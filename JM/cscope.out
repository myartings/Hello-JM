cscope 15 $HOME/Codes/MJM/JM -q 0000008868 0004129941
	@lcommon/inc/blk_prediction.h

18 #i‚de‡
_BLK_PREDICTION_H_


19 
	#_BLK_PREDICTION_H_


	)

20 
	~"mbuf„r.h
"

22 
compuã_ªsidue
 (
img≥l
 **
curImg
, img≥»**
mb_¥ed
, **
mb_ºes
, 
mb_x
, 
›ix_x
, 
width
, 
height
);

23 
ßm∂e_ªc⁄°ru˘
 (
img≥l
 **
curImg
, img≥»**
mb_¥ed
, **
mb_ºes
, 
mb_x
, 
›ix_x
, 
width
, 
height
, 
max_img≥l_vÆue
, 
dq_bôs
);

	@lcommon/inc/config_common.h

15 #i‚de‡
_CONFIG_COMMON_H_


16 
	#_CONFIG_COMMON_H_


	)

20 *
	mTokíName
;

21 *
	mPœ˚
;

22 
	mTy≥
;

23 
	mDeÁu…
;

24 
	m∑øm_limôs
;

25 
	mmö_limô
;

26 
	mmax_limô
;

27 
	mch¨_size
;

28 } 
	tM≠pög
;

30 *
GëC⁄figFûeC⁄ã¡
 (*
Fûíame
);

31 
InôP¨ams
 (
M≠pög
 *
M≠
);

32 
Te°P¨ams
(
M≠pög
 *
M≠
, 
bôdïth_qp_sˇÀ
[3]);

33 
Di•œyP¨ams
(
M≠pög
 *
M≠
, *
mesßge
);

34 
P¨£C⁄ã¡
 (
I≈utP¨amëîs
 *
p_I≈
, 
M≠pög
 *
M≠
, *
buf
, 
bufsize
);

	@lcommon/inc/ctx_tables.h

16 
	#CTX_UNUSED
 {0,64}

	)

17 
	#CTX_UNDEF
 {0,63}

	)

19 #ifde‡
CONTEXT_INI_C


22 
	#NUM_CTX_MODELS_I
 1

	)

23 
	#NUM_CTX_MODELS_P
 3

	)

26 c⁄° 
	gINIT_MB_TYPE_I
[1][3][11][2] =

30 { { 20, -15} , { 2, 54} , { 3, 74} , 
CTX_UNUSED
 , { -28, 127} , { -23, 104} , { -6, 53} , { -1, 54} , { 7, 51} , CTX_UNUSED , CTX_UNUSED },

32 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED }

35 c⁄° 
	gINIT_MB_TYPE_P
[3][3][11][2] =

39 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

40 { { 23, 33} , { 23, 2} , { 21, 0} , 
CTX_UNUSED
 , { 1, 9} , { 0, 49} , { -37, 118} , { 5, 57} , { -13, 78} , { -11, 65} , { 1, 62} },

41 { { 26, 67} , { 16, 90} , { 9, 104} , 
CTX_UNUSED
 , { -46, 127} , { -20, 104} , { 1, 67} , { 18, 64} , { 9, 43} , { 29, 0} , CTX_UNUSED }

45 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

46 { { 22, 25} , { 34, 0} , { 16, 0} , 
CTX_UNUSED
 , { -2, 9} , { 4, 41} , { -29, 118} , { 2, 65} , { -6, 71} , { -13, 79} , { 5, 52} },

47 { { 57, 2} , { 41, 36} , { 26, 69} , 
CTX_UNUSED
 , { -45, 127} , { -15, 101} , { -4, 76} , { 26, 34} , { 19, 22} , { 40, 0} , CTX_UNUSED }

51 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

52 { { 29, 16} , { 25, 0} , { 14, 0} , 
CTX_UNUSED
 , { -10, 51} , { -3, 62} , { -27, 99} , { 26, 16} , { -4, 85} , { -24, 102} , { 5, 57} },

53 { { 54, 0} , { 37, 42} , { 12, 97} , 
CTX_UNUSED
 , { -32, 127} , { -22, 117} , { -2, 74} , { 20, 40} , { 20, 10} , { 29, 0} , CTX_UNUSED }

57 c⁄° 
	gINIT_B8_TYPE_I
[1][2][9][2] =

61 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

62 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED }

66 c⁄° 
	gINIT_B8_TYPE_P
[3][2][9][2] =

70 { 
CTX_UNUSED
 , { 12, 49} , CTX_UNUSED , { -4, 73} , { 17, 50} , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

71 { { -6, 86} , { -17, 95} , { -6, 61} , { 9, 45} , 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED }

75 { 
CTX_UNUSED
 , { 9, 50} , CTX_UNUSED , { -3, 70} , { 10, 54} , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

76 { { 6, 69} , { -13, 90} , { 0, 52} , { 8, 43} , 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED }

80 { 
CTX_UNUSED
 , { 6, 57} , CTX_UNUSED , { -17, 73} , { 14, 57} , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

81 { { -6, 93} , { -14, 88} , { -6, 44} , { 4, 55} , 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED }

85 c⁄° 
	gINIT_MV_RES_I
[1][2][10][2] =

89 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

90 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED }

94 c⁄° 
	gINIT_MV_RES_P
[3][2][10][2] =

98 { { -3, 69} , 
CTX_UNUSED
 , { -6, 81} , { -11, 96} , CTX_UNUSED , { 0, 58} , CTX_UNUSED , { -3, 76} , { -10, 94} , CTX_UNUSED },

99 { { 6, 55} , { 7, 67} , { -5, 86} , { 2, 88} , 
CTX_UNUSED
 , { 5, 54} , { 4, 69} , { -3, 81} , { 0, 88} , CTX_UNUSED }

103 { { -2, 69} , 
CTX_UNUSED
 , { -5, 82} , { -10, 96} , CTX_UNUSED , { 1, 56} , CTX_UNUSED , { -3, 74} , { -6, 85} , CTX_UNUSED },

104 { { 2, 59} , { 2, 75} , { -3, 87} , { -3, 100} , 
CTX_UNUSED
 , { 0, 59} , { -3, 81} , { -7, 86} , { -5, 95} , CTX_UNUSED }

108 { { -11, 89} , 
CTX_UNUSED
 , { -15, 103} , { -21, 116} , CTX_UNUSED , { 1, 63} , CTX_UNUSED , { -5, 85} , { -13, 106} , CTX_UNUSED },

109 { { 19, 57} , { 20, 58} , { 4, 84} , { 6, 96} , 
CTX_UNUSED
 , { 5, 63} , { 6, 75} , { -3, 90} , { -1, 101} , CTX_UNUSED }

113 c⁄° 
	gINIT_REF_NO_I
[1][2][6][2] =

117 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

118 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED }

122 c⁄° 
	gINIT_REF_NO_P
[3][2][6][2] =

127 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED }

132 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED }

137 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED }

142 c⁄° 
	gINIT_TRANSFORM_SIZE_I
[1][1][3][2]=

151 c⁄° 
	gINIT_TRANSFORM_SIZE_P
[3][1][3][2]=

170 c⁄° 
	gINIT_DELTA_QP_I
[1][1][4][2]=

177 c⁄° 
	gINIT_DELTA_QP_P
[3][1][4][2]=

193 c⁄° 
	gINIT_MB_AFF_I
[1][1][4][2] =

197 { { 0, 11} , { 1, 55} , { 0, 69} , 
CTX_UNUSED
 }

200 c⁄° 
	gINIT_MB_AFF_P
[3][1][4][2] =

204 { { 0, 45} , { -4, 78} , { -3, 96} , 
CTX_UNUSED
 }

208 { { 13, 15} , { 7, 51} , { 2, 80} , 
CTX_UNUSED
 }

212 { { 7, 34} , { -9, 88} , { -20, 127} , 
CTX_UNUSED
 }

216 c⁄° 
	gINIT_IPR_I
[1][1][2][2] =

224 c⁄° 
	gINIT_IPR_P
[3][1][2][2] =

240 c⁄° 
	gINIT_CIPR_I
[1][1][4][2] =

248 c⁄° 
	gINIT_CIPR_P
[3][1][4][2] =

264 c⁄° 
	gINIT_CBP_I
[1][3][4][2] =

274 c⁄° 
	gINIT_CBP_P
[3][3][4][2] =

296 c⁄° 
	gINIT_BCBP_I
[1][22][4][2] =

303 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

307 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

308 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

309 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

314 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

316 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

321 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

323 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED }

327 c⁄° 
	gINIT_BCBP_P
[3][22][4][2] =

334 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

338 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

339 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

340 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

345 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

347 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

352 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

354 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED }

361 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

365 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

366 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

367 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

372 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

374 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

379 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

381 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED }

388 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

392 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

393 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

394 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

399 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

401 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

406 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

408 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED }

412 c⁄° 
	gINIT_MAP_I
[1][22][15][2] =

417 { 
CTX_UNUSED
 , { 1, 50} , { 7, 52} , { 10, 35} , { 0, 44} , { 11, 38} , { 1, 45} , { 0, 46} , { 5, 44} , { 31, 17} , { 1, 51} , { 7, 50} , { 28, 19} , { 16, 33} , { 14, 62} },

419 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

420 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

422 { { -8, 102} , { -15, 100} , { 0, 95} , 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

423 { 
CTX_UNUSED
 , { -4, 75} , { 2, 72} , { -11, 75} , { -3, 71} , { 15, 46} , { -13, 69} , { 0, 62} , { 0, 65} , { 21, 37} , { -15, 72} , { 9, 57} , { 16, 54} , { 0, 62} , { 12, 72} },

424 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

425 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

428 { 
CTX_UNUSED
 , { 1, 50} , { 7, 52} , { 10, 35} , { 0, 44} , { 11, 38} , { 1, 45} , { 0, 46} , { 5, 44} , { 31, 17} , { 1, 51} , { 7, 50} , { 28, 19} , { 16, 33} , { 14, 62} },

430 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

431 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

435 { 
CTX_UNUSED
 , { 1, 50} , { 7, 52} , { 10, 35} , { 0, 44} , { 11, 38} , { 1, 45} , { 0, 46} , { 5, 44} , { 31, 17} , { 1, 51} , { 7, 50} , { 28, 19} , { 16, 33} , { 14, 62} },

437 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

438 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

443 c⁄° 
	gINIT_MAP_P
[3][22][15][2] =

448 { 
CTX_UNUSED
 , { 11, 35} , { 4, 64} , { 1, 61} , { 11, 35} , { 18, 25} , { 12, 24} , { 13, 29} , { 13, 36} , { -10, 93} , { -7, 73} , { -2, 73} , { 13, 46} , { 9, 49} , { -7, 100} },

450 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

451 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

453 { { 3, 64} , { 1, 61} , { 9, 63} , 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

454 { 
CTX_UNUSED
 , { 7, 50} , { 16, 39} , { 5, 44} , { 4, 52} , { 11, 48} , { -5, 60} , { -1, 59} , { 0, 59} , { 22, 33} , { 5, 44} , { 14, 43} , { -1, 78} , { 0, 60} , { 9, 69} },

455 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

456 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

459 { 
CTX_UNUSED
 , { 11, 35} , { 4, 64} , { 1, 61} , { 11, 35} , { 18, 25} , { 12, 24} , { 13, 29} , { 13, 36} , { -10, 93} , { -7, 73} , { -2, 73} , { 13, 46} , { 9, 49} , { -7, 100} },

461 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

462 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

466 { 
CTX_UNUSED
 , { 11, 35} , { 4, 64} , { 1, 61} , { 11, 35} , { 18, 25} , { 12, 24} , { 13, 29} , { 13, 36} , { -10, 93} , { -7, 73} , { -2, 73} , { 13, 46} , { 9, 49} , { -7, 100} },

468 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

469 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

475 { 
CTX_UNUSED
 , { -4, 66} , { -5, 78} , { -4, 71} , { -8, 72} , { 2, 59} , { -1, 55} , { -7, 70} , { -6, 75} , { -8, 89} , { -34, 119} , { -3, 75} , { 32, 20} , { 30, 22} , { -44, 127} },

477 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

478 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

480 { { -4, 71} , { 0, 58} , { 7, 61} , 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

481 { 
CTX_UNUSED
 , { 9, 41} , { 18, 25} , { 9, 32} , { 5, 43} , { 9, 47} , { 0, 44} , { 0, 51} , { 2, 46} , { 19, 38} , { -4, 66} , { 15, 38} , { 12, 42} , { 9, 34} , { 0, 89} },

482 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

483 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

486 { 
CTX_UNUSED
 , { -4, 66} , { -5, 78} , { -4, 71} , { -8, 72} , { 2, 59} , { -1, 55} , { -7, 70} , { -6, 75} , { -8, 89} , { -34, 119} , { -3, 75} , { 32, 20} , { 30, 22} , { -44, 127} },

488 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

489 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

493 { 
CTX_UNUSED
 , { -4, 66} , { -5, 78} , { -4, 71} , { -8, 72} , { 2, 59} , { -1, 55} , { -7, 70} , { -6, 75} , { -8, 89} , { -34, 119} , { -3, 75} , { 32, 20} , { 30, 22} , { -44, 127} },

495 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

496 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

502 { 
CTX_UNUSED
 , { -4, 44} , { -1, 69} , { 0, 62} , { -7, 51} , { -4, 47} , { -6, 42} , { -3, 41} , { -6, 53} , { 8, 76} , { -9, 78} , { -11, 83} , { 9, 52} , { 0, 67} , { -5, 90} },

504 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

505 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

507 { { 3, 65} , { -7, 69} , { 8, 77} , 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

508 { 
CTX_UNUSED
 , { -10, 66} , { 3, 62} , { -3, 68} , { -20, 81} , { 0, 30} , { 1, 7} , { -3, 23} , { -21, 74} , { 16, 66} , { -23, 124} , { 17, 37} , { 44, -18} , { 50, -34} , { -22, 127} },

509 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

510 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

513 { 
CTX_UNUSED
 , { -4, 44} , { -1, 69} , { 0, 62} , { -7, 51} , { -4, 47} , { -6, 42} , { -3, 41} , { -6, 53} , { 8, 76} , { -9, 78} , { -11, 83} , { 9, 52} , { 0, 67} , { -5, 90} },

515 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

516 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

520 { 
CTX_UNUSED
 , { -4, 44} , { -1, 69} , { 0, 62} , { -7, 51} , { -4, 47} , { -6, 42} , { -3, 41} , { -6, 53} , { 8, 76} , { -9, 78} , { -11, 83} , { 9, 52} , { 0, 67} , { -5, 90} },

522 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

523 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

528 c⁄° 
	gINIT_LAST_I
[1][22][15][2] =

533 { 
CTX_UNUSED
 , { 12, 38} , { 11, 45} , { 15, 39} , { 11, 42} , { 13, 44} , { 16, 45} , { 12, 41} , { 10, 49} , { 30, 34} , { 18, 42} , { 10, 55} , { 17, 51} , { 17, 46} , { 0, 89} },

534 { { 23, -13} , { 26, -13} , { 40, -15} , { 49, -14} , { 44, 3} , { 45, 6} , { 44, 34} , { 33, 54} , { 19, 82} , 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

535 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

536 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

538 { { 30, -6} , { 27, 3} , { 26, 22} , 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

539 { 
CTX_UNUSED
 , { 37, -16} , { 35, -4} , { 38, -8} , { 38, -3} , { 37, 3} , { 38, 5} , { 42, 0} , { 35, 16} , { 39, 22} , { 14, 48} , { 27, 37} , { 21, 60} , { 12, 68} , { 2, 97} },

540 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

541 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

544 { 
CTX_UNUSED
 , { 12, 38} , { 11, 45} , { 15, 39} , { 11, 42} , { 13, 44} , { 16, 45} , { 12, 41} , { 10, 49} , { 30, 34} , { 18, 42} , { 10, 55} , { 17, 51} , { 17, 46} , { 0, 89} },

545 { { 23, -13} , { 26, -13} , { 40, -15} , { 49, -14} , { 44, 3} , { 45, 6} , { 44, 34} , { 33, 54} , { 19, 82} , 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

546 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

547 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

551 { 
CTX_UNUSED
 , { 12, 38} , { 11, 45} , { 15, 39} , { 11, 42} , { 13, 44} , { 16, 45} , { 12, 41} , { 10, 49} , { 30, 34} , { 18, 42} , { 10, 55} , { 17, 51} , { 17, 46} , { 0, 89} },

552 { { 23, -13} , { 26, -13} , { 40, -15} , { 49, -14} , { 44, 3} , { 45, 6} , { 44, 34} , { 33, 54} , { 19, 82} , 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

553 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

554 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

559 c⁄° 
	gINIT_LAST_P
[3][22][15][2] =

564 { 
CTX_UNUSED
 , { 6, 51} , { 6, 57} , { 7, 53} , { 6, 52} , { 6, 55} , { 11, 45} , { 14, 36} , { 8, 53} , { -1, 82} , { 7, 55} , { -3, 78} , { 15, 46} , { 22, 31} , { -1, 84} },

565 { { 9, -2} , { 26, -9} , { 33, -9} , { 39, -7} , { 41, -2} , { 45, 3} , { 49, 9} , { 45, 27} , { 36, 59} , 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

566 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

567 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

569 { { 1, 67} , { 5, 59} , { 9, 67} , 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

570 { 
CTX_UNUSED
 , { 16, 30} , { 18, 32} , { 18, 35} , { 22, 29} , { 24, 31} , { 23, 38} , { 18, 43} , { 20, 41} , { 11, 63} , { 9, 59} , { 9, 64} , { -1, 94} , { -2, 89} , { -9, 108} },

571 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

572 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

575 { 
CTX_UNUSED
 , { 6, 51} , { 6, 57} , { 7, 53} , { 6, 52} , { 6, 55} , { 11, 45} , { 14, 36} , { 8, 53} , { -1, 82} , { 7, 55} , { -3, 78} , { 15, 46} , { 22, 31} , { -1, 84} },

576 { { 9, -2} , { 26, -9} , { 33, -9} , { 39, -7} , { 41, -2} , { 45, 3} , { 49, 9} , { 45, 27} , { 36, 59} , 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

577 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

578 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

582 { 
CTX_UNUSED
 , { 6, 51} , { 6, 57} , { 7, 53} , { 6, 52} , { 6, 55} , { 11, 45} , { 14, 36} , { 8, 53} , { -1, 82} , { 7, 55} , { -3, 78} , { 15, 46} , { 22, 31} , { -1, 84} },

583 { { 9, -2} , { 26, -9} , { 33, -9} , { 39, -7} , { 41, -2} , { 45, 3} , { 49, 9} , { 45, 27} , { 36, 59} , 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

584 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

585 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

591 { 
CTX_UNUSED
 , { 33, -4} , { 29, 10} , { 37, -5} , { 51, -29} , { 39, -9} , { 52, -34} , { 69, -58} , { 67, -63} , { 44, -5} , { 32, 7} , { 55, -29} , { 32, 1} , { 0, 0} , { 27, 36} },

592 { { 17, -10} , { 32, -13} , { 42, -9} , { 49, -5} , { 53, 0} , { 64, 3} , { 68, 10} , { 66, 27} , { 47, 57} , 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

593 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

594 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

596 { { 0, 75} , { 2, 72} , { 8, 77} , 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

597 { 
CTX_UNUSED
 , { 14, 35} , { 18, 31} , { 17, 35} , { 21, 30} , { 17, 45} , { 20, 42} , { 18, 45} , { 27, 26} , { 16, 54} , { 7, 66} , { 16, 56} , { 11, 73} , { 10, 67} , { -10, 116} },

598 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

599 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

602 { 
CTX_UNUSED
 , { 33, -4} , { 29, 10} , { 37, -5} , { 51, -29} , { 39, -9} , { 52, -34} , { 69, -58} , { 67, -63} , { 44, -5} , { 32, 7} , { 55, -29} , { 32, 1} , { 0, 0} , { 27, 36} },

603 { { 17, -10} , { 32, -13} , { 42, -9} , { 49, -5} , { 53, 0} , { 64, 3} , { 68, 10} , { 66, 27} , { 47, 57} , 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

604 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

605 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

609 { 
CTX_UNUSED
 , { 33, -4} , { 29, 10} , { 37, -5} , { 51, -29} , { 39, -9} , { 52, -34} , { 69, -58} , { 67, -63} , { 44, -5} , { 32, 7} , { 55, -29} , { 32, 1} , { 0, 0} , { 27, 36} },

610 { { 17, -10} , { 32, -13} , { 42, -9} , { 49, -5} , { 53, 0} , { 64, 3} , { 68, 10} , { 66, 27} , { 47, 57} , 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

611 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

612 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

618 { 
CTX_UNUSED
 , { 8, 44} , { 11, 44} , { 14, 42} , { 7, 48} , { 4, 56} , { 4, 52} , { 13, 37} , { 9, 49} , { 19, 58} , { 10, 48} , { 12, 45} , { 0, 69} , { 20, 33} , { 8, 63} },

619 { { 9, -2} , { 30, -10} , { 31, -4} , { 33, -1} , { 33, 7} , { 31, 12} , { 37, 23} , { 31, 38} , { 20, 64} , 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

620 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

621 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

623 { { 20, 34} , { 19, 31} , { 27, 44} , 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

624 { 
CTX_UNUSED
 , { 19, 16} , { 15, 36} , { 15, 36} , { 21, 28} , { 25, 21} , { 30, 20} , { 31, 12} , { 27, 16} , { 24, 42} , { 0, 93} , { 14, 56} , { 15, 57} , { 26, 38} , { -24, 127} },

625 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

626 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

629 { 
CTX_UNUSED
 , { 8, 44} , { 11, 44} , { 14, 42} , { 7, 48} , { 4, 56} , { 4, 52} , { 13, 37} , { 9, 49} , { 19, 58} , { 10, 48} , { 12, 45} , { 0, 69} , { 20, 33} , { 8, 63} },

630 { { 9, -2} , { 30, -10} , { 31, -4} , { 33, -1} , { 33, 7} , { 31, 12} , { 37, 23} , { 31, 38} , { 20, 64} , 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

631 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

632 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

636 { 
CTX_UNUSED
 , { 8, 44} , { 11, 44} , { 14, 42} , { 7, 48} , { 4, 56} , { 4, 52} , { 13, 37} , { 9, 49} , { 19, 58} , { 10, 48} , { 12, 45} , { 0, 69} , { 20, 33} , { 8, 63} },

637 { { 9, -2} , { 30, -10} , { 31, -4} , { 33, -1} , { 33, 7} , { 31, 12} , { 37, 23} , { 31, 38} , { 20, 64} , 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

638 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

639 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

644 c⁄° 
	gINIT_ONE_I
[1][22][5][2] =

651 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

655 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

656 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

657 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

662 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

664 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

669 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

671 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED }

675 c⁄° 
	gINIT_ONE_P
[3][22][5][2] =

682 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

686 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

687 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

688 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

693 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

695 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

700 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

702 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED }

709 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

713 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

714 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

715 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

720 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

722 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

727 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

729 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED }

736 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

740 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

741 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

742 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

747 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

749 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

754 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

756 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED }

760 c⁄° 
	gINIT_ABS_I
[1][22][5][2] =

767 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

769 { { -13, 86} , { -13, 96} , { -11, 97} , { -19, 117} , 
CTX_UNUSED
 },

771 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

772 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

773 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

778 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

780 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

785 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

787 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED }

791 c⁄° 
	gINIT_ABS_P
[3][22][5][2] =

798 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

800 { { -2, 58} , { -3, 72} , { -3, 81} , { -11, 97} , 
CTX_UNUSED
 },

802 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

803 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

804 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

809 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

811 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

816 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

818 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

825 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

827 { { -2, 55} , { -2, 67} , { 0, 73} , { -8, 89} , 
CTX_UNUSED
 },

829 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

830 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

831 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

836 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

838 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

843 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

845 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

852 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

854 { { -13, 78} , { -9, 83} , { -4, 81} , { -13, 99} , 
CTX_UNUSED
 },

856 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

857 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

858 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

863 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

865 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

870 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

872 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED }

878 #i‡
ENABLE_FIELD_CTX


879 c⁄° 
	gINIT_FLD_MAP_I
[1][8][15][2] =

884 { 
CTX_UNUSED
 , { 10, 44} , { -7, 62} , { 15, 36} , { 14, 40} , { 16, 27} , { 12, 29} , { 1, 44} , { 20, 36} , { 18, 32} , { 5, 42} , { 1, 48} , { 10, 62} , { 17, 46} , { 9, 64} },

887 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

888 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

890 { { -7, 99} , { -14, 95} , { 2, 95} , 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

891 { 
CTX_UNUSED
 , { 0, 76} , { -5, 74} , { 0, 70} , { -11, 75} , { 1, 68} , { 0, 65} , { -14, 73} , { 3, 62} , { 4, 62} , { -1, 68} , { -13, 75} , { 11, 55} , { 5, 64} , { 12, 70} }

895 c⁄° 
	gINIT_FLD_MAP_P
[3][8][15][2] =

900 { 
CTX_UNUSED
 , { -9, 93} , { -22, 94} , { -5, 86} , { 9, 67} , { -4, 80} , { -10, 85} , { -1, 70} , { 7, 60} , { 9, 58} , { 5, 61} , { 12, 50} , { 15, 50} , { 18, 49} , { 17, 54} },

903 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

904 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

906 { { -2, 69} , { -2, 59} , { 6, 70} , 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

907 { 
CTX_UNUSED
 , { 10, 44} , { 9, 31} , { 12, 43} , { 3, 53} , { 14, 34} , { 10, 38} , { -3, 52} , { 13, 40} , { 17, 32} , { 7, 44} , { 7, 38} , { 13, 50} , { 10, 57} , { 26, 43} }

912 { 
CTX_UNUSED
 , { -17, 111} , { -28, 114} , { -6, 89} , { -2, 80} , { -4, 82} , { -9, 85} , { -8, 81} , { -1, 72} , { 5, 64} , { 1, 67} , { 9, 56} , { 0, 69} , { 1, 69} , { 7, 69} },

915 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

916 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

918 { { -1, 70} , { -9, 72} , { 14, 60} , 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

919 { 
CTX_UNUSED
 , { 16, 37} , { 0, 47} , { 18, 35} , { 11, 37} , { 12, 41} , { 10, 41} , { 2, 48} , { 12, 41} , { 13, 41} , { 0, 59} , { 3, 50} , { 19, 40} , { 3, 66} , { 18, 50} }

924 { 
CTX_UNUSED
 , { -13, 106} , { -50, 127} , { -5, 92} , { 17, 57} , { -5, 86} , { -13, 94} , { -12, 91} , { -2, 77} , { 0, 71} , { -1, 73} , { 4, 64} , { -7, 81} , { 5, 64} , { 15, 57} },

927 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

928 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

930 { { -2, 76} , { -18, 86} , { 12, 70} , 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

931 { 
CTX_UNUSED
 , { 5, 64} , { -12, 70} , { 11, 55} , { 5, 56} , { 0, 69} , { 2, 65} , { -6, 74} , { 5, 54} , { 7, 54} , { -6, 76} , { -11, 82} , { -2, 77} , { -2, 77} , { 25, 42} }

935 c⁄° 
	gINIT_FLD_LAST_I
[1][8][15][2] =

940 { 
CTX_UNUSED
 , { 24, 17} , { 21, 21} , { 25, 22} , { 31, 27} , { 22, 29} , { 19, 35} , { 14, 50} , { 10, 57} , { 7, 63} , { -2, 77} , { -4, 82} , { -3, 94} , { 9, 69} , { -12, 109} },

941 { { 21, -10} , { 24, -11} , { 28, -8} , { 28, -1} , { 29, 3} , { 29, 9} , { 35, 20} , { 29, 36} , { 14, 67} , 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

943 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

944 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

946 { { 29, -3} , { 26, 0} , { 22, 30} , 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

947 { 
CTX_UNUSED
 , { 31, -7} , { 35, -15} , { 34, -3} , { 34, 3} , { 36, -1} , { 34, 5} , { 32, 11} , { 35, 5} , { 34, 12} , { 39, 11} , { 30, 29} , { 34, 26} , { 29, 39} , { 19, 66} }

951 c⁄° 
	gINIT_FLD_LAST_P
[3][8][15][2] =

956 { 
CTX_UNUSED
 , { 45, -24} , { 53, -45} , { 48, -26} , { 65, -43} , { 43, -19} , { 39, -10} , { 30, 9} , { 18, 26} , { 20, 27} , { 0, 57} , { -14, 82} , { -5, 75} , { -19, 97} , { -35, 125} },

957 { { 21, -13} , { 33, -14} , { 39, -7} , { 46, -2} , { 51, 2} , { 60, 6} , { 61, 17} , { 55, 34} , { 42, 62} , 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

959 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

960 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

962 { { 8, 60} , { 6, 63} , { 17, 65} , 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

963 { 
CTX_UNUSED
 , { 21, 24} , { 23, 20} , { 26, 23} , { 27, 32} , { 28, 23} , { 28, 24} , { 23, 40} , { 24, 32} , { 28, 29} , { 23, 42} , { 19, 57} , { 22, 53} , { 22, 61} , { 11, 86} }

968 { 
CTX_UNUSED
 , { 69, -71} , { 63, -63} , { 66, -64} , { 77, -74} , { 54, -39} , { 52, -35} , { 41, -10} , { 36, 0} , { 40, -1} , { 30, 14} , { 28, 26} , { 23, 37} , { 12, 55} , { 11, 65} },

969 { { 17, -10} , { 32, -13} , { 42, -9} , { 49, -5} , { 53, 0} , { 64, 3} , { 68, 10} , { 66, 27} , { 47, 57} , 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

971 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

972 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

974 { { 12, 48} , { 11, 49} , { 26, 45} , 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

975 { 
CTX_UNUSED
 , { 22, 22} , { 23, 22} , { 27, 21} , { 33, 20} , { 26, 28} , { 30, 24} , { 27, 34} , { 18, 42} , { 25, 39} , { 18, 50} , { 12, 70} , { 21, 54} , { 14, 71} , { 11, 83} }

980 { 
CTX_UNUSED
 , { 61, -55} , { 56, -46} , { 62, -50} , { 81, -67} , { 45, -20} , { 35, -2} , { 28, 15} , { 34, 1} , { 39, 1} , { 30, 17} , { 20, 38} , { 18, 45} , { 15, 54} , { 0, 79} },

981 { { 9, -2} , { 30, -10} , { 31, -4} , { 33, -1} , { 33, 7} , { 31, 12} , { 37, 23} , { 31, 38} , { 20, 64} , 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

983 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

984 { 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

986 { { 18, 31} , { 19, 26} , { 36, 24} , 
CTX_UNUSED
 , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED , CTX_UNUSED },

987 { 
CTX_UNUSED
 , { 24, 23} , { 27, 16} , { 24, 30} , { 31, 29} , { 22, 41} , { 22, 42} , { 16, 60} , { 15, 52} , { 14, 60} , { 3, 78} , { -16, 123} , { 21, 53} , { 22, 56} , { 25, 61} }

	@lcommon/inc/distortion.h

14 #i‚de‡
_DISTORTION_H_


15 
	#_DISTORTION_H_


	)

19 
	sdi°‹ti⁄_d©a


21 
	mi4x4rd
[4][4];

22 
di°blk
 
	mi4x4
 [4][4];

23 
di°blk
 
	mi8x8
 [2][2];

24 
	mi8x8rd
[2][2];

25 
	mi16x16
;

26 
	mi16x16rd
;

27 
	mrd_co°
;

28 } 
	tDi°‹ti⁄D©a
;

	@lcommon/inc/enc_statistics.h

16 #i‚de‡
_ENC_STATISTICS_H_


17 
	#_ENC_STATISTICS_H_


	)

18 
	~"globÆ.h
"

20 
	s°©_∑ømëîs


22 
	mbôøã
;

23 
öt64
 
	mbô_˘r
;

24 
öt64
 
	mbô_˘r_n
;

25 
öt64
 
	mbô_˘r_emuœti⁄_¥evíti⁄
;

26 
	mbô_¶i˚
;

27 
	m°‹ed_bô_¶i˚
;

28 
	mb8_mode_0_u£
 [
NUM_SLICE_TYPES
][2];

29 
öt64
 
	mmode_u£_å™sf‹m
[
NUM_SLICE_TYPES
][
MAXMODE
][2];

30 
öt64
 
	möåa_chroma_mode
[4];

33 
	mNumbîBFømes
;

35 
	m‰ame_cou¡î
;

36 
öt64
 
	mqu™t
 [
NUM_SLICE_TYPES
];

37 
öt64
 
	mnum_ma¸oblocks
 [
NUM_SLICE_TYPES
];

38 
	m‰ame_˘r
 [
NUM_SLICE_TYPES
];

39 
öt64
 
	mbô_cou¡î
 [
NUM_SLICE_TYPES
];

40 
	mbôøã_°
 [
NUM_SLICE_TYPES
];

41 
öt64
 
	mmode_u£
 [
NUM_SLICE_TYPES
][
MAXMODE
];

42 
öt64
 
	mbô_u£_mode
 [
NUM_SLICE_TYPES
][
MAXMODE
];

43 
öt64
 
	mbô_u£_mb_ty≥
 [
NUM_SLICE_TYPES
];

44 
öt64
 
	mbô_u£_hódî
 [
NUM_SLICE_TYPES
];

45 
öt64
 
	mtmp_bô_u£_cbp
 [
NUM_SLICE_TYPES
];

46 
öt64
 
	mbô_u£_c€ffC
 [
NUM_SLICE_TYPES
];

47 
öt64
 
	mbô_u£_c€ff
 [3][
NUM_SLICE_TYPES
];

48 
öt64
 
	mbô_u£_dñè_qu™t
 [
NUM_SLICE_TYPES
];

49 
öt64
 
	mbô_u£_°uffög_bôs
[
NUM_SLICE_TYPES
];

51 
	mbô_˘r_∑ømëî£ts
;

52 
	mbô_˘r_∑ømëî£ts_n
;

53 
öt64
 
	mbô_˘r_fûÀr_d©a
;

54 
öt64
 
	mbô_˘r_fûÀr_d©a_n
;

56 #i‡(
MVC_EXTENSION_ENABLE
)

57 
	mbôøã_v
[2];

58 
öt64
 
	mbô_˘r_v
[2];

59 
öt64
 
	mbô_˘r_n_v
[2];

60 
öt64
 
	mbô_˘r_emuœti⁄¥evíti⁄_v
[2];

61 
öt64
 
	mbô_cou¡î_v
[2][
NUM_SLICE_TYPES
];

62 
	mbô_˘r_∑ømëî£ts_v
[2];

63 
	mbô_˘r_∑ømëî£ts_n_v
[2];

64 
öt64
 
	mbô_˘r_fûÀr_d©a_v
[2];

65 
öt64
 
	mbô_˘r_fûÀr_d©a_n_v
[2];

68 
°©_∑ømëîs
 
	tSètP¨amëîs
;

	@lcommon/inc/fast_memory.h

15 #i‚de‡
_FAST_MEMORY_H_


16 
	#_FAST_MEMORY_H_


	)

18 
	~"ty≥defs.h
"

21 
ölöe
 
	$Á°_mem£t
(*
d°
,
vÆue
,
width
)

23 
	`mem£t
(
d°
,
vÆue
,
width
);

24 
	}
}

26 
ölöe
 
	$Á°_mem˝y
(*
d°
,*
§c
,
width
)

28 
	`mem˝y
(
d°
,
§c
,
width
);

29 
	}
}

31 
ölöe
 
	$Á°_mem£t_zîo
(*
d°
, 
width
)

33 
	`mem£t
(
d°
,0,
width
);

34 
	}
}

	@lcommon/inc/frame.h

12 #i‚de‡
_FRAME_H_


13 
	#_FRAME_H_


	)

16 
	mCM_UNKNOWN
 = -1,

17 
	mCM_YUV
 = 0,

18 
	mCM_RGB
 = 1,

19 
	mCM_XYZ
 = 2

20 } 
	tCﬁ‹Modñ
;

23 
	mCF_UNKNOWN
 = -1,

24 
	mYUV400
 = 0,

25 
	mYUV420
 = 1,

26 
	mYUV422
 = 2,

27 
	mYUV444
 = 3

28 } 
	tCﬁ‹F‹m©
;

31 
	mPF_UNKNOWN
 = -1,

32 
	mUYVY
 = 0,

33 
	mYUY2
 = 1,

34 
	mYUYV
 = 1,

35 
	mYVYU
 = 2,

36 
	mBGR
 = 3,

37 
	mV210
 = 4

38 } 
	tPixñF‹m©
;

41 
	s‰ame_f‹m©


43 
Cﬁ‹F‹m©
 
	myuv_f‹m©
;

44 
Cﬁ‹Modñ
 
	mcﬁ‹_modñ
;

45 
PixñF‹m©
 
	mpixñ_f‹m©
;

46 
	m‰ame_øã
;

47 
	mwidth
[3];

48 
	mheight
[3];

49 
	mauto_¸›_right
;

50 
	mauto_¸›_bŸtom
;

51 
	mauto_¸›_right_¸
;

52 
	mauto_¸›_bŸtom_¸
;

53 
	mwidth_¸›
;

54 
	mheight_¸›
;

55 
	mmb_width
;

56 
	mmb_height
;

57 
	msize_cmp
[3];

58 
	msize
;

59 
	mbô_dïth
[3];

60 
	mmax_vÆue
[3];

61 
	mmax_vÆue_sq
[3];

62 
	mpic_unô_size_⁄_disk
;

63 
	mpic_unô_size_shi·3
;

64 } 
	tFømeF‹m©
;

	@lcommon/inc/ifunctions.h

17 #i‚de‡
_IFUNCTIONS_H_


18 
	#_IFUNCTIONS_H_


	)

20 #i‡!(
deföed
(
WIN32
Ë|| deföed(
WIN64
)Ë&& (
__STDC_VERSION__
 < 199901L)

21 

	)

22 
	#ölöe


	)

24 
	~<m©h.h
>

25 
	~<limôs.h
>

28 
ölöe
 
	$smö
(
a
, 
b
)

30  (Ë(((
a
Ë< (
b
)) ? (a) : (b));

31 
	}
}

33 
ölöe
 
	$smax
(
a
, 
b
)

35  (Ë(((
a
Ë> (
b
)) ? (a) : (b));

36 
	}
}

38 
ölöe
 
	$imö
(
a
, 
b
)

40  ((
a
Ë< (
b
)) ? (a) : (b);

41 
	}
}

43 
ölöe
 
	$imö3
(
a
, 
b
, 
c
)

45  ((
a
Ë< (
b
)Ë? 
	`imö
◊, 
c
) : imin(b, c);

46 
	}
}

48 
ölöe
 
	$imax
(
a
, 
b
)

50  ((
a
Ë> (
b
)) ? (a) : (b);

51 
	}
}

53 
ölöe
 
	$imedün
(
a
,
b
,
c
)

55 i‡(
a
 > 
b
)

57 i‡(
b
 > 
c
)

58 (
b
);

59 i‡(
a
 > 
c
)

60 (
c
);

62 (
a
);

66 i‡(
a
 > 
c
)

67 (
a
);

68 i‡(
b
 > 
c
)

69 (
c
);

71 (
b
);

73 
	}
}

75 
ölöe
 
	$imedün_ﬁd
(
a
, 
b
, 
c
)

77  (
a
 + 
b
 + 
c
 - 
	`imö
◊, imö(b, c)Ë- 
	`imax
(a, imax(b ,c)));

78 
	}
}

80 
ölöe
 
	$dmö
(
a
, 
b
)

82  ((
a
Ë< (
b
)) ? (a) : (b);

83 
	}
}

85 
ölöe
 
	$dmax
(
a
, 
b
)

87  ((
a
Ë> (
b
)) ? (a) : (b);

88 
	}
}

90 
ölöe
 
öt64
 
	$i64mö
(
öt64
 
a
, i¡64 
b
)

92  ((
a
Ë< (
b
)) ? (a) : (b);

93 
	}
}

95 
ölöe
 
öt64
 
	$i64max
(
öt64
 
a
, i¡64 
b
)

97  ((
a
Ë> (
b
)) ? (a) : (b);

98 
	}
}

100 
ölöe
 
di°blk
 
	$di°blkmö
(
di°blk
 
a
, di°blk 
b
)

102  ((
a
Ë< (
b
)) ? (a) : (b);

103 
	}
}

105 
ölöe
 
di°blk
 
	$di°blkmax
(
di°blk
 
a
, di°blk 
b
)

107  ((
a
Ë> (
b
)) ? (a) : (b);

108 
	}
}

110 
ölöe
 
	$ßbs
(
x
)

112 c⁄° 
SHORT_BITS
 = ((Ë* 
CHAR_BIT
) - 1;

113 
y
 = (Ë(
x
 >> 
SHORT_BITS
);

114  (Ë((
x
 ^ 
y
) - y);

115 
	}
}

117 
ölöe
 
	$übs
(
x
)

119 c⁄° 
INT_BITS
 = ((Ë* 
CHAR_BIT
) - 1;

120 
y
 = 
x
 >> 
INT_BITS
;

121  (
x
 ^ 
y
) - y;

122 
	}
}

124 
ölöe
 
	$dabs
(
x
)

126  ((
x
) < 0) ? -(x) : (x);

127 
	}
}

129 
ölöe
 
öt64
 
	$i64abs
(
öt64
 
x
)

131 c⁄° 
öt64
 
INT64_BITS
 = ((öt64Ë* 
CHAR_BIT
) - 1;

132 
öt64
 
y
 = 
x
 >> 
INT64_BITS
;

133  (
x
 ^ 
y
) - y;

134 
	}
}

136 
ölöe
 
	$dabs2
(
x
)

138  (
x
) * (x);

139 
	}
}

141 
ölöe
 
	$übs2
(
x
)

143  (
x
) * (x);

144 
	}
}

146 
ölöe
 
öt64
 
	$i64abs2
(
öt64
 
x
)

148  (
x
) * (x);

149 
	}
}

151 
ölöe
 
	$isign
(
x
)

153  ( (
x
 > 0) - (x < 0));

154 
	}
}

156 
ölöe
 
	$isig«b
(
a
, 
b
)

158  ((
b
Ë< 0Ë? -
	`übs
(
a
) : iabs(a);

159 
	}
}

161 
ölöe
 
	$rshi·_∫d
(
x
, 
a
)

163  (
a
 > 0Ë? ((
x
 + (1 << (a-1) )) >>á) : (x << (-a));

164 
	}
}

166 
ölöe
 
	$rshi·_∫d_sign
(
x
, 
a
)

168  (
x
 > 0Ë? ( ( x + (1 << (
a
-1)ËË>>á ) : (-––
	`übs
(x) + (1 << (a-1)) ) >>á ));

169 
	}
}

171 
ölöe
 
	$rshi·_∫d_us
(
x
, 
a
)

173  (
a
 > 0Ë? ((
x
 + (1 << (a-1))) >>á) : x;

174 
	}
}

176 
ölöe
 
	$rshi·_∫d_sf
(
x
, 
a
)

178  ((
x
 + (1 << (
a
-1) )) >>á);

179 
	}
}

181 
ölöe
 
	$shi·_off_sf
(
x
, 
o
, 
a
)

183  ((
x
 + 
o
Ë>> 
a
);

184 
	}
}

186 
ölöe
 
	$rshi·_∫d_us_sf
(
x
, 
a
)

188  ((
x
 + (1 << (
a
-1))) >>á);

189 
	}
}

191 
ölöe
 
	$iClù1
(
high
, 
x
)

193 
x
 = 
	`imax
(x, 0);

194 
x
 = 
	`imö
(x, 
high
);

196  
x
;

197 
	}
}

199 
ölöe
 
	$iClù3
(
low
, 
high
, 
x
)

201 
x
 = 
	`imax
(x, 
low
);

202 
x
 = 
	`imö
(x, 
high
);

204  
x
;

205 
	}
}

207 
ölöe
 
	$sClù3
(
low
, 
high
, 
x
)

209 
x
 = 
	`smax
(x, 
low
);

210 
x
 = 
	`smö
(x, 
high
);

212  
x
;

213 
	}
}

215 
ölöe
 
	$dClù3
(
low
, 
high
, 
x
)

217 
x
 = 
	`dmax
(x, 
low
);

218 
x
 = 
	`dmö
(x, 
high
);

220  
x
;

221 
	}
}

224 
ölöe
 
di°blk
 
	$weighãd_co°
(
Á˘‹
, 
bôs
)

226 #i‡
JCOST_CALC_SCALEUP


227  (((
di°blk
)(
Á˘‹
))*((di°blk)(
bôs
)));

229 #i‡(
USE_RND_COST
)

230  (
	`rshi·_∫d_sf
((
œmbda
Ë* (
bôs
), 
LAMBDA_ACCURACY_BITS
));

232  (((
Á˘‹
)*(
bôs
))>>
LAMBDA_ACCURACY_BITS
);

235 
	}
}

237 
ölöe
 
	$RSD
(
x
)

239  ((
x
&2)?(x|1):(x&(~1)));

240 
	}
}

242 
ölöe
 
	$powî2
(
x
)

244  1 << (
x
);

245 
	}
}

248 c⁄° 
öt64
 
	gpo2
[64] = {0x1,0x2,0x4,0x8,0x10,0x20,0x40,0x80,0x100,0x200,0x400,0x800,0x1000,0x2000,0x4000,0x8000,

258 
ölöe
 
öt64
 
	$i64_powî2
(
x
)

260 ((
x
 > 63Ë? 0 : 
po2
[x]);

261 
	}
}

263 
ölöe
 
	$Êﬂt2öt
 (
x
)

265  ()((
x
 < 0) ? (x - 0.5f) : (x + 0.5f));

266 
	}
}

268 
ölöe
 
	$gë_bô
(
öt64
 
x
,
n
)

270  ()(((
x
 >> 
n
) & 1));

271 
	}
}

273 #i‡
ZEROSNR


274 
ölöe
 
	$p¢r
(
max_ßm∂e_sq
, 
ßm∂es
, 
s£_di°‹ti⁄
 )

276  (Ë(10.0 * 
	`log10
(
max_ßm∂e_sq
 * (Ë((Ë
ßm∂es
 / (
s£_di°‹ti⁄
 < 1.0 ? 1.0 : sse_distortion))));

277 
	}
}

279 
ölöe
 
	$p¢r
(
max_ßm∂e_sq
, 
ßm∂es
, 
s£_di°‹ti⁄
 )

281  (Ë(
s£_di°‹ti⁄
 =0.0 ? 0.0 : (10.0 * 
	`log10
(
max_ßm∂e_sq
 * (Ë((Ë
ßm∂es
 / sse_distortion))));

282 
	}
}

285 
ölöe
 
	$CheckCo°_Shi·
(
öt64
 
mco°
, i¡64 
mö_mco°
)

287 if((
mco°
<<
LAMBDA_ACCURACY_BITS
Ë>
mö_mco°
)

291 
	}
}

293 
ölöe
 
	$CheckCo°
(
öt64
 
mco°
, i¡64 
mö_mco°
)

295  ((
mco°
Ë>(
mö_mco°
));

296 
	}
}

298 
ölöe
 
	$down_sˇÀ
(
di°blk
 *
pblkdi°Co°
)

300 #i‡
JCOST_CALC_SCALEUP


301 *
pblkdi°Co°
 = (*pblkdi°Co°)>>
LAMBDA_ACCURACY_BITS
;

303 
	}
}

305 
ölöe
 
	$up_sˇÀ
(
di°blk
 *
pblkdi°Co°
)

307 #i‡
JCOST_CALC_SCALEUP


308 *
pblkdi°Co°
 = (*pblkdi°Co°)<<
LAMBDA_ACCURACY_BITS
;

310 
	}
}

312 
ölöe
 
di°blk
 
	$di°_sˇÀ
(
di°blk
 
blkdi°Co°
)

314 #i‡
JCOST_CALC_SCALEUP


315  ((
blkdi°Co°
)<<
LAMBDA_ACCURACY_BITS
);

317  (
blkdi°Co°
);

319 
	}
}

321 
ölöe
 
	$di°_down
(
di°blk
 
blkdi°Co°
)

323 #i‡
JCOST_CALC_SCALEUP


324  (()((
blkdi°Co°
)>>
LAMBDA_ACCURACY_BITS
));

326  (()
blkdi°Co°
);

328 
	}
}

336 
ölöe
 
	$RoundLog2
 (
iVÆue
)

338 
iRë
 = 0;

339 
iVÆue_squ¨e
 = 
iVÆue
 * iValue;

340 (1 << (
iRë
 + 1)Ë<
iVÆue_squ¨e
)

341 ++
iRë
;

343 
iRë
 = (iRet + 1) >> 1;

344  
iRë
;

345 
	}
}

347 
ölöe
 
	$‰ì_poöãr
(*
poöãr
)

349 i‡(
poöãr
 !
NULL
)

351 
	`‰ì
(
poöãr
);

352 
poöãr
 = 
NULL
;

354 
	}
}

356 
ölöe
 
	$i32_sw≠
(
x
, 
y
)

358 
ãmp
 = 
x
;

359 
x
 = 
y
;

360 
y
 = 
ãmp
;

361 
	}
}

363 
ölöe
 
	$is_öåa_mb
(
mb_ty≥
)

365  (
mb_ty≥
==
SI4MB
 || mb_ty≥==
I4MB
 || mb_ty≥==
I16MB
 || mb_ty≥==
I8MB
 || mb_ty≥==
IPCM
);

366 
	}
}

368 #i‡!(
deföed
(
WIN32
Ë|| deföed(
WIN64
)Ë&& (
__STDC_VERSION__
 < 199901L)

370 #unde‡
ölöe


	@lcommon/inc/img_io.h

13 
	~"globÆ.h
"

15 #i‚de‡
_IMG_IO_H_


16 
	#_IMG_IO_H_


	)

18 
	~"io_video.h
"

19 
	~"io_øw.h
"

20 
	~"io_tiff.h
"

22 
P¨£SizeFromSåög
 (
VideoD©aFûe
 *
öput_fûe
, *
xÀn
, *
yÀn
, *
Âs
);

23 
P¨£FømeNoF‹m©FromSåög
 (
VideoD©aFûe
 *
öput_fûe
);

24 
O≥nFømeFûe
 (
VideoD©aFûe
 *
öput_fûe
, 
FømeNumbîInFûe
);

25 
O≥nFûes
 (
VideoD©aFûe
 *
öput_fûe
);

26 
Clo£Fûes
 (
VideoD©aFûe
 *
öput_fûe
);

27 
VideoFûeTy≥
 
P¨£VideoTy≥
 (
VideoD©aFûe
 *
öput_fûe
);

	@lcommon/inc/img_process.h

15 #i‚de‡
_IMG_PROCESS_H_


16 
	#_IMG_PROCESS_H_


	)

19 
öô_¥o˚ss_image
 ( 
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
 );

20 
˛ór_¥o˚ss_image
–
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
);

21 
¥o˚ss_image
 ( 
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
 );

	@lcommon/inc/img_process_types.h

16 #i‚de‡
_IMG_PROCESS_TYPES_H_


17 
	#_IMG_PROCESS_TYPES_H_


	)

19 
	#DEMUX_META_DEBUG
 1

	)

20 
	#MAX_NUM_PARTITIONS
 512

	)

21 
	#NUM_VIEWS
 2

	)

22 
	#NUM_COMPONENTS
 3

	)

	@lcommon/inc/input.h

13 #i‚de‡
_INPUT_H_


14 
	#_INPUT_H_


	)

16 
ã°Endün
();

17 
öôI≈ut
(
VideoP¨amëîs
 *
p_Vid
, 
FømeF‹m©
 *
sour˚
, FømeF‹m© *
ouçut
);

18 
AŒoˇãFømeMem‹y
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
FømeF‹m©
 *
sour˚
);

19 
DñëeFømeMem‹y
 (
VideoP¨amëîs
 *
p_Vid
);

21 
ªad_⁄e_‰ame
 (
VideoP¨amëîs
 *
p_Vid
, 
VideoD©aFûe
 *
öput_fûe
, 
FømeNoInFûe
, 
HódîSize
, 
FømeF‹m©
 *
sour˚
, FømeF‹m© *
ouçut
, 
img≥l
 **
pImage
[3]);

22 
∑d_b‹dîs
 ( 
FømeF‹m©
 
ouçut
, 
img_size_x
, 
img_size_y
, 
img_size_x_¸
, 
img_size_y_¸
, 
img≥l
 **
pImage
[3]);

	@lcommon/inc/io_image.h

14 #i‚de‡
_IO_IMAGE_H_


15 
	#_IO_IMAGE_H_


	)

17 
	~"deföes.h
"

18 
	~"‰ame.h
"

20 
	simage_d©a


22 
FømeF‹m©
 
	mf‹m©
;

24 
img≥l
 **
	m‰m_d©a
[
MAX_PLANE
];

25 
img≥l
 **
	mt›_d©a
[
MAX_PLANE
];

26 
img≥l
 **
	mbŸ_d©a
[
MAX_PLANE
];

28 
img≥l
 **
	m‰m_d©a_buf
[2][
MAX_PLANE
];

29 
img≥l
 **
	mt›_d©a_buf
[2][
MAX_PLANE
];

30 
img≥l
 **
	mbŸ_d©a_buf
[2][
MAX_PLANE
];

35 
uöt16
 **
	m‰m_uöt16
[
MAX_PLANE
];

36 
uöt16
 **
	mt›_uöt16
[
MAX_PLANE
];

37 
uöt16
 **
	mbŸ_uöt16
[
MAX_PLANE
];

39 
	m‰m_°ride
[
MAX_PLANE
];

40 
	mt›_°ride
[
MAX_PLANE
];

41 
	mbŸ_°ride
[
MAX_PLANE
];

42 } 
	tImageD©a
;

	@lcommon/inc/io_raw.h

15 #i‚de‡
_IO_RAW_H_


16 
	#_IO_RAW_H_


	)

18 
RódFømeC⁄ˇã«ãd
 (
I≈utP¨amëîs
 *
p_I≈
, 
VideoD©aFûe
 *
öput_fûe
, 
FømeNoInFûe
, 
HódîSize
, 
FømeF‹m©
 *
sour˚
, *
buf
);

19 
RódFømeSï¨©e
 (
I≈utP¨amëîs
 *
p_I≈
, 
VideoD©aFûe
 *
öput_fûe
, 
FømeNoInFûe
, 
HódîSize
, 
FømeF‹m©
 *
sour˚
, *
buf
);

	@lcommon/inc/io_tiff.h

16 #i‚de‡
_IO_TIFF_H_


17 
	#_IO_TIFF_H_


	)

22 
RódTIFFImage
 (
I≈utP¨amëîs
 *
p_I≈
, 
VideoD©aFûe
 *
öput_fûe
, 
FømeNoInFûe
, 
FømeF‹m©
 *
sour˚
, *
buf
);

	@lcommon/inc/io_video.h

14 #i‚de‡
_IO_VIDEO_H_


15 
	#_IO_VIDEO_H_


	)

17 
	~"‰ame.h
"

19 
	svideo_size
 {

20 * 
	m«me
;

21 
	mx_size
;

22 
	my_size
;

23 } 
	tVIDEO_SIZE
;

26 
	mVIDEO_UNKNOWN
 = -1,

27 
	mVIDEO_YUV
 = 0,

28 
	mVIDEO_RGB
 = 1,

29 
	mVIDEO_XYZ
 = 2,

30 
	mVIDEO_TIFF
 = 3,

31 
	mVIDEO_AVI
 = 4

32 } 
	tVideoFûeTy≥
;

34 
	svideo_d©a_fûe


37 
	m‚ame
[
FILE_NAME_SIZE
];

38 
	mfhód
[
FILE_NAME_SIZE
];

39 
	m·aû
[
FILE_NAME_SIZE
];

40 
	mf_num
;

41 
VideoFûeTy≥
 
	mvdty≥
;

42 
FømeF‹m©
 
	mf‹m©
;

43 
	mis_c⁄ˇã«ãd
;

44 
	mis_öãæóved
;

45 
	mzîo_∑d
;

46 
	mnum_digôs
;

47 
	m°¨t_‰ame
;

48 
	míd_‰ame
;

49 
	mn‰ames
;

50 
	m¸›_x_size
;

51 
	m¸›_y_size
;

52 
	m¸›_x_off£t
;

53 
	m¸›_y_off£t
;

56 * 
	mavi
;

60 } 
	tVideoD©aFûe
;

	@lcommon/inc/lagrangian.h

14 #i‚de‡
_LAGRANGIAN_H_


15 
	#_LAGRANGIAN_H_


	)

17 
	sœmbda_∑øms


19 
	mmd
;

20 
	mme
[3];

21 
	mmf
[3];

22 } 
	tLambdaP¨ams
;

	@lcommon/inc/mb_access.h

16 #i‚de‡
_MB_ACCESS_H_


17 
	#_MB_ACCESS_H_


	)

19 
CheckAvaûabûôyOfNeighb‹s
(
Ma¸oblock
 *
cuºMB
);

20 
CheckAvaûabûôyOfNeighb‹sMBAFF
(
Ma¸oblock
 *
cuºMB
);

21 
CheckAvaûabûôyOfNeighb‹sN‹mÆ
(
Ma¸oblock
 *
cuºMB
);

23 
gëAffNeighbour
 (
Ma¸oblock
 *
cuºMB
, 
xN
, 
yN
, 
mb_size
[2], 
PixñPos
 *
pix
);

24 
gëN⁄AffNeighbour
 (
Ma¸oblock
 *
cuºMB
, 
xN
, 
yN
, 
mb_size
[2], 
PixñPos
 *
pix
);

25 
gë4x4Neighbour
 (
Ma¸oblock
 *
cuºMB
, 
xN
, 
yN
, 
mb_size
[2], 
PixñPos
 *
pix
);

26 
gë4x4NeighbourBa£
 (
Ma¸oblock
 *
cuºMB
, 
block_x
, 
block_y
, 
mb_size
[2], 
PixñPos
 *
pix
);

27 
Boﬁón
 
mb_is_avaûabÀ
 (
mbAddr
, 
Ma¸oblock
 *
cuºMB
);

28 
gë_mb_pos
 (
VideoP¨amëîs
 *
p_Vid
, 
mb_addr
, 
mb_size
[2], *
x
, *
y
);

29 
gë_mb_block_pos_n‹mÆ
 (
BlockPos
 *
PicPos
, 
mb_addr
, *
x
, *
y
);

30 
gë_mb_block_pos_mbaff
 (
BlockPos
 *
PicPos
, 
mb_addr
, *
x
, *
y
);

	@lcommon/inc/mbuffer_common.h

16 #i‚de‡
_MBUFFER_COMMON_H_


17 
	#_MBUFFER_COMMON_H_


	)

26 
ölöe
 
	$com∑ª_pic_by_pic_num_desc
–c⁄° *
¨g1
, c⁄° *
¨g2
 )

28 
pic_num1
 = (*(
St‹abÀPi˘uª
**)
¨g1
)->
pic_num
;

29 
pic_num2
 = (*(
St‹abÀPi˘uª
**)
¨g2
)->
pic_num
;

31 i‡(
pic_num1
 < 
pic_num2
)

33 i‡(
pic_num1
 > 
pic_num2
)

37 
	}
}

46 
ölöe
 
	$com∑ª_pic_by_…_pic_num_asc
–c⁄° *
¨g1
, c⁄° *
¨g2
 )

48 
l⁄g_ãrm_pic_num1
 = (*(
St‹abÀPi˘uª
**)
¨g1
)->
l⁄g_ãrm_pic_num
;

49 
l⁄g_ãrm_pic_num2
 = (*(
St‹abÀPi˘uª
**)
¨g2
)->
l⁄g_ãrm_pic_num
;

51 i‡–
l⁄g_ãrm_pic_num1
 < 
l⁄g_ãrm_pic_num2
)

53 i‡–
l⁄g_ãrm_pic_num1
 > 
l⁄g_ãrm_pic_num2
)

57 
	}
}

66 
ölöe
 
	$com∑ª_fs_by_‰ame_num_desc
–c⁄° *
¨g1
, c⁄° *
¨g2
 )

68 
‰ame_num_wøp1
 = (*(
FømeSt‹e
**)
¨g1
)->
‰ame_num_wøp
;

69 
‰ame_num_wøp2
 = (*(
FømeSt‹e
**)
¨g2
)->
‰ame_num_wøp
;

70 i‡–
‰ame_num_wøp1
 < 
‰ame_num_wøp2
)

72 i‡–
‰ame_num_wøp1
 > 
‰ame_num_wøp2
)

76 
	}
}

86 
ölöe
 
	$com∑ª_fs_by_…_pic_idx_asc
–c⁄° *
¨g1
, c⁄° *
¨g2
 )

88 
l⁄g_ãrm_‰ame_idx1
 = (*(
FømeSt‹e
**)
¨g1
)->
l⁄g_ãrm_‰ame_idx
;

89 
l⁄g_ãrm_‰ame_idx2
 = (*(
FømeSt‹e
**)
¨g2
)->
l⁄g_ãrm_‰ame_idx
;

91 i‡–
l⁄g_ãrm_‰ame_idx1
 < 
l⁄g_ãrm_‰ame_idx2
)

93 i‡–
l⁄g_ãrm_‰ame_idx1
 > 
l⁄g_ãrm_‰ame_idx2
)

97 
	}
}

107 
ölöe
 
	$com∑ª_pic_by_poc_asc
–c⁄° *
¨g1
, c⁄° *
¨g2
 )

109 
poc1
 = (*(
St‹abÀPi˘uª
**)
¨g1
)->
poc
;

110 
poc2
 = (*(
St‹abÀPi˘uª
**)
¨g2
)->
poc
;

112 i‡–
poc1
 < 
poc2
)

114 i‡–
poc1
 > 
poc2
)

118 
	}
}

128 
ölöe
 
	$com∑ª_pic_by_poc_desc
–c⁄° *
¨g1
, c⁄° *
¨g2
 )

130 
poc1
 = (*(
St‹abÀPi˘uª
**)
¨g1
)->
poc
;

131 
poc2
 = (*(
St‹abÀPi˘uª
**)
¨g2
)->
poc
;

133 i‡(
poc1
 < 
poc2
)

135 i‡(
poc1
 > 
poc2
)

139 
	}
}

149 
ölöe
 
	$com∑ª_fs_by_poc_asc
–c⁄° *
¨g1
, c⁄° *
¨g2
 )

151 
poc1
 = (*(
FømeSt‹e
**)
¨g1
)->
poc
;

152 
poc2
 = (*(
FømeSt‹e
**)
¨g2
)->
poc
;

154 i‡(
poc1
 < 
poc2
)

156 i‡(
poc1
 > 
poc2
)

160 
	}
}

170 
ölöe
 
	$com∑ª_fs_by_poc_desc
–c⁄° *
¨g1
, c⁄° *
¨g2
 )

172 
poc1
 = (*(
FømeSt‹e
**)
¨g1
)->
poc
;

173 
poc2
 = (*(
FømeSt‹e
**)
¨g2
)->
poc
;

175 i‡(
poc1
 < 
poc2
)

177 i‡(
poc1
 > 
poc2
)

181 
	}
}

190 
ölöe
 
	$is_sh‹t_ªf
(
St‹abÀPi˘uª
 *
s
)

192  ((
s
->
u£d_f‹_ª„ªn˚
Ë&& (!(s->
is_l⁄g_ãrm
)));

193 
	}
}

203 
ölöe
 
	$is_l⁄g_ªf
(
St‹abÀPi˘uª
 *
s
)

205  ((
s
->
u£d_f‹_ª„ªn˚
Ë&& (s->
is_l⁄g_ãrm
));

206 
	}
}

209 
gí_pic_li°_‰om_‰ame_li°
(
Pi˘uªSåu˘uª
 
cuºSåu˘uª
, 
FømeSt‹e
 **
fs_li°
, 
li°_idx
, 
St‹abÀPi˘uª
 **
li°
, *
li°_size
, 
l⁄g_ãrm
);

210 
St‹abÀPi˘uª
* 
gë_l⁄g_ãrm_pic
(
Sli˚
 *
cuºSli˚
, 
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
L⁄gãrmPicNum
);

211 
upd©e_ªf_li°
(
DecodedPi˘uªBuf„r
 *
p_Dpb
);

212 
upd©e_…ªf_li°
(
DecodedPi˘uªBuf„r
 *
p_Dpb
);

213 
mm_m¨k_cuºít_pi˘uª_l⁄g_ãrm
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
St‹abÀPi˘uª
 *
p
, 
l⁄g_ãrm_‰ame_idx
);

214 
mm_unm¨k_sh‹t_ãrm_f‹_ª„ªn˚
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
St‹abÀPi˘uª
 *
p
, 
dif„ªn˚_of_pic_nums_möus1
);

215 
mm_unm¨k_l⁄g_ãrm_f‹_ª„ªn˚
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
St‹abÀPi˘uª
 *
p
, 
l⁄g_ãrm_pic_num
);

216 
mm_assign_l⁄g_ãrm_‰ame_idx
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
St‹abÀPi˘uª
* 
p
, 
dif„ªn˚_of_pic_nums_möus1
, 
l⁄g_ãrm_‰ame_idx
);

217 
mm_upd©e_max_l⁄g_ãrm_‰ame_idx
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
max_l⁄g_ãrm_‰ame_idx_∂us1
);

218 
mm_unm¨k_Æl_sh‹t_ãrm_f‹_ª„ªn˚
 (
DecodedPi˘uªBuf„r
 *
p_Dpb
);

219 
mm_unm¨k_Æl_l⁄g_ãrm_f‹_ª„ªn˚
 (
DecodedPi˘uªBuf„r
 *
p_Dpb
);

220 
is_u£d_f‹_ª„ªn˚
 (
FømeSt‹e
* 
fs
);

221 
gë_smÆÀ°_poc
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, *
poc
,* 
pos
);

222 
ªmove_unu£d_‰ame_‰om_dpb
(
DecodedPi˘uªBuf„r
 *
p_Dpb
);

	@lcommon/inc/memalloc.h

17 #i‚de‡
_MEMALLOC_H_


18 
	#_MEMALLOC_H_


	)

20 
	~"globÆ.h
"

21 
	~"mbuf„r.h
"

22 
	~"di°‹ti⁄.h
"

23 
	~"œgøngün.h
"

24 
	~"qu™t_∑øms.h
"

26 
gë_mem2Ddi°
(
Di°‹ti⁄D©a
 ***
¨øy2D
, 
dim0
, 
dim1
);

28 
gë_mem2Dlm
 (
LambdaP¨ams
 ***
¨øy2D
, 
dim0
, 
dim1
);

29 
gë_mem2Dﬁm
 (
LambdaP¨ams
 ***
¨øy2D
, 
dim0
, 
dim1
, 
off£t
);

31 
gë_mem2Dmp
 (
PicMŸi⁄P¨ams
 ***
¨øy2D
, 
dim0
, 
dim1
);

32 
gë_mem3Dmp
 (
PicMŸi⁄P¨ams
 ****
¨øy3D
, 
dim0
, 
dim1
, 
dim2
);

34 
gë_mem2Dqu™t
(
LevñQu™tP¨ams
 ***
¨øy2D
, 
dim0
, 
dim1
);

35 
gë_mem3Dqu™t
(
LevñQu™tP¨ams
 ****
¨øy3D
, 
dim0
, 
dim1
, 
dim2
);

36 
gë_mem4Dqu™t
(
LevñQu™tP¨ams
 *****
¨øy4D
, 
dim0
, 
dim1
, 
dim2
, 
dim3
);

37 
gë_mem5Dqu™t
(
LevñQu™tP¨ams
 ******
¨øy5D
, 
dim0
, 
dim1
, 
dim2
, 
dim3
, 
dim4
);

39 
gë_mem2Dmv
 (
MŸi⁄Ve˘‹
 ***
¨øy2D
, 
dim0
, 
dim1
);

40 
gë_mem3Dmv
 (
MŸi⁄Ve˘‹
 ****
¨øy3D
, 
dim0
, 
dim1
, 
dim2
);

41 
gë_mem4Dmv
 (
MŸi⁄Ve˘‹
 *****
¨øy4D
, 
dim0
, 
dim1
, 
dim2
, 
dim3
);

42 
gë_mem5Dmv
 (
MŸi⁄Ve˘‹
 ******
¨øy5D
, 
dim0
, 
dim1
, 
dim2
, 
dim3
, 
dim4
);

43 
gë_mem6Dmv
 (
MŸi⁄Ve˘‹
 *******
¨øy6D
, 
dim0
, 
dim1
, 
dim2
, 
dim3
, 
dim4
, 
dim5
);

44 
gë_mem7Dmv
 (
MŸi⁄Ve˘‹
 ********
¨øy7D
, 
dim0
, 
dim1
, 
dim2
, 
dim3
, 
dim4
, 
dim5
, 
dim6
);

46 
byã
** 
√w_mem2D
(
dim0
, 
dim1
);

47 
gë_mem2D
(
byã
 ***
¨øy2D
, 
dim0
, 
dim1
);

48 
gë_mem3D
(
byã
 ****
¨øy3D
, 
dim0
, 
dim1
, 
dim2
);

49 
gë_mem4D
(
byã
 *****
¨øy4D
, 
dim0
, 
dim1
, 
dim2
, 
dim3
);

51 ** 
√w_mem2Döt
(
dim0
, 
dim1
);

52 
gë_mem2Döt
(***
¨øy2D
, 
dim0
, 
dim1
);

53 
gë_mem2Döt_∑d
(***
¨øy2D
, 
dim0
, 
dim1
, 
iPadY
, 
iPadX
);

54 
gë_mem2Döt64
(
öt64
 ***
¨øy2D
, 
dim0
, 
dim1
);

55 
gë_mem3Döt
(****
¨øy3D
, 
dim0
, 
dim1
, 
dim2
);

56 
gë_mem3Döt64
(
öt64
 ****
¨øy3D
, 
dim0
, 
dim1
, 
dim2
);

57 
gë_mem4Döt
(*****
¨øy4D
, 
dim0
, 
dim1
, 
dim2
, 
dim3
);

58 
gë_mem4Döt64
(
öt64
 *****
¨øy4D
, 
dim0
, 
dim1
, 
dim2
, 
dim3
);

59 
gë_mem5Döt
(******
¨øy5D
, 
dim0
, 
dim1
, 
dim2
, 
dim3
, 
dim4
);

61 
uöt16
** 
√w_mem2Duöt16
(
dim0
, 
dim1
);

62 
gë_mem2Duöt16
(
uöt16
 ***
¨øy2D
, 
dim0
, 
dim1
);

63 
gë_mem3Duöt16
(
uöt16
 ****
¨øy3D
,
dim0
, 
dim1
, 
dim2
);

65 
gë_mem2Ddi°blk
(
di°blk
 ***
¨øy2D
, 
dim0
, 
dim1
);

66 
gë_mem3Ddi°blk
(
di°blk
 ****
¨øy3D
, 
dim0
, 
dim1
, 
dim2
);

67 
gë_mem4Ddi°blk
(
di°blk
 *****
¨øy4D
, 
dim0
, 
dim1
, 
dim2
, 
dim3
);

69 
gë_mem2Dsh‹t
(***
¨øy2D
, 
dim0
, 
dim1
);

70 
gë_mem3Dsh‹t
(****
¨øy3D
, 
dim0
, 
dim1
, 
dim2
);

71 
gë_mem4Dsh‹t
(*****
¨øy4D
, 
dim0
, 
dim1
, 
dim2
, 
dim3
);

72 
gë_mem5Dsh‹t
(******
¨øy5D
, 
dim0
, 
dim1
, 
dim2
, 
dim3
, 
dim4
);

73 
gë_mem6Dsh‹t
(*******
¨øy6D
, 
dim0
, 
dim1
, 
dim2
, 
dim3
, 
dim4
, 
dim5
);

74 
gë_mem7Dsh‹t
(********
¨øy7D
, 
dim0
, 
dim1
, 
dim2
, 
dim3
, 
dim4
, 
dim5
, 
dim6
);

76 
gë_mem1D≥l
(
img≥l
 **
¨øy2D
, 
dim0
);

77 
gë_mem2D≥l
(
img≥l
 ***
¨øy2D
, 
dim0
, 
dim1
);

78 
gë_mem2D≥l_∑d
(
img≥l
 ***
¨øy2D
, 
dim0
, 
dim1
, 
iPadY
, 
iPadX
);

80 
gë_mem3D≥l
 (
img≥l
 ****
¨øy3D
, 
dim0
, 
dim1
, 
dim2
);

81 
gë_mem3D≥l_∑d
(
img≥l
 ****
¨øy3D
, 
dim0
, 
dim1
, 
dim2
, 
iPadY
, 
iPadX
);

82 
gë_mem4D≥l
 (
img≥l
 *****
¨øy4D
, 
dim0
, 
dim1
, 
dim2
, 
dim3
);

83 
gë_mem4D≥l_∑d
(
img≥l
 *****
¨øy4D
, 
dim0
, 
dim1
, 
dim2
, 
dim3
, 
iPadY
, 
iPadX
);

84 
gë_mem5D≥l
 (
img≥l
 ******
¨øy5D
, 
dim0
, 
dim1
, 
dim2
, 
dim3
, 
dim4
);

85 
gë_mem5D≥l_∑d
(
img≥l
 ******
¨øy5D
, 
dim0
, 
dim1
, 
dim2
, 
dim3
, 
dim4
, 
iPadY
, 
iPadX
);

86 
gë_mem2DdoubÀ
 (***
¨øy2D
, 
dim0
, 
dim1
);

88 
gë_mem1DodoubÀ
(**
¨øy1D
, 
dim0
, 
off£t
);

89 
gë_mem2DodoubÀ
(***
¨øy2D
, 
dim0
, 
dim1
, 
off£t
);

90 
gë_mem3DodoubÀ
(****
¨øy2D
, 
dim0
, 
dim1
, 
dim2
, 
off£t
);

92 
gë_mem2Doöt
 (***
¨øy2D
, 
dim0
, 
dim1
, 
off£t
);

93 
gë_mem3Doöt
 (****
¨øy3D
, 
dim0
, 
dim1
, 
dim2
, 
off£t
);

95 
gë_mem2Dwp
 (
WPP¨ams
 ***
¨øy2D
, 
dim0
, 
dim1
);

97 
gë_off£t_mem2Dsh‹t
(***
¨øy2D
, 
rows
, 
cﬁumns
, 
off£t_y
, 
off£t_x
);

99 
‰ì_off£t_mem2Dsh‹t
(**
¨øy2D
, 
cﬁumns
, 
off£t_x
, 
off£t_y
);

101 
‰ì_mem2Ddi°
 (
Di°‹ti⁄D©a
 **
¨øy2D
);

103 
‰ì_mem2Dlm
 (
LambdaP¨ams
 **
¨øy2D
);

104 
‰ì_mem2Dﬁm
 (
LambdaP¨ams
 **
¨øy2D
, 
off£t
);

106 
‰ì_mem2Dmp
 (
PicMŸi⁄P¨ams
 **
¨øy2D
);

107 
‰ì_mem3Dmp
 (
PicMŸi⁄P¨ams
 ***
¨øy2D
);

109 
‰ì_mem2Dqu™t
(
LevñQu™tP¨ams
 **
¨øy2D
);

110 
‰ì_mem3Dqu™t
(
LevñQu™tP¨ams
 ***
¨øy2D
);

111 
‰ì_mem4Dqu™t
(
LevñQu™tP¨ams
 ****
¨øy2D
);

112 
‰ì_mem5Dqu™t
(
LevñQu™tP¨ams
 *****
¨øy2D
);

114 
‰ì_mem2Dmv
 (
MŸi⁄Ve˘‹
 **
¨øy2D
);

115 
‰ì_mem3Dmv
 (
MŸi⁄Ve˘‹
 ***
¨øy2D
);

116 
‰ì_mem4Dmv
 (
MŸi⁄Ve˘‹
 ****
¨øy2D
);

117 
‰ì_mem5Dmv
 (
MŸi⁄Ve˘‹
 *****
¨øy2D
);

118 
‰ì_mem6Dmv
 (
MŸi⁄Ve˘‹
 ******
¨øy2D
);

119 
‰ì_mem7Dmv
 (
MŸi⁄Ve˘‹
 *******
¨øy7D
);

121 
gë_mem2D_•p
(
St‹abÀPi˘uªPå
 ***
¨øy3D
, 
dim0
, 
dim1
);

122 
gë_mem3D_•p
(
St‹abÀPi˘uªPå
 ****
¨øy3D
, 
dim0
, 
dim1
, 
dim2
);

124 
‰ì_mem2D_•p
 (
St‹abÀPi˘uªPå
 **
¨øy2D
);

125 
‰ì_mem3D_•p
 (
St‹abÀPi˘uªPå
 ***
¨øy2D
);

127 
‰ì_mem2D
 (
byã
 **
¨øy2D
);

128 
‰ì_mem3D
 (
byã
 ***
¨øy3D
);

129 
‰ì_mem4D
 (
byã
 ****
¨øy4D
);

131 
‰ì_mem2Döt
 (**
¨øy2D
);

132 
‰ì_mem2Döt_∑d
(**
¨øy2D
, 
iPadY
, 
iPadX
);

133 
‰ì_mem3Döt
 (***
¨øy3D
);

134 
‰ì_mem4Döt
 (****
¨øy4D
);

135 
‰ì_mem5Döt
 (*****
¨øy5D
);

137 
‰ì_mem2Duöt16
(
uöt16
 **
¨øy2D
);

138 
‰ì_mem3Duöt16
(
uöt16
 ***
¨øy3D
);

140 
‰ì_mem2Döt64
(
öt64
 **
¨øy2D
);

141 
‰ì_mem3Döt64
(
öt64
 ***
¨øy3D
);

142 
‰ì_mem4Döt64
(
öt64
 ****
¨øy4D
);

144 
‰ì_mem2Ddi°blk
(
di°blk
 **
¨øy2D
);

145 
‰ì_mem3Ddi°blk
(
di°blk
 ***
¨øy3D
);

146 
‰ì_mem4Ddi°blk
(
di°blk
 ****
¨øy4D
);

148 
‰ì_mem2Dsh‹t
(**
¨øy2D
);

149 
‰ì_mem3Dsh‹t
(***
¨øy3D
);

150 
‰ì_mem4Dsh‹t
(****
¨øy4D
);

151 
‰ì_mem5Dsh‹t
(*****
¨øy5D
);

152 
‰ì_mem6Dsh‹t
(******
¨øy6D
);

153 
‰ì_mem7Dsh‹t
(*******
¨øy7D
);

155 
‰ì_mem1D≥l
 (
img≥l
 *
¨øy1D
);

156 
‰ì_mem2D≥l
 (
img≥l
 **
¨øy2D
);

157 
‰ì_mem2D≥l_∑d
(
img≥l
 **
¨øy2D
, 
iPadY
, 
iPadX
);

158 
‰ì_mem3D≥l
 (
img≥l
 ***
¨øy3D
);

159 
‰ì_mem3D≥l_∑d
(
img≥l
 ***
¨øy3D
, 
iDim12
, 
iPadY
, 
iPadX
);

160 
‰ì_mem4D≥l
 (
img≥l
 ****
¨øy4D
);

161 
‰ì_mem4D≥l_∑d
(
img≥l
 ****
¨øy4D
, 
iFømes
, 
iPadY
, 
iPadX
);

162 
‰ì_mem5D≥l
 (
img≥l
 *****
¨øy5D
);

163 
‰ì_mem5D≥l_∑d
(
img≥l
 *****
¨øy5D
, 
iFømes
, 
iPadY
, 
iPadX
);

164 
‰ì_mem2DdoubÀ
 (**
¨øy2D
);

165 
‰ì_mem3DdoubÀ
 (***
¨øy3D
);

167 
‰ì_mem1DodoubÀ
(*
¨øy1D
, 
off£t
);

168 
‰ì_mem2DodoubÀ
(**
¨øy2D
, 
off£t
);

169 
‰ì_mem3DodoubÀ
(***
¨øy3D
, 
rows
, 
cﬁumns
, 
off£t
);

170 
‰ì_mem2Doöt
 (**
¨øy2D
, 
off£t
);

171 
‰ì_mem3Doöt
 (***
¨øy3D
, 
rows
, 
cﬁumns
, 
off£t
);

173 
öô_t›_bŸ_∂™es
(
img≥l
 **
imgFøme
, 
height
, img≥»***
imgT›Fõld
, img≥»***
imgBŸFõld
);

174 
‰ì_t›_bŸ_∂™es
(
img≥l
 **
imgT›Fõld
, img≥»**
imgBŸFõld
);

176 
‰ì_mem2Dwp
 (
WPP¨ams
 **
¨øy2D
);

178 
c›y2DImage
(
img≥l
 **
d°_img
, img≥»**
§c_img
, 
size_x
, 
size_y
);

179 
no_mem_exô
(*
whîe
);

180 
mÆloc_mem2D≥l_2SLayîs
(
img≥l
 ***
buf0
, 
imgty≥0
, img≥»***
buf1
, 
imgty≥1
, 
height
, 
width
);

181 
mÆloc_mem3D≥l_2SLayîs
(
img≥l
 ****
buf0
, 
imgty≥0
, img≥»****
buf1
, 
imgty≥1
, 
‰ames
, 
height
, 
width
);

183 
‰ì_mem2D≥l_2SLayîs
(
img≥l
 ***
buf0
, img≥»***
buf1
);

184 
‰ì_mem3D≥l_2SLayîs
(
img≥l
 ****
buf0
, img≥»****
buf1
);

187 
ölöe
 * 
	$mem_mÆloc
(
size_t
 
nôems
)

189 *
d
;

190 if((
d
 = 
	`mÆloc
(
nôems
)Ë=
NULL
)

192 
	`no_mem_exô
("malloc failed.\n");

193  
NULL
;

195  
d
;

196 
	}
}

204 
ölöe
 * 
	$mem_ˇŒoc
(
size_t
 
nôems
, size_à
size
)

206 
size_t
 
∑dded_size
 = 
nôems
 * 
size
;

207 *
d
 = 
	`mem_mÆloc
(
∑dded_size
);

208 
	`mem£t
(
d
, 0, ()
∑dded_size
);

209  
d
;

210 
	}
}

212 
ölöe
 
	$mem_‰ì
(*
a
)

214 
	`‰ì_poöãr
(
a
);

215 
	}
}

	@lcommon/inc/mv_prediction.h

14 #i‚de‡
_MV_PREDICTION_H_


15 
	#_MV_PREDICTION_H_


	)

17 
öô_mŸi⁄_ve˘‹_¥edi˘i⁄
(
Ma¸oblock
 *
cuºMB
, 
mb_aff_‰ame_Êag
);

	@lcommon/inc/nalucommon.h

15 #i‚de‡
_NALUCOMMON_H_


16 
	#_NALUCOMMON_H_


	)

18 
	~"deföes.h
"

20 
	#MAXRBSPSIZE
 64000

	)

21 
	#MAXNALUSIZE
 64000

	)

25 
	mNALU_TYPE_SLICE
 = 1,

26 
	mNALU_TYPE_DPA
 = 2,

27 
	mNALU_TYPE_DPB
 = 3,

28 
	mNALU_TYPE_DPC
 = 4,

29 
	mNALU_TYPE_IDR
 = 5,

30 
	mNALU_TYPE_SEI
 = 6,

31 
	mNALU_TYPE_SPS
 = 7,

32 
	mNALU_TYPE_PPS
 = 8,

33 
	mNALU_TYPE_AUD
 = 9,

34 
	mNALU_TYPE_EOSEQ
 = 10,

35 
	mNALU_TYPE_EOSTREAM
 = 11,

36 
	mNALU_TYPE_FILL
 = 12,

37 #i‡(
MVC_EXTENSION_ENABLE
)

38 
	mNALU_TYPE_PREFIX
 = 14,

39 
	mNALU_TYPE_SUB_SPS
 = 15,

40 
	mNALU_TYPE_SLC_EXT
 = 20,

41 
	mNALU_TYPE_VDRD
 = 24

43 } 
	tNÆuTy≥
;

47 
	mNALU_PRIORITY_HIGHEST
 = 3,

48 
	mNALU_PRIORITY_HIGH
 = 2,

49 
	mNALU_PRIORITY_LOW
 = 1,

50 
	mNALU_PRIORITY_DISPOSABLE
 = 0

51 } 
	tNÆRefIdc
;

54 
	s«lu_t


56 
	m°¨tcodïªfix_Àn
;

57 
	mÀn
;

58 
	mmax_size
;

59 
	mf‹biddí_bô
;

60 
NÆuTy≥
 
	m«l_unô_ty≥
;

61 
NÆRefIdc
 
	m«l_ª„ªn˚_idc
;

62 
byã
 *
	mbuf
;

63 
uöt16
 
	mlo°_∑ckës
;

64 #i‡(
MVC_EXTENSION_ENABLE
)

65 
	msvc_exãnsi⁄_Êag
;

66 
	mn⁄_idr_Êag
;

67 
	m¥i‹ôy_id
;

68 
	mvõw_id
;

69 
	mãmp‹Æ_id
;

70 
	m™ch‹_pic_Êag
;

71 
	möãr_võw_Êag
;

72 
	mª£rved_⁄e_bô
;

74 } 
	tNALU_t
;

77 
NALU_t
 *
AŒocNALU
();

80 
FªeNALU
(
NALU_t
 *
n
);

82 #i‡(
MVC_EXTENSION_ENABLE
)

83 
«l_unô_hódî_svc_exãnsi⁄
();

84 
¥efix_«l_unô_svc
();

	@lcommon/inc/parsetcommon.h

26 #i‚de‡
_PARSETCOMMON_H_


27 
	#_PARSETCOMMON_H_


	)

29 
	~"deföes.h
"

31 
	#MAXIMUMPARSETRBSPSIZE
 1500

	)

32 
	#MAXIMUMPARSETNALUSIZE
 1500

	)

34 
	#MAXSPS
 32

	)

35 
	#MAXPPS
 256

	)

37 
	#MAXIMUMVALUEOF˝b_˙t
 32

	)

40 
	m˝b_˙t_möus1
;

41 
	mbô_øã_sˇÀ
;

42 
	m˝b_size_sˇÀ
;

43 
	mbô_øã_vÆue_möus1
 [
MAXIMUMVALUEOF˝b_˙t
];

44 
	m˝b_size_vÆue_möus1
 [
MAXIMUMVALUEOF˝b_˙t
];

45 
	mcbr_Êag
 [
MAXIMUMVALUEOF˝b_˙t
];

46 
	möôül_˝b_ªmovÆ_dñay_Àngth_möus1
;

47 
	m˝b_ªmovÆ_dñay_Àngth_möus1
;

48 
	mdpb_ouçut_dñay_Àngth_möus1
;

49 
	mtime_off£t_Àngth
;

50 } 
	thrd_∑ømëîs_t
;

55 
Boﬁón
 
	ma•e˘_øtio_öfo_¥e£¡_Êag
;

56 
	ma•e˘_øtio_idc
;

57 
	mßr_width
;

58 
	mßr_height
;

59 
Boﬁón
 
	movîsˇn_öfo_¥e£¡_Êag
;

60 
Boﬁón
 
	movîsˇn_≠¥›rüã_Êag
;

61 
Boﬁón
 
	mvideo_sig«l_ty≥_¥e£¡_Êag
;

62 
	mvideo_f‹m©
;

63 
Boﬁón
 
	mvideo_fuŒ_ønge_Êag
;

64 
Boﬁón
 
	mcﬁour_des¸ùti⁄_¥e£¡_Êag
;

65 
	mcﬁour_¥im¨õs
;

66 
	må™s„r_ch¨a˘îi°ics
;

67 
	mm©rix_c€fficõ¡s
;

68 
Boﬁón
 
	mchroma_loˇti⁄_öfo_¥e£¡_Êag
;

69 
	mchroma_ßm∂e_loc_ty≥_t›_fõld
;

70 
	mchroma_ßm∂e_loc_ty≥_bŸtom_fõld
;

71 
Boﬁón
 
	mtimög_öfo_¥e£¡_Êag
;

72 
	mnum_unôs_ö_tick
;

73 
	mtime_sˇÀ
;

74 
Boﬁón
 
	mfixed_‰ame_øã_Êag
;

75 
Boﬁón
 
	m«l_hrd_∑ømëîs_¥e£¡_Êag
;

76 
hrd_∑ømëîs_t
 
	m«l_hrd_∑ømëîs
;

77 
Boﬁón
 
	mv˛_hrd_∑ømëîs_¥e£¡_Êag
;

78 
hrd_∑ømëîs_t
 
	mv˛_hrd_∑ømëîs
;

80 
Boﬁón
 
	mlow_dñay_hrd_Êag
;

81 
Boﬁón
 
	mpic_°ru˘_¥e£¡_Êag
;

82 
Boﬁón
 
	mbô°ªam_ª°ri˘i⁄_Êag
;

83 
Boﬁón
 
	mmŸi⁄_ve˘‹s_ovî_pic_bound¨õs_Êag
;

84 
	mmax_byãs_≥r_pic_díom
;

85 
	mmax_bôs_≥r_mb_díom
;

86 
	mlog2_max_mv_Àngth_vîtiˇl
;

87 
	mlog2_max_mv_Àngth_h‹iz⁄èl
;

88 
	mnum_ª‹dî_‰ames
;

89 
	mmax_dec_‰ame_buf„rög
;

90 } 
	tvui_£q_∑ømëîs_t
;

93 
	#MAXnum_¶i˚_groups_möus1
 8

	)

96 
Boﬁón
 
	mVÆid
;

97 
	mpic_∑ømëî_£t_id
;

98 
	m£q_∑ømëî_£t_id
;

99 
Boﬁón
 
	míå›y_codög_mode_Êag
;

100 
Boﬁón
 
	må™sf‹m_8x8_mode_Êag
;

102 
Boﬁón
 
	mpic_sˇlög_m©rix_¥e£¡_Êag
;

103 
	mpic_sˇlög_li°_¥e£¡_Êag
[12];

104 
	mSˇlögLi°4x4
[6][16];

105 
	mSˇlögLi°8x8
[6][64];

106 
Boﬁón
 
	mU£DeÁu…SˇlögM©rix4x4Fœg
[6];

107 
Boﬁón
 
	mU£DeÁu…SˇlögM©rix8x8Fœg
[6];

110 
Boﬁón
 
	mbŸtom_fõld_pic_‹dî_ö_‰ame_¥e£¡_Êag
;

111 
	mnum_¶i˚_groups_möus1
;

112 
	m¶i˚_group_m≠_ty≥
;

114 
	mrun_Àngth_möus1
[
MAXnum_¶i˚_groups_möus1
];

116 
	mt›_À·
[
MAXnum_¶i˚_groups_möus1
];

117 
	mbŸtom_right
[
MAXnum_¶i˚_groups_möus1
];

119 
Boﬁón
 
	m¶i˚_group_ch™ge_dúe˘i⁄_Êag
;

120 
	m¶i˚_group_ch™ge_øã_möus1
;

122 
	mpic_size_ö_m≠_unôs_möus1
;

123 
byã
 *
	m¶i˚_group_id
;

125 
	mnum_ªf_idx_l0_deÁu…_a˘ive_möus1
;

126 
	mnum_ªf_idx_l1_deÁu…_a˘ive_möus1
;

127 
Boﬁón
 
	mweighãd_¥ed_Êag
;

128 
	mweighãd_bùªd_idc
;

129 
	mpic_öô_qp_möus26
;

130 
	mpic_öô_qs_möus26
;

131 
	mchroma_qp_ödex_off£t
;

133 
	mcb_qp_ödex_off£t
;

134 
	m¸_qp_ödex_off£t
;

135 
	m£c⁄d_chroma_qp_ödex_off£t
;

137 
Boﬁón
 
	mdeblockög_fûãr_c⁄åﬁ_¥e£¡_Êag
;

138 
Boﬁón
 
	mc⁄°øöed_öåa_¥ed_Êag
;

139 
Boﬁón
 
	mªdund™t_pic_˙t_¥e£¡_Êag
;

140 
Boﬁón
 
	mvui_pic_∑ømëîs_Êag
;

141 } 
	tpic_∑ømëî_£t_rb•_t
;

144 
	#MAXnum_ªf_‰ames_ö_pic_‹dî_˙t_cy˛e
 256

	)

147 
Boﬁón
 
	mVÆid
;

149 
	m¥ofûe_idc
;

150 
Boﬁón
 
	mc⁄°øöed_£t0_Êag
;

151 
Boﬁón
 
	mc⁄°øöed_£t1_Êag
;

152 
Boﬁón
 
	mc⁄°øöed_£t2_Êag
;

153 
Boﬁón
 
	mc⁄°øöed_£t3_Êag
;

154 #i‡(
MVC_EXTENSION_ENABLE
)

155 
Boﬁón
 
	mc⁄°øöed_£t4_Êag
;

156 
Boﬁón
 
	mc⁄°øöed_£t5_Êag
;

158 
	mÀvñ_idc
;

159 
	m£q_∑ømëî_£t_id
;

160 
	mchroma_f‹m©_idc
;

162 
Boﬁón
 
	m£q_sˇlög_m©rix_¥e£¡_Êag
;

163 
	m£q_sˇlög_li°_¥e£¡_Êag
[12];

164 
	mSˇlögLi°4x4
[6][16];

165 
	mSˇlögLi°8x8
[6][64];

166 
Boﬁón
 
	mU£DeÁu…SˇlögM©rix4x4Fœg
[6];

167 
Boﬁón
 
	mU£DeÁu…SˇlögM©rix8x8Fœg
[6];

169 
	mbô_dïth_luma_möus8
;

170 
	mbô_dïth_chroma_möus8
;

171 
	mlog2_max_‰ame_num_möus4
;

172 
	mpic_‹dî_˙t_ty≥
;

174 
	mlog2_max_pic_‹dî_˙t_lsb_möus4
;

176 
Boﬁón
 
	mdñè_pic_‹dî_Æways_zîo_Êag
;

177 
	moff£t_f‹_n⁄_ªf_pic
;

178 
	moff£t_f‹_t›_to_bŸtom_fõld
;

179 
	mnum_ªf_‰ames_ö_pic_‹dî_˙t_cy˛e
;

181 
	moff£t_f‹_ªf_‰ame
[
MAXnum_ªf_‰ames_ö_pic_‹dî_˙t_cy˛e
];

182 
	mnum_ªf_‰ames
;

183 
Boﬁón
 
	mg≠s_ö_‰ame_num_vÆue_Ælowed_Êag
;

184 
	mpic_width_ö_mbs_möus1
;

185 
	mpic_height_ö_m≠_unôs_möus1
;

186 
Boﬁón
 
	m‰ame_mbs_⁄ly_Êag
;

188 
Boﬁón
 
	mmb_ad≠tive_‰ame_fõld_Êag
;

189 
Boﬁón
 
	mdúe˘_8x8_ö„ªn˚_Êag
;

190 
Boﬁón
 
	m‰ame_¸›pög_Êag
;

191 
	m‰ame_¸›_À·_off£t
;

192 
	m‰ame_¸›_right_off£t
;

193 
	m‰ame_¸›_t›_off£t
;

194 
	m‰ame_¸›_bŸtom_off£t
;

195 
Boﬁón
 
	mvui_∑ømëîs_¥e£¡_Êag
;

196 
vui_£q_∑ømëîs_t
 
	mvui_£q_∑ømëîs
;

197 
	m£∑øã_cﬁour_∂™e_Êag
;

198 #i‡(
MVC_EXTENSION_ENABLE
)

199 
	mmax_dec_‰ame_buf„rög
;

201 
	mlos¶ess_qµrime_Êag
;

202 } 
	t£q_∑ømëî_£t_rb•_t
;

204 #i‡(
MVC_EXTENSION_ENABLE
)

205 
	smvcvui_èg


207 
	mnum_›s_möus1
;

208 *
	mãmp‹Æ_id
;

209 *
	mnum_èrgë_ouçut_võws_möus1
;

210 **
	mvõw_id
;

211 *
	mtimög_öfo_¥e£¡_Êag
;

212 *
	mnum_unôs_ö_tick
;

213 *
	mtime_sˇÀ
;

214 *
	mfixed_‰ame_øã_Êag
;

215 *
	m«l_hrd_∑ømëîs_¥e£¡_Êag
;

216 *
	mv˛_hrd_∑ømëîs_¥e£¡_Êag
;

217 *
	mlow_dñay_hrd_Êag
;

218 *
	mpic_°ru˘_¥e£¡_Êag
;

221 
	m˝b_˙t_möus1
;

222 
	mbô_øã_sˇÀ
;

223 
	m˝b_size_sˇÀ
;

224 
	mbô_øã_vÆue_möus1
[32];

225 
	m˝b_size_vÆue_möus1
[32];

226 
	mcbr_Êag
[32];

227 
	möôül_˝b_ªmovÆ_dñay_Àngth_möus1
;

228 
	m˝b_ªmovÆ_dñay_Àngth_möus1
;

229 
	mdpb_ouçut_dñay_Àngth_möus1
;

230 
	mtime_off£t_Àngth
;

231 }
	tMVCVUI_t
;

235 
£q_∑ømëî_£t_rb•_t
 
	m•s
;

237 
	mbô_equÆ_to_⁄e
;

238 
	mnum_võws_möus1
;

239 *
	mvõw_id
;

240 *
	mnum_™ch‹_ªfs_l0
;

241 **
	m™ch‹_ªf_l0
;

242 *
	mnum_™ch‹_ªfs_l1
;

243 **
	m™ch‹_ªf_l1
;

245 *
	mnum_n⁄_™ch‹_ªfs_l0
;

246 **
	mn⁄_™ch‹_ªf_l0
;

247 *
	mnum_n⁄_™ch‹_ªfs_l1
;

248 **
	mn⁄_™ch‹_ªf_l1
;

250 
	mnum_Àvñ_vÆues_sig«Œed_möus1
;

251 *
	mÀvñ_idc
;

252 *
	mnum_≠∂iˇbÀ_›s_möus1
;

253 **
	m≠∂iˇbÀ_›_ãmp‹Æ_id
;

254 **
	m≠∂iˇbÀ_›_num_èrgë_võws_möus1
;

255 ***
	m≠∂iˇbÀ_›_èrgë_võw_id
;

256 **
	m≠∂iˇbÀ_›_num_võws_möus1
;

258 
	mmvc_vui_∑ømëîs_¥e£¡_Êag
;

259 
Boﬁón
 
	mVÆid
;

260 
MVCVUI_t
 
	mMVCVUIP¨ams
;

261 } 
	tsub£t_£q_∑ømëî_£t_rb•_t
;

265 
pic_∑ømëî_£t_rb•_t
 *
AŒocPPS
 ();

266 
£q_∑ømëî_£t_rb•_t
 *
AŒocSPS
 ();

268 
FªePPS
 (
pic_∑ømëî_£t_rb•_t
 *
µs
);

269 
FªeSPS
 (
£q_∑ømëî_£t_rb•_t
 *
•s
);

271 
•s_is_equÆ
(
£q_∑ømëî_£t_rb•_t
 *
•s1
, seq_∑ømëî_£t_rb•_à*
•s2
);

272 
µs_is_equÆ
(
pic_∑ømëî_£t_rb•_t
 *
µs1
,Öic_∑ømëî_£t_rb•_à*
µs2
);

	@lcommon/inc/quant_params.h

14 #i‚de‡
_QUANT_PARAMS_H_


15 
	#_QUANT_PARAMS_H_


	)

17 
	sÀvñ_qu™t_∑øms
 {

18 
	mOff£tComp
;

19 
	mSˇÀComp
;

20 
	mInvSˇÀComp
;

21 } 
	tLevñQu™tP¨ams
;

23 
	squ™t_∑øms
 {

24 
	mAd≠tRndWeight
;

25 
	mAd≠tRndCrWeight
;

27 
LevñQu™tP¨ams
 *****
	mq_∑øms_4x4
;

28 
LevñQu™tP¨ams
 *****
	mq_∑øms_8x8
;

30 *
	mqp_≥r_m©rix
;

31 *
	mqp_ªm_m©rix
;

33 **
	mOff£tLi°4x4öput
;

34 **
	mOff£tLi°8x8öput
;

35 ***
	mOff£tLi°4x4
;

36 ***
	mOff£tLi°8x8
;

37 } 
	tQu™tP¨amëîs
;

39 
	squ™t_mëhods
 {

40 
	mblock_y
;

41 
	mblock_x
;

42 
	mqp
;

43 * 
	mACLevñ
;

44 * 
	mACRun
;

45 **
	mÁdju°
;

46 
LevñQu™tP¨ams
 **
	mq_∑øms
;

47 *
	mc€ff_co°
;

48 c⁄° 
byã
 (*
pos_sˇn
)[2];

49 c⁄° 
byã
 *
	mc_co°
;

50 
	mty≥
;

51 } 
	tQu™tMëhods
;

	@lcommon/inc/report.h

13 #i‚de‡
_REPORT_H_


14 
	#_REPORT_H_


	)

15 
	~"c⁄åibut‹s.h
"

16 
	~"globÆ.h
"

17 
	~"íc_°©i°ics.h
"

19 
ªp‹t
 ( 
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
SètP¨amëîs
 *
p_Sèts
 );

20 
öf‹m©i⁄_öô
 ( 
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
SètP¨amëîs
 *
p_Sèts
 );

21 
ªp‹t_‰ame_°©i°ic
–
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
 );

22 
ªp‹t_°©s_⁄_îr‹
 ();

	@lcommon/inc/transform.h

18 #i‚de‡
_TRANSFORM_H_


19 
	#_TRANSFORM_H_


	)

21 
f‹w¨d4x4
 (**
block
 , **
tblock
, 
pos_y
, 
pos_x
);

22 
övî£4x4
 (**
tblock
, **
block
 , 
pos_y
, 
pos_x
);

23 
f‹w¨d8x8
 (**
block
 , **
tblock
, 
pos_y
, 
pos_x
);

24 
övî£8x8
 (**
tblock
, **
block
 , 
pos_x
);

25 
hadam¨d4x4
 (**
block
 , **
tblock
);

26 
ihadam¨d4x4
 (**
tblock
, **
block
);

27 
hadam¨d4x2
 (**
block
 , **
tblock
);

28 
ihadam¨d4x2
 (**
tblock
, **
block
);

29 
hadam¨d2x2
 (**
block
 , 
tblock
[4]);

30 
ihadam¨d2x2
 (
block
[4], 
tblock
[4]);

	@lcommon/inc/typedefs.h

16 #i‚de‡
_TYPEDEFS_H_


17 
	#_TYPEDEFS_H_


	)

19 
	~"wö32.h
"

21 
	tbyã
;

22 
	tuöt8
;

23 
	tuöt16
;

24 
	tuöt32
;

26 
	töt8
;

27 
	töt16
;

28 
	töt32
;

30 #i‡
IMGTYPE
 == 0

31 
byã
 
	timg≥l
;

32 
uöt16
 
	tdi°≥l
;

33 
öt32
 
	tdi°blk
;

34 
öt32
 
	tå™•ñ
;

36 
uöt16
 
	timg≥l
;

37 
uöt32
 
	tdi°≥l
;

38 
öt64
 
	tdi°blk
;

39 
öt32
 
	tå™•ñ
;

43 #ifde‡
FALSE


44 
	#Boﬁón
 

	)

47 
	mFALSE
,

48 
	mTRUE


49 } 
	tBoﬁón
;

52 #i‚de‡
MAXINT64


53 
	#MAXINT64
 0x7fffffffffffffff

	)

	@lcommon/inc/types.h

14 #i‚de‡
_TYPES_H_


15 
	#_TYPES_H_


	)

25 
	mPLANE_Y
 = 0,

26 
	mPLANE_U
 = 1,

27 
	mPLANE_V
 = 2,

29 
	mPLANE_G
 = 0,

30 
	mPLANE_B
 = 1,

31 
	mPLANE_R
 = 2

32 } 
	tCﬁ‹Pœ√
;

35 
	mLIST_0
 = 0,

36 
	mLIST_1
 = 1,

37 
	mBI_PRED
 = 2,

38 
	mBI_PRED_L0
 = 3,

39 
	mBI_PRED_L1
 = 4

43 
	mERROR_SAD
 = 0,

44 
	mERROR_SSE
 = 1,

45 
	mERROR_SATD
 = 2,

46 
	mERROR_PSATD
 = 3

50 
	mME_Y_ONLY
 = 0,

51 
	mME_YUV_FP
 = 1,

52 
	mME_YUV_FP_SP
 = 2

57 
	mDISTORTION_MSE
 = 0

64 
	mPAR_DP_1
,

65 
	mPAR_DP_3


66 } 
	tPAR_DP_TYPE
;

72 
	mPAR_OF_ANNEXB
,

73 
	mPAR_OF_RTP


74 } 
	tPAR_OF_TYPE
;

79 
	mFRAME_CODING
 = 0,

80 
	mFIELD_CODING
 = 1,

81 
	mADAPTIVE_CODING
 = 2,

82 
	mFRAME_MB_PAIR_CODING
 = 3

83 } 
	tCodögTy≥
;

89 
	mSE_HEADER
,

90 
	mSE_PTYPE
,

91 
	mSE_MBTYPE
,

92 
	mSE_REFFRAME
,

93 
	mSE_INTRAPREDMODE
,

94 
	mSE_MVD
,

95 
	mSE_CBP
,

96 
	mSE_LUM_DC_INTRA
,

97 
	mSE_CHR_DC_INTRA
,

98 
	mSE_LUM_AC_INTRA
,

99 
	mSE_CHR_AC_INTRA
,

100 
	mSE_LUM_DC_INTER
,

101 
	mSE_CHR_DC_INTER
,

102 
	mSE_LUM_AC_INTER
,

103 
	mSE_CHR_AC_INTER
,

104 
	mSE_DELTA_QUANT
,

105 
	mSE_BFRAME
,

106 
	mSE_EOS
,

107 
	mSE_MAX_ELEMENTS
 = 20

108 } 
	tSE_ty≥
;

113 
	mNO_SLICES
,

114 
	mFIXED_MB
,

115 
	mFIXED_RATE
,

116 
	mCALL_BACK


117 } 
	tSli˚Mode
;

122 
	mCAVLC
,

123 
	mCABAC


124 } 
	tSymbﬁMode
;

128 
	mFULL_SEARCH
 = -1,

129 
	mFAST_FULL_SEARCH
 = 0,

130 
	mUM_HEX
 = 1,

131 
	mUM_HEX_SIMPLE
 = 2,

132 
	mEPZS
 = 3

133 } 
	tSórchTy≥
;

138 
	mFRAME
,

139 
	mTOP_FIELD
,

140 
	mBOTTOM_FIELD


141 } 
	tPi˘uªSåu˘uª
;

145 
	mP_SLICE
 = 0,

146 
	mB_SLICE
 = 1,

147 
	mI_SLICE
 = 2,

148 
	mSP_SLICE
 = 3,

149 
	mSI_SLICE
 = 4,

150 
	mNUM_SLICE_TYPES
 = 5

151 } 
	tSli˚Ty≥
;

156 
	mF_PEL
,

157 
	mH_PEL
,

158 
	mQ_PEL


159 } 
	tMELevñ
;

163 
	mFAST_ACCESS
 = 0,

164 
	mUMV_ACCESS
 = 1

165 } 
	tREF_ACCESS_TYPE
;

169 
	mIS_LUMA
 = 0,

170 
	mIS_CHROMA
 = 1

171 } 
	tComp⁄ít_Ty≥
;

175 
	mRC_MODE_0
 = 0,

176 
	mRC_MODE_1
 = 1,

177 
	mRC_MODE_2
 = 2,

178 
	mRC_MODE_3
 = 3

179 } 
	tRCModeTy≥
;

183 
	mSSE
 = 0,

184 
	mSSE_RGB
 = 1,

185 
	mPSNR
 = 2,

186 
	mPSNR_RGB
 = 3,

187 
	mSSIM
 = 4,

188 
	mSSIM_RGB
 = 5,

189 
	mMS_SSIM
 = 6,

190 
	mMS_SSIM_RGB
 = 7,

191 
	mTOTAL_DIST_TYPES
 = 8

192 } 
	tdi°‹ti⁄_ty≥s
;

195 
	mWP_MCPREC_PLUS0
 = 4,

196 
	mWP_MCPREC_PLUS1
 = 5,

197 
	mWP_MCPREC_MINUS0
 = 6,

198 
	mWP_MCPREC_MINUS1
 = 7,

199 
	mWP_MCPREC_MINUS_PLUS0
 = 8,

200 
	mWP_REGULAR
 = 9

201 } 
	tweighãd_¥edi˘i⁄_ty≥s
;

	@lcommon/inc/vui_params.h

13 #i‚de‡
_VUI_PARAMS_H_


14 
	#_VUI_PARAMS_H_


	)

17 
	svui_∑ømëîs


19 
	ma•e˘_øtio_öfo_¥e£¡_Êag
;

20 
	ma•e˘_øtio_idc
;

21 
	mßr_width
;

22 
	mßr_height
;

23 
	movîsˇn_öfo_¥e£¡_Êag
;

24 
	movîsˇn_≠¥›rüã_Êag
;

25 
	mvideo_sig«l_ty≥_¥e£¡_Êag
;

26 
	mvideo_f‹m©
;

27 
	mvideo_fuŒ_ønge_Êag
;

28 
	mcﬁour_des¸ùti⁄_¥e£¡_Êag
;

29 
	mcﬁour_¥im¨õs
;

30 
	må™s„r_ch¨a˘îi°ics
;

31 
	mm©rix_c€fficõ¡s
;

32 
	mchroma_loˇti⁄_öfo_¥e£¡_Êag
;

33 
	mchroma_ßm∂e_loc_ty≥_t›_fõld
;

34 
	mchroma_ßm∂e_loc_ty≥_bŸtom_fõld
;

35 
	mtimög_öfo_¥e£¡_Êag
;

36 
	mnum_unôs_ö_tick
;

37 
	mtime_sˇÀ
;

38 
	mfixed_‰ame_øã_Êag
;

39 
	m«l_hrd_∑ømëîs_¥e£¡_Êag
;

40 
	m«l_˝b_˙t_möus1
;

41 
	m«l_bô_øã_sˇÀ
;

42 
	m«l_˝b_size_sˇÀ
;

43 
	m«l_bô_øã_vÆue_möus1
;

44 
	m«l_˝b_size_vÆue_möus1
;

45 
	m«l_vbr_cbr_Êag
;

46 
	m«l_öôül_˝b_ªmovÆ_dñay_Àngth_möus1
;

47 
	m«l_˝b_ªmovÆ_dñay_Àngth_möus1
;

48 
	m«l_dpb_ouçut_dñay_Àngth_möus1
;

49 
	m«l_time_off£t_Àngth
;

50 
	mv˛_hrd_∑ømëîs_¥e£¡_Êag
;

51 
	mv˛_˝b_˙t_möus1
;

52 
	mv˛_bô_øã_sˇÀ
;

53 
	mv˛_˝b_size_sˇÀ
;

54 
	mv˛_bô_øã_vÆue_möus1
;

55 
	mv˛_˝b_size_vÆue_möus1
;

56 
	mv˛_vbr_cbr_Êag
;

57 
	mv˛_öôül_˝b_ªmovÆ_dñay_Àngth_möus1
;

58 
	mv˛_˝b_ªmovÆ_dñay_Àngth_möus1
;

59 
	mv˛_dpb_ouçut_dñay_Àngth_möus1
;

60 
	mv˛_time_off£t_Àngth
;

61 
	mlow_dñay_hrd_Êag
;

62 
	mpic_°ru˘_¥e£¡_Êag
;

63 
	mbô°ªam_ª°ri˘i⁄_Êag
;

64 
	mmŸi⁄_ve˘‹s_ovî_pic_bound¨õs_Êag
;

65 
	mmax_byãs_≥r_pic_díom
;

66 
	mmax_bôs_≥r_mb_díom
;

67 
	mlog2_max_mv_Àngth_vîtiˇl
;

68 
	mlog2_max_mv_Àngth_h‹iz⁄èl
;

69 
	mnum_ª‹dî_‰ames
;

70 
	mmax_dec_‰ame_buf„rög
;

71 } 
	tVUIP¨amëîs
;

	@lcommon/inc/win32.h

14 #i‚de‡
_WIN32_H_


15 
	#_WIN32_H_


	)

17 
	~<f˙é.h
>

18 
	~<°dlib.h
>

19 
	~<°dio.h
>

20 
	~<°rög.h
>

21 
	~<as£π.h
>

23 #i‡(
_MSC_VER
 >1400Ë|| 
deföed
(
__INTEL_COMPILER
Ë|| (
__GNUC__
 >= 5)

25 
	#NUM_THREADS
 8

	)

28 #i‡
deföed
(
WIN32
Ë|| deföed (
WIN64
)

29 
	~<io.h
>

30 
	~<sys/ty≥s.h
>

31 
	~<sys/°©.h
>

32 
	~<wödows.h
>

33 #i‡(
_MSC_VER
 < 1400)

34 
	töçå_t
;

36 
	~<¸tdefs.h
>

38 #i‡
deföed
(
OPENMP
)

39 
	~<omp.h
>

42 
	#°rˇ£cmp
 
_°rcmpi


	)

43 
	#°∫ˇ£cmp
 
_°∫icmp


	)

45 
	#¢¥ötf
 
_¢¥ötf


	)

46 
	#›í
 
_›í


	)

47 
	#˛o£
 
_˛o£


	)

48 
	#ªad
 
_ªad


	)

49 
	#wrôe
 
_wrôe


	)

50 
	#l£ek
 
_l£eki64


	)

51 
	#fsync
 
_commô


	)

52 
	#ãŒ
 
_ãŒi64


	)

53 
	#TIMEB
 
_timeb


	)

54 
	#TIME_T
 
LARGE_INTEGER


	)

55 
	#OPENFLAGS_WRITE
 
_O_WRONLY
|
_O_CREAT
|
_O_BINARY
|
_O_TRUNC


	)

56 
	#OPEN_PERMISSIONS
 
_S_IREAD
 | 
_S_IWRITE


	)

57 
	#OPENFLAGS_READ
 
_O_RDONLY
|
_O_BINARY


	)

58 
	#ölöe
 
_ölöe


	)

59 
	#f‹˚ölöe
 
__f‹˚ölöe


	)

61 
	~<uni°d.h
>

62 
	~<sys/time.h
>

63 
	~<sys/°©.h
>

64 
	~<time.h
>

65 
	~<°döt.h
>

66 #i‡
deföed
(
OPENMP
)

67 
	~<omp.h
>

70 
	#TIMEB
 
timeb


	)

71 
	#TIME_T
 
timevÆ


	)

72 
	#ãŒ
(
fd
Ë
	`l£ek
(fd, 0, 
SEEK_CUR
)

	)

73 
	#OPENFLAGS_WRITE
 
O_WRONLY
|
O_CREAT
|
O_TRUNC


	)

74 
	#OPENFLAGS_READ
 
O_RDONLY


	)

75 
	#OPEN_PERMISSIONS
 
S_IRUSR
 | 
S_IWUSR


	)

77 #i‡
__STDC_VERSION__
 >= 199901L

80 
	#ölöe


	)

82 
	#f‹˚ölöe
 
ölöe


	)

85 #i‡(
deföed
(
WIN32
Ë|| deföed(
WIN64
)Ë&& !deföed(
__GNUC__
)

86 
__öt64
 
	töt64
;

87 
	t__öt64
 
	tuöt64
;

88 
	#FORMAT_OFF_T
 "I64d"

	)

89 #i‚de‡
INT64_MIN


90 
	#INT64_MIN
 (-9223372036854775807
i64
 - 1i64)

	)

93 
	töt64
;

94 
	tuöt64
;

95 
	#FORMAT_OFF_T
 "Œd"

	)

96 #i‚de‡
INT64_MIN


97 
	#INT64_MIN
 (-9223372036854775807LL - 1LL)

	)

101 
gëtime
(
TIME_T
* 
time
);

102 
öô_time
();

103 
öt64
 
timediff
(
TIME_T
* 
°¨t
, TIME_T* 
íd
);

104 
öt64
 
timí‹m
(öt64 
cur_time
);

	@lcommon/src/blk_prediction.c

15 
	~"c⁄åibut‹s.h
"

17 
	~<°dlib.h
>

18 
	~<as£π.h
>

19 
	~<limôs.h
>

20 
	~<m©h.h
>

22 
	~"block.h
"

23 
	~"globÆ.h
"

25 
	~"ma¸oblock.h
"

26 
	~"mc_¥edi˘i⁄.h
"

27 
	~"image.h
"

28 
	~"mb_ac˚ss.h
"

30 
	$compuã_ªsidue
 (
img≥l
 **
curImg
, img≥»**
m¥
, **
mb_ºes
, 
mb_x
, 
›ix_x
, 
width
, 
height
)

32 
img≥l
 *
imgOrg
, *
imgPªd
;

33 *
m7
;

34 
i
, 
j
;

36 
j
 = 0; j < 
height
; j++)

38 
imgOrg
 = &
curImg
[
j
][
›ix_x
];

39 
imgPªd
 = &
m¥
[
j
][
mb_x
];

40 
m7
 = &
mb_ºes
[
j
][
mb_x
];

41 
i
 = 0; i < 
width
; i++)

43 *
m7
++ = *
imgOrg
++ - *
imgPªd
++;

46 
	}
}

48 
	$ßm∂e_ªc⁄°ru˘
 (
img≥l
 **
curImg
, img≥»**
m¥
, **
mb_ºes
, 
mb_x
, 
›ix_x
, 
width
, 
height
, 
max_img≥l_vÆue
, 
dq_bôs
)

50 
img≥l
 *
imgOrg
, *
imgPªd
;

51 *
m7
;

52 
i
, 
j
;

54 
j
 = 0; j < 
height
; j++)

56 
imgOrg
 = &
curImg
[
j
][
›ix_x
];

57 
imgPªd
 = &
m¥
[
j
][
mb_x
];

58 
m7
 = &
mb_ºes
[
j
][
mb_x
];

59 
i
=0;i<
width
;i++)

60 *
imgOrg
++ = (
img≥l
Ë
	`iClù1
–
max_img≥l_vÆue
, 
	`rshi·_∫d_sf
(*
m7
++, 
dq_bôs
Ë+ *
imgPªd
++);

62 
	}
}

	@lcommon/src/config_common.c

58 
	~<sys/°©.h
>

60 
	~"globÆ.h
"

61 
	~"c⁄figfûe.h
"

62 
	~"memÆloc.h
"

64 
P¨amëîNameToM≠Index
 (
M≠pög
 *
M≠
, *
s
);

67 
	#MAX_ITEMS_TO_PARSE
 10000

	)

81 *
	$GëC⁄figFûeC⁄ã¡
 (*
Fûíame
)

83 
FûeSize
;

84 
FILE
 *
f
;

85 *
buf
;

87 i‡(
NULL
 =(
f
 = 
	`f›í
 (
Fûíame
, "r")))

89 
	`¢¥ötf
 (
îr‹ãxt
, 
ET_SIZE
, "C™nŸ o≥¿c⁄figuøti⁄ fûê%s.", 
Fûíame
);

90  
NULL
;

93 i‡(0 !
	`f£ek
 (
f
, 0, 
SEEK_END
))

95 
	`¢¥ötf
 (
îr‹ãxt
, 
ET_SIZE
, "C™nŸ f£ek i¿c⁄figuøti⁄ fûê%s.", 
Fûíame
);

96  
NULL
;

99 
FûeSize
 = 
	`·ñl
 (
f
);

101 i‡(
FûeSize
 < 0 || FileSize > 150000)

103 
	`¢¥ötf
 (
îr‹ãxt
, 
ET_SIZE
, "\nUƒós⁄abÀ Fûesizê%ldÑï‹ãd by fãŒ f‹ c⁄figuøti⁄ fûê%s.", 
FûeSize
, 
Fûíame
);

104  
NULL
;

106 i‡(0 !
	`f£ek
 (
f
, 0, 
SEEK_SET
))

108 
	`¢¥ötf
 (
îr‹ãxt
, 
ET_SIZE
, "C™nŸ f£ek i¿c⁄figuøti⁄ fûê%s.", 
Fûíame
);

109  
NULL
;

112 i‡((
buf
 = 
	`mÆloc
 (
FûeSize
 + 1))==
NULL
Ë
	`no_mem_exô
("GetConfigFileContent: buf");

118 
FûeSize
 = (Ë
	`‰ód
 (
buf
, 1, FûeSize, 
f
);

119 
buf
[
FûeSize
] = '\0';

122 
	`f˛o£
 (
f
);

123  
buf
;

124 
	}
}

143 
	$P¨£C⁄ã¡
 (
I≈utP¨amëîs
 *
p_I≈
, 
M≠pög
 *
M≠
, *
buf
, 
bufsize
)

145 *
ôems
[
MAX_ITEMS_TO_PARSE
] = {
NULL
};

146 
M≠Idx
;

147 
ôem
 = 0;

148 
InSåög
 = 0, 
InIãm
 = 0;

149 *
p
 = 
buf
;

150 *
bu„nd
 = &
buf
[
bufsize
];

151 
I¡C⁄ã¡
;

152 
DoubÀC⁄ã¡
;

153 
i
;

158 
p
 < 
bu„nd
)

160 *
p
)

163 ++
p
;

166 *
p
 = '\0';

167 *
p
 !'\n' &&Ö < 
bu„nd
)

168 ++
p
;

169 
InSåög
 = 0;

170 
InIãm
 = 0;

173 
InIãm
 = 0;

174 
InSåög
 = 0;

175 *
p
++='\0';

179 i‡(
InSåög
)

180 
p
++;

183 *
p
++ = '\0';

184 
InIãm
 = 0;

189 *
p
++ = '\0';

190 i‡(!
InSåög
)

192 
ôems
[
ôem
++] = 
p
;

193 
InIãm
 = ~InItem;

196 
InIãm
 = 0;

197 
InSåög
 = ~InString;

201 i‡(!
InIãm
)

203 
ôems
[
ôem
++] = 
p
;

204 
InIãm
 = ~InItem;

206 
p
++;

210 
ôem
--;

212 
i
=0; i<
ôem
; i+= 3)

214 i‡(0 > (
M≠Idx
 = 
	`P¨amëîNameToM≠Index
 (
M≠
, 
ôems
[
i
])))

218 
	`¥ötf
 ("\n\tP¨sögÉº‹ i¿c⁄fig fûe: P¨amëî Namê'%s'ÇŸÑecognized.", 
ôems
[
i
]);

219 
i
 -= 2 ;

222 i‡(
	`°rˇ£cmp
 ("=", 
ôems
[
i
+1]))

224 
	`¢¥ötf
 (
îr‹ãxt
, 
ET_SIZE
, " ParsingÉrror in config file: '='ÉxpectedásÅhe secondÅoken inÉachÜine.");

225 
	`îr‹
 (
îr‹ãxt
, 300);

230 
M≠
[
M≠Idx
].
Ty≥
)

233 i‡(1 !
	`ssˇnf
 (
ôems
[
i
+2], "%d", &
I¡C⁄ã¡
))

235 
	`¢¥ötf
 (
îr‹ãxt
, 
ET_SIZE
, " P¨sögÉº‹: Ex≥˘edÇumîiˇ»vÆuêf‹ P¨amëî o‡%s, found '%s'.", 
ôems
[
i
], items[i+2]);

236 
	`îr‹
 (
îr‹ãxt
, 300);

238 * (*Ë(
M≠
[
M≠Idx
].
Pœ˚
Ë
I¡C⁄ã¡
;

239 
	`¥ötf
 (".");

242 i‡(
ôems
[
i
 + 2] =
NULL
)

243 
	`mem£t
((*Ë
M≠
[
M≠Idx
].
Pœ˚
, 0, M≠[M≠Idx].
ch¨_size
);

245 
	`°∫˝y
 ((*Ë
M≠
[
M≠Idx
].
Pœ˚
, 
ôems
 [
i
+2], M≠[M≠Idx].
ch¨_size
);

246 
	`¥ötf
 (".");

249 i‡(1 !
	`ssˇnf
 (
ôems
[
i
+2], "%lf", &
DoubÀC⁄ã¡
))

251 
	`¢¥ötf
 (
îr‹ãxt
, 
ET_SIZE
, " P¨sögÉº‹: Ex≥˘edÇumîiˇ»vÆuêf‹ P¨amëî o‡%s, found '%s'.", 
ôems
[
i
], items[i+2]);

252 
	`îr‹
 (
îr‹ãxt
, 300);

254 * (*Ë(
M≠
[
M≠Idx
].
Pœ˚
Ë
DoubÀC⁄ã¡
;

255 
	`¥ötf
 (".");

258 
	`îr‹
 ("Unknown valueÅype inÅhe map definition of configfile.h",-1);

261 *
p_I≈
 = 
cfg∑øms
;

262 
	}
}

277 
	$P¨amëîNameToM≠Index
 (
M≠pög
 *
M≠
, *
s
)

279 
i
 = 0;

281 
M≠
[
i
].
TokíName
 !
NULL
)

282 i‡(0==
	`°rˇ£cmp
 (
M≠
[
i
].
TokíName
, 
s
))

283  
i
;

285 
i
++;

287 
	}
}

297 
	$InôP¨ams
(
M≠pög
 *
M≠
)

299 
i
 = 0;

301 
M≠
[
i
].
TokíName
 !
NULL
)

303 i‡(
M≠
[
i
].
Ty≥
 == 0)

304 * (*Ë(
M≠
[
i
].
Pœ˚
Ë(ËM≠[i].
DeÁu…
;

305 i‡(
M≠
[
i
].
Ty≥
 == 2)

306 * (*Ë(
M≠
[
i
].
Pœ˚
ËM≠[i].
DeÁu…
;

307 
i
++;

310 
	}
}

320 
	$Te°P¨ams
(
M≠pög
 *
M≠
, 
bôdïth_qp_sˇÀ
[3])

322 
i
 = 0;

324 
M≠
[
i
].
TokíName
 !
NULL
)

326 i‡(
M≠
[
i
].
∑øm_limôs
 == 1)

328 i‡(
M≠
[
i
].
Ty≥
 == 0)

330 i‡–* (*Ë(
M≠
[
i
].
Pœ˚
Ë< (ËM≠[i].
mö_limô
 || * (*Ë(M≠[i].Pœ˚Ë> (ËM≠[i].
max_limô
 )

332 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Eº‹ i¿öpuà∑ømëî %s. Check c⁄figuøti⁄ fûe. VÆuêshould bêö [%d, %d]Ñ™ge.", 
M≠
[
i
].
TokíName
, (ËM≠[i].
mö_limô
,()M≠[i].
max_limô
 );

333 
	`îr‹
 (
îr‹ãxt
, 400);

337 i‡(
M≠
[
i
].
Ty≥
 == 2)

339 i‡–* (*Ë(
M≠
[
i
].
Pœ˚
Ë< M≠[i].
mö_limô
 || * (*Ë(M≠[i].Pœ˚Ë> M≠[i].
max_limô
 )

341 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Eº‹ i¿öpuà∑ømëî %s. Check c⁄figuøti⁄ fûe. VÆuêshould bêö [%.2f, %.2f]Ñ™ge.", 
M≠
[
i
].
TokíName
,M≠[i].
mö_limô
 ,M≠[i].
max_limô
 );

342 
	`îr‹
 (
îr‹ãxt
, 400);

346 i‡(
M≠
[
i
].
∑øm_limôs
 == 2)

348 i‡(
M≠
[
i
].
Ty≥
 == 0)

350 i‡–* (*Ë(
M≠
[
i
].
Pœ˚
Ë< (ËM≠[i].
mö_limô
 )

352 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Eº‹ i¿öpuà∑ømëî %s. Check c⁄figuøti⁄ fûe. VÆuêshouldÇŸ bêsmÆÀ∏th™ %d.", 
M≠
[
i
].
TokíName
, (ËM≠[i].
mö_limô
);

353 
	`îr‹
 (
îr‹ãxt
, 400);

356 i‡(
M≠
[
i
].
Ty≥
 == 2)

358 i‡–* (*Ë(
M≠
[
i
].
Pœ˚
Ë< M≠[i].
mö_limô
 )

360 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Eº‹ i¿öpuà∑ømëî %s. Check c⁄figuøti⁄ fûe. VÆuêshouldÇŸ bêsmÆÀ∏th™ %2.f.", 
M≠
[
i
].
TokíName
,M≠[i].
mö_limô
);

361 
	`îr‹
 (
îr‹ãxt
, 400);

365 i‡(
M≠
[
i
].
∑øm_limôs
 == 3)

368 i‡(
M≠
[
i
].
Ty≥
 == 0)

370 
cur_qp
 = * (*Ë(
M≠
[
i
].
Pœ˚
);

371 
mö_qp
 = (Ë(
M≠
[
i
].
mö_limô
 - (
bôdïth_qp_sˇÀ
? bitdepth_qp_scale[0]: 0));

372 
max_qp
 = (Ë
M≠
[
i
].
max_limô
;

374 i‡(–
cur_qp
 < 
mö_qp
 ) || ( cur_q∞> 
max_qp
 ))

376 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Eº‹ i¿öpuà∑ømëî %s. Check c⁄figuøti⁄ fûe. VÆuêshould bêö [%d, %d]Ñ™ge.", 
M≠
[
i
].
TokíName
, 
mö_qp
, 
max_qp
 );

377 
	`îr‹
 (
îr‹ãxt
, 400);

382 
i
++;

385 
	}
}

397 
	$Di•œyP¨ams
(
M≠pög
 *
M≠
, *
mesßge
)

399 
i
 = 0;

401 
	`¥ötf
("******************************************************\n");

402 
	`¥ötf
("* %† *\n", 
mesßge
);

403 
	`¥ötf
("******************************************************\n");

404 
M≠
[
i
].
TokíName
 !
NULL
)

406 i‡(
M≠
[
i
].
Ty≥
 == 0)

407 
	`¥ötf
("P¨amëî %†%d\n",
M≠
[
i
].
TokíName
,* (*Ë(M≠[i].
Pœ˚
));

408 i‡(
M≠
[
i
].
Ty≥
 == 1)

409 
	`¥ötf
("P¨amëî %†""%s""\n",
M≠
[
i
].
TokíName
,(*Ë(M≠[i].
Pœ˚
));

410 i‡(
M≠
[
i
].
Ty≥
 == 2)

411 
	`¥ötf
("P¨amëî %†%.2f\n",
M≠
[
i
].
TokíName
,* (*Ë(M≠[i].
Pœ˚
));

412 
i
++;

414 
	`¥ötf
("******************************************************\n");

415  
i
;

416 
	}
}

	@lcommon/src/img_io.c

14 
	~"c⁄åibut‹s.h
"

15 
	~"globÆ.h
"

16 
	~"img_io.h
"

17 
	~"ªp‹t.h
"

19 c⁄° 
VIDEO_SIZE
 
	gVideoRes
[] = {

31 { 
NULL
, 0, 0}

41 
	$P¨£SizeFromSåög
 (
VideoD©aFûe
 *
öput_fûe
, *
x_size
, *
y_size
, *
Âs
)

43 *
p1
, *
p2
, *
èû
;

44 *
‚
 = 
öput_fûe
->
‚ame
;

45 
c
;

46 
i
 = 0;

48 *
x_size
 = *
y_size
 = -1;

49 
p1
 = 
p2
 = 
‚
;

50 
p1
 !
NULL
 && 
p2
 != NULL)

53 
p1
 = 
	`°r°r
(Ö1, "_");

54 i‡(
p1
 =
NULL
)

58 
p2
 = 
	`°r°r
–
p1
, "x");

61 i‡(
p2
 =
NULL
)

65 *
p2
 = 0;

66 *
x_size
 = 
	`°πﬁ
–
p1
 + 1, &
èû
, 10);

69 i‡(*
èû
 !'\0' || *(
p1
 + 1) == '\0')

71 *
p2
 = 'x';

72 
p1
 = 
èû
;

77 *
p2
 = 'x';

80 
p1
 = 
	`°Ωbrk
–
p2
 + 1, "_.");

82 i‡(
p1
 =
NULL
)

84 
p1
 = 
p2
 + 1;

89 
c
 = *
p1
;

90 *
p1
 = 0;

91 *
y_size
 = 
	`°πﬁ
–
p2
 + 1, &
èû
, 10);

94 i‡(*
èû
 !'\0' || *(
p2
 + 1) == '\0')

96 *
p1
 = 
c
;

97 
p1
 = 
èû
;

102 *
p1
 = 
c
;

105 
p2
 = 
	`°r°r
–
p1
 + 1, "ip");

108 i‡(
p2
 =
NULL
)

112 
c
 = *
p2
;

113 *
p2
 = 0;

114 *
Âs
 = 
	`°πod
–
p1
 + 1, &
èû
);

117 i‡(*
èû
 !'\0' || *(
p1
 + 1) == '\0')

119 *
p2
 = 
c
;

120 
p1
 = 
èû
;

125 *
p2
 = 
c
;

130 i‡(
p1
 =
NULL
 || 
p2
 == NULL)

132 
i
 = 0; 
VideoRes
[i].
«me
 !
NULL
; i++)

134 i‡(
	`°rˇ£cmp
 (
‚
, 
VideoRes
[
i
].
«me
))

136 *
x_size
 = 
VideoRes
[
i
].x_size;

137 *
y_size
 = 
VideoRes
[
i
].y_size;

144  (*
x_size
 =-1 || *
y_size
 == -1) ? 0 : 1;

145 
	}
}

154 
	$P¨£FømeNoF‹m©FromSåög
 (
VideoD©aFûe
 *
öput_fûe
)

156 *
p1
, *
p2
, *
èû
;

157 *
‚
 = 
öput_fûe
->
‚ame
;

158 *
fhód
 = 
öput_fûe
->fhead;

159 *
·aû
 = 
öput_fûe
->ftail;

160 *
zîo_∑d
 = &
öput_fûe
->zero_pad;

161 *
num_digôs
 = &
öput_fûe
->num_digits;

163 *
zîo_∑d
 = 0;

164 *
num_digôs
 = -1;

165 
p1
 = 
p2
 = 
‚
;

166 
p1
 !
NULL
 && 
p2
 != NULL)

169 
p1
 = 
	`°r°r
(Ö1, "%");

170 i‡(
p1
 =
NULL
)

173 
	`°∫˝y
(
fhód
, 
‚
, 
p1
 - fn);

176 
p2
 = 
	`°r°r
–
p1
, "d");

179 i‡(
p2
 =
NULL
)

183 *
p2
 = 0;

185 i‡(*(
p1
 + 1) == '0')

186 *
zîo_∑d
 = 1;

188 *
num_digôs
 = 
	`°πﬁ
–
p1
 + 1, &
èû
, 10);

191 i‡(*
èû
 !'\0' || *(
p1
 + 1) == '\0')

193 *
p2
 = 'd';

194 
p1
 = 
èû
;

199 *
p2
 = 'd';

201 
èû
++;

202 
	`°∫˝y
(
·aû
, 
èû
, (Ë
	`°æí
(tail));

206 i‡(
öput_fûe
->
vdty≥
 =
VIDEO_TIFF
)

208 
öput_fûe
->
is_c⁄ˇã«ãd
 = 0;

211 
öput_fûe
->
is_c⁄ˇã«ãd
 = (*
num_digôs
 == -1) ? 1 : 0;

212 
	}
}

220 
	$O≥nFømeFûe
–
VideoD©aFûe
 *
öput_fûe
, 
FømeNumbîInFûe
)

222 
öfûe
 [
FILE_NAME_SIZE
], 
ö_numbî
[16];

223 
Àngth
 = 0;

224 
ö_numbî
[
Àngth
]='\0';

225 
Àngth
 = (Ë
	`°æí
(
öput_fûe
->
fhód
);

226 
	`°∫˝y
(
öfûe
, 
öput_fûe
->
fhód
, 
Àngth
);

227 
öfûe
[
Àngth
]='\0';

228 i‡(
öput_fûe
->
zîo_∑d
)

229 
	`¢¥ötf
(
ö_numbî
, 16, "%0*d", 
öput_fûe
->
num_digôs
, 
FømeNumbîInFûe
);

231 
	`¢¥ötf
(
ö_numbî
, 16, "%*d", 
öput_fûe
->
num_digôs
, 
FømeNumbîInFûe
);

233 
	`°∫ˇt
(
öfûe
, 
ö_numbî
, (in_number));

234 
Àngth
 +(
ö_numbî
);

235 
öfûe
[
Àngth
]='\0';

236 
	`°∫ˇt
(
öfûe
, 
öput_fûe
->
·aû
, 
	`°æí
(input_file->ftail));

237 
Àngth
 +(Ë
	`°æí
(
öput_fûe
->
·aû
);

238 
öfûe
[
Àngth
]='\0';

240 i‡((
öput_fûe
->
f_num
 = 
	`›í
(
öfûe
, 
OPENFLAGS_READ
)) == -1)

242 
	`¥ötf
 ("O≥nFømeFûe: c™nŸ o≥¿fûê%s\n", 
öfûe
);

243 
	`ªp‹t_°©s_⁄_îr‹
();

245 
	}
}

253 
	$O≥nFûes
–
VideoD©aFûe
 *
öput_fûe
)

255 i‡(
öput_fûe
->
is_c⁄ˇã«ãd
 == 1)

257 i‡((Ë
	`°æí
(
öput_fûe
->
‚ame
) == 0)

259 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "No input sequenceÇame wasÖrovided. Please check settings.");

260 
	`îr‹
 (
îr‹ãxt
, 500);

263 i‡((
öput_fûe
->
f_num
 = 
	`›í
(öput_fûe->
‚ame
, 
OPENFLAGS_READ
)) == -1)

265 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "I≈uàfûê%†d€†nŸÉxi°",
öput_fûe
->
‚ame
);

266 
	`îr‹
 (
îr‹ãxt
, 500);

269 
	}
}

277 
	$Clo£Fûes
(
VideoD©aFûe
 *
öput_fûe
)

279 i‡(
öput_fûe
->
f_num
 != -1)

280 
	`˛o£
(
öput_fûe
->
f_num
);

281 
öput_fûe
->
f_num
 = -1;

282 
	}
}

290 
VideoFûeTy≥
 
	$P¨£VideoTy≥
 (
VideoD©aFûe
 *
öput_fûe
)

292 *
f‹m©
;

294 
f‹m©
 = 
öput_fûe
->
‚ame
 + (Ë
	`°æí
(input_file->fname) - 3;

296 i‡(
	`°rˇ£cmp
 (
f‹m©
, "yuv") == 0)

298 
öput_fûe
->
vdty≥
 = 
VIDEO_YUV
;

299 
öput_fûe
->
f‹m©
.
yuv_f‹m©
 = 
YUV420
;

300 
öput_fûe
->
avi
 = 
NULL
;

302 i‡(
	`°rˇ£cmp
 (
f‹m©
, "rgb") == 0)

304 
öput_fûe
->
vdty≥
 = 
VIDEO_RGB
;

305 
öput_fûe
->
f‹m©
.
yuv_f‹m©
 = 
YUV444
;

306 
öput_fûe
->
avi
 = 
NULL
;

308 i‡(
	`°rˇ£cmp
 (
f‹m©
, "tif") == 0)

310 
öput_fûe
->
vdty≥
 = 
VIDEO_TIFF
;

311 
öput_fûe
->
avi
 = 
NULL
;

313 i‡(
	`°rˇ£cmp
 (
f‹m©
, "avi") == 0)

315 
öput_fûe
->
vdty≥
 = 
VIDEO_AVI
;

321 
öput_fûe
->
vdty≥
 = 
VIDEO_YUV
;

322 
öput_fûe
->
f‹m©
.
yuv_f‹m©
 = 
YUV420
;

323 
öput_fûe
->
avi
 = 
NULL
;

326  
öput_fûe
->
vdty≥
;

327 
	}
}

	@lcommon/src/img_process.c

15 
	~"c⁄åibut‹s.h
"

16 
	~"globÆ.h
"

17 
	~"img_¥o˚ss.h
"

18 
	~"io_image.h
"

19 
	~"memÆloc.h
"

20 
	~"Á°_mem‹y.h
"

22 
ölöe
 
	$Re£tImage
(
ImageD©a
 *
imgOut
)

24 
	`Á°_mem£t
(
imgOut
->
‰m_d©a
[0][0], 0, imgOut->
f‹m©
.
height
[0] * imgOut->f‹m©.
width
[0] *  (
img≥l
));

26 i‡(
imgOut
->
f‹m©
.
yuv_f‹m©
 !
YUV400
)

28 i‡((
img≥l
) == ())

30 
	`Á°_mem£t
(
imgOut
->
‰m_d©a
[1][0], 128, imgOut->
f‹m©
.
height
[1] * imgOut->f‹m©.
width
[1] *  (
img≥l
));

31 
	`Á°_mem£t
(
imgOut
->
‰m_d©a
[2][0], 128, imgOut->
f‹m©
.
height
[2] * imgOut->f‹m©.
width
[2] *  (
img≥l
));

35 
i
, 
j
, 
k
;

36 
img≥l
 
med_vÆue
;

37 
k
 = 1; k <=2; k++)

39 
med_vÆue
 = (
img≥l
Ë(
imgOut
->
f‹m©
.
max_vÆue
[
k
] + 1) >> 1;

40 
j
 = 0; j < 
imgOut
->
f‹m©
.
height
[
k
]; j++)

42 
i
 = 0; i < 
imgOut
->
f‹m©
.
width
[
k
]; i++)

44 
imgOut
->
‰m_d©a
[
k
][
j
][
i
] = 
med_vÆue
;

50 
	}
}

53 
ölöe
 
	$CPImage
(
ImageD©a
 *
imgOut
, ImageD©®*
imgIn
)

55 
	`mem˝y
(
imgOut
->
‰m_d©a
[0][0], 
imgIn
->‰m_d©a[0][0], imgIn->
f‹m©
.
height
[0] * imgIn->f‹m©.
width
[0] *  (
img≥l
));

57 i‡(
imgIn
->
f‹m©
.
yuv_f‹m©
 !
YUV400
)

59 
	`mem˝y
(
imgOut
->
‰m_d©a
[1][0], 
imgIn
->‰m_d©a[1][0], imgIn->
f‹m©
.
height
[1] * imgIn->f‹m©.
width
[1] *  (
img≥l
));

60 
	`mem˝y
(
imgOut
->
‰m_d©a
[2][0], 
imgIn
->‰m_d©a[2][0], imgIn->
f‹m©
.
height
[2] * imgIn->f‹m©.
width
[2] *  (
img≥l
));

62 
	}
}

65 
ölöe
 
	$FûãrImage
(
ImageD©a
 *
imgOut
, ImageD©®*
imgIn
)

67 
	`mem˝y
(
imgOut
->
‰m_d©a
[0][0], 
imgIn
->‰m_d©a[0][0], imgIn->
f‹m©
.
height
[0] * imgIn->f‹m©.
width
[0] *  (
img≥l
));

69 i‡(
imgIn
->
f‹m©
.
yuv_f‹m©
 !
YUV400
)

71 
	`mem˝y
(
imgOut
->
‰m_d©a
[1][0], 
imgIn
->‰m_d©a[1][0], imgIn->
f‹m©
.
height
[1] * imgIn->f‹m©.
width
[1] *  (
img≥l
));

72 
	`mem˝y
(
imgOut
->
‰m_d©a
[2][0], 
imgIn
->‰m_d©a[2][0], imgIn->
f‹m©
.
height
[2] * imgIn->f‹m©.
width
[2] *  (
img≥l
));

74 
	}
}

77 
ölöe
 
	$BÀndImageLöes
(
ImageD©a
 *
imgIn0
, ImageD©®*
imgIn1
)

79 
j
;

80 
j
 = 1; j < 
imgIn1
->
f‹m©
.
height
[0]; j += 2)

81 
	`mem˝y
(
imgIn0
->
‰m_d©a
[0][
j
], 
imgIn1
->‰m_d©a[0][j], imgIn1->
f‹m©
.
width
[0] *  (
img≥l
));

83 i‡(
imgIn1
->
f‹m©
.
yuv_f‹m©
 !
YUV400
)

85 
j
 = 1; j < 
imgIn1
->
f‹m©
.
height
[1]; j += 2)

87 
	`mem˝y
(
imgIn0
->
‰m_d©a
[1][
j
], 
imgIn1
->‰m_d©a[1][j], imgIn1->
f‹m©
.
width
[1] *  (
img≥l
));

89 
j
 = 1; j < 
imgIn1
->
f‹m©
.
height
[2]; j += 2)

91 
	`mem˝y
(
imgIn0
->
‰m_d©a
[2][
j
], 
imgIn1
->‰m_d©a[2][j], imgIn1->
f‹m©
.
width
[2] *  (
img≥l
));

94 
	}
}

97 
ölöe
 
	$FûãrImageSï
(
ImageD©a
 *
imgOut
, ImageD©®*
imgIn
)

99 
i
, 
j
;

100 c⁄° 
SïFûãr
[6] = {1, -5, 20, 20, -5, 1};

101 
max_width
 = 
imgOut
->
f‹m©
.
width
[0] - 1;

102 
max_height
 = 
imgOut
->
f‹m©
.
height
[0] - 1;

104 **
ãmp_d©a
 = 
	`√w_mem2Döt
(
imgIn
->
f‹m©
.
height
[0], imgIn->f‹m©.
width
[0]);

105 
img≥l
 *
‰m_d©a
 = 
NULL
;

109 
j
 = 0; j < 
imgOut
->
f‹m©
.
height
[0]; j++)

111 
‰m_d©a
 = 
imgIn
->‰m_d©a[0][
j
];

112 
i
 = 0; i < 
imgOut
->
f‹m©
.
width
[0]; i++)

114 
ãmp_d©a
[
j
][
i
] =

115 
SïFûãr
[0] * 
‰m_d©a
[
	`iClù3
(0, 
max_width
, 
i
 - 2)] +

116 
SïFûãr
[1] * 
‰m_d©a
[
	`iClù3
(0, 
max_width
, 
i
 - 1)] +

117 
SïFûãr
[2] * 
‰m_d©a
[
	`iClù3
(0, 
max_width
, 
i
 )] +

118 
SïFûãr
[3] * 
‰m_d©a
[
	`iClù3
(0, 
max_width
, 
i
 + 1)] +

119 
SïFûãr
[4] * 
‰m_d©a
[
	`iClù3
(0, 
max_width
, 
i
 + 2)] +

120 
SïFûãr
[5] * 
‰m_d©a
[
	`iClù3
(0, 
max_width
, 
i
 + 3)];

124 
j
 = 0; j < 
imgOut
->
f‹m©
.
height
[0]; j++)

126 
‰m_d©a
 = 
imgOut
->‰m_d©a[0][
j
];

127 
i
 = 0; i < 
imgOut
->
f‹m©
.
width
[0]; i++)

129 
‰m_d©a
[
i
] = (
img≥l
Ë
	`iClù3
(0, 
imgOut
->
f‹m©
.
max_vÆue
[0], 
	`rshi·_∫d_sign
(

130 
SïFûãr
[0] * 
ãmp_d©a
[
	`iClù3
(0, 
max_height
, 
j
 - 2)][
i
] +

131 
SïFûãr
[1] * 
ãmp_d©a
[
	`iClù3
(0, 
max_height
, 
j
 - 1)][
i
] +

132 
SïFûãr
[2] * 
ãmp_d©a
[
	`iClù3
(0, 
max_height
, 
j
 )][
i
] +

133 
SïFûãr
[3] * 
ãmp_d©a
[
	`iClù3
(0, 
max_height
, 
j
 + 1)][
i
] +

134 
SïFûãr
[4] * 
ãmp_d©a
[
	`iClù3
(0, 
max_height
, 
j
 + 2)][
i
] +

135 
SïFûãr
[5] * 
ãmp_d©a
[
	`iClù3
(0, 
max_height
, 
j
 + 3)][
i
], 10));

139 i‡(
imgOut
->
f‹m©
.
yuv_f‹m©
 !
YUV400
)

141 
k
;

143 
k
 = 1; k <=2; k++)

145 
max_width
 = 
imgOut
->
f‹m©
.
width
[
k
] - 1;

146 
max_height
 = 
imgOut
->
f‹m©
.
height
[
k
] - 1;

149 
j
 = 0; j < 
imgOut
->
f‹m©
.
height
[
k
]; j++)

151 
‰m_d©a
 = 
imgIn
->‰m_d©a[
k
][
j
];

152 
i
 = 0; i < 
imgOut
->
f‹m©
.
width
[
k
]; i++)

154 
ãmp_d©a
[
j
][
i
] =

155 
SïFûãr
[0] * 
‰m_d©a
[
	`iClù3
(0, 
max_width
, 
i
 - 2)] +

156 
SïFûãr
[1] * 
‰m_d©a
[
	`iClù3
(0, 
max_width
, 
i
 - 1)] +

157 
SïFûãr
[2] * 
‰m_d©a
[
	`iClù3
(0, 
max_width
, 
i
 )] +

158 
SïFûãr
[3] * 
‰m_d©a
[
	`iClù3
(0, 
max_width
, 
i
 + 1)] +

159 
SïFûãr
[4] * 
‰m_d©a
[
	`iClù3
(0, 
max_width
, 
i
 + 2)] +

160 
SïFûãr
[5] * 
‰m_d©a
[
	`iClù3
(0, 
max_width
, 
i
 + 3)];

164 
j
 = 0; j < 
imgOut
->
f‹m©
.
height
[
k
]; j++)

166 
‰m_d©a
 = 
imgOut
->‰m_d©a[
k
][
j
];

167 
i
 = 0; i < 
imgOut
->
f‹m©
.
width
[
k
]; i++)

169 
‰m_d©a
[
i
] = (
img≥l
Ë
	`iClù3
(0, 
imgOut
->
f‹m©
.
max_vÆue
[
k
], 
	`rshi·_∫d_sign
(

170 
SïFûãr
[0] * 
ãmp_d©a
[
	`iClù3
(0, 
max_height
, 
j
 - 2)][
i
] +

171 
SïFûãr
[1] * 
ãmp_d©a
[
	`iClù3
(0, 
max_height
, 
j
 - 1)][
i
] +

172 
SïFûãr
[2] * 
ãmp_d©a
[
	`iClù3
(0, 
max_height
, 
j
 )][
i
] +

173 
SïFûãr
[3] * 
ãmp_d©a
[
	`iClù3
(0, 
max_height
, 
j
 + 1)][
i
] +

174 
SïFûãr
[4] * 
ãmp_d©a
[
	`iClù3
(0, 
max_height
, 
j
 + 2)][
i
] +

175 
SïFûãr
[5] * 
ãmp_d©a
[
	`iClù3
(0, 
max_height
, 
j
 + 3)][
i
], 10));

181 
	`‰ì_mem2Döt
(
ãmp_d©a
);

182 
	}
}

186 
ölöe
 
	$MuxImages
(
ImageD©a
 *
imgOut
, ImageD©®*
imgIn0
, ImageD©®*
imgIn1
, ImageD©®*
M≠
)

188 
i
, 
j
;

189 
j
 = 0; j < 
imgOut
->
f‹m©
.
height
[0]; j++)

191 
i
 = 0; i < 
imgOut
->
f‹m©
.
width
[0]; i++)

193 
imgOut
->
‰m_d©a
[0][
j
][
i
] = (
img≥l
Ë
	`rshi·_∫d_sf
(
imgIn0
->‰m_d©a[0][j][i] * (
M≠
->
f‹m©
.
max_vÆue
[0] - M≠->‰m_d©a[0][j][i]Ë+ 
imgIn1
->‰m_d©a[0][j][i] * M≠->‰m_d©a[0][j][i], M≠->f‹m©.
bô_dïth
[0]);

197 i‡(
imgOut
->
f‹m©
.
yuv_f‹m©
 !
YUV400
)

199 
k
;

200 
k
 = 1; k <=2; k++)

202 
j
 = 0; j < 
imgOut
->
f‹m©
.
height
[
k
]; j++)

204 
i
 = 0; i < 
imgOut
->
f‹m©
.
width
[
k
]; i++)

206 
imgOut
->
‰m_d©a
[
k
][
j
][
i
] = (
img≥l
Ë
	`rshi·_∫d_sf
(
imgIn0
->‰m_d©a[k][j][i] * (
M≠
->
f‹m©
.
max_vÆue
[k] - M≠->‰m_d©a[k][j][i]Ë+ 
imgIn1
->‰m_d©a[k][j][i] * M≠->‰m_d©a[k][j][i], M≠->f‹m©.
bô_dïth
[k]);

211 
	}
}

213 
ölöe
 
	$YV12toYUV
(
ImageD©a
 *
imgOut
, ImageD©®*
imgIn
)

215 
	`mem˝y
(
imgOut
->
‰m_d©a
[0][0], 
imgIn
->‰m_d©a[0][0], imgIn->
f‹m©
.
height
[0] * imgIn->f‹m©.
width
[0] *  (
img≥l
));

217 i‡(
imgIn
->
f‹m©
.
yuv_f‹m©
 !
YUV400
)

219 
	`mem˝y
(
imgOut
->
‰m_d©a
[1][0], 
imgIn
->‰m_d©a[2][0], imgIn->
f‹m©
.
height
[1] * imgIn->f‹m©.
width
[1] *  (
img≥l
));

220 
	`mem˝y
(
imgOut
->
‰m_d©a
[2][0], 
imgIn
->‰m_d©a[1][0], imgIn->
f‹m©
.
height
[2] * imgIn->f‹m©.
width
[2] *  (
img≥l
));

222 
	}
}

224 
	$¥o˚ss_image
–
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
 )

226  
p_I≈
->
Pro˚ssI≈ut
 )

230 
	`CPImage
(&
p_Vid
->
imgD©a
, &p_Vid->
imgD©a0
);

231 i‡(
p_I≈
->
íabÀ_32_puŒdown
)

232 
	`BÀndImageLöes
(&
p_Vid
->
imgD©a
, &p_Vid->
imgD©a4
);

235 
	`FûãrImage
(&
p_Vid
->
imgD©a
, &p_Vid->
imgD©a0
);

236 i‡(
p_I≈
->
íabÀ_32_puŒdown
)

238 
	`FûãrImage
(&
p_Vid
->
imgD©a32
, &p_Vid->
imgD©a4
);

239 
	`BÀndImageLöes
(&
p_Vid
->
imgD©a
, &p_Vid->
imgD©a32
);

243 
	`YV12toYUV
(&
p_Vid
->
imgD©a
, &p_Vid->
imgD©a0
);

244 i‡(
p_I≈
->
íabÀ_32_puŒdown
)

246 
	`YV12toYUV
(&
p_Vid
->
imgD©a32
, &p_Vid->
imgD©a4
);

247 
	`BÀndImageLöes
(&
p_Vid
->
imgD©a
, &p_Vid->
imgD©a32
);

251 
	`MuxImages
(&
p_Vid
->
imgD©a
, &p_Vid->
imgD©a0
, &p_Vid->
imgD©a1
, &p_Vid->
imgD©a2
);

252 i‡(
p_I≈
->
íabÀ_32_puŒdown
)

254 
	`MuxImages
(&
p_Vid
->
imgD©a32
, &p_Vid->
imgD©a4
, &p_Vid->
imgD©a5
, &p_Vid->
imgD©a6
);

255 
	`BÀndImageLöes
(&
p_Vid
->
imgD©a
, &p_Vid->
imgD©a32
);

260 
	`FûãrImageSï
(&
p_Vid
->
imgD©a
, &p_Vid->
imgD©a0
);

261 i‡(
p_I≈
->
íabÀ_32_puŒdown
)

263 
	`FûãrImageSï
(&
p_Vid
->
imgD©a
, &p_Vid->
imgD©a4
);

264 
	`BÀndImageLöes
(&
p_Vid
->
imgD©a
, &p_Vid->
imgD©a32
);

269 
	}
}

	@lcommon/src/input.c

16 
	~"c⁄åibut‹s.h
"

18 
	~<m©h.h
>

19 
	~<time.h
>

21 
	~"globÆ.h
"

22 
	~"deföes.h
"

23 
	~"öput.h
"

24 
	~"img_io.h
"

25 
	~"memÆloc.h
"

26 
	~"Á°_mem‹y.h
"

28 
buf2img_basic
 ( 
img≥l
** 
imgX
, * 
buf
, 
size_x
, 
size_y
, 
o_size_x
, 
o_size_y
, 
symbﬁ_size_ö_byãs
, 
bôshi·
);

29 
buf2img_ídün
 ( 
img≥l
** 
imgX
, * 
buf
, 
size_x
, 
size_y
, 
o_size_x
, 
o_size_y
, 
symbﬁ_size_ö_byãs
, 
bôshi·
);

30 
buf2img_bôshi·
 ( 
img≥l
** 
imgX
, * 
buf
, 
size_x
, 
size_y
, 
o_size_x
, 
o_size_y
, 
symbﬁ_size_ö_byãs
, 
bôshi·
);

31 
fûlPœ√
 ( 
img≥l
** 
imgX
, 
nVÆ
, 
size_x
, 
size_y
);

42 
	$öôI≈ut
(
VideoP¨amëîs
 *
p_Vid
, 
FømeF‹m©
 *
sour˚
, FømeF‹m© *
ouçut
)

44 i‡(
sour˚
->
bô_dïth
[0] =
ouçut
->bit_depth[0] && source->bit_depth[1] == output->bit_depth[1])

46 i‡(–(Ë! (
img≥l
)Ë&& 
	`ã°Endün
())

47 
p_Vid
->
buf2img
 = 
buf2img_ídün
;

49 
p_Vid
->
buf2img
 = 
buf2img_basic
;

52 
p_Vid
->
buf2img
 = 
buf2img_bôshi·
;

53 
	}
}

65 
	$ã°Endün
()

67 
s
;

68 
byã
 *
p
;

70 
p
=(
byã
*)&
s
;

72 
s
=1;

74  (*
p
==0);

75 
	}
}

77 #i‡(
DEBUG_BITDEPTH
)

84 
	$MaskMSBs
 (
img≥l
** 
imgX
, 
mask
, 
width
, 
height
)

86 
i
,
j
;

88 
j
=0; j < 
height
; j++)

90 
i
=0; i < 
width
; i++)

92 
imgX
[
j
][
i
]=(
img≥l
Ë(imgX[j][i] & 
mask
);

95 
	}
}

104 
	$fûlPœ√
 ( 
img≥l
** 
imgX
,

105 
nVÆ
,

106 
size_x
,

107 
size_y


110 
j
, 
i
;

112 i‡((
img≥l
) == ())

114 
	`Á°_mem£t
(
imgX
[0], 
nVÆ
, 
size_y
 * 
size_x
);

118 
j
 = 0; j < 
size_y
; j++)

120 
i
 = 0; i < 
size_x
; i++)

122 
imgX
[
j
][
i
] = (
img≥l
Ë
nVÆ
;

126 
	}
}

128 
	$deöãæóve_yuv420
–** 
öput
,

129 ** 
ouçut
,

130 
FømeF‹m©
 *
sour˚
,

131 
symbﬁ_size_ö_byãs


134 
i
;

136 *
icmp
 = *
öput
;

138 *
ocmp0
 = *
ouçut
;

140 *
ocmp1
 = 
ocmp0
 + 
symbﬁ_size_ö_byãs
 * 
sour˚
->
size_cmp
[
Y_COMP
];

141 *
ocmp2
 = 
ocmp1
 + 
symbﬁ_size_ö_byãs
 * 
sour˚
->
size_cmp
[
U_COMP
];

143 
i
 = 0; i < 
sour˚
->
size_cmp
[
U_COMP
]; i++)

145 
	`mem˝y
(
ocmp1
, 
icmp
, 
symbﬁ_size_ö_byãs
);

146 
ocmp1
 +
symbﬁ_size_ö_byãs
;

147 
icmp
 +
symbﬁ_size_ö_byãs
;

148 
	`mem˝y
(
ocmp0
, 
icmp
, 2 * 
symbﬁ_size_ö_byãs
);

149 
ocmp0
 +2 * 
symbﬁ_size_ö_byãs
;

150 
icmp
 +2 * 
symbﬁ_size_ö_byãs
;

151 
	`mem˝y
(
ocmp2
, 
icmp
, 
symbﬁ_size_ö_byãs
);

152 
ocmp2
 +
symbﬁ_size_ö_byãs
;

153 
icmp
 +
symbﬁ_size_ö_byãs
;

154 
	`mem˝y
(
ocmp0
, 
icmp
, 2 * 
symbﬁ_size_ö_byãs
);

155 
ocmp0
 +2 * 
symbﬁ_size_ö_byãs
;

156 
icmp
 +2 * 
symbﬁ_size_ö_byãs
;

160 
icmp
 = *
öput
;

161 *
öput
 = *
ouçut
;

162 *
ouçut
 = 
icmp
;

163 
	}
}

165 
	$deöãæóve_yuv444
–** 
öput
,

166 ** 
ouçut
,

167 
FømeF‹m©
 *
sour˚
,

168 
symbﬁ_size_ö_byãs


171 
i
;

173 *
icmp
 = *
öput
;

175 *
ocmp0
 = *
ouçut
;

177 *
ocmp1
 = 
ocmp0
 + 
symbﬁ_size_ö_byãs
 * 
sour˚
->
size_cmp
[
Y_COMP
];

178 *
ocmp2
 = 
ocmp1
 + 
symbﬁ_size_ö_byãs
 * 
sour˚
->
size_cmp
[
U_COMP
];

180 
i
 = 0; i < 
sour˚
->
size_cmp
[
Y_COMP
]; i++)

182 
	`mem˝y
(
ocmp0
, 
icmp
, 
symbﬁ_size_ö_byãs
);

183 
ocmp0
 +
symbﬁ_size_ö_byãs
;

184 
icmp
 +
symbﬁ_size_ö_byãs
;

185 
	`mem˝y
(
ocmp1
, 
icmp
, 
symbﬁ_size_ö_byãs
);

186 
ocmp1
 +
symbﬁ_size_ö_byãs
;

187 
icmp
 +
symbﬁ_size_ö_byãs
;

188 
	`mem˝y
(
ocmp2
, 
icmp
, 
symbﬁ_size_ö_byãs
);

189 
ocmp2
 +
symbﬁ_size_ö_byãs
;

190 
icmp
 +
symbﬁ_size_ö_byãs
;

193 
icmp
 = *
öput
;

194 *
öput
 = *
ouçut
;

195 *
ouçut
 = 
icmp
;

196 
	}
}

198 
	$deöãæóve_yuyv
 ( ** 
öput
,

199 ** 
ouçut
,

200 
FømeF‹m©
 *
sour˚
,

201 
symbﬁ_size_ö_byãs


204 
i
;

206 *
icmp
 = *
öput
;

208 *
ocmp0
 = *
ouçut
;

210 *
ocmp1
 = 
ocmp0
 + 
symbﬁ_size_ö_byãs
 * 
sour˚
->
size_cmp
[
Y_COMP
];

211 *
ocmp2
 = 
ocmp1
 + 
symbﬁ_size_ö_byãs
 * 
sour˚
->
size_cmp
[
U_COMP
];

213 
i
 = 0; i < 
sour˚
->
size_cmp
[
U_COMP
]; i++)

216 
	`mem˝y
(
ocmp0
, 
icmp
, 
symbﬁ_size_ö_byãs
);

217 
ocmp0
 +
symbﬁ_size_ö_byãs
;

218 
icmp
 +
symbﬁ_size_ö_byãs
;

220 
	`mem˝y
(
ocmp1
, 
icmp
, 
symbﬁ_size_ö_byãs
);

221 
ocmp1
 +
symbﬁ_size_ö_byãs
;

222 
icmp
 +
symbﬁ_size_ö_byãs
;

224 
	`mem˝y
(
ocmp0
, 
icmp
, 
symbﬁ_size_ö_byãs
);

225 
ocmp0
 +
symbﬁ_size_ö_byãs
;

226 
icmp
 +
symbﬁ_size_ö_byãs
;

228 
	`mem˝y
(
ocmp2
, 
icmp
, 
symbﬁ_size_ö_byãs
);

229 
ocmp2
 +
symbﬁ_size_ö_byãs
;

230 
icmp
 +
symbﬁ_size_ö_byãs
;

233 
icmp
 = *
öput
;

234 *
öput
 = *
ouçut
;

235 *
ouçut
 = 
icmp
;

236 
	}
}

238 
	$deöãæóve_yvyu
 ( ** 
öput
,

239 ** 
ouçut
,

240 
FømeF‹m©
 *
sour˚
,

241 
symbﬁ_size_ö_byãs


244 
i
;

246 *
icmp
 = *
öput
;

248 *
ocmp0
 = *
ouçut
;

250 *
ocmp1
 = 
ocmp0
 + 
symbﬁ_size_ö_byãs
 * 
sour˚
->
size_cmp
[
Y_COMP
];

251 *
ocmp2
 = 
ocmp1
 + 
symbﬁ_size_ö_byãs
 * 
sour˚
->
size_cmp
[
U_COMP
];

253 
i
 = 0; i < 
sour˚
->
size_cmp
[
U_COMP
]; i++)

256 
	`mem˝y
(
ocmp0
, 
icmp
, 
symbﬁ_size_ö_byãs
);

257 
ocmp0
 +
symbﬁ_size_ö_byãs
;

258 
icmp
 +
symbﬁ_size_ö_byãs
;

260 
	`mem˝y
(
ocmp2
, 
icmp
, 
symbﬁ_size_ö_byãs
);

261 
ocmp2
 +
symbﬁ_size_ö_byãs
;

262 
icmp
 +
symbﬁ_size_ö_byãs
;

264 
	`mem˝y
(
ocmp0
, 
icmp
, 
symbﬁ_size_ö_byãs
);

265 
ocmp0
 +
symbﬁ_size_ö_byãs
;

266 
icmp
 +
symbﬁ_size_ö_byãs
;

268 
	`mem˝y
(
ocmp1
, 
icmp
, 
symbﬁ_size_ö_byãs
);

269 
ocmp1
 +
symbﬁ_size_ö_byãs
;

270 
icmp
 +
symbﬁ_size_ö_byãs
;

273 
icmp
 = *
öput
;

274 *
öput
 = *
ouçut
;

275 *
ouçut
 = 
icmp
;

276 
	}
}

278 
	$deöãæóve_uyvy
 ( ** 
öput
,

279 ** 
ouçut
,

280 
FømeF‹m©
 *
sour˚
,

281 
symbﬁ_size_ö_byãs


284 
i
;

286 *
icmp
 = *
öput
;

288 *
ocmp0
 = *
ouçut
;

290 *
ocmp1
 = 
ocmp0
 + 
symbﬁ_size_ö_byãs
 * 
sour˚
->
size_cmp
[
Y_COMP
];

291 *
ocmp2
 = 
ocmp1
 + 
symbﬁ_size_ö_byãs
 * 
sour˚
->
size_cmp
[
U_COMP
];

293 
i
 = 0; i < 
sour˚
->
size_cmp
[
U_COMP
]; i++)

296 
	`mem˝y
(
ocmp1
, 
icmp
, 
symbﬁ_size_ö_byãs
);

297 
ocmp1
 +
symbﬁ_size_ö_byãs
;

298 
icmp
 +
symbﬁ_size_ö_byãs
;

300 
	`mem˝y
(
ocmp0
, 
icmp
, 
symbﬁ_size_ö_byãs
);

301 
ocmp0
 +
symbﬁ_size_ö_byãs
;

302 
icmp
 +
symbﬁ_size_ö_byãs
;

304 
	`mem˝y
(
ocmp2
, 
icmp
, 
symbﬁ_size_ö_byãs
);

305 
ocmp2
 +
symbﬁ_size_ö_byãs
;

306 
icmp
 +
symbﬁ_size_ö_byãs
;

308 
	`mem˝y
(
ocmp0
, 
icmp
, 
symbﬁ_size_ö_byãs
);

309 
ocmp0
 +
symbﬁ_size_ö_byãs
;

310 
icmp
 +
symbﬁ_size_ö_byãs
;

313 
icmp
 = *
öput
;

314 *
öput
 = *
ouçut
;

315 *
ouçut
 = 
icmp
;

316 
	}
}

318 
	$deöãæóve_v210
 ( ** 
öput
,

319 ** 
ouçut
,

320 
FømeF‹m©
 *
sour˚
,

321 
symbﬁ_size_ö_byãs


324 
i
;

326 *
icmp
 = *
öput
;

328 *
ui32cmp
 = (*Ë*
öput
;

329 *
ui16cmp0
 = (*Ë*
ouçut
;

330 *
ui16cmp1
 = 
ui16cmp0
 + 
sour˚
->
size_cmp
[0];

331 *
ui16cmp2
 = 
ui16cmp1
 + 
sour˚
->
size_cmp
[1];

333 
i
 = 0; i < 
sour˚
->
size_cmp
[
U_COMP
] / 3; i++)

338 *
ui16cmp2
 = (*
ui32cmp
 & 0x3FF00000)>>20;

339 *
ui16cmp0
 = (*
ui32cmp
 & 0xffc00)>>10;

340 *
ui16cmp1
 = (*(
ui32cmp
++) & 0x3FF);

345 *(
ui16cmp0
 + 2Ë(*
ui32cmp
 & 0x3FF00000)>>20;

346 *(
ui16cmp1
 + 1Ë(*
ui32cmp
 & 0xffc00)>>10;

347 *(
ui16cmp0
 + 1Ë(*(
ui32cmp
++) & 0x3FF);

352 *(
ui16cmp1
 + 2Ë(*
ui32cmp
 & 0x3FF00000)>>20;

353 *(
ui16cmp0
 + 3Ë(*
ui32cmp
 & 0xffc00)>>10;

354 *(
ui16cmp2
 + 1Ë(*(
ui32cmp
++) & 0x3FF);

359 *(
ui16cmp0
 + 5Ë(*
ui32cmp
 & 0x3FF00000)>>20;

360 *(
ui16cmp2
 + 2Ë(*
ui32cmp
 & 0xffc00)>>10;

361 *(
ui16cmp0
 + 4Ë(*(
ui32cmp
++) & 0x3FF);

365 
ui16cmp0
 += 6;

366 
ui16cmp1
 += 3;

367 
ui16cmp2
 += 3;

370 
icmp
 = *
öput
;

371 *
öput
 = *
ouçut
;

372 *
ouçut
 = 
icmp
;

373 
	}
}

381 
	$deöãæóve
 ( ** 
öput
,

382 ** 
ouçut
,

383 
FømeF‹m©
 *
sour˚
,

384 
symbﬁ_size_ö_byãs


387 i‡(
sour˚
->
yuv_f‹m©
 =
YUV420
)

389 
	`deöãæóve_yuv420
(
öput
, 
ouçut
, 
sour˚
, 
symbﬁ_size_ö_byãs
);

391 i‡(
sour˚
->
yuv_f‹m©
 =
YUV422
)

393 i‡(
sour˚
->
pixñ_f‹m©
 =
YUYV
 || sour˚->pixñ_f‹m© =
YUY2
)

395 
	`deöãæóve_yuyv
(
öput
, 
ouçut
, 
sour˚
, 
symbﬁ_size_ö_byãs
);

397 i‡(
sour˚
->
pixñ_f‹m©
 =
YVYU
)

399 
	`deöãæóve_yvyu
(
öput
, 
ouçut
, 
sour˚
, 
symbﬁ_size_ö_byãs
);

401 i‡(
sour˚
->
pixñ_f‹m©
 =
UYVY
)

403 
	`deöãæóve_uyvy
(
öput
, 
ouçut
, 
sour˚
, 
symbﬁ_size_ö_byãs
);

405 i‡(
sour˚
->
pixñ_f‹m©
 =
V210
)

407 
	`deöãæóve_v210
(
öput
, 
ouçut
, 
sour˚
, 
symbﬁ_size_ö_byãs
);

410 
	`Ârötf
(
°dîr
, "UnsupportedÖixel format.\n");

411 
	`exô
(
EXIT_FAILURE
);

414 i‡(
sour˚
->
yuv_f‹m©
 =
YUV444
)

415 
	`deöãæóve_yuv444
(
öput
, 
ouçut
, 
sour˚
, 
symbﬁ_size_ö_byãs
);

416 
	}
}

424 
	$buf2img_bôshi·
 ( 
img≥l
** 
imgX
,

425 * 
buf
,

426 
size_x
,

427 
size_y
,

428 
o_size_x
,

429 
o_size_y
,

430 
symbﬁ_size_ö_byãs
,

431 
bôshi·


434 
i
,
j
;

436 
uöt16
 
tmp16
, 
ui16
;

437 
tmp32
, 
ui32
;

440 i‡(((
symbﬁ_size_ö_byãs
 << 3Ë- 
bôshi·
Ë> ((
img≥l
)<< 3))

442 
	`îr‹
 ("SourceÖicture has higher bit depthÅhan imgpel dataÅype. \nPleaseÑecompile withÜarger dataÅype for imgpel.", 500);

445 i‡(
	`ã°Endün
())

447 i‡(
size_x
 !
o_size_x
 || 
size_y
 !
o_size_y
)

449 
	`îr‹
 ("RescalingÇot supported in bigÉndianárchitectures. ", 500);

453 
symbﬁ_size_ö_byãs
)

457 
j
 = 0; j < 
o_size_y
; j++)

458 
i
 = 0; i < 
o_size_x
; i++)

460 
imgX
[
j
][
i
](
img≥l
Ë
	`rshi·_∫d
(
buf
[ò+ j*
size_x
], 
bôshi·
);

466 
j
 = 0; j < 
o_size_y
; j++)

467 
i
 = 0; i < 
o_size_x
; i++)

469 
	`mem˝y
(&
tmp16
, 
buf
 + ((
i
 + 
j
 * 
size_x
) * 2), 2);

470 
ui16
 = (
tmp16
 >> 8) | ((tmp16 & 0xFF) << 8);

471 
imgX
[
j
][
i
] = (
img≥l
Ë
	`rshi·_∫d
(
ui16
, 
bôshi·
);

477 
j
 = 0; j < 
o_size_y
; j++)

478 
i
 = 0; i < 
o_size_x
; i++)

480 
	`mem˝y
(&
tmp32
, 
buf
 + ((
i
 + 
j
 * 
size_x
) * 4), 4);

481 
ui32
 = ((
tmp32
 & 0xFF00) << 8) | ((tmp32 & 0xFF)<<24) | ((tmp32 & 0xFF0000)>>8) | ((tmp32 & 0xFF000000)>>24);

482 
imgX
[
j
][
i
] = (
img≥l
Ë
	`rshi·_∫d
(
ui32
, 
bôshi·
);

487 
	`îr‹
 ("reading only from formats of 8, 16 or 32 bitállowed on bigÉndianárchitecture", 500);

495 
j_pos
;

496 i‡(
size_x
 =
o_size_x
 && 
size_y
 =
o_size_y
)

498 
j
 = 0; j < 
o_size_y
; j++)

500 
j_pos
 = 
j
*
size_x
;

501 
i
 = 0; i < 
o_size_x
; i++)

503 
ui16
=0;

504 
	`mem˝y
(&(
ui16
), 
buf
 + ((
i
 + 
j_pos
Ë* 
symbﬁ_size_ö_byãs
), symbol_size_in_bytes);

505 
imgX
[
j
][
i
] = (
img≥l
Ë
	`rshi·_∫d
(
ui16
,
bôshi·
);

511 
imöwidth
 = 
	`imö
(
size_x
, 
o_size_x
);

512 
imöheight
 = 
	`imö
(
size_y
, 
o_size_y
);

513 
d°_off£t_x
 = 0, 
d°_off£t_y
 = 0;

514 
off£t_x
 = 0, 
off£t_y
 = 0;

517 i‡–
o_size_x
 >
size_x
 )

518 
d°_off£t_x
 = ( 
o_size_x
 - 
size_x
 ) >> 1;

520 i‡(
o_size_y
 >
size_y
)

521 
d°_off£t_y
 = ( 
o_size_y
 - 
size_y
 ) >> 1;

525 
imöwidth
 = ( (
off£t_x
 + imöwidth ) > 
size_x
 ) ? (size_x - offset_x) : iminwidth;

526 
imöheight
 = ( (
off£t_y
 + imöheightË> 
size_y
 ) ? (size_y - offset_y) : iminheight;

528 
imöwidth
 = ( (
d°_off£t_x
 + imöwidth ) > 
o_size_x
 ) ? (o_size_x - dst_offset_x) : iminwidth;

529 
imöheight
 = ( (
d°_off£t_y
 + imöheightË> 
o_size_y
 ) ? (o_size_y - dst_offset_y) : iminheight;

531 
j
=0; j < 
imöheight
; j++)

533 
j_pos
 = (
j
 + 
off£t_y
Ë* 
size_x
 + 
off£t_x
;

534 
i
=0; i < 
imöwidth
; i++)

536 
ui16
=0;

537 
	`mem˝y
(&(
ui16
), 
buf
 + ((
i
 + 
j_pos
Ë* 
symbﬁ_size_ö_byãs
), symbol_size_in_bytes);

538 
imgX
[
j
 + 
d°_off£t_y
][
i
 + 
d°_off£t_x
] = (
img≥l
Ë
	`rshi·_∫d
(
ui16
,
bôshi·
);

543 
	}
}

552 
	$buf2img_basic
 (
img≥l
** 
imgX
,

553 * 
buf
,

554 
size_x
,

555 
size_y
,

556 
o_size_x
,

557 
o_size_y
,

558 
symbﬁ_size_ö_byãs
,

559 
dummy


562 
i
,
j
;

563 * 
ãmp_buf
 = 
buf
;

565 i‡(
symbﬁ_size_ö_byãs
> (
img≥l
))

567 
	`îr‹
 ("SourceÖicture has higher bit depthÅhan imgpel dataÅype. \nPleaseÑecompile withÜarger dataÅype for imgpel.", 500);

570 i‡(– (
img≥l
Ë=
symbﬁ_size_ö_byãs
))

573 i‡(
size_x
 =
o_size_x
 && 
size_y
 =
o_size_y
)

574 
	`mem˝y
(&
imgX
[0][0], 
ãmp_buf
, 
size_x
 * 
size_y
 * (
img≥l
));

577 
imöwidth
 = 
	`imö
(
size_x
, 
o_size_x
);

578 
imöheight
 = 
	`imö
(
size_y
, 
o_size_y
);

579 
d°_off£t_x
 = 0, 
d°_off£t_y
 = 0;

580 
off£t_x
 = 0, 
off£t_y
 = 0;

583 i‡–
o_size_x
 >
size_x
 )

584 
d°_off£t_x
 = ( 
o_size_x
 - 
size_x
 ) >> 1;

586 i‡(
o_size_y
 >
size_y
)

587 
d°_off£t_y
 = ( 
o_size_y
 - 
size_y
 ) >> 1;

591 
imöwidth
 = ( (
off£t_x
 + imöwidth ) > 
size_x
 ) ? (size_x - offset_x) : iminwidth;

592 
imöheight
 = ( (
off£t_y
 + imöheightË> 
size_y
 ) ? (size_y - offset_y) : iminheight;

594 
imöwidth
 = ( (
d°_off£t_x
 + imöwidth ) > 
o_size_x
 ) ? (o_size_x - dst_offset_x) : iminwidth;

595 
imöheight
 = ( (
d°_off£t_y
 + imöheightË> 
o_size_y
 ) ? (o_size_y - dst_offset_y) : iminheight;

597 
i
=0; i<
imöheight
;i++) {

598 
	`mem˝y
(&
imgX
[
i
 + 
d°_off£t_y
][
d°_off£t_x
], &(
ãmp_buf
[(ò+ 
off£t_y
Ë* 
size_x
 + 
off£t_x
]), 
imöwidth
 * (
img≥l
));

604 
j_pos
;

605 
uöt16
 
ui16
;

606 i‡(
size_x
 =
o_size_x
 && 
size_y
 =
o_size_y
)

608 
j
=0; j < 
o_size_y
; j++)

610 
j_pos
 = 
j
 * 
size_x
;

611 
i
=0; i < 
o_size_x
; i++)

613 
ui16
=0;

614 
	`mem˝y
(&(
ui16
), 
buf
 + ((
i
 + 
j_pos
Ë* 
symbﬁ_size_ö_byãs
), symbol_size_in_bytes);

615 
imgX
[
j
][
i
](
img≥l
Ë
ui16
;

621 
imöwidth
 = 
	`imö
(
size_x
, 
o_size_x
);

622 
imöheight
 = 
	`imö
(
size_y
, 
o_size_y
);

623 
d°_off£t_x
 = 0, 
d°_off£t_y
 = 0;

624 
off£t_x
 = 0, 
off£t_y
 = 0;

627 i‡–
o_size_x
 >
size_x
 )

628 
d°_off£t_x
 = ( 
o_size_x
 - 
size_x
 ) >> 1;

630 i‡(
o_size_y
 >
size_y
)

631 
d°_off£t_y
 = ( 
o_size_y
 - 
size_y
 ) >> 1;

635 
imöwidth
 = ( (
off£t_x
 + imöwidth ) > 
size_x
 ) ? (size_x - offset_x) : iminwidth;

636 
imöheight
 = ( (
off£t_y
 + imöheightË> 
size_y
 ) ? (size_y - offset_y) : iminheight;

638 
imöwidth
 = ( (
d°_off£t_x
 + imöwidth ) > 
o_size_x
 ) ? (o_size_x - dst_offset_x) : iminwidth;

639 
imöheight
 = ( (
d°_off£t_y
 + imöheightË> 
o_size_y
 ) ? (o_size_y - dst_offset_y) : iminheight;

641 
j
 = 0; j < 
imöheight
; j++)

643 
	`mem˝y
(&
imgX
[
j
 + 
d°_off£t_y
][
d°_off£t_x
], &(
ãmp_buf
[(j + 
off£t_y
Ë* 
size_x
 + 
off£t_x
]), 
imöwidth
 * 
symbﬁ_size_ö_byãs
);

645 
j
=0; j < 
imöheight
; j++)

647 
j_pos
 = (
j
 + 
off£t_y
Ë* 
size_x
 + 
off£t_x
;

648 
i
=0; i < 
imöwidth
; i++)

650 
ui16
 = 0;

651 
	`mem˝y
(&(
ui16
), 
buf
 + ((
i
 + 
j_pos
Ë* 
symbﬁ_size_ö_byãs
), symbol_size_in_bytes);

652 
imgX
[
j
 + 
d°_off£t_y
][
i
 + 
d°_off£t_x
](
img≥l
Ë
ui16
;

657 
	}
}

665 
	$buf2img_ídün
 (
img≥l
** 
imgX
,

666 * 
buf
,

667 
size_x
,

668 
size_y
,

669 
o_size_x
,

670 
o_size_y
,

671 
symbﬁ_size_ö_byãs
,

672 
dummy


675 
i
,
j
;

677 
uöt16
 
tmp16
, 
ui16
;

678 
tmp32
, 
ui32
;

680 i‡(
symbﬁ_size_ö_byãs
 > (
img≥l
))

682 
	`îr‹
 ("SourceÖicture has higher bit depthÅhan imgpel dataÅype. \nPleaseÑecompile withÜarger dataÅype for imgpel.", 500);

685 i‡(
size_x
 !
o_size_x
 || 
size_y
 !
o_size_y
)

687 
	`îr‹
 ("RescalingÇot supported in bigÉndianárchitectures. ", 500);

691 
symbﬁ_size_ö_byãs
)

695 
j
=0;j<
size_y
;j++)

697 
i
=0;i<
size_x
;i++)

699 
imgX
[
j
][
i
](
img≥l
Ë
buf
[ò+ j*
size_x
];

706 
j
=0;j<
size_y
;j++)

708 
i
=0;i<
size_x
;i++)

710 
	`mem˝y
(&
tmp16
, 
buf
+((
i
+
j
*
size_x
)*2), 2);

711 
ui16
 = (
tmp16
 >> 8) | ((tmp16&0xFF)<<8);

712 
imgX
[
j
][
i
] = (
img≥l
Ë
ui16
;

719 
j
=0;j<
size_y
;j++)

721 
i
=0;i<
size_x
;i++)

723 
	`mem˝y
(&
tmp32
, 
buf
+((
i
+
j
*
size_x
)*4), 4);

724 
ui32
 = ((
tmp32
&0xFF00)<<8) | ((tmp32&0xFF)<<24) | ((tmp32&0xFF0000)>>8) | ((tmp32&0xFF000000)>>24);

725 
imgX
[
j
][
i
] = (
img≥l
Ë
ui32
;

732 
	`îr‹
 ("reading only from formats of 8, 16 or 32 bitállowed on bigÉndianárchitecture", 500);

736 
	}
}

745 
	$AŒoˇãFømeMem‹y
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
FømeF‹m©
 *
sour˚
)

749 i‡(
NULL
 =(
p_Vid
->
buf
 = 
	`mÆloc
 (
sour˚
->
size
 * sour˚->
pic_unô_size_shi·3
)))

750 
	`no_mem_exô
("AllocateFrameMemory:Ö_Vid->buf");

751 i‡(
p_I≈
->
öput_fûe1
.
is_öãæóved
)

753 i‡(
NULL
 =(
p_Vid
->
ibuf
 = 
	`mÆloc
 (
sour˚
->
size
 * sour˚->
pic_unô_size_shi·3
)))

754 
	`no_mem_exô
("AllocateFrameMemory:Ö_Vid->ibuf");

756 
	}
}

765 
	$DñëeFømeMem‹y
 (
VideoP¨amëîs
 *
p_Vid
)

767 i‡(
p_Vid
->
buf
 !
NULL
)

768 
	`‰ì
 (
p_Vid
->
buf
);

769 i‡(
p_Vid
->
ibuf
 !
NULL
)

770 
	`‰ì
 (
p_Vid
->
ibuf
);

771 
	}
}

792 
	$ªad_⁄e_‰ame
 (
VideoP¨amëîs
 *
p_Vid
, 
VideoD©aFûe
 *
öput_fûe
, 
FømeNoInFûe
, 
HódîSize
, 
FømeF‹m©
 *
sour˚
, FømeF‹m© *
ouçut
, 
img≥l
 **
pImage
[3])

794 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

795 
fûe_ªad
 = 0;

796 
symbﬁ_size_ö_byãs
 = 
sour˚
->
pic_unô_size_shi·3
;

798 c⁄° 
byãs_y
 = 
sour˚
->
size_cmp
[0] * 
symbﬁ_size_ö_byãs
;

799 c⁄° 
byãs_uv
 = 
sour˚
->
size_cmp
[1] * 
symbﬁ_size_ö_byãs
;

800 
bô_sˇÀ
;

802 
Boﬁón
 
rgb_öput
 = (BoﬁónË(
sour˚
->
cﬁ‹_modñ
 =
CM_RGB
 && sour˚->
yuv_f‹m©
 =
YUV444
);

804 i‡(
öput_fûe
->
is_c⁄ˇã«ãd
 == 0)

806 i‡(
öput_fûe
->
vdty≥
 =
VIDEO_TIFF
)

808 
fûe_ªad
 = 
	`RódTIFFImage
 (
p_I≈
, 
öput_fûe
, 
FømeNoInFûe
, 
sour˚
, 
p_Vid
->
buf
);

812 
fûe_ªad
 = 
	`RódFømeSï¨©e
 (
p_I≈
, 
öput_fûe
, 
FømeNoInFûe
, 
HódîSize
, 
sour˚
, 
p_Vid
->
buf
);

817 
fûe_ªad
 = 
	`RódFømeC⁄ˇã«ãd
 (
p_I≈
, 
öput_fûe
, 
FømeNoInFûe
, 
HódîSize
, 
sour˚
, 
p_Vid
->
buf
);

820 i‡–!
fûe_ªad
 )

826 i‡(
öput_fûe
->
is_öãæóved
)

828 
	`deöãæóve
 ( &
p_Vid
->
buf
, &p_Vid->
ibuf
, 
sour˚
, 
symbﬁ_size_ö_byãs
);

831 
bô_sˇÀ
 = 
sour˚
->
bô_dïth
[0] - 
ouçut
->bit_depth[0];

833 if(
rgb_öput
)

834 
p_Vid
->
	`buf2img
(
pImage
[0],Ö_Vid->
buf
 + 
byãs_y
, 
sour˚
->
width
[0], sour˚->
height
[0], 
ouçut
->width[0], ouçut->height[0], 
symbﬁ_size_ö_byãs
, 
bô_sˇÀ
);

836 
p_Vid
->
	`buf2img
(
pImage
[0],Ö_Vid->
buf
, 
sour˚
->
width
[0], sour˚->
height
[0], 
ouçut
->width[0], ouçut->height[0], 
symbﬁ_size_ö_byãs
, 
bô_sˇÀ
);

838 #i‡(
DEBUG_BITDEPTH
)

839 
	`MaskMSBs
(
pImage
[0], ((1 << 
ouçut
->
bô_dïth
[0]Ë- 1), ouçut->
width
[0], ouçut->
height
[0]);

842 i‡(
p_Vid
->
yuv_f‹m©
 !
YUV400
)

844 
bô_sˇÀ
 = 
sour˚
->
bô_dïth
[1] - 
ouçut
->bit_depth[1];

845 #i‡(
ALLOW_GRAYSCALE
)

846 i‡(!
p_I≈
->
gøysˇÀ
)

849 if(
rgb_öput
)

850 
p_Vid
->
	`buf2img
(
pImage
[1],Ö_Vid->
buf
 + 
byãs_y
 + 
byãs_uv
, 
sour˚
->
width
[1], sour˚->
height
[1], 
ouçut
->width[1], ouçut->height[1], 
symbﬁ_size_ö_byãs
, 
bô_sˇÀ
);

852 
p_Vid
->
	`buf2img
(
pImage
[1],Ö_Vid->
buf
 + 
byãs_y
, 
sour˚
->
width
[1], sour˚->
height
[1], 
ouçut
->width[1], ouçut->height[1], 
symbﬁ_size_ö_byãs
, 
bô_sˇÀ
);

854 
bô_sˇÀ
 = 
sour˚
->
bô_dïth
[2] - 
ouçut
->bit_depth[2];

855 if(
rgb_öput
)

856 
p_Vid
->
	`buf2img
(
pImage
[2],Ö_Vid->
buf
, 
sour˚
->
width
[1], sour˚->
height
[1], 
ouçut
->width[1], ouçut->height[1], 
symbﬁ_size_ö_byãs
, 
bô_sˇÀ
);

858 
p_Vid
->
	`buf2img
(
pImage
[2],Ö_Vid->
buf
 + 
byãs_y
 + 
byãs_uv
, 
sour˚
->
width
[1], sour˚->
height
[1], 
ouçut
->width[1], ouçut->height[1], 
symbﬁ_size_ö_byãs
, 
bô_sˇÀ
);

860 #i‡(
DEBUG_BITDEPTH
)

861 
	`MaskMSBs
(
pImage
[1], ((1 << 
ouçut
->
bô_dïth
[1]Ë- 1), ouçut->
width
[1], ouçut->
height
[1]);

862 
	`MaskMSBs
(
pImage
[2], ((1 << 
ouçut
->
bô_dïth
[2]Ë- 1), ouçut->
width
[1], ouçut->
height
[1]);

866  
fûe_ªad
;

867 
	}
}

889 
	$∑d_b‹dîs
 (
FømeF‹m©
 
ouçut
, 
img_size_x
, 
img_size_y
, 
img_size_x_¸
, 
img_size_y_¸
, 
img≥l
 **
pImage
[3])

891 
x
, 
y
;

895 i‡(
ouçut
.
width
[0] < 
img_size_x
)

896 
y
 = 0; y < 
ouçut
.
height
[0]; y++)

897 
x
 = 
ouçut
.
width
[0]; x < 
img_size_x
; x++)

898 
pImage
[0][
y
][
x
] =ÖImage[0][y][x-1];

901 i‡(
ouçut
.
height
[0] < 
img_size_y
)

902 
y
 = 
ouçut
.
height
[0]; y<
img_size_y
; y++)

903 
	`mem˝y
(
pImage
[0][
y
],ÖImage[0][y - 1], 
img_size_x
 * (
img≥l
));

906 i‡(
ouçut
.
yuv_f‹m©
 !
YUV400
)

908 
k
;

910 
k
 = 1; k < 3; k++)

913 i‡(
ouçut
.
width
[1] < 
img_size_x_¸
)

914 
y
=0; y < 
ouçut
.
height
[1]; y++)

915 
x
 = 
ouçut
.
width
[1]; x < 
img_size_x_¸
; x++)

916 
pImage
 [
k
][
y
][
x
] =ÖImage[k][y][x-1];

919 i‡(
ouçut
.
height
[1] < 
img_size_y_¸
)

920 
y
 = 
ouçut
.
height
[1]; y < 
img_size_y_¸
; y++)

921 
	`mem˝y
(
pImage
[
k
][
y
],ÖImage[k][y - 1], 
img_size_x_¸
 * (
img≥l
));

924 
	}
}

	@lcommon/src/io_raw.c

15 
	~"c⁄åibut‹s.h
"

17 
	~"globÆ.h
"

18 
	~"img_io.h
"

20 
	#FAST_READ
 1

	)

22 #i‡
FAST_READ


23 
ölöe
 
	$RódD©a
 (
vfûe
, 
FømeF‹m©
 *
sour˚
, *
buf
)

25 *
cur_buf
 = 
buf
;

26 
ªad_size
 = 
sour˚
->
pic_unô_size_shi·3
 * sour˚->
width
[0];

27 
i
, 
j
;

29 
i
 = 0; i < 
sour˚
->
height
[0]; i++)

31 i‡(
	`ªad
(
vfûe
, 
cur_buf
, 
ªad_size
) !=Ñead_size)

33 
	`¥ötf
 ("ªad_⁄e_‰ame: c™nŸÑód %d byã†‰om i≈uàfûe, u√x≥˘ed EOF!\n", 
sour˚
->
width
[0]);

36 
cur_buf
 +
ªad_size
;

39 i‡(
sour˚
->
yuv_f‹m©
 !
YUV400
)

41 
ªad_size
 = 
sour˚
->
pic_unô_size_shi·3
 * sour˚->
width
[1];

42 
j
 = 0; j < 2; j++)

44 
i
 = 0; i < 
sour˚
->
height
[1]; i++)

46 i‡(
	`ªad
(
vfûe
, 
cur_buf
, 
ªad_size
) !=Ñead_size)

48 
	`¥ötf
 ("ªad_⁄e_‰ame: c™nŸÑód %d byã†‰om i≈uàfûe, u√x≥˘ed EOF!\n", 
sour˚
->
width
[1]);

51 
cur_buf
 +
ªad_size
;

56 
	}
}

58 
ölöe
 
	$RódD©a
 (
vfûe
, 
‰amesize_ö_byãs
, *
buf
)

60 i‡(
	`ªad
(
vfûe
, 
buf
, (Ë
‰amesize_ö_byãs
) != () framesize_in_bytes)

62 
	`¥ötf
 ("ªad_⁄e_‰ame: c™nŸÑód %d byã†‰om i≈uàfûe, u√x≥˘ed EOF!\n", (Ë
‰amesize_ö_byãs
);

69 
	}
}

72 
ölöe
 
	$RódD©aV210
 (
vfûe
, 
‰amesize_ö_byãs
, *
buf
)

74 i‡(
	`ªad
(
vfûe
, 
buf
, (Ë
‰amesize_ö_byãs
) != () framesize_in_bytes)

76 
	`¥ötf
 ("ªad_⁄e_‰ame: c™nŸÑód %d byã†‰om i≈uàfûe, u√x≥˘ed EOF!\n", (Ë
‰amesize_ö_byãs
);

83 
	}
}

104 
	$RódFømeC⁄ˇã«ãd
 (
I≈utP¨amëîs
 *
p_I≈
, 
VideoD©aFûe
 *
öput_fûe
, 
FømeNoInFûe
, 
HódîSize
, 
FømeF‹m©
 *
sour˚
, *
buf
)

106 
fûe_ªad
 = 0;

107 
vfûe
 = 
öput_fûe
->
f_num
;

108 
Boﬁón
 
is_v210
 = (
öput_fûe
->
is_öãæóved
 && 
sour˚
->
pixñ_f‹m©
 =
V210
);

109 
symbﬁ_size_ö_byãs
 = 
sour˚
->
pic_unô_size_shi·3
;

111 c⁄° 
byãs_y
 = 
sour˚
->
size_cmp
[0] * 
symbﬁ_size_ö_byãs
;

112 c⁄° 
byãs_uv
 = 
sour˚
->
size_cmp
[1] * 
symbﬁ_size_ö_byãs
;

114 c⁄° 
öt64
 
‰amesize_ö_byãs
 = (
is_v210
 =
TRUE
Ë? 16 * (
sour˚
->
size_cmp
[0] / 6Ë: 
byãs_y
 + 2 * 
byãs_uv
;

117 i‡(
	`l£ek
 (
vfûe
, 
HódîSize
 + 
‰amesize_ö_byãs
 * (
FømeNoInFûe
 + 
p_I≈
->
°¨t_‰ame
), 
SEEK_SET
) == -1)

119 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "ªad_⁄e_‰ame: c™nŸádv™˚ fûêpoöã∏ö i≈uàfûêbey⁄d fømê%d\n", 
p_I≈
->
°¨t_‰ame
 + 
FømeNoInFûe
);

120 
	`îr‹
 (
îr‹ãxt
,-1);

125 i‡((
sour˚
->
pic_unô_size_⁄_disk
 & 0x07) == 0)

127 i‡(
is_v210
 =
TRUE
)

129 
fûe_ªad
 = 
	`RódD©aV210
(
vfûe
, (Ë
‰amesize_ö_byãs
, 
buf
);

133 #i‡
FAST_READ


134 
fûe_ªad
 = 
	`RódD©a
 (
vfûe
, 
sour˚
, 
buf
);

136 
fûe_ªad
 = 
	`RódD©a
 (
vfûe
, (Ë
‰amesize_ö_byãs
, 
buf
);

142 
	`¥ötf
 ("read_one_frame (NOT IMPLEMENTED):Öic unit size on disk must be divisible by 8");

143 
	`exô
 (-1);

145  
fûe_ªad
;

146 
	}
}

166 
	$RódFømeSï¨©e
 (
I≈utP¨amëîs
 *
p_I≈
, 
VideoD©aFûe
 *
öput_fûe
, 
FømeNoInFûe
, 
HódîSize
, 
FømeF‹m©
 *
sour˚
, *
buf
)

168 
fûe_ªad
 = 0;

169 
vfûe
 = 
öput_fûe
->
f_num
;

171 
	`O≥nFømeFûe
–
öput_fûe
, 
FømeNoInFûe
 + 
p_I≈
->
°¨t_‰ame
);

174 i‡(
	`l£ek
 (
vfûe
, 
HódîSize
, 
SEEK_SET
) != HeaderSize)

176 
	`îr‹
 ("read_one_frame: cannot fseekÅo (Header size) in input file", -1);

180 i‡((
sour˚
->
pic_unô_size_⁄_disk
 & 0x07) == 0)

182 #i‡
FAST_READ


183 
fûe_ªad
 = 
	`RódD©a
 (
vfûe
, 
sour˚
, 
buf
);

185 
symbﬁ_size_ö_byãs
 = 
sour˚
->
pic_unô_size_shi·3
;

187 c⁄° 
byãs_y
 = 
sour˚
->
size_cmp
[0] * 
symbﬁ_size_ö_byãs
;

188 c⁄° 
byãs_uv
 = 
sour˚
->
size_cmp
[1] * 
symbﬁ_size_ö_byãs
;

189 c⁄° 
öt64
 
‰amesize_ö_byãs
 = 
byãs_y
 + 2*
byãs_uv
;

191 
fûe_ªad
 = 
	`RódD©a
 (
vfûe
, (Ë
‰amesize_ö_byãs
, 
buf
);

196 
	`¥ötf
 ("read_one_frame (NOT IMPLEMENTED):Öic unit size on disk must be divisible by 8");

197 
	`exô
 (-1);

200 i‡(
vfûe
 != -1)

201 
	`˛o£
(
vfûe
);

203  
fûe_ªad
;

204 
	}
}

	@lcommon/src/io_tiff.c

15 
	~"c⁄åibut‹s.h
"

16 
	~"ªp‹t.h
"

17 
	~"io_tiff.h
"

21 
	#YRES
 1080

	)

26 
	eTiffTy≥
 {

27 
	mT_BYTE
 = 1,

28 
	mT_ASCII
 = 2,

29 
	mT_SHORT
 = 3,

30 
	mT_LONG
 = 4,

31 
	mT_RATIONAL
 = 5,

32 
	mT_SBYTE
 = 6,

33 
	mT_UNDEFINED
 = 7,

34 
	mT_SSHORT
 = 8,

35 
	mT_SLONG
 = 9,

36 
	mT_SRATIONAL
 = 10,

37 
	mT_FLOAT
 = 11,

38 
	mT_DOUBLE
 = 12

39 } 
	tTiffTy≥
;

42 
	sTiffDúe˘‹yE¡ry
 {

43 
uöt16
 
	mèg
;

44 
uöt16
 
	mty≥
;

45 
uöt32
 
	mcou¡
;

46 
uöt32
 
	moff£t
;

47 } 
	tTiffDúe˘‹yE¡ry
;

51 
	sTiffIFD
 {

52 
uöt16
 
	mnE¡rõs
;

53 
TiffDúe˘‹yE¡ry
 *
	mdúe˘‹yE¡ry
;

54 } 
	tTiffIFD
;

57 
	sTiffImageFûeHódî
 {

58 
uöt16
 
	mbyãOrdî
;

59 
uöt16
 
	m¨bôøryNumbî
;

60 
uöt32
 
	moff£t
;

61 } 
	tTiffImageFûeHódî
;

65 
	sTiff
 {

66 
uöt16
 *
	mimg
;

67 
uöt8
 *
	mfûeInMem‹y
;

68 
uöt8
 *
	mmp
;

69 
	mÀ
;

70 
	mnSåùs
;

71 
TiffImageFûeHódî
 
	mifh
;

73 
uöt16
 
	mOrõ¡©i⁄
;

74 
uöt32


75 
	mBôsPîSam∂e
[3],

76 
	mRowsPîSåù
,

77 
	mImageLígth
,

78 
	mImageWidth
,

79 
	mSåùByãCou¡s
[
YRES
],

80 
	mSåùOff£ts
[
YRES
],

81 
	mXResﬁuti⁄
[2],

82 
	mYResﬁuti⁄
[2];

84 
uöt32
 (*
gëU16
Ë(
	mTiff
 *);

85 
uöt32
 (*
gëU32
Ë(
	mTiff
 *);

86 } 
	tTiff
;

89 
	eVideoCode
 {

90 
	mVC_NULL
 = 0,

91 
	mVC_ITU_REC709
 = 1,

92 
	mVC_CCIR_601
 = 3,

93 
	mVC_FCC
 = 4,

94 
	mVC_ITU_REC624BG
 = 5,

95 
	mVC_SMPTE_170M
 = 6,

96 
	mVC_SMPTE_240M
 = 7,

97 
	mVC_SMPTE_260M
 = 7,

98 
	mVC_ITU_REC709_EXACT
 = 8,

99 
	mVC_MAX
 = 8

100 } 
	tVideoCode
;

103 c⁄° 
	gC€f
[
VC_MAX
+1][3] = {

115 
	#CR
 
C€f
[
videoCode
][0]

	)

116 
	#CG
 
C€f
[
videoCode
][1]

	)

117 
	#CB
 
C€f
[
videoCode
][2]

	)

118 
	#CU
 (0.5/(
CB
-1.0))

	)

119 
	#CV
 (0.5/(
CR
-1.0))

	)

122 
	#°dSˇÀY
 219.0

123 
	#°dSˇÀUV
 224.0

124 

	)

125 
	#INTEGER_SCALE
 16384

	)

126 
	#INTEGER_SHIFT
 14

	)

130 
	sRGB_YUV
 {

131 
uöt16


132 
	mpixMax
;

134 
	m°dR™ge
,

135 
	my
, 
	mu
, 
	mv
,

136 
	mr
, 
	mg
, 
	mb
,

137 
	myr
, 
	myg
, 
	myb
,

138 
	mur
, 
	mug
, 
	mub
,

139 
	mvr
, 
	mvg
, 
	mvb
,

140 
	moffy
, 
	moffuv
;

142 
	msy
, 
	msuv
;

143 } 
	tRGB_YUV
;

152 
	$c⁄°ru˘Tiff
 (
Tiff
 * 
t
)

154 
t
->
fûeInMem‹y
 = 0;

155 
t
->
img
 = 0;

156 
t
->
mp
 = 0;

157 
	}
}

167 
	$de°ru˘Tiff
 (
Tiff
 * 
t
)

169 
	`‰ì_poöãr
–
t
->
fûeInMem‹y
);

170 
	`‰ì_poöãr
–
t
->
img
);

171 
	}
}

183 
uöt32
 
	$gëU16
 (
Tiff
 * 
t
)

186 
uöt8
 
ö
[2];

187 
uöt16
 
out
;

188 } 
u
;

189 
u
.
ö
[0] = *
t
->
mp
++;

190 
u
.
ö
[1] = *
t
->
mp
++;

191  
u
.
out
;

192 
	}
}

202 
uöt32
 
	$gëU32
 (
Tiff
 * 
t
)

205 
uöt8
 
ö
[4];

206 
uöt32
 
out
;

207 } 
u
;

208 
u
.
ö
[0] = *
t
->
mp
++;

209 
u
.
ö
[1] = *
t
->
mp
++;

210 
u
.
ö
[2] = *
t
->
mp
++;

211 
u
.
ö
[3] = *
t
->
mp
++;

212  
u
.
out
;

213 
	}
}

225 
uöt32
 
	$gëSw≠≥dU16
 (
Tiff
 * 
t
)

228 
uöt8
 
ö
[2];

229 
uöt16
 
out
;

230 } 
u
;

231 
u
.
ö
[1] = *
t
->
mp
++;

232 
u
.
ö
[0] = *
t
->
mp
++;

233  
u
.
out
;

234 
	}
}

244 
uöt32
 
	$gëSw≠≥dU32
 (
Tiff
 * 
t
)

247 
uöt8
 
ö
[4];

248 
uöt32
 
out
;

249 } 
u
;

250 
u
.
ö
[3] = *
t
->
mp
++;

251 
u
.
ö
[2] = *
t
->
mp
++;

252 
u
.
ö
[1] = *
t
->
mp
++;

253 
u
.
ö
[0] = *
t
->
mp
++;

254  
u
.
out
;

255 
	}
}

265 
	$gëI¡Aºay
 (
Tiff
 * 
t
, 
uöt32
 
off£t
, 
TiffTy≥
 
ty≥
, uöt32 
a
[], 
n
)

267 
i
;

268 
uöt8
 *
mp
 = 
t
->mp;

270 
t
->
mp
 =Å->
fûeInMem‹y
 + 
off£t
;

271 
ty≥
)

273 
T_SHORT
:

274 
i
=0; i < 
n
; ++i)

276 
a
[
i
] = 
	`gëU16
–
t
);

279 
T_LONG
:

280 
i
=0; i < 
n
; ++i)

282 
a
[
i
] = 
	`gëU32
–
t
);

285 
T_RATIONAL
:

286 
i
=0; i < 2*
n
; ++i)

288 
a
[
i
] = 
	`gëU32
–
t
);

292 
	`as£π
–
ty≥
 =
T_SHORT
 ||Åy≥ =
T_LONG
 ||Åy≥ =
T_RATIONAL
);

294 
t
->
mp
 = mp;

295 
	}
}

305 
	$ªadDúe˘‹yE¡ry
 (
Tiff
 * 
t
)

307 
uöt32
 
èg
 = 
t
->
	`gëU16
(Å);

308 
TiffTy≥
 
ty≥
 = (TiffTy≥Ë
t
->
	`gëU16
(Å);

309 
uöt32
 
cou¡
 = 
t
->
	`gëU32
(Å);

310 
uöt32
 
off£t
 = 
t
->
	`gëU32
(Å);

312 
èg
)

315 
	`as£π
–
cou¡
 == 1);

317 
t
->
ImageWidth
 = 
off£t
;

320 
	`as£π
–
cou¡
 == 1);

322 
t
->
ImageLígth
 = 
off£t
;

323 i‡(
off£t
 > 
YRES
)

325 
	`Ârötf
–
°dîr
, "ªadDúe˘‹yE¡ry: ImageLígth (%dËex˚ed†buûtö maximum o‡%d\n", 
off£t
, 
YRES
);

330 i‡(
cou¡
 != 3)

332 
	`Ârötf
–
°dîr
, "BitsPerSample (only [3] supported)\n");

335 
	`gëI¡Aºay
–
t
, 
off£t
, 
ty≥
,Å->
BôsPîSam∂e
, 3);

337 i‡(
t
->
BôsPîSam∂e
[0] !=Å->BitsPerSample[1] ||Å->BitsPerSample[0] !=Å->BitsPerSample[2])

339 
	`Ârötf
–
°dîr
, "BitsPerSample must beÅhe same foráll samples\n");

342 i‡(
t
->
BôsPîSam∂e
[0] != 8 &&Å->BitsPerSample[0] != 16)

344 
	`Ârötf
–
°dîr
, "Only 8 or 16 BitsPerSample is supported\n");

349 
	`as£π
–
cou¡
 == 1);

351 i‡(
off£t
 != 1)

353 
	`Ârötf
–
°dîr
, "Only uncompressed TIFF files supported\n");

358 
	`as£π
–
cou¡
 == 1);

360 
	`as£π
–
off£t
 == 2);

364 
	`gëI¡Aºay
–
t
, 
off£t
, 
ty≥
,Å->
SåùOff£ts
, 
cou¡
);

365 
t
->
nSåùs
 = 
cou¡
;

368 
	`as£π
–
cou¡
 == 1);

370 
t
->
Orõ¡©i⁄
 = (
uöt16
Ë
off£t
;

371 i‡(
t
->
Orõ¡©i⁄
 != 1)

373 
	`Ârötf
–
°dîr
, "Only Orientation 1 is supported\n");

378 
	`as£π
–
cou¡
 == 1);

380 
	`as£π
–
off£t
 == 3);

383 
	`as£π
–
cou¡
 == 1);

385 
t
->
RowsPîSåù
 = 
off£t
;

389 
	`gëI¡Aºay
–
t
, 
off£t
, 
ty≥
,Å->
SåùByãCou¡s
, 
cou¡
);

392 
	`as£π
–
cou¡
 == 1);

393 
	`gëI¡Aºay
–
t
, 
off£t
, 
ty≥
,Å->
XResﬁuti⁄
, 1);

397 
	`as£π
–
cou¡
 == 1);

398 
	`gëI¡Aºay
–
t
, 
off£t
, 
ty≥
,Å->
YResﬁuti⁄
, 1);

402 
	`as£π
–
cou¡
 == 1);

404 
	`as£π
–
off£t
 == 1);

408 
	`as£π
–
cou¡
 == 1);

419 
	}
}

431 
	$ªadFûeI¡oMem‹y
 (
Tiff
 * 
t
, c⁄° * 
∑th
)

434 
˙t
, 
ªsu…
;

435 
uöt16


436 
byãOrdî
;

438 
ídün
 = 1,

439 
machöeLôéeEndün
 = (*–(*)(&
ídün
) ) == 1) ? 1 : 0,

440 
fd
;

442 
	`as£π
–
t
);

443 
	`as£π
–
∑th
);

445 
fd
 = 
	`›í
–
∑th
, 
OPENFLAGS_READ
);

446 i‡(
fd
 == -1)

448 
	`Ârötf
–
°dîr
, "Couldn'à›íÅÿªad: %s\n", 
∑th
);

452 
˙t
 = (Ë
	`l£ek
–
fd
, 0, 
SEEK_END
);

453 i‡(
˙t
 == -1L)

456 i‡(
	`l£ek
–
fd
, 0, 
SEEK_SET
) == -1L)

459 
t
->
fûeInMem‹y
 = (
uöt8
 *Ë
	`ªÆloc
–t->fûeInMem‹y, 
˙t
);

460 i‡(
t
->
fûeInMem‹y
 == 0)

462 
	`˛o£
–
fd
);

466 
ªsu…
 = (Ë
	`ªad
–
fd
, 
t
->
fûeInMem‹y
, 
˙t
);

467 i‡(
ªsu…
 !
˙t
)

469 
	`˛o£
–
fd
);

473 
	`˛o£
–
fd
);

475 
byãOrdî
 = (
t
->
fûeInMem‹y
[0] << 8) |Å->fileInMemory[1];

476 
byãOrdî
)

479 
t
->
À
 = 1;

483 
t
->
À
 = 0;

487 
	`Ârötf
–
°dîr
, "FirstÅwo bytes indicate: Notá TIFF file\n");

488 
	`‰ì_poöãr
–
t
->
fûeInMem‹y
);

491 i‡(
t
->
À
 =
machöeLôéeEndün
)

493 
t
->
gëU16
 = getU16;

494 
t
->
gëU32
 = getU32;

498 
t
->
gëU16
 = 
gëSw≠≥dU16
;

499 
t
->
gëU32
 = 
gëSw≠≥dU32
;

501 
t
->
mp
 =Å->
fûeInMem‹y
;

503 
	}
}

512 
	$ªadImageD©a
 (
Tiff
 * 
t
)

514 
i
, 
j
, 
n
;

515 
uöt8
 *
mp
, *
s
;

516 
uöt16
 *
p
;

517 
uöt32
 
size
;

519 
	`as£π
–
t
);

521 
size
 = 
t
->
ImageWidth
 *Å->
ImageLígth
 * 3 * (
uöt16
);

522 
t
->
img
 = (
uöt16
 *Ë
	`ªÆloc
–t->img, 
size
);

523 i‡(
t
->
img
 == 0)

526 
t
->
BôsPîSam∂e
[0])

529 
p
 = 
t
->
img
;

530 
i
=0; i < 
t
->
nSåùs
; ++i)

532 
n
 = 
t
->
SåùByãCou¡s
[
i
];

533 
s
 = 
t
->
fûeInMem‹y
 +Å->
SåùOff£ts
[
i
];

534 
j
=0; j < 
n
; ++j)

536 *
p
++ = *
s
++;

541 
mp
 = 
t
->mp;

542 
p
 = 
t
->
img
;

543 
i
=0; i < 
t
->
nSåùs
; ++i)

545 
n
 = 
t
->
SåùByãCou¡s
[
i
] / 2;

546 
t
->
mp
 =Å->
fûeInMem‹y
 +Å->
SåùOff£ts
[
i
];

547 
j
=0; j < 
n
; ++j)

549 *
p
++ = (
uöt16
Ë
	`gëU16
–
t
);

552 
t
->
mp
 = mp;

556 
	}
}

566 
	$ªadImageFûeDúe˘‹y
 (
Tiff
 * 
t
)

568 
uöt32
 
i
;

569 
uöt32
 
nE¡rõs
 = 
t
->
	`gëU16
(Å);

571 
i
=0; i < 
nE¡rõs
; ++i)

573 
	`ªadDúe˘‹yE¡ry
–
t
);

576 
	}
}

586 
	$ªadImageFûeHódî
 (
Tiff
 * 
t
)

588 
t
->
ifh
.
byãOrdî
 = (
uöt16
Ë
	`gëU16
(Å);

589 
t
->
ifh
.
¨bôøryNumbî
 = (
uöt16
Ë
	`gëU16
(Å);

590 
t
->
ifh
.
off£t
 = 
	`gëU32
(Å);

591 i‡(
t
->
ifh
.
¨bôøryNumbî
 != 42)

593 
	`Ârötf
–
°dîr
, "ImageFileHeader.arbitrary != 42\n");

596 
t
->
mp
 =Å->
fûeInMem‹y
 +Å->
ifh
.
off£t
;

598 
	}
}

607 
	$ªadTiff
 (
Tiff
 * 
t
, * 
∑th
) {

608 
	`as£π
–
t
);

609 
	`as£π
–
∑th
);

611 i‡(
	`ªadFûeI¡oMem‹y
–
t
, 
∑th
))

612 
Eº‹
;

613 i‡(
	`ªadImageFûeHódî
–
t
))

614 
Eº‹
;

615 i‡(
	`ªadImageFûeDúe˘‹y
–
t
))

616 
Eº‹
;

617 i‡(
	`ªadImageD©a
–
t
))

618 
Eº‹
;

621 
Eº‹
:

622 
	`‰ì_poöãr
–
t
->
fûeInMem‹y
);

623 
	`‰ì_poöãr
–
t
->
img
);

625 
	}
}

634 
	$RGB_YUV_öôülize
 (
RGB_YUV
 * 
T
,

635 
VideoCode
 
videoCode
,

636 
°dR™ge
,

637 
uöt16
 
pixMax


640 
i
, 
pixSˇÀ
;

642 
videoCode
)

644 
VC_ITU_REC709
:

645 
VC_CCIR_601
:

648 
	`Ârötf
–
°dîr
, "RGB_YUV_öôülize: Unsuµ‹ãd videoCodê(%d)\n", 
videoCode
);

652 
T
->
°dR™ge
 = stdRange;

653 
T
->
pixMax
 =ÖixMax;

655 
pixSˇÀ
 = ()
pixMax
 + (()pixMax & 1);

657 i‡(
°dR™ge
)

659 
T
->
offy
 = ()(
INTEGER_SCALE
 * (
pixSˇÀ
 * 16 / 256.0 + 0.5));

660 
T
->
sy
 = 
INTEGER_SCALE
 * 
°dSˇÀY
 / 255.0;

661 
T
->
suv
 = 
INTEGER_SCALE
 * 
°dSˇÀUV
 / 255.0;

665 
T
->
offy
 = ()(
INTEGER_SCALE
 * 0.5);

666 
T
->
sy
 = 
INTEGER_SCALE
;

667 
T
->
suv
 = 
INTEGER_SCALE
;

669 
T
->
offuv
 = ()(
INTEGER_SCALE
 * (0.5 * 
pixSˇÀ
 + 0.5));

672 
T
->
yr
 = ()(T-> 
sy
*
CR
 +0.5); T->
yg
 = ()(T-> sy*
CG
 +0.5); T->
yb
 = ()(T-> sy*
CB
 +0.5);

673 
T
->
ur
 = ()(T->
suv
*
CR
*
CU
-0.5); T->
ug
 = ()(T->suv*
CG
*CU-0.5); T->
ub
 = ()(T->suv*0.5 +0.5);

674 
T
->
vr
 = ()(T->
suv
*0.5 +0.5); T->
vg
 = ()(T->suv*
CG
*
CV
-0.5); T->
vb
 = ()(T->suv*
CB
*CV-0.5);

676 
i
 = ()(
T
->
sy
 + 0.5);

677 i‡(
T
->
yr
+T->
yg
+T->
yb
 !
i
)

679 
	`Ârötf
–
°dîr
, "ERROR: RGB_YUV_öôülize: yr+yg+yb=%d sy=%u\n", 
T
->
yr
+T->
yg
+T->
yb
, 
i
);

682 i‡(
T
->
ur
+T->
ug
+T->
ub
)

684 
	`Ârötf
–
°dîr
, "ERROR: RGB_YUV_öôülize: ur+ug+ub=%d\n", 
T
->
ur
+T->
ug
+T->
ub
);

687 i‡(
T
->
vr
+T->
vg
+T->
vb
)

689 
	`Ârötf
–
°dîr
, "ERROR: RGB_YUV_öôülize: vr+vg+vb=%d\n", 
T
->
vr
+T->
vg
+T->
vb
);

694 
	}
}

703 
	$RGB_YUV_rgb_to_yuv
 (
RGB_YUV
 * 
T
,

704 
uöt16
 *
Ω
,

705 
uöt16
 *
gp
,

706 
uöt16
 *
bp
,

707 
xªs
,

708 
yªs
,

709 
rgb_°ride
,

710 
uöt16
 *
yp
,

711 
uöt16
 *
up
,

712 
uöt16
 *
vp
,

713 
yuv_°ride


716 
i
;

717 
cou¡
 = 
xªs
 * 
yªs
;

719 i‡(
T
->
°dR™ge
)

721 
i
=0; i < 
cou¡
; ++i)

723 
T
->
r
 = (Ë*
Ω
;Ñ∞+
rgb_°ride
;

724 
T
->
g
 = (Ë*
gp
; g∞+
rgb_°ride
;

725 
T
->
b
 = (Ë*
bp
; b∞+
rgb_°ride
;

727 *
yp
 = (
uöt16
)((
T
->
yr
*T->
r
 + T->
yg
*T->
g
 + T->
yb
*T->
b
 + T-> 
offy
Ë>> 
INTEGER_SHIFT
); y∞+
yuv_°ride
;

728 *
up
 = (
uöt16
)((
T
->
ur
*T->
r
 + T->
ug
*T->
g
 + T->
ub
*T->
b
 + T->
offuv
Ë>> 
INTEGER_SHIFT
); u∞+
yuv_°ride
;

729 *
vp
 = (
uöt16
)((
T
->
vr
*T->
r
 + T->
vg
*T->
g
 + T->
vb
*T->
b
 + T->
offuv
Ë>> 
INTEGER_SHIFT
); v∞+
yuv_°ride
;

734 
i
=0; i < 
cou¡
; ++i)

736 
T
->
r
 = (Ë*
Ω
;Ñ∞+
rgb_°ride
;

737 
T
->
g
 = (Ë*
gp
; g∞+
rgb_°ride
;

738 
T
->
b
 = (Ë*
bp
; b∞+
rgb_°ride
;

742 
T
->
y
 = (T->
yr
*T->
r
 + T->
yg
*T->
g
 + T->
yb
*T->
b
 + T-> 
offy
Ë>> 
INTEGER_SHIFT
;

743 i‡(
T
->
y
 < 0)

744 
T
->
y
 = 0;

745 i‡(
T
->
y
 > T->
pixMax
)

746 
T
->
y
 = (ËT->
pixMax
;

747 *
yp
 = (
uöt16
Ë
T
->
y
; y∞+
yuv_°ride
;

749 
T
->
u
 = (T->
ur
*T->
r
 + T->
ug
*T->
g
 + T->
ub
*T->
b
 + T->
offuv
Ë>> 
INTEGER_SHIFT
;

750 i‡(
T
->
u
 < 0)

751 
T
->
u
 = 0;

752 i‡(
T
->
u
 > T->
pixMax
)

753 
T
->
u
 = (ËT->
pixMax
;

754 *
up
 = (
uöt16
Ë
T
->
u
; u∞+
yuv_°ride
;

756 
T
->
v
 = (T->
vr
*T->
r
 + T->
vg
*T->
g
 + T->
vb
*T->
b
 + T->
offuv
Ë>> 
INTEGER_SHIFT
;

757 i‡(
T
->
v
 < 0)

758 
T
->
v
 = 0;

759 i‡(
T
->
v
 > T->
pixMax
)

760 
T
->
v
 = (ËT->
pixMax
;

761 *
vp
 = (
uöt16
Ë
T
->
v
; v∞+
yuv_°ride
;

764 
	}
}

798 
	$h‹iz⁄èl_hÆf_1ch™_cosôe
 (
uöt16
 *
§cPå
,

799 
§cXªs
,

800 
yªs
,

801 
§cZªs
,

802 
uöt16
 *
d°På
,

803 
d°Zªs
,

804 
pixMax


807 
x
, 
y
, 
limô
, 
n7
, 
n5
, 
n3
, 
n1
;

808 
ªsu…
;

809 
uöt16
 *
§c
 = 
§cPå
;

810 
uöt16
 *
d°
 = 
d°På
;

812 
y
=0; y < 
yªs
; y++)

814 
x
=0; x < 8; x+=2)

816 
n1
 = (
x
 >= 1) ? 1 : x;

817 
n3
 = (
x
 >= 3) ? 3 : x;

818 
n5
 = (
x
 >= 5) ? 5 : x;

819 
n7
 = (
x
 >= 7) ? 7 : x;

820 
ªsu…
 = ( 2048* *(
§c
)

821 + 1228*–*(
§c
-
n1
*
§cZªs
) + *(src+ srcZres) )

822 - 262*–*(
§c
-
n3
*
§cZªs
) + *(src+3*srcZres) )

823 + 47*–*(
§c
-
n5
*
§cZªs
) + *(src+5*srcZres) )

824 + 11*–*(
§c
-
n7
*
§cZªs
) + *(src+7*srcZres) )+2048) / 4096;

825 i‡(
ªsu…
 < 0)

826 
ªsu…
 = 0;

827 i‡(
ªsu…
 > 
pixMax
)

828 
ªsu…
 = 
pixMax
;

829 *
d°
 = (
uöt16
Ë
ªsu…
;

830 
d°
 +
d°Zªs
;

831 
§c
 +2*
§cZªs
;

834 
limô
 = 
§cXªs
 - 8;

835 
x
=8; x < 
limô
; x+=2)

837 
ªsu…
 = ( 2048* *(
§c
)

838 + 1228*–*(
§c
- 
§cZªs
) + *(src+ srcZres) )

839 - 262*–*(
§c
-3*
§cZªs
) + *(src+3*srcZres) )

840 + 47*–*(
§c
-5*
§cZªs
) + *(src+5*srcZres) )

841 + 11*–*(
§c
-7*
§cZªs
) + *(src+7*srcZres) )+2048) / 4096;

842 i‡(
ªsu…
 < 0)

843 
ªsu…
 = 0;

844 i‡(
ªsu…
 > 
pixMax
)

845 
ªsu…
 = 
pixMax
;

846 *
d°
 = (
uöt16
Ë
ªsu…
;

847 
d°
 +
d°Zªs
;

848 
§c
 +2*
§cZªs
;

851 
limô
 = 
§cXªs
 - (srcXres & 1);

852 ; 
x
 < 
limô
; x+=2)

854 
n1
 = (
x
 < 
§cXªs
-1) ? 1 : 0;

855 
n3
 = (
x
 < 
§cXªs
-3) ? 3 : (srcXres-1-x);

856 
n5
 = (
x
 < 
§cXªs
-5) ? 5 : (srcXres-1-x);

857 
n7
 = (
x
 < 
§cXªs
-7) ? 7 : (srcXres-1-x);

858 
ªsu…
 = ( 2048* *(
§c
)

859 + 1228*–*(
§c
- 
§cZªs
Ë+ *(§c+
n1
*srcZres) )

860 - 262*–*(
§c
-3*
§cZªs
Ë+ *(§c+
n3
*srcZres) )

861 + 47*–*(
§c
-5*
§cZªs
Ë+ *(§c+
n5
*srcZres) )

862 + 11*–*(
§c
-7*
§cZªs
Ë+ *(§c+
n7
*srcZres) )+2048) / 4096;

863 i‡(
ªsu…
 < 0)

864 
ªsu…
 = 0;

865 i‡(
ªsu…
 > 
pixMax
)

866 
ªsu…
 = 
pixMax
;

867 *
d°
 = (
uöt16
Ë
ªsu…
;

868 
d°
 +
d°Zªs
;

869 
§c
 +2*
§cZªs
;

872 
	}
}

882 
	$vîtiˇl_hÆf_1ch™
 (
uöt16
 *
§cPå
,

883 
xªs
,

884 
§cYªs
,

885 
§cZªs
,

886 
uöt16
 *
d°På
,

887 
d°Zªs
,

888 
pixMax


891 
x
, 
y
, 
limô
, 
n6
, 
n5
, 
n4
, 
n3
, 
n2
, 
n1
;

892 
ªsu…
;

894 
§cRowCou¡
 = 
xªs
 * 
§cZªs
;

895 
uöt16
 *
§c
 = 
§cPå
;

896 
uöt16
 *
d°
 = 
d°På
;

898 
y
=0; y < 6; y+=2)

900 
n1
 = (
y
 >= 1) ? 1 : y;

901 
n2
 = (
y
 >= 2) ? 2 : y;

902 
n3
 = (
y
 >= 3) ? 3 : y;

903 
n4
 = (
y
 >= 4) ? 4 : y;

905 
x
=0; x < 
xªs
; x++)

907 
ªsu…
 = (225*–*(
§c
 ) + *(§c+ 
§cRowCou¡
) )

908 +69*–*(
§c
-
n1
*
§cRowCou¡
) + *(src+2*srcRowCount) )

909 -30*–*(
§c
-
n2
*
§cRowCou¡
) + *(src+3*srcRowCount) )

910 -16*–*(
§c
-
n3
*
§cRowCou¡
) + *(src+4*srcRowCount) )

911 + 6*–*(
§c
-
n4
*
§cRowCou¡
) + *(src+5*srcRowCount) )

912 + 2*–*(
§c
- 
y
*
§cRowCou¡
) + *(src+6*srcRowCount) )+256) / 512;

913 i‡(
ªsu…
 < 0)

914 
ªsu…
 = 0;

915 i‡(
ªsu…
 > 
pixMax
)

916 
ªsu…
 = 
pixMax
;

917 *
d°
 = (
uöt16
Ë
ªsu…
;

918 
d°
 +
d°Zªs
;

919 
§c
 +
§cZªs
;

921 
§c
 +
§cRowCou¡
;

924 
limô
 = 
§cYªs
 - 6;

925 
y
=6; y < 
limô
; y+=2)

927 
x
=0; x < 
xªs
; x++)

929 
ªsu…
 = (225*–*(
§c
 ) + *(§c+ 
§cRowCou¡
) )

930 +69*–*(
§c
- 
§cRowCou¡
) + *(src+2*srcRowCount) )

931 -30*–*(
§c
-2*
§cRowCou¡
) + *(src+3*srcRowCount) )

932 -16*–*(
§c
-3*
§cRowCou¡
) + *(src+4*srcRowCount) )

933 + 6*–*(
§c
-4*
§cRowCou¡
) + *(src+5*srcRowCount) )

934 + 2*–*(
§c
-5*
§cRowCou¡
) + *(src+6*srcRowCount) )+256) / 512;

935 i‡(
ªsu…
 < 0)

936 
ªsu…
 = 0;

937 i‡(
ªsu…
 > 
pixMax
)

938 
ªsu…
 = 
pixMax
;

939 *
d°
 = (
uöt16
Ë
ªsu…
;

940 
d°
 +
d°Zªs
;

941 
§c
 +
§cZªs
;

943 
§c
 +
§cRowCou¡
;

946 
limô
 = 
§cYªs
 - (srcYres & 1);

947 ; 
y
 < 
limô
; y+=2)

949 
n1
 = (
y
 < 
§cYªs
-1) ? 1 : 0;

950 
n2
 = (
y
 < 
§cYªs
-2) ? 2 : (srcYres-1-y);

951 
n3
 = (
y
 < 
§cYªs
-3) ? 3 : (srcYres-1-y);

952 
n4
 = (
y
 < 
§cYªs
-4) ? 4 : (srcYres-1-y);

953 
n5
 = (
y
 < 
§cYªs
-5) ? 5 : (srcYres-1-y);

954 
n6
 = (
y
 < 
§cYªs
-6) ? 6 : (srcYres-1-y);

955 
x
=0; x < 
xªs
; x++)

957 
ªsu…
 = (225*–*(
§c
 ) + *(§c+
n1
*
§cRowCou¡
) )

958 +69*–*(
§c
- 
§cRowCou¡
Ë+ *(§c+
n2
*srcRowCount) )

959 -30*–*(
§c
-2*
§cRowCou¡
Ë+ *(§c+
n3
*srcRowCount) )

960 -16*–*(
§c
-3*
§cRowCou¡
Ë+ *(§c+
n4
*srcRowCount) )

961 + 6*–*(
§c
-4*
§cRowCou¡
Ë+ *(§c+
n5
*srcRowCount) )

962 + 2*–*(
§c
-5*
§cRowCou¡
Ë+ *(§c+
n6
*srcRowCount) )+256) / 512;

963 i‡(
ªsu…
 < 0)

964 
ªsu…
 = 0;

965 i‡(
ªsu…
 > 
pixMax
)

966 
ªsu…
 = 
pixMax
;

967 *
d°
 = (
uöt16
Ë
ªsu…
;

968 
d°
 +
d°Zªs
;

969 
§c
 +
§cZªs
;

971 
§c
 +
§cRowCou¡
;

973 
	}
}

994 
	$RódTIFFImage
 (
I≈utP¨amëîs
 *
p_I≈
, 
VideoD©aFûe
 *
öput_fûe
, 
FømeNoInFûe
, 
FømeF‹m©
 *
sour˚
, *
buf
)

996 
Tiff
 
t
;

997 
∑th
[
FILE_NAME_SIZE
];

998 
‰ameNumbîInFûe
, 
n
, 
nComp⁄íts
, 
height
, 
i
, 
width
, 
y
;

999 
RGB_YUV
 
rgb_yuv
;

1000 
uöt16


1001 *
img
, *
ãmp
 = 
NULL
, *
ãmp2
 = NULL,

1002 *
p
, *
yp
, *
up
, *
vp
;

1004 
	`as£π
–
p_I≈
);

1005 
	`as£π
–
öput_fûe
);

1006 
	`as£π
–
sour˚
);

1007 
	`as£π
–
buf
);

1009 
width
 = 
sour˚
->width[0];

1010 
height
 = 
sour˚
->height[0];

1011 
	`as£π
–(
width
 & 1Ë=0 && (
height
 & 1) == 0);

1013 i‡(
sour˚
->
cﬁ‹_modñ
 =
CM_RGB
 && !
öput_fûe
->
is_öãæóved
)

1015 
	`Ârötf
–
°dîr
, "ReadTIFFImage: RGB input file hasÇot been declaredás interleaved but only interleaved is supported\n");

1016 
Eº‹
;

1019 
‰ameNumbîInFûe
 = 
FømeNoInFûe
 + 
p_I≈
->
°¨t_‰ame
;

1020 i‡(
öput_fûe
->
num_digôs
 > 0)

1022 i‡(
öput_fûe
->
zîo_∑d
)

1024 
n
 = 
	`¢¥ötf
–
∑th
, ’©h), "%s%0*d%s", 
öput_fûe
->
fhód
, i≈ut_fûe->
num_digôs
, 
‰ameNumbîInFûe
, i≈ut_fûe->
·aû
);

1028 
n
 = 
	`¢¥ötf
–
∑th
, ’©h), "%s%*d%s", 
öput_fûe
->
fhód
, i≈ut_fûe->
num_digôs
, 
‰ameNumbîInFûe
, i≈ut_fûe->
·aû
);

1030 i‡(
n
 =
FILE_NAME_SIZE
 ||Ç == -1)

1032 
	`Ârötf
–
°dîr
, "ReadTIFFImage: fileÇame isÅooÜarge\n");

1038 
	`°r˝y
–
∑th
, 
öput_fûe
->
‚ame
);

1041 i‡(
	`ªadTiff
–&
t
, 
∑th
))

1043 
Eº‹
;

1046 i‡((Ë
t
.
ImageLígth
 !
height
)

1048 
	`Ârötf
–
°dîr
, "RódTIFFImage: Tif‡heighà(%uËdif„ª¡ fromÉncodî i≈uàheighà(%dË. Exôög...\n", 
t
.
ImageLígth
, 
height
);

1049 
Eº‹
;

1051 i‡((Ë
t
.
ImageWidth
 !
width
)

1053 
	`Ârötf
–
°dîr
, "RódTIFFImage: Tif‡width (%uËdif„ª¡ fromÉncodî i≈uàwidth (%dË. Exôög...\n", 
t
.
ImageWidth
, 
width
);

1054 
Eº‹
;

1057 i‡(
sour˚
->
pic_unô_size_⁄_disk
 != 8 && source->pic_unit_size_on_disk != 16) {

1058 
	`Ârötf
–
°dîr
, "RódTIFFImagê⁄ly suµ‹t†pic_unô_size_⁄_disk o‡8 o∏16ÇŸ %d\n", 
sour˚
->
pic_unô_size_⁄_disk
);

1059 
Eº‹
;

1064 
img
 = 
t
.img;

1065 
nComp⁄íts
 = 
width
 * 
height
 * 3;

1067 i‡(
sour˚
->
cﬁ‹_modñ
 =
CM_YUV
)

1069 i‡(
	`RGB_YUV_öôülize
–&
rgb_yuv
, (
VideoCode
Ë
p_I≈
->
videoCode
,Ö_I≈->
°dR™ge
, 65535))

1070 
Eº‹
;

1072 
	`RGB_YUV_rgb_to_yuv
–&
rgb_yuv
, 
img
, img+1, img+2, 
width
, 
height
, 3, img, img+1, img+2, 3);

1073 
sour˚
->
yuv_f‹m©
)

1075 
YUV420
:

1077 
nComp⁄íts
 = 
width
 * 
height
 * 3 / 2;

1078 
yp
 = 
ãmp
 = (
uöt16
 *Ë
	`mÆloc
–
nComp⁄íts
 * (uint16));

1079 
up
 = 
yp
 + 
width
 * 
height
;

1080 
vp
 = 
up
 + 
width
 * 
height
 / 4;

1082 
p
 = 
img
;

1083 
i
=0; i < 
width
*
height
; ++i)

1085 
yp
[
i
] = *
p
;Ö += 3;

1088 
ãmp2
 = (
uöt16
 *Ë
	`mÆloc
–
height
 * 
width
 * (uint16) / 2);

1090 
	`h‹iz⁄èl_hÆf_1ch™_cosôe
–
img
+1, 
width
, 
height
, 3, 
ãmp2
, 1, 65535);

1091 
	`vîtiˇl_hÆf_1ch™
–
ãmp2
, 
width
/2, 
height
, 1, 
up
, 1, 65535);

1093 
	`h‹iz⁄èl_hÆf_1ch™_cosôe
–
img
+2, 
width
, 
height
, 3, 
ãmp2
, 1, 65535);

1094 
	`vîtiˇl_hÆf_1ch™
–
ãmp2
, 
width
/2, 
height
, 1, 
vp
, 1, 65535);

1095 
	`‰ì_poöãr
(
ãmp2
);

1096 
img
 = 
yp
;

1098 
YUV422
:

1100 
nComp⁄íts
 = 
width
 * 
height
 * 2;

1101 
yp
 = 
ãmp
 = (
uöt16
 *Ë
	`mÆloc
–
nComp⁄íts
 * (uint16));

1102 
up
 = 
yp
 + 
width
*
height
;

1103 
vp
 = 
yp
 + 
width
*
height
/2;

1105 
p
 = 
img
;

1106 
i
=0; i < 
width
*
height
; ++i)

1108 
yp
[
i
] = *
p
;Ö += 3;

1111 
y
=0; y < 
height
; ++y) {

1112 
	`h‹iz⁄èl_hÆf_1ch™_cosôe
–
img
 + 1 + 
y
*
width
*3, width, 1, 3, 
up
 + y * width/2, 1, 65535);

1113 
	`h‹iz⁄èl_hÆf_1ch™_cosôe
–
img
 + 2 + 
y
*
width
*3, width, 1, 3, 
vp
 + y * width/2, 1, 65535);

1115 
img
 = 
yp
;

1117 
YUV444
:

1120 
	`Ârötf
–
°dîr
, "RódTIFFImage: Unsuµ‹ãd Cﬁ‹F‹m© (%d)\n", 
sour˚
->
yuv_f‹m©
);

1121 
Eº‹
;

1125 
sour˚
->
pic_unô_size_shi·3
)

1128 
i
=0; i < 
nComp⁄íts
; ++i)

1130 
buf
[
i
] = (
uöt8
)(
img
[i] >> 8);

1134 
i
=0; i < 
nComp⁄íts
; ++i)

1136 ((
uöt16
 *Ë
buf
)[
i
] = 
img
[i];

1140 
	`Ârötf
–
°dîr
, "RódTIFFImagê⁄ly suµ‹t†pic_unô_size_shi·3 o‡1 o∏2ÇŸ %d\n", 
sour˚
->
pic_unô_size_shi·3
);

1141 
Eº‹
;

1144 
	`‰ì_poöãr
(
ãmp
);

1147 
Eº‹
:

1149 
	`‰ì_poöãr
(
ãmp
);

1150 
	`ªp‹t_°©s_⁄_îr‹
();

1153 
	}
}

	@lcommon/src/mbuffer_common.c

18 
	~<limôs.h
>

20 
	~"globÆ.h
"

21 
	~"hódî.h
"

22 
	~"image.h
"

23 
	~"mbuf„r_comm⁄.h
"

24 
	~"mbuf„r.h
"

25 
	~"memÆloc.h
"

26 
	~"ouçut.h
"

27 
	~"Á°_mem‹y.h
"

28 
	~"öput.h
"

30 
unm¨k_l⁄g_ãrm_fõld_f‹_ª„ªn˚_by_‰ame_idx
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
Pi˘uªSåu˘uª
 
°ru˘uª
, 
l⁄g_ãrm_‰ame_idx
, 
m¨k_cuºít
, 
cuº_‰ame_num
, 
cuº_pic_num
);

37 
	$is_sh‹t_ãrm_ª„ªn˚
(
FømeSt‹e
* 
fs
)

40 i‡(
fs
->
is_u£d
==3)

42 i‡((
fs
->
‰ame
->
u£d_f‹_ª„ªn˚
)&&(!fs->‰ame->
is_l⁄g_ãrm
))

48 i‡(
fs
->
is_u£d
 & 1)

50 i‡(
fs
->
t›_fõld
)

52 i‡((
fs
->
t›_fõld
->
u£d_f‹_ª„ªn˚
)&&(!fs->t›_fõld->
is_l⁄g_ãrm
))

59 i‡(
fs
->
is_u£d
 & 2)

61 i‡(
fs
->
bŸtom_fõld
)

63 i‡((
fs
->
bŸtom_fõld
->
u£d_f‹_ª„ªn˚
)&&(!fs->bŸtom_fõld->
is_l⁄g_ãrm
))

70 
	}
}

79 
	$is_l⁄g_ãrm_ª„ªn˚
(
FømeSt‹e
* 
fs
)

82 i‡(
fs
->
is_u£d
==3)

84 i‡((
fs
->
‰ame
->
u£d_f‹_ª„ªn˚
)&&(fs->‰ame->
is_l⁄g_ãrm
))

90 i‡(
fs
->
is_u£d
 & 1)

92 i‡(
fs
->
t›_fõld
)

94 i‡((
fs
->
t›_fõld
->
u£d_f‹_ª„ªn˚
)&&(fs->t›_fõld->
is_l⁄g_ãrm
))

101 i‡(
fs
->
is_u£d
 & 2)

103 i‡(
fs
->
bŸtom_fõld
)

105 i‡((
fs
->
bŸtom_fõld
->
u£d_f‹_ª„ªn˚
)&&(fs->bŸtom_fõld->
is_l⁄g_ãrm
))

112 
	}
}

121 
	$gí_pic_li°_‰om_‰ame_li°
(
Pi˘uªSåu˘uª
 
cuºSåu˘uª
, 
FømeSt‹e
 **
fs_li°
, 
li°_idx
, 
St‹abÀPi˘uª
 **
li°
, *
li°_size
, 
l⁄g_ãrm
)

123 
t›_idx
 = 0;

124 
bŸ_idx
 = 0;

126 (*
is_ªf
)(
St‹abÀPi˘uª
 *
s
Ë(
l⁄g_ãrm
Ë? 
is_l⁄g_ªf
 : 
is_sh‹t_ªf
;

129 i‡(
cuºSåu˘uª
 =
TOP_FIELD
)

131 (
t›_idx
<
li°_idx
)||(
bŸ_idx
<list_idx))

133  ; 
t›_idx
<
li°_idx
;Åop_idx++)

135 if(
fs_li°
[
t›_idx
]->
is_u£d
 & 1)

137 if(
	`is_ªf
(
fs_li°
[
t›_idx
]->
t›_fõld
))

140 
li°
[(Ë*
li°_size
] = 
fs_li°
[
t›_idx
]->
t›_fõld
;

141 (*
li°_size
)++;

142 
t›_idx
++;

147  ; 
bŸ_idx
<
li°_idx
; bot_idx++)

149 if(
fs_li°
[
bŸ_idx
]->
is_u£d
 & 2)

151 if(
	`is_ªf
(
fs_li°
[
bŸ_idx
]->
bŸtom_fõld
))

154 
li°
[(Ë*
li°_size
] = 
fs_li°
[
bŸ_idx
]->
bŸtom_fõld
;

155 (*
li°_size
)++;

156 
bŸ_idx
++;

163 i‡(
cuºSåu˘uª
 =
BOTTOM_FIELD
)

165 (
t›_idx
<
li°_idx
)||(
bŸ_idx
<list_idx))

167  ; 
bŸ_idx
<
li°_idx
; bot_idx++)

169 if(
fs_li°
[
bŸ_idx
]->
is_u£d
 & 2)

171 if(
	`is_ªf
(
fs_li°
[
bŸ_idx
]->
bŸtom_fõld
))

174 
li°
[(Ë*
li°_size
] = 
fs_li°
[
bŸ_idx
]->
bŸtom_fõld
;

175 (*
li°_size
)++;

176 
bŸ_idx
++;

181  ; 
t›_idx
<
li°_idx
;Åop_idx++)

183 if(
fs_li°
[
t›_idx
]->
is_u£d
 & 1)

185 if(
	`is_ªf
(
fs_li°
[
t›_idx
]->
t›_fõld
))

188 
li°
[(Ë*
li°_size
] = 
fs_li°
[
t›_idx
]->
t›_fõld
;

189 (*
li°_size
)++;

190 
t›_idx
++;

197 
	}
}

206 
St‹abÀPi˘uª
* 
	$gë_l⁄g_ãrm_pic
(
Sli˚
 *
cuºSli˚
, 
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
L⁄gãrmPicNum
)

208 
uöt32
 
i
;

210 
i
=0; i<
p_Dpb
->
…ªf_‰ames_ö_buf„r
; i++)

212 i‡(
cuºSli˚
->
°ru˘uª
==
FRAME
)

214 i‡(
p_Dpb
->
fs_…ªf
[
i
]->
is_ª„ªn˚
 == 3)

215 i‡((
p_Dpb
->
fs_…ªf
[
i
]->
‰ame
->
is_l⁄g_ãrm
)&&’_Dpb->fs_…ªf[i]->‰ame->
l⁄g_ãrm_pic_num
 =
L⁄gãrmPicNum
))

216  
p_Dpb
->
fs_…ªf
[
i
]->
‰ame
;

220 i‡(
p_Dpb
->
fs_…ªf
[
i
]->
is_ª„ªn˚
 & 1)

221 i‡((
p_Dpb
->
fs_…ªf
[
i
]->
t›_fõld
->
is_l⁄g_ãrm
)&&’_Dpb->fs_…ªf[i]->t›_fõld->
l⁄g_ãrm_pic_num
 =
L⁄gãrmPicNum
))

222  
p_Dpb
->
fs_…ªf
[
i
]->
t›_fõld
;

223 i‡(
p_Dpb
->
fs_…ªf
[
i
]->
is_ª„ªn˚
 & 2)

224 i‡((
p_Dpb
->
fs_…ªf
[
i
]->
bŸtom_fõld
->
is_l⁄g_ãrm
)&&’_Dpb->fs_…ªf[i]->bŸtom_fõld->
l⁄g_ãrm_pic_num
 =
L⁄gãrmPicNum
))

225  
p_Dpb
->
fs_…ªf
[
i
]->
bŸtom_fõld
;

228  
NULL
;

229 
	}
}

238 
	$upd©e_ªf_li°
(
DecodedPi˘uªBuf„r
 *
p_Dpb
)

240 
i
, 
j
;

241 
i
=0, 
j
=0; i<
p_Dpb
->
u£d_size
; i++)

243 i‡(
	`is_sh‹t_ãrm_ª„ªn˚
(
p_Dpb
->
fs
[
i
]))

245 
p_Dpb
->
fs_ªf
[
j
++]ı_Dpb->
fs
[
i
];

249 
p_Dpb
->
ªf_‰ames_ö_buf„r
 = 
j
;

251 
j
<
p_Dpb
->
size
)

253 
p_Dpb
->
fs_ªf
[
j
++]=
NULL
;

255 
	}
}

267 
	$upd©e_…ªf_li°
(
DecodedPi˘uªBuf„r
 *
p_Dpb
)

269 
i
, 
j
;

270 
i
=0, 
j
=0; i<
p_Dpb
->
u£d_size
; i++)

272 i‡(
	`is_l⁄g_ãrm_ª„ªn˚
(
p_Dpb
->
fs
[
i
]))

274 
p_Dpb
->
fs_…ªf
[
j
++] =Ö_Dpb->
fs
[
i
];

278 
p_Dpb
->
…ªf_‰ames_ö_buf„r
 = 
j
;

280 
j
<
p_Dpb
->
size
)

282 
p_Dpb
->
fs_…ªf
[
j
++]=
NULL
;

284 
	}
}

292 
	$gë_pic_num_x
 (
St‹abÀPi˘uª
 *
p
, 
dif„ªn˚_of_pic_nums_möus1
)

294 
cuºPicNum
;

296 i‡(
p
->
°ru˘uª
 =
FRAME
)

297 
cuºPicNum
 = 
p
->
‰ame_num
;

299 
cuºPicNum
 = 2 * 
p
->
‰ame_num
 + 1;

301  
cuºPicNum
 - (
dif„ªn˚_of_pic_nums_möus1
 + 1);

302 
	}
}

310 
	$mm_unm¨k_sh‹t_ãrm_f‹_ª„ªn˚
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
St‹abÀPi˘uª
 *
p
, 
dif„ªn˚_of_pic_nums_möus1
)

312 
picNumX
;

314 
uöt32
 
i
;

316 
picNumX
 = 
	`gë_pic_num_x
(
p
, 
dif„ªn˚_of_pic_nums_möus1
);

318 
i
=0; i<
p_Dpb
->
ªf_‰ames_ö_buf„r
; i++)

320 i‡(
p
->
°ru˘uª
 =
FRAME
)

322 i‡((
p_Dpb
->
fs_ªf
[
i
]->
is_ª„ªn˚
==3Ë&& (p_Dpb->fs_ªf[i]->
is_l⁄g_ãrm
==0))

324 i‡(
p_Dpb
->
fs_ªf
[
i
]->
‰ame
->
pic_num
 =
picNumX
)

326 
	`unm¨k_f‹_ª„ªn˚
(
p_Dpb
->
fs_ªf
[
i
]);

333 i‡((
p_Dpb
->
fs_ªf
[
i
]->
is_ª„ªn˚
 & 1Ë&& (!’_Dpb->fs_ªf[i]->
is_l⁄g_ãrm
 & 1)))

335 i‡(
p_Dpb
->
fs_ªf
[
i
]->
t›_fõld
->
pic_num
 =
picNumX
)

337 
p_Dpb
->
fs_ªf
[
i
]->
t›_fõld
->
u£d_f‹_ª„ªn˚
 = 0;

338 
p_Dpb
->
fs_ªf
[
i
]->
is_ª„ªn˚
 &= 2;

339 i‡(
p_Dpb
->
fs_ªf
[
i
]->
is_u£d
 == 3)

341 
p_Dpb
->
fs_ªf
[
i
]->
‰ame
->
u£d_f‹_ª„ªn˚
 = 0;

346 i‡((
p_Dpb
->
fs_ªf
[
i
]->
is_ª„ªn˚
 & 2Ë&& (!’_Dpb->fs_ªf[i]->
is_l⁄g_ãrm
 & 2)))

348 i‡(
p_Dpb
->
fs_ªf
[
i
]->
bŸtom_fõld
->
pic_num
 =
picNumX
)

350 
p_Dpb
->
fs_ªf
[
i
]->
bŸtom_fõld
->
u£d_f‹_ª„ªn˚
 = 0;

351 
p_Dpb
->
fs_ªf
[
i
]->
is_ª„ªn˚
 &= 1;

352 i‡(
p_Dpb
->
fs_ªf
[
i
]->
is_u£d
 == 3)

354 
p_Dpb
->
fs_ªf
[
i
]->
‰ame
->
u£d_f‹_ª„ªn˚
 = 0;

361 
	}
}

370 
	$mm_unm¨k_l⁄g_ãrm_f‹_ª„ªn˚
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
St‹abÀPi˘uª
 *
p
, 
l⁄g_ãrm_pic_num
)

372 
uöt32
 
i
;

373 
i
=0; i<
p_Dpb
->
…ªf_‰ames_ö_buf„r
; i++)

375 i‡(
p
->
°ru˘uª
 =
FRAME
)

377 i‡((
p_Dpb
->
fs_…ªf
[
i
]->
is_ª„ªn˚
==3Ë&& (p_Dpb->fs_…ªf[i]->
is_l⁄g_ãrm
==3))

379 i‡(
p_Dpb
->
fs_…ªf
[
i
]->
‰ame
->
l⁄g_ãrm_pic_num
 ==Üong_term_pic_num)

381 
	`unm¨k_f‹_l⁄g_ãrm_ª„ªn˚
(
p_Dpb
->
fs_…ªf
[
i
]);

387 i‡((
p_Dpb
->
fs_…ªf
[
i
]->
is_ª„ªn˚
 & 1Ë&& (’_Dpb->fs_…ªf[i]->
is_l⁄g_ãrm
 & 1)))

389 i‡(
p_Dpb
->
fs_…ªf
[
i
]->
t›_fõld
->
l⁄g_ãrm_pic_num
 ==Üong_term_pic_num)

391 
p_Dpb
->
fs_…ªf
[
i
]->
t›_fõld
->
u£d_f‹_ª„ªn˚
 = 0;

392 
p_Dpb
->
fs_…ªf
[
i
]->
t›_fõld
->
is_l⁄g_ãrm
 = 0;

393 
p_Dpb
->
fs_…ªf
[
i
]->
is_ª„ªn˚
 &= 2;

394 
p_Dpb
->
fs_…ªf
[
i
]->
is_l⁄g_ãrm
 &= 2;

395 i‡(
p_Dpb
->
fs_…ªf
[
i
]->
is_u£d
 == 3)

397 
p_Dpb
->
fs_…ªf
[
i
]->
‰ame
->
u£d_f‹_ª„ªn˚
 = 0;

398 
p_Dpb
->
fs_…ªf
[
i
]->
‰ame
->
is_l⁄g_ãrm
 = 0;

403 i‡((
p_Dpb
->
fs_…ªf
[
i
]->
is_ª„ªn˚
 & 2Ë&& (’_Dpb->fs_…ªf[i]->
is_l⁄g_ãrm
 & 2)))

405 i‡(
p_Dpb
->
fs_…ªf
[
i
]->
bŸtom_fõld
->
l⁄g_ãrm_pic_num
 ==Üong_term_pic_num)

407 
p_Dpb
->
fs_…ªf
[
i
]->
bŸtom_fõld
->
u£d_f‹_ª„ªn˚
 = 0;

408 
p_Dpb
->
fs_…ªf
[
i
]->
bŸtom_fõld
->
is_l⁄g_ãrm
 = 0;

409 
p_Dpb
->
fs_…ªf
[
i
]->
is_ª„ªn˚
 &= 1;

410 
p_Dpb
->
fs_…ªf
[
i
]->
is_l⁄g_ãrm
 &= 1;

411 i‡(
p_Dpb
->
fs_…ªf
[
i
]->
is_u£d
 == 3)

413 
p_Dpb
->
fs_…ªf
[
i
]->
‰ame
->
u£d_f‹_ª„ªn˚
 = 0;

414 
p_Dpb
->
fs_…ªf
[
i
]->
‰ame
->
is_l⁄g_ãrm
 = 0;

421 
	}
}

430 
	$unm¨k_l⁄g_ãrm_‰ame_f‹_ª„ªn˚_by_‰ame_idx
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
l⁄g_ãrm_‰ame_idx
)

432 
uöt32
 
i
;

433 
i
=0; i<
p_Dpb
->
…ªf_‰ames_ö_buf„r
; i++)

435 i‡(
p_Dpb
->
fs_…ªf
[
i
]->
l⁄g_ãrm_‰ame_idx
 ==Üong_term_frame_idx)

436 
	`unm¨k_f‹_l⁄g_ãrm_ª„ªn˚
(
p_Dpb
->
fs_…ªf
[
i
]);

438 
	}
}

448 
	$m¨k_pic_l⁄g_ãrm
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
St‹abÀPi˘uª
* 
p
, 
l⁄g_ãrm_‰ame_idx
, 
picNumX
)

450 
uöt32
 
i
;

451 
add_t›
, 
add_bŸtom
;

453 i‡(
p
->
°ru˘uª
 =
FRAME
)

455 
i
=0; i<
p_Dpb
->
ªf_‰ames_ö_buf„r
; i++)

457 i‡(
p_Dpb
->
fs_ªf
[
i
]->
is_ª„ªn˚
 == 3)

459 i‡((!
p_Dpb
->
fs_ªf
[
i
]->
‰ame
->
is_l⁄g_ãrm
)&&’_Dpb->fs_ªf[i]->‰ame->
pic_num
 =
picNumX
))

461 
p_Dpb
->
fs_ªf
[
i
]->
l⁄g_ãrm_‰ame_idx
 =Ö_Dpb->fs_ªf[i]->
‰ame
->long_term_frame_idx

462 
l⁄g_ãrm_‰ame_idx
;

463 
p_Dpb
->
fs_ªf
[
i
]->
‰ame
->
l⁄g_ãrm_pic_num
 = 
l⁄g_ãrm_‰ame_idx
;

464 
p_Dpb
->
fs_ªf
[
i
]->
‰ame
->
is_l⁄g_ãrm
 = 1;

466 i‡(
p_Dpb
->
fs_ªf
[
i
]->
t›_fõld
 &&Ö_Dpb->fs_ªf[i]->
bŸtom_fõld
)

468 
p_Dpb
->
fs_ªf
[
i
]->
t›_fõld
->
l⁄g_ãrm_‰ame_idx
 =Ö_Dpb->fs_ªf[i]->
bŸtom_fõld
->long_term_frame_idx

469 
l⁄g_ãrm_‰ame_idx
;

470 
p_Dpb
->
fs_ªf
[
i
]->
t›_fõld
->
l⁄g_ãrm_pic_num
 = 
l⁄g_ãrm_‰ame_idx
;

471 
p_Dpb
->
fs_ªf
[
i
]->
bŸtom_fõld
->
l⁄g_ãrm_pic_num
 = 
l⁄g_ãrm_‰ame_idx
;

473 
p_Dpb
->
fs_ªf
[
i
]->
t›_fõld
->
is_l⁄g_ãrm
 =Ö_Dpb->fs_ªf[i]->
bŸtom_fõld
->is_long_term

477 
p_Dpb
->
fs_ªf
[
i
]->
is_l⁄g_ãrm
 = 3;

482 
	`¥ötf
 ("Warning:Ñeference frame forÜongÅerm markingÇot found\n");

486 i‡(
p
->
°ru˘uª
 =
TOP_FIELD
)

488 
add_t›
 = 1;

489 
add_bŸtom
 = 0;

493 
add_t›
 = 0;

494 
add_bŸtom
 = 1;

496 
i
=0; i<
p_Dpb
->
ªf_‰ames_ö_buf„r
; i++)

498 i‡(
p_Dpb
->
fs_ªf
[
i
]->
is_ª„ªn˚
 & 1)

500 i‡((!
p_Dpb
->
fs_ªf
[
i
]->
t›_fõld
->
is_l⁄g_ãrm
)&&’_Dpb->fs_ªf[i]->t›_fõld->
pic_num
 =
picNumX
))

502 i‡((
p_Dpb
->
fs_ªf
[
i
]->
is_l⁄g_ãrm
Ë&& (p_Dpb->fs_ªf[i]->
l⁄g_ãrm_‰ame_idx
 !=Üong_term_frame_idx))

504 
	`¥ötf
 ("Warning:ássigningÜong_term_frame_idx different from other field\n");

507 
p_Dpb
->
fs_ªf
[
i
]->
l⁄g_ãrm_‰ame_idx
 =Ö_Dpb->fs_ªf[i]->
t›_fõld
->long_term_frame_idx

508 
l⁄g_ãrm_‰ame_idx
;

509 
p_Dpb
->
fs_ªf
[
i
]->
t›_fõld
->
l⁄g_ãrm_pic_num
 = 2 * 
l⁄g_ãrm_‰ame_idx
 + 
add_t›
;

510 
p_Dpb
->
fs_ªf
[
i
]->
t›_fõld
->
is_l⁄g_ãrm
 = 1;

511 
p_Dpb
->
fs_ªf
[
i
]->
is_l⁄g_ãrm
 |= 1;

512 i‡(
p_Dpb
->
fs_ªf
[
i
]->
is_l⁄g_ãrm
 == 3)

514 
p_Dpb
->
fs_ªf
[
i
]->
‰ame
->
is_l⁄g_ãrm
 = 1;

515 
p_Dpb
->
fs_ªf
[
i
]->
‰ame
->
l⁄g_ãrm_‰ame_idx
 =Ö_Dpb->fs_ªf[i]->‰ame->
l⁄g_ãrm_pic_num
 =Üong_term_frame_idx;

520 i‡(
p_Dpb
->
fs_ªf
[
i
]->
is_ª„ªn˚
 & 2)

522 i‡((!
p_Dpb
->
fs_ªf
[
i
]->
bŸtom_fõld
->
is_l⁄g_ãrm
)&&’_Dpb->fs_ªf[i]->bŸtom_fõld->
pic_num
 =
picNumX
))

524 i‡((
p_Dpb
->
fs_ªf
[
i
]->
is_l⁄g_ãrm
Ë&& (p_Dpb->fs_ªf[i]->
l⁄g_ãrm_‰ame_idx
 !=Üong_term_frame_idx))

526 
	`¥ötf
 ("Warning:ássigningÜong_term_frame_idx different from other field\n");

529 
p_Dpb
->
fs_ªf
[
i
]->
l⁄g_ãrm_‰ame_idx
 =Ö_Dpb->fs_ªf[i]->
bŸtom_fõld
->long_term_frame_idx

530 
l⁄g_ãrm_‰ame_idx
;

531 
p_Dpb
->
fs_ªf
[
i
]->
bŸtom_fõld
->
l⁄g_ãrm_pic_num
 = 2 * 
l⁄g_ãrm_‰ame_idx
 + 
add_bŸtom
;

532 
p_Dpb
->
fs_ªf
[
i
]->
bŸtom_fõld
->
is_l⁄g_ãrm
 = 1;

533 
p_Dpb
->
fs_ªf
[
i
]->
is_l⁄g_ãrm
 |= 2;

534 i‡(
p_Dpb
->
fs_ªf
[
i
]->
is_l⁄g_ãrm
 == 3)

536 
p_Dpb
->
fs_ªf
[
i
]->
‰ame
->
is_l⁄g_ãrm
 = 1;

537 
p_Dpb
->
fs_ªf
[
i
]->
‰ame
->
l⁄g_ãrm_‰ame_idx
 =Ö_Dpb->fs_ªf[i]->‰ame->
l⁄g_ãrm_pic_num
 =Üong_term_frame_idx;

543 
	`¥ötf
 ("Warning:Ñeference field forÜongÅerm markingÇot found\n");

545 
	}
}

554 
	$mm_assign_l⁄g_ãrm_‰ame_idx
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
St‹abÀPi˘uª
* 
p
, 
dif„ªn˚_of_pic_nums_möus1
, 
l⁄g_ãrm_‰ame_idx
)

556 
picNumX
 = 
	`gë_pic_num_x
(
p
, 
dif„ªn˚_of_pic_nums_möus1
);

559 i‡(
p
->
°ru˘uª
 =
FRAME
)

561 
	`unm¨k_l⁄g_ãrm_‰ame_f‹_ª„ªn˚_by_‰ame_idx
(
p_Dpb
, 
l⁄g_ãrm_‰ame_idx
);

565 
i
;

566 
Pi˘uªSåu˘uª
 
°ru˘uª
 = 
FRAME
;

568 
i
=0; i<
p_Dpb
->
ªf_‰ames_ö_buf„r
; i++)

570 i‡(
p_Dpb
->
fs_ªf
[
i
]->
is_ª„ªn˚
 & 1)

572 i‡(
p_Dpb
->
fs_ªf
[
i
]->
t›_fõld
->
pic_num
 =
picNumX
)

574 
°ru˘uª
 = 
TOP_FIELD
;

578 i‡(
p_Dpb
->
fs_ªf
[
i
]->
is_ª„ªn˚
 & 2)

580 i‡(
p_Dpb
->
fs_ªf
[
i
]->
bŸtom_fõld
->
pic_num
 =
picNumX
)

582 
°ru˘uª
 = 
BOTTOM_FIELD
;

587 i‡(
°ru˘uª
==
FRAME
)

589 
	`îr‹
 ("field forÜongÅerm markingÇot found",200);

592 
	`unm¨k_l⁄g_ãrm_fõld_f‹_ª„ªn˚_by_‰ame_idx
(
p_Dpb
, 
°ru˘uª
, 
l⁄g_ãrm_‰ame_idx
, 0, 0, 
picNumX
);

595 
	`m¨k_pic_l⁄g_ãrm
(
p_Dpb
, 
p
, 
l⁄g_ãrm_‰ame_idx
, 
picNumX
);

596 
	}
}

604 
	$mm_upd©e_max_l⁄g_ãrm_‰ame_idx
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
max_l⁄g_ãrm_‰ame_idx_∂us1
)

606 
uöt32
 
i
;

608 
p_Dpb
->
max_l⁄g_ãrm_pic_idx
 = 
max_l⁄g_ãrm_‰ame_idx_∂us1
 - 1;

611 
i
=0; i<
p_Dpb
->
…ªf_‰ames_ö_buf„r
; i++)

613 i‡(
p_Dpb
->
fs_…ªf
[
i
]->
l⁄g_ãrm_‰ame_idx
 >Ö_Dpb->
max_l⁄g_ãrm_pic_idx
)

615 
	`unm¨k_f‹_l⁄g_ãrm_ª„ªn˚
(
p_Dpb
->
fs_…ªf
[
i
]);

618 
	}
}

627 
	$mm_unm¨k_Æl_l⁄g_ãrm_f‹_ª„ªn˚
 (
DecodedPi˘uªBuf„r
 *
p_Dpb
)

629 
	`mm_upd©e_max_l⁄g_ãrm_‰ame_idx
(
p_Dpb
, 0);

630 
	}
}

638 
	$mm_unm¨k_Æl_sh‹t_ãrm_f‹_ª„ªn˚
 (
DecodedPi˘uªBuf„r
 *
p_Dpb
)

640 
i
;

641 
i
=0; i<
p_Dpb
->
ªf_‰ames_ö_buf„r
; i++)

643 
	`unm¨k_f‹_ª„ªn˚
(
p_Dpb
->
fs_ªf
[
i
]);

645 
	`upd©e_ªf_li°
(
p_Dpb
);

646 
	}
}

655 
	$mm_m¨k_cuºít_pi˘uª_l⁄g_ãrm
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
St‹abÀPi˘uª
 *
p
, 
l⁄g_ãrm_‰ame_idx
)

658 i‡(
p
->
°ru˘uª
 =
FRAME
)

660 
	`unm¨k_l⁄g_ãrm_‰ame_f‹_ª„ªn˚_by_‰ame_idx
(
p_Dpb
, 
l⁄g_ãrm_‰ame_idx
);

664 
	`unm¨k_l⁄g_ãrm_fõld_f‹_ª„ªn˚_by_‰ame_idx
(
p_Dpb
, 
p
->
°ru˘uª
, 
l⁄g_ãrm_‰ame_idx
, 1,Ö->
pic_num
, 0);

667 
p
->
is_l⁄g_ãrm
 = 1;

668 
p
->
l⁄g_ãrm_‰ame_idx
 =Üong_term_frame_idx;

669 
	}
}

678 
	$is_u£d_f‹_ª„ªn˚
(
FømeSt‹e
* 
fs
)

680 i‡(
fs
->
is_ª„ªn˚
)

685 i‡(
fs
->
is_u£d
 == 3)

687 i‡(
fs
->
‰ame
->
u£d_f‹_ª„ªn˚
)

693 i‡(
fs
->
is_u£d
 & 1)

695 i‡(
fs
->
t›_fõld
)

697 i‡(
fs
->
t›_fõld
->
u£d_f‹_ª„ªn˚
)

704 i‡(
fs
->
is_u£d
 & 2)

706 i‡(
fs
->
bŸtom_fõld
)

708 i‡(
fs
->
bŸtom_fõld
->
u£d_f‹_ª„ªn˚
)

715 
	}
}

723 
	$gë_smÆÀ°_poc
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, *
poc
,* 
pos
)

725 
uöt32
 
i
;

727 i‡(
p_Dpb
->
u£d_size
<1)

729 
	`îr‹
("Cannot determine smallest POC, DPBÉmpty.",150);

732 *
pos
=-1;

733 *
poc
 = 
INT_MAX
;

734 
i
 = 0; i < 
p_Dpb
->
u£d_size
; i++)

736 i‡((*
poc
 > 
p_Dpb
->
fs
[
i
]->poc)&&(!p_Dpb->fs[i]->
is_ouçut
))

738 *
poc
 = 
p_Dpb
->
fs
[
i
]->poc;

739 *
pos
 = 
i
;

742 
	}
}

750 
	$ªmove_unu£d_‰ame_‰om_dpb
(
DecodedPi˘uªBuf„r
 *
p_Dpb
)

752 
uöt32
 
i
;

755 
i
 = 0; i < 
p_Dpb
->
u£d_size
; i++)

757 i‡(
p_Dpb
->
fs
[
i
]->
is_ouçut
 && (!
	`is_u£d_f‹_ª„ªn˚
(p_Dpb->fs[i])))

759 
	`ªmove_‰ame_‰om_dpb
(
p_Dpb
, 
i
);

764 
	}
}

773 
	$unm¨k_l⁄g_ãrm_fõld_f‹_ª„ªn˚_by_‰ame_idx
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
Pi˘uªSåu˘uª
 
°ru˘uª
, 
l⁄g_ãrm_‰ame_idx
, 
m¨k_cuºít
, 
cuº_‰ame_num
, 
cuº_pic_num
)

775 
VideoP¨amëîs
 *
p_Vid
 = 
p_Dpb
->p_Vid;

776 
i
;

778 
	`as£π
(
°ru˘uª
!=
FRAME
);

779 i‡(
cuº_pic_num
<0)

780 
cuº_pic_num
 +(2 * 
p_Vid
->
max_‰ame_num
);

782 
i
=0; i<
p_Dpb
->
…ªf_‰ames_ö_buf„r
; i++)

784 i‡(
p_Dpb
->
fs_…ªf
[
i
]->
l⁄g_ãrm_‰ame_idx
 ==Üong_term_frame_idx)

786 i‡(
°ru˘uª
 =
TOP_FIELD
)

788 i‡(
p_Dpb
->
fs_…ªf
[
i
]->
is_l⁄g_ãrm
 == 3)

790 
	`unm¨k_f‹_l⁄g_ãrm_ª„ªn˚
(
p_Dpb
->
fs_…ªf
[
i
]);

794 i‡(
p_Dpb
->
fs_…ªf
[
i
]->
is_l⁄g_ãrm
 == 1)

796 
	`unm¨k_f‹_l⁄g_ãrm_ª„ªn˚
(
p_Dpb
->
fs_…ªf
[
i
]);

800 i‡(
m¨k_cuºít
)

802 i‡(
p_Dpb
->
œ°_pi˘uª
)

804 i‡––
p_Dpb
->
œ°_pi˘uª
 !p_Dpb->
fs_…ªf
[
i
] )||Ö_Dpb->œ°_pi˘uª->
‰ame_num
 !
cuº_‰ame_num
)

805 
	`unm¨k_f‹_l⁄g_ãrm_ª„ªn˚
(
p_Dpb
->
fs_…ªf
[
i
]);

809 
	`unm¨k_f‹_l⁄g_ãrm_ª„ªn˚
(
p_Dpb
->
fs_…ªf
[
i
]);

814 i‡((
p_Dpb
->
fs_…ªf
[
i
]->
‰ame_num
Ë!()(
cuº_pic_num
 >> 1))

816 
	`unm¨k_f‹_l⁄g_ãrm_ª„ªn˚
(
p_Dpb
->
fs_…ªf
[
i
]);

822 i‡(
°ru˘uª
 =
BOTTOM_FIELD
)

824 i‡(
p_Dpb
->
fs_…ªf
[
i
]->
is_l⁄g_ãrm
 == 3)

826 
	`unm¨k_f‹_l⁄g_ãrm_ª„ªn˚
(
p_Dpb
->
fs_…ªf
[
i
]);

830 i‡(
p_Dpb
->
fs_…ªf
[
i
]->
is_l⁄g_ãrm
 == 2)

832 
	`unm¨k_f‹_l⁄g_ãrm_ª„ªn˚
(
p_Dpb
->
fs_…ªf
[
i
]);

836 i‡(
m¨k_cuºít
)

838 i‡(
p_Dpb
->
œ°_pi˘uª
)

840 i‡––
p_Dpb
->
œ°_pi˘uª
 !p_Dpb->
fs_…ªf
[
i
] )||Ö_Dpb->œ°_pi˘uª->
‰ame_num
 !
cuº_‰ame_num
)

841 
	`unm¨k_f‹_l⁄g_ãrm_ª„ªn˚
(
p_Dpb
->
fs_…ªf
[
i
]);

845 
	`unm¨k_f‹_l⁄g_ãrm_ª„ªn˚
(
p_Dpb
->
fs_…ªf
[
i
]);

850 i‡((
p_Dpb
->
fs_…ªf
[
i
]->
‰ame_num
Ë!()(
cuº_pic_num
 >> 1))

852 
	`unm¨k_f‹_l⁄g_ãrm_ª„ªn˚
(
p_Dpb
->
fs_…ªf
[
i
]);

860 
	}
}

	@lcommon/src/memalloc.c

18 
	~"globÆ.h
"

19 
	~"memÆloc.h
"

30 
	$öô_t›_bŸ_∂™es
(
img≥l
 **
imgFøme
, 
dim0
, img≥»***
imgT›Fõld
, img≥»***
imgBŸFõld
)

32 
i
;

34 if((*
imgT›Fõld
 = (
img≥l
**)
	`mem_mÆloc
((
dim0
>>1Ë* (img≥l*))Ë=
NULL
)

35 
	`no_mem_exô
("init_top_bot_planes: imgTopField");

37 if((*
imgBŸFõld
 = (
img≥l
**)
	`mem_mÆloc
((
dim0
>>1Ë* (img≥l*))Ë=
NULL
)

38 
	`no_mem_exô
("init_top_bot_planes: imgBotField");

40 
i
 = 0; i < (
dim0
>>1); i++)

42 (*
imgT›Fõld
)[
i
] = 
imgFøme
[2 * i ];

43 (*
imgBŸFõld
)[
i
] = 
imgFøme
[2 * i + 1];

46  
dim0
 * (
img≥l
*);

47 
	}
}

57 
	$‰ì_t›_bŸ_∂™es
(
img≥l
 **
imgT›Fõld
, img≥»**
imgBŸFõld
)

59 
	`mem_‰ì
 (
imgT›Fõld
);

60 
	`mem_‰ì
 (
imgBŸFõld
);

61 
	}
}

72 
	$gë_mem2Ddi°
(
Di°‹ti⁄D©a
 ***
¨øy2D
, 
dim0
, 
dim1
)

74 
i
;

76 if((*
¨øy2D
 = (
Di°‹ti⁄D©a
**)
	`mem_mÆloc
(
dim0
 * (Di°‹ti⁄D©a*))Ë=
NULL
)

77 
	`no_mem_exô
("get_mem2Ddist:árray2D");

78 if((*(*
¨øy2D
Ë(
Di°‹ti⁄D©a
* )
	`mem_ˇŒoc
(
dim0
 * 
dim1
,(Di°‹ti⁄D©®))Ë=
NULL
)

79 
	`no_mem_exô
("get_mem2Ddist:árray2D");

81 
i
 = 1 ; i < 
dim0
; i++)

82 (*
¨øy2D
)[
i
] = (*¨øy2D)[i-1] + 
dim1
;

84  
dim0
 * ((
Di°‹ti⁄D©a
*Ë+ 
dim1
 * (DistortionData));

85 
	}
}

95 
	$gë_mem2Dlm
(
LambdaP¨ams
 ***
¨øy2D
, 
dim0
, 
dim1
)

97 
i
;

99 if((*
¨øy2D
 = (
LambdaP¨ams
**)
	`mem_mÆloc
(
dim0
 * (LambdaP¨ams*))Ë=
NULL
)

100 
	`no_mem_exô
("get_mem2Dlm:árray2D");

101 if((*(*
¨øy2D
Ë(
LambdaP¨ams
* )
	`mem_ˇŒoc
(
dim0
 * 
dim1
,(LambdaP¨am†))Ë=
NULL
)

102 
	`no_mem_exô
("get_mem2Dlm:árray2D");

104 
i
 = 1 ; i < 
dim0
; i++)

105 (*
¨øy2D
)[
i
] = (*¨øy2D)[i-1] + 
dim1
;

107  
dim0
 * ((
LambdaP¨ams
*Ë+ 
dim1
 * (LambdaParams));

108 
	}
}

117 
	$‰ì_mem2Ddi°
(
Di°‹ti⁄D©a
 **
¨øy2D
)

119 i‡(
¨øy2D
)

121 i‡(*
¨øy2D
)

122 
	`mem_‰ì
 (*
¨øy2D
);

124 
	`îr‹
 ("free_mem2Ddist:ÅryingÅo free unused memory",100);

126 
	`mem_‰ì
 (
¨øy2D
);

130 
	`îr‹
 ("free_mem2Ddist:ÅryingÅo free unused memory",100);

132 
	}
}

141 
	$‰ì_mem2Dlm
(
LambdaP¨ams
 **
¨øy2D
)

143 i‡(
¨øy2D
)

145 i‡(*
¨øy2D
)

146 
	`mem_‰ì
 (*
¨øy2D
);

148 
	`îr‹
 ("free_mem2Dlm:ÅryingÅo free unused memory",100);

150 
	`mem_‰ì
 (
¨øy2D
);

154 
	`îr‹
 ("free_mem2Dlm:ÅryingÅo free unused memory",100);

156 
	}
}

166 
	$gë_mem2Dmp
(
PicMŸi⁄P¨ams
 ***
¨øy2D
, 
dim0
, 
dim1
)

168 
i
;

170 if((*
¨øy2D
 = (
PicMŸi⁄P¨ams
**)
	`mem_mÆloc
(
dim0
 * (PicMŸi⁄P¨ams*))Ë=
NULL
)

171 
	`no_mem_exô
("get_mem2Dmp:árray2D");

172 if((*(*
¨øy2D
Ë(
PicMŸi⁄P¨ams
* )
	`mem_ˇŒoc
(
dim0
 * 
dim1
, (PicMŸi⁄P¨am†))Ë=
NULL
)

173 
	`no_mem_exô
("get_mem2Dmp:árray2D");

175 
i
 = 1 ; i < 
dim0
; i++)

176 (*
¨øy2D
)[
i
] = (*¨øy2D)[i-1] + 
dim1
;

178  
dim0
 * ((
PicMŸi⁄P¨ams
*Ë+ 
dim1
 * (PicMotionParams));

179 
	}
}

190 
	$gë_mem3Dmp
(
PicMŸi⁄P¨ams
 ****
¨øy3D
, 
dim0
, 
dim1
, 
dim2
)

192 
i
, 
mem_size
 = 
dim0
 * (
PicMŸi⁄P¨ams
**);

194 if(((*
¨øy3D
Ë(
PicMŸi⁄P¨ams
***)
	`mem_mÆloc
(
dim0
 * (PicMŸi⁄P¨ams**))Ë=
NULL
)

195 
	`no_mem_exô
("get_mem3Dmp:árray3D");

197 
mem_size
 +
	`gë_mem2Dmp
(*
¨øy3D
, 
dim0
 * 
dim1
, 
dim2
);

199 
i
 = 1; i < 
dim0
; i++)

200 (*
¨øy3D
)[
i
] = (*¨øy3D)[ò- 1] + 
dim1
;

202  
mem_size
;

203 
	}
}

212 
	$‰ì_mem2Dmp
(
PicMŸi⁄P¨ams
 **
¨øy2D
)

214 i‡(
¨øy2D
)

216 i‡(*
¨øy2D
)

217 
	`mem_‰ì
 (*
¨øy2D
);

219 
	`îr‹
 ("free_mem2Dmp:ÅryingÅo free unused memory",100);

221 
	`mem_‰ì
 (
¨øy2D
);

225 
	`îr‹
 ("free_mem2Dmp:ÅryingÅo free unused memory",100);

227 
	}
}

236 
	$‰ì_mem3Dmp
(
PicMŸi⁄P¨ams
 ***
¨øy3D
)

238 i‡(
¨øy3D
)

240 
	`‰ì_mem2Dmp
(*
¨øy3D
);

241 
	`mem_‰ì
 (
¨øy3D
);

245 
	`îr‹
 ("free_mem3Dmp:ÅryingÅo free unused memory",100);

247 
	}
}

257 
	$gë_mem2Dqu™t
(
LevñQu™tP¨ams
 ***
¨øy2D
, 
dim0
, 
dim1
)

259 
i
;

261 if((*
¨øy2D
 = (
LevñQu™tP¨ams
**Ë
	`mem_mÆloc
(
dim0
 * (LevñQu™tP¨ams*))Ë=
NULL
)

262 
	`no_mem_exô
("get_mem2Dquant:árray2D");

263 if((*(*
¨øy2D
Ë(
LevñQu™tP¨ams
* ) 
	`mem_ˇŒoc
(
dim0
 * 
dim1
,(LevñQu™tP¨am†))Ë=
NULL
)

264 
	`no_mem_exô
("get_mem2Dquant:árray2D");

266 
i
 = 1 ; i < 
dim0
; i++)

267 (*
¨øy2D
)[
i
] = (*¨øy2D)[i-1] + 
dim1
;

269  
dim0
 * ((
LevñQu™tP¨ams
*Ë+ 
dim1
 * (LevelQuantParams));

270 
	}
}

281 
	$gë_mem3Dqu™t
(
LevñQu™tP¨ams
 ****
¨øy3D
, 
dim0
, 
dim1
, 
dim2
)

283 
i
, 
mem_size
 = 
dim0
 * (
LevñQu™tP¨ams
**);

285 if(((*
¨øy3D
Ë(
LevñQu™tP¨ams
***)
	`mem_mÆloc
(
dim0
 * (LevñQu™tP¨ams**))Ë=
NULL
)

286 
	`no_mem_exô
("get_mem3Dquant:árray3D");

288 
mem_size
 +
	`gë_mem2Dqu™t
(*
¨øy3D
, 
dim0
 * 
dim1
, 
dim2
);

290 
i
 = 1; i < 
dim0
; i++)

291 (*
¨øy3D
)[
i
] = (*¨øy3D)[ò- 1] + 
dim1
;

293  
mem_size
;

294 
	}
}

305 
	$gë_mem4Dqu™t
(
LevñQu™tP¨ams
 *****
¨øy4D
, 
dim0
, 
dim1
, 
dim2
, 
dim3
)

307 
i
, 
mem_size
 = 
dim0
 * (
LevñQu™tP¨ams
***);

309 if(((*
¨øy4D
Ë(
LevñQu™tP¨ams
****)
	`mem_mÆloc
(
dim0
 * (LevñQu™tP¨ams***))Ë=
NULL
)

310 
	`no_mem_exô
("get_mem4Dquant:árray4D");

312 
mem_size
 +
	`gë_mem3Dqu™t
(*
¨øy4D
, 
dim0
 * 
dim1
, 
dim2
, 
dim3
);

314 
i
 = 1; i < 
dim0
; i++)

315 (*
¨øy4D
)[
i
] = (*¨øy4D)[ò- 1] + 
dim1
;

317  
mem_size
;

318 
	}
}

329 
	$gë_mem5Dqu™t
(
LevñQu™tP¨ams
 ******
¨øy5D
, 
dim0
, 
dim1
, 
dim2
, 
dim3
, 
dim4
)

331 
i
, 
mem_size
 = 
dim0
 * (
LevñQu™tP¨ams
***);

333 if(((*
¨øy5D
Ë(
LevñQu™tP¨ams
*****)
	`mem_mÆloc
(
dim0
 * (LevñQu™tP¨ams****))Ë=
NULL
)

334 
	`no_mem_exô
("get_mem5Dquant:árray5D");

336 
mem_size
 +
	`gë_mem4Dqu™t
(*
¨øy5D
, 
dim0
 * 
dim1
, 
dim2
, 
dim3
, 
dim4
);

338 
i
 = 1; i < 
dim0
; i++)

339 (*
¨øy5D
)[
i
] = (*¨øy5D)[ò- 1] + 
dim1
;

341  
mem_size
;

342 
	}
}

353 
	$gë_mem2Dwp
(
WPP¨ams
 ***
¨øy2D
, 
dim0
, 
dim1
)

355 
i
;

357 if((*
¨øy2D
 = (
WPP¨ams
**)
	`mem_mÆloc
(
dim0
 * (WPP¨ams*))Ë=
NULL
)

358 
	`no_mem_exô
("get_mem2Dwp:árray2D");

359 if((*(*
¨øy2D
Ë(
WPP¨ams
* )
	`mem_ˇŒoc
(
dim0
 * 
dim1
,(WPP¨am†))Ë=
NULL
)

360 
	`no_mem_exô
("get_mem2Dwp:árray2D");

362 
i
 = 1 ; i < 
dim0
; i++)

363 (*
¨øy2D
)[
i
] = (*¨øy2D)[i-1] + 
dim1
;

365  
dim0
 * ((
WPP¨ams
*Ë+ 
dim1
 * (WPParams));

366 
	}
}

375 
	$‰ì_mem2Dwp
(
WPP¨ams
 **
¨øy2D
)

377 i‡(
¨øy2D
)

379 i‡(*
¨øy2D
)

380 
	`mem_‰ì
 (*
¨øy2D
);

382 
	`îr‹
 ("free_mem2Dwp:ÅryingÅo free unused memory",100);

384 
	`mem_‰ì
 (
¨øy2D
);

388 
	`îr‹
 ("free_mem2Dwp:ÅryingÅo free unused memory",100);

390 
	}
}

399 
	$‰ì_mem2Dqu™t
(
LevñQu™tP¨ams
 **
¨øy2D
)

401 i‡(
¨øy2D
)

403 i‡(*
¨øy2D
)

404 
	`mem_‰ì
 (*
¨øy2D
);

406 
	`îr‹
 ("free_mem2Dquant:ÅryingÅo free unused memory",100);

408 
	`mem_‰ì
 (
¨øy2D
);

412 
	`îr‹
 ("free_mem2Dquant:ÅryingÅo free unused memory",100);

414 
	}
}

424 
	$‰ì_mem3Dqu™t
(
LevñQu™tP¨ams
 ***
¨øy3D
)

426 i‡(
¨øy3D
)

428 
	`‰ì_mem2Dqu™t
(*
¨øy3D
);

429 
	`mem_‰ì
 (
¨øy3D
);

433 
	`îr‹
 ("free_mem3Dquant:ÅryingÅo free unused memory",100);

435 
	}
}

444 
	$‰ì_mem4Dqu™t
(
LevñQu™tP¨ams
 ****
¨øy4D
)

446 i‡(
¨øy4D
)

448 
	`‰ì_mem3Dqu™t
(*
¨øy4D
);

449 
	`mem_‰ì
 (
¨øy4D
);

453 
	`îr‹
 ("free_mem4Dquant:ÅryingÅo free unused memory",100);

455 
	}
}

464 
	$‰ì_mem5Dqu™t
(
LevñQu™tP¨ams
 *****
¨øy5D
)

466 i‡(
¨øy5D
)

468 
	`‰ì_mem4Dqu™t
(*
¨øy5D
);

469 
	`mem_‰ì
 (
¨øy5D
);

473 
	`îr‹
 ("free_mem5Dquant:ÅryingÅo free unused memory",100);

475 
	}
}

486 
	$gë_mem2D_•p
(
St‹abÀPi˘uªPå
 ***
¨øy2D
, 
dim0
, 
dim1
)

488 
i
;

490 if((*
¨øy2D
 = (
St‹abÀPi˘uªPå
**)
	`mem_mÆloc
(
dim0
 * (St‹abÀPi˘uªPå*))Ë=
NULL
)

491 
	`no_mem_exô
("get_mem2D_spp:árray2D");

492 if((*(*
¨øy2D
Ë(
St‹abÀPi˘uªPå
* )
	`mem_ˇŒoc
(
dim0
 * 
dim1
,(St‹abÀPi˘uªPå ))Ë=
NULL
)

493 
	`no_mem_exô
("get_mem2D_spp:árray2D");

495 
i
 = 1 ; i < 
dim0
; i++)

496 (*
¨øy2D
)[
i
] = (*¨øy2D)[i-1] + 
dim1
;

498  
dim0
 * ((
St‹abÀPi˘uªPå
*Ë+ 
dim1
 * (StorablePicturePtr));

499 
	}
}

510 
	$gë_mem3D_•p
(
St‹abÀPi˘uªPå
 ****
¨øy3D
, 
dim0
, 
dim1
, 
dim2
)

512 
i
, 
mem_size
 = 
dim0
 * (
St‹abÀPi˘uªPå
**);

514 if(((*
¨øy3D
Ë(
St‹abÀPi˘uªPå
***)
	`mem_mÆloc
(
dim0
 * (St‹abÀPi˘uªPå**))Ë=
NULL
)

515 
	`no_mem_exô
("get_mem3D_spp:árray3D");

517 
mem_size
 +
	`gë_mem2D_•p
(*
¨øy3D
, 
dim0
 * 
dim1
, 
dim2
);

519 
i
 = 1; i < 
dim0
; i++)

520 (*
¨øy3D
)[
i
] = (*¨øy3D)[ò- 1] + 
dim1
;

522  
mem_size
;

523 
	}
}

533 
	$gë_mem2Dmv
(
MŸi⁄Ve˘‹
 ***
¨øy2D
, 
dim0
, 
dim1
)

535 
i
;

537 if((*
¨øy2D
 = (
MŸi⁄Ve˘‹
**)
	`mem_mÆloc
(
dim0
 * (MŸi⁄Ve˘‹*))Ë=
NULL
)

538 
	`no_mem_exô
("get_mem2Dmv:árray2D");

539 if((*(*
¨øy2D
Ë(
MŸi⁄Ve˘‹
* )
	`mem_ˇŒoc
(
dim0
 * 
dim1
,(MŸi⁄Ve˘‹ ))Ë=
NULL
)

540 
	`no_mem_exô
("get_mem2Dmv:árray2D");

542 
i
 = 1 ; i < 
dim0
; i++)

543 (*
¨øy2D
)[
i
] = (*¨øy2D)[i-1] + 
dim1
;

545  
dim0
 * ((
MŸi⁄Ve˘‹
*Ë+ 
dim1
 * (MotionVector));

546 
	}
}

557 
	$gë_mem3Dmv
(
MŸi⁄Ve˘‹
 ****
¨øy3D
, 
dim0
, 
dim1
, 
dim2
)

559 
i
, 
mem_size
 = 
dim0
 * (
MŸi⁄Ve˘‹
**);

561 if(((*
¨øy3D
Ë(
MŸi⁄Ve˘‹
***)
	`mem_mÆloc
(
dim0
 * (MŸi⁄Ve˘‹**))Ë=
NULL
)

562 
	`no_mem_exô
("get_mem3Dmv:árray3D");

564 
mem_size
 +
	`gë_mem2Dmv
(*
¨øy3D
, 
dim0
 * 
dim1
, 
dim2
);

566 
i
 = 1; i < 
dim0
; i++)

567 (*
¨øy3D
)[
i
] = (*¨øy3D)[ò- 1] + 
dim1
;

569  
mem_size
;

570 
	}
}

581 
	$gë_mem4Dmv
(
MŸi⁄Ve˘‹
 *****
¨øy4D
, 
dim0
, 
dim1
, 
dim2
, 
dim3
)

583 
i
, 
mem_size
 = 
dim0
 * (
MŸi⁄Ve˘‹
***);

585 if(((*
¨øy4D
Ë(
MŸi⁄Ve˘‹
****)
	`mem_mÆloc
(
dim0
 * (MŸi⁄Ve˘‹***))Ë=
NULL
)

586 
	`no_mem_exô
("get_mem4Dpel:árray4D");

588 
mem_size
 +
	`gë_mem3Dmv
(*
¨øy4D
, 
dim0
 * 
dim1
, 
dim2
, 
dim3
);

590 
i
 = 1; i < 
dim0
; i++)

591 (*
¨øy4D
)[
i
] = (*¨øy4D)[ò- 1] + 
dim1
;

593  
mem_size
;

594 
	}
}

605 
	$gë_mem5Dmv
(
MŸi⁄Ve˘‹
 ******
¨øy5D
, 
dim0
, 
dim1
, 
dim2
, 
dim3
, 
dim4
)

607 
i
, 
mem_size
 = 
dim0
 * (
MŸi⁄Ve˘‹
***);

609 if(((*
¨øy5D
Ë(
MŸi⁄Ve˘‹
*****)
	`mem_mÆloc
(
dim0
 * (MŸi⁄Ve˘‹****))Ë=
NULL
)

610 
	`no_mem_exô
("get_mem5Dmv:árray5D");

612 
mem_size
 +
	`gë_mem4Dmv
(*
¨øy5D
, 
dim0
 * 
dim1
, 
dim2
, 
dim3
, 
dim4
);

614 
i
 = 1; i < 
dim0
; i++)

615 (*
¨øy5D
)[
i
] = (*¨øy5D)[ò- 1] + 
dim1
;

617  
mem_size
;

618 
	}
}

629 
	$gë_mem6Dmv
(
MŸi⁄Ve˘‹
 *******
¨øy6D
, 
dim0
, 
dim1
, 
dim2
, 
dim3
, 
dim4
, 
dim5
)

631 
i
, 
mem_size
 = 
dim0
 * (
MŸi⁄Ve˘‹
*****);

633 if(((*
¨øy6D
Ë(
MŸi⁄Ve˘‹
******)
	`mem_mÆloc
(
dim0
 * (MŸi⁄Ve˘‹*****))Ë=
NULL
)

634 
	`no_mem_exô
("get_mem6Dmv:árray6D");

636 
mem_size
 +
	`gë_mem5Dmv
(*
¨øy6D
, 
dim0
 * 
dim1
, 
dim2
, 
dim3
, 
dim4
, 
dim5
);

638 
i
 = 1; i < 
dim0
; i++)

639 (*
¨øy6D
)[
i
] = (*¨øy6D)[ò- 1] + 
dim1
;

641  
mem_size
;

642 
	}
}

653 
	$gë_mem7Dmv
(
MŸi⁄Ve˘‹
 ********
¨øy7D
, 
dim0
, 
dim1
, 
dim2
, 
dim3
, 
dim4
, 
dim5
, 
dim6
)

655 
i
, 
mem_size
 = 
dim0
 * (
MŸi⁄Ve˘‹
*****);

657 if(((*
¨øy7D
Ë(
MŸi⁄Ve˘‹
*******)
	`mem_mÆloc
(
dim0
 * (MŸi⁄Ve˘‹******))Ë=
NULL
)

658 
	`no_mem_exô
("get_mem7Dmv:árray7D");

660 
mem_size
 +
	`gë_mem6Dmv
(*
¨øy7D
, 
dim0
 * 
dim1
, 
dim2
, 
dim3
, 
dim4
, 
dim5
, 
dim6
);

662 
i
 = 1; i < 
dim0
; i++)

663 (*
¨øy7D
)[
i
] = (*¨øy7D)[ò- 1] + 
dim1
;

665  
mem_size
;

666 
	}
}

676 
	$‰ì_mem2D_•p
(
St‹abÀPi˘uªPå
 **
¨øy2D
)

678 i‡(
¨øy2D
)

680 i‡(*
¨øy2D
)

681 
	`mem_‰ì
 (*
¨øy2D
);

683 
	`îr‹
 ("free_mem2D_spp:ÅryingÅo free unused memory",100);

685 
	`mem_‰ì
 (
¨øy2D
);

689 
	`îr‹
 ("free_mem2D_spp:ÅryingÅo free unused memory",100);

691 
	}
}

701 
	$‰ì_mem3D_•p
(
St‹abÀPi˘uªPå
 ***
¨øy3D
)

703 i‡(
¨øy3D
)

705 
	`‰ì_mem2D_•p
(*
¨øy3D
);

706 
	`mem_‰ì
 (
¨øy3D
);

710 
	`îr‹
 ("free_mem3D_spp:ÅryingÅo free unused memory",100);

712 
	}
}

722 
	$‰ì_mem2Dmv
(
MŸi⁄Ve˘‹
 **
¨øy2D
)

724 i‡(
¨øy2D
)

726 i‡(*
¨øy2D
)

727 
	`mem_‰ì
 (*
¨øy2D
);

729 
	`îr‹
 ("free_mem2Dmv:ÅryingÅo free unused memory",100);

731 
	`mem_‰ì
 (
¨øy2D
);

735 
	`îr‹
 ("free_mem2Dmv:ÅryingÅo free unused memory",100);

737 
	}
}

747 
	$‰ì_mem3Dmv
(
MŸi⁄Ve˘‹
 ***
¨øy3D
)

749 i‡(
¨øy3D
)

751 
	`‰ì_mem2Dmv
(*
¨øy3D
);

752 
	`mem_‰ì
 (
¨øy3D
);

756 
	`îr‹
 ("free_mem3Dmv:ÅryingÅo free unused memory",100);

758 
	}
}

767 
	$‰ì_mem4Dmv
(
MŸi⁄Ve˘‹
 ****
¨øy4D
)

769 i‡(
¨øy4D
)

771 
	`‰ì_mem3Dmv
(*
¨øy4D
);

772 
	`mem_‰ì
 (
¨øy4D
);

776 
	`îr‹
 ("free_mem4Dmv:ÅryingÅo free unused memory",100);

778 
	}
}

787 
	$‰ì_mem5Dmv
(
MŸi⁄Ve˘‹
 *****
¨øy5D
)

789 i‡(
¨øy5D
)

791 
	`‰ì_mem4Dmv
(*
¨øy5D
);

792 
	`mem_‰ì
 (
¨øy5D
);

796 
	`îr‹
 ("free_mem5Dmv:ÅryingÅo free unused memory",100);

798 
	}
}

807 
	$‰ì_mem6Dmv
(
MŸi⁄Ve˘‹
 ******
¨øy6D
)

809 i‡(
¨øy6D
)

811 
	`‰ì_mem5Dmv
(*
¨øy6D
);

812 
	`mem_‰ì
 (
¨øy6D
);

816 
	`îr‹
 ("free_mem6Dmv:ÅryingÅo free unused memory",100);

818 
	}
}

827 
	$‰ì_mem7Dmv
(
MŸi⁄Ve˘‹
 *******
¨øy7D
)

829 i‡(
¨øy7D
)

831 
	`‰ì_mem6Dmv
(*
¨øy7D
);

832 
	`mem_‰ì
 (
¨øy7D
);

836 
	`îr‹
 ("free_mem7Dmv:ÅryingÅo free unused memory",100);

838 
	}
}

848 
	$gë_mem1D≥l
(
img≥l
 **
¨øy1D
, 
dim0
)

850 if((*
¨øy1D
 = (
img≥l
*)
	`mem_ˇŒoc
(
dim0
, (img≥l))Ë=
NULL
)

851 
	`no_mem_exô
("get_mem1Dpel:árray1D");

853  ((
img≥l
*Ë+ 
dim0
 * (imgpel));

854 
	}
}

864 
	$gë_mem2D≥l
(
img≥l
 ***
¨øy2D
, 
dim0
, 
dim1
)

866 
i
;

868 if((*
¨øy2D
 = (
img≥l
**)
	`mem_mÆloc
(
dim0
 * (img≥l*))Ë=
NULL
)

869 
	`no_mem_exô
("get_mem2Dpel:árray2D");

870 if((*(*
¨øy2D
Ë(
img≥l
* )
	`mem_mÆloc
(
dim0
 * 
dim1
 * (img≥»))Ë=
NULL
)

871 
	`no_mem_exô
("get_mem2Dpel:árray2D");

873 
i
 = 1 ; i < 
dim0
; i++)

875 (*
¨øy2D
)[
i
] = (*¨øy2D)[i-1] + 
dim1
;

878  
dim0
 * ((
img≥l
*Ë+ 
dim1
 * (imgpel));

879 
	}
}

881 
	$gë_mem2D≥l_∑d
(
img≥l
 ***
¨øy2D
, 
dim0
, 
dim1
, 
iPadY
, 
iPadX
)

883 
i
;

884 
img≥l
 *
cuº
 = 
NULL
;

885 
iHeight
, 
iWidth
;

887 
iHeight
 = 
dim0
+2*
iPadY
;

888 
iWidth
 = 
dim1
+2*
iPadX
;

889 if((*
¨øy2D
 = (
img≥l
**)
	`mem_mÆloc
(
iHeight
*(img≥l*))Ë=
NULL
)

890 
	`no_mem_exô
("get_mem2Dpel_pad:árray2D");

891 if((*(*
¨øy2D
Ë(
img≥l
* )
	`mem_ˇŒoc
(
iHeight
 * 
iWidth
, (img≥»))Ë=
NULL
)

892 
	`no_mem_exô
("get_mem2Dpel_pad:árray2D");

894 (*
¨øy2D
)[0] +
iPadX
;

895 
cuº
 = (*
¨øy2D
)[0];

896 
i
 = 1 ; i < 
iHeight
; i++)

898 
cuº
 +
iWidth
;

899 (*
¨øy2D
)[
i
] = 
cuº
;

901 (*
¨øy2D
Ë&((*¨øy2D)[
iPadY
]);

903  
iHeight
 * ((
img≥l
*Ë+ 
iWidth
 * (imgpel));

904 
	}
}

916 
	$gë_mem3D≥l
(
img≥l
 ****
¨øy3D
, 
dim0
, 
dim1
, 
dim2
)

918 
i
, 
mem_size
 = 
dim0
 * (
img≥l
**);

920 if(((*
¨øy3D
Ë(
img≥l
***)
	`mÆloc
(
dim0
 * (img≥l**))Ë=
NULL
)

921 
	`no_mem_exô
("get_mem3Dpel:árray3D");

923 
mem_size
 +
	`gë_mem2D≥l
(*
¨øy3D
, 
dim0
 * 
dim1
, 
dim2
);

925 
i
 = 1; i < 
dim0
; i++)

926 (*
¨øy3D
)[
i
] = (*¨øy3D)[ò- 1] + 
dim1
;

928  
mem_size
;

929 
	}
}

931 
	$gë_mem3D≥l_∑d
(
img≥l
 ****
¨øy3D
, 
dim0
, 
dim1
, 
dim2
, 
iPadY
, 
iPadX
)

933 
i
, 
mem_size
 = 
dim0
 * (
img≥l
**);

935 if(((*
¨øy3D
Ë(
img≥l
***)
	`mem_mÆloc
(
dim0
*(img≥l**))Ë=
NULL
)

936 
	`no_mem_exô
("get_mem3Dpel_pad:árray3D");

938 
i
 = 0; i < 
dim0
; i++)

939 
mem_size
 +
	`gë_mem2D≥l_∑d
((*
¨øy3D
)+
i
, 
dim1
, 
dim2
, 
iPadY
, 
iPadX
);

941  
mem_size
;

942 
	}
}

954 
	$gë_mem4D≥l
(
img≥l
 *****
¨øy4D
, 
dim0
, 
dim1
, 
dim2
, 
dim3
)

956 
i
, 
mem_size
 = 
dim0
 * (
img≥l
***);

958 if(((*
¨øy4D
Ë(
img≥l
****)
	`mem_mÆloc
(
dim0
 * (img≥l***))Ë=
NULL
)

959 
	`no_mem_exô
("get_mem4Dpel:árray4D");

961 
mem_size
 +
	`gë_mem3D≥l
(*
¨øy4D
, 
dim0
 * 
dim1
, 
dim2
, 
dim3
);

963 
i
 = 1; i < 
dim0
; i++)

964 (*
¨øy4D
)[
i
] = (*¨øy4D)[ò- 1] + 
dim1
;

966  
mem_size
;

967 
	}
}

970 
	$gë_mem4D≥l_∑d
(
img≥l
 *****
¨øy4D
, 
dim0
, 
dim1
, 
dim2
, 
dim3
, 
iPadY
, 
iPadX
)

972 
i
, 
mem_size
 = 
dim0
 * (
img≥l
***);

974 if(((*
¨øy4D
Ë(
img≥l
****)
	`mem_mÆloc
(
dim0
 * (img≥l***))Ë=
NULL
)

975 
	`no_mem_exô
("get_mem4Dpel_pad:árray4D");

977 
mem_size
 +
	`gë_mem3D≥l_∑d
(*
¨øy4D
, 
dim0
 * 
dim1
, 
dim2
, 
dim3
, 
iPadY
, 
iPadX
);

979 
i
 = 1; i < 
dim0
; i++)

980 (*
¨øy4D
)[
i
] = (*¨øy4D)[ò- 1] + 
dim1
;

982  
mem_size
;

983 
	}
}

994 
	$gë_mem5D≥l
(
img≥l
 ******
¨øy5D
, 
dim0
, 
dim1
, 
dim2
, 
dim3
, 
dim4
)

996 
i
, 
mem_size
 = 
dim0
 * (
img≥l
****);

998 if(((*
¨øy5D
Ë(
img≥l
*****)
	`mem_mÆloc
(
dim0
 * (img≥l****))Ë=
NULL
)

999 
	`no_mem_exô
("get_mem5Dpel:árray5D");

1001 
mem_size
 +
	`gë_mem4D≥l
(*
¨øy5D
, 
dim0
 * 
dim1
, 
dim2
, 
dim3
, 
dim4
);

1003 
i
 = 1; i < 
dim0
; i++)

1004 (*
¨øy5D
)[
i
] = (*¨øy5D)[ò- 1] + 
dim1
;

1006  
mem_size
;

1007 
	}
}

1009 
	$gë_mem5D≥l_∑d
(
img≥l
 ******
¨øy5D
, 
dim0
, 
dim1
, 
dim2
, 
dim3
, 
dim4
, 
iPadY
, 
iPadX
)

1011 
i
, 
mem_size
 = 
dim0
 * (
img≥l
****);

1013 if(((*
¨øy5D
Ë(
img≥l
*****)
	`mem_mÆloc
(
dim0
 * (img≥l****))Ë=
NULL
)

1014 
	`no_mem_exô
("get_mem5Dpel_pad:árray5D");

1016 
mem_size
 +
	`gë_mem4D≥l_∑d
(*
¨øy5D
, 
dim0
 * 
dim1
, 
dim2
, 
dim3
, 
dim4
, 
iPadY
, 
iPadX
);

1018 
i
 = 1; i < 
dim0
; i++)

1019 (*
¨øy5D
)[
i
] = (*¨øy5D)[ò- 1] + 
dim1
;

1021  
mem_size
;

1022 
	}
}

1031 
	$‰ì_mem1D≥l
(
img≥l
 *
¨øy1D
)

1033 i‡(
¨øy1D
)

1035 
	`mem_‰ì
 (
¨øy1D
);

1039 
	`îr‹
 ("free_mem1Dpel:ÅryingÅo free unused memory",100);

1041 
	}
}

1050 
	$‰ì_mem2D≥l
(
img≥l
 **
¨øy2D
)

1052 i‡(
¨øy2D
)

1054 i‡(*
¨øy2D
)

1055 
	`mem_‰ì
 (*
¨øy2D
);

1057 
	`îr‹
 ("free_mem2Dpel:ÅryingÅo free unused memory",100);

1059 
	`mem_‰ì
 (
¨øy2D
);

1063 
	`îr‹
 ("free_mem2Dpel:ÅryingÅo free unused memory",100);

1065 
	}
}

1067 
	$‰ì_mem2D≥l_∑d
(
img≥l
 **
¨øy2D
, 
iPadY
, 
iPadX
)

1069 i‡(
¨øy2D
)

1071 i‡(*
¨øy2D
)

1073 
	`mem_‰ì
 (
¨øy2D
[-
iPadY
]-
iPadX
);

1076 
	`îr‹
 ("free_mem2Dpel_pad:ÅryingÅo free unused memory",100);

1078 
	`mem_‰ì
 (&
¨øy2D
[-
iPadY
]);

1082 
	`îr‹
 ("free_mem2Dpel_pad:ÅryingÅo free unused memory",100);

1084 
	}
}

1093 
	$‰ì_mem3D≥l
(
img≥l
 ***
¨øy3D
)

1095 i‡(
¨øy3D
)

1097 
	`‰ì_mem2D≥l
(*
¨øy3D
);

1098 
	`mem_‰ì
 (
¨øy3D
);

1102 
	`îr‹
 ("free_mem3Dpel:ÅryingÅo free unused memory",100);

1104 
	}
}

1106 
	$‰ì_mem3D≥l_∑d
(
img≥l
 ***
¨øy3D
, 
iDim12
, 
iPadY
, 
iPadX
)

1108 i‡(
¨øy3D
)

1110 
i
;

1111 
i
=0; i<
iDim12
; i++)

1112 if(
¨øy3D
[
i
])

1114 
	`‰ì_mem2D≥l_∑d
(
¨øy3D
[
i
], 
iPadY
, 
iPadX
);

1115 
¨øy3D
[
i
] = 
NULL
;

1117 
	`mem_‰ì
 (
¨øy3D
);

1121 
	`îr‹
 ("free_mem3Dpel_pad:ÅryingÅo free unused memory",100);

1124 
	}
}

1133 
	$‰ì_mem4D≥l
(
img≥l
 ****
¨øy4D
)

1135 i‡(
¨øy4D
)

1137 
	`‰ì_mem3D≥l
(*
¨øy4D
);

1138 
	`mem_‰ì
 (
¨øy4D
);

1142 
	`îr‹
 ("free_mem4Dpel:ÅryingÅo free unused memory",100);

1144 
	}
}

1146 
	$‰ì_mem4D≥l_∑d
(
img≥l
 ****
¨øy4D
, 
iFømes
, 
iPadY
, 
iPadX
)

1148 i‡(
¨øy4D
)

1150 
	`‰ì_mem3D≥l_∑d
(*
¨øy4D
, 
iFømes
, 
iPadY
, 
iPadX
);

1151 
	`mem_‰ì
 (
¨øy4D
);

1155 
	`îr‹
 ("free_mem4Dpel_pad:ÅryingÅo free unused memory",100);

1157 
	}
}

1166 
	$‰ì_mem5D≥l
(
img≥l
 *****
¨øy5D
)

1168 i‡(
¨øy5D
)

1170 
	`‰ì_mem4D≥l
(*
¨øy5D
);

1171 
	`mem_‰ì
 (
¨øy5D
);

1175 
	`îr‹
 ("free_mem5Dpel:ÅryingÅo free unused memory",100);

1177 
	}
}

1179 
	$‰ì_mem5D≥l_∑d
(
img≥l
 *****
¨øy5D
, 
iFømes
, 
iPadY
, 
iPadX
)

1181 i‡(
¨øy5D
)

1183 
	`‰ì_mem4D≥l_∑d
(*
¨øy5D
, 
iFømes
, 
iPadY
, 
iPadX
);

1184 
	`mem_‰ì
(
¨øy5D
);

1188 
	`îr‹
 ("free_mem5Dpel_pad:ÅryingÅo free unused memory",100);

1190 
	}
}

1201 
byã
** 
	$√w_mem2D
(
dim0
, 
dim1
)

1203 
i
;

1204 
byã
 **
¨øy2D
;

1206 if(–
¨øy2D
 = (
byã
**)
	`mem_mÆloc
(
dim0
 * (byã*))Ë=
NULL
)

1207 
	`no_mem_exô
("get_mem2D:árray2D");

1208 if((*(
¨øy2D
Ë(
byã
* )
	`mem_ˇŒoc
(
dim0
 * 
dim1
,(byã ))Ë=
NULL
)

1209 
	`no_mem_exô
("get_mem2D:árray2D");

1211 
i
 = 1; i < 
dim0
; i++)

1212 
¨øy2D
[
i
] =áºay2D[i-1] + 
dim1
;

1214  (
¨øy2D
);

1215 
	}
}

1225 
	$gë_mem2D
(
byã
 ***
¨øy2D
, 
dim0
, 
dim1
)

1227 
i
;

1229 if(–*
¨øy2D
 = (
byã
**)
	`mem_mÆloc
(
dim0
 * (byã*))Ë=
NULL
)

1230 
	`no_mem_exô
("get_mem2D:árray2D");

1231 if((*(*
¨øy2D
Ë(
byã
* )
	`mem_ˇŒoc
(
dim0
 * 
dim1
,(byã ))Ë=
NULL
)

1232 
	`no_mem_exô
("get_mem2D:árray2D");

1234 
i
 = 1; i < 
dim0
; i++)

1235 (*
¨øy2D
)[
i
] = (*¨øy2D)[i-1] + 
dim1
;

1237  
dim0
 * ((
byã
*Ë+ 
dim1
 * (byte));

1238 
	}
}

1250 ** 
	$√w_mem2Döt
(
dim0
, 
dim1
)

1252 
i
;

1253 **
¨øy2D
;

1255 if((
¨øy2D
 = (**)
	`mem_mÆloc
(
dim0
 * (*))Ë=
NULL
)

1256 
	`no_mem_exô
("get_mem2Dint:árray2D");

1257 if((*(
¨øy2D
Ë(* )
	`mem_ˇŒoc
(
dim0
 * 
dim1
, ())Ë=
NULL
)

1258 
	`no_mem_exô
("get_mem2Dint:árray2D");

1260 
i
 = 1 ; i < 
dim0
; i++)

1261 (
¨øy2D
)[
i
] = (¨øy2D)[i-1] + 
dim1
;

1263  (
¨øy2D
);

1264 
	}
}

1275 
	$gë_mem2Döt
(***
¨øy2D
, 
dim0
, 
dim1
)

1277 
i
;

1279 if((*
¨øy2D
 = (**)
	`mem_mÆloc
(
dim0
 * (*))Ë=
NULL
)

1280 
	`no_mem_exô
("get_mem2Dint:árray2D");

1281 if((*(*
¨øy2D
Ë(* )
	`mem_ˇŒoc
(
dim0
 * 
dim1
, ())Ë=
NULL
)

1282 
	`no_mem_exô
("get_mem2Dint:árray2D");

1284 
i
 = 1 ; i < 
dim0
; i++)

1285 (*
¨øy2D
)[
i
] = (*¨øy2D)[i-1] + 
dim1
;

1287  
dim0
 * ((*Ë+ 
dim1
 * ());

1288 
	}
}

1290 
	$gë_mem2Döt_∑d
(***
¨øy2D
, 
dim0
, 
dim1
, 
iPadY
, 
iPadX
)

1292 
i
;

1293 *
cuº
 = 
NULL
;

1294 
iHeight
, 
iWidth
;

1296 
iHeight
 = 
dim0
+2*
iPadY
;

1297 
iWidth
 = 
dim1
+2*
iPadX
;

1298 if((*
¨øy2D
 = (**)
	`mem_mÆloc
(
iHeight
*(*))Ë=
NULL
)

1299 
	`no_mem_exô
("get_mem2Dint_pad:árray2D");

1300 if((*(*
¨øy2D
Ë(* )
	`mem_ˇŒoc
(
iHeight
 * 
iWidth
, ())Ë=
NULL
)

1301 
	`no_mem_exô
("get_mem2Dint_pad:árray2D");

1303 (*
¨øy2D
)[0] +
iPadX
;

1304 
cuº
 = (*
¨øy2D
)[0];

1305 
i
 = 1 ; i < 
iHeight
; i++)

1307 
cuº
 +
iWidth
;

1308 (*
¨øy2D
)[
i
] = 
cuº
;

1310 (*
¨øy2D
Ë&((*¨øy2D)[
iPadY
]);

1312  
iHeight
 * ((*Ë+ 
iWidth
 * ());

1313 
	}
}

1324 
	$gë_mem2Döt64
(
öt64
 ***
¨øy2D
, 
dim0
, 
dim1
)

1326 
i
;

1328 if((*
¨øy2D
 = (
öt64
**)
	`mem_mÆloc
(
dim0
 * (öt64*))Ë=
NULL
)

1329 
	`no_mem_exô
("get_mem2Dint64:árray2D");

1330 if((*(*
¨øy2D
Ë(
öt64
* )
	`mem_ˇŒoc
(
dim0
 * 
dim1
,(öt64 ))Ë=
NULL
)

1331 
	`no_mem_exô
("get_mem2Dint64:árray2D");

1333 
i
 = 1; i < 
dim0
; i++)

1334 (*
¨øy2D
)[
i
] = (*¨øy2D)[i-1] + 
dim1
;

1336  
dim0
 * ((
öt64
*Ë+ 
dim1
 * (int64));

1337 
	}
}

1348 
	$gë_mem3D
(
byã
 ****
¨øy3D
, 
dim0
, 
dim1
, 
dim2
)

1350 
i
, 
mem_size
 = 
dim0
 * (
byã
**);

1352 if(((*
¨øy3D
Ë(
byã
***)
	`mem_mÆloc
(
dim0
 * (byã**))Ë=
NULL
)

1353 
	`no_mem_exô
("get_mem3D:árray3D");

1355 
mem_size
 +
	`gë_mem2D
(*
¨øy3D
, 
dim0
 * 
dim1
, 
dim2
);

1357 
i
 = 1; i < 
dim0
; i++)

1358 (*
¨øy3D
)[
i
] = (*¨øy3D)[i-1] + 
dim1
;

1360  
mem_size
;

1361 
	}
}

1372 
	$gë_mem4D
(
byã
 *****
¨øy4D
, 
dim0
, 
dim1
, 
dim2
, 
dim3
)

1374 
i
, 
mem_size
 = 
dim0
 * (
byã
***);

1376 if(((*
¨øy4D
Ë(
byã
****)
	`mem_mÆloc
(
dim0
 * (byã***))Ë=
NULL
)

1377 
	`no_mem_exô
("get_mem4D:árray4D");

1379 
mem_size
 +
	`gë_mem3D
(*
¨øy4D
, 
dim0
 * 
dim1
, 
dim2
, 
dim3
);

1381 
i
 = 1; i < 
dim0
; i++)

1382 (*
¨øy4D
)[
i
] = (*¨øy4D)[i-1] + 
dim1
;

1384  
mem_size
;

1385 
	}
}

1396 
	$gë_mem3Döt
(****
¨øy3D
, 
dim0
, 
dim1
, 
dim2
)

1398 
i
, 
mem_size
 = 
dim0
 * (**);

1400 if(((*
¨øy3D
Ë(***)
	`mem_mÆloc
(
dim0
 * (**))Ë=
NULL
)

1401 
	`no_mem_exô
("get_mem3Dint:árray3D");

1403 
mem_size
 +
	`gë_mem2Döt
(*
¨øy3D
, 
dim0
 * 
dim1
, 
dim2
);

1405 
i
 = 1; i < 
dim0
; i++)

1406 (*
¨øy3D
)[
i
] = (*¨øy3D)[i-1] + 
dim1
;

1408  
mem_size
;

1409 
	}
}

1420 
	$gë_mem3Döt64
(
öt64
 ****
¨øy3D
, 
dim0
, 
dim1
, 
dim2
)

1422 
i
, 
mem_size
 = 
dim0
 * (
öt64
**);

1424 if(((*
¨øy3D
Ë(
öt64
***)
	`mem_mÆloc
(
dim0
 * (öt64**))Ë=
NULL
)

1425 
	`no_mem_exô
("get_mem3Dint64:árray3D");

1427 
mem_size
 +
	`gë_mem2Döt64
(*
¨øy3D
, 
dim0
 * 
dim1
, 
dim2
);

1429 
i
 = 1; i < 
dim0
; i++)

1430 (*
¨øy3D
)[
i
] = (*¨øy3D)[i-1] + 
dim1
;

1432  
mem_size
;

1433 
	}
}

1435 
	$gë_mem2Ddi°blk
(
di°blk
 ***
¨øy2D
, 
dim0
, 
dim1
)

1437 
i
;

1439 if((*
¨øy2D
 = (
di°blk
**)
	`mem_mÆloc
(
dim0
 * (di°blk*))Ë=
NULL
)

1440 
	`no_mem_exô
("get_mem2Ddistblk:árray2D");

1441 if((*(*
¨øy2D
Ë(
di°blk
* )
	`mem_ˇŒoc
(
dim0
 * 
dim1
,(di°blk ))Ë=
NULL
)

1442 
	`no_mem_exô
("get_mem2Ddistblk:árray2D");

1444 
i
 = 1; i < 
dim0
; i++)

1445 (*
¨øy2D
)[
i
] = (*¨øy2D)[i-1] + 
dim1
;

1447  
dim0
 * ((
di°blk
*Ë+ 
dim1
 * (distblk));

1448 
	}
}

1450 
	$gë_mem3Ddi°blk
(
di°blk
 ****
¨øy3D
, 
dim0
, 
dim1
, 
dim2
)

1452 
i
, 
mem_size
 = 
dim0
 * (
di°blk
**);

1454 if(((*
¨øy3D
Ë(
di°blk
***)
	`mem_mÆloc
(
dim0
 * (di°blk**))Ë=
NULL
)

1455 
	`no_mem_exô
("get_mem3Ddistblk:árray3D");

1457 
mem_size
 +
	`gë_mem2Ddi°blk
(*
¨øy3D
, 
dim0
 * 
dim1
, 
dim2
);

1459 
i
 = 1; i < 
dim0
; i++)

1460 (*
¨øy3D
)[
i
] = (*¨øy3D)[i-1] + 
dim1
;

1462  
mem_size
;

1463 
	}
}

1465 
	$gë_mem4Ddi°blk
(
di°blk
 *****
¨øy4D
, 
dim0
, 
dim1
, 
dim2
, 
dim3
)

1467 
i
, 
mem_size
 = 
dim0
 * (
di°blk
***);

1469 if(((*
¨øy4D
Ë(
di°blk
****)
	`mem_mÆloc
(
dim0
 * (di°blk***))Ë=
NULL
)

1470 
	`no_mem_exô
("get_mem4Ddistblk:árray4D");

1472 
mem_size
 +
	`gë_mem3Ddi°blk
(*
¨øy4D
, 
dim0
 * 
dim1
, 
dim2
, 
dim3
);

1474 
i
 = 1; i < 
dim0
; i++)

1475 (*
¨øy4D
)[
i
] = (*¨øy4D)[i-1] + 
dim1
;

1477  
mem_size
;

1478 
	}
}

1488 
	$gë_mem4Döt
(*****
¨øy4D
, 
dim0
, 
dim1
, 
dim2
, 
dim3
)

1490 
i
, 
mem_size
 = 
dim0
 * (***);

1492 if(((*
¨øy4D
Ë(****)
	`mem_mÆloc
(
dim0
 * (***))Ë=
NULL
)

1493 
	`no_mem_exô
("get_mem4Dint:árray4D");

1495 
mem_size
 +
	`gë_mem3Döt
(*
¨øy4D
, 
dim0
 * 
dim1
, 
dim2
, 
dim3
);

1497 
i
 = 1; i < 
dim0
; i++)

1498 (*
¨øy4D
)[
i
] = (*¨øy4D)[i-1] + 
dim1
;

1500  
mem_size
;

1501 
	}
}

1503 
	$gë_mem4Döt64
(
öt64
 *****
¨øy4D
, 
dim0
, 
dim1
, 
dim2
, 
dim3
)

1505 
i
, 
mem_size
 = 
dim0
 * (
öt64
***);

1507 if(((*
¨øy4D
Ë(
öt64
****)
	`mem_mÆloc
(
dim0
 * (öt64***))Ë=
NULL
)

1508 
	`no_mem_exô
("get_mem4Dint64:árray4D");

1510 
mem_size
 +
	`gë_mem3Döt64
(*
¨øy4D
, 
dim0
 * 
dim1
, 
dim2
, 
dim3
);

1512 
i
 = 1; i < 
dim0
; i++)

1513 (*
¨øy4D
)[
i
] = (*¨øy4D)[i-1] + 
dim1
;

1515  
mem_size
;

1516 
	}
}

1527 
	$gë_mem5Döt
(******
¨øy5D
, 
dim0
, 
dim1
, 
dim2
, 
dim3
, 
dim4
)

1529 
i
, 
mem_size
 = 
dim0
 * (****);

1531 if(((*
¨øy5D
Ë(*****)
	`mem_mÆloc
(
dim0
 * (****))Ë=
NULL
)

1532 
	`no_mem_exô
("get_mem5Dint:árray5D");

1534 
mem_size
 +
	`gë_mem4Döt
(*
¨øy5D
, 
dim0
 * 
dim1
, 
dim2
, 
dim3
, 
dim4
);

1536 
i
 = 1; i < 
dim0
; i++)

1537 (*
¨øy5D
)[
i
] = (*¨øy5D)[i-1] + 
dim1
;

1539  
mem_size
;

1540 
	}
}

1550 
	$‰ì_mem2D
(
byã
 **
¨øy2D
)

1552 i‡(
¨øy2D
)

1554 i‡(*
¨øy2D
)

1555 
	`mem_‰ì
 (*
¨øy2D
);

1557 
	`îr‹
 ("free_mem2D:ÅryingÅo free unused memory",100);

1559 
	`mem_‰ì
 (
¨øy2D
);

1563 
	`îr‹
 ("free_mem2D:ÅryingÅo free unused memory",100);

1565 
	}
}

1574 
	$‰ì_mem2Döt
(**
¨øy2D
)

1576 i‡(
¨øy2D
)

1578 i‡(*
¨øy2D
)

1579 
	`mem_‰ì
 (*
¨øy2D
);

1581 
	`îr‹
 ("free_mem2Dint:ÅryingÅo free unused memory",100);

1583 
	`mem_‰ì
 (
¨øy2D
);

1587 
	`îr‹
 ("free_mem2Dint:ÅryingÅo free unused memory",100);

1589 
	}
}

1591 
	$‰ì_mem2Döt_∑d
(**
¨øy2D
, 
iPadY
, 
iPadX
)

1593 i‡(
¨øy2D
)

1595 i‡(*
¨øy2D
)

1596 
	`mem_‰ì
 (
¨øy2D
[-
iPadY
]-
iPadX
);

1598 
	`îr‹
 ("free_mem2Dint_pad:ÅryingÅo free unused memory",100);

1600 
	`mem_‰ì
 (&
¨øy2D
[-
iPadY
]);

1604 
	`îr‹
 ("free_mem2Dint_pad:ÅryingÅo free unused memory",100);

1606 
	}
}

1615 
	$‰ì_mem2Döt64
(
öt64
 **
¨øy2D
)

1617 i‡(
¨øy2D
)

1619 i‡(*
¨øy2D
)

1620 
	`mem_‰ì
 (*
¨øy2D
);

1622 
	`îr‹
 ("free_mem2Dint64:ÅryingÅo free unused memory",100);

1623 
	`mem_‰ì
 (
¨øy2D
);

1627 
	`îr‹
 ("free_mem2Dint64:ÅryingÅo free unused memory",100);

1629 
	}
}

1639 
	$‰ì_mem3D
(
byã
 ***
¨øy3D
)

1641 i‡(
¨øy3D
)

1643 
	`‰ì_mem2D
(*
¨øy3D
);

1644 
	`mem_‰ì
 (
¨øy3D
);

1648 
	`îr‹
 ("free_mem3D:ÅryingÅo free unused memory",100);

1650 
	}
}

1659 
	$‰ì_mem4D
(
byã
 ****
¨øy4D
)

1661 i‡(
¨øy4D
)

1663 
	`‰ì_mem3D
(*
¨øy4D
);

1664 
	`mem_‰ì
 (
¨øy4D
);

1668 
	`îr‹
 ("free_mem4D:ÅryingÅo free unused memory",100);

1670 
	}
}

1679 
	$‰ì_mem3Döt
(***
¨øy3D
)

1681 i‡(
¨øy3D
)

1683 
	`‰ì_mem2Döt
(*
¨øy3D
);

1684 
	`mem_‰ì
 (
¨øy3D
);

1688 
	`îr‹
 ("free_mem3Dint:ÅryingÅo free unused memory",100);

1690 
	}
}

1700 
	$‰ì_mem3Döt64
(
öt64
 ***
¨øy3D
)

1702 i‡(
¨øy3D
)

1704 
	`‰ì_mem2Döt64
(*
¨øy3D
);

1705 
	`mem_‰ì
 (
¨øy3D
);

1709 
	`îr‹
 ("free_mem3Dint64:ÅryingÅo free unused memory",100);

1711 
	}
}

1713 
	$‰ì_mem3Ddi°blk
(
di°blk
 ***
¨øy3D
)

1715 i‡(
¨øy3D
)

1717 
	`‰ì_mem2Ddi°blk
(*
¨øy3D
);

1718 
	`mem_‰ì
 (
¨øy3D
);

1722 
	`îr‹
 ("free_mem3Ddistblk:ÅryingÅo free unused memory",100);

1724 
	}
}

1733 
	$‰ì_mem4Döt
(****
¨øy4D
)

1735 i‡(
¨øy4D
)

1737 
	`‰ì_mem3Döt
–*
¨øy4D
);

1738 
	`mem_‰ì
 (
¨øy4D
);

1741 
	`îr‹
 ("free_mem4Dint:ÅryingÅo free unused memory",100);

1743 
	}
}

1745 
	$‰ì_mem4Döt64
(
öt64
 ****
¨øy4D
)

1747 i‡(
¨øy4D
)

1749 
	`‰ì_mem3Döt64
–*
¨øy4D
);

1750 
	`mem_‰ì
 (
¨øy4D
);

1753 
	`îr‹
 ("free_mem4Dint64:ÅryingÅo free unused memory",100);

1755 
	}
}

1757 
	$‰ì_mem4Ddi°blk
(
di°blk
 ****
¨øy4D
)

1759 i‡(
¨øy4D
)

1761 
	`‰ì_mem3Ddi°blk
–*
¨øy4D
);

1762 
	`mem_‰ì
 (
¨øy4D
);

1765 
	`îr‹
 ("free_mem4Ddistblk:ÅryingÅo free unused memory",100);

1767 
	}
}

1776 
	$‰ì_mem5Döt
(*****
¨øy5D
)

1778 i‡(
¨øy5D
)

1780 
	`‰ì_mem4Döt
–*
¨øy5D
);

1781 
	`mem_‰ì
 (
¨øy5D
);

1784 
	`îr‹
 ("free_mem5Dint:ÅryingÅo free unused memory",100);

1786 
	}
}

1796 
	$no_mem_exô
(*
whîe
)

1798 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "CouldÇŸáŒoˇã mem‹y: %s",
whîe
);

1799 
	`îr‹
 (
îr‹ãxt
, 100);

1800 
	}
}

1812 
uöt16
** 
	$√w_mem2Duöt16
(
dim0
, 
dim1
)

1814 
i
;

1815 
uöt16
 **
¨øy2D
;

1817 if(–
¨øy2D
 = (
uöt16
**)
	`mem_mÆloc
(
dim0
 * (uöt16*))Ë=
NULL
)

1818 
	`no_mem_exô
("get_mem2Duint16:árray2D");

1819 if((*
¨øy2D
 = (
uöt16
* )
	`mem_ˇŒoc
(
dim0
 * 
dim1
,(uöt16 ))Ë=
NULL
)

1820 
	`no_mem_exô
("get_mem2Duint16:árray2D");

1822 
i
 = 1; i < 
dim0
; i++)

1823 
¨øy2D
[
i
] =áºay2D[i-1] + 
dim1
;

1825  (
¨øy2D
);

1826 
	}
}

1837 
	$gë_mem2Duöt16
(
uöt16
 ***
¨øy2D
, 
dim0
, 
dim1
)

1839 
i
;

1841 if(–*
¨øy2D
 = (
uöt16
**)
	`mem_mÆloc
(
dim0
 * (uöt16*))Ë=
NULL
)

1842 
	`no_mem_exô
("get_mem2Duint16:árray2D");

1844 if((*(*
¨øy2D
Ë(
uöt16
* )
	`mem_ˇŒoc
(
dim0
 * 
dim1
,(uöt16 ))Ë=
NULL
)

1845 
	`no_mem_exô
("get_mem2Duint16:árray2D");

1847 
i
 = 1; i < 
dim0
; i++)

1848 (*
¨øy2D
)[
i
] = (*¨øy2D)[i-1] + 
dim1
;

1850  
dim0
 * ((
uöt16
*Ë+ 
dim1
 * (uint16));

1851 
	}
}

1862 
	$gë_mem3Duöt16
(
uöt16
 ****
¨øy3D
,
dim0
, 
dim1
, 
dim2
)

1864 
i
, 
mem_size
 = 
dim0
 * (
uöt16
**);

1866 if(((*
¨øy3D
Ë(
uöt16
***)
	`mem_mÆloc
(
dim0
 * (uöt16**))Ë=
NULL
)

1867 
	`no_mem_exô
("get_mem3Duint16:árray3D");

1869 
mem_size
 +
	`gë_mem2Duöt16
(*
¨øy3D
, 
dim0
 * 
dim1
, 
dim2
);

1871 
i
 = 1; i < 
dim0
; i++)

1872 (*
¨øy3D
)[
i
] = (*¨øy3D)[i-1] + 
dim1
;

1874  
mem_size
;

1875 
	}
}

1887 
	$gë_mem4Duöt16
(
uöt16
 *****
¨øy4D
, 
dim0
, 
dim1
, 
dim2
, 
dim3
)

1889 
i
, 
mem_size
 = 
dim0
 * (
uöt16
***);

1891 if(((*
¨øy4D
Ë(
uöt16
****)
	`mem_mÆloc
(
dim0
 * (uöt16***))Ë=
NULL
)

1892 
	`no_mem_exô
("get_mem4Duint16:árray4D");

1894 
mem_size
 +
	`gë_mem3Duöt16
(*
¨øy4D
, 
dim0
 * 
dim1
, 
dim2
, 
dim3
);

1896 
i
 = 1; i < 
dim0
; i++)

1897 (*
¨øy4D
)[
i
] = (*¨øy4D)[i-1] + 
dim1
;

1899  
mem_size
;

1900 
	}
}

1911 
	$gë_mem2Dsh‹t
(***
¨øy2D
, 
dim0
, 
dim1
)

1913 
i
;

1914 *
cuº
 = 
NULL
;

1916 if(–*
¨øy2D
 = (**)
	`mem_mÆloc
(
dim0
 * (*))Ë=
NULL
)

1917 
	`no_mem_exô
("get_mem2Dshort:árray2D");

1918 if((*(*
¨øy2D
Ë(* )
	`mem_ˇŒoc
(
dim0
 * 
dim1
,())Ë=
NULL
)

1919 
	`no_mem_exô
("get_mem2Dshort:árray2D");

1921 
cuº
 = (*
¨øy2D
)[0];

1922 
i
 = 1; i < 
dim0
; i++)

1924 
cuº
 +
dim1
;

1925 (*
¨øy2D
)[
i
] = 
cuº
;

1928  
dim0
 * ((*Ë+ 
dim1
 * ());

1929 
	}
}

1940 
	$gë_mem3Dsh‹t
(****
¨øy3D
,
dim0
, 
dim1
, 
dim2
)

1942 
i
, 
mem_size
 = 
dim0
 * (**);

1943 **
cuº
 = 
NULL
;

1945 if(((*
¨øy3D
Ë(***)
	`mem_mÆloc
(
dim0
 * (**))Ë=
NULL
)

1946 
	`no_mem_exô
("get_mem3Dshort:árray3D");

1948 
mem_size
 +
	`gë_mem2Dsh‹t
(*
¨øy3D
, 
dim0
 * 
dim1
, 
dim2
);

1950 
cuº
 = (*
¨øy3D
)[0];

1951 
i
 = 1; i < 
dim0
; i++)

1953 
cuº
 +
dim1
;

1954 (*
¨øy3D
)[
i
] = 
cuº
;

1957  
mem_size
;

1958 
	}
}

1970 
	$gë_mem4Dsh‹t
(*****
¨øy4D
, 
dim0
, 
dim1
, 
dim2
, 
dim3
)

1972 
i
, 
mem_size
 = 
dim0
 * (***);

1974 if(((*
¨øy4D
Ë(****)
	`mem_mÆloc
(
dim0
 * (***))Ë=
NULL
)

1975 
	`no_mem_exô
("get_mem4Dshort:árray4D");

1977 
mem_size
 +
	`gë_mem3Dsh‹t
(*
¨øy4D
, 
dim0
 * 
dim1
, 
dim2
, 
dim3
);

1979 
i
 = 1; i < 
dim0
; i++)

1980 (*
¨øy4D
)[
i
] = (*¨øy4D)[i-1] + 
dim1
;

1982  
mem_size
;

1983 
	}
}

1994 
	$gë_mem5Dsh‹t
(******
¨øy5D
, 
dim0
, 
dim1
, 
dim2
, 
dim3
, 
dim4
)

1996 
i
, 
mem_size
 = 
dim0
 * (****);

1998 if(((*
¨øy5D
Ë(*****)
	`mem_mÆloc
(
dim0
 * (****))Ë=
NULL
)

1999 
	`no_mem_exô
("get_mem5Dshort:árray5D");

2001 
mem_size
 +
	`gë_mem4Dsh‹t
(*
¨øy5D
, 
dim0
 * 
dim1
, 
dim2
, 
dim3
, 
dim4
);

2003 
i
 = 1; i < 
dim0
; i++)

2004 (*
¨øy5D
)[
i
] = (*¨øy5D)[i-1] + 
dim1
;

2006  
mem_size
;

2007 
	}
}

2018 
	$gë_mem6Dsh‹t
(*******
¨øy6D
, 
dim0
, 
dim1
, 
dim2
, 
dim3
, 
dim4
, 
dim5
)

2020 
i
, 
mem_size
 = 
dim0
 * (*****);

2022 if(((*
¨øy6D
Ë(******)
	`mem_mÆloc
(
dim0
 * (*****))Ë=
NULL
)

2023 
	`no_mem_exô
("get_mem6Dshort:árray6D");

2025 
mem_size
 +
	`gë_mem5Dsh‹t
(*
¨øy6D
, 
dim0
 * 
dim1
, 
dim2
, 
dim3
, 
dim4
, 
dim5
);

2027 
i
 = 1; i < 
dim0
; i++)

2028 (*
¨øy6D
)[
i
] = (*¨øy6D)[i-1] + 
dim1
;

2030  
mem_size
;

2031 
	}
}

2042 
	$gë_mem7Dsh‹t
(********
¨øy7D
, 
dim0
, 
dim1
, 
dim2
, 
dim3
, 
dim4
, 
dim5
, 
dim6
)

2044 
i
, 
mem_size
 = 
dim0
 * (******);

2046 if(((*
¨øy7D
Ë(*******)
	`mem_mÆloc
(
dim0
 * (******))Ë=
NULL
)

2047 
	`no_mem_exô
("get_mem7Dshort:árray7D");

2049 
mem_size
 +
	`gë_mem6Dsh‹t
(*
¨øy7D
, 
dim0
 * 
dim1
, 
dim2
, 
dim3
, 
dim4
, 
dim5
, 
dim6
);

2051 
i
 = 1; i < 
dim0
; i++)

2052 (*
¨øy7D
)[
i
] = (*¨øy7D)[i-1] + 
dim1
;

2054  
mem_size
;

2055 
	}
}

2064 
	$‰ì_mem2Duöt16
(
uöt16
 **
¨øy2D
)

2066 i‡(
¨øy2D
)

2068 i‡(*
¨øy2D
)

2069 
	`mem_‰ì
 (*
¨øy2D
);

2070 
	`îr‹
 ("free_mem2Duint16:ÅryingÅo free unused memory",100);

2072 
	`mem_‰ì
 (
¨øy2D
);

2076 
	`îr‹
 ("free_mem2Duint16:ÅryingÅo free unused memory",100);

2078 
	}
}

2087 
	$‰ì_mem3Duöt16
(
uöt16
 ***
¨øy3D
)

2089 i‡(
¨øy3D
)

2091 
	`‰ì_mem2Duöt16
(*
¨øy3D
);

2092 
	`mem_‰ì
 (
¨øy3D
);

2096 
	`îr‹
 ("free_mem3Duint16:ÅryingÅo free unused memory",100);

2098 
	}
}

2107 
	$‰ì_mem4Duöt16
(
uöt16
 ****
¨øy4D
)

2109 i‡(
¨øy4D
)

2111 
	`‰ì_mem3Duöt16
–*
¨øy4D
);

2112 
	`mem_‰ì
 (
¨øy4D
);

2116 
	`îr‹
 ("free_mem4Duint16:ÅryingÅo free unused memory",100);

2118 
	}
}

2127 
	$‰ì_mem2Dsh‹t
(**
¨øy2D
)

2129 i‡(
¨øy2D
)

2131 i‡(*
¨øy2D
)

2132 
	`mem_‰ì
 (*
¨øy2D
);

2133 
	`îr‹
 ("free_mem2Dshort:ÅryingÅo free unused memory",100);

2135 
	`mem_‰ì
 (
¨øy2D
);

2139 
	`îr‹
 ("free_mem2Dshort:ÅryingÅo free unused memory",100);

2141 
	}
}

2150 
	$‰ì_mem3Dsh‹t
(***
¨øy3D
)

2152 i‡(
¨øy3D
)

2154 
	`‰ì_mem2Dsh‹t
(*
¨øy3D
);

2155 
	`mem_‰ì
 (
¨øy3D
);

2159 
	`îr‹
 ("free_mem3Dshort:ÅryingÅo free unused memory",100);

2161 
	}
}

2170 
	$‰ì_mem4Dsh‹t
(****
¨øy4D
)

2172 i‡(
¨øy4D
)

2174 
	`‰ì_mem3Dsh‹t
–*
¨øy4D
);

2175 
	`mem_‰ì
 (
¨øy4D
);

2179 
	`îr‹
 ("free_mem4Dshort:ÅryingÅo free unused memory",100);

2181 
	}
}

2190 
	$‰ì_mem5Dsh‹t
(*****
¨øy5D
)

2192 i‡(
¨øy5D
)

2194 
	`‰ì_mem4Dsh‹t
–*
¨øy5D
) ;

2195 
	`mem_‰ì
 (
¨øy5D
);

2199 
	`îr‹
 ("free_mem5Dshort:ÅryingÅo free unused memory",100);

2201 
	}
}

2210 
	$‰ì_mem6Dsh‹t
(******
¨øy6D
)

2212 i‡(
¨øy6D
)

2214 
	`‰ì_mem5Dsh‹t
–*
¨øy6D
);

2215 
	`mem_‰ì
 (
¨øy6D
);

2219 
	`îr‹
 ("free_mem6Dshort:ÅryingÅo free unused memory",100);

2221 
	}
}

2230 
	$‰ì_mem7Dsh‹t
(*******
¨øy7D
)

2232 i‡(
¨øy7D
)

2234 
	`‰ì_mem6Dsh‹t
–*
¨øy7D
);

2235 
	`mem_‰ì
 (
¨øy7D
);

2239 
	`îr‹
 ("free_mem7Dshort:ÅryingÅo free unused memory",100);

2241 
	}
}

2252 
	$gë_mem2DdoubÀ
(***
¨øy2D
, 
dim0
, 
dim1
)

2254 
i
;

2256 if((*
¨øy2D
 = (**)
	`mem_mÆloc
(
dim0
 * (*))Ë=
NULL
)

2257 
	`no_mem_exô
("get_mem2Ddouble:árray2D");

2259 if(((*
¨øy2D
)[0] = (* )
	`mem_ˇŒoc
(
dim0
 * 
dim1
, ())Ë=
NULL
)

2260 
	`no_mem_exô
("get_mem2Ddouble:árray2D");

2262 
i
=1 ; i<
dim0
 ; i++)

2263 (*
¨øy2D
)[
i
] = (*¨øy2D)[i-1] + 
dim1
 ;

2265  
dim0
 * ((*Ë+ 
dim1
 * ());

2266 
	}
}

2278 
	$gë_mem1DodoubÀ
(**
¨øy1D
, 
dim0
, 
off£t
)

2280 if((*
¨øy1D
 = (*)
	`mem_ˇŒoc
(
dim0
, ())Ë=
NULL
)

2281 
	`no_mem_exô
("get_mem1Dodouble:árray2D");

2283 *
¨øy1D
 +
off£t
;

2285  
dim0
 * ();

2286 
	}
}

2298 
	$gë_mem2DodoubÀ
(***
¨øy2D
, 
dim0
, 
dim1
, 
off£t
)

2300 
i
;

2302 if((*
¨øy2D
 = (**)
	`mem_mÆloc
(
dim0
 * (*))Ë=
NULL
)

2303 
	`no_mem_exô
("get_mem2Dodouble:árray2D");

2304 if(((*
¨øy2D
)[0] = (* )
	`mem_ˇŒoc
(
dim0
 * 
dim1
,())Ë=
NULL
)

2305 
	`no_mem_exô
("get_mem2Dodouble:árray2D");

2307 (*
¨øy2D
)[0] +
off£t
;

2309 
i
=1 ; i<
dim0
 ; i++)

2310 (*
¨øy2D
)[
i
] = (*¨øy2D)[i-1] + 
dim1
 ;

2312  
dim0
 * ((*Ë+ 
dim1
 * ());

2313 
	}
}

2324 
	$gë_mem3DodoubÀ
(****
¨øy3D
, 
dim0
, 
dim1
, 
dim2
, 
off£t
)

2326 
i
,
j
;

2328 if(((*
¨øy3D
Ë(***)
	`mem_mÆloc
(
dim0
 * (**))Ë=
NULL
)

2329 
	`no_mem_exô
("get_mem3Dodouble:árray3D");

2331 if(((*
¨øy3D
)[0] = (** )
	`mem_ˇŒoc
(
dim0
 * 
dim1
,(*))Ë=
NULL
)

2332 
	`no_mem_exô
("get_mem3Dodouble:árray3D");

2334 (*
¨øy3D
Ë[0] +
off£t
;

2336 
i
=1 ; i<
dim0
 ; i++)

2337 (*
¨øy3D
)[
i
] = (*¨øy3D)[i-1] + 
dim1
 ;

2339 
i
 = 0; i < 
dim0
; i++)

2340 
j
 = -
off£t
; j < 
dim1
 - offset; j++)

2341 if(((*
¨øy3D
)[
i
][
j
] = (* )
	`mem_ˇŒoc
(
dim2
, ())Ë=
NULL
)

2342 
	`no_mem_exô
("get_mem3Dodouble:árray3D");

2344  
dim0
*–(**Ë+ 
dim1
 * ( (*Ë+ 
dim2
 * ()));

2345 
	}
}

2358 
	$gë_off£t_mem2Dsh‹t
(***
¨øy2D
, 
dim0
, 
dim1
, 
off£t_y
, 
off£t_x
)

2360 
i
;

2362 if((*
¨øy2D
 = (**)
	`mem_mÆloc
(
dim0
 * (*))Ë=
NULL
)

2363 
	`no_mem_exô
("get_offset_mem2Dshort:árray2D");

2365 if(((*
¨øy2D
)[0] = (* )
	`mem_ˇŒoc
(
dim0
 * 
dim1
,())Ë=
NULL
)

2366 
	`no_mem_exô
("get_offset_mem2Dshort:árray2D");

2367 (*
¨øy2D
)[0] +
off£t_x
 + 
off£t_y
 * 
dim1
;

2369 
i
=-1 ; i > -
off£t_y
 - 1; i--)

2371 (*
¨øy2D
)[
i
] = (*¨øy2D)[i+1] - 
dim1
;

2374 
i
=1 ; i < 
dim1
 - 
off£t_y
; i++)

2375 (*
¨øy2D
)[
i
] = (*¨øy2D)[i-1] + 
dim1
;

2377  
dim0
 * ((*Ë+ 
dim1
 * ());

2378 
	}
}

2389 
	$gë_mem3Doöt
(****
¨øy3D
, 
dim0
, 
dim1
, 
dim2
, 
off£t
)

2391 
i
,
j
;

2393 if(((*
¨øy3D
Ë(***)
	`mem_mÆloc
(
dim0
 * (**))Ë=
NULL
)

2394 
	`no_mem_exô
("get_mem3Doint:árray3D");

2396 if(((*
¨øy3D
)[0] = (** )
	`mem_ˇŒoc
(
dim0
 * 
dim1
,(*))Ë=
NULL
)

2397 
	`no_mem_exô
("get_mem3Doint:árray3D");

2399 (*
¨øy3D
Ë[0] +
off£t
;

2401 
i
=1 ; i<
dim0
 ; i++)

2402 (*
¨øy3D
)[
i
] = (*¨øy3D)[i-1] + 
dim1
 ;

2404 
i
 = 0; i < 
dim0
; i++)

2405 
j
 = -
off£t
; j < 
dim1
 - offset; j++)

2406 if(((*
¨øy3D
)[
i
][
j
] = (* )
	`mem_ˇŒoc
(
dim2
,())Ë=
NULL
)

2407 
	`no_mem_exô
("get_mem3Doint:árray3D");

2409  
dim0
 * ((**Ë+ 
dim1
 * ((*Ë+ 
dim2
 * ()));

2410 
	}
}

2422 
	$gë_mem2Doöt
(***
¨øy2D
, 
dim0
, 
dim1
, 
off£t
)

2424 
i
;

2426 if((*
¨øy2D
 = (**)
	`mem_mÆloc
(
dim0
 * (*))Ë=
NULL
)

2427 
	`no_mem_exô
("get_mem2Dint:árray2D");

2428 if(((*
¨øy2D
)[0] = (* )
	`mem_ˇŒoc
(
dim0
 * 
dim1
,())Ë=
NULL
)

2429 
	`no_mem_exô
("get_mem2Dint:árray2D");

2431 (*
¨øy2D
)[0] +
off£t
;

2433 
i
=1 ; i<
dim0
 ; i++)

2434 (*
¨øy2D
)[
i
] = (*¨øy2D)[i-1] + 
dim1
 ;

2436  
dim0
 * ((*Ë+ 
dim1
 * ());

2437 
	}
}

2447 
	$‰ì_mem2DdoubÀ
(**
¨øy2D
)

2449 i‡(
¨øy2D
)

2451 i‡(*
¨øy2D
)

2452 
	`mem_‰ì
 (*
¨øy2D
);

2454 
	`îr‹
 ("free_mem2Ddouble:ÅryingÅo free unused memory",100);

2456 
	`mem_‰ì
 (
¨øy2D
);

2461 
	`îr‹
 ("free_mem2Ddouble:ÅryingÅo free unused memory",100);

2463 
	}
}

2472 
	$‰ì_mem1DodoubÀ
(*
¨øy1D
, 
off£t
)

2474 i‡(
¨øy1D
)

2476 
¨øy1D
 -
off£t
;

2477 
	`mem_‰ì
 (
¨øy1D
);

2481 
	`îr‹
 ("free_mem1Dodouble:ÅryingÅo free unused memory",100);

2483 
	}
}

2493 
	$‰ì_mem2DodoubÀ
(**
¨øy2D
, 
off£t
)

2495 i‡(
¨øy2D
)

2497 
¨øy2D
[0] -
off£t
;

2498 i‡(
¨øy2D
[0])

2499 
	`mem_‰ì
 (
¨øy2D
[0]);

2500 
	`îr‹
 ("free_mem2Dodouble:ÅryingÅo free unused memory",100);

2502 
	`mem_‰ì
 (
¨øy2D
);

2506 
	`îr‹
 ("free_mem2Dodouble:ÅryingÅo free unused memory",100);

2508 
	}
}

2516 
	$‰ì_mem3DodoubÀ
(***
¨øy3D
, 
dim0
, 
dim1
, 
off£t
)

2518 
i
, 
j
;

2520 i‡(
¨øy3D
)

2522 
i
 = 0; i < 
dim0
; i++)

2524 
j
 = -
off£t
; j < 
dim1
 - offset; j++)

2526 i‡(
¨øy3D
[
i
][
j
])

2527 
	`mem_‰ì
 (
¨øy3D
[
i
][
j
]);

2529 
	`îr‹
 ("free_mem3Dodouble:ÅryingÅo free unused memory",100);

2532 
¨øy3D
[0] -
off£t
;

2533 i‡(
¨øy3D
[0])

2534 
	`mem_‰ì
 (
¨øy3D
[0]);

2536 
	`îr‹
 ("free_mem3Dodouble:ÅryingÅo free unused memory",100);

2537 
	`mem_‰ì
 (
¨øy3D
);

2541 
	`îr‹
 ("free_mem3Dodouble:ÅryingÅo free unused memory",100);

2543 
	}
}

2551 
	$‰ì_mem3Doöt
(***
¨øy3D
, 
dim0
, 
dim1
, 
off£t
)

2553 
i
, 
j
;

2555 i‡(
¨øy3D
)

2557 
i
 = 0; i < 
dim0
; i++)

2559 
j
 = -
off£t
; j < 
dim1
 - offset; j++)

2561 i‡(
¨øy3D
[
i
][
j
])

2562 
	`mem_‰ì
 (
¨øy3D
[
i
][
j
]);

2564 
	`îr‹
 ("free_mem3Doint:ÅryingÅo free unused memory",100);

2567 
¨øy3D
[0] -
off£t
;

2568 i‡(
¨øy3D
[0])

2569 
	`mem_‰ì
 (
¨øy3D
[0]);

2571 
	`îr‹
 ("free_mem3Doint:ÅryingÅo free unused memory",100);

2572 
	`mem_‰ì
 (
¨øy3D
);

2576 
	`îr‹
 ("free_mem3Doint:ÅryingÅo free unused memory",100);

2578 
	}
}

2588 
	$‰ì_mem2Doöt
(**
¨øy2D
, 
off£t
)

2590 i‡(
¨øy2D
)

2592 
¨øy2D
[0] -
off£t
;

2593 i‡(
¨øy2D
[0])

2594 
	`mem_‰ì
 (
¨øy2D
[0]);

2596 
	`îr‹
 ("free_mem2Doint:ÅryingÅo free unused memory",100);

2598 
	`mem_‰ì
 (
¨øy2D
);

2603 
	`îr‹
 ("free_mem2Doint:ÅryingÅo free unused memory",100);

2605 
	}
}

2614 
	$‰ì_off£t_mem2Dsh‹t
(**
¨øy2D
, 
dim1
, 
off£t_y
, 
off£t_x
)

2616 i‡(
¨øy2D
)

2618 
¨øy2D
[0] -
off£t_x
 + 
off£t_y
 * 
dim1
;

2619 i‡(
¨øy2D
[0])

2620 
	`mem_‰ì
 (
¨øy2D
[0]);

2622 
	`îr‹
 ("free_offset_mem2Dshort:ÅryingÅo free unused memory",100);

2624 
	`mem_‰ì
 (
¨øy2D
);

2629 
	`îr‹
 ("free_offset_mem2Dshort:ÅryingÅo free unused memory",100);

2631 
	}
}

2640 
	$‰ì_mem3DdoubÀ
(***
¨øy3D
)

2642 i‡(
¨øy3D
)

2644 
	`‰ì_mem2DdoubÀ
(*
¨øy3D
);

2645 
	`mem_‰ì
 (
¨øy3D
);

2649 
	`îr‹
 ("free_mem3D:ÅryingÅo free unused memory",100);

2651 
	}
}

2664 
	$gë_mem2Dﬁm
(
LambdaP¨ams
 ***
¨øy2D
, 
dim0
, 
dim1
, 
off£t
)

2666 
i
;

2668 if((*
¨øy2D
 = (
LambdaP¨ams
**)
	`mem_mÆloc
(
dim0
 * (LambdaP¨ams*))Ë=
NULL
)

2669 
	`no_mem_exô
("get_mem2Dolm:árray2D");

2670 if(((*
¨øy2D
)[0] = (
LambdaP¨ams
* )
	`mem_ˇŒoc
(
dim0
 * 
dim1
, (LambdaP¨ams))Ë=
NULL
)

2671 
	`no_mem_exô
("get_mem2Dolm:árray2D");

2673 (*
¨øy2D
)[0] +
off£t
;

2675 
i
=1 ; i<
dim0
 ; i++)

2676 (*
¨øy2D
)[
i
] = (*¨øy2D)[i-1] + 
dim1
 ;

2678  
dim0
 * ((
LambdaP¨ams
*Ë+ 
dim1
 * (LambdaParams));

2679 
	}
}

2689 
	$‰ì_mem2Dﬁm
(
LambdaP¨ams
 **
¨øy2D
, 
off£t
)

2691 i‡(
¨øy2D
)

2693 
¨øy2D
[0] -
off£t
;

2694 i‡(
¨øy2D
[0])

2695 
	`mem_‰ì
 (
¨øy2D
[0]);

2697 
	`îr‹
 ("free_mem2Dolm:ÅryingÅo free unused memory",100);

2699 
	`mem_‰ì
 (
¨øy2D
);

2704 
	`îr‹
 ("free_mem2Dolm:ÅryingÅo free unused memory",100);

2706 
	}
}

2708 
	$‰ì_mem2Ddi°blk
(
di°blk
 **
¨øy2D
)

2710 i‡(
¨øy2D
)

2712 i‡(*
¨øy2D
)

2713 
	`mem_‰ì
 (*
¨øy2D
);

2715 
	`îr‹
 ("free_mem2Ddistblk:ÅryingÅo free unused memory",100);

2716 
	`‰ì
 (
¨øy2D
);

2720 
	`îr‹
 ("free_mem2Ddistblk:ÅryingÅo free unused memory",100);

2722 
	}
}

	@lcommon/src/mv_prediction.c

15 
	~"globÆ.h
"

16 
	~"mbuf„r.h
"

24 
	$GëMŸi⁄Ve˘‹Pªdi˘‹MBAFF
 (
Ma¸oblock
 *
cuºMB
,

25 
PixñPos
 *
block
,

26 
MŸi⁄Ve˘‹
 *
pmv
,

27 
ªf_‰ame
,

28 
PicMŸi⁄P¨ams
 **
mv_öfo
,

29 
li°
,

30 
mb_x
,

31 
mb_y
,

32 
blocksh≠e_x
,

33 
blocksh≠e_y
)

35 
mv_a
, 
mv_b
, 
mv_c
, 
¥ed_vec
=0;

36 
mvPªdTy≥
, 
rFømeL
, 
rFømeU
, 
rFømeUR
;

37 
hv
;

38 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

40 
mvPªdTy≥
 = 
MVPRED_MEDIAN
;

43 i‡(
cuºMB
->
mb_fõld
)

45 
rFømeL
 = 
block
[0].
avaûabÀ


46 ? (
p_Vid
->
mb_d©a
[
block
[0].
mb_addr
].
mb_fõld


47 ? 
mv_öfo
[
block
[0].
pos_y
][block[0].
pos_x
].
ªf_idx
[
li°
]

48 : 
mv_öfo
[
block
[0].
pos_y
][block[0].
pos_x
].
ªf_idx
[
li°
] * 2) : -1;

49 
rFømeU
 = 
block
[1].
avaûabÀ


50 ? (
p_Vid
->
mb_d©a
[
block
[1].
mb_addr
].
mb_fõld


51 ? 
mv_öfo
[
block
[1].
pos_y
][block[1].
pos_x
].
ªf_idx
[
li°
]

52 : 
mv_öfo
[
block
[1].
pos_y
][block[1].
pos_x
].
ªf_idx
[
li°
] * 2) : -1;

53 
rFømeUR
 = 
block
[2].
avaûabÀ


54 ? (
p_Vid
->
mb_d©a
[
block
[2].
mb_addr
].
mb_fõld


55 ? 
mv_öfo
[
block
[2].
pos_y
][block[2].
pos_x
].
ªf_idx
[
li°
]

56 : 
mv_öfo
[
block
[2].
pos_y
][block[2].
pos_x
].
ªf_idx
[
li°
] * 2) : -1;

60 
rFømeL
 = 
block
[0].
avaûabÀ


61 ? (
p_Vid
->
mb_d©a
[
block
[0].
mb_addr
].
mb_fõld


62 ? 
mv_öfo
[
block
[0].
pos_y
][block[0].
pos_x
].
ªf_idx
[
li°
] >>1

63 : 
mv_öfo
[
block
[0].
pos_y
][block[0].
pos_x
].
ªf_idx
[
li°
]) : -1;

64 
rFømeU
 = 
block
[1].
avaûabÀ


65 ? (
p_Vid
->
mb_d©a
[
block
[1].
mb_addr
].
mb_fõld


66 ? 
mv_öfo
[
block
[1].
pos_y
][block[1].
pos_x
].
ªf_idx
[
li°
] >>1

67 : 
mv_öfo
[
block
[1].
pos_y
][block[1].
pos_x
].
ªf_idx
[
li°
]) : -1;

68 
rFømeUR
 = 
block
[2].
avaûabÀ


69 ? (
p_Vid
->
mb_d©a
[
block
[2].
mb_addr
].
mb_fõld


70 ? 
mv_öfo
[
block
[2].
pos_y
][block[2].
pos_x
].
ªf_idx
[
li°
] >>1

71 : 
mv_öfo
[
block
[2].
pos_y
][block[2].
pos_x
].
ªf_idx
[
li°
]) : -1;

78 if(
rFømeL
 =
ªf_‰ame
 && 
rFømeU
 !ªf_‰amê&& 
rFømeUR
 !=Ñef_frame)

79 
mvPªdTy≥
 = 
MVPRED_L
;

80 if(
rFømeL
 !
ªf_‰ame
 && 
rFømeU
 =ªf_‰amê&& 
rFømeUR
 !=Ñef_frame)

81 
mvPªdTy≥
 = 
MVPRED_U
;

82 if(
rFømeL
 !
ªf_‰ame
 && 
rFømeU
 !ªf_‰amê&& 
rFømeUR
 ==Ñef_frame)

83 
mvPªdTy≥
 = 
MVPRED_UR
;

85 if(
blocksh≠e_x
 =8 && 
blocksh≠e_y
 == 16)

87 if(
mb_x
 == 0)

89 if(
rFømeL
 =
ªf_‰ame
)

90 
mvPªdTy≥
 = 
MVPRED_L
;

94 if–
rFømeUR
 =
ªf_‰ame
)

95 
mvPªdTy≥
 = 
MVPRED_UR
;

98 if(
blocksh≠e_x
 =16 && 
blocksh≠e_y
 == 8)

100 if(
mb_y
 == 0)

102 if(
rFømeU
 =
ªf_‰ame
)

103 
mvPªdTy≥
 = 
MVPRED_U
;

107 if(
rFømeL
 =
ªf_‰ame
)

108 
mvPªdTy≥
 = 
MVPRED_L
;

112 
hv
=0; hv < 2; hv++)

114 i‡(
hv
 == 0)

116 
mv_a
 = 
block
[0].
avaûabÀ
 ? 
mv_öfo
[block[0].
pos_y
][block[0].
pos_x
].
mv
[
li°
].
mv_x
 : 0;

117 
mv_b
 = 
block
[1].
avaûabÀ
 ? 
mv_öfo
[block[1].
pos_y
][block[1].
pos_x
].
mv
[
li°
].
mv_x
 : 0;

118 
mv_c
 = 
block
[2].
avaûabÀ
 ? 
mv_öfo
[block[2].
pos_y
][block[2].
pos_x
].
mv
[
li°
].
mv_x
 : 0;

122 i‡(
cuºMB
->
mb_fõld
)

124 
mv_a
 = 
block
[0].
avaûabÀ
 ? 
p_Vid
->
mb_d©a
[block[0].
mb_addr
].
mb_fõld


125 ? 
mv_öfo
[
block
[0].
pos_y
][block[0].
pos_x
].
mv
[
li°
].
mv_y


126 : 
mv_öfo
[
block
[0].
pos_y
][block[0].
pos_x
].
mv
[
li°
].
mv_y
 / 2

128 
mv_b
 = 
block
[1].
avaûabÀ
 ? 
p_Vid
->
mb_d©a
[block[1].
mb_addr
].
mb_fõld


129 ? 
mv_öfo
[
block
[1].
pos_y
][block[1].
pos_x
].
mv
[
li°
].
mv_y


130 : 
mv_öfo
[
block
[1].
pos_y
][block[1].
pos_x
].
mv
[
li°
].
mv_y
 / 2

132 
mv_c
 = 
block
[2].
avaûabÀ
 ? 
p_Vid
->
mb_d©a
[block[2].
mb_addr
].
mb_fõld


133 ? 
mv_öfo
[
block
[2].
pos_y
][block[2].
pos_x
].
mv
[
li°
].
mv_y


134 : 
mv_öfo
[
block
[2].
pos_y
][block[2].
pos_x
].
mv
[
li°
].
mv_y
 / 2

139 
mv_a
 = 
block
[0].
avaûabÀ
 ? 
p_Vid
->
mb_d©a
[block[0].
mb_addr
].
mb_fõld


140 ? 
mv_öfo
[
block
[0].
pos_y
][block[0].
pos_x
].
mv
[
li°
].
mv_y
 * 2

141 : 
mv_öfo
[
block
[0].
pos_y
][block[0].
pos_x
].
mv
[
li°
].
mv_y


143 
mv_b
 = 
block
[1].
avaûabÀ
 ? 
p_Vid
->
mb_d©a
[block[1].
mb_addr
].
mb_fõld


144 ? 
mv_öfo
[
block
[1].
pos_y
][block[1].
pos_x
].
mv
[
li°
].
mv_y
 * 2

145 : 
mv_öfo
[
block
[1].
pos_y
][block[1].
pos_x
].
mv
[
li°
].
mv_y


147 
mv_c
 = 
block
[2].
avaûabÀ
 ? 
p_Vid
->
mb_d©a
[block[2].
mb_addr
].
mb_fõld


148 ? 
mv_öfo
[
block
[2].
pos_y
][block[2].
pos_x
].
mv
[
li°
].
mv_y
 * 2

149 : 
mv_öfo
[
block
[2].
pos_y
][block[2].
pos_x
].
mv
[
li°
].
mv_y


154 
mvPªdTy≥
)

156 
MVPRED_MEDIAN
:

157 if(!(
block
[1].
avaûabÀ
 || block[2].available))

159 
¥ed_vec
 = 
mv_a
;

163 
¥ed_vec
 = 
	`imedün
(
mv_a
, 
mv_b
, 
mv_c
);

166 
MVPRED_L
:

167 
¥ed_vec
 = 
mv_a
;

169 
MVPRED_U
:

170 
¥ed_vec
 = 
mv_b
;

172 
MVPRED_UR
:

173 
¥ed_vec
 = 
mv_c
;

179 i‡(
hv
 == 0)

180 
pmv
->
mv_x
 = (Ë
¥ed_vec
;

182 
pmv
->
mv_y
 = (Ë
¥ed_vec
;

184 
	}
}

192 
	$GëMŸi⁄Ve˘‹Pªdi˘‹N‹mÆ
 (
Ma¸oblock
 *
cuºMB
,

193 
PixñPos
 *
block
,

194 
MŸi⁄Ve˘‹
 *
pmv
,

195 
ªf_‰ame
,

196 
PicMŸi⁄P¨ams
 **
mv_öfo
,

197 
li°
,

198 
mb_x
,

199 
mb_y
,

200 
blocksh≠e_x
,

201 
blocksh≠e_y
)

203 
mvPªdTy≥
 = 
MVPRED_MEDIAN
;

205 
rFømeL
 = 
block
[0].
avaûabÀ
 ? 
mv_öfo
[block[0].
pos_y
][block[0].
pos_x
].
ªf_idx
[
li°
] : -1;

206 
rFømeU
 = 
block
[1].
avaûabÀ
 ? 
mv_öfo
[block[1].
pos_y
][block[1].
pos_x
].
ªf_idx
[
li°
] : -1;

207 
rFømeUR
 = 
block
[2].
avaûabÀ
 ? 
mv_öfo
[block[2].
pos_y
][block[2].
pos_x
].
ªf_idx
[
li°
] : -1;

212 if(
rFømeL
 =
ªf_‰ame
 && 
rFømeU
 !ªf_‰amê&& 
rFømeUR
 !=Ñef_frame)

213 
mvPªdTy≥
 = 
MVPRED_L
;

214 if(
rFømeL
 !
ªf_‰ame
 && 
rFømeU
 =ªf_‰amê&& 
rFømeUR
 !=Ñef_frame)

215 
mvPªdTy≥
 = 
MVPRED_U
;

216 if(
rFømeL
 !
ªf_‰ame
 && 
rFømeU
 !ªf_‰amê&& 
rFømeUR
 ==Ñef_frame)

217 
mvPªdTy≥
 = 
MVPRED_UR
;

220 if(
blocksh≠e_x
 =8 && 
blocksh≠e_y
 == 16)

222 if(
mb_x
 == 0)

224 if(
rFømeL
 =
ªf_‰ame
)

225 
mvPªdTy≥
 = 
MVPRED_L
;

229 if(
rFømeUR
 =
ªf_‰ame
)

230 
mvPªdTy≥
 = 
MVPRED_UR
;

233 if(
blocksh≠e_x
 =16 && 
blocksh≠e_y
 == 8)

235 if(
mb_y
 == 0)

237 if(
rFømeU
 =
ªf_‰ame
)

238 
mvPªdTy≥
 = 
MVPRED_U
;

242 if(
rFømeL
 =
ªf_‰ame
)

243 
mvPªdTy≥
 = 
MVPRED_L
;

247 
mvPªdTy≥
)

249 
MVPRED_MEDIAN
:

250 if(!(
block
[1].
avaûabÀ
 || block[2].available))

252 i‡(
block
[0].
avaûabÀ
)

254 *
pmv
 = 
mv_öfo
[
block
[0].
pos_y
][block[0].
pos_x
].
mv
[
li°
];

258 *
pmv
 = 
zîo_mv
;

263 
MŸi⁄Ve˘‹
 *
mv_a
 = 
block
[0].
avaûabÀ
 ? &
mv_öfo
[block[0].
pos_y
][block[0].
pos_x
].
mv
[
li°
] : (MŸi⁄Ve˘‹ *Ë&
zîo_mv
;

264 
MŸi⁄Ve˘‹
 *
mv_b
 = 
block
[1].
avaûabÀ
 ? &
mv_öfo
[block[1].
pos_y
][block[1].
pos_x
].
mv
[
li°
] : (MŸi⁄Ve˘‹ *Ë&
zîo_mv
;

265 
MŸi⁄Ve˘‹
 *
mv_c
 = 
block
[2].
avaûabÀ
 ? &
mv_öfo
[block[2].
pos_y
][block[2].
pos_x
].
mv
[
li°
] : (MŸi⁄Ve˘‹ *Ë&
zîo_mv
;

267 
pmv
->
mv_x
 = (Ë
	`imedün
(
mv_a
->mv_x, 
mv_b
->mv_x, 
mv_c
->mv_x);

268 
pmv
->
mv_y
 = (Ë
	`imedün
(
mv_a
->mv_y, 
mv_b
->mv_y, 
mv_c
->mv_y);

271 
MVPRED_L
:

272 i‡(
block
[0].
avaûabÀ
)

274 *
pmv
 = 
mv_öfo
[
block
[0].
pos_y
][block[0].
pos_x
].
mv
[
li°
];

278 *
pmv
 = 
zîo_mv
;

281 
MVPRED_U
:

282 i‡(
block
[1].
avaûabÀ
)

284 *
pmv
 = 
mv_öfo
[
block
[1].
pos_y
][block[1].
pos_x
].
mv
[
li°
];

288 *
pmv
 = 
zîo_mv
;

291 
MVPRED_UR
:

292 i‡(
block
[2].
avaûabÀ
)

294 *
pmv
 = 
mv_öfo
[
block
[2].
pos_y
][block[2].
pos_x
].
mv
[
li°
];

298 *
pmv
 = 
zîo_mv
;

304 
	}
}

306 
	$öô_mŸi⁄_ve˘‹_¥edi˘i⁄
(
Ma¸oblock
 *
cuºMB
, 
mb_aff_‰ame_Êag
)

308 i‡(
mb_aff_‰ame_Êag
)

309 
cuºMB
->
GëMVPªdi˘‹
 = 
GëMŸi⁄Ve˘‹Pªdi˘‹MBAFF
;

311 
cuºMB
->
GëMVPªdi˘‹
 = 
GëMŸi⁄Ve˘‹Pªdi˘‹N‹mÆ
;

312 
	}
}

	@lcommon/src/nalucommon.c

15 
	~"globÆ.h
"

16 
	~"«lucomm⁄.h
"

17 
	~"memÆloc.h
"

31 
NALU_t
 *
	$AŒocNALU
(
buf„rsize
)

33 
NALU_t
 *
n
;

35 i‡((
n
 = (
NALU_t
*)
	`ˇŒoc
 (1,  (NALU_t))Ë=
NULL
)

36 
	`no_mem_exô
 ("AllocNALU:Ç");

38 
n
->
max_size
=
buf„rsize
;

39 i‡((
n
->
buf
 = (
byã
*)
	`ˇŒoc
 (
buf„rsize
,  (byã))Ë=
NULL
)

41 
	`‰ì
 (
n
);

42 
	`no_mem_exô
 ("AllocNALU:Ç->buf");

45  
n
;

46 
	}
}

59 
	$FªeNALU
(
NALU_t
 *
n
)

61 i‡(
n
 !
NULL
)

63 i‡(
n
->
buf
 !
NULL
)

65 
	`‰ì
(
n
->
buf
);

66 
n
->
buf
=
NULL
;

68 
	`‰ì
 (
n
);

70 
	}
}

	@lcommon/src/parsetcommon.c

16 
	~"globÆ.h
"

17 
	~"∑r£tcomm⁄.h
"

18 
	~"memÆloc.h
"

29 
pic_∑ømëî_£t_rb•_t
 *
	$AŒocPPS
 ()

31 
pic_∑ømëî_£t_rb•_t
 *
p
;

33 i‡((
p
=
	`ˇŒoc
 (1,  (
pic_∑ømëî_£t_rb•_t
))Ë=
NULL
)

34 
	`no_mem_exô
 ("AllocPPS: PPS");

35 
p
->
¶i˚_group_id
 = 
NULL
;

36  
p
;

37 
	}
}

50 
£q_∑ømëî_£t_rb•_t
 *
	$AŒocSPS
 ()

52 
£q_∑ømëî_£t_rb•_t
 *
p
;

54 i‡((
p
=
	`ˇŒoc
 (1,  (
£q_∑ømëî_£t_rb•_t
))Ë=
NULL
)

55 
	`no_mem_exô
 ("AllocSPS: SPS");

56  
p
;

57 
	}
}

70 
	$FªePPS
 (
pic_∑ømëî_£t_rb•_t
 *
µs
)

72 
	`as£π
 (
µs
 !
NULL
);

73 i‡(
µs
->
¶i˚_group_id
 !
NULL
)

74 
	`‰ì
 (
µs
->
¶i˚_group_id
);

75 
	`‰ì
 (
µs
);

76 
	}
}

89 
	$FªeSPS
 (
£q_∑ømëî_£t_rb•_t
 *
•s
)

91 
	`as£π
 (
•s
 !
NULL
);

92 
	`‰ì
 (
•s
);

93 
	}
}

96 
	$•s_is_equÆ
(
£q_∑ømëî_£t_rb•_t
 *
•s1
, seq_∑ømëî_£t_rb•_à*
•s2
)

98 
i
;

99 
equÆ
 = 1;

101 i‡((!
•s1
->
VÆid
Ë|| (!
•s2
->Valid))

104 
equÆ
 &(
•s1
->
¥ofûe_idc
 =
•s2
->profile_idc);

105 
equÆ
 &(
•s1
->
c⁄°øöed_£t0_Êag
 =
•s2
->constrained_set0_flag);

106 
equÆ
 &(
•s1
->
c⁄°øöed_£t1_Êag
 =
•s2
->constrained_set1_flag);

107 
equÆ
 &(
•s1
->
c⁄°øöed_£t2_Êag
 =
•s2
->constrained_set2_flag);

108 
equÆ
 &(
•s1
->
Àvñ_idc
 =
•s2
->level_idc);

109 
equÆ
 &(
•s1
->
£q_∑ømëî_£t_id
 =
•s2
->seq_parameter_set_id);

110 
equÆ
 &(
•s1
->
log2_max_‰ame_num_möus4
 =
•s2
->log2_max_frame_num_minus4);

111 
equÆ
 &(
•s1
->
pic_‹dî_˙t_ty≥
 =
•s2
->pic_order_cnt_type);

113 i‡(!
equÆ
) Équal;

115 if–
•s1
->
pic_‹dî_˙t_ty≥
 == 0 )

117 
equÆ
 &(
•s1
->
log2_max_pic_‹dî_˙t_lsb_möus4
 =
•s2
->log2_max_pic_order_cnt_lsb_minus4);

120 if–
•s1
->
pic_‹dî_˙t_ty≥
 == 1 )

122 
equÆ
 &(
•s1
->
dñè_pic_‹dî_Æways_zîo_Êag
 =
•s2
->delta_pic_order_always_zero_flag);

123 
equÆ
 &(
•s1
->
off£t_f‹_n⁄_ªf_pic
 =
•s2
->offset_for_non_ref_pic);

124 
equÆ
 &(
•s1
->
off£t_f‹_t›_to_bŸtom_fõld
 =
•s2
->offset_for_top_to_bottom_field);

125 
equÆ
 &(
•s1
->
num_ªf_‰ames_ö_pic_‹dî_˙t_cy˛e
 =
•s2
->num_ref_frames_in_pic_order_cnt_cycle);

126 i‡(!
equÆ
) Équal;

128  
i
 = 0 ; i< 
•s1
->
num_ªf_‰ames_ö_pic_‹dî_˙t_cy˛e
 ;i ++)

129 
equÆ
 &(
•s1
->
off£t_f‹_ªf_‰ame
[
i
] =
•s2
->offset_for_ref_frame[i]);

132 
equÆ
 &(
•s1
->
num_ªf_‰ames
 =
•s2
->num_ref_frames);

133 
equÆ
 &(
•s1
->
g≠s_ö_‰ame_num_vÆue_Ælowed_Êag
 =
•s2
->gaps_in_frame_num_value_allowed_flag);

134 
equÆ
 &(
•s1
->
pic_width_ö_mbs_möus1
 =
•s2
->pic_width_in_mbs_minus1);

135 
equÆ
 &(
•s1
->
pic_height_ö_m≠_unôs_möus1
 =
•s2
->pic_height_in_map_units_minus1);

136 
equÆ
 &(
•s1
->
‰ame_mbs_⁄ly_Êag
 =
•s2
->frame_mbs_only_flag);

138 i‡(!
equÆ
) Équal;

139 if–!
•s1
->
‰ame_mbs_⁄ly_Êag
 )

140 
equÆ
 &(
•s1
->
mb_ad≠tive_‰ame_fõld_Êag
 =
•s2
->mb_adaptive_frame_field_flag);

142 
equÆ
 &(
•s1
->
dúe˘_8x8_ö„ªn˚_Êag
 =
•s2
->direct_8x8_inference_flag);

143 
equÆ
 &(
•s1
->
‰ame_¸›pög_Êag
 =
•s2
->frame_cropping_flag);

144 i‡(!
equÆ
) Équal;

145 i‡(
•s1
->
‰ame_¸›pög_Êag
)

147 
equÆ
 &(
•s1
->
‰ame_¸›_À·_off£t
 =
•s2
->frame_crop_left_offset);

148 
equÆ
 &(
•s1
->
‰ame_¸›_right_off£t
 =
•s2
->frame_crop_right_offset);

149 
equÆ
 &(
•s1
->
‰ame_¸›_t›_off£t
 =
•s2
->frame_crop_top_offset);

150 
equÆ
 &(
•s1
->
‰ame_¸›_bŸtom_off£t
 =
•s2
->frame_crop_bottom_offset);

152 
equÆ
 &(
•s1
->
vui_∑ømëîs_¥e£¡_Êag
 =
•s2
->vui_parameters_present_flag);

154  
equÆ
;

155 
	}
}

157 
	$µs_is_equÆ
(
pic_∑ømëî_£t_rb•_t
 *
µs1
,Öic_∑ømëî_£t_rb•_à*
µs2
)

159 
i
, 
j
;

160 
equÆ
 = 1;

162 i‡((!
µs1
->
VÆid
Ë|| (!
µs2
->Valid))

165 
equÆ
 &(
µs1
->
pic_∑ømëî_£t_id
 =
µs2
->pic_parameter_set_id);

166 
equÆ
 &(
µs1
->
£q_∑ømëî_£t_id
 =
µs2
->seq_parameter_set_id);

167 
equÆ
 &(
µs1
->
íå›y_codög_mode_Êag
 =
µs2
->entropy_coding_mode_flag);

168 
equÆ
 &(
µs1
->
bŸtom_fõld_pic_‹dî_ö_‰ame_¥e£¡_Êag
 =
µs2
->bottom_field_pic_order_in_frame_present_flag);

169 
equÆ
 &(
µs1
->
num_¶i˚_groups_möus1
 =
µs2
->num_slice_groups_minus1);

171 i‡(!
equÆ
) Équal;

173 i‡(
µs1
->
num_¶i˚_groups_möus1
>0)

175 
equÆ
 &(
µs1
->
¶i˚_group_m≠_ty≥
 =
µs2
->slice_group_map_type);

176 i‡(!
equÆ
) Équal;

177 i‡(
µs1
->
¶i˚_group_m≠_ty≥
 == 0)

179 
i
=0; i<=
µs1
->
num_¶i˚_groups_möus1
; i++)

180 
equÆ
 &(
µs1
->
run_Àngth_möus1
[
i
] =
µs2
->run_length_minus1[i]);

182 if–
µs1
->
¶i˚_group_m≠_ty≥
 == 2 )

184 
i
=0; i<
µs1
->
num_¶i˚_groups_möus1
; i++)

186 
equÆ
 &(
µs1
->
t›_À·
[
i
] =
µs2
->top_left[i]);

187 
equÆ
 &(
µs1
->
bŸtom_right
[
i
] =
µs2
->bottom_right[i]);

190 if–
µs1
->
¶i˚_group_m≠_ty≥
 == 3 ||Öps1->slice_group_map_type==4 ||Öps1->slice_group_map_type==5 )

192 
equÆ
 &(
µs1
->
¶i˚_group_ch™ge_dúe˘i⁄_Êag
 =
µs2
->slice_group_change_direction_flag);

193 
equÆ
 &(
µs1
->
¶i˚_group_ch™ge_øã_möus1
 =
µs2
->slice_group_change_rate_minus1);

195 if–
µs1
->
¶i˚_group_m≠_ty≥
 == 6 )

197 
equÆ
 &(
µs1
->
pic_size_ö_m≠_unôs_möus1
 =
µs2
->pic_size_in_map_units_minus1);

198 i‡(!
equÆ
) Équal;

199 
i
=0; i<=
µs1
->
pic_size_ö_m≠_unôs_möus1
; i++)

200 
equÆ
 &(
µs1
->
¶i˚_group_id
[
i
] =
µs2
->slice_group_id[i]);

204 
equÆ
 &(
µs1
->
num_ªf_idx_l0_deÁu…_a˘ive_möus1
 =
µs2
->num_ref_idx_l0_default_active_minus1);

205 
equÆ
 &(
µs1
->
num_ªf_idx_l1_deÁu…_a˘ive_möus1
 =
µs2
->num_ref_idx_l1_default_active_minus1);

206 
equÆ
 &(
µs1
->
weighãd_¥ed_Êag
 =
µs2
->weighted_pred_flag);

207 
equÆ
 &(
µs1
->
weighãd_bùªd_idc
 =
µs2
->weighted_bipred_idc);

208 
equÆ
 &(
µs1
->
pic_öô_qp_möus26
 =
µs2
->pic_init_qp_minus26);

209 
equÆ
 &(
µs1
->
pic_öô_qs_möus26
 =
µs2
->pic_init_qs_minus26);

210 
equÆ
 &(
µs1
->
chroma_qp_ödex_off£t
 =
µs2
->chroma_qp_index_offset);

211 
equÆ
 &(
µs1
->
deblockög_fûãr_c⁄åﬁ_¥e£¡_Êag
 =
µs2
->deblocking_filter_control_present_flag);

212 
equÆ
 &(
µs1
->
c⁄°øöed_öåa_¥ed_Êag
 =
µs2
->constrained_intra_pred_flag);

213 
equÆ
 &(
µs1
->
ªdund™t_pic_˙t_¥e£¡_Êag
 =
µs2
->redundant_pic_cnt_present_flag);

215 i‡(!
equÆ
) Équal;

219 
equÆ
 &(
µs1
->
å™sf‹m_8x8_mode_Êag
 =
µs2
->transform_8x8_mode_flag);

220 
equÆ
 &(
µs1
->
pic_sˇlög_m©rix_¥e£¡_Êag
 =
µs2
->pic_scaling_matrix_present_flag);

221 if(
µs1
->
pic_sˇlög_m©rix_¥e£¡_Êag
)

223 
i
 = 0; i < (6 + (()
µs1
->
å™sf‹m_8x8_mode_Êag
 << 1)); i++)

225 
equÆ
 &(
µs1
->
pic_sˇlög_li°_¥e£¡_Êag
[
i
] =
µs2
->pic_scaling_list_present_flag[i]);

226 if(
µs1
->
pic_sˇlög_li°_¥e£¡_Êag
[
i
])

228 if(
i
 < 6)

230 
j
 = 0; j < 16; j++)

231 
equÆ
 &(
µs1
->
SˇlögLi°4x4
[
i
][
j
] =
µs2
->ScalingList4x4[i][j]);

235 
j
 = 0; j < 64; j++)

236 
equÆ
 &(
µs1
->
SˇlögLi°8x8
[
i
-6][
j
] =
µs2
->ScalingList8x8[i-6][j]);

241 
equÆ
 &(
µs1
->
£c⁄d_chroma_qp_ödex_off£t
 =
µs2
->second_chroma_qp_index_offset);

243  
equÆ
;

244 
	}
}

	@lcommon/src/transform.c

16 
	~"globÆ.h
"

17 
	~"å™sf‹m.h
"

20 
	$f‹w¨d4x4
(**
block
, **
tblock
, 
pos_y
, 
pos_x
)

22 
i
, 
ii
;

23 
tmp
[16];

24 *
pTmp
 = 
tmp
, *
pblock
;

25 
p0
,
p1
,
p2
,
p3
;

26 
t0
,
t1
,
t2
,
t3
;

29 
i
=
pos_y
; i <Öos_y + 
BLOCK_SIZE
; i++)

31 
pblock
 = &
block
[
i
][
pos_x
];

32 
p0
 = *(
pblock
++);

33 
p1
 = *(
pblock
++);

34 
p2
 = *(
pblock
++);

35 
p3
 = *(
pblock
 );

37 
t0
 = 
p0
 + 
p3
;

38 
t1
 = 
p1
 + 
p2
;

39 
t2
 = 
p1
 - 
p2
;

40 
t3
 = 
p0
 - 
p3
;

42 *(
pTmp
++Ë
t0
 + 
t1
;

43 *(
pTmp
++Ë(
t3
 << 1Ë+ 
t2
;

44 *(
pTmp
++Ë
t0
 - 
t1
;

45 *(
pTmp
++Ë
t3
 - (
t2
 << 1);

49 
i
=0; i < 
BLOCK_SIZE
; i++)

51 
pTmp
 = 
tmp
 + 
i
;

52 
p0
 = *
pTmp
;

53 
p1
 = *(
pTmp
 +
BLOCK_SIZE
);

54 
p2
 = *(
pTmp
 +
BLOCK_SIZE
);

55 
p3
 = *(
pTmp
 +
BLOCK_SIZE
);

57 
t0
 = 
p0
 + 
p3
;

58 
t1
 = 
p1
 + 
p2
;

59 
t2
 = 
p1
 - 
p2
;

60 
t3
 = 
p0
 - 
p3
;

62 
ii
 = 
pos_x
 + 
i
;

63 
tblock
[
pos_y
 ][
ii
] = 
t0
 + 
t1
;

64 
tblock
[
pos_y
 + 1][
ii
] = 
t2
 + (
t3
 << 1);

65 
tblock
[
pos_y
 + 2][
ii
] = 
t0
 - 
t1
;

66 
tblock
[
pos_y
 + 3][
ii
] = 
t3
 - (
t2
 << 1);

68 
	}
}

70 
	$övî£4x4
(**
tblock
, **
block
, 
pos_y
, 
pos_x
)

72 
i
, 
ii
;

73 
tmp
[16];

74 *
pTmp
 = 
tmp
, *
pblock
;

75 
p0
,
p1
,
p2
,
p3
;

76 
t0
,
t1
,
t2
,
t3
;

79 
i
 = 
pos_y
; i <Öos_y + 
BLOCK_SIZE
; i++)

81 
pblock
 = &
tblock
[
i
][
pos_x
];

82 
t0
 = *(
pblock
++);

83 
t1
 = *(
pblock
++);

84 
t2
 = *(
pblock
++);

85 
t3
 = *(
pblock
 );

87 
p0
 = 
t0
 + 
t2
;

88 
p1
 = 
t0
 - 
t2
;

89 
p2
 = (
t1
 >> 1Ë- 
t3
;

90 
p3
 = 
t1
 + (
t3
 >> 1);

92 *(
pTmp
++Ë
p0
 + 
p3
;

93 *(
pTmp
++Ë
p1
 + 
p2
;

94 *(
pTmp
++Ë
p1
 - 
p2
;

95 *(
pTmp
++Ë
p0
 - 
p3
;

99 
i
 = 0; i < 
BLOCK_SIZE
; i++)

101 
pTmp
 = 
tmp
 + 
i
;

102 
t0
 = *
pTmp
;

103 
t1
 = *(
pTmp
 +
BLOCK_SIZE
);

104 
t2
 = *(
pTmp
 +
BLOCK_SIZE
);

105 
t3
 = *(
pTmp
 +
BLOCK_SIZE
);

107 
p0
 = 
t0
 + 
t2
;

108 
p1
 = 
t0
 - 
t2
;

109 
p2
 =(
t1
 >> 1Ë- 
t3
;

110 
p3
 = 
t1
 + (
t3
 >> 1);

112 
ii
 = 
i
 + 
pos_x
;

113 
block
[
pos_y
 ][
ii
] = 
p0
 + 
p3
;

114 
block
[
pos_y
 + 1][
ii
] = 
p1
 + 
p2
;

115 
block
[
pos_y
 + 2][
ii
] = 
p1
 - 
p2
;

116 
block
[
pos_y
 + 3][
ii
] = 
p0
 - 
p3
;

118 
	}
}

121 
	$hadam¨d4x4
(**
block
, **
tblock
)

123 
i
;

124 
tmp
[16];

125 *
pTmp
 = 
tmp
, *
pblock
;

126 
p0
,
p1
,
p2
,
p3
;

127 
t0
,
t1
,
t2
,
t3
;

130 
i
 = 0; i < 
BLOCK_SIZE
; i++)

132 
pblock
 = 
block
[
i
];

133 
p0
 = *(
pblock
++);

134 
p1
 = *(
pblock
++);

135 
p2
 = *(
pblock
++);

136 
p3
 = *(
pblock
 );

138 
t0
 = 
p0
 + 
p3
;

139 
t1
 = 
p1
 + 
p2
;

140 
t2
 = 
p1
 - 
p2
;

141 
t3
 = 
p0
 - 
p3
;

143 *(
pTmp
++Ë
t0
 + 
t1
;

144 *(
pTmp
++Ë
t3
 + 
t2
;

145 *(
pTmp
++Ë
t0
 - 
t1
;

146 *(
pTmp
++Ë
t3
 - 
t2
;

150 
i
 = 0; i < 
BLOCK_SIZE
; i++)

152 
pTmp
 = 
tmp
 + 
i
;

153 
p0
 = *
pTmp
;

154 
p1
 = *(
pTmp
 +
BLOCK_SIZE
);

155 
p2
 = *(
pTmp
 +
BLOCK_SIZE
);

156 
p3
 = *(
pTmp
 +
BLOCK_SIZE
);

158 
t0
 = 
p0
 + 
p3
;

159 
t1
 = 
p1
 + 
p2
;

160 
t2
 = 
p1
 - 
p2
;

161 
t3
 = 
p0
 - 
p3
;

163 
tblock
[0][
i
] = (
t0
 + 
t1
) >> 1;

164 
tblock
[1][
i
] = (
t2
 + 
t3
) >> 1;

165 
tblock
[2][
i
] = (
t0
 - 
t1
) >> 1;

166 
tblock
[3][
i
] = (
t3
 - 
t2
) >> 1;

168 
	}
}

171 
	$ihadam¨d4x4
(**
tblock
, **
block
)

173 
i
;

174 
tmp
[16];

175 *
pTmp
 = 
tmp
, *
pblock
;

176 
p0
,
p1
,
p2
,
p3
;

177 
t0
,
t1
,
t2
,
t3
;

180 
i
 = 0; i < 
BLOCK_SIZE
; i++)

182 
pblock
 = 
tblock
[
i
];

183 
t0
 = *(
pblock
++);

184 
t1
 = *(
pblock
++);

185 
t2
 = *(
pblock
++);

186 
t3
 = *(
pblock
 );

188 
p0
 = 
t0
 + 
t2
;

189 
p1
 = 
t0
 - 
t2
;

190 
p2
 = 
t1
 - 
t3
;

191 
p3
 = 
t1
 + 
t3
;

193 *(
pTmp
++Ë
p0
 + 
p3
;

194 *(
pTmp
++Ë
p1
 + 
p2
;

195 *(
pTmp
++Ë
p1
 - 
p2
;

196 *(
pTmp
++Ë
p0
 - 
p3
;

200 
i
 = 0; i < 
BLOCK_SIZE
; i++)

202 
pTmp
 = 
tmp
 + 
i
;

203 
t0
 = *
pTmp
;

204 
t1
 = *(
pTmp
 +
BLOCK_SIZE
);

205 
t2
 = *(
pTmp
 +
BLOCK_SIZE
);

206 
t3
 = *(
pTmp
 +
BLOCK_SIZE
);

208 
p0
 = 
t0
 + 
t2
;

209 
p1
 = 
t0
 - 
t2
;

210 
p2
 = 
t1
 - 
t3
;

211 
p3
 = 
t1
 + 
t3
;

213 
block
[0][
i
] = 
p0
 + 
p3
;

214 
block
[1][
i
] = 
p1
 + 
p2
;

215 
block
[2][
i
] = 
p1
 - 
p2
;

216 
block
[3][
i
] = 
p0
 - 
p3
;

218 
	}
}

220 
	$hadam¨d4x2
(**
block
, **
tblock
)

222 
i
;

223 
tmp
[8];

224 *
pTmp
 = 
tmp
;

225 
p0
,
p1
,
p2
,
p3
;

226 
t0
,
t1
,
t2
,
t3
;

229 *(
pTmp
++Ë
block
[0][0] + block[1][0];

230 *(
pTmp
++Ë
block
[0][1] + block[1][1];

231 *(
pTmp
++Ë
block
[0][2] + block[1][2];

232 *(
pTmp
++Ë
block
[0][3] + block[1][3];

234 *(
pTmp
++Ë
block
[0][0] - block[1][0];

235 *(
pTmp
++Ë
block
[0][1] - block[1][1];

236 *(
pTmp
++Ë
block
[0][2] - block[1][2];

237 *(
pTmp
 ) = 
block
[0][3] - block[1][3];

240 
pTmp
 = 
tmp
;

241 
i
=0;i<2;i++)

243 
p0
 = *(
pTmp
++);

244 
p1
 = *(
pTmp
++);

245 
p2
 = *(
pTmp
++);

246 
p3
 = *(
pTmp
++);

248 
t0
 = 
p0
 + 
p3
;

249 
t1
 = 
p1
 + 
p2
;

250 
t2
 = 
p1
 - 
p2
;

251 
t3
 = 
p0
 - 
p3
;

253 
tblock
[
i
][0] = (
t0
 + 
t1
);

254 
tblock
[
i
][1] = (
t3
 + 
t2
);

255 
tblock
[
i
][2] = (
t0
 - 
t1
);

256 
tblock
[
i
][3] = (
t3
 - 
t2
);

258 
	}
}

260 
	$ihadam¨d4x2
(**
tblock
, **
block
)

262 
i
;

263 
tmp
[8];

264 *
pTmp
 = 
tmp
;

265 
p0
,
p1
,
p2
,
p3
;

266 
t0
,
t1
,
t2
,
t3
;

269 *(
pTmp
++Ë
tblock
[0][0] +Åblock[1][0];

270 *(
pTmp
++Ë
tblock
[0][1] +Åblock[1][1];

271 *(
pTmp
++Ë
tblock
[0][2] +Åblock[1][2];

272 *(
pTmp
++Ë
tblock
[0][3] +Åblock[1][3];

274 *(
pTmp
++Ë
tblock
[0][0] -Åblock[1][0];

275 *(
pTmp
++Ë
tblock
[0][1] -Åblock[1][1];

276 *(
pTmp
++Ë
tblock
[0][2] -Åblock[1][2];

277 *(
pTmp
 ) = 
tblock
[0][3] -Åblock[1][3];

280 
pTmp
 = 
tmp
;

281 
i
 = 0; i < 2; i++)

283 
p0
 = *(
pTmp
++);

284 
p1
 = *(
pTmp
++);

285 
p2
 = *(
pTmp
++);

286 
p3
 = *(
pTmp
++);

288 
t0
 = 
p0
 + 
p2
;

289 
t1
 = 
p0
 - 
p2
;

290 
t2
 = 
p1
 - 
p3
;

291 
t3
 = 
p1
 + 
p3
;

294 
block
[0][
i
] = 
t0
 + 
t3
;

295 
block
[1][
i
] = 
t1
 + 
t2
;

296 
block
[2][
i
] = 
t1
 - 
t2
;

297 
block
[3][
i
] = 
t0
 - 
t3
;

299 
	}
}

302 
	$hadam¨d2x2
(**
block
, 
tblock
[4])

304 
p0
,
p1
,
p2
,
p3
;

306 
p0
 = 
block
[0][0] + block[0][4];

307 
p1
 = 
block
[0][0] - block[0][4];

308 
p2
 = 
block
[4][0] + block[4][4];

309 
p3
 = 
block
[4][0] - block[4][4];

311 
tblock
[0] = (
p0
 + 
p2
);

312 
tblock
[1] = (
p1
 + 
p3
);

313 
tblock
[2] = (
p0
 - 
p2
);

314 
tblock
[3] = (
p1
 - 
p3
);

315 
	}
}

317 
	$ihadam¨d2x2
(
tblock
[4], 
block
[4])

319 
t0
,
t1
,
t2
,
t3
;

321 
t0
 = 
tblock
[0] +Åblock[1];

322 
t1
 = 
tblock
[0] -Åblock[1];

323 
t2
 = 
tblock
[2] +Åblock[3];

324 
t3
 = 
tblock
[2] -Åblock[3];

326 
block
[0] = (
t0
 + 
t2
);

327 
block
[1] = (
t1
 + 
t3
);

328 
block
[2] = (
t0
 - 
t2
);

329 
block
[3] = (
t1
 - 
t3
);

330 
	}
}

353 
	$f‹w¨d8x8
(**
block
, **
tblock
, 
pos_y
, 
pos_x
)

355 
i
, 
ii
;

356 
tmp
[64];

357 *
pTmp
 = 
tmp
, *
pblock
;

358 
a0
, 
a1
, 
a2
, 
a3
;

359 
p0
, 
p1
, 
p2
, 
p3
, 
p4
, 
p5
 ,
p6
, 
p7
;

360 
b0
, 
b1
, 
b2
, 
b3
, 
b4
, 
b5
, 
b6
, 
b7
;

363 
i
=
pos_y
; i <Öos_y + 
BLOCK_SIZE_8x8
; i++)

365 
pblock
 = &
block
[
i
][
pos_x
];

366 
p0
 = *(
pblock
++);

367 
p1
 = *(
pblock
++);

368 
p2
 = *(
pblock
++);

369 
p3
 = *(
pblock
++);

370 
p4
 = *(
pblock
++);

371 
p5
 = *(
pblock
++);

372 
p6
 = *(
pblock
++);

373 
p7
 = *(
pblock
 );

375 
a0
 = 
p0
 + 
p7
;

376 
a1
 = 
p1
 + 
p6
;

377 
a2
 = 
p2
 + 
p5
;

378 
a3
 = 
p3
 + 
p4
;

380 
b0
 = 
a0
 + 
a3
;

381 
b1
 = 
a1
 + 
a2
;

382 
b2
 = 
a0
 - 
a3
;

383 
b3
 = 
a1
 - 
a2
;

385 
a0
 = 
p0
 - 
p7
;

386 
a1
 = 
p1
 - 
p6
;

387 
a2
 = 
p2
 - 
p5
;

388 
a3
 = 
p3
 - 
p4
;

390 
b4
 = 
a1
 + 
a2
 + ((
a0
 >> 1) +á0);

391 
b5
 = 
a0
 - 
a3
 - ((
a2
 >> 1) +á2);

392 
b6
 = 
a0
 + 
a3
 - ((
a1
 >> 1) +á1);

393 
b7
 = 
a1
 - 
a2
 + ((
a3
 >> 1) +á3);

395 *(
pTmp
++Ë
b0
 + 
b1
;

396 *(
pTmp
++Ë
b4
 + (
b7
 >> 2);

397 *(
pTmp
++Ë
b2
 + (
b3
 >> 1);

398 *(
pTmp
++Ë
b5
 + (
b6
 >> 2);

399 *(
pTmp
++Ë
b0
 - 
b1
;

400 *(
pTmp
++Ë
b6
 - (
b5
 >> 2);

401 *(
pTmp
++Ë(
b2
 >> 1Ë- 
b3
;

402 *(
pTmp
++Ë(
b4
 >> 2Ë- 
b7
;

406 
i
=0; i < 
BLOCK_SIZE_8x8
; i++)

408 
pTmp
 = 
tmp
 + 
i
;

409 
p0
 = *
pTmp
;

410 
p1
 = *(
pTmp
 +
BLOCK_SIZE_8x8
);

411 
p2
 = *(
pTmp
 +
BLOCK_SIZE_8x8
);

412 
p3
 = *(
pTmp
 +
BLOCK_SIZE_8x8
);

413 
p4
 = *(
pTmp
 +
BLOCK_SIZE_8x8
);

414 
p5
 = *(
pTmp
 +
BLOCK_SIZE_8x8
);

415 
p6
 = *(
pTmp
 +
BLOCK_SIZE_8x8
);

416 
p7
 = *(
pTmp
 +
BLOCK_SIZE_8x8
);

418 
a0
 = 
p0
 + 
p7
;

419 
a1
 = 
p1
 + 
p6
;

420 
a2
 = 
p2
 + 
p5
;

421 
a3
 = 
p3
 + 
p4
;

423 
b0
 = 
a0
 + 
a3
;

424 
b1
 = 
a1
 + 
a2
;

425 
b2
 = 
a0
 - 
a3
;

426 
b3
 = 
a1
 - 
a2
;

428 
a0
 = 
p0
 - 
p7
;

429 
a1
 = 
p1
 - 
p6
;

430 
a2
 = 
p2
 - 
p5
;

431 
a3
 = 
p3
 - 
p4
;

433 
b4
 = 
a1
 + 
a2
 + ((
a0
 >> 1) +á0);

434 
b5
 = 
a0
 - 
a3
 - ((
a2
 >> 1) +á2);

435 
b6
 = 
a0
 + 
a3
 - ((
a1
 >> 1) +á1);

436 
b7
 = 
a1
 - 
a2
 + ((
a3
 >> 1) +á3);

438 
ii
 = 
pos_x
 + 
i
;

439 
tblock
[
pos_y
 ][
ii
] = 
b0
 + 
b1
;

440 
tblock
[
pos_y
 + 1][
ii
] = 
b4
 + (
b7
 >> 2);

441 
tblock
[
pos_y
 + 2][
ii
] = 
b2
 + (
b3
 >> 1);

442 
tblock
[
pos_y
 + 3][
ii
] = 
b5
 + (
b6
 >> 2);

443 
tblock
[
pos_y
 + 4][
ii
] = 
b0
 - 
b1
;

444 
tblock
[
pos_y
 + 5][
ii
] = 
b6
 - (
b5
 >> 2);

445 
tblock
[
pos_y
 + 6][
ii
] = (
b2
 >> 1Ë- 
b3
;

446 
tblock
[
pos_y
 + 7][
ii
] = (
b4
 >> 2Ë- 
b7
;

448 
	}
}

450 
	$övî£8x8
(**
tblock
, **
block
, 
pos_x
)

452 
i
, 
ii
;

453 
tmp
[64];

454 *
pTmp
 = 
tmp
, *
pblock
;

455 
a0
, 
a1
, 
a2
, 
a3
;

456 
p0
, 
p1
, 
p2
, 
p3
, 
p4
, 
p5
 ,
p6
, 
p7
;

457 
b0
, 
b1
, 
b2
, 
b3
, 
b4
, 
b5
, 
b6
, 
b7
;

460 
i
=0; i < 
BLOCK_SIZE_8x8
; i++)

462 
pblock
 = &
tblock
[
i
][
pos_x
];

463 
p0
 = *(
pblock
++);

464 
p1
 = *(
pblock
++);

465 
p2
 = *(
pblock
++);

466 
p3
 = *(
pblock
++);

467 
p4
 = *(
pblock
++);

468 
p5
 = *(
pblock
++);

469 
p6
 = *(
pblock
++);

470 
p7
 = *(
pblock
 );

472 
a0
 = 
p0
 + 
p4
;

473 
a1
 = 
p0
 - 
p4
;

474 
a2
 = 
p6
 - (
p2
 >> 1);

475 
a3
 = 
p2
 + (
p6
 >> 1);

477 
b0
 = 
a0
 + 
a3
;

478 
b2
 = 
a1
 - 
a2
;

479 
b4
 = 
a1
 + 
a2
;

480 
b6
 = 
a0
 - 
a3
;

482 
a0
 = -
p3
 + 
p5
 - 
p7
 - (p7 >> 1);

483 
a1
 = 
p1
 + 
p7
 - 
p3
 - (p3 >> 1);

484 
a2
 = -
p1
 + 
p7
 + 
p5
 + (p5 >> 1);

485 
a3
 = 
p3
 + 
p5
 + 
p1
 + (p1 >> 1);

488 
b1
 = 
a0
 + (
a3
>>2);

489 
b3
 = 
a1
 + (
a2
>>2);

490 
b5
 = 
a2
 - (
a1
>>2);

491 
b7
 = 
a3
 - (
a0
>>2);

493 *(
pTmp
++Ë
b0
 + 
b7
;

494 *(
pTmp
++Ë
b2
 - 
b5
;

495 *(
pTmp
++Ë
b4
 + 
b3
;

496 *(
pTmp
++Ë
b6
 + 
b1
;

497 *(
pTmp
++Ë
b6
 - 
b1
;

498 *(
pTmp
++Ë
b4
 - 
b3
;

499 *(
pTmp
++Ë
b2
 + 
b5
;

500 *(
pTmp
++Ë
b0
 - 
b7
;

504 
i
=0; i < 
BLOCK_SIZE_8x8
; i++)

506 
pTmp
 = 
tmp
 + 
i
;

507 
p0
 = *
pTmp
;

508 
p1
 = *(
pTmp
 +
BLOCK_SIZE_8x8
);

509 
p2
 = *(
pTmp
 +
BLOCK_SIZE_8x8
);

510 
p3
 = *(
pTmp
 +
BLOCK_SIZE_8x8
);

511 
p4
 = *(
pTmp
 +
BLOCK_SIZE_8x8
);

512 
p5
 = *(
pTmp
 +
BLOCK_SIZE_8x8
);

513 
p6
 = *(
pTmp
 +
BLOCK_SIZE_8x8
);

514 
p7
 = *(
pTmp
 +
BLOCK_SIZE_8x8
);

516 
a0
 = 
p0
 + 
p4
;

517 
a1
 = 
p0
 - 
p4
;

518 
a2
 = 
p6
 - (
p2
>>1);

519 
a3
 = 
p2
 + (
p6
>>1);

521 
b0
 = 
a0
 + 
a3
;

522 
b2
 = 
a1
 - 
a2
;

523 
b4
 = 
a1
 + 
a2
;

524 
b6
 = 
a0
 - 
a3
;

526 
a0
 = -
p3
 + 
p5
 - 
p7
 - (p7 >> 1);

527 
a1
 = 
p1
 + 
p7
 - 
p3
 - (p3 >> 1);

528 
a2
 = -
p1
 + 
p7
 + 
p5
 + (p5 >> 1);

529 
a3
 = 
p3
 + 
p5
 + 
p1
 + (p1 >> 1);

532 
b1
 = 
a0
 + (
a3
 >> 2);

533 
b7
 = 
a3
 - (
a0
 >> 2);

534 
b3
 = 
a1
 + (
a2
 >> 2);

535 
b5
 = 
a2
 - (
a1
 >> 2);

537 
ii
 = 
i
 + 
pos_x
;

538 
block
[0][
ii
] = 
b0
 + 
b7
;

539 
block
[1][
ii
] = 
b2
 - 
b5
;

540 
block
[2][
ii
] = 
b4
 + 
b3
;

541 
block
[3][
ii
] = 
b6
 + 
b1
;

542 
block
[4][
ii
] = 
b6
 - 
b1
;

543 
block
[5][
ii
] = 
b4
 - 
b3
;

544 
block
[6][
ii
] = 
b2
 + 
b5
;

545 
block
[7][
ii
] = 
b0
 - 
b7
;

547 
	}
}

	@lcommon/src/win32.c

15 
	~"globÆ.h
"

18 #ifde‡
_WIN32


20 
LARGE_INTEGER
 
	g‰eq
;

22 
	$gëtime
(
TIME_T
* 
time
)

24 #i‚de‡
TIMING_DISABLE


25 
	`QuîyPîf‹m™˚Cou¡î
(
time
);

27 
	}
}

29 
öt64
 
	$timediff
(
TIME_T
* 
°¨t
, TIME_T* 
íd
)

31 #i‚de‡
TIMING_DISABLE


32  (
öt64
)((
íd
->
QuadP¨t
 - 
°¨t
->QuadPart));

36 
	}
}

38 
	$öô_time
()

40 
	`QuîyPîf‹m™˚Fªquícy
(&
‰eq
);

41 
	}
}

43 
öt64
 
	$timí‹m
(
öt64
 
cur_time
)

45 #i‚de‡
TIMING_DISABLE


46  (
öt64
)(
cur_time
 * 1000 /(
‰eq
.
QuadP¨t
));

50 
	}
}

54 
timez⁄e
 
	gtz
;

56 
	$gëtime
(
TIME_T
* 
time
)

58 
	`gëtimeofday
(
time
, &
tz
);

59 
	}
}

61 
	$öô_time
()

63 
	}
}

65 
öt64
 
	$timediff
(
TIME_T
* 
°¨t
, TIME_T* 
íd
)

67 
t1
, 
t2
;

69 
t1
 = 
íd
->
tv_£c
 - 
°¨t
->tv_sec;

70 
t2
 = 
íd
->
tv_u£c
 - 
°¨t
->tv_usec;

71  (
öt64
Ë
t2
 + (öt64Ë
t1
 * (int64) 1000000;

72 
	}
}

74 
öt64
 
	$timí‹m
(
öt64
 
cur_time
)

76  (
öt64
)(
cur_time
 / (int64) 1000);

77 
	}
}

	@ldecod/inc/annexb.h

12 #i‚de‡
_ANNEXB_H_


13 
	#_ANNEXB_H_


	)

15 
	~"«lucomm⁄.h
"

17 
	s™√x_b_°ru˘


19 
	mBôSåómFûe
;

20 
byã
 *
	miobuf„r
;

21 
byã
 *
	miobuf„ºód
;

22 
	mbyãsöbuf„r
;

23 
	mis_eof
;

24 
	miIOBuf„rSize
;

26 
	mIsFú°ByãSåómNALU
;

27 
	m√xt°¨tcodebyãs
;

28 
byã
 *
	mBuf
;

29 } 
	tANNEXB_t
;

31 
gë_™√x_b_NALU
 (
VideoP¨amëîs
 *
p_Vid
, 
NALU_t
 *
«lu
, 
ANNEXB_t
 *
™√x_b
);

33 
›í_™√x_b
 (*
‚
, 
ANNEXB_t
 *
™√x_b
);

34 
˛o£_™√x_b
 (
ANNEXB_t
 *
™√x_b
);

35 
mÆloc_™√x_b
 (
VideoP¨amëîs
 *
p_Vid
, 
ANNEXB_t
 **
p_™√x_b
);

36 
‰ì_™√x_b
 (
ANNEXB_t
 **
p_™√x_b
);

37 
öô_™√x_b
 (
ANNEXB_t
 *
™√x_b
);

38 
ª£t_™√x_b
 (
ANNEXB_t
 *
™√x_b
);

	@ldecod/inc/biaridecod.h

20 #i‚de‡
_BIARIDECOD_H_


21 
	#_BIARIDECOD_H_


	)

30 c⁄° 
byã
 
	grLPS_èbÀ_64x4
[64][4]=

99 c⁄° 
byã
 
	gAC_√xt_°©e_MPS_64
[64] =

111 c⁄° 
byã
 
	gAC_√xt_°©e_LPS_64
[64] =

122 c⁄° 
byã
 
	gªn‹m_èbÀ_32
[32]={6,5,4,4,3,3,3,3,2,2,2,2,2,2,2,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1};

125 
¨ideco_°¨t_decodög
(
DecodögEnvú⁄mítPå
 
ìp
, *
code_buf„r
, 
fú°byã
, *
code_Àn
);

126 
¨ideco_bôs_ªad
(
DecodögEnvú⁄mítPå
 
dï
);

127 
¨ideco_d⁄e_decodög
(
DecodögEnvú⁄mítPå
 
dï
);

128 
büri_öô_c⁄ãxt
 (
qp
, 
BiC⁄ãxtTy≥På
 
˘x
, c⁄° * 
öi
);

129 
büri_decode_symbﬁ
(
DecodögEnvú⁄mít
 *
dï
, 
BiC⁄ãxtTy≥
 *
bi_˘
 );

130 
büri_decode_symbﬁ_eq_¥ob
(
DecodögEnvú⁄mítPå
 
dï
);

131 
büri_decode_föÆ
(
DecodögEnvú⁄mítPå
 
dï
);

	@ldecod/inc/block.h

18 #i‚de‡
_BLOCK_H_


19 
	#_BLOCK_H_


	)

21 
	~"globÆ.h
"

22 
	~"å™sf‹m8x8.h
"

24 c⁄° 
byã
 
	gQP_SCALE_CR
[52]=

34 c⁄° 
	gsubblk_off£t_x
[3][8][4] =

69 c⁄° 
	gsubblk_off£t_y
[3][8][4] =

103 c⁄° 
byã
 
	gdecode_block_sˇn
[16] = {0, 1, 4, 5, 2, 3, 6, 7, 8, 9, 12, 13, 10, 11, 14, 15};

105 
iMBå™s4x4
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
smb
);

106 
iMBå™s8x8
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
);

108 
ôøns_•_¸
(
Ma¸oblock
 *
cuºMB
, 
uv
);

110 
Inv_ResiduÆ_å™s_4x4
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
ioff
, 
joff
);

111 
Inv_ResiduÆ_å™s_8x8
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
ioff
,
joff
);

112 
Inv_ResiduÆ_å™s_16x16
 (
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
);

113 
Inv_ResiduÆ_å™s_Chroma
(
Ma¸oblock
 *
cuºMB
, 
uv
);

115 
ôøns4x4
 (
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
ioff
, 
joff
);

116 
ôøns4x4_ls
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
ioff
, 
joff
);

117 
ôøns_•
 (
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
ioff
, 
joff
);

118 
ôøns_2
 (
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
);

119 
iTønsf‹m
 (
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
smb
);

121 
c›y_image_d©a
 (
img≥l
 **
imgBuf1
, img≥»**
imgBuf2
, 
off1
, 
off2
, 
width
, 
height
);

122 
c›y_image_d©a_16x16
 (
img≥l
 **
imgBuf1
, img≥»**
imgBuf2
, 
off1
, 
off2
);

123 
c›y_image_d©a_8x8
 (
img≥l
 **
imgBuf1
, img≥»**
imgBuf2
, 
off1
, 
off2
);

124 
c›y_image_d©a_4x4
 (
img≥l
 **
imgBuf1
, img≥»**
imgBuf2
, 
off1
, 
off2
);

125 
CheckVîtMV
(
Ma¸oblock
 *
cuºMB
, 
vec1_y
, 
block_size_y
);

	@ldecod/inc/cabac.h

19 #i‚de‡
_CABAC_H_


20 
	#_CABAC_H_


	)

22 
	~"globÆ.h
"

24 
MŸi⁄InfoC⁄ãxts
* 
¸óã_c⁄ãxts_MŸi⁄Info
();

25 
TextuªInfoC⁄ãxts
* 
¸óã_c⁄ãxts_TextuªInfo
();

26 
dñëe_c⁄ãxts_MŸi⁄Info
(
MŸi⁄InfoC⁄ãxts
 *
íco_˘x
);

27 
dñëe_c⁄ãxts_TextuªInfo
(
TextuªInfoC⁄ãxts
 *
íco_˘x
);

29 
ˇbac_√w_¶i˚
(
Sli˚
 *
cuºSli˚
);

31 
ªadMB_ty≥Info_CABAC_i_¶i˚
 (
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
DecodögEnvú⁄mítPå
 
dï_dp
);

32 
ªadMB_ty≥Info_CABAC_p_¶i˚
 (
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
DecodögEnvú⁄mítPå
 
dï_dp
);

33 
ªadMB_ty≥Info_CABAC_b_¶i˚
 (
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
DecodögEnvú⁄mítPå
 
dï_dp
);

34 
ªadB8_ty≥Info_CABAC_p_¶i˚
 (
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
DecodögEnvú⁄mítPå
 
dï_dp
);

35 
ªadB8_ty≥Info_CABAC_b_¶i˚
 (
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
DecodögEnvú⁄mítPå
 
dï_dp
);

36 
ªadI¡øPªdMode_CABAC
 (
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
DecodögEnvú⁄mítPå
 
dï_dp
);

37 
ªadRefFøme_CABAC
 (
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
DecodögEnvú⁄mítPå
 
dï_dp
);

38 
ªad_MVD_CABAC
 (
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
DecodögEnvú⁄mítPå
 
dï_dp
);

39 
ªad_mvd_CABAC_mbaff
 (
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
DecodögEnvú⁄mítPå
 
dï_dp
);

40 
ªad_CBP_CABAC
 (
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
DecodögEnvú⁄mítPå
 
dï_dp
);

41 
ªadRunLevñ_CABAC
 (
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
DecodögEnvú⁄mítPå
 
dï_dp
);

42 
ªad_dQu™t_CABAC
 (
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
DecodögEnvú⁄mítPå
 
dï_dp
);

43 
ªadCIPªdMode_CABAC
 (
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
DecodögEnvú⁄mítPå
 
dï_dp
);

44 
ªad_skù_Êag_CABAC_p_¶i˚
 (
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
DecodögEnvú⁄mítPå
 
dï_dp
);

45 
ªad_skù_Êag_CABAC_b_¶i˚
 (
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
DecodögEnvú⁄mítPå
 
dï_dp
);

46 
ªadFõldModeInfo_CABAC
 (
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
DecodögEnvú⁄mítPå
 
dï_dp
);

47 
ªadMB_å™sf‹m_size_Êag_CABAC
(
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
DecodögEnvú⁄mítPå
 
dï_dp
);

49 
ªadIPCM_CABAC
(
Sli˚
 *
cuºSli˚
, 
d©≠¨tôi⁄_dec
 *
dP
);

51 
ˇbac_°¨tcode_fﬁlows
(
Sli˚
 *
cuºSli˚
, 
eos_bô
);

53 
ªadSy¡axEÀmít_CABAC
 (
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
this_d©aP¨t
);

55 
check_√xt_mb_™d_gë_fõld_mode_CABAC_p_¶i˚
–
Sli˚
 *
cuºSli˚
, 
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
a˘_dp
);

56 
check_√xt_mb_™d_gë_fõld_mode_CABAC_b_¶i˚
–
Sli˚
 *
cuºSli˚
, 
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
a˘_dp
);

58 
CheckAvaûabûôyOfNeighb‹sCABAC
(
Ma¸oblock
 *
cuºMB
);

60 
£t_ªad_™d_°‹e_CBP
(
Ma¸oblock
 **
cuºMB
, 
chroma_f‹m©_idc
);

	@ldecod/inc/configfile.h

11 #i‚de‡
_CONFIGFILE_H_


12 
	#_CONFIGFILE_H_


	)

14 
	#DEFAULTCONFIGFILENAME
 "decodî.cfg"

	)

16 
	~"c⁄fig_comm⁄.h
"

21 
I≈utP¨amëîs
 
	gcfg∑øms
;

23 #ifde‡
INCLUDED_BY_CONFIGFILE_C


29 
M≠pög
 
	gM≠
[] = {

30 {"I≈utFûe", &
cfg∑øms
.
öfûe
, 1, 0.0, 0, 0.0, 0.0, 
FILE_NAME_SIZE
, },

31 {"OuçutFûe", &
cfg∑øms
.
outfûe
, 1, 0.0, 0, 0.0, 0.0, 
FILE_NAME_SIZE
, },

32 {"RefFûe", &
cfg∑øms
.
ªffûe
, 1, 0.0, 0, 0.0, 0.0, 
FILE_NAME_SIZE
, },

33 {"WrôeUV", &
cfg∑øms
.
wrôe_uv
, 0, 1.0, 1, 0.0, 1.0, },

34 {"FûeF‹m©", &
cfg∑øms
.
FûeF‹m©
, 0, 0.0, 1, 0.0, 1.0, },

35 {"RefOff£t", &
cfg∑øms
.
ªf_off£t
, 0, 0.0, 1, 0.0, 256.0, },

36 {"POCSˇÀ", &
cfg∑øms
.
poc_sˇÀ
, 0, 2.0, 1, 1.0, 10.0, },

37 #ifde‡
_LEAKYBUCKET_


38 {"R_decodî", &
cfg∑øms
.
R_decodî
, 0, 500000.0, 2, 0.0, 0.0, },

39 {"B_decodî", &
cfg∑øms
.
B_decodî
, 0, 104000.0, 2, 0.0, 0.0, },

40 {"F_decodî", &
cfg∑øms
.
F_decodî
, 0, 73000.0, 2, 0.0, 0.0, },

41 {"LókyBuckëP¨amFûe", &
cfg∑øms
.
LókyBuckëP¨amFûe
, 1, 0.0, 0, 0.0, 0.0, 
FILE_NAME_SIZE
, },

43 {"Di•œyDecP¨ams", &
cfg∑øms
.
bDi•œyDecP¨ams
, 0, 1.0, 1, 0.0, 1.0, },

44 {"C⁄˚ÆMode", &
cfg∑øms
.
c⁄˚Æ_mode
, 0, 0.0, 1, 0.0, 2.0, },

45 {"RefPOCG≠", &
cfg∑øms
.
ªf_poc_g≠
, 0, 2.0, 1, 0.0, 4.0, },

46 {"POCG≠", &
cfg∑øms
.
poc_g≠
, 0, 2.0, 1, 0.0, 4.0, },

47 {"Sûít", &
cfg∑øms
.
sûít
, 0, 0.0, 1, 0.0, 1.0, },

48 {"I¡øProfûeDeblockög", &
cfg∑øms
.
öåa_¥ofûe_deblockög
, 0, 1.0, 1, 0.0, 1.0, },

49 {"DecFrmNum", &
cfg∑øms
.
iDecFrmNum
, 0, 0.0, 2, 0.0, 0.0, },

50 #i‡(
MVC_EXTENSION_ENABLE
)

51 {"DecodeAŒLayîs", &
cfg∑øms
.
DecodeAŒLayîs
, 0, 0.0, 1, 0.0, 1.0, },

53 {"DPBPLUS0", &
cfg∑øms
.
dpb_∂us
[0], 0, 1.0, 1, -16.0, 16.0, },

54 {"DPBPLUS1", &
cfg∑øms
.
dpb_∂us
[1], 0, 0.0, 1, -16.0, 16.0, },

55 {
NULL
, NULL, -1, 0.0, 0, 0.0, 0.0, },

59 #i‚de‡
INCLUDED_BY_CONFIGFILE_C


60 
M≠pög
 
M≠
[];

62 
JMDecHñpExô
 ();

63 
P¨£Comm™d
(
I≈utP¨amëîs
 *
p_I≈
, 
ac
, *
av
[]);

	@ldecod/inc/context_ini.h

17 #i‚de‡
_CONTEXT_INI_


18 
	#_CONTEXT_INI_


	)

20 
öô_c⁄ãxts
 (
Sli˚
 *
cuº¶i˚
);

	@ldecod/inc/contributors.h

	@ldecod/inc/dec_statistics.h

15 #i‚de‡
_DEC_STATISTICS_H_


16 
	#_DEC_STATISTICS_H_


	)

17 
	~"globÆ.h
"

19 
	sdec_°©_∑ømëîs


21 
	m‰ame_˘r
 [
NUM_SLICE_TYPES
];

22 
öt64
 
	mmode_u£
 [
NUM_SLICE_TYPES
][
MAXMODE
];

23 
öt64
 
	mmode_u£_å™sf‹m
 [
NUM_SLICE_TYPES
][
MAXMODE
][2];

25 
öt64
 *
	mhi°ogøm_mv
 [2][2];

26 
öt64
 *
	mhi°ogøm_ªfs
[2];

27 } 
	tDecSètP¨amëîs
;

29 
öô_dec_°©s
 (
DecSètP¨amëîs
 *
°©s
);

30 
dñëe_dec_°©s
(
DecSètP¨amëîs
 *
°©s
);

	@ldecod/inc/defines.h

21 #i‚de‡
_DEFINES_H_


22 
	#_DEFINES_H_


	)

23 #ifde‡
TRACE


24 #unde‡
TRACE


26 #i‡
deföed
 
_DEBUG


27 
	#TRACE
 0

28 #ñ£

	)

29 
	#TRACE
 0

31 

	)

32 
	#JM
 "18 (FRExt)"

	)

33 
	#VERSION
 "18.4"

	)

34 
	#EXT_VERSION
 "(FRExt)"

	)

36 
	#DUMP_DPB
 0

37 
	#PRINTREFLIST
 0

38 
	#PAIR_FIELDS_IN_OUTPUT
 0

39 
	#IMGTYPE
 1

40 
	#ENABLE_FIELD_CTX
 1

41 
	#ENABLE_HIGH444_CTX
 1

42 
	#ZEROSNR
 0

43 
	#ENABLE_OUTPUT_TONEMAPPING
 1

44 
	#JCOST_CALC_SCALEUP
 1

45 
	#DISABLE_ERC
 0

46 
	#JM_PARALLEL_DEBLOCK
 0

47 
	#SIMULCAST_ENABLE
 0

48 

	)

49 
	#MVC_EXTENSION_ENABLE
 1

50 
	#ENABLE_DEC_STATS
 0

51 

	)

52 
	#MVC_INIT_VIEW_ID
 -1

	)

53 
	#MAX_VIEW_NUM
 1024

	)

54 
	#BASE_VIEW_IDX
 0

	)

56 
	~"ty≥defs.h
"

58 
	#SSE_MEMORY_ALIGNMENT
 16

	)

61 
	#MAX_NUM_SLICES
 50

	)

62 
	#MAX_REFERENCE_PICTURES
 32

63 
	#MAX_CODED_FRAME_SIZE
 8000000

64 
	#MAX_NUM_DECSLICES
 16

	)

65 
	#MAX_DEC_THREADS
 16

66 
	#MCBUF_LUMA_PAD_X
 32

	)

67 
	#MCBUF_LUMA_PAD_Y
 12

	)

68 
	#MCBUF_CHROMA_PAD_X
 16

	)

69 
	#MCBUF_CHROMA_PAD_Y
 8

	)

70 
	#MAX_NUM_DPB_LAYERS
 2

	)

74 
	mFREXT_CAVLC444
 = 44,

75 
	mBASELINE
 = 66,

76 
	mMAIN
 = 77,

77 
	mEXTENDED
 = 88,

78 
	mFREXT_HP
 = 100,

79 
	mFREXT_Hi10P
 = 110,

80 
	mFREXT_Hi422
 = 122,

81 
	mFREXT_Hi444
 = 244,

82 
	mMVC_HIGH
 = 118,

83 
	mSTEREO_HIGH
 = 128

84 } 
	tProfûeIDC
;

86 
	#FILE_NAME_SIZE
 255

	)

87 
	#INPUT_TEXT_SIZE
 1024

	)

89 #i‡(
ENABLE_HIGH444_CTX
 == 1)

90 
	#NUM_BLOCK_TYPES
 22

	)

92 
	#NUM_BLOCK_TYPES
 10

	)

98 
	#BLOCK_SHIFT
 2

	)

99 
	#BLOCK_SIZE
 4

	)

100 
	#BLOCK_SIZE_8x8
 8

	)

101 
	#SMB_BLOCK_SIZE
 8

	)

102 
	#BLOCK_PIXELS
 16

	)

103 
	#MB_BLOCK_SIZE
 16

	)

104 
	#MB_PIXELS
 256

105 
	#MB_PIXELS_SHIFT
 8

106 
	#MB_BLOCK_SHIFT
 4

	)

107 
	#BLOCK_MULTIPLE
 4

108 
	#MB_BLOCK_PARTITIONS
 16

109 
	#BLOCK_CONTEXT
 64

110 

	)

112 
	#BLOCK_SIZE_SP
 16

113 
	#BLOCK_SIZE_8x8_SP
 32

114 

	)

117 
	mPSKIP
 = 0,

118 
	mBSKIP_DIRECT
 = 0,

119 
	mP16x16
 = 1,

120 
	mP16x8
 = 2,

121 
	mP8x16
 = 3,

122 
	mSMB8x8
 = 4,

123 
	mSMB8x4
 = 5,

124 
	mSMB4x8
 = 6,

125 
	mSMB4x4
 = 7,

126 
	mP8x8
 = 8,

127 
	mI4MB
 = 9,

128 
	mI16MB
 = 10,

129 
	mIBLOCK
 = 11,

130 
	mSI4MB
 = 12,

131 
	mI8MB
 = 13,

132 
	mIPCM
 = 14,

133 
	mMAXMODE
 = 15

134 } 
	tMBModeTy≥s
;

137 
	#NO_INTRA_PMODE
 9

	)

141 
	mDIR_TEMPORAL
 = 0,

142 
	mDIR_SPATIAL
 = 1

143 } 
	tDúe˘Modes
;

147 
	mLUMA
 = 0,

148 
	mLUMA_INTRA16x16DC
 = 1,

149 
	mLUMA_INTRA16x16AC
 = 2,

150 
	mCB
 = 3,

151 
	mCB_INTRA16x16DC
 = 4,

152 
	mCB_INTRA16x16AC
 = 5,

153 
	mCR
 = 8,

154 
	mCR_INTRA16x16DC
 = 9,

155 
	mCR_INTRA16x16AC
 = 10

156 } 
	tCAVLCBlockTy≥s
;

160 
	mLUMA_16DC
 = 0,

161 
	mLUMA_16AC
 = 1,

162 
	mLUMA_8x8
 = 2,

163 
	mLUMA_8x4
 = 3,

164 
	mLUMA_4x8
 = 4,

165 
	mLUMA_4x4
 = 5,

166 
	mCHROMA_DC
 = 6,

167 
	mCHROMA_AC
 = 7,

168 
	mCHROMA_DC_2x4
 = 8,

169 
	mCHROMA_DC_4x4
 = 9,

170 
	mCB_16DC
 = 10,

171 
	mCB_16AC
 = 11,

172 
	mCB_8x8
 = 12,

173 
	mCB_8x4
 = 13,

174 
	mCB_4x8
 = 14,

175 
	mCB_4x4
 = 15,

176 
	mCR_16DC
 = 16,

177 
	mCR_16AC
 = 17,

178 
	mCR_8x8
 = 18,

179 
	mCR_8x4
 = 19,

180 
	mCR_4x8
 = 20,

181 
	mCR_4x4
 = 21

182 } 
	tCABACBlockTy≥s
;

185 
	#Q_BITS
 15

	)

186 
	#DQ_BITS
 6

	)

187 
	#Q_BITS_8
 16

	)

188 
	#DQ_BITS_8
 6

	)

191 
	#IS_I16MB
(
MB
Ë((MB)->
mb_ty≥
==
I16MB
 || (MB)->mb_ty≥==
IPCM
)

	)

192 
	#IS_DIRECT
(
MB
Ë((MB)->
mb_ty≥
==0 && (
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
 ))

	)

194 
	#TOTRUN_NUM
 15

	)

195 
	#RUNBEFORE_NUM
 7

	)

196 
	#RUNBEFORE_NUM_M1
 6

	)

199 
	#MIN_QP
 0

	)

200 
	#MAX_QP
 51

	)

203 
	mVERT_PRED
 = 0,

204 
	mHOR_PRED
 = 1,

205 
	mDC_PRED
 = 2,

206 
	mDIAG_DOWN_LEFT_PRED
 = 3,

207 
	mDIAG_DOWN_RIGHT_PRED
 = 4,

208 
	mVERT_RIGHT_PRED
 = 5,

209 
	mHOR_DOWN_PRED
 = 6,

210 
	mVERT_LEFT_PRED
 = 7,

211 
	mHOR_UP_PRED
 = 8

212 } 
	tI4x4PªdModes
;

216 
	mVERT_PRED_16
 = 0,

217 
	mHOR_PRED_16
 = 1,

218 
	mDC_PRED_16
 = 2,

219 
	mPLANE_16
 = 3

220 } 
	tI16x16PªdModes
;

224 
	mDC_PRED_8
 = 0,

225 
	mHOR_PRED_8
 = 1,

226 
	mVERT_PRED_8
 = 2,

227 
	mPLANE_8
 = 3

228 } 
	tI8x8PªdModes
;

232 
	mY_COMP
 = 0,

233 
	mU_COMP
 = 1,

234 
	mV_COMP
 = 2,

235 
	mR_COMP
 = 3,

236 
	mG_COMP
 = 4,

237 
	mB_COMP
 = 5,

238 
	mT_COMP
 = 6

239 } 
	gCﬁ‹Comp⁄ít
;

242 
	mEOS
 = 1,

243 
	mSOP
 = 2,

244 
	mSOS
 = 3,

245 
	mSOS_CONT
 = 4

250 
	mMVPRED_MEDIAN
 = 0,

251 
	mMVPRED_L
 = 1,

252 
	mMVPRED_U
 = 2,

253 
	mMVPRED_UR
 = 3

254 } 
	tMVPªdTy≥s
;

257 
	mDECODING_OK
 = 0,

258 
	mSEARCH_SYNC
 = 1,

259 
	mPICTURE_DECODED
 = 2

262 
	#LAMBDA_ACCURACY_BITS
 16

	)

263 
	#INVALIDINDEX
 (-135792468)

	)

265 
	#RC_MAX_TEMPORAL_LEVELS
 5

	)

268 
	#ZEROBYTES_SHORTSTARTCODE
 2

269 

	)

270 
	#MAX_PLANE
 3

	)

271 
	#IS_FREXT_PROFILE
(
¥ofûe_idc
Ë–¥ofûe_idc>=
FREXT_HP
 ||Örofûe_id¯=
FREXT_CAVLC444
 )

	)

272 
	#HI_INTRA_ONLY_PROFILE
 (((
p_Vid
->
a˘ive_•s
->
¥ofûe_idc
>=
FREXT_Hi10P
)&&’_Vid->a˘ive_•s->
c⁄°øöed_£t3_Êag
))||’_Vid->a˘ive_•s->¥ofûe_idc==
FREXT_CAVLC444
))

	)

	@ldecod/inc/elements.h

23 #i‚de‡
_ELEMENTS_H_


24 
	#_ELEMENTS_H_


	)

48 
	#SE_HEADER
 0

	)

49 
	#SE_PTYPE
 1

	)

50 
	#SE_MBTYPE
 2

	)

51 
	#SE_REFFRAME
 3

	)

52 
	#SE_INTRAPREDMODE
 4

	)

53 
	#SE_MVD
 5

	)

54 
	#SE_CBP_INTRA
 6

	)

55 
	#SE_LUM_DC_INTRA
 7

	)

56 
	#SE_CHR_DC_INTRA
 8

	)

57 
	#SE_LUM_AC_INTRA
 9

	)

58 
	#SE_CHR_AC_INTRA
 10

	)

59 
	#SE_CBP_INTER
 11

	)

60 
	#SE_LUM_DC_INTER
 12

	)

61 
	#SE_CHR_DC_INTER
 13

	)

62 
	#SE_LUM_AC_INTER
 14

	)

63 
	#SE_CHR_AC_INTER
 15

	)

64 
	#SE_DELTA_QUANT_INTER
 16

	)

65 
	#SE_DELTA_QUANT_INTRA
 17

	)

66 
	#SE_BFRAME
 18

	)

67 
	#SE_EOS
 19

	)

68 
	#SE_MAX_ELEMENTS
 20

	)

71 
	#NO_EC
 0

72 
	#EC_REQ
 1

73 
	#EC_SYNC
 2

74 

	)

75 
	#MAXPARTITIONMODES
 2

76 

	)

103 c⁄° 
byã
 
	gassignSE2∑πôi⁄
[][
SE_MAX_ELEMENTS
] =

	@ldecod/inc/erc_api.h

21 #i‚de‡
_ERC_API_H_


22 
	#_ERC_API_H_


	)

24 
	~"îc_globÆs.h
"

32 
	#MVPERMB_THR
 8

	)

35 
	#DEF_REGION_SIZE
 384

	)

37 
	#ERC_BLOCK_OK
 3

	)

38 
	#ERC_BLOCK_CONCEALED
 2

	)

39 
	#ERC_BLOCK_CORRUPTED
 1

	)

40 
	#ERC_BLOCK_EMPTY
 0

	)

47 
	#xPosYBlock
(
cuºYBlockNum
,
picSizeX
Ë\

	)

48 ((
	gcuºYBlockNum
)%((
	gpicSizeX
)>>3))

50 
	#yPosYBlock
(
cuºYBlockNum
,
picSizeX
Ë\

	)

51 ((
	gcuºYBlockNum
)/((
	gpicSizeX
)>>3))

53 
	#xPosMB
(
cuºMBNum
,
picSizeX
Ë\

	)

54 ((
	gcuºMBNum
)%((
	gpicSizeX
)>>4))

56 
	#yPosMB
(
cuºMBNum
,
picSizeX
Ë\

	)

57 ((
	gcuºMBNum
)/((
	gpicSizeX
)>>4))

59 
	#MBxy2YBlock
(
cuºXPos
,
cuºYPos
,
comp
,
picSizeX
Ë\

	)

60 ((((
	gcuºYPos
)<<1)+((
	gcomp
)>>1))*((
	gpicSizeX
)>>3)+((
	gcuºXPos
)<<1)+((comp)&1))

62 
	#MBNum2YBlock
(
cuºMBNum
,
comp
,
picSizeX
Ë\

	)

63 
MBxy2YBlock
(
xPosMB
((
cuºMBNum
),(
picSizeX
)),
yPosMB
((cuºMBNum),’icSizeX)),(
comp
),(picSizeX))

71 
	sîcSegmít_s


73 
	m°¨tMBPos
;

74 
	mídMBPos
;

75 
	mfC‹ru±ed
;

76 } 
	tîcSegmít_t
;

79 
	sîcV¨übÀs_s


82 
	mnOfMBs
;

84 
	mnOfSegmíts
;

87 *
	myC⁄dôi⁄
;

89 *
	muC⁄dôi⁄
;

91 *
	mvC⁄dôi⁄
;

94 
îcSegmít_t
 *
	m£gmíts
;

95 
	mcuºSegmít
;

98 *
	m¥evFømeYC⁄dôi⁄
;

101 
	mcuºSegmítC‹ru±ed
;

103 
	mnOfC‹ru±edSegmíts
;

106 
	mc⁄˚Æmít
;

108 } 
	tîcV¨übÀs_t
;

114 
îcInô
 (
VideoP¨amëîs
 *
p_Vid
, 
pic_sizex
, 
pic_sizey
, 
Êag
);

115 
îcV¨übÀs_t
 *
îcO≥n
( );

116 
îcRe£t
–
îcV¨übÀs_t
 *
îr‹V¨
, 
nOfMBs
, 
numOfSegmíts
, 
picSizeX
 );

117 
îcClo£
–
VideoP¨amëîs
 *
p_Vid
, 
îcV¨übÀs_t
 *
îr‹V¨
 );

118 
îcSëEº‹C⁄˚Æmít
–
îcV¨übÀs_t
 *
îr‹V¨
, 
vÆue
 );

120 
îcSèπSegmít
–
cuºMBNum
, 
£gmít
, 
bôPos
, 
îcV¨übÀs_t
 *
îr‹V¨
 );

121 
îcSt›Segmít
–
cuºMBNum
, 
£gmít
, 
bôPos
, 
îcV¨übÀs_t
 *
îr‹V¨
 );

122 
îcM¨kCuºSegmítLo°
(
picSizeX
, 
îcV¨übÀs_t
 *
îr‹V¨
 );

123 
îcM¨kCuºSegmítOK
(
picSizeX
, 
îcV¨übÀs_t
 *
îr‹V¨
 );

124 
îcM¨kCuºMBC⁄˚Æed
–
cuºMBNum
, 
comp
, 
picSizeX
, 
îcV¨übÀs_t
 *
îr‹V¨
 );

126 
îcC⁄˚ÆI¡øFøme
–
VideoP¨amëîs
 *
p_Vid
, 
‰ame
 *
ªc‰
, 
picSizeX
, 
picSizeY
, 
îcV¨übÀs_t
 *
îr‹V¨
 );

127 
îcC⁄˚ÆI¡îFøme
–
‰ame
 *
ªc‰
, 
obje˘Buf„r_t
 *
obje˘_li°
,

128 
picSizeX
, 
picSizeY
, 
îcV¨übÀs_t
 *
îr‹V¨
, 
chroma_f‹m©_idc
 );

133 
	~"mbuf„r.h
"

134 
	~"ouçut.h
"

136 
	sc⁄˚Æmít_node
 {

137 
St‹abÀPi˘uª
* 
	mpi˘uª
;

138 
	mmissögpocs
;

139 
c⁄˚Æmít_node
 *
	m√xt
;

142 
c⁄˚Æmít_node
 * 
öô_node
(
St‹abÀPi˘uª
* , );

143 
¥öt_node
–
c⁄˚Æmít_node
 * );

144 
¥öt_li°
–
c⁄˚Æmít_node
 * );

145 
öô_li°s_f‹_n⁄_ª„ªn˚_loss
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, , 
Pi˘uªSåu˘uª
 );

147 
c⁄˚Æ_n⁄_ªf_pics
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
diff
);

148 
c⁄˚Æ_lo°_‰ames
 (
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
Sli˚
 *
pSli˚
);

150 
¶idög_wödow_poc_m™agemít
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
St‹abÀPi˘uª
 *
p
);

151 
wrôe_lo°_n⁄_ªf_pic
 (
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
poc
, 
p_out
);

152 
wrôe_lo°_ªf_a·î_idr
 (
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
pos
);

154 
comp
(const *, const *);

	@ldecod/inc/erc_do.h

16 #i‚de‡
_ERC_DO_H_


17 
	#_ERC_DO_H_


	)

20 
	~"îc_≠i.h
"

22 
îcPixC⁄˚ÆIMB
 (
VideoP¨amëîs
 *
p_Vid
, 
img≥l
 *
cuºFøme
, 
row
, 
cﬁumn
, 
¥edBlocks
[], 
‰ameWidth
, 
mbWidthInBlocks
);

24 
îcCﬁÀ˘8PªdBlocks
–
¥edBlocks
[], 
cuºRow
, 
cuºCﬁumn
, *
c⁄dôi⁄
,

25 
maxRow
, 
maxCﬁumn
, 
°ï
, 
byã
 
fNoC‹√rNeigh
 );

26 
îcCﬁÀ˘CﬁumnBlocks
–
¥edBlocks
[], 
cuºRow
, 
cuºCﬁumn
, *
c⁄dôi⁄
, 
maxRow
, 
maxCﬁumn
, 
°ï
 );

28 
	#isS∂ôãd
(
obje˘_li°
,
cuºMBNum
Ë\

	)

29 ((
	gobje˘_li°
+((
	gcuºMBNum
)<<2))->
	gªgi⁄Mode
 >
REGMODE_SPLITTED
)

32 
	#isBlock
(
obje˘_li°
,
cuºMBNum
,
comp
,
ªgMode
Ë\

	)

33 (
isS∂ôãd
(
obje˘_li°
,
cuºMBNum
) ? \

34 ((
	gobje˘_li°
+((
	gcuºMBNum
)<<2)+(
	gcomp
))->
	gªgi⁄Mode
 =
REGMODE_
##
ªgMode
##
_8x8
) : \

35 ((
obje˘_li°
+((
cuºMBNum
)<<2))->
ªgi⁄Mode
 =
REGMODE_
##
ªgMode
))

38 
	#gëP¨am
(
obje˘_li°
,
cuºMBNum
,
comp
,
∑øm
Ë\

	)

39 (
isS∂ôãd
(
obje˘_li°
,
cuºMBNum
) ? \

40 ((
	gobje˘_li°
+((
	gcuºMBNum
)<<2)+(
	gcomp
))->
	g∑øm
) : \

41 ((
obje˘_li°
+((
cuºMBNum
)<<2))->
∑øm
))

	@ldecod/inc/erc_globals.h

15 #i‚de‡
_ERC_GLOBALS_H_


16 
	#_ERC_GLOBALS_H_


	)

18 
	~"deföes.h
"

23 
	#REGMODE_INTER_COPY
 0

24 
	#REGMODE_INTER_PRED
 1

25 
	#REGMODE_INTRA
 2

26 
	#REGMODE_SPLITTED
 3

28 
	#REGMODE_INTER_COPY_8x8
 4

	)

29 
	#REGMODE_INTER_PRED_8x8
 5

	)

30 
	#REGMODE_INTRA_8x8
 6

	)

33 
	s‰ame_s


35 
VideoP¨amëîs
 *
	mp_Vid
;

36 
img≥l
 *
	my±r
;

37 
img≥l
 *
	mu±r
;

38 
img≥l
 *
	mv±r
;

39 } 
	t‰ame
;

42 
	sobje˘_buf„r


44 
byã
 
	mªgi⁄Mode
;

45 
	mxMö
;

46 
	myMö
;

47 
	mmv
[3];

49 } 
	tobje˘Buf„r_t
;

	@ldecod/inc/errorconcealment.h

13 #i‚de‡
_ERRORCONCEALMENT_H_


14 
	#_ERRORCONCEALMENT_H_


	)

16 
gë_c⁄˚Æed_ñemít
(
VideoP¨amëîs
 *
p_Vid
, 
Sy¡axEÀmít
 *
sym
);

17 
£t_ec_Êag
 (
VideoP¨amëîs
 *
p_Vid
, 
£
);

18 
ª£t_ec_Êags
 (
VideoP¨amëîs
 *
p_Vid
);

	@ldecod/inc/filehandle.h

15 
	~"c⁄åibut‹s.h
"

17 #i‡
TRACE


18 
de˘ø˚bô˙t
(
cou¡
);

19 
åa˚bôs
 ( c⁄° *
åa˚_°r
, 
Àn
, 
öfo
, 
vÆue1
);

20 
åa˚bôs2
 ( c⁄° *
åa˚_°r
, 
Àn
, 
öfo
);

21 
åa˚_öfo
 ( 
Sy¡axEÀmít
 *
cuºSE
, c⁄° *
des¸ùti⁄_°r
, 
vÆue1
 );

	@ldecod/inc/fmo.h

17 #i‚de‡
_FMO_H_


18 
	#_FMO_H_


	)

21 
fmo_öô
 (
VideoP¨amëîs
 *
p_Vid
, 
Sli˚
 *
pSli˚
);

22 
FmoFöô
 (
VideoP¨amëîs
 *
p_Vid
);

24 
FmoGëNumbîOfSli˚Group
(
VideoP¨amëîs
 *
p_Vid
);

25 
FmoGëLa°MBOfPi˘uª
 (
VideoP¨amëîs
 *
p_Vid
);

26 
FmoGëLa°MBInSli˚Group
(
VideoP¨amëîs
 *
p_Vid
, 
Sli˚Group
);

27 
FmoGëSli˚GroupId
 (
VideoP¨amëîs
 *
p_Vid
, 
mb
);

28 
FmoGëNextMBNr
 (
VideoP¨amëîs
 *
p_Vid
, 
CuºítMbNr
);

	@ldecod/inc/global.h

26 #i‚de‡
_GLOBAL_H_


27 
	#_GLOBAL_H_


	)

28 
	~<°dlib.h
>

29 
	~<°d¨g.h
>

30 
	~<°rög.h
>

31 
	~<as£π.h
>

32 
	~<time.h
>

33 
	~<sys/timeb.h
>

35 
	~"wö32.h
"

36 
	~"deföes.h
"

37 
	~"ifun˘i⁄s.h
"

38 
	~"∑r£tcomm⁄.h
"

39 
	~"ty≥s.h
"

40 
	~"io_image.h
"

41 
	~"‰ame.h
"

42 
	~"di°‹ti⁄.h
"

43 
	~"io_video.h
"

45 
bô_°ªam_dec
 
	tBô°ªam
;

47 
	#ET_SIZE
 300

48 
îr‹ãxt
[
ET_SIZE
];

49 

	)

50 
	gpic_mŸi⁄_∑øms_ﬁd
;

51 
	gpic_mŸi⁄_∑øms
;

59 
	mDEC_OPENED
 = 0,

60 
	mDEC_STOPPED
,

61 }
	tDecodîSètus_e
;

65 
	mLumaComp
 = 0,

66 
	mCrComp
 = 1,

67 
	mCbComp
 = 2

68 } 
	tCﬁ‹_Comp⁄ít
;

75 
	spix_pos


77 
	mavaûabÀ
;

78 
	mmb_addr
;

79 
	mx
;

80 
	my
;

81 
	mpos_x
;

82 
	mpos_y
;

83 } 
	tPixñPos
;

88 
	mDønge
;

89 
	mDvÆue
;

90 
	mDbôsLe·
;

91 
byã
 *
	mDcode°rm
;

92 *
	mDcode°rm_Àn
;

93 } 
	tDecodögEnvú⁄mít
;

95 
DecodögEnvú⁄mít
 *
	tDecodögEnvú⁄mítPå
;

100 
	mmv_x
;

101 
	mmv_y
;

102 } 
	tMŸi⁄Ve˘‹
;

104 c⁄° 
MŸi⁄Ve˘‹
 
	gzîo_mv
 = {0, 0};

108 
	mx
;

109 
	my
;

110 } 
	tBlockPos
;

115 
uöt16
 
	m°©e
;

116 
	mMPS
;

117 
	mdummy
;

118 } 
	tBiC⁄ãxtTy≥
;

120 
BiC⁄ãxtTy≥
 *
	tBiC⁄ãxtTy≥På
;

128 
	#NUM_MB_TYPE_CTX
 11

	)

129 
	#NUM_B8_TYPE_CTX
 9

	)

130 
	#NUM_MV_RES_CTX
 10

	)

131 
	#NUM_REF_NO_CTX
 6

	)

132 
	#NUM_DELTA_QP_CTX
 4

	)

133 
	#NUM_MB_AFF_CTX
 4

	)

134 
	#NUM_TRANSFORM_SIZE_CTX
 3

	)

137 
	g°‹abÀ_pi˘uª
;

138 
	gd©≠¨tôi⁄_dec
;

139 
	gsy¡axñemít_dec
;

143 
BiC⁄ãxtTy≥
 
	mmb_ty≥_c⁄ãxts
 [3][
NUM_MB_TYPE_CTX
];

144 
BiC⁄ãxtTy≥
 
	mb8_ty≥_c⁄ãxts
 [2][
NUM_B8_TYPE_CTX
];

145 
BiC⁄ãxtTy≥
 
	mmv_ªs_c⁄ãxts
 [2][
NUM_MV_RES_CTX
];

146 
BiC⁄ãxtTy≥
 
	mªf_no_c⁄ãxts
 [2][
NUM_REF_NO_CTX
];

147 
BiC⁄ãxtTy≥
 
	mdñè_qp_c⁄ãxts
[
NUM_DELTA_QP_CTX
];

148 
BiC⁄ãxtTy≥
 
	mmb_aff_c⁄ãxts
 [
NUM_MB_AFF_CTX
];

149 } 
	tMŸi⁄InfoC⁄ãxts
;

151 
	#NUM_IPR_CTX
 2

	)

152 
	#NUM_CIPR_CTX
 4

	)

153 
	#NUM_CBP_CTX
 4

	)

154 
	#NUM_BCBP_CTX
 4

	)

155 
	#NUM_MAP_CTX
 15

	)

156 
	#NUM_LAST_CTX
 15

	)

157 
	#NUM_ONE_CTX
 5

	)

158 
	#NUM_ABS_CTX
 5

	)

162 
BiC⁄ãxtTy≥
 
	må™sf‹m_size_c⁄ãxts
 [
NUM_TRANSFORM_SIZE_CTX
];

163 
BiC⁄ãxtTy≥
 
	mùr_c⁄ãxts
 [
NUM_IPR_CTX
];

164 
BiC⁄ãxtTy≥
 
	mcùr_c⁄ãxts
[
NUM_CIPR_CTX
];

165 
BiC⁄ãxtTy≥
 
	mcbp_c⁄ãxts
 [3][
NUM_CBP_CTX
];

166 
BiC⁄ãxtTy≥
 
	mbcbp_c⁄ãxts
[
NUM_BLOCK_TYPES
][
NUM_BCBP_CTX
];

167 
BiC⁄ãxtTy≥
 
	mm≠_c⁄ãxts
 [2][
NUM_BLOCK_TYPES
][
NUM_MAP_CTX
];

168 
BiC⁄ãxtTy≥
 
	mœ°_c⁄ãxts
[2][
NUM_BLOCK_TYPES
][
NUM_LAST_CTX
];

169 
BiC⁄ãxtTy≥
 
	m⁄e_c⁄ãxts
 [
NUM_BLOCK_TYPES
][
NUM_ONE_CTX
];

170 
BiC⁄ãxtTy≥
 
	mabs_c⁄ãxts
 [
NUM_BLOCK_TYPES
][
NUM_ABS_CTX
];

171 } 
	tTextuªInfoC⁄ãxts
;

182 
	sDecRefPicM¨kög_s


184 
	mmem‹y_m™agemít_c⁄åﬁ_›î©i⁄
;

185 
	mdif„ªn˚_of_pic_nums_möus1
;

186 
	ml⁄g_ãrm_pic_num
;

187 
	ml⁄g_ãrm_‰ame_idx
;

188 
	mmax_l⁄g_ãrm_‰ame_idx_∂us1
;

189 
DecRefPicM¨kög_s
 *
	mNext
;

190 } 
	tDecRefPicM¨kög_t
;

193 
	scbp_s


195 
öt64
 
	mblk
 ;

196 
öt64
 
	mbôs
 ;

197 
öt64
 
	mbôs_8x8
;

198 } 
	tCBPSåu˘uª
;

201 
	sma¸oblock_dec


203 
¶i˚
 *
	mp_Sli˚
;

204 
video_∑r
 *
	mp_Vid
;

205 
öp_∑r
 *
	mp_I≈
;

206 
	mmbAddrX
;

207 
	mmbAddrA
, 
	mmbAddrB
, 
	mmbAddrC
, 
	mmbAddrD
;

208 
Boﬁón
 
	mmbAvaûA
, 
	mmbAvaûB
, 
	mmbAvaûC
, 
	mmbAvaûD
;

209 
BlockPos
 
	mmb
;

210 
	mblock_x
;

211 
	mblock_y
;

212 
	mblock_y_aff
;

213 
	mpix_x
;

214 
	mpix_y
;

215 
	mpix_c_x
;

216 
	mpix_c_y
;

218 
	msubblock_x
;

219 
	msubblock_y
;

221 
	mqp
;

222 
	mqpc
[2];

223 
	mqp_sˇÀd
[
MAX_PLANE
];

224 
Boﬁón
 
	mis_los¶ess
;

225 
Boﬁón
 
	mis_öåa_block
;

226 
Boﬁón
 
	mis_v_block
;

227 
Boﬁón
 
	mDeblockCÆl
;

229 
	m¶i˚_ƒ
;

230 
	mei_Êag
;

231 
	md∂_Êag
;

232 
	mdñè_qu™t
;

233 
	mli°_off£t
;

235 
ma¸oblock_dec
 *
	mmb_up
;

236 
ma¸oblock_dec
 *
	mmb_À·
;

238 
ma¸oblock_dec
 *
	mmbup
;

239 
ma¸oblock_dec
 *
	mmbÀ·
;

242 
	mmb_ty≥
;

243 
	mmvd
[2][
BLOCK_MULTIPLE
][BLOCK_MULTIPLE][2];

245 
	mcbp
;

246 
CBPSåu˘uª
 
	ms_cbp
[3];

248 
	mi16mode
;

249 
	mb8mode
[4];

250 
	mb8pdú
[4];

251 
	mùmode_DPCM
;

252 
	mc_ùªd_mode
;

253 
	mskù_Êag
;

254 
	mDFDißbÀIdc
;

255 
	mDFAÕhaC0Off£t
;

256 
	mDFBëaOff£t
;

258 
Boﬁón
 
	mmb_fõld
;

260 
byã
 
	mmixedModeEdgeFœg
;

263 
byã
 
	m°ªngth_vî
[4][4];

264 
byã
 
	m°ªngth_h‹
[4][16];

267 
Boﬁón
 
	mluma_å™sf‹m_size_8x8_Êag
;

268 
Boﬁón
 
	mNoMbP¨tLessTh™8x8Fœg
;

270 (*
	môøns_4x4
)(
ma¸oblock_dec
 *
	mcuºMB
, 
Cﬁ‹Pœ√
 
	m∂
, 
	mioff
, 
	mjoff
);

271 (*
	môøns_8x8
)(
ma¸oblock_dec
 *
	mcuºMB
, 
Cﬁ‹Pœ√
 
	m∂
, 
	mioff
, 
	mjoff
);

273 (*
	mGëMVPªdi˘‹
Ë(
ma¸oblock_dec
 *
	mcuºMB
, 
PixñPos
 *
	mblock
,

274 
MŸi⁄Ve˘‹
 *
	mpmv
, 
	mªf_‰ame
, 
pic_mŸi⁄_∑øms
 **
	mmv_öfo
, 
	mli°
, 
	mmb_x
, 
	mmb_y
, 
	mblocksh≠e_x
, 
	mblocksh≠e_y
);

276 (*
	mªad_™d_°‹e_CBP_block_bô
Ë(
ma¸oblock_dec
 *
	mcuºMB
, 
DecodögEnvú⁄mítPå
 
	mdï_dp
, 
	mty≥
);

277 (*
	mªadRefPi˘uªIdx
Ë(
ma¸oblock_dec
 *
	mcuºMB
, 
sy¡axñemít_dec
 *
	mcuºSE
, 
d©≠¨tôi⁄_dec
 *
	mdP
, 
	mb8mode
, 
	mli°
);

279 (*
	mªad_comp_c€ff_4x4_CABAC
Ë(
ma¸oblock_dec
 *
	mcuºMB
, 
sy¡axñemít_dec
 *
	mcuºSE
, 
Cﬁ‹Pœ√
 
	m∂
, (*
	mInvLevñSˇÀ4x4
)[4], 
	mqp_≥r
, 
	mcbp
);

280 (*
	mªad_comp_c€ff_8x8_CABAC
Ë(
ma¸oblock_dec
 *
	mcuºMB
, 
sy¡axñemít_dec
 *
	mcuºSE
, 
Cﬁ‹Pœ√
 
	m∂
);

282 (*
	mªad_comp_c€ff_4x4_CAVLC
Ë(
ma¸oblock_dec
 *
	mcuºMB
, 
Cﬁ‹Pœ√
 
	m∂
, (*
	mInvLevñSˇÀ4x4
)[4], 
	mqp_≥r
, 
	mcbp
, 
byã
 **
	mnzc€ff
);

283 (*
	mªad_comp_c€ff_8x8_CAVLC
Ë(
ma¸oblock_dec
 *
	mcuºMB
, 
Cﬁ‹Pœ√
 
	m∂
, (*
	mInvLevñSˇÀ8x8
)[8], 
	mqp_≥r
, 
	mcbp
, 
byã
 **
	mnzc€ff
);

284 } 
	tMa¸oblock
;

287 
	ssy¡axñemít_dec


289 
	mty≥
;

290 
	mvÆue1
;

291 
	mvÆue2
;

292 
	mÀn
;

293 
	möf
;

294 
	mbô∑âîn
;

295 
	mc⁄ãxt
;

296 
	mk
;

298 #i‡
TRACE


299 
	#TRACESTRING_SIZE
 100

300 
åa˚°rög
[
TRACESTRING_SIZE
];

302 

	)

304 (*
	mm≠pög
)(
	mÀn
, 
	möfo
, *
	mvÆue1
, *
	mvÆue2
);

306 (*
	mªadög
)(
ma¸oblock_dec
 *
	mcuºMB
, 
	msy¡axñemít_dec
 *, 
	mDecodögEnvú⁄mítPå
);

307 } 
	tSy¡axEÀmít
;

311 
	sbô_°ªam_dec


314 
	mªad_Àn
;

315 
	mcode_Àn
;

317 
	m‰ame_bôoff£t
;

318 
	mbô°ªam_Àngth
;

320 
byã
 *
	m°ªamBuf„r
;

321 
	mei_Êag
;

325 
	sd©≠¨tôi⁄_dec


328 
Bô°ªam
 *
	mbô°ªam
;

329 
DecodögEnvú⁄mít
 
	mde_ˇbac
;

331 (*
	mªadSy¡axEÀmít
)(
ma¸oblock_dec
 *
	mcuºMB
, 
	msy¡axñemít_dec
 *, 
	md©≠¨tôi⁄_dec
 *);

335 } 
	tD©aP¨tôi⁄
;

337 
	swp_∑øms


339 
	mweight
[3];

340 
	moff£t
[3];

341 } 
	tWPP¨ams
;

343 #i‡(
MVC_EXTENSION_ENABLE
)

344 
	s«lunôhódîmv˚xt_èg


346 
	mn⁄_idr_Êag
;

347 
	m¥i‹ôy_id
;

348 
	mvõw_id
;

349 
	mãmp‹Æ_id
;

350 
	m™ch‹_pic_Êag
;

351 
	möãr_võw_Êag
;

352 
	mª£rved_⁄e_bô
;

353 
	miPªfixNALU
;

354 } 
	tNALUnôHódîMVCExt_t
;

358 
	s¶i˚


360 
video_∑r
 *
	mp_Vid
;

361 
öp_∑r
 *
	mp_I≈
;

362 
pic_∑ømëî_£t_rb•_t
 *
	ma˘ive_µs
;

363 
£q_∑ømëî_£t_rb•_t
 *
	ma˘ive_•s
;

364 
	msvc_exãnsi⁄_Êag
;

367 
decoded_pi˘uª_buf„r
 *
	mp_Dpb
;

370 
	midr_Êag
;

371 
	midr_pic_id
;

372 
	m«l_ª„ªn˚_idc
;

373 
	mTønsf‹m8x8Mode
;

374 
Boﬁón
 
	mchroma444_nŸ_£∑øã
;

376 
	mt›poc
;

377 
	mbŸtompoc
;

378 
	m‰amïoc
;

382 
	mpic_‹dî_˙t_lsb
;

383 
	mdñè_pic_‹dî_˙t_bŸtom
;

385 
	mdñè_pic_‹dî_˙t
[2];

389 sig√d 
	mPicOrdîC¡Msb
;

395 
	mAbsFømeNum
;

396 
	mThisPOC
;

404 
	mcuºít_mb_ƒ
;

405 
	mnum_dec_mb
;

406 
	mcuºít_¶i˚_ƒ
;

413 
	mcod_cou¡î
;

414 
	mÆÃefzîo
;

417 
	mmb_aff_‰ame_Êag
;

418 
	mdúe˘_•©ül_mv_¥ed_Êag
;

419 
	mnum_ªf_idx_a˘ive
[2];

423 
	mei_Êag
;

424 
	mqp
;

425 
	m¶i˚_qp_dñè
;

426 
	mqs
;

427 
	m¶i˚_qs_dñè
;

428 
	m¶i˚_ty≥
;

429 
	mmodñ_numbî
;

430 
	m‰ame_num
;

431 
	mfõld_pic_Êag
;

432 
byã
 
	mbŸtom_fõld_Êag
;

433 
Pi˘uªSåu˘uª
 
	m°ru˘uª
;

434 
	m°¨t_mb_ƒ
;

435 
	míd_mb_ƒ_∂us1
;

436 
	mmax_∑π_ƒ
;

437 
	mdp_mode
;

438 
	mcuºít_hódî
;

439 
	m√xt_hódî
;

440 
	mœ°_dqu™t
;

443 
	mcﬁour_∂™e_id
;

444 
	mªdund™t_pic_˙t
;

445 
	m•_swôch
;

446 
	m¶i˚_group_ch™ge_cy˛e
;

447 
	mªdund™t_¶i˚_ªf_idx
;

448 
	mno_ouçut_of_¥i‹_pics_Êag
;

449 
	ml⁄g_ãrm_ª„ªn˚_Êag
;

450 
	mad≠tive_ªf_pic_buf„rög_Êag
;

451 
DecRefPicM¨kög_t
 *
	mdec_ªf_pic_m¨kög_buf„r
;

453 
	mli°Xsize
[6];

454 
°‹abÀ_pi˘uª
 **
	mli°X
[6];

457 
D©aP¨tôi⁄
 *
	m∑πAº
;

458 
MŸi⁄InfoC⁄ãxts
 *
	mmŸ_˘x
;

459 
TextuªInfoC⁄ãxts
 *
	mãx_˘x
;

461 
	mmvsˇÀ
[6][
MAX_REFERENCE_PICTURES
];

463 
	mªf_pic_li°_ª‹dîög_Êag
[2];

464 *
	mmodifiˇti⁄_of_pic_nums_idc
[2];

465 *
	mabs_diff_pic_num_möus1
[2];

466 *
	ml⁄g_ãrm_pic_idx
[2];

468 #i‡(
MVC_EXTENSION_ENABLE
)

469 *
	mabs_diff_võw_idx_möus1
[2];

471 
	mvõw_id
;

472 
	möãr_võw_Êag
;

473 
	m™ch‹_pic_Êag
;

475 
NALUnôHódîMVCExt_t
 
	mNÆuHódîMVCExt
;

477 
	mœyî_id
;

478 
	mDFDißbÀIdc
;

479 
	mDFAÕhaC0Off£t
;

480 
	mDFBëaOff£t
;

482 
	mpic_∑ømëî_£t_id
;

484 
	mdpB_NŸPª£¡
;

485 
	mdpC_NŸPª£¡
;

487 
Boﬁón
 
	mis_ª£t_c€ff
;

488 
Boﬁón
 
	mis_ª£t_c€ff_¸
;

489 
img≥l
 ***
	mmb_¥ed
;

490 
img≥l
 ***
	mmb_ªc
;

491 ***
	mmb_ºes
;

492 ***
	mcof
;

493 ***
	mfcf
;

495 
	mcofu
[16];

497 
img≥l
 **
	mtmp_block_l0
;

498 
img≥l
 **
	mtmp_block_l1
;

499 **
	mtmp_ªs
;

500 
img≥l
 **
	mtmp_block_l2
;

501 
img≥l
 **
	mtmp_block_l3
;

504 
	mInvLevñSˇÀ4x4_I¡ø
[3][6][4][4];

505 
	mInvLevñSˇÀ4x4_I¡î
[3][6][4][4];

506 
	mInvLevñSˇÀ8x8_I¡ø
[3][6][8][8];

507 
	mInvLevñSˇÀ8x8_I¡î
[3][6][8][8];

509 *
	mqm©rix
[12];

512 
	mc€ff
[64];

513 
	mc€ff_˘r
;

514 
	mpos
;

518 
	mweighãd_¥ed_Êag
;

519 
	mweighãd_bùªd_idc
;

521 
	mluma_log2_weight_díom
;

522 
	mchroma_log2_weight_díom
;

524 
WPP¨ams
 **
	mwp_∑øms
;

526 ***
	mwp_weight
;

527 ***
	mwp_off£t
;

528 ****
	mwbp_weight
;

529 
	mwp_round_luma
;

530 
	mwp_round_chroma
;

532 #i‡(
MVC_EXTENSION_ENABLE
)

533 
	mli°öãrvõwidx0
;

534 
	mli°öãrvõwidx1
;

535 
‰ame_°‹e
 **
	mfs_li°öãrvõw0
;

536 
‰ame_°‹e
 **
	mfs_li°öãrvõw1
;

541 
	mmax_mb_vmv_r
;

542 
	mªf_Êag
[17];

544 
	mîc_mv≥rMB
;

545 
Ma¸oblock
 *
	mmb_d©a
;

546 
°‹abÀ_pi˘uª
 *
	mdec_pi˘uª
;

547 **
	msiblock
;

548 
byã
 **
	mùªdmode
;

549 *
	möåa_block
;

550 
	mchroma_ve˘‹_adju°mít
[6][16];

551 (*
	mªad_CBP_™d_c€ffs_‰om_NAL
Ë(
Ma¸oblock
 *
	mcuºMB
);

552 (*
	mdecode_⁄e_comp⁄ít
 ) (
Ma¸oblock
 *
	mcuºMB
, 
Cﬁ‹Pœ√
 
	mcuº_∂™e
, 
img≥l
 **
	mcuºImg
, 
°‹abÀ_pi˘uª
 *
	mdec_pi˘uª
);

553 (*
	mªadSli˚
 ) (
	mvideo_∑r
 *, 
	möp_∑r
 *);

554 (*
	m«l_°¨tcode_fﬁlows
 ) (
	m¶i˚
*, );

555 (*
	mªad_mŸi⁄_öfo_‰om_NAL
Ë(
Ma¸oblock
 *
	mcuºMB
);

556 (*
	mªad_⁄e_ma¸oblock
 ) (
Ma¸oblock
 *
	mcuºMB
);

557 (*
	möãΩªt_mb_mode
 ) (
Ma¸oblock
 *
	mcuºMB
);

558 (*
	möô_li°s
 ) (
¶i˚
 *
	mcuºSli˚
);

560 (*
	möåa_¥ed_chroma
 ) (
Ma¸oblock
 *
	mcuºMB
);

561 (*
	möåa_¥ed_4x4
Ë(
Ma¸oblock
 *
	mcuºMB
, 
Cﬁ‹Pœ√
 
	m∂
, 
	mioff
, 
	mjoff
,
	mi4
,
	mj4
);

562 (*
	möåa_¥ed_8x8
Ë(
Ma¸oblock
 *
	mcuºMB
, 
Cﬁ‹Pœ√
 
	m∂
, 
	mioff
, 
	mjoff
);

563 (*
	möåa_¥ed_16x16
Ë(
Ma¸oblock
 *
	mcuºMB
, 
Cﬁ‹Pœ√
 
	m∂
, 
	m¥edmode
);

565 (*
	mlöfo_cbp_öåa
 ) (
	mÀn
, 
	möfo
, *
	mcbp
, *
	mdummy
);

566 (*
	mlöfo_cbp_öãr
 ) (
	mÀn
, 
	möfo
, *
	mcbp
, *
	mdummy
);

567 (*
	mupd©e_dúe˘_mv_öfo
 ) (
Ma¸oblock
 *
	mcuºMB
);

568 (*
	mªad_c€ff_4x4_CAVLC
 ) (
Ma¸oblock
 *
	mcuºMB
, 
	mblock_ty≥
, 
	mi
, 
	mj
, 
	mÀv¨r
[16], 
	mru«º
[16], *
	mnumbî_c€fficõ¡s
);

570 } 
	tSli˚
;

572 
	sdecodedpic_t


574 
	mbVÆid
;

575 
	miVõwId
;

576 
	miPOC
;

577 
	miYUVF‹m©
;

578 
	miYUVSt‹ageF‹m©
;

579 
	miBôDïth
;

580 
byã
 *
	mpY
;

581 
byã
 *
	mpU
;

582 
byã
 *
	mpV
;

583 
	miWidth
;

584 
	miHeight
;

585 
	miYBufSåide
;

586 
	miUVBufSåide
;

587 
	miSkùPicNum
;

588 
	miBufSize
;

589 
decodedpic_t
 *
	mpNext
;

590 } 
	tDecodedPicLi°
;

593 
	scodög_∑r


595 
	mœyî_id
;

596 
	m¥ofûe_idc
;

597 
	mwidth
;

598 
	mheight
;

599 
	mwidth_¸
;

600 
	mheight_¸
;

602 
	mpic_unô_bôsize_⁄_disk
;

603 
	mbôdïth_luma
;

604 
	mbôdïth_chroma
;

605 
	mbôdïth_sˇÀ
[2];

606 
	mbôdïth_luma_qp_sˇÀ
;

607 
	mbôdïth_chroma_qp_sˇÀ
;

608 
	mdc_¥ed_vÆue_comp
[
MAX_PLANE
];

609 
	mmax_≥l_vÆue_comp
[
MAX_PLANE
];

611 
	myuv_f‹m©
;

612 
	mlos¶ess_qµrime_Êag
;

613 
	mnum_blk8x8_uv
;

614 
	mnum_uv_blocks
;

615 
	mnum_cdc_c€ff
;

616 
	mmb_¸_size_x
;

617 
	mmb_¸_size_y
;

618 
	mmb_¸_size_x_blk
;

619 
	mmb_¸_size_y_blk
;

620 
	mmb_¸_size
;

621 
	mmb_size
[3][2];

622 
	mmb_size_blk
[3][2];

623 
	mmb_size_shi·
[3][2];

625 
	mmax_vmv_r
;

626 
	m£∑øã_cﬁour_∂™e_Êag
;

627 
	mChromaAºayTy≥
;

628 
	mmax_‰ame_num
;

629 
	mPicWidthInMbs
;

630 
	mPicHeightInM≠Unôs
;

631 
	mFømeHeightInMbs
;

632 
	mFømeSizeInMbs
;

633 
	miLumaPadX
;

634 
	miLumaPadY
;

635 
	miChromaPadX
;

636 
	miChromaPadY
;

638 
	msub≥l_x
;

639 
	msub≥l_y
;

640 
	mshi·≥l_x
;

641 
	mshi·≥l_y
;

642 
	mtŸÆ_sˇÀ
;

643 
	mﬁdFømeSizeInMbs
;

646 (*
	mimg2buf
Ë(
img≥l
** 
	mimgX
, * 
	mbuf
, 
	msize_x
, 
	msize_y
, 
	msymbﬁ_size_ö_byãs
, 
	m¸›_À·
, 
	m¸›_right
, 
	m¸›_t›
, 
	m¸›_bŸtom
, 
	miOutSåide
);

647 
	mrgb_ouçut
;

649 
img≥l
 **
	mimgY_ªf
;

650 
img≥l
 ***
	mimgUV_ªf
;

651 
Ma¸oblock
 *
	mmb_d©a
;

652 
Ma¸oblock
 *
	mmb_d©a_JV
[
MAX_PLANE
];

653 *
	möåa_block
;

654 *
	möåa_block_JV
[
MAX_PLANE
];

655 
BlockPos
 *
	mPicPos
;

656 
byã
 **
	mùªdmode
;

657 
byã
 **
	mùªdmode_JV
[
MAX_PLANE
];

658 
byã
 ****
	mnz_c€ff
;

659 **
	msiblock
;

660 **
	msiblock_JV
[
MAX_PLANE
];

661 *
	mqp_≥r_m©rix
;

662 *
	mqp_ªm_m©rix
;

663 }
	tCodögP¨amëîs
;

665 
	sœyî_∑r


667 
	mœyî_id
;

668 
video_∑r
 *
	mp_Vid
;

669 
CodögP¨amëîs
 *
	mp_Cps
;

670 
£q_∑ømëî_£t_rb•_t
 *
	mp_SPS
;

671 
decoded_pi˘uª_buf„r
 *
	mp_Dpb
;

672 }
	tLayîP¨amëîs
;

675 
	svideo_∑r


677 
öp_∑r
 *
	mp_I≈
;

678 
pic_∑ømëî_£t_rb•_t
 *
	ma˘ive_µs
;

679 
£q_∑ømëî_£t_rb•_t
 *
	ma˘ive_•s
;

680 
£q_∑ømëî_£t_rb•_t
 
	mSeqP¨Së
[
MAXSPS
];

681 
pic_∑ømëî_£t_rb•_t
 
	mPicP¨Së
[
MAXPPS
];

682 
decoded_pi˘uª_buf„r
 *
	mp_Dpb_œyî
[
MAX_NUM_DPB_LAYERS
];

683 
CodögP¨amëîs
 *
	mp_EncodeP¨
[
MAX_NUM_DPB_LAYERS
];

684 
LayîP¨amëîs
 *
	mp_LayîP¨
[
MAX_NUM_DPB_LAYERS
];

686 #i‡(
MVC_EXTENSION_ENABLE
)

687 
sub£t_£q_∑ømëî_£t_rb•_t
 *
	ma˘ive_sub£t_•s
;

689 
sub£t_£q_∑ømëî_£t_rb•_t
 
	mSub£tSeqP¨Së
[
MAXSPS
];

690 
	mœ°_pic_width_ö_mbs_möus1
;

691 
	mœ°_pic_height_ö_m≠_unôs_möus1
;

692 
	mœ°_max_dec_‰ame_buf„rög
;

693 
	mœ°_¥ofûe_idc
;

696 
£i_∑øms
 *
	mp_SEI
;

698 
ﬁd_¶i˚_∑r
 *
	mﬁd_¶i˚
;

699 
¢r_∑r
 *
	m¢r
;

700 
	mnumbî
;

703 
	mnum_dec_mb
;

704 
	miSli˚NumOfCuºPic
;

705 
	miNumOfSli˚sAŒoˇãd
;

706 
	miNumOfSli˚sDecoded
;

707 
Sli˚
 **
	mµSli˚Li°
;

708 *
	möåa_block
;

709 *
	möåa_block_JV
[
MAX_PLANE
];

713 
	mty≥
;

715 
byã
 **
	mùªdmode
;

716 
byã
 **
	mùªdmode_JV
[
MAX_PLANE
];

717 
byã
 ****
	mnz_c€ff
;

718 **
	msiblock
;

719 **
	msiblock_JV
[
MAX_PLANE
];

720 
BlockPos
 *
	mPicPos
;

722 
	m√w‰ame
;

723 
	m°ru˘uª
;

726 
Sli˚
 *
	mpNextSli˚
;

727 
Ma¸oblock
 *
	mmb_d©a
;

728 
Ma¸oblock
 *
	mmb_d©a_JV
[
MAX_PLANE
];

730 
	mChromaAºayTy≥
;

735 
c⁄˚Æmít_node
 *
	mc⁄˚Æmít_hód
;

736 
c⁄˚Æmít_node
 *
	mc⁄˚Æmít_íd
;

738 
	m¥e_‰ame_num
;

739 
	mn⁄_c⁄f‹mög_°ªam
;

743 sig√d 
	mPªvPicOrdîC¡Msb
;

744 
	mPªvPicOrdîC¡Lsb
;

747 sig√d 
	mEx≥˘edPicOrdîC¡
, 
	mPicOrdîC¡Cy˛eC¡
, 
	mFømeNumInPicOrdîC¡Cy˛e
;

748 
	mPªviousFømeNum
, 
	mFømeNumOff£t
;

749 
	mEx≥˘edDñèPîPicOrdîC¡Cy˛e
;

750 
	mThisPOC
;

751 
	mPªviousFømeNumOff£t
;

754 
	mPicHeightInMbs
;

755 
	mPicSizeInMbs
;

757 
	mno_ouçut_of_¥i‹_pics_Êag
;

759 
	mœ°_has_mmco_5
;

760 
	mœ°_pic_bŸtom_fõld
;

762 
	midr_p¢r_numbî
;

763 
	mp¢r_numbî
;

766 
TIME_T
 
	m°¨t_time
;

767 
TIME_T
 
	míd_time
;

770 
	mœ°_ªf_pic_poc
;

771 
	mªf_poc_g≠
;

772 
	mpoc_g≠
;

773 
	mc⁄˚Æ_mode
;

774 
	móæõr_missög_poc
;

775 
	m‰ame_to_c⁄˚Æ
;

776 
	mIDR_c⁄˚Æmít_Êag
;

777 
	mc⁄˚Æ_¶i˚_ty≥
;

779 
Boﬁón
 
	mfú°_•s
;

781 
	mªcovîy_poöt
;

782 
	mªcovîy_poöt_found
;

783 
	mªcovîy_‰ame_˙t
;

784 
	mªcovîy_‰ame_num
;

785 
	mªcovîy_poc
;

787 
byã
 *
	mbuf
;

788 
byã
 *
	mibuf
;

790 
ImageD©a
 
	mimgD©a
;

791 
ImageD©a
 
	mimgD©a0
;

792 
ImageD©a
 
	mimgD©a1
;

793 
ImageD©a
 
	mimgD©a2
;

796 
ImageD©a
 
	mimgD©a32
;

797 
ImageD©a
 
	mimgD©a4
;

798 
ImageD©a
 
	mimgD©a5
;

799 
ImageD©a
 
	mimgD©a6
;

803 
	m¥evious_‰ame_num
;

805 
	mIs_¥im¨y_c‹ª˘
;

806 
	mIs_ªdund™t_c‹ª˘
;

809 
öt64
 
	mtŸ_time
;

812 
	mp_out
;

813 #i‡(
MVC_EXTENSION_ENABLE
)

814 
	mp_out_mvc
[
MAX_VIEW_NUM
];

816 
	mp_ªf
;

819 
	mLa°Ac˚ssUnôExi°s
;

820 
	mNALUCou¡
;

823 
	mB‰ame_˘r
;

824 
	m‰ame_no
;

826 
	mg_nFøme
;

827 
Boﬁón
 
	mglobÆ_öô_d⁄e
[2];

830 
img≥l
 **
	mimgY_ªf
;

831 
img≥l
 ***
	mimgUV_ªf
;

833 *
	mqp_≥r_m©rix
;

834 *
	mqp_ªm_m©rix
;

836 
‰ame_°‹e
 *
	mœ°_out_fs
;

837 
	mpocs_ö_dpb
[100];

839 
°‹abÀ_pi˘uª
 *
	mdec_pi˘uª
;

840 
°‹abÀ_pi˘uª
 *
	mdec_pi˘uª_JV
[
MAX_PLANE
];

841 
°‹abÀ_pi˘uª
 *
	mno_ª„ªn˚_pi˘uª
;

844 
obje˘_buf„r
 *
	mîc_obje˘_li°
;

845 
îcV¨übÀs_s
 *
	mîc_îr‹V¨
;

847 
	mîc_mv≥rMB
;

848 
video_∑r
 *
	mîc_img
;

849 
	mec_Êag
[
SE_MAX_ELEMENTS
];

851 
™√x_b_°ru˘
 *
	m™√x_b
;

853 
‰ame_°‹e
 *
	mout_buf„r
;

855 
°‹abÀ_pi˘uª
 *
	m≥ndög_ouçut
;

856 
	m≥ndög_ouçut_°©e
;

857 
	mªcovîy_Êag
;

859 
	mBôSåómFûe
;

862 
	mc¶i˚_ty≥
[9];

864 *
	mMbToSli˚GroupM≠
;

865 *
	mM≠UnôToSli˚GroupM≠
;

866 
	mNumbîOfSli˚Groups
;

868 #i‡(
ENABLE_OUTPUT_TONEMAPPING
)

869 
t⁄e_m≠pög_°ru˘_s
 *
	m£iT⁄eM≠pög
;

872 (*
	mbuf2img
Ë(
img≥l
** 
	mimgX
, * 
	mbuf
, 
	msize_x
, 
	msize_y
, 
	mo_size_x
, 
	mo_size_y
, 
	msymbﬁ_size_ö_byãs
, 
	mbôshi·
);

873 (*
	mgëNeighbour
Ë(
Ma¸oblock
 *
	mcuºMB
, 
	mxN
, 
	myN
, 
	mmb_size
[2], 
PixñPos
 *
	mpix
);

874 (*
	mgë_mb_block_pos
Ë(
BlockPos
 *
	mPicPos
, 
	mmb_addr
, *
	mx
, *
	my
);

875 (*
	mGëSåígthVî
Ë(
Ma¸oblock
 *
	mMbQ
, 
	medge
, 
	mmvlimô
, 
°‹abÀ_pi˘uª
 *
	mp
);

876 (*
	mGëSåígthH‹
Ë(
Ma¸oblock
 *
	mMbQ
, 
	medge
, 
	mmvlimô
, 
°‹abÀ_pi˘uª
 *
	mp
);

877 (*
	mEdgeLo›LumaVî
Ë(
Cﬁ‹Pœ√
 
	m∂
, 
img≥l
** 
	mImg
, 
byã
 *
	mSåígth
, 
Ma¸oblock
 *
	mMbQ
, 
	medge
);

878 (*
	mEdgeLo›LumaH‹
Ë(
Cﬁ‹Pœ√
 
	m∂
, 
img≥l
** 
	mImg
, 
byã
 *
	mSåígth
, 
Ma¸oblock
 *
	mMbQ
, 
	medge
, 
°‹abÀ_pi˘uª
 *
	mp
);

879 (*
	mEdgeLo›ChromaVî
)(
img≥l
** 
	mImg
, 
byã
 *
	mSåígth
, 
Ma¸oblock
 *
	mMbQ
, 
	medge
, 
	muv
, 
°‹abÀ_pi˘uª
 *
	mp
);

880 (*
	mEdgeLo›ChromaH‹
)(
img≥l
** 
	mImg
, 
byã
 *
	mSåígth
, 
Ma¸oblock
 *
	mMbQ
, 
	medge
, 
	muv
, 
°‹abÀ_pi˘uª
 *
	mp
);

881 (*
	mimg2buf
Ë(
img≥l
** 
	mimgX
, * 
	mbuf
, 
	msize_x
, 
	msize_y
, 
	msymbﬁ_size_ö_byãs
, 
	m¸›_À·
, 
	m¸›_right
, 
	m¸›_t›
, 
	m¸›_bŸtom
, 
	miOutSåide
);

883 
ImageD©a
 
	mãmpD©a3
;

884 
DecodedPicLi°
 *
	mpDecOuputPic
;

885 
	miDeblockMode
;

886 
«lu_t
 *
	m«lu
;

887 
	miLumaPadX
;

888 
	miLumaPadY
;

889 
	miChromaPadX
;

890 
	miChromaPadY
;

892 
	mbDeblockE«bÀ
;

893 
	miPo°Pro˚ss
;

894 
	mbFømeInô
;

895 #i‡
_FLTDBG_


896 
FILE
 *
	mÂDbg
;

898 
pic_∑ømëî_£t_rb•_t
 *
	mpNextPPS
;

899 
	mœ°_dec_poc
;

900 
	mœ°_dec_võw_id
;

901 
	mœ°_dec_œyî_id
;

902 
	mdpb_œyî_id
;

905 
	mwidth
;

906 
	mheight
;

907 
	mwidth_¸
;

908 
	mheight_¸
;

910 
	mpic_unô_bôsize_⁄_disk
;

911 
	mbôdïth_luma
;

912 
	mbôdïth_chroma
;

913 
	mbôdïth_sˇÀ
[2];

914 
	mbôdïth_luma_qp_sˇÀ
;

915 
	mbôdïth_chroma_qp_sˇÀ
;

916 
	mdc_¥ed_vÆue_comp
[
MAX_PLANE
];

917 
	mmax_≥l_vÆue_comp
[
MAX_PLANE
];

919 
	m£∑øã_cﬁour_∂™e_Êag
;

920 
	mpic_unô_size_⁄_disk
;

922 
	m¥ofûe_idc
;

923 
	myuv_f‹m©
;

924 
	mlos¶ess_qµrime_Êag
;

925 
	mnum_blk8x8_uv
;

926 
	mnum_uv_blocks
;

927 
	mnum_cdc_c€ff
;

928 
	mmb_¸_size_x
;

929 
	mmb_¸_size_y
;

930 
	mmb_¸_size_x_blk
;

931 
	mmb_¸_size_y_blk
;

932 
	mmb_¸_size
;

933 
	mmb_size
[3][2];

934 
	mmb_size_blk
[3][2];

935 
	mmb_size_shi·
[3][2];

936 
	msub≥l_x
;

937 
	msub≥l_y
;

938 
	mshi·≥l_x
;

939 
	mshi·≥l_y
;

940 
	mtŸÆ_sˇÀ
;

941 
	mmax_‰ame_num
;

943 
	mPicWidthInMbs
;

944 
	mPicHeightInM≠Unôs
;

945 
	mFømeHeightInMbs
;

946 
	mFømeSizeInMbs
;

947 
	mﬁdFømeSizeInMbs
;

948 
	mmax_vmv_r
;

952 
dec_°©_∑ømëîs
 *
	mdec_°©s
;

953 } 
	tVideoP¨amëîs
;

957 
	s¢r_∑r


959 
	m‰ame_˘r
;

960 
	m¢r
[3];

961 
	m¢r1
[3];

962 
	m¢ø
[3];

963 
	ms£
[3];

964 
	mms£
[3];

965 } 
	tSNRP¨amëîs
;

968 
	söp_∑r


970 
	möfûe
[
FILE_NAME_SIZE
];

971 
	moutfûe
[
FILE_NAME_SIZE
];

972 
	mªffûe
[
FILE_NAME_SIZE
];

974 
	mFûeF‹m©
;

975 
	mªf_off£t
;

976 
	mpoc_sˇÀ
;

977 
	mwrôe_uv
;

978 
	msûít
;

979 
	möåa_¥ofûe_deblockög
;

982 
FømeF‹m©
 
	msour˚
;

983 
FømeF‹m©
 
	mouçut
;

985 
	mPro˚ssI≈ut
;

986 
	míabÀ_32_puŒdown
;

987 
VideoD©aFûe
 
	möput_fûe1
;

988 
VideoD©aFûe
 
	möput_fûe2
;

989 
VideoD©aFûe
 
	möput_fûe3
;

990 #i‡(
MVC_EXTENSION_ENABLE
)

991 
	mDecodeAŒLayîs
;

994 #ifde‡
_LEAKYBUCKET_


995 
	mR_decodî
;

996 
	mB_decodî
;

997 
	mF_decodî
;

998 
	mLókyBuckëP¨amFûe
[
FILE_NAME_SIZE
];

1002 
	mc⁄˚Æ_mode
;

1003 
	mªf_poc_g≠
;

1004 
	mpoc_g≠
;

1008 
	m°¨t_‰ame
;

1011 
	m°dR™ge
;

1012 
	mvideoCode
;

1013 
	mexp‹t_võws
;

1015 
	miDecFrmNum
;

1017 
	mbDi•œyDecP¨ams
;

1018 
	mdpb_∂us
[2];

1019 } 
	tI≈utP¨amëîs
;

1021 
	sﬁd_¶i˚_∑r


1023 
	mfõld_pic_Êag
;

1024 
	m‰ame_num
;

1025 
	m«l_ªf_idc
;

1026 
	mpic_odî_˙t_lsb
;

1027 
	mdñè_pic_odî_˙t_bŸtom
;

1028 
	mdñè_pic_‹dî_˙t
[2];

1029 
byã
 
	mbŸtom_fõld_Êag
;

1030 
byã
 
	midr_Êag
;

1031 
	midr_pic_id
;

1032 
	mµs_id
;

1033 #i‡(
MVC_EXTENSION_ENABLE
)

1034 
	mvõw_id
;

1035 
	möãr_võw_Êag
;

1036 
	m™ch‹_pic_Êag
;

1038 
	mœyî_id
;

1039 } 
	tOldSli˚P¨ams
;

1041 
	sdecodî_∑øms


1043 
I≈utP¨amëîs
 *
	mp_I≈
;

1044 
VideoP¨amëîs
 *
	mp_Vid
;

1045 
öt64
 
	mbuf„rSize
;

1046 
	mU£dBôs
;

1047 
FILE
 *
	mp_åa˚
;

1048 
	mbôcou¡î
;

1049 } 
	tDecodîP¨ams
;

1051 
DecodîP¨ams
 *
p_Dec
;

1054 
îr‹
(*
ãxt
, 
code
);

1057 
öô_globÆ_buf„rs
–
VideoP¨amëîs
 *
p_Vid
, 
œyî_id
 );

1058 
‰ì_globÆ_buf„rs
–
VideoP¨amëîs
 *
p_Vid
);

1059 
‰ì_œyî_buf„rs
–
VideoP¨amëîs
 *
p_Vid
, 
œyî_id
 );

1061 
RBSPtoSODB
(
byã
 *
°ªamBuf„r
, 
œ°_byã_pos
);

1062 
EBSPtoRBSP
(
byã
 *
°ªamBuf„r
, 
íd_byãpos
, 
begö_byãpos
);

1064 
FªeP¨tôi⁄
 (
D©aP¨tôi⁄
 *
dp
, 
n
);

1065 
D©aP¨tôi⁄
 *
AŒocP¨tôi⁄
(
n
);

1067 
åa˚bôs
 (c⁄° *
åa˚_°r
, 
Àn
, 
öfo
, 
vÆue1
);

1068 
åa˚bôs2
(c⁄° *
åa˚_°r
, 
Àn
, 
öfo
);

1070 
CeûLog2
 ( 
uiVÆ
);

1071 
CeûLog2_sf
–
uiVÆ
);

1074 
ch™ge_∂™e_JV
 ( 
VideoP¨amëîs
 *
p_Vid
, 
≈œ√
, 
Sli˚
 *
pSli˚
);

1075 
make_‰ame_pi˘uª_JV
–
VideoP¨amëîs
 *
p_Vid
 );

1077 #i‡(
MVC_EXTENSION_ENABLE
)

1078 
«l_unô_hódî_mvc_exãnsi⁄
(
NALUnôHódîMVCExt_t
 *
NÆuHódîMVCExt
, 
bô_°ªam_dec
 *
bô°ªam
);

1081 
FªeDecPicLi°
 ( 
DecodedPicLi°
 *
pDecPicLi°
 );

1082 
CÀ¨DecPicLi°
–
VideoP¨amëîs
 *
p_Vid
 );

1083 
DecodedPicLi°
 *
gë_⁄e_avaû_dec_pic_‰om_li°
(DecodedPicLi° *
pDecPicLi°
, 
b3D
, 
võw_id
);

1084 
Sli˚
 *
mÆloc_¶i˚
–
I≈utP¨amëîs
 *
p_I≈
, 
VideoP¨amëîs
 *
p_Vid
 );

1085 
c›y_¶i˚_öfo
 ( 
Sli˚
 *
cuºSli˚
, 
OldSli˚P¨ams
 *
p_ﬁd_¶i˚
 );

1086 
O≥nOuçutFûes
(
VideoP¨amëîs
 *
p_Vid
, 
võw0_id
, 
võw1_id
);

1087 
£t_globÆ_codög_∑r
(
VideoP¨amëîs
 *
p_Vid
, 
CodögP¨amëîs
 *
˝s
);

1089 
ölöe
 
	$is_FREXT_¥ofûe
(
¥ofûe_idc
)

1091  ( 
¥ofûe_idc
 >
FREXT_HP
 ||Örofûe_id¯=
FREXT_CAVLC444
 );

1092 
	}
}

1093 
ölöe
 
	$HI_öåa_⁄ly_¥ofûe
(
¥ofûe_idc
, 
Boﬁón
 
c⁄°øöed_£t3_Êag
)

1095  ( ((
¥ofûe_idc
 >
FREXT_Hi10P
Ë&& 
c⁄°øöed_£t3_Êag
Ë|| (¥ofûe_id¯=
FREXT_CAVLC444
) );

1096 
	}
}

1097 
ölöe
 
	$is_BL_¥ofûe
(
¥ofûe_idc
)

1099  ( 
¥ofûe_idc
 =
FREXT_CAVLC444
 ||Örofûe_id¯=
BASELINE
 ||Örofûe_id¯=
MAIN
 ||Örofûe_id¯=
EXTENDED
 ||

1100 
¥ofûe_idc
 =
FREXT_HP
 ||Örofûe_id¯=
FREXT_Hi10P
 ||Örofûe_id¯=
FREXT_Hi422
 ||Örofûe_id¯=
FREXT_Hi444
);

1101 
	}
}

1102 
ölöe
 
	$is_EL_¥ofûe
(
¥ofûe_idc
)

1104  ( (
¥ofûe_idc
 =
MVC_HIGH
Ë|| (¥ofûe_id¯=
STEREO_HIGH
)

1106 
	}
}

1108 
ölöe
 
	$is_MVC_¥ofûe
(
¥ofûe_idc
)

1111 #i‡(
MVC_EXTENSION_ENABLE
)

1112 || (
¥ofûe_idc
 =
MVC_HIGH
Ë|| (¥ofûe_id¯=
STEREO_HIGH
)

1115 
	}
}

	@ldecod/inc/h264decoder.h

14 #i‚de‡
_H264DECODER_H_


15 
	#_H264DECODER_H_


	)

17 
	~"globÆ.h
"

21 
	mDEC_GEN_NOERR
 = 0,

22 
	mDEC_OPEN_NOERR
 = 0,

23 
	mDEC_CLOSE_NOERR
 = 0,

24 
	mDEC_SUCCEED
 = 0,

25 
	mDEC_EOS
 =1,

26 
	mDEC_NEED_DATA
 = 2,

27 
	mDEC_INVALID_PARAM
 = 3,

28 
	mDEC_ERRMASK
 = 0x8000

30 }
	tDecEºCode
;

32 
	sdec_£t_t


34 
	miPo°¥ocLevñ
;

35 
	mbDBE«bÀ
;

36 
	mbAŒLayîs
;

37 
	mtime_ö¸
;

38 
	mbDecCompAd≠t
;

39 } 
	tDecSë_t
;

41 #ifde‡
__˝lu•lus


45 
O≥nDecodî
(
I≈utP¨amëîs
 *
p_I≈
);

46 
DecodeO√Føme
(
DecodedPicLi°
 **
µDecPic
);

47 
FöôDecodî
(
DecodedPicLi°
 **
µDecPicLi°
);

48 
Clo£Decodî
();

49 
SëO±sDecodî
(
DecSë_t
 *
pDecO±s
);

51 #ifde‡
__˝lu•lus


	@ldecod/inc/header.h

10 #i‚de‡
_HEADER_H_


11 
	#_HEADER_H_


	)

13 
Fú°P¨tOfSli˚Hódî
(
Sli˚
 *
cuºSli˚
);

14 
Re°OfSli˚Hódî
 (
Sli˚
 *
cuºSli˚
);

16 
dec_ªf_pic_m¨kög
(
VideoP¨amëîs
 *
p_Vid
, 
Bô°ªam
 *
cuºSåóm
, 
Sli˚
 *
pSli˚
);

18 
decode_poc
(
VideoP¨amëîs
 *
p_Vid
, 
Sli˚
 *
pSli˚
);

19 
dumµoc
 (
VideoP¨amëîs
 *
p_Vid
);

	@ldecod/inc/image.h

12 #i‚de‡
_IMAGE_H_


13 
	#_IMAGE_H_


	)

15 
	~"mbuf„r.h
"

17 
ˇlcuœã_‰ame_no
(
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
p
);

18 
föd_¢r
 (
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
p
, *
p_ªf
);

19 
pi˘uª_‹dî
 ( 
Sli˚
 *
pSli˚
 );

21 
decode_⁄e_¶i˚
 (
Sli˚
 *
cuºSli˚
);

22 
ªad_√w_¶i˚
 (
Sli˚
 *
cuºSli˚
);

23 
exô_pi˘uª
 (
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 **
dec_pi˘uª
);

24 
decode_⁄e_‰ame
 (
DecodîP¨ams
 *
pDecodî
);

26 
is_√w_pi˘uª
(
St‹abÀPi˘uª
 *
dec_pi˘uª
, 
Sli˚
 *
cuºSli˚
, 
OldSli˚P¨ams
 *
p_ﬁd_¶i˚
);

27 
öô_ﬁd_¶i˚
(
OldSli˚P¨ams
 *
p_ﬁd_¶i˚
);

29 
c›y_dec_pi˘uª_JV
 (
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
d°
, St‹abÀPi˘uª *
§c
 );

31 
‰ame_po°¥o˚ssög
(
VideoP¨amëîs
 *
p_Vid
);

32 
fõld_po°¥o˚ssög
(
VideoP¨amëîs
 *
p_Vid
);

34 #i‡(
MVC_EXTENSION_ENABLE
)

35 
GëVõwIdx
(
VideoP¨amëîs
 *
p_Vid
, 
iVOIdx
);

36 
GëVOIdx
(
VideoP¨amëîs
 *
p_Vid
, 
iVõwId
);

37 
gë_maxVõwIdx
(
VideoP¨amëîs
 *
p_Vid
, 
võw_id
, 
™ch‹_pic_Êag
, 
li°idx
);

40 
öô_¶i˚
(
VideoP¨amëîs
 *
p_Vid
, 
Sli˚
 *
cuºSli˚
);

41 
decode_¶i˚
(
Sli˚
 *
cuºSli˚
, 
cuºít_hódî
);

	@ldecod/inc/intra16x16_pred.h

16 #i‚de‡
_INTRA16x16_PRED_H_


17 
	#_INTRA16x16_PRED_H_


	)

19 
	~"globÆ.h
"

20 
	~"mbuf„r.h
"

22 
öåa_¥ed_16x16_mbaff
 (
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
¥edmode
);

23 
öåa_¥ed_16x16_n‹mÆ
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
¥edmode
);

	@ldecod/inc/intra4x4_pred.h

16 #i‚de‡
_INTRA4x4_PRED_H_


17 
	#_INTRA4x4_PRED_H_


	)

19 
	~"globÆ.h
"

20 
	~"mbuf„r.h
"

22 
öåa_¥ed_4x4_mbaff
 (
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
ioff
, 
joff
, 
img_block_x
, 
img_block_y
);

23 
öåa_¥ed_4x4_n‹mÆ
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
ioff
, 
joff
, 
img_block_x
, 
img_block_y
);

	@ldecod/inc/intra8x8_pred.h

16 #i‚de‡
_INTRA8x8_PRED_H_


17 
	#_INTRA8x8_PRED_H_


	)

19 
	~"globÆ.h
"

20 
	~"mbuf„r.h
"

22 
öåa_¥ed_8x8_n‹mÆ
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
ioff
, 
joff
);

23 
öåa_¥ed_8x8_mbaff
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
ioff
, 
joff
);

	@ldecod/inc/leaky_bucket.h

14 #i‚de‡
_LEAKY_BUCKET_H_


15 
	#_LEAKY_BUCKET_H_


	)

17 
	~"globÆ.h
"

19 #ifde‡
_LEAKYBUCKET_


21 
GëBigDoubÀW‹d
(
FILE
 *
Â
);

22 
ˇlc_buf„r
(
I≈utP¨amëîs
 *
p_I≈
);

	@ldecod/inc/loop_filter.h

18 #i‚de‡
_LOOP_FILTER_H_


19 
	#_LOOP_FILTER_H_


	)

21 
	~"globÆ.h
"

24 
	#GROUP_SIZE
 1

	)

36 c⁄° 
byã
 
	gALPHA_TABLE
[52] = {0,0,0,0,0,0,0,0,0,0,0,0, 0,0,0,0,4,4,5,6, 7,8,9,10,12,13,15,17, 20,22,25,28,32,36,40,45, 50,56,63,71,80,90,101,113, 127,144,162,182,203,226,255,255} ;

37 c⁄° 
byã
 
	gBETA_TABLE
[52] = {0,0,0,0,0,0,0,0,0,0,0,0, 0,0,0,0,2,2,2,3, 3,3,3, 4, 4, 4, 6, 6, 7, 7, 8, 8, 9, 9,10,10, 11,11,12,12,13,13, 14, 14, 15, 15, 16, 16, 17, 17, 18, 18} ;

38 c⁄° 
byã
 
	gCLIP_TAB
[52][5] =

49 c⁄° 
	gchroma_edge
[2][4][4] =

60 c⁄° 
	g≥ um_¸
[2][4] = {{0,8,16,16}, {0,8, 8,16}};

63 
ölöe
 
	$com∑ª_mvs
(c⁄° 
MŸi⁄Ve˘‹
 *
mv0
, c⁄° MŸi⁄Ve˘‹ *
mv1
, 
mvlimô
)

65  ((
	`übs
–
mv0
->
mv_x
 - 
mv1
->mv_xË>4Ë| (übs–mv0->
mv_y
 - mv1->mv_yË>
mvlimô
));

66 
	}
}

	@ldecod/inc/loopfilter.h

10 #i‚de‡
_LOOPFILTER_H_


11 
	#_LOOPFILTER_H_


	)

13 
	~"globÆ.h
"

14 
	~"mbuf„r.h
"

16 
DeblockPi˘uª
(
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
p
) ;

18 
öô_Deblock
(
VideoP¨amëîs
 *
p_Vid
, 
mb_aff_‰ame_Êag
);

	@ldecod/inc/macroblock.h

14 #i‚de‡
_MACROBLOCK_H_


15 
	#_MACROBLOCK_H_


	)

17 
	~"globÆ.h
"

18 
	~"mbuf„r.h
"

19 
	~"block.h
"

22 c⁄° 
byã
 
	gSNGL_SCAN
[16][2] =

31 c⁄° 
byã
 
	gFIELD_SCAN
[16][2] =

40 c⁄° 
	gBLOCK_STEP
[8][2]=

46 c⁄° 
byã
 
	gSNGL_SCAN8x8
[64][2] = {

55 c⁄° 
byã
 
	gFIELD_SCAN8x8
[64][2] = {

63 c⁄° 
byã
 
	gSCAN_YUV422
[8][2] =

71 c⁄° 
	gcbp_blk_chroma
[8][4] =

82 c⁄° 
	gcofuv_blk_x
[3][8][4] =

111 c⁄° 
	gcofuv_blk_y
[3][8][4] =

141 
£tup_¶i˚_mëhods_mbaff
(
Sli˚
 *
cuºSli˚
);

142 
£tup_¶i˚_mëhods
 (
Sli˚
 *
cuºSli˚
);

143 
gë_√ighb‹s
(
Ma¸oblock
 *
cuºMB
, 
PixñPos
 *
block
, 
mb_x
, 
mb_y
, 
blocksh≠e_x
);

145 
°¨t_ma¸oblock
 (
Sli˚
 *
cuºSli˚
, 
Ma¸oblock
 **
cuºMB
);

146 
decode_⁄e_ma¸oblock
(
Ma¸oblock
 *
cuºMB
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
);

147 
Boﬁón
 
exô_ma¸oblock
 (
Sli˚
 *
cuºSli˚
, 
eos_bô
);

148 
upd©e_qp
 (
Ma¸oblock
 *
cuºMB
, 
qp
);

	@ldecod/inc/mb_prediction.h

15 #i‚de‡
_MB_PREDICTION_H_


16 
	#_MB_PREDICTION_H_


	)

18 
mb_¥ed_öåa4x4
 (
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
cuº_∂™e
, 
img≥l
 **
cuºImg
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
);

19 
mb_¥ed_öåa16x16
 (
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
cuº_∂™e
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
);

20 
mb_¥ed_öåa8x8
 (
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
cuº_∂™e
, 
img≥l
 **
cuºImg
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
);

22 
mb_¥ed_skù
 (
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
cuº_∂™e
, 
img≥l
 **
cuºImg
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
);

23 
mb_¥ed_•_skù
 (
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
cuº_∂™e
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
);

24 
mb_¥ed_p_öãr8x8
 (
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
cuº_∂™e
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
);

25 
mb_¥ed_p_öãr16x16
 (
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
cuº_∂™e
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
);

26 
mb_¥ed_p_öãr16x8
 (
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
cuº_∂™e
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
);

27 
mb_¥ed_p_öãr8x16
 (
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
cuº_∂™e
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
);

28 
mb_¥ed_b_d4x4•©ül
 (
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
cuº_∂™e
, 
img≥l
 **
cuºImg
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
);

29 
mb_¥ed_b_d8x8•©ül
 (
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
cuº_∂™e
, 
img≥l
 **
cuºImg
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
);

30 
mb_¥ed_b_d4x4ãmp‹Æ
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
cuº_∂™e
, 
img≥l
 **
cuºImg
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
);

31 
mb_¥ed_b_d8x8ãmp‹Æ
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
cuº_∂™e
, 
img≥l
 **
cuºImg
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
);

32 
mb_¥ed_b_öãr8x8
 (
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
cuº_∂™e
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
);

33 
mb_¥ed_ùcm
 (
Ma¸oblock
 *
cuºMB
);

	@ldecod/inc/mbuffer.h

21 #i‚de‡
_MBUFFERDEC_H_


22 
	#_MBUFFERDEC_H_


	)

24 
	~"globÆ.h
"

26 
	#MAX_LIST_SIZE
 33

	)

28 
	spic_mŸi⁄_∑øms_ﬁd


30 
byã
 * 
	mmb_fõld
;

31 } 
	tPicMŸi⁄P¨amsOld
;

34 
	spic_mŸi⁄_∑øms


36 
°‹abÀ_pi˘uª
 *
	mªf_pic
[2];

37 
MŸi⁄Ve˘‹
 
	mmv
[2];

38 
	mªf_idx
[2];

40 
byã
 
	m¶i˚_no
;

41 } 
	tPicMŸi⁄P¨ams
;

44 
	s°‹abÀ_pi˘uª


46 
Pi˘uªSåu˘uª
 
	m°ru˘uª
;

48 
	mpoc
;

49 
	mt›_poc
;

50 
	mbŸtom_poc
;

51 
	m‰ame_poc
;

52 
	m‰ame_num
;

53 
	mªcovîy_‰ame
;

55 
	mpic_num
;

56 
	ml⁄g_ãrm_pic_num
;

57 
	ml⁄g_ãrm_‰ame_idx
;

59 
byã
 
	mis_l⁄g_ãrm
;

60 
	mu£d_f‹_ª„ªn˚
;

61 
	mis_ouçut
;

62 
	mn⁄_exi°ög
;

63 
	m£∑øã_cﬁour_∂™e_Êag
;

65 
	mmax_¶i˚_id
;

67 
	msize_x
, 
	msize_y
, 
	msize_x_¸
, 
	msize_y_¸
;

68 
	msize_x_m1
, 
	msize_y_m1
, 
	msize_x_¸_m1
, 
	msize_y_¸_m1
;

69 
	mcoded_‰ame
;

70 
	mmb_aff_‰ame_Êag
;

71 
	mPicWidthInMbs
;

72 
	mPicSizeInMbs
;

73 
	miLumaPadY
, 
	miLumaPadX
;

74 
	miChromaPadY
, 
	miChromaPadX
;

77 
img≥l
 ** 
	mimgY
;

78 
img≥l
 *** 
	mimgUV
;

80 
pic_mŸi⁄_∑øms
 **
	mmv_öfo
;

81 
pic_mŸi⁄_∑øms
 **
	mJVmv_öfo
[
MAX_PLANE
];

83 
pic_mŸi⁄_∑øms_ﬁd
 
	mmŸi⁄
;

84 
pic_mŸi⁄_∑øms_ﬁd
 
	mJVmŸi⁄
[
MAX_PLANE
];

86 
°‹abÀ_pi˘uª
 *
	mt›_fõld
;

87 
°‹abÀ_pi˘uª
 *
	mbŸtom_fõld
;

88 
°‹abÀ_pi˘uª
 *
	m‰ame
;

90 
	m¶i˚_ty≥
;

91 
	midr_Êag
;

92 
	mno_ouçut_of_¥i‹_pics_Êag
;

93 
	ml⁄g_ãrm_ª„ªn˚_Êag
;

94 
	mad≠tive_ªf_pic_buf„rög_Êag
;

96 
	mchroma_f‹m©_idc
;

97 
	m‰ame_mbs_⁄ly_Êag
;

98 
	m‰ame_¸›pög_Êag
;

99 
	m‰ame_¸›_À·_off£t
;

100 
	m‰ame_¸›_right_off£t
;

101 
	m‰ame_¸›_t›_off£t
;

102 
	m‰ame_¸›_bŸtom_off£t
;

103 
	mqp
;

104 
	mchroma_qp_off£t
[2];

105 
	m¶i˚_qp_dñè
;

106 
DecRefPicM¨kög_t
 *
	mdec_ªf_pic_m¨kög_buf„r
;

109 
	mc⁄˚Æed_pic
;

112 
	m£iHasT⁄e_m≠pög
;

113 
	mt⁄e_m≠pög_modñ_id
;

114 
	mt⁄em≠≥d_bô_dïth
;

115 
img≥l
* 
	mt⁄e_m≠pög_lut
;

117 
	m¥oc_Êag
;

118 #i‡(
MVC_EXTENSION_ENABLE
)

119 
	mvõw_id
;

120 
	möãr_võw_Êag
;

121 
	m™ch‹_pic_Êag
;

123 
	miLumaSåide
;

124 
	miChromaSåide
;

125 
	miLumaEx∑ndedHeight
;

126 
	miChromaEx∑ndedHeight
;

127 
img≥l
 **
	mcur_imgY
;

128 
	mno_ªf
;

129 
	miCodögTy≥
;

131 
	mli°Xsize
[
MAX_NUM_SLICES
][2];

132 
°‹abÀ_pi˘uª
 **
	mli°X
[
MAX_NUM_SLICES
][2];

133 
	mœyî_id
;

134 } 
	tSt‹abÀPi˘uª
;

136 
St‹abÀPi˘uª
 *
	tSt‹abÀPi˘uªPå
;

139 
	s‰ame_°‹e


141 
	mis_u£d
;

142 
	mis_ª„ªn˚
;

143 
	mis_l⁄g_ãrm
;

144 
	mis_‹ig_ª„ªn˚
;

146 
	mis_n⁄_exi°ít
;

148 
	m‰ame_num
;

149 
	mªcovîy_‰ame
;

151 
	m‰ame_num_wøp
;

152 
	ml⁄g_ãrm_‰ame_idx
;

153 
	mis_ouçut
;

154 
	mpoc
;

157 
	mc⁄˚Æmít_ª„ªn˚
;

159 
St‹abÀPi˘uª
 *
	m‰ame
;

160 
St‹abÀPi˘uª
 *
	mt›_fõld
;

161 
St‹abÀPi˘uª
 *
	mbŸtom_fõld
;

163 #i‡(
MVC_EXTENSION_ENABLE
)

164 
	mvõw_id
;

165 
	möãr_võw_Êag
[2];

166 
	m™ch‹_pic_Êag
[2];

168 
	mœyî_id
;

169 } 
	tFømeSt‹e
;

173 
	sdecoded_pi˘uª_buf„r


175 
VideoP¨amëîs
 *
	mp_Vid
;

176 
I≈utP¨amëîs
 *
	mp_I≈
;

177 
FømeSt‹e
 **
	mfs
;

178 
FømeSt‹e
 **
	mfs_ªf
;

179 
FømeSt‹e
 **
	mfs_…ªf
;

180 
FømeSt‹e
 **
	mfs_ûªf
;

181 
	msize
;

182 
	mu£d_size
;

183 
	mªf_‰ames_ö_buf„r
;

184 
	m…ªf_‰ames_ö_buf„r
;

185 
	mœ°_ouçut_poc
;

186 #i‡(
MVC_EXTENSION_ENABLE
)

187 
	mœ°_ouçut_võw_id
;

189 
	mmax_l⁄g_ãrm_pic_idx
;

192 
	möô_d⁄e
;

193 
	mnum_ªf_‰ames
;

195 
FømeSt‹e
 *
	mœ°_pi˘uª
;

196 
	mu£d_size_û
;

197 
	mœyî_id
;

201 } 
	tDecodedPi˘uªBuf„r
;

204 
öô_dpb
(
VideoP¨amëîs
 *
p_Vid
, 
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
ty≥
);

205 
ª_öô_dpb
(
VideoP¨amëîs
 *
p_Vid
, 
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
ty≥
);

206 
‰ì_dpb
(
DecodedPi˘uªBuf„r
 *
p_Dpb
);

207 
FømeSt‹e
* 
Æloc_‰ame_°‹e
();

208 
‰ì_‰ame_°‹e
 (
FømeSt‹e
* 
f
);

209 
St‹abÀPi˘uª
* 
Æloc_°‹abÀ_pi˘uª
(
VideoP¨amëîs
 *
p_Vid
, 
Pi˘uªSåu˘uª
 
ty≥
, 
size_x
, 
size_y
, 
size_x_¸
, 
size_y_¸
, 
is_ouçut
);

210 
‰ì_°‹abÀ_pi˘uª
 (
St‹abÀPi˘uª
* 
p
);

211 
°‹e_pi˘uª_ö_dpb
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
St‹abÀPi˘uª
* 
p
);

212 
St‹abÀPi˘uª
* 
gë_sh‹t_ãrm_pic
 (
Sli˚
 *
cuºSli˚
, 
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
picNum
);

214 #i‡(
MVC_EXTENSION_ENABLE
)

215 
idr_mem‹y_m™agemít
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
St‹abÀPi˘uª
* 
p
);

216 
Êush_dpbs
(
DecodedPi˘uªBuf„r
 **
p_Dpb
, 
nLayîs
);

217 
GëMaxDecFømeBuf„rög
(
VideoP¨amëîs
 *
p_Vid
);

218 
≠≥nd_öãrvõw_li°
(
DecodedPi˘uªBuf„r
 *
p_Dpb
,

219 
Pi˘uªSåu˘uª
 
cuºPicSåu˘uª
, 
li°_idx
,

220 
FømeSt‹e
 **
li°
, *
li°Xsize
, 
cuºPOC
,

221 
cuº_võw_id
, 
™ch‹_pic_Êag
);

224 
unm¨k_f‹_ª„ªn˚
(
FømeSt‹e
* 
fs
);

225 
unm¨k_f‹_l⁄g_ãrm_ª„ªn˚
(
FømeSt‹e
* 
fs
);

226 
ªmove_‰ame_‰om_dpb
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
pos
);

228 
Êush_dpb
(
DecodedPi˘uªBuf„r
 *
p_Dpb
);

229 
öô_li°s_p_¶i˚
 (
Sli˚
 *
cuºSli˚
);

230 
öô_li°s_b_¶i˚
 (
Sli˚
 *
cuºSli˚
);

231 
öô_li°s_i_¶i˚
 (
Sli˚
 *
cuºSli˚
);

232 
upd©e_pic_num
 (
Sli˚
 *
cuºSli˚
);

234 
dpb_•lô_fõld
 (
VideoP¨amëîs
 *
p_Vid
, 
FømeSt‹e
 *
fs
);

235 
dpb_comböe_fõld
 (
VideoP¨amëîs
 *
p_Vid
, 
FømeSt‹e
 *
fs
);

236 
dpb_comböe_fõld_yuv
(
VideoP¨amëîs
 *
p_Vid
, 
FømeSt‹e
 *
fs
);

238 
ª‹dî_ªf_pic_li°
(
Sli˚
 *
cuºSli˚
, 
cur_li°
);

240 
öô_mbaff_li°s
 (
VideoP¨amëîs
 *
p_Vid
, 
Sli˚
 *
cuºSli˚
);

241 
Æloc_ªf_pic_li°_ª‹dîög_buf„r
(
Sli˚
 *
cuºSli˚
);

242 
‰ì_ªf_pic_li°_ª‹dîög_buf„r
(
Sli˚
 *
cuºSli˚
);

244 
fûl_‰ame_num_g≠
(
VideoP¨amëîs
 *
p_Vid
, 
Sli˚
 *
pSli˚
);

246 
compuã_cﬁoˇãd
 (
Sli˚
 *
cuºSli˚
, 
St‹abÀPi˘uª
 **
li°X
[6]);

249 
öô_img_d©a
(
VideoP¨amëîs
 *
p_Vid
, 
ImageD©a
 *
p_ImgD©a
, 
£q_∑ømëî_£t_rb•_t
 *
•s
);

250 
‰ì_img_d©a
(
VideoP¨amëîs
 *
p_Vid
, 
ImageD©a
 *
p_ImgD©a
);

251 
∑d_dec_pi˘uª
(
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
);

252 
∑d_buf
(
img≥l
 *
pImgBuf
, 
iWidth
, 
iHeight
, 
iSåide
, 
iPadX
, 
iPadY
);

253 
¥o˚ss_pi˘uª_ö_dpb_s
(
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
p_pic
);

254 
St‹abÀPi˘uª
 * 
˛⁄e_°‹abÀ_pi˘uª
–
VideoP¨amëîs
 *
p_Vid
, St‹abÀPi˘uª *
p_pic
 );

255 
°‹e_¥oc_pi˘uª_ö_dpb
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
St‹abÀPi˘uª
* 
p
);

	@ldecod/inc/mbuffer_mvc.h

18 #i‚de‡
_MBUFFER_MVC_H_


19 
	#_MBUFFER_MVC_H_


	)

21 
	~"globÆ.h
"

23 #i‡(
MVC_EXTENSION_ENABLE
)

24 
ª‹dî_li°s_mvc
 (
Sli˚
 * 
cuºSli˚
, 
cuºPOC
);

25 
öô_li°s_p_¶i˚_mvc
(
Sli˚
 *
cuºSli˚
);

26 
öô_li°s_b_¶i˚_mvc
(
Sli˚
 *
cuºSli˚
);

27 
öô_li°s_i_¶i˚_mvc
(
Sli˚
 *
cuºSli˚
);

29 
ª‹dî_ªf_pic_li°_mvc
(
Sli˚
 *
cuºSli˚
, 
cur_li°
, **
™ch‹_ªf
, **
n⁄_™ch‹_ªf
,

30 
võw_id
, 
™ch‹_pic_Êag
, 
cuºPOC
, 
li°idx
);

32 
ª‹dî_sh‹t_ãrm
(
Sli˚
 *
cuºSli˚
, 
cur_li°
, 
num_ªf_idx_lX_a˘ive_möus1
, 
picNumLX
, *
ªfIdxLX
, 
cuºVõwID
);

33 
ª‹dî_l⁄g_ãrm
(
Sli˚
 *
cuºSli˚
, 
St‹abÀPi˘uª
 **
RefPicLi°X
, 
num_ªf_idx_lX_a˘ive_möus1
, 
L⁄gTîmPicNum
, *
ªfIdxLX
, 
cuºVõwID
);

	@ldecod/inc/mc_prediction.h

17 #i‚de‡
_MC_PREDICTION_H_


18 
	#_MC_PREDICTION_H_


	)

20 
	~"globÆ.h
"

21 
	~"mbuf„r.h
"

23 
Æloˇã_¥ed_mem
(
Sli˚
 *
cuºSli˚
);

24 
‰ì_¥ed_mem
 (
Sli˚
 *
cuºSli˚
);

26 
gë_block_luma
(
St‹abÀPi˘uª
 *
cuº_ªf
, 
x_pos
, 
y_pos
, 
block_size_x
, 
block_size_y
, 
img≥l
 **
block
,

27 
shi·_x
,
maxﬁd_x
,
maxﬁd_y
,**
tmp_ªs
,
max_img≥l_vÆue
,
img≥l
 
no_ªf_vÆue
,
Ma¸oblock
 *
cuºMB
);

29 
öåa_¸_decodög
 (
Ma¸oblock
 *
cuºMB
, 
yuv
);

30 
¥ï¨e_dúe˘_∑øms
(
Ma¸oblock
 *
cuºMB
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
, 
MŸi⁄Ve˘‹
 *
pmvl0
, MŸi⁄Ve˘‹ *
pmvl1
,*
l0_rFøme
, *
l1_rFøme
);

31 
≥rf‹m_mc
 (
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
, 
¥ed_dú
, 
i
, 
j
, 
block_size_x
, 
block_size_y
);

	@ldecod/inc/nalu.h

17 #i‚de‡
_NALU_H_


18 
	#_NALU_H_


	)

20 
	~"«lucomm⁄.h
"

22 
CheckZîoByãN⁄VCL
(
VideoP¨amëîs
 *
p_Vid
, 
NALU_t
 *
«lu
);

23 
CheckZîoByãVCL
 (
VideoP¨amëîs
 *
p_Vid
, 
NALU_t
 *
«lu
);

25 
ªad_√xt_«lu
(
VideoP¨amëîs
 *
p_Vid
, 
NALU_t
 *
«lu
);

	@ldecod/inc/output.h

14 #i‚de‡
_OUTPUT_H_


15 
	#_OUTPUT_H_


	)

18 
wrôe_°‹ed_‰ame
(
VideoP¨amëîs
 *
p_Vid
, 
FømeSt‹e
 *
fs
, 
p_out
);

19 
dúe˘_ouçut
 (
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
p
, 
p_out
);

20 
öô_out_buf„r
 (
VideoP¨amëîs
 *
p_Vid
);

21 
unöô_out_buf„r
 (
VideoP¨amëîs
 *
p_Vid
);

22 #i‡(
PAIR_FIELDS_IN_OUTPUT
)

23 
Êush_≥ndög_ouçut
(
VideoP¨amëîs
 *
p_Vid
, 
p_out
);

25 
öô_ouçut
(
CodögP¨amëîs
 *
p_CodögP¨ams
, 
symbﬁ_size_ö_byãs
);

	@ldecod/inc/parset.h

17 #i‚de‡
_PARSET_H_


18 
	#_PARSET_H_


	)

20 
	~"∑r£tcomm⁄.h
"

21 
	~"«lucomm⁄.h
"

23 c⁄° 
byã
 
	gZZ_SCAN
[16] =

27 c⁄° 
byã
 
	gZZ_SCAN8
[64] =

34 
Sˇlög_Li°
(*
sˇlögLi°
, 
sizeOfSˇlögLi°
, 
Boﬁón
 *
U£DeÁu…SˇlögM©rix
, 
Bô°ªam
 *
s
);

36 
InôVUI
(
£q_∑ømëî_£t_rb•_t
 *
•s
);

37 
RódVUI
(
D©aP¨tôi⁄
 *
p
, 
£q_∑ømëî_£t_rb•_t
 *
•s
);

38 
RódHRDP¨amëîs
(
D©aP¨tôi⁄
 *
p
, 
hrd_∑ømëîs_t
 *
hrd
);

40 
PPSC⁄si°ícyCheck
 (
pic_∑ømëî_£t_rb•_t
 *
µs
);

41 
SPSC⁄si°ícyCheck
 (
£q_∑ømëî_£t_rb•_t
 *
•s
);

43 
MakePPSavaûabÀ
 (
VideoP¨amëîs
 *
p_Vid
, 
id
, 
pic_∑ømëî_£t_rb•_t
 *
µs
);

44 
MakeSPSavaûabÀ
 (
VideoP¨amëîs
 *
p_Vid
, 
id
, 
£q_∑ømëî_£t_rb•_t
 *
•s
);

46 
Pro˚ssSPS
 (
VideoP¨amëîs
 *
p_Vid
, 
NALU_t
 *
«lu
);

47 
Pro˚ssPPS
 (
VideoP¨amëîs
 *
p_Vid
, 
NALU_t
 *
«lu
);

49 
CÀ™UpPPS
(
VideoP¨amëîs
 *
p_Vid
);

51 
a˘iv©e_•s
 (
VideoP¨amëîs
 *
p_Vid
, 
£q_∑ømëî_£t_rb•_t
 *
•s
);

52 
a˘iv©e_µs
 (
VideoP¨amëîs
 *
p_Vid
, 
pic_∑ømëî_£t_rb•_t
 *
µs
);

54 
U£P¨amëîSë
 (
Sli˚
 *
cuºSli˚
);

56 #i‡(
MVC_EXTENSION_ENABLE
)

57 
Sub£tSPSC⁄si°ícyCheck
 (
sub£t_£q_∑ømëî_£t_rb•_t
 *
sub£t_•s
);

58 
Pro˚ssSub£tSPS
 (
VideoP¨amëîs
 *
p_Vid
, 
NALU_t
 *
«lu
);

60 
mvc_vui_∑ømëîs_exãnsi⁄
(
MVCVUI_t
 *
pMVCVUI
, 
Bô°ªam
 *
s
);

61 
£q_∑ømëî_£t_mvc_exãnsi⁄
(
sub£t_£q_∑ømëî_£t_rb•_t
 *
sub£t_•s
, 
Bô°ªam
 *
s
);

62 
öô_sub£t_•s_li°
(
sub£t_£q_∑ømëî_£t_rb•_t
 *
sub£t_•s_li°
, 
iSize
);

63 
ª£t_sub£t_•s
(
sub£t_£q_∑ømëî_£t_rb•_t
 *
sub£t_•s
);

64 
GëBa£VõwId
(
VideoP¨amëîs
 *
p_Vid
, 
sub£t_£q_∑ømëî_£t_rb•_t
 **
sub£t_•s
);

65 
gë_max_dec_‰ame_buf_size
(
£q_∑ømëî_£t_rb•_t
 *
•s
);

	@ldecod/inc/quant.h

14 #i‚de‡
_QUANT_H_


15 
	#_QUANT_H_


	)

18 c⁄° 
	gdequ™t_c€f8
[6][8][8] =

84 c⁄° 
	gdequ™t_c€f
[6][4][4] = {

117 c⁄° 
	gqu™t_c€f
[6][4][4] = {

151 c⁄° 
	gA
[4][4] = {

160 
öô_qp_¥o˚ss
 (
CodögP¨amëîs
 *
˝s
);

161 
‰ì_qp_m©ri˚s
(
CodögP¨amëîs
 *
˝s
);

164 
assign_qu™t_∑øms
 (
Sli˚
 *
cuº¶i˚
);

165 
CÆcuœãQu™t4x4P¨am
(
Sli˚
 *
cuº¶i˚
);

166 
CÆcuœãQu™t8x8P¨am
(
Sli˚
 *
cuº¶i˚
);

	@ldecod/inc/rtp.h

11 #i‚de‡
_RTP_H_


12 
	#_RTP_H_


	)

14 
	~"«lucomm⁄.h
"

16 
	#MAXRTPPAYLOADLEN
 (65536 - 40)

17 
	#MAXRTPPACKETSIZE
 (65536 - 28)

18 
	#H264PAYLOADTYPE
 105

19 
	#H264SSRC
 0x12345678

20 
	#RTP_TR_TIMESTAMP_MULT
 1000

21 

	)

24 
	mv
;

25 
	mp
;

26 
	mx
;

27 
	mcc
;

29 
	mm
;

30 
	m±
;

31 
uöt16
 
	m£q
;

33 
	mtime°amp
;

34 
	ms§c
;

35 
byã
 * 
	m∑ylﬂd
;

36 
	m∑yÀn
;

37 
byã
 * 
	m∑ckë
;

38 
	m∑ckÀn
;

39 } 
	tRTP∑ckë_t
;

41 
DumpRTPHódî
 (
RTP∑ckë_t
 *
p
);

42 
GëRTPNALU
 (
VideoP¨amëîs
 *
p_Vid
, 
NALU_t
 *
«lu
, 
BôSåómFûe
);

43 
O≥nRTPFûe
 (*
‚
, *
p_BôSåómFûe
);

44 
Clo£RTPFûe
(*
p_BôSåómFûe
);

	@ldecod/inc/sei.h

11 #i‚de‡
SEI_H


12 
	#SEI_H


	)

15 
	mSEI_BUFFERING_PERIOD
 = 0,

16 
	mSEI_PIC_TIMING
,

17 
	mSEI_PAN_SCAN_RECT
,

18 
	mSEI_FILLER_PAYLOAD
,

19 
	mSEI_USER_DATA_REGISTERED_ITU_T_T35
,

20 
	mSEI_USER_DATA_UNREGISTERED
,

21 
	mSEI_RECOVERY_POINT
,

22 
	mSEI_DEC_REF_PIC_MARKING_REPETITION
,

23 
	mSEI_SPARE_PIC
,

24 
	mSEI_SCENE_INFO
,

25 
	mSEI_SUB_SEQ_INFO
,

26 
	mSEI_SUB_SEQ_LAYER_CHARACTERISTICS
,

27 
	mSEI_SUB_SEQ_CHARACTERISTICS
,

28 
	mSEI_FULL_FRAME_FREEZE
,

29 
	mSEI_FULL_FRAME_FREEZE_RELEASE
,

30 
	mSEI_FULL_FRAME_SNAPSHOT
,

31 
	mSEI_PROGRESSIVE_REFINEMENT_SEGMENT_START
,

32 
	mSEI_PROGRESSIVE_REFINEMENT_SEGMENT_END
,

33 
	mSEI_MOTION_CONSTRAINED_SLICE_GROUP_SET
,

34 
	mSEI_FILM_GRAIN_CHARACTERISTICS
,

35 
	mSEI_DEBLOCKING_FILTER_DISPLAY_PREFERENCE
,

36 
	mSEI_STEREO_VIDEO_INFO
,

37 
	mSEI_POST_FILTER_HINTS
,

38 
	mSEI_TONE_MAPPING
,

39 
	mSEI_SCALABILITY_INFO
,

40 
	mSEI_SUB_PIC_SCALABLE_LAYER
,

41 
	mSEI_NON_REQUIRED_LAYER_REP
,

42 
	mSEI_PRIORITY_LAYER_INFO
,

43 
	mSEI_LAYERS_NOT_PRESENT
,

44 
	mSEI_LAYER_DEPENDENCY_CHANGE
,

45 
	mSEI_SCALABLE_NESTING
,

46 
	mSEI_BASE_LAYER_TEMPORAL_HRD
,

47 
	mSEI_QUALITY_LAYER_INTEGRITY_CHECK
,

48 
	mSEI_REDUNDANT_PIC_PROPERTY
,

49 
	mSEI_TL0_DEP_REP_INDEX
,

50 
	mSEI_TL_SWITCHING_POINT
,

51 
	mSEI_PARALLEL_DECODING_INFO
,

52 
	mSEI_MVC_SCALABLE_NESTING
,

53 
	mSEI_VIEW_SCALABILITY_INFO
,

54 
	mSEI_MULTIVIEW_SCENE_INFO
,

55 
	mSEI_MULTIVIEW_ACQUISITION_INFO
,

56 
	mSEI_NON_REQUIRED_VIEW_COMPONENT
,

57 
	mSEI_VIEW_DEPENDENCY_CHANGE
,

58 
	mSEI_OPERATION_POINTS_NOT_PRESENT
,

59 
	mSEI_BASE_VIEW_TEMPORAL_HRD
,

60 
	mSEI_FRAME_PACKING_ARRANGEMENT
,

62 
	mSEI_MAX_ELEMENTS


63 } 
	tSEI_ty≥
;

65 
	#MAX_FN
 256

	)

67 
	#MAX_CODED_BIT_DEPTH
 12

	)

68 
	#MAX_SEI_BIT_DEPTH
 12

	)

69 
	#MAX_NUM_PIVOTS
 (1<<
MAX_CODED_BIT_DEPTH
)

	)

71 #i‡(
ENABLE_OUTPUT_TONEMAPPING
)

72 
	st⁄e_m≠pög_°ru˘_s


74 
Boﬁón
 
	m£iHasT⁄e_m≠pög
;

75 
	mt⁄e_m≠_ª≥tôi⁄_≥riod
;

76 
	mcoded_d©a_bô_dïth
;

77 
	m£i_bô_dïth
;

78 
	mmodñ_id
;

79 
	mcou¡
;

81 
img≥l
 
	mlut
[1<<
MAX_CODED_BIT_DEPTH
];

83 
Bô°ªam
 *
	md©a
;

84 
	m∑ylﬂdSize
;

85 } 
	tT⁄eM≠pögSEI
;

91 
	m‰ame_∑ckög_¨øngemít_id
;

92 
Boﬁón
 
	m‰ame_∑ckög_¨øngemít_ˇn˚l_Êag
;

93 
	m‰ame_∑ckög_¨øngemít_ty≥
;

94 
Boﬁón
 
	mquöcunx_ßm∂ög_Êag
;

95 
	mc⁄ã¡_öãΩªèti⁄_ty≥
;

96 
Boﬁón
 
	m•©ül_Êùpög_Êag
;

97 
Boﬁón
 
	m‰ame0_Êù≥d_Êag
;

98 
Boﬁón
 
	mfõld_võws_Êag
;

99 
Boﬁón
 
	mcuºít_‰ame_is_‰ame0_Êag
;

100 
Boﬁón
 
	m‰ame0_£lf_c⁄èöed_Êag
;

101 
Boﬁón
 
	m‰ame1_£lf_c⁄èöed_Êag
;

102 
	m‰ame0_grid_posôi⁄_x
;

103 
	m‰ame0_grid_posôi⁄_y
;

104 
	m‰ame1_grid_posôi⁄_x
;

105 
	m‰ame1_grid_posôi⁄_y
;

106 
	m‰ame_∑ckög_¨øngemít_ª£rved_byã
;

107 
	m‰ame_∑ckög_¨øngemít_ª≥tôi⁄_≥riod
;

108 
Boﬁón
 
	m‰ame_∑ckög_¨øngemít_exãnsi⁄_Êag
;

109 } 
	t‰ame_∑ckög_¨øngemít_öf‹m©i⁄_°ru˘
;

111 
I¡î¥ëSEIMesßge
 ( 
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
, 
Sli˚
 *
pSli˚
 );

112 
öãΩªt_•¨e_pic
 ( 
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
 );

113 
öãΩªt_sub£quí˚_öfo
 ( 
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
 );

114 
öãΩªt_sub£quí˚_œyî_ch¨a˘îi°ics_öfo
 ( 
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
 );

115 
öãΩªt_sub£quí˚_ch¨a˘îi°ics_öfo
 ( 
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
 );

116 
öãΩªt_s˚√_öf‹m©i⁄
 ( 
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
 );

117 
öãΩªt_u£r_d©a_ªgi°îed_ôu_t_t35_öfo
 ( 
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
 );

118 
öãΩªt_u£r_d©a_uƒegi°îed_öfo
 ( 
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
 );

119 
öãΩªt_∑n_sˇn_ª˘_öfo
 ( 
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
 );

120 
öãΩªt_ªcovîy_poöt_öfo
 ( 
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
 );

121 
öãΩªt_fûÀr_∑ylﬂd_öfo
 ( 
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
 );

122 
öãΩªt_dec_ªf_pic_m¨kög_ª≥tôi⁄_öfo
 ( 
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
, 
Sli˚
 *
pSli˚
 );

123 
öãΩªt_fuŒ_‰ame_‰ìze_öfo
 ( 
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
 );

124 
öãΩªt_fuŒ_‰ame_‰ìze_ªÀa£_öfo
 ( 
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
 );

125 
öãΩªt_fuŒ_‰ame_¢≠shŸ_öfo
 ( 
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
 );

126 
öãΩªt_¥ogªssive_ªföemít_°¨t_öfo
 ( 
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
 );

127 
öãΩªt_¥ogªssive_ªföemít_íd_öfo
 ( 
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
 );

128 
öãΩªt_mŸi⁄_c⁄°øöed_¶i˚_group_£t_öfo
 ( 
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
 );

129 
öãΩªt_ª£rved_öfo
 ( 
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
 );

130 
öãΩªt_buf„rög_≥riod_öfo
 ( 
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
 );

131 
öãΩªt_pi˘uª_timög_öfo
 ( 
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
 );

132 
öãΩªt_fûm_gøö_ch¨a˘îi°ics_öfo
 ( 
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
 );

133 
öãΩªt_deblockög_fûãr_di•œy_¥e„ªn˚_öfo
–
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
 );

134 
öãΩªt_°îeo_video_öfo_öfo
 ( 
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
 );

135 
öãΩªt_po°_fûãr_höts_öfo
 ( 
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
 );

136 
öãΩªt_t⁄e_m≠pög
 ( 
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
 );

137 
öãΩªt_‰ame_∑ckög_¨øngemít_öfo
 ( 
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
 );

139 #i‡(
ENABLE_OUTPUT_TONEMAPPING
)

140 
t⁄e_m≠
 (
img≥l
** 
imgX
, img≥l* 
lut
, 
size_x
, 
size_y
);

141 
öô_t⁄e_m≠pög_£i
 (
T⁄eM≠pögSEI
 *
£iT⁄eM≠pög
);

142 
upd©e_t⁄e_m≠pög_£i
(
T⁄eM≠pögSEI
 *
£iT⁄eM≠pög
);

	@ldecod/inc/transform8x8.h

17 #i‚de‡
_TRANSFORM8X8_H_


18 
	#_TRANSFORM8X8_H_


	)

20 
ôøns8x8
 (
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
ioff
, 
joff
);

21 
ic›y8x8
 (
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
ioff
, 
joff
);

	@ldecod/inc/vlc.h

15 #i‚de‡
_VLC_H_


16 
	#_VLC_H_


	)

19 c⁄° 
byã
 
	gNCBP
[2][48][2]=

36 c⁄° 
byã
 
	gNTAB1
[4][8][2] =

44 c⁄° 
byã
 
	gLEVRUN1
[16]=

50 c⁄° 
byã
 
	gNTAB2
[4][8][2] =

59 c⁄° 
byã
 
	gLEVRUN3
[4] =

64 c⁄° 
byã
 
	gNTAB3
[2][2][2] =

70 
ªad_£_v
 (*
åa˚°rög
, 
Bô°ªam
 *
bô°ªam
, *
u£d_bôs
);

71 
ªad_ue_v
 (*
åa˚°rög
, 
Bô°ªam
 *
bô°ªam
, *
u£d_bôs
);

72 
Boﬁón
 
ªad_u_1
 (*
åa˚°rög
, 
Bô°ªam
 *
bô°ªam
, *
u£d_bôs
);

73 
ªad_u_v
 (
LíInBôs
, *
åa˚°rög
, 
Bô°ªam
 *
bô°ªam
, *
u£d_bôs
);

74 
ªad_i_v
 (
LíInBôs
, *
åa˚°rög
, 
Bô°ªam
 *
bô°ªam
, *
u£d_bôs
);

77 
löfo_ue
(
Àn
, 
öfo
, *
vÆue1
, *
dummy
);

78 
löfo_£
(
Àn
, 
öfo
, *
vÆue1
, *
dummy
);

80 
löfo_cbp_öåa_n‹mÆ
(
Àn
,
öfo
,*
cbp
, *
dummy
);

81 
löfo_cbp_öãr_n‹mÆ
(
Àn
,
öfo
,*
cbp
, *
dummy
);

82 
löfo_cbp_öåa_Ÿhî
(
Àn
,
öfo
,*
cbp
, *
dummy
);

83 
löfo_cbp_öãr_Ÿhî
(
Àn
,
öfo
,*
cbp
, *
dummy
);

85 
löfo_Àvrun_öãr
(
Àn
,
öfo
,*
Àvñ
,*
úun
);

86 
löfo_Àvrun_c2x2
(
Àn
,
öfo
,*
Àvñ
,*
úun
);

88 
uvlc_°¨tcode_fﬁlows
(
Sli˚
 *
cuºSli˚
, 
dummy
);

90 
ªadSy¡axEÀmít_VLC
 (
Sy¡axEÀmít
 *
sym
, 
Bô°ªam
 *
cuºSåóm
);

91 
ªadSy¡axEÀmít_UVLC
(
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
sym
, 
d©≠¨tôi⁄_dec
 *
dp
);

92 
ªadSy¡axEÀmít_I¡ø4x4Pªdi˘i⁄Mode
(
Sy¡axEÀmít
 *
sym
, 
Bô°ªam
 *
cuºSåóm
);

94 
GëVLCSymbﬁ
 (
byã
 
buf„r
[],
tŸbôoff£t
,*
öfo
, 
byãcou¡
);

95 
GëVLCSymbﬁ_I¡øMode
 (
byã
 
buf„r
[],
tŸbôoff£t
,*
öfo
, 
byãcou¡
);

97 
ªadSy¡axEÀmít_FLC
 (
Sy¡axEÀmít
 *
sym
, 
Bô°ªam
 *
cuºSåóm
);

98 
ªadSy¡axEÀmít_NumC€ffTøûögO√s
 (
Sy¡axEÀmít
 *
sym
, 
Bô°ªam
 *
cuºSåóm
, *
ty≥
);

99 
ªadSy¡axEÀmít_NumC€ffTøûögO√sChromaDC
(
VideoP¨amëîs
 *
p_Vid
, 
Sy¡axEÀmít
 *
sym
, 
Bô°ªam
 *
cuºSåóm
);

100 
ªadSy¡axEÀmít_Levñ_VLC0
 (
Sy¡axEÀmít
 *
sym
, 
Bô°ªam
 *
cuºSåóm
);

101 
ªadSy¡axEÀmít_Levñ_VLCN
 (
Sy¡axEÀmít
 *
sym
, 
vlc
, 
Bô°ªam
 *
cuºSåóm
);

102 
ªadSy¡axEÀmít_TŸÆZîos
 (
Sy¡axEÀmít
 *
sym
, 
Bô°ªam
 *
cuºSåóm
);

103 
ªadSy¡axEÀmít_TŸÆZîosChromaDC
 (
VideoP¨amëîs
 *
p_Vid
, 
Sy¡axEÀmít
 *
sym
, 
Bô°ªam
 *
cuºSåóm
);

104 
ªadSy¡axEÀmít_Run
 (
Sy¡axEÀmít
 *
sym
, 
Bô°ªam
 *
cuºSåóm
);

105 
GëBôs
 (
byã
 
buf„r
[],
tŸbôoff£t
,*
öfo
, 
bôcou¡
, 
numbôs
);

106 
ShowBôs
 (
byã
 
buf„r
[],
tŸbôoff£t
,
bôcou¡
, 
numbôs
);

108 
m‹e_rb•_d©a
 (
byã
 
buf„r
[],
tŸbôoff£t
,
byãcou¡
);

	@ldecod/src/annexb.c

15 
	~"globÆ.h
"

16 
	~"™√xb.h
"

17 
	~"memÆloc.h
"

18 
	~"Á°_mem‹y.h
"

20 c⁄° 
	gIOBUFFERSIZE
 = 512*1024;

22 
	$mÆloc_™√x_b
(
VideoP¨amëîs
 *
p_Vid
, 
ANNEXB_t
 **
p_™√x_b
)

24 i‡–((*
p_™√x_b
Ë(
ANNEXB_t
 *Ë
	`ˇŒoc
(1, (ANNEXB_t))Ë=
NULL
)

26 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Memoryállocation for Annex_B file failed");

27 
	`îr‹
(
îr‹ãxt
,100);

29 i‡(((*
p_™√x_b
)->
Buf
 = (
byã
*Ë
	`mÆloc
(
p_Vid
->
«lu
->
max_size
)Ë=
NULL
)

31 
	`îr‹
("malloc_annex_b: Buf", 101);

33 
	}
}

36 
	$öô_™√x_b
(
ANNEXB_t
 *
™√x_b
)

38 
™√x_b
->
BôSåómFûe
 = -1;

39 
™√x_b
->
iobuf„r
 = 
NULL
;

40 
™√x_b
->
iobuf„ºód
 = 
NULL
;

41 
™√x_b
->
byãsöbuf„r
 = 0;

42 
™√x_b
->
is_eof
 = 
FALSE
;

43 
™√x_b
->
IsFú°ByãSåómNALU
 = 1;

44 
™√x_b
->
√xt°¨tcodebyãs
 = 0;

45 
	}
}

47 
	$‰ì_™√x_b
(
ANNEXB_t
 **
p_™√x_b
)

49 
	`‰ì
((*
p_™√x_b
)->
Buf
);

50 (*
p_™√x_b
)->
Buf
 = 
NULL
;

51 
	`‰ì
(*
p_™√x_b
);

52 *
p_™√x_b
 = 
NULL
;

53 
	}
}

61 
ölöe
 
	$gëChunk
(
ANNEXB_t
 *
™√x_b
)

63 
ªadbyãs
 = 
	`ªad
 (
™√x_b
->
BôSåómFûe
,á¬ex_b->
iobuf„r
,á¬ex_b->
iIOBuf„rSize
);

64 i‡(0==
ªadbyãs
)

66 
™√x_b
->
is_eof
 = 
TRUE
;

70 
™√x_b
->
byãsöbuf„r
 = 
ªadbyãs
;

71 
™√x_b
->
iobuf„ºód
 =á¬ex_b->
iobuf„r
;

72  
ªadbyãs
;

73 
	}
}

81 
ölöe
 
byã
 
	$gëfbyã
(
ANNEXB_t
 *
™√x_b
)

83 i‡(0 =
™√x_b
->
byãsöbuf„r
)

85 i‡(0 =
	`gëChunk
(
™√x_b
))

88 
™√x_b
->
byãsöbuf„r
--;

89  (*
™√x_b
->
iobuf„ºód
++);

90 
	}
}

108 
ölöe
 
	$FödSèπCode
 (*
Buf
, 
zîos_ö_°¨tcode
)

110 
i
;

112 
i
 = 0; i < 
zîos_ö_°¨tcode
; i++)

114 if(*(
Buf
++) != 0)

120 if(*
Buf
 != 1)

124 
	}
}

146 
	$gë_™√x_b_NALU
 (
VideoP¨amëîs
 *
p_Vid
, 
NALU_t
 *
«lu
, 
ANNEXB_t
 *
™√x_b
)

148 
i
;

149 
öfo2
 = 0, 
öfo3
 = 0, 
pos
 = 0;

150 
SèπCodeFound
 = 0;

151 
LódögZîo8BôsCou¡
 = 0;

152 
byã
 *
pBuf
 = 
™√x_b
->
Buf
;

154 i‡(
™√x_b
->
√xt°¨tcodebyãs
 != 0)

156 
i
=0; i<
™√x_b
->
√xt°¨tcodebyãs
-1; i++)

158 (*
pBuf
++) = 0;

159 
pos
++;

161 (*
pBuf
++) = 1;

162 
pos
++;

166 !
™√x_b
->
is_eof
)

168 
pos
++;

169 i‡((*(
pBuf
++)
	`gëfbyã
(
™√x_b
))!= 0)

173 if(
™√x_b
->
is_eof
 =
TRUE
)

175 if(
pos
==0)

181 
	`¥ötf
( "get_annex_b_NALU can'tÑead start code\n");

186 if(*(
pBuf
 - 1Ë!1 || 
pos
 < 3)

188 
	`¥ötf
 ("get_annex_b_NALU:Ço Start CodeátÅhe beginning ofÅhe NALU,Ñeturn -1\n");

192 i‡(
pos
 == 3)

194 
«lu
->
°¨tcodïªfix_Àn
 = 3;

198 
LódögZîo8BôsCou¡
 = 
pos
 - 4;

199 
«lu
->
°¨tcodïªfix_Àn
 = 4;

205 if(!
™√x_b
->
IsFú°ByãSåómNALU
 && 
LódögZîo8BôsCou¡
 > 0)

207 
	`¥ötf
 ("get_annex_b_NALU: TheÜeading_zero_8bits syntax can only beÖresent inÅhe first byte stream NAL unit,Ñeturn -1\n");

211 
LódögZîo8BôsCou¡
 = 
pos
;

212 
™√x_b
->
IsFú°ByãSåómNALU
 = 0;

214 !
SèπCodeFound
)

216 i‡(
™√x_b
->
is_eof
 =
TRUE
)

218 
pBuf
 -= 2;

219 *(
pBuf
--)==0)

220 
pos
--;

222 
«lu
->
Àn
 = (
pos
 - 1Ë- 
LódögZîo8BôsCou¡
;

223 
	`mem˝y
 (
«lu
->
buf
, 
™√x_b
->
Buf
 + 
LódögZîo8BôsCou¡
,ÇÆu->
Àn
);

224 
«lu
->
f‹biddí_bô
 = (*“Æu->
buf
) >> 7) & 1;

225 
«lu
->
«l_ª„ªn˚_idc
 = (
NÆRefIdc
Ë((*“Æu->
buf
) >> 5) & 3);

226 
«lu
->
«l_unô_ty≥
 = (
NÆuTy≥
Ë((*“Æu->
buf
)) & 0x1f);

227 
™√x_b
->
√xt°¨tcodebyãs
 = 0;

231 #i‡
TRACE


232 
	`Ârötf
 (
p_Dec
->
p_åa˚
, "\n\nLast NALU in File\n\n");

233 
	`Ârötf
 (
p_Dec
->
p_åa˚
, "Annex B NALU w/ %s startcode,Üen %d, forbidden_bit %d,Çal_reference_idc %d,Çal_unit_type %d\n\n",

234 
«lu
->
°¨tcodïªfix_Àn
 =4?"l⁄g":"sh‹t",ÇÆu->
Àn
,ÇÆu->
f‹biddí_bô
,ÇÆu->
«l_ª„ªn˚_idc
,ÇÆu->
«l_unô_ty≥
);

235 
	`fÊush
 (
p_Dec
->
p_åa˚
);

237  (
pos
 - 1);

240 
pos
++;

241 *(
pBuf
 ++Ë
	`gëfbyã
(
™√x_b
);

242 
öfo3
 = 
	`FödSèπCode
(
pBuf
 - 4, 3);

243 if(
öfo3
 != 1)

245 
öfo2
 = 
	`FödSèπCode
(
pBuf
 - 3, 2);

246 
SèπCodeFound
 = 
öfo2
 & 0x01;

249 
SèπCodeFound
 = 1;

254 if(
öfo3
 == 1)

256 
pBuf
 -= 5;

257 *(
pBuf
--) == 0)

258 
pos
--;

259 
™√x_b
->
√xt°¨tcodebyãs
 = 4;

261 i‡(
öfo2
 == 1)

262 
™√x_b
->
√xt°¨tcodebyãs
 = 3;

265 
	`¥ötf
(" Panic: Error inÇext start code search \n");

269 
pos
 -
™√x_b
->
√xt°¨tcodebyãs
;

277 
«lu
->
Àn
 = 
pos
 - 
LódögZîo8BôsCou¡
;

278 
	`Á°_mem˝y
 (
«lu
->
buf
, 
™√x_b
->
Buf
 + 
LódögZîo8BôsCou¡
,ÇÆu->
Àn
);

279 
«lu
->
f‹biddí_bô
 = (*“Æu->
buf
) >> 7) & 1;

280 
«lu
->
«l_ª„ªn˚_idc
 = (
NÆRefIdc
Ë((*“Æu->
buf
) >> 5) & 3);

281 
«lu
->
«l_unô_ty≥
 = (
NÆuTy≥
Ë((*“Æu->
buf
)) & 0x1f);

282 
«lu
->
lo°_∑ckës
 = 0;

286 #i‡
TRACE


287 
	`Ârötf
 (
p_Dec
->
p_åa˚
, "\n\nAnnex B NALU w/ %s startcode,Üen %d, forbidden_bit %d,Çal_reference_idc %d,Çal_unit_type %d\n\n",

288 
«lu
->
°¨tcodïªfix_Àn
 =4?"l⁄g":"sh‹t",ÇÆu->
Àn
,ÇÆu->
f‹biddí_bô
,ÇÆu->
«l_ª„ªn˚_idc
,ÇÆu->
«l_unô_ty≥
);

289 
	`fÊush
 (
p_Dec
->
p_åa˚
);

292  (
pos
);

294 
	}
}

306 
	$›í_™√x_b
 (*
‚
, 
ANNEXB_t
 *
™√x_b
)

308 i‡(
NULL
 !
™√x_b
->
iobuf„r
)

310 
	`îr‹
 ("open_annex_b:ÅriedÅo open Annex B fileÅwice",500);

312 i‡((
™√x_b
->
BôSåómFûe
 = 
	`›í
(
‚
, 
OPENFLAGS_READ
)) == -1)

314 
	`¢¥ötf
 (
îr‹ãxt
, 
ET_SIZE
, "C™nŸ o≥¿A¬ex B ByãSåóm fûê'%s'", 
‚
);

315 
	`îr‹
(
îr‹ãxt
,500);

318 
™√x_b
->
iIOBuf„rSize
 = 
IOBUFFERSIZE
 *  (
byã
);

319 
™√x_b
->
iobuf„r
 = 
	`mÆloc
 (™√x_b->
iIOBuf„rSize
);

320 i‡(
NULL
 =
™√x_b
->
iobuf„r
)

322 
	`îr‹
 ("open_annex_b: cannotállocate IO buffer",500);

324 
™√x_b
->
is_eof
 = 
FALSE
;

325 
	`gëChunk
(
™√x_b
);

326 
	}
}

335 
	$˛o£_™√x_b
(
ANNEXB_t
 *
™√x_b
)

337 i‡(
™√x_b
->
BôSåómFûe
 != -1)

339 
	`˛o£
(
™√x_b
->
BôSåómFûe
);

340 
™√x_b
->
BôSåómFûe
 = - 1;

342 
	`‰ì
 (
™√x_b
->
iobuf„r
);

343 
™√x_b
->
iobuf„r
 = 
NULL
;

344 
	}
}

347 
	$ª£t_™√x_b
(
ANNEXB_t
 *
™√x_b
)

349 
™√x_b
->
is_eof
 = 
FALSE
;

350 
™√x_b
->
byãsöbuf„r
 = 0;

351 
™√x_b
->
iobuf„ºód
 =á¬ex_b->
iobuf„r
;

352 
	}
}

	@ldecod/src/biaridecod.c

21 
	~"globÆ.h
"

22 
	~"memÆloc.h
"

23 
	~"büridecod.h
"

26 
	#B_BITS
 10

27 
	#HALF
 0x01FE

28 
	#QUARTER
 0x0100

29 

	)

38 
DecodögEnvú⁄mítPå
 
	$¨ideco_¸óã_decodög_ívú⁄mít
()

40 
DecodögEnvú⁄mítPå
 
dï
;

42 i‡((
dï
 = 
	`ˇŒoc
(1,(
DecodögEnvú⁄mít
))Ë=
NULL
)

43 
	`no_mem_exô
("arideco_create_decoding_environment: dep");

44  
dï
;

45 
	}
}

54 
	$¨ideco_dñëe_decodög_ívú⁄mít
(
DecodögEnvú⁄mítPå
 
dï
)

56 i‡(
dï
 =
NULL
)

58 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Error freeing dep (NULLÖointer)");

59 
	`îr‹
 (
îr‹ãxt
, 200);

62 
	`‰ì
(
dï
);

63 
	}
}

71 
	$¨ideco_d⁄e_decodög
(
DecodögEnvú⁄mítPå
 
dï
)

73 (*
dï
->
Dcode°rm_Àn
)++;

74 #if(
TRACE
==2)

75 
	`Ârötf
(
p_åa˚
, "d⁄e_decodög: %d\n", *
dï
->
Dcode°rm_Àn
);

77 
	}
}

85 
ölöe
 
	$gëbyã
(
DecodögEnvú⁄mítPå
 
dï
)

87 #if(
TRACE
==2)

88 
	`Ârötf
(
p_åa˚
, "gë_byã: %d\n", (*
dï
->
Dcode°rm_Àn
));

90  
dï
->
Dcode°rm
[(*dï->
Dcode°rm_Àn
)++];

91 
	}
}

99 
ölöe
 
	$gëw‹d
(
DecodögEnvú⁄mítPå
 
dï
)

101 *
Àn
 = 
dï
->
Dcode°rm_Àn
;

102 
byã
 *
p_code_°rm
 = &
dï
->
Dcode°rm
[*
Àn
];

103 #if(
TRACE
==2)

104 
	`Ârötf
(
p_åa˚
, "gë_byã: %d\n", *
Àn
);

105 
	`Ârötf
(
p_åa˚
, "gë_byã: %d\n", *
Àn
 + 1);

107 *
Àn
 += 2;

108  ((*
p_code_°rm
<<8) | *(p_code_strm + 1));

109 
	}
}

116 
	$¨ideco_°¨t_decodög
(
DecodögEnvú⁄mítPå
 
dï
, *
code_buf„r
,

117 
fú°byã
, *
code_Àn
)

120 
dï
->
Dcode°rm
 = 
code_buf„r
;

121 
dï
->
Dcode°rm_Àn
 = 
code_Àn
;

122 *
dï
->
Dcode°rm_Àn
 = 
fú°byã
;

124 
dï
->
DvÆue
 = 
	`gëbyã
(dep);

125 
dï
->
DvÆue
 = (dï->DvÆuê<< 16Ë| 
	`gëw‹d
(dep);

127 
dï
->
DbôsLe·
 = 15;

128 
dï
->
Dønge
 = 
HALF
;

130 #i‡(2==
TRACE
)

131 
	`Ârötf
(
p_åa˚
, "vÆue: %d fú°byã: %d code_Àn: %d\n", 
dï
->
DvÆue
 >> dï->
DbôsLe·
, 
fú°byã
, *
code_Àn
);

133 
	}
}

142 
	$¨ideco_bôs_ªad
(
DecodögEnvú⁄mítPå
 
dï
)

144 #i‡(2==
TRACE
)

145 
tmp
 = ((*
dï
->
Dcode°rm_Àn
Ë<< 3Ë- dï->
DbôsLe·
;

146 
	`Ârötf
(
p_åa˚
, "tmp: %d\n", 
tmp
);

147  
tmp
;

149  (((*
dï
->
Dcode°rm_Àn
Ë<< 3Ë- dï->
DbôsLe·
);

151 
	}
}

162 
	$büri_decode_symbﬁ
(
DecodögEnvú⁄mít
 *
dï
, 
BiC⁄ãxtTy≥
 *
bi_˘
 )

164 
bô
 = 
bi_˘
->
MPS
;

165 *
vÆue
 = &
dï
->
DvÆue
;

166 *
ønge
 = &
dï
->
Dønge
;

167 
uöt16
 *
°©e
 = &
bi_˘
->state;

168 
rLPS
 = 
rLPS_èbÀ_64x4
[*
°©e
][(*
ønge
>>6) & 0x03];

169 *
DbôsLe·
 = &
dï
->DbitsLeft;

171 *
ønge
 -
rLPS
;

173 if(*
vÆue
 < (*
ønge
 << *
DbôsLe·
))

175 *
°©e
 = 
AC_√xt_°©e_MPS_64
[*state];

176 if–*
ønge
 >
QUARTER
 )

178  (
bô
);

182 *
ønge
 <<= 1;

183 (*
DbôsLe·
)--;

188 
ªn‹m
 = 
ªn‹m_èbÀ_32
[(
rLPS
>>3) & 0x1F];

189 *
vÆue
 -(*
ønge
 << *
DbôsLe·
);

191 *
ønge
 = (
rLPS
 << 
ªn‹m
);

192 (*
DbôsLe·
Ë-
ªn‹m
;

194 
bô
 ^= 0x01;

195 i‡(!(*
°©e
))

196 
bi_˘
->
MPS
 ^= 0x01;

198 *
°©e
 = 
AC_√xt_°©e_LPS_64
[*state];

201 if–*
DbôsLe·
 > 0 )

203  (
bô
);

207 *
vÆue
 <<= 16;

208 *
vÆue
 |
	`gëw‹d
(
dï
);

210 (*
DbôsLe·
) += 16;

212  (
bô
);

214 
	}
}

225 
	$büri_decode_symbﬁ_eq_¥ob
(
DecodögEnvú⁄mítPå
 
dï
)

227 
tmp_vÆue
;

228 *
vÆue
 = &
dï
->
DvÆue
;

229 *
DbôsLe·
 = &
dï
->DbitsLeft;

231 if(--(*
DbôsLe·
) == 0)

233 *
vÆue
 = (*vÆuê<< 16Ë| 
	`gëw‹d
–
dï
 );

235 *
DbôsLe·
 = 16;

237 
tmp_vÆue
 = *
vÆue
 - (
dï
->
Dønge
 << *
DbôsLe·
);

239 i‡(
tmp_vÆue
 < 0)

245 *
vÆue
 = 
tmp_vÆue
;

248 
	}
}

258 
	$büri_decode_föÆ
(
DecodögEnvú⁄mítPå
 
dï
)

260 
ønge
 = 
dï
->
Dønge
 - 2;

261 
vÆue
 = 
dï
->
DvÆue
;

262 
vÆue
 -(
ønge
 << 
dï
->
DbôsLe·
);

264 i‡(
vÆue
 < 0)

266 if–
ønge
 >
QUARTER
 )

268 
dï
->
Dønge
 = 
ønge
;

273 
dï
->
Dønge
 = (
ønge
 << 1);

274 if–--(
dï
->
DbôsLe·
) > 0 )

278 
dï
->
DvÆue
 = (dï->DvÆuê<< 16Ë| 
	`gëw‹d
( dep );

280 
dï
->
DbôsLe·
 = 16;

289 
	}
}

297 
	$büri_öô_c⁄ãxt
 (
qp
, 
BiC⁄ãxtTy≥På
 
˘x
, c⁄° * 
öi
)

299 
p°©e
 = ((
öi
[0]* 
qp
 )>>4) + ini[1];

301 i‡–
p°©e
 >= 64 )

303 
p°©e
 = 
	`imö
(126,Östate);

304 
˘x
->
°©e
 = (
uöt16
Ë(
p°©e
 - 64);

305 
˘x
->
MPS
 = 1;

309 
p°©e
 = 
	`imax
(1,Östate);

310 
˘x
->
°©e
 = (
uöt16
Ë(63 - 
p°©e
);

311 
˘x
->
MPS
 = 0;

313 
	}
}

	@ldecod/src/block.c

17 
	~"c⁄åibut‹s.h
"

19 
	~"globÆ.h
"

20 
	~"block.h
"

21 
	~"blk_¥edi˘i⁄.h
"

22 
	~"image.h
"

23 
	~"mb_ac˚ss.h
"

24 
	~"å™sf‹m.h
"

25 
	~"qu™t.h
"

26 
	~"memÆloc.h
"

34 
	$ôøns4x4
(
Ma¸oblock
 *
cuºMB
,

35 
Cﬁ‹Pœ√
 
∂
,

36 
ioff
,

37 
joff
)

39 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

40 **
mb_ºes
 = 
cuºSli˚
->mb_ºes[
∂
];

42 
	`övî£4x4
(
cuºSli˚
->
cof
[
∂
],
mb_ºes
,
joff
,
ioff
);

44 
	`ßm∂e_ªc⁄°ru˘
 (&
cuºSli˚
->
mb_ªc
[
∂
][
joff
], &cuºSli˚->
mb_¥ed
[∂][joff], &
mb_ºes
[joff], 
ioff
, ioff, 
BLOCK_SIZE
, BLOCK_SIZE, 
cuºMB
->
p_Vid
->
max_≥l_vÆue_comp
[∂], 
DQ_BITS
);

45 
	}
}

53 
	$ôøns4x4_ls
(
Ma¸oblock
 *
cuºMB
,

54 
Cﬁ‹Pœ√
 
∂
,

55 
ioff
,

56 
joff
)

58 
i
,
j
;

60 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

61 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

62 
max_img≥l_vÆue
 = 
p_Vid
->
max_≥l_vÆue_comp
[
∂
];

64 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_¥ed[
∂
];

65 
img≥l
 **
mb_ªc
 = 
cuºSli˚
->mb_ªc[
∂
];

66 **
mb_ºes
 = 
cuºSli˚
->mb_ºe†[
∂
];

68 
j
 = 
joff
; j < jof‡+ 
BLOCK_SIZE
; ++j)

70 
i
 = 
ioff
; i < iof‡+ 
BLOCK_SIZE
; ++i)

72 
mb_ªc
[
j
][
i
] = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, 
mb_¥ed
[j][i] + 
mb_ºes
[j][i]);

75 
	}
}

84 
	$Inv_ResiduÆ_å™s_4x4
(
Ma¸oblock
 *
cuºMB
,

85 
Cﬁ‹Pœ√
 
∂
,

86 
ioff
,

87 
joff
)

89 
i
,
j
;

90 
ãmp
[4][4];

91 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

92 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_¥ed[
∂
];

93 
img≥l
 **
mb_ªc
 = 
cuºSli˚
->mb_ªc[
∂
];

94 **
mb_ºes
 = 
cuºSli˚
->mb_ºes[
∂
];

95 **
cof
 = 
cuºSli˚
->cof[
∂
];

97 if(
cuºMB
->
ùmode_DPCM
 =
VERT_PRED
)

99 
i
=0; i<4; ++i)

101 
ãmp
[0][
i
] = 
cof
[
joff
 + 0][
ioff
 + i];

102 
ãmp
[1][
i
] = 
cof
[
joff
 + 1][
ioff
 + i] +Åemp[0][i];

103 
ãmp
[2][
i
] = 
cof
[
joff
 + 2][
ioff
 + i] +Åemp[1][i];

104 
ãmp
[3][
i
] = 
cof
[
joff
 + 3][
ioff
 + i] +Åemp[2][i];

107 
i
=0; i<4; ++i)

109 
mb_ºes
[
joff
 ][
ioff
 + 
i
]=
ãmp
[0][i];

110 
mb_ºes
[
joff
 + 1][
ioff
 + 
i
]=
ãmp
[1][i];

111 
mb_ºes
[
joff
 + 2][
ioff
 + 
i
]=
ãmp
[2][i];

112 
mb_ºes
[
joff
 + 3][
ioff
 + 
i
]=
ãmp
[3][i];

115 if(
cuºMB
->
ùmode_DPCM
 =
HOR_PRED
)

117 
j
=0; j<4; ++j)

119 
ãmp
[
j
][0] = 
cof
[
joff
 + j][
ioff
 ];

120 
ãmp
[
j
][1] = 
cof
[
joff
 + j][
ioff
 + 1] +Åemp[j][0];

121 
ãmp
[
j
][2] = 
cof
[
joff
 + j][
ioff
 + 2] +Åemp[j][1];

122 
ãmp
[
j
][3] = 
cof
[
joff
 + j][
ioff
 + 3] +Åemp[j][2];

125 
j
=0; j<4; ++j)

127 
mb_ºes
[
joff
 + 
j
][
ioff
 ]=
ãmp
[j][0];

128 
mb_ºes
[
joff
 + 
j
][
ioff
 + 1]=
ãmp
[j][1];

129 
mb_ºes
[
joff
 + 
j
][
ioff
 + 2]=
ãmp
[j][2];

130 
mb_ºes
[
joff
 + 
j
][
ioff
 + 3]=
ãmp
[j][3];

135 
j
 = 
joff
; j < jof‡+ 
BLOCK_SIZE
; ++j)

136 
i
 = 
ioff
; i < iof‡+ 
BLOCK_SIZE
; ++i)

137 
mb_ºes
[
j
][
i
] = 
cof
[j][i];

140 
j
 = 
joff
; j < jof‡+ 
BLOCK_SIZE
; ++j)

142 
i
 = 
ioff
; i < iof‡+ 
BLOCK_SIZE
; ++i)

144 
mb_ªc
[
j
][
i
] = (
img≥l
Ë(
mb_ºes
[j][i] + 
mb_¥ed
[j][i]);

147 
	}
}

159 
	$Inv_ResiduÆ_å™s_8x8
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
ioff
,
joff
)

161 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

162 
i
, 
j
;

163 
ãmp
[8][8];

164 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_¥ed[
∂
];

165 
img≥l
 **
mb_ªc
 = 
cuºSli˚
->mb_ªc[
∂
];

166 **
mb_ºes
 = 
cuºSli˚
->mb_ºes[
∂
];

168 if(
cuºMB
->
ùmode_DPCM
 =
VERT_PRED
)

170 
i
=0; i<8; ++i)

172 
ãmp
[0][
i
] = 
mb_ºes
[
joff
 + 0][
ioff
 + i];

173 
ãmp
[1][
i
] = 
mb_ºes
[
joff
 + 1][
ioff
 + i] +Åemp[0][i];

174 
ãmp
[2][
i
] = 
mb_ºes
[
joff
 + 2][
ioff
 + i] +Åemp[1][i];

175 
ãmp
[3][
i
] = 
mb_ºes
[
joff
 + 3][
ioff
 + i] +Åemp[2][i];

176 
ãmp
[4][
i
] = 
mb_ºes
[
joff
 + 4][
ioff
 + i] +Åemp[3][i];

177 
ãmp
[5][
i
] = 
mb_ºes
[
joff
 + 5][
ioff
 + i] +Åemp[4][i];

178 
ãmp
[6][
i
] = 
mb_ºes
[
joff
 + 6][
ioff
 + i] +Åemp[5][i];

179 
ãmp
[7][
i
] = 
mb_ºes
[
joff
 + 7][
ioff
 + i] +Åemp[6][i];

181 
i
=0; i<8; ++i)

183 
mb_ºes
[
joff
 ][
ioff
+
i
]=
ãmp
[0][i];

184 
mb_ºes
[
joff
+1][
ioff
+
i
]=
ãmp
[1][i];

185 
mb_ºes
[
joff
+2][
ioff
+
i
]=
ãmp
[2][i];

186 
mb_ºes
[
joff
+3][
ioff
+
i
]=
ãmp
[3][i];

187 
mb_ºes
[
joff
+4][
ioff
+
i
]=
ãmp
[4][i];

188 
mb_ºes
[
joff
+5][
ioff
+
i
]=
ãmp
[5][i];

189 
mb_ºes
[
joff
+6][
ioff
+
i
]=
ãmp
[6][i];

190 
mb_ºes
[
joff
+7][
ioff
+
i
]=
ãmp
[7][i];

193 if(
cuºMB
->
ùmode_DPCM
 =
HOR_PRED
)

195 
i
=0; i<8; ++i)

197 
ãmp
[
i
][0] = 
mb_ºes
[
joff
 + i][
ioff
 + 0];

198 
ãmp
[
i
][1] = 
mb_ºes
[
joff
 + i][
ioff
 + 1] +Åemp[i][0];

199 
ãmp
[
i
][2] = 
mb_ºes
[
joff
 + i][
ioff
 + 2] +Åemp[i][1];

200 
ãmp
[
i
][3] = 
mb_ºes
[
joff
 + i][
ioff
 + 3] +Åemp[i][2];

201 
ãmp
[
i
][4] = 
mb_ºes
[
joff
 + i][
ioff
 + 4] +Åemp[i][3];

202 
ãmp
[
i
][5] = 
mb_ºes
[
joff
 + i][
ioff
 + 5] +Åemp[i][4];

203 
ãmp
[
i
][6] = 
mb_ºes
[
joff
 + i][
ioff
 + 6] +Åemp[i][5];

204 
ãmp
[
i
][7] = 
mb_ºes
[
joff
 + i][
ioff
 + 7] +Åemp[i][6];

206 
i
=0; i<8; ++i)

208 
mb_ºes
[
joff
+
i
][
ioff
+0]=
ãmp
[i][0];

209 
mb_ºes
[
joff
+
i
][
ioff
+1]=
ãmp
[i][1];

210 
mb_ºes
[
joff
+
i
][
ioff
+2]=
ãmp
[i][2];

211 
mb_ºes
[
joff
+
i
][
ioff
+3]=
ãmp
[i][3];

212 
mb_ºes
[
joff
+
i
][
ioff
+4]=
ãmp
[i][4];

213 
mb_ºes
[
joff
+
i
][
ioff
+5]=
ãmp
[i][5];

214 
mb_ºes
[
joff
+
i
][
ioff
+6]=
ãmp
[i][6];

215 
mb_ºes
[
joff
+
i
][
ioff
+7]=
ãmp
[i][7];

219 
j
 = 
joff
; j < jof‡+ 
BLOCK_SIZE
*2; ++j)

221 
i
 = 
ioff
; i < iof‡+ 
BLOCK_SIZE
*2; ++i)

223 
mb_ªc
 [
j
][
i
] = (
img≥l
Ë(
mb_ºes
[j][i] + 
mb_¥ed
[j][i]);

226 
	}
}

237 
	$Inv_ResiduÆ_å™s_16x16
(
Ma¸oblock
 *
cuºMB
,

238 
Cﬁ‹Pœ√
 
∂
)

240 
i
,
j
;

241 
ãmp
[16][16];

242 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

243 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_¥ed[
∂
];

244 
img≥l
 **
mb_ªc
 = 
cuºSli˚
->mb_ªc[
∂
];

245 **
mb_ºes
 = 
cuºSli˚
->mb_ºes[
∂
];

246 **
cof
 = 
cuºSli˚
->cof[
∂
];

248 if(
cuºMB
->
ùmode_DPCM
 =
VERT_PRED_16
)

250 
i
=0; i<
MB_BLOCK_SIZE
; ++i)

252 
ãmp
[0][
i
] = 
cof
[0][i];

253 
j
 = 1; j < 
MB_BLOCK_SIZE
; j++)

254 
ãmp
[
j
][
i
] = 
cof
[j][i] +Åemp[j-1][i];

257 
i
=0; i<
MB_BLOCK_SIZE
; ++i)

259 
j
 = 0; j < 
MB_BLOCK_SIZE
; j++)

260 
mb_ºes
[
j
][
i
]=
ãmp
[j][i];

263 if(
cuºMB
->
ùmode_DPCM
 =
HOR_PRED_16
)

265 
j
=0; j<
MB_BLOCK_SIZE
; ++j)

267 
ãmp
[
j
][ 0] = 
cof
[j][ 0 ];

268 
i
 = 1; i < 
MB_BLOCK_SIZE
; i++)

269 
ãmp
[
j
][
i
] = 
cof
[j][i] +Åemp[j][i-1];

272 
j
=0; j<
MB_BLOCK_SIZE
; ++j)

274 
i
 = 0; i < 
MB_BLOCK_SIZE
; ++i)

275 
mb_ºes
[
j
][
i
]=
ãmp
[j][i];

280 
j
 = 0; j < 
MB_BLOCK_SIZE
; ++j)

281 
i
 = 0; i < 
MB_BLOCK_SIZE
; ++i)

282 
mb_ºes
[
j
][
i
] = 
cof
[j][i];

285 
j
 = 0; j < 
MB_BLOCK_SIZE
; ++j)

287 
i
 = 0; i < 
MB_BLOCK_SIZE
; ++i)

289 
mb_ªc
[
j
][
i
] = (
img≥l
Ë(
mb_ºes
[j][i] + 
mb_¥ed
[j][i]);

292 
	}
}

302 
	$Inv_ResiduÆ_å™s_Chroma
(
Ma¸oblock
 *
cuºMB
, 
uv
)

304 
i
, 
j
;

305 
ãmp
[16][16];

306 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

309 **
mb_ºes
 = 
cuºSli˚
->mb_ºes[
uv
+1];

310 **
cof
 = 
cuºSli˚
->cof[
uv
+1];

311 
width
, 
height
;

313 
width
 = 
cuºMB
->
p_Vid
->
mb_¸_size_x
;

314 
height
 = 
cuºMB
->
p_Vid
->
mb_¸_size_y
;

316 if(
cuºMB
->
c_ùªd_mode
 =
VERT_PRED_8
)

318 
i
=0; i<
width
; i++)

320 
ãmp
[0][
i
] = 
cof
[0][i];

321 
j
 = 1; j < 
height
; j++)

322 
ãmp
[
j
][
i
] =Åemp[j-1][i] + 
cof
[j][i];

324 
i
=0; i<
width
; i++)

326 
j
 = 0; j < 
height
; j++)

327 
mb_ºes
[
j
][
i
] = 
ãmp
[j][i];

332 
i
=0; i<
height
; i++)

334 
ãmp
[
i
][0] = 
cof
[i][0];

335 
j
 = 1; j < 
width
; j++)

336 
ãmp
[
i
][
j
] =Åemp[i][j-1] + 
cof
[i][j];

338 
i
=0; i<
height
; i++)

340 
j
 = 0; j < 
width
; j++)

341 
mb_ºes
[
i
][
j
] = 
ãmp
[i][j];

344 
	}
}

353 
	$ôøns_2
(
Ma¸oblock
 *
cuºMB
,

354 
Cﬁ‹Pœ√
 
∂
)

356 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

357 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

358 
j
;

360 
å™sf‹m_∂
 = (
p_Vid
->
£∑øã_cﬁour_∂™e_Êag
 !0Ë? 
PLANE_Y
 : 
∂
;

361 **
cof
 = 
cuºSli˚
->cof[
å™sf‹m_∂
];

362 
qp_sˇÀd
 = 
cuºMB
->qp_sˇÀd[
å™sf‹m_∂
];

364 
qp_≥r
 = 
p_Vid
->
qp_≥r_m©rix
[ 
qp_sˇÀd
 ];

365 
qp_ªm
 = 
p_Vid
->
qp_ªm_m©rix
[ 
qp_sˇÀd
 ];

367 
övLevñSˇÀ
 = 
cuºSli˚
->
InvLevñSˇÀ4x4_I¡ø
[
∂
][
qp_ªm
][0][0];

368 **
M4
;

369 
	`gë_mem2Döt
(&
M4
, 
BLOCK_SIZE
, BLOCK_SIZE);

372 
j
=0; j < 4;++j)

374 
M4
[
j
][0]=
cof
[j<<2][0];

375 
M4
[
j
][1]=
cof
[j<<2][4];

376 
M4
[
j
][2]=
cof
[j<<2][8];

377 
M4
[
j
][3]=
cof
[j<<2][12];

380 
	`ihadam¨d4x4
(
M4
, M4);

383 
j
=0; j < 4;++j)

385 
cof
[
j
<<2][0] = 
	`rshi·_∫d
((–
M4
[j][0] * 
övLevñSˇÀ
Ë<< 
qp_≥r
), 6);

386 
cof
[
j
<<2][4] = 
	`rshi·_∫d
((–
M4
[j][1] * 
övLevñSˇÀ
Ë<< 
qp_≥r
), 6);

387 
cof
[
j
<<2][8] = 
	`rshi·_∫d
((–
M4
[j][2] * 
övLevñSˇÀ
Ë<< 
qp_≥r
), 6);

388 
cof
[
j
<<2][12] = 
	`rshi·_∫d
((–
M4
[j][3] * 
övLevñSˇÀ
Ë<< 
qp_≥r
), 6);

391 
	`‰ì_mem2Döt
(
M4
);

392 
	}
}

395 
	$ôøns_•
(
Ma¸oblock
 *
cuºMB
,

396 
Cﬁ‹Pœ√
 
∂
,

397 
ioff
,

398 
joff
)

400 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

401 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

402 
i
,
j
;

403 
ûev
, 
icof
;

405 
qp
 = (
cuºSli˚
->
¶i˚_ty≥
 =
SI_SLICE
Ë? cuºSli˚->
qs
 : currSlice->qp;

406 
qp_≥r
 = 
p_Vid
->
qp_≥r_m©rix
[ 
qp
 ];

407 
qp_ªm
 = 
p_Vid
->
qp_ªm_m©rix
[ 
qp
 ];

409 
qp_≥r_•
 = 
p_Vid
->
qp_≥r_m©rix
[ 
cuºSli˚
->
qs
 ];

410 
qp_ªm_•
 = 
p_Vid
->
qp_ªm_m©rix
[ 
cuºSli˚
->
qs
 ];

411 
q_bôs_•
 = 
Q_BITS
 + 
qp_≥r_•
;

413 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_¥ed[
∂
];

414 
img≥l
 **
mb_ªc
 = 
cuºSli˚
->mb_ªc[
∂
];

415 **
mb_ºes
 = 
cuºSli˚
->mb_ºes[
∂
];

416 **
cof
 = 
cuºSli˚
->cof[
∂
];

417 
max_img≥l_vÆue
 = 
p_Vid
->
max_≥l_vÆue_comp
[
∂
];

419 c⁄° (*
InvLevñSˇÀ4x4
Ë[4] = 
dequ™t_c€f
[
qp_ªm
];

420 c⁄° (*
InvLevñSˇÀ4x4SP
)[4] = 
dequ™t_c€f
[
qp_ªm_•
];

421 **
PBlock
;

423 
	`gë_mem2Döt
(&
PBlock
, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE);

425 
j
=0; j< 
BLOCK_SIZE
; ++j)

427 
PBlock
[
j
][0] = 
mb_¥ed
[j+
joff
][
ioff
 ];

428 
PBlock
[
j
][1] = 
mb_¥ed
[j+
joff
][
ioff
 + 1];

429 
PBlock
[
j
][2] = 
mb_¥ed
[j+
joff
][
ioff
 + 2];

430 
PBlock
[
j
][3] = 
mb_¥ed
[j+
joff
][
ioff
 + 3];

433 
	`f‹w¨d4x4
(
PBlock
, PBlock, 0, 0);

435 if(
cuºSli˚
->
•_swôch
 || cuºSli˚->
¶i˚_ty≥
==
SI_SLICE
)

437 
j
=0;j<
BLOCK_SIZE
;++j)

439 
i
=0;i<
BLOCK_SIZE
;++i)

442 
icof
 = (
cof
[
joff
 + 
j
][
ioff
 + 
i
] >> 
qp_≥r
Ë/ 
InvLevñSˇÀ4x4
[j][i];

445 
ûev
 = 
	`rshi·_∫d_sf
(
	`übs
(
PBlock
[
j
][
i
]Ë* 
qu™t_c€f
[
qp_ªm_•
][j][i], 
q_bôs_•
);

446 
ûev
 = 
	`isig«b
(ûev, 
PBlock
[
j
][
i
]Ë+ 
icof
;

447 
cof
[
joff
 + 
j
][
ioff
 + 
i
] = 
ûev
 * 
InvLevñSˇÀ4x4SP
[j][i] << 
qp_≥r_•
;

453 
j
=0;j<
BLOCK_SIZE
;++j)

455 
i
=0;i<
BLOCK_SIZE
;++i)

458 
icof
 = (
cof
[
joff
 + 
j
][
ioff
 + 
i
] >> 
qp_≥r
Ë/ 
InvLevñSˇÀ4x4
[j][i];

461 
ûev
 = 
PBlock
[
j
][
i
] + ((
icof
 * 
InvLevñSˇÀ4x4
[j][i] * 
A
[j][i] << 
qp_≥r
) >> 6);

462 
ûev
 = 
	`isign
(ûevË* 
	`rshi·_∫d_sf
(
	`übs
(ûevË* 
qu™t_c€f
[
qp_ªm_•
][
j
][
i
], 
q_bôs_•
);

464 
cof
[
joff
 + 
j
][
ioff
 + 
i
] = 
ûev
 * 
InvLevñSˇÀ4x4SP
[j][i] << 
qp_≥r_•
;

469 
	`övî£4x4
(
cof
, 
mb_ºes
, 
joff
, 
ioff
);

471 
j
=
joff
; j<jof‡+
BLOCK_SIZE
;++j)

473 
mb_ªc
[
j
][
ioff
 ] = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
,
	`rshi·_∫d_sf
(
mb_ºes
[j][iof‡], 
DQ_BITS
));

474 
mb_ªc
[
j
][
ioff
+ 1] = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
,
	`rshi·_∫d_sf
(
mb_ºes
[j][ioff+ 1], 
DQ_BITS
));

475 
mb_ªc
[
j
][
ioff
+ 2] = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
,
	`rshi·_∫d_sf
(
mb_ºes
[j][ioff+ 2], 
DQ_BITS
));

476 
mb_ªc
[
j
][
ioff
+ 3] = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
,
	`rshi·_∫d_sf
(
mb_ºes
[j][ioff+ 3], 
DQ_BITS
));

479 
	`‰ì_mem2Döt
(
PBlock
);

480 
	}
}

483 
	$ôøns_•_¸
(
Ma¸oblock
 *
cuºMB
, 
uv
)

485 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

486 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

487 
i
,
j
,
ûev
, 
icof
, 
n2
,
n1
;

488 
mp1
[
BLOCK_SIZE
];

489 
qp_≥r
,
qp_ªm
;

490 
qp_≥r_•
,
qp_ªm_•
,
q_bôs_•
;

491 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_¥ed[
uv
 + 1];

492 **
cof
 = 
cuºSli˚
->cof[
uv
 + 1];

493 **
PBlock
 = 
	`√w_mem2Döt
(
MB_BLOCK_SIZE
, MB_BLOCK_SIZE);

495 
qp_≥r
 = 
p_Vid
->
qp_≥r_m©rix
[ ((
cuºSli˚
->
qp
 < 0 ? cuºSli˚->q∞: 
QP_SCALE_CR
[currSlice->qp]))];

496 
qp_ªm
 = 
p_Vid
->
qp_ªm_m©rix
[ ((
cuºSli˚
->
qp
 < 0 ? cuºSli˚->q∞: 
QP_SCALE_CR
[currSlice->qp]))];

498 
qp_≥r_•
 = 
p_Vid
->
qp_≥r_m©rix
[ ((
cuºSli˚
->
qs
 < 0 ? cuºSli˚->q†: 
QP_SCALE_CR
[currSlice->qs]))];

499 
qp_ªm_•
 = 
p_Vid
->
qp_ªm_m©rix
[ ((
cuºSli˚
->
qs
 < 0 ? cuºSli˚->q†: 
QP_SCALE_CR
[currSlice->qs]))];

500 
q_bôs_•
 = 
Q_BITS
 + 
qp_≥r_•
;

502 i‡(
cuºSli˚
->
¶i˚_ty≥
 =
SI_SLICE
)

504 
qp_≥r
 = 
qp_≥r_•
;

505 
qp_ªm
 = 
qp_ªm_•
;

508 
j
=0; j < 
p_Vid
->
mb_¸_size_y
; ++j)

510 
i
=0; i < 
p_Vid
->
mb_¸_size_x
; ++i)

512 
PBlock
[
j
][
i
] = 
mb_¥ed
[j][i];

513 
mb_¥ed
[
j
][
i
] = 0;

517 
n2
=0;Ç2 < 
p_Vid
->
mb_¸_size_y
;Ç2 +
BLOCK_SIZE
)

519 
n1
=0;Ç1 < 
p_Vid
->
mb_¸_size_x
;Ç1 +
BLOCK_SIZE
)

521 
	`f‹w¨d4x4
(
PBlock
, PBlock, 
n2
, 
n1
);

526 
mp1
[0] = (
PBlock
[0][0] + PBlock[4][0] + PBlock[0][4] + PBlock[4][4]);

527 
mp1
[1] = (
PBlock
[0][0] - PBlock[4][0] + PBlock[0][4] - PBlock[4][4]);

528 
mp1
[2] = (
PBlock
[0][0] + PBlock[4][0] - PBlock[0][4] - PBlock[4][4]);

529 
mp1
[3] = (
PBlock
[0][0] - PBlock[4][0] - PBlock[0][4] + PBlock[4][4]);

531 i‡(
cuºSli˚
->
•_swôch
 || cuºSli˚->
¶i˚_ty≥
 =
SI_SLICE
)

533 
n2
=0;Ç2 < 2; ++n2 )

535 
n1
=0;Ç1 < 2; ++n1 )

538 
ûev
 = 
	`rshi·_∫d_sf
(
	`übs
 (
mp1
[
n1
+
n2
*2]Ë* 
qu™t_c€f
[
qp_ªm_•
][0][0], 
q_bôs_•
 + 1);

540 
ûev
 = 
	`isig«b
(ûev, 
mp1
[
n1
+
n2
*2]Ë+ 
cof
[n2<<2][n1<<2];

542 
mp1
[
n1
+
n2
*2] =
ûev
 * 
dequ™t_c€f
[
qp_ªm_•
][0][0] << 
qp_≥r_•
;

546 
n2
 = 0;Ç2 < 
p_Vid
->
mb_¸_size_y
;Ç2 +
BLOCK_SIZE
)

548 
n1
 = 0;Ç1 < 
p_Vid
->
mb_¸_size_x
;Ç1 +
BLOCK_SIZE
)

550 
j
 = 0; j < 
BLOCK_SIZE
; ++j)

552 
i
 = 0; i < 
BLOCK_SIZE
; ++i)

555 
cof
[
n2
 + 
j
][
n1
 + 
i
] = (cof[n2 + j][n1 + i] >> 
qp_≥r
Ë/ 
dequ™t_c€f
[
qp_ªm
][j][i];

558 
ûev
 = 
	`rshi·_∫d_sf
(
	`übs
(
PBlock
[
n2
 + 
j
][
n1
 + 
i
]Ë* 
qu™t_c€f
[
qp_ªm_•
][j][i], 
q_bôs_•
);

560 
ûev
 = 
	`isig«b
(ûev,
PBlock
[
n2
 + 
j
][
n1
 + 
i
]Ë+ 
cof
[n2 + j][n1 + i];

562 
cof
[
n2
 + 
j
][
n1
 + 
i
] = 
ûev
 * 
dequ™t_c€f
[
qp_ªm_•
][j][i] << 
qp_≥r_•
;

570 
n2
=0;Ç2 < 2; ++n2 )

572 
n1
=0;Ç1 < 2; ++n1 )

574 
ûev
 = 
mp1
[
n1
+
n2
*2] + (((
cof
[n2<<2][n1<<2] * 
dequ™t_c€f
[
qp_ªm
][0][0] * 
A
[0][0]Ë<< 
qp_≥r
) >> 5);

575 
ûev
 = 
	`isign
(ûevË* 
	`rshi·_∫d_sf
(
	`übs
(ûevË* 
qu™t_c€f
[
qp_ªm_•
][0][0], 
q_bôs_•
 + 1);

577 
mp1
[
n1
+
n2
*2] = 
ûev
 * 
dequ™t_c€f
[
qp_ªm_•
][0][0] << 
qp_≥r_•
;

581 
n2
 = 0;Ç2 < 
p_Vid
->
mb_¸_size_y
;Ç2 +
BLOCK_SIZE
)

583 
n1
 = 0;Ç1 < 
p_Vid
->
mb_¸_size_x
;Ç1 +
BLOCK_SIZE
)

585 
j
 = 0; j< 
BLOCK_SIZE
; ++j)

587 
i
 = 0; i< 
BLOCK_SIZE
; ++i)

591 
icof
 = (
cof
[
n2
 + 
j
][
n1
 + 
i
] >> 
qp_≥r
Ë/ 
dequ™t_c€f
[
qp_ªm
][j][i];

593 
ûev
 = 
PBlock
[
n2
 + 
j
][
n1
 + 
i
] + ((
icof
 * 
dequ™t_c€f
[
qp_ªm
][j][i] * 
A
[j][i] << 
qp_≥r
) >> 6);

595 
ûev
 = 
	`isign
(ûevË* 
	`rshi·_∫d_sf
(
	`übs
(ûevË* 
qu™t_c€f
[
qp_ªm_•
][
j
][
i
], 
q_bôs_•
);

596 
cof
[
n2
 + 
j
][
n1
 + 
i
] = 
ûev
 * 
dequ™t_c€f
[
qp_ªm_•
][j][i] << 
qp_≥r_•
;

604 
cof
[0][0] = (
mp1
[0] + mp1[1] + mp1[2] + mp1[3]) >> 1;

605 
cof
[0][4] = (
mp1
[0] + mp1[1] - mp1[2] - mp1[3]) >> 1;

606 
cof
[4][0] = (
mp1
[0] - mp1[1] + mp1[2] - mp1[3]) >> 1;

607 
cof
[4][4] = (
mp1
[0] - mp1[1] - mp1[2] + mp1[3]) >> 1;

609 
	`‰ì_mem2Döt
(
PBlock
);

610 
	}
}

612 
	$iMBå™s4x4
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
smb
)

614 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

617 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
cuºMB
->
p_Sli˚
->dec_picture;

618 
jj
, 
ii
;

619 
block8x8
;

620 
k
;

622 
img≥l
 **
cuº_img
 = 
∂
 ? 
dec_pi˘uª
->
imgUV
[∂ - 1]: dec_pi˘uª->
imgY
;

626 i‡(
cuºMB
->
is_los¶ess
 && cuºMB->
mb_ty≥
 =
I16MB
)

628 
	`Inv_ResiduÆ_å™s_16x16
(
cuºMB
, 
∂
) ;

630 i‡(
smb
 || 
cuºMB
->
is_los¶ess
 =
TRUE
)

632 
cuºMB
->
ôøns_4x4
 = (
smb
Ë? 
ôøns_•
 : ((cuºMB->
is_los¶ess
 =
FALSE
Ë? 
ôøns4x4
 : 
Inv_ResiduÆ_å™s_4x4
);

633 
block8x8
=0; block8x8 < 
MB_BLOCK_SIZE
; block8x8 += 4)

635 
k
 = 
block8x8
; k < block8x8 + 4; ++k )

637 
jj
 = ((
decode_block_sˇn
[
k
] >> 2Ë& 3Ë<< 
BLOCK_SHIFT
;

638 
ii
 = (
decode_block_sˇn
[
k
] & 3Ë<< 
BLOCK_SHIFT
;

640 
cuºMB
->
	`ôøns_4x4
(cuºMB, 
∂
, 
ii
, 
jj
);

646 **
cof
 = 
cuºSli˚
->cof[
∂
];

647 **
mb_ºes
 = 
cuºSli˚
->mb_ºes[
∂
];

649 i‡(
cuºMB
->
is_öåa_block
 =
FALSE
)

651 i‡(
cuºMB
->
cbp
 & 0x01)

653 
	`övî£4x4
(
cof
, 
mb_ºes
, 0, 0);

654 
	`övî£4x4
(
cof
, 
mb_ºes
, 0, 4);

655 
	`övî£4x4
(
cof
, 
mb_ºes
, 4, 0);

656 
	`övî£4x4
(
cof
, 
mb_ºes
, 4, 4);

658 i‡(
cuºMB
->
cbp
 & 0x02)

660 
	`övî£4x4
(
cof
, 
mb_ºes
, 0, 8);

661 
	`övî£4x4
(
cof
, 
mb_ºes
, 0, 12);

662 
	`övî£4x4
(
cof
, 
mb_ºes
, 4, 8);

663 
	`övî£4x4
(
cof
, 
mb_ºes
, 4, 12);

665 i‡(
cuºMB
->
cbp
 & 0x04)

667 
	`övî£4x4
(
cof
, 
mb_ºes
, 8, 0);

668 
	`övî£4x4
(
cof
, 
mb_ºes
, 8, 4);

669 
	`övî£4x4
(
cof
, 
mb_ºes
, 12, 0);

670 
	`övî£4x4
(
cof
, 
mb_ºes
, 12, 4);

672 i‡(
cuºMB
->
cbp
 & 0x08)

674 
	`övî£4x4
(
cof
, 
mb_ºes
, 8, 8);

675 
	`övî£4x4
(
cof
, 
mb_ºes
, 8, 12);

676 
	`övî£4x4
(
cof
, 
mb_ºes
, 12, 8);

677 
	`övî£4x4
(
cof
, 
mb_ºes
, 12, 12);

682 
jj
 = 0; jj < 
MB_BLOCK_SIZE
; jj +
BLOCK_SIZE
)

684 
	`övî£4x4
(
cof
, 
mb_ºes
, 
jj
, 0);

685 
	`övî£4x4
(
cof
, 
mb_ºes
, 
jj
, 4);

686 
	`övî£4x4
(
cof
, 
mb_ºes
, 
jj
, 8);

687 
	`övî£4x4
(
cof
, 
mb_ºes
, 
jj
, 12);

690 
	`ßm∂e_ªc⁄°ru˘
 (
cuºSli˚
->
mb_ªc
[
∂
], cuºSli˚->
mb_¥ed
[∂], 
mb_ºes
, 0, 0, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE, 
cuºMB
->
p_Vid
->
max_≥l_vÆue_comp
[∂], 
DQ_BITS
);

694 
	`c›y_image_d©a_16x16
(&
cuº_img
[
cuºMB
->
pix_y
], 
cuºSli˚
->
mb_ªc
[
∂
], cuºMB->
pix_x
, 0);

695 
	}
}

697 
	$iMBå™s8x8
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
)

700 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
cuºMB
->
p_Sli˚
->dec_picture;

701 
img≥l
 **
cuº_img
 = 
∂
 ? 
dec_pi˘uª
->
imgUV
[∂ - 1]: dec_pi˘uª->
imgY
;

704 i‡(
cuºMB
->
cbp
 & 0x01)

705 
	`ôøns8x8
(
cuºMB
, 
∂
, 0, 0);

707 
	`ic›y8x8
(
cuºMB
, 
∂
, 0, 0);

709 i‡(
cuºMB
->
cbp
 & 0x02)

710 
	`ôøns8x8
(
cuºMB
, 
∂
, 8, 0);

712 
	`ic›y8x8
(
cuºMB
, 
∂
, 8, 0);

714 i‡(
cuºMB
->
cbp
 & 0x04)

715 
	`ôøns8x8
(
cuºMB
, 
∂
, 0, 8);

717 
	`ic›y8x8
(
cuºMB
, 
∂
, 0, 8);

719 i‡(
cuºMB
->
cbp
 & 0x08)

720 
	`ôøns8x8
(
cuºMB
, 
∂
, 8, 8);

722 
	`ic›y8x8
(
cuºMB
, 
∂
, 8, 8);

724 
	`c›y_image_d©a_16x16
(&
cuº_img
[
cuºMB
->
pix_y
], cuºMB->
p_Sli˚
->
mb_ªc
[
∂
], cuºMB->
pix_x
, 0);

725 
	}
}

727 
	$iTønsf‹m
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
smb
)

729 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

730 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

731 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
cuºSli˚
->dec_picture;

732 
img≥l
 **
cuº_img
;

733 
uv
 = 
∂
-1;

735 i‡((
cuºMB
->
cbp
 & 15Ë!0 || 
smb
)

737 if(
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 == 0)

739 
	`iMBå™s4x4
(
cuºMB
, 
∂
, 
smb
);

743 
	`iMBå™s8x8
(
cuºMB
, 
∂
);

748 
cuº_img
 = 
∂
 ? 
dec_pi˘uª
->
imgUV
[
uv
] : dec_pi˘uª->
imgY
;

749 
	`c›y_image_d©a_16x16
(&
cuº_img
[
cuºMB
->
pix_y
], 
cuºSli˚
->
mb_¥ed
[
∂
], cuºMB->
pix_x
, 0);

751 if(
smb
)

752 
cuºSli˚
->
is_ª£t_c€ff
 = 
FALSE
;

754 i‡((
dec_pi˘uª
->
chroma_f‹m©_idc
 !
YUV400
Ë&& (dec_pi˘uª->chroma_f‹m©_id¯!
YUV444
))

756 
img≥l
 **
curUV
;

757 
b8
;

758 
ioff
, 
joff
;

759 
img≥l
 **
mb_ªc
;

761 
uv
 = 
PLANE_U
; uv <
PLANE_V
; ++uv)

765 
curUV
 = &
dec_pi˘uª
->
imgUV
[
uv
 - 1][
cuºMB
->
pix_c_y
];

766 
mb_ªc
 = 
cuºSli˚
->mb_ªc[
uv
];

768 i‡(!
smb
 && (
cuºMB
->
cbp
 >> 4))

770 i‡(
cuºMB
->
is_los¶ess
 =
FALSE
)

772 c⁄° *
x_pos
, *
y_pos
;

774 
b8
 = 0; b8 < (
p_Vid
->
num_uv_blocks
); ++b8)

776 
x_pos
 = 
subblk_off£t_x
[1][
b8
];

777 
y_pos
 = 
subblk_off£t_y
[1][
b8
];

779 
	`ôøns4x4
(
cuºMB
, 
uv
, *
x_pos
++, *
y_pos
++);

780 
	`ôøns4x4
(
cuºMB
, 
uv
, *
x_pos
++, *
y_pos
++);

781 
	`ôøns4x4
(
cuºMB
, 
uv
, *
x_pos
++, *
y_pos
++);

782 
	`ôøns4x4
(
cuºMB
, 
uv
, *
x_pos
 , *
y_pos
 );

784 
	`ßm∂e_ªc⁄°ru˘
 (
mb_ªc
, 
cuºSli˚
->
mb_¥ed
[
uv
], cuºSli˚->
mb_ºes
[uv], 0, 0,

785 
p_Vid
->
mb_size
[1][0],Ö_Vid->mb_size[1][1], 
cuºMB
->p_Vid->
max_≥l_vÆue_comp
[
uv
], 
DQ_BITS
);

789 c⁄° *
x_pos
, *
y_pos
;

790 
b8
 = 0; b8 < (
p_Vid
->
num_uv_blocks
); ++b8)

792 
i
,
j
;

793 
x_pos
 = 
subblk_off£t_x
[1][
b8
];

794 
y_pos
 = 
subblk_off£t_y
[1][
b8
];

796 
i
 = 0 ; i < 
p_Vid
->
mb_¸_size_y
 ; i ++)

798 
j
 = 0 ; j < 
p_Vid
->
mb_¸_size_x
 ; j ++)

800 
cuºSli˚
->
mb_ºes
[
uv
][
i
][
j
] = cuºSli˚->
cof
[uv][i][j] ;

804 
	`ôøns4x4_ls
(
cuºMB
, 
uv
, *
x_pos
++, *
y_pos
++);

805 
	`ôøns4x4_ls
(
cuºMB
, 
uv
, *
x_pos
++, *
y_pos
++);

806 
	`ôøns4x4_ls
(
cuºMB
, 
uv
, *
x_pos
++, *
y_pos
++);

807 
	`ôøns4x4_ls
(
cuºMB
, 
uv
, *
x_pos
 , *
y_pos
 );

810 
	`c›y_image_d©a
(
curUV
, 
mb_ªc
, 
cuºMB
->
pix_c_x
, 0, 
p_Vid
->
mb_size
[1][0],Ö_Vid->mb_size[1][1]);

812 
cuºSli˚
->
is_ª£t_c€ff_¸
 = 
FALSE
;

814 i‡(
smb
)

816 
cuºMB
->
ôøns_4x4
 = (cuºMB->
is_los¶ess
 =
FALSE
Ë? 
ôøns4x4
 : 
ôøns4x4_ls
;

817 
	`ôøns_•_¸
(
cuºMB
, 
uv
 - 1);

819 
joff
 = 0; jof‡< 
p_Vid
->
mb_¸_size_y
; jof‡+
BLOCK_SIZE
)

821 
ioff
 = 0; iof‡< 
p_Vid
->
mb_¸_size_x
 ;iof‡+
BLOCK_SIZE
)

823 
cuºMB
->
	`ôøns_4x4
(cuºMB, 
uv
, 
ioff
, 
joff
);

827 
	`c›y_image_d©a
(
curUV
, 
mb_ªc
, 
cuºMB
->
pix_c_x
, 0, 
p_Vid
->
mb_size
[1][0],Ö_Vid->mb_size[1][1]);

828 
cuºSli˚
->
is_ª£t_c€ff_¸
 = 
FALSE
;

832 
	`c›y_image_d©a
(
curUV
, 
cuºSli˚
->
mb_¥ed
[
uv
], 
cuºMB
->
pix_c_x
, 0, 
p_Vid
->
mb_size
[1][0],Ö_Vid->mb_size[1][1]);

836 
	}
}

844 
	$c›y_image_d©a_16x16
(
img≥l
 **
imgBuf1
, img≥»**
imgBuf2
, 
off1
, 
off2
)

846 
j
;

847 
j
 = 0; j < 
MB_BLOCK_SIZE
; j += 4)

849 
	`mem˝y
((*
imgBuf1
++ + 
off1
), (*
imgBuf2
++ + 
off2
), 
MB_BLOCK_SIZE
 *  (
img≥l
));

850 
	`mem˝y
((*
imgBuf1
++ + 
off1
), (*
imgBuf2
++ + 
off2
), 
MB_BLOCK_SIZE
 *  (
img≥l
));

851 
	`mem˝y
((*
imgBuf1
++ + 
off1
), (*
imgBuf2
++ + 
off2
), 
MB_BLOCK_SIZE
 *  (
img≥l
));

852 
	`mem˝y
((*
imgBuf1
++ + 
off1
), (*
imgBuf2
++ + 
off2
), 
MB_BLOCK_SIZE
 *  (
img≥l
));

854 
	}
}

862 
	$c›y_image_d©a_8x8
(
img≥l
 **
imgBuf1
, img≥»**
imgBuf2
, 
off1
, 
off2
)

864 
j
;

865 
j
 = 0; j < 
BLOCK_SIZE_8x8
; j+=4)

867 
	`mem˝y
((*
imgBuf1
++ + 
off1
), (*
imgBuf2
++ + 
off2
), 
BLOCK_SIZE_8x8
 *  (
img≥l
));

868 
	`mem˝y
((*
imgBuf1
++ + 
off1
), (*
imgBuf2
++ + 
off2
), 
BLOCK_SIZE_8x8
 *  (
img≥l
));

869 
	`mem˝y
((*
imgBuf1
++ + 
off1
), (*
imgBuf2
++ + 
off2
), 
BLOCK_SIZE_8x8
 *  (
img≥l
));

870 
	`mem˝y
((*
imgBuf1
++ + 
off1
), (*
imgBuf2
++ + 
off2
), 
BLOCK_SIZE_8x8
 *  (
img≥l
));

872 
	}
}

881 
	$c›y_image_d©a_4x4
(
img≥l
 **
imgBuf1
, img≥»**
imgBuf2
, 
off1
, 
off2
)

883 
	`mem˝y
((*
imgBuf1
++ + 
off1
), (*
imgBuf2
++ + 
off2
), 
BLOCK_SIZE
 *  (
img≥l
));

884 
	`mem˝y
((*
imgBuf1
++ + 
off1
), (*
imgBuf2
++ + 
off2
), 
BLOCK_SIZE
 *  (
img≥l
));

885 
	`mem˝y
((*
imgBuf1
++ + 
off1
), (*
imgBuf2
++ + 
off2
), 
BLOCK_SIZE
 *  (
img≥l
));

886 
	`mem˝y
((*
imgBuf1
 + 
off1
), (*
imgBuf2
 + 
off2
), 
BLOCK_SIZE
 *  (
img≥l
));

887 
	}
}

889 
	$CheckVîtMV
(
Ma¸oblock
 *
cuºMB
, 
vec1_y
, 
block_size_y
)

891 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

892 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
cuºMB
->
p_Sli˚
->dec_picture;

893 
y_pos
 = 
vec1_y
>>2;

894 
maxﬁd_y
 = (
cuºMB
->
mb_fõld
Ë? (
dec_pi˘uª
->
size_y
 >> 1Ë- 1 : dec_pi˘uª->
size_y_m1
;

896 if(
y_pos
 < (-
p_Vid
->
iLumaPadY
 + 2Ë|| y_po†> (
maxﬁd_y
 +Ö_Vid->iLumaPadY - 
block_size_y
 - 2))

900 
	}
}

909 
	$c›y_image_d©a
(
img≥l
 **
imgBuf1
, img≥»**
imgBuf2
, 
off1
, 
off2
, 
width
, 
height
)

911 
j
;

912 
j
 = 0; j < 
height
; ++j)

914 
	`mem˝y
((*
imgBuf1
++ + 
off1
), (*
imgBuf2
++ + 
off2
), 
width
 *  (
img≥l
));

916 
	}
}

	@ldecod/src/cabac.c

14 
	~"globÆ.h
"

15 
	~"ˇbac.h
"

16 
	~"memÆloc.h
"

17 
	~"ñemíts.h
"

18 
	~"image.h
"

19 
	~"büridecod.h
"

20 
	~"mb_ac˚ss.h
"

21 
	~"vlc.h
"

23 #i‡
TRACE


24 
	gsymbﬁCou¡
 = 0;

27 c⁄° 
	gmaxpos
 [] = {15, 14, 63, 31, 31, 15, 3, 14, 7, 15, 15, 14, 63, 31, 31, 15, 15, 14, 63, 31, 31, 15};

28 c⁄° 
	gc1isdc
 [] = { 1, 0, 1, 1, 1, 1, 1, 0, 1, 1, 1, 0, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1};

29 c⁄° 
	gty≥2˘x_bcbp
[] = { 0, 1, 2, 3, 3, 4, 5, 6, 5, 5, 10, 11, 12, 13, 13, 14, 16, 17, 18, 19, 19, 20};

30 c⁄° 
	gty≥2˘x_m≠
 [] = { 0, 1, 2, 3, 4, 5, 6, 7, 6, 6, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21};

31 c⁄° 
	gty≥2˘x_œ°
[] = { 0, 1, 2, 3, 4, 5, 6, 7, 6, 6, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21};

32 c⁄° 
	gty≥2˘x_⁄e
 [] = { 0, 1, 2, 3, 3, 4, 5, 6, 5, 5, 10, 11, 12, 13, 13, 14, 16, 17, 18, 19, 19, 20};

33 c⁄° 
	gty≥2˘x_abs
 [] = { 0, 1, 2, 3, 3, 4, 5, 6, 5, 5, 10, 11, 12, 13, 13, 14, 16, 17, 18, 19, 19, 20};

34 c⁄° 
	gmax_c2
 [] = { 4, 4, 4, 4, 4, 4, 3, 4, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4};

40 
u«ry_bö_decode
 ( 
DecodögEnvú⁄mítPå
 
dï_dp
, 
BiC⁄ãxtTy≥På
 
˘x
, 
˘x_off£t
);

41 
u«ry_bö_max_decode
 ( 
DecodögEnvú⁄mítPå
 
dï_dp
, 
BiC⁄ãxtTy≥På
 
˘x
, 
˘x_off£t
, 
max_symbﬁ
);

42 
u«ry_exp_gﬁomb_Àvñ_decode
–
DecodögEnvú⁄mítPå
 
dï_dp
, 
BiC⁄ãxtTy≥På
 
˘x
);

43 
u«ry_exp_gﬁomb_mv_decode
 ( 
DecodögEnvú⁄mítPå
 
dï_dp
, 
BiC⁄ãxtTy≥På
 
˘x
, 
max_bö
);

45 
	$CheckAvaûabûôyOfNeighb‹sCABAC
(
Ma¸oblock
 *
cuºMB
)

47 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

48 
PixñPos
 
up
, 
À·
;

49 *
mb_size
 = 
p_Vid
->mb_size[
IS_LUMA
];

51 
p_Vid
->
	`gëNeighbour
(
cuºMB
, -1, 0, 
mb_size
, &
À·
);

52 
p_Vid
->
	`gëNeighbour
(
cuºMB
, 0, -1, 
mb_size
, &
up
);

54 i‡(
up
.
avaûabÀ
)

55 
cuºMB
->
mb_up
 = &cuºMB->
p_Sli˚
->
mb_d©a
[
up
.
mb_addr
];

57 
cuºMB
->
mb_up
 = 
NULL
;

59 i‡(
À·
.
avaûabÀ
)

60 
cuºMB
->
mb_À·
 = &cuºMB->
p_Sli˚
->
mb_d©a
[
À·
.
mb_addr
];

62 
cuºMB
->
mb_À·
 = 
NULL
;

63 
	}
}

65 
	$ˇbac_√w_¶i˚
(
Sli˚
 *
cuºSli˚
)

67 
cuºSli˚
->
œ°_dqu™t
 = 0;

68 
	}
}

78 
MŸi⁄InfoC⁄ãxts
* 
	$¸óã_c⁄ãxts_MŸi⁄Info
()

80 
MŸi⁄InfoC⁄ãxts
 *
deco_˘x
;

82 
deco_˘x
 = (
MŸi⁄InfoC⁄ãxts
*Ë
	`ˇŒoc
(1, (MotionInfoContexts) );

83 if–
deco_˘x
 =
NULL
 )

84 
	`no_mem_exô
("create_contexts_MotionInfo: deco_ctx");

86  
deco_˘x
;

87 
	}
}

97 
TextuªInfoC⁄ãxts
* 
	$¸óã_c⁄ãxts_TextuªInfo
()

99 
TextuªInfoC⁄ãxts
 *
deco_˘x
;

101 
deco_˘x
 = (
TextuªInfoC⁄ãxts
*Ë
	`ˇŒoc
(1, (TextureInfoContexts) );

102 if–
deco_˘x
 =
NULL
 )

103 
	`no_mem_exô
("create_contexts_TextureInfo: deco_ctx");

105  
deco_˘x
;

106 
	}
}

116 
	$dñëe_c⁄ãxts_MŸi⁄Info
(
MŸi⁄InfoC⁄ãxts
 *
deco_˘x
)

118 if–
deco_˘x
 =
NULL
 )

121 
	`‰ì
–
deco_˘x
 );

122 
	}
}

132 
	$dñëe_c⁄ãxts_TextuªInfo
(
TextuªInfoC⁄ãxts
 *
deco_˘x
)

134 if–
deco_˘x
 =
NULL
 )

137 
	`‰ì
–
deco_˘x
 );

138 
	}
}

140 
	$ªadFõldModeInfo_CABAC
(
Ma¸oblock
 *
cuºMB
,

141 
Sy¡axEÀmít
 *
£
,

142 
DecodögEnvú⁄mítPå
 
dï_dp
)

144 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

146 
MŸi⁄InfoC⁄ãxts
 *
˘x
 = 
cuºSli˚
->
mŸ_˘x
;

147 
a
 = 
cuºMB
->
mbAvaûA
 ? 
cuºSli˚
->
mb_d©a
[cuºMB->
mbAddrA
].
mb_fõld
 : 0;

148 
b
 = 
cuºMB
->
mbAvaûB
 ? 
cuºSli˚
->
mb_d©a
[cuºMB->
mbAddrB
].
mb_fõld
 : 0;

149 
a˘_˘x
 = 
a
 + 
b
;

151 
£
->
vÆue1
 = 
	`büri_decode_symbﬁ
 (
dï_dp
, &
˘x
->
mb_aff_c⁄ãxts
[
a˘_˘x
]);

153 #i‡
TRACE


154 
	`Ârötf
(
p_Dec
->
p_åa˚
, "@%-6d %-63†(%3d)\n",
symbﬁCou¡
++, 
£
->
åa˚°rög
, se->
vÆue1
);

155 
	`fÊush
(
p_Dec
->
p_åa˚
);

157 
	}
}

160 
	$check_√xt_mb_™d_gë_fõld_mode_CABAC_p_¶i˚
–
Sli˚
 *
cuºSli˚
,

161 
Sy¡axEÀmít
 *
£
,

162 
D©aP¨tôi⁄
 *
a˘_dp
)

164 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

165 
BiC⁄ãxtTy≥På
 
mb_ty≥_˘x_c›y
[3];

166 
BiC⁄ãxtTy≥På
 
mb_aff_˘x_c›y
;

167 
DecodögEnvú⁄mítPå
 
dï_dp_c›y
;

168 
MŸi⁄InfoC⁄ãxts
 *
mŸ_˘x
 = 
cuºSli˚
->mot_ctx;

170 
Àngth
;

171 
DecodögEnvú⁄mítPå
 
dï_dp
 = &(
a˘_dp
->
de_ˇbac
);

173 
skù
 = 0;

174 
fõld
 = 0;

175 
i
;

177 
Ma¸oblock
 *
cuºMB
;

180 ++
cuºSli˚
->
cuºít_mb_ƒ
;

182 
cuºMB
 = &
cuºSli˚
->
mb_d©a
[cuºSli˚->
cuºít_mb_ƒ
];

183 
cuºMB
->
p_Vid
 =Ö_Vid;

184 
cuºMB
->
p_Sli˚
 = 
cuºSli˚
;

185 
cuºMB
->
¶i˚_ƒ
 = 
cuºSli˚
->
cuºít_¶i˚_ƒ
;

186 
cuºMB
->
mb_fõld
 = 
cuºSli˚
->
mb_d©a
[cuºSli˚->
cuºít_mb_ƒ
-1].mb_field;

187 
cuºMB
->
mbAddrX
 = 
cuºSli˚
->
cuºít_mb_ƒ
;

188 
cuºMB
->
li°_off£t
 = ((
cuºSli˚
->
mb_aff_‰ame_Êag
)&&(cuºMB->
mb_fõld
))? (cuºMB->
mbAddrX
&0x01) ? 4 : 2 : 0;

190 
	`CheckAvaûabûôyOfNeighb‹sMBAFF
(
cuºMB
);

191 
	`CheckAvaûabûôyOfNeighb‹sCABAC
(
cuºMB
);

194 
dï_dp_c›y
 = (
DecodögEnvú⁄mítPå
Ë
	`ˇŒoc
(1, (
DecodögEnvú⁄mít
) );

195 
i
=0;i<3;++i)

196 
mb_ty≥_˘x_c›y
[
i
] = (
BiC⁄ãxtTy≥På
Ë
	`ˇŒoc
(
NUM_MB_TYPE_CTX
, (
BiC⁄ãxtTy≥
) );

197 
mb_aff_˘x_c›y
 = (
BiC⁄ãxtTy≥På
Ë
	`ˇŒoc
(
NUM_MB_AFF_CTX
, (
BiC⁄ãxtTy≥
) );

200 
	`mem˝y
(
dï_dp_c›y
,
dï_dp
,(
DecodögEnvú⁄mít
));

201 
Àngth
 = *(
dï_dp_c›y
->
Dcode°rm_Àn
Ë*(
dï_dp
->Dcodestrm_len);

202 
i
=0;i<3;++i)

203 
	`mem˝y
(
mb_ty≥_˘x_c›y
[
i
], 
mŸ_˘x
->
mb_ty≥_c⁄ãxts
[i],
NUM_MB_TYPE_CTX
*(
BiC⁄ãxtTy≥
) );

204 
	`mem˝y
(
mb_aff_˘x_c›y
, 
mŸ_˘x
->
mb_aff_c⁄ãxts
,
NUM_MB_AFF_CTX
*(
BiC⁄ãxtTy≥
) );

207 #i‡
TRACE


208 
	`°∫˝y
(
£
->
åa˚°rög
, "mb_skù_Êag (o‡fﬁlowög bŸtom MB)", 
TRACESTRING_SIZE
);

210 
cuºSli˚
->
œ°_dqu™t
 = 0;

211 
	`ªad_skù_Êag_CABAC_p_¶i˚
(
cuºMB
, 
£
, 
dï_dp
);

213 
skù
 = (
£
->
vÆue1
==0);

215 i‡(!
skù
)

217 #i‡
TRACE


218 
	`°∫˝y
(
£
->
åa˚°rög
, "mb_fõld_decodög_Êag (o‡fﬁlowög bŸtom MB)", 
TRACESTRING_SIZE
);

220 
	`ªadFõldModeInfo_CABAC
–
cuºMB
, 
£
,
dï_dp
);

221 
fõld
 = 
£
->
vÆue1
;

222 
cuºSli˚
->
mb_d©a
[cuºSli˚->
cuºít_mb_ƒ
-1].
mb_fõld
 = 
fõld
;

226 
cuºSli˚
->
cuºít_mb_ƒ
--;

228 
	`mem˝y
(
dï_dp
,
dï_dp_c›y
,(
DecodögEnvú⁄mít
));

229 *(
dï_dp
->
Dcode°rm_Àn
Ë
Àngth
;

230 
i
=0;i<3;++i)

231 
	`mem˝y
(
mŸ_˘x
->
mb_ty≥_c⁄ãxts
[
i
],
mb_ty≥_˘x_c›y
[i], 
NUM_MB_TYPE_CTX
*(
BiC⁄ãxtTy≥
) );

232 
	`mem˝y
–
mŸ_˘x
->
mb_aff_c⁄ãxts
,
mb_aff_˘x_c›y
,
NUM_MB_AFF_CTX
*(
BiC⁄ãxtTy≥
) );

234 
	`CheckAvaûabûôyOfNeighb‹sCABAC
(
cuºMB
);

237 
	`‰ì
(
dï_dp_c›y
);

238 
i
=0;i<3;++i)

239 
	`‰ì
(
mb_ty≥_˘x_c›y
[
i
]);

240 
	`‰ì
(
mb_aff_˘x_c›y
);

242  
skù
;

243 
	}
}

245 
	$check_√xt_mb_™d_gë_fõld_mode_CABAC_b_¶i˚
–
Sli˚
 *
cuºSli˚
,

246 
Sy¡axEÀmít
 *
£
,

247 
D©aP¨tôi⁄
 *
a˘_dp
)

249 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

250 
BiC⁄ãxtTy≥På
 
mb_ty≥_˘x_c›y
[3];

251 
BiC⁄ãxtTy≥På
 
mb_aff_˘x_c›y
;

252 
DecodögEnvú⁄mítPå
 
dï_dp_c›y
;

254 
Àngth
;

255 
DecodögEnvú⁄mítPå
 
dï_dp
 = &(
a˘_dp
->
de_ˇbac
);

256 
MŸi⁄InfoC⁄ãxts
 *
mŸ_˘x
 = 
cuºSli˚
->mot_ctx;

258 
skù
 = 0;

259 
fõld
 = 0;

260 
i
;

262 
Ma¸oblock
 *
cuºMB
;

265 ++
cuºSli˚
->
cuºít_mb_ƒ
;

267 
cuºMB
 = &
cuºSli˚
->
mb_d©a
[cuºSli˚->
cuºít_mb_ƒ
];

268 
cuºMB
->
p_Vid
 =Ö_Vid;

269 
cuºMB
->
p_Sli˚
 = 
cuºSli˚
;

270 
cuºMB
->
¶i˚_ƒ
 = 
cuºSli˚
->
cuºít_¶i˚_ƒ
;

271 
cuºMB
->
mb_fõld
 = 
cuºSli˚
->
mb_d©a
[cuºSli˚->
cuºít_mb_ƒ
-1].mb_field;

272 
cuºMB
->
mbAddrX
 = 
cuºSli˚
->
cuºít_mb_ƒ
;

273 
cuºMB
->
li°_off£t
 = ((
cuºSli˚
->
mb_aff_‰ame_Êag
)&&(cuºMB->
mb_fõld
))? (cuºMB->
mbAddrX
 & 0x01) ? 4 : 2 : 0;

275 
	`CheckAvaûabûôyOfNeighb‹sMBAFF
(
cuºMB
);

276 
	`CheckAvaûabûôyOfNeighb‹sCABAC
(
cuºMB
);

279 
dï_dp_c›y
 = (
DecodögEnvú⁄mítPå
Ë
	`ˇŒoc
(1, (
DecodögEnvú⁄mít
) );

280 
i
=0;i<3;++i)

281 
mb_ty≥_˘x_c›y
[
i
] = (
BiC⁄ãxtTy≥På
Ë
	`ˇŒoc
(
NUM_MB_TYPE_CTX
, (
BiC⁄ãxtTy≥
) );

282 
mb_aff_˘x_c›y
 = (
BiC⁄ãxtTy≥På
Ë
	`ˇŒoc
(
NUM_MB_AFF_CTX
, (
BiC⁄ãxtTy≥
) );

285 
	`mem˝y
(
dï_dp_c›y
,
dï_dp
,(
DecodögEnvú⁄mít
));

286 
Àngth
 = *(
dï_dp_c›y
->
Dcode°rm_Àn
Ë*(
dï_dp
->Dcodestrm_len);

288 
i
=0;i<3;++i)

289 
	`mem˝y
(
mb_ty≥_˘x_c›y
[
i
], 
mŸ_˘x
->
mb_ty≥_c⁄ãxts
[i],
NUM_MB_TYPE_CTX
*(
BiC⁄ãxtTy≥
) );

291 
	`mem˝y
(
mb_aff_˘x_c›y
, 
mŸ_˘x
->
mb_aff_c⁄ãxts
,
NUM_MB_AFF_CTX
*(
BiC⁄ãxtTy≥
) );

294 #i‡
TRACE


295 
	`°∫˝y
(
£
->
åa˚°rög
, "mb_skù_Êag (o‡fﬁlowög bŸtom MB)", 
TRACESTRING_SIZE
);

297 
cuºSli˚
->
œ°_dqu™t
 = 0;

298 
	`ªad_skù_Êag_CABAC_b_¶i˚
(
cuºMB
, 
£
, 
dï_dp
);

300 
skù
 = (
£
->
vÆue1
==0 && se->
vÆue2
==0);

301 i‡(!
skù
)

303 #i‡
TRACE


304 
	`°∫˝y
(
£
->
åa˚°rög
, "mb_fõld_decodög_Êag (o‡fﬁlowög bŸtom MB)", 
TRACESTRING_SIZE
);

306 
	`ªadFõldModeInfo_CABAC
–
cuºMB
, 
£
,
dï_dp
);

307 
fõld
 = 
£
->
vÆue1
;

308 
cuºSli˚
->
mb_d©a
[cuºSli˚->
cuºít_mb_ƒ
-1].
mb_fõld
 = 
fõld
;

312 
cuºSli˚
->
cuºít_mb_ƒ
--;

314 
	`mem˝y
(
dï_dp
,
dï_dp_c›y
,(
DecodögEnvú⁄mít
));

315 *(
dï_dp
->
Dcode°rm_Àn
Ë
Àngth
;

317 
i
=0;i<3;++i)

318 
	`mem˝y
(
mŸ_˘x
->
mb_ty≥_c⁄ãxts
[
i
],
mb_ty≥_˘x_c›y
[i], 
NUM_MB_TYPE_CTX
 * (
BiC⁄ãxtTy≥
) );

320 
	`mem˝y
–
mŸ_˘x
->
mb_aff_c⁄ãxts
, 
mb_aff_˘x_c›y
, 
NUM_MB_AFF_CTX
 * (
BiC⁄ãxtTy≥
) );

322 
	`CheckAvaûabûôyOfNeighb‹sCABAC
(
cuºMB
);

325 
	`‰ì
(
dï_dp_c›y
);

326 
i
=0;i<3;++i)

327 
	`‰ì
(
mb_ty≥_˘x_c›y
[
i
]);

328 
	`‰ì
(
mb_aff_˘x_c›y
);

330  
skù
;

331 
	}
}

340 
	$ªad_MVD_CABAC
–
Ma¸oblock
 *
cuºMB
,

341 
Sy¡axEÀmít
 *
£
,

342 
DecodögEnvú⁄mítPå
 
dï_dp
)

344 *
mb_size
 = 
cuºMB
->
p_Vid
->mb_size[
IS_LUMA
];

345 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

346 
MŸi⁄InfoC⁄ãxts
 *
˘x
 = 
cuºSli˚
->
mŸ_˘x
;

347 
i
 = 
cuºMB
->
subblock_x
;

348 
j
 = 
cuºMB
->
subblock_y
;

349 
a
 = 0;

351 
a˘_sym
;

352 
li°_idx
 = 
£
->
vÆue2
 & 0x01;

353 
k
 = (
£
->
vÆue2
 >> 1);

355 
PixñPos
 
block_a
, 
block_b
;

357 
	`gë4x4NeighbourBa£
(
cuºMB
, 
i
 - 1, 
j
 , 
mb_size
, &
block_a
);

358 
	`gë4x4NeighbourBa£
(
cuºMB
, 
i
 , 
j
 - 1, 
mb_size
, &
block_b
);

359 i‡(
block_a
.
avaûabÀ
)

361 
a
 = 
	`übs
(
cuºSli˚
->
mb_d©a
[
block_a
.
mb_addr
].
mvd
[
li°_idx
][block_a.
y
][block_a.
x
][
k
]);

363 i‡(
block_b
.
avaûabÀ
)

365 
a
 +
	`übs
(
cuºSli˚
->
mb_d©a
[
block_b
.
mb_addr
].
mvd
[
li°_idx
][block_b.
y
][block_b.
x
][
k
]);

370 i‡(
a
 < 3)

371 
a
 = 5 * 
k
;

372 i‡(
a
 > 32)

373 
a
 = 5 * 
k
 + 3;

375 
a
 = 5 * 
k
 + 2;

377 
£
->
c⁄ãxt
 = 
a
;

379 
a˘_sym
 = 
	`büri_decode_symbﬁ
(
dï_dp
, 
˘x
->
mv_ªs_c⁄ãxts
[0] + 
a
 );

381 i‡(
a˘_sym
 != 0)

383 
a
 = 5 * 
k
;

384 
a˘_sym
 = 
	`u«ry_exp_gﬁomb_mv_decode
(
dï_dp
, 
˘x
->
mv_ªs_c⁄ãxts
[1] + 
a
, 3) + 1;

386 if(
	`büri_decode_symbﬁ_eq_¥ob
(
dï_dp
))

387 
a˘_sym
 = -act_sym;

389 
£
->
vÆue1
 = 
a˘_sym
;

391 #i‡
TRACE


392 
	`Ârötf
(
p_Dec
->
p_åa˚
, "@%-6d %-63†(%3d)\n",
symbﬁCou¡
++, 
£
->
åa˚°rög
, se->
vÆue1
);

393 
	`fÊush
(
p_Dec
->
p_åa˚
);

395 
	}
}

405 
	$ªad_mvd_CABAC_mbaff
–
Ma¸oblock
 *
cuºMB
,

406 
Sy¡axEÀmít
 *
£
,

407 
DecodögEnvú⁄mítPå
 
dï_dp
)

409 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

410 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

411 
MŸi⁄InfoC⁄ãxts
 *
˘x
 = 
cuºSli˚
->
mŸ_˘x
;

412 
i
 = 
cuºMB
->
subblock_x
;

413 
j
 = 
cuºMB
->
subblock_y
;

414 
a
 = 0, 
b
 = 0;

415 
a˘_˘x
;

416 
a˘_sym
;

417 
li°_idx
 = 
£
->
vÆue2
 & 0x01;

418 
k
 = (
£
->
vÆue2
 >> 1);

420 
PixñPos
 
block_a
, 
block_b
;

422 
	`gë4x4NeighbourBa£
(
cuºMB
, 
i
 - 1, 
j
 , 
p_Vid
->
mb_size
[
IS_LUMA
], &
block_a
);

423 i‡(
block_a
.
avaûabÀ
)

425 
a
 = 
	`übs
(
cuºSli˚
->
mb_d©a
[
block_a
.
mb_addr
].
mvd
[
li°_idx
][block_a.
y
][block_a.
x
][
k
]);

426 i‡(
cuºSli˚
->
mb_aff_‰ame_Êag
 && (
k
==1))

428 i‡((
cuºMB
->
mb_fõld
==0Ë&& (
cuºSli˚
->
mb_d©a
[
block_a
.
mb_addr
].mb_field==1))

429 
a
 *= 2;

430 i‡((
cuºMB
->
mb_fõld
==1Ë&& (
cuºSli˚
->
mb_d©a
[
block_a
.
mb_addr
].mb_field==0))

431 
a
 /= 2;

435 
	`gë4x4NeighbourBa£
(
cuºMB
, 
i
 , 
j
 - 1, 
p_Vid
->
mb_size
[
IS_LUMA
], &
block_b
);

436 i‡(
block_b
.
avaûabÀ
)

438 
b
 = 
	`übs
(
cuºSli˚
->
mb_d©a
[
block_b
.
mb_addr
].
mvd
[
li°_idx
][block_b.
y
][block_b.
x
][
k
]);

439 i‡(
cuºSli˚
->
mb_aff_‰ame_Êag
 && (
k
==1))

441 i‡((
cuºMB
->
mb_fõld
==0Ë&& (
cuºSli˚
->
mb_d©a
[
block_b
.
mb_addr
].mb_field==1))

442 
b
 *= 2;

443 i‡((
cuºMB
->
mb_fõld
==1Ë&& (
cuºSli˚
->
mb_d©a
[
block_b
.
mb_addr
].mb_field==0))

444 
b
 /= 2;

447 
a
 +
b
;

449 i‡(
a
 < 3)

450 
a˘_˘x
 = 5 * 
k
;

451 i‡(
a
 > 32)

452 
a˘_˘x
 = 5 * 
k
 + 3;

454 
a˘_˘x
 = 5 * 
k
 + 2;

456 
£
->
c⁄ãxt
 = 
a˘_˘x
;

458 
a˘_sym
 = 
	`büri_decode_symbﬁ
(
dï_dp
,&
˘x
->
mv_ªs_c⁄ãxts
[0][
a˘_˘x
] );

460 i‡(
a˘_sym
 != 0)

462 
a˘_˘x
 = 5 * 
k
;

463 
a˘_sym
 = 
	`u«ry_exp_gﬁomb_mv_decode
(
dï_dp
, 
˘x
->
mv_ªs_c⁄ãxts
[1] + 
a˘_˘x
, 3) + 1;

465 if(
	`büri_decode_symbﬁ_eq_¥ob
(
dï_dp
))

466 
a˘_sym
 = -act_sym;

468 
£
->
vÆue1
 = 
a˘_sym
;

470 #i‡
TRACE


471 
	`Ârötf
(
p_Dec
->
p_åa˚
, "@%-6d %-63†(%3d)\n",
symbﬁCou¡
++, 
£
->
åa˚°rög
, se->
vÆue1
);

472 
	`fÊush
(
p_Dec
->
p_åa˚
);

474 
	}
}

483 
	$ªadB8_ty≥Info_CABAC_p_¶i˚
 (
Ma¸oblock
 *
cuºMB
,

484 
Sy¡axEÀmít
 *
£
,

485 
DecodögEnvú⁄mítPå
 
dï_dp
)

487 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

488 
a˘_sym
 = 0;

490 
MŸi⁄InfoC⁄ãxts
 *
˘x
 = 
cuºSli˚
->
mŸ_˘x
;

491 
BiC⁄ãxtTy≥
 *
b8_ty≥_c⁄ãxts
 = &
˘x
->b8_type_contexts[0][1];

493 i‡(
	`büri_decode_symbﬁ
 (
dï_dp
, 
b8_ty≥_c⁄ãxts
++))

494 
a˘_sym
 = 0;

497 i‡(
	`büri_decode_symbﬁ
 (
dï_dp
, ++
b8_ty≥_c⁄ãxts
))

499 
a˘_sym
 = (
	`büri_decode_symbﬁ
 (
dï_dp
, ++
b8_ty≥_c⁄ãxts
))? 2: 3;

503 
a˘_sym
 = 1;

507 
£
->
vÆue1
 = 
a˘_sym
;

509 #i‡
TRACE


510 
	`Ârötf
(
p_Dec
->
p_åa˚
, "@%-6d %-63†(%3d)\n",
symbﬁCou¡
++, 
£
->
åa˚°rög
, se->
vÆue1
);

511 
	`fÊush
(
p_Dec
->
p_åa˚
);

513 
	}
}

522 
	$ªadB8_ty≥Info_CABAC_b_¶i˚
 (
Ma¸oblock
 *
cuºMB
,

523 
Sy¡axEÀmít
 *
£
,

524 
DecodögEnvú⁄mítPå
 
dï_dp
)

526 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

527 
a˘_sym
 = 0;

529 
MŸi⁄InfoC⁄ãxts
 *
˘x
 = 
cuºSli˚
->
mŸ_˘x
;

530 
BiC⁄ãxtTy≥
 *
b8_ty≥_c⁄ãxts
 = 
˘x
->b8_type_contexts[1];

532 i‡(
	`büri_decode_symbﬁ
 (
dï_dp
, 
b8_ty≥_c⁄ãxts
++))

534 i‡(
	`büri_decode_symbﬁ
 (
dï_dp
, 
b8_ty≥_c⁄ãxts
++))

536 i‡(
	`büri_decode_symbﬁ
 (
dï_dp
, 
b8_ty≥_c⁄ãxts
++))

538 i‡(
	`büri_decode_symbﬁ
 (
dï_dp
, 
b8_ty≥_c⁄ãxts
))

540 
a˘_sym
 = 10;

541 i‡(
	`büri_decode_symbﬁ
 (
dï_dp
, 
b8_ty≥_c⁄ãxts
))

542 
a˘_sym
++;

546 
a˘_sym
 = 6;

547 i‡(
	`büri_decode_symbﬁ
 (
dï_dp
, 
b8_ty≥_c⁄ãxts
))

548 
a˘_sym
 += 2;

549 i‡(
	`büri_decode_symbﬁ
 (
dï_dp
, 
b8_ty≥_c⁄ãxts
))

550 
a˘_sym
++;

555 
a˘_sym
 = 2;

556 i‡(
	`büri_decode_symbﬁ
 (
dï_dp
, 
b8_ty≥_c⁄ãxts
))

557 
a˘_sym
 += 2;

558 i‡(
	`büri_decode_symbﬁ
 (
dï_dp
, 
b8_ty≥_c⁄ãxts
))

559 
a˘_sym
 ++;

564 
a˘_sym
 = (
	`büri_decode_symbﬁ
 (
dï_dp
, ++
b8_ty≥_c⁄ãxts
)) ? 1: 0;

566 ++
a˘_sym
;

570 
a˘_sym
 = 0;

573 
£
->
vÆue1
 = 
a˘_sym
;

575 #i‡
TRACE


576 
	`Ârötf
(
p_Dec
->
p_åa˚
, "@%-6d %-63†(%3d)\n",
symbﬁCou¡
++, 
£
->
åa˚°rög
, se->
vÆue1
);

577 
	`fÊush
(
p_Dec
->
p_åa˚
);

579 
	}
}

588 
	$ªad_skù_Êag_CABAC_p_¶i˚
–
Ma¸oblock
 *
cuºMB
,

589 
Sy¡axEÀmít
 *
£
,

590 
DecodögEnvú⁄mítPå
 
dï_dp
)

592 
a
 = (
cuºMB
->
mb_À·
 !
NULL
Ë? (cuºMB->mb_À·->
skù_Êag
 == 0) : 0;

593 
b
 = (
cuºMB
->
mb_up
 !
NULL
Ë? (cuºMB->mb_u∞->
skù_Êag
 == 0) : 0;

594 
BiC⁄ãxtTy≥
 *
mb_ty≥_c⁄ãxts
 = &
cuºMB
->
p_Sli˚
->
mŸ_˘x
->mb_ty≥_c⁄ãxts[1][
a
 + 
b
];

596 
£
->
vÆue1
 = (
	`büri_decode_symbﬁ
(
dï_dp
, 
mb_ty≥_c⁄ãxts
) != 1);

598 #i‡
TRACE


599 
	`Ârötf
(
p_Dec
->
p_åa˚
, "@%-6d %-63†(%3d)\n",
symbﬁCou¡
++, 
£
->
åa˚°rög
, se->
vÆue1
);

600 
	`fÊush
(
p_Dec
->
p_åa˚
);

602 i‡(!
£
->
vÆue1
)

604 
cuºMB
->
p_Sli˚
->
œ°_dqu™t
 = 0;

606 
	}
}

615 
	$ªad_skù_Êag_CABAC_b_¶i˚
–
Ma¸oblock
 *
cuºMB
,

616 
Sy¡axEÀmít
 *
£
,

617 
DecodögEnvú⁄mítPå
 
dï_dp
)

619 
a
 = (
cuºMB
->
mb_À·
 !
NULL
Ë? (cuºMB->mb_À·->
skù_Êag
 == 0) : 0;

620 
b
 = (
cuºMB
->
mb_up
 !
NULL
Ë? (cuºMB->mb_u∞->
skù_Êag
 == 0) : 0;

621 
BiC⁄ãxtTy≥
 *
mb_ty≥_c⁄ãxts
 = &
cuºMB
->
p_Sli˚
->
mŸ_˘x
->mb_ty≥_c⁄ãxts[2][7 + 
a
 + 
b
];

623 
£
->
vÆue1
 = se->
vÆue2
 = (
	`büri_decode_symbﬁ
 (
dï_dp
, 
mb_ty≥_c⁄ãxts
) != 1);

625 #i‡
TRACE


626 
	`Ârötf
(
p_Dec
->
p_åa˚
, "@%-6d %-63†(%3d)\n", 
symbﬁCou¡
++, 
£
->
åa˚°rög
, se->
vÆue1
);

627 
	`fÊush
(
p_Dec
->
p_åa˚
);

629 i‡(!
£
->
vÆue1
)

631 
cuºMB
->
p_Sli˚
->
œ°_dqu™t
 = 0;

633 
	}
}

643 
	$ªadMB_å™sf‹m_size_Êag_CABAC
–
Ma¸oblock
 *
cuºMB
,

644 
Sy¡axEÀmít
 *
£
,

645 
DecodögEnvú⁄mítPå
 
dï_dp
)

647 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

648 
TextuªInfoC⁄ãxts
*
˘x
 = 
cuºSli˚
->
ãx_˘x
;

650 
b
 = (
cuºMB
->
mb_up
 =
NULL
Ë? 0 : cuºMB->mb_up->
luma_å™sf‹m_size_8x8_Êag
;

651 
a
 = (
cuºMB
->
mb_À·
 =
NULL
Ë? 0 : cuºMB->mb_À·->
luma_å™sf‹m_size_8x8_Êag
;

653 
a˘_sym
 = 
	`büri_decode_symbﬁ
(
dï_dp
, 
˘x
->
å™sf‹m_size_c⁄ãxts
 + 
a
 + 
b
 );

655 
£
->
vÆue1
 = 
a˘_sym
;

657 #i‡
TRACE


658 
	`Ârötf
(
p_Dec
->
p_åa˚
, "@%-6d %-63†(%3d)\n",
symbﬁCou¡
++, 
£
->
åa˚°rög
, se->
vÆue1
);

659 
	`fÊush
(
p_Dec
->
p_åa˚
);

662 
	}
}

671 
	$ªadMB_ty≥Info_CABAC_i_¶i˚
(
Ma¸oblock
 *
cuºMB
,

672 
Sy¡axEÀmít
 *
£
,

673 
DecodögEnvú⁄mítPå
 
dï_dp
)

675 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

676 
MŸi⁄InfoC⁄ãxts
 *
˘x
 = 
cuºSli˚
->
mŸ_˘x
;

678 
a
 = 0, 
b
 = 0;

679 
a˘_˘x
;

680 
a˘_sym
;

681 
mode_sym
;

682 
cuº_mb_ty≥
 = 0;

684 if(
cuºSli˚
->
¶i˚_ty≥
 =
I_SLICE
)

686 i‡(
cuºMB
->
mb_up
 !
NULL
)

687 
b
 = (((
cuºMB
->
mb_up
)->
mb_ty≥
 !
I4MB
 && cuºMB->mb_up->mb_ty≥ !
I8MB
) ? 1 : 0 );

689 i‡(
cuºMB
->
mb_À·
 !
NULL
)

690 
a
 = (((
cuºMB
->
mb_À·
)->
mb_ty≥
 !
I4MB
 && cuºMB->mb_À·->mb_ty≥ !
I8MB
) ? 1 : 0 );

692 
a˘_˘x
 = 
a
 + 
b
;

693 
a˘_sym
 = 
	`büri_decode_symbﬁ
(
dï_dp
, 
˘x
->
mb_ty≥_c⁄ãxts
[0] + 
a˘_˘x
);

694 
£
->
c⁄ãxt
 = 
a˘_˘x
;

696 i‡(
a˘_sym
==0)

698 
cuº_mb_ty≥
 = 
a˘_sym
;

702 
mode_sym
 = 
	`büri_decode_föÆ
(
dï_dp
);

703 if(
mode_sym
 == 1)

705 
cuº_mb_ty≥
 = 25;

709 
a˘_sym
 = 1;

710 
a˘_˘x
 = 4;

711 
mode_sym
 = 
	`büri_decode_symbﬁ
(
dï_dp
, 
˘x
->
mb_ty≥_c⁄ãxts
[0] + 
a˘_˘x
 );

712 
a˘_sym
 +
mode_sym
*12;

713 
a˘_˘x
 = 5;

715 
mode_sym
 = 
	`büri_decode_symbﬁ
(
dï_dp
, 
˘x
->
mb_ty≥_c⁄ãxts
[0] + 
a˘_˘x
 );

716 i‡(
mode_sym
!=0)

718 
a˘_˘x
=6;

719 
mode_sym
 = 
	`büri_decode_symbﬁ
(
dï_dp
, 
˘x
->
mb_ty≥_c⁄ãxts
[0] + 
a˘_˘x
 );

720 
a˘_sym
+=4;

721 i‡(
mode_sym
!=0)

722 
a˘_sym
+=4;

725 
a˘_˘x
 = 7;

726 
mode_sym
 = 
	`büri_decode_symbﬁ
(
dï_dp
, 
˘x
->
mb_ty≥_c⁄ãxts
[0] + 
a˘_˘x
 );

727 
a˘_sym
 +
mode_sym
*2;

728 
a˘_˘x
 = 8;

729 
mode_sym
 = 
	`büri_decode_symbﬁ
(
dï_dp
, 
˘x
->
mb_ty≥_c⁄ãxts
[0] + 
a˘_˘x
 );

730 
a˘_sym
 +
mode_sym
;

731 
cuº_mb_ty≥
 = 
a˘_sym
;

735 if(
cuºSli˚
->
¶i˚_ty≥
 =
SI_SLICE
)

738 i‡(
cuºMB
->
mb_up
 !
NULL
)

739 
b
 = (–(
cuºMB
->
mb_up
)->
mb_ty≥
 !
SI4MB
) ? 1 : 0 );

741 i‡(
cuºMB
->
mb_À·
 !
NULL
)

742 
a
 = (–(
cuºMB
->
mb_À·
)->
mb_ty≥
 !
SI4MB
) ? 1 : 0 );

744 
a˘_˘x
 = 
a
 + 
b
;

745 
a˘_sym
 = 
	`büri_decode_symbﬁ
(
dï_dp
, 
˘x
->
mb_ty≥_c⁄ãxts
[1] + 
a˘_˘x
);

746 
£
->
c⁄ãxt
 = 
a˘_˘x
;

748 i‡(
a˘_sym
==0)

750 
cuº_mb_ty≥
 = 0;

754 i‡(
cuºMB
->
mb_up
 !
NULL
)

755 
b
 = (–(
cuºMB
->
mb_up
)->
mb_ty≥
 !
I4MB
) ? 1 : 0 );

757 i‡(
cuºMB
->
mb_À·
 !
NULL
)

758 
a
 = (–(
cuºMB
->
mb_À·
)->
mb_ty≥
 !
I4MB
) ? 1 : 0 );

760 
a˘_˘x
 = 
a
 + 
b
;

761 
a˘_sym
 = 
	`büri_decode_symbﬁ
(
dï_dp
, 
˘x
->
mb_ty≥_c⁄ãxts
[0] + 
a˘_˘x
);

762 
£
->
c⁄ãxt
 = 
a˘_˘x
;

764 i‡(
a˘_sym
==0)

766 
cuº_mb_ty≥
 = 1;

770 
mode_sym
 = 
	`büri_decode_föÆ
(
dï_dp
);

771 if–
mode_sym
==1 )

773 
cuº_mb_ty≥
 = 26;

777 
a˘_sym
 = 2;

778 
a˘_˘x
 = 4;

779 
mode_sym
 = 
	`büri_decode_symbﬁ
(
dï_dp
, 
˘x
->
mb_ty≥_c⁄ãxts
[0] + 
a˘_˘x
 );

780 
a˘_sym
 +
mode_sym
*12;

781 
a˘_˘x
 = 5;

783 
mode_sym
 = 
	`büri_decode_symbﬁ
(
dï_dp
, 
˘x
->
mb_ty≥_c⁄ãxts
[0] + 
a˘_˘x
 );

784 i‡(
mode_sym
!=0)

786 
a˘_˘x
=6;

787 
mode_sym
 = 
	`büri_decode_symbﬁ
(
dï_dp
, 
˘x
->
mb_ty≥_c⁄ãxts
[0] + 
a˘_˘x
 );

788 
a˘_sym
+=4;

789 i‡(
mode_sym
!=0)

790 
a˘_sym
+=4;

793 
a˘_˘x
 = 7;

794 
mode_sym
 = 
	`büri_decode_symbﬁ
(
dï_dp
, 
˘x
->
mb_ty≥_c⁄ãxts
[0] + 
a˘_˘x
 );

795 
a˘_sym
 +
mode_sym
*2;

796 
a˘_˘x
 = 8;

797 
mode_sym
 = 
	`büri_decode_symbﬁ
(
dï_dp
, 
˘x
->
mb_ty≥_c⁄ãxts
[0] + 
a˘_˘x
 );

798 
a˘_sym
 +
mode_sym
;

799 
cuº_mb_ty≥
 = 
a˘_sym
;

805 
£
->
vÆue1
 = 
cuº_mb_ty≥
;

807 #i‡
TRACE


808 
	`Ârötf
(
p_Dec
->
p_åa˚
, "@%-6d %-63†(%3d)\n",
symbﬁCou¡
++, 
£
->
åa˚°rög
, se->
vÆue1
);

809 
	`fÊush
(
p_Dec
->
p_åa˚
);

811 
	}
}

821 
	$ªadMB_ty≥Info_CABAC_p_¶i˚
(
Ma¸oblock
 *
cuºMB
,

822 
Sy¡axEÀmít
 *
£
,

823 
DecodögEnvú⁄mítPå
 
dï_dp
)

825 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

826 
MŸi⁄InfoC⁄ãxts
 *
˘x
 = 
cuºSli˚
->
mŸ_˘x
;

828 
a˘_˘x
;

829 
a˘_sym
;

830 
mode_sym
;

831 
cuº_mb_ty≥
;

832 
BiC⁄ãxtTy≥
 *
mb_ty≥_c⁄ãxts
 = 
˘x
->mb_type_contexts[1];

834 i‡(
	`büri_decode_symbﬁ
(
dï_dp
, &
mb_ty≥_c⁄ãxts
[4] ))

836 i‡(
	`büri_decode_symbﬁ
(
dï_dp
, &
mb_ty≥_c⁄ãxts
[7] ))

837 
a˘_sym
 = 7;

839 
a˘_sym
 = 6;

843 i‡(
	`büri_decode_symbﬁ
(
dï_dp
, &
mb_ty≥_c⁄ãxts
[5] ))

845 i‡(
	`büri_decode_symbﬁ
(
dï_dp
, &
mb_ty≥_c⁄ãxts
[7] ))

846 
a˘_sym
 = 2;

848 
a˘_sym
 = 3;

852 i‡(
	`büri_decode_symbﬁ
(
dï_dp
, &
mb_ty≥_c⁄ãxts
[6] ))

853 
a˘_sym
 = 4;

855 
a˘_sym
 = 1;

859 i‡(
a˘_sym
 <= 6)

861 
cuº_mb_ty≥
 = 
a˘_sym
;

865 
mode_sym
 = 
	`büri_decode_föÆ
(
dï_dp
);

866 if–
mode_sym
==1 )

868 
cuº_mb_ty≥
 = 31;

872 
a˘_˘x
 = 8;

873 
mode_sym
 = 
	`büri_decode_symbﬁ
(
dï_dp
, 
mb_ty≥_c⁄ãxts
 + 
a˘_˘x
 );

874 
a˘_sym
 +
mode_sym
*12;

877 
a˘_˘x
 = 9;

878 
mode_sym
 = 
	`büri_decode_symbﬁ
(
dï_dp
, 
mb_ty≥_c⁄ãxts
 + 
a˘_˘x
 );

879 i‡(
mode_sym
 != 0)

881 
a˘_sym
+=4;

882 
mode_sym
 = 
	`büri_decode_symbﬁ
(
dï_dp
, 
mb_ty≥_c⁄ãxts
 + 
a˘_˘x
 );

883 i‡(
mode_sym
 != 0)

884 
a˘_sym
+=4;

888 
a˘_˘x
 = 10;

889 
mode_sym
 = 
	`büri_decode_symbﬁ
(
dï_dp
, 
mb_ty≥_c⁄ãxts
 + 
a˘_˘x
 );

890 
a˘_sym
 +
mode_sym
*2;

891 
mode_sym
 = 
	`büri_decode_symbﬁ
(
dï_dp
, 
mb_ty≥_c⁄ãxts
 + 
a˘_˘x
 );

892 
a˘_sym
 +
mode_sym
;

893 
cuº_mb_ty≥
 = 
a˘_sym
;

897 
£
->
vÆue1
 = 
cuº_mb_ty≥
;

899 #i‡
TRACE


900 
	`Ârötf
(
p_Dec
->
p_åa˚
, "@%-6d %-63†(%3d)\n",
symbﬁCou¡
++, 
£
->
åa˚°rög
, se->
vÆue1
);

901 
	`fÊush
(
p_Dec
->
p_åa˚
);

903 
	}
}

913 
	$ªadMB_ty≥Info_CABAC_b_¶i˚
(
Ma¸oblock
 *
cuºMB
,

914 
Sy¡axEÀmít
 *
£
,

915 
DecodögEnvú⁄mítPå
 
dï_dp
)

917 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

918 
MŸi⁄InfoC⁄ãxts
 *
˘x
 = 
cuºSli˚
->
mŸ_˘x
;

920 
a
 = 0, 
b
 = 0;

921 
a˘_˘x
;

922 
a˘_sym
;

923 
mode_sym
;

924 
cuº_mb_ty≥
;

925 
BiC⁄ãxtTy≥
 *
mb_ty≥_c⁄ãxts
 = 
˘x
->mb_type_contexts[2];

927 i‡(
cuºMB
->
mb_up
 !
NULL
)

928 
b
 = (–(
cuºMB
->
mb_up
)->
mb_ty≥
 != 0) ? 1 : 0 );

930 i‡(
cuºMB
->
mb_À·
 !
NULL
)

931 
a
 = (–(
cuºMB
->
mb_À·
)->
mb_ty≥
 != 0) ? 1 : 0 );

933 
a˘_˘x
 = 
a
 + 
b
;

935 i‡(
	`büri_decode_symbﬁ
 (
dï_dp
, &
mb_ty≥_c⁄ãxts
[
a˘_˘x
]))

937 i‡(
	`büri_decode_symbﬁ
 (
dï_dp
, &
mb_ty≥_c⁄ãxts
[4]))

939 i‡(
	`büri_decode_symbﬁ
 (
dï_dp
, &
mb_ty≥_c⁄ãxts
[5]))

941 
a˘_sym
 = 12;

942 i‡(
	`büri_decode_symbﬁ
 (
dï_dp
, &
mb_ty≥_c⁄ãxts
[6]))

943 
a˘_sym
 += 8;

944 i‡(
	`büri_decode_symbﬁ
 (
dï_dp
, &
mb_ty≥_c⁄ãxts
[6]))

945 
a˘_sym
 += 4;

946 i‡(
	`büri_decode_symbﬁ
 (
dï_dp
, &
mb_ty≥_c⁄ãxts
[6]))

947 
a˘_sym
 += 2;

949 i‡(
a˘_sym
 == 24)

950 
a˘_sym
=11;

951 i‡(
a˘_sym
 == 26)

952 
a˘_sym
 = 22;

955 i‡(
a˘_sym
 == 22)

956 
a˘_sym
 = 23;

957 i‡(
	`büri_decode_symbﬁ
 (
dï_dp
, &
mb_ty≥_c⁄ãxts
[6]))

958 
a˘_sym
 += 1;

963 
a˘_sym
 = 3;

964 i‡(
	`büri_decode_symbﬁ
 (
dï_dp
, &
mb_ty≥_c⁄ãxts
[6]))

965 
a˘_sym
 += 4;

966 i‡(
	`büri_decode_symbﬁ
 (
dï_dp
, &
mb_ty≥_c⁄ãxts
[6]))

967 
a˘_sym
 += 2;

968 i‡(
	`büri_decode_symbﬁ
 (
dï_dp
, &
mb_ty≥_c⁄ãxts
[6]))

969 
a˘_sym
 += 1;

974 i‡(
	`büri_decode_symbﬁ
 (
dï_dp
, &
mb_ty≥_c⁄ãxts
[6]))

975 
a˘_sym
=2;

977 
a˘_sym
=1;

982 
a˘_sym
 = 0;

986 i‡(
a˘_sym
 <= 23)

988 
cuº_mb_ty≥
 = 
a˘_sym
;

992 
mode_sym
 = 
	`büri_decode_föÆ
(
dï_dp
);

993 if–
mode_sym
 == 1 )

995 
cuº_mb_ty≥
 = 48;

999 
mb_ty≥_c⁄ãxts
 = 
˘x
->mb_type_contexts[1];

1000 
a˘_˘x
 = 8;

1001 
mode_sym
 = 
	`büri_decode_symbﬁ
(
dï_dp
, 
mb_ty≥_c⁄ãxts
 + 
a˘_˘x
 );

1002 
a˘_sym
 +
mode_sym
*12;

1005 
a˘_˘x
 = 9;

1006 
mode_sym
 = 
	`büri_decode_symbﬁ
(
dï_dp
, 
mb_ty≥_c⁄ãxts
 + 
a˘_˘x
 );

1007 i‡(
mode_sym
 != 0)

1009 
a˘_sym
+=4;

1010 
mode_sym
 = 
	`büri_decode_symbﬁ
(
dï_dp
, 
mb_ty≥_c⁄ãxts
 + 
a˘_˘x
 );

1011 i‡(
mode_sym
 != 0)

1012 
a˘_sym
+=4;

1016 
a˘_˘x
 = 10;

1017 
mode_sym
 = 
	`büri_decode_symbﬁ
(
dï_dp
, 
mb_ty≥_c⁄ãxts
 + 
a˘_˘x
 );

1018 
a˘_sym
 +
mode_sym
*2;

1019 
mode_sym
 = 
	`büri_decode_symbﬁ
(
dï_dp
, 
mb_ty≥_c⁄ãxts
 + 
a˘_˘x
 );

1020 
a˘_sym
 +
mode_sym
;

1021 
cuº_mb_ty≥
 = 
a˘_sym
;

1025 
£
->
vÆue1
 = 
cuº_mb_ty≥
;

1027 #i‡
TRACE


1028 
	`Ârötf
(
p_Dec
->
p_åa˚
, "@%-6d %-63†(%3d)\n",
symbﬁCou¡
++, 
£
->
åa˚°rög
, se->
vÆue1
);

1029 
	`fÊush
(
p_Dec
->
p_åa˚
);

1031 
	}
}

1040 
	$ªadI¡øPªdMode_CABAC
–
Ma¸oblock
 *
cuºMB
,

1041 
Sy¡axEÀmít
 *
£
,

1042 
DecodögEnvú⁄mítPå
 
dï_dp
)

1044 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1045 
TextuªInfoC⁄ãxts
 *
˘x
 = 
cuºSli˚
->
ãx_˘x
;

1047 
a˘_sym
 = 
	`büri_decode_symbﬁ
(
dï_dp
, 
˘x
->
ùr_c⁄ãxts
);

1050 i‡(
a˘_sym
 == 1)

1051 
£
->
vÆue1
 = -1;

1054 
£
->
vÆue1
 = (
	`büri_decode_symbﬁ
(
dï_dp
, 
˘x
->
ùr_c⁄ãxts
 + 1) );

1055 
£
->
vÆue1
 |(
	`büri_decode_symbﬁ
(
dï_dp
, 
˘x
->
ùr_c⁄ãxts
 + 1) << 1);

1056 
£
->
vÆue1
 |(
	`büri_decode_symbﬁ
(
dï_dp
, 
˘x
->
ùr_c⁄ãxts
 + 1) << 2);

1059 #i‡
TRACE


1060 
	`Ârötf
(
p_Dec
->
p_åa˚
, "@%-6d %-63†(%3d)\n",
symbﬁCou¡
++, 
£
->
åa˚°rög
, se->
vÆue1
);

1061 
	`fÊush
(
p_Dec
->
p_åa˚
);

1063 
	}
}

1071 
	$ªadRefFøme_CABAC
(
Ma¸oblock
 *
cuºMB
,

1072 
Sy¡axEÀmít
 *
£
,

1073 
DecodögEnvú⁄mítPå
 
dï_dp
)

1075 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1076 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1077 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
cuºSli˚
->dec_picture;

1078 
MŸi⁄InfoC⁄ãxts
 *
˘x
 = 
cuºSli˚
->
mŸ_˘x
;

1079 
Ma¸oblock
 *
√ighb‹MB
 = 
NULL
;

1081 
add˘x
 = 0;

1082 
a
 = 0, 
b
 = 0;

1083 
a˘_˘x
;

1084 
a˘_sym
;

1085 
li°
 = 
£
->
vÆue2
;

1087 
PixñPos
 
block_a
, 
block_b
;

1089 
	`gë4x4Neighbour
(
cuºMB
, cuºMB->
subblock_x
 - 1, cuºMB->
subblock_y
 , 
p_Vid
->
mb_size
[
IS_LUMA
], &
block_a
);

1090 
	`gë4x4Neighbour
(
cuºMB
, cuºMB->
subblock_x
, cuºMB->
subblock_y
 - 1, 
p_Vid
->
mb_size
[
IS_LUMA
], &
block_b
);

1092 i‡(
block_b
.
avaûabÀ
)

1094 
b8b
=((
block_b
.
x
 >> 1Ë& 0x01)+(block_b.
y
 & 0x02);

1095 
√ighb‹MB
 = &
cuºSli˚
->
mb_d©a
[
block_b
.
mb_addr
];

1096 i‡(!–(
√ighb‹MB
->
mb_ty≥
==
IPCM
Ë|| 
	`IS_DIRECT
“eighb‹MBË|| (√ighb‹MB->
b8mode
[
b8b
]==0 &&Çeighb‹MB->
b8pdú
[b8b]==2)))

1098 i‡(
cuºSli˚
->
mb_aff_‰ame_Êag
 && (
cuºMB
->
mb_fõld
 =
FALSE
Ë&& (
√ighb‹MB
->mb_fõld =
TRUE
))

1099 
b
 = (
dec_pi˘uª
->
mv_öfo
[
block_b
.
pos_y
][block_b.
pos_x
].
ªf_idx
[
li°
] > 1 ? 2 : 0);

1101 
b
 = (
dec_pi˘uª
->
mv_öfo
[
block_b
.
pos_y
][block_b.
pos_x
].
ªf_idx
[
li°
] > 0 ? 2 : 0);

1105 i‡(
block_a
.
avaûabÀ
)

1107 
b8a
=((
block_a
.
x
 >> 1Ë& 0x01)+(block_a.
y
 & 0x02);

1108 
√ighb‹MB
 = &
cuºSli˚
->
mb_d©a
[
block_a
.
mb_addr
];

1109 i‡(!((
√ighb‹MB
->
mb_ty≥
==
IPCM
Ë|| 
	`IS_DIRECT
“eighb‹MBË|| (√ighb‹MB->
b8mode
[
b8a
]==0 &&Çeighb‹MB->
b8pdú
[b8a]==2)))

1111 i‡(
cuºSli˚
->
mb_aff_‰ame_Êag
 && (
cuºMB
->
mb_fõld
 =
FALSE
Ë&& (
√ighb‹MB
->mb_field == 1))

1112 
a
 = (
dec_pi˘uª
->
mv_öfo
[
block_a
.
pos_y
][block_a.
pos_x
].
ªf_idx
[
li°
] > 1 ? 1 : 0);

1114 
a
 = (
dec_pi˘uª
->
mv_öfo
[
block_a
.
pos_y
][block_a.
pos_x
].
ªf_idx
[
li°
] > 0 ? 1 : 0);

1118 
a˘_˘x
 = 
a
 + 
b
;

1119 
£
->
c⁄ãxt
 = 
a˘_˘x
;

1121 
a˘_sym
 = 
	`büri_decode_symbﬁ
(
dï_dp
,
˘x
->
ªf_no_c⁄ãxts
[
add˘x
] + 
a˘_˘x
 );

1123 i‡(
a˘_sym
 != 0)

1125 
a˘_˘x
 = 4;

1126 
a˘_sym
 = 
	`u«ry_bö_decode
(
dï_dp
,
˘x
->
ªf_no_c⁄ãxts
[
add˘x
] + 
a˘_˘x
,1);

1127 ++
a˘_sym
;

1129 
£
->
vÆue1
 = 
a˘_sym
;

1131 #i‡
TRACE


1132 
	`Ârötf
(
p_Dec
->
p_åa˚
, "@%-6d %-63†(%3d)\n",
symbﬁCou¡
++, 
£
->
åa˚°rög
, se->
vÆue1
);

1134 
	`fÊush
(
p_Dec
->
p_åa˚
);

1136 
	}
}

1146 
	$ªad_dQu™t_CABAC
–
Ma¸oblock
 *
cuºMB
,

1147 
Sy¡axEÀmít
 *
£
,

1148 
DecodögEnvú⁄mítPå
 
dï_dp
)

1150 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1151 
MŸi⁄InfoC⁄ãxts
 *
˘x
 = 
cuºSli˚
->
mŸ_˘x
;

1152 *
dqu™t
 = &
£
->
vÆue1
;

1153 
a˘_˘x
 = ((
cuºSli˚
->
œ°_dqu™t
 != 0) ? 1 : 0);

1154 
a˘_sym
 = 
	`büri_decode_symbﬁ
(
dï_dp
,
˘x
->
dñè_qp_c⁄ãxts
 + 
a˘_˘x
 );

1156 i‡(
a˘_sym
 != 0)

1158 
a˘_˘x
 = 2;

1159 
a˘_sym
 = 
	`u«ry_bö_decode
(
dï_dp
,
˘x
->
dñè_qp_c⁄ãxts
 + 
a˘_˘x
,1);

1160 ++
a˘_sym
;

1161 *
dqu™t
 = (
a˘_sym
 + 1) >> 1;

1162 if((
a˘_sym
 & 0x01)==0)

1163 *
dqu™t
 = -*dquant;

1166 *
dqu™t
 = 0;

1168 
cuºSli˚
->
œ°_dqu™t
 = *
dqu™t
;

1170 #i‡
TRACE


1171 
	`Ârötf
(
p_Dec
->
p_åa˚
, "@%-6d %-63†(%3d)\n",
symbﬁCou¡
++, 
£
->
åa˚°rög
, se->
vÆue1
);

1172 
	`fÊush
(
p_Dec
->
p_åa˚
);

1174 
	}
}

1182 
	$ªad_CBP_CABAC
(
Ma¸oblock
 *
cuºMB
,

1183 
Sy¡axEÀmít
 *
£
,

1184 
DecodögEnvú⁄mítPå
 
dï_dp
)

1186 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1187 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
cuºMB
->
p_Sli˚
->dec_picture;

1188 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1189 
TextuªInfoC⁄ãxts
 *
˘x
 = 
cuºSli˚
->
ãx_˘x
;

1190 
Ma¸oblock
 *
√ighb‹MB
 = 
NULL
;

1192 
mb_x
, 
mb_y
;

1193 
a
 = 0, 
b
 = 0;

1194 
cuº_cbp_˘x
;

1195 
cbp
 = 0;

1196 
cbp_bô
;

1197 
mask
;

1198 
PixñPos
 
block_a
;

1201 
mb_y
=0; mb_y < 4; mb_y += 2)

1203 i‡(
mb_y
 == 0)

1205 
√ighb‹MB
 = 
cuºMB
->
mb_up
;

1206 
b
 = 0;

1209 
mb_x
=0; mb_x < 4; mb_x += 2)

1211 i‡(
mb_y
 == 0)

1213 i‡(
√ighb‹MB
 !
NULL
)

1215 if(
√ighb‹MB
->
mb_ty≥
!=
IPCM
)

1216 
b
 = (–(
√ighb‹MB
->
cbp
 & (1<<(2 + (
mb_x
>>1)))) == 0) ? 2 : 0);

1220 
b
 = ( ((
cbp
 & (1<<(
mb_x
/2))) == 0) ? 2: 0);

1222 i‡(
mb_x
 == 0)

1224 
	`gë4x4Neighbour
(
cuºMB
, (
mb_x
<<2Ë- 1, (
mb_y
 << 2), 
p_Vid
->
mb_size
[
IS_LUMA
], &
block_a
);

1225 i‡(
block_a
.
avaûabÀ
)

1227 if(
cuºSli˚
->
mb_d©a
[
block_a
.
mb_addr
].
mb_ty≥
==
IPCM
)

1228 
a
 = 0;

1230 
a
 = (–(
cuºSli˚
->
mb_d©a
[
block_a
.
mb_addr
].
cbp
 & (1<<(2*(block_a.
y
/2)+1))) == 0) ? 1 : 0);

1233 
a
=0;

1236 
a
 = ( ((
cbp
 & (1<<
mb_y
)) == 0) ? 1: 0);

1238 
cuº_cbp_˘x
 = 
a
 + 
b
;

1239 
mask
 = (1 << (
mb_y
 + (
mb_x
 >> 1)));

1240 
cbp_bô
 = 
	`büri_decode_symbﬁ
(
dï_dp
, 
˘x
->
cbp_c⁄ãxts
[0] + 
cuº_cbp_˘x
 );

1241 i‡(
cbp_bô
)

1242 
cbp
 +
mask
;

1246 i‡((
dec_pi˘uª
->
chroma_f‹m©_idc
 !
YUV400
Ë&& (dec_pi˘uª->chroma_f‹m©_id¯!
YUV444
))

1250 
b
 = 0;

1251 
√ighb‹MB
 = 
cuºMB
->
mb_up
;

1252 i‡(
√ighb‹MB
 !
NULL
)

1254 i‡(
√ighb‹MB
->
mb_ty≥
==
IPCM
 || (√ighb‹MB->
cbp
 > 15))

1255 
b
 = 2;

1258 
a
 = 0;

1259 
√ighb‹MB
 = 
cuºMB
->
mb_À·
;

1260 i‡(
√ighb‹MB
 !
NULL
)

1262 i‡(
√ighb‹MB
->
mb_ty≥
==
IPCM
 || (√ighb‹MB->
cbp
 > 15))

1263 
a
 = 1;

1266 
cuº_cbp_˘x
 = 
a
 + 
b
;

1267 
cbp_bô
 = 
	`büri_decode_symbﬁ
(
dï_dp
, 
˘x
->
cbp_c⁄ãxts
[1] + 
cuº_cbp_˘x
 );

1270 i‡(
cbp_bô
)

1272 
b
 = 0;

1273 
√ighb‹MB
 = 
cuºMB
->
mb_up
;

1274 i‡(
√ighb‹MB
 !
NULL
)

1277 i‡((
√ighb‹MB
->
mb_ty≥
 =
IPCM
Ë|| (“eighb‹MB->
cbp
 >> 4) == 2))

1278 
b
 = 2;

1282 
a
 = 0;

1283 
√ighb‹MB
 = 
cuºMB
->
mb_À·
;

1284 i‡(
√ighb‹MB
 !
NULL
)

1286 i‡((
√ighb‹MB
->
mb_ty≥
 =
IPCM
Ë|| (“eighb‹MB->
cbp
 >> 4) == 2))

1287 
a
 = 1;

1290 
cuº_cbp_˘x
 = 
a
 + 
b
;

1291 
cbp_bô
 = 
	`büri_decode_symbﬁ
(
dï_dp
, 
˘x
->
cbp_c⁄ãxts
[2] + 
cuº_cbp_˘x
 );

1292 
cbp
 +(
cbp_bô
 == 1) ? 32 : 16;

1296 
£
->
vÆue1
 = 
cbp
;

1298 i‡(!
cbp
)

1300 
cuºSli˚
->
œ°_dqu™t
 = 0;

1303 #i‡
TRACE


1304 
	`Ârötf
(
p_Dec
->
p_åa˚
, "@%-6d %-63†(%3d)\n",
symbﬁCou¡
++, 
£
->
åa˚°rög
, se->
vÆue1
);

1305 
	`fÊush
(
p_Dec
->
p_åa˚
);

1307 
	}
}

1316 
	$ªadCIPªdMode_CABAC
(
Ma¸oblock
 *
cuºMB
,

1317 
Sy¡axEÀmít
 *
£
,

1318 
DecodögEnvú⁄mítPå
 
dï_dp
)

1320 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1321 
TextuªInfoC⁄ãxts
 *
˘x
 = 
cuºSli˚
->
ãx_˘x
;

1322 *
a˘_sym
 = &
£
->
vÆue1
;

1324 
Ma¸oblock
 *
MbUp
 = 
cuºMB
->
mb_up
;

1325 
Ma¸oblock
 *
MbLe·
 = 
cuºMB
->
mb_À·
;

1327 
b
 = (
MbUp
 !
NULL
Ë? (((MbUp->
c_ùªd_mode
 !0Ë&& (MbUp->
mb_ty≥
 !
IPCM
)) ? 1 : 0) : 0;

1328 
a
 = (
MbLe·
 !
NULL
Ë? (((MbLe·->
c_ùªd_mode
 !0Ë&& (MbLe·->
mb_ty≥
 !
IPCM
)) ? 1 : 0) : 0;

1329 
a˘_˘x
 = 
a
 + 
b
;

1331 *
a˘_sym
 = 
	`büri_decode_symbﬁ
(
dï_dp
, 
˘x
->
cùr_c⁄ãxts
 + 
a˘_˘x
 );

1333 i‡(*
a˘_sym
 != 0)

1334 *
a˘_sym
 = 
	`u«ry_bö_max_decode
(
dï_dp
, 
˘x
->
cùr_c⁄ãxts
 + 3, 0, 1) + 1;

1336 #i‡
TRACE


1337 
	`Ârötf
(
p_Dec
->
p_åa˚
, "@%-6d %-63†(%3d)\n",
symbﬁCou¡
++, 
£
->
åa˚°rög
, se->
vÆue1
);

1338 
	`fÊush
(
p_Dec
->
p_åa˚
);

1341 
	}
}

1350 
	$ªad_™d_°‹e_CBP_block_bô_444
 (
Ma¸oblock
 *
cuºMB
,

1351 
DecodögEnvú⁄mítPå
 
dï_dp
,

1352 
ty≥
)

1354 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1355 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1356 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
cuºSli˚
->dec_picture;

1357 
TextuªInfoC⁄ãxts
 *
ãx_˘x
 = 
cuºSli˚
->tex_ctx;

1358 
Ma¸oblock
 *
mb_d©a
 = 
cuºSli˚
->mb_data;

1359 
y_ac
 = (
ty≥
==
LUMA_16AC
 ||Åy≥==
LUMA_8x8
 ||Åy≥==
LUMA_8x4
 ||Åy≥==
LUMA_4x8
 ||Åy≥==
LUMA_4x4


1360 || 
ty≥
==
CB_16AC
 ||Åy≥==
CB_8x8
 ||Åy≥==
CB_8x4
 ||Åy≥==
CB_4x8
 ||Åy≥==
CB_4x4


1361 || 
ty≥
==
CR_16AC
 ||Åy≥==
CR_8x8
 ||Åy≥==
CR_8x4
 ||Åy≥==
CR_4x8
 ||Åy≥==
CR_4x4
);

1362 
y_dc
 = (
ty≥
==
LUMA_16DC
 ||Åy≥==
CB_16DC
 ||Åy≥==
CR_16DC
);

1363 
u_ac
 = (
ty≥
==
CHROMA_AC
 && !
cuºMB
->
is_v_block
);

1364 
v_ac
 = (
ty≥
==
CHROMA_AC
 && 
cuºMB
->
is_v_block
);

1365 
chroma_dc
 = (
ty≥
==
CHROMA_DC
 ||Åy≥==
CHROMA_DC_2x4
 ||Åy≥==
CHROMA_DC_4x4
);

1366 
u_dc
 = (
chroma_dc
 && !
cuºMB
->
is_v_block
);

1367 
v_dc
 = (
chroma_dc
 && 
cuºMB
->
is_v_block
);

1368 
j
 = (
y_ac
 || 
u_ac
 || 
v_ac
 ? 
cuºMB
->
subblock_y
 : 0);

1369 
i
 = (
y_ac
 || 
u_ac
 || 
v_ac
 ? 
cuºMB
->
subblock_x
 : 0);

1370 
bô
 = (
y_dc
 ? 0 : 
y_ac
 ? 1 : 
u_dc
 ? 17 : 
v_dc
 ? 18 : 
u_ac
 ? 19 : 35);

1371 
deÁu…_bô
 = (
cuºMB
->
is_öåa_block
 ? 1 : 0);

1372 
uµî_bô
 = 
deÁu…_bô
;

1373 
À·_bô
 = 
deÁu…_bô
;

1374 
cbp_bô
 = 1;

1375 
˘x
;

1376 
bô_pos_a
 = 0;

1377 
bô_pos_b
 = 0;

1379 
PixñPos
 
block_a
, 
block_b
;

1380 i‡(
y_ac
)

1382 
	`gë4x4Neighbour
(
cuºMB
, 
i
 - 1, 
j
 , 
p_Vid
->
mb_size
[
IS_LUMA
], &
block_a
);

1383 
	`gë4x4Neighbour
(
cuºMB
, 
i
 , 
j
 - 1, 
p_Vid
->
mb_size
[
IS_LUMA
], &
block_b
);

1384 i‡(
block_a
.
avaûabÀ
)

1385 
bô_pos_a
 = 4*
block_a
.
y
 + block_a.
x
;

1386 i‡(
block_b
.
avaûabÀ
)

1387 
bô_pos_b
 = 4*
block_b
.
y
 + block_b.
x
;

1389 i‡(
y_dc
)

1391 
	`gë4x4Neighbour
(
cuºMB
, 
i
 - 1, 
j
 , 
p_Vid
->
mb_size
[
IS_LUMA
], &
block_a
);

1392 
	`gë4x4Neighbour
(
cuºMB
, 
i
 , 
j
 - 1, 
p_Vid
->
mb_size
[
IS_LUMA
], &
block_b
);

1394 i‡(
u_ac
||
v_ac
)

1396 
	`gë4x4Neighbour
(
cuºMB
, 
i
 - 1, 
j
 , 
p_Vid
->
mb_size
[
IS_CHROMA
], &
block_a
);

1397 
	`gë4x4Neighbour
(
cuºMB
, 
i
 , 
j
 - 1, 
p_Vid
->
mb_size
[
IS_CHROMA
], &
block_b
);

1398 i‡(
block_a
.
avaûabÀ
)

1399 
bô_pos_a
 = 4*
block_a
.
y
 + block_a.
x
;

1400 i‡(
block_b
.
avaûabÀ
)

1401 
bô_pos_b
 = 4*
block_b
.
y
 + block_b.
x
;

1405 
	`gë4x4Neighbour
(
cuºMB
, 
i
 - 1, 
j
 , 
p_Vid
->
mb_size
[
IS_CHROMA
], &
block_a
);

1406 
	`gë4x4Neighbour
(
cuºMB
, 
i
 , 
j
 - 1, 
p_Vid
->
mb_size
[
IS_CHROMA
], &
block_b
);

1409 i‡(
dec_pi˘uª
->
chroma_f‹m©_idc
!=
YUV444
)

1411 i‡(
ty≥
!=
LUMA_8x8
)

1414 i‡(
block_b
.
avaûabÀ
)

1416 if(
mb_d©a
[
block_b
.
mb_addr
].
mb_ty≥
==
IPCM
)

1417 
uµî_bô
=1;

1419 
uµî_bô
 = 
	`gë_bô
(
mb_d©a
[
block_b
.
mb_addr
].
s_cbp
[0].
bôs
, 
bô
 + 
bô_pos_b
);

1422 i‡(
block_a
.
avaûabÀ
)

1424 if(
mb_d©a
[
block_a
.
mb_addr
].
mb_ty≥
==
IPCM
)

1425 
À·_bô
=1;

1427 
À·_bô
 = 
	`gë_bô
(
mb_d©a
[
block_a
.
mb_addr
].
s_cbp
[0].
bôs
, 
bô
 + 
bô_pos_a
);

1431 
˘x
 = 2 * 
uµî_bô
 + 
À·_bô
;

1433 
cbp_bô
 = 
	`büri_decode_symbﬁ
 (
dï_dp
, 
ãx_˘x
->
bcbp_c⁄ãxts
[
ty≥2˘x_bcbp
[
ty≥
]] + 
˘x
);

1436 if–(
p_Vid
->
£∑øã_cﬁour_∂™e_Êag
 != 0) )

1438 i‡(
ty≥
!=
LUMA_8x8
)

1441 i‡(
block_b
.
avaûabÀ
)

1443 if(
mb_d©a
[
block_b
.
mb_addr
].
mb_ty≥
==
IPCM
)

1444 
uµî_bô
 = 1;

1446 
uµî_bô
 = 
	`gë_bô
(
mb_d©a
[
block_b
.
mb_addr
].
s_cbp
[0].
bôs
,
bô
+
bô_pos_b
);

1450 i‡(
block_a
.
avaûabÀ
)

1452 if(
mb_d©a
[
block_a
.
mb_addr
].
mb_ty≥
==
IPCM
)

1453 
À·_bô
 = 1;

1455 
À·_bô
 = 
	`gë_bô
(
mb_d©a
[
block_a
.
mb_addr
].
s_cbp
[0].
bôs
,
bô
+
bô_pos_a
);

1459 
˘x
 = 2 * 
uµî_bô
 + 
À·_bô
;

1461 
cbp_bô
 = 
	`büri_decode_symbﬁ
 (
dï_dp
, 
ãx_˘x
->
bcbp_c⁄ãxts
[
ty≥2˘x_bcbp
[
ty≥
]] + 
˘x
);

1466 i‡(
block_b
.
avaûabÀ
)

1468 if((
ty≥
==
LUMA_8x8
 ||Åy≥==
CB_8x8
 ||Åy≥==
CR_8x8
) &&

1469 !
mb_d©a
[
block_b
.
mb_addr
].
luma_å™sf‹m_size_8x8_Êag
)

1471 if(
mb_d©a
[
block_b
.
mb_addr
].
mb_ty≥
==
IPCM
)

1472 
uµî_bô
=1;

1475 if(
ty≥
==
LUMA_8x8
)

1476 
uµî_bô
 = 
	`gë_bô
(
mb_d©a
[
block_b
.
mb_addr
].
s_cbp
[0].
bôs_8x8
, 
bô
 + 
bô_pos_b
);

1477 i‡(
ty≥
==
CB_8x8
)

1478 
uµî_bô
 = 
	`gë_bô
(
mb_d©a
[
block_b
.
mb_addr
].
s_cbp
[1].
bôs_8x8
, 
bô
 + 
bô_pos_b
);

1479 i‡(
ty≥
==
CR_8x8
)

1480 
uµî_bô
 = 
	`gë_bô
(
mb_d©a
[
block_b
.
mb_addr
].
s_cbp
[2].
bôs_8x8
, 
bô
 + 
bô_pos_b
);

1481 i‡((
ty≥
==
CB_4x4
)||—y≥==
CB_4x8
)||—y≥==
CB_8x4
)||—y≥==
CB_16AC
)||—y≥==
CB_16DC
))

1482 
uµî_bô
 = 
	`gë_bô
(
mb_d©a
[
block_b
.
mb_addr
].
s_cbp
[1].
bôs
,
bô
+
bô_pos_b
);

1483 i‡((
ty≥
==
CR_4x4
)||—y≥==
CR_4x8
)||—y≥==
CR_8x4
)||—y≥==
CR_16AC
)||—y≥==
CR_16DC
))

1484 
uµî_bô
 = 
	`gë_bô
(
mb_d©a
[
block_b
.
mb_addr
].
s_cbp
[2].
bôs
,
bô
+
bô_pos_b
);

1486 
uµî_bô
 = 
	`gë_bô
(
mb_d©a
[
block_b
.
mb_addr
].
s_cbp
[0].
bôs
,
bô
+
bô_pos_b
);

1491 i‡(
block_a
.
avaûabÀ
)

1493 if((
ty≥
==
LUMA_8x8
 ||Åy≥==
CB_8x8
 ||Åy≥==
CR_8x8
) &&

1494 !
mb_d©a
[
block_a
.
mb_addr
].
luma_å™sf‹m_size_8x8_Êag
)

1496 if(
mb_d©a
[
block_a
.
mb_addr
].
mb_ty≥
==
IPCM
)

1497 
À·_bô
=1;

1500 if(
ty≥
==
LUMA_8x8
)

1501 
À·_bô
 = 
	`gë_bô
(
mb_d©a
[
block_a
.
mb_addr
].
s_cbp
[0].
bôs_8x8
,
bô
+
bô_pos_a
);

1502 i‡(
ty≥
==
CB_8x8
)

1503 
À·_bô
 = 
	`gë_bô
(
mb_d©a
[
block_a
.
mb_addr
].
s_cbp
[1].
bôs_8x8
,
bô
+
bô_pos_a
);

1504 i‡(
ty≥
==
CR_8x8
)

1505 
À·_bô
 = 
	`gë_bô
(
mb_d©a
[
block_a
.
mb_addr
].
s_cbp
[2].
bôs_8x8
,
bô
+
bô_pos_a
);

1506 i‡((
ty≥
==
CB_4x4
)||—y≥==
CB_4x8
)||—y≥==
CB_8x4
)||—y≥==
CB_16AC
)||—y≥==
CB_16DC
))

1507 
À·_bô
 = 
	`gë_bô
(
mb_d©a
[
block_a
.
mb_addr
].
s_cbp
[1].
bôs
,
bô
+
bô_pos_a
);

1508 i‡((
ty≥
==
CR_4x4
)||—y≥==
CR_4x8
)||—y≥==
CR_8x4
)||—y≥==
CR_16AC
)||—y≥==
CR_16DC
))

1509 
À·_bô
 = 
	`gë_bô
(
mb_d©a
[
block_a
.
mb_addr
].
s_cbp
[2].
bôs
,
bô
+
bô_pos_a
);

1511 
À·_bô
 = 
	`gë_bô
(
mb_d©a
[
block_a
.
mb_addr
].
s_cbp
[0].
bôs
,
bô
+
bô_pos_a
);

1515 
˘x
 = 2 * 
uµî_bô
 + 
À·_bô
;

1517 
cbp_bô
 = 
	`büri_decode_symbﬁ
 (
dï_dp
, 
ãx_˘x
->
bcbp_c⁄ãxts
[
ty≥2˘x_bcbp
[
ty≥
]] + 
˘x
);

1521 
bô
 = (
y_dc
 ? 0 : 
y_ac
 ? 1 + 
j
 + (
i
 >> 2Ë: 
u_dc
 ? 17 : 
v_dc
 ? 18 : 
u_ac
 ? 19 + j + (i >> 2) : 35 + j + (i >> 2));

1523 i‡(
cbp_bô
)

1525 
CBPSåu˘uª
 *
s_cbp
 = 
cuºMB
->s_cbp;

1526 i‡(
ty≥
==
LUMA_8x8
)

1528 
s_cbp
[0].
bôs
 |((
öt64
Ë0x33 << 
bô
 );

1530 i‡(
dec_pi˘uª
->
chroma_f‹m©_idc
==
YUV444
)

1532 
s_cbp
[0].
bôs_8x8
 |((
öt64
Ë0x33 << 
bô
 );

1535 i‡(
ty≥
==
CB_8x8
)

1537 
s_cbp
[1].
bôs_8x8
 |((
öt64
Ë0x33 << 
bô
 );

1538 
s_cbp
[1].
bôs
 |((
öt64
Ë0x33 << 
bô
 );

1540 i‡(
ty≥
==
CR_8x8
)

1542 
s_cbp
[2].
bôs_8x8
 |((
öt64
Ë0x33 << 
bô
 );

1543 
s_cbp
[2].
bôs
 |((
öt64
Ë0x33 << 
bô
 );

1545 i‡(
ty≥
==
LUMA_8x4
)

1547 
s_cbp
[0].
bôs
 |((
öt64
Ë0x03 << 
bô
 );

1549 i‡(
ty≥
==
CB_8x4
)

1551 
s_cbp
[1].
bôs
 |((
öt64
Ë0x03 << 
bô
 );

1553 i‡(
ty≥
==
CR_8x4
)

1555 
s_cbp
[2].
bôs
 |((
öt64
Ë0x03 << 
bô
 );

1557 i‡(
ty≥
==
LUMA_4x8
)

1559 
s_cbp
[0].
bôs
 |((
öt64
Ë0x11<< 
bô
 );

1561 i‡(
ty≥
==
CB_4x8
)

1563 
s_cbp
[1].
bôs
 |((
öt64
)0x11<< 
bô
 );

1565 i‡(
ty≥
==
CR_4x8
)

1567 
s_cbp
[2].
bôs
 |((
öt64
)0x11<< 
bô
 );

1569 i‡((
ty≥
==
CB_4x4
)||—y≥==
CB_16AC
)||—y≥==
CB_16DC
))

1571 
s_cbp
[1].
bôs
 |
	`i64_powî2
(
bô
);

1573 i‡((
ty≥
==
CR_4x4
)||—y≥==
CR_16AC
)||—y≥==
CR_16DC
))

1575 
s_cbp
[2].
bôs
 |
	`i64_powî2
(
bô
);

1579 
s_cbp
[0].
bôs
 |
	`i64_powî2
(
bô
);

1582  
cbp_bô
;

1583 
	}
}

1586 
ölöe
 
	$£t_cbp_bô
(
Ma¸oblock
 *
√ighb‹_mb
)

1588 if(
√ighb‹_mb
->
mb_ty≥
 =
IPCM
)

1591  (Ë(
√ighb‹_mb
->
s_cbp
[0].
bôs
 & 0x01);

1592 
	}
}

1594 
ölöe
 
	$£t_cbp_bô_ac
(
Ma¸oblock
 *
√ighb‹_mb
, 
PixñPos
 *
block
)

1596 i‡(
√ighb‹_mb
->
mb_ty≥
 =
IPCM
)

1600 
bô_pos
 = 1 + (
block
->
y
 << 2Ë+ block->
x
;

1601  
	`gë_bô
(
√ighb‹_mb
->
s_cbp
[0].
bôs
, 
bô_pos
);

1603 
	}
}

1611 
	$ªad_™d_°‹e_CBP_block_bô_n‹mÆ
 (
Ma¸oblock
 *
cuºMB
,

1612 
DecodögEnvú⁄mítPå
 
dï_dp
,

1613 
ty≥
)

1615 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1616 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1617 
TextuªInfoC⁄ãxts
 *
ãx_˘x
 = 
cuºSli˚
->tex_ctx;

1618 
cbp_bô
 = 1;

1619 
Ma¸oblock
 *
mb_d©a
 = 
cuºSli˚
->mb_data;

1621 i‡(
ty≥
==
LUMA_16DC
)

1623 
uµî_bô
 = 1;

1624 
À·_bô
 = 1;

1625 
˘x
;

1627 
PixñPos
 
block_a
, 
block_b
;

1629 
	`gë4x4NeighbourBa£
(
cuºMB
, -1, 0, 
p_Vid
->
mb_size
[
IS_LUMA
], &
block_a
);

1630 
	`gë4x4NeighbourBa£
(
cuºMB
, 0, -1, 
p_Vid
->
mb_size
[
IS_LUMA
], &
block_b
);

1633 i‡(
block_b
.
avaûabÀ
)

1635 
uµî_bô
 = 
	`£t_cbp_bô
(&
mb_d©a
[
block_b
.
mb_addr
]);

1638 i‡(
block_a
.
avaûabÀ
)

1640 
À·_bô
 = 
	`£t_cbp_bô
(&
mb_d©a
[
block_a
.
mb_addr
]);

1643 
˘x
 = 2 * 
uµî_bô
 + 
À·_bô
;

1645 
cbp_bô
 = 
	`büri_decode_symbﬁ
 (
dï_dp
, 
ãx_˘x
->
bcbp_c⁄ãxts
[
ty≥2˘x_bcbp
[
ty≥
]] + 
˘x
);

1649 i‡(
cbp_bô
)

1651 
cuºMB
->
s_cbp
[0].
bôs
 |= 1;

1654 i‡(
ty≥
==
LUMA_16AC
)

1656 
j
 = 
cuºMB
->
subblock_y
;

1657 
i
 = 
cuºMB
->
subblock_x
;

1658 
bô
 = 1;

1659 
deÁu…_bô
 = (
cuºMB
->
is_öåa_block
 ? 1 : 0);

1660 
uµî_bô
 = 
deÁu…_bô
;

1661 
À·_bô
 = 
deÁu…_bô
;

1662 
˘x
;

1664 
PixñPos
 
block_a
, 
block_b
;

1666 
	`gë4x4NeighbourBa£
(
cuºMB
, 
i
 - 1, 
j
 , 
p_Vid
->
mb_size
[
IS_LUMA
], &
block_a
);

1667 
	`gë4x4NeighbourBa£
(
cuºMB
, 
i
 , 
j
 - 1, 
p_Vid
->
mb_size
[
IS_LUMA
], &
block_b
);

1670 i‡(
block_b
.
avaûabÀ
)

1672 
uµî_bô
 = 
	`£t_cbp_bô_ac
(&
mb_d©a
[
block_b
.
mb_addr
], &block_b);

1675 i‡(
block_a
.
avaûabÀ
)

1677 
À·_bô
 = 
	`£t_cbp_bô_ac
(&
mb_d©a
[
block_a
.
mb_addr
], &block_a);

1680 
˘x
 = 2 * 
uµî_bô
 + 
À·_bô
;

1682 
cbp_bô
 = 
	`büri_decode_symbﬁ
 (
dï_dp
, 
ãx_˘x
->
bcbp_c⁄ãxts
[
ty≥2˘x_bcbp
[
ty≥
]] + 
˘x
);

1684 i‡(
cbp_bô
)

1687 
bô
 = 1 + 
j
 + (
i
 >> 2);

1688 
cuºMB
->
s_cbp
[0].
bôs
 |
	`i64_powî2
(
bô
);

1691 i‡(
ty≥
==
LUMA_8x4
)

1693 
j
 = 
cuºMB
->
subblock_y
;

1694 
i
 = 
cuºMB
->
subblock_x
;

1695 
bô
 = 1;

1696 
deÁu…_bô
 = (
cuºMB
->
is_öåa_block
 ? 1 : 0);

1697 
uµî_bô
 = 
deÁu…_bô
;

1698 
À·_bô
 = 
deÁu…_bô
;

1699 
˘x
;

1701 
PixñPos
 
block_a
, 
block_b
;

1703 
	`gë4x4NeighbourBa£
(
cuºMB
, 
i
 - 1, 
j
 , 
p_Vid
->
mb_size
[
IS_LUMA
], &
block_a
);

1704 
	`gë4x4NeighbourBa£
(
cuºMB
, 
i
 , 
j
 - 1, 
p_Vid
->
mb_size
[
IS_LUMA
], &
block_b
);

1707 i‡(
block_b
.
avaûabÀ
)

1709 
uµî_bô
 = 
	`£t_cbp_bô_ac
(&
mb_d©a
[
block_b
.
mb_addr
], &block_b);

1712 i‡(
block_a
.
avaûabÀ
)

1714 
À·_bô
 = 
	`£t_cbp_bô_ac
(&
mb_d©a
[
block_a
.
mb_addr
], &block_a);

1717 
˘x
 = 2 * 
uµî_bô
 + 
À·_bô
;

1719 
cbp_bô
 = 
	`büri_decode_symbﬁ
 (
dï_dp
, 
ãx_˘x
->
bcbp_c⁄ãxts
[
ty≥2˘x_bcbp
[
ty≥
]] + 
˘x
);

1721 i‡(
cbp_bô
)

1724 
bô
 = 1 + 
j
 + (
i
 >> 2);

1725 
cuºMB
->
s_cbp
[0].
bôs
 |((
öt64
Ë0x03 << 
bô
 );

1728 i‡(
ty≥
==
LUMA_4x8
)

1730 
j
 = 
cuºMB
->
subblock_y
;

1731 
i
 = 
cuºMB
->
subblock_x
;

1732 
bô
 = 1;

1733 
deÁu…_bô
 = (
cuºMB
->
is_öåa_block
 ? 1 : 0);

1734 
uµî_bô
 = 
deÁu…_bô
;

1735 
À·_bô
 = 
deÁu…_bô
;

1736 
˘x
;

1738 
PixñPos
 
block_a
, 
block_b
;

1740 
	`gë4x4NeighbourBa£
(
cuºMB
, 
i
 - 1, 
j
 , 
p_Vid
->
mb_size
[
IS_LUMA
], &
block_a
);

1741 
	`gë4x4NeighbourBa£
(
cuºMB
, 
i
 , 
j
 - 1, 
p_Vid
->
mb_size
[
IS_LUMA
], &
block_b
);

1744 i‡(
block_b
.
avaûabÀ
)

1746 
uµî_bô
 = 
	`£t_cbp_bô_ac
(&
mb_d©a
[
block_b
.
mb_addr
], &block_b);

1749 i‡(
block_a
.
avaûabÀ
)

1751 
À·_bô
 = 
	`£t_cbp_bô_ac
(&
mb_d©a
[
block_a
.
mb_addr
], &block_a);

1754 
˘x
 = 2 * 
uµî_bô
 + 
À·_bô
;

1756 
cbp_bô
 = 
	`büri_decode_symbﬁ
 (
dï_dp
, 
ãx_˘x
->
bcbp_c⁄ãxts
[
ty≥2˘x_bcbp
[
ty≥
]] + 
˘x
);

1758 i‡(
cbp_bô
)

1761 
bô
 = 1 + 
j
 + (
i
 >> 2);

1763 
cuºMB
->
s_cbp
[0].
bôs
 |((
öt64
Ë0x11 << 
bô
 );

1766 i‡(
ty≥
==
LUMA_4x4
)

1768 
j
 = 
cuºMB
->
subblock_y
;

1769 
i
 = 
cuºMB
->
subblock_x
;

1770 
bô
 = 1;

1771 
deÁu…_bô
 = (
cuºMB
->
is_öåa_block
 ? 1 : 0);

1772 
uµî_bô
 = 
deÁu…_bô
;

1773 
À·_bô
 = 
deÁu…_bô
;

1774 
˘x
;

1776 
PixñPos
 
block_a
, 
block_b
;

1778 
	`gë4x4NeighbourBa£
(
cuºMB
, 
i
 - 1, 
j
 , 
p_Vid
->
mb_size
[
IS_LUMA
], &
block_a
);

1779 
	`gë4x4NeighbourBa£
(
cuºMB
, 
i
 , 
j
 - 1, 
p_Vid
->
mb_size
[
IS_LUMA
], &
block_b
);

1782 i‡(
block_b
.
avaûabÀ
)

1784 
uµî_bô
 = 
	`£t_cbp_bô_ac
(&
mb_d©a
[
block_b
.
mb_addr
], &block_b);

1787 i‡(
block_a
.
avaûabÀ
)

1789 
À·_bô
 = 
	`£t_cbp_bô_ac
(&
mb_d©a
[
block_a
.
mb_addr
], &block_a);

1792 
˘x
 = 2 * 
uµî_bô
 + 
À·_bô
;

1794 
cbp_bô
 = 
	`büri_decode_symbﬁ
 (
dï_dp
, 
ãx_˘x
->
bcbp_c⁄ãxts
[
ty≥2˘x_bcbp
[
ty≥
]] + 
˘x
);

1796 i‡(
cbp_bô
)

1799 
bô
 = 1 + 
j
 + (
i
 >> 2);

1801 
cuºMB
->
s_cbp
[0].
bôs
 |
	`i64_powî2
(
bô
);

1804 i‡(
ty≥
 =
LUMA_8x8
)

1806 
j
 = 
cuºMB
->
subblock_y
;

1807 
i
 = 
cuºMB
->
subblock_x
;

1809 
bô
 = 1 + 
j
 + (
i
 >> 2);

1811 
cuºMB
->
s_cbp
[0].
bôs
 |((
öt64
Ë0x33 << 
bô
 );

1813 i‡(
ty≥
==
CHROMA_DC
 ||Åy≥==
CHROMA_DC_2x4
 ||Åy≥==
CHROMA_DC_4x4
)

1815 
u_dc
 = (!
cuºMB
->
is_v_block
);

1816 
j
 = 0;

1817 
i
 = 0;

1818 
bô
 = (
u_dc
 ? 17 : 18);

1819 
deÁu…_bô
 = (
cuºMB
->
is_öåa_block
 ? 1 : 0);

1820 
uµî_bô
 = 
deÁu…_bô
;

1821 
À·_bô
 = 
deÁu…_bô
;

1822 
˘x
;

1824 
PixñPos
 
block_a
, 
block_b
;

1826 
	`gë4x4NeighbourBa£
(
cuºMB
, 
i
 - 1, 
j
 , 
p_Vid
->
mb_size
[
IS_CHROMA
], &
block_a
);

1827 
	`gë4x4NeighbourBa£
(
cuºMB
, 
i
 , 
j
 - 1, 
p_Vid
->
mb_size
[
IS_CHROMA
], &
block_b
);

1830 i‡(
block_b
.
avaûabÀ
)

1832 if(
mb_d©a
[
block_b
.
mb_addr
].
mb_ty≥
==
IPCM
)

1833 
uµî_bô
 = 1;

1835 
uµî_bô
 = 
	`gë_bô
(
mb_d©a
[
block_b
.
mb_addr
].
s_cbp
[0].
bôs
, 
bô
);

1838 i‡(
block_a
.
avaûabÀ
)

1840 if(
mb_d©a
[
block_a
.
mb_addr
].
mb_ty≥
==
IPCM
)

1841 
À·_bô
 = 1;

1843 
À·_bô
 = 
	`gë_bô
(
mb_d©a
[
block_a
.
mb_addr
].
s_cbp
[0].
bôs
, 
bô
);

1846 
˘x
 = 2 * 
uµî_bô
 + 
À·_bô
;

1848 
cbp_bô
 = 
	`büri_decode_symbﬁ
 (
dï_dp
, 
ãx_˘x
->
bcbp_c⁄ãxts
[
ty≥2˘x_bcbp
[
ty≥
]] + 
˘x
);

1850 i‡(
cbp_bô
)

1853 
bô
 = (
u_dc
 ? 17 : 18);

1854 
cuºMB
->
s_cbp
[0].
bôs
 |
	`i64_powî2
(
bô
);

1859 
u_ac
 = (!
cuºMB
->
is_v_block
);

1860 
j
 = 
cuºMB
->
subblock_y
;

1861 
i
 = 
cuºMB
->
subblock_x
;

1862 
bô
 = (
u_ac
 ? 19 : 35);

1863 
deÁu…_bô
 = (
cuºMB
->
is_öåa_block
 ? 1 : 0);

1864 
uµî_bô
 = 
deÁu…_bô
;

1865 
À·_bô
 = 
deÁu…_bô
;

1866 
˘x
;

1868 
PixñPos
 
block_a
, 
block_b
;

1870 
	`gë4x4NeighbourBa£
(
cuºMB
, 
i
 - 1, 
j
 , 
p_Vid
->
mb_size
[
IS_CHROMA
], &
block_a
);

1871 
	`gë4x4NeighbourBa£
(
cuºMB
, 
i
 , 
j
 - 1, 
p_Vid
->
mb_size
[
IS_CHROMA
], &
block_b
);

1874 i‡(
block_b
.
avaûabÀ
)

1876 if(
mb_d©a
[
block_b
.
mb_addr
].
mb_ty≥
==
IPCM
)

1877 
uµî_bô
=1;

1880 
bô_pos_b
 = 4*
block_b
.
y
 + block_b.
x
;

1881 
uµî_bô
 = 
	`gë_bô
(
mb_d©a
[
block_b
.
mb_addr
].
s_cbp
[0].
bôs
, 
bô
 + 
bô_pos_b
);

1885 i‡(
block_a
.
avaûabÀ
)

1887 if(
mb_d©a
[
block_a
.
mb_addr
].
mb_ty≥
==
IPCM
)

1888 
À·_bô
=1;

1891 
bô_pos_a
 = 4*
block_a
.
y
 + block_a.
x
;

1892 
À·_bô
 = 
	`gë_bô
(
mb_d©a
[
block_a
.
mb_addr
].
s_cbp
[0].
bôs
,
bô
 + 
bô_pos_a
);

1896 
˘x
 = 2 * 
uµî_bô
 + 
À·_bô
;

1898 
cbp_bô
 = 
	`büri_decode_symbﬁ
 (
dï_dp
, 
ãx_˘x
->
bcbp_c⁄ãxts
[
ty≥2˘x_bcbp
[
ty≥
]] + 
˘x
);

1900 i‡(
cbp_bô
)

1903 
bô
 = (
u_ac
 ? 19 + 
j
 + (
i
 >> 2) : 35 + j + (i >> 2));

1904 
cuºMB
->
s_cbp
[0].
bôs
 |
	`i64_powî2
(
bô
);

1907  
cbp_bô
;

1908 
	}
}

1911 
	$£t_ªad_™d_°‹e_CBP
(
Ma¸oblock
 **
cuºMB
, 
chroma_f‹m©_idc
)

1913 i‡(
chroma_f‹m©_idc
 =
YUV444
)

1914 (*
cuºMB
)->
ªad_™d_°‹e_CBP_block_bô
 = 
ªad_™d_°‹e_CBP_block_bô_444
;

1916 (*
cuºMB
)->
ªad_™d_°‹e_CBP_block_bô
 = 
ªad_™d_°‹e_CBP_block_bô_n‹mÆ
;

1917 
	}
}

1924 c⁄° 
byã
 
	gpos2˘x_m≠8x8
 [] = { 0, 1, 2, 3, 4, 5, 5, 4, 4, 3, 3, 4, 4, 4, 5, 5,

1928 c⁄° 
byã
 
	gpos2˘x_m≠8x4
 [] = { 0, 1, 2, 3, 4, 5, 7, 8, 9, 10, 11, 9, 8, 6, 7, 8,

1930 c⁄° 
byã
 
	gpos2˘x_m≠4x4
 [] = { 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 14};

1931 c⁄° 
byã
 
	gpos2˘x_m≠2x4c
[] = { 0, 0, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2};

1932 c⁄° 
byã
 
	gpos2˘x_m≠4x4c
[] = { 0, 0, 0, 0, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2};

1933 c⁄° 
byã
* 
	gpos2˘x_m≠
 [] = {
pos2˘x_m≠4x4
,Öos2˘x_m≠4x4, 
pos2˘x_m≠8x8
, 
pos2˘x_m≠8x4
,

1934 
pos2˘x_m≠8x4
, 
pos2˘x_m≠4x4
,Öos2ctx_map4x4,Öos2ctx_map4x4,

1935 
pos2˘x_m≠2x4c
, 
pos2˘x_m≠4x4c
,

1936 
pos2˘x_m≠4x4
,Öos2˘x_m≠4x4, 
pos2˘x_m≠8x8
,
pos2˘x_m≠8x4
,

1937 
pos2˘x_m≠8x4
, 
pos2˘x_m≠4x4
,

1938 
pos2˘x_m≠4x4
,Öos2˘x_m≠4x4, 
pos2˘x_m≠8x8
,
pos2˘x_m≠8x4
,

1939 
pos2˘x_m≠8x4
,
pos2˘x_m≠4x4
};

1942 c⁄° 
byã
 
	gpos2˘x_m≠8x8i
[] = { 0, 1, 1, 2, 2, 3, 3, 4, 5, 6, 7, 7, 7, 8, 4, 5,

1946 c⁄° 
byã
 
	gpos2˘x_m≠8x4i
[] = { 0, 1, 2, 3, 4, 5, 6, 3, 4, 5, 6, 3, 4, 7, 6, 8,

1948 c⁄° 
byã
 
	gpos2˘x_m≠4x8i
[] = { 0, 1, 1, 1, 2, 3, 3, 4, 4, 4, 5, 6, 2, 7, 7, 8,

1950 c⁄° 
byã
* 
	gpos2˘x_m≠_öt
[] = {
pos2˘x_m≠4x4
,Öos2˘x_m≠4x4, 
pos2˘x_m≠8x8i
,
pos2˘x_m≠8x4i
,

1951 
pos2˘x_m≠4x8i
,
pos2˘x_m≠4x4
,Öos2ctx_map4x4,Öos2ctx_map4x4,

1952 
pos2˘x_m≠2x4c
, 
pos2˘x_m≠4x4c
,

1953 
pos2˘x_m≠4x4
,Öos2˘x_m≠4x4, 
pos2˘x_m≠8x8i
,
pos2˘x_m≠8x4i
,

1954 
pos2˘x_m≠8x4i
,
pos2˘x_m≠4x4
,

1955 
pos2˘x_m≠4x4
,Öos2˘x_m≠4x4, 
pos2˘x_m≠8x8i
,
pos2˘x_m≠8x4i
,

1956 
pos2˘x_m≠8x4i
,
pos2˘x_m≠4x4
};

1959 c⁄° 
byã
 
	gpos2˘x_œ°8x8
 [] = { 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,

1963 c⁄° 
byã
 
	gpos2˘x_œ°8x4
 [] = { 0, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2,

1966 c⁄° 
byã
 
	gpos2˘x_œ°4x4
 [] = { 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15};

1967 c⁄° 
byã
 
	gpos2˘x_œ°2x4c
[] = { 0, 0, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2};

1968 c⁄° 
byã
 
	gpos2˘x_œ°4x4c
[] = { 0, 0, 0, 0, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2};

1969 c⁄° 
byã
* 
	gpos2˘x_œ°
 [] = {
pos2˘x_œ°4x4
,Öos2˘x_œ°4x4, 
pos2˘x_œ°8x8
, 
pos2˘x_œ°8x4
,

1970 
pos2˘x_œ°8x4
, 
pos2˘x_œ°4x4
,Öos2ctx_last4x4,Öos2ctx_last4x4,

1971 
pos2˘x_œ°2x4c
, 
pos2˘x_œ°4x4c
,

1972 
pos2˘x_œ°4x4
,Öos2˘x_œ°4x4, 
pos2˘x_œ°8x8
,
pos2˘x_œ°8x4
,

1973 
pos2˘x_œ°8x4
, 
pos2˘x_œ°4x4
,

1974 
pos2˘x_œ°4x4
,Öos2˘x_œ°4x4, 
pos2˘x_œ°8x8
,
pos2˘x_œ°8x4
,

1975 
pos2˘x_œ°8x4
, 
pos2˘x_œ°4x4
};

1985 
	$ªad_signifiˇn˚_m≠
 (
Ma¸oblock
 *
cuºMB
,

1986 
DecodögEnvú⁄mítPå
 
dï_dp
,

1987 
ty≥
,

1988 
c€ff
[])

1990 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1991 
Êd
 = ( 
cuºSli˚
->
°ru˘uª
!=
FRAME
 || 
cuºMB
->
mb_fõld
 );

1992 c⁄° 
byã
 *
pos2˘x_M≠
 = (
Êd
Ë? 
pos2˘x_m≠_öt
[
ty≥
] : 
pos2˘x_m≠
[type];

1993 c⁄° 
byã
 *
pos2˘x_La°
 = 
pos2˘x_œ°
[
ty≥
];

1995 
BiC⁄ãxtTy≥På
 
m≠_˘x
 = 
cuºSli˚
->
ãx_˘x
->
m≠_c⁄ãxts
 [
Êd
][
ty≥2˘x_m≠
 [
ty≥
]];

1996 
BiC⁄ãxtTy≥På
 
œ°_˘x
 = 
cuºSli˚
->
ãx_˘x
->
œ°_c⁄ãxts
[
Êd
][
ty≥2˘x_œ°
[
ty≥
]];

1998 
i
;

1999 
c€ff_˘r
 = 0;

2000 
i0
 = 0;

2001 
i1
 = 
maxpos
[
ty≥
];

2004 i‡(!
c1isdc
[
ty≥
])

2006 ++
i0
;

2007 ++
i1
;

2010 
i
=
i0
; i < 
i1
; ++i)

2013 i‡(
	`büri_decode_symbﬁ
 (
dï_dp
, 
m≠_˘x
 + 
pos2˘x_M≠
[
i
]))

2015 *(
c€ff
++) = 1;

2016 ++
c€ff_˘r
;

2018 i‡(
	`büri_decode_symbﬁ
 (
dï_dp
, 
œ°_˘x
 + 
pos2˘x_La°
[
i
]))

2020 
	`mem£t
(
c€ff
, 0, (
i1
 - 
i
) * ());

2021  
c€ff_˘r
;

2026 *(
c€ff
++) = 0;

2030 i‡(
i
 < 
i1
 + 1)

2032 *
c€ff
 = 1;

2033 ++
c€ff_˘r
;

2036  
c€ff_˘r
;

2037 
	}
}

2047 
	$ªad_signifiˇ¡_c€fficõ¡s
 (
DecodögEnvú⁄mítPå
 
dï_dp
,

2048 
TextuªInfoC⁄ãxts
 *
ãx_˘x
,

2049 
ty≥
,

2050 *
c€ff
)

2052 
BiC⁄ãxtTy≥
 *
⁄e_c⁄ãxts
 = 
ãx_˘x
->⁄e_c⁄ãxts[
ty≥2˘x_⁄e
[
ty≥
]];

2053 
BiC⁄ãxtTy≥
 *
abs_c⁄ãxts
 = 
ãx_˘x
->abs_c⁄ãxts[
ty≥2˘x_abs
[
ty≥
]];

2054 c⁄° 
max_ty≥
 = 
max_c2
[
ty≥
];

2055 
i
 = 
maxpos
[
ty≥
];

2056 *
cof
 = 
c€ff
 + 
i
;

2057 
c1
 = 1;

2058 
c2
 = 0;

2060 ; 
i
>=0; i--)

2062 i‡(*
cof
 != 0)

2064 *
cof
 +
	`büri_decode_symbﬁ
 (
dï_dp
, 
⁄e_c⁄ãxts
 + 
c1
);

2066 i‡(*
cof
 == 2)

2068 *
cof
 +
	`u«ry_exp_gﬁomb_Àvñ_decode
 (
dï_dp
, 
abs_c⁄ãxts
 + 
c2
);

2069 
c2
 = 
	`imö
 (++c2, 
max_ty≥
);

2070 
c1
 = 0;

2072 i‡(
c1
)

2074 
c1
 = 
	`imö
 (++c1, 4);

2077 i‡(
	`büri_decode_symbﬁ_eq_¥ob
(
dï_dp
))

2079 *
cof
 = - *cof;

2082 
cof
--;

2084 
	}
}

2093 
	$ªadRunLevñ_CABAC
 (
Ma¸oblock
 *
cuºMB
,

2094 
Sy¡axEÀmít
 *
£
,

2095 
DecodögEnvú⁄mítPå
 
dï_dp
)

2097 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

2098 *
c€ff_˘r
 = &
cuºSli˚
->coeff_ctr;

2099 *
c€ff
 = 
cuºSli˚
->coeff;

2102 i‡(*
c€ff_˘r
 < 0)

2105 i‡((*
c€ff_˘r
 = 
cuºMB
->
	`ªad_™d_°‹e_CBP_block_bô
 (cuºMB, 
dï_dp
, 
£
->
c⁄ãxt
) ) != 0)

2108 *
c€ff_˘r
 = 
	`ªad_signifiˇn˚_m≠
 (
cuºMB
, 
dï_dp
, 
£
->
c⁄ãxt
, 
c€ff
);

2111 
	`ªad_signifiˇ¡_c€fficõ¡s
 (
dï_dp
, 
cuºSli˚
->
ãx_˘x
, 
£
->
c⁄ãxt
, 
c€ff
);

2116 i‡(*
c€ff_˘r
)

2119 
£
->
vÆue2
 = 0; 
c€ff
[
cuºSli˚
->
pos
] == 0; ++currSlice->pos, ++se->value2);

2120 
£
->
vÆue1
 = 
c€ff
[
cuºSli˚
->
pos
++];

2125 
£
->
vÆue1
 = se->
vÆue2
 = 0;

2128 i‡((*
c€ff_˘r
)-- == 0)

2129 
cuºSli˚
->
pos
 = 0;

2131 #i‡
TRACE


2132 
	`Ârötf
(
p_Dec
->
p_åa˚
, "@%-6d %-53†%3d %3d\n",
symbﬁCou¡
++, 
£
->
åa˚°rög
, se->
vÆue1
,£->
vÆue2
);

2133 
	`fÊush
(
p_Dec
->
p_åa˚
);

2135 
	}
}

2143 
	$ªadSy¡axEÀmít_CABAC
(
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
this_d©aP¨t
)

2145 
DecodögEnvú⁄mítPå
 
dï_dp
 = &(
this_d©aP¨t
->
de_ˇbac
);

2146 
cuº_Àn
 = 
	`¨ideco_bôs_ªad
(
dï_dp
);

2149 
£
->
	`ªadög
(
cuºMB
, se, 
dï_dp
);

2151 
£
->
Àn
 = (
	`¨ideco_bôs_ªad
(
dï_dp
Ë- 
cuº_Àn
);

2153 #i‡(
TRACE
==2)

2154 
	`Ârötf
(
p_Dec
->
p_åa˚
, "cuº_Àn: %d\n",
cuº_Àn
);

2155 
	`Ârötf
(
p_Dec
->
p_åa˚
, "£_Àn: %d\n",
£
->
Àn
);

2158  (
£
->
Àn
);

2159 
	}
}

2170 
	$u«ry_bö_max_decode
(
DecodögEnvú⁄mítPå
 
dï_dp
,

2171 
BiC⁄ãxtTy≥På
 
˘x
,

2172 
˘x_off£t
,

2173 
max_symbﬁ
)

2175 
symbﬁ
 = 
	`büri_decode_symbﬁ
(
dï_dp
, 
˘x
 );

2177 i‡(
symbﬁ
 =0 || (
max_symbﬁ
 == 0))

2178  
symbﬁ
;

2181 
l
;

2182 
˘x
 +
˘x_off£t
;

2183 
symbﬁ
 = 0;

2186 
l
 = 
	`büri_decode_symbﬁ
(
dï_dp
, 
˘x
);

2187 ++
symbﬁ
;

2189  (
l
 !0Ë&& (
symbﬁ
 < 
max_symbﬁ
) );

2191 i‡((
l
 !0Ë&& (
symbﬁ
 =
max_symbﬁ
))

2192 ++
symbﬁ
;

2193  
symbﬁ
;

2195 
	}
}

2205 
	$u«ry_bö_decode
(
DecodögEnvú⁄mítPå
 
dï_dp
,

2206 
BiC⁄ãxtTy≥På
 
˘x
,

2207 
˘x_off£t
)

2209 
symbﬁ
 = 
	`büri_decode_symbﬁ
(
dï_dp
, 
˘x
 );

2211 i‡(
symbﬁ
 == 0)

2215 
l
;

2216 
˘x
 +
˘x_off£t
;;

2217 
symbﬁ
 = 0;

2220 
l
 = 
	`büri_decode_symbﬁ
(
dï_dp
, 
˘x
);

2221 ++
symbﬁ
;

2223  
l
 != 0 );

2224  
symbﬁ
;

2226 
	}
}

2240 
	$ˇbac_°¨tcode_fﬁlows
(
Sli˚
 *
cuºSli˚
, 
eos_bô
)

2242 
bô
;

2244 if–
eos_bô
 )

2246 c⁄° 
byã
 *
∑πM≠
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
dp_mode
];

2247 
D©aP¨tôi⁄
 *
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_MBTYPE
]]);

2248 
DecodögEnvú⁄mítPå
 
dï_dp
 = &(
dP
->
de_ˇbac
);

2250 
bô
 = 
	`büri_decode_föÆ
 (
dï_dp
);

2252 #i‡
TRACE


2253 
	`Ârötf
(
p_Dec
->
p_åa˚
, "@%-6d %-63†(%3d)\n",
symbﬁCou¡
++, "íd_of_¶i˚_Êag", 
bô
);

2254 
	`fÊush
(
p_Dec
->
p_åa˚
);

2259 
bô
 = 0;

2262  (
bô
 == 1 ? 1 : 0);

2263 
	}
}

2272 
	$exp_gﬁomb_decode_eq_¥ob
–
DecodögEnvú⁄mítPå
 
dï_dp
,

2273 
k
)

2275 
l
;

2276 
symbﬁ
 = 0;

2277 
bö¨y_symbﬁ
 = 0;

2281 
l
 = 
	`büri_decode_symbﬁ_eq_¥ob
(
dï_dp
);

2282 i‡(
l
 == 1)

2284 
symbﬁ
 +(1<<
k
);

2285 ++
k
;

2288 
l
!=0);

2290 
k
--)

2291 i‡(
	`büri_decode_symbﬁ_eq_¥ob
(
dï_dp
)==1)

2292 
bö¨y_symbﬁ
 |(1<<
k
);

2294  (Ë(
symbﬁ
 + 
bö¨y_symbﬁ
);

2295 
	}
}

2304 
	$u«ry_exp_gﬁomb_Àvñ_decode
–
DecodögEnvú⁄mítPå
 
dï_dp
,

2305 
BiC⁄ãxtTy≥På
 
˘x
)

2307 
symbﬁ
 = 
	`büri_decode_symbﬁ
(
dï_dp
, 
˘x
 );

2309 i‡(
symbﬁ
==0)

2313 
l
, 
k
 = 1;

2314 
exp_°¨t
 = 13;

2316 
symbﬁ
 = 0;

2320 
l
=
	`büri_decode_symbﬁ
(
dï_dp
, 
˘x
);

2321 ++
symbﬁ
;

2322 ++
k
;

2324 (
l
 !0Ë&& (
k
 !
exp_°¨t
));

2325 i‡(
l
!=0)

2326 
symbﬁ
 +
	`exp_gﬁomb_decode_eq_¥ob
(
dï_dp
,0)+1;

2327  
symbﬁ
;

2329 
	}
}

2340 
	$u«ry_exp_gﬁomb_mv_decode
(
DecodögEnvú⁄mítPå
 
dï_dp
,

2341 
BiC⁄ãxtTy≥På
 
˘x
,

2342 
max_bö
)

2344 
symbﬁ
 = 
	`büri_decode_symbﬁ
(
dï_dp
, 
˘x
 );

2346 i‡(
symbﬁ
 == 0)

2350 
exp_°¨t
 = 8;

2351 
l
,
k
 = 1;

2352 
bö
 = 1;

2354 
symbﬁ
=0;

2356 ++
˘x
;

2359 
l
=
	`büri_decode_symbﬁ
(
dï_dp
, 
˘x
);

2360 i‡((++
bö
)==2Ë
˘x
++;

2361 i‡(
bö
==
max_bö
)

2362 ++
˘x
;

2363 ++
symbﬁ
;

2364 ++
k
;

2366 (
l
!=0Ë&& (
k
!=
exp_°¨t
));

2367 i‡(
l
!=0)

2368 
symbﬁ
 +
	`exp_gﬁomb_decode_eq_¥ob
(
dï_dp
,3) + 1;

2369  
symbﬁ
;

2371 
	}
}

2380 
	$ªadIPCM_CABAC
(
Sli˚
 *
cuºSli˚
, 
d©≠¨tôi⁄_dec
 *
dP
)

2382 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

2383 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
cuºSli˚
->dec_picture;

2384 
Bô°ªam
* 
cuºSåóm
 = 
dP
->
bô°ªam
;

2385 
DecodögEnvú⁄mítPå
 
dï
 = &(
dP
->
de_ˇbac
);

2386 
byã
 *
buf
 = 
cuºSåóm
->
°ªamBuf„r
;

2387 
Bô°ªamLígthInBôs
 = (
dP
->
bô°ªam
->
bô°ªam_Àngth
 << 3) + 7;

2389 
vÆ
 = 0;

2391 
bôs_ªad
 = 0;

2392 
bôoff£t
, 
bôdïth
;

2393 
uv
, 
i
, 
j
;

2395 
dï
->
DbôsLe·
 >= 8)

2397 
dï
->
DvÆue
 >>= 8;

2398 
dï
->
DbôsLe·
 -= 8;

2399 (*
dï
->
Dcode°rm_Àn
)--;

2402 
bôoff£t
 = (*
dï
->
Dcode°rm_Àn
) << 3;

2405 
bôdïth
 = 
p_Vid
->
bôdïth_luma
;

2406 
i
=0;i<
MB_BLOCK_SIZE
;++i)

2408 
j
=0;j<
MB_BLOCK_SIZE
;++j)

2410 
bôs_ªad
 +
	`GëBôs
(
buf
, 
bôoff£t
, &
vÆ
, 
Bô°ªamLígthInBôs
, 
bôdïth
);

2411 #i‡
TRACE


2412 
	`åa˚bôs2
("pcm_byãÜuma", 
bôdïth
, 
vÆ
);

2414 
cuºSli˚
->
cof
[0][
i
][
j
] = 
vÆ
;

2416 
bôoff£t
 +
bôdïth
;

2421 
bôdïth
 = 
p_Vid
->
bôdïth_chroma
;

2422 i‡((
dec_pi˘uª
->
chroma_f‹m©_idc
 !
YUV400
Ë&& (
p_Vid
->
£∑øã_cﬁour_∂™e_Êag
 == 0))

2424 
uv
 = 1; uv < 3; ++uv)

2426 
i
 = 0; i < 
p_Vid
->
mb_¸_size_y
; ++i)

2428 
j
 = 0; j < 
p_Vid
->
mb_¸_size_x
; ++j)

2430 
bôs_ªad
 +
	`GëBôs
(
buf
, 
bôoff£t
, &
vÆ
, 
Bô°ªamLígthInBôs
, 
bôdïth
);

2431 #i‡
TRACE


2432 
	`åa˚bôs2
("pcm_byã chroma", 
bôdïth
, 
vÆ
);

2434 
cuºSli˚
->
cof
[
uv
][
i
][
j
] = 
vÆ
;

2436 
bôoff£t
 +
bôdïth
;

2442 (*
dï
->
Dcode°rm_Àn
Ë+–
bôs_ªad
 >> 3);

2443 i‡(
bôs_ªad
 & 7)

2445 ++(*
dï
->
Dcode°rm_Àn
);

2447 
	}
}

	@ldecod/src/configfile.c

59 
	#INCLUDED_BY_CONFIGFILE_C


	)

61 
	~<sys/°©.h
>

63 
	~"globÆ.h
"

64 
	~"memÆloc.h
"

65 
	~"c⁄fig_comm⁄.h
"

66 
	~"c⁄figfûe.h
"

67 
	#MAX_ITEMS_TO_PARSE
 10000

	)

69 
P©chI≈
 (
I≈utP¨amëîs
 *
p_I≈
);

77 
	$JMDecHñpExô
 ()

79 
	`Ârötf
–
°dîr
, "\nÜdecod [-h] [-d defdec.cfg] {[-f curenc1.cfg]...[-f curencN.cfg]}"

99 
	`exô
(-1);

100 
	}
}

109 
ölöe
 
	$c⁄f_ªad_check
 (
vÆ
, 
ex≥˘ed
)

111 i‡(
vÆ
 !
ex≥˘ed
)

113 
	`îr‹
 ("init_conf:ÉrrorÑeading from config file", 500);

115 
	}
}

131 
	$P¨£Comm™d
(
I≈utP¨amëîs
 *
p_I≈
, 
ac
, *
av
[])

133 *
c⁄ã¡
 = 
NULL
;

134 
CLcou¡
, 
C⁄ã¡Lí
, 
NumbîP¨ams
;

135 *
fûíame
=
DEFAULTCONFIGFILENAME
;

137 i‡(
ac
==2)

139 i‡(0 =
	`°∫cmp
 (
av
[1], "-v", 2))

141 
	`¥ötf
("JM " 
JM
 ": compûed " 
__DATE__
 " " 
__TIME__
 "\n");

142 
	`exô
(-1);

145 i‡(0 =
	`°∫cmp
 (
av
[1], "-h", 2))

147 
	`JMDecHñpExô
();

151 
	`mem˝y
 (&
cfg∑øms
, 
p_I≈
,  (
I≈utP¨amëîs
));

153 
	`¥ötf
 ("Setting Default Parameters...\n");

154 
	`InôP¨ams
(
M≠
);

156 *
p_I≈
 = 
cfg∑øms
;

158 
CLcou¡
 = 1;

160 i‡(
ac
>=3)

162 i‡((
	`°æí
(
av
[1])==2Ë&& (0 =
	`°∫cmp
 (av[1], "-d", 2)))

164 if(0 =
	`°∫cmp
 (
av
[2], "null", 4))

165 
fûíame
=
NULL
;

167 
fûíame
=
av
[2];

168 
CLcou¡
 = 3;

170 i‡(0 =
	`°∫cmp
 (
av
[1], "-h", 2))

172 
	`JMDecHñpExô
();

175 if(
fûíame
)

177 
	`¥ötf
 ("P¨sög C⁄figfûê%s\n", 
fûíame
);

178 
c⁄ã¡
 = 
	`GëC⁄figFûeC⁄ã¡
 (
fûíame
);

179 i‡(
NULL
 !
c⁄ã¡
)

182 
	`P¨£C⁄ã¡
 (
p_I≈
, 
M≠
, 
c⁄ã¡
, (Ë
	`°æí
(content));

183 
	`¥ötf
 ("\n");

184 
	`‰ì
 (
c⁄ã¡
);

189 
CLcou¡
 < 
ac
)

191 i‡(0 =
	`°∫cmp
 (
av
[
CLcou¡
], "-h", 2))

193 
	`JMDecHñpExô
();

196 i‡(0 =
	`°∫cmp
 (
av
[
CLcou¡
], "-f", 2) || 0 == strncmp (av[CLcount], "-F", 2))

198 
c⁄ã¡
 = 
	`GëC⁄figFûeC⁄ã¡
 (
av
[
CLcou¡
+1]);

199 i‡(
NULL
==
c⁄ã¡
)

200 
	`îr‹
 (
îr‹ãxt
, 300);

201 
	`¥ötf
 ("P¨sög C⁄figfûê%s", 
av
[
CLcou¡
+1]);

202 
	`P¨£C⁄ã¡
 (
p_I≈
, 
M≠
, 
c⁄ã¡
, (Ë
	`°æí
 (content));

203 
	`¥ötf
 ("\n");

204 
	`‰ì
 (
c⁄ã¡
);

205 
CLcou¡
 += 2;

207 i‡(0 =
	`°∫cmp
 (
av
[
CLcou¡
], "-i", 2) || 0 == strncmp (av[CLcount], "-I", 2))

209 
	`°∫˝y
(
p_I≈
->
öfûe
, 
av
[
CLcou¡
+1], 
FILE_NAME_SIZE
);

210 
CLcou¡
 += 2;

212 i‡(0 =
	`°∫cmp
 (
av
[
CLcou¡
], "-r", 2) || 0 == strncmp (av[CLcount], "-R", 2))

214 
	`°∫˝y
(
p_I≈
->
ªffûe
, 
av
[
CLcou¡
+1], 
FILE_NAME_SIZE
);

215 
CLcou¡
 += 2;

217 i‡(0 =
	`°∫cmp
 (
av
[
CLcou¡
], "-o", 2) || 0 == strncmp (av[CLcount], "-O", 2))

219 
	`°∫˝y
(
p_I≈
->
outfûe
, 
av
[
CLcou¡
+1], 
FILE_NAME_SIZE
);

220 
CLcou¡
 += 2;

222 i‡(0 =
	`°∫cmp
 (
av
[
CLcou¡
], "-s", 2) || 0 == strncmp (av[CLcount], "-S", 2))

224 
p_I≈
->
sûít
 = 1;

225 
CLcou¡
 += 1;

227 i‡(0 =
	`°∫cmp
 (
av
[
CLcou¡
], "-n", 2) || 0 == strncmp (av[CLcount], "-N", 2))

229 
	`c⁄f_ªad_check
 (
	`ssˇnf
(
av
[
CLcou¡
+1],"%d", &
p_I≈
->
iDecFrmNum
), 1);

230 
CLcou¡
 += 2;

232 #i‡(
MVC_EXTENSION_ENABLE
)

233 i‡(0 =
	`°∫cmp
 (
av
[
CLcou¡
], "-mpr", 4) || 0 == strncmp (av[CLcount], "-MPR", 4))

235 
	`c⁄f_ªad_check
 (
	`ssˇnf
(
av
[
CLcou¡
+1],"%d", &
p_I≈
->
DecodeAŒLayîs
), 1);

236 
CLcou¡
 += 2;

239 i‡(0 =
	`°∫cmp
 (
av
[
CLcou¡
], "-p", 2) || 0 == strncmp (av[CLcount], "-P", 2))

244 ++
CLcou¡
;

245 
C⁄ã¡Lí
 = 0;

246 
NumbîP¨ams
 = 
CLcou¡
;

249 
NumbîP¨ams
 < 
ac
 && 
av
[NumberParams][0] != '-')

250 
C⁄ã¡Lí
 +(Ë
	`°æí
 (
av
[
NumbîP¨ams
++]);

251 
C⁄ã¡Lí
 += 1000;

254 i‡((
c⁄ã¡
 = 
	`mÆloc
 (
C⁄ã¡Lí
))==
NULL
Ë
	`no_mem_exô
("Configure: content");;

255 
c⁄ã¡
[0] = '\0';

259 
CLcou¡
 < 
NumbîP¨ams
)

261 *
sour˚
 = &
av
[
CLcou¡
][0];

262 *
de°ö
 = &
c⁄ã¡
[(Ë
	`°æí
 (content)];

264 *
sour˚
 != '\0')

266 i‡(*
sour˚
 == '=')

268 *
de°ö
++=' '; *destin++='='; *destin++=' ';

271 *
de°ö
++=*
sour˚
;

272 
sour˚
++;

274 *
de°ö
 = '\0';

275 
CLcou¡
++;

277 
	`¥ötf
 ("P¨sög comm™dÜöê°rög '%s'", 
c⁄ã¡
);

278 
	`P¨£C⁄ã¡
 (
p_I≈
, 
M≠
, 
c⁄ã¡
, (Ë
	`°æí
(content));

279 
	`‰ì
 (
c⁄ã¡
);

280 
	`¥ötf
 ("\n");

284 
	`¢¥ötf
 (
îr‹ãxt
, 
ET_SIZE
, "Eº‹ i¿comm™dÜöe,á¯%d,áround såög '%s', missög -‡‹ -∞∑ømëîs?", 
CLcou¡
, 
av
[CLcount]);

285 
	`îr‹
 (
îr‹ãxt
, 300);

288 
	`¥ötf
 ("\n");

290 
	`P©chI≈
(
p_I≈
);

291 
cfg∑øms
 = *
p_I≈
;

292 
p_I≈
->
íabÀ_32_puŒdown
 = 0;

293 i‡(
p_I≈
->
bDi•œyDecP¨ams
)

294 
	`Di•œyP¨ams
(
M≠
, "Decoder Parameters");

295 
	}
}

304 
	$P©chI≈
 (
I≈utP¨amëîs
 *
p_I≈
)

308 
	`Te°P¨ams
(
M≠
, 
NULL
);

309 if(
p_I≈
->
exp‹t_võws
 == 1)

310 
p_I≈
->
dpb_∂us
[1] = 
	`imax
(1,Ö_Inp->dpb_plus[1]);

311 
	}
}

	@ldecod/src/context_ini.c

16 
	#CONTEXT_INI_C


	)

18 
	~"deföes.h
"

19 
	~"globÆ.h
"

20 
	~"büridecod.h
"

21 
	~"˘x_èbÀs.h
"

24 
	#IBIARI_CTX_INIT2
(
ii
,
jj
,
˘x
,
èb
,
num
, 
qp
Ë\

	)

26 
	gi
=0; i<
	gii
; ++i) \

27 
	gj
=0; j<
	gjj
; ++j) \

29 
büri_öô_c⁄ãxt
 (
qp
, &(
˘x
[
i
][
j
]), 
èb
 ## 
_I
[
num
][i][j]); \

33 
	#PBIARI_CTX_INIT2
(
ii
,
jj
,
˘x
,
èb
,
num
, 
qp
Ë\

	)

35 
	gi
=0; i<
	gii
; ++i) \

36 
	gj
=0; j<
	gjj
; ++j) \

38 
büri_öô_c⁄ãxt
 (
qp
, &(
˘x
[
i
][
j
]), 
èb
 ## 
_P
[
num
][i][j]); \

43 
	#IBIARI_CTX_INIT1
(
jj
,
˘x
,
èb
,
num
, 
qp
Ë\

	)

45 
	gj
=0; j<
	gjj
; ++j) \

47 
büri_öô_c⁄ãxt
 (
qp
, &(
˘x
[
j
]), 
èb
 ## 
_I
[
num
][0][j]); \

52 
	#PBIARI_CTX_INIT1
(
jj
,
˘x
,
èb
,
num
, 
qp
Ë\

	)

55 
	gj
=0; j<
	gjj
; ++j) \

57 
büri_öô_c⁄ãxt
 (
qp
, &(
˘x
[
j
]), 
èb
 ## 
_P
[
num
][0][j]); \

62 
	$öô_c⁄ãxts
 (
Sli˚
 *
cuºSli˚
)

64 
MŸi⁄InfoC⁄ãxts
* 
mc
 = 
cuºSli˚
->
mŸ_˘x
;

65 
TextuªInfoC⁄ãxts
* 
tc
 = 
cuºSli˚
->
ãx_˘x
;

66 
i
, 
j
;

67 
qp
 = 
	`imax
(0, 
cuºSli˚
->qp);

68 
modñ_numbî
 = 
cuºSli˚
->model_number;

73 i‡((
cuºSli˚
->
¶i˚_ty≥
 =
I_SLICE
)||(cuºSli˚->¶i˚_ty≥ =
SI_SLICE
))

75 
	`IBIARI_CTX_INIT2
 (3, 
NUM_MB_TYPE_CTX
, 
mc
->
mb_ty≥_c⁄ãxts
, 
INIT_MB_TYPE
, 
modñ_numbî
, 
qp
);

76 
	`IBIARI_CTX_INIT2
 (2, 
NUM_B8_TYPE_CTX
, 
mc
->
b8_ty≥_c⁄ãxts
, 
INIT_B8_TYPE
, 
modñ_numbî
, 
qp
);

77 
	`IBIARI_CTX_INIT2
 (2, 
NUM_MV_RES_CTX
, 
mc
->
mv_ªs_c⁄ãxts
, 
INIT_MV_RES
, 
modñ_numbî
, 
qp
);

78 
	`IBIARI_CTX_INIT2
 (2, 
NUM_REF_NO_CTX
, 
mc
->
ªf_no_c⁄ãxts
, 
INIT_REF_NO
, 
modñ_numbî
, 
qp
);

79 
	`IBIARI_CTX_INIT1
 ( 
NUM_DELTA_QP_CTX
, 
mc
->
dñè_qp_c⁄ãxts
, 
INIT_DELTA_QP
, 
modñ_numbî
, 
qp
);

80 
	`IBIARI_CTX_INIT1
 ( 
NUM_MB_AFF_CTX
, 
mc
->
mb_aff_c⁄ãxts
, 
INIT_MB_AFF
, 
modñ_numbî
, 
qp
);

83 
	`IBIARI_CTX_INIT1
 ( 
NUM_TRANSFORM_SIZE_CTX
, 
tc
->
å™sf‹m_size_c⁄ãxts
, 
INIT_TRANSFORM_SIZE
, 
modñ_numbî
, 
qp
);

84 
	`IBIARI_CTX_INIT1
 ( 
NUM_IPR_CTX
, 
tc
->
ùr_c⁄ãxts
, 
INIT_IPR
, 
modñ_numbî
, 
qp
);

85 
	`IBIARI_CTX_INIT1
 ( 
NUM_CIPR_CTX
, 
tc
->
cùr_c⁄ãxts
, 
INIT_CIPR
, 
modñ_numbî
, 
qp
);

86 
	`IBIARI_CTX_INIT2
 (3, 
NUM_CBP_CTX
, 
tc
->
cbp_c⁄ãxts
, 
INIT_CBP
, 
modñ_numbî
, 
qp
);

87 
	`IBIARI_CTX_INIT2
 (
NUM_BLOCK_TYPES
, 
NUM_BCBP_CTX
, 
tc
->
bcbp_c⁄ãxts
, 
INIT_BCBP
, 
modñ_numbî
, 
qp
);

88 
	`IBIARI_CTX_INIT2
 (
NUM_BLOCK_TYPES
, 
NUM_MAP_CTX
, 
tc
->
m≠_c⁄ãxts
[0], 
INIT_MAP
, 
modñ_numbî
, 
qp
);

89 #i‡
ENABLE_FIELD_CTX


90 
	`IBIARI_CTX_INIT2
 (
NUM_BLOCK_TYPES
, 
NUM_MAP_CTX
, 
tc
->
m≠_c⁄ãxts
[1], 
INIT_FLD_MAP
, 
modñ_numbî
, 
qp
);

91 
	`IBIARI_CTX_INIT2
 (
NUM_BLOCK_TYPES
, 
NUM_LAST_CTX
, 
tc
->
œ°_c⁄ãxts
[1], 
INIT_FLD_LAST
, 
modñ_numbî
, 
qp
);

93 
	`IBIARI_CTX_INIT2
 (
NUM_BLOCK_TYPES
, 
NUM_LAST_CTX
, 
tc
->
œ°_c⁄ãxts
[0], 
INIT_LAST
, 
modñ_numbî
, 
qp
);

94 
	`IBIARI_CTX_INIT2
 (
NUM_BLOCK_TYPES
, 
NUM_ONE_CTX
, 
tc
->
⁄e_c⁄ãxts
, 
INIT_ONE
, 
modñ_numbî
, 
qp
);

95 
	`IBIARI_CTX_INIT2
 (
NUM_BLOCK_TYPES
, 
NUM_ABS_CTX
, 
tc
->
abs_c⁄ãxts
, 
INIT_ABS
, 
modñ_numbî
, 
qp
);

99 
	`PBIARI_CTX_INIT2
 (3, 
NUM_MB_TYPE_CTX
, 
mc
->
mb_ty≥_c⁄ãxts
, 
INIT_MB_TYPE
, 
modñ_numbî
, 
qp
);

100 
	`PBIARI_CTX_INIT2
 (2, 
NUM_B8_TYPE_CTX
, 
mc
->
b8_ty≥_c⁄ãxts
, 
INIT_B8_TYPE
, 
modñ_numbî
, 
qp
);

101 
	`PBIARI_CTX_INIT2
 (2, 
NUM_MV_RES_CTX
, 
mc
->
mv_ªs_c⁄ãxts
, 
INIT_MV_RES
, 
modñ_numbî
, 
qp
);

102 
	`PBIARI_CTX_INIT2
 (2, 
NUM_REF_NO_CTX
, 
mc
->
ªf_no_c⁄ãxts
, 
INIT_REF_NO
, 
modñ_numbî
, 
qp
);

103 
	`PBIARI_CTX_INIT1
 ( 
NUM_DELTA_QP_CTX
, 
mc
->
dñè_qp_c⁄ãxts
, 
INIT_DELTA_QP
, 
modñ_numbî
, 
qp
);

104 
	`PBIARI_CTX_INIT1
 ( 
NUM_MB_AFF_CTX
, 
mc
->
mb_aff_c⁄ãxts
, 
INIT_MB_AFF
, 
modñ_numbî
, 
qp
);

107 
	`PBIARI_CTX_INIT1
 ( 
NUM_TRANSFORM_SIZE_CTX
, 
tc
->
å™sf‹m_size_c⁄ãxts
, 
INIT_TRANSFORM_SIZE
, 
modñ_numbî
, 
qp
);

108 
	`PBIARI_CTX_INIT1
 ( 
NUM_IPR_CTX
, 
tc
->
ùr_c⁄ãxts
, 
INIT_IPR
, 
modñ_numbî
, 
qp
);

109 
	`PBIARI_CTX_INIT1
 ( 
NUM_CIPR_CTX
, 
tc
->
cùr_c⁄ãxts
, 
INIT_CIPR
, 
modñ_numbî
, 
qp
);

110 
	`PBIARI_CTX_INIT2
 (3, 
NUM_CBP_CTX
, 
tc
->
cbp_c⁄ãxts
, 
INIT_CBP
, 
modñ_numbî
, 
qp
);

111 
	`PBIARI_CTX_INIT2
 (
NUM_BLOCK_TYPES
, 
NUM_BCBP_CTX
, 
tc
->
bcbp_c⁄ãxts
, 
INIT_BCBP
, 
modñ_numbî
, 
qp
);

112 
	`PBIARI_CTX_INIT2
 (
NUM_BLOCK_TYPES
, 
NUM_MAP_CTX
, 
tc
->
m≠_c⁄ãxts
[0], 
INIT_MAP
, 
modñ_numbî
, 
qp
);

113 #i‡
ENABLE_FIELD_CTX


114 
	`PBIARI_CTX_INIT2
 (
NUM_BLOCK_TYPES
, 
NUM_MAP_CTX
, 
tc
->
m≠_c⁄ãxts
[1], 
INIT_FLD_MAP
, 
modñ_numbî
, 
qp
);

115 
	`PBIARI_CTX_INIT2
 (
NUM_BLOCK_TYPES
, 
NUM_LAST_CTX
, 
tc
->
œ°_c⁄ãxts
[1], 
INIT_FLD_LAST
, 
modñ_numbî
, 
qp
);

117 
	`PBIARI_CTX_INIT2
 (
NUM_BLOCK_TYPES
, 
NUM_LAST_CTX
, 
tc
->
œ°_c⁄ãxts
[0], 
INIT_LAST
, 
modñ_numbî
, 
qp
);

118 
	`PBIARI_CTX_INIT2
 (
NUM_BLOCK_TYPES
, 
NUM_ONE_CTX
, 
tc
->
⁄e_c⁄ãxts
, 
INIT_ONE
, 
modñ_numbî
, 
qp
);

119 
	`PBIARI_CTX_INIT2
 (
NUM_BLOCK_TYPES
, 
NUM_ABS_CTX
, 
tc
->
abs_c⁄ãxts
, 
INIT_ABS
, 
modñ_numbî
, 
qp
);

121 
	}
}

	@ldecod/src/dec_statistics.c

13 
	~"globÆ.h
"

14 
	~"dec_°©i°ics.h
"

15 
	~"memÆloc.h
"

26 
	$öô_dec_°©s
(
DecSètP¨amëîs
 *
°©s
)

28 
i
, 
j
;

29 
öt64
 *
hi°
;

30 
i
 = 0; i < 
NUM_SLICE_TYPES
; i++)

32 
°©s
->
‰ame_˘r
[
i
] = 0;

33 
j
 = 0; j < 
MAXMODE
; j++)

35 
°©s
->
mode_u£
 [
i
][
j
] = 0;

36 
°©s
->
mode_u£_å™sf‹m
[
i
][
j
][0] = 0;

37 
°©s
->
mode_u£_å™sf‹m
[
i
][
j
][1] = 0;

41 
i
 = 0; i < 2; i++)

43 
j
 = 0; j < 2; j++)

45 i‡((
hi°
 = (
öt64
 *Ë
	`mÆloc
 (4096 *  (öt64)))=
NULL
)

46 
	`no_mem_exô
 ("init_dec_stats: stats->histogram_mv");

47 
	`mem£t
(
hi°
, 0, 4096 *  (
öt64
));

48 
°©s
->
hi°ogøm_mv
[
i
][
j
] = 
hi°
 + 2048;

50 i‡((
hi°
 = (
öt64
 *Ë
	`mÆloc
 (17 *  (öt64)))=
NULL
)

51 
	`no_mem_exô
 ("init_dec_stats: stats->histogram_refs");

52 
	`mem£t
(
hi°
, 0, 17 *  (
öt64
));

53 
°©s
->
hi°ogøm_ªfs
[
i
] = 
hi°
 + 1;

55 
	}
}

57 
	$dñëe_dec_°©s
(
DecSètP¨amëîs
 *
°©s
)

59 
i
, 
j
;

61 
i
 = 0; i < 2; i++)

63 
j
 = 0; j < 2; j++)

65 
°©s
->
hi°ogøm_mv
[
i
][
j
] -= 2048;

66 
	`‰ì
(
°©s
->
hi°ogøm_mv
[
i
][
j
]);

68 
°©s
->
hi°ogøm_ªfs
[
i
] -= 1;

69 
	`‰ì
(
°©s
->
hi°ogøm_ªfs
[
i
]);

71 
	}
}

	@ldecod/src/decoder_test.c

14 
	~"c⁄åibut‹s.h
"

16 
	~<sys/°©.h
>

19 
	~"wö32.h
"

20 
	~"h264decodî.h
"

21 
	~"c⁄figfûe.h
"

23 
	#DECOUTPUT_TEST
 0

	)

25 
	#PRINT_OUTPUT_POC
 0

	)

26 
	#BITSTREAM_FILENAME
 "ã°.264"

	)

27 
	#DECRECON_FILENAME
 "ã°_dec.yuv"

	)

28 
	#ENCRECON_FILENAME
 "ã°_ªc.yuv"

	)

29 
	#FCFR_DEBUG_FILENAME
 "fc‰_dec_Ωu_°©s.txt"

	)

30 
	#DECOUTPUT_VIEW0_FILENAME
 "H264_Decodî_Ouçut_Võw0.yuv"

	)

31 
	#DECOUTPUT_VIEW1_FILENAME
 "H264_Decodî_Ouçut_Võw1.yuv"

	)

34 
	$C⁄figuª
(
I≈utP¨amëîs
 *
p_I≈
, 
ac
, *
av
[])

38 
	`mem£t
(
p_I≈
, 0, (
I≈utP¨amëîs
));

39 
	`°r˝y
(
p_I≈
->
öfûe
, 
BITSTREAM_FILENAME
);

40 
	`°r˝y
(
p_I≈
->
outfûe
, 
DECRECON_FILENAME
);

41 
	`°r˝y
(
p_I≈
->
ªffûe
, 
ENCRECON_FILENAME
);

43 #ifde‡
_LEAKYBUCKET_


44 
	`°r˝y
(
p_I≈
->
LókyBuckëP¨amFûe
,"leakybucketparam.cfg");

47 
	`P¨£Comm™d
(
p_I≈
, 
ac
, 
av
);

49 
	`Ârötf
(
°dout
,"----------------------------- JM %†%†-----------------------------\n", 
VERSION
, 
EXT_VERSION
);

51 if(!
p_I≈
->
bDi•œyDecP¨ams
)

53 
	`Ârötf
(
°dout
,"--------------------------------------------------------------------------\n");

54 
	`Ârötf
(
°dout
," I≈uàH.264 bô°ªam : %†\n",
p_I≈
->
öfûe
);

55 
	`Ârötf
(
°dout
," Ouçuàdecoded YUV : %†\n",
p_I≈
->
outfûe
);

57 
	`Ârötf
(
°dout
," I≈uàª„ªn˚ fûê : %†\n",
p_I≈
->
ªffûe
);

59 
	`Ârötf
(
°dout
,"--------------------------------------------------------------------------\n");

60 #ifde‡
_LEAKYBUCKET_


61 
	`Ârötf
(
°dout
," R©e_decodî : %8ld \n",
p_I≈
->
R_decodî
);

62 
	`Ârötf
(
°dout
," B_decodî : %8ld \n",
p_I≈
->
B_decodî
);

63 
	`Ârötf
(
°dout
," F_decodî : %8ld \n",
p_I≈
->
F_decodî
);

64 
	`Ârötf
(
°dout
," LókyBuckëP¨amFûe: %†\n",
p_I≈
->
LókyBuckëP¨amFûe
);

65 
	`ˇlc_buf„r
(
p_I≈
);

66 
	`Ârötf
(
°dout
,"--------------------------------------------------------------------------\n");

70 
	}
}

76 
	$WrôeO√Føme
(
DecodedPicLi°
 *
pDecPic
, 
hFûeOuçut0
, 
hFûeOuçut1
, 
bOuçutAŒFømes
)

78 
iOuçutFøme
=0;

79 
DecodedPicLi°
 *
pPic
 = 
pDecPic
;

81 if(
pPic
 && ((’Pic->
iYUVSt‹ageF‹m©
==2Ë&&ÖPic->
bVÆid
==3) || ((pPic->iYUVStorageFormat!=2) &&ÖPic->bValid==1)) )

83 
i
, 
iWidth
, 
iHeight
, 
iSåide
, 
iWidthUV
, 
iHeightUV
, 
iSåideUV
;

84 
byã
 *
pbBuf
;

85 
hFûeOuçut
;

86 
ªs
;

88 
iWidth
 = 
pPic
->iWidth*(’Pic->
iBôDïth
+7)>>3);

89 
iHeight
 = 
pPic
->iHeight;

90 
iSåide
 = 
pPic
->
iYBufSåide
;

91 if(
pPic
->
iYUVF‹m©
 !
YUV444
)

92 
iWidthUV
 = 
pPic
->
iWidth
>>1;

94 
iWidthUV
 = 
pPic
->
iWidth
;

95 if(
pPic
->
iYUVF‹m©
 =
YUV420
)

96 
iHeightUV
 = 
pPic
->
iHeight
>>1;

98 
iHeightUV
 = 
pPic
->
iHeight
;

99 
iWidthUV
 *((
pPic
->
iBôDïth
+7)>>3);

100 
iSåideUV
 = 
pPic
->
iUVBufSåide
;

104 if(
pPic
->
iYUVSt‹ageF‹m©
==2)

105 
hFûeOuçut
 = (
pPic
->
iVõwId
&0xffff)? 
hFûeOuçut1
 : 
hFûeOuçut0
;

107 
hFûeOuçut
 = 
hFûeOuçut0
;

108 if(
hFûeOuçut
 >=0)

111 
pbBuf
 = 
pPic
->
pY
;

112 
i
=0; i<
iHeight
; i++)

114 
ªs
 = 
	`wrôe
(
hFûeOuçut
, 
pbBuf
+
i
*
iSåide
, 
iWidth
);

115 i‡(-1==
ªs
)

117 
	`îr‹
 ("error writingÅo output file.", 600);

121 if(
pPic
->
iYUVF‹m©
 !
YUV400
)

124 
pbBuf
 = 
pPic
->
pU
;

125 
i
=0; i<
iHeightUV
; i++)

127 
ªs
 = 
	`wrôe
(
hFûeOuçut
, 
pbBuf
+
i
*
iSåideUV
, 
iWidthUV
);

128 i‡(-1==
ªs
)

130 
	`îr‹
 ("error writingÅo output file.", 600);

134 
pbBuf
 = 
pPic
->
pV
;

135 
i
=0; i<
iHeightUV
; i++)

137 
ªs
 = 
	`wrôe
(
hFûeOuçut
, 
pbBuf
+
i
*
iSåideUV
, 
iWidthUV
);

138 i‡(-1==
ªs
)

140 
	`îr‹
 ("error writingÅo output file.", 600);

145 
iOuçutFøme
++;

148 i‡(
pPic
->
iYUVSt‹ageF‹m©
 == 2)

150 
hFûeOuçut
 = ((
pPic
->
iVõwId
>>16)&0xffff)? 
hFûeOuçut1
 : 
hFûeOuçut0
;

151 if(
hFûeOuçut
>=0)

153 
iPicSize
 =
iHeight
*
iSåide
;

155 
pbBuf
 = 
pPic
->
pY
+
iPicSize
;

156 
i
=0; i<
iHeight
; i++)

158 
ªs
 = 
	`wrôe
(
hFûeOuçut
, 
pbBuf
+
i
*
iSåide
, 
iWidth
);

159 i‡(-1==
ªs
)

161 
	`îr‹
 ("error writingÅo output file.", 600);

165 if(
pPic
->
iYUVF‹m©
 !
YUV400
)

167 
iPicSize
 = 
iHeightUV
*
iSåideUV
;

169 
pbBuf
 = 
pPic
->
pU
+
iPicSize
;

170 
i
=0; i<
iHeightUV
; i++)

172 
ªs
 = 
	`wrôe
(
hFûeOuçut
, 
pbBuf
+
i
*
iSåideUV
, 
iWidthUV
);

173 i‡(-1==
ªs
)

175 
	`îr‹
 ("error writingÅo output file.", 600);

179 
pbBuf
 = 
pPic
->
pV
+
iPicSize
;

180 
i
=0; i<
iHeightUV
; i++)

182 
ªs
 = 
	`wrôe
(
hFûeOuçut
, 
pbBuf
+
i
*
iSåideUV
, 
iWidthUV
);

183 i‡(-1==
ªs
)

185 
	`îr‹
 ("error writingÅo output file.", 600);

190 
iOuçutFøme
++;

194 #i‡
PRINT_OUTPUT_POC


195 
	`Ârötf
(
°dout
, "\nOuçuà‰ame: %d/%d\n", 
pPic
->
iPOC
,ÖPic->
iVõwId
);

197 
pPic
->
bVÆid
 = 0;

198 
pPic
 =ÖPic->
pNext
;

199 }
pPic
 !
NULL
 &&ÖPic->
bVÆid
 && 
bOuçutAŒFømes
);

201 #i‡
PRINT_OUTPUT_POC


203 
	`Ârötf
(
°dout
, "\nNone frame output\n");

206  
iOuçutFøme
;

207 
	}
}

215 
	$maö
(
¨gc
, **
¨gv
)

217 
iRë
;

218 
DecodedPicLi°
 *
pDecPicLi°
;

219 
hFûeDecOuçut0
=-1, 
hFûeDecOuçut1
=-1;

220 
iFømesOuçut
=0, 
iFømesDecoded
=0;

221 
I≈utP¨amëîs
 
I≈utP¨ams
;

223 #i‡
DECOUTPUT_TEST


224 
hFûeDecOuçut0
 = 
	`›í
(
DECOUTPUT_VIEW0_FILENAME
, 
OPENFLAGS_WRITE
, 
OPEN_PERMISSIONS
);

225 
	`Ârötf
(
°dout
, "Decodî ouçuàvõw0: %s\n", 
DECOUTPUT_VIEW0_FILENAME
);

226 
hFûeDecOuçut1
 = 
	`›í
(
DECOUTPUT_VIEW1_FILENAME
, 
OPENFLAGS_WRITE
, 
OPEN_PERMISSIONS
);

227 
	`Ârötf
(
°dout
, "Decodî ouçuàvõw1: %s\n", 
DECOUTPUT_VIEW1_FILENAME
);

230 
	`öô_time
();

233 
	`C⁄figuª
(&
I≈utP¨ams
, 
¨gc
, 
¨gv
);

235 
iRë
 = 
	`O≥nDecodî
(&
I≈utP¨ams
);

236 if(
iRë
 !
DEC_OPEN_NOERR
)

238 
	`Ârötf
(
°dîr
, "O≥¿ícodî faûed: 0x%x!\n", 
iRë
);

245 
iRë
 = 
	`DecodeO√Føme
(&
pDecPicLi°
);

246 if(
iRë
==
DEC_EOS
 || iRë==
DEC_SUCCEED
)

249 
iFømesOuçut
 +
	`WrôeO√Føme
(
pDecPicLi°
, 
hFûeDecOuçut0
, 
hFûeDecOuçut1
, 0);

250 
iFømesDecoded
++;

255 
	`Ârötf
(
°dîr
, "Eº‹ i¿decodögÖro˚ss: 0x%x\n", 
iRë
);

257 }(
iRë
 =
DEC_SUCCEED
Ë&& ((
p_Dec
->
p_I≈
->
iDecFrmNum
==0Ë|| (
iFømesDecoded
<p_Dec->p_Inp->iDecFrmNum)));

259 
iRë
 = 
	`FöôDecodî
(&
pDecPicLi°
);

260 
iFømesOuçut
 +
	`WrôeO√Føme
(
pDecPicLi°
, 
hFûeDecOuçut0
, 
hFûeDecOuçut1
 , 1);

261 
iRë
 = 
	`Clo£Decodî
();

264 if(
hFûeDecOuçut0
>=0)

266 
	`˛o£
(
hFûeDecOuçut0
);

268 if(
hFûeDecOuçut1
>=0)

270 
	`˛o£
(
hFûeDecOuçut1
);

273 
	`¥ötf
("%d føme†¨êdecoded.\n", 
iFømesDecoded
);

275 
	}
}

	@ldecod/src/erc_api.c

18 
	~"globÆ.h
"

19 
	~"memÆloc.h
"

20 
	~"îc_≠i.h
"

21 
	~"Á°_mem‹y.h
"

29 
	$îcInô
(
VideoP¨amëîs
 *
p_Vid
, 
pic_sizex
, 
pic_sizey
, 
Êag
)

31 
	`îcClo£
(
p_Vid
,Ö_Vid->
îc_îr‹V¨
);

32 
p_Vid
->
îc_obje˘_li°
 = (
obje˘Buf„r_t
 *Ë
	`ˇŒoc
((
pic_sizex
 * 
pic_sizey
) >> 6, (objectBuffer_t));

33 i‡(
p_Vid
->
îc_obje˘_li°
 =
NULL
Ë
	`no_mem_exô
("ercInit:Érc_object_list");

36 
p_Vid
->
îc_îr‹V¨
 = 
	`îcO≥n
();

39 
	`îcSëEº‹C⁄˚Æmít
(
p_Vid
->
îc_îr‹V¨
, 
Êag
);

40 
	}
}

50 
îcV¨übÀs_t
 *
	$îcO≥n
( )

52 
îcV¨übÀs_t
 *
îr‹V¨
 = 
NULL
;

54 
îr‹V¨
 = (
îcV¨übÀs_t
 *)
	`mÆloc
( (ercVariables_t));

55 i‡–
îr‹V¨
 =
NULL
 ) 
	`no_mem_exô
("ercOpen:ÉrrorVar");

57 
îr‹V¨
->
nOfMBs
 = 0;

58 
îr‹V¨
->
£gmíts
 = 
NULL
;

59 
îr‹V¨
->
cuºSegmít
 = 0;

60 
îr‹V¨
->
yC⁄dôi⁄
 = 
NULL
;

61 
îr‹V¨
->
uC⁄dôi⁄
 = 
NULL
;

62 
îr‹V¨
->
vC⁄dôi⁄
 = 
NULL
;

63 
îr‹V¨
->
¥evFømeYC⁄dôi⁄
 = 
NULL
;

65 
îr‹V¨
->
c⁄˚Æmít
 = 1;

67  
îr‹V¨
;

68 
	}
}

85 
	$îcRe£t
–
îcV¨übÀs_t
 *
îr‹V¨
, 
nOfMBs
, 
numOfSegmíts
, 
picSizeX
 )

87 *
tmp
 = 
NULL
;

88 
i
 = 0;

90 i‡–
îr‹V¨
 &&Éº‹V¨->
c⁄˚Æmít
 )

92 
îcSegmít_t
 *
£gmíts
 = 
NULL
;

94 i‡–
nOfMBs
 !
îr‹V¨
->nOfMB†&&Éº‹V¨->
yC⁄dôi⁄
 !
NULL
 )

96 
	`‰ì
–
îr‹V¨
->
yC⁄dôi⁄
 );

97 
îr‹V¨
->
yC⁄dôi⁄
 = 
NULL
;

98 
	`‰ì
–
îr‹V¨
->
¥evFømeYC⁄dôi⁄
 );

99 
îr‹V¨
->
¥evFømeYC⁄dôi⁄
 = 
NULL
;

100 
	`‰ì
–
îr‹V¨
->
uC⁄dôi⁄
 );

101 
îr‹V¨
->
uC⁄dôi⁄
 = 
NULL
;

102 
	`‰ì
–
îr‹V¨
->
vC⁄dôi⁄
 );

103 
îr‹V¨
->
vC⁄dôi⁄
 = 
NULL
;

104 
	`‰ì
–
îr‹V¨
->
£gmíts
 );

105 
îr‹V¨
->
£gmíts
 = 
NULL
;

109 i‡–
îr‹V¨
->
yC⁄dôi⁄
 =
NULL
 )

111 
îr‹V¨
->
£gmíts
 = (
îcSegmít_t
 *)
	`mÆloc
–
numOfSegmíts
*(ercSegment_t) );

112 i‡–
îr‹V¨
->
£gmíts
 =
NULL
 ) 
	`no_mem_exô
("ercReset:ÉrrorVar->segments");

113 
	`Á°_mem£t
–
îr‹V¨
->
£gmíts
, 0, 
numOfSegmíts
*(
îcSegmít_t
));

114 
îr‹V¨
->
nOfSegmíts
 = 
numOfSegmíts
;

116 
îr‹V¨
->
yC⁄dôi⁄
 = (*)
	`mÆloc
–4*
nOfMBs
*() );

117 i‡–
îr‹V¨
->
yC⁄dôi⁄
 =
NULL
 ) 
	`no_mem_exô
("ercReset:ÉrrorVar->yCondition");

118 
îr‹V¨
->
¥evFømeYC⁄dôi⁄
 = (*)
	`mÆloc
–4*
nOfMBs
*() );

119 i‡–
îr‹V¨
->
¥evFømeYC⁄dôi⁄
 =
NULL
 ) 
	`no_mem_exô
("ercReset:ÉrrorVar->prevFrameYCondition");

120 
îr‹V¨
->
uC⁄dôi⁄
 = (*)
	`mÆloc
–
nOfMBs
*() );

121 i‡–
îr‹V¨
->
uC⁄dôi⁄
 =
NULL
 ) 
	`no_mem_exô
("ercReset:ÉrrorVar->uCondition");

122 
îr‹V¨
->
vC⁄dôi⁄
 = (*)
	`mÆloc
–
nOfMBs
*() );

123 i‡–
îr‹V¨
->
vC⁄dôi⁄
 =
NULL
 ) 
	`no_mem_exô
("ercReset:ÉrrorVar->vCondition");

124 
îr‹V¨
->
nOfMBs
 =ÇOfMBs;

129 
tmp
 = 
îr‹V¨
->
¥evFømeYC⁄dôi⁄
;

130 
îr‹V¨
->
¥evFømeYC⁄dôi⁄
 =Éº‹V¨->
yC⁄dôi⁄
;

131 
îr‹V¨
->
yC⁄dôi⁄
 = 
tmp
;

135 
	`Á°_mem£t
–
îr‹V¨
->
yC⁄dôi⁄
, 0, 4*
nOfMBs
*(*errorVar->yCondition));

136 
	`Á°_mem£t
–
îr‹V¨
->
uC⁄dôi⁄
, 0, 
nOfMBs
*(*errorVar->uCondition));

137 
	`Á°_mem£t
–
îr‹V¨
->
vC⁄dôi⁄
, 0, 
nOfMBs
*(*errorVar->vCondition));

139 i‡(
îr‹V¨
->
nOfSegmíts
 !
numOfSegmíts
)

141 
	`‰ì
–
îr‹V¨
->
£gmíts
 );

142 
îr‹V¨
->
£gmíts
 = 
NULL
;

143 
îr‹V¨
->
£gmíts
 = (
îcSegmít_t
 *)
	`mÆloc
–
numOfSegmíts
*(ercSegment_t) );

144 i‡–
îr‹V¨
->
£gmíts
 =
NULL
 ) 
	`no_mem_exô
("ercReset:ÉrrorVar->segments");

145 
îr‹V¨
->
nOfSegmíts
 = 
numOfSegmíts
;

150 
£gmíts
 = 
îr‹V¨
->segments;

151  
i
 = 0; i < 
îr‹V¨
->
nOfSegmíts
; i++ )

153 
£gmíts
->
°¨tMBPos
 = 0;

154 
£gmíts
->
ídMBPos
 = (Ë(
nOfMBs
 - 1);

155 (
£gmíts
++)->
fC‹ru±ed
 = 1;

158 
îr‹V¨
->
cuºSegmít
 = 0;

159 
îr‹V¨
->
nOfC‹ru±edSegmíts
 = 0;

161 
	}
}

174 
	$îcClo£
(
VideoP¨amëîs
 *
p_Vid
, 
îcV¨übÀs_t
 *
îr‹V¨
 )

176 i‡–
îr‹V¨
 !
NULL
 )

178 i‡(
îr‹V¨
->
yC⁄dôi⁄
 !
NULL
)

180 
	`‰ì
–
îr‹V¨
->
£gmíts
 );

181 
	`‰ì
–
îr‹V¨
->
yC⁄dôi⁄
 );

182 
	`‰ì
–
îr‹V¨
->
uC⁄dôi⁄
 );

183 
	`‰ì
–
îr‹V¨
->
vC⁄dôi⁄
 );

184 
	`‰ì
–
îr‹V¨
->
¥evFømeYC⁄dôi⁄
 );

186 
	`‰ì
–
îr‹V¨
 );

187 
îr‹V¨
 = 
NULL
;

190 i‡(
p_Vid
->
îc_obje˘_li°
)

192 
	`‰ì
(
p_Vid
->
îc_obje˘_li°
);

193 
p_Vid
->
îc_obje˘_li°
=
NULL
;

195 
	}
}

207 
	$îcSëEº‹C⁄˚Æmít
–
îcV¨übÀs_t
 *
îr‹V¨
, 
vÆue
 )

209 i‡–
îr‹V¨
 !
NULL
 )

210 
îr‹V¨
->
c⁄˚Æmít
 = 
vÆue
;

211 
	}
}

230 
	$îcSèπSegmít
–
cuºMBNum
, 
£gmít
, 
bôPos
, 
îcV¨übÀs_t
 *
îr‹V¨
 )

232 i‡–
îr‹V¨
 &&Éº‹V¨->
c⁄˚Æmít
 )

234 
îr‹V¨
->
cuºSegmítC‹ru±ed
 = 0;

236 
îr‹V¨
->
£gmíts
[ 
£gmít
 ].
fC‹ru±ed
 = 0;

237 
îr‹V¨
->
£gmíts
[ 
£gmít
 ].
°¨tMBPos
 = (Ë
cuºMBNum
;

240 
	}
}

257 
	$îcSt›Segmít
–
cuºMBNum
, 
£gmít
, 
bôPos
, 
îcV¨übÀs_t
 *
îr‹V¨
 )

259 i‡–
îr‹V¨
 &&Éº‹V¨->
c⁄˚Æmít
 )

261 
îr‹V¨
->
£gmíts
[ 
£gmít
 ].
ídMBPos
 = (Ë
cuºMBNum
;

262 
îr‹V¨
->
cuºSegmít
++;

264 
	}
}

277 
	$îcM¨kCuºSegmítLo°
(
picSizeX
, 
îcV¨übÀs_t
 *
îr‹V¨
 )

279 
j
 = 0;

280 
cuºít_£gmít
;

282 
cuºít_£gmít
 = 
îr‹V¨
->
cuºSegmít
-1;

283 i‡–
îr‹V¨
 &&Éº‹V¨->
c⁄˚Æmít
 )

285 i‡(
îr‹V¨
->
cuºSegmítC‹ru±ed
 == 0)

287 
îr‹V¨
->
nOfC‹ru±edSegmíts
++;

288 
îr‹V¨
->
cuºSegmítC‹ru±ed
 = 1;

291  
j
 = 
îr‹V¨
->
£gmíts
[
cuºít_£gmít
].
°¨tMBPos
; j <îr‹V¨->£gmíts[cuºít_£gmít].
ídMBPos
; j++ )

293 
îr‹V¨
->
yC⁄dôi⁄
[
	`MBNum2YBlock
 (
j
, 0, 
picSizeX
)] = 
ERC_BLOCK_CORRUPTED
;

294 
îr‹V¨
->
yC⁄dôi⁄
[
	`MBNum2YBlock
 (
j
, 1, 
picSizeX
)] = 
ERC_BLOCK_CORRUPTED
;

295 
îr‹V¨
->
yC⁄dôi⁄
[
	`MBNum2YBlock
 (
j
, 2, 
picSizeX
)] = 
ERC_BLOCK_CORRUPTED
;

296 
îr‹V¨
->
yC⁄dôi⁄
[
	`MBNum2YBlock
 (
j
, 3, 
picSizeX
)] = 
ERC_BLOCK_CORRUPTED
;

297 
îr‹V¨
->
uC⁄dôi⁄
[
j
] = 
ERC_BLOCK_CORRUPTED
;

298 
îr‹V¨
->
vC⁄dôi⁄
[
j
] = 
ERC_BLOCK_CORRUPTED
;

300 
îr‹V¨
->
£gmíts
[
cuºít_£gmít
].
fC‹ru±ed
 = 1;

302 
	}
}

315 
	$îcM¨kCuºSegmítOK
(
picSizeX
, 
îcV¨übÀs_t
 *
îr‹V¨
 )

317 
j
 = 0;

318 
cuºít_£gmít
;

320 
cuºít_£gmít
 = 
îr‹V¨
->
cuºSegmít
-1;

321 i‡–
îr‹V¨
 &&Éº‹V¨->
c⁄˚Æmít
 )

324  
j
 = 
îr‹V¨
->
£gmíts
[
cuºít_£gmít
].
°¨tMBPos
; j <îr‹V¨->£gmíts[cuºít_£gmít].
ídMBPos
; j++ )

326 
îr‹V¨
->
yC⁄dôi⁄
[
	`MBNum2YBlock
 (
j
, 0, 
picSizeX
)] = 
ERC_BLOCK_OK
;

327 
îr‹V¨
->
yC⁄dôi⁄
[
	`MBNum2YBlock
 (
j
, 1, 
picSizeX
)] = 
ERC_BLOCK_OK
;

328 
îr‹V¨
->
yC⁄dôi⁄
[
	`MBNum2YBlock
 (
j
, 2, 
picSizeX
)] = 
ERC_BLOCK_OK
;

329 
îr‹V¨
->
yC⁄dôi⁄
[
	`MBNum2YBlock
 (
j
, 3, 
picSizeX
)] = 
ERC_BLOCK_OK
;

330 
îr‹V¨
->
uC⁄dôi⁄
[
j
] = 
ERC_BLOCK_OK
;

331 
îr‹V¨
->
vC⁄dôi⁄
[
j
] = 
ERC_BLOCK_OK
;

333 
îr‹V¨
->
£gmíts
[
cuºít_£gmít
].
fC‹ru±ed
 = 0;

335 
	}
}

351 
	$îcM¨kCuºMBC⁄˚Æed
–
cuºMBNum
, 
comp
, 
picSizeX
, 
îcV¨übÀs_t
 *
îr‹V¨
 )

353 
£tAŒ
 = 0;

355 i‡–
îr‹V¨
 &&Éº‹V¨->
c⁄˚Æmít
 )

357 i‡(
comp
 < 0)

359 
£tAŒ
 = 1;

360 
comp
 = 0;

363 
comp
)

366 
îr‹V¨
->
yC⁄dôi⁄
[
	`MBNum2YBlock
 (
cuºMBNum
, 0, 
picSizeX
)] = 
ERC_BLOCK_CONCEALED
;

367 
îr‹V¨
->
yC⁄dôi⁄
[
	`MBNum2YBlock
 (
cuºMBNum
, 1, 
picSizeX
)] = 
ERC_BLOCK_CONCEALED
;

368 
îr‹V¨
->
yC⁄dôi⁄
[
	`MBNum2YBlock
 (
cuºMBNum
, 2, 
picSizeX
)] = 
ERC_BLOCK_CONCEALED
;

369 
îr‹V¨
->
yC⁄dôi⁄
[
	`MBNum2YBlock
 (
cuºMBNum
, 3, 
picSizeX
)] = 
ERC_BLOCK_CONCEALED
;

370 i‡(!
£tAŒ
)

373 
îr‹V¨
->
uC⁄dôi⁄
[
cuºMBNum
] = 
ERC_BLOCK_CONCEALED
;

374 i‡(!
£tAŒ
)

377 
îr‹V¨
->
vC⁄dôi⁄
[
cuºMBNum
] = 
ERC_BLOCK_CONCEALED
;

380 
	}
}

	@ldecod/src/erc_do_i.c

18 
	~"globÆ.h
"

19 
	~"îc_do.h
"

21 
c⁄˚ÆBlocks
 ( 
VideoP¨amëîs
 *
p_Vid
, 
œ°Cﬁumn
, 
œ°Row
, 
comp
, 
‰ame
 *
ªc‰
, 
picSizeX
, *
c⁄dôi⁄
 );

22 
pixMónI¡îpﬁ©eBlock
–
VideoP¨amëîs
 *
p_Vid
, 
img≥l
 *
§c
[], img≥»*
block
, 
blockSize
, 
‰ameWidth
 );

44 
	$îcC⁄˚ÆI¡øFøme
–
VideoP¨amëîs
 *
p_Vid
, 
‰ame
 *
ªc‰
, 
picSizeX
, 
picSizeY
, 
îcV¨übÀs_t
 *
îr‹V¨
 )

46 
œ°Cﬁumn
 = 0, 
œ°Row
 = 0;

49 i‡–
îr‹V¨
 &&Éº‹V¨->
c⁄˚Æmít
 )

52 i‡–
îr‹V¨
->
nOfC‹ru±edSegmíts
 )

55 
œ°Row
 = (Ë(
picSizeY
>>3);

56 
œ°Cﬁumn
 = (Ë(
picSizeX
>>3);

57 
	`c⁄˚ÆBlocks
–
p_Vid
, 
œ°Cﬁumn
, 
œ°Row
, 0, 
ªc‰
, 
picSizeX
, 
îr‹V¨
->
yC⁄dôi⁄
 );

60 
œ°Row
 = (Ë(
picSizeY
>>4);

61 
œ°Cﬁumn
 = (Ë(
picSizeX
>>4);

62 
	`c⁄˚ÆBlocks
–
p_Vid
, 
œ°Cﬁumn
, 
œ°Row
, 1, 
ªc‰
, 
picSizeX
, 
îr‹V¨
->
uC⁄dôi⁄
 );

65 
	`c⁄˚ÆBlocks
–
p_Vid
, 
œ°Cﬁumn
, 
œ°Row
, 2, 
ªc‰
, 
picSizeX
, 
îr‹V¨
->
vC⁄dôi⁄
 );

71 
	}
}

94 
	$îcPixC⁄˚ÆIMB
(
VideoP¨amëîs
 *
p_Vid
, 
img≥l
 *
cuºFøme
, 
row
, 
cﬁumn
, 
¥edBlocks
[], 
‰ameWidth
, 
mbWidthInBlocks
)

96 
img≥l
 *
§c
[8]={
NULL
,NULL,NULL,NULL,NULL,NULL,NULL,NULL};

97 
img≥l
 *
cuºBlock
 = 
NULL
;

100 i‡(
¥edBlocks
[0])

101 
§c
[0] = 
cuºFøme
 + (
row
-
mbWidthInBlocks
)*
‰ameWidth
*8 + (
cﬁumn
+mbWidthInBlocks)*8;

102 i‡(
¥edBlocks
[1])

103 
§c
[1] = 
cuºFøme
 + (
row
-
mbWidthInBlocks
)*
‰ameWidth
*8 + (
cﬁumn
-mbWidthInBlocks)*8;

104 i‡(
¥edBlocks
[2])

105 
§c
[2] = 
cuºFøme
 + (
row
+
mbWidthInBlocks
)*
‰ameWidth
*8 + (
cﬁumn
-mbWidthInBlocks)*8;

106 i‡(
¥edBlocks
[3])

107 
§c
[3] = 
cuºFøme
 + (
row
+
mbWidthInBlocks
)*
‰ameWidth
*8 + (
cﬁumn
+mbWidthInBlocks)*8;

108 i‡(
¥edBlocks
[4])

109 
§c
[4] = 
cuºFøme
 + (
row
-
mbWidthInBlocks
)*
‰ameWidth
*8 + 
cﬁumn
*8;

110 i‡(
¥edBlocks
[5])

111 
§c
[5] = 
cuºFøme
 + 
row
*
‰ameWidth
*8 + (
cﬁumn
-
mbWidthInBlocks
)*8;

112 i‡(
¥edBlocks
[6])

113 
§c
[6] = 
cuºFøme
 + (
row
+
mbWidthInBlocks
)*
‰ameWidth
*8 + 
cﬁumn
*8;

114 i‡(
¥edBlocks
[7])

115 
§c
[7] = 
cuºFøme
 + 
row
*
‰ameWidth
*8 + (
cﬁumn
+
mbWidthInBlocks
)*8;

117 
cuºBlock
 = 
cuºFøme
 + 
row
*
‰ameWidth
*8 + 
cﬁumn
*8;

118 
	`pixMónI¡îpﬁ©eBlock
–
p_Vid
, 
§c
, 
cuºBlock
, 
mbWidthInBlocks
*8, 
‰ameWidth
 );

119 
	}
}

154 
	$îcCﬁÀ˘8PªdBlocks
–
¥edBlocks
[], 
cuºRow
, 
cuºCﬁumn
, *
c⁄dôi⁄
,

155 
maxRow
, 
maxCﬁumn
, 
°ï
, 
byã
 
fNoC‹√rNeigh
 )

157 
§cCou¡î
 = 0;

158 
§cCou¡Mö
 = (
fNoC‹√rNeigh
 ? 2 : 4);

159 
thªshﬁd
 = 
ERC_BLOCK_OK
;

161 
	`mem£t
–
¥edBlocks
, 0, 8*() );

166 
§cCou¡î
 = 0;

168 i‡(
cuºRow
 > 0 && 
c⁄dôi⁄
[ (cuºRow-1)*
maxCﬁumn
 + 
cuºCﬁumn
 ] >
thªshﬁd
 )

170 
¥edBlocks
[4] = 
c⁄dôi⁄
[ (
cuºRow
-1)*
maxCﬁumn
 + 
cuºCﬁumn
 ];

171 
§cCou¡î
++;

174 i‡–
cuºRow
 < (
maxRow
-
°ï
Ë&& 
c⁄dôi⁄
[ (cuºRow+°ï)*
maxCﬁumn
 + 
cuºCﬁumn
 ] >
thªshﬁd
 )

176 
¥edBlocks
[6] = 
c⁄dôi⁄
[ (
cuºRow
+
°ï
)*
maxCﬁumn
 + 
cuºCﬁumn
 ];

177 
§cCou¡î
++;

180 i‡–
cuºCﬁumn
 > 0 )

183 i‡–
c⁄dôi⁄
[ 
cuºRow
*
maxCﬁumn
 + 
cuºCﬁumn
 - 1 ] >
thªshﬁd
 )

185 
¥edBlocks
[5] = 
c⁄dôi⁄
[ 
cuºRow
*
maxCﬁumn
 + 
cuºCﬁumn
 - 1 ];

186 
§cCou¡î
++;

189 i‡–!
fNoC‹√rNeigh
 )

192 i‡–
cuºRow
 > 0 && 
c⁄dôi⁄
[ (cuºRow-1)*
maxCﬁumn
 + 
cuºCﬁumn
 - 1 ] >
thªshﬁd
 )

194 
¥edBlocks
[1] = 
c⁄dôi⁄
[ (
cuºRow
-1)*
maxCﬁumn
 + 
cuºCﬁumn
 - 1 ];

195 
§cCou¡î
++;

198 i‡–
cuºRow
 < (
maxRow
-
°ï
Ë&& 
c⁄dôi⁄
[ (cuºRow+°ï)*
maxCﬁumn
 + 
cuºCﬁumn
 - 1 ] >
thªshﬁd
 )

200 
¥edBlocks
[2] = 
c⁄dôi⁄
[ (
cuºRow
+
°ï
)*
maxCﬁumn
 + 
cuºCﬁumn
 - 1 ];

201 
§cCou¡î
++;

206 i‡–
cuºCﬁumn
 < (
maxCﬁumn
-
°ï
) )

209 i‡–
c⁄dôi⁄
[ 
cuºRow
*
maxCﬁumn
+
cuºCﬁumn
 + 
°ï
 ] >
thªshﬁd
 )

211 
¥edBlocks
[7] = 
c⁄dôi⁄
[ 
cuºRow
*
maxCﬁumn
+
cuºCﬁumn
 + 
°ï
 ];

212 
§cCou¡î
++;

215 i‡–!
fNoC‹√rNeigh
 )

218 i‡–
cuºRow
 > 0 && 
c⁄dôi⁄
[ (cuºRow-1)*
maxCﬁumn
 + 
cuºCﬁumn
 + 
°ï
 ] >
thªshﬁd
 )

220 
¥edBlocks
[0] = 
c⁄dôi⁄
[ (
cuºRow
-1)*
maxCﬁumn
 + 
cuºCﬁumn
 + 
°ï
 ];

221 
§cCou¡î
++;

224 i‡–
cuºRow
 < (
maxRow
-
°ï
Ë&& 
c⁄dôi⁄
[ (cuºRow+°ï)*
maxCﬁumn
 + 
cuºCﬁumn
 + sã∞] >
thªshﬁd
 )

226 
¥edBlocks
[3] = 
c⁄dôi⁄
[ (
cuºRow
+
°ï
)*
maxCﬁumn
 + 
cuºCﬁumn
 + step ];

227 
§cCou¡î
++;

232 
thªshﬁd
--;

233 i‡(
thªshﬁd
 < 
ERC_BLOCK_CONCEALED
)

235 }  
§cCou¡î
 < 
§cCou¡Mö
);

237  
§cCou¡î
;

238 
	}
}

263 
	$îcCﬁÀ˘CﬁumnBlocks
–
¥edBlocks
[], 
cuºRow
, 
cuºCﬁumn
, *
c⁄dôi⁄
, 
maxRow
, 
maxCﬁumn
, 
°ï
 )

265 
§cCou¡î
 = 0, 
thªshﬁd
 = 
ERC_BLOCK_CORRUPTED
;

267 
	`mem£t
–
¥edBlocks
, 0, 8*() );

270 i‡–
c⁄dôi⁄
[ (
cuºRow
-1)*
maxCﬁumn
 + 
cuºCﬁumn
 ] > 
thªshﬁd
 )

272 
¥edBlocks
[4] = 1;

273 
§cCou¡î
++;

275 i‡–
c⁄dôi⁄
[ (
cuºRow
+
°ï
)*
maxCﬁumn
 + 
cuºCﬁumn
 ] > 
thªshﬁd
 )

277 
¥edBlocks
[6] = 1;

278 
§cCou¡î
++;

281  
§cCou¡î
;

282 
	}
}

309 
	$c⁄˚ÆBlocks
–
VideoP¨amëîs
 *
p_Vid
, 
œ°Cﬁumn
, 
œ°Row
, 
comp
, 
‰ame
 *
ªc‰
, 
picSizeX
, *
c⁄dôi⁄
 )

311 
row
, 
cﬁumn
, 
§cCou¡î
 = 0, 
thr
 = 
ERC_BLOCK_CORRUPTED
,

312 
œ°C‹ru±edRow
 = -1, 
fú°C‹ru±edRow
 = -1, 
cuºRow
 = 0,

313 
¨óHeight
 = 0, 
i
 = 0, 
smoŸhCﬁumn
 = 0;

314 
¥edBlocks
[8], 
°ï
 = 1;

318 i‡–
comp
 == 0 )

319 
°ï
 = 2;

321 
°ï
 = 1;

323  
cﬁumn
 = 0; cﬁum¿< 
œ°Cﬁumn
; cﬁum¿+
°ï
 )

325  
row
 = 0;Ñow < 
œ°Row
;Ñow +
°ï
 )

327 i‡–
c⁄dôi⁄
[
row
*
œ°Cﬁumn
+
cﬁumn
] <
thr
 )

329 
fú°C‹ru±edRow
 = 
row
;

331  
œ°C‹ru±edRow
 = 
row
+
°ï
;Üa°C‹ru±edRow < 
œ°Row
;ÜastCorruptedRow += step )

334 i‡–
c⁄dôi⁄
[ 
œ°C‹ru±edRow
*
œ°Cﬁumn
 + 
cﬁumn
 ] > 
thr
 )

337 
œ°C‹ru±edRow
 -
°ï
;

341 i‡–
œ°C‹ru±edRow
 >
œ°Row
 )

344 
œ°C‹ru±edRow
 = 
œ°Row
-
°ï
;

345  
cuºRow
 = 
fú°C‹ru±edRow
; cuºRow < 
œ°Row
; cuºRow +
°ï
 )

347 
§cCou¡î
 = 
	`îcCﬁÀ˘8PªdBlocks
–
¥edBlocks
, 
cuºRow
, 
cﬁumn
, 
c⁄dôi⁄
, 
œ°Row
, 
œ°Cﬁumn
, 
°ï
, 1 );

349  
comp
 )

352 
	`îcPixC⁄˚ÆIMB
–
p_Vid
, 
ªc‰
->
y±r
, 
cuºRow
, 
cﬁumn
, 
¥edBlocks
, 
picSizeX
, 2 );

355 
	`îcPixC⁄˚ÆIMB
–
p_Vid
, 
ªc‰
->
u±r
, 
cuºRow
, 
cﬁumn
, 
¥edBlocks
, (
picSizeX
>>1), 1 );

358 
	`îcPixC⁄˚ÆIMB
–
p_Vid
, 
ªc‰
->
v±r
, 
cuºRow
, 
cﬁumn
, 
¥edBlocks
, (
picSizeX
>>1), 1 );

362 i‡–
comp
 == 0 )

364 
c⁄dôi⁄
[ 
cuºRow
*
œ°Cﬁumn
+
cﬁumn
] = 
ERC_BLOCK_CONCEALED
;

365 
c⁄dôi⁄
[ 
cuºRow
*
œ°Cﬁumn
+
cﬁumn
 + 1] = 
ERC_BLOCK_CONCEALED
;

366 
c⁄dôi⁄
[ 
cuºRow
*
œ°Cﬁumn
+
cﬁumn
 +Üa°Cﬁumn] = 
ERC_BLOCK_CONCEALED
;

367 
c⁄dôi⁄
[ 
cuºRow
*
œ°Cﬁumn
+
cﬁumn
 +Üa°Cﬁum¿+ 1] = 
ERC_BLOCK_CONCEALED
;

371 
c⁄dôi⁄
[ 
cuºRow
*
œ°Cﬁumn
+
cﬁumn
] = 
ERC_BLOCK_CONCEALED
;

375 
row
 = 
œ°Row
;

377 i‡–
fú°C‹ru±edRow
 == 0 )

380  
cuºRow
 = 
œ°C‹ru±edRow
; cuºRow >0; cuºRow -
°ï
 )

382 
§cCou¡î
 = 
	`îcCﬁÀ˘8PªdBlocks
–
¥edBlocks
, 
cuºRow
, 
cﬁumn
, 
c⁄dôi⁄
, 
œ°Row
, 
œ°Cﬁumn
, 
°ï
, 1 );

384  
comp
 )

387 
	`îcPixC⁄˚ÆIMB
–
p_Vid
, 
ªc‰
->
y±r
, 
cuºRow
, 
cﬁumn
, 
¥edBlocks
, 
picSizeX
, 2 );

390 
	`îcPixC⁄˚ÆIMB
–
p_Vid
, 
ªc‰
->
u±r
, 
cuºRow
, 
cﬁumn
, 
¥edBlocks
, (
picSizeX
>>1), 1 );

393 
	`îcPixC⁄˚ÆIMB
–
p_Vid
, 
ªc‰
->
v±r
, 
cuºRow
, 
cﬁumn
, 
¥edBlocks
, (
picSizeX
>>1), 1 );

397 i‡–
comp
 == 0 )

399 
c⁄dôi⁄
[ 
cuºRow
*
œ°Cﬁumn
+
cﬁumn
] = 
ERC_BLOCK_CONCEALED
;

400 
c⁄dôi⁄
[ 
cuºRow
*
œ°Cﬁumn
+
cﬁumn
 + 1] = 
ERC_BLOCK_CONCEALED
;

401 
c⁄dôi⁄
[ 
cuºRow
*
œ°Cﬁumn
+
cﬁumn
 +Üa°Cﬁumn] = 
ERC_BLOCK_CONCEALED
;

402 
c⁄dôi⁄
[ 
cuºRow
*
œ°Cﬁumn
+
cﬁumn
 +Üa°Cﬁum¿+ 1] = 
ERC_BLOCK_CONCEALED
;

406 
c⁄dôi⁄
[ 
cuºRow
*
œ°Cﬁumn
+
cﬁumn
] = 
ERC_BLOCK_CONCEALED
;

411 
row
 = 
œ°C‹ru±edRow
+
°ï
;

417 
row
 = 
œ°C‹ru±edRow
+
°ï
;

418 
¨óHeight
 = 
œ°C‹ru±edRow
-
fú°C‹ru±edRow
+
°ï
;

421  
i
 = 0; i < 
¨óHeight
; i +
°ï
 )

423 i‡–
i
 % 2 )

425 
cuºRow
 = 
œ°C‹ru±edRow
;

426 
œ°C‹ru±edRow
 -
°ï
;

430 
cuºRow
 = 
fú°C‹ru±edRow
;

431 
fú°C‹ru±edRow
 +
°ï
;

434 i‡(
smoŸhCﬁumn
 > 0)

436 
§cCou¡î
 = 
	`îcCﬁÀ˘CﬁumnBlocks
–
¥edBlocks
, 
cuºRow
, 
cﬁumn
, 
c⁄dôi⁄
, 
œ°Row
, 
œ°Cﬁumn
, 
°ï
 );

440 
§cCou¡î
 = 
	`îcCﬁÀ˘8PªdBlocks
–
¥edBlocks
, 
cuºRow
, 
cﬁumn
, 
c⁄dôi⁄
, 
œ°Row
, 
œ°Cﬁumn
, 
°ï
, 1 );

443  
comp
 )

446 
	`îcPixC⁄˚ÆIMB
–
p_Vid
, 
ªc‰
->
y±r
, 
cuºRow
, 
cﬁumn
, 
¥edBlocks
, 
picSizeX
, 2 );

450 
	`îcPixC⁄˚ÆIMB
–
p_Vid
, 
ªc‰
->
u±r
, 
cuºRow
, 
cﬁumn
, 
¥edBlocks
, (
picSizeX
>>1), 1 );

454 
	`îcPixC⁄˚ÆIMB
–
p_Vid
, 
ªc‰
->
v±r
, 
cuºRow
, 
cﬁumn
, 
¥edBlocks
, (
picSizeX
>>1), 1 );

458 i‡–
comp
 == 0 )

460 
c⁄dôi⁄
[ 
cuºRow
*
œ°Cﬁumn
+
cﬁumn
] = 
ERC_BLOCK_CONCEALED
;

461 
c⁄dôi⁄
[ 
cuºRow
*
œ°Cﬁumn
+
cﬁumn
 + 1] = 
ERC_BLOCK_CONCEALED
;

462 
c⁄dôi⁄
[ 
cuºRow
*
œ°Cﬁumn
+
cﬁumn
 +Üa°Cﬁumn] = 
ERC_BLOCK_CONCEALED
;

463 
c⁄dôi⁄
[ 
cuºRow
*
œ°Cﬁumn
+
cﬁumn
 +Üa°Cﬁum¿+ 1] = 
ERC_BLOCK_CONCEALED
;

467 
c⁄dôi⁄
[ 
cuºRow
*
œ°Cﬁumn
+
cﬁumn
 ] = 
ERC_BLOCK_CONCEALED
;

472 
œ°C‹ru±edRow
 = -1;

473 
fú°C‹ru±edRow
 = -1;

478 
	}
}

497 
	$pixMónI¡îpﬁ©eBlock
–
VideoP¨amëîs
 *
p_Vid
, 
img≥l
 *
§c
[], img≥»*
block
, 
blockSize
, 
‰ameWidth
 )

499 
row
, 
cﬁumn
, 
k
, 
tmp
, 
§cCou¡î
 = 0, 
weight
 = 0, 
bmax
 = 
blockSize
 - 1;

501 
k
 = 0;

502  
row
 = 0;Ñow < 
blockSize
;Ñow++ )

504  
cﬁumn
 = 0; cﬁum¿< 
blockSize
; column++ )

506 
tmp
 = 0;

507 
§cCou¡î
 = 0;

509 i‡–
§c
[4] !
NULL
 )

511 
weight
 = 
blockSize
-
row
;

512 
tmp
 +
weight
 * (*(
§c
[4]+
bmax
*
‰ameWidth
+
cﬁumn
));

513 
§cCou¡î
 +
weight
;

516 i‡–
§c
[5] !
NULL
 )

518 
weight
 = 
blockSize
-
cﬁumn
;

519 
tmp
 +
weight
 * (*(
§c
[5]+
row
*
‰ameWidth
+
bmax
));

520 
§cCou¡î
 +
weight
;

523 i‡–
§c
[6] !
NULL
 )

525 
weight
 = 
row
+1;

526 
tmp
 +
weight
 * (*(
§c
[6]+
cﬁumn
));

527 
§cCou¡î
 +
weight
;

530 i‡–
§c
[7] !
NULL
 )

532 
weight
 = 
cﬁumn
+1;

533 
tmp
 +
weight
 * (*(
§c
[7]+
row
*
‰ameWidth
));

534 
§cCou¡î
 +
weight
;

537 i‡–
§cCou¡î
 > 0 )

538 
block
[ 
k
 + 
cﬁumn
 ] = (
img≥l
)(
tmp
/
§cCou¡î
);

540 
block
[ 
k
 + 
cﬁumn
 ] = (
img≥l
Ë(
blockSize
 =8 ? 
p_Vid
->
dc_¥ed_vÆue_comp
[1] :Ö_Vid->dc_pred_value_comp[0]);

542 
k
 +
‰ameWidth
;

544 
	}
}

	@ldecod/src/erc_do_p.c

21 
	~"globÆ.h
"

22 
	~"mbuf„r.h
"

23 
	~"memÆloc.h
"

24 
	~"îc_do.h
"

25 
	~"image.h
"

26 
	~"mc_¥edi˘i⁄.h
"

27 
	~"ma¸oblock.h
"

31 
c⁄˚ÆByC›y
(
‰ame
 *
ªc‰
, 
cuºMBNum
, 
obje˘Buf„r_t
 *
obje˘_li°
, 
picSizeX
);

32 
c⁄˚ÆByTrül
(
‰ame
 *
ªc‰
, 
img≥l
 *
¥edMB
,

33 
cuºMBNum
, 
obje˘Buf„r_t
 *
obje˘_li°
, 
¥edBlocks
[],

34 
picSizeX
, 
picSizeY
, *
yC⁄dôi⁄
);

35 
edgeDi°‹ti⁄
 (
¥edBlocks
[], 
cuºYBlockNum
, 
img≥l
 *
¥edMB
,

36 
img≥l
 *
ªcY
, 
picSizeX
, 
ªgi⁄Size
);

37 
c›yBëwìnFømes
 (
‰ame
 *
ªc‰
, 
cuºYBlockNum
, 
picSizeX
, 
ªgi⁄Size
);

38 
buûdPªdRegi⁄YUV
(
VideoP¨amëîs
 *
p_Vid
, *
mv
, 
x
, 
y
, 
img≥l
 *
¥edMB
);

41 
buûdPªdblockRegi⁄YUV
(
VideoP¨amëîs
 *
p_Vid
, *
mv
,

42 
x
, 
y
, 
img≥l
 *
¥edMB
, 
li°
, 
mb
);

43 
C›yImgD©a
(
img≥l
 **
öputY
, img≥»***
öputUV
, img≥»**
ouçutY
, img≥»***
ouçutUV
,

44 
img_width
, 
img_height
, 
img_width_¸
, 
img_height_¸
);

46 
c›yPªdMB
 (
cuºYBlockNum
, 
img≥l
 *
¥edMB
, 
‰ame
 *
ªc‰
,

47 
picSizeX
, 
ªgi⁄Size
);

48 
add_node
 ( 
VideoP¨amëîs
 *
p_Vid
, 
c⁄˚Æmít_node
 *
±r
 );

49 
dñëe_node
–
VideoP¨amëîs
 *
p_Vid
, 
c⁄˚Æmít_node
 *
±r
 );

51 c⁄° 
	guv_div
[2][4] = {{0, 1, 1, 0}, {0, 1, 0, 0}};

74 
	$îcC⁄˚ÆI¡îFøme
(
‰ame
 *
ªc‰
, 
obje˘Buf„r_t
 *
obje˘_li°
,

75 
picSizeX
, 
picSizeY
, 
îcV¨übÀs_t
 *
îr‹V¨
, 
chroma_f‹m©_idc
 )

77 
VideoP¨amëîs
 *
p_Vid
 = 
ªc‰
->p_Vid;

78 
œ°Cﬁumn
 = 0, 
œ°Row
 = 0, 
¥edBlocks
[8];

79 
œ°C‹ru±edRow
 = -1, 
fú°C‹ru±edRow
 = -1;

80 
cuºRow
 = 0, 
row
, 
cﬁumn
, 
cﬁumnInd
, 
¨óHeight
 = 0, 
i
 = 0;

81 
img≥l
 *
¥edMB
;

84 i‡–
îr‹V¨
 &&Éº‹V¨->
c⁄˚Æmít
 )

87 i‡–
îr‹V¨
->
nOfC‹ru±edSegmíts
 )

89 i‡(
chroma_f‹m©_idc
 !
YUV400
)

90 
¥edMB
 = (
img≥l
 *Ë
	`mÆloc
 ( (256 + (
p_Vid
->
mb_¸_size
)*2) *  (imgpel));

92 
¥edMB
 = (
img≥l
 *Ë
	`mÆloc
(256 *  (imgpel));

94 i‡–
¥edMB
 =
NULL
 ) 
	`no_mem_exô
("ercConcealInterFrame:ÖredMB");

96 
œ°Row
 = (Ë(
picSizeY
>>4);

97 
œ°Cﬁumn
 = (Ë(
picSizeX
>>4);

99  
cﬁumnInd
 = 0; cﬁumnInd < 
œ°Cﬁumn
; columnInd ++)

102 
cﬁumn
 = ((
cﬁumnInd
%2Ë? (
œ°Cﬁumn
 - columnInd/2 -1) : (columnInd/2));

104  
row
 = 0;Ñow < 
œ°Row
;Ñow++)

107 i‡–
îr‹V¨
->
yC⁄dôi⁄
[
	`MBxy2YBlock
(
cﬁumn
, 
row
, 0, 
picSizeX
)] <
ERC_BLOCK_CORRUPTED
 )

109 
fú°C‹ru±edRow
 = 
row
;

111  
œ°C‹ru±edRow
 = 
row
+1;Üa°C‹ru±edRow < 
œ°Row
;ÜastCorruptedRow++)

114 i‡(
îr‹V¨
->
yC⁄dôi⁄
[
	`MBxy2YBlock
(
cﬁumn
, 
œ°C‹ru±edRow
, 0, 
picSizeX
)] > 
ERC_BLOCK_CORRUPTED
)

117 
œ°C‹ru±edRow
 --;

121 i‡–
œ°C‹ru±edRow
 >
œ°Row
 )

124 
œ°C‹ru±edRow
 = 
œ°Row
-1;

125  
cuºRow
 = 
fú°C‹ru±edRow
; cuºRow < 
œ°Row
; currRow++ )

128 
	`îcCﬁÀ˘8PªdBlocks
 (
¥edBlocks
, (
cuºRow
<<1), (
cﬁumn
<<1),

129 
îr‹V¨
->
yC⁄dôi⁄
, (
œ°Row
<<1), (
œ°Cﬁumn
<<1), 2, 0);

131 if(
p_Vid
->
îc_mv≥rMB
 >
MVPERMB_THR
)

132 
	`c⁄˚ÆByTrül
(
ªc‰
, 
¥edMB
,

133 
cuºRow
*
œ°Cﬁumn
+
cﬁumn
, 
obje˘_li°
, 
¥edBlocks
,

134 
picSizeX
, 
picSizeY
,

135 
îr‹V¨
->
yC⁄dôi⁄
);

137 
	`c⁄˚ÆByC›y
(
ªc‰
, 
cuºRow
*
œ°Cﬁumn
+
cﬁumn
,

138 
obje˘_li°
, 
picSizeX
);

140 
	`îcM¨kCuºMBC⁄˚Æed
 (
cuºRow
*
œ°Cﬁumn
+
cﬁumn
, -1, 
picSizeX
, 
îr‹V¨
);

142 
row
 = 
œ°Row
;

144 i‡–
fú°C‹ru±edRow
 == 0 )

147  
cuºRow
 = 
œ°C‹ru±edRow
; currRow >= 0; currRow-- )

150 
	`îcCﬁÀ˘8PªdBlocks
 (
¥edBlocks
, (
cuºRow
<<1), (
cﬁumn
<<1),

151 
îr‹V¨
->
yC⁄dôi⁄
, (
œ°Row
<<1), (
œ°Cﬁumn
<<1), 2, 0);

153 if(
p_Vid
->
îc_mv≥rMB
 >
MVPERMB_THR
)

154 
	`c⁄˚ÆByTrül
(
ªc‰
, 
¥edMB
,

155 
cuºRow
*
œ°Cﬁumn
+
cﬁumn
, 
obje˘_li°
, 
¥edBlocks
,

156 
picSizeX
, 
picSizeY
,

157 
îr‹V¨
->
yC⁄dôi⁄
);

159 
	`c⁄˚ÆByC›y
(
ªc‰
, 
cuºRow
*
œ°Cﬁumn
+
cﬁumn
,

160 
obje˘_li°
, 
picSizeX
);

162 
	`îcM¨kCuºMBC⁄˚Æed
 (
cuºRow
*
œ°Cﬁumn
+
cﬁumn
, -1, 
picSizeX
, 
îr‹V¨
);

165 
row
 = 
œ°C‹ru±edRow
+1;

171 
row
 = 
œ°C‹ru±edRow
+1;

173 
¨óHeight
 = 
œ°C‹ru±edRow
-
fú°C‹ru±edRow
+1;

178  
i
 = 0; i < 
¨óHeight
; i++)

180 i‡–
i
 % 2 )

182 
cuºRow
 = 
œ°C‹ru±edRow
;

183 
œ°C‹ru±edRow
 --;

187 
cuºRow
 = 
fú°C‹ru±edRow
;

188 
fú°C‹ru±edRow
 ++;

191 
	`îcCﬁÀ˘8PªdBlocks
 (
¥edBlocks
, (
cuºRow
<<1), (
cﬁumn
<<1),

192 
îr‹V¨
->
yC⁄dôi⁄
, (
œ°Row
<<1), (
œ°Cﬁumn
<<1), 2, 0);

194 if(
p_Vid
->
îc_mv≥rMB
 >
MVPERMB_THR
)

195 
	`c⁄˚ÆByTrül
(
ªc‰
, 
¥edMB
,

196 
cuºRow
*
œ°Cﬁumn
+
cﬁumn
, 
obje˘_li°
, 
¥edBlocks
,

197 
picSizeX
, 
picSizeY
,

198 
îr‹V¨
->
yC⁄dôi⁄
);

200 
	`c⁄˚ÆByC›y
(
ªc‰
, 
cuºRow
*
œ°Cﬁumn
+
cﬁumn
,

201 
obje˘_li°
, 
picSizeX
);

203 
	`îcM¨kCuºMBC⁄˚Æed
 (
cuºRow
*
œ°Cﬁumn
+
cﬁumn
, -1, 
picSizeX
, 
îr‹V¨
);

207 
œ°C‹ru±edRow
 = -1;

208 
fú°C‹ru±edRow
 = -1;

213 
	`‰ì
(
¥edMB
);

219 
	}
}

239 
	$c⁄˚ÆByC›y
(
‰ame
 *
ªc‰
, 
cuºMBNum
,

240 
obje˘Buf„r_t
 *
obje˘_li°
, 
picSizeX
)

242 
obje˘Buf„r_t
 *
cuºRegi⁄
;

244 
cuºRegi⁄
 = 
obje˘_li°
+(
cuºMBNum
<<2);

245 
cuºRegi⁄
->
ªgi⁄Mode
 = 
REGMODE_INTER_COPY
;

247 
cuºRegi⁄
->
xMö
 = (
	`xPosMB
(
cuºMBNum
,
picSizeX
)<<4);

248 
cuºRegi⁄
->
yMö
 = (
	`yPosMB
(
cuºMBNum
,
picSizeX
)<<4);

250 
	`c›yBëwìnFømes
 (
ªc‰
, 
	`MBNum2YBlock
(
cuºMBNum
,0,
picSizeX
),ÖicSizeX, 16);

253 
	}
}

270 
	$c›yBëwìnFømes
 (
‰ame
 *
ªc‰
, 
cuºYBlockNum
, 
picSizeX
, 
ªgi⁄Size
)

272 
VideoP¨amëîs
 *
p_Vid
 = 
ªc‰
->p_Vid;

273 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
p_Vid
->dec_picture;

274 
j
, 
k
, 
loˇti⁄
, 
xmö
, 
ymö
;

275 
St‹abÀPi˘uª
* 
ªfPic
 = 
p_Vid
->
µSli˚Li°
[0]->
li°X
[0][0];

278 
xmö
 = (
	`xPosYBlock
(
cuºYBlockNum
,
picSizeX
)<<3);

279 
ymö
 = (
	`yPosYBlock
(
cuºYBlockNum
,
picSizeX
)<<3);

281 
j
 = 
ymö
; j < ymö + 
ªgi⁄Size
; j++)

282 
k
 = 
xmö
; k < xmö + 
ªgi⁄Size
; k++)

284 
loˇti⁄
 = 
j
 * 
picSizeX
 + 
k
;

286 
ªc‰
->
y±r
[
loˇti⁄
] = 
ªfPic
->
imgY
[
j
][
k
];

289 
j
 = 
ymö
 >> 
uv_div
[1][
dec_pi˘uª
->
chroma_f‹m©_idc
]; j < (ymö + 
ªgi⁄Size
) >> uv_div[1][dec_picture->chroma_format_idc]; j++)

290 
k
 = 
xmö
 >> 
uv_div
[0][
dec_pi˘uª
->
chroma_f‹m©_idc
]; k < (xmö + 
ªgi⁄Size
) >> uv_div[0][dec_picture->chroma_format_idc]; k++)

293 
loˇti⁄
 = ((
j
 * 
picSizeX
Ë>> 
uv_div
[0][
dec_pi˘uª
->
chroma_f‹m©_idc
]Ë+ 
k
;

297 
ªc‰
->
u±r
[
loˇti⁄
] = 
ªfPic
->
imgUV
[0][
j
][
k
];

298 
ªc‰
->
v±r
[
loˇti⁄
] = 
ªfPic
->
imgUV
[1][
j
][
k
];

300 
	}
}

329 
	$c⁄˚ÆByTrül
(
‰ame
 *
ªc‰
, 
img≥l
 *
¥edMB
,

330 
cuºMBNum
, 
obje˘Buf„r_t
 *
obje˘_li°
, 
¥edBlocks
[],

331 
picSizeX
, 
picSizeY
, *
yC⁄dôi⁄
)

333 
VideoP¨amëîs
 *
p_Vid
 = 
ªc‰
->p_Vid;

335 
¥edMBNum
 = 0, 
numMBPîLöe
,

336 
compS∂ô1
 = 0, 
compS∂ô2
 = 0, 
compLe·
 = 1, 
comp
 = 0, 
compPªd
, 
‹dî
 = 1,

337 
fI¡îNeighb‹Exi°s
, 
numI¡øNeighbours
,

338 
fZîoMŸi⁄Checked
, 
¥edS∂ôãd
 = 0,

339 
thªshﬁd
 = 
ERC_BLOCK_OK
,

340 
möDi°
, 
cuºDi°
, 
i
, 
k
;

341 
ªgi⁄Size
;

342 
obje˘Buf„r_t
 *
cuºRegi⁄
;

343 
mvBe°
[3] = {0, 0, 0}, 
mvPªd
[3] = {0, 0, 0}, *
mv±r
;

345 
numMBPîLöe
 = (Ë(
picSizeX
>>4);

347 
comp
 = 0;

348 
ªgi⁄Size
 = 16;

353 
cuºRegi⁄
 = 
obje˘_li°
+(
cuºMBNum
<<2)+
comp
;

357 
cuºRegi⁄
->
xMö
 = (
	`xPosYBlock
(
	`MBNum2YBlock
(
cuºMBNum
,
comp
,
picSizeX
),picSizeX)<<3);

358 
cuºRegi⁄
->
yMö
 = (
	`yPosYBlock
(
	`MBNum2YBlock
(
cuºMBNum
,
comp
,
picSizeX
),picSizeX)<<3);

363 
möDi°
 = 0;

364 
fI¡îNeighb‹Exi°s
 = 0;

365 
numI¡øNeighbours
 = 0;

366 
fZîoMŸi⁄Checked
 = 0;

369 
i
 = 4; i < 8; i++)

373 i‡(
¥edBlocks
[
i
] >
thªshﬁd
)

375 
i
)

378 
¥edMBNum
 = 
cuºMBNum
-
numMBPîLöe
;

379 
compS∂ô1
 = 2;

380 
compS∂ô2
 = 3;

384 
¥edMBNum
 = 
cuºMBNum
-1;

385 
compS∂ô1
 = 1;

386 
compS∂ô2
 = 3;

390 
¥edMBNum
 = 
cuºMBNum
+
numMBPîLöe
;

391 
compS∂ô1
 = 0;

392 
compS∂ô2
 = 1;

396 
¥edMBNum
 = 
cuºMBNum
+1;

397 
compS∂ô1
 = 0;

398 
compS∂ô2
 = 2;

404 i‡(
	`isBlock
(
obje˘_li°
,
¥edMBNum
,
compS∂ô1
,
INTRA
) ||

405 
	`isBlock
(
obje˘_li°
,
¥edMBNum
,
compS∂ô2
,
INTRA
))

407 
numI¡øNeighbours
++;

412 
¥edS∂ôãd
 = 
	`isS∂ôãd
(
obje˘_li°
, 
¥edMBNum
),

413 
compPªd
 = 
compS∂ô1
;

414 
¥edS∂ôãd
 >= 0;

415 
compPªd
 = 
compS∂ô2
,

416 
¥edS∂ôãd
 -((
compS∂ô1
 =
compS∂ô2
) ? 2 : 1))

420 i‡(
	`isBlock
(
obje˘_li°
, 
¥edMBNum
, 
compPªd
, 
INTER_COPY
))

423 i‡(
fZîoMŸi⁄Checked
)

429 
fZîoMŸi⁄Checked
 = 1;

431 
mvPªd
[0] = mvPred[1] = 0;

432 
mvPªd
[2] = 0;

434 
	`buûdPªdRegi⁄YUV
(
p_Vid
->
îc_img
, 
mvPªd
, 
cuºRegi⁄
->
xMö
, cuºRegi⁄->
yMö
, 
¥edMB
);

438 i‡(
	`isBlock
(
obje˘_li°
,
¥edMBNum
,
compPªd
,
INTRA
))

444 
mv±r
 = 
	`gëP¨am
(
obje˘_li°
, 
¥edMBNum
, 
compPªd
, 
mv
);

446 
mvPªd
[0] = 
mv±r
[0];

447 
mvPªd
[1] = 
mv±r
[1];

448 
mvPªd
[2] = 
mv±r
[2];

450 
	`buûdPªdRegi⁄YUV
(
p_Vid
->
îc_img
, 
mvPªd
, 
cuºRegi⁄
->
xMö
, cuºRegi⁄->
yMö
, 
¥edMB
);

454 
cuºDi°
 = 
	`edgeDi°‹ti⁄
(
¥edBlocks
,

455 
	`MBNum2YBlock
(
cuºMBNum
,
comp
,
picSizeX
),

456 
¥edMB
, 
ªc‰
->
y±r
, 
picSizeX
, 
ªgi⁄Size
);

459 i‡(
cuºDi°
 < 
möDi°
 || !
fI¡îNeighb‹Exi°s
)

462 
möDi°
 = 
cuºDi°
;

464 
k
=0;k<3;k++)

465 
mvBe°
[
k
] = 
mvPªd
[k];

467 
cuºRegi⁄
->
ªgi⁄Mode
 =

468 (
	`isBlock
(
obje˘_li°
, 
¥edMBNum
, 
compPªd
, 
INTER_COPY
)) ?

469 ((
ªgi⁄Size
 =16Ë? 
REGMODE_INTER_COPY
 : 
REGMODE_INTER_COPY_8x8
) :

470 ((
ªgi⁄Size
 =16Ë? 
REGMODE_INTER_PRED
 : 
REGMODE_INTER_PRED_8x8
);

472 
	`c›yPªdMB
(
	`MBNum2YBlock
(
cuºMBNum
,
comp
,
picSizeX
), 
¥edMB
, 
ªc‰
,

473 
picSizeX
, 
ªgi⁄Size
);

476 
fI¡îNeighb‹Exi°s
 = 1;

482 
thªshﬁd
--;

484 } (
thªshﬁd
 >
ERC_BLOCK_CONCEALED
Ë&& (
fI¡îNeighb‹Exi°s
 == 0));

487 i‡(!
fZîoMŸi⁄Checked
)

489 
mvPªd
[0] = mvPred[1] = 0;

490 
mvPªd
[2] = 0;

492 
	`buûdPªdRegi⁄YUV
(
p_Vid
->
îc_img
, 
mvPªd
, 
cuºRegi⁄
->
xMö
, cuºRegi⁄->
yMö
, 
¥edMB
);

494 
cuºDi°
 = 
	`edgeDi°‹ti⁄
(
¥edBlocks
,

495 
	`MBNum2YBlock
(
cuºMBNum
,
comp
,
picSizeX
),

496 
¥edMB
, 
ªc‰
->
y±r
, 
picSizeX
, 
ªgi⁄Size
);

498 i‡(
cuºDi°
 < 
möDi°
 || !
fI¡îNeighb‹Exi°s
)

501 
möDi°
 = 
cuºDi°
;

502 
k
=0;k<3;k++)

503 
mvBe°
[
k
] = 
mvPªd
[k];

505 
cuºRegi⁄
->
ªgi⁄Mode
 =

506 ((
ªgi⁄Size
 =16Ë? 
REGMODE_INTER_COPY
 : 
REGMODE_INTER_COPY_8x8
);

508 
	`c›yPªdMB
(
	`MBNum2YBlock
(
cuºMBNum
,
comp
,
picSizeX
), 
¥edMB
, 
ªc‰
,

509 
picSizeX
, 
ªgi⁄Size
);

513 
i
=0; i<3; i++)

514 
cuºRegi⁄
->
mv
[
i
] = 
mvBe°
[i];

516 
yC⁄dôi⁄
[
	`MBNum2YBlock
(
cuºMBNum
,
comp
,
picSizeX
)] = 
ERC_BLOCK_CONCEALED
;

517 
comp
 = (comp+
‹dî
+4)%4;

518 
compLe·
--;

520 } 
compLe·
);

523 
	}
}

545 
	$buûdPªdRegi⁄YUV
(
VideoP¨amëîs
 *
p_Vid
, *
mv
, 
x
, 
y
, 
img≥l
 *
¥edMB
)

547 
img≥l
 **
tmp_block
;

548 
i
=0, 
j
=0, 
ii
=0, 
jj
=0,
i1
=0,
j1
=0,
j4
=0,
i4
=0;

549 
uv
;

550 
vec1_x
=0,
vec1_y
=0;

551 
ioff
,
joff
;

552 
img≥l
 *
pMB
 = 
¥edMB
;

553 
Sli˚
 *
cuºSli˚
;

554 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
p_Vid
->dec_picture;

555 
ii0
,
jj0
,
ii1
,
jj1
,
if1
,
jf1
,
if0
,
jf0
;

556 
mv_mul
;

559 
f1_x
, 
f1_y
, 
f2_x
, 
f2_y
, 
f3
, 
f4
;

560 
b8
, 
b4
;

561 
yuv
 = 
dec_pi˘uª
->
chroma_f‹m©_idc
 - 1;

563 
ªf_‰ame
 = 
	`imax
 (
mv
[2], 0);

564 
mb_ƒ
 = 
y
/16*(
p_Vid
->
width
/16)+
x
/16;

565 **
tmp_ªs
 = 
NULL
;

567 
Ma¸oblock
 *
cuºMB
 = &
p_Vid
->
mb_d©a
[
mb_ƒ
];

568 
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

569 
tmp_ªs
 = 
cuºSli˚
->tmp_res;

572 
	`gë_mem2D≥l
(&
tmp_block
, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE);

575 
cuºMB
->
mb
.
x
 = (Ë(x/
MB_BLOCK_SIZE
);

576 
cuºMB
->
mb
.
y
 = (Ë(y/
MB_BLOCK_SIZE
);

577 
cuºMB
->
block_y
 = cuºMB->
mb
.
y
 * 
BLOCK_SIZE
;

578 
cuºMB
->
pix_c_y
 = cuºMB->
mb
.
y
 * 
p_Vid
->
mb_¸_size_y
;

579 
cuºMB
->
block_x
 = cuºMB->
mb
.
x
 * 
BLOCK_SIZE
;

580 
cuºMB
->
pix_c_x
 = cuºMB->
mb
.
x
 * 
p_Vid
->
mb_¸_size_x
;

582 
mv_mul
=4;

586 
j
=0;j<
MB_BLOCK_SIZE
/
BLOCK_SIZE
;j++)

588 
joff
=
j
*4;

589 
j4
=
cuºMB
->
block_y
+
j
;

590 
i
=0;i<
MB_BLOCK_SIZE
/
BLOCK_SIZE
;i++)

592 
ioff
=
i
*4;

593 
i4
=
cuºMB
->
block_x
+
i
;

595 
vec1_x
 = 
i4
*4*
mv_mul
 + 
mv
[0];

596 
vec1_y
 = 
j4
*4*
mv_mul
 + 
mv
[1];

598 
	`gë_block_luma
(
cuºSli˚
->
li°X
[0][
ªf_‰ame
], 
vec1_x
, 
vec1_y
, 
BLOCK_SIZE
, BLOCK_SIZE,

599 
tmp_block
,

600 
dec_pi˘uª
->
iLumaSåide
,dec_pi˘uª->
size_x_m1
,

601 (
cuºMB
->
mb_fõld
Ë? (
dec_pi˘uª
->
size_y
 >> 1Ë- 1 : dec_pi˘uª->
size_y_m1
,
tmp_ªs
,

602 
p_Vid
->
max_≥l_vÆue_comp
[
PLANE_Y
],(
img≥l
Ëp_Vid->
dc_¥ed_vÆue_comp
[PLANE_Y], 
cuºMB
);

604 
ii
=0;ii<
BLOCK_SIZE
;ii++)

605 
jj
=0;jj<
MB_BLOCK_SIZE
/
BLOCK_SIZE
;jj++)

606 
cuºSli˚
->
mb_¥ed
[
LumaComp
][
jj
+
joff
][
ii
+
ioff
]=
tmp_block
[jj][ii];

611 
j
 = 0; j < 16; j++)

613 
i
 = 0; i < 16; i++)

615 
pMB
[
j
*16+
i
] = 
cuºSli˚
->
mb_¥ed
[
LumaComp
][j][i];

618 
pMB
 += 256;

620 i‡(
dec_pi˘uª
->
chroma_f‹m©_idc
 !
YUV400
)

623 
f1_x
 = 64/
p_Vid
->
mb_¸_size_x
;

624 
f2_x
=
f1_x
-1;

626 
f1_y
 = 64/
p_Vid
->
mb_¸_size_y
;

627 
f2_y
=
f1_y
-1;

629 
f3
=
f1_x
*
f1_y
;

630 
f4
=
f3
>>1;

632 
uv
=0;uv<2;uv++)

634 
b8
=0;b8<(
p_Vid
->
num_uv_blocks
);b8++)

636 
b4
=0;b4<4;b4++)

638 
joff
 = 
subblk_off£t_y
[
yuv
][
b8
][
b4
];

639 
j4
=
cuºMB
->
pix_c_y
+
joff
;

640 
ioff
 = 
subblk_off£t_x
[
yuv
][
b8
][
b4
];

641 
i4
=
cuºMB
->
pix_c_x
+
ioff
;

643 
jj
=0;jj<4;jj++)

645 
ii
=0;ii<4;ii++)

647 
i1
=(
i4
+
ii
)*
f1_x
 + 
mv
[0];

648 
j1
=(
j4
+
jj
)*
f1_y
 + 
mv
[1];

650 
ii0
=
	`iClù3
 (0, 
dec_pi˘uª
->
size_x_¸
-1, 
i1
/
f1_x
);

651 
jj0
=
	`iClù3
 (0, 
dec_pi˘uª
->
size_y_¸
-1, 
j1
/
f1_y
);

652 
ii1
=
	`iClù3
 (0, 
dec_pi˘uª
->
size_x_¸
-1, ((
i1
+
f2_x
)/
f1_x
));

653 
jj1
=
	`iClù3
 (0, 
dec_pi˘uª
->
size_y_¸
-1, ((
j1
+
f2_y
)/
f1_y
));

655 
if1
=(
i1
 & 
f2_x
);

656 
jf1
=(
j1
 & 
f2_y
);

657 
if0
=
f1_x
-
if1
;

658 
jf0
=
f1_y
-
jf1
;

660 
cuºSli˚
->
mb_¥ed
[
uv
 + 1][
jj
+
joff
][
ii
+
ioff
] = (
img≥l
)

661 ((
if0
*
jf0
*
cuºSli˚
->
li°X
[0][
ªf_‰ame
]->
imgUV
[
uv
][
jj0
][
ii0
]+

662 
if1
*
jf0
*
cuºSli˚
->
li°X
[0][
ªf_‰ame
]->
imgUV
[
uv
][
jj0
][
ii1
]+

663 
if0
*
jf1
*
cuºSli˚
->
li°X
[0][
ªf_‰ame
]->
imgUV
[
uv
][
jj1
][
ii0
]+

664 
if1
*
jf1
*
cuºSli˚
->
li°X
[0][
ªf_‰ame
]->
imgUV
[
uv
][
jj1
][
ii1
]+
f4
)/
f3
);

670 
j
 = 0; j < 8; j++)

672 
i
 = 0; i < 8; i++)

674 
pMB
[
j
*8+
i
] = 
cuºSli˚
->
mb_¥ed
[
uv
 + 1][j][i];

677 
pMB
 += 64;

682 
	`‰ì_mem2D≥l
(
tmp_block
);

683 
	}
}

703 
	$c›yPªdMB
 (
cuºYBlockNum
, 
img≥l
 *
¥edMB
, 
‰ame
 *
ªc‰
,

704 
picSizeX
, 
ªgi⁄Size
)

706 
VideoP¨amëîs
 *
p_Vid
 = 
ªc‰
->p_Vid;

707 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
p_Vid
->dec_picture;

708 
j
, 
k
, 
xmö
, 
ymö
, 
xmax
, 
ymax
;

709 
loˇti⁄Tmp
;

710 
uv_x
 = 
uv_div
[0][
dec_pi˘uª
->
chroma_f‹m©_idc
];

711 
uv_y
 = 
uv_div
[1][
dec_pi˘uª
->
chroma_f‹m©_idc
];

713 
xmö
 = (
	`xPosYBlock
(
cuºYBlockNum
,
picSizeX
)<<3);

714 
ymö
 = (
	`yPosYBlock
(
cuºYBlockNum
,
picSizeX
)<<3);

715 
xmax
 = 
xmö
 + 
ªgi⁄Size
 -1;

716 
ymax
 = 
ymö
 + 
ªgi⁄Size
 -1;

718 
j
 = 
ymö
; j <
ymax
; j++)

720 
k
 = 
xmö
; k <
xmax
; k++)

722 
loˇti⁄Tmp
 = (
j
-
ymö
Ë* 16 + (
k
-
xmö
);

723 
dec_pi˘uª
->
imgY
[
j
][
k
] = 
¥edMB
[
loˇti⁄Tmp
];

727 i‡(
dec_pi˘uª
->
chroma_f‹m©_idc
 !
YUV400
)

729 
j
 = (
ymö
>>
uv_y
); j <(
ymax
>>uv_y); j++)

731 
k
 = (
xmö
>>
uv_x
); k <(
xmax
>>uv_x); k++)

733 
loˇti⁄Tmp
 = (
j
-(
ymö
>>
uv_y
)Ë* 
p_Vid
->
mb_¸_size_x
 + (
k
-(
xmö
>>1)) + 256;

734 
dec_pi˘uª
->
imgUV
[0][
j
][
k
] = 
¥edMB
[
loˇti⁄Tmp
];

736 
loˇti⁄Tmp
 += 64;

738 
dec_pi˘uª
->
imgUV
[1][
j
][
k
] = 
¥edMB
[
loˇti⁄Tmp
];

742 
	}
}

771 
	$edgeDi°‹ti⁄
 (
¥edBlocks
[], 
cuºYBlockNum
, 
img≥l
 *
¥edMB
,

772 
img≥l
 *
ªcY
, 
picSizeX
, 
ªgi⁄Size
)

774 
i
, 
j
, 
di°‹ti⁄
, 
numOfPªdBlocks
, 
thªshﬁd
 = 
ERC_BLOCK_OK
;

775 
img≥l
 *
cuºBlock
 = 
NULL
, *
√ighb‹
 = NULL;

776 
cuºBlockOff£t
 = 0;

778 
cuºBlock
 = 
ªcY
 + (
	`yPosYBlock
(
cuºYBlockNum
,
picSizeX
)<<3)*picSizeX + (
	`xPosYBlock
(currYBlockNum,picSizeX)<<3);

783 
di°‹ti⁄
 = 0; 
numOfPªdBlocks
 = 0;

786 
j
 = 4; j < 8; j++)

789 i‡(
¥edBlocks
[
j
] >
thªshﬁd
)

792 
j
)

795 
√ighb‹
 = 
cuºBlock
 - 
picSizeX
;

796  
i
 = 0; i < 
ªgi⁄Size
; i++ )

798 
di°‹ti⁄
 +
	`übs
(()(
¥edMB
[
i
] - 
√ighb‹
[i]));

802 
√ighb‹
 = 
cuºBlock
 - 1;

803  
i
 = 0; i < 
ªgi⁄Size
; i++ )

805 
di°‹ti⁄
 +
	`übs
(()(
¥edMB
[
i
*16] - 
√ighb‹
[i*
picSizeX
]));

809 
√ighb‹
 = 
cuºBlock
 + 
ªgi⁄Size
*
picSizeX
;

810 
cuºBlockOff£t
 = (
ªgi⁄Size
-1)*16;

811  
i
 = 0; i < 
ªgi⁄Size
; i++ )

813 
di°‹ti⁄
 +
	`übs
(()(
¥edMB
[
i
+
cuºBlockOff£t
] - 
√ighb‹
[i]));

817 
√ighb‹
 = 
cuºBlock
 + 
ªgi⁄Size
;

818 
cuºBlockOff£t
 = 
ªgi⁄Size
-1;

819  
i
 = 0; i < 
ªgi⁄Size
; i++ )

821 
di°‹ti⁄
 +
	`übs
(()(
¥edMB
[
i
*16+
cuºBlockOff£t
] - 
√ighb‹
[i*
picSizeX
]));

826 
numOfPªdBlocks
++;

830 
thªshﬁd
--;

831 i‡(
thªshﬁd
 < 
ERC_BLOCK_CONCEALED
)

833 } 
numOfPªdBlocks
 == 0);

835 if(
numOfPªdBlocks
 == 0)

840  (
di°‹ti⁄
/
numOfPªdBlocks
);

841 
	}
}

854 
	$buûdPªdblockRegi⁄YUV
(
VideoP¨amëîs
 *
p_Vid
, *
mv
,

855 
x
, 
y
, 
img≥l
 *
¥edMB
, 
li°
, 
cuºít_mb_ƒ
)

857 
img≥l
 **
tmp_block
;

858 
i
=0,
j
=0,
ii
=0,
jj
=0,
i1
=0,
j1
=0,
j4
=0,
i4
=0;

859 
uv
;

860 
vec1_x
=0,
vec1_y
=0;

861 
ioff
,
joff
;

863 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
p_Vid
->dec_picture;

864 
img≥l
 *
pMB
 = 
¥edMB
;

866 
ii0
,
jj0
,
ii1
,
jj1
,
if1
,
jf1
,
if0
,
jf0
;

867 
mv_mul
;

870 
f1_x
, 
f1_y
, 
f2_x
, 
f2_y
, 
f3
, 
f4
;

871 
yuv
 = 
dec_pi˘uª
->
chroma_f‹m©_idc
 - 1;

873 
ªf_‰ame
 = 
mv
[2];

874 
mb_ƒ
 = 
cuºít_mb_ƒ
;

876 
Ma¸oblock
 *
cuºMB
 = &
p_Vid
->
mb_d©a
[
mb_ƒ
];

877 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

879 
	`gë_mem2D≥l
(&
tmp_block
, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE);

883 
cuºMB
->
mb
.
x
 = (Ë(x/
BLOCK_SIZE
);

884 
cuºMB
->
mb
.
y
 = (Ë(y/
BLOCK_SIZE
);

885 
cuºMB
->
block_y
 = cuºMB->
mb
.
y
 * 
BLOCK_SIZE
;

886 
cuºMB
->
pix_c_y
 = cuºMB->
mb
.
y
 * 
p_Vid
->
mb_¸_size_y
/4;

887 
cuºMB
->
block_x
 = cuºMB->
mb
.
x
 * 
BLOCK_SIZE
;

888 
cuºMB
->
pix_c_x
 = cuºMB->
mb
.
x
 * 
p_Vid
->
mb_¸_size_x
/4;

890 
mv_mul
=4;

894 
vec1_x
 = 
x
*
mv_mul
 + 
mv
[0];

895 
vec1_y
 = 
y
*
mv_mul
 + 
mv
[1];

896 
	`gë_block_luma
(
cuºSli˚
->
li°X
[
li°
][
ªf_‰ame
], 
vec1_x
, 
vec1_y
, 
BLOCK_SIZE
, BLOCK_SIZE, 
tmp_block
,

897 
dec_pi˘uª
->
iLumaSåide
,dec_pi˘uª->
size_x_m1
, (
cuºMB
->
mb_fõld
Ë? (dec_pi˘uª->
size_y
 >> 1Ë- 1 : dec_pi˘uª->
size_y_m1
,
cuºSli˚
->
tmp_ªs
,

898 
p_Vid
->
max_≥l_vÆue_comp
[
PLANE_Y
],(
img≥l
Ëp_Vid->
dc_¥ed_vÆue_comp
[PLANE_Y], 
cuºMB
);

900 
jj
=0;jj<
MB_BLOCK_SIZE
/
BLOCK_SIZE
;jj++)

901 
ii
=0;ii<
BLOCK_SIZE
;ii++)

902 
cuºSli˚
->
mb_¥ed
[
LumaComp
][
jj
][
ii
]=
tmp_block
[jj][ii];

905 
j
 = 0; j < 4; j++)

907 
i
 = 0; i < 4; i++)

909 
pMB
[
j
*4+
i
] = 
cuºSli˚
->
mb_¥ed
[
LumaComp
][j][i];

912 
pMB
 += 16;

914 i‡(
dec_pi˘uª
->
chroma_f‹m©_idc
 !
YUV400
)

917 
f1_x
 = 64/(
p_Vid
->
mb_¸_size_x
);

918 
f2_x
=
f1_x
-1;

920 
f1_y
 = 64/(
p_Vid
->
mb_¸_size_y
);

921 
f2_y
=
f1_y
-1;

923 
f3
=
f1_x
*
f1_y
;

924 
f4
=
f3
>>1;

926 
uv
=0;uv<2;uv++)

928 
joff
 = 
subblk_off£t_y
[
yuv
][0][0];

929 
j4
=
cuºMB
->
pix_c_y
+
joff
;

930 
ioff
 = 
subblk_off£t_x
[
yuv
][0][0];

931 
i4
=
cuºMB
->
pix_c_x
+
ioff
;

933 
jj
=0;jj<2;jj++)

935 
ii
=0;ii<2;ii++)

937 
i1
=(
i4
+
ii
)*
f1_x
 + 
mv
[0];

938 
j1
=(
j4
+
jj
)*
f1_y
 + 
mv
[1];

940 
ii0
=
	`iClù3
 (0, 
dec_pi˘uª
->
size_x_¸
-1, 
i1
/
f1_x
);

941 
jj0
=
	`iClù3
 (0, 
dec_pi˘uª
->
size_y_¸
-1, 
j1
/
f1_y
);

942 
ii1
=
	`iClù3
 (0, 
dec_pi˘uª
->
size_x_¸
-1, ((
i1
+
f2_x
)/
f1_x
));

943 
jj1
=
	`iClù3
 (0, 
dec_pi˘uª
->
size_y_¸
-1, ((
j1
+
f2_y
)/
f1_y
));

945 
if1
=(
i1
 & 
f2_x
);

946 
jf1
=(
j1
 & 
f2_y
);

947 
if0
=
f1_x
-
if1
;

948 
jf0
=
f1_y
-
jf1
;

950 
cuºSli˚
->
mb_¥ed
[
uv
 + 1][
jj
][
ii
]=(
img≥l
Ë((
if0
*
jf0
*cuºSli˚->
li°X
[
li°
][
ªf_‰ame
]->
imgUV
[uv][
jj0
][
ii0
]+

951 
if1
*
jf0
*
cuºSli˚
->
li°X
[
li°
][
ªf_‰ame
]->
imgUV
[
uv
][
jj0
][
ii1
]+

952 
if0
*
jf1
*
cuºSli˚
->
li°X
[
li°
][
ªf_‰ame
]->
imgUV
[
uv
][
jj1
][
ii0
]+

953 
if1
*
jf1
*
cuºSli˚
->
li°X
[
li°
][
ªf_‰ame
]->
imgUV
[
uv
][
jj1
][
ii1
]+
f4
)/
f3
);

957 
j
 = 0; j < 2; j++)

959 
i
 = 0; i < 2; i++)

961 
pMB
[
j
*2+
i
] = 
cuºSli˚
->
mb_¥ed
[
uv
 + 1][j][i];

964 
pMB
 += 4;

968 
	`‰ì_mem2D≥l
(
tmp_block
);

969 
	}
}

978 
ölöe
 
	$com∑ª_pic_by_pic_num_desc
–c⁄° *
¨g1
, c⁄° *
¨g2
 )

980 
pic_num1
 = (*(
St‹abÀPi˘uª
**)
¨g1
)->
pic_num
;

981 
pic_num2
 = (*(
St‹abÀPi˘uª
**)
¨g2
)->
pic_num
;

983 i‡(
pic_num1
 < 
pic_num2
)

985 i‡(
pic_num1
 > 
pic_num2
)

989 
	}
}

998 
ölöe
 
	$com∑ª_pic_by_…_pic_num_asc
–c⁄° *
¨g1
, c⁄° *
¨g2
 )

1000 
l⁄g_ãrm_pic_num1
 = (*(
St‹abÀPi˘uª
**)
¨g1
)->
l⁄g_ãrm_pic_num
;

1001 
l⁄g_ãrm_pic_num2
 = (*(
St‹abÀPi˘uª
**)
¨g2
)->
l⁄g_ãrm_pic_num
;

1002 i‡–
l⁄g_ãrm_pic_num1
 < 
l⁄g_ãrm_pic_num2
)

1005 i‡–
l⁄g_ãrm_pic_num1
 > 
l⁄g_ãrm_pic_num2
)

1009 
	}
}

1018 
ölöe
 
	$com∑ª_pic_by_poc_asc
–c⁄° *
¨g1
, c⁄° *
¨g2
 )

1020 
poc1
 = (*(
St‹abÀPi˘uª
**)
¨g1
)->
poc
;

1021 
poc2
 = (*(
St‹abÀPi˘uª
**)
¨g2
)->
poc
;

1023 i‡–
poc1
 < 
poc2
)

1025 i‡–
poc1
 > 
poc2
)

1029 
	}
}

1039 
ölöe
 
	$com∑ª_pic_by_poc_desc
–c⁄° *
¨g1
, c⁄° *
¨g2
 )

1041 
poc1
 = (*(
St‹abÀPi˘uª
**)
¨g1
)->
poc
;

1042 
poc2
 = (*(
St‹abÀPi˘uª
**)
¨g2
)->
poc
;

1044 i‡(
poc1
 < 
poc2
)

1046 i‡(
poc1
 > 
poc2
)

1050 
	}
}

1059 
	$C›yImgD©a
(
img≥l
 **
öputY
, img≥»***
öputUV
, img≥»**
ouçutY
, img≥»***
ouçutUV
,

1060 
img_width
, 
img_height
, 
img_width_¸
, 
img_height_¸
)

1062 
x
, 
y
;

1064 
y
=0; y<
img_height
; y++)

1065 
x
=0; x<
img_width
; x++)

1066 
ouçutY
[
y
][
x
] = 
öputY
[y][x];

1068 
y
=0; y<
img_height_¸
; y++)

1069 
x
=0; x<
img_width_¸
; x++)

1071 
ouçutUV
[0][
y
][
x
] = 
öputUV
[0][y][x];

1072 
ouçutUV
[1][
y
][
x
] = 
öputUV
[1][y][x];

1074 
	}
}

1083 
St‹abÀPi˘uª
* 
	$gë_œ°_ªf_pic_‰om_dpb
(
DecodedPi˘uªBuf„r
 *
p_Dpb
)

1085 
u£d_size
 = 
p_Dpb
->used_size - 1;

1086 
i
;

1088 
i
 = 
u£d_size
; i >= 0; i--)

1090 i‡(
p_Dpb
->
fs
[
i
]->
is_u£d
==3)

1092 i‡(((
p_Dpb
->
fs
[
i
]->
‰ame
->
u£d_f‹_ª„ªn˚
) &&

1093 (!
p_Dpb
->
fs
[
i
]->
‰ame
->
is_l⁄g_ãrm
))

1096  
p_Dpb
->
fs
[
i
]->
‰ame
;

1101  
NULL
;

1102 
	}
}

1113 
	$c›y_to_c⁄˚Æ
(
St‹abÀPi˘uª
 *
§c
, St‹abÀPi˘uª *
d°
, 
VideoP¨amëîs
 *
p_Vid
)

1115 
i
=0;

1116 
mv
[3];

1117 
mu…ùlõr
;

1118 
img≥l
 *
¥edMB
, *
°‹eYUV
;

1119 
j
, 
y
, 
x
, 
mb_height
, 
mb_width
, 
ii
=0, 
jj
=0;

1120 
uv
;

1121 
mm
, 
¬
;

1122 
sˇÀ
 = 1;

1123 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
p_Vid
->dec_picture;

1126 
cuºít_mb_ƒ
 = 0;

1128 
d°
->
PicSizeInMbs
 = 
§c
->PicSizeInMbs;

1130 
d°
->
¶i˚_ty≥
 = 
§c
->¶i˚_ty≥ = 
p_Vid
->
c⁄˚Æ_¶i˚_ty≥
;

1132 
d°
->
idr_Êag
 = 
FALSE
;

1134 
d°
->
no_ouçut_of_¥i‹_pics_Êag
 = 
§c
->no_output_of_prior_pics_flag;

1135 
d°
->
l⁄g_ãrm_ª„ªn˚_Êag
 = 
§c
->long_term_reference_flag;

1136 
d°
->
ad≠tive_ªf_pic_buf„rög_Êag
 = 
§c
->adaptive_ref_pic_buffering_flag = 0;

1137 
d°
->
chroma_f‹m©_idc
 = 
§c
->chroma_format_idc;

1138 
d°
->
‰ame_mbs_⁄ly_Êag
 = 
§c
->frame_mbs_only_flag;

1139 
d°
->
‰ame_¸›pög_Êag
 = 
§c
->frame_cropping_flag;

1140 
d°
->
‰ame_¸›_À·_off£t
 = 
§c
->frame_crop_left_offset;

1141 
d°
->
‰ame_¸›_right_off£t
 = 
§c
->frame_crop_right_offset;

1142 
d°
->
‰ame_¸›_bŸtom_off£t
 = 
§c
->frame_crop_bottom_offset;

1143 
d°
->
‰ame_¸›_t›_off£t
 = 
§c
->frame_crop_top_offset;

1145 
d°
->
qp
 = 
§c
->qp;

1146 
d°
->
¶i˚_qp_dñè
 = 
§c
->slice_qp_delta;

1148 
dec_pi˘uª
 = 
§c
;

1151 i‡(
p_Vid
->
c⁄˚Æ_mode
==1)

1155 
d°
->
PicWidthInMbs
 = 
§c
->PicWidthInMbs;

1156 
d°
->
PicSizeInMbs
 = 
§c
->PicSizeInMbs;

1158 
	`C›yImgD©a
–
§c
->
imgY
, src->
imgUV
, 
d°
->imgY, d°->imgUV, 
p_Vid
->
width
,Ö_Vid->
height
,Ö_Vid->
width_¸
,Ö_Vid->
height_¸
);

1162 i‡(
p_Vid
->
c⁄˚Æ_mode
==2)

1164 i‡(
dec_pi˘uª
->
chroma_f‹m©_idc
 !
YUV400
)

1166 
°‹eYUV
 = (
img≥l
 *Ë
	`mÆloc
 ( (16 + (
p_Vid
->
mb_¸_size_x
*p_Vid->
mb_¸_size_y
)*2/16) *  (imgpel));

1170 
°‹eYUV
 = (
img≥l
 *Ë
	`mÆloc
 (16 *  (imgpel));

1173 
p_Vid
->
îc_img
 =Ö_Vid;

1175 
d°
->
PicWidthInMbs
 = 
§c
->PicWidthInMbs;

1176 
d°
->
PicSizeInMbs
 = 
§c
->PicSizeInMbs;

1177 
mb_width
 = 
d°
->
PicWidthInMbs
;

1178 
mb_height
 = (
d°
->
PicSizeInMbs
)/(d°->
PicWidthInMbs
);

1179 
sˇÀ
 = (
p_Vid
->
c⁄˚Æ_¶i˚_ty≥
 =
B_SLICE
) ? 2 : 1;

1181 if(
p_Vid
->
c⁄˚Æ_¶i˚_ty≥
 =
B_SLICE
)

1183 
	`öô_li°s_f‹_n⁄_ª„ªn˚_loss
(

1184 
p_Vid
->
p_Dpb_œyî
[0],

1185 
d°
->
¶i˚_ty≥
, 
p_Vid
->
µSli˚Li°
[0]->
°ru˘uª
);

1188 
p_Vid
->
µSli˚Li°
[0]->
	`öô_li°s
(p_Vid->ppSliceList[0]);

1190 
mu…ùlõr
 = 
BLOCK_SIZE
;

1192 
i
=0;i<
mb_height
*4;i++)

1194 
mm
 = 
i
 * 
BLOCK_SIZE
;

1195 
j
=0;j<
mb_width
*4;j++)

1197 
¬
 = 
j
 * 
BLOCK_SIZE
;

1199 
mv
[0] = 
§c
->
mv_öfo
[
i
][
j
].mv[
LIST_0
].
mv_x
 / 
sˇÀ
;

1200 
mv
[1] = 
§c
->
mv_öfo
[
i
][
j
].mv[
LIST_0
].
mv_y
 / 
sˇÀ
;

1201 
mv
[2] = 
§c
->
mv_öfo
[
i
][
j
].
ªf_idx
[
LIST_0
];

1203 if(
mv
[2]<0)

1204 
mv
[2]=0;

1206 
d°
->
mv_öfo
[
i
][
j
].
mv
[
LIST_0
].
mv_x
 = () mv[0];

1207 
d°
->
mv_öfo
[
i
][
j
].
mv
[
LIST_0
].
mv_y
 = () mv[1];

1208 
d°
->
mv_öfo
[
i
][
j
].
ªf_idx
[
LIST_0
] = (Ë
mv
[2];

1210 
x
 = (
j
Ë* 
mu…ùlõr
;

1211 
y
 = (
i
Ë* 
mu…ùlõr
;

1213 i‡((
mm
%16==0Ë&& (
¬
%16==0))

1214 
cuºít_mb_ƒ
++;

1216 
	`buûdPªdblockRegi⁄YUV
(
p_Vid
->
îc_img
, 
mv
, 
x
, 
y
, 
°‹eYUV
, 
LIST_0
, 
cuºít_mb_ƒ
);

1218 
¥edMB
 = 
°‹eYUV
;

1220 
ii
=0;ii<
mu…ùlõr
;ii++)

1222 
jj
=0;jj<
mu…ùlõr
;jj++)

1224 
d°
->
imgY
[
i
*
mu…ùlõr
+
ii
][
j
*mu…ùlõr+
jj
] = 
¥edMB
[ii*(multiplier)+jj];

1228 
¥edMB
 =ÖªdMB + (
mu…ùlõr
*multiplier);

1230 i‡(
dec_pi˘uª
->
chroma_f‹m©_idc
 !
YUV400
)

1233 
uv
=0;uv<2;uv++)

1235 
ii
=0;ii< (
mu…ùlõr
/2);ii++)

1237 
jj
=0;jj< (
mu…ùlõr
/2);jj++)

1239 
d°
->
imgUV
[
uv
][
i
*
mu…ùlõr
/2 +
ii
][
j
*mu…ùlõr/2 +
jj
] = 
¥edMB
[ii*(multiplier/2)+jj];

1242 
¥edMB
 =ÖªdMB + (
mu…ùlõr
*multiplier/4);

1247 
	`‰ì
(
°‹eYUV
);

1249 
	}
}

1260 
	$c›y_¥ev_pic_to_c⁄˚Æed_pic
(
St‹abÀPi˘uª
 *
pi˘uª
, 
DecodedPi˘uªBuf„r
 *
p_Dpb
)

1262 
VideoP¨amëîs
 *
p_Vid
 = 
p_Dpb
->p_Vid;

1264 
St‹abÀPi˘uª
 *
ªf_pic
 = 
	`gë_œ°_ªf_pic_‰om_dpb
(
p_Dpb
);

1266 
	`as£π
(
ªf_pic
 !
NULL
);

1269 
p_Vid
->
c⁄˚Æ_¶i˚_ty≥
 = 
P_SLICE
;

1270 
	`c›y_to_c⁄˚Æ
(
ªf_pic
, 
pi˘uª
, 
p_Vid
);

1271 
	}
}

1284 
	$c⁄˚Æ_lo°_‰ames
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
Sli˚
 *
pSli˚
)

1286 
VideoP¨amëîs
 *
p_Vid
 = 
p_Dpb
->p_Vid;

1287 
CuºFømeNum
;

1288 
Unu£dSh‹tTîmFømeNum
;

1289 
St‹abÀPi˘uª
 *
pi˘uª
 = 
NULL
;

1290 
tmp1
 = 
pSli˚
->
dñè_pic_‹dî_˙t
[0];

1291 
tmp2
 = 
pSli˚
->
dñè_pic_‹dî_˙t
[1];

1292 
i
;

1294 
pSli˚
->
dñè_pic_‹dî_˙t
[0] =ÖSlice->delta_pic_order_cnt[1] = 0;

1298 if(
p_Vid
->
IDR_c⁄˚Æmít_Êag
 == 1)

1302 
Unu£dSh‹tTîmFømeNum
 = 0;

1303 
p_Vid
->
œ°_ªf_pic_poc
 = -p_Vid->
poc_g≠
;

1304 
p_Vid
->
óæõr_missög_poc
 = 0;

1307 
Unu£dSh‹tTîmFømeNum
 = (
p_Vid
->
¥e_‰ame_num
 + 1Ë%Ö_Vid->
max_‰ame_num
;

1309 
CuºFømeNum
 = 
pSli˚
->
‰ame_num
;

1311 
CuºFømeNum
 !
Unu£dSh‹tTîmFømeNum
)

1313 
pi˘uª
 = 
	`Æloc_°‹abÀ_pi˘uª
 (
p_Vid
, 
FRAME
,Ö_Vid->
width
,Ö_Vid->
height
,Ö_Vid->
width_¸
,Ö_Vid->
height_¸
, 1);

1315 
pi˘uª
->
coded_‰ame
 = 1;

1316 
pi˘uª
->
pic_num
 = 
Unu£dSh‹tTîmFømeNum
;

1317 
pi˘uª
->
‰ame_num
 = 
Unu£dSh‹tTîmFømeNum
;

1318 
pi˘uª
->
n⁄_exi°ög
 = 0;

1319 
pi˘uª
->
is_ouçut
 = 0;

1320 
pi˘uª
->
u£d_f‹_ª„ªn˚
 = 1;

1321 
pi˘uª
->
c⁄˚Æed_pic
 = 1;

1323 
pi˘uª
->
ad≠tive_ªf_pic_buf„rög_Êag
 = 0;

1325 
pSli˚
->
‰ame_num
 = 
Unu£dSh‹tTîmFømeNum
;

1327 
pi˘uª
->
t›_poc
=
p_Vid
->
œ°_ªf_pic_poc
 +Ö_Vid->
ªf_poc_g≠
;

1328 
pi˘uª
->
bŸtom_poc
ıi˘uª->
t›_poc
;

1329 
pi˘uª
->
‰ame_poc
ıi˘uª->
t›_poc
;

1330 
pi˘uª
->
poc
ıi˘uª->
t›_poc
;

1331 
p_Vid
->
œ°_ªf_pic_poc
 = 
pi˘uª
->
poc
;

1333 
	`c›y_¥ev_pic_to_c⁄˚Æed_pic
(
pi˘uª
, 
p_Dpb
);

1336 if(
p_Vid
->
IDR_c⁄˚Æmít_Êag
 == 1)

1338 
pi˘uª
->
¶i˚_ty≥
 = 
I_SLICE
;

1339 
pi˘uª
->
idr_Êag
 = 
TRUE
;

1340 
	`Êush_dpb
(
p_Dpb
);

1341 
pi˘uª
->
t›_poc
= 0;

1342 
pi˘uª
->
bŸtom_poc
ıi˘uª->
t›_poc
;

1343 
pi˘uª
->
‰ame_poc
ıi˘uª->
t›_poc
;

1344 
pi˘uª
->
poc
ıi˘uª->
t›_poc
;

1345 
p_Vid
->
œ°_ªf_pic_poc
 = 
pi˘uª
->
poc
;

1348 
	`°‹e_pi˘uª_ö_dpb
(
p_Vid
->
p_Dpb_œyî
[0], 
pi˘uª
);

1350 
pi˘uª
=
NULL
;

1352 
p_Vid
->
¥e_‰ame_num
 = 
Unu£dSh‹tTîmFømeNum
;

1353 
Unu£dSh‹tTîmFømeNum
 = (Unu£dSh‹tTîmFømeNum + 1Ë% 
p_Vid
->
max_‰ame_num
;

1356 
i
=16;i>0;i--)

1358 
pSli˚
->
ªf_Êag
[
i
] =ÖSlice->ref_flag[i-1];

1360 
pSli˚
->
ªf_Êag
[0] = 0;

1362 
pSli˚
->
dñè_pic_‹dî_˙t
[0] = 
tmp1
;

1363 
pSli˚
->
dñè_pic_‹dî_˙t
[1] = 
tmp2
;

1364 
pSli˚
->
‰ame_num
 = 
CuºFømeNum
;

1365 
	}
}

1376 
	$upd©e_ªf_li°_f‹_c⁄˚Æmít
(
DecodedPi˘uªBuf„r
 *
p_Dpb
)

1378 
VideoP¨amëîs
 *
p_Vid
 = 
p_Dpb
->p_Vid;

1379 
i
, 
j
= 0;

1381 
i
 = 0; i < 
p_Dpb
->
u£d_size
; i++)

1383 i‡(
p_Dpb
->
fs
[
i
]->
c⁄˚Æmít_ª„ªn˚
)

1385 
p_Dpb
->
fs_ªf
[
j
++] =Ö_Dpb->
fs
[
i
];

1389 
p_Dpb
->
ªf_‰ames_ö_buf„r
 = 
p_Vid
->
a˘ive_µs
->
num_ªf_idx_l0_deÁu…_a˘ive_möus1
;

1390 
	}
}

1401 
	$öô_li°s_f‹_n⁄_ª„ªn˚_loss
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
cuºSli˚Ty≥
, 
Pi˘uªSåu˘uª
 
cuºPicSåu˘uª
)

1403 
VideoP¨amëîs
 *
p_Vid
 = 
p_Dpb
->p_Vid;

1404 
£q_∑ømëî_£t_rb•_t
 *
a˘ive_•s
 = 
p_Vid
->active_sps;

1406 
i
;

1407 
j
;

1408 
max_‰ame_num
 = 1 << (
a˘ive_•s
->
log2_max_‰ame_num_möus4
 + 4);

1409 
diff
;

1411 
li°0idx
 = 0;

1412 
li°0idx_1
 = 0;

1414 
St‹abÀPi˘uª
 *
tmp_s
;

1416 i‡(
cuºPicSåu˘uª
 =
FRAME
)

1418 
i
=0;i<
p_Dpb
->
ªf_‰ames_ö_buf„r
; i++)

1420 if(
p_Dpb
->
fs
[
i
]->
c⁄˚Æmít_ª„ªn˚
 == 1)

1422 if(
p_Dpb
->
fs
[
i
]->
‰ame_num
 > 
p_Vid
->
‰ame_to_c⁄˚Æ
)

1423 
p_Dpb
->
fs_ªf
[
i
]->
‰ame_num_wøp
 =Ö_Dpb->
fs
[i]->
‰ame_num
 - 
max_‰ame_num
;

1425 
p_Dpb
->
fs_ªf
[
i
]->
‰ame_num_wøp
 =Ö_Dpb->
fs
[i]->
‰ame_num
;

1426 
p_Dpb
->
fs_ªf
[
i
]->
‰ame
->
pic_num
 =Ö_Dpb->fs_ªf[i]->
‰ame_num_wøp
;

1431 i‡(
cuºSli˚Ty≥
 =
P_SLICE
)

1434 i‡(
cuºPicSåu˘uª
 =
FRAME
)

1436 
i
=0;i<
p_Dpb
->
u£d_size
; i++)

1438 if(
p_Dpb
->
fs
[
i
]->
c⁄˚Æmít_ª„ªn˚
 == 1)

1440 
p_Vid
->
µSli˚Li°
[0]->
li°X
[0][
li°0idx
++] = 
p_Dpb
->
fs
[
i
]->
‰ame
;

1444 
	`qs‹t
((*)
p_Vid
->
µSli˚Li°
[0]->
li°X
[0], 
li°0idx
, (
St‹abÀPi˘uª
*), 
com∑ª_pic_by_pic_num_desc
);

1445 
p_Vid
->
µSli˚Li°
[0]->
li°Xsize
[0] = (Ë
li°0idx
;

1449 i‡(
cuºSli˚Ty≥
 =
B_SLICE
)

1451 i‡(
cuºPicSåu˘uª
 =
FRAME
)

1454 
i
=0;i<
p_Dpb
->
u£d_size
; i++)

1456 if(
p_Dpb
->
fs
[
i
]->
c⁄˚Æmít_ª„ªn˚
 == 1)

1458 if(
p_Vid
->
óæõr_missög_poc
 > 
p_Dpb
->
fs
[
i
]->
‰ame
->
poc
)

1459 
p_Vid
->
µSli˚Li°
[0]->
li°X
[0][
li°0idx
++] = 
p_Dpb
->
fs
[
i
]->
‰ame
;

1463 
	`qs‹t
((*)
p_Vid
->
µSli˚Li°
[0]->
li°X
[0], 
li°0idx
, (
St‹abÀPi˘uª
*), 
com∑ª_pic_by_poc_desc
);

1464 
li°0idx_1
 = 
li°0idx
;

1467 
i
=0;i<
p_Dpb
->
u£d_size
; i++)

1469 if(
p_Dpb
->
fs
[
i
]->
c⁄˚Æmít_ª„ªn˚
 == 1)

1471 if(
p_Vid
->
óæõr_missög_poc
 < 
p_Dpb
->
fs
[
i
]->
‰ame
->
poc
)

1472 
p_Vid
->
µSli˚Li°
[0]->
li°X
[0][
li°0idx
++] = 
p_Dpb
->
fs
[
i
]->
‰ame
;

1476 
	`qs‹t
((*)&
p_Vid
->
µSli˚Li°
[0]->
li°X
[0][
li°0idx_1
], 
li°0idx
-li°0idx_1, (
St‹abÀPi˘uª
*), 
com∑ª_pic_by_poc_asc
);

1478 
j
=0; j<
li°0idx_1
; j++)

1480 
p_Vid
->
µSli˚Li°
[0]->
li°X
[1][
li°0idx
-
li°0idx_1
+
j
]=p_Vid->ppSliceList[0]->listX[0][j];

1482 
j
=
li°0idx_1
; j<
li°0idx
; j++)

1484 
p_Vid
->
µSli˚Li°
[0]->
li°X
[1][
j
-
li°0idx_1
]=p_Vid->ppSliceList[0]->listX[0][j];

1487 
p_Vid
->
µSli˚Li°
[0]->
li°Xsize
[0] =Ö_Vid->µSli˚Li°[0]->li°Xsize[1] = (Ë
li°0idx
;

1489 
	`qs‹t
((*)&
p_Vid
->
µSli˚Li°
[0]->
li°X
[0][(Ëp_Vid->µSli˚Li°[0]->
li°Xsize
[0]], 
li°0idx
-p_Vid->µSli˚Li°[0]->li°Xsize[0], (
St‹abÀPi˘uª
*), 
com∑ª_pic_by_…_pic_num_asc
);

1490 
	`qs‹t
((*)&
p_Vid
->
µSli˚Li°
[0]->
li°X
[1][(Ëp_Vid->µSli˚Li°[0]->
li°Xsize
[0]], 
li°0idx
-p_Vid->µSli˚Li°[0]->li°Xsize[0], (
St‹abÀPi˘uª
*), 
com∑ª_pic_by_…_pic_num_asc
);

1491 
p_Vid
->
µSli˚Li°
[0]->
li°Xsize
[0] =Ö_Vid->µSli˚Li°[0]->li°Xsize[1] = (Ë
li°0idx
;

1495 i‡((
p_Vid
->
µSli˚Li°
[0]->
li°Xsize
[0] ==Ö_Vid->ppSliceList[0]->listXsize[1]) && (p_Vid->ppSliceList[0]->listXsize[0] > 1))

1498 
diff
=0;

1499 
j
 = 0; j< 
p_Vid
->
µSli˚Li°
[0]->
li°Xsize
[0]; j++)

1501 i‡(
p_Vid
->
µSli˚Li°
[0]->
li°X
[0][
j
]!=p_Vid->ppSliceList[0]->listX[1][j])

1502 
diff
=1;

1504 i‡(!
diff
)

1506 
tmp_s
 = 
p_Vid
->
µSli˚Li°
[0]->
li°X
[1][0];

1507 
p_Vid
->
µSli˚Li°
[0]->
li°X
[1][0]=p_Vid->ppSliceList[0]->listX[1][1];

1508 
p_Vid
->
µSli˚Li°
[0]->
li°X
[1][1]=
tmp_s
;

1513 
p_Vid
->
µSli˚Li°
[0]->
li°Xsize
[0] = (Ë
	`imö
 (p_Vid->µSli˚Li°[0]->li°Xsize[0], ()
a˘ive_•s
->
num_ªf_‰ames
);

1514 
p_Vid
->
µSli˚Li°
[0]->
li°Xsize
[1] = (Ë
	`imö
 (p_Vid->µSli˚Li°[0]->li°Xsize[1], ()
a˘ive_•s
->
num_ªf_‰ames
);

1516 
p_Vid
->
µSli˚Li°
[0]->
li°Xsize
[1] = 0;

1518 
i
=
p_Vid
->
µSli˚Li°
[0]->
li°Xsize
[0]; i< (
MAX_LIST_SIZE
) ; i++)

1520 
p_Vid
->
µSli˚Li°
[0]->
li°X
[0][
i
] = 
NULL
;

1522 
i
=
p_Vid
->
µSli˚Li°
[0]->
li°Xsize
[1]; i< (
MAX_LIST_SIZE
) ; i++)

1524 
p_Vid
->
µSli˚Li°
[0]->
li°X
[1][
i
] = 
NULL
;

1526 
	}
}

1539 
St‹abÀPi˘uª
 *
	$gë_pic_‰om_dpb
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
missögpoc
, *
pos
)

1541 
VideoP¨amëîs
 *
p_Vid
 = 
p_Dpb
->p_Vid;

1542 
u£d_size
 = 
p_Dpb
->used_size - 1;

1543 
i
, 
c⁄˚Æ‰om
 = 0;

1545 if(
p_Vid
->
c⁄˚Æ_mode
 == 1)

1546 
c⁄˚Æ‰om
 = 
missögpoc
 - 
p_Vid
->
poc_g≠
;

1547 i‡(
p_Vid
->
c⁄˚Æ_mode
 == 2)

1548 
c⁄˚Æ‰om
 = 
missögpoc
 + 
p_Vid
->
poc_g≠
;

1550 
i
 = 
u£d_size
; i >= 0; i--)

1552 if(
p_Dpb
->
fs
[
i
]->
poc
 =
c⁄˚Æ‰om
)

1554 *
pos
 = 
i
;

1555  
p_Dpb
->
fs
[
i
]->
‰ame
;

1559  
NULL
;

1560 
	}
}

1571 
	$comp
(c⁄° *
i
, c⁄° *
j
)

1573  *(*)
i
 - *(*)
j
;

1574 
	}
}

1585 
c⁄˚Æmít_node
 * 
	$öô_node
–
St‹abÀPi˘uª
* 
pi˘uª
, 
missögpoc
 )

1587 
c⁄˚Æmít_node
 *
±r
;

1589 
±r
 = (
c⁄˚Æmít_node
 *Ë
	`ˇŒoc
( 1, (concealment_node ) );

1591 if–
±r
 =
NULL
 )

1592  (
c⁄˚Æmít_node
 *Ë
NULL
;

1594 
±r
->
pi˘uª
 =Öicture;

1595 
±r
->
missögpocs
 = 
missögpoc
;

1596 
±r
->
√xt
 = 
NULL
;

1597  
±r
;

1599 
	}
}

1609 
	$¥öt_node
–
c⁄˚Æmít_node
 *
±r
 )

1611 
	`¥ötf
("Missög POC=%d\n", 
±r
->
missögpocs
 );

1612 
	}
}

1623 
	$¥öt_li°
–
c⁄˚Æmít_node
 *
±r
 )

1625  
±r
 !
NULL
 )

1627 
	`¥öt_node
–
±r
 );

1628 
±r
 =Öå->
√xt
;

1630 
	}
}

1641 
	$add_node
–
VideoP¨amëîs
 *
p_Vid
, 
c⁄˚Æmít_node
 *
c⁄˚Æmít_√w
 )

1643 if–
p_Vid
->
c⁄˚Æmít_hód
 =
NULL
 )

1645 
p_Vid
->
c⁄˚Æmít_íd
 =Ö_Vid->
c⁄˚Æmít_hód
 = 
c⁄˚Æmít_√w
;

1648 
p_Vid
->
c⁄˚Æmít_íd
->
√xt
 = 
c⁄˚Æmít_√w
;

1649 
p_Vid
->
c⁄˚Æmít_íd
 = 
c⁄˚Æmít_√w
;

1650 
	}
}

1662 
	$dñëe_node
–
VideoP¨amëîs
 *
p_Vid
, 
c⁄˚Æmít_node
 *
±r
 )

1665 if–
±r
 =
p_Vid
->
c⁄˚Æmít_hód
 )

1667 
p_Vid
->
c⁄˚Æmít_hód
 =Ö_Vid->c⁄˚Æmít_hód->
√xt
;

1668 if–
p_Vid
->
c⁄˚Æmít_íd
 =
±r
 )

1669 
p_Vid
->
c⁄˚Æmít_íd
 =Ö_Vid->c⁄˚Æmít_íd->
√xt
;

1670 
	`‰ì
(
±r
);

1672 
	}
}

1682 
	$dñëe_li°
–
VideoP¨amëîs
 *
p_Vid
, 
c⁄˚Æmít_node
 *
±r
 )

1684 
c⁄˚Æmít_node
 *
ãmp
;

1686 if–
p_Vid
->
c⁄˚Æmít_hód
 =
NULL
 ) ;

1688 if–
±r
 =
p_Vid
->
c⁄˚Æmít_hód
 )

1690 
p_Vid
->
c⁄˚Æmít_hód
 = 
NULL
;

1691 
p_Vid
->
c⁄˚Æmít_íd
 = 
NULL
;

1695 
ãmp
 = 
p_Vid
->
c⁄˚Æmít_hód
;

1697  
ãmp
->
√xt
 !
±r
 )

1698 
ãmp
 =Åemp->
√xt
;

1699 
p_Vid
->
c⁄˚Æmít_íd
 = 
ãmp
;

1702  
±r
 !
NULL
 )

1704 
ãmp
 = 
±r
->
√xt
;

1705 
	`‰ì
–
±r
 );

1706 
±r
 = 
ãmp
;

1708 
	}
}

1721 
	$c⁄˚Æ_n⁄_ªf_pics
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
diff
)

1723 
VideoP¨amëîs
 *
p_Vid
 = 
p_Dpb
->p_Vid;

1724 
missögpoc
 = 0;

1725 
i
, 
pos
 = 0;

1726 
St‹abÀPi˘uª
 *
c⁄˚Æ_‰om_pi˘uª
 = 
NULL
;

1727 
St‹abÀPi˘uª
 *
c⁄˚Æ_to_pi˘uª
 = 
NULL
;

1728 
c⁄˚Æmít_node
 *
c⁄˚Æmít_±r
 = 
NULL
;

1729 
ãmp_u£d_size
 = 
p_Dpb
->
u£d_size
;

1731 if(
p_Dpb
->
u£d_size
 == 0 )

1734 
	`qs‹t
(
p_Vid
->
pocs_ö_dpb
, 
p_Dpb
->
size
, (), 
comp
);

1736 
i
=0;i<
p_Dpb
->
size
-
diff
;i++)

1738 
p_Dpb
->
u£d_size
 =Ö_Dpb->
size
;

1739 if((
p_Vid
->
pocs_ö_dpb
[
i
+1] -Ö_Vid->pocs_ö_dpb[i]Ë>Ö_Vid->
poc_g≠
)

1741 
c⁄˚Æ_to_pi˘uª
 = 
	`Æloc_°‹abÀ_pi˘uª
 (
p_Vid
, 
FRAME
,Ö_Vid->
width
,Ö_Vid->
height
,Ö_Vid->
width_¸
,Ö_Vid->
height_¸
, 1);

1743 
missögpoc
 = 
p_Vid
->
pocs_ö_dpb
[
i
] +Ö_Vid->
poc_g≠
;

1747 if(
missögpoc
 > 
p_Vid
->
óæõr_missög_poc
)

1749 
p_Vid
->
óæõr_missög_poc
 = 
missögpoc
;

1750 
c⁄˚Æ_to_pi˘uª
->
t›_poc
 = 
missögpoc
;

1751 
c⁄˚Æ_to_pi˘uª
->
bŸtom_poc
 = 
missögpoc
;

1752 
c⁄˚Æ_to_pi˘uª
->
‰ame_poc
 = 
missögpoc
;

1753 
c⁄˚Æ_to_pi˘uª
->
poc
 = 
missögpoc
;

1754 
c⁄˚Æ_‰om_pi˘uª
 = 
	`gë_pic_‰om_dpb
(
p_Dpb
, 
missögpoc
, &
pos
);

1756 
	`as£π
(
c⁄˚Æ_‰om_pi˘uª
 !
NULL
);

1758 
p_Dpb
->
u£d_size
 = 
pos
 + 1;

1760 
p_Vid
->
‰ame_to_c⁄˚Æ
 = 
c⁄˚Æ_‰om_pi˘uª
->
‰ame_num
 + 1;

1762 
	`upd©e_ªf_li°_f‹_c⁄˚Æmít
(
p_Dpb
);

1763 
p_Vid
->
c⁄˚Æ_¶i˚_ty≥
 = 
B_SLICE
;

1764 
	`c›y_to_c⁄˚Æ
(
c⁄˚Æ_‰om_pi˘uª
, 
c⁄˚Æ_to_pi˘uª
, 
p_Vid
);

1765 
c⁄˚Æmít_±r
 = 
	`öô_node
–
c⁄˚Æ_to_pi˘uª
, 
missögpoc
 );

1766 
	`add_node
(
p_Vid
, 
c⁄˚Æmít_±r
);

1775 
p_Dpb
->
u£d_size
 = 
ãmp_u£d_size
;

1776 
	}
}

1787 
	$¶idög_wödow_poc_m™agemít
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
St‹abÀPi˘uª
 *
p
)

1789 i‡(
p_Dpb
->
u£d_size
 =p_Dpb->
size
)

1791 
VideoP¨amëîs
 *
p_Vid
 = 
p_Dpb
->p_Vid;

1792 
i
;

1794 
i
=0;i<
p_Dpb
->
size
-1; i++)

1795 
p_Vid
->
pocs_ö_dpb
[
i
] =Ö_Vid->pocs_in_dpb[i+1];

1797 
	}
}

1811 
	$wrôe_lo°_n⁄_ªf_pic
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
poc
, 
p_out
)

1813 
VideoP¨amëîs
 *
p_Vid
 = 
p_Dpb
->p_Vid;

1814 
FømeSt‹e
 
c⁄˚Æmít_fs
;

1815 if(
poc
 > 0)

1817 if((
poc
 - 
p_Dpb
->
œ°_ouçut_poc
Ë> 
p_Vid
->
poc_g≠
)

1820 
c⁄˚Æmít_fs
.
‰ame
 = 
p_Vid
->
c⁄˚Æmít_hód
->
pi˘uª
;

1821 
c⁄˚Æmít_fs
.
is_ouçut
 = 0;

1822 
c⁄˚Æmít_fs
.
is_ª„ªn˚
 = 0;

1823 
c⁄˚Æmít_fs
.
is_u£d
 = 3;

1825 
	`wrôe_°‹ed_‰ame
(
p_Vid
, &
c⁄˚Æmít_fs
, 
p_out
);

1826 
	`dñëe_node
(
p_Vid
,Ö_Vid->
c⁄˚Æmít_hód
);

1829 
	}
}

1840 
	$wrôe_lo°_ªf_a·î_idr
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
pos
)

1842 
VideoP¨amëîs
 *
p_Vid
 = 
p_Dpb
->p_Vid;

1844 
ãmp
 = 1;

1846 if(
p_Vid
->
œ°_out_fs
->
‰ame
 =
NULL
)

1848 
p_Vid
->
œ°_out_fs
->
‰ame
 = 
	`Æloc_°‹abÀ_pi˘uª
 (p_Vid, 
FRAME
,Ö_Vid->
width
,Ö_Vid->
height
,

1849 
p_Vid
->
width_¸
,Ö_Vid->
height_¸
, 1);

1850 
p_Vid
->
œ°_out_fs
->
is_u£d
 = 3;

1853 if(
p_Vid
->
c⁄˚Æ_mode
 == 2)

1855 
ãmp
 = 2;

1856 
p_Vid
->
c⁄˚Æ_mode
 = 1;

1858 
	`c›y_to_c⁄˚Æ
(
p_Dpb
->
fs
[
pos
]->
‰ame
, 
p_Vid
->
œ°_out_fs
->frame,Ö_Vid);

1860 
p_Vid
->
c⁄˚Æ_mode
 = 
ãmp
;

1861 
	}
}

	@ldecod/src/errorconcealment.c

32 
	~"c⁄åibut‹s.h
"

33 
	~"globÆ.h
"

34 
	~"ñemíts.h
"

52 
	$£t_ec_Êag
(
VideoP¨amëîs
 *
p_Vid
, 
£
)

59 
£
)

61 
SE_HEADER
 :

62 
p_Vid
->
ec_Êag
[
SE_HEADER
] = 
EC_REQ
;

63 
SE_PTYPE
 :

64 
p_Vid
->
ec_Êag
[
SE_PTYPE
] = 
EC_REQ
;

65 
SE_MBTYPE
 :

66 
p_Vid
->
ec_Êag
[
SE_MBTYPE
] = 
EC_REQ
;

68 
SE_REFFRAME
 :

69 
p_Vid
->
ec_Êag
[
SE_REFFRAME
] = 
EC_REQ
;

70 
p_Vid
->
ec_Êag
[
SE_MVD
] = 
EC_REQ
;

71 
£
 = 
SE_CBP_INTER
;

74 
SE_INTRAPREDMODE
 :

75 
p_Vid
->
ec_Êag
[
SE_INTRAPREDMODE
] = 
EC_REQ
;

76 
£
 = 
SE_CBP_INTRA
;

78 
SE_MVD
 :

79 
p_Vid
->
ec_Êag
[
SE_MVD
] = 
EC_REQ
;

80 
£
 = 
SE_CBP_INTER
;

87 
£
)

89 
SE_CBP_INTRA
 :

90 
p_Vid
->
ec_Êag
[
SE_CBP_INTRA
] = 
EC_REQ
;

91 
SE_LUM_DC_INTRA
 :

92 
p_Vid
->
ec_Êag
[
SE_LUM_DC_INTRA
] = 
EC_REQ
;

93 
SE_CHR_DC_INTRA
 :

94 
p_Vid
->
ec_Êag
[
SE_CHR_DC_INTRA
] = 
EC_REQ
;

95 
SE_LUM_AC_INTRA
 :

96 
p_Vid
->
ec_Êag
[
SE_LUM_AC_INTRA
] = 
EC_REQ
;

97 
SE_CHR_AC_INTRA
 :

98 
p_Vid
->
ec_Êag
[
SE_CHR_AC_INTRA
] = 
EC_REQ
;

101 
SE_CBP_INTER
 :

102 
p_Vid
->
ec_Êag
[
SE_CBP_INTER
] = 
EC_REQ
;

103 
SE_LUM_DC_INTER
 :

104 
p_Vid
->
ec_Êag
[
SE_LUM_DC_INTER
] = 
EC_REQ
;

105 
SE_CHR_DC_INTER
 :

106 
p_Vid
->
ec_Êag
[
SE_CHR_DC_INTER
] = 
EC_REQ
;

107 
SE_LUM_AC_INTER
 :

108 
p_Vid
->
ec_Êag
[
SE_LUM_AC_INTER
] = 
EC_REQ
;

109 
SE_CHR_AC_INTER
 :

110 
p_Vid
->
ec_Êag
[
SE_CHR_AC_INTER
] = 
EC_REQ
;

112 
SE_DELTA_QUANT_INTER
 :

113 
p_Vid
->
ec_Êag
[
SE_DELTA_QUANT_INTER
] = 
EC_REQ
;

115 
SE_DELTA_QUANT_INTRA
 :

116 
p_Vid
->
ec_Êag
[
SE_DELTA_QUANT_INTRA
] = 
EC_REQ
;

122  
EC_REQ
;

123 
	}
}

132 
	$ª£t_ec_Êags
(
VideoP¨amëîs
 *
p_Vid
)

134 
i
;

135 
i
=0; i<
SE_MAX_ELEMENTS
; i++)

136 
p_Vid
->
ec_Êag
[
i
] = 
NO_EC
;

137 
	}
}

151 
	$gë_c⁄˚Æed_ñemít
(
VideoP¨amëîs
 *
p_Vid
, 
Sy¡axEÀmít
 *
sym
)

153 i‡(
p_Vid
->
ec_Êag
[
sym
->
ty≥
] =
NO_EC
)

154  
NO_EC
;

160 
sym
->
ty≥
)

162 
SE_HEADER
 :

163 
sym
->
Àn
 = 31;

164 
sym
->
öf
 = 0;

167 
SE_PTYPE
 :

168 
SE_MBTYPE
 :

169 
SE_REFFRAME
 :

170 
sym
->
Àn
 = 1;

171 
sym
->
öf
 = 0;

174 
SE_INTRAPREDMODE
 :

175 
SE_MVD
 :

176 
sym
->
Àn
 = 1;

177 
sym
->
öf
 = 0;

180 
SE_CBP_INTRA
 :

181 
sym
->
Àn
 = 5;

182 
sym
->
öf
 = 0;

185 
SE_LUM_DC_INTRA
 :

186 
SE_CHR_DC_INTRA
 :

187 
SE_LUM_AC_INTRA
 :

188 
SE_CHR_AC_INTRA
 :

189 
sym
->
Àn
 = 1;

190 
sym
->
öf
 = 0;

193 
SE_CBP_INTER
 :

194 
sym
->
Àn
 = 1;

195 
sym
->
öf
 = 0;

198 
SE_LUM_DC_INTER
 :

199 
SE_CHR_DC_INTER
 :

200 
SE_LUM_AC_INTER
 :

201 
SE_CHR_AC_INTER
 :

202 
sym
->
Àn
 = 1;

203 
sym
->
öf
 = 0;

206 
SE_DELTA_QUANT_INTER
:

207 
sym
->
Àn
 = 1;

208 
sym
->
öf
 = 0;

210 
SE_DELTA_QUANT_INTRA
:

211 
sym
->
Àn
 = 1;

212 
sym
->
öf
 = 0;

218  
EC_REQ
;

219 
	}
}

	@ldecod/src/filehandle.c

14 
	~"c⁄åibut‹s.h
"

15 
	~"globÆ.h
"

16 
	~"mbuf„r.h
"

19 #i‡
TRACE


27 
	$de˘ø˚bô˙t
(
cou¡
)

29 
p_Dec
->
bôcou¡î
 -
cou¡
;

30 
	}
}

39 
	$åa˚bôs
(

40 c⁄° *
åa˚_°r
,

41 
Àn
,

42 
öfo
,

43 
vÆue1
)

45 
i
, 
ch¨s
;

48 if(
Àn
>=64)

50 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "LengthárgumentÅoÖutÅooÜong forÅraceÅo work");

51 
	`îr‹
 (
îr‹ãxt
, 600);

54 
	`putc
('@', 
p_Dec
->
p_åa˚
);

55 
ch¨s
 = 
	`Ârötf
(
p_Dec
->
p_åa˚
, "%i",Ö_Dec->
bôcou¡î
);

56 
ch¨s
++ < 5)

57 
	`putc
(' ',
p_Dec
->
p_åa˚
);

59 
ch¨s
 +
	`Ârötf
(
p_Dec
->
p_åa˚
, " %s", 
åa˚_°r
);

60 
ch¨s
++ < 55)

61 
	`putc
(' ',
p_Dec
->
p_åa˚
);

64 if(
Àn
<15)

66 
i
=0 ; i<15-
Àn
 ; i++)

67 
	`Âutc
(' ', 
p_Dec
->
p_åa˚
);

71 
i
=0 ; i<
Àn
/2 ; i++)

73 
	`Âutc
('0', 
p_Dec
->
p_åa˚
);

76 
	`Ârötf
(
p_Dec
->
p_åa˚
, "1");

79 
i
=0 ; i<
Àn
/2 ; i++)

81 i‡(0x01 & ( 
öfo
 >> ((
Àn
/2-
i
)-1)))

82 
	`Âutc
('1', 
p_Dec
->
p_åa˚
);

84 
	`Âutc
('0', 
p_Dec
->
p_åa˚
);

87 
	`Ârötf
(
p_Dec
->
p_åa˚
, " (%3dË\n", 
vÆue1
);

88 
p_Dec
->
bôcou¡î
 +
Àn
;

90 
	`fÊush
 (
p_Dec
->
p_åa˚
);

91 
	}
}

99 
	$åa˚bôs2
(

100 c⁄° *
åa˚_°r
,

101 
Àn
,

102 
öfo
)

105 
i
, 
ch¨s
;

108 if(
Àn
>=64)

110 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "LengthárgumentÅoÖutÅooÜong forÅraceÅo work");

111 
	`îr‹
 (
îr‹ãxt
, 600);

114 
	`putc
('@', 
p_Dec
->
p_åa˚
);

115 
ch¨s
 = 
	`Ârötf
(
p_Dec
->
p_åa˚
, "%i",Ö_Dec->
bôcou¡î
);

117 
ch¨s
++ < 5)

118 
	`putc
(' ',
p_Dec
->
p_åa˚
);

120 
ch¨s
 +
	`Ârötf
(
p_Dec
->
p_åa˚
, " %s", 
åa˚_°r
);

122 
ch¨s
++ < 55)

123 
	`putc
(' ',
p_Dec
->
p_åa˚
);

126 if(
Àn
 < 15)

128 
i
 = 0; i < 15 - 
Àn
; i++)

129 
	`Âutc
(' ', 
p_Dec
->
p_åa˚
);

132 
p_Dec
->
bôcou¡î
 +
Àn
;

133 
Àn
 >= 32)

135 
i
 = 0; i < 8; i++)

137 
	`Âutc
('0', 
p_Dec
->
p_åa˚
);

139 
Àn
 -= 8;

143 
i
=0 ; i<
Àn
 ; i++)

145 i‡(0x01 & ( 
öfo
 >> (
Àn
-
i
-1)))

146 
	`Âutc
('1', 
p_Dec
->
p_åa˚
);

148 
	`Âutc
('0', 
p_Dec
->
p_åa˚
);

151 
	`Ârötf
(
p_Dec
->
p_åa˚
, " (%3dË\n", 
öfo
);

153 
	`fÊush
 (
p_Dec
->
p_åa˚
);

154 
	}
}

162 
	$åa˚_öfo
(

163 
Sy¡axEÀmít
 *
cuºSE
,

164 c⁄° *
des¸ùti⁄_°r
,

165 
vÆue1


169 
t°rög
[20];

170 
	`•rötf
–
t°rög
, "%s%d", 
des¸ùti⁄_°r
, 
vÆue1
);

171 
	`°∫˝y
(
cuºSE
->
åa˚°rög
, 
t°rög
, 
TRACESTRING_SIZE
);

172 
	}
}

	@ldecod/src/fmo.c

17 
	~"globÆ.h
"

18 
	~"ñemíts.h
"

19 
	~"deföes.h
"

20 
	~"hódî.h
"

21 
	~"fmo.h
"

22 
	~"Á°_mem‹y.h
"

26 
FmoGíî©eTy≥0M≠UnôM≠
 (
VideoP¨amëîs
 *
p_Vid
, 
PicSizeInM≠Unôs
 );

27 
FmoGíî©eTy≥1M≠UnôM≠
 (
VideoP¨amëîs
 *
p_Vid
, 
PicSizeInM≠Unôs
 );

28 
FmoGíî©eTy≥2M≠UnôM≠
 (
VideoP¨amëîs
 *
p_Vid
, 
PicSizeInM≠Unôs
 );

29 
FmoGíî©eTy≥3M≠UnôM≠
 (
VideoP¨amëîs
 *
p_Vid
, 
PicSizeInM≠Unôs
, 
Sli˚
 *
cuºSli˚
 );

30 
FmoGíî©eTy≥4M≠UnôM≠
 (
VideoP¨amëîs
 *
p_Vid
, 
PicSizeInM≠Unôs
, 
Sli˚
 *
cuºSli˚
 );

31 
FmoGíî©eTy≥5M≠UnôM≠
 (
VideoP¨amëîs
 *
p_Vid
, 
PicSizeInM≠Unôs
, 
Sli˚
 *
cuºSli˚
 );

32 
FmoGíî©eTy≥6M≠UnôM≠
 (
VideoP¨amëîs
 *
p_Vid
, 
PicSizeInM≠Unôs
 );

46 
	$FmoGíî©eM≠UnôToSli˚GroupM≠
 (
VideoP¨amëîs
 *
p_Vid
, 
Sli˚
 *
cuºSli˚
)

48 
£q_∑ømëî_£t_rb•_t
* 
•s
 = 
p_Vid
->
a˘ive_•s
;

49 
pic_∑ømëî_£t_rb•_t
* 
µs
 = 
p_Vid
->
a˘ive_µs
;

51 
NumSli˚GroupM≠Unôs
;

53 
NumSli˚GroupM≠Unôs
 = (
•s
->
pic_height_ö_m≠_unôs_möus1
+1)* (•s->
pic_width_ö_mbs_möus1
+1);

55 i‡(
µs
->
¶i˚_group_m≠_ty≥
 == 6)

57 i‡((
µs
->
pic_size_ö_m≠_unôs_möus1
 + 1Ë!
NumSli˚GroupM≠Unôs
)

59 
	`îr‹
 ("wrongÖps->pic_size_in_map_units_minus1 for used SPSánd FMOÅype 6", 500);

64 i‡(
p_Vid
->
M≠UnôToSli˚GroupM≠
)

65 
	`‰ì
 (
p_Vid
->
M≠UnôToSli˚GroupM≠
);

66 i‡((
p_Vid
->
M≠UnôToSli˚GroupM≠
 = 
	`mÆloc
 ((
NumSli˚GroupM≠Unôs
Ë*  ())Ë=
NULL
)

68 
	`¥ötf
 ("ˇ¬ŸáŒoˇãd %d byã†f‹Ö_Vid->M≠UnôToSli˚GroupM≠,Éxô\n", (Ë–(
µs
->
pic_size_ö_m≠_unôs_möus1
+1) *  ()));

69 
	`exô
 (-1);

72 i‡(
µs
->
num_¶i˚_groups_möus1
 == 0)

74 
	`Á°_mem£t
 (
p_Vid
->
M≠UnôToSli˚GroupM≠
, 0, 
NumSli˚GroupM≠Unôs
 *  ());

78 
µs
->
¶i˚_group_m≠_ty≥
)

81 
	`FmoGíî©eTy≥0M≠UnôM≠
 (
p_Vid
, 
NumSli˚GroupM≠Unôs
);

84 
	`FmoGíî©eTy≥1M≠UnôM≠
 (
p_Vid
, 
NumSli˚GroupM≠Unôs
);

87 
	`FmoGíî©eTy≥2M≠UnôM≠
 (
p_Vid
, 
NumSli˚GroupM≠Unôs
);

90 
	`FmoGíî©eTy≥3M≠UnôM≠
 (
p_Vid
, 
NumSli˚GroupM≠Unôs
, 
cuºSli˚
);

93 
	`FmoGíî©eTy≥4M≠UnôM≠
 (
p_Vid
, 
NumSli˚GroupM≠Unôs
, 
cuºSli˚
);

96 
	`FmoGíî©eTy≥5M≠UnôM≠
 (
p_Vid
, 
NumSli˚GroupM≠Unôs
, 
cuºSli˚
);

99 
	`FmoGíî©eTy≥6M≠UnôM≠
 (
p_Vid
, 
NumSli˚GroupM≠Unôs
);

102 
	`¥ötf
 ("IŒegÆ sli˚_group_m≠_ty≥ %d ,Éxô \n", (Ë
µs
->
¶i˚_group_m≠_ty≥
);

103 
	`exô
 (-1);

106 
	}
}

119 
	$FmoGíî©eMbToSli˚GroupM≠
 (
VideoP¨amëîs
 *
p_Vid
, 
Sli˚
 *
pSli˚
)

121 
£q_∑ømëî_£t_rb•_t
* 
•s
 = 
p_Vid
->
a˘ive_•s
;

123 
i
;

126 i‡(
p_Vid
->
MbToSli˚GroupM≠
)

127 
	`‰ì
 (
p_Vid
->
MbToSli˚GroupM≠
);

129 i‡((
p_Vid
->
MbToSli˚GroupM≠
 = 
	`mÆloc
 (’_Vid->
PicSizeInMbs
Ë*  ())Ë=
NULL
)

131 
	`¥ötf
 ("ˇ¬ŸáŒoˇã %d byã†f‹Ö_Vid->MbToSli˚GroupM≠,Éxô\n", (Ë((
p_Vid
->
PicSizeInMbs
) *  ()));

132 
	`exô
 (-1);

136 i‡((
•s
->
‰ame_mbs_⁄ly_Êag
)|| 
pSli˚
->
fõld_pic_Êag
)

138 *
MbToSli˚GroupM≠
 = 
p_Vid
->MbToSliceGroupMap;

139 *
M≠UnôToSli˚GroupM≠
 = 
p_Vid
->MapUnitToSliceGroupMap;

140 
i
=0; i<
p_Vid
->
PicSizeInMbs
; i++)

142 *
MbToSli˚GroupM≠
++ = *
M≠UnôToSli˚GroupM≠
++;

146 i‡(
•s
->
mb_ad≠tive_‰ame_fõld_Êag
 && (!
pSli˚
->
fõld_pic_Êag
))

148 
i
=0; i<
p_Vid
->
PicSizeInMbs
; i++)

150 
p_Vid
->
MbToSli˚GroupM≠
[
i
] =Ö_Vid->
M≠UnôToSli˚GroupM≠
[i/2];

155 
i
=0; i<
p_Vid
->
PicSizeInMbs
; i++)

157 
p_Vid
->
MbToSli˚GroupM≠
[
i
] =Ö_Vid->
M≠UnôToSli˚GroupM≠
[(i/(2*p_Vid->
PicWidthInMbs
))*p_Vid->PicWidthInMbs+(i%p_Vid->PicWidthInMbs)];

161 
	}
}

173 
	$fmo_öô
(
VideoP¨amëîs
 *
p_Vid
, 
Sli˚
 *
pSli˚
)

175 
pic_∑ømëî_£t_rb•_t
* 
µs
 = 
p_Vid
->
a˘ive_µs
;

177 #ifde‡
PRINT_FMO_MAPS


178 
i
,
j
;

181 
	`FmoGíî©eM≠UnôToSli˚GroupM≠
(
p_Vid
, 
pSli˚
);

182 
	`FmoGíî©eMbToSli˚GroupM≠
(
p_Vid
, 
pSli˚
);

184 
p_Vid
->
NumbîOfSli˚Groups
 = 
µs
->
num_¶i˚_groups_möus1
 + 1;

186 #ifde‡
PRINT_FMO_MAPS


187 
	`¥ötf
("\n");

188 
	`¥ötf
("FMO Map (Units):\n");

190 
j
=0; j<
p_Vid
->
PicHeightInM≠Unôs
; j++)

192 
i
=0; i<
p_Vid
->
PicWidthInMbs
; i++)

194 
	`¥ötf
("%c",48+
p_Vid
->
M≠UnôToSli˚GroupM≠
[
i
+
j
*p_Vid->
PicWidthInMbs
]);

196 
	`¥ötf
("\n");

198 
	`¥ötf
("\n");

199 
	`¥ötf
("FMO Map (Mb):\n");

201 
j
=0; j<
p_Vid
->
PicHeightInMbs
; j++)

203 
i
=0; i<
p_Vid
->
PicWidthInMbs
; i++)

205 
	`¥ötf
("%c",48 + 
p_Vid
->
MbToSli˚GroupM≠
[
i
 + 
j
 *Ö_Vid->
PicWidthInMbs
]);

207 
	`¥ötf
("\n");

209 
	`¥ötf
("\n");

214 
	}
}

223 
	$FmoFöô
(
VideoP¨amëîs
 *
p_Vid
)

225 i‡(
p_Vid
->
MbToSli˚GroupM≠
)

227 
	`‰ì
 (
p_Vid
->
MbToSli˚GroupM≠
);

228 
p_Vid
->
MbToSli˚GroupM≠
 = 
NULL
;

230 i‡(
p_Vid
->
M≠UnôToSli˚GroupM≠
)

232 
	`‰ì
 (
p_Vid
->
M≠UnôToSli˚GroupM≠
);

233 
p_Vid
->
M≠UnôToSli˚GroupM≠
 = 
NULL
;

236 
	}
}

248 
	$FmoGëNumbîOfSli˚Group
(
VideoP¨amëîs
 *
p_Vid
)

250  
p_Vid
->
NumbîOfSli˚Groups
;

251 
	}
}

266 
	$FmoGëLa°MBOfPi˘uª
(
VideoP¨amëîs
 *
p_Vid
)

268  
	`FmoGëLa°MBInSli˚Group
 (
p_Vid
, 
	`FmoGëNumbîOfSli˚Group
(p_Vid)-1);

269 
	}
}

282 
	$FmoGëLa°MBInSli˚Group
 (
VideoP¨amëîs
 *
p_Vid
, 
Sli˚Group
)

284 
i
;

286 
i
=
p_Vid
->
PicSizeInMbs
-1; i>=0; i--)

287 i‡(
	`FmoGëSli˚GroupId
 (
p_Vid
, 
i
Ë=
Sli˚Group
)

288  
i
;

291 
	}
}

305 
	$FmoGëSli˚GroupId
 (
VideoP¨amëîs
 *
p_Vid
, 
mb
)

307 
	`as£π
 (
mb
 < (Ë
p_Vid
->
PicSizeInMbs
);

308 
	`as£π
 (
p_Vid
->
MbToSli˚GroupM≠
 !
NULL
);

309  
p_Vid
->
MbToSli˚GroupM≠
[
mb
];

310 
	}
}

325 
	$FmoGëNextMBNr
 (
VideoP¨amëîs
 *
p_Vid
, 
CuºítMbNr
)

327 
Sli˚Group
 = 
	`FmoGëSli˚GroupId
 (
p_Vid
, 
CuºítMbNr
);

329 ++
CuºítMbNr
<()
p_Vid
->
PicSizeInMbs
 &&Ö_Vid->
MbToSli˚GroupM≠
 [CuºítMbNr] !
Sli˚Group
)

332 i‡(
CuºítMbNr
 >()
p_Vid
->
PicSizeInMbs
)

335  
CuºítMbNr
;

336 
	}
}

346 
	$FmoGíî©eTy≥0M≠UnôM≠
 (
VideoP¨amëîs
 *
p_Vid
, 
PicSizeInM≠Unôs
 )

348 
pic_∑ømëî_£t_rb•_t
* 
µs
 = 
p_Vid
->
a˘ive_µs
;

349 
iGroup
, 
j
;

350 
i
 = 0;

353  
iGroup
 = 0;

354 (
iGroup
 <
µs
->
num_¶i˚_groups_möus1
Ë&& (
i
 < 
PicSizeInM≠Unôs
);

355 
i
 +
µs
->
run_Àngth_möus1
[
iGroup
++] + 1 )

357  
j
 = 0; j <
µs
->
run_Àngth_möus1
[ 
iGroup
 ] && 
i
 + j < 
PicSizeInM≠Unôs
; j++ )

358 
p_Vid
->
M≠UnôToSli˚GroupM≠
[
i
+
j
] = 
iGroup
;

361  
i
 < 
PicSizeInM≠Unôs
 );

362 
	}
}

372 
	$FmoGíî©eTy≥1M≠UnôM≠
 (
VideoP¨amëîs
 *
p_Vid
, 
PicSizeInM≠Unôs
 )

374 
pic_∑ømëî_£t_rb•_t
* 
µs
 = 
p_Vid
->
a˘ive_µs
;

375 
i
;

376  
i
 = 0; i < 
PicSizeInM≠Unôs
; i++ )

378 
p_Vid
->
M≠UnôToSli˚GroupM≠
[
i
] = ((i%p_Vid->
PicWidthInMbs
)+(((i/p_Vid->PicWidthInMbs)*(
µs
->
num_¶i˚_groups_möus1
+1))/2))

379 %(
µs
->
num_¶i˚_groups_möus1
+1);

381 
	}
}

390 
	$FmoGíî©eTy≥2M≠UnôM≠
 (
VideoP¨amëîs
 *
p_Vid
, 
PicSizeInM≠Unôs
 )

392 
pic_∑ømëî_£t_rb•_t
* 
µs
 = 
p_Vid
->
a˘ive_µs
;

393 
iGroup
;

394 
i
, 
x
, 
y
;

395 
yT›Le·
, 
xT›Le·
, 
yBŸtomRight
, 
xBŸtomRight
;

397  
i
 = 0; i < 
PicSizeInM≠Unôs
; i++ )

398 
p_Vid
->
M≠UnôToSli˚GroupM≠
[ 
i
 ] = 
µs
->
num_¶i˚_groups_möus1
;

400  
iGroup
 = 
µs
->
num_¶i˚_groups_möus1
 - 1 ; iGroup >= 0; iGroup-- )

402 
yT›Le·
 = 
µs
->
t›_À·
[ 
iGroup
 ] / 
p_Vid
->
PicWidthInMbs
;

403 
xT›Le·
 = 
µs
->
t›_À·
[ 
iGroup
 ] % 
p_Vid
->
PicWidthInMbs
;

404 
yBŸtomRight
 = 
µs
->
bŸtom_right
[ 
iGroup
 ] / 
p_Vid
->
PicWidthInMbs
;

405 
xBŸtomRight
 = 
µs
->
bŸtom_right
[ 
iGroup
 ] % 
p_Vid
->
PicWidthInMbs
;

406  
y
 = 
yT›Le·
; y <
yBŸtomRight
; y++ )

407  
x
 = 
xT›Le·
; x <
xBŸtomRight
; x++ )

408 
p_Vid
->
M≠UnôToSli˚GroupM≠
[ 
y
 *Ö_Vid->
PicWidthInMbs
 + 
x
 ] = 
iGroup
;

410 
	}
}

420 
	$FmoGíî©eTy≥3M≠UnôM≠
 (
VideoP¨amëîs
 *
p_Vid
, 
PicSizeInM≠Unôs
, 
Sli˚
 *
cuºSli˚
 )

422 
pic_∑ømëî_£t_rb•_t
* 
µs
 = 
p_Vid
->
a˘ive_µs
;

423 
i
, 
k
;

424 
À·Bound
, 
t›Bound
, 
rightBound
, 
bŸtomBound
;

425 
x
, 
y
, 
xDú
, 
yDú
;

426 
m≠UnôVaˇ¡
;

428 
m≠UnôsInSli˚Group0
 = 
	`imö
((
µs
->
¶i˚_group_ch™ge_øã_möus1
 + 1Ë* 
cuºSli˚
->
¶i˚_group_ch™ge_cy˛e
, 
PicSizeInM≠Unôs
);

430  
i
 = 0; i < 
PicSizeInM≠Unôs
; i++ )

431 
p_Vid
->
M≠UnôToSli˚GroupM≠
[ 
i
 ] = 2;

433 
x
 = ( 
p_Vid
->
PicWidthInMbs
 - 
µs
->
¶i˚_group_ch™ge_dúe˘i⁄_Êag
 ) / 2;

434 
y
 = ( 
p_Vid
->
PicHeightInM≠Unôs
 - 
µs
->
¶i˚_group_ch™ge_dúe˘i⁄_Êag
 ) / 2;

436 
À·Bound
 = 
x
;

437 
t›Bound
 = 
y
;

438 
rightBound
 = 
x
;

439 
bŸtomBound
 = 
y
;

441 
xDú
 = 
µs
->
¶i˚_group_ch™ge_dúe˘i⁄_Êag
 - 1;

442 
yDú
 = 
µs
->
¶i˚_group_ch™ge_dúe˘i⁄_Êag
;

444  
k
 = 0; k < 
PicSizeInM≠Unôs
; k +
m≠UnôVaˇ¡
 )

446 
m≠UnôVaˇ¡
 = ( 
p_Vid
->
M≠UnôToSli˚GroupM≠
[ 
y
 *Ö_Vid->
PicWidthInMbs
 + 
x
 ] == 2 );

447 if–
m≠UnôVaˇ¡
 )

448 
p_Vid
->
M≠UnôToSli˚GroupM≠
[ 
y
 *Ö_Vid->
PicWidthInMbs
 + 
x
 ] = ( 
k
 >
m≠UnôsInSli˚Group0
 );

450 if–
xDú
 =-1 && 
x
 =
À·Bound
 )

452 
À·Bound
 = 
	`imax
(ÜeftBound - 1, 0 );

453 
x
 = 
À·Bound
;

454 
xDú
 = 0;

455 
yDú
 = 2 * 
µs
->
¶i˚_group_ch™ge_dúe˘i⁄_Êag
 - 1;

458 if–
xDú
 =1 && 
x
 =
rightBound
 )

460 
rightBound
 = 
	`imö
–rightBound + 1, ()
p_Vid
->
PicWidthInMbs
 - 1 );

461 
x
 = 
rightBound
;

462 
xDú
 = 0;

463 
yDú
 = 1 - 2 * 
µs
->
¶i˚_group_ch™ge_dúe˘i⁄_Êag
;

466 if–
yDú
 =-1 && 
y
 =
t›Bound
 )

468 
t›Bound
 = 
	`imax
(ÅopBound - 1, 0 );

469 
y
 = 
t›Bound
;

470 
xDú
 = 1 - 2 * 
µs
->
¶i˚_group_ch™ge_dúe˘i⁄_Êag
;

471 
yDú
 = 0;

474 if–
yDú
 =1 && 
y
 =
bŸtomBound
 )

476 
bŸtomBound
 = 
	`imö
–bŸtomBound + 1, ()
p_Vid
->
PicHeightInM≠Unôs
 - 1 );

477 
y
 = 
bŸtomBound
;

478 
xDú
 = 2 * 
µs
->
¶i˚_group_ch™ge_dúe˘i⁄_Êag
 - 1;

479 
yDú
 = 0;

483 
x
 = x + 
xDú
;

484 
y
 = y + 
yDú
;

488 
	}
}

497 
	$FmoGíî©eTy≥4M≠UnôM≠
 (
VideoP¨amëîs
 *
p_Vid
, 
PicSizeInM≠Unôs
, 
Sli˚
 *
cuºSli˚
 )

499 
pic_∑ømëî_£t_rb•_t
* 
µs
 = 
p_Vid
->
a˘ive_µs
;

501 
m≠UnôsInSli˚Group0
 = 
	`imö
((
µs
->
¶i˚_group_ch™ge_øã_möus1
 + 1Ë* 
cuºSli˚
->
¶i˚_group_ch™ge_cy˛e
, 
PicSizeInM≠Unôs
);

502 
sizeOfUµîLe·Group
 = 
µs
->
¶i˚_group_ch™ge_dúe˘i⁄_Êag
 ? ( 
PicSizeInM≠Unôs
 - 
m≠UnôsInSli˚Group0
 ) : mapUnitsInSliceGroup0;

504 
i
;

506  
i
 = 0; i < 
PicSizeInM≠Unôs
; i++ )

507 if–
i
 < 
sizeOfUµîLe·Group
 )

508 
p_Vid
->
M≠UnôToSli˚GroupM≠
[ 
i
 ] = 
µs
->
¶i˚_group_ch™ge_dúe˘i⁄_Êag
;

510 
p_Vid
->
M≠UnôToSli˚GroupM≠
[ 
i
 ] = 1 - 
µs
->
¶i˚_group_ch™ge_dúe˘i⁄_Êag
;

512 
	}
}

521 
	$FmoGíî©eTy≥5M≠UnôM≠
 (
VideoP¨amëîs
 *
p_Vid
, 
PicSizeInM≠Unôs
, 
Sli˚
 *
cuºSli˚
 )

523 
pic_∑ømëî_£t_rb•_t
* 
µs
 = 
p_Vid
->
a˘ive_µs
;

525 
m≠UnôsInSli˚Group0
 = 
	`imö
((
µs
->
¶i˚_group_ch™ge_øã_möus1
 + 1Ë* 
cuºSli˚
->
¶i˚_group_ch™ge_cy˛e
, 
PicSizeInM≠Unôs
);

526 
sizeOfUµîLe·Group
 = 
µs
->
¶i˚_group_ch™ge_dúe˘i⁄_Êag
 ? ( 
PicSizeInM≠Unôs
 - 
m≠UnôsInSli˚Group0
 ) : mapUnitsInSliceGroup0;

528 
i
,
j
, 
k
 = 0;

530  
j
 = 0; j < 
p_Vid
->
PicWidthInMbs
; j++ )

531  
i
 = 0; i < 
p_Vid
->
PicHeightInM≠Unôs
; i++ )

532 if–
k
++ < 
sizeOfUµîLe·Group
 )

533 
p_Vid
->
M≠UnôToSli˚GroupM≠
[ 
i
 *Ö_Vid->
PicWidthInMbs
 + 
j
 ] = 
µs
->
¶i˚_group_ch™ge_dúe˘i⁄_Êag
;

535 
p_Vid
->
M≠UnôToSli˚GroupM≠
[ 
i
 *Ö_Vid->
PicWidthInMbs
 + 
j
 ] = 1 - 
µs
->
¶i˚_group_ch™ge_dúe˘i⁄_Êag
;

537 
	}
}

546 
	$FmoGíî©eTy≥6M≠UnôM≠
 (
VideoP¨amëîs
 *
p_Vid
, 
PicSizeInM≠Unôs
 )

548 
pic_∑ømëî_£t_rb•_t
* 
µs
 = 
p_Vid
->
a˘ive_µs
;

549 
i
;

550 
i
=0; i<
PicSizeInM≠Unôs
; i++)

552 
p_Vid
->
M≠UnôToSli˚GroupM≠
[
i
] = 
µs
->
¶i˚_group_id
[i];

554 
	}
}

	@ldecod/src/header.c

12 
	~"globÆ.h
"

13 
	~"ñemíts.h
"

14 
	~"deföes.h
"

15 
	~"fmo.h
"

16 
	~"vlc.h
"

17 
	~"mbuf„r.h
"

18 
	~"hódî.h
"

20 
	~"˘x_èbÀs.h
"

23 #i‡
TRACE


24 
	#SYMTRACESTRING
(
s
Ë
	`°∫˝y
(
sym
.
åa˚°rög
,s,
TRACESTRING_SIZE
)

	)

26 
	#SYMTRACESTRING
(
s
)

28 

	)

29 
ªf_pic_li°_ª‹dîög
(
Sli˚
 *
cuºSli˚
);

30 
¥ed_weight_èbÀ
(
Sli˚
 *
cuºSli˚
);

31 #i‡(
MVC_EXTENSION_ENABLE
)

32 
ªf_pic_li°_mvc_modifiˇti⁄
(
Sli˚
 *
cuºSli˚
);

42 
	$CeûLog2
–
uiVÆ
)

44 
uiTmp
 = 
uiVÆ
-1;

45 
uiRë
 = 0;

47  
uiTmp
 != 0 )

49 
uiTmp
 >>= 1;

50 
uiRë
++;

52  
uiRë
;

53 
	}
}

55 
	$CeûLog2_sf
–
uiVÆ
)

57 
uiTmp
 = 
uiVÆ
-1;

58 
uiRë
 = 0;

60  
uiTmp
 > 0 )

62 
uiTmp
 >>= 1;

63 
uiRë
++;

65  
uiRë
;

66 
	}
}

76 
	$Fú°P¨tOfSli˚Hódî
(
Sli˚
 *
cuºSli˚
)

78 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

79 
byã
 
dP_ƒ
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
dp_mode
][
SE_HEADER
];

80 
D©aP¨tôi⁄
 *
∑πôi⁄
 = &(
cuºSli˚
->
∑πAº
[
dP_ƒ
]);

81 
Bô°ªam
 *
cuºSåóm
 = 
∑πôi⁄
->
bô°ªam
;

82 
tmp
;

84 
p_Dec
->
U£dBôs

∑πôi⁄
->
bô°ªam
->
‰ame_bôoff£t
;

87 
cuºSli˚
->
°¨t_mb_ƒ
 = 
	`ªad_ue_v
 ("SH: fú°_mb_ö_¶i˚", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

89 
tmp
 = 
	`ªad_ue_v
 ("SH: sli˚_ty≥", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

91 i‡(
tmp
 > 4)Åmp -= 5;

93 
p_Vid
->
ty≥
 = 
cuºSli˚
->
¶i˚_ty≥
 = (
Sli˚Ty≥
Ë
tmp
;

95 
cuºSli˚
->
pic_∑ømëî_£t_id
 = 
	`ªad_ue_v
 ("SH:Öic_∑ømëî_£t_id", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

97 if–
p_Vid
->
£∑øã_cﬁour_∂™e_Êag
 )

98 
cuºSli˚
->
cﬁour_∂™e_id
 = 
	`ªad_u_v
 (2, "SH: cﬁour_∂™e_id", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

100 
cuºSli˚
->
cﬁour_∂™e_id
 = 
PLANE_Y
;

102  
p_Dec
->
U£dBôs
;

103 
	}
}

113 
	$Re°OfSli˚Hódî
(
Sli˚
 *
cuºSli˚
)

115 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

116 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºSli˚
->p_Inp;

117 
£q_∑ømëî_£t_rb•_t
 *
a˘ive_•s
 = 
p_Vid
->active_sps;

119 
byã
 
dP_ƒ
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
dp_mode
][
SE_HEADER
];

120 
D©aP¨tôi⁄
 *
∑πôi⁄
 = &(
cuºSli˚
->
∑πAº
[
dP_ƒ
]);

121 
Bô°ªam
 *
cuºSåóm
 = 
∑πôi⁄
->
bô°ªam
;

123 
vÆ
, 
Àn
;

125 
cuºSli˚
->
‰ame_num
 = 
	`ªad_u_v
 (
a˘ive_•s
->
log2_max_‰ame_num_möus4
 + 4, "SH: føme_num", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

128 if(
cuºSli˚
->
idr_Êag
)

130 
p_Vid
->
¥e_‰ame_num
 = 
cuºSli˚
->
‰ame_num
;

132 
p_Vid
->
œ°_ªf_pic_poc
 = 0;

133 
	`as£π
(
cuºSli˚
->
‰ame_num
 == 0);

136 i‡(
a˘ive_•s
->
‰ame_mbs_⁄ly_Êag
)

138 
p_Vid
->
°ru˘uª
 = 
FRAME
;

139 
cuºSli˚
->
fõld_pic_Êag
=0;

144 
cuºSli˚
->
fõld_pic_Êag
 = 
	`ªad_u_1
("SH: fõld_pic_Êag", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

145 i‡(
cuºSli˚
->
fõld_pic_Êag
)

148 
cuºSli˚
->
bŸtom_fõld_Êag
 = (
byã
Ë
	`ªad_u_1
("SH: bŸtom_fõld_Êag", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

149 
p_Vid
->
°ru˘uª
 = 
cuºSli˚
->
bŸtom_fõld_Êag
 ? 
BOTTOM_FIELD
 : 
TOP_FIELD
;

153 
p_Vid
->
°ru˘uª
 = 
FRAME
;

154 
cuºSli˚
->
bŸtom_fõld_Êag
 = 
FALSE
;

158 
cuºSli˚
->
°ru˘uª
 = (
Pi˘uªSåu˘uª
Ë
p_Vid
->structure;

160 
cuºSli˚
->
mb_aff_‰ame_Êag
 = (
a˘ive_•s
->
mb_ad≠tive_‰ame_fõld_Êag
 && (cuºSli˚->
fõld_pic_Êag
==0));

163 i‡(
p_Vid
->
°ru˘uª
 =
FRAME
 )

164 
	`as£π
 (
cuºSli˚
->
fõld_pic_Êag
 == 0);

165 i‡(
p_Vid
->
°ru˘uª
 =
TOP_FIELD
 )

166 
	`as£π
 (
cuºSli˚
->
fõld_pic_Êag
 =1 && (cuºSli˚->
bŸtom_fõld_Êag
 =
FALSE
));

167 i‡(
p_Vid
->
°ru˘uª
 =
BOTTOM_FIELD
)

168 
	`as£π
 (
cuºSli˚
->
fõld_pic_Êag
 =1 && (cuºSli˚->
bŸtom_fõld_Êag
 =
TRUE
 ));

170 i‡(
cuºSli˚
->
idr_Êag
)

172 
cuºSli˚
->
idr_pic_id
 = 
	`ªad_ue_v
("SH: idr_pic_id", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

174 #i‡(
MVC_EXTENSION_ENABLE
)

175 i‡–
cuºSli˚
->
svc_exãnsi⁄_Êag
 =0 && cuºSli˚->
NÆuHódîMVCExt
.
n⁄_idr_Êag
 == 0 )

177 
cuºSli˚
->
idr_pic_id
 = 
	`ªad_ue_v
("SH: idr_pic_id", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

181 i‡(
a˘ive_•s
->
pic_‹dî_˙t_ty≥
 == 0)

183 
cuºSli˚
->
pic_‹dî_˙t_lsb
 = 
	`ªad_u_v
(
a˘ive_•s
->
log2_max_pic_‹dî_˙t_lsb_möus4
 + 4, "SH:Öic_‹dî_˙t_lsb", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

184 if–
p_Vid
->
a˘ive_µs
->
bŸtom_fõld_pic_‹dî_ö_‰ame_¥e£¡_Êag
 =1 && !
cuºSli˚
->
fõld_pic_Êag
 )

185 
cuºSli˚
->
dñè_pic_‹dî_˙t_bŸtom
 = 
	`ªad_£_v
("SH: dñè_pic_‹dî_˙t_bŸtom", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

187 
cuºSli˚
->
dñè_pic_‹dî_˙t_bŸtom
 = 0;

189 if–
a˘ive_•s
->
pic_‹dî_˙t_ty≥
 == 1 )

191 i‡–!
a˘ive_•s
->
dñè_pic_‹dî_Æways_zîo_Êag
 )

193 
cuºSli˚
->
dñè_pic_‹dî_˙t
[ 0 ] = 
	`ªad_£_v
("SH: dñè_pic_‹dî_˙t[0]", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

194 if–
p_Vid
->
a˘ive_µs
->
bŸtom_fõld_pic_‹dî_ö_‰ame_¥e£¡_Êag
 =1 && !
cuºSli˚
->
fõld_pic_Êag
 )

195 
cuºSli˚
->
dñè_pic_‹dî_˙t
[ 1 ] = 
	`ªad_£_v
("SH: dñè_pic_‹dî_˙t[1]", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

197 
cuºSli˚
->
dñè_pic_‹dî_˙t
[ 1 ] = 0;

201 
cuºSli˚
->
dñè_pic_‹dî_˙t
[ 0 ] = 0;

202 
cuºSli˚
->
dñè_pic_‹dî_˙t
[ 1 ] = 0;

207 i‡(
p_Vid
->
a˘ive_µs
->
ªdund™t_pic_˙t_¥e£¡_Êag
)

209 
cuºSli˚
->
ªdund™t_pic_˙t
 = 
	`ªad_ue_v
 ("SH:Ñedund™t_pic_˙t", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

212 if(
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
)

214 
cuºSli˚
->
dúe˘_•©ül_mv_¥ed_Êag
 = 
	`ªad_u_1
 ("SH: dúe˘_•©ül_mv_¥ed_Êag", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

217 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
] = 
p_Vid
->
a˘ive_µs
->
num_ªf_idx_l0_deÁu…_a˘ive_möus1
 + 1;

218 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_1
] = 
p_Vid
->
a˘ive_µs
->
num_ªf_idx_l1_deÁu…_a˘ive_möus1
 + 1;

220 if(
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
 || cuºSli˚->¶i˚_ty≥ =
SP_SLICE
 || cuºSli˚->¶i˚_ty≥ =
B_SLICE
)

222 
vÆ
 = 
	`ªad_u_1
 ("SH:Çum_ªf_idx_ovîride_Êag", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

223 i‡(
vÆ
)

225 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
] = 1 + 
	`ªad_ue_v
 ("SH:Çum_ªf_idx_l0_a˘ive_möus1", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

227 if(
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
)

229 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_1
] = 1 + 
	`ªad_ue_v
 ("SH:Çum_ªf_idx_l1_a˘ive_möus1", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

233 i‡(
cuºSli˚
->
¶i˚_ty≥
!=
B_SLICE
)

235 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_1
] = 0;

238 #i‡(
MVC_EXTENSION_ENABLE
)

239 i‡(
cuºSli˚
->
svc_exãnsi⁄_Êag
 == 0 || currSlice->svc_extension_flag == 1)

240 
	`ªf_pic_li°_mvc_modifiˇti⁄
(
cuºSli˚
);

242 
	`ªf_pic_li°_ª‹dîög
(
cuºSli˚
);

244 
	`ªf_pic_li°_ª‹dîög
(
cuºSli˚
);

247 
cuºSli˚
->
weighãd_¥ed_Êag
 = (Ë((cuºSli˚->
¶i˚_ty≥
 =
P_SLICE
 || cuºSli˚->¶i˚_ty≥ =
SP_SLICE
)

248 ? 
p_Vid
->
a˘ive_µs
->
weighãd_¥ed_Êag


249 : (
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
 && 
p_Vid
->
a˘ive_µs
->
weighãd_bùªd_idc
 == 1));

250 
cuºSli˚
->
weighãd_bùªd_idc
 = (Ë(cuºSli˚->
¶i˚_ty≥
 =
B_SLICE
 && 
p_Vid
->
a˘ive_µs
->weighted_bipred_idc > 0);

252 i‡((
p_Vid
->
a˘ive_µs
->
weighãd_¥ed_Êag
&&(
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
|| cuºSli˚->¶i˚_ty≥ =
SP_SLICE
))||

253 (
p_Vid
->
a˘ive_µs
->
weighãd_bùªd_idc
==1 && (
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
)))

255 
	`¥ed_weight_èbÀ
(
cuºSli˚
);

258 i‡(
cuºSli˚
->
«l_ª„ªn˚_idc
)

259 
	`dec_ªf_pic_m¨kög
(
p_Vid
, 
cuºSåóm
, 
cuºSli˚
);

261 i‡(
p_Vid
->
a˘ive_µs
->
íå›y_codög_mode_Êag
 && 
cuºSli˚
->
¶i˚_ty≥
 !
I_SLICE
 && cuºSli˚->¶i˚_ty≥ !
SI_SLICE
)

263 
cuºSli˚
->
modñ_numbî
 = 
	`ªad_ue_v
("SH: cabac_öô_idc", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

267 
cuºSli˚
->
modñ_numbî
 = 0;

270 
cuºSli˚
->
¶i˚_qp_dñè
 = 
vÆ
 = 
	`ªad_£_v
("SH: sli˚_qp_dñè", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

272 
cuºSli˚
->
qp
 = 26 + 
p_Vid
->
a˘ive_µs
->
pic_öô_qp_möus26
 + 
vÆ
;

274 i‡((
cuºSli˚
->
qp
 < -
p_Vid
->
bôdïth_luma_qp_sˇÀ
) || (currSlice->qp > 51))

275 
	`îr‹
 ("slice_qp_delta makes slice_qp_y out ofÑange", 500);

277 if(
cuºSli˚
->
¶i˚_ty≥
 =
SP_SLICE
 || cuºSli˚->¶i˚_ty≥ =
SI_SLICE
)

279 if(
cuºSli˚
->
¶i˚_ty≥
==
SP_SLICE
)

281 
cuºSli˚
->
•_swôch
 = 
	`ªad_u_1
 ("SH: sp_f‹_swôch_Êag", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

283 
cuºSli˚
->
¶i˚_qs_dñè
 = 
vÆ
 = 
	`ªad_£_v
("SH: sli˚_qs_dñè", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

284 
cuºSli˚
->
qs
 = 26 + 
p_Vid
->
a˘ive_µs
->
pic_öô_qs_möus26
 + 
vÆ
;

285 i‡((
cuºSli˚
->
qs
 < 0) || (currSlice->qs > 51))

286 
	`îr‹
 ("slice_qs_delta makes slice_qs_y out ofÑange", 500);

289 i‡–!
	`HI_öåa_⁄ly_¥ofûe
(
a˘ive_•s
->
¥ofûe_idc
,á˘ive_•s->
c⁄°øöed_£t3_Êag
Ë|| (
p_I≈
->
öåa_¥ofûe_deblockög
 == 1) )

292 #i‡
DPF_PARAM_DISP


293 
	`¥ötf
("deblockög_fûãr_c⁄åﬁ_¥e£¡_Êag:%d\n", 
p_Vid
->
a˘ive_µs
->
deblockög_fûãr_c⁄åﬁ_¥e£¡_Êag
);

295 i‡(
p_Vid
->
a˘ive_µs
->
deblockög_fûãr_c⁄åﬁ_¥e£¡_Êag
)

297 
cuºSli˚
->
DFDißbÀIdc
 = (Ë
	`ªad_ue_v
 ("SH: dißbÀ_deblockög_fûãr_idc", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

299 i‡(
cuºSli˚
->
DFDißbÀIdc
!=1)

301 
cuºSli˚
->
DFAÕhaC0Off£t
 = (Ë(2 * 
	`ªad_£_v
("SH: sli˚_Æpha_c0_off£t_div2", 
cuºSåóm
, &
p_Dec
->
U£dBôs
));

302 
cuºSli˚
->
DFBëaOff£t
 = (Ë(2 * 
	`ªad_£_v
("SH: sli˚_bëa_off£t_div2", 
cuºSåóm
, &
p_Dec
->
U£dBôs
));

306 
cuºSli˚
->
DFAÕhaC0Off£t
 = cuºSli˚->
DFBëaOff£t
 = 0;

311 
cuºSli˚
->
DFDißbÀIdc
 = cuºSli˚->
DFAÕhaC0Off£t
 = cuºSli˚->
DFBëaOff£t
 = 0;

313 #i‡
DPF_PARAM_DISP


314 
	`¥ötf
("Sli˚:%d, DFP¨amëîs:(%d,%d,%d)\n\n", 
cuºSli˚
->
cuºít_¶i˚_ƒ
, cuºSli˚->
DFDißbÀIdc
, cuºSli˚->
DFAÕhaC0Off£t
, cuºSli˚->
DFBëaOff£t
);

320 i‡(
p_Vid
->
a˘ive_µs
->
deblockög_fûãr_c⁄åﬁ_¥e£¡_Êag
)

322 
cuºSli˚
->
DFDißbÀIdc
 = (Ë
	`ªad_ue_v
 ("SH: dißbÀ_deblockög_fûãr_idc", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

324 i‡(
cuºSli˚
->
DFDißbÀIdc
!=1)

326 
cuºSli˚
->
DFAÕhaC0Off£t
 = (Ë(2 * 
	`ªad_£_v
("SH: sli˚_Æpha_c0_off£t_div2", 
cuºSåóm
, &
p_Dec
->
U£dBôs
));

327 
cuºSli˚
->
DFBëaOff£t
 = (Ë(2 * 
	`ªad_£_v
("SH: sli˚_bëa_off£t_div2", 
cuºSåóm
, &
p_Dec
->
U£dBôs
));

331 
cuºSli˚
->
DFDißbÀIdc
 =1;

332 
cuºSli˚
->
DFAÕhaC0Off£t
 = cuºSli˚->
DFBëaOff£t
 = 0;

336 i‡(
p_Vid
->
a˘ive_µs
->
num_¶i˚_groups_möus1
>0 &&Ö_Vid->a˘ive_µs->
¶i˚_group_m≠_ty≥
>=3 &&

337 
p_Vid
->
a˘ive_µs
->
¶i˚_group_m≠_ty≥
<=5)

339 
Àn
 = (
a˘ive_•s
->
pic_height_ö_m≠_unôs_möus1
+1)*◊˘ive_•s->
pic_width_ö_mbs_möus1
+1)/

340 (
p_Vid
->
a˘ive_µs
->
¶i˚_group_ch™ge_øã_möus1
+1);

341 i‡(((
a˘ive_•s
->
pic_height_ö_m≠_unôs_möus1
+1)*◊˘ive_•s->
pic_width_ö_mbs_möus1
+1))%

342 (
p_Vid
->
a˘ive_µs
->
¶i˚_group_ch™ge_øã_möus1
+1))

343 
Àn
 +=1;

345 
Àn
 = 
	`CeûLog2
(len+1);

347 
cuºSli˚
->
¶i˚_group_ch™ge_cy˛e
 = 
	`ªad_u_v
 (
Àn
, "SH: sli˚_group_ch™ge_cy˛e", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

349 
p_Vid
->
PicHeightInMbs
 =Ö_Vid->
FømeHeightInMbs
 / ( 1 + 
cuºSli˚
->
fõld_pic_Êag
 );

350 
p_Vid
->
PicSizeInMbs
 =Ö_Vid->
PicWidthInMbs
 *Ö_Vid->
PicHeightInMbs
;

351 
p_Vid
->
FømeSizeInMbs
 =Ö_Vid->
PicWidthInMbs
 *Ö_Vid->
FømeHeightInMbs
;

353  
p_Dec
->
U£dBôs
;

354 
	}
}

363 
	$ªf_pic_li°_ª‹dîög
(
Sli˚
 *
cuºSli˚
)

366 
byã
 
dP_ƒ
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
dp_mode
][
SE_HEADER
];

367 
D©aP¨tôi⁄
 *
∑πôi⁄
 = &(
cuºSli˚
->
∑πAº
[
dP_ƒ
]);

368 
Bô°ªam
 *
cuºSåóm
 = 
∑πôi⁄
->
bô°ªam
;

369 
i
, 
vÆ
;

371 
	`Æloc_ªf_pic_li°_ª‹dîög_buf„r
(
cuºSli˚
);

373 i‡(
cuºSli˚
->
¶i˚_ty≥
 !
I_SLICE
 && cuºSli˚->¶i˚_ty≥ !
SI_SLICE
)

375 
vÆ
 = 
cuºSli˚
->
ªf_pic_li°_ª‹dîög_Êag
[
LIST_0
] = 
	`ªad_u_1
 ("SH:Ñef_pic_li°_ª‹dîög_Êag_l0", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

377 i‡(
vÆ
)

379 
i
=0;

382 
vÆ
 = 
cuºSli˚
->
modifiˇti⁄_of_pic_nums_idc
[
LIST_0
][
i
] = 
	`ªad_ue_v
("SH: modifiˇti⁄_of_pic_nums_idc_l0", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

383 i‡(
vÆ
==0 || val==1)

385 
cuºSli˚
->
abs_diff_pic_num_möus1
[
LIST_0
][
i
] = 
	`ªad_ue_v
("SH:ábs_diff_pic_num_möus1_l0", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

389 i‡(
vÆ
==2)

391 
cuºSli˚
->
l⁄g_ãrm_pic_idx
[
LIST_0
][
i
] = 
	`ªad_ue_v
("SH:Ü⁄g_ãrm_pic_idx_l0", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

394 
i
++;

396 } 
vÆ
 != 3);

400 i‡(
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
)

402 
vÆ
 = 
cuºSli˚
->
ªf_pic_li°_ª‹dîög_Êag
[
LIST_1
] = 
	`ªad_u_1
 ("SH:Ñef_pic_li°_ª‹dîög_Êag_l1", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

404 i‡(
vÆ
)

406 
i
=0;

409 
vÆ
 = 
cuºSli˚
->
modifiˇti⁄_of_pic_nums_idc
[
LIST_1
][
i
] = 
	`ªad_ue_v
("SH: modifiˇti⁄_of_pic_nums_idc_l1", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

410 i‡(
vÆ
==0 || val==1)

412 
cuºSli˚
->
abs_diff_pic_num_möus1
[
LIST_1
][
i
] = 
	`ªad_ue_v
("SH:ábs_diff_pic_num_möus1_l1", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

416 i‡(
vÆ
==2)

418 
cuºSli˚
->
l⁄g_ãrm_pic_idx
[
LIST_1
][
i
] = 
	`ªad_ue_v
("SH:Ü⁄g_ãrm_pic_idx_l1", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

421 
i
++;

423 } 
vÆ
 != 3);

428 if(
cuºSli˚
->
ªdund™t_pic_˙t
 && (cuºSli˚->
¶i˚_ty≥
 !
I_SLICE
) )

430 
cuºSli˚
->
ªdund™t_¶i˚_ªf_idx
 = cuºSli˚->
abs_diff_pic_num_möus1
[
LIST_0
][0] + 1;

432 
	}
}

440 #i‡(
MVC_EXTENSION_ENABLE
)

441 
	$ªf_pic_li°_mvc_modifiˇti⁄
(
Sli˚
 *
cuºSli˚
)

444 
byã
 
dP_ƒ
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
dp_mode
][
SE_HEADER
];

445 
D©aP¨tôi⁄
 *
∑πôi⁄
 = &(
cuºSli˚
->
∑πAº
[
dP_ƒ
]);

446 
Bô°ªam
 *
cuºSåóm
 = 
∑πôi⁄
->
bô°ªam
;

447 
i
, 
vÆ
;

449 
	`Æloc_ªf_pic_li°_ª‹dîög_buf„r
(
cuºSli˚
);

451 i‡((
cuºSli˚
->
¶i˚_ty≥
 % 5Ë!
I_SLICE
 && (cuºSli˚->¶i˚_ty≥ % 5Ë!
SI_SLICE
)

453 
vÆ
 = 
cuºSli˚
->
ªf_pic_li°_ª‹dîög_Êag
[
LIST_0
] = 
	`ªad_u_1
 ("SH:Ñef_pic_li°_modifiˇti⁄_Êag_l0", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

455 i‡(
vÆ
)

457 
i
=0;

460 
vÆ
 = 
cuºSli˚
->
modifiˇti⁄_of_pic_nums_idc
[
LIST_0
][
i
] = 
	`ªad_ue_v
("SH: modifiˇti⁄_of_pic_nums_idc_l0", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

461 i‡(
vÆ
==0 || val==1)

463 
cuºSli˚
->
abs_diff_pic_num_möus1
[
LIST_0
][
i
] = 
	`ªad_ue_v
("SH:ábs_diff_pic_num_möus1_l0", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

467 i‡(
vÆ
==2)

469 
cuºSli˚
->
l⁄g_ãrm_pic_idx
[
LIST_0
][
i
] = 
	`ªad_ue_v
("SH:Ü⁄g_ãrm_pic_idx_l0", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

471 i‡(
vÆ
==4 || val==5)

473 
cuºSli˚
->
abs_diff_võw_idx_möus1
[
LIST_0
][
i
] = 
	`ªad_ue_v
("SH:ábs_diff_võw_idx_möus1_l0", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

476 
i
++;

478 } 
vÆ
 != 3);

482 i‡((
cuºSli˚
->
¶i˚_ty≥
 % 5Ë=
B_SLICE
)

484 
vÆ
 = 
cuºSli˚
->
ªf_pic_li°_ª‹dîög_Êag
[
LIST_1
] = 
	`ªad_u_1
 ("SH:Ñef_pic_li°_ª‹dîög_Êag_l1", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

486 i‡(
vÆ
)

488 
i
=0;

491 
vÆ
 = 
cuºSli˚
->
modifiˇti⁄_of_pic_nums_idc
[
LIST_1
][
i
] = 
	`ªad_ue_v
("SH: modifiˇti⁄_of_pic_nums_idc_l1", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

492 i‡(
vÆ
==0 || val==1)

494 
cuºSli˚
->
abs_diff_pic_num_möus1
[
LIST_1
][
i
] = 
	`ªad_ue_v
("SH:ábs_diff_pic_num_möus1_l1", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

498 i‡(
vÆ
==2)

500 
cuºSli˚
->
l⁄g_ãrm_pic_idx
[
LIST_1
][
i
] = 
	`ªad_ue_v
("SH:Ü⁄g_ãrm_pic_idx_l1", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

502 i‡(
vÆ
==4 || val==5)

504 
cuºSli˚
->
abs_diff_võw_idx_möus1
[
LIST_1
][
i
] = 
	`ªad_ue_v
("SH:ábs_diff_võw_idx_möus1_l1", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

507 
i
++;

509 } 
vÆ
 != 3);

514 if(
cuºSli˚
->
ªdund™t_pic_˙t
 && (cuºSli˚->
¶i˚_ty≥
 !
I_SLICE
) )

516 
cuºSli˚
->
ªdund™t_¶i˚_ªf_idx
 = cuºSli˚->
abs_diff_pic_num_möus1
[
LIST_0
][0] + 1;

518 
	}
}

521 
	$ª£t_wp_∑øms
(
Sli˚
 *
cuºSli˚
)

523 
i
,
comp
;

524 
log_weight_díom
;

526 
i
=0; i<
MAX_REFERENCE_PICTURES
; i++)

528 
comp
=0; comp<3; comp++)

530 
log_weight_díom
 = (
comp
 =0Ë? 
cuºSli˚
->
luma_log2_weight_díom
 : cuºSli˚->
chroma_log2_weight_díom
;

531 
cuºSli˚
->
wp_weight
[0][
i
][
comp
] = 1 << 
log_weight_díom
;

532 
cuºSli˚
->
wp_weight
[1][
i
][
comp
] = 1 << 
log_weight_díom
;

535 
	}
}

543 
	$¥ed_weight_èbÀ
(
Sli˚
 *
cuºSli˚
)

545 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

546 
£q_∑ømëî_£t_rb•_t
 *
a˘ive_•s
 = 
p_Vid
->active_sps;

547 
byã
 
dP_ƒ
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
dp_mode
][
SE_HEADER
];

548 
D©aP¨tôi⁄
 *
∑πôi⁄
 = &(
cuºSli˚
->
∑πAº
[
dP_ƒ
]);

549 
Bô°ªam
 *
cuºSåóm
 = 
∑πôi⁄
->
bô°ªam
;

550 
luma_weight_Êag_l0
, 
luma_weight_Êag_l1
, 
chroma_weight_Êag_l0
, 
chroma_weight_Êag_l1
;

551 
i
,
j
;

553 
cuºSli˚
->
luma_log2_weight_díom
 = (Ë
	`ªad_ue_v
 ("SH:Üuma_log2_weight_díom", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

554 
cuºSli˚
->
wp_round_luma
 = cuºSli˚->
luma_log2_weight_díom
 ? 1<<(currSlice->luma_log2_weight_denom - 1): 0;

556 i‡–0 !
a˘ive_•s
->
chroma_f‹m©_idc
)

558 
cuºSli˚
->
chroma_log2_weight_díom
 = (Ë
	`ªad_ue_v
 ("SH: chroma_log2_weight_díom", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

559 
cuºSli˚
->
wp_round_chroma
 = cuºSli˚->
chroma_log2_weight_díom
 ? 1<<(currSlice->chroma_log2_weight_denom - 1): 0;

562 
	`ª£t_wp_∑øms
(
cuºSli˚
);

564 
i
=0; i<
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
]; i++)

566 
luma_weight_Êag_l0
 = 
	`ªad_u_1
("SH:Üuma_weight_Êag_l0", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

568 i‡(
luma_weight_Êag_l0
)

570 
cuºSli˚
->
wp_weight
[
LIST_0
][
i
][0] = 
	`ªad_£_v
 ("SH:Üuma_weight_l0", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

571 
cuºSli˚
->
wp_off£t
[
LIST_0
][
i
][0] = 
	`ªad_£_v
 ("SH:Üuma_off£t_l0", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

572 
cuºSli˚
->
wp_off£t
[
LIST_0
][
i
][0] = cuºSli˚->wp_off£t[LIST_0][i][0]<<(
p_Vid
->
bôdïth_luma
 - 8);

576 
cuºSli˚
->
wp_weight
[
LIST_0
][
i
][0] = 1 << cuºSli˚->
luma_log2_weight_díom
;

577 
cuºSli˚
->
wp_off£t
[
LIST_0
][
i
][0] = 0;

580 i‡(
a˘ive_•s
->
chroma_f‹m©_idc
 != 0)

582 
chroma_weight_Êag_l0
 = 
	`ªad_u_1
 ("SH: chroma_weight_Êag_l0", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

584 
j
=1; j<3; j++)

586 i‡(
chroma_weight_Êag_l0
)

588 
cuºSli˚
->
wp_weight
[
LIST_0
][
i
][
j
] = 
	`ªad_£_v
("SH: chroma_weight_l0", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

589 
cuºSli˚
->
wp_off£t
[
LIST_0
][
i
][
j
] = 
	`ªad_£_v
("SH: chroma_off£t_l0", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

590 
cuºSli˚
->
wp_off£t
[
LIST_0
][
i
][
j
] = cuºSli˚->wp_off£t[LIST_0][i][j]<<(
p_Vid
->
bôdïth_chroma
-8);

594 
cuºSli˚
->
wp_weight
[
LIST_0
][
i
][
j
] = 1<<cuºSli˚->
chroma_log2_weight_díom
;

595 
cuºSli˚
->
wp_off£t
[
LIST_0
][
i
][
j
] = 0;

600 i‡((
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
Ë&& 
p_Vid
->
a˘ive_µs
->
weighãd_bùªd_idc
 == 1)

602 
i
=0; i<
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_1
]; i++)

604 
luma_weight_Êag_l1
 = 
	`ªad_u_1
("SH:Üuma_weight_Êag_l1", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

606 i‡(
luma_weight_Êag_l1
)

608 
cuºSli˚
->
wp_weight
[
LIST_1
][
i
][0] = 
	`ªad_£_v
 ("SH:Üuma_weight_l1", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

609 
cuºSli˚
->
wp_off£t
[
LIST_1
][
i
][0] = 
	`ªad_£_v
 ("SH:Üuma_off£t_l1", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

610 
cuºSli˚
->
wp_off£t
[
LIST_1
][
i
][0] = cuºSli˚->wp_off£t[LIST_1][i][0]<<(
p_Vid
->
bôdïth_luma
-8);

614 
cuºSli˚
->
wp_weight
[
LIST_1
][
i
][0] = 1<<cuºSli˚->
luma_log2_weight_díom
;

615 
cuºSli˚
->
wp_off£t
[
LIST_1
][
i
][0] = 0;

618 i‡(
a˘ive_•s
->
chroma_f‹m©_idc
 != 0)

620 
chroma_weight_Êag_l1
 = 
	`ªad_u_1
 ("SH: chroma_weight_Êag_l1", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

622 
j
=1; j<3; j++)

624 i‡(
chroma_weight_Êag_l1
)

626 
cuºSli˚
->
wp_weight
[
LIST_1
][
i
][
j
] = 
	`ªad_£_v
("SH: chroma_weight_l1", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

627 
cuºSli˚
->
wp_off£t
[
LIST_1
][
i
][
j
] = 
	`ªad_£_v
("SH: chroma_off£t_l1", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

628 
cuºSli˚
->
wp_off£t
[
LIST_1
][
i
][
j
] = cuºSli˚->wp_off£t[LIST_1][i][j]<<(
p_Vid
->
bôdïth_chroma
-8);

632 
cuºSli˚
->
wp_weight
[
LIST_1
][
i
][
j
] = 1<<cuºSli˚->
chroma_log2_weight_díom
;

633 
cuºSli˚
->
wp_off£t
[
LIST_1
][
i
][
j
] = 0;

639 
	}
}

648 
	$dec_ªf_pic_m¨kög
(
VideoP¨amëîs
 *
p_Vid
, 
Bô°ªam
 *
cuºSåóm
, 
Sli˚
 *
pSli˚
)

650 
vÆ
;

652 
DecRefPicM¨kög_t
 *
tmp_dΩm
,*
tmp_dΩm2
;

655 
pSli˚
->
dec_ªf_pic_m¨kög_buf„r
)

657 
tmp_dΩm
=
pSli˚
->
dec_ªf_pic_m¨kög_buf„r
;

659 
pSli˚
->
dec_ªf_pic_m¨kög_buf„r
=
tmp_dΩm
->
Next
;

660 
	`‰ì
 (
tmp_dΩm
);

663 #i‡(
MVC_EXTENSION_ENABLE
)

664 i‡–
pSli˚
->
idr_Êag
 || (pSli˚->
svc_exãnsi⁄_Êag
 =0 &&ÖSli˚->
NÆuHódîMVCExt
.
n⁄_idr_Êag
 == 0) )

666 i‡(
pSli˚
->
idr_Êag
)

669 
pSli˚
->
no_ouçut_of_¥i‹_pics_Êag
 = 
	`ªad_u_1
("SH:Ço_ouçut_of_¥i‹_pics_Êag", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

670 
p_Vid
->
no_ouçut_of_¥i‹_pics_Êag
 = 
pSli˚
->no_output_of_prior_pics_flag;

671 
pSli˚
->
l⁄g_ãrm_ª„ªn˚_Êag
 = 
	`ªad_u_1
("SH:Ü⁄g_ãrm_ª„ªn˚_Êag", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

675 
pSli˚
->
ad≠tive_ªf_pic_buf„rög_Êag
 = 
	`ªad_u_1
("SH:ád≠tive_ªf_pic_buf„rög_Êag", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

676 i‡(
pSli˚
->
ad≠tive_ªf_pic_buf„rög_Êag
)

681 
tmp_dΩm
=(
DecRefPicM¨kög_t
*)
	`ˇŒoc
 (1, (DecRefPicMarking_t));

682 
tmp_dΩm
->
Next
=
NULL
;

684 
vÆ
 = 
tmp_dΩm
->
mem‹y_m™agemít_c⁄åﬁ_›î©i⁄
 = 
	`ªad_ue_v
("SH: mem‹y_m™agemít_c⁄åﬁ_›î©i⁄", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

686 i‡((
vÆ
==1)||(val==3))

688 
tmp_dΩm
->
dif„ªn˚_of_pic_nums_möus1
 = 
	`ªad_ue_v
("SH: dif„ªn˚_of_pic_nums_möus1", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

690 i‡(
vÆ
==2)

692 
tmp_dΩm
->
l⁄g_ãrm_pic_num
 = 
	`ªad_ue_v
("SH:Ü⁄g_ãrm_pic_num", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

695 i‡((
vÆ
==3)||(val==6))

697 
tmp_dΩm
->
l⁄g_ãrm_‰ame_idx
 = 
	`ªad_ue_v
("SH:Ü⁄g_ãrm_‰ame_idx", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

699 i‡(
vÆ
==4)

701 
tmp_dΩm
->
max_l⁄g_ãrm_‰ame_idx_∂us1
 = 
	`ªad_ue_v
("SH: max_l⁄g_ãrm_pic_idx_∂us1", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

705 i‡(
pSli˚
->
dec_ªf_pic_m¨kög_buf„r
==
NULL
)

707 
pSli˚
->
dec_ªf_pic_m¨kög_buf„r
=
tmp_dΩm
;

711 
tmp_dΩm2
=
pSli˚
->
dec_ªf_pic_m¨kög_buf„r
;

712 
tmp_dΩm2
->
Next
!=
NULL
)Åmp_drpm2=tmp_drpm2->Next;

713 
tmp_dΩm2
->
Next
=
tmp_dΩm
;

717 
vÆ
 != 0);

720 
	}
}

733 
	$decode_poc
(
VideoP¨amëîs
 *
p_Vid
, 
Sli˚
 *
pSli˚
)

735 
£q_∑ømëî_£t_rb•_t
 *
a˘ive_•s
 = 
p_Vid
->active_sps;

736 
i
;

738 
MaxPicOrdîC¡Lsb
 = (1<<(
a˘ive_•s
->
log2_max_pic_‹dî_˙t_lsb_möus4
+4));

740  
a˘ive_•s
->
pic_‹dî_˙t_ty≥
 )

744 if(
pSli˚
->
idr_Êag
)

746 
p_Vid
->
PªvPicOrdîC¡Msb
 = 0;

747 
p_Vid
->
PªvPicOrdîC¡Lsb
 = 0;

751 i‡(
p_Vid
->
œ°_has_mmco_5
)

753 i‡(
p_Vid
->
œ°_pic_bŸtom_fõld
)

755 
p_Vid
->
PªvPicOrdîC¡Msb
 = 0;

756 
p_Vid
->
PªvPicOrdîC¡Lsb
 = 0;

760 
p_Vid
->
PªvPicOrdîC¡Msb
 = 0;

761 
p_Vid
->
PªvPicOrdîC¡Lsb
 = 
pSli˚
->
t›poc
;

766 if–
pSli˚
->
pic_‹dî_˙t_lsb
 < 
p_Vid
->
PªvPicOrdîC¡Lsb
 &&

767 –
p_Vid
->
PªvPicOrdîC¡Lsb
 - 
pSli˚
->
pic_‹dî_˙t_lsb
 ) >–
MaxPicOrdîC¡Lsb
 / 2 ) )

768 
pSli˚
->
PicOrdîC¡Msb
 = 
p_Vid
->
PªvPicOrdîC¡Msb
 + 
MaxPicOrdîC¡Lsb
;

769 i‡–
pSli˚
->
pic_‹dî_˙t_lsb
 > 
p_Vid
->
PªvPicOrdîC¡Lsb
 &&

770 –
pSli˚
->
pic_‹dî_˙t_lsb
 - 
p_Vid
->
PªvPicOrdîC¡Lsb
 ) > ( 
MaxPicOrdîC¡Lsb
 / 2 ) )

771 
pSli˚
->
PicOrdîC¡Msb
 = 
p_Vid
->
PªvPicOrdîC¡Msb
 - 
MaxPicOrdîC¡Lsb
;

773 
pSli˚
->
PicOrdîC¡Msb
 = 
p_Vid
->
PªvPicOrdîC¡Msb
;

777 if(
pSli˚
->
fõld_pic_Êag
==0)

779 
pSli˚
->
t›poc
 =ÖSli˚->
PicOrdîC¡Msb
 +ÖSli˚->
pic_‹dî_˙t_lsb
;

780 
pSli˚
->
bŸtompoc
 =ÖSli˚->
t›poc
 +ÖSli˚->
dñè_pic_‹dî_˙t_bŸtom
;

781 
pSli˚
->
ThisPOC
 =ÖSli˚->
‰amïoc
 = (pSli˚->
t›poc
 <ÖSli˚->
bŸtompoc
)?ÖSlice->toppoc :ÖSlice->bottompoc;

783 i‡(
pSli˚
->
bŸtom_fõld_Êag
 =
FALSE
)

785 
pSli˚
->
ThisPOC
pSli˚->
t›poc
 =ÖSli˚->
PicOrdîC¡Msb
 +ÖSli˚->
pic_‹dî_˙t_lsb
;

789 
pSli˚
->
ThisPOC
pSli˚->
bŸtompoc
 =ÖSli˚->
PicOrdîC¡Msb
 +ÖSli˚->
pic_‹dî_˙t_lsb
;

791 
pSli˚
->
‰amïoc
 =ÖSli˚->
ThisPOC
;

793 
p_Vid
->
ThisPOC
 = 
pSli˚
->ThisPOC;

796 
p_Vid
->
PªviousFømeNum
 = 
pSli˚
->
‰ame_num
;

798 if(
pSli˚
->
«l_ª„ªn˚_idc
)

800 
p_Vid
->
PªvPicOrdîC¡Lsb
 = 
pSli˚
->
pic_‹dî_˙t_lsb
;

801 
p_Vid
->
PªvPicOrdîC¡Msb
 = 
pSli˚
->
PicOrdîC¡Msb
;

808 if(
pSli˚
->
idr_Êag
)

810 
p_Vid
->
FømeNumOff£t
=0;

811 if(
pSli˚
->
‰ame_num
)

812 
	`îr‹
("frame_numÇotÉqualÅo zero in IDRÖicture", -1020);

816 i‡(
p_Vid
->
œ°_has_mmco_5
)

818 
p_Vid
->
PªviousFømeNumOff£t
 = 0;

819 
p_Vid
->
PªviousFømeNum
 = 0;

821 i‡(
pSli˚
->
‰ame_num
<
p_Vid
->
PªviousFømeNum
)

823 
p_Vid
->
FømeNumOff£t
 =Ö_Vid->
PªviousFømeNumOff£t
 +Ö_Vid->
max_‰ame_num
;

827 
p_Vid
->
FømeNumOff£t
 =Ö_Vid->
PªviousFømeNumOff£t
;

832 if(
a˘ive_•s
->
num_ªf_‰ames_ö_pic_‹dî_˙t_cy˛e
)

833 
pSli˚
->
AbsFømeNum
 = 
p_Vid
->
FømeNumOff£t
+pSli˚->
‰ame_num
;

835 
pSli˚
->
AbsFømeNum
=0;

836 if–(!
pSli˚
->
«l_ª„ªn˚_idc
Ë&&ÖSli˚->
AbsFømeNum
 > 0)

837 
pSli˚
->
AbsFømeNum
--;

840 
p_Vid
->
Ex≥˘edDñèPîPicOrdîC¡Cy˛e
=0;

842 if(
a˘ive_•s
->
num_ªf_‰ames_ö_pic_‹dî_˙t_cy˛e
)

843 
i
=0;i<(Ë
a˘ive_•s
->
num_ªf_‰ames_ö_pic_‹dî_˙t_cy˛e
;i++)

844 
p_Vid
->
Ex≥˘edDñèPîPicOrdîC¡Cy˛e
 +
a˘ive_•s
->
off£t_f‹_ªf_‰ame
[
i
];

846 if(
pSli˚
->
AbsFømeNum
)

848 
p_Vid
->
PicOrdîC¡Cy˛eC¡
 = (
pSli˚
->
AbsFømeNum
-1)/
a˘ive_•s
->
num_ªf_‰ames_ö_pic_‹dî_˙t_cy˛e
;

849 
p_Vid
->
FømeNumInPicOrdîC¡Cy˛e
 = (
pSli˚
->
AbsFømeNum
-1)%
a˘ive_•s
->
num_ªf_‰ames_ö_pic_‹dî_˙t_cy˛e
;

850 
p_Vid
->
Ex≥˘edPicOrdîC¡
 =Ö_Vid->
PicOrdîC¡Cy˛eC¡
*p_Vid->
Ex≥˘edDñèPîPicOrdîC¡Cy˛e
;

851 
i
=0;i<=()
p_Vid
->
FømeNumInPicOrdîC¡Cy˛e
;i++)

852 
p_Vid
->
Ex≥˘edPicOrdîC¡
 +
a˘ive_•s
->
off£t_f‹_ªf_‰ame
[
i
];

855 
p_Vid
->
Ex≥˘edPicOrdîC¡
=0;

857 if(!
pSli˚
->
«l_ª„ªn˚_idc
)

858 
p_Vid
->
Ex≥˘edPicOrdîC¡
 +
a˘ive_•s
->
off£t_f‹_n⁄_ªf_pic
;

860 if(
pSli˚
->
fõld_pic_Êag
==0)

862 
pSli˚
->
t›poc
 = 
p_Vid
->
Ex≥˘edPicOrdîC¡
 +ÖSli˚->
dñè_pic_‹dî_˙t
[0];

863 
pSli˚
->
bŸtompoc
 =ÖSli˚->
t›poc
 + 
a˘ive_•s
->
off£t_f‹_t›_to_bŸtom_fõld
 +ÖSli˚->
dñè_pic_‹dî_˙t
[1];

864 
pSli˚
->
ThisPOC
 =ÖSli˚->
‰amïoc
 = (pSli˚->
t›poc
 <ÖSli˚->
bŸtompoc
)?ÖSlice->toppoc :ÖSlice->bottompoc;

866 i‡(
pSli˚
->
bŸtom_fõld_Êag
 =
FALSE
)

868 
pSli˚
->
ThisPOC
 =ÖSli˚->
t›poc
 = 
p_Vid
->
Ex≥˘edPicOrdîC¡
 +ÖSli˚->
dñè_pic_‹dî_˙t
[0];

872 
pSli˚
->
ThisPOC
 =ÖSli˚->
bŸtompoc
 = 
p_Vid
->
Ex≥˘edPicOrdîC¡
 + 
a˘ive_•s
->
off£t_f‹_t›_to_bŸtom_fõld
 +ÖSli˚->
dñè_pic_‹dî_˙t
[0];

874 
pSli˚
->
‰amïoc
ıSli˚->
ThisPOC
;

876 
p_Vid
->
PªviousFømeNum
=
pSli˚
->
‰ame_num
;

877 
p_Vid
->
PªviousFømeNumOff£t
ı_Vid->
FømeNumOff£t
;

883 if(
pSli˚
->
idr_Êag
)

885 
p_Vid
->
FømeNumOff£t
=0;

886 
pSli˚
->
ThisPOC
 =ÖSli˚->
‰amïoc
 =ÖSli˚->
t›poc
 =ÖSli˚->
bŸtompoc
 = 0;

887 if(
pSli˚
->
‰ame_num
)

888 
	`îr‹
("frame_numÇotÉqualÅo zero in IDRÖicture", -1020);

892 i‡(
p_Vid
->
œ°_has_mmco_5
)

894 
p_Vid
->
PªviousFømeNum
 = 0;

895 
p_Vid
->
PªviousFømeNumOff£t
 = 0;

897 i‡(
pSli˚
->
‰ame_num
<
p_Vid
->
PªviousFømeNum
)

898 
p_Vid
->
FømeNumOff£t
 =Ö_Vid->
PªviousFømeNumOff£t
 +Ö_Vid->
max_‰ame_num
;

900 
p_Vid
->
FømeNumOff£t
 =Ö_Vid->
PªviousFømeNumOff£t
;

903 
pSli˚
->
AbsFømeNum
 = 
p_Vid
->
FømeNumOff£t
+pSli˚->
‰ame_num
;

904 if(!
pSli˚
->
«l_ª„ªn˚_idc
)

905 
pSli˚
->
ThisPOC
 = (2*pSli˚->
AbsFømeNum
 - 1);

907 
pSli˚
->
ThisPOC
 = (2*pSli˚->
AbsFømeNum
);

909 i‡(
pSli˚
->
fõld_pic_Êag
==0)

910 
pSli˚
->
t›poc
 =ÖSli˚->
bŸtompoc
 =ÖSli˚->
‰amïoc
 =ÖSli˚->
ThisPOC
;

911 i‡(
pSli˚
->
bŸtom_fõld_Êag
 =
FALSE
)

912 
pSli˚
->
t›poc
 =ÖSli˚->
‰amïoc
 =ÖSli˚->
ThisPOC
;

914 
pSli˚
->
bŸtompoc
 =ÖSli˚->
‰amïoc
 =ÖSli˚->
ThisPOC
;

917 
p_Vid
->
PªviousFømeNum
=
pSli˚
->
‰ame_num
;

918 
p_Vid
->
PªviousFømeNumOff£t
ı_Vid->
FømeNumOff£t
;

924 
	`as£π
( 1==0 );

927 
	}
}

937 
	$dumµoc
(
VideoP¨amëîs
 *
p_Vid
)

939 
£q_∑ømëî_£t_rb•_t
 *
a˘ive_•s
 = 
p_Vid
->active_sps;

941 
	`¥ötf
 ("\nPOCÜocals...\n");

942 
	`¥ötf
 ("t›po¯ %d\n", (Ë
p_Vid
->
µSli˚Li°
[0]->
t›poc
);

943 
	`¥ötf
 ("bŸtompo¯ %d\n", (Ë
p_Vid
->
µSli˚Li°
[0]->
bŸtompoc
);

944 
	`¥ötf
 ("‰ame_num %d\n", (Ë
p_Vid
->
µSli˚Li°
[0]->
‰ame_num
);

945 
	`¥ötf
 ("fõld_pic_Êag %d\n", (Ë
p_Vid
->
µSli˚Li°
[0]->
fõld_pic_Êag
);

946 
	`¥ötf
 ("bŸtom_fõld_Êag %d\n", (Ë
p_Vid
->
µSli˚Li°
[0]->
bŸtom_fõld_Êag
);

947 
	`¥ötf
 ("POC SPS\n");

948 
	`¥ötf
 ("log2_max_‰ame_num_möus4 %d\n", (Ë
a˘ive_•s
->
log2_max_‰ame_num_möus4
);

949 
	`¥ötf
 ("log2_max_pic_‹dî_˙t_lsb_möus4 %d\n", (Ë
a˘ive_•s
->
log2_max_pic_‹dî_˙t_lsb_möus4
);

950 
	`¥ötf
 ("pic_‹dî_˙t_ty≥ %d\n", (Ë
a˘ive_•s
->
pic_‹dî_˙t_ty≥
);

951 
	`¥ötf
 ("num_ªf_‰ames_ö_pic_‹dî_˙t_cy˛ê%d\n", (Ë
a˘ive_•s
->
num_ªf_‰ames_ö_pic_‹dî_˙t_cy˛e
);

952 
	`¥ötf
 ("dñè_pic_‹dî_Æways_zîo_Êag %d\n", (Ë
a˘ive_•s
->
dñè_pic_‹dî_Æways_zîo_Êag
);

953 
	`¥ötf
 ("off£t_f‹_n⁄_ªf_pi¯ %d\n", (Ë
a˘ive_•s
->
off£t_f‹_n⁄_ªf_pic
);

954 
	`¥ötf
 ("off£t_f‹_t›_to_bŸtom_fõld %d\n", (Ë
a˘ive_•s
->
off£t_f‹_t›_to_bŸtom_fõld
);

955 
	`¥ötf
 ("off£t_f‹_ªf_‰ame[0] %d\n", (Ë
a˘ive_•s
->
off£t_f‹_ªf_‰ame
[0]);

956 
	`¥ötf
 ("off£t_f‹_ªf_‰ame[1] %d\n", (Ë
a˘ive_•s
->
off£t_f‹_ªf_‰ame
[1]);

957 
	`¥ötf
 ("POC in SLice Header\n");

958 
	`¥ötf
 ("bŸtom_fõld_pic_‹dî_ö_‰ame_¥e£¡_Êag %d\n", (Ë
p_Vid
->
a˘ive_µs
->
bŸtom_fõld_pic_‹dî_ö_‰ame_¥e£¡_Êag
);

959 
	`¥ötf
 ("dñè_pic_‹dî_˙t[0] %d\n", (Ë
p_Vid
->
µSli˚Li°
[0]->
dñè_pic_‹dî_˙t
[0]);

960 
	`¥ötf
 ("dñè_pic_‹dî_˙t[1] %d\n", (Ë
p_Vid
->
µSli˚Li°
[0]->
dñè_pic_‹dî_˙t
[1]);

961 
	`¥ötf
 ("idr_Êag %d\n", (Ë
p_Vid
->
µSli˚Li°
[0]->
idr_Êag
);

962 
	`¥ötf
 ("max_‰ame_num %d\n", (Ë
p_Vid
->
max_‰ame_num
);

965 
	}
}

974 
	$pi˘uª_‹dî
–
Sli˚
 *
pSli˚
 )

976 i‡(
pSli˚
->
fõld_pic_Êag
==0)

977  
pSli˚
->
‰amïoc
;

978 i‡(
pSli˚
->
bŸtom_fõld_Êag
 =
FALSE
)

979  
pSli˚
->
t›poc
;

981  
pSli˚
->
bŸtompoc
;

982 
	}
}

	@ldecod/src/image.c

29 
	~"c⁄åibut‹s.h
"

31 
	~<m©h.h
>

32 
	~<limôs.h
>

34 
	~"globÆ.h
"

35 
	~"image.h
"

36 
	~"fmo.h
"

37 
	~"™√xb.h
"

38 
	~"«lu.h
"

39 
	~"∑r£t.h
"

40 
	~"hódî.h
"

42 
	~"£i.h
"

43 
	~"ouçut.h
"

44 
	~"mb_ac˚ss.h
"

45 
	~"memÆloc.h
"

46 
	~"ma¸oblock.h
"

48 
	~"lo›fûãr.h
"

50 
	~"büridecod.h
"

51 
	~"c⁄ãxt_öi.h
"

52 
	~"ˇbac.h
"

53 
	~"vlc.h
"

54 
	~"qu™t.h
"

56 
	~"îr‹c⁄˚Æmít.h
"

57 
	~"îc_≠i.h
"

58 
	~"mbuf„r_comm⁄.h
"

59 
	~"mbuf„r_mvc.h
"

60 
	~"Á°_mem‹y.h
"

62 
	~"mc_¥edi˘i⁄.h
"

63 
ã°Endün
();

64 
ª‹dî_li°s
(
Sli˚
 *
cuºSli˚
);

66 
ölöe
 
	$ª£t_mbs
(
Ma¸oblock
 *
cuºMB
)

68 
cuºMB
->
¶i˚_ƒ
 = -1;

69 
cuºMB
->
ei_Êag
 = 1;

70 
cuºMB
->
d∂_Êag
 = 0;

71 
	}
}

73 
	$£tup_buf„rs
(
VideoP¨amëîs
 *
p_Vid
, 
œyî_id
)

75 
CodögP¨amëîs
 *
˝s
 = 
p_Vid
->
p_EncodeP¨
[
œyî_id
];

76 
i
;

78 if(
p_Vid
->
œ°_dec_œyî_id
 !
œyî_id
)

80 
p_Vid
->
imgY_ªf
 = 
˝s
->imgY_ref;

81 
p_Vid
->
imgUV_ªf
 = 
˝s
->imgUV_ref;

82 if(
˝s
->
£∑øã_cﬁour_∂™e_Êag
)

84  
i
=0; i<
MAX_PLANE
; i++ )

86 
p_Vid
->
mb_d©a_JV
[
i
] = 
˝s
->mb_data_JV[i];

87 
p_Vid
->
öåa_block_JV
[
i
] = 
˝s
->intra_block_JV[i];

88 
p_Vid
->
ùªdmode_JV
[
i
] = 
˝s
->ipredmode_JV[i];

89 
p_Vid
->
siblock_JV
[
i
] = 
˝s
->siblock_JV[i];

91 
p_Vid
->
mb_d©a
 = 
NULL
;

92 
p_Vid
->
öåa_block
 = 
NULL
;

93 
p_Vid
->
ùªdmode
 = 
NULL
;

94 
p_Vid
->
siblock
 = 
NULL
;

98 
p_Vid
->
mb_d©a
 = 
˝s
->mb_data;

99 
p_Vid
->
öåa_block
 = 
˝s
->intra_block;

100 
p_Vid
->
ùªdmode
 = 
˝s
->ipredmode;

101 
p_Vid
->
siblock
 = 
˝s
->siblock;

103 
p_Vid
->
PicPos
 = 
˝s
->PicPos;

104 
p_Vid
->
nz_c€ff
 = 
˝s
->nz_coeff;

105 
p_Vid
->
qp_≥r_m©rix
 = 
˝s
->qp_per_matrix;

106 
p_Vid
->
qp_ªm_m©rix
 = 
˝s
->qp_rem_matrix;

107 
p_Vid
->
ﬁdFømeSizeInMbs
 = 
˝s
->oldFrameSizeInMbs;

108 
p_Vid
->
img2buf
 = 
˝s
->img2buf;

109 
p_Vid
->
œ°_dec_œyî_id
 = 
œyî_id
;

111 
	}
}

113 #i‡
MVC_EXTENSION_ENABLE


114 
	$öô_mvc_pi˘uª
(
Sli˚
 *
cuºSli˚
)

116 
i
;

117 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

118 
DecodedPi˘uªBuf„r
 *
p_Dpb
 = 
p_Vid
->
p_Dpb_œyî
[0];

120 
St‹abÀPi˘uª
 *
p_pic
 = 
NULL
;

123 i‡(
cuºSli˚
->
°ru˘uª
 =
FRAME
)

125 
i
 = 0; i < ()
p_Dpb
->
u£d_size
 ; i++)

127 
FømeSt‹e
 *
fs
 = 
p_Dpb
->fs[
i
];

128 i‡((
fs
->
‰ame
->
võw_id
 =0Ë&& (fs->‰ame->
‰ame_poc
 =
cuºSli˚
->
‰amïoc
))

130 
p_pic
 = 
fs
->
‰ame
;

135 i‡(
cuºSli˚
->
°ru˘uª
 =
TOP_FIELD
)

137 
i
 = 0; i < ()
p_Dpb
->
u£d_size
 ; i++)

139 
FømeSt‹e
 *
fs
 = 
p_Dpb
->fs[
i
];

140 i‡((
fs
->
t›_fõld
->
võw_id
 =0Ë&& (fs->t›_fõld->
t›_poc
 =
cuºSli˚
->
t›poc
))

142 
p_pic
 = 
fs
->
t›_fõld
;

149 
i
 = 0; i < ()
p_Dpb
->
u£d_size
 ; i++)

151 
FømeSt‹e
 *
fs
 = 
p_Dpb
->fs[
i
];

152 i‡((
fs
->
bŸtom_fõld
->
võw_id
 =0Ë&& (fs->bŸtom_fõld->
bŸtom_poc
 =
cuºSli˚
->
bŸtompoc
))

154 
p_pic
 = 
fs
->
bŸtom_fõld
;

159 if(!
p_pic
)

161 
p_Vid
->
bFømeInô
 = 0;

165 
	`¥o˚ss_pi˘uª_ö_dpb_s
(
p_Vid
, 
p_pic
);

166 
	`°‹e_¥oc_pi˘uª_ö_dpb
 (
cuºSli˚
->
p_Dpb
, 
	`˛⁄e_°‹abÀ_pi˘uª
(
p_Vid
, 
p_pic
));

168 
	}
}

177 
	$öô_pi˘uª
(
VideoP¨amëîs
 *
p_Vid
, 
Sli˚
 *
cuºSli˚
, 
I≈utP¨amëîs
 *
p_I≈
)

179 
i
;

180 
≈œ√
;

181 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
NULL
;

182 
£q_∑ømëî_£t_rb•_t
 *
a˘ive_•s
 = 
p_Vid
->active_sps;

183 
DecodedPi˘uªBuf„r
 *
p_Dpb
 = 
cuºSli˚
->p_Dpb;

185 
p_Vid
->
PicHeightInMbs
 =Ö_Vid->
FømeHeightInMbs
 / ( 1 + 
cuºSli˚
->
fõld_pic_Êag
 );

186 
p_Vid
->
PicSizeInMbs
 =Ö_Vid->
PicWidthInMbs
 *Ö_Vid->
PicHeightInMbs
;

187 
p_Vid
->
FømeSizeInMbs
 =Ö_Vid->
PicWidthInMbs
 *Ö_Vid->
FømeHeightInMbs
;

189 
p_Vid
->
bFømeInô
 = 1;

190 i‡(
p_Vid
->
dec_pi˘uª
)

193 
	`exô_pi˘uª
(
p_Vid
, &p_Vid->
dec_pi˘uª
);

195 
p_Vid
->
dpb_œyî_id
 = 
cuºSli˚
->
œyî_id
;

197 
	`£tup_buf„rs
(
p_Vid
, 
cuºSli˚
->
œyî_id
);

199 i‡(
p_Vid
->
ªcovîy_poöt
)

200 
p_Vid
->
ªcovîy_‰ame_num
 = (
cuºSli˚
->
‰ame_num
 +Ö_Vid->
ªcovîy_‰ame_˙t
Ë%Ö_Vid->
max_‰ame_num
;

202 i‡(
cuºSli˚
->
idr_Êag
)

203 
p_Vid
->
ªcovîy_‰ame_num
 = 
cuºSli˚
->
‰ame_num
;

205 i‡(
p_Vid
->
ªcovîy_poöt
 == 0 &&

206 
cuºSli˚
->
‰ame_num
 !
p_Vid
->
¥e_‰ame_num
 &&

207 
cuºSli˚
->
‰ame_num
 !(
p_Vid
->
¥e_‰ame_num
 + 1Ë%Ö_Vid->
max_‰ame_num
)

209 i‡(
a˘ive_•s
->
g≠s_ö_‰ame_num_vÆue_Ælowed_Êag
 == 0)

212 if(
p_I≈
->
c⁄˚Æ_mode
 !=0)

214 if((
cuºSli˚
->
‰ame_num
Ë< ((
p_Vid
->
¥e_‰ame_num
 + 1Ë%Ö_Vid->
max_‰ame_num
))

219 
p_Vid
->
c⁄˚Æ_mode
 = 1;

220 
p_Vid
->
IDR_c⁄˚Æmít_Êag
 = 1;

221 
	`c⁄˚Æ_lo°_‰ames
(
p_Dpb
, 
cuºSli˚
);

223 
p_Vid
->
c⁄˚Æ_mode
 = 
p_I≈
->conceal_mode;

228 
p_Vid
->
c⁄˚Æ_mode
 = 
p_I≈
->conceal_mode;

230 
p_Vid
->
IDR_c⁄˚Æmít_Êag
 = 0;

231 
	`c⁄˚Æ_lo°_‰ames
(
p_Dpb
, 
cuºSli˚
);

236 
	`îr‹
("An unintentionalÜoss ofÖictures occurs! Exit\n", 100);

239 if(
p_Vid
->
c⁄˚Æ_mode
 == 0)

240 
	`fûl_‰ame_num_g≠
(
p_Vid
, 
cuºSli˚
);

243 if(
cuºSli˚
->
«l_ª„ªn˚_idc
)

245 
p_Vid
->
¥e_‰ame_num
 = 
cuºSli˚
->
‰ame_num
;

251 
	`decode_poc
(
p_Vid
, 
cuºSli˚
);

253 i‡(
p_Vid
->
ªcovîy_‰ame_num
 =(Ë
cuºSli˚
->
‰ame_num
 &&Ö_Vid->
ªcovîy_poc
 == 0x7fffffff)

254 
p_Vid
->
ªcovîy_poc
 = 
cuºSli˚
->
‰amïoc
;

256 if(
cuºSli˚
->
«l_ª„ªn˚_idc
)

257 
p_Vid
->
œ°_ªf_pic_poc
 = 
cuºSli˚
->
‰amïoc
;

261 i‡(
cuºSli˚
->
°ru˘uª
==
FRAME
 ||cuºSli˚->°ru˘uª==
TOP_FIELD
)

263 
	`gëtime
 (&(
p_Vid
->
°¨t_time
));

266 
dec_pi˘uª
 = 
p_Vid
->dec_pi˘uª = 
	`Æloc_°‹abÀ_pi˘uª
 (p_Vid, 
cuºSli˚
->
°ru˘uª
,Ö_Vid->
width
,Ö_Vid->
height
,Ö_Vid->
width_¸
,Ö_Vid->
height_¸
, 1);

267 
dec_pi˘uª
->
t›_poc
=
cuºSli˚
->
t›poc
;

268 
dec_pi˘uª
->
bŸtom_poc
=
cuºSli˚
->
bŸtompoc
;

269 
dec_pi˘uª
->
‰ame_poc
=
cuºSli˚
->
‰amïoc
;

270 
dec_pi˘uª
->
qp
 = 
cuºSli˚
->qp;

271 
dec_pi˘uª
->
¶i˚_qp_dñè
 = 
cuºSli˚
->slice_qp_delta;

272 
dec_pi˘uª
->
chroma_qp_off£t
[0] = 
p_Vid
->
a˘ive_µs
->
chroma_qp_ödex_off£t
;

273 
dec_pi˘uª
->
chroma_qp_off£t
[1] = 
p_Vid
->
a˘ive_µs
->
£c⁄d_chroma_qp_ödex_off£t
;

274 
dec_pi˘uª
->
iCodögTy≥
 = 
cuºSli˚
->
°ru˘uª
==
FRAME
? (cuºSli˚->
mb_aff_‰ame_Êag
? 
FRAME_MB_PAIR_CODING
:
FRAME_CODING
): 
FIELD_CODING
;

275 
dec_pi˘uª
->
œyî_id
 = 
cuºSli˚
->layer_id;

276 #i‡(
MVC_EXTENSION_ENABLE
)

277 
dec_pi˘uª
->
võw_id
 = 
cuºSli˚
->view_id;

278 
dec_pi˘uª
->
öãr_võw_Êag
 = 
cuºSli˚
->inter_view_flag;

279 
dec_pi˘uª
->
™ch‹_pic_Êag
 = 
cuºSli˚
->anchor_pic_flag;

280 i‡(
dec_pi˘uª
->
võw_id
 == 1)

282 if((
p_Vid
->
¥ofûe_idc
 =
MVC_HIGH
Ë|| (p_Vid->¥ofûe_id¯=
STEREO_HIGH
))

283 
	`öô_mvc_pi˘uª
(
cuºSli˚
);

290 #i‡(
DISABLE_ERC
 == 0)

291 
	`îcRe£t
(
p_Vid
->
îc_îr‹V¨
,Ö_Vid->
PicSizeInMbs
,Ö_Vid->PicSizeInMbs, 
dec_pi˘uª
->
size_x
);

293 
p_Vid
->
îc_mv≥rMB
 = 0;

295 
cuºSli˚
->
°ru˘uª
 )

297 
TOP_FIELD
:

299 
dec_pi˘uª
->
poc
 = 
cuºSli˚
->
t›poc
;

300 
p_Vid
->
numbî
 *= 2;

303 
BOTTOM_FIELD
:

305 
dec_pi˘uª
->
poc
 = 
cuºSli˚
->
bŸtompoc
;

306 
p_Vid
->
numbî
 =Ö_Vid->number * 2 + 1;

309 
FRAME
:

311 
dec_pi˘uª
->
poc
 = 
cuºSli˚
->
‰amïoc
;

315 
	`îr‹
("p_Vid->structureÇot initialized", 235);

320 i‡(
p_Vid
->
ty≥
 > 
SI_SLICE
)

322 
	`£t_ec_Êag
(
p_Vid
, 
SE_PTYPE
);

323 
p_Vid
->
ty≥
 = 
P_SLICE
;

327 i‡(
p_Vid
->
a˘ive_µs
->
íå›y_codög_mode_Êag
 =(
Boﬁón
Ë
CAVLC
)

329 
	`mem£t
(
p_Vid
->
nz_c€ff
[0][0][0], -1,Ö_Vid->
PicSizeInMbs
 * 48 *(
byã
));

334 if–(
p_Vid
->
£∑øã_cﬁour_∂™e_Êag
 != 0) )

336  
≈œ√
=0;Ç∂™e<
MAX_PLANE
; ++nplane )

338 
Ma¸oblock
 *
cuºMB
 = 
p_Vid
->
mb_d©a_JV
[
≈œ√
];

339 *
öåa_block
 = 
p_Vid
->
öåa_block_JV
[
≈œ√
];

340 
i
=0; i<()
p_Vid
->
PicSizeInMbs
; ++i)

342 
	`ª£t_mbs
(
cuºMB
++);

344 
	`Á°_mem£t
(
p_Vid
->
ùªdmode_JV
[
≈œ√
][0], 
DC_PRED
, 16 *Ö_Vid->
FømeHeightInMbs
 *Ö_Vid->
PicWidthInMbs
 * ());

345 if(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

347 
i
=0; i<()
p_Vid
->
PicSizeInMbs
; ++i)

349 
öåa_block
[
i
] = 1;

357 #¥agm®
omp
 
∑øŒñ
 

358 
i
=0; i<()
p_Vid
->
PicSizeInMbs
; ++i)

359 
	`ª£t_mbs
(&
p_Vid
->
mb_d©a
[
i
]);

361 
Ma¸oblock
 *
cuºMB
 = 
p_Vid
->
mb_d©a
;

362 
i
=0; i<()
p_Vid
->
PicSizeInMbs
; ++i)

363 
	`ª£t_mbs
(
cuºMB
++);

365 if(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

367 
i
=0; i<()
p_Vid
->
PicSizeInMbs
; ++i)

369 
p_Vid
->
öåa_block
[
i
] = 1;

372 
	`Á°_mem£t
(
p_Vid
->
ùªdmode
[0], 
DC_PRED
, 16 *Ö_Vid->
FømeHeightInMbs
 *Ö_Vid->
PicWidthInMbs
 * ());

375 
dec_pi˘uª
->
¶i˚_ty≥
 = 
p_Vid
->
ty≥
;

376 
dec_pi˘uª
->
u£d_f‹_ª„ªn˚
 = (
cuºSli˚
->
«l_ª„ªn˚_idc
 != 0);

377 
dec_pi˘uª
->
idr_Êag
 = 
cuºSli˚
->idr_flag;

378 
dec_pi˘uª
->
no_ouçut_of_¥i‹_pics_Êag
 = 
cuºSli˚
->no_output_of_prior_pics_flag;

379 
dec_pi˘uª
->
l⁄g_ãrm_ª„ªn˚_Êag
 = 
cuºSli˚
->long_term_reference_flag;

380 
dec_pi˘uª
->
ad≠tive_ªf_pic_buf„rög_Êag
 = 
cuºSli˚
->adaptive_ref_pic_buffering_flag;

382 
dec_pi˘uª
->
dec_ªf_pic_m¨kög_buf„r
 = 
cuºSli˚
->dec_ref_pic_marking_buffer;

383 
cuºSli˚
->
dec_ªf_pic_m¨kög_buf„r
 = 
NULL
;

385 
dec_pi˘uª
->
mb_aff_‰ame_Êag
 = 
cuºSli˚
->mb_aff_frame_flag;

386 
dec_pi˘uª
->
PicWidthInMbs
 = 
p_Vid
->PicWidthInMbs;

388 
p_Vid
->
gë_mb_block_pos
 = 
dec_pi˘uª
->
mb_aff_‰ame_Êag
 ? 
gë_mb_block_pos_mbaff
 : 
gë_mb_block_pos_n‹mÆ
;

389 
p_Vid
->
gëNeighbour
 = 
dec_pi˘uª
->
mb_aff_‰ame_Êag
 ? 
gëAffNeighbour
 : 
gëN⁄AffNeighbour
;

391 
dec_pi˘uª
->
pic_num
 = 
cuºSli˚
->
‰ame_num
;

392 
dec_pi˘uª
->
‰ame_num
 = 
cuºSli˚
->frame_num;

394 
dec_pi˘uª
->
ªcovîy_‰ame
 = (Ë((Ë
cuºSli˚
->
‰ame_num
 =
p_Vid
->
ªcovîy_‰ame_num
);

396 
dec_pi˘uª
->
coded_‰ame
 = (
cuºSli˚
->
°ru˘uª
==
FRAME
);

398 
dec_pi˘uª
->
chroma_f‹m©_idc
 = 
a˘ive_•s
->chroma_format_idc;

400 
dec_pi˘uª
->
‰ame_mbs_⁄ly_Êag
 = 
a˘ive_•s
->frame_mbs_only_flag;

401 
dec_pi˘uª
->
‰ame_¸›pög_Êag
 = 
a˘ive_•s
->frame_cropping_flag;

403 i‡(
dec_pi˘uª
->
‰ame_¸›pög_Êag
)

405 
dec_pi˘uª
->
‰ame_¸›_À·_off£t
 = 
a˘ive_•s
->frame_crop_left_offset;

406 
dec_pi˘uª
->
‰ame_¸›_right_off£t
 = 
a˘ive_•s
->frame_crop_right_offset;

407 
dec_pi˘uª
->
‰ame_¸›_t›_off£t
 = 
a˘ive_•s
->frame_crop_top_offset;

408 
dec_pi˘uª
->
‰ame_¸›_bŸtom_off£t
 = 
a˘ive_•s
->frame_crop_bottom_offset;

411 #i‡(
ENABLE_OUTPUT_TONEMAPPING
)

413 i‡(
p_Vid
->
£iT⁄eM≠pög
->
£iHasT⁄e_m≠pög
)

415 
coded_d©a_bô_max
 = (1 << 
p_Vid
->
£iT⁄eM≠pög
->
coded_d©a_bô_dïth
);

416 
dec_pi˘uª
->
£iHasT⁄e_m≠pög
 = 1;

417 
dec_pi˘uª
->
t⁄e_m≠pög_modñ_id
 = 
p_Vid
->
£iT⁄eM≠pög
->
modñ_id
;

418 
dec_pi˘uª
->
t⁄em≠≥d_bô_dïth
 = 
p_Vid
->
£iT⁄eM≠pög
->
£i_bô_dïth
;

419 
dec_pi˘uª
->
t⁄e_m≠pög_lut
 = 
	`mÆloc
(
coded_d©a_bô_max
 * ());

420 i‡(
NULL
 =
dec_pi˘uª
->
t⁄e_m≠pög_lut
)

422 
	`no_mem_exô
("init_picture:Åone_mapping_lut");

424 
	`mem˝y
(
dec_pi˘uª
->
t⁄e_m≠pög_lut
, 
p_Vid
->
£iT⁄eM≠pög
->
lut
, (
img≥l
Ë* 
coded_d©a_bô_max
);

425 
	`upd©e_t⁄e_m≠pög_£i
(
p_Vid
->
£iT⁄eM≠pög
);

428 
dec_pi˘uª
->
£iHasT⁄e_m≠pög
 = 0;

431 if–(
p_Vid
->
£∑øã_cﬁour_∂™e_Êag
 != 0) )

433 
p_Vid
->
dec_pi˘uª_JV
[0] =Ö_Vid->
dec_pi˘uª
;

434 
p_Vid
->
dec_pi˘uª_JV
[1] = 
	`Æloc_°‹abÀ_pi˘uª
 (p_Vid, (
Pi˘uªSåu˘uª
Ë
cuºSli˚
->
°ru˘uª
,Ö_Vid->
width
,Ö_Vid->
height
,Ö_Vid->
width_¸
,Ö_Vid->
height_¸
, 1);

435 
	`c›y_dec_pi˘uª_JV
–
p_Vid
,Ö_Vid->
dec_pi˘uª_JV
[1],Ö_Vid->dec_picture_JV[0] );

436 
p_Vid
->
dec_pi˘uª_JV
[2] = 
	`Æloc_°‹abÀ_pi˘uª
 (p_Vid, (
Pi˘uªSåu˘uª
Ë
cuºSli˚
->
°ru˘uª
,Ö_Vid->
width
,Ö_Vid->
height
,Ö_Vid->
width_¸
,Ö_Vid->
height_¸
, 1);

437 
	`c›y_dec_pi˘uª_JV
–
p_Vid
,Ö_Vid->
dec_pi˘uª_JV
[2],Ö_Vid->dec_picture_JV[0] );

439 
	}
}

441 
upd©e_mbaff_ma¸oblock_d©a
(
img≥l
 **
cur_img
, img≥»(*
ãmp
)[16], 
x0
, 
width
, 
height
)

443 
img≥l
 (*
ãmp_evn
)[16] = 
ãmp
;

444 
img≥l
 (*
ãmp_odd
)[16] = 
ãmp
 + 
height
;

445 
img≥l
 **
	gãmp_img
 = 
cur_img
;

446 
	gy
;

448 
	gy
 = 0; y < 2 * 
	gheight
; ++y)

449 
mem˝y
(*
ãmp
++, (*
ãmp_img
++ + 
x0
), 
width
 * (
img≥l
));

451 
	gy
 = 0; y < 
	gheight
; ++y)

453 
mem˝y
((*
cur_img
++ + 
x0
), *
ãmp_evn
++, 
width
 * (
img≥l
));

454 
mem˝y
((*
cur_img
++ + 
x0
), *
ãmp_odd
++, 
width
 * (
img≥l
));

458 
	$MbAffPo°Proc
(
VideoP¨amëîs
 *
p_Vid
)

461 
img≥l
 
ãmp_buf„r
[32][16];

463 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
p_Vid
->dec_picture;

464 
img≥l
 ** 
imgY
 = 
dec_pi˘uª
->imgY;

465 
img≥l
 ***
imgUV
 = 
dec_pi˘uª
->imgUV;

467 
i
, 
x0
, 
y0
;

469 
i
=0; i<()
dec_pi˘uª
->
PicSizeInMbs
; i+=2)

471 i‡(
dec_pi˘uª
->
mŸi⁄
.
mb_fõld
[
i
])

473 
	`gë_mb_pos
(
p_Vid
, 
i
,Ö_Vid->
mb_size
[
IS_LUMA
], &
x0
, &
y0
);

474 
	`upd©e_mbaff_ma¸oblock_d©a
(
imgY
 + 
y0
, 
ãmp_buf„r
, 
x0
, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE);

476 i‡(
dec_pi˘uª
->
chroma_f‹m©_idc
 !
YUV400
)

478 
x0
 = (Ë((x0 * 
p_Vid
->
mb_¸_size_x
) >> 4);

479 
y0
 = (Ë((y0 * 
p_Vid
->
mb_¸_size_y
) >> 4);

481 
	`upd©e_mbaff_ma¸oblock_d©a
(
imgUV
[0] + 
y0
, 
ãmp_buf„r
, 
x0
, 
p_Vid
->
mb_¸_size_x
,Ö_Vid->
mb_¸_size_y
);

482 
	`upd©e_mbaff_ma¸oblock_d©a
(
imgUV
[1] + 
y0
, 
ãmp_buf„r
, 
x0
, 
p_Vid
->
mb_¸_size_x
,Ö_Vid->
mb_¸_size_y
);

486 
	}
}

488 
	$fûl_wp_∑øms
(
Sli˚
 *
cuºSli˚
)

490 i‡(
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
)

492 
i
, 
j
, 
k
;

493 
comp
;

494 
log_weight_díom
;

495 
tb
, 
td
;

496 
tx
,
Di°SˇÀFa˘‹
;

498 
max_l0_ªf
 = 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
];

499 
max_l1_ªf
 = 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_1
];

501 i‡(
cuºSli˚
->
a˘ive_µs
->
weighãd_bùªd_idc
 == 2)

503 
cuºSli˚
->
luma_log2_weight_díom
 = 5;

504 
cuºSli˚
->
chroma_log2_weight_díom
 = 5;

505 
cuºSli˚
->
wp_round_luma
 = 16;

506 
cuºSli˚
->
wp_round_chroma
 = 16;

508 
i
=0; i<
MAX_REFERENCE_PICTURES
; ++i)

510 
comp
=0; comp<3; ++comp)

512 
log_weight_díom
 = (
comp
 =0Ë? 
cuºSli˚
->
luma_log2_weight_díom
 : cuºSli˚->
chroma_log2_weight_díom
;

513 
cuºSli˚
->
wp_weight
[0][
i
][
comp
] = 1 << 
log_weight_díom
;

514 
cuºSli˚
->
wp_weight
[1][
i
][
comp
] = 1 << 
log_weight_díom
;

515 
cuºSli˚
->
wp_off£t
[0][
i
][
comp
] = 0;

516 
cuºSli˚
->
wp_off£t
[1][
i
][
comp
] = 0;

521 
i
=0; i<
max_l0_ªf
; ++i)

523 
j
=0; j<
max_l1_ªf
; ++j)

525 
comp
 = 0; comp<3; ++comp)

527 
log_weight_díom
 = (
comp
 =0Ë? 
cuºSli˚
->
luma_log2_weight_díom
 : cuºSli˚->
chroma_log2_weight_díom
;

528 i‡(
cuºSli˚
->
a˘ive_µs
->
weighãd_bùªd_idc
 == 1)

530 
cuºSli˚
->
wbp_weight
[0][
i
][
j
][
comp
] = cuºSli˚->
wp_weight
[0][i][comp];

531 
cuºSli˚
->
wbp_weight
[1][
i
][
j
][
comp
] = cuºSli˚->
wp_weight
[1][j][comp];

533 i‡(
cuºSli˚
->
a˘ive_µs
->
weighãd_bùªd_idc
 == 2)

535 
td
 = 
	`iClù3
(-128,127,
cuºSli˚
->
li°X
[
LIST_1
][
j
]->
poc
 - cuºSli˚->li°X[
LIST_0
][
i
]->poc);

536 i‡(
td
 =0 || 
cuºSli˚
->
li°X
[
LIST_1
][
j
]->
is_l⁄g_ãrm
 || cuºSli˚->li°X[
LIST_0
][
i
]->is_long_term)

538 
cuºSli˚
->
wbp_weight
[0][
i
][
j
][
comp
] = 32;

539 
cuºSli˚
->
wbp_weight
[1][
i
][
j
][
comp
] = 32;

543 
tb
 = 
	`iClù3
(-128,127,
cuºSli˚
->
ThisPOC
 - cuºSli˚->
li°X
[
LIST_0
][
i
]->
poc
);

545 
tx
 = (16384 + 
	`übs
(
td
/2))/td;

546 
Di°SˇÀFa˘‹
 = 
	`iClù3
(-1024, 1023, (
tx
*
tb
 + 32 )>>6);

548 
cuºSli˚
->
wbp_weight
[1][
i
][
j
][
comp
] = 
Di°SˇÀFa˘‹
 >> 2;

549 
cuºSli˚
->
wbp_weight
[0][
i
][
j
][
comp
] = 64 - currSlice->wbp_weight[1][i][j][comp];

550 i‡(
cuºSli˚
->
wbp_weight
[1][
i
][
j
][
comp
] < -64 || currSlice->wbp_weight[1][i][j][comp] > 128)

552 
cuºSli˚
->
wbp_weight
[0][
i
][
j
][
comp
] = 32;

553 
cuºSli˚
->
wbp_weight
[1][
i
][
j
][
comp
] = 32;

554 
cuºSli˚
->
wp_off£t
[0][
i
][
comp
] = 0;

555 
cuºSli˚
->
wp_off£t
[1][
j
][
comp
] = 0;

563 i‡(
cuºSli˚
->
mb_aff_‰ame_Êag
)

565 
i
=0; i<2*
max_l0_ªf
; ++i)

567 
j
=0; j<2*
max_l1_ªf
; ++j)

569 
comp
 = 0; comp<3; ++comp)

571 
k
=2; k<6; k+=2)

573 
cuºSli˚
->
wp_off£t
[
k
+0][
i
][
comp
] = currSlice->wp_offset[0][i>>1][comp];

574 
cuºSli˚
->
wp_off£t
[
k
+1][
j
][
comp
] = currSlice->wp_offset[1][j>>1][comp];

576 
log_weight_díom
 = (
comp
 =0Ë? 
cuºSli˚
->
luma_log2_weight_díom
 : cuºSli˚->
chroma_log2_weight_díom
;

577 i‡(
cuºSli˚
->
a˘ive_µs
->
weighãd_bùªd_idc
 == 1)

579 
cuºSli˚
->
wbp_weight
[
k
+0][
i
][
j
][
comp
] = cuºSli˚->
wp_weight
[0][i>>1][comp];

580 
cuºSli˚
->
wbp_weight
[
k
+1][
i
][
j
][
comp
] = cuºSli˚->
wp_weight
[1][j>>1][comp];

582 i‡(
cuºSli˚
->
a˘ive_µs
->
weighãd_bùªd_idc
 == 2)

584 
td
 = 
	`iClù3
(-128, 127, 
cuºSli˚
->
li°X
[
k
+
LIST_1
][
j
]->
poc
 - cuºSli˚->li°X[k+
LIST_0
][
i
]->poc);

585 i‡(
td
 =0 || 
cuºSli˚
->
li°X
[
k
+
LIST_1
][
j
]->
is_l⁄g_ãrm
 || cuºSli˚->li°X[k+
LIST_0
][
i
]->is_long_term)

587 
cuºSli˚
->
wbp_weight
[
k
+0][
i
][
j
][
comp
] = 32;

588 
cuºSli˚
->
wbp_weight
[
k
+1][
i
][
j
][
comp
] = 32;

592 
tb
 = 
	`iClù3
(-128,127,((
k
==2)?
cuºSli˚
->
t›poc
:cuºSli˚->
bŸtompoc
Ë- cuºSli˚->
li°X
[k+
LIST_0
][
i
]->
poc
);

594 
tx
 = (16384 + 
	`übs
(
td
/2))/td;

595 
Di°SˇÀFa˘‹
 = 
	`iClù3
(-1024, 1023, (
tx
*
tb
 + 32 )>>6);

597 
cuºSli˚
->
wbp_weight
[
k
+1][
i
][
j
][
comp
] = 
Di°SˇÀFa˘‹
 >> 2;

598 
cuºSli˚
->
wbp_weight
[
k
+0][
i
][
j
][
comp
] = 64 - currSlice->wbp_weight[k+1][i][j][comp];

599 i‡(
cuºSli˚
->
wbp_weight
[
k
+1][
i
][
j
][
comp
] < -64 || currSlice->wbp_weight[k+1][i][j][comp] > 128)

601 
cuºSli˚
->
wbp_weight
[
k
+1][
i
][
j
][
comp
] = 32;

602 
cuºSli˚
->
wbp_weight
[
k
+0][
i
][
j
][
comp
] = 32;

603 
cuºSli˚
->
wp_off£t
[
k
+0][
i
][
comp
] = 0;

604 
cuºSli˚
->
wp_off£t
[
k
+1][
j
][
comp
] = 0;

614 
	}
}

618 
	$öô_pi˘uª_decodög
(
VideoP¨amëîs
 *
p_Vid
)

620 
Sli˚
 *
pSli˚
 = 
p_Vid
->
µSli˚Li°
[0];

621 
j
, 
i
, 
iDeblockMode
=1;

623 if(
p_Vid
->
iSli˚NumOfCuºPic
 >
MAX_NUM_SLICES
)

625 
	`îr‹
 ("MaximumÇumber of supported slicesÉxceeded. \nPleaseÑecompile with increased value for MAX_NUM_SLICES", 200);

628 if(
p_Vid
->
pNextPPS
->
VÆid
 && (Ëp_Vid->pNextPPS->
pic_∑ømëî_£t_id
 =
pSli˚
->pic_parameter_set_id)

630 
pic_∑ømëî_£t_rb•_t
 
tmpPPS
;

631 
	`mem˝y
(&
tmpPPS
, &(
p_Vid
->
PicP¨Së
[
pSli˚
->
pic_∑ømëî_£t_id
]),  (
pic_∑ømëî_£t_rb•_t
));

632 (
p_Vid
->
PicP¨Së
[
pSli˚
->
pic_∑ømëî_£t_id
]).
¶i˚_group_id
 = 
NULL
;

633 
	`MakePPSavaûabÀ
 (
p_Vid
,Ö_Vid->
pNextPPS
->
pic_∑ømëî_£t_id
,Ö_Vid->pNextPPS);

634 
	`mem˝y
(
p_Vid
->
pNextPPS
, &
tmpPPS
,  (
pic_∑ømëî_£t_rb•_t
));

635 
tmpPPS
.
¶i˚_group_id
 = 
NULL
;

638 
	`U£P¨amëîSë
 (
pSli˚
);

639 if(
pSli˚
->
idr_Êag
)

640 
p_Vid
->
numbî
=0;

642 
p_Vid
->
PicHeightInMbs
 =Ö_Vid->
FømeHeightInMbs
 / ( 1 + 
pSli˚
->
fõld_pic_Êag
 );

643 
p_Vid
->
PicSizeInMbs
 =Ö_Vid->
PicWidthInMbs
 *Ö_Vid->
PicHeightInMbs
;

644 
p_Vid
->
FømeSizeInMbs
 =Ö_Vid->
PicWidthInMbs
 *Ö_Vid->
FømeHeightInMbs
;

645 
p_Vid
->
°ru˘uª
 = 
pSli˚
->structure;

647 
	`fmo_öô
 (
p_Vid
, 
pSli˚
);

649 #i‡(
MVC_EXTENSION_ENABLE
)

650 if((
pSli˚
->
œyî_id
>0Ë&& (pSli˚->
svc_exãnsi⁄_Êag
 =0 &&ÖSli˚->
NÆuHódîMVCExt
.
n⁄_idr_Êag
 == 0))

652 
	`idr_mem‹y_m™agemít
(
p_Vid
->
p_Dpb_œyî
[
pSli˚
->
œyî_id
],Ö_Vid->
dec_pi˘uª
);

654 
	`upd©e_ªf_li°
(
p_Vid
->
p_Dpb_œyî
[
pSli˚
->
võw_id
]);

655 
	`upd©e_…ªf_li°
(
p_Vid
->
p_Dpb_œyî
[
pSli˚
->
võw_id
]);

656 
	`upd©e_pic_num
(
pSli˚
);

657 
i
 = 
pSli˚
->
võw_id
;

659 
	`upd©e_pic_num
(
pSli˚
);

660 
i
 = 0;

662 
	`öô_Deblock
(
p_Vid
, 
pSli˚
->
mb_aff_‰ame_Êag
);

664 
j
=0; j<
p_Vid
->
iSli˚NumOfCuºPic
; j++)

666 if(
p_Vid
->
µSli˚Li°
[
j
]->
DFDißbÀIdc
 != 1)

667 
iDeblockMode
=0;

668 #i‡(
MVC_EXTENSION_ENABLE
)

669 
	`as£π
(
p_Vid
->
µSli˚Li°
[
j
]->
võw_id
 =
i
);

672 
p_Vid
->
iDeblockMode
 = iDeblockMode;

673 
	}
}

675 
	$öô_¶i˚
(
VideoP¨amëîs
 *
p_Vid
, 
Sli˚
 *
cuºSli˚
)

677 
i
;

679 
p_Vid
->
a˘ive_•s
 = 
cuºSli˚
->active_sps;

680 
p_Vid
->
a˘ive_µs
 = 
cuºSli˚
->active_pps;

682 
cuºSli˚
->
	`öô_li°s
 (currSlice);

684 #i‡(
MVC_EXTENSION_ENABLE
)

685 i‡(
cuºSli˚
->
svc_exãnsi⁄_Êag
 == 0 || currSlice->svc_extension_flag == 1)

686 
	`ª‹dî_li°s_mvc
 (
cuºSli˚
, cuºSli˚->
ThisPOC
);

688 
	`ª‹dî_li°s
 (
cuºSli˚
);

690 i‡(
cuºSli˚
->
fs_li°öãrvõw0
)

692 
	`‰ì
(
cuºSli˚
->
fs_li°öãrvõw0
);

693 
cuºSli˚
->
fs_li°öãrvõw0
 = 
NULL
;

695 i‡(
cuºSli˚
->
fs_li°öãrvõw1
)

697 
	`‰ì
(
cuºSli˚
->
fs_li°öãrvõw1
);

698 
cuºSli˚
->
fs_li°öãrvõw1
 = 
NULL
;

701 
	`ª‹dî_li°s
 (
cuºSli˚
);

704 i‡(
cuºSli˚
->
°ru˘uª
==
FRAME
)

706 
	`öô_mbaff_li°s
(
p_Vid
, 
cuºSli˚
);

711 if(!(
cuºSli˚
->
ªdund™t_pic_˙t
 !0 && 
p_Vid
->
¥evious_‰ame_num
 =cuºSli˚->
‰ame_num
))

713 
i
=16;i>0;i--)

715 
cuºSli˚
->
ªf_Êag
[
i
] = currSlice->ref_flag[i-1];

718 
cuºSli˚
->
ªf_Êag
[0] = cuºSli˚->
ªdund™t_pic_˙t
==0 ? 
p_Vid
->
Is_¥im¨y_c‹ª˘
 :Ö_Vid->
Is_ªdund™t_c‹ª˘
;

721 if((
cuºSli˚
->
a˘ive_•s
->
chroma_f‹m©_idc
==0)||(currSlice->active_sps->chroma_format_idc==3))

723 
cuºSli˚
->
löfo_cbp_öåa
 = 
löfo_cbp_öåa_Ÿhî
;

724 
cuºSli˚
->
löfo_cbp_öãr
 = 
löfo_cbp_öãr_Ÿhî
;

728 
cuºSli˚
->
löfo_cbp_öåa
 = 
löfo_cbp_öåa_n‹mÆ
;

729 
cuºSli˚
->
löfo_cbp_öãr
 = 
löfo_cbp_öãr_n‹mÆ
;

731 
	}
}

733 
	$decode_¶i˚
(
Sli˚
 *
cuºSli˚
, 
cuºít_hódî
)

735 i‡(
cuºSli˚
->
a˘ive_µs
->
íå›y_codög_mode_Êag
)

737 
	`öô_c⁄ãxts
 (
cuºSli˚
);

738 
	`ˇbac_√w_¶i˚
(
cuºSli˚
);

741 i‡–(
cuºSli˚
->
a˘ive_µs
->
weighãd_bùªd_idc
 > 0 && (cuºSli˚->
¶i˚_ty≥
 =
B_SLICE
)Ë|| (cuºSli˚->a˘ive_µs->
weighãd_¥ed_Êag
 && cuºSli˚->¶i˚_ty≥ !=
I_SLICE
))

742 
	`fûl_wp_∑øms
(
cuºSli˚
);

747 i‡((
cuºít_hódî
 =
SOP
 || cuºít_hódî =
SOS
Ë&& 
cuºSli˚
->
ei_Êag
 == 0)

748 
	`decode_⁄e_¶i˚
(
cuºSli˚
);

754 
	}
}

764 
	$Eº‹_åackög
(
VideoP¨amëîs
 *
p_Vid
, 
Sli˚
 *
cuºSli˚
)

766 
i
;

768 if(
cuºSli˚
->
ªdund™t_pic_˙t
 == 0)

770 
p_Vid
->
Is_¥im¨y_c‹ª˘
 =Ö_Vid->
Is_ªdund™t_c‹ª˘
 = 1;

773 if(
cuºSli˚
->
ªdund™t_pic_˙t
 =0 && 
p_Vid
->
ty≥
 !
I_SLICE
)

775 
i
=0;i<
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
];++i)

777 if(
cuºSli˚
->
ªf_Êag
[
i
] == 0)

779 
p_Vid
->
Is_¥im¨y_c‹ª˘
 = 0;

783 if(
cuºSli˚
->
ªdund™t_pic_˙t
 !0 && 
p_Vid
->
ty≥
 !
I_SLICE
)

785 if(
cuºSli˚
->
ªf_Êag
[cuºSli˚->
ªdund™t_¶i˚_ªf_idx
] == 0)

787 
p_Vid
->
Is_ªdund™t_c‹ª˘
 = 0;

790 
	}
}

792 
	$C›yPOC
(
Sli˚
 *
pSli˚0
, Sli˚ *
cuºSli˚
)

794 
cuºSli˚
->
‰amïoc
 = 
pSli˚0
->framepoc;

795 
cuºSli˚
->
t›poc
 = 
pSli˚0
->toppoc;

796 
cuºSli˚
->
bŸtompoc
 = 
pSli˚0
->bottompoc;

797 
cuºSli˚
->
ThisPOC
 = 
pSli˚0
->ThisPOC;

798 
	}
}

809 
	$decode_⁄e_‰ame
(
DecodîP¨ams
 *
pDecodî
)

811 
VideoP¨amëîs
 *
p_Vid
 = 
pDecodî
->p_Vid;

812 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

813 
cuºít_hódî
, 
iRë
;

814 
Sli˚
 *
cuºSli˚
;

815 
Sli˚
 **
µSli˚Li°
 = 
p_Vid
->ppSliceList;

816 
iSli˚No
;

819 
p_Vid
->
iSli˚NumOfCuºPic
=0;

820 
cuºít_hódî
=0;

821 
p_Vid
->
iNumOfSli˚sDecoded
=0;

822 
p_Vid
->
num_dec_mb
 = 0;

823 if(
p_Vid
->
√w‰ame
)

825 if(
p_Vid
->
pNextPPS
->
VÆid
)

828 
	`MakePPSavaûabÀ
 (
p_Vid
,Ö_Vid->
pNextPPS
->
pic_∑ømëî_£t_id
,Ö_Vid->pNextPPS);

829 
p_Vid
->
pNextPPS
->
VÆid
=0;

833 
	`as£π
(
µSli˚Li°
[
p_Vid
->
iSli˚NumOfCuºPic
]);

834 
cuºSli˚
 = 
µSli˚Li°
[
p_Vid
->
iSli˚NumOfCuºPic
];

835 
µSli˚Li°
[
p_Vid
->
iSli˚NumOfCuºPic
] =Ö_Vid->
pNextSli˚
;

836 
p_Vid
->
pNextSli˚
 = 
cuºSli˚
;

837 
	`as£π
(
µSli˚Li°
[
p_Vid
->
iSli˚NumOfCuºPic
]->
cuºít_¶i˚_ƒ
 == 0);

839 
cuºSli˚
 = 
µSli˚Li°
[
p_Vid
->
iSli˚NumOfCuºPic
];

841 
	`U£P¨amëîSë
 (
cuºSli˚
);

843 
	`öô_pi˘uª
(
p_Vid
, 
cuºSli˚
, 
p_I≈
);

845 
p_Vid
->
iSli˚NumOfCuºPic
++;

846 
cuºít_hódî
 = 
SOS
;

848 
cuºít_hódî
 !
SOP
 && cuºít_hódî !=
EOS
)

851 
	`as£π
(
p_Vid
->
iSli˚NumOfCuºPic
 <Ö_Vid->
iNumOfSli˚sAŒoˇãd
);

852 if(!
µSli˚Li°
[
p_Vid
->
iSli˚NumOfCuºPic
])

854 
µSli˚Li°
[
p_Vid
->
iSli˚NumOfCuºPic
] = 
	`mÆloc_¶i˚
(
p_I≈
,Ö_Vid);

856 
cuºSli˚
 = 
µSli˚Li°
[
p_Vid
->
iSli˚NumOfCuºPic
];

859 
cuºSli˚
->
p_Vid
 =Ö_Vid;

860 
cuºSli˚
->
p_I≈
 =Ö_Inp;

861 
cuºSli˚
->
p_Dpb
 = 
p_Vid
->
p_Dpb_œyî
[0];

862 
cuºSli˚
->
√xt_hódî
 = -8888;

863 
cuºSli˚
->
num_dec_mb
 = 0;

864 
cuºSli˚
->
c€ff_˘r
 = -1;

865 
cuºSli˚
->
pos
 = 0;

866 
cuºSli˚
->
is_ª£t_c€ff
 = 
FALSE
;

867 
cuºSli˚
->
is_ª£t_c€ff_¸
 = 
FALSE
;

869 
cuºít_hódî
 = 
	`ªad_√w_¶i˚
(
cuºSli˚
);

871 
cuºSli˚
->
cuºít_hódî
 = current_header;

874 
	`Eº‹_åackög
(
p_Vid
, 
cuºSli˚
);

877 if(
cuºSli˚
->
‰ame_num
 =
p_Vid
->
¥evious_‰ame_num
 && cuºSli˚->
ªdund™t_pic_˙t
 !=0

878 && 
p_Vid
->
Is_¥im¨y_c‹ª˘
 !=0 && 
cuºít_hódî
 !
EOS
)

883 if((
cuºít_hódî
 !
SOP
 && cuºít_hódî !=
EOS
Ë|| (
p_Vid
->
iSli˚NumOfCuºPic
==0 && current_header == SOP))

885 
cuºSli˚
->
cuºít_¶i˚_ƒ
 = (Ë
p_Vid
->
iSli˚NumOfCuºPic
;

886 
p_Vid
->
dec_pi˘uª
->
max_¶i˚_id
 = (Ë
	`imax
(
cuºSli˚
->
cuºít_¶i˚_ƒ
,Ö_Vid->dec_picture->max_slice_id);

887 if(
p_Vid
->
iSli˚NumOfCuºPic
 >0)

889 
	`C›yPOC
(*
µSli˚Li°
, 
cuºSli˚
);

890 
µSli˚Li°
[
p_Vid
->
iSli˚NumOfCuºPic
-1]->
íd_mb_ƒ_∂us1
 = 
cuºSli˚
->
°¨t_mb_ƒ
;

892 
p_Vid
->
iSli˚NumOfCuºPic
++;

893 if(
p_Vid
->
iSli˚NumOfCuºPic
 >p_Vid->
iNumOfSli˚sAŒoˇãd
)

895 
Sli˚
 **
tmpSli˚Li°
 = (Sli˚ **)
	`ªÆloc
(
p_Vid
->
µSli˚Li°
, (p_Vid->
iNumOfSli˚sAŒoˇãd
+
MAX_NUM_DECSLICES
)*(Slice*));

896 if(!
tmpSli˚Li°
)

898 
tmpSli˚Li°
 = 
	`ˇŒoc
((
p_Vid
->
iNumOfSli˚sAŒoˇãd
+
MAX_NUM_DECSLICES
), (
Sli˚
*));

899 
	`mem˝y
(
tmpSli˚Li°
, 
p_Vid
->
µSli˚Li°
,Ö_Vid->
iSli˚NumOfCuºPic
*(
Sli˚
*));

901 
	`‰ì
(
p_Vid
->
µSli˚Li°
);

902 
µSli˚Li°
 = 
p_Vid
->µSli˚Li° = 
tmpSli˚Li°
;

907 
µSli˚Li°
 = 
p_Vid
->µSli˚Li° = 
tmpSli˚Li°
;

908 
	`mem£t
(
p_Vid
->
µSli˚Li°
+p_Vid->
iSli˚NumOfCuºPic
, 0, (
Sli˚
*)*
MAX_NUM_DECSLICES
);

910 
p_Vid
->
iNumOfSli˚sAŒoˇãd
 +
MAX_NUM_DECSLICES
;

912 
cuºít_hódî
 = 
SOS
;

916 if(
µSli˚Li°
[
p_Vid
->
iSli˚NumOfCuºPic
-1]->
mb_aff_‰ame_Êag
)

917 
µSli˚Li°
[
p_Vid
->
iSli˚NumOfCuºPic
-1]->
íd_mb_ƒ_∂us1
 =Ö_Vid->
FømeSizeInMbs
/2;

919 
µSli˚Li°
[
p_Vid
->
iSli˚NumOfCuºPic
-1]->
íd_mb_ƒ_∂us1
 =Ö_Vid->
FømeSizeInMbs
/(1+µSli˚Li°[p_Vid->iSli˚NumOfCuºPic-1]->
fõld_pic_Êag
);

920 
p_Vid
->
√w‰ame
 = 1;

921 
cuºSli˚
->
cuºít_¶i˚_ƒ
 = 0;

923 
µSli˚Li°
[
p_Vid
->
iSli˚NumOfCuºPic
] =Ö_Vid->
pNextSli˚
;

924 
p_Vid
->
pNextSli˚
 = 
cuºSli˚
;

927 
	`c›y_¶i˚_öfo
(
cuºSli˚
, 
p_Vid
->
ﬁd_¶i˚
);

929 
iRë
 = 
cuºít_hódî
;

930 
	`öô_pi˘uª_decodög
(
p_Vid
);

933 
iSli˚No
=0; iSli˚No<
p_Vid
->
iSli˚NumOfCuºPic
; iSliceNo++)

935 
cuºSli˚
 = 
µSli˚Li°
[
iSli˚No
];

936 
cuºít_hódî
 = 
cuºSli˚
->current_header;

939 
	`as£π
(
cuºít_hódî
 !
EOS
);

940 
	`as£π
(
cuºSli˚
->
cuºít_¶i˚_ƒ
 =
iSli˚No
);

942 
	`öô_¶i˚
(
p_Vid
, 
cuºSli˚
);

943 
	`decode_¶i˚
(
cuºSli˚
, 
cuºít_hódî
);

945 
p_Vid
->
iNumOfSli˚sDecoded
++;

946 
p_Vid
->
num_dec_mb
 +
cuºSli˚
->num_dec_mb;

947 
p_Vid
->
îc_mv≥rMB
 +
cuºSli˚
->erc_mvperMB;

950 #i‡
MVC_EXTENSION_ENABLE


951 
p_Vid
->
œ°_dec_võw_id
 =Ö_Vid->
dec_pi˘uª
->
võw_id
;

953 if(
p_Vid
->
dec_pi˘uª
->
°ru˘uª
 =
FRAME
)

954 
p_Vid
->
œ°_dec_poc
 =Ö_Vid->
dec_pi˘uª
->
‰ame_poc
;

955 if(
p_Vid
->
dec_pi˘uª
->
°ru˘uª
 =
TOP_FIELD
)

956 
p_Vid
->
œ°_dec_poc
 =Ö_Vid->
dec_pi˘uª
->
t›_poc
;

957 if(
p_Vid
->
dec_pi˘uª
->
°ru˘uª
 =
BOTTOM_FIELD
)

958 
p_Vid
->
œ°_dec_poc
 =Ö_Vid->
dec_pi˘uª
->
bŸtom_poc
;

959 
	`exô_pi˘uª
(
p_Vid
, &p_Vid->
dec_pi˘uª
);

960 
p_Vid
->
¥evious_‰ame_num
 = 
µSli˚Li°
[0]->
‰ame_num
;

961  (
iRë
);

962 
	}
}

980 
	$buf„r2img
 (
img≥l
** 
imgX
, * 
buf
, 
size_x
, 
size_y
, 
symbﬁ_size_ö_byãs
)

982 
i
,
j
;

984 
uöt16
 
tmp16
, 
ui16
;

985 
tmp32
, 
ui32
;

987 i‡(
symbﬁ_size_ö_byãs
> (
img≥l
))

989 
	`îr‹
 ("SourceÖicture has higher bit depthÅhan imgpel dataÅype. \nPleaseÑecompile withÜarger dataÅype for imgpel.", 500);

992 i‡(–(Ë= (
img≥l
)Ë&& ( (Ë=
symbﬁ_size_ö_byãs
))

995 
	`Á°_mem˝y
(&
imgX
[0][0], 
buf
, 
size_x
 * 
size_y
);

1000 i‡(
	`ã°Endün
())

1003 
symbﬁ_size_ö_byãs
)

1007 
j
 = 0; j < 
size_y
; ++j)

1008 
i
 = 0; i < 
size_x
; ++i)

1010 
imgX
[
j
][
i
]
buf
[i+j*
size_x
];

1016 
j
=0;j<
size_y
;++j)

1017 
i
=0;i<
size_x
;++i)

1019 
	`mem˝y
(&
tmp16
, 
buf
+((
i
+
j
*
size_x
)*2), 2);

1020 
ui16
 = (
uöt16
Ë((
tmp16
 >> 8) | ((tmp16&0xFF)<<8));

1021 
imgX
[
j
][
i
] = (
img≥l
Ë
ui16
;

1027 
j
=0;j<
size_y
;++j)

1028 
i
=0;i<
size_x
;++i)

1030 
	`mem˝y
(&
tmp32
, 
buf
+((
i
+
j
*
size_x
)*4), 4);

1031 
ui32
 = ((
tmp32
&0xFF00)<<8) | ((tmp32&0xFF)<<24) | ((tmp32&0xFF0000)>>8) | ((tmp32&0xFF000000)>>24);

1032 
imgX
[
j
][
i
] = (
img≥l
Ë
ui32
;

1037 
	`îr‹
 ("reading only from formats of 8, 16 or 32 bitállowed on bigÉndianárchitecture", 500);

1046 i‡(
symbﬁ_size_ö_byãs
 == 1)

1048 
j
=0; j < 
size_y
; ++j)

1050 
i
=0; i < 
size_x
; ++i)

1052 
imgX
[
j
][
i
]=*(
buf
++);

1058 
j
=0; j < 
size_y
; ++j)

1060 
jpos
 = 
j
*
size_x
;

1061 
i
=0; i < 
size_x
; ++i)

1063 
imgX
[
j
][
i
]=0;

1064 
	`mem˝y
(&(
imgX
[
j
][
i
]), 
buf
 +((i+
jpos
)*
symbﬁ_size_ö_byãs
), symbol_size_in_bytes);

1071 
	}
}

1080 
öt64
 
	$compuã_SSE
(
img≥l
 **
imgRef
, img≥»**
imgSrc
, 
xRef
, 
xSrc
, 
ySize
, 
xSize
)

1082 
i
, 
j
;

1083 
img≥l
 *
löeRef
, *
löeSrc
;

1084 
öt64
 
di°‹ti⁄
 = 0;

1086 
j
 = 0; j < 
ySize
; j++)

1088 
löeRef
 = &
imgRef
[
j
][
xRef
];

1089 
löeSrc
 = &
imgSrc
[
j
][
xSrc
];

1091 
i
 = 0; i < 
xSize
; i++)

1092 
di°‹ti⁄
 +
	`übs2
–*
löeRef
++ - *
löeSrc
++ );

1094  
di°‹ti⁄
;

1095 
	}
}

1103 
	$ˇlcuœã_‰ame_no
(
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
p
)

1105 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

1107 
p¢rPOC
 = 
p_Vid
->
a˘ive_•s
->
mb_ad≠tive_‰ame_fõld_Êag
 ? 
p
->
poc
 /(
p_I≈
->
poc_sˇÀ
) :Ö->poc/(p_Inp->poc_scale);

1109 i‡(
p¢rPOC
==0)

1111 
p_Vid
->
idr_p¢r_numbî
 =Ö_Vid->
g_nFøme
 *Ö_Vid->
ªf_poc_g≠
/(
p_I≈
->
poc_sˇÀ
);

1113 
p_Vid
->
p¢r_numbî
 = 
	`imax
’_Vid->p¢r_numbî,Ö_Vid->
idr_p¢r_numbî
+
p¢rPOC
);

1115 
p_Vid
->
‰ame_no
 =Ö_Vid->
idr_p¢r_numbî
 + 
p¢rPOC
;

1116 
	}
}

1132 
	$föd_¢r
(
VideoP¨amëîs
 *
p_Vid
,

1133 
St‹abÀPi˘uª
 *
p
,

1134 *
p_ªf
)

1136 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

1137 
SNRP¨amëîs
 *
¢r
 = 
p_Vid
->snr;

1139 
k
;

1140 
ªt
;

1141 
öt64
 
diff_comp
[3] = {0};

1142 
öt64
 
°©us
;

1143 
symbﬁ_size_ö_byãs
 = (
p_Vid
->
pic_unô_bôsize_⁄_disk
 >> 3);

1144 
comp_size_x
[3], 
comp_size_y
[3];

1145 
öt64
 
‰amesize_ö_byãs
;

1147 
max_pix_vÆue_sqd
[3];

1149 
Boﬁón
 
rgb_ouçut
 = (BoﬁónË(
p_Vid
->
a˘ive_•s
->
vui_£q_∑ømëîs
.
m©rix_c€fficõ¡s
==0);

1150 *
buf
;

1151 
img≥l
 **
cur_ªf
 [3];

1152 
img≥l
 **
cur_comp
[3];

1154 
yuv_ty≥s
[4][6]= {"4:0:0","4:2:0","4:2:2","4:4:4"};

1156 
max_pix_vÆue_sqd
[0] = 
	`übs2
(
p_Vid
->
max_≥l_vÆue_comp
[0]);

1157 
max_pix_vÆue_sqd
[1] = 
	`übs2
(
p_Vid
->
max_≥l_vÆue_comp
[1]);

1158 
max_pix_vÆue_sqd
[2] = 
	`übs2
(
p_Vid
->
max_≥l_vÆue_comp
[2]);

1160 
cur_ªf
[0] = 
p_Vid
->
imgY_ªf
;

1161 
cur_ªf
[1] = 
p
->
chroma_f‹m©_idc
 !
YUV400
 ? 
p_Vid
->
imgUV_ªf
[0] : 
NULL
;

1162 
cur_ªf
[2] = 
p
->
chroma_f‹m©_idc
 !
YUV400
 ? 
p_Vid
->
imgUV_ªf
[1] : 
NULL
;

1164 
cur_comp
[0] = 
p
->
imgY
;

1165 
cur_comp
[1] = 
p
->
chroma_f‹m©_idc
 !
YUV400
 ?Ö->
imgUV
[0] : 
NULL
;

1166 
cur_comp
[2] = 
p
->
chroma_f‹m©_idc
!
YUV400
 ?Ö->
imgUV
[1] : 
NULL
;

1168 
comp_size_x
[0] = 
p_I≈
->
sour˚
.
width
[0];

1169 
comp_size_y
[0] = 
p_I≈
->
sour˚
.
height
[0];

1170 
comp_size_x
[1] = comp_size_x[2] = 
p_I≈
->
sour˚
.
width
[1];

1171 
comp_size_y
[1] = comp_size_y[2] = 
p_I≈
->
sour˚
.
height
[1];

1173 
‰amesize_ö_byãs
 = (((
öt64
Ë
comp_size_x
[0] * 
comp_size_y
[0]Ë+ ((öt64Ëcomp_size_x[1] * comp_size_y[1] ) * 2Ë* 
symbﬁ_size_ö_byãs
;

1176 
buf
 = 
	`mÆloc
 ( 
comp_size_x
[0] * 
comp_size_y
[0] * 
symbﬁ_size_ö_byãs
 );

1178 i‡(
NULL
 =
buf
)

1180 
	`no_mem_exô
("find_snr: buf");

1183 
°©us
 = 
	`l£ek
 (*
p_ªf
, 
‰amesize_ö_byãs
 * 
p_Vid
->
‰ame_no
, 
SEEK_SET
);

1184 i‡(
°©us
 == -1)

1186 
	`Ârötf
(
°dîr
, "W¨nög: CouldÇŸ sìkÅÿ‰amênumbî %d i¿ª„ªn˚ fûe. Show¿PSNR mighàbêwr⁄g.\n", 
p_Vid
->
‰ame_no
);

1187 
	`‰ì
 (
buf
);

1191 if(
rgb_ouçut
)

1192 
	`l£ek
 (*
p_ªf
, 
‰amesize_ö_byãs
/3, 
SEEK_CUR
);

1194 
k
 = 0; k < ((
p
->
chroma_f‹m©_idc
 !
YUV400
) ? 3 : 1); ++k)

1197 if(
rgb_ouçut
 && 
k
 == 2)

1198 
	`l£ek
 (*
p_ªf
, -
‰amesize_ö_byãs
, 
SEEK_CUR
);

1200 
ªt
 = 
	`ªad
(*
p_ªf
, 
buf
, 
comp_size_x
[
k
] * 
comp_size_y
[k] * 
symbﬁ_size_ö_byãs
);

1201 i‡(
ªt
 !
comp_size_x
[
k
] * 
comp_size_y
[k] * 
symbﬁ_size_ö_byãs
)

1203 
	`¥ötf
 ("Warning: couldÇotÑead fromÑeconstructed file\n");

1204 
	`Á°_mem£t
 (
buf
, 0, 
comp_size_x
[
k
] * 
comp_size_y
[k] * 
symbﬁ_size_ö_byãs
);

1205 
	`˛o£
(*
p_ªf
);

1206 *
p_ªf
 = -1;

1209 
	`buf„r2img
(
cur_ªf
[
k
], 
buf
, 
comp_size_x
[k], 
comp_size_y
[k], 
symbﬁ_size_ö_byãs
);

1212 
diff_comp
[
k
] = 
	`compuã_SSE
(
cur_ªf
[k], 
cur_comp
[k], 0, 0, 
comp_size_y
[k], 
comp_size_x
[k]);

1215 
¢r
->¢r[
k
] = 
	`p¢r
–
max_pix_vÆue_sqd
[k], 
comp_size_x
[k] * 
comp_size_y
[k], (Ë
diff_comp
[k]);

1217 i‡(
¢r
->
‰ame_˘r
 == 0)

1219 
¢r
->
¢ø
[
k
] = snr->snr[k];

1223 
¢r
->
¢ø
[
k
] = ()(¢r->¢ø[k]*(¢r->
‰ame_˘r
)+snr->snr[k])/(snr->frame_ctr + 1);

1227 if(
rgb_ouçut
)

1228 
	`l£ek
 (*
p_ªf
, 
‰amesize_ö_byãs
 * 2 / 3, 
SEEK_CUR
);

1230 
	`‰ì
 (
buf
);

1233 if(
p
->
c⁄˚Æed_pic
)

1235 
	`Ârötf
(
°dout
,"%04d(P) %8d %5d %5d %7.4f %7.4f %7.4f %s %5d\n",

1236 
p_Vid
->
‰ame_no
, 
p
->
‰ame_poc
,Ö->
pic_num
,Ö->
qp
,

1237 
¢r
->¢r[0], sƒ->¢r[1], sƒ->¢r[2], 
yuv_ty≥s
[
p
->
chroma_f‹m©_idc
], 0);

1239 
	}
}

1242 
	$ª‹dî_li°s
(
Sli˚
 *
cuºSli˚
)

1244 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

1246 i‡((
cuºSli˚
->
¶i˚_ty≥
 !
I_SLICE
)&&(cuºSli˚->¶i˚_ty≥ !
SI_SLICE
))

1248 i‡(
cuºSli˚
->
ªf_pic_li°_ª‹dîög_Êag
[
LIST_0
])

1250 
	`ª‹dî_ªf_pic_li°
(
cuºSli˚
, 
LIST_0
);

1252 i‡(
p_Vid
->
no_ª„ªn˚_pi˘uª
 =
cuºSli˚
->
li°X
[0][cuºSli˚->
num_ªf_idx_a˘ive
[
LIST_0
] - 1])

1254 i‡(
p_Vid
->
n⁄_c⁄f‹mög_°ªam
)

1255 
	`¥ötf
("RefPicLi°0[ %d ] i†equÆÅÿ'nÿª„ªn˚Öi˘uª'\n", 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
] - 1);

1257 
	`îr‹
("RefPicList0[Çum_ref_idx_l0_active_minus1 ] isÉqualÅo 'noÑeferenceÖicture', invalid bitstream",500);

1260 
cuºSli˚
->
li°Xsize
[0] = (ËcuºSli˚->
num_ªf_idx_a˘ive
[
LIST_0
];

1263 i‡(
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
)

1265 i‡(
cuºSli˚
->
ªf_pic_li°_ª‹dîög_Êag
[
LIST_1
])

1267 
	`ª‹dî_ªf_pic_li°
(
cuºSli˚
, 
LIST_1
);

1269 i‡(
p_Vid
->
no_ª„ªn˚_pi˘uª
 =
cuºSli˚
->
li°X
[1][cuºSli˚->
num_ªf_idx_a˘ive
[
LIST_1
]-1])

1271 i‡(
p_Vid
->
n⁄_c⁄f‹mög_°ªam
)

1272 
	`¥ötf
("RefPicLi°1[ %d ] i†equÆÅÿ'nÿª„ªn˚Öi˘uª'\n", 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_1
] - 1);

1274 
	`îr‹
("RefPicList1[Çum_ref_idx_l1_active_minus1 ] isÉqualÅo 'noÑeferenceÖicture', invalid bitstream",500);

1277 
cuºSli˚
->
li°Xsize
[1] = (ËcuºSli˚->
num_ªf_idx_a˘ive
[
LIST_1
];

1280 
	`‰ì_ªf_pic_li°_ª‹dîög_buf„r
(
cuºSli˚
);

1282 i‡–
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
 )

1284 #i‡
PRINTREFLIST


1285 
i
;

1286 #i‡(
MVC_EXTENSION_ENABLE
)

1288 if((
p_Vid
->
¥ofûe_idc
 =
MVC_HIGH
 ||Ö_Vid->¥ofûe_id¯=
STEREO_HIGH
Ë&& 
cuºSli˚
->
cuºít_¶i˚_ƒ
==0)

1290 if(
cuºSli˚
->
li°Xsize
[0]>0)

1292 
	`¥ötf
("\n");

1293 
	`¥ötf
(" ** (FöÆVõwID:%dË%†Re‡Pi¯Li° 0 ****\n", 
cuºSli˚
->
võw_id
, cuºSli˚->
°ru˘uª
==
FRAME
 ? "FRM":(cuºSli˚->°ru˘uª==
TOP_FIELD
 ? "TOP":"BOT"));

1294 
i
=0; i<()(
cuºSli˚
->
li°Xsize
[0]); i++)

1296 
	`¥ötf
(" %2d -> POC: %4d PicNum: %4d VõwID: %d\n", 
i
, 
cuºSli˚
->
li°X
[0][i]->
poc
, cuºSli˚->li°X[0][i]->
pic_num
, cuºSli˚->li°X[0][i]->
võw_id
);

1303 i‡–
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
 )

1305 #i‡
PRINTREFLIST


1306 
i
;

1307 #i‡(
MVC_EXTENSION_ENABLE
)

1309 if((
p_Vid
->
¥ofûe_idc
 =
MVC_HIGH
 ||Ö_Vid->¥ofûe_id¯=
STEREO_HIGH
Ë&& 
cuºSli˚
->
cuºít_¶i˚_ƒ
==0)

1311 if((
cuºSli˚
->
li°Xsize
[0]>0) || (currSlice->listXsize[1]>0))

1312 
	`¥ötf
("\n");

1313 if(
cuºSli˚
->
li°Xsize
[0]>0)

1315 
	`¥ötf
(" ** (FöÆVõwID:%dË%†Re‡Pi¯Li° 0 ****\n", 
cuºSli˚
->
võw_id
, cuºSli˚->
°ru˘uª
==
FRAME
 ? "FRM":(cuºSli˚->°ru˘uª==
TOP_FIELD
 ? "TOP":"BOT"));

1316 
i
=0; i<()(
cuºSli˚
->
li°Xsize
[0]); i++)

1318 
	`¥ötf
(" %2d -> POC: %4d PicNum: %4d VõwID: %d\n", 
i
, 
cuºSli˚
->
li°X
[0][i]->
poc
, cuºSli˚->li°X[0][i]->
pic_num
, cuºSli˚->li°X[0][i]->
võw_id
);

1321 if(
cuºSli˚
->
li°Xsize
[1]>0)

1323 
	`¥ötf
(" ** (FöÆVõwID:%dË%†Re‡Pi¯Li° 1 ****\n", 
cuºSli˚
->
võw_id
, cuºSli˚->
°ru˘uª
==
FRAME
 ? "FRM":(cuºSli˚->°ru˘uª==
TOP_FIELD
 ? "TOP":"BOT"));

1324 
i
=0; i<()(
cuºSli˚
->
li°Xsize
[1]); i++)

1326 
	`¥ötf
(" %2d -> POC: %4d PicNum: %4d VõwID: %d\n", 
i
, 
cuºSli˚
->
li°X
[1][i]->
poc
, cuºSli˚->li°X[1][i]->
pic_num
, cuºSli˚->li°X[1][i]->
võw_id
);

1334 
	}
}

1343 
	$ªad_√w_¶i˚
(
Sli˚
 *
cuºSli˚
)

1345 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

1346 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºSli˚
->p_Inp;

1348 
NALU_t
 *
«lu
 = 
p_Vid
->nalu;

1349 
cuºít_hódî
 = 0;

1350 
BôsU£dByHódî
;

1351 
Bô°ªam
 *
cuºSåóm
 = 
NULL
;

1353 
¶i˚_id_a
, 
¶i˚_id_b
, 
¶i˚_id_c
;

1357 #i‡(
MVC_EXTENSION_ENABLE
)

1358 
cuºSli˚
->
svc_exãnsi⁄_Êag
 = -1;

1360 i‡(0 =
	`ªad_√xt_«lu
(
p_Vid
, 
«lu
))

1361  
EOS
;

1363 #i‡(
MVC_EXTENSION_ENABLE
)

1364 if(
p_I≈
->
DecodeAŒLayîs
 =1 && (
«lu
->
«l_unô_ty≥
 =
NALU_TYPE_PREFIX
 ||ÇÆu->«l_unô_ty≥ =
NALU_TYPE_SLC_EXT
))

1366 
cuºSåóm
 = 
cuºSli˚
->
∑πAº
[0].
bô°ªam
;

1367 
cuºSåóm
->
ei_Êag
 = 0;

1368 
cuºSåóm
->
‰ame_bôoff£t
 = cuºSåóm->
ªad_Àn
 = 0;

1369 
	`Á°_mem˝y
 (
cuºSåóm
->
°ªamBuf„r
, &
«lu
->
buf
[1],ÇÆu->
Àn
-1);

1370 
cuºSåóm
->
code_Àn
 = cuºSåóm->
bô°ªam_Àngth
 = 
	`RBSPtoSODB
(cuºSåóm->
°ªamBuf„r
, 
«lu
->
Àn
-1);

1372 
cuºSli˚
->
svc_exãnsi⁄_Êag
 = 
	`ªad_u_1
 ("svc_exãnsi⁄_Êag" , 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

1374 if(
cuºSli˚
->
svc_exãnsi⁄_Êag
)

1376 
	`«l_unô_hódî_svc_exãnsi⁄
();

1380 
	`«l_unô_hódî_mvc_exãnsi⁄
(&
cuºSli˚
->
NÆuHódîMVCExt
, 
cuºSåóm
);

1381 
cuºSli˚
->
NÆuHódîMVCExt
.
iPªfixNALU
 = (
«lu
->
«l_unô_ty≥
 =
NALU_TYPE_PREFIX
);

1384 if(
«lu
->
«l_unô_ty≥
 =
NALU_TYPE_SLC_EXT
)

1386 if(
cuºSli˚
->
svc_exãnsi⁄_Êag
)

1392 
«lu
->
«l_unô_ty≥
 = 
NALU_TYPE_SLICE
;

1398 
¥o˚ss_«lu
:

1399 
«lu
->
«l_unô_ty≥
)

1401 
NALU_TYPE_SLICE
:

1402 
NALU_TYPE_IDR
:

1404 i‡(
p_Vid
->
ªcovîy_poöt
 || 
«lu
->
«l_unô_ty≥
 =
NALU_TYPE_IDR
)

1406 i‡(
p_Vid
->
ªcovîy_poöt_found
 == 0)

1408 i‡(
«lu
->
«l_unô_ty≥
 !
NALU_TYPE_IDR
)

1410 
	`¥ötf
("Warning: Decoding doesÇot start withán IDRÖicture.\n");

1411 
p_Vid
->
n⁄_c⁄f‹mög_°ªam
 = 1;

1414 
p_Vid
->
n⁄_c⁄f‹mög_°ªam
 = 0;

1416 
p_Vid
->
ªcovîy_poöt_found
 = 1;

1419 i‡(
p_Vid
->
ªcovîy_poöt_found
 == 0)

1422 
cuºSli˚
->
idr_Êag
 = (
«lu
->
«l_unô_ty≥
 =
NALU_TYPE_IDR
);

1423 
cuºSli˚
->
«l_ª„ªn˚_idc
 = 
«lu
->nal_reference_idc;

1424 
cuºSli˚
->
dp_mode
 = 
PAR_DP_1
;

1425 
cuºSli˚
->
max_∑π_ƒ
 = 1;

1426 #i‡(
MVC_EXTENSION_ENABLE
)

1427 i‡(
cuºSli˚
->
svc_exãnsi⁄_Êag
 != 0)

1429 
cuºSåóm
 = 
cuºSli˚
->
∑πAº
[0].
bô°ªam
;

1430 
cuºSåóm
->
ei_Êag
 = 0;

1431 
cuºSåóm
->
‰ame_bôoff£t
 = cuºSåóm->
ªad_Àn
 = 0;

1432 
	`Á°_mem˝y
 (
cuºSåóm
->
°ªamBuf„r
, &
«lu
->
buf
[1],ÇÆu->
Àn
-1);

1433 
cuºSåóm
->
code_Àn
 = cuºSåóm->
bô°ªam_Àngth
 = 
	`RBSPtoSODB
(cuºSåóm->
°ªamBuf„r
, 
«lu
->
Àn
-1);

1436 
cuºSåóm
 = 
cuºSli˚
->
∑πAº
[0].
bô°ªam
;

1437 
cuºSåóm
->
ei_Êag
 = 0;

1438 
cuºSåóm
->
‰ame_bôoff£t
 = cuºSåóm->
ªad_Àn
 = 0;

1439 
	`mem˝y
 (
cuºSåóm
->
°ªamBuf„r
, &
«lu
->
buf
[1],ÇÆu->
Àn
-1);

1440 
cuºSåóm
->
code_Àn
 = cuºSåóm->
bô°ªam_Àngth
 = 
	`RBSPtoSODB
(cuºSåóm->
°ªamBuf„r
, 
«lu
->
Àn
-1);

1443 #i‡(
MVC_EXTENSION_ENABLE
)

1444 if(
cuºSli˚
->
svc_exãnsi⁄_Êag
 == 0)

1448 
cuºSli˚
->
võw_id
 = cuºSli˚->
NÆuHódîMVCExt
.view_id;

1449 
cuºSli˚
->
öãr_võw_Êag
 = cuºSli˚->
NÆuHódîMVCExt
.inter_view_flag;

1450 
cuºSli˚
->
™ch‹_pic_Êag
 = cuºSli˚->
NÆuHódîMVCExt
.anchor_pic_flag;

1453 if(
cuºSli˚
->
svc_exãnsi⁄_Êag
 == -1)

1455 if(
p_Vid
->
a˘ive_sub£t_•s
 =
NULL
)

1457 
cuºSli˚
->
võw_id
 = 
	`GëBa£VõwId
(
p_Vid
, &p_Vid->
a˘ive_sub£t_•s
);

1458 if(
cuºSli˚
->
NÆuHódîMVCExt
.
iPªfixNALU
 >0)

1460 
	`as£π
(
cuºSli˚
->
võw_id
 =cuºSli˚->
NÆuHódîMVCExt
.view_id);

1461 
cuºSli˚
->
öãr_võw_Êag
 = cuºSli˚->
NÆuHódîMVCExt
.inter_view_flag;

1462 
cuºSli˚
->
™ch‹_pic_Êag
 = cuºSli˚->
NÆuHódîMVCExt
.anchor_pic_flag;

1466 
cuºSli˚
->
öãr_võw_Êag
 = 1;

1467 
cuºSli˚
->
™ch‹_pic_Êag
 = cuºSli˚->
idr_Êag
;

1472 
	`as£π
(
p_Vid
->
a˘ive_sub£t_•s
->
num_võws_möus1
 >=0);

1474 if(
cuºSli˚
->
NÆuHódîMVCExt
.
iPªfixNALU
 >0)

1476 
cuºSli˚
->
võw_id
 = cuºSli˚->
NÆuHódîMVCExt
.view_id;

1477 
cuºSli˚
->
öãr_võw_Êag
 = cuºSli˚->
NÆuHódîMVCExt
.inter_view_flag;

1478 
cuºSli˚
->
™ch‹_pic_Êag
 = cuºSli˚->
NÆuHódîMVCExt
.anchor_pic_flag;

1482 
cuºSli˚
->
võw_id
 = 
p_Vid
->
a˘ive_sub£t_•s
->view_id[0];

1483 
cuºSli˚
->
öãr_võw_Êag
 = 1;

1484 
cuºSli˚
->
™ch‹_pic_Êag
 = cuºSli˚->
idr_Êag
;

1488 
cuºSli˚
->
œyî_id
 = cuºSli˚->
võw_id
 = 
	`GëVOIdx
–
p_Vid
, currSlice->view_id );

1502 
BôsU£dByHódî
 = 
	`Fú°P¨tOfSli˚Hódî
(
cuºSli˚
);

1503 
	`U£P¨amëîSë
 (
cuºSli˚
);

1504 
cuºSli˚
->
a˘ive_•s
 = 
p_Vid
->active_sps;

1505 
cuºSli˚
->
a˘ive_µs
 = 
p_Vid
->active_pps;

1506 
cuºSli˚
->
Tønsf‹m8x8Mode
 = 
p_Vid
->
a˘ive_µs
->
å™sf‹m_8x8_mode_Êag
;

1507 
cuºSli˚
->
chroma444_nŸ_£∑øã
 = (
p_Vid
->
a˘ive_•s
->
chroma_f‹m©_idc
==
YUV444
)&&(’_Vid->
£∑øã_cﬁour_∂™e_Êag
 == 0));

1509 
BôsU£dByHódî
 +
	`Re°OfSli˚Hódî
 (
cuºSli˚
);

1510 #i‡(
MVC_EXTENSION_ENABLE
)

1511 if(
cuºSli˚
->
võw_id
 >=0)

1513 
cuºSli˚
->
p_Dpb
 = 
p_Vid
->
p_Dpb_œyî
[cuºSli˚->
võw_id
];

1517 
	`assign_qu™t_∑øms
 (
cuºSli˚
);

1520 if(
cuºSli˚
->
ªdund™t_pic_˙t
 && 
p_Vid
->
Is_¥im¨y_c‹ª˘
==0 &&Ö_Vid->
Is_ªdund™t_c‹ª˘
)

1522 
p_Vid
->
dec_pi˘uª
->
¶i˚_ty≥
 =Ö_Vid->
ty≥
;

1525 if(
	`is_√w_pi˘uª
(
p_Vid
->
dec_pi˘uª
, 
cuºSli˚
,Ö_Vid->
ﬁd_¶i˚
))

1527 if(
p_Vid
->
iSli˚NumOfCuºPic
==0)

1528 
	`öô_pi˘uª
(
p_Vid
, 
cuºSli˚
, 
p_I≈
);

1530 
cuºít_hódî
 = 
SOP
;

1532 
	`CheckZîoByãVCL
(
p_Vid
, 
«lu
);

1535 
cuºít_hódî
 = 
SOS
;

1537 
	`£tup_¶i˚_mëhods
(
cuºSli˚
);

1540 i‡(
cuºSli˚
->
mb_aff_‰ame_Êag
)

1541 
cuºSli˚
->
cuºít_mb_ƒ
 = cuºSli˚->
°¨t_mb_ƒ
 << 1;

1543 
cuºSli˚
->
cuºít_mb_ƒ
 = cuºSli˚->
°¨t_mb_ƒ
;

1545 i‡(
p_Vid
->
a˘ive_µs
->
íå›y_codög_mode_Êag
)

1547 
ByãSèπPosôi⁄
 = 
cuºSåóm
->
‰ame_bôoff£t
/8;

1548 i‡(
cuºSåóm
->
‰ame_bôoff£t
%8 != 0)

1550 ++
ByãSèπPosôi⁄
;

1552 
	`¨ideco_°¨t_decodög
 (&
cuºSli˚
->
∑πAº
[0].
de_ˇbac
, 
cuºSåóm
->
°ªamBuf„r
, 
ByãSèπPosôi⁄
, &cuºSåóm->
ªad_Àn
);

1556 
p_Vid
->
ªcovîy_poöt
 = 0;

1557  
cuºít_hódî
;

1559 
NALU_TYPE_DPA
:

1560 i‡(
p_Vid
->
ªcovîy_poöt_found
 == 0)

1564 
cuºSli˚
->
dpB_NŸPª£¡
 =1;

1565 
cuºSli˚
->
dpC_NŸPª£¡
 =1;

1567 
cuºSli˚
->
idr_Êag
 = 
FALSE
;

1568 
cuºSli˚
->
«l_ª„ªn˚_idc
 = 
«lu
->nal_reference_idc;

1569 
cuºSli˚
->
dp_mode
 = 
PAR_DP_3
;

1570 
cuºSli˚
->
max_∑π_ƒ
 = 3;

1571 
cuºSli˚
->
ei_Êag
 = 0;

1572 #i‡
MVC_EXTENSION_ENABLE


1573 
cuºSli˚
->
p_Dpb
 = 
p_Vid
->
p_Dpb_œyî
[0];

1575 
cuºSåóm
 = 
cuºSli˚
->
∑πAº
[0].
bô°ªam
;

1576 
cuºSåóm
->
ei_Êag
 = 0;

1577 
cuºSåóm
->
‰ame_bôoff£t
 = cuºSåóm->
ªad_Àn
 = 0;

1578 
	`mem˝y
 (
cuºSåóm
->
°ªamBuf„r
, &
«lu
->
buf
[1],ÇÆu->
Àn
-1);

1579 
cuºSåóm
->
code_Àn
 = cuºSåóm->
bô°ªam_Àngth
 = 
	`RBSPtoSODB
(cuºSåóm->
°ªamBuf„r
, 
«lu
->
Àn
-1);

1580 #i‡
MVC_EXTENSION_ENABLE


1581 
cuºSli˚
->
võw_id
 = 
	`GëBa£VõwId
(
p_Vid
, &p_Vid->
a˘ive_sub£t_•s
);

1582 
cuºSli˚
->
öãr_võw_Êag
 = 1;

1583 
cuºSli˚
->
œyî_id
 = cuºSli˚->
võw_id
 = 
	`GëVOIdx
–
p_Vid
, currSlice->view_id );

1584 
cuºSli˚
->
™ch‹_pic_Êag
 = cuºSli˚->
idr_Êag
;

1587 
BôsU£dByHódî
 = 
	`Fú°P¨tOfSli˚Hódî
(
cuºSli˚
);

1588 
	`U£P¨amëîSë
 (
cuºSli˚
);

1589 
cuºSli˚
->
a˘ive_•s
 = 
p_Vid
->active_sps;

1590 
cuºSli˚
->
a˘ive_µs
 = 
p_Vid
->active_pps;

1591 
cuºSli˚
->
Tønsf‹m8x8Mode
 = 
p_Vid
->
a˘ive_µs
->
å™sf‹m_8x8_mode_Êag
;

1592 
cuºSli˚
->
chroma444_nŸ_£∑øã
 = (
p_Vid
->
a˘ive_•s
->
chroma_f‹m©_idc
==
YUV444
)&&(’_Vid->
£∑øã_cﬁour_∂™e_Êag
 == 0));

1594 
BôsU£dByHódî
 +
	`Re°OfSli˚Hódî
 (
cuºSli˚
);

1595 #i‡
MVC_EXTENSION_ENABLE


1596 
cuºSli˚
->
p_Dpb
 = 
p_Vid
->
p_Dpb_œyî
[cuºSli˚->
võw_id
];

1599 
	`assign_qu™t_∑øms
 (
cuºSli˚
);

1602 if(
	`is_√w_pi˘uª
(
p_Vid
->
dec_pi˘uª
, 
cuºSli˚
,Ö_Vid->
ﬁd_¶i˚
))

1604 if(
p_Vid
->
iSli˚NumOfCuºPic
==0)

1605 
	`öô_pi˘uª
(
p_Vid
, 
cuºSli˚
, 
p_I≈
);

1607 
cuºít_hódî
 = 
SOP
;

1609 
	`CheckZîoByãVCL
(
p_Vid
, 
«lu
);

1612 
cuºít_hódî
 = 
SOS
;

1614 
	`£tup_¶i˚_mëhods
(
cuºSli˚
);

1617 i‡(
cuºSli˚
->
mb_aff_‰ame_Êag
)

1618 
cuºSli˚
->
cuºít_mb_ƒ
 = cuºSli˚->
°¨t_mb_ƒ
 << 1;

1620 
cuºSli˚
->
cuºít_mb_ƒ
 = cuºSli˚->
°¨t_mb_ƒ
;

1625 
¶i˚_id_a
 = 
	`ªad_ue_v
("NALU: DP_A sli˚_id", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

1627 i‡(
p_Vid
->
a˘ive_µs
->
íå›y_codög_mode_Êag
)

1628 
	`îr‹
 ("received dataÖartition with CABAC,Åhis isÇotállowed", 500);

1631 i‡(0 =
	`ªad_√xt_«lu
(
p_Vid
, 
«lu
))

1632  
cuºít_hódî
;

1634 i‡–
NALU_TYPE_DPB
 =
«lu
->
«l_unô_ty≥
)

1637 
cuºSåóm
 = 
cuºSli˚
->
∑πAº
[1].
bô°ªam
;

1638 
cuºSåóm
->
ei_Êag
 = 0;

1639 
cuºSåóm
->
‰ame_bôoff£t
 = cuºSåóm->
ªad_Àn
 = 0;

1641 
	`mem˝y
 (
cuºSåóm
->
°ªamBuf„r
, &
«lu
->
buf
[1],ÇÆu->
Àn
-1);

1642 
cuºSåóm
->
code_Àn
 = cuºSåóm->
bô°ªam_Àngth
 = 
	`RBSPtoSODB
(cuºSåóm->
°ªamBuf„r
, 
«lu
->
Àn
-1);

1644 
¶i˚_id_b
 = 
	`ªad_ue_v
("NALU: DP_B sli˚_id", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

1646 
cuºSli˚
->
dpB_NŸPª£¡
 = 0;

1648 i‡((
¶i˚_id_b
 !
¶i˚_id_a
Ë|| (
«lu
->
lo°_∑ckës
))

1650 
	`¥ötf
 ("Waning: gotá dataÖartition B which doesÇot match DP_A (DPÜoss!)\n");

1651 
cuºSli˚
->
dpB_NŸPª£¡
 =1;

1652 
cuºSli˚
->
dpC_NŸPª£¡
 =1;

1656 i‡(
p_Vid
->
a˘ive_µs
->
ªdund™t_pic_˙t_¥e£¡_Êag
)

1657 
	`ªad_ue_v
("NALU: DP_BÑedund™t_pic_˙t", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

1660 i‡(0 =
	`ªad_√xt_«lu
(
p_Vid
, 
«lu
))

1661  
cuºít_hódî
;

1666 
cuºSli˚
->
dpB_NŸPª£¡
 =1;

1670 i‡–
NALU_TYPE_DPC
 =
«lu
->
«l_unô_ty≥
)

1672 
cuºSåóm
 = 
cuºSli˚
->
∑πAº
[2].
bô°ªam
;

1673 
cuºSåóm
->
ei_Êag
 = 0;

1674 
cuºSåóm
->
‰ame_bôoff£t
 = cuºSåóm->
ªad_Àn
 = 0;

1676 
	`mem˝y
 (
cuºSåóm
->
°ªamBuf„r
, &
«lu
->
buf
[1],ÇÆu->
Àn
-1);

1677 
cuºSåóm
->
code_Àn
 = cuºSåóm->
bô°ªam_Àngth
 = 
	`RBSPtoSODB
(cuºSåóm->
°ªamBuf„r
, 
«lu
->
Àn
-1);

1679 
cuºSli˚
->
dpC_NŸPª£¡
 = 0;

1681 
¶i˚_id_c
 = 
	`ªad_ue_v
("NALU: DP_C sli˚_id", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

1682 i‡((
¶i˚_id_c
 !
¶i˚_id_a
)|| (
«lu
->
lo°_∑ckës
))

1684 
	`¥ötf
 ("Warning: gotá dataÖartition C which doesÇot match DP_A(DPÜoss!)\n");

1686 
cuºSli˚
->
dpC_NŸPª£¡
 =1;

1689 i‡(
p_Vid
->
a˘ive_µs
->
ªdund™t_pic_˙t_¥e£¡_Êag
)

1690 
	`ªad_ue_v
("NALU:SLICE_CÑedud™d_pic_˙t", 
cuºSåóm
, &
p_Dec
->
U£dBôs
);

1694 
cuºSli˚
->
dpC_NŸPª£¡
 =1;

1698 i‡((
«lu
->
«l_unô_ty≥
 !
NALU_TYPE_DPB
Ë&& («lu->«l_unô_ty≥ !
NALU_TYPE_DPC
))

1701 
¥o˚ss_«lu
;

1707  
cuºít_hódî
;

1709 
NALU_TYPE_DPB
:

1710 i‡(
p_I≈
->
sûít
 =
FALSE
)

1712 
	`¥ötf
 ("found dataÖartition B without matching DP A, discarding\n");

1715 
NALU_TYPE_DPC
:

1716 i‡(
p_I≈
->
sûít
 =
FALSE
)

1718 
	`¥ötf
 ("found dataÖartition C without matching DP A, discarding\n");

1721 
NALU_TYPE_SEI
:

1723 
	`I¡î¥ëSEIMesßge
(
«lu
->
buf
,«lu->
Àn
,
p_Vid
, 
cuºSli˚
);

1725 
NALU_TYPE_PPS
:

1727 
	`Pro˚ssPPS
(
p_Vid
, 
«lu
);

1729 
NALU_TYPE_SPS
:

1731 
	`Pro˚ssSPS
(
p_Vid
, 
«lu
);

1733 
NALU_TYPE_AUD
:

1737 
NALU_TYPE_EOSEQ
:

1740 
NALU_TYPE_EOSTREAM
:

1743 
NALU_TYPE_FILL
:

1744 i‡(
p_I≈
->
sûít
 =
FALSE
)

1750 #i‡(
MVC_EXTENSION_ENABLE
)

1751 
NALU_TYPE_VDRD
:

1755 
NALU_TYPE_PREFIX
:

1757 if(
cuºSli˚
->
svc_exãnsi⁄_Êag
==1)

1758 
	`¥efix_«l_unô_svc
();

1760 
NALU_TYPE_SUB_SPS
:

1762 i‡(
p_I≈
->
DecodeAŒLayîs
== 1)

1764 
	`Pro˚ssSub£tSPS
(
p_Vid
, 
«lu
);

1768 i‡(
p_I≈
->
sûít
 =
FALSE
)

1769 
	`¥ötf
 ("Found Subsequence SPS NALU. Ignoring.\n");

1772 
NALU_TYPE_SLC_EXT
:

1774 i‡(
p_I≈
->
DecodeAŒLayîs
 =0 && (p_I≈->
sûít
 =
FALSE
))

1775 
	`¥ötf
 ("Found SVCÉxãnsi⁄ NALU (%d). Ign‹ög.\n", (Ë
«lu
->
«l_unô_ty≥
);

1780 i‡(
p_I≈
->
sûít
 =
FALSE
)

1781 
	`¥ötf
 ("Found NALUÅy≥ %d,Üí %d undeföed, ign‹êNALU, movög on\n", (Ë
«lu
->
«l_unô_ty≥
, (Ë«lu->
Àn
);

1786 
	}
}

1788 
	$∑d_buf
(
img≥l
 *
pImgBuf
, 
iWidth
, 
iHeight
, 
iSåide
, 
iPadX
, 
iPadY
)

1790 
j
;

1791 
img≥l
 *
pLöe0
 = 
pImgBuf
 - 
iPadX
, *
pLöe
;

1792 #i‡(
IMGTYPE
==0)

1793 
∑d_width
 = 
iPadX
 + 
iWidth
;

1794 
	`Á°_mem£t
(
pImgBuf
 - 
iPadX
, *pImgBuf, iPadX * (
img≥l
));

1795 
	`Á°_mem£t
(
pImgBuf
 + 
iWidth
, *’ImgBu‡+ iWidth - 1), 
iPadX
 * (
img≥l
));

1797 
pLöe
 = 
pLöe0
 - 
iPadY
 * 
iSåide
;

1799 
j
 = -
iPadY
; j < 0; j++)

1801 
	`Á°_mem˝y
(
pLöe
, 
pLöe0
, 
iSåide
 * (
img≥l
));

1802 
pLöe
 +
iSåide
;

1805 
j
 = 1; j < 
iHeight
; j++)

1807 
pLöe
 +
iSåide
;

1808 
	`Á°_mem£t
(
pLöe
, *’Löê+ 
iPadX
), iPadX * (
img≥l
));

1809 
	`Á°_mem£t
(
pLöe
 + 
∑d_width
, *’Löê+Öad_width - 1), 
iPadX
 * (
img≥l
));

1812 
pLöe0
 = 
pLöe
 + 
iSåide
;

1814 
j
 = 
iHeight
; j < iHeighà+ 
iPadY
; j++)

1816 
	`Á°_mem˝y
(
pLöe0
, 
pLöe
, 
iSåide
 * (
img≥l
));

1817 
pLöe0
 +
iSåide
;

1820 
i
;

1821 
i
=-
iPadX
; i<0; i++)

1822 
pImgBuf
[
i
] = *pImgBuf;

1823 
i
=0; i<
iPadX
; i++)

1824 
pImgBuf
[
i
+
iWidth
] = *(pImgBuf+iWidth-1);

1826 
j
=-
iPadY
; j<0; j++)

1827 
	`mem˝y
(
pLöe0
+
j
*
iSåide
,ÖLöe0, iSåide*(
img≥l
));

1828 
j
=1; j<
iHeight
; j++)

1830 
pLöe
 = 
pLöe0
 + 
j
*
iSåide
;

1831 
i
=0; i<
iPadX
; i++)

1832 
pLöe
[
i
] =ÖLöe[
iPadX
];

1833 
pLöe
 +
iPadX
+
iWidth
-1;

1834 
i
=1; i<
iPadX
+1; i++)

1835 
pLöe
[
i
] = *pLine;

1837 
pLöe
 = 
pLöe0
 + (
iHeight
-1)*
iSåide
;

1838 
j
=
iHeight
; j<iHeight+
iPadY
; j++)

1839 
	`mem˝y
(
pLöe0
+
j
*
iSåide
, 
pLöe
, iSåide*(
img≥l
));

1841 
	}
}

1843 
	$∑d_dec_pi˘uª
(
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
)

1845 
iPadX
 = 
p_Vid
->
iLumaPadX
;

1846 
iPadY
 = 
p_Vid
->
iLumaPadY
;

1847 
iWidth
 = 
dec_pi˘uª
->
size_x
;

1848 
iHeight
 = 
dec_pi˘uª
->
size_y
;

1849 
iSåide
 = 
dec_pi˘uª
->
iLumaSåide
;

1851 
	`∑d_buf
(*
dec_pi˘uª
->
imgY
, 
iWidth
, 
iHeight
, 
iSåide
, 
iPadX
, 
iPadY
);

1853 if(
dec_pi˘uª
->
chroma_f‹m©_idc
 !
YUV400
)

1855 
iPadX
 = 
p_Vid
->
iChromaPadX
;

1856 
iPadY
 = 
p_Vid
->
iChromaPadY
;

1857 
iWidth
 = 
dec_pi˘uª
->
size_x_¸
;

1858 
iHeight
 = 
dec_pi˘uª
->
size_y_¸
;

1859 
iSåide
 = 
dec_pi˘uª
->
iChromaSåide
;

1860 
	`∑d_buf
(*
dec_pi˘uª
->
imgUV
[0], 
iWidth
, 
iHeight
, 
iSåide
, 
iPadX
, 
iPadY
);

1861 
	`∑d_buf
(*
dec_pi˘uª
->
imgUV
[1], 
iWidth
, 
iHeight
, 
iSåide
, 
iPadX
, 
iPadY
);

1863 
	}
}

1873 
	$exô_pi˘uª
(
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 **
dec_pi˘uª
)

1875 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

1876 
SNRP¨amëîs
 *
¢r
 = 
p_Vid
->snr;

1877 
yuv_ty≥s
[4][6]= {"4:0:0","4:2:0","4:2:2","4:4:4"};

1878 #i‡(
DISABLE_ERC
 == 0)

1879 
îcSèπMB
;

1880 
îcSegmít
;

1881 
‰ame
 
ªc‰
;

1883 
°ru˘uª
, 
‰ame_poc
, 
¶i˚_ty≥
, 
ªÂic
, 
qp
, 
pic_num
, 
chroma_f‹m©_idc
, 
is_idr
;

1885 
öt64
 
tmp_time
;

1886 
yuvF‹m©
[10];

1889 i‡(*
dec_pi˘uª
==
NULL
 || (
p_Vid
->
num_dec_mb
 !p_Vid->
PicSizeInMbs
 && (p_Vid->
yuv_f‹m©
 !
YUV444
 || !p_Vid->
£∑øã_cﬁour_∂™e_Êag
)))

1894 #i‡(
DISABLE_ERC
 == 0)

1895 
ªc‰
.
p_Vid
 =Ö_Vid;

1896 
ªc‰
.
y±r
 = &(*
dec_pi˘uª
)->
imgY
[0][0];

1897 i‡((*
dec_pi˘uª
)->
chroma_f‹m©_idc
 !
YUV400
)

1899 
ªc‰
.
u±r
 = &(*
dec_pi˘uª
)->
imgUV
[0][0][0];

1900 
ªc‰
.
v±r
 = &(*
dec_pi˘uª
)->
imgUV
[1][0][0];

1904 
îcSèπMB
 = 0;

1905 
îcSegmít
 = 0;

1908 i‡(!(*
dec_pi˘uª
)->
mb_aff_‰ame_Êag
)

1910 
i
;

1911 
	`îcSèπSegmít
(0, 
îcSegmít
, 0 , 
p_Vid
->
îc_îr‹V¨
);

1913 
i
 = 1; i < (Ë(*
dec_pi˘uª
)->
PicSizeInMbs
; ++i)

1915 if(
p_Vid
->
mb_d©a
[
i
].
ei_Êag
 !=Ö_Vid->mb_data[i-1].ei_flag)

1917 
	`îcSt›Segmít
(
i
-1, 
îcSegmít
, 0, 
p_Vid
->
îc_îr‹V¨
);

1920 if(
p_Vid
->
mb_d©a
[
i
-1].
ei_Êag
)

1921 
	`îcM¨kCuºSegmítLo°
((*
dec_pi˘uª
)->
size_x
, 
p_Vid
->
îc_îr‹V¨
);

1923 
	`îcM¨kCuºSegmítOK
((*
dec_pi˘uª
)->
size_x
, 
p_Vid
->
îc_îr‹V¨
);

1925 ++
îcSegmít
;

1926 
	`îcSèπSegmít
(
i
, 
îcSegmít
, 0 , 
p_Vid
->
îc_îr‹V¨
);

1927 
îcSèπMB
 = 
i
;

1931 
	`îcSt›Segmít
((*
dec_pi˘uª
)->
PicSizeInMbs
-1, 
îcSegmít
, 0, 
p_Vid
->
îc_îr‹V¨
);

1932 if(
p_Vid
->
mb_d©a
[
i
-1].
ei_Êag
)

1933 
	`îcM¨kCuºSegmítLo°
((*
dec_pi˘uª
)->
size_x
, 
p_Vid
->
îc_îr‹V¨
);

1935 
	`îcM¨kCuºSegmítOK
((*
dec_pi˘uª
)->
size_x
, 
p_Vid
->
îc_îr‹V¨
);

1938 
p_Vid
->
îc_mv≥rMB
 /(*
dec_pi˘uª
)->
PicSizeInMbs
;

1940 
p_Vid
->
îc_img
 =Ö_Vid;

1942 if((*
dec_pi˘uª
)->
¶i˚_ty≥
 =
I_SLICE
 || (*dec_pi˘uª)->¶i˚_ty≥ =
SI_SLICE
)

1943 
	`îcC⁄˚ÆI¡øFøme
(
p_Vid
, &
ªc‰
, (*
dec_pi˘uª
)->
size_x
, (*dec_pi˘uª)->
size_y
,Ö_Vid->
îc_îr‹V¨
);

1945 
	`îcC⁄˚ÆI¡îFøme
(&
ªc‰
, 
p_Vid
->
îc_obje˘_li°
, (*
dec_pi˘uª
)->
size_x
, (*dec_pi˘uª)->
size_y
,Ö_Vid->
îc_îr‹V¨
, (*dec_pi˘uª)->
chroma_f‹m©_idc
);

1949 if(!
p_Vid
->
iDeblockMode
 && (p_Vid->
bDeblockE«bÀ
 & (1<<(*
dec_pi˘uª
)->
u£d_f‹_ª„ªn˚
)))

1952 if–(
p_Vid
->
£∑øã_cﬁour_∂™e_Êag
 != 0) )

1954 
≈œ√
;

1955 
cﬁour_∂™e_id
 = 
p_Vid
->
µSli˚Li°
[0]->colour_plane_id;

1956  
≈œ√
=0;Ç∂™e<
MAX_PLANE
; ++nplane )

1958 
p_Vid
->
µSli˚Li°
[0]->
cﬁour_∂™e_id
 = 
≈œ√
;

1959 
	`ch™ge_∂™e_JV
–
p_Vid
, 
≈œ√
, 
NULL
 );

1960 
	`DeblockPi˘uª
–
p_Vid
, *
dec_pi˘uª
 );

1962 
p_Vid
->
µSli˚Li°
[0]->
cﬁour_∂™e_id
 = colour_plane_id;

1963 
	`make_‰ame_pi˘uª_JV
(
p_Vid
);

1967 
	`DeblockPi˘uª
–
p_Vid
, *
dec_pi˘uª
 );

1972 if–(
p_Vid
->
£∑øã_cﬁour_∂™e_Êag
 != 0) )

1974 
	`make_‰ame_pi˘uª_JV
(
p_Vid
);

1978 i‡((*
dec_pi˘uª
)->
mb_aff_‰ame_Êag
)

1979 
	`MbAffPo°Proc
(
p_Vid
);

1981 i‡(
p_Vid
->
°ru˘uª
 =
FRAME
)

1982 
	`‰ame_po°¥o˚ssög
(
p_Vid
);

1984 
	`fõld_po°¥o˚ssög
(
p_Vid
);

1985 #i‡(
MVC_EXTENSION_ENABLE
)

1986 if((*
dec_pi˘uª
)->
u£d_f‹_ª„ªn˚
 || ((*dec_pi˘uª)->
öãr_võw_Êag
 == 1))

1987 
	`∑d_dec_pi˘uª
(
p_Vid
, *
dec_pi˘uª
);

1989 if((*
dec_pi˘uª
)->
u£d_f‹_ª„ªn˚
)

1990 
	`∑d_dec_pi˘uª
(
p_Vid
, *
dec_pi˘uª
);

1992 
°ru˘uª
 = (*
dec_pi˘uª
)->structure;

1993 
¶i˚_ty≥
 = (*
dec_pi˘uª
)->slice_type;

1994 
‰ame_poc
 = (*
dec_pi˘uª
)->frame_poc;

1995 
ªÂic
 = (*
dec_pi˘uª
)->
u£d_f‹_ª„ªn˚
;

1996 
qp
 = (*
dec_pi˘uª
)->qp;

1997 
pic_num
 = (*
dec_pi˘uª
)->pic_num;

1998 
is_idr
 = (*
dec_pi˘uª
)->
idr_Êag
;

2000 
chroma_f‹m©_idc
 = (*
dec_pi˘uª
)->chroma_format_idc;

2001 #i‡
MVC_EXTENSION_ENABLE


2002 
	`°‹e_pi˘uª_ö_dpb
(
p_Vid
->
p_Dpb_œyî
[(*
dec_pi˘uª
)->
võw_id
], *dec_picture);

2004 
	`°‹e_pi˘uª_ö_dpb
(
p_Vid
->
p_Dpb_œyî
[0], *
dec_pi˘uª
);

2007 *
dec_pi˘uª
=
NULL
;

2009 i‡(
p_Vid
->
œ°_has_mmco_5
)

2011 
p_Vid
->
¥e_‰ame_num
 = 0;

2014 i‡(
p_I≈
->
sûít
 =
FALSE
)

2016 i‡(
°ru˘uª
==
TOP_FIELD
 || såu˘uª==
FRAME
)

2018 if(
¶i˚_ty≥
 =
I_SLICE
 && 
is_idr
)

2019 
	`°r˝y
(
p_Vid
->
c¶i˚_ty≥
,"IDR");

2020 if(
¶i˚_ty≥
 =
I_SLICE
)

2021 
	`°r˝y
(
p_Vid
->
c¶i˚_ty≥
," I ");

2022 if(
¶i˚_ty≥
 =
P_SLICE
)

2023 
	`°r˝y
(
p_Vid
->
c¶i˚_ty≥
," P ");

2024 if(
¶i˚_ty≥
 =
SP_SLICE
)

2025 
	`°r˝y
(
p_Vid
->
c¶i˚_ty≥
,"SP ");

2026 i‡(
¶i˚_ty≥
 =
SI_SLICE
)

2027 
	`°r˝y
(
p_Vid
->
c¶i˚_ty≥
,"SI ");

2028 if(
ªÂic
)

2029 
	`°r˝y
(
p_Vid
->
c¶i˚_ty≥
," B ");

2031 
	`°r˝y
(
p_Vid
->
c¶i˚_ty≥
," b ");

2033 i‡(
°ru˘uª
==
FRAME
)

2035 
	`°∫ˇt
(
p_Vid
->
c¶i˚_ty≥
,"Ë ",8-
	`°æí
(p_Vid->cslice_type));

2038 i‡(
°ru˘uª
==
BOTTOM_FIELD
)

2040 if(
¶i˚_ty≥
 =
I_SLICE
 && 
is_idr
)

2041 
	`°∫ˇt
(
p_Vid
->
c¶i˚_ty≥
,"|IDR)",8-
	`°æí
(p_Vid->cslice_type));

2042 if(
¶i˚_ty≥
 =
I_SLICE
)

2043 
	`°∫ˇt
(
p_Vid
->
c¶i˚_ty≥
,"| I )",8-
	`°æí
(p_Vid->cslice_type));

2044 if(
¶i˚_ty≥
 =
P_SLICE
)

2045 
	`°∫ˇt
(
p_Vid
->
c¶i˚_ty≥
,"| P )",8-
	`°æí
(p_Vid->cslice_type));

2046 if(
¶i˚_ty≥
 =
SP_SLICE
)

2047 
	`°∫ˇt
(
p_Vid
->
c¶i˚_ty≥
,"|SP )",8-
	`°æí
(p_Vid->cslice_type));

2048 i‡(
¶i˚_ty≥
 =
SI_SLICE
)

2049 
	`°∫ˇt
(
p_Vid
->
c¶i˚_ty≥
,"|SI )",8-
	`°æí
(p_Vid->cslice_type));

2050 if(
ªÂic
)

2051 
	`°∫ˇt
(
p_Vid
->
c¶i˚_ty≥
,"| B )",8-
	`°æí
(p_Vid->cslice_type));

2053 
	`°∫ˇt
(
p_Vid
->
c¶i˚_ty≥
,"| b )",8-
	`°æí
(p_Vid->cslice_type));

2057 i‡((
°ru˘uª
==
FRAME
)||°ru˘uª==
BOTTOM_FIELD
)

2059 
	`gëtime
 (&(
p_Vid
->
íd_time
));

2061 
tmp_time
 = 
	`timediff
(&(
p_Vid
->
°¨t_time
), &’_Vid->
íd_time
));

2062 
p_Vid
->
tŸ_time
 +
tmp_time
;

2063 
tmp_time
 = 
	`timí‹m
(tmp_time);

2064 
	`•rötf
(
yuvF‹m©
,"%s", 
yuv_ty≥s
[
chroma_f‹m©_idc
]);

2066 i‡(
p_I≈
->
sûít
 =
FALSE
)

2068 
SNRP¨amëîs
 *
¢r
 = 
p_Vid
->snr;

2069 i‡(
p_Vid
->
p_ªf
 != -1)

2070 
	`Ârötf
(
°dout
,"%05d(%s%5d %5d %5d %8.4f %8.4f %8.4f %s %7d\n",

2071 
p_Vid
->
‰ame_no
,Ö_Vid->
c¶i˚_ty≥
, 
‰ame_poc
, 
pic_num
, 
qp
, 
¢r
->¢r[0], sƒ->¢r[1], sƒ->¢r[2], 
yuvF‹m©
, (Ë
tmp_time
);

2073 
	`Ârötf
(
°dout
,"%05d(%s%5d %5d %5d %s %7d\n",

2074 
p_Vid
->
‰ame_no
,Ö_Vid->
c¶i˚_ty≥
, 
‰ame_poc
, 
pic_num
, 
qp
, 
yuvF‹m©
, ()
tmp_time
);

2077 
	`Ârötf
(
°dout
,"Com∂ëed Decodög fømê%05d.\r",
¢r
->
‰ame_˘r
);

2079 
	`fÊush
(
°dout
);

2081 if(
¶i˚_ty≥
 =
I_SLICE
 || sli˚_ty≥ =
SI_SLICE
 || sli˚_ty≥ =
P_SLICE
 || 
ªÂic
)

2083 #i‡(
MVC_EXTENSION_ENABLE
)

2084 if((
p_Vid
->
µSli˚Li°
[0])->
võw_id
!=0)

2086 ++(
p_Vid
->
numbî
);

2089 ++(
p_Vid
->
B‰ame_˘r
);

2090 ++(
¢r
->
‰ame_˘r
);

2092 #i‡(
MVC_EXTENSION_ENABLE
)

2093 i‡((
p_Vid
->
µSli˚Li°
[0])->
võw_id
 != 0)

2095 ++(
p_Vid
->
g_nFøme
);

2100 
	}
}

2109 
	$îcWrôeMBMODE™dMV
(
Ma¸oblock
 *
cuºMB
)

2111 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

2112 
i
, 
ii
, 
jj
, 
cuºMBNum
 = 
cuºMB
->
mbAddrX
;

2113 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
p_Vid
->dec_picture;

2114 
mbx
 = 
	`xPosMB
(
cuºMBNum
, 
dec_pi˘uª
->
size_x
), 
mby
 = 
	`yPosMB
(currMBNum, dec_picture->size_x);

2115 
obje˘Buf„r_t
 *
cuºRegi⁄
, *
pRegi⁄
;

2117 
cuºRegi⁄
 = 
p_Vid
->
îc_obje˘_li°
 + (
cuºMBNum
<<2);

2119 if(
p_Vid
->
ty≥
 !
B_SLICE
)

2121 
i
=0; i<4; ++i)

2123 
pRegi⁄
 = 
cuºRegi⁄
 + 
i
;

2124 
pRegi⁄
->
ªgi⁄Mode
 = (
cuºMB
->
mb_ty≥
 ==
I16MB
 ? 
REGMODE_INTRA
 :

2125 
cuºMB
->
b8mode
[
i
]==
IBLOCK
 ? 
REGMODE_INTRA_8x8
 :

2126 
cuºMB
->
b8mode
[
i
]==0 ? 
REGMODE_INTER_COPY
 :

2127 
cuºMB
->
b8mode
[
i
]==1 ? 
REGMODE_INTER_PRED
 : 
REGMODE_INTER_PRED_8x8
);

2128 i‡(
cuºMB
->
b8mode
[
i
]==0 || cuºMB->b8mode[i]==
IBLOCK
)

2130 
pRegi⁄
->
mv
[0] = 0;

2131 
pRegi⁄
->
mv
[1] = 0;

2132 
pRegi⁄
->
mv
[2] = 0;

2136 
ii
 = 4*
mbx
 + (
i
 & 0x01)*2;

2137 
jj
 = 4*
mby
 + (
i
 >> 1 )*2;

2138 i‡(
cuºMB
->
b8mode
[
i
]>=5 && currMB->b8mode[i]<=7)

2140 
pRegi⁄
->
mv
[0] = (
dec_pi˘uª
->
mv_öfo
[
jj
][
ii
].mv[
LIST_0
].
mv_x
 + dec_picture->mv_info[jj][ii + 1].mv[LIST_0].mv_x + dec_picture->mv_info[jj + 1][ii].mv[LIST_0].mv_x + dec_picture->mv_info[jj + 1][ii + 1].mv[LIST_0].mv_x + 2)/4;

2141 
pRegi⁄
->
mv
[1] = (
dec_pi˘uª
->
mv_öfo
[
jj
][
ii
].mv[
LIST_0
].
mv_y
 + dec_picture->mv_info[jj][ii + 1].mv[LIST_0].mv_y + dec_picture->mv_info[jj + 1][ii].mv[LIST_0].mv_y + dec_picture->mv_info[jj + 1][ii + 1].mv[LIST_0].mv_y + 2)/4;

2145 
pRegi⁄
->
mv
[0] = 
dec_pi˘uª
->
mv_öfo
[
jj
][
ii
].mv[
LIST_0
].
mv_x
;

2146 
pRegi⁄
->
mv
[1] = 
dec_pi˘uª
->
mv_öfo
[
jj
][
ii
].mv[
LIST_0
].
mv_y
;

2150 
cuºMB
->
p_Sli˚
->
îc_mv≥rMB
 +
	`übs
(
pRegi⁄
->
mv
[0]) + iabs(pRegion->mv[1]);

2151 
pRegi⁄
->
mv
[2] = 
dec_pi˘uª
->
mv_öfo
[
jj
][
ii
].
ªf_idx
[
LIST_0
];

2157 
i
=0; i<4; ++i)

2159 
ii
 = 4*
mbx
 + (
i
%2)*2;

2160 
jj
 = 4*
mby
 + (
i
/2)*2;

2161 
pRegi⁄
 = 
cuºRegi⁄
 + 
i
;

2162 
pRegi⁄
->
ªgi⁄Mode
 = (
cuºMB
->
mb_ty≥
 ==
I16MB
 ? 
REGMODE_INTRA
 :

2163 
cuºMB
->
b8mode
[
i
]==
IBLOCK
 ? 
REGMODE_INTRA_8x8
 : 
REGMODE_INTER_PRED_8x8
);

2164 i‡(
cuºMB
->
mb_ty≥
==
I16MB
 || cuºMB->
b8mode
[
i
]==
IBLOCK
)

2166 
pRegi⁄
->
mv
[0] = 0;

2167 
pRegi⁄
->
mv
[1] = 0;

2168 
pRegi⁄
->
mv
[2] = 0;

2172 
idx
 = (
dec_pi˘uª
->
mv_öfo
[
jj
][
ii
].
ªf_idx
[0] < 0) ? 1 : 0;

2175 
pRegi⁄
->
mv
[0] = (
dec_pi˘uª
->
mv_öfo
[
jj
][
ii
].mv[
idx
].
mv_x
 +

2176 
dec_pi˘uª
->
mv_öfo
[
jj
][
ii
+1].
mv
[
idx
].
mv_x
 +

2177 
dec_pi˘uª
->
mv_öfo
[
jj
+1][
ii
].
mv
[
idx
].
mv_x
 +

2178 
dec_pi˘uª
->
mv_öfo
[
jj
+1][
ii
+1].
mv
[
idx
].
mv_x
 + 2)/4;

2179 
pRegi⁄
->
mv
[1] = (
dec_pi˘uª
->
mv_öfo
[
jj
][
ii
].mv[
idx
].
mv_y
 +

2180 
dec_pi˘uª
->
mv_öfo
[
jj
][
ii
+1].
mv
[
idx
].
mv_y
 +

2181 
dec_pi˘uª
->
mv_öfo
[
jj
+1][
ii
].
mv
[
idx
].
mv_y
 +

2182 
dec_pi˘uª
->
mv_öfo
[
jj
+1][
ii
+1].
mv
[
idx
].
mv_y
 + 2)/4;

2183 
cuºMB
->
p_Sli˚
->
îc_mv≥rMB
 +
	`übs
(
pRegi⁄
->
mv
[0]) + iabs(pRegion->mv[1]);

2185 
pRegi⁄
->
mv
[2] = (
dec_pi˘uª
->
mv_öfo
[
jj
][
ii
].
ªf_idx
[
idx
]);

2201 
	}
}

2210 
	$öô_ﬁd_¶i˚
(
OldSli˚P¨ams
 *
p_ﬁd_¶i˚
)

2212 
p_ﬁd_¶i˚
->
fõld_pic_Êag
 = 0;

2213 
p_ﬁd_¶i˚
->
µs_id
 = 
INT_MAX
;

2214 
p_ﬁd_¶i˚
->
‰ame_num
 = 
INT_MAX
;

2215 
p_ﬁd_¶i˚
->
«l_ªf_idc
 = 
INT_MAX
;

2216 
p_ﬁd_¶i˚
->
idr_Êag
 = 
FALSE
;

2218 
p_ﬁd_¶i˚
->
pic_odî_˙t_lsb
 = 
UINT_MAX
;

2219 
p_ﬁd_¶i˚
->
dñè_pic_odî_˙t_bŸtom
 = 
INT_MAX
;

2221 
p_ﬁd_¶i˚
->
dñè_pic_‹dî_˙t
[0] = 
INT_MAX
;

2222 
p_ﬁd_¶i˚
->
dñè_pic_‹dî_˙t
[1] = 
INT_MAX
;

2223 
	}
}

2226 
	$c›y_¶i˚_öfo
(
Sli˚
 *
cuºSli˚
, 
OldSli˚P¨ams
 *
p_ﬁd_¶i˚
)

2228 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

2230 
p_ﬁd_¶i˚
->
µs_id
 = 
cuºSli˚
->
pic_∑ømëî_£t_id
;

2231 
p_ﬁd_¶i˚
->
‰ame_num
 = 
cuºSli˚
->frame_num;

2232 
p_ﬁd_¶i˚
->
fõld_pic_Êag
 = 
cuºSli˚
->field_pic_flag;

2234 if(
cuºSli˚
->
fõld_pic_Êag
)

2236 
p_ﬁd_¶i˚
->
bŸtom_fõld_Êag
 = 
cuºSli˚
->bottom_field_flag;

2239 
p_ﬁd_¶i˚
->
«l_ªf_idc
 = 
cuºSli˚
->
«l_ª„ªn˚_idc
;

2240 
p_ﬁd_¶i˚
->
idr_Êag
 = (
byã
Ë
cuºSli˚
->idr_flag;

2242 i‡(
cuºSli˚
->
idr_Êag
)

2244 
p_ﬁd_¶i˚
->
idr_pic_id
 = 
cuºSli˚
->idr_pic_id;

2247 i‡(
p_Vid
->
a˘ive_•s
->
pic_‹dî_˙t_ty≥
 == 0)

2249 
p_ﬁd_¶i˚
->
pic_odî_˙t_lsb
 = 
cuºSli˚
->
pic_‹dî_˙t_lsb
;

2250 
p_ﬁd_¶i˚
->
dñè_pic_odî_˙t_bŸtom
 = 
cuºSli˚
->
dñè_pic_‹dî_˙t_bŸtom
;

2253 i‡(
p_Vid
->
a˘ive_•s
->
pic_‹dî_˙t_ty≥
 == 1)

2255 
p_ﬁd_¶i˚
->
dñè_pic_‹dî_˙t
[0] = 
cuºSli˚
->delta_pic_order_cnt[0];

2256 
p_ﬁd_¶i˚
->
dñè_pic_‹dî_˙t
[1] = 
cuºSli˚
->delta_pic_order_cnt[1];

2258 #i‡(
MVC_EXTENSION_ENABLE
)

2259 
p_ﬁd_¶i˚
->
võw_id
 = 
cuºSli˚
->view_id;

2260 
p_ﬁd_¶i˚
->
öãr_võw_Êag
 = 
cuºSli˚
->inter_view_flag;

2261 
p_ﬁd_¶i˚
->
™ch‹_pic_Êag
 = 
cuºSli˚
->anchor_pic_flag;

2263 
p_ﬁd_¶i˚
->
œyî_id
 = 
cuºSli˚
->layer_id;

2264 
	}
}

2272 
	$is_√w_pi˘uª
(
St‹abÀPi˘uª
 *
dec_pi˘uª
, 
Sli˚
 *
cuºSli˚
, 
OldSli˚P¨ams
 *
p_ﬁd_¶i˚
)

2274 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

2276 
ªsu…
=0;

2278 
ªsu…
 |(
NULL
==
dec_pi˘uª
);

2280 
ªsu…
 |(
p_ﬁd_¶i˚
->
µs_id
 !
cuºSli˚
->
pic_∑ømëî_£t_id
);

2282 
ªsu…
 |(
p_ﬁd_¶i˚
->
‰ame_num
 !
cuºSli˚
->frame_num);

2284 
ªsu…
 |(
p_ﬁd_¶i˚
->
fõld_pic_Êag
 !
cuºSli˚
->field_pic_flag);

2286 if(
cuºSli˚
->
fõld_pic_Êag
 && 
p_ﬁd_¶i˚
->field_pic_flag)

2288 
ªsu…
 |(
p_ﬁd_¶i˚
->
bŸtom_fõld_Êag
 !
cuºSli˚
->bottom_field_flag);

2291 
ªsu…
 |(
p_ﬁd_¶i˚
->
«l_ªf_idc
 !
cuºSli˚
->
«l_ª„ªn˚_idc
) && ((p_old_slice->nal_ref_idc == 0) || (currSlice->nal_reference_idc == 0));

2292 
ªsu…
 |(
p_ﬁd_¶i˚
->
idr_Êag
 !
cuºSli˚
->idr_flag);

2294 i‡(
cuºSli˚
->
idr_Êag
 && 
p_ﬁd_¶i˚
->idr_flag)

2296 
ªsu…
 |(
p_ﬁd_¶i˚
->
idr_pic_id
 !
cuºSli˚
->idr_pic_id);

2299 i‡(
p_Vid
->
a˘ive_•s
->
pic_‹dî_˙t_ty≥
 == 0)

2301 
ªsu…
 |(
p_ﬁd_¶i˚
->
pic_odî_˙t_lsb
 !
cuºSli˚
->
pic_‹dî_˙t_lsb
);

2302 if–
p_Vid
->
a˘ive_µs
->
bŸtom_fõld_pic_‹dî_ö_‰ame_¥e£¡_Êag
 =1 && !
cuºSli˚
->
fõld_pic_Êag
 )

2304 
ªsu…
 |(
p_ﬁd_¶i˚
->
dñè_pic_odî_˙t_bŸtom
 !
cuºSli˚
->
dñè_pic_‹dî_˙t_bŸtom
);

2308 i‡(
p_Vid
->
a˘ive_•s
->
pic_‹dî_˙t_ty≥
 == 1)

2310 i‡(!
p_Vid
->
a˘ive_•s
->
dñè_pic_‹dî_Æways_zîo_Êag
)

2312 
ªsu…
 |(
p_ﬁd_¶i˚
->
dñè_pic_‹dî_˙t
[0] !
cuºSli˚
->delta_pic_order_cnt[0]);

2313 if–
p_Vid
->
a˘ive_µs
->
bŸtom_fõld_pic_‹dî_ö_‰ame_¥e£¡_Êag
 =1 && !
cuºSli˚
->
fõld_pic_Êag
 )

2315 
ªsu…
 |(
p_ﬁd_¶i˚
->
dñè_pic_‹dî_˙t
[1] !
cuºSli˚
->delta_pic_order_cnt[1]);

2320 #i‡(
MVC_EXTENSION_ENABLE
)

2321 
ªsu…
 |(
cuºSli˚
->
võw_id
 !
p_ﬁd_¶i˚
->view_id);

2322 
ªsu…
 |(
cuºSli˚
->
öãr_võw_Êag
 !
p_ﬁd_¶i˚
->inter_view_flag);

2323 
ªsu…
 |(
cuºSli˚
->
™ch‹_pic_Êag
 !
p_ﬁd_¶i˚
->anchor_pic_flag);

2325 
ªsu…
 |(
cuºSli˚
->
œyî_id
 !
p_ﬁd_¶i˚
->layer_id);

2326  
ªsu…
;

2327 
	}
}

2335 
	$‰ame_po°¥o˚ssög
(
VideoP¨amëîs
 *
p_Vid
)

2337 
	}
}

2345 
	$fõld_po°¥o˚ssög
(
VideoP¨amëîs
 *
p_Vid
)

2347 
p_Vid
->
numbî
 /= 2;

2348 
	}
}

2359 
	$c›y_dec_pi˘uª_JV
–
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
d°
, St‹abÀPi˘uª *
§c
 )

2361 
d°
->
t›_poc
 = 
§c
->top_poc;

2362 
d°
->
bŸtom_poc
 = 
§c
->bottom_poc;

2363 
d°
->
‰ame_poc
 = 
§c
->frame_poc;

2364 
d°
->
qp
 = 
§c
->qp;

2365 
d°
->
¶i˚_qp_dñè
 = 
§c
->slice_qp_delta;

2366 
d°
->
chroma_qp_off£t
[0] = 
§c
->chroma_qp_offset[0];

2367 
d°
->
chroma_qp_off£t
[1] = 
§c
->chroma_qp_offset[1];

2369 
d°
->
poc
 = 
§c
->poc;

2371 
d°
->
¶i˚_ty≥
 = 
§c
->slice_type;

2372 
d°
->
u£d_f‹_ª„ªn˚
 = 
§c
->used_for_reference;

2373 
d°
->
idr_Êag
 = 
§c
->idr_flag;

2374 
d°
->
no_ouçut_of_¥i‹_pics_Êag
 = 
§c
->no_output_of_prior_pics_flag;

2375 
d°
->
l⁄g_ãrm_ª„ªn˚_Êag
 = 
§c
->long_term_reference_flag;

2376 
d°
->
ad≠tive_ªf_pic_buf„rög_Êag
 = 
§c
->adaptive_ref_pic_buffering_flag;

2378 
d°
->
dec_ªf_pic_m¨kög_buf„r
 = 
§c
->dec_ref_pic_marking_buffer;

2380 
d°
->
mb_aff_‰ame_Êag
 = 
§c
->mb_aff_frame_flag;

2381 
d°
->
PicWidthInMbs
 = 
§c
->PicWidthInMbs;

2382 
d°
->
pic_num
 = 
§c
->pic_num;

2383 
d°
->
‰ame_num
 = 
§c
->frame_num;

2384 
d°
->
ªcovîy_‰ame
 = 
§c
->recovery_frame;

2385 
d°
->
coded_‰ame
 = 
§c
->coded_frame;

2387 
d°
->
chroma_f‹m©_idc
 = 
§c
->chroma_format_idc;

2389 
d°
->
‰ame_mbs_⁄ly_Êag
 = 
§c
->frame_mbs_only_flag;

2390 
d°
->
‰ame_¸›pög_Êag
 = 
§c
->frame_cropping_flag;

2392 
d°
->
‰ame_¸›_À·_off£t
 = 
§c
->frame_crop_left_offset;

2393 
d°
->
‰ame_¸›_right_off£t
 = 
§c
->frame_crop_right_offset;

2394 
d°
->
‰ame_¸›_t›_off£t
 = 
§c
->frame_crop_top_offset;

2395 
d°
->
‰ame_¸›_bŸtom_off£t
 = 
§c
->frame_crop_bottom_offset;

2397 #i‡(
ENABLE_OUTPUT_TONEMAPPING
)

2399 
d°
->
£iHasT⁄e_m≠pög
 = 
§c
->seiHasTone_mapping;

2401 
d°
->
£iHasT⁄e_m≠pög
 = 
§c
->seiHasTone_mapping;

2402 
d°
->
t⁄e_m≠pög_modñ_id
 = 
§c
->tone_mapping_model_id;

2403 
d°
->
t⁄em≠≥d_bô_dïth
 = 
§c
->tonemapped_bit_depth;

2404 if–
§c
->
t⁄e_m≠pög_lut
 )

2406 
coded_d©a_bô_max
 = (1 << 
p_Vid
->
£iT⁄eM≠pög
->
coded_d©a_bô_dïth
);

2407 
d°
->
t⁄e_m≠pög_lut
 = 
	`mÆloc
((Ë* 
coded_d©a_bô_max
);

2408 i‡(
NULL
 =
d°
->
t⁄e_m≠pög_lut
)

2410 
	`no_mem_exô
("copy_dec_picture_JV:Åone_mapping_lut");

2412 
	`mem˝y
(
d°
->
t⁄e_m≠pög_lut
, 
§c
->t⁄e_m≠pög_lut, (
img≥l
Ë* 
coded_d©a_bô_max
);

2415 
	}
}

2420 
	$öô_cur_imgy
(
Sli˚
 *
cuºSli˚
, 
VideoP¨amëîs
 *
p_Vid
)

2422 
i
,
j
;

2423 i‡((
p_Vid
->
£∑øã_cﬁour_∂™e_Êag
 != 0))

2425 
St‹abÀPi˘uª
 *
vidªf
 = 
p_Vid
->
no_ª„ªn˚_pi˘uª
;

2426 
n‹ef
 = (
cuºSli˚
->
‰amïoc
 < 
p_Vid
->
ªcovîy_poc
);

2427 
cuºSli˚
->
cﬁour_∂™e_id
)

2430 
j
 = 0; j < 6; j++)

2432 
i
 = 0; i < 
MAX_LIST_SIZE
; i++)

2434 
St‹abÀPi˘uª
 *
cuº_ªf
 = 
cuºSli˚
->
li°X
[
j
][
i
];

2435 i‡(
cuº_ªf
)

2437 
cuº_ªf
->
no_ªf
 = 
n‹ef
 && (cuº_ª‡=
vidªf
);

2438 
cuº_ªf
->
cur_imgY
 = cuº_ªf->
imgY
;

2447 
St‹abÀPi˘uª
 *
vidªf
 = 
p_Vid
->
no_ª„ªn˚_pi˘uª
;

2448 
n‹ef
 = (
cuºSli˚
->
‰amïoc
 < 
p_Vid
->
ªcovîy_poc
);

2449 
tŸÆ_li°s
 = 
cuºSli˚
->
mb_aff_‰ame_Êag
 ? 6 : (cuºSli˚->
¶i˚_ty≥
==
B_SLICE
 ? 2 : 1);

2451 
j
 = 0; j < 
tŸÆ_li°s
; j++)

2457 
i
 = 0; i < 
MAX_LIST_SIZE
; i++)

2459 
St‹abÀPi˘uª
 *
cuº_ªf
 = 
cuºSli˚
->
li°X
[
j
][
i
];

2460 i‡(
cuº_ªf
)

2462 
cuº_ªf
->
no_ªf
 = 
n‹ef
 && (cuº_ª‡=
vidªf
);

2463 
cuº_ªf
->
cur_imgY
 = cuº_ªf->
imgY
;

2468 
	}
}

2478 
	$decode_⁄e_¶i˚
(
Sli˚
 *
cuºSli˚
)

2480 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

2481 
Boﬁón
 
íd_of_¶i˚
 = 
FALSE
;

2482 
Ma¸oblock
 *
cuºMB
 = 
NULL
;

2483 
cuºSli˚
->
cod_cou¡î
=-1;

2485 if–(
p_Vid
->
£∑øã_cﬁour_∂™e_Êag
 != 0) )

2487 
	`ch™ge_∂™e_JV
–
p_Vid
, 
cuºSli˚
->
cﬁour_∂™e_id
, currSlice );

2491 
cuºSli˚
->
mb_d©a
 = 
p_Vid
->mb_data;

2492 
cuºSli˚
->
dec_pi˘uª
 = 
p_Vid
->dec_picture;

2493 
cuºSli˚
->
siblock
 = 
p_Vid
->siblock;

2494 
cuºSli˚
->
ùªdmode
 = 
p_Vid
->ipredmode;

2495 
cuºSli˚
->
öåa_block
 = 
p_Vid
->intra_block;

2498 i‡(
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
)

2500 
	`compuã_cﬁoˇãd
(
cuºSli˚
, cuºSli˚->
li°X
);

2503 i‡(
cuºSli˚
->
¶i˚_ty≥
 !
I_SLICE
 && cuºSli˚->¶i˚_ty≥ !
SI_SLICE
)

2504 
	`öô_cur_imgy
(
cuºSli˚
,
p_Vid
);

2508 
íd_of_¶i˚
 =
FALSE
)

2511 #i‡
TRACE


2512 
	`Ârötf
(
p_Dec
->
p_åa˚
,"\n*********** POC: %ò(I/PËMB: %òSli˚: %òTy≥ %d **********\n", 
cuºSli˚
->
ThisPOC
, cuºSli˚->
cuºít_mb_ƒ
, cuºSli˚->
cuºít_¶i˚_ƒ
, cuºSli˚->
¶i˚_ty≥
);

2516 
	`°¨t_ma¸oblock
(
cuºSli˚
, &
cuºMB
);

2518 
cuºSli˚
->
	`ªad_⁄e_ma¸oblock
(
cuºMB
);

2519 
	`decode_⁄e_ma¸oblock
(
cuºMB
, 
cuºSli˚
->
dec_pi˘uª
);

2521 if(
cuºSli˚
->
mb_aff_‰ame_Êag
 && 
cuºMB
->
mb_fõld
)

2523 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
] >>= 1;

2524 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_1
] >>= 1;

2527 #i‡(
DISABLE_ERC
 == 0)

2528 
	`îcWrôeMBMODE™dMV
(
cuºMB
);

2531 
íd_of_¶i˚
 = 
	`exô_ma¸oblock
(
cuºSli˚
, (!cuºSli˚->
mb_aff_‰ame_Êag
|| cuºSli˚->
cuºít_mb_ƒ
%2));

2534 
	}
}

2536 #i‡(
MVC_EXTENSION_ENABLE
)

2537 
	$GëVOIdx
(
VideoP¨amëîs
 *
p_Vid
, 
iVõwId
)

2539 
iVOIdx
 = -1;

2540 *
piVõwIdM≠
;

2541 if(
p_Vid
->
a˘ive_sub£t_•s
)

2543 
piVõwIdM≠
 = 
p_Vid
->
a˘ive_sub£t_•s
->
võw_id
;

2544 
iVOIdx
 = 
p_Vid
->
a˘ive_sub£t_•s
->
num_võws_möus1
; iVOIdx>=0; iVOIdx--)

2545 if(
piVõwIdM≠
[
iVOIdx
] =
iVõwId
)

2550 
sub£t_£q_∑ømëî_£t_rb•_t
 *
cuº_sub£t_•s
;

2551 
i
;

2553 
cuº_sub£t_•s
 = 
p_Vid
->
Sub£tSeqP¨Së
;

2554 
i
=0; i<
MAXSPS
; i++)

2556 if(
cuº_sub£t_•s
->
num_võws_möus1
>=0 && cuº_sub£t_•s->
•s
.
VÆid
)

2560 
cuº_sub£t_•s
++;

2563 if–
i
 < 
MAXSPS
 )

2565 
p_Vid
->
a˘ive_sub£t_•s
 = 
cuº_sub£t_•s
;

2567 
piVõwIdM≠
 = 
p_Vid
->
a˘ive_sub£t_•s
->
võw_id
;

2568 
iVOIdx
 = 
p_Vid
->
a˘ive_sub£t_•s
->
num_võws_möus1
; iVOIdx>=0; iVOIdx--)

2569 if(
piVõwIdM≠
[
iVOIdx
] =
iVõwId
)

2572  
iVOIdx
;

2576 
iVOIdx
 = 0;

2580  
iVOIdx
;

2581 
	}
}

2583 
	$GëVõwIdx
(
VideoP¨amëîs
 *
p_Vid
, 
iVOIdx
)

2585 
iVõwIdx
 = -1;

2586 *
piVõwIdM≠
;

2588 if–
p_Vid
->
a˘ive_sub£t_•s
 )

2590 
	`as£π
–
p_Vid
->
a˘ive_sub£t_•s
->
num_võws_möus1
 >
iVOIdx
 && iVOIdx >= 0 );

2591 
piVõwIdM≠
 = 
p_Vid
->
a˘ive_sub£t_•s
->
võw_id
;

2592 
iVõwIdx
 = 
piVõwIdM≠
[
iVOIdx
];

2595  
iVõwIdx
;

2596 
	}
}

2597 
	$gë_maxVõwIdx
 (
VideoP¨amëîs
 *
p_Vid
, 
võw_id
, 
™ch‹_pic_Êag
, 
li°idx
)

2599 
VOIdx
;

2600 
maxVõwIdx
 = 0;

2602 
VOIdx
 = 
võw_id
;

2603 if(
VOIdx
 >= 0)

2605 if(
™ch‹_pic_Êag
)

2606 
maxVõwIdx
 = 
li°idx
? 
p_Vid
->
a˘ive_sub£t_•s
->
num_™ch‹_ªfs_l1
[
VOIdx
] :Ö_Vid->a˘ive_sub£t_•s->
num_™ch‹_ªfs_l0
[VOIdx];

2608 
maxVõwIdx
 = 
li°idx
? 
p_Vid
->
a˘ive_sub£t_•s
->
num_n⁄_™ch‹_ªfs_l1
[
VOIdx
] :Ö_Vid->a˘ive_sub£t_•s->
num_n⁄_™ch‹_ªfs_l0
[VOIdx];

2611  
maxVõwIdx
;

2612 
	}
}

	@ldecod/src/intra16x16_pred.c

15 
	~"globÆ.h
"

16 
	~"öåa16x16_¥ed.h
"

17 
	~"mb_ac˚ss.h
"

18 
	~"image.h
"

30 
	$öåa16x16_dc_¥ed
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
)

32 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

33 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

35 
s0
 = 0, 
s1
 = 0, 
s2
 = 0;

37 
i
,
j
;

39 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

40 
img≥l
 **
mb_¥ed
 = &(
cuºSli˚
->mb_¥ed[
∂
][0]);

42 
PixñPos
 
a
, 
b
;

44 
up_avaû
, 
À·_avaû
;

46 
	`gëN⁄AffNeighbour
(
cuºMB
, -1, 0, 
p_Vid
->
mb_size
[
IS_LUMA
], &
a
);

47 
	`gëN⁄AffNeighbour
(
cuºMB
, 0, -1, 
p_Vid
->
mb_size
[
IS_LUMA
], &
b
);

49 i‡(!
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

51 
up_avaû
 = 
b
.
avaûabÀ
;

52 
À·_avaû
 = 
a
.
avaûabÀ
;

56 
up_avaû
 = 
b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[b.
mb_addr
] : 0;

57 
À·_avaû
 = 
a
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[a.
mb_addr
]: 0;

61 i‡(
up_avaû
)

63 
img≥l
 *
≥l
 = &
imgY
[
b
.
pos_y
][b.
pos_x
];

64 
i
 = 0; i < 
MB_BLOCK_SIZE
; ++i)

66 
s1
 +*
≥l
++;

71 i‡(
À·_avaû
)

73 
pos_y
 = 
a
.pos_y;

74 
pos_x
 = 
a
.pos_x;

75 
i
 = 0; i < 
MB_BLOCK_SIZE
; ++i)

77 
s2
 +
imgY
[
pos_y
++][
pos_x
];

81 i‡(
up_avaû
 && 
À·_avaû
)

82 
s0
 = (
s1
 + 
s2
 + 16)>>5;

83 i‡(!
up_avaû
 && 
À·_avaû
)

84 
s0
 = (
s2
 + 8)>>4;

85 i‡(
up_avaû
 && !
À·_avaû
)

86 
s0
 = (
s1
 + 8)>>4;

88 
s0
 = 
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

90 
j
 = 0; j < 
MB_BLOCK_SIZE
; ++j)

92 #i‡(
IMGTYPE
 == 0)

93 
	`mem£t
(
mb_¥ed
[
j
], 
s0
, 
MB_BLOCK_SIZE
 * (
img≥l
));

95 
i
 = 0; i < 
MB_BLOCK_SIZE
; i += 4)

97 
mb_¥ed
[
j
][
i
 ]=(
img≥l
Ë
s0
;

98 
mb_¥ed
[
j
][
i
 + 1]=(
img≥l
Ë
s0
;

99 
mb_¥ed
[
j
][
i
 + 2]=(
img≥l
Ë
s0
;

100 
mb_¥ed
[
j
][
i
 + 3]=(
img≥l
Ë
s0
;

105  
DECODING_OK
;

107 
	}
}

120 
	$öåa16x16_vît_¥ed
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
)

122 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

123 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

125 
j
;

127 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

129 
PixñPos
 
b
;

131 
up_avaû
;

133 
	`gëN⁄AffNeighbour
(
cuºMB
, 0, -1, 
p_Vid
->
mb_size
[
IS_LUMA
], &
b
);

135 i‡(!
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

137 
up_avaû
 = 
b
.
avaûabÀ
;

141 
up_avaû
 = 
b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[b.
mb_addr
] : 0;

144 i‡(!
up_avaû
)

145 
	`îr‹
 ("invalid 16x16 intraÖred Mode VERT_PRED_16",500);

147 
img≥l
 **
¥d
 = &
cuºSli˚
->
mb_¥ed
[
∂
][0];

148 
img≥l
 *
§c
 = &(
imgY
[
b
.
pos_y
][b.
pos_x
]);

150 
j
=0;j<
MB_BLOCK_SIZE
; j+= 4)

152 
	`mem˝y
(*
¥d
++, 
§c
, 
MB_BLOCK_SIZE
 * (
img≥l
));

153 
	`mem˝y
(*
¥d
++, 
§c
, 
MB_BLOCK_SIZE
 * (
img≥l
));

154 
	`mem˝y
(*
¥d
++, 
§c
, 
MB_BLOCK_SIZE
 * (
img≥l
));

155 
	`mem˝y
(*
¥d
++, 
§c
, 
MB_BLOCK_SIZE
 * (
img≥l
));

159  
DECODING_OK
;

160 
	}
}

173 
	$öåa16x16_h‹_¥ed
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
)

175 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

176 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

177 
j
;

179 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

180 
img≥l
 **
mb_¥ed
 = &(
cuºSli˚
->mb_¥ed[
∂
][0]);

181 
img≥l
 
¥edi˘i⁄
;

182 
pos_y
, 
pos_x
;

184 
PixñPos
 
a
;

186 
À·_avaû
;

188 
	`gëN⁄AffNeighbour
(
cuºMB
, -1, 0, 
p_Vid
->
mb_size
[
IS_LUMA
], &
a
);

190 i‡(!
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

192 
À·_avaû
 = 
a
.
avaûabÀ
;

196 
À·_avaû
 = 
a
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[a.
mb_addr
]: 0;

199 i‡(!
À·_avaû
)

200 
	`îr‹
 ("invalid 16x16 intraÖred Mode HOR_PRED_16",500);

202 
pos_y
 = 
a
.pos_y;

203 
pos_x
 = 
a
.pos_x;

205 
j
 = 0; j < 
MB_BLOCK_SIZE
; ++j)

207 #i‡(
IMGTYPE
 == 0)

208 
img≥l
 *
¥d
 = 
mb_¥ed
[
j
];

209 
¥edi˘i⁄
 = 
imgY
[
pos_y
++][
pos_x
];

211 
	`mem£t
(
¥d
, 
¥edi˘i⁄
, 
MB_BLOCK_SIZE
 * (
img≥l
));

213 
i
;

214 
img≥l
 *
¥d
 = 
mb_¥ed
[
j
];

215 
¥edi˘i⁄
 = 
imgY
[
pos_y
++][
pos_x
];

217 
i
 = 0; i < 
MB_BLOCK_SIZE
; i += 4)

219 *
¥d
++
¥edi˘i⁄
;

220 *
¥d
++
¥edi˘i⁄
;

221 *
¥d
++
¥edi˘i⁄
;

222 *
¥d
++
¥edi˘i⁄
;

227  
DECODING_OK
;

228 
	}
}

241 
	$öåa16x16_∂™e_¥ed
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
)

243 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

244 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

246 
i
,
j
;

248 
ih
 = 0, 
iv
 = 0;

249 
ib
,
ic
,
üa
;

251 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

252 
img≥l
 **
mb_¥ed
 = &(
cuºSli˚
->mb_¥ed[
∂
][0]);

253 
img≥l
 *
m¥_löe
;

254 
max_img≥l_vÆue
 = 
p_Vid
->
max_≥l_vÆue_comp
[
∂
];

255 
pos_y
, 
pos_x
;

257 
PixñPos
 
a
, 
b
, 
d
;

259 
up_avaû
, 
À·_avaû
, 
À·_up_avaû
;

261 
	`gëN⁄AffNeighbour
(
cuºMB
, -1, -1, 
p_Vid
->
mb_size
[
IS_LUMA
], &
d
);

262 
	`gëN⁄AffNeighbour
(
cuºMB
, -1, 0, 
p_Vid
->
mb_size
[
IS_LUMA
], &
a
);

263 
	`gëN⁄AffNeighbour
(
cuºMB
, 0, -1, 
p_Vid
->
mb_size
[
IS_LUMA
], &
b
);

265 i‡(!
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

267 
up_avaû
 = 
b
.
avaûabÀ
;

268 
À·_avaû
 = 
a
.
avaûabÀ
;

269 
À·_up_avaû
 = 
d
.
avaûabÀ
;

273 
up_avaû
 = 
b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[b.
mb_addr
] : 0;

274 
À·_avaû
 = 
a
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[a.
mb_addr
] : 0;

275 
À·_up_avaû
 = 
d
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[d.
mb_addr
] : 0;

278 i‡(!
up_avaû
 || !
À·_up_avaû
 || !
À·_avaû
)

279 
	`îr‹
 ("invalid 16x16 intraÖred Mode PLANE_16",500);

281 
m¥_löe
 = &
imgY
[
b
.
pos_y
][b.
pos_x
+7];

282 
pos_y
 = 
a
.pos_y + 7;

283 
pos_x
 = 
a
.pos_x;

284 
i
 = 1; i < 8; ++i)

286 
ih
 +
i
*(
m¥_löe
[i] - mpr_line[-i]);

287 
iv
 +
i
*(
imgY
[
pos_y
 + i][
pos_x
] - imgY[pos_y - i][pos_x]);

290 
ih
 +8*(
m¥_löe
[8] - 
imgY
[
d
.
pos_y
][d.
pos_x
]);

291 
iv
 +8*(
imgY
[
pos_y
 + 8][
pos_x
] - imgY[
d
.pos_y][d.pos_x]);

293 
ib
=(5 * 
ih
 + 32)>>6;

294 
ic
=(5 * 
iv
 + 32)>>6;

296 
üa
=16 * (
m¥_löe
[8] + 
imgY
[
pos_y
 + 8][
pos_x
]);

297 
j
 = 0;j < 
MB_BLOCK_SIZE
; ++j)

299 
ibb
 = 
üa
 + (
j
 - 7Ë* 
ic
 + 16;

300 
img≥l
 *
¥d
 = 
mb_¥ed
[
j
];

301 
i
 = 0;ò< 
MB_BLOCK_SIZE
; i += 4)

303 *
¥d
++ = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((
ibb
 + (
i
 - 7Ë* 
ib
) >> 5));

304 *
¥d
++ = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((
ibb
 + (
i
 - 6Ë* 
ib
) >> 5));

305 *
¥d
++ = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((
ibb
 + (
i
 - 5Ë* 
ib
) >> 5));

306 *
¥d
++ = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((
ibb
 + (
i
 - 4Ë* 
ib
) >> 5));

310  
DECODING_OK
;

311 
	}
}

323 
	$öåa_¥ed_16x16_n‹mÆ
(
Ma¸oblock
 *
cuºMB
,

324 
Cﬁ‹Pœ√
 
∂
,

325 
¥edmode
)

327 
¥edmode
)

329 
VERT_PRED_16
:

330  (
	`öåa16x16_vît_¥ed
(
cuºMB
, 
∂
));

332 
HOR_PRED_16
:

333  (
	`öåa16x16_h‹_¥ed
(
cuºMB
, 
∂
));

335 
DC_PRED_16
:

336  (
	`öåa16x16_dc_¥ed
(
cuºMB
, 
∂
));

338 
PLANE_16
:

339  (
	`öåa16x16_∂™e_¥ed
(
cuºMB
, 
∂
));

343 
	`¥ötf
("ûÀgÆ 16x16 i¡øÖªdi˘i⁄ modêöput: %d\n",
¥edmode
);

344  
SEARCH_SYNC
;

347 
	}
}

	@ldecod/src/intra16x16_pred_mbaff.c

17 
	~"globÆ.h
"

18 
	~"öåa16x16_¥ed.h
"

19 
	~"mb_ac˚ss.h
"

20 
	~"image.h
"

32 
	$öåa16x16_dc_¥ed_mbaff
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
)

34 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

35 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

37 
s0
 = 0, 
s1
 = 0, 
s2
 = 0;

39 
i
,
j
;

41 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

42 
img≥l
 **
mb_¥ed
 = &(
cuºSli˚
->mb_¥ed[
∂
][0]);

44 
PixñPos
 
b
;

45 
PixñPos
 
À·
[17];

47 
up_avaû
, 
À·_avaû
;

49 
s1
=
s2
=0;

51 
i
=0;i<17;++i)

53 
	`gëAffNeighbour
(
cuºMB
, -1, 
i
-1, 
p_Vid
->
mb_size
[
IS_LUMA
], &
À·
[i]);

55 
	`gëAffNeighbour
(
cuºMB
, 0, -1, 
p_Vid
->
mb_size
[
IS_LUMA
], &
b
);

57 i‡(!
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

59 
up_avaû
 = 
b
.
avaûabÀ
;

60 
À·_avaû
 = 
À·
[1].
avaûabÀ
;

64 
up_avaû
 = 
b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[b.
mb_addr
] : 0;

65 
i
 = 1, 
À·_avaû
 = 1; i < 17; ++i)

66 
À·_avaû
 &
À·
[
i
].
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[À·[i].
mb_addr
]: 0;

69 
i
 = 0; i < 
MB_BLOCK_SIZE
; ++i)

71 i‡(
up_avaû
)

72 
s1
 +
imgY
[
b
.
pos_y
][b.
pos_x
+
i
];

73 i‡(
À·_avaû
)

74 
s2
 +
imgY
[
À·
[
i
 + 1].
pos_y
][À·[ò+ 1].
pos_x
];

76 i‡(
up_avaû
 && 
À·_avaû
)

77 
s0
 = (
s1
 + 
s2
 + 16)>>5;

78 i‡(!
up_avaû
 && 
À·_avaû
)

79 
s0
 = (
s2
 + 8)>>4;

80 i‡(
up_avaû
 && !
À·_avaû
)

81 
s0
 = (
s1
 + 8)>>4;

83 
s0
 = 
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

85 
j
 = 0; j < 
MB_BLOCK_SIZE
; ++j)

87 #i‡(
IMGTYPE
 == 0)

88 
	`mem£t
(
mb_¥ed
[
j
], 
s0
, 
MB_BLOCK_SIZE
 * (
img≥l
));

90 
i
 = 0; i < 
MB_BLOCK_SIZE
; ++i)

92 
mb_¥ed
[
j
][
i
]=(
img≥l
Ë
s0
;

97  
DECODING_OK
;

98 
	}
}

112 
	$öåa16x16_vît_¥ed_mbaff
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
)

114 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

115 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

117 
j
;

119 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

121 
PixñPos
 
b
;

123 
up_avaû
;

125 
	`gëAffNeighbour
(
cuºMB
, 0, -1, 
p_Vid
->
mb_size
[
IS_LUMA
], &
b
);

127 i‡(!
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

129 
up_avaû
 = 
b
.
avaûabÀ
;

133 
up_avaû
 = 
b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[b.
mb_addr
] : 0;

136 i‡(!
up_avaû
)

137 
	`îr‹
 ("invalid 16x16 intraÖred Mode VERT_PRED_16",500);

139 
img≥l
 **
¥d
 = &
cuºSli˚
->
mb_¥ed
[
∂
][0];

140 
img≥l
 *
§c
 = &(
imgY
[
b
.
pos_y
][b.
pos_x
]);

142 
j
=0;j<
MB_BLOCK_SIZE
; j+= 4)

144 
	`mem˝y
(*
¥d
++, 
§c
, 
MB_BLOCK_SIZE
 * (
img≥l
));

145 
	`mem˝y
(*
¥d
++, 
§c
, 
MB_BLOCK_SIZE
 * (
img≥l
));

146 
	`mem˝y
(*
¥d
++, 
§c
, 
MB_BLOCK_SIZE
 * (
img≥l
));

147 
	`mem˝y
(*
¥d
++, 
§c
, 
MB_BLOCK_SIZE
 * (
img≥l
));

151  
DECODING_OK
;

152 
	}
}

165 
	$öåa16x16_h‹_¥ed_mbaff
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
)

167 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

168 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

169 
i
,
j
;

171 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

172 
img≥l
 **
mb_¥ed
 = &(
cuºSli˚
->mb_¥ed[
∂
][0]);

173 
img≥l
 
¥edi˘i⁄
;

175 
PixñPos
 
À·
[17];

177 
À·_avaû
;

179 
i
=0;i<17;++i)

181 
	`gëAffNeighbour
(
cuºMB
, -1, 
i
-1, 
p_Vid
->
mb_size
[
IS_LUMA
], &
À·
[i]);

184 i‡(!
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

186 
À·_avaû
 = 
À·
[1].
avaûabÀ
;

190 
i
 = 1, 
À·_avaû
 = 1; i < 17; ++i)

191 
À·_avaû
 &
À·
[
i
].
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[À·[i].
mb_addr
]: 0;

194 i‡(!
À·_avaû
)

195 
	`îr‹
 ("invalid 16x16 intraÖred Mode HOR_PRED_16",500);

197 
j
 = 0; j < 
MB_BLOCK_SIZE
; ++j)

199 
¥edi˘i⁄
 = 
imgY
[
À·
[
j
+1].
pos_y
][À·[j+1].
pos_x
];

200 
i
 = 0; i < 
MB_BLOCK_SIZE
; ++i)

201 
mb_¥ed
[
j
][
i
]
¥edi˘i⁄
;

204  
DECODING_OK
;

205 
	}
}

217 
	$öåa16x16_∂™e_¥ed_mbaff
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
)

219 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

220 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

222 
i
,
j
;

224 
ih
 = 0, 
iv
 = 0;

225 
ib
,
ic
,
üa
;

227 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

228 
img≥l
 **
mb_¥ed
 = &(
cuºSli˚
->mb_¥ed[
∂
][0]);

229 
img≥l
 *
m¥_löe
;

230 
max_img≥l_vÆue
 = 
p_Vid
->
max_≥l_vÆue_comp
[
∂
];

232 
PixñPos
 
b
;

233 
PixñPos
 
À·
[17];

235 
up_avaû
, 
À·_avaû
, 
À·_up_avaû
;

237 
i
=0;i<17; ++i)

239 
	`gëAffNeighbour
(
cuºMB
, -1, 
i
-1, 
p_Vid
->
mb_size
[
IS_LUMA
], &
À·
[i]);

241 
	`gëAffNeighbour
(
cuºMB
, 0, -1, 
p_Vid
->
mb_size
[
IS_LUMA
], &
b
);

243 i‡(!
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

245 
up_avaû
 = 
b
.
avaûabÀ
;

246 
À·_avaû
 = 
À·
[1].
avaûabÀ
;

247 
À·_up_avaû
 = 
À·
[0].
avaûabÀ
;

251 
up_avaû
 = 
b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[b.
mb_addr
] : 0;

252 
i
 = 1, 
À·_avaû
 = 1; i < 17; ++i)

253 
À·_avaû
 &
À·
[
i
].
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[À·[i].
mb_addr
]: 0;

254 
À·_up_avaû
 = 
À·
[0].
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[À·[0].
mb_addr
]: 0;

257 i‡(!
up_avaû
 || !
À·_up_avaû
 || !
À·_avaû
)

258 
	`îr‹
 ("invalid 16x16 intraÖred Mode PLANE_16",500);

260 
m¥_löe
 = &
imgY
[
b
.
pos_y
][b.
pos_x
+7];

261 
i
 = 1; i < 8; ++i)

263 
ih
 +
i
*(
m¥_löe
[i] - mpr_line[-i]);

264 
iv
 +
i
*(
imgY
[
À·
[8+i].
pos_y
][À·[8+i].
pos_x
] - imgY[left[8-i].pos_y][left[8-i].pos_x]);

267 
ih
 +8*(
m¥_löe
[8] - 
imgY
[
À·
[0].
pos_y
][À·[0].
pos_x
]);

268 
iv
 +8*(
imgY
[
À·
[16].
pos_y
][À·[16].
pos_x
] - imgY[left[0].pos_y][left[0].pos_x]);

270 
ib
=(5 * 
ih
 + 32)>>6;

271 
ic
=(5 * 
iv
 + 32)>>6;

273 
üa
=16 * (
m¥_löe
[8] + 
imgY
[
À·
[16].
pos_y
][À·[16].
pos_x
]);

274 
j
 = 0;j < 
MB_BLOCK_SIZE
; ++j)

276 
i
 = 0;ò< 
MB_BLOCK_SIZE
; ++i)

278 
mb_¥ed
[
j
][
i
] = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((
üa
 + (ò- 7Ë* 
ib
 + (j - 7Ë* 
ic
 + 16) >> 5));

282  
DECODING_OK
;

283 
	}
}

295 
	$öåa_¥ed_16x16_mbaff
(
Ma¸oblock
 *
cuºMB
,

296 
Cﬁ‹Pœ√
 
∂
,

297 
¥edmode
)

299 
¥edmode
)

301 
VERT_PRED_16
:

302  (
	`öåa16x16_vît_¥ed_mbaff
(
cuºMB
, 
∂
));

304 
HOR_PRED_16
:

305  (
	`öåa16x16_h‹_¥ed_mbaff
(
cuºMB
, 
∂
));

307 
DC_PRED_16
:

308  (
	`öåa16x16_dc_¥ed_mbaff
(
cuºMB
, 
∂
));

310 
PLANE_16
:

311  (
	`öåa16x16_∂™e_¥ed_mbaff
(
cuºMB
, 
∂
));

315 
	`¥ötf
("ûÀgÆ 16x16 i¡øÖªdi˘i⁄ modêöput: %d\n",
¥edmode
);

316  
SEARCH_SYNC
;

319 
	}
}

	@ldecod/src/intra16x16_pred_normal.c

17 
	~"globÆ.h
"

18 
	~"öåa16x16_¥ed.h
"

19 
	~"mb_ac˚ss.h
"

20 
	~"image.h
"

32 
	$öåa16x16_dc_¥ed
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
)

34 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

35 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

37 
s0
 = 0, 
s1
 = 0, 
s2
 = 0;

39 
i
,
j
;

41 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

42 
img≥l
 **
mb_¥ed
 = &(
cuºSli˚
->mb_¥ed[
∂
][0]);

44 
PixñPos
 
a
, 
b
;

46 
up_avaû
, 
À·_avaû
;

48 
	`gëN⁄AffNeighbour
(
cuºMB
, -1, 0, 
p_Vid
->
mb_size
[
IS_LUMA
], &
a
);

49 
	`gëN⁄AffNeighbour
(
cuºMB
, 0, -1, 
p_Vid
->
mb_size
[
IS_LUMA
], &
b
);

51 i‡(!
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

53 
up_avaû
 = 
b
.
avaûabÀ
;

54 
À·_avaû
 = 
a
.
avaûabÀ
;

58 
up_avaû
 = 
b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[b.
mb_addr
] : 0;

59 
À·_avaû
 = 
a
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[a.
mb_addr
]: 0;

63 i‡(
up_avaû
)

65 
img≥l
 *
≥l
 = &
imgY
[
b
.
pos_y
][b.
pos_x
];

66 
i
 = 0; i < 
MB_BLOCK_SIZE
; ++i)

68 
s1
 +*
≥l
++;

73 i‡(
À·_avaû
)

75 
pos_y
 = 
a
.pos_y;

76 
pos_x
 = 
a
.pos_x;

77 
i
 = 0; i < 
MB_BLOCK_SIZE
; ++i)

79 
s2
 +
imgY
[
pos_y
++][
pos_x
];

83 i‡(
up_avaû
 && 
À·_avaû
)

84 
s0
 = (
s1
 + 
s2
 + 16)>>5;

85 i‡(!
up_avaû
 && 
À·_avaû
)

86 
s0
 = (
s2
 + 8)>>4;

87 i‡(
up_avaû
 && !
À·_avaû
)

88 
s0
 = (
s1
 + 8)>>4;

90 
s0
 = 
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

92 
j
 = 0; j < 
MB_BLOCK_SIZE
; ++j)

94 #i‡(
IMGTYPE
 == 0)

95 
	`mem£t
(
mb_¥ed
[
j
], 
s0
, 
MB_BLOCK_SIZE
 * (
img≥l
));

97 
i
 = 0; i < 
MB_BLOCK_SIZE
; i += 4)

99 
mb_¥ed
[
j
][
i
 ]=(
img≥l
Ë
s0
;

100 
mb_¥ed
[
j
][
i
 + 1]=(
img≥l
Ë
s0
;

101 
mb_¥ed
[
j
][
i
 + 2]=(
img≥l
Ë
s0
;

102 
mb_¥ed
[
j
][
i
 + 3]=(
img≥l
Ë
s0
;

107  
DECODING_OK
;

109 
	}
}

122 
	$öåa16x16_vît_¥ed
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
)

124 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

125 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

127 
j
;

129 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

131 
PixñPos
 
b
;

133 
up_avaû
;

136 
p_Vid
->
	`gëNeighbour
(
cuºMB
, 0, -1,Ö_Vid->
mb_size
[
IS_LUMA
], &
b
);

138 i‡(!
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

140 
up_avaû
 = 
b
.
avaûabÀ
;

144 
up_avaû
 = 
b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[b.
mb_addr
] : 0;

147 i‡(!
up_avaû
)

148 
	`îr‹
 ("invalid 16x16 intraÖred Mode VERT_PRED_16",500);

150 
img≥l
 **
¥d
 = &
cuºSli˚
->
mb_¥ed
[
∂
][0];

151 
img≥l
 *
§c
 = &(
imgY
[
b
.
pos_y
][b.
pos_x
]);

153 
j
=0;j<
MB_BLOCK_SIZE
; j+= 4)

155 
	`mem˝y
(*
¥d
++, 
§c
, 
MB_BLOCK_SIZE
 * (
img≥l
));

156 
	`mem˝y
(*
¥d
++, 
§c
, 
MB_BLOCK_SIZE
 * (
img≥l
));

157 
	`mem˝y
(*
¥d
++, 
§c
, 
MB_BLOCK_SIZE
 * (
img≥l
));

158 
	`mem˝y
(*
¥d
++, 
§c
, 
MB_BLOCK_SIZE
 * (
img≥l
));

162  
DECODING_OK
;

163 
	}
}

176 
	$öåa16x16_h‹_¥ed
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
)

178 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

179 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

180 #i‡(
IMGTYPE
 == 0)

181 
j
;

183 
i
, 
j
;

186 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

187 
img≥l
 **
mb_¥ed
 = &(
cuºSli˚
->mb_¥ed[
∂
][0]);

188 
img≥l
 
¥edi˘i⁄
;

189 
pos_y
, 
pos_x
;

191 
PixñPos
 
a
;

193 
À·_avaû
;

195 
	`gëN⁄AffNeighbour
(
cuºMB
, -1, 0, 
p_Vid
->
mb_size
[
IS_LUMA
], &
a
);

197 i‡(!
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

199 
À·_avaû
 = 
a
.
avaûabÀ
;

203 
À·_avaû
 = 
a
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[a.
mb_addr
]: 0;

206 i‡(!
À·_avaû
)

207 
	`îr‹
 ("invalid 16x16 intraÖred Mode HOR_PRED_16",500);

209 
pos_y
 = 
a
.pos_y;

210 
pos_x
 = 
a
.pos_x;

212 
j
 = 0; j < 
MB_BLOCK_SIZE
; ++j)

214 
img≥l
 *
¥d
 = 
mb_¥ed
[
j
];

215 
¥edi˘i⁄
 = 
imgY
[
pos_y
++][
pos_x
];

216 #i‡(
IMGTYPE
 == 0)

217 
	`mem£t
(
¥d
, 
¥edi˘i⁄
, 
MB_BLOCK_SIZE
 * (
img≥l
));

219 
i
 = 0; i < 
MB_BLOCK_SIZE
; i += 4)

221 *
¥d
++
¥edi˘i⁄
;

222 *
¥d
++
¥edi˘i⁄
;

223 *
¥d
++
¥edi˘i⁄
;

224 *
¥d
++
¥edi˘i⁄
;

229  
DECODING_OK
;

230 
	}
}

243 
	$öåa16x16_∂™e_¥ed
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
)

245 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

246 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

248 
i
,
j
;

250 
ih
 = 0, 
iv
 = 0;

251 
ib
,
ic
,
üa
;

253 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

254 
img≥l
 **
mb_¥ed
 = &(
cuºSli˚
->mb_¥ed[
∂
][0]);

255 
img≥l
 *
m¥_löe
;

256 
max_img≥l_vÆue
 = 
p_Vid
->
max_≥l_vÆue_comp
[
∂
];

257 
pos_y
, 
pos_x
;

259 
PixñPos
 
a
, 
b
, 
d
;

261 
up_avaû
, 
À·_avaû
, 
À·_up_avaû
;

263 
	`gëN⁄AffNeighbour
(
cuºMB
, -1, -1, 
p_Vid
->
mb_size
[
IS_LUMA
], &
d
);

264 
	`gëN⁄AffNeighbour
(
cuºMB
, -1, 0, 
p_Vid
->
mb_size
[
IS_LUMA
], &
a
);

265 
	`gëN⁄AffNeighbour
(
cuºMB
, 0, -1, 
p_Vid
->
mb_size
[
IS_LUMA
], &
b
);

267 i‡(!
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

269 
up_avaû
 = 
b
.
avaûabÀ
;

270 
À·_avaû
 = 
a
.
avaûabÀ
;

271 
À·_up_avaû
 = 
d
.
avaûabÀ
;

275 
up_avaû
 = 
b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[b.
mb_addr
] : 0;

276 
À·_avaû
 = 
a
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[a.
mb_addr
] : 0;

277 
À·_up_avaû
 = 
d
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[d.
mb_addr
] : 0;

280 i‡(!
up_avaû
 || !
À·_up_avaû
 || !
À·_avaû
)

281 
	`îr‹
 ("invalid 16x16 intraÖred Mode PLANE_16",500);

283 
m¥_löe
 = &
imgY
[
b
.
pos_y
][b.
pos_x
+7];

284 
pos_y
 = 
a
.pos_y + 7;

285 
pos_x
 = 
a
.pos_x;

286 
i
 = 1; i < 8; ++i)

288 
ih
 +
i
*(
m¥_löe
[i] - mpr_line[-i]);

289 
iv
 +
i
*(
imgY
[
pos_y
 + i][
pos_x
] - imgY[pos_y - i][pos_x]);

292 
ih
 +8*(
m¥_löe
[8] - 
imgY
[
d
.
pos_y
][d.
pos_x
]);

293 
iv
 +8*(
imgY
[
pos_y
 + 8][
pos_x
] - imgY[
d
.pos_y][d.pos_x]);

295 
ib
=(5 * 
ih
 + 32)>>6;

296 
ic
=(5 * 
iv
 + 32)>>6;

298 
üa
=16 * (
m¥_löe
[8] + 
imgY
[
pos_y
 + 8][
pos_x
]);

299 
j
 = 0;j < 
MB_BLOCK_SIZE
; ++j)

301 
ibb
 = 
üa
 + (
j
 - 7Ë* 
ic
 + 16;

302 
img≥l
 *
¥d
 = 
mb_¥ed
[
j
];

303 
i
 = 0;ò< 
MB_BLOCK_SIZE
; i += 4)

305 *
¥d
++ = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((
ibb
 + (
i
 - 7Ë* 
ib
) >> 5));

306 *
¥d
++ = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((
ibb
 + (
i
 - 6Ë* 
ib
) >> 5));

307 *
¥d
++ = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((
ibb
 + (
i
 - 5Ë* 
ib
) >> 5));

308 *
¥d
++ = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((
ibb
 + (
i
 - 4Ë* 
ib
) >> 5));

312  
DECODING_OK
;

313 
	}
}

325 
	$öå≠ªd_16x16_n‹mÆ
(
Ma¸oblock
 *
cuºMB
,

326 
Cﬁ‹Pœ√
 
∂
,

327 
¥edmode
)

329 
¥edmode
)

331 
VERT_PRED_16
:

332  (
	`öåa16x16_vît_¥ed
(
cuºMB
, 
∂
));

334 
HOR_PRED_16
:

335  (
	`öåa16x16_h‹_¥ed
(
cuºMB
, 
∂
));

337 
DC_PRED_16
:

338  (
	`öåa16x16_dc_¥ed
(
cuºMB
, 
∂
));

340 
PLANE_16
:

341  (
	`öåa16x16_∂™e_¥ed
(
cuºMB
, 
∂
));

345 
	`¥ötf
("ûÀgÆ 16x16 i¡øÖªdi˘i⁄ modêöput: %d\n",
¥edmode
);

346  
SEARCH_SYNC
;

349 
	}
}

	@ldecod/src/intra4x4_pred.c

15 
	~"globÆ.h
"

16 
	~"öåa4x4_¥ed.h
"

17 
	~"mb_ac˚ss.h
"

18 
	~"image.h
"

32 
	#P_X
 (
PªdPñ
[0])

	)

33 
	#P_A
 (
PªdPñ
[1])

	)

34 
	#P_B
 (
PªdPñ
[2])

	)

35 
	#P_C
 (
PªdPñ
[3])

	)

36 
	#P_D
 (
PªdPñ
[4])

	)

37 
	#P_E
 (
PªdPñ
[5])

	)

38 
	#P_F
 (
PªdPñ
[6])

	)

39 
	#P_G
 (
PªdPñ
[7])

	)

40 
	#P_H
 (
PªdPñ
[8])

	)

41 
	#P_I
 (
PªdPñ
[9])

	)

42 
	#P_J
 (
PªdPñ
[10])

	)

43 
	#P_K
 (
PªdPñ
[11])

	)

44 
	#P_L
 (
PªdPñ
[12])

	)

64 
	$öåa4x4_dc_¥ed
(
Ma¸oblock
 *
cuºMB
,

65 
Cﬁ‹Pœ√
 
∂
,

66 
ioff
,

67 
joff
)

69 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

70 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

72 
j
;

73 
s0
 = 0;

74 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

75 
img≥l
 *
cuΩñ
 = 
NULL
;

77 
PixñPos
 
pix_a
, 
pix_b
;

79 
block_avaûabÀ_up
;

80 
block_avaûabÀ_À·
;

82 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_¥ed[
∂
];

84 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 , 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix_a
);

85 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 , 
joff
 -1, 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix_b
);

87 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

89 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_a.
mb_addr
] : 0;

90 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_b.
mb_addr
] : 0;

94 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
;

95 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

99 i‡(
block_avaûabÀ_up
)

101 
cuΩñ
 = &
imgY
[
pix_b
.
pos_y
][pix_b.
pos_x
];

102 
s0
 +*
cuΩñ
++;

103 
s0
 +*
cuΩñ
++;

104 
s0
 +*
cuΩñ
++;

105 
s0
 +*
cuΩñ
;

108 i‡(
block_avaûabÀ_À·
)

110 
img≥l
 **
img_¥ed
 = &
imgY
[
pix_a
.
pos_y
];

111 
pos_x
 = 
pix_a
.pos_x;

112 
s0
 +*(*(
img_¥ed
 ++Ë+ 
pos_x
);

113 
s0
 +*(*(
img_¥ed
 ++Ë+ 
pos_x
);

114 
s0
 +*(*(
img_¥ed
 ++Ë+ 
pos_x
);

115 
s0
 +*(*(
img_¥ed
 ) + 
pos_x
);

118 i‡(
block_avaûabÀ_up
 && 
block_avaûabÀ_À·
)

121 
s0
 = (s0 + 4)>>3;

123 i‡(!
block_avaûabÀ_up
 && 
block_avaûabÀ_À·
)

126 
s0
 = (s0 + 2)>>2;

128 i‡(
block_avaûabÀ_up
 && !
block_avaûabÀ_À·
)

131 
s0
 = (s0 + 2)>>2;

136 
s0
 = 
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

139 
j
=
joff
; j < jof‡+ 
BLOCK_SIZE
; ++j)

142 
mb_¥ed
[
j
][
ioff
 ] = (
img≥l
Ë
s0
;

143 
mb_¥ed
[
j
][
ioff
 + 1] = (
img≥l
Ë
s0
;

144 
mb_¥ed
[
j
][
ioff
 + 2] = (
img≥l
Ë
s0
;

145 
mb_¥ed
[
j
][
ioff
 + 3] = (
img≥l
Ë
s0
;

147  
DECODING_OK
;

148 
	}
}

160 
	$öåa4x4_vît_¥ed
(
Ma¸oblock
 *
cuºMB
,

161 
Cﬁ‹Pœ√
 
∂
,

162 
ioff
,

163 
joff
)

165 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

166 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

168 
block_avaûabÀ_up
;

169 
PixñPos
 
pix_b
;

171 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
, 
joff
 - 1 , 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix_b
);

173 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

175 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_b.
mb_addr
] : 0;

179 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

182 i‡(!
block_avaûabÀ_up
)

184 
	`¥ötf
 ("w¨nög: I¡ø_4x4_Vîtiˇ»¥edi˘i⁄ modênŸáŒowedáàmb %d\n", (Ë
cuºSli˚
->
cuºít_mb_ƒ
);

188 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_¥ed[
∂
];

189 
img≥l
 *
imgY
 = (
∂
Ë? &
cuºSli˚
->
dec_pi˘uª
->
imgUV
[∂ - 1][
pix_b
.
pos_y
][pix_b.
pos_x
] : &currSlice->dec_picture->imgY[pix_b.pos_y][pix_b.pos_x];

190 
	`mem˝y
(&(
mb_¥ed
[
joff
++][
ioff
]), 
imgY
, 
BLOCK_SIZE
 * (
img≥l
));

191 
	`mem˝y
(&(
mb_¥ed
[
joff
++][
ioff
]), 
imgY
, 
BLOCK_SIZE
 * (
img≥l
));

192 
	`mem˝y
(&(
mb_¥ed
[
joff
++][
ioff
]), 
imgY
, 
BLOCK_SIZE
 * (
img≥l
));

193 
	`mem˝y
(&(
mb_¥ed
[
joff
 ][
ioff
]), 
imgY
, 
BLOCK_SIZE
 * (
img≥l
));

195  
DECODING_OK
;

196 
	}
}

217 
	$öåa4x4_h‹_¥ed
(
Ma¸oblock
 *
cuºMB
,

218 
Cﬁ‹Pœ√
 
∂
,

219 
ioff
,

220 
joff
)

222 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

223 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

225 
PixñPos
 
pix_a
;

227 
block_avaûabÀ_À·
;

229 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 - 1 , 
joff
, 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix_a
);

231 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

233 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[pix_a.
mb_addr
]: 0;

237 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
;

240 i‡(!
block_avaûabÀ_À·
)

241 
	`¥ötf
 ("w¨nög: I¡ø_4x4_H‹iz⁄è»¥edi˘i⁄ modênŸáŒowedáàmb %d\n",(Ë
cuºSli˚
->
cuºít_mb_ƒ
);

243 #i‡(
IMGTYPE
 == 0)

245 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

246 
img≥l
 **
mb_¥ed
 = &
cuºSli˚
->mb_¥ed[
∂
][
joff
];

247 
img≥l
 **
img_¥ed
 = &
imgY
[
pix_a
.
pos_y
];

248 
pos_x
 = 
pix_a
.pos_x;

250 
	`mem£t
((*(
mb_¥ed
++Ë+ 
ioff
), *(*(
img_¥ed
++Ë+ 
pos_x
), 
BLOCK_SIZE
 *  (
img≥l
));

251 
	`mem£t
((*(
mb_¥ed
++Ë+ 
ioff
), *(*(
img_¥ed
++Ë+ 
pos_x
), 
BLOCK_SIZE
 *  (
img≥l
));

252 
	`mem£t
((*(
mb_¥ed
++Ë+ 
ioff
), *(*(
img_¥ed
++Ë+ 
pos_x
), 
BLOCK_SIZE
 *  (
img≥l
));

253 
	`mem£t
((*(
mb_¥ed
 ) + 
ioff
), *(*(
img_¥ed
 ) + 
pos_x
), 
BLOCK_SIZE
 *  (
img≥l
));

257 
j
;

258 
pos_y
 = 
pix_a
.pos_y;

259 
pos_x
 = 
pix_a
.pos_x;

260 
img≥l
 *
¥edrow
, 
¥edi˘i⁄
;

261 
img≥l
 **
mb_¥ed
 = &
cuºSli˚
->mb_¥ed[
∂
][
joff
];

262 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

264 
j
=0;j<
BLOCK_SIZE
;++j)

266 
¥edrow
 = 
mb_¥ed
[
j
];

267 
¥edi˘i⁄
 = 
imgY
[
pos_y
++][
pos_x
];

269 
¥edrow
[
ioff
 ]
¥edi˘i⁄
;

270 
¥edrow
[
ioff
 + 1]
¥edi˘i⁄
;

271 
¥edrow
[
ioff
 + 2]
¥edi˘i⁄
;

272 
¥edrow
[
ioff
 + 3]
¥edi˘i⁄
;

277  
DECODING_OK
;

278 
	}
}

290 
	$öåa4x4_düg_down_right_¥ed
(
Ma¸oblock
 *
cuºMB
,

291 
Cﬁ‹Pœ√
 
∂
,

292 
ioff
,

293 
joff
)

295 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

296 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

298 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

300 
PixñPos
 
pix_a
;

301 
PixñPos
 
pix_b
, 
pix_d
;

303 
block_avaûabÀ_up
;

304 
block_avaûabÀ_À·
;

305 
block_avaûabÀ_up_À·
;

307 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_¥ed[
∂
];

309 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 -1 , 
joff
 , 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix_a
);

310 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 , 
joff
 -1 , 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix_b
);

311 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 -1 , 
joff
 -1 , 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix_d
);

313 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

315 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_a.
mb_addr
]: 0;

316 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_b.
mb_addr
] : 0;

317 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_d.
mb_addr
] : 0;

321 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
;

322 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

323 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
;

326 i‡((!
block_avaûabÀ_up
)||(!
block_avaûabÀ_À·
)||(!
block_avaûabÀ_up_À·
))

327 
	`¥ötf
 ("w¨nög: I¡ø_4x4_Düg⁄Æ_Down_Righà¥edi˘i⁄ modênŸáŒowedáàmb %d\n",(Ë
cuºSli˚
->
cuºít_mb_ƒ
);

330 
img≥l
 
PªdPixñ
[7];

331 
img≥l
 
PªdPñ
[13];

332 
img≥l
 **
img_¥ed
 = &
imgY
[
pix_a
.
pos_y
];

333 
pix_x
 = 
pix_a
.
pos_x
;

334 
img≥l
 *
¥ed_≥l
 = &
imgY
[
pix_b
.
pos_y
][pix_b.
pos_x
];

337 
	`mem˝y
(&
PªdPñ
[1], 
¥ed_≥l
, 
BLOCK_SIZE
 * (
img≥l
));

339 
P_I
 = *(*(
img_¥ed
++Ë+ 
pix_x
);

340 
P_J
 = *(*(
img_¥ed
++Ë+ 
pix_x
);

341 
P_K
 = *(*(
img_¥ed
++Ë+ 
pix_x
);

342 
P_L
 = *(*(
img_¥ed
 ) + 
pix_x
);

344 
P_X
 = 
imgY
[
pix_d
.
pos_y
][pix_d.
pos_x
];

346 
PªdPixñ
[0] = (
img≥l
Ë((
P_L
 + (
P_K
 << 1Ë+ 
P_J
 + 2) >> 2);

347 
PªdPixñ
[1] = (
img≥l
Ë((
P_K
 + (
P_J
 << 1Ë+ 
P_I
 + 2) >> 2);

348 
PªdPixñ
[2] = (
img≥l
Ë((
P_J
 + (
P_I
 << 1Ë+ 
P_X
 + 2) >> 2);

349 
PªdPixñ
[3] = (
img≥l
Ë((
P_I
 + (
P_X
 << 1Ë+ 
P_A
 + 2) >> 2);

350 
PªdPixñ
[4] = (
img≥l
Ë((
P_X
 + 2*
P_A
 + 
P_B
 + 2) >> 2);

351 
PªdPixñ
[5] = (
img≥l
Ë((
P_A
 + 2*
P_B
 + 
P_C
 + 2) >> 2);

352 
PªdPixñ
[6] = (
img≥l
Ë((
P_B
 + 2*
P_C
 + 
P_D
 + 2) >> 2);

354 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[3], 4 * (
img≥l
));

355 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[2], 4 * (
img≥l
));

356 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[1], 4 * (
img≥l
));

357 
	`mem˝y
(&
mb_¥ed
[
joff
 ][
ioff
], &
PªdPixñ
[0], 4 * (
img≥l
));

360  
DECODING_OK
;

361 
	}
}

373 
	$öåa4x4_düg_down_À·_¥ed
(
Ma¸oblock
 *
cuºMB
,

374 
Cﬁ‹Pœ√
 
∂
,

375 
ioff
,

376 
joff
)

378 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

379 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

381 
PixñPos
 
pix_b
, 
pix_c
;

383 
block_avaûabÀ_up
;

384 
block_avaûabÀ_up_right
;

386 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 , 
joff
 - 1, 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix_b
);

387 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 + 4, 
joff
 - 1, 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix_c
);

389 
pix_c
.
avaûabÀ
 =Öix_c.avaûabÀ && !((
ioff
==4Ë&& ((
joff
==4)||(joff==12)));

391 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

393 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_b.
mb_addr
] : 0;

394 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_c.
mb_addr
] : 0;

398 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

399 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
;

402 i‡(!
block_avaûabÀ_up
)

403 
	`¥ötf
 ("w¨nög: I¡ø_4x4_Düg⁄Æ_Down_Le·Öªdi˘i⁄ modênŸáŒowedáàmb %d\n", (Ë
cuºSli˚
->
cuºít_mb_ƒ
);

406 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

407 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_¥ed[
∂
];

409 
img≥l
 
PªdPixñ
[8];

410 
img≥l
 
PªdPñ
[25];

411 
img≥l
 *
¥ed_≥l
 = &
imgY
[
pix_b
.
pos_y
][pix_b.
pos_x
];

415 
	`mem˝y
(&
PªdPñ
[1], 
¥ed_≥l
, 
BLOCK_SIZE
 * (
img≥l
));

419 i‡(
block_avaûabÀ_up_right
)

421 
	`mem˝y
(&
PªdPñ
[5], &
imgY
[
pix_c
.
pos_y
][pix_c.
pos_x
], 
BLOCK_SIZE
 * (
img≥l
));

425 #i‡(
IMGTYPE
 == 0)

426 
	`mem£t
(&
PªdPñ
[5], PªdPñ[4], 
BLOCK_SIZE
 * (
img≥l
));

428 
P_E
 = 
P_F
 = 
P_G
 = 
P_H
 = 
P_D
;

432 
PªdPixñ
[0] = (
img≥l
Ë((
P_A
 + 
P_C
 + 2*(
P_B
) + 2) >> 2);

433 
PªdPixñ
[1] = (
img≥l
Ë((
P_B
 + 
P_D
 + 2*(
P_C
) + 2) >> 2);

434 
PªdPixñ
[2] = (
img≥l
Ë((
P_C
 + 
P_E
 + 2*(
P_D
) + 2) >> 2);

435 
PªdPixñ
[3] = (
img≥l
Ë((
P_D
 + 
P_F
 + 2*(
P_E
) + 2) >> 2);

436 
PªdPixñ
[4] = (
img≥l
Ë((
P_E
 + 
P_G
 + 2*(
P_F
) + 2) >> 2);

437 
PªdPixñ
[5] = (
img≥l
Ë((
P_F
 + 
P_H
 + 2*(
P_G
) + 2) >> 2);

438 
PªdPixñ
[6] = (
img≥l
Ë((
P_G
 + 3*(
P_H
) + 2) >> 2);

440 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[0], 4 * (
img≥l
));

441 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[1], 4 * (
img≥l
));

442 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[2], 4 * (
img≥l
));

443 
	`mem˝y
(&
mb_¥ed
[
joff
 ][
ioff
], &
PªdPixñ
[3], 4 * (
img≥l
));

446  
DECODING_OK
;

447 
	}
}

459 
	$öåa4x4_vît_right_¥ed
(
Ma¸oblock
 *
cuºMB
,

460 
Cﬁ‹Pœ√
 
∂
,

461 
ioff
,

462 
joff
)

464 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

465 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

467 
PixñPos
 
pix_a
, 
pix_b
, 
pix_d
;

469 
block_avaûabÀ_up
;

470 
block_avaûabÀ_À·
;

471 
block_avaûabÀ_up_À·
;

473 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 -1 , 
joff
 , 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix_a
);

474 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 , 
joff
 -1 , 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix_b
);

475 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 -1 , 
joff
 -1 , 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix_d
);

477 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

479 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[pix_a.
mb_addr
]: 0;

480 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_b.
mb_addr
] : 0;

481 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_d.
mb_addr
] : 0;

485 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
;

486 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

487 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
;

490 i‡((!
block_avaûabÀ_up
)||(!
block_avaûabÀ_À·
)||(!
block_avaûabÀ_up_À·
))

491 
	`¥ötf
 ("w¨nög: I¡ø_4x4_Vîtiˇl_Righà¥edi˘i⁄ modênŸáŒowedáàmb %d\n", (Ë
cuºSli˚
->
cuºít_mb_ƒ
);

493 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

494 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_¥ed[
∂
];

495 
img≥l
 
PªdPixñ
[10];

496 
img≥l
 
PªdPñ
[13];

498 
img≥l
 **
img_¥ed
 = &
imgY
[
pix_a
.
pos_y
];

499 
pix_x
 = 
pix_a
.
pos_x
;

500 
img≥l
 *
¥ed_≥l
 = &
imgY
[
pix_b
.
pos_y
][pix_b.
pos_x
];

503 
	`mem˝y
(&
PªdPñ
[1], 
¥ed_≥l
, 
BLOCK_SIZE
 * (
img≥l
));

506 
P_I
 = *(*(
img_¥ed
++Ë+ 
pix_x
);

507 
P_J
 = *(*(
img_¥ed
++Ë+ 
pix_x
);

508 
P_K
 = *(*(
img_¥ed
++Ë+ 
pix_x
);

510 
P_X
 = 
imgY
[
pix_d
.
pos_y
][pix_d.
pos_x
];

512 
PªdPixñ
[0] = (
img≥l
Ë((
P_X
 + (
P_I
 << 1Ë+ 
P_J
 + 2) >> 2);

513 
PªdPixñ
[1] = (
img≥l
Ë((
P_X
 + 
P_A
 + 1) >> 1);

514 
PªdPixñ
[2] = (
img≥l
Ë((
P_A
 + 
P_B
 + 1) >> 1);

515 
PªdPixñ
[3] = (
img≥l
Ë((
P_B
 + 
P_C
 + 1) >> 1);

516 
PªdPixñ
[4] = (
img≥l
Ë((
P_C
 + 
P_D
 + 1) >> 1);

517 
PªdPixñ
[5] = (
img≥l
Ë((
P_I
 + (
P_J
 << 1Ë+ 
P_K
 + 2) >> 2);

518 
PªdPixñ
[6] = (
img≥l
Ë((
P_I
 + (
P_X
 << 1Ë+ 
P_A
 + 2) >> 2);

519 
PªdPixñ
[7] = (
img≥l
Ë((
P_X
 + 2*
P_A
 + 
P_B
 + 2) >> 2);

520 
PªdPixñ
[8] = (
img≥l
Ë((
P_A
 + 2*
P_B
 + 
P_C
 + 2) >> 2);

521 
PªdPixñ
[9] = (
img≥l
Ë((
P_B
 + 2*
P_C
 + 
P_D
 + 2) >> 2);

523 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[1], 4 * (
img≥l
));

524 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[6], 4 * (
img≥l
));

525 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[0], 4 * (
img≥l
));

526 
	`mem˝y
(&
mb_¥ed
[
joff
 ][
ioff
], &
PªdPixñ
[5], 4 * (
img≥l
));

530  
DECODING_OK
;

531 
	}
}

544 
	$öåa4x4_vît_À·_¥ed
(
Ma¸oblock
 *
cuºMB
,

545 
Cﬁ‹Pœ√
 
∂
,

546 
ioff
,

547 
joff
)

549 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

550 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

552 
PixñPos
 
pix_b
, 
pix_c
;

554 
block_avaûabÀ_up
;

555 
block_avaûabÀ_up_right
;

557 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 , 
joff
 -1 , 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix_b
);

558 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 +4 , 
joff
 -1 , 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix_c
);

560 
pix_c
.
avaûabÀ
 =Öix_c.avaûabÀ && !((
ioff
==4Ë&& ((
joff
==4)||(joff==12)));

562 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

564 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_b.
mb_addr
] : 0;

565 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_c.
mb_addr
] : 0;

569 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

570 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
;

574 i‡(!
block_avaûabÀ_up
)

575 
	`¥ötf
 ("w¨nög: I¡ø_4x4_Vîtiˇl_Le·Öªdi˘i⁄ modênŸáŒowedáàmb %d\n", (Ë
cuºSli˚
->
cuºít_mb_ƒ
);

577 
img≥l
 
PªdPixñ
[10];

578 
img≥l
 
PªdPñ
[13];

579 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

580 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_¥ed[
∂
];

581 
img≥l
 *
¥ed_≥l
 = &
imgY
[
pix_b
.
pos_y
][pix_b.
pos_x
];

585 
	`mem˝y
(&
PªdPñ
[1], 
¥ed_≥l
, 
BLOCK_SIZE
 * (
img≥l
));

589 i‡(
block_avaûabÀ_up_right
)

591 
	`mem˝y
(&
PªdPñ
[5], &
imgY
[
pix_c
.
pos_y
][pix_c.
pos_x
], 
BLOCK_SIZE
 * (
img≥l
));

595 #i‡(
IMGTYPE
 == 0)

596 
	`mem£t
(&
PªdPñ
[5], PªdPñ[4], 
BLOCK_SIZE
 * (
img≥l
));

598 
P_E
 = 
P_F
 = 
P_G
 = 
P_H
 = 
P_D
;

602 
PªdPixñ
[0] = (
img≥l
Ë((
P_A
 + 
P_B
 + 1) >> 1);

603 
PªdPixñ
[1] = (
img≥l
Ë((
P_B
 + 
P_C
 + 1) >> 1);

604 
PªdPixñ
[2] = (
img≥l
Ë((
P_C
 + 
P_D
 + 1) >> 1);

605 
PªdPixñ
[3] = (
img≥l
Ë((
P_D
 + 
P_E
 + 1) >> 1);

606 
PªdPixñ
[4] = (
img≥l
Ë((
P_E
 + 
P_F
 + 1) >> 1);

607 
PªdPixñ
[5] = (
img≥l
Ë((
P_A
 + 2*
P_B
 + 
P_C
 + 2) >> 2);

608 
PªdPixñ
[6] = (
img≥l
Ë((
P_B
 + 2*
P_C
 + 
P_D
 + 2) >> 2);

609 
PªdPixñ
[7] = (
img≥l
Ë((
P_C
 + 2*
P_D
 + 
P_E
 + 2) >> 2);

610 
PªdPixñ
[8] = (
img≥l
Ë((
P_D
 + 2*
P_E
 + 
P_F
 + 2) >> 2);

611 
PªdPixñ
[9] = (
img≥l
Ë((
P_E
 + 2*
P_F
 + 
P_G
 + 2) >> 2);

613 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[0], 4 * (
img≥l
));

614 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[5], 4 * (
img≥l
));

615 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[1], 4 * (
img≥l
));

616 
	`mem˝y
(&
mb_¥ed
[
joff
 ][
ioff
], &
PªdPixñ
[6], 4 * (
img≥l
));

618  
DECODING_OK
;

619 
	}
}

631 
	$öåa4x4_h‹_up_¥ed
(
Ma¸oblock
 *
cuºMB
,

632 
Cﬁ‹Pœ√
 
∂
,

633 
ioff
,

634 
joff
)

636 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

637 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

639 
PixñPos
 
pix_a
;

641 
block_avaûabÀ_À·
;

643 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 -1 , 
joff
, 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix_a
);

645 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

647 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[pix_a.
mb_addr
]: 0;

651 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
;

654 i‡(!
block_avaûabÀ_À·
)

655 
	`¥ötf
 ("w¨nög: I¡ø_4x4_H‹iz⁄èl_U∞¥edi˘i⁄ modênŸáŒowedáàmb %d\n",(Ë
cuºSli˚
->
cuºít_mb_ƒ
);

658 
img≥l
 
PªdPixñ
[10];

659 
img≥l
 
PªdPñ
[13];

660 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

661 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_¥ed[
∂
];

663 
img≥l
 **
img_¥ed
 = &
imgY
[
pix_a
.
pos_y
];

664 
pix_x
 = 
pix_a
.
pos_x
;

667 
P_I
 = *(*(
img_¥ed
++Ë+ 
pix_x
);

668 
P_J
 = *(*(
img_¥ed
++Ë+ 
pix_x
);

669 
P_K
 = *(*(
img_¥ed
++Ë+ 
pix_x
);

670 
P_L
 = *(*(
img_¥ed
 ) + 
pix_x
);

672 
PªdPixñ
[0] = (
img≥l
Ë((
P_I
 + 
P_J
 + 1) >> 1);

673 
PªdPixñ
[1] = (
img≥l
Ë((
P_I
 + (
P_J
 << 1Ë+ 
P_K
 + 2) >> 2);

674 
PªdPixñ
[2] = (
img≥l
Ë((
P_J
 + 
P_K
 + 1) >> 1);

675 
PªdPixñ
[3] = (
img≥l
Ë((
P_J
 + (
P_K
 << 1Ë+ 
P_L
 + 2) >> 2);

676 
PªdPixñ
[4] = (
img≥l
Ë((
P_K
 + 
P_L
 + 1) >> 1);

677 
PªdPixñ
[5] = (
img≥l
Ë((
P_K
 + (
P_L
 << 1) + P_L + 2) >> 2);

678 
PªdPixñ
[6] = (
img≥l
Ë
P_L
;

679 
PªdPixñ
[7] = (
img≥l
Ë
P_L
;

680 
PªdPixñ
[8] = (
img≥l
Ë
P_L
;

681 
PªdPixñ
[9] = (
img≥l
Ë
P_L
;

683 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[0], 4 * (
img≥l
));

684 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[2], 4 * (
img≥l
));

685 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[4], 4 * (
img≥l
));

686 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[6], 4 * (
img≥l
));

689  
DECODING_OK
;

690 
	}
}

702 
	$öåa4x4_h‹_down_¥ed
(
Ma¸oblock
 *
cuºMB
,

703 
Cﬁ‹Pœ√
 
∂
,

704 
ioff
,

705 
joff
)

707 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

708 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

710 
PixñPos
 
pix_a
, 
pix_b
, 
pix_d
;

712 
block_avaûabÀ_up
;

713 
block_avaûabÀ_À·
;

714 
block_avaûabÀ_up_À·
;

716 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 -1 , 
joff
 , 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix_a
);

717 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 , 
joff
 -1 , 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix_b
);

718 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 -1 , 
joff
 -1 , 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix_d
);

720 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

722 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_a.
mb_addr
]: 0;

723 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_b.
mb_addr
] : 0;

724 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_d.
mb_addr
] : 0;

728 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
;

729 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

730 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
;

733 i‡((!
block_avaûabÀ_up
)||(!
block_avaûabÀ_À·
)||(!
block_avaûabÀ_up_À·
))

734 
	`¥ötf
 ("w¨nög: I¡ø_4x4_H‹iz⁄èl_Dow¿¥edi˘i⁄ modênŸáŒowedáàmb %d\n", (Ë
cuºSli˚
->
cuºít_mb_ƒ
);

737 
img≥l
 
PªdPixñ
[10];

738 
img≥l
 
PªdPñ
[13];

739 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

740 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_¥ed[
∂
];

742 
img≥l
 **
img_¥ed
 = &
imgY
[
pix_a
.
pos_y
];

743 
pix_x
 = 
pix_a
.
pos_x
;

744 
img≥l
 *
¥ed_≥l
 = &
imgY
[
pix_b
.
pos_y
][pix_b.
pos_x
];

748 
	`mem˝y
(&
PªdPñ
[1], 
¥ed_≥l
, 
BLOCK_SIZE
 * (
img≥l
));

751 
P_I
 = *(*(
img_¥ed
++Ë+ 
pix_x
);

752 
P_J
 = *(*(
img_¥ed
++Ë+ 
pix_x
);

753 
P_K
 = *(*(
img_¥ed
++Ë+ 
pix_x
);

754 
P_L
 = *(*(
img_¥ed
 ) + 
pix_x
);

756 
P_X
 = 
imgY
[
pix_d
.
pos_y
][pix_d.
pos_x
];

758 
PªdPixñ
[0] = (
img≥l
Ë((
P_K
 + 
P_L
 + 1) >> 1);

759 
PªdPixñ
[1] = (
img≥l
Ë((
P_J
 + (
P_K
 << 1Ë+ 
P_L
 + 2) >> 2);

760 
PªdPixñ
[2] = (
img≥l
Ë((
P_J
 + 
P_K
 + 1) >> 1);

761 
PªdPixñ
[3] = (
img≥l
Ë((
P_I
 + (
P_J
 << 1Ë+ 
P_K
 + 2) >> 2);

762 
PªdPixñ
[4] = (
img≥l
Ë((
P_I
 + 
P_J
 + 1) >> 1);

763 
PªdPixñ
[5] = (
img≥l
Ë((
P_X
 + (
P_I
 << 1Ë+ 
P_J
 + 2) >> 2);

764 
PªdPixñ
[6] = (
img≥l
Ë((
P_X
 + 
P_I
 + 1) >> 1);

765 
PªdPixñ
[7] = (
img≥l
Ë((
P_I
 + (
P_X
 << 1Ë+ 
P_A
 + 2) >> 2);

766 
PªdPixñ
[8] = (
img≥l
Ë((
P_X
 + 2*
P_A
 + 
P_B
 + 2) >> 2);

767 
PªdPixñ
[9] = (
img≥l
Ë((
P_A
 + 2*
P_B
 + 
P_C
 + 2) >> 2);

769 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[6], 4 * (
img≥l
));

770 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[4], 4 * (
img≥l
));

771 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[2], 4 * (
img≥l
));

772 
	`mem˝y
(&
mb_¥ed
[
joff
 ][
ioff
], &
PªdPixñ
[0], 4 * (
img≥l
));

775  
DECODING_OK
;

776 
	}
}

789 
	$öåa_¥ed_4x4_n‹mÆ
(
Ma¸oblock
 *
cuºMB
,

790 
Cﬁ‹Pœ√
 
∂
,

791 
ioff
,

792 
joff
,

793 
img_block_x
,

794 
img_block_y
)

796 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

797 
byã
 
¥edmode
 = 
p_Vid
->
ùªdmode
[
img_block_y
][
img_block_x
];

798 
cuºMB
->
ùmode_DPCM
 = 
¥edmode
;

800 
¥edmode
)

802 
DC_PRED
:

803  (
	`öåa4x4_dc_¥ed
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

805 
VERT_PRED
:

806  (
	`öåa4x4_vît_¥ed
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

808 
HOR_PRED
:

809  (
	`öåa4x4_h‹_¥ed
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

811 
DIAG_DOWN_RIGHT_PRED
:

812  (
	`öåa4x4_düg_down_right_¥ed
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

814 
DIAG_DOWN_LEFT_PRED
:

815  (
	`öåa4x4_düg_down_À·_¥ed
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

817 
VERT_RIGHT_PRED
:

818  (
	`öåa4x4_vît_right_¥ed
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

820 
VERT_LEFT_PRED
:

821  (
	`öåa4x4_vît_À·_¥ed
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

823 
HOR_UP_PRED
:

824  (
	`öåa4x4_h‹_up_¥ed
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

826 
HOR_DOWN_PRED
:

827  (
	`öåa4x4_h‹_down_¥ed
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

829 
	`¥ötf
("Eº‹: iŒegÆ i¡ø_4x4Öªdi˘i⁄ mode: %d\n", (Ë
¥edmode
);

830  
SEARCH_SYNC
;

833 
	}
}

	@ldecod/src/intra4x4_pred_mbaff.c

15 
	~"globÆ.h
"

16 
	~"öåa4x4_¥ed.h
"

17 
	~"mb_ac˚ss.h
"

18 
	~"image.h
"

32 
	#P_X
 (
PªdPñ
[0])

	)

33 
	#P_A
 (
PªdPñ
[1])

	)

34 
	#P_B
 (
PªdPñ
[2])

	)

35 
	#P_C
 (
PªdPñ
[3])

	)

36 
	#P_D
 (
PªdPñ
[4])

	)

37 
	#P_E
 (
PªdPñ
[5])

	)

38 
	#P_F
 (
PªdPñ
[6])

	)

39 
	#P_G
 (
PªdPñ
[7])

	)

40 
	#P_H
 (
PªdPñ
[8])

	)

41 
	#P_I
 (
PªdPñ
[9])

	)

42 
	#P_J
 (
PªdPñ
[10])

	)

43 
	#P_K
 (
PªdPñ
[11])

	)

44 
	#P_L
 (
PªdPñ
[12])

	)

64 
	$öåa4x4_dc_¥ed_mbaff
(
Ma¸oblock
 *
cuºMB
,

65 
Cﬁ‹Pœ√
 
∂
,

66 
ioff
,

67 
joff
)

69 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

70 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

72 
i
,
j
;

73 
s0
 = 0;

74 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

76 
PixñPos
 
pix_a
[4], 
pix_b
;

78 
block_avaûabÀ_up
;

79 
block_avaûabÀ_À·
;

81 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_¥ed[
∂
];

83 
i
=0;i<4;++i)

85 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 + 
i
, 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix_a
[i]);

87 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 , 
joff
 -1 , 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix_b
);

89 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

91 
i
=0, 
block_avaûabÀ_À·
=1; i<4;++i)

92 
block_avaûabÀ_À·
 &
pix_a
[
i
].
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[pix_a[i].
mb_addr
]: 0;

93 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_b.
mb_addr
] : 0;

97 
block_avaûabÀ_À·
 = 
pix_a
[0].
avaûabÀ
;

98 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

102 i‡(
block_avaûabÀ_up
)

104 
s0
 +
imgY
[
pix_b
.
pos_y
][pix_b.
pos_x
 + 0];

105 
s0
 +
imgY
[
pix_b
.
pos_y
][pix_b.
pos_x
 + 1];

106 
s0
 +
imgY
[
pix_b
.
pos_y
][pix_b.
pos_x
 + 2];

107 
s0
 +
imgY
[
pix_b
.
pos_y
][pix_b.
pos_x
 + 3];

110 i‡(
block_avaûabÀ_À·
)

112 
s0
 +
imgY
[
pix_a
[0].
pos_y
][pix_a[0].
pos_x
];

113 
s0
 +
imgY
[
pix_a
[1].
pos_y
][pix_a[1].
pos_x
];

114 
s0
 +
imgY
[
pix_a
[2].
pos_y
][pix_a[2].
pos_x
];

115 
s0
 +
imgY
[
pix_a
[3].
pos_y
][pix_a[3].
pos_x
];

118 i‡(
block_avaûabÀ_up
 && 
block_avaûabÀ_À·
)

121 
s0
 = (s0 + 4)>>3;

123 i‡(!
block_avaûabÀ_up
 && 
block_avaûabÀ_À·
)

126 
s0
 = (s0 + 2)>>2;

128 i‡(
block_avaûabÀ_up
 && !
block_avaûabÀ_À·
)

131 
s0
 = (s0 + 2)>>2;

136 
s0
 = 
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

139 
j
=
joff
; j < jof‡+ 
BLOCK_SIZE
; ++j)

142 
mb_¥ed
[
j
][
ioff
 ] = (
img≥l
Ë
s0
;

143 
mb_¥ed
[
j
][
ioff
 + 1] = (
img≥l
Ë
s0
;

144 
mb_¥ed
[
j
][
ioff
 + 2] = (
img≥l
Ë
s0
;

145 
mb_¥ed
[
j
][
ioff
 + 3] = (
img≥l
Ë
s0
;

147  
DECODING_OK
;

148 
	}
}

160 
	$öåa4x4_vît_¥ed_mbaff
(
Ma¸oblock
 *
cuºMB
,

161 
Cﬁ‹Pœ√
 
∂
,

162 
ioff
,

163 
joff
)

165 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

166 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

168 
block_avaûabÀ_up
;

169 
PixñPos
 
pix_b
;

171 
	`gëAffNeighbour
(
cuºMB
, 
ioff
, 
joff
 - 1 , 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix_b
);

173 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

175 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_b.
mb_addr
] : 0;

179 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

182 i‡(!
block_avaûabÀ_up
)

184 
	`¥ötf
 ("w¨nög: I¡ø_4x4_Vîtiˇ»¥edi˘i⁄ modênŸáŒowedáàmb %d\n", (Ë
cuºSli˚
->
cuºít_mb_ƒ
);

188 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_¥ed[
∂
];

189 
img≥l
 *
imgY
 = (
∂
Ë? &
cuºSli˚
->
dec_pi˘uª
->
imgUV
[∂ - 1][
pix_b
.
pos_y
][pix_b.
pos_x
] : &currSlice->dec_picture->imgY[pix_b.pos_y][pix_b.pos_x];

190 
	`mem˝y
(&(
mb_¥ed
[
joff
++][
ioff
]), 
imgY
, 
BLOCK_SIZE
 * (
img≥l
));

191 
	`mem˝y
(&(
mb_¥ed
[
joff
++][
ioff
]), 
imgY
, 
BLOCK_SIZE
 * (
img≥l
));

192 
	`mem˝y
(&(
mb_¥ed
[
joff
++][
ioff
]), 
imgY
, 
BLOCK_SIZE
 * (
img≥l
));

193 
	`mem˝y
(&(
mb_¥ed
[
joff
 ][
ioff
]), 
imgY
, 
BLOCK_SIZE
 * (
img≥l
));

195  
DECODING_OK
;

196 
	}
}

217 
	$öåa4x4_h‹_¥ed_mbaff
(
Ma¸oblock
 *
cuºMB
,

218 
Cﬁ‹Pœ√
 
∂
,

219 
ioff
,

220 
joff
)

222 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

223 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

225 
i
,
j
;

226 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

228 
PixñPos
 
pix_a
[4];

230 
block_avaûabÀ_À·
;

232 
img≥l
 *
¥edrow
, 
¥edi˘i⁄
, **
mb_¥ed
 = 
cuºSli˚
->mb_¥ed[
∂
];

234 
i
=0;i<4;++i)

236 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 -1 , 
joff
 +
i
 , 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix_a
[i]);

239 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

241 
i
=0, 
block_avaûabÀ_À·
=1; i<4;++i)

242 
block_avaûabÀ_À·
 &
pix_a
[
i
].
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[pix_a[i].
mb_addr
]: 0;

246 
block_avaûabÀ_À·
 = 
pix_a
[0].
avaûabÀ
;

249 i‡(!
block_avaûabÀ_À·
)

250 
	`¥ötf
 ("w¨nög: I¡ø_4x4_H‹iz⁄è»¥edi˘i⁄ modênŸáŒowedáàmb %d\n",(Ë
cuºSli˚
->
cuºít_mb_ƒ
);

252 
j
=0;j<
BLOCK_SIZE
;++j)

254 
¥edrow
 = 
mb_¥ed
[
j
+
joff
];

255 
¥edi˘i⁄
 = 
imgY
[
pix_a
[
j
].
pos_y
][pix_a[j].
pos_x
];

256 
i
 = 
ioff
;ò< iof‡+ 
BLOCK_SIZE
;++i)

257 
¥edrow
[
i
]
¥edi˘i⁄
;

260  
DECODING_OK
;

261 
	}
}

273 
	$öåa4x4_düg_down_right_¥ed_mbaff
(
Ma¸oblock
 *
cuºMB
,

274 
Cﬁ‹Pœ√
 
∂
,

275 
ioff
,

276 
joff
)

278 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

279 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

281 
i
;

282 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

284 
PixñPos
 
pix_a
[4];

285 
PixñPos
 
pix_b
, 
pix_d
;

287 
block_avaûabÀ_up
;

288 
block_avaûabÀ_À·
;

289 
block_avaûabÀ_up_À·
;

291 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_¥ed[
∂
];

293 
i
=0;i<4;++i)

295 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 -1 , 
joff
 +
i
 , 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix_a
[i]);

298 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 , 
joff
 -1 , 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix_b
);

299 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 -1 , 
joff
 -1 , 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix_d
);

301 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

303 
i
=0, 
block_avaûabÀ_À·
=1; i<4;++i)

304 
block_avaûabÀ_À·
 &
pix_a
[
i
].
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[pix_a[i].
mb_addr
]: 0;

305 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_b.
mb_addr
] : 0;

306 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_d.
mb_addr
] : 0;

310 
block_avaûabÀ_À·
 = 
pix_a
[0].
avaûabÀ
;

311 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

312 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
;

315 i‡((!
block_avaûabÀ_up
)||(!
block_avaûabÀ_À·
)||(!
block_avaûabÀ_up_À·
))

316 
	`¥ötf
 ("w¨nög: I¡ø_4x4_Düg⁄Æ_Down_Righà¥edi˘i⁄ modênŸáŒowedáàmb %d\n",(Ë
cuºSli˚
->
cuºít_mb_ƒ
);

319 
img≥l
 
PªdPixñ
[7];

320 
img≥l
 
PªdPñ
[13];

321 
img≥l
 *
¥ed_≥l
 = &
imgY
[
pix_b
.
pos_y
][pix_b.
pos_x
];

324 
	`mem˝y
(&
PªdPñ
[1], 
¥ed_≥l
, 
BLOCK_SIZE
 * (
img≥l
));

327 
P_I
 = 
imgY
[
pix_a
[0].
pos_y
][pix_a[0].
pos_x
];

328 
P_J
 = 
imgY
[
pix_a
[1].
pos_y
][pix_a[1].
pos_x
];

329 
P_K
 = 
imgY
[
pix_a
[2].
pos_y
][pix_a[2].
pos_x
];

330 
P_L
 = 
imgY
[
pix_a
[3].
pos_y
][pix_a[3].
pos_x
];

332 
P_X
 = 
imgY
[
pix_d
.
pos_y
][pix_d.
pos_x
];

334 
PªdPixñ
[0] = (
img≥l
Ë((
P_L
 + (
P_K
 << 1Ë+ 
P_J
 + 2) >> 2);

335 
PªdPixñ
[1] = (
img≥l
Ë((
P_K
 + (
P_J
 << 1Ë+ 
P_I
 + 2) >> 2);

336 
PªdPixñ
[2] = (
img≥l
Ë((
P_J
 + (
P_I
 << 1Ë+ 
P_X
 + 2) >> 2);

337 
PªdPixñ
[3] = (
img≥l
Ë((
P_I
 + (
P_X
 << 1Ë+ 
P_A
 + 2) >> 2);

338 
PªdPixñ
[4] = (
img≥l
Ë((
P_X
 + 2*
P_A
 + 
P_B
 + 2) >> 2);

339 
PªdPixñ
[5] = (
img≥l
Ë((
P_A
 + 2*
P_B
 + 
P_C
 + 2) >> 2);

340 
PªdPixñ
[6] = (
img≥l
Ë((
P_B
 + 2*
P_C
 + 
P_D
 + 2) >> 2);

342 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[3], 4 * (
img≥l
));

343 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[2], 4 * (
img≥l
));

344 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[1], 4 * (
img≥l
));

345 
	`mem˝y
(&
mb_¥ed
[
joff
 ][
ioff
], &
PªdPixñ
[0], 4 * (
img≥l
));

348  
DECODING_OK
;

349 
	}
}

361 
	$öåa4x4_düg_down_À·_¥ed_mbaff
(
Ma¸oblock
 *
cuºMB
,

362 
Cﬁ‹Pœ√
 
∂
,

363 
ioff
,

364 
joff
)

366 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

367 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

369 
PixñPos
 
pix_b
, 
pix_c
;

371 
block_avaûabÀ_up
;

372 
block_avaûabÀ_up_right
;

374 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 , 
joff
 - 1, 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix_b
);

375 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 + 4, 
joff
 - 1, 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix_c
);

377 
pix_c
.
avaûabÀ
 =Öix_c.avaûabÀ && !((
ioff
==4Ë&& ((
joff
==4)||(joff==12)));

379 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

381 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_b.
mb_addr
] : 0;

382 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_c.
mb_addr
] : 0;

386 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

387 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
;

390 i‡(!
block_avaûabÀ_up
)

391 
	`¥ötf
 ("w¨nög: I¡ø_4x4_Düg⁄Æ_Down_Le·Öªdi˘i⁄ modênŸáŒowedáàmb %d\n", (Ë
cuºSli˚
->
cuºít_mb_ƒ
);

394 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

395 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_¥ed[
∂
];

397 
img≥l
 
PªdPixñ
[8];

398 
img≥l
 
PªdPñ
[25];

399 
img≥l
 *
¥ed_≥l
 = &
imgY
[
pix_b
.
pos_y
][pix_b.
pos_x
];

403 
	`mem˝y
(&
PªdPñ
[1], 
¥ed_≥l
, 
BLOCK_SIZE
 * (
img≥l
));

406 i‡(
block_avaûabÀ_up_right
)

408 
	`mem˝y
(&
PªdPñ
[5], &
imgY
[
pix_c
.
pos_y
][pix_c.
pos_x
], 
BLOCK_SIZE
 * (
img≥l
));

412 
P_E
 = 
P_F
 = 
P_G
 = 
P_H
 = 
P_D
;

415 
PªdPixñ
[0] = (
img≥l
Ë((
P_A
 + 
P_C
 + 2*(
P_B
) + 2) >> 2);

416 
PªdPixñ
[1] = (
img≥l
Ë((
P_B
 + 
P_D
 + 2*(
P_C
) + 2) >> 2);

417 
PªdPixñ
[2] = (
img≥l
Ë((
P_C
 + 
P_E
 + 2*(
P_D
) + 2) >> 2);

418 
PªdPixñ
[3] = (
img≥l
Ë((
P_D
 + 
P_F
 + 2*(
P_E
) + 2) >> 2);

419 
PªdPixñ
[4] = (
img≥l
Ë((
P_E
 + 
P_G
 + 2*(
P_F
) + 2) >> 2);

420 
PªdPixñ
[5] = (
img≥l
Ë((
P_F
 + 
P_H
 + 2*(
P_G
) + 2) >> 2);

421 
PªdPixñ
[6] = (
img≥l
Ë((
P_G
 + 3*(
P_H
) + 2) >> 2);

423 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[0], 4 * (
img≥l
));

424 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[1], 4 * (
img≥l
));

425 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[2], 4 * (
img≥l
));

426 
	`mem˝y
(&
mb_¥ed
[
joff
 ][
ioff
], &
PªdPixñ
[3], 4 * (
img≥l
));

429  
DECODING_OK
;

430 
	}
}

442 
	$öåa4x4_vît_right_¥ed_mbaff
(
Ma¸oblock
 *
cuºMB
,

443 
Cﬁ‹Pœ√
 
∂
,

444 
ioff
,

445 
joff
)

447 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

448 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

450 
i
;

451 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

453 
PixñPos
 
pix_a
[4];

454 
PixñPos
 
pix_b
, 
pix_d
;

456 
block_avaûabÀ_up
;

457 
block_avaûabÀ_À·
;

458 
block_avaûabÀ_up_À·
;

460 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_¥ed[
∂
];

462 
i
=0;i<4;++i)

464 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 -1 , 
joff
 +
i
 , 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix_a
[i]);

467 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 , 
joff
 -1 , 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix_b
);

468 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 -1 , 
joff
 -1 , 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix_d
);

470 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

472 
i
=0, 
block_avaûabÀ_À·
=1; i<4;++i)

473 
block_avaûabÀ_À·
 &
pix_a
[
i
].
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[pix_a[i].
mb_addr
]: 0;

474 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_b.
mb_addr
] : 0;

475 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_d.
mb_addr
] : 0;

479 
block_avaûabÀ_À·
 = 
pix_a
[0].
avaûabÀ
;

480 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

481 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
;

484 i‡((!
block_avaûabÀ_up
)||(!
block_avaûabÀ_À·
)||(!
block_avaûabÀ_up_À·
))

485 
	`¥ötf
 ("w¨nög: I¡ø_4x4_Vîtiˇl_Righà¥edi˘i⁄ modênŸáŒowedáàmb %d\n", (Ë
cuºSli˚
->
cuºít_mb_ƒ
);

487 
img≥l
 
PªdPixñ
[10];

488 
img≥l
 
PªdPñ
[13];

489 
img≥l
 *
¥ed_≥l
 = &
imgY
[
pix_b
.
pos_y
][pix_b.
pos_x
];

492 
	`mem˝y
(&
PªdPñ
[1], 
¥ed_≥l
, 
BLOCK_SIZE
 * (
img≥l
));

495 
P_I
 = 
imgY
[
pix_a
[0].
pos_y
][pix_a[0].
pos_x
];

496 
P_J
 = 
imgY
[
pix_a
[1].
pos_y
][pix_a[1].
pos_x
];

497 
P_K
 = 
imgY
[
pix_a
[2].
pos_y
][pix_a[2].
pos_x
];

499 
P_X
 = 
imgY
[
pix_d
.
pos_y
][pix_d.
pos_x
];

501 
PªdPixñ
[0] = (
img≥l
Ë((
P_X
 + (
P_I
 << 1Ë+ 
P_J
 + 2) >> 2);

502 
PªdPixñ
[1] = (
img≥l
Ë((
P_X
 + 
P_A
 + 1) >> 1);

503 
PªdPixñ
[2] = (
img≥l
Ë((
P_A
 + 
P_B
 + 1) >> 1);

504 
PªdPixñ
[3] = (
img≥l
Ë((
P_B
 + 
P_C
 + 1) >> 1);

505 
PªdPixñ
[4] = (
img≥l
Ë((
P_C
 + 
P_D
 + 1) >> 1);

506 
PªdPixñ
[5] = (
img≥l
Ë((
P_I
 + (
P_J
 << 1Ë+ 
P_K
 + 2) >> 2);

507 
PªdPixñ
[6] = (
img≥l
Ë((
P_I
 + (
P_X
 << 1Ë+ 
P_A
 + 2) >> 2);

508 
PªdPixñ
[7] = (
img≥l
Ë((
P_X
 + 2*
P_A
 + 
P_B
 + 2) >> 2);

509 
PªdPixñ
[8] = (
img≥l
Ë((
P_A
 + 2*
P_B
 + 
P_C
 + 2) >> 2);

510 
PªdPixñ
[9] = (
img≥l
Ë((
P_B
 + 2*
P_C
 + 
P_D
 + 2) >> 2);

512 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[1], 4 * (
img≥l
));

513 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[6], 4 * (
img≥l
));

514 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[0], 4 * (
img≥l
));

515 
	`mem˝y
(&
mb_¥ed
[
joff
 ][
ioff
], &
PªdPixñ
[5], 4 * (
img≥l
));

519  
DECODING_OK
;

520 
	}
}

533 
	$öåa4x4_vît_À·_¥ed_mbaff
(
Ma¸oblock
 *
cuºMB
,

534 
Cﬁ‹Pœ√
 
∂
,

535 
ioff
,

536 
joff
)

538 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

539 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

541 
PixñPos
 
pix_b
, 
pix_c
;

543 
block_avaûabÀ_up
;

544 
block_avaûabÀ_up_right
;

546 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 , 
joff
 -1 , 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix_b
);

547 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 +4 , 
joff
 -1 , 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix_c
);

549 
pix_c
.
avaûabÀ
 =Öix_c.avaûabÀ && !((
ioff
==4Ë&& ((
joff
==4)||(joff==12)));

551 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

553 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_b.
mb_addr
] : 0;

554 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_c.
mb_addr
] : 0;

558 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

559 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
;

563 i‡(!
block_avaûabÀ_up
)

564 
	`¥ötf
 ("w¨nög: I¡ø_4x4_Vîtiˇl_Le·Öªdi˘i⁄ modênŸáŒowedáàmb %d\n", (Ë
cuºSli˚
->
cuºít_mb_ƒ
);

566 
img≥l
 
PªdPixñ
[10];

567 
img≥l
 
PªdPñ
[13];

568 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

569 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_¥ed[
∂
];

570 
img≥l
 *
¥ed_≥l
 = &
imgY
[
pix_b
.
pos_y
][pix_b.
pos_x
];

574 
	`mem˝y
(&
PªdPñ
[1], 
¥ed_≥l
, 
BLOCK_SIZE
 * (
img≥l
));

577 i‡(
block_avaûabÀ_up_right
)

579 
	`mem˝y
(&
PªdPñ
[5], &
imgY
[
pix_c
.
pos_y
][pix_c.
pos_x
], 
BLOCK_SIZE
 * (
img≥l
));

583 
P_E
 = 
P_F
 = 
P_G
 = 
P_H
 = 
P_D
;

586 
PªdPixñ
[0] = (
img≥l
Ë((
P_A
 + 
P_B
 + 1) >> 1);

587 
PªdPixñ
[1] = (
img≥l
Ë((
P_B
 + 
P_C
 + 1) >> 1);

588 
PªdPixñ
[2] = (
img≥l
Ë((
P_C
 + 
P_D
 + 1) >> 1);

589 
PªdPixñ
[3] = (
img≥l
Ë((
P_D
 + 
P_E
 + 1) >> 1);

590 
PªdPixñ
[4] = (
img≥l
Ë((
P_E
 + 
P_F
 + 1) >> 1);

591 
PªdPixñ
[5] = (
img≥l
Ë((
P_A
 + 2*
P_B
 + 
P_C
 + 2) >> 2);

592 
PªdPixñ
[6] = (
img≥l
Ë((
P_B
 + 2*
P_C
 + 
P_D
 + 2) >> 2);

593 
PªdPixñ
[7] = (
img≥l
Ë((
P_C
 + 2*
P_D
 + 
P_E
 + 2) >> 2);

594 
PªdPixñ
[8] = (
img≥l
Ë((
P_D
 + 2*
P_E
 + 
P_F
 + 2) >> 2);

595 
PªdPixñ
[9] = (
img≥l
Ë((
P_E
 + 2*
P_F
 + 
P_G
 + 2) >> 2);

597 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[0], 4 * (
img≥l
));

598 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[5], 4 * (
img≥l
));

599 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[1], 4 * (
img≥l
));

600 
	`mem˝y
(&
mb_¥ed
[
joff
 ][
ioff
], &
PªdPixñ
[6], 4 * (
img≥l
));

602  
DECODING_OK
;

603 
	}
}

615 
	$öåa4x4_h‹_up_¥ed_mbaff
(
Ma¸oblock
 *
cuºMB
,

616 
Cﬁ‹Pœ√
 
∂
,

617 
ioff
,

618 
joff
)

620 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

621 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

623 
i
;

624 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

626 
PixñPos
 
pix_a
[4];

628 
block_avaûabÀ_À·
;

630 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_¥ed[
∂
];

632 
i
=0;i<4;++i)

634 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 -1 , 
joff
 +
i
 , 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix_a
[i]);

637 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

639 
i
=0, 
block_avaûabÀ_À·
=1; i<4;++i)

640 
block_avaûabÀ_À·
 &
pix_a
[
i
].
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[pix_a[i].
mb_addr
]: 0;

644 
block_avaûabÀ_À·
 = 
pix_a
[0].
avaûabÀ
;

647 i‡(!
block_avaûabÀ_À·
)

648 
	`¥ötf
 ("w¨nög: I¡ø_4x4_H‹iz⁄èl_U∞¥edi˘i⁄ modênŸáŒowedáàmb %d\n",(Ë
cuºSli˚
->
cuºít_mb_ƒ
);

651 
img≥l
 
PªdPixñ
[10];

652 
img≥l
 
PªdPñ
[13];

655 
P_I
 = 
imgY
[
pix_a
[0].
pos_y
][pix_a[0].
pos_x
];

656 
P_J
 = 
imgY
[
pix_a
[1].
pos_y
][pix_a[1].
pos_x
];

657 
P_K
 = 
imgY
[
pix_a
[2].
pos_y
][pix_a[2].
pos_x
];

658 
P_L
 = 
imgY
[
pix_a
[3].
pos_y
][pix_a[3].
pos_x
];

660 
PªdPixñ
[0] = (
img≥l
Ë((
P_I
 + 
P_J
 + 1) >> 1);

661 
PªdPixñ
[1] = (
img≥l
Ë((
P_I
 + (
P_J
 << 1Ë+ 
P_K
 + 2) >> 2);

662 
PªdPixñ
[2] = (
img≥l
Ë((
P_J
 + 
P_K
 + 1) >> 1);

663 
PªdPixñ
[3] = (
img≥l
Ë((
P_J
 + (
P_K
 << 1Ë+ 
P_L
 + 2) >> 2);

664 
PªdPixñ
[4] = (
img≥l
Ë((
P_K
 + 
P_L
 + 1) >> 1);

665 
PªdPixñ
[5] = (
img≥l
Ë((
P_K
 + (
P_L
 << 1) + P_L + 2) >> 2);

666 
PªdPixñ
[6] = (
img≥l
Ë
P_L
;

667 
PªdPixñ
[7] = (
img≥l
Ë
P_L
;

668 
PªdPixñ
[8] = (
img≥l
Ë
P_L
;

669 
PªdPixñ
[9] = (
img≥l
Ë
P_L
;

671 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[0], 4 * (
img≥l
));

672 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[2], 4 * (
img≥l
));

673 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[4], 4 * (
img≥l
));

674 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[6], 4 * (
img≥l
));

677  
DECODING_OK
;

678 
	}
}

690 
	$öåa4x4_h‹_down_¥ed_mbaff
(
Ma¸oblock
 *
cuºMB
,

691 
Cﬁ‹Pœ√
 
∂
,

692 
ioff
,

693 
joff
)

695 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

696 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

698 
i
;

699 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

701 
PixñPos
 
pix_a
[4];

702 
PixñPos
 
pix_b
, 
pix_d
;

704 
block_avaûabÀ_up
;

705 
block_avaûabÀ_À·
;

706 
block_avaûabÀ_up_À·
;

708 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_¥ed[
∂
];

710 
i
=0;i<4;++i)

712 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 -1 , 
joff
 +
i
 , 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix_a
[i]);

715 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 , 
joff
 -1 , 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix_b
);

716 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 -1 , 
joff
 -1 , 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix_d
);

718 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

720 
i
=0, 
block_avaûabÀ_À·
=1; i<4;++i)

721 
block_avaûabÀ_À·
 &
pix_a
[
i
].
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[pix_a[i].
mb_addr
]: 0;

722 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_b.
mb_addr
] : 0;

723 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_d.
mb_addr
] : 0;

727 
block_avaûabÀ_À·
 = 
pix_a
[0].
avaûabÀ
;

728 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

729 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
;

732 i‡((!
block_avaûabÀ_up
)||(!
block_avaûabÀ_À·
)||(!
block_avaûabÀ_up_À·
))

733 
	`¥ötf
 ("w¨nög: I¡ø_4x4_H‹iz⁄èl_Dow¿¥edi˘i⁄ modênŸáŒowedáàmb %d\n", (Ë
cuºSli˚
->
cuºít_mb_ƒ
);

736 
img≥l
 
PªdPixñ
[10];

737 
img≥l
 
PªdPñ
[13];

738 
img≥l
 *
¥ed_≥l
 = &
imgY
[
pix_b
.
pos_y
][pix_b.
pos_x
];

742 
	`mem˝y
(&
PªdPñ
[1], 
¥ed_≥l
, 
BLOCK_SIZE
 * (
img≥l
));

744 
P_I
 = 
imgY
[
pix_a
[0].
pos_y
][pix_a[0].
pos_x
];

745 
P_J
 = 
imgY
[
pix_a
[1].
pos_y
][pix_a[1].
pos_x
];

746 
P_K
 = 
imgY
[
pix_a
[2].
pos_y
][pix_a[2].
pos_x
];

747 
P_L
 = 
imgY
[
pix_a
[3].
pos_y
][pix_a[3].
pos_x
];

749 
P_X
 = 
imgY
[
pix_d
.
pos_y
][pix_d.
pos_x
];

751 
PªdPixñ
[0] = (
img≥l
Ë((
P_K
 + 
P_L
 + 1) >> 1);

752 
PªdPixñ
[1] = (
img≥l
Ë((
P_J
 + (
P_K
 << 1Ë+ 
P_L
 + 2) >> 2);

753 
PªdPixñ
[2] = (
img≥l
Ë((
P_J
 + 
P_K
 + 1) >> 1);

754 
PªdPixñ
[3] = (
img≥l
Ë((
P_I
 + (
P_J
 << 1Ë+ 
P_K
 + 2) >> 2);

755 
PªdPixñ
[4] = (
img≥l
Ë((
P_I
 + 
P_J
 + 1) >> 1);

756 
PªdPixñ
[5] = (
img≥l
Ë((
P_X
 + (
P_I
 << 1Ë+ 
P_J
 + 2) >> 2);

757 
PªdPixñ
[6] = (
img≥l
Ë((
P_X
 + 
P_I
 + 1) >> 1);

758 
PªdPixñ
[7] = (
img≥l
Ë((
P_I
 + (
P_X
 << 1Ë+ 
P_A
 + 2) >> 2);

759 
PªdPixñ
[8] = (
img≥l
Ë((
P_X
 + 2*
P_A
 + 
P_B
 + 2) >> 2);

760 
PªdPixñ
[9] = (
img≥l
Ë((
P_A
 + 2*
P_B
 + 
P_C
 + 2) >> 2);

762 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[6], 4 * (
img≥l
));

763 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[4], 4 * (
img≥l
));

764 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[2], 4 * (
img≥l
));

765 
	`mem˝y
(&
mb_¥ed
[
joff
 ][
ioff
], &
PªdPixñ
[0], 4 * (
img≥l
));

768  
DECODING_OK
;

769 
	}
}

782 
	$öåa_¥ed_4x4_mbaff
(
Ma¸oblock
 *
cuºMB
,

783 
Cﬁ‹Pœ√
 
∂
,

784 
ioff
,

785 
joff
,

786 
img_block_x
,

787 
img_block_y
)

789 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

790 
byã
 
¥edmode
 = 
p_Vid
->
ùªdmode
[
img_block_y
][
img_block_x
];

791 
cuºMB
->
ùmode_DPCM
 = 
¥edmode
;

793 
¥edmode
)

795 
DC_PRED
:

796  (
	`öåa4x4_dc_¥ed_mbaff
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

798 
VERT_PRED
:

799  (
	`öåa4x4_vît_¥ed_mbaff
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

801 
HOR_PRED
:

802  (
	`öåa4x4_h‹_¥ed_mbaff
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

804 
DIAG_DOWN_RIGHT_PRED
:

805  (
	`öåa4x4_düg_down_right_¥ed_mbaff
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

807 
DIAG_DOWN_LEFT_PRED
:

808  (
	`öåa4x4_düg_down_À·_¥ed_mbaff
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

810 
VERT_RIGHT_PRED
:

811  (
	`öåa4x4_vît_right_¥ed_mbaff
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

813 
VERT_LEFT_PRED
:

814  (
	`öåa4x4_vît_À·_¥ed_mbaff
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

816 
HOR_UP_PRED
:

817  (
	`öåa4x4_h‹_up_¥ed_mbaff
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

819 
HOR_DOWN_PRED
:

820  (
	`öåa4x4_h‹_down_¥ed_mbaff
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

822 
	`¥ötf
("Eº‹: iŒegÆ i¡ø_4x4Öªdi˘i⁄ mode: %d\n", (Ë
¥edmode
);

823  
SEARCH_SYNC
;

826 
	}
}

	@ldecod/src/intra4x4_pred_normal.c

15 
	~"globÆ.h
"

16 
	~"öåa4x4_¥ed.h
"

17 
	~"mb_ac˚ss.h
"

18 
	~"image.h
"

49 
	$öåa4x4_dc_¥ed
(
Ma¸oblock
 *
cuºMB
,

50 
Cﬁ‹Pœ√
 
∂
,

51 
ioff
,

52 
joff
)

54 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

55 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

57 
j
;

58 
s0
 = 0;

59 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

60 
img≥l
 *
cuΩñ
 = 
NULL
;

62 
PixñPos
 
pix_a
, 
pix_b
;

64 
block_avaûabÀ_up
;

65 
block_avaûabÀ_À·
;

67 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_¥ed[
∂
];

69 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 , 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix_a
);

70 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 , 
joff
 -1, 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix_b
);

72 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

74 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_a.
mb_addr
] : 0;

75 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_b.
mb_addr
] : 0;

79 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
;

80 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

84 i‡(
block_avaûabÀ_up
)

86 
cuΩñ
 = &
imgY
[
pix_b
.
pos_y
][pix_b.
pos_x
];

87 
s0
 +*
cuΩñ
++;

88 
s0
 +*
cuΩñ
++;

89 
s0
 +*
cuΩñ
++;

90 
s0
 +*
cuΩñ
;

93 i‡(
block_avaûabÀ_À·
)

95 
img≥l
 **
img_¥ed
 = &
imgY
[
pix_a
.
pos_y
];

96 
pos_x
 = 
pix_a
.pos_x;

97 
s0
 +*(*(
img_¥ed
 ++Ë+ 
pos_x
);

98 
s0
 +*(*(
img_¥ed
 ++Ë+ 
pos_x
);

99 
s0
 +*(*(
img_¥ed
 ++Ë+ 
pos_x
);

100 
s0
 +*(*(
img_¥ed
 ) + 
pos_x
);

103 i‡(
block_avaûabÀ_up
 && 
block_avaûabÀ_À·
)

106 
s0
 = (s0 + 4)>>3;

108 i‡(!
block_avaûabÀ_up
 && 
block_avaûabÀ_À·
)

111 
s0
 = (s0 + 2)>>2;

113 i‡(
block_avaûabÀ_up
 && !
block_avaûabÀ_À·
)

116 
s0
 = (s0 + 2)>>2;

121 
s0
 = 
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

124 
j
=
joff
; j < jof‡+ 
BLOCK_SIZE
; ++j)

127 
mb_¥ed
[
j
][
ioff
 ] = (
img≥l
Ë
s0
;

128 
mb_¥ed
[
j
][
ioff
 + 1] = (
img≥l
Ë
s0
;

129 
mb_¥ed
[
j
][
ioff
 + 2] = (
img≥l
Ë
s0
;

130 
mb_¥ed
[
j
][
ioff
 + 3] = (
img≥l
Ë
s0
;

132  
DECODING_OK
;

133 
	}
}

145 
	$öåa4x4_vît_¥ed
(
Ma¸oblock
 *
cuºMB
,

146 
Cﬁ‹Pœ√
 
∂
,

147 
ioff
,

148 
joff
)

150 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

151 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

153 
block_avaûabÀ_up
;

154 
PixñPos
 
pix_b
;

156 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
, 
joff
 - 1 , 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix_b
);

158 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

160 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_b.
mb_addr
] : 0;

164 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

167 i‡(!
block_avaûabÀ_up
)

169 
	`¥ötf
 ("w¨nög: I¡ø_4x4_Vîtiˇ»¥edi˘i⁄ modênŸáŒowedáàmb %d\n", (Ë
cuºSli˚
->
cuºít_mb_ƒ
);

173 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_¥ed[
∂
];

174 
img≥l
 *
imgY
 = (
∂
Ë? &
cuºSli˚
->
dec_pi˘uª
->
imgUV
[∂ - 1][
pix_b
.
pos_y
][pix_b.
pos_x
] : &currSlice->dec_picture->imgY[pix_b.pos_y][pix_b.pos_x];

175 
	`mem˝y
(&(
mb_¥ed
[
joff
++][
ioff
]), 
imgY
, 
BLOCK_SIZE
 * (
img≥l
));

176 
	`mem˝y
(&(
mb_¥ed
[
joff
++][
ioff
]), 
imgY
, 
BLOCK_SIZE
 * (
img≥l
));

177 
	`mem˝y
(&(
mb_¥ed
[
joff
++][
ioff
]), 
imgY
, 
BLOCK_SIZE
 * (
img≥l
));

178 
	`mem˝y
(&(
mb_¥ed
[
joff
 ][
ioff
]), 
imgY
, 
BLOCK_SIZE
 * (
img≥l
));

180  
DECODING_OK
;

181 
	}
}

202 
	$öåa4x4_h‹_¥ed
(
Ma¸oblock
 *
cuºMB
,

203 
Cﬁ‹Pœ√
 
∂
,

204 
ioff
,

205 
joff
)

207 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

208 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

210 
PixñPos
 
pix_a
;

212 
block_avaûabÀ_À·
;

214 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 - 1 , 
joff
, 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix_a
);

216 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

218 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[pix_a.
mb_addr
]: 0;

222 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
;

225 i‡(!
block_avaûabÀ_À·
)

226 
	`¥ötf
 ("w¨nög: I¡ø_4x4_H‹iz⁄è»¥edi˘i⁄ modênŸáŒowedáàmb %d\n",(Ë
cuºSli˚
->
cuºít_mb_ƒ
);

228 #i‡(
IMGTYPE
 == 0)

230 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

231 
img≥l
 **
mb_¥ed
 = &
cuºSli˚
->mb_¥ed[
∂
][
joff
];

232 
img≥l
 **
img_¥ed
 = &
imgY
[
pix_a
.
pos_y
];

233 
pos_x
 = 
pix_a
.pos_x;

235 
	`mem£t
((*(
mb_¥ed
++Ë+ 
ioff
), *(*(
img_¥ed
++Ë+ 
pos_x
), 
BLOCK_SIZE
 *  (
img≥l
));

236 
	`mem£t
((*(
mb_¥ed
++Ë+ 
ioff
), *(*(
img_¥ed
++Ë+ 
pos_x
), 
BLOCK_SIZE
 *  (
img≥l
));

237 
	`mem£t
((*(
mb_¥ed
++Ë+ 
ioff
), *(*(
img_¥ed
++Ë+ 
pos_x
), 
BLOCK_SIZE
 *  (
img≥l
));

238 
	`mem£t
((*(
mb_¥ed
 ) + 
ioff
), *(*(
img_¥ed
 ) + 
pos_x
), 
BLOCK_SIZE
 *  (
img≥l
));

242 
j
;

243 
pos_y
 = 
pix_a
.pos_y;

244 
pos_x
 = 
pix_a
.pos_x;

245 
img≥l
 *
¥edrow
, 
¥edi˘i⁄
;

246 
img≥l
 **
mb_¥ed
 = &
cuºSli˚
->mb_¥ed[
∂
][
joff
];

247 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

249 
j
=0;j<
BLOCK_SIZE
;++j)

251 
¥edrow
 = 
mb_¥ed
[
j
];

252 
¥edi˘i⁄
 = 
imgY
[
pos_y
++][
pos_x
];

254 
¥edrow
[
ioff
 ]
¥edi˘i⁄
;

255 
¥edrow
[
ioff
 + 1]
¥edi˘i⁄
;

256 
¥edrow
[
ioff
 + 2]
¥edi˘i⁄
;

257 
¥edrow
[
ioff
 + 3]
¥edi˘i⁄
;

262  
DECODING_OK
;

263 
	}
}

275 
	$öåa4x4_düg_down_right_¥ed
(
Ma¸oblock
 *
cuºMB
,

276 
Cﬁ‹Pœ√
 
∂
,

277 
ioff
,

278 
joff
)

280 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

281 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

283 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

285 
PixñPos
 
pix_a
;

286 
PixñPos
 
pix_b
, 
pix_d
;

288 
block_avaûabÀ_up
;

289 
block_avaûabÀ_À·
;

290 
block_avaûabÀ_up_À·
;

292 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_¥ed[
∂
];

294 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 -1 , 
joff
 , 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix_a
);

295 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 , 
joff
 -1 , 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix_b
);

296 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 -1 , 
joff
 -1 , 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix_d
);

298 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

300 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_a.
mb_addr
]: 0;

301 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_b.
mb_addr
] : 0;

302 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_d.
mb_addr
] : 0;

306 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
;

307 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

308 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
;

311 i‡((!
block_avaûabÀ_up
)||(!
block_avaûabÀ_À·
)||(!
block_avaûabÀ_up_À·
))

312 
	`¥ötf
 ("w¨nög: I¡ø_4x4_Düg⁄Æ_Down_Righà¥edi˘i⁄ modênŸáŒowedáàmb %d\n",(Ë
cuºSli˚
->
cuºít_mb_ƒ
);

315 
img≥l
 
PªdPixñ
[7];

316 
img≥l
 **
img_¥ed
 = &
imgY
[
pix_a
.
pos_y
];

317 
pix_x
 = 
pix_a
.
pos_x
;

318 
img≥l
 *
¥ed_≥l
 = &
imgY
[
pix_b
.
pos_y
][pix_b.
pos_x
];

320 
img≥l
 
p_a
 = *
¥ed_≥l
++;

321 
img≥l
 
p_b
 = *
¥ed_≥l
++;

322 
img≥l
 
p_c
 = *
¥ed_≥l
++;

323 
img≥l
 
p_d
 = *
¥ed_≥l
 ;

325 
img≥l
 
p_i
 = *(*(
img_¥ed
++Ë+ 
pix_x
);

326 
img≥l
 
p_j
 = *(*(
img_¥ed
++Ë+ 
pix_x
);

327 
img≥l
 
p_k
 = *(*(
img_¥ed
++Ë+ 
pix_x
);

328 
img≥l
 
p_l
 = *(*(
img_¥ed
 ) + 
pix_x
);

330 
img≥l
 
p_x
 = 
imgY
[
pix_d
.
pos_y
][pix_d.
pos_x
];

332 
PªdPixñ
[0] = (
img≥l
Ë((
p_l
 + 2*
p_k
 + 
p_j
 + 2) >> 2);

333 
PªdPixñ
[1] = (
img≥l
Ë((
p_k
 + 2*
p_j
 + 
p_i
 + 2) >> 2);

334 
PªdPixñ
[2] = (
img≥l
Ë((
p_j
 + 2*
p_i
 + 
p_x
 + 2) >> 2);

335 
PªdPixñ
[3] = (
img≥l
Ë((
p_i
 + 2*
p_x
 + 
p_a
 + 2) >> 2);

336 
PªdPixñ
[4] = (
img≥l
Ë((
p_x
 + 2*
p_a
 + 
p_b
 + 2) >> 2);

337 
PªdPixñ
[5] = (
img≥l
Ë((
p_a
 + 2*
p_b
 + 
p_c
 + 2) >> 2);

338 
PªdPixñ
[6] = (
img≥l
Ë((
p_b
 + 2*
p_c
 + 
p_d
 + 2) >> 2);

340 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[3], 4 * (
img≥l
));

341 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[2], 4 * (
img≥l
));

342 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[1], 4 * (
img≥l
));

343 
	`mem˝y
(&
mb_¥ed
[
joff
 ][
ioff
], &
PªdPixñ
[0], 4 * (
img≥l
));

346  
DECODING_OK
;

347 
	}
}

359 
	$öåa4x4_düg_down_À·_¥ed
(
Ma¸oblock
 *
cuºMB
,

360 
Cﬁ‹Pœ√
 
∂
,

361 
ioff
,

362 
joff
)

364 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

365 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

367 
PixñPos
 
pix_b
, 
pix_c
;

369 
block_avaûabÀ_up
;

370 
block_avaûabÀ_up_right
;

372 
p_Vid
->
	`gëNeighbour
(
cuºMB
, 
ioff
 , 
joff
 - 1,Ö_Vid->
mb_size
[
IS_LUMA
], &
pix_b
);

373 
p_Vid
->
	`gëNeighbour
(
cuºMB
, 
ioff
 + 4, 
joff
 - 1,Ö_Vid->
mb_size
[
IS_LUMA
], &
pix_c
);

375 
pix_c
.
avaûabÀ
 =Öix_c.avaûabÀ && !((
ioff
==4Ë&& ((
joff
==4)||(joff==12)));

377 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

379 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_b.
mb_addr
] : 0;

380 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_c.
mb_addr
] : 0;

384 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

385 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
;

388 i‡(!
block_avaûabÀ_up
)

389 
	`¥ötf
 ("w¨nög: I¡ø_4x4_Düg⁄Æ_Down_Le·Öªdi˘i⁄ modênŸáŒowedáàmb %d\n", (Ë
cuºSli˚
->
cuºít_mb_ƒ
);

392 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

393 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_¥ed[
∂
];

395 
img≥l
 
p_e
, 
p_f
, 
p_g
, 
p_h
;

396 
img≥l
 
PªdPixñ
[8];

397 
img≥l
 *
¥ed_≥l
 = &
imgY
[
pix_b
.
pos_y
][pix_b.
pos_x
];

400 
img≥l
 
p_a
 = *
¥ed_≥l
++;

401 
img≥l
 
p_b
 = *
¥ed_≥l
++;

402 
img≥l
 
p_c
 = *
¥ed_≥l
++;

403 
img≥l
 
p_d
 = *
¥ed_≥l
 ;

405 i‡(
block_avaûabÀ_up_right
)

407 
¥ed_≥l
 = &
imgY
[
pix_c
.
pos_y
][pix_c.
pos_x
];

408 
p_e
 = *
¥ed_≥l
++;

409 
p_f
 = *
¥ed_≥l
++;

410 
p_g
 = *
¥ed_≥l
++;

411 
p_h
 = *
¥ed_≥l
 ;

415 
p_e
 = 
p_f
 = 
p_g
 = 
p_h
 = 
p_d
;

418 
PªdPixñ
[0] = (
img≥l
Ë((
p_a
 + 
p_c
 + 2*(
p_b
) + 2) >> 2);

419 
PªdPixñ
[1] = (
img≥l
Ë((
p_b
 + 
p_d
 + 2*(
p_c
) + 2) >> 2);

420 
PªdPixñ
[2] = (
img≥l
Ë((
p_c
 + 
p_e
 + 2*(
p_d
) + 2) >> 2);

421 
PªdPixñ
[3] = (
img≥l
Ë((
p_d
 + 
p_f
 + 2*(
p_e
) + 2) >> 2);

422 
PªdPixñ
[4] = (
img≥l
Ë((
p_e
 + 
p_g
 + 2*(
p_f
) + 2) >> 2);

423 
PªdPixñ
[5] = (
img≥l
Ë((
p_f
 + 
p_h
 + 2*(
p_g
) + 2) >> 2);

424 
PªdPixñ
[6] = (
img≥l
Ë((
p_g
 + 3*(
p_h
) + 2) >> 2);

426 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[0], 4 * (
img≥l
));

427 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[1], 4 * (
img≥l
));

428 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[2], 4 * (
img≥l
));

429 
	`mem˝y
(&
mb_¥ed
[
joff
 ][
ioff
], &
PªdPixñ
[3], 4 * (
img≥l
));

432  
DECODING_OK
;

433 
	}
}

445 
	$öåa4x4_vît_right_¥ed
(
Ma¸oblock
 *
cuºMB
,

446 
Cﬁ‹Pœ√
 
∂
,

447 
ioff
,

448 
joff
)

450 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

451 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

453 
PixñPos
 
pix_a
, 
pix_b
, 
pix_d
;

455 
block_avaûabÀ_up
;

456 
block_avaûabÀ_À·
;

457 
block_avaûabÀ_up_À·
;

459 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 -1 , 
joff
 , 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix_a
);

460 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 , 
joff
 -1 , 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix_b
);

461 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 -1 , 
joff
 -1 , 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix_d
);

463 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

465 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[pix_a.
mb_addr
]: 0;

466 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_b.
mb_addr
] : 0;

467 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_d.
mb_addr
] : 0;

471 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
;

472 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

473 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
;

476 i‡((!
block_avaûabÀ_up
)||(!
block_avaûabÀ_À·
)||(!
block_avaûabÀ_up_À·
))

477 
	`¥ötf
 ("w¨nög: I¡ø_4x4_Vîtiˇl_Righà¥edi˘i⁄ modênŸáŒowedáàmb %d\n", (Ë
cuºSli˚
->
cuºít_mb_ƒ
);

479 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

480 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_¥ed[
∂
];

481 
img≥l
 
PªdPixñ
[10];

483 
img≥l
 **
img_¥ed
 = &
imgY
[
pix_a
.
pos_y
];

484 
pix_x
 = 
pix_a
.
pos_x
;

485 
img≥l
 *
¥ed_≥l
 = &
imgY
[
pix_b
.
pos_y
][pix_b.
pos_x
];

487 
img≥l
 
p_a
 = *
¥ed_≥l
++;

488 
img≥l
 
p_b
 = *
¥ed_≥l
++;

489 
img≥l
 
p_c
 = *
¥ed_≥l
++;

490 
img≥l
 
p_d
 = *
¥ed_≥l
 ;

492 
img≥l
 
p_i
 = *(*(
img_¥ed
++Ë+ 
pix_x
);

493 
img≥l
 
p_j
 = *(*(
img_¥ed
++Ë+ 
pix_x
);

494 
img≥l
 
p_k
 = *(*(
img_¥ed
++Ë+ 
pix_x
);

496 
img≥l
 
p_x
 = 
imgY
[
pix_d
.
pos_y
][pix_d.
pos_x
];

498 
PªdPixñ
[0] = (
img≥l
Ë((
p_x
 + 2*
p_i
 + 
p_j
 + 2) >> 2);

499 
PªdPixñ
[1] = (
img≥l
Ë((
p_x
 + 
p_a
 + 1) >> 1);

500 
PªdPixñ
[2] = (
img≥l
Ë((
p_a
 + 
p_b
 + 1) >> 1);

501 
PªdPixñ
[3] = (
img≥l
Ë((
p_b
 + 
p_c
 + 1) >> 1);

502 
PªdPixñ
[4] = (
img≥l
Ë((
p_c
 + 
p_d
 + 1) >> 1);

503 
PªdPixñ
[5] = (
img≥l
Ë((
p_i
 + 2*
p_j
 + 
p_k
 + 2) >> 2);

504 
PªdPixñ
[6] = (
img≥l
Ë((
p_i
 + 2*
p_x
 + 
p_a
 + 2) >> 2);

505 
PªdPixñ
[7] = (
img≥l
Ë((
p_x
 + 2*
p_a
 + 
p_b
 + 2) >> 2);

506 
PªdPixñ
[8] = (
img≥l
Ë((
p_a
 + 2*
p_b
 + 
p_c
 + 2) >> 2);

507 
PªdPixñ
[9] = (
img≥l
Ë((
p_b
 + 2*
p_c
 + 
p_d
 + 2) >> 2);

509 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[1], 4 * (
img≥l
));

510 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[6], 4 * (
img≥l
));

511 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[0], 4 * (
img≥l
));

512 
	`mem˝y
(&
mb_¥ed
[
joff
 ][
ioff
], &
PªdPixñ
[5], 4 * (
img≥l
));

516  
DECODING_OK
;

517 
	}
}

530 
	$öåa4x4_vît_À·_¥ed
(
Ma¸oblock
 *
cuºMB
,

531 
Cﬁ‹Pœ√
 
∂
,

532 
ioff
,

533 
joff
)

535 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

536 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

538 
PixñPos
 
pix_b
, 
pix_c
;

540 
block_avaûabÀ_up
;

541 
block_avaûabÀ_up_right
;

543 
p_Vid
->
	`gëNeighbour
(
cuºMB
, 
ioff
 , 
joff
 -1 ,Ö_Vid->
mb_size
[
IS_LUMA
], &
pix_b
);

544 
p_Vid
->
	`gëNeighbour
(
cuºMB
, 
ioff
 +4 , 
joff
 -1 ,Ö_Vid->
mb_size
[
IS_LUMA
], &
pix_c
);

546 
pix_c
.
avaûabÀ
 =Öix_c.avaûabÀ && !((
ioff
==4Ë&& ((
joff
==4)||(joff==12)));

548 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

550 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_b.
mb_addr
] : 0;

551 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_c.
mb_addr
] : 0;

555 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

556 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
;

560 i‡(!
block_avaûabÀ_up
)

561 
	`¥ötf
 ("w¨nög: I¡ø_4x4_Vîtiˇl_Le·Öªdi˘i⁄ modênŸáŒowedáàmb %d\n", (Ë
cuºSli˚
->
cuºít_mb_ƒ
);

563 
img≥l
 
PªdPixñ
[10];

564 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

565 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_¥ed[
∂
];

566 
img≥l
 *
¥ed_≥l
 = &
imgY
[
pix_b
.
pos_y
][pix_b.
pos_x
];

569 
img≥l
 
p_a
 = *
¥ed_≥l
++;

570 
img≥l
 
p_b
 = *
¥ed_≥l
++;

571 
img≥l
 
p_c
 = *
¥ed_≥l
++;

572 
img≥l
 
p_d
 = *
¥ed_≥l
 ;

573 
img≥l
 
p_e
, 
p_f
, 
p_g
;

575 i‡(
block_avaûabÀ_up_right
)

577 
img≥l
 *
¥ed_≥l
 = &
imgY
[
pix_c
.
pos_y
][pix_c.
pos_x
];

578 
p_e
 = *
¥ed_≥l
++;

579 
p_f
 = *
¥ed_≥l
++;

580 
p_g
 = *
¥ed_≥l
++;

584 
p_e
 = 
p_f
 = 
p_g
 = 
p_d
;

587 
PªdPixñ
[0] = (
img≥l
Ë((
p_a
 + 
p_b
 + 1) >> 1);

588 
PªdPixñ
[1] = (
img≥l
Ë((
p_b
 + 
p_c
 + 1) >> 1);

589 
PªdPixñ
[2] = (
img≥l
Ë((
p_c
 + 
p_d
 + 1) >> 1);

590 
PªdPixñ
[3] = (
img≥l
Ë((
p_d
 + 
p_e
 + 1) >> 1);

591 
PªdPixñ
[4] = (
img≥l
Ë((
p_e
 + 
p_f
 + 1) >> 1);

592 
PªdPixñ
[5] = (
img≥l
Ë((
p_a
 + 2*
p_b
 + 
p_c
 + 2) >> 2);

593 
PªdPixñ
[6] = (
img≥l
Ë((
p_b
 + 2*
p_c
 + 
p_d
 + 2) >> 2);

594 
PªdPixñ
[7] = (
img≥l
Ë((
p_c
 + 2*
p_d
 + 
p_e
 + 2) >> 2);

595 
PªdPixñ
[8] = (
img≥l
Ë((
p_d
 + 2*
p_e
 + 
p_f
 + 2) >> 2);

596 
PªdPixñ
[9] = (
img≥l
Ë((
p_e
 + 2*
p_f
 + 
p_g
 + 2) >> 2);

598 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[0], 4 * (
img≥l
));

599 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[5], 4 * (
img≥l
));

600 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[1], 4 * (
img≥l
));

601 
	`mem˝y
(&
mb_¥ed
[
joff
 ][
ioff
], &
PªdPixñ
[6], 4 * (
img≥l
));

603  
DECODING_OK
;

604 
	}
}

616 
	$öåa4x4_h‹_up_¥ed
(
Ma¸oblock
 *
cuºMB
,

617 
Cﬁ‹Pœ√
 
∂
,

618 
ioff
,

619 
joff
)

621 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

622 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

624 
PixñPos
 
pix_a
;

626 
block_avaûabÀ_À·
;

628 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 -1 , 
joff
, 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix_a
);

630 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

632 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[pix_a.
mb_addr
]: 0;

636 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
;

639 i‡(!
block_avaûabÀ_À·
)

640 
	`¥ötf
 ("w¨nög: I¡ø_4x4_H‹iz⁄èl_U∞¥edi˘i⁄ modênŸáŒowedáàmb %d\n",(Ë
cuºSli˚
->
cuºít_mb_ƒ
);

643 
img≥l
 
PªdPixñ
[10];

644 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

645 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_¥ed[
∂
];

647 
img≥l
 **
img_¥ed
 = &
imgY
[
pix_a
.
pos_y
];

648 
pix_x
 = 
pix_a
.
pos_x
;

651 
img≥l
 
p_i
 = *(*(
img_¥ed
++Ë+ 
pix_x
);

652 
img≥l
 
p_j
 = *(*(
img_¥ed
++Ë+ 
pix_x
);

653 
img≥l
 
p_k
 = *(*(
img_¥ed
++Ë+ 
pix_x
);

654 
img≥l
 
p_l
 = *(*(
img_¥ed
 ) + 
pix_x
);

656 
PªdPixñ
[0] = (
img≥l
Ë((
p_i
 + 
p_j
 + 1) >> 1);

657 
PªdPixñ
[1] = (
img≥l
Ë((
p_i
 + 2*
p_j
 + 
p_k
 + 2) >> 2);

658 
PªdPixñ
[2] = (
img≥l
Ë((
p_j
 + 
p_k
 + 1) >> 1);

659 
PªdPixñ
[3] = (
img≥l
Ë((
p_j
 + 2*
p_k
 + 
p_l
 + 2) >> 2);

660 
PªdPixñ
[4] = (
img≥l
Ë((
p_k
 + 
p_l
 + 1) >> 1);

661 
PªdPixñ
[5] = (
img≥l
Ë((
p_k
 + 2*
p_l
 +Ö_l + 2) >> 2);

662 
PªdPixñ
[6] = (
img≥l
Ë
p_l
;

663 
PªdPixñ
[7] = (
img≥l
Ë
p_l
;

664 
PªdPixñ
[8] = (
img≥l
Ë
p_l
;

665 
PªdPixñ
[9] = (
img≥l
Ë
p_l
;

667 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[0], 4 * (
img≥l
));

668 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[2], 4 * (
img≥l
));

669 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[4], 4 * (
img≥l
));

670 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[6], 4 * (
img≥l
));

673  
DECODING_OK
;

674 
	}
}

686 
	$öåa4x4_h‹_down_¥ed
(
Ma¸oblock
 *
cuºMB
,

687 
Cﬁ‹Pœ√
 
∂
,

688 
ioff
,

689 
joff
)

691 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

692 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

694 
PixñPos
 
pix_a
, 
pix_b
, 
pix_d
;

696 
block_avaûabÀ_up
;

697 
block_avaûabÀ_À·
;

698 
block_avaûabÀ_up_À·
;

700 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 -1 , 
joff
 , 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix_a
);

701 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 , 
joff
 -1 , 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix_b
);

702 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 -1 , 
joff
 -1 , 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix_d
);

704 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

706 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_a.
mb_addr
]: 0;

707 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_b.
mb_addr
] : 0;

708 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_d.
mb_addr
] : 0;

712 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
;

713 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

714 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
;

717 i‡((!
block_avaûabÀ_up
)||(!
block_avaûabÀ_À·
)||(!
block_avaûabÀ_up_À·
))

718 
	`¥ötf
 ("w¨nög: I¡ø_4x4_H‹iz⁄èl_Dow¿¥edi˘i⁄ modênŸáŒowedáàmb %d\n", (Ë
cuºSli˚
->
cuºít_mb_ƒ
);

721 
img≥l
 
PªdPixñ
[10];

722 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

723 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_¥ed[
∂
];

725 
img≥l
 **
img_¥ed
 = &
imgY
[
pix_a
.
pos_y
];

726 
pix_x
 = 
pix_a
.
pos_x
;

727 
img≥l
 *
¥ed_≥l
 = &
imgY
[
pix_b
.
pos_y
][pix_b.
pos_x
];

730 
img≥l
 
p_a
 = *
¥ed_≥l
++;

731 
img≥l
 
p_b
 = *
¥ed_≥l
++;

732 
img≥l
 
p_c
 = *
¥ed_≥l
++;

734 
img≥l
 
p_i
 = *(*(
img_¥ed
++Ë+ 
pix_x
);

735 
img≥l
 
p_j
 = *(*(
img_¥ed
++Ë+ 
pix_x
);

736 
img≥l
 
p_k
 = *(*(
img_¥ed
++Ë+ 
pix_x
);

737 
img≥l
 
p_l
 = *(*(
img_¥ed
 ) + 
pix_x
);

739 
img≥l
 
p_x
 = 
imgY
[
pix_d
.
pos_y
][pix_d.
pos_x
];

741 
PªdPixñ
[0] = (
img≥l
Ë((
p_k
 + 
p_l
 + 1) >> 1);

742 
PªdPixñ
[1] = (
img≥l
Ë((
p_j
 + 2*
p_k
 + 
p_l
 + 2) >> 2);

743 
PªdPixñ
[2] = (
img≥l
Ë((
p_j
 + 
p_k
 + 1) >> 1);

744 
PªdPixñ
[3] = (
img≥l
Ë((
p_i
 + 2*
p_j
 + 
p_k
 + 2) >> 2);

745 
PªdPixñ
[4] = (
img≥l
Ë((
p_i
 + 
p_j
 + 1) >> 1);

746 
PªdPixñ
[5] = (
img≥l
Ë((
p_x
 + 2*
p_i
 + 
p_j
 + 2) >> 2);

747 
PªdPixñ
[6] = (
img≥l
Ë((
p_x
 + 
p_i
 + 1) >> 1);

748 
PªdPixñ
[7] = (
img≥l
Ë((
p_i
 + 2*
p_x
 + 
p_a
 + 2) >> 2);

749 
PªdPixñ
[8] = (
img≥l
Ë((
p_x
 + 2*
p_a
 + 
p_b
 + 2) >> 2);

750 
PªdPixñ
[9] = (
img≥l
Ë((
p_a
 + 2*
p_b
 + 
p_c
 + 2) >> 2);

752 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[6], 4 * (
img≥l
));

753 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[4], 4 * (
img≥l
));

754 
	`mem˝y
(&
mb_¥ed
[
joff
++][
ioff
], &
PªdPixñ
[2], 4 * (
img≥l
));

755 
	`mem˝y
(&
mb_¥ed
[
joff
 ][
ioff
], &
PªdPixñ
[0], 4 * (
img≥l
));

758  
DECODING_OK
;

759 
	}
}

772 
	$öåa4x4_¥ed_n‹mÆ
(
Ma¸oblock
 *
cuºMB
,

773 
Cﬁ‹Pœ√
 
∂
,

774 
ioff
,

775 
joff
,

776 
img_block_x
,

777 
img_block_y
)

779 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

780 
byã
 
¥edmode
 = 
p_Vid
->
ùªdmode
[
img_block_y
][
img_block_x
];

781 
cuºMB
->
ùmode_DPCM
 = 
¥edmode
;

783 
¥edmode
)

785 
DC_PRED
:

786  (
	`öåa4x4_dc_¥ed
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

788 
VERT_PRED
:

789  (
	`öåa4x4_vît_¥ed
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

791 
HOR_PRED
:

792  (
	`öåa4x4_h‹_¥ed
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

794 
DIAG_DOWN_RIGHT_PRED
:

795  (
	`öåa4x4_düg_down_right_¥ed
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

797 
DIAG_DOWN_LEFT_PRED
:

798  (
	`öåa4x4_düg_down_À·_¥ed
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

800 
VERT_RIGHT_PRED
:

801  (
	`öåa4x4_vît_right_¥ed
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

803 
VERT_LEFT_PRED
:

804  (
	`öåa4x4_vît_À·_¥ed
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

806 
HOR_UP_PRED
:

807  (
	`öåa4x4_h‹_up_¥ed
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

809 
HOR_DOWN_PRED
:

810  (
	`öåa4x4_h‹_down_¥ed
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

812 
	`¥ötf
("Eº‹: iŒegÆ i¡ø_4x4Öªdi˘i⁄ mode: %d\n", (Ë
¥edmode
);

813  
SEARCH_SYNC
;

816 
	}
}

	@ldecod/src/intra8x8_pred.c

17 
	~"globÆ.h
"

18 
	~"öåa8x8_¥ed.h
"

19 
	~"mb_ac˚ss.h
"

20 
	~"image.h
"

38 
	#P_Z
 (
PªdPñ
[0])

	)

39 
	#P_A
 (
PªdPñ
[1])

	)

40 
	#P_B
 (
PªdPñ
[2])

	)

41 
	#P_C
 (
PªdPñ
[3])

	)

42 
	#P_D
 (
PªdPñ
[4])

	)

43 
	#P_E
 (
PªdPñ
[5])

	)

44 
	#P_F
 (
PªdPñ
[6])

	)

45 
	#P_G
 (
PªdPñ
[7])

	)

46 
	#P_H
 (
PªdPñ
[8])

	)

47 
	#P_I
 (
PªdPñ
[9])

	)

48 
	#P_J
 (
PªdPñ
[10])

	)

49 
	#P_K
 (
PªdPñ
[11])

	)

50 
	#P_L
 (
PªdPñ
[12])

	)

51 
	#P_M
 (
PªdPñ
[13])

	)

52 
	#P_N
 (
PªdPñ
[14])

	)

53 
	#P_O
 (
PªdPñ
[15])

	)

54 
	#P_P
 (
PªdPñ
[16])

	)

55 
	#P_Q
 (
PªdPñ
[17])

	)

56 
	#P_R
 (
PªdPñ
[18])

	)

57 
	#P_S
 (
PªdPñ
[19])

	)

58 
	#P_T
 (
PªdPñ
[20])

	)

59 
	#P_U
 (
PªdPñ
[21])

	)

60 
	#P_V
 (
PªdPñ
[22])

	)

61 
	#P_W
 (
PªdPñ
[23])

	)

62 
	#P_X
 (
PªdPñ
[24])

	)

70 
ölöe
 
	$LowPassF‹I¡ø8x8Pªd
(
img≥l
 *
PªdPñ
, 
block_up_À·
, 
block_up
, 
block_À·
)

72 
i
;

73 
img≥l
 
Lo›Aºay
[25];

75 
	`mem˝y
(&
Lo›Aºay
[0], &
PªdPñ
[0], 25 * (
img≥l
));

77 if(
block_up_À·
)

79 if(
block_up
 && 
block_À·
)

81 
Lo›Aºay
[0] = (
img≥l
Ë((
P_Q
 + (
P_Z
<<1Ë+ 
P_A
 + 2)>>2);

85 if(
block_up
)

86 
Lo›Aºay
[0] = (
img≥l
Ë((
P_Z
 + (P_Z<<1Ë+ 
P_A
 + 2)>>2);

87 i‡(
block_À·
)

88 
Lo›Aºay
[0] = (
img≥l
Ë((
P_Z
 + (P_Z<<1Ë+ 
P_Q
 + 2)>>2);

92 if(
block_up
)

94 if(
block_up_À·
)

96 
Lo›Aºay
[1] = (
img≥l
Ë((
PªdPñ
[0] + (PredPel[1]<<1) + PredPel[2] + 2)>>2);

99 
Lo›Aºay
[1] = (
img≥l
Ë((
PªdPñ
[1] + (PredPel[1]<<1) + PredPel[2] + 2)>>2);

102 
i
 = 2; i <16; i++)

104 
Lo›Aºay
[
i
] = (
img≥l
Ë((
PªdPñ
[i-1] + (PredPel[i]<<1) + PredPel[i+1] + 2)>>2);

106 
Lo›Aºay
[16] = (
img≥l
Ë((
P_P
 + (P_P<<1Ë+ 
P_O
 + 2)>>2);

109 if(
block_À·
)

111 if(
block_up_À·
)

112 
Lo›Aºay
[17] = (
img≥l
Ë((
P_Z
 + (
P_Q
<<1Ë+ 
P_R
 + 2)>>2);

114 
Lo›Aºay
[17] = (
img≥l
Ë((
P_Q
 + (P_Q<<1Ë+ 
P_R
 + 2)>>2);

116 
i
 = 18; i <24; i++)

118 
Lo›Aºay
[
i
] = (
img≥l
Ë((
PªdPñ
[i-1] + (PredPel[i]<<1) + PredPel[i+1] + 2)>>2);

120 
Lo›Aºay
[24] = (
img≥l
Ë((
P_W
 + (
P_X
<<1) + P_X + 2) >> 2);

123 
	`mem˝y
(&
PªdPñ
[0], &
Lo›Aºay
[0], 25 * (
img≥l
));

124 
	}
}

132 
ölöe
 
	$LowPassF‹I¡ø8x8PªdH‹
(
img≥l
 *
PªdPñ
, 
block_up_À·
, 
block_up
, 
block_À·
)

134 
i
;

135 
img≥l
 
Lo›Aºay
[25];

137 
	`mem˝y
(&
Lo›Aºay
[0], &
PªdPñ
[0], 25 * (
img≥l
));

139 if(
block_up_À·
)

141 if(
block_up
 && 
block_À·
)

143 
Lo›Aºay
[0] = (
img≥l
Ë((
P_Q
 + (
P_Z
<<1Ë+ 
P_A
 + 2)>>2);

147 if(
block_up
)

148 
Lo›Aºay
[0] = (
img≥l
Ë((
P_Z
 + (P_Z<<1Ë+ 
P_A
 + 2)>>2);

149 i‡(
block_À·
)

150 
Lo›Aºay
[0] = (
img≥l
Ë((
P_Z
 + (P_Z<<1Ë+ 
P_Q
 + 2)>>2);

154 if(
block_up
)

156 if(
block_up_À·
)

158 
Lo›Aºay
[1] = (
img≥l
Ë((
PªdPñ
[0] + (PredPel[1]<<1) + PredPel[2] + 2)>>2);

161 
Lo›Aºay
[1] = (
img≥l
Ë((
PªdPñ
[1] + (PredPel[1]<<1) + PredPel[2] + 2)>>2);

164 
i
 = 2; i <16; i++)

166 
Lo›Aºay
[
i
] = (
img≥l
Ë((
PªdPñ
[i-1] + (PredPel[i]<<1) + PredPel[i+1] + 2)>>2);

168 
Lo›Aºay
[16] = (
img≥l
Ë((
P_P
 + (P_P<<1Ë+ 
P_O
 + 2)>>2);

172 
	`mem˝y
(&
PªdPñ
[0], &
Lo›Aºay
[0], 17 * (
img≥l
));

173 
	}
}

181 
ölöe
 
	$LowPassF‹I¡ø8x8PªdVî
(
img≥l
 *
PªdPñ
, 
block_up_À·
, 
block_up
, 
block_À·
)

185 
i
;

186 
img≥l
 
Lo›Aºay
[25];

188 
	`mem˝y
(&
Lo›Aºay
[0], &
PªdPñ
[0], 25 * (
img≥l
));

190 if(
block_up_À·
)

192 if(
block_up
 && 
block_À·
)

194 
Lo›Aºay
[0] = (
img≥l
Ë((
P_Q
 + (
P_Z
<<1Ë+ 
P_A
 + 2)>>2);

198 if(
block_up
)

199 
Lo›Aºay
[0] = (
img≥l
Ë((
P_Z
 + (P_Z<<1Ë+ 
P_A
 + 2)>>2);

200 i‡(
block_À·
)

201 
Lo›Aºay
[0] = (
img≥l
Ë((
P_Z
 + (P_Z<<1Ë+ 
P_Q
 + 2)>>2);

205 if(
block_À·
)

207 if(
block_up_À·
)

208 
Lo›Aºay
[17] = (
img≥l
Ë((
P_Z
 + (
P_Q
<<1Ë+ 
P_R
 + 2)>>2);

210 
Lo›Aºay
[17] = (
img≥l
Ë((
P_Q
 + (P_Q<<1Ë+ 
P_R
 + 2)>>2);

212 
i
 = 18; i <24; i++)

214 
Lo›Aºay
[
i
] = (
img≥l
Ë((
PªdPñ
[i-1] + (PredPel[i]<<1) + PredPel[i+1] + 2)>>2);

216 
Lo›Aºay
[24] = (
img≥l
Ë((
P_W
 + (
P_X
<<1) + P_X + 2) >> 2);

219 
	`mem˝y
(&
PªdPñ
[0], &
Lo›Aºay
[0], 25 * (
img≥l
));

220 
	}
}

233 
ölöe
 
	$öåa8x8_dc_¥ed
(
Ma¸oblock
 *
cuºMB
,

234 
Cﬁ‹Pœ√
 
∂
,

235 
ioff
,

236 
joff
)

238 
i
,
j
;

239 
s0
 = 0;

240 
img≥l
 
PªdPñ
[25];

241 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

242 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

244 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
cuºSli˚
->dec_picture;

245 
img≥l
 **
imgY
 = (
∂
Ë? 
dec_pi˘uª
->
imgUV
[pl - 1] : dec_picture->imgY;

247 
PixñPos
 
pix_a
;

248 
PixñPos
 
pix_b
, 
pix_c
, 
pix_d
;

250 
block_avaûabÀ_up
;

251 
block_avaûabÀ_À·
;

252 
block_avaûabÀ_up_À·
;

253 
block_avaûabÀ_up_right
;

255 
img≥l
 **
m¥
 = 
cuºSli˚
->
mb_¥ed
[
∂
];

256 *
mb_size
 = 
p_Vid
->mb_size[
IS_LUMA
];

258 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
, 
mb_size
, &
pix_a
);

259 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 , 
joff
 - 1, 
mb_size
, &
pix_b
);

260 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 + 8, 
joff
 - 1, 
mb_size
, &
pix_c
);

261 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 - 1, 
mb_size
, &
pix_d
);

263 
pix_c
.
avaûabÀ
 =Öix_c.avaûabÀ &&!(
ioff
 =8 && 
joff
 == 8);

265 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

267 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_a.
mb_addr
]: 0;

268 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_b.
mb_addr
] : 0;

269 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_c.
mb_addr
] : 0;

270 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_d.
mb_addr
] : 0;

274 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
;

275 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

276 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
;

277 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
;

281 i‡(
block_avaûabÀ_up
)

283 
	`mem˝y
(&
PªdPñ
[1], &
imgY
[
pix_b
.
pos_y
][pix_b.
pos_x
], 
BLOCK_SIZE_8x8
 * (
img≥l
));

287 #i‡(
IMGTYPE
 == 0)

288 
	`mem£t
(&
PªdPñ
[1], 
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
], 
BLOCK_SIZE_8x8
 * (
img≥l
));

290 
P_A
 = 
P_B
 = 
P_C
 = 
P_D
 = 
P_E
 = 
P_F
 = 
P_G
 = 
P_H
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

294 i‡(
block_avaûabÀ_up_right
)

296 
	`mem˝y
(&
PªdPñ
[9], &
imgY
[
pix_c
.
pos_y
][pix_c.
pos_x
], 
BLOCK_SIZE_8x8
 * (
img≥l
));

300 #i‡(
IMGTYPE
 == 0)

301 
	`mem£t
(&
PªdPñ
[9], PªdPñ[8], 
BLOCK_SIZE_8x8
 * (
img≥l
));

303 
P_I
 = 
P_J
 = 
P_K
 = 
P_L
 = 
P_M
 = 
P_N
 = 
P_O
 = 
P_P
 = 
P_H
;

307 i‡(
block_avaûabÀ_À·
)

309 
img≥l
 **
img_¥ed
 = &
imgY
[
pix_a
.
pos_y
];

310 
pos_x
 = 
pix_a
.pos_x;

311 
P_Q
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

312 
P_R
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

313 
P_S
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

314 
P_T
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

315 
P_U
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

316 
P_V
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

317 
P_W
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

318 
P_X
 = *(*(
img_¥ed
 ) + 
pos_x
);

322 
P_Q
 = 
P_R
 = 
P_S
 = 
P_T
 = 
P_U
 = 
P_V
 = 
P_W
 = 
P_X
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

325 i‡(
block_avaûabÀ_up_À·
)

327 
P_Z
 = 
imgY
[
pix_d
.
pos_y
][pix_d.
pos_x
];

331 
P_Z
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

334 
	`LowPassF‹I¡ø8x8Pªd
(
PªdPñ
, 
block_avaûabÀ_up_À·
, 
block_avaûabÀ_up
, 
block_avaûabÀ_À·
);

336 i‡(
block_avaûabÀ_up
 && 
block_avaûabÀ_À·
)

339 
s0
 = (
P_A
 + 
P_B
 + 
P_C
 + 
P_D
 + 
P_E
 + 
P_F
 + 
P_G
 + 
P_H
 + 
P_Q
 + 
P_R
 + 
P_S
 + 
P_T
 + 
P_U
 + 
P_V
 + 
P_W
 + 
P_X
 + 8) >> 4;

341 i‡(!
block_avaûabÀ_up
 && 
block_avaûabÀ_À·
)

344 
s0
 = (
P_Q
 + 
P_R
 + 
P_S
 + 
P_T
 + 
P_U
 + 
P_V
 + 
P_W
 + 
P_X
 + 4) >> 3;

346 i‡(
block_avaûabÀ_up
 && !
block_avaûabÀ_À·
)

349 
s0
 = (
P_A
 + 
P_B
 + 
P_C
 + 
P_D
 + 
P_E
 + 
P_F
 + 
P_G
 + 
P_H
 + 4) >> 3;

354 
s0
 = 
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

357 
i
 = 
ioff
; i < iof‡+ 
BLOCK_SIZE_8x8
; i++)

358 
m¥
[
joff
][
i
] = (
img≥l
Ë
s0
;

360 
j
 = 
joff
 + 1; j < jof‡+ 
BLOCK_SIZE_8x8
; j++)

361 
	`mem˝y
(&
m¥
[
j
][
ioff
], &m¥[j - 1][ioff], 
BLOCK_SIZE_8x8
 * (
img≥l
));

363  
DECODING_OK
;

364 
	}
}

376 
ölöe
 
	$öåa8x8_vît_¥ed
(
Ma¸oblock
 *
cuºMB
,

377 
Cﬁ‹Pœ√
 
∂
,

378 
ioff
,

379 
joff
)

381 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

382 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

384 
i
;

385 
img≥l
 
PªdPñ
[25];

386 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

388 
PixñPos
 
pix_a
;

389 
PixñPos
 
pix_b
, 
pix_c
, 
pix_d
;

391 
block_avaûabÀ_up
;

392 
block_avaûabÀ_À·
;

393 
block_avaûabÀ_up_À·
;

394 
block_avaûabÀ_up_right
;

397 
img≥l
 **
m¥
 = 
cuºSli˚
->
mb_¥ed
[
∂
];

398 *
mb_size
 = 
p_Vid
->mb_size[
IS_LUMA
];

400 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 , 
mb_size
, &
pix_a
);

401 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 , 
joff
 - 1, 
mb_size
, &
pix_b
);

402 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 + 8, 
joff
 - 1, 
mb_size
, &
pix_c
);

403 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 - 1, 
mb_size
, &
pix_d
);

405 
pix_c
.
avaûabÀ
 =Öix_c.avaûabÀ &&!(
ioff
 =8 && 
joff
 == 8);

407 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

409 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_a.
mb_addr
] : 0;

410 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_b.
mb_addr
] : 0;

411 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_c.
mb_addr
] : 0;

412 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_d.
mb_addr
] : 0;

416 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
;

417 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

418 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
;

419 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
;

422 i‡(!
block_avaûabÀ_up
)

423 
	`¥ötf
 ("w¨nög: I¡ø_8x8_Vîtiˇ»¥edi˘i⁄ modênŸáŒowedáàmb %d\n", (Ë
cuºSli˚
->
cuºít_mb_ƒ
);

426 i‡(
block_avaûabÀ_up
)

428 
	`mem˝y
(&
PªdPñ
[1], &
imgY
[
pix_b
.
pos_y
][pix_b.
pos_x
], 
BLOCK_SIZE_8x8
 * (
img≥l
));

432 #i‡(
IMGTYPE
 == 0)

433 
	`mem£t
(&
PªdPñ
[1], 
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
], 
BLOCK_SIZE_8x8
 * (
img≥l
));

435 
P_A
 = 
P_B
 = 
P_C
 = 
P_D
 = 
P_E
 = 
P_F
 = 
P_G
 = 
P_H
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

439 i‡(
block_avaûabÀ_up_right
)

441 
	`mem˝y
(&
PªdPñ
[9], &
imgY
[
pix_c
.
pos_y
][pix_c.
pos_x
], 
BLOCK_SIZE_8x8
 * (
img≥l
));

445 #i‡(
IMGTYPE
 == 0)

446 
	`mem£t
(&
PªdPñ
[9], PªdPñ[8], 
BLOCK_SIZE_8x8
 * (
img≥l
));

448 
P_I
 = 
P_J
 = 
P_K
 = 
P_L
 = 
P_M
 = 
P_N
 = 
P_O
 = 
P_P
 = 
P_H
;

452 i‡(
block_avaûabÀ_up_À·
)

454 
P_Z
 = 
imgY
[
pix_d
.
pos_y
][pix_d.
pos_x
];

458 
P_Z
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

461 
	`LowPassF‹I¡ø8x8PªdH‹
(&(
P_Z
), 
block_avaûabÀ_up_À·
, 
block_avaûabÀ_up
, 
block_avaûabÀ_À·
);

463 
i
=
joff
; i < jof‡+ 
BLOCK_SIZE_8x8
; i++)

465 
	`mem˝y
(&
m¥
[
i
][
ioff
], &
PªdPñ
[1], 
BLOCK_SIZE_8x8
 * (
img≥l
));

468  
DECODING_OK
;

469 
	}
}

481 
ölöe
 
	$öåa8x8_h‹_¥ed
(
Ma¸oblock
 *
cuºMB
,

482 
Cﬁ‹Pœ√
 
∂
,

483 
ioff
,

484 
joff
)

486 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

487 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

490 
j
;

491 
img≥l
 
PªdPñ
[25];

492 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

494 
PixñPos
 
pix_a
;

495 
PixñPos
 
pix_b
, 
pix_d
;

497 
block_avaûabÀ_up
;

498 
block_avaûabÀ_À·
;

499 
block_avaûabÀ_up_À·
;

501 #i‡(
IMGTYPE
 != 0)

502 
ùos0
 = 
ioff
 , 
ùos1
 = iof‡+ 1, 
ùos2
 = iof‡+ 2, 
ùos3
 = ioff + 3;

503 
ùos4
 = 
ioff
 + 4, 
ùos5
 = iof‡+ 5, 
ùos6
 = iof‡+ 6, 
ùos7
 = ioff + 7;

505 
jpos
;

506 
img≥l
 **
m¥
 = 
cuºSli˚
->
mb_¥ed
[
∂
];

507 *
mb_size
 = 
p_Vid
->mb_size[
IS_LUMA
];

509 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 , 
mb_size
, &
pix_a
);

510 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 , 
joff
 - 1, 
mb_size
, &
pix_b
);

511 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 - 1, 
mb_size
, &
pix_d
);

513 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

515 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_a.
mb_addr
]: 0;

516 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_b.
mb_addr
] : 0;

517 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_d.
mb_addr
] : 0;

521 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
;

522 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

523 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
;

526 i‡(!
block_avaûabÀ_À·
)

527 
	`¥ötf
 ("w¨nög: I¡ø_8x8_H‹iz⁄è»¥edi˘i⁄ modênŸáŒowedáàmb %d\n", (Ë
cuºSli˚
->
cuºít_mb_ƒ
);

530 i‡(
block_avaûabÀ_À·
)

532 
img≥l
 **
img_¥ed
 = &
imgY
[
pix_a
.
pos_y
];

533 
pos_x
 = 
pix_a
.pos_x;

534 
P_Q
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

535 
P_R
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

536 
P_S
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

537 
P_T
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

538 
P_U
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

539 
P_V
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

540 
P_W
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

541 
P_X
 = *(*(
img_¥ed
 ) + 
pos_x
);

545 
P_Q
 = 
P_R
 = 
P_S
 = 
P_T
 = 
P_U
 = 
P_V
 = 
P_W
 = 
P_X
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

548 i‡(
block_avaûabÀ_up_À·
)

550 
P_Z
 = 
imgY
[
pix_d
.
pos_y
][pix_d.
pos_x
];

554 
P_Z
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

557 
	`LowPassF‹I¡ø8x8PªdVî
(&(
P_Z
), 
block_avaûabÀ_up_À·
, 
block_avaûabÀ_up
, 
block_avaûabÀ_À·
);

559 
j
=0; j < 
BLOCK_SIZE_8x8
; j++)

561 
jpos
 = 
j
 + 
joff
;

562 #i‡(
IMGTYPE
 == 0)

563 
	`mem£t
(&
m¥
[
jpos
][
ioff
], (
img≥l
Ë(&
P_Q
)[
j
], 8 * (imgpel));

565 
m¥
[
jpos
][
ùos0
] =

566 
m¥
[
jpos
][
ùos1
] =

567 
m¥
[
jpos
][
ùos2
] =

568 
m¥
[
jpos
][
ùos3
] =

569 
m¥
[
jpos
][
ùos4
] =

570 
m¥
[
jpos
][
ùos5
] =

571 
m¥
[
jpos
][
ùos6
] =

572 
m¥
[
jpos
][
ùos7
] = (
img≥l
Ë(&
P_Q
)[
j
];

576  
DECODING_OK
;

577 
	}
}

589 
ölöe
 
	$öåa8x8_düg_down_right_¥ed
(
Ma¸oblock
 *
cuºMB
,

590 
Cﬁ‹Pœ√
 
∂
,

591 
ioff
,

592 
joff
)

594 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

595 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

597 
img≥l
 
PªdPñ
[25];

598 
img≥l
 
PªdAºay
[16];

599 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

601 
PixñPos
 
pix_a
;

602 
PixñPos
 
pix_b
, 
pix_c
, 
pix_d
;

604 
block_avaûabÀ_up
;

605 
block_avaûabÀ_À·
;

606 
block_avaûabÀ_up_À·
;

607 
block_avaûabÀ_up_right
;

609 
img≥l
 *
¥ed_≥ls
;

610 
img≥l
 **
mb_¥ed
 = &
cuºSli˚
->mb_¥ed[
∂
][
joff
];

611 *
mb_size
 = 
p_Vid
->mb_size[
IS_LUMA
];

613 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 , 
mb_size
, &
pix_a
);

614 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 , 
joff
 - 1, 
mb_size
, &
pix_b
);

615 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 + 8, 
joff
 - 1, 
mb_size
, &
pix_c
);

616 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 - 1, 
mb_size
, &
pix_d
);

618 
pix_c
.
avaûabÀ
 =Öix_c.avaûabÀ &&!(
ioff
 =8 && 
joff
 == 8);

620 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

622 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_a.
mb_addr
]: 0;

623 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_b.
mb_addr
] : 0;

624 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_c.
mb_addr
] : 0;

625 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_d.
mb_addr
] : 0;

629 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
;

630 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

631 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
;

632 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
;

635 i‡((!
block_avaûabÀ_up
)||(!
block_avaûabÀ_À·
)||(!
block_avaûabÀ_up_À·
))

636 
	`¥ötf
 ("w¨nög: I¡ø_8x8_Düg⁄Æ_Down_Righà¥edi˘i⁄ modênŸáŒowedáàmb %d\n", (Ë
cuºSli˚
->
cuºít_mb_ƒ
);

639 i‡(
block_avaûabÀ_up
)

641 
	`mem˝y
(&
PªdPñ
[1], &
imgY
[
pix_b
.
pos_y
][pix_b.
pos_x
], 
BLOCK_SIZE_8x8
 * (
img≥l
));

645 #i‡(
IMGTYPE
 == 0)

646 
	`mem£t
(&
PªdPñ
[1], 
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
], 
BLOCK_SIZE_8x8
 * (
img≥l
));

648 
P_A
 = 
P_B
 = 
P_C
 = 
P_D
 = 
P_E
 = 
P_F
 = 
P_G
 = 
P_H
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

652 i‡(
block_avaûabÀ_up_right
)

654 
	`mem˝y
(&
PªdPñ
[9], &
imgY
[
pix_c
.
pos_y
][pix_c.
pos_x
], 
BLOCK_SIZE_8x8
 * (
img≥l
));

658 #i‡(
IMGTYPE
 == 0)

659 
	`mem£t
(&
PªdPñ
[9], PªdPñ[8], 
BLOCK_SIZE_8x8
 * (
img≥l
));

661 
P_I
 = 
P_J
 = 
P_K
 = 
P_L
 = 
P_M
 = 
P_N
 = 
P_O
 = 
P_P
 = 
P_H
;

665 i‡(
block_avaûabÀ_À·
)

667 
img≥l
 **
img_¥ed
 = &
imgY
[
pix_a
.
pos_y
];

668 
pos_x
 = 
pix_a
.pos_x;

669 
P_Q
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

670 
P_R
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

671 
P_S
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

672 
P_T
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

673 
P_U
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

674 
P_V
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

675 
P_W
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

676 
P_X
 = *(*(
img_¥ed
 ) + 
pos_x
);

680 
P_Q
 = 
P_R
 = 
P_S
 = 
P_T
 = 
P_U
 = 
P_V
 = 
P_W
 = 
P_X
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

683 i‡(
block_avaûabÀ_up_À·
)

685 
P_Z
 = 
imgY
[
pix_d
.
pos_y
][pix_d.
pos_x
];

689 
P_Z
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

692 
	`LowPassF‹I¡ø8x8Pªd
(
PªdPñ
, 
block_avaûabÀ_up_À·
, 
block_avaûabÀ_up
, 
block_avaûabÀ_À·
);

695 
PªdAºay
[ 0] = (
img≥l
Ë((
P_X
 + 
P_V
 + ((
P_W
) << 1) + 2) >> 2);

696 
PªdAºay
[ 1] = (
img≥l
Ë((
P_W
 + 
P_U
 + ((
P_V
) << 1) + 2) >> 2);

697 
PªdAºay
[ 2] = (
img≥l
Ë((
P_V
 + 
P_T
 + ((
P_U
) << 1) + 2) >> 2);

698 
PªdAºay
[ 3] = (
img≥l
Ë((
P_U
 + 
P_S
 + ((
P_T
) << 1) + 2) >> 2);

699 
PªdAºay
[ 4] = (
img≥l
Ë((
P_T
 + 
P_R
 + ((
P_S
) << 1) + 2) >> 2);

700 
PªdAºay
[ 5] = (
img≥l
Ë((
P_S
 + 
P_Q
 + ((
P_R
) << 1) + 2) >> 2);

701 
PªdAºay
[ 6] = (
img≥l
Ë((
P_R
 + 
P_Z
 + ((
P_Q
) << 1) + 2) >> 2);

702 
PªdAºay
[ 7] = (
img≥l
Ë((
P_Q
 + 
P_A
 + ((
P_Z
) << 1) + 2) >> 2);

703 
PªdAºay
[ 8] = (
img≥l
Ë((
P_Z
 + 
P_B
 + ((
P_A
) << 1) + 2) >> 2);

704 
PªdAºay
[ 9] = (
img≥l
Ë((
P_A
 + 
P_C
 + ((
P_B
) << 1) + 2) >> 2);

705 
PªdAºay
[10] = (
img≥l
Ë((
P_B
 + 
P_D
 + ((
P_C
) << 1) + 2) >> 2);

706 
PªdAºay
[11] = (
img≥l
Ë((
P_C
 + 
P_E
 + ((
P_D
) << 1) + 2) >> 2);

707 
PªdAºay
[12] = (
img≥l
Ë((
P_D
 + 
P_F
 + ((
P_E
) << 1) + 2) >> 2);

708 
PªdAºay
[13] = (
img≥l
Ë((
P_E
 + 
P_G
 + ((
P_F
) << 1) + 2) >> 2);

709 
PªdAºay
[14] = (
img≥l
Ë((
P_F
 + 
P_H
 + ((
P_G
) << 1) + 2) >> 2);

711 
¥ed_≥ls
 = &
PªdAºay
[7];

713 
	`mem˝y
((*
mb_¥ed
++Ë+ 
ioff
, 
¥ed_≥ls
--, 8 * (
img≥l
));

714 
	`mem˝y
((*
mb_¥ed
++Ë+ 
ioff
, 
¥ed_≥ls
--, 8 * (
img≥l
));

715 
	`mem˝y
((*
mb_¥ed
++Ë+ 
ioff
, 
¥ed_≥ls
--, 8 * (
img≥l
));

716 
	`mem˝y
((*
mb_¥ed
++Ë+ 
ioff
, 
¥ed_≥ls
--, 8 * (
img≥l
));

717 
	`mem˝y
((*
mb_¥ed
++Ë+ 
ioff
, 
¥ed_≥ls
--, 8 * (
img≥l
));

718 
	`mem˝y
((*
mb_¥ed
++Ë+ 
ioff
, 
¥ed_≥ls
--, 8 * (
img≥l
));

719 
	`mem˝y
((*
mb_¥ed
++Ë+ 
ioff
, 
¥ed_≥ls
--, 8 * (
img≥l
));

720 
	`mem˝y
((*
mb_¥ed
 ) + 
ioff
, 
¥ed_≥ls
 , 8 * (
img≥l
));

722  
DECODING_OK
;

723 
	}
}

735 
ölöe
 
	$öåa8x8_düg_down_À·_¥ed
(
Ma¸oblock
 *
cuºMB
,

736 
Cﬁ‹Pœ√
 
∂
,

737 
ioff
,

738 
joff
)

740 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

741 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

743 
img≥l
 
PªdPñ
[25];

744 
img≥l
 
PªdAºay
[16];

745 
img≥l
 *
Pªd
 = &
PªdAºay
[0];

746 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

748 
PixñPos
 
pix_a
;

749 
PixñPos
 
pix_b
, 
pix_c
, 
pix_d
;

751 
block_avaûabÀ_up
;

752 
block_avaûabÀ_À·
;

753 
block_avaûabÀ_up_À·
;

754 
block_avaûabÀ_up_right
;

756 
img≥l
 **
mb_¥ed
 = &
cuºSli˚
->mb_¥ed[
∂
][
joff
];

757 *
mb_size
 = 
p_Vid
->mb_size[
IS_LUMA
];

759 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 , 
mb_size
, &
pix_a
);

760 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 , 
joff
 - 1, 
mb_size
, &
pix_b
);

761 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 + 8, 
joff
 - 1, 
mb_size
, &
pix_c
);

762 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 - 1, 
mb_size
, &
pix_d
);

764 
pix_c
.
avaûabÀ
 =Öix_c.avaûabÀ &&!(
ioff
 =8 && 
joff
 == 8);

766 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

768 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_a.
mb_addr
]: 0;

769 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_b.
mb_addr
] : 0;

770 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_c.
mb_addr
] : 0;

771 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_d.
mb_addr
] : 0;

775 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
;

776 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

777 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
;

778 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
;

781 i‡(!
block_avaûabÀ_up
)

782 
	`¥ötf
 ("w¨nög: I¡ø_8x8_Düg⁄Æ_Down_Le·Öªdi˘i⁄ modênŸáŒowedáàmb %d\n", (Ë
cuºSli˚
->
cuºít_mb_ƒ
);

785 i‡(
block_avaûabÀ_up
)

787 
	`mem˝y
(&
PªdPñ
[1], &
imgY
[
pix_b
.
pos_y
][pix_b.
pos_x
], 
BLOCK_SIZE_8x8
 * (
img≥l
));

791 #i‡(
IMGTYPE
 == 0)

792 
	`mem£t
(&
PªdPñ
[1], 
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
], 
BLOCK_SIZE_8x8
 * (
img≥l
));

794 
P_A
 = 
P_B
 = 
P_C
 = 
P_D
 = 
P_E
 = 
P_F
 = 
P_G
 = 
P_H
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

798 i‡(
block_avaûabÀ_up_right
)

800 
	`mem˝y
(&
PªdPñ
[9], &
imgY
[
pix_c
.
pos_y
][pix_c.
pos_x
], 
BLOCK_SIZE_8x8
 * (
img≥l
));

804 #i‡(
IMGTYPE
 == 0)

805 
	`mem£t
(&
PªdPñ
[9], PªdPñ[8], 
BLOCK_SIZE_8x8
 * (
img≥l
));

807 
P_I
 = 
P_J
 = 
P_K
 = 
P_L
 = 
P_M
 = 
P_N
 = 
P_O
 = 
P_P
 = 
P_H
;

811 i‡(
block_avaûabÀ_À·
)

813 
img≥l
 **
img_¥ed
 = &
imgY
[
pix_a
.
pos_y
];

814 
pos_x
 = 
pix_a
.pos_x;

815 
P_Q
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

816 
P_R
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

817 
P_S
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

818 
P_T
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

819 
P_U
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

820 
P_V
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

821 
P_W
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

822 
P_X
 = *(*(
img_¥ed
 ) + 
pos_x
);

826 
P_Q
 = 
P_R
 = 
P_S
 = 
P_T
 = 
P_U
 = 
P_V
 = 
P_W
 = 
P_X
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

829 i‡(
block_avaûabÀ_up_À·
)

831 
P_Z
 = 
imgY
[
pix_d
.
pos_y
][pix_d.
pos_x
];

835 
P_Z
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

838 
	`LowPassF‹I¡ø8x8Pªd
(
PªdPñ
, 
block_avaûabÀ_up_À·
, 
block_avaûabÀ_up
, 
block_avaûabÀ_À·
);

841 *
Pªd
++ = (
img≥l
Ë((
P_A
 + 
P_C
 + ((
P_B
) << 1) + 2) >> 2);

842 *
Pªd
++ = (
img≥l
Ë((
P_B
 + 
P_D
 + ((
P_C
) << 1) + 2) >> 2);

843 *
Pªd
++ = (
img≥l
Ë((
P_C
 + 
P_E
 + ((
P_D
) << 1) + 2) >> 2);

844 *
Pªd
++ = (
img≥l
Ë((
P_D
 + 
P_F
 + ((
P_E
) << 1) + 2) >> 2);

845 *
Pªd
++ = (
img≥l
Ë((
P_E
 + 
P_G
 + ((
P_F
) << 1) + 2) >> 2);

846 *
Pªd
++ = (
img≥l
Ë((
P_F
 + 
P_H
 + ((
P_G
) << 1) + 2) >> 2);

847 *
Pªd
++ = (
img≥l
Ë((
P_G
 + 
P_I
 + ((
P_H
) << 1) + 2) >> 2);

848 *
Pªd
++ = (
img≥l
Ë((
P_H
 + 
P_J
 + ((
P_I
) << 1) + 2) >> 2);

849 *
Pªd
++ = (
img≥l
Ë((
P_I
 + 
P_K
 + ((
P_J
) << 1) + 2) >> 2);

850 *
Pªd
++ = (
img≥l
Ë((
P_J
 + 
P_L
 + ((
P_K
) << 1) + 2) >> 2);

851 *
Pªd
++ = (
img≥l
Ë((
P_K
 + 
P_M
 + ((
P_L
) << 1) + 2) >> 2);

852 *
Pªd
++ = (
img≥l
Ë((
P_L
 + 
P_N
 + ((
P_M
) << 1) + 2) >> 2);

853 *
Pªd
++ = (
img≥l
Ë((
P_M
 + 
P_O
 + ((
P_N
) << 1) + 2) >> 2);

854 *
Pªd
++ = (
img≥l
Ë((
P_N
 + 
P_P
 + ((
P_O
) << 1) + 2) >> 2);

855 *
Pªd
 = (
img≥l
Ë((
P_O
 + 
P_P
 + ((P_P) << 1) + 2) >> 2);

857 
Pªd
 = &
PªdAºay
[ 0];

859 
	`mem˝y
((*
mb_¥ed
++Ë+ 
ioff
, 
Pªd
++, 8 * (
img≥l
));

860 
	`mem˝y
((*
mb_¥ed
++Ë+ 
ioff
, 
Pªd
++, 8 * (
img≥l
));

861 
	`mem˝y
((*
mb_¥ed
++Ë+ 
ioff
, 
Pªd
++, 8 * (
img≥l
));

862 
	`mem˝y
((*
mb_¥ed
++Ë+ 
ioff
, 
Pªd
++, 8 * (
img≥l
));

863 
	`mem˝y
((*
mb_¥ed
++Ë+ 
ioff
, 
Pªd
++, 8 * (
img≥l
));

864 
	`mem˝y
((*
mb_¥ed
++Ë+ 
ioff
, 
Pªd
++, 8 * (
img≥l
));

865 
	`mem˝y
((*
mb_¥ed
++Ë+ 
ioff
, 
Pªd
++, 8 * (
img≥l
));

866 
	`mem˝y
((*
mb_¥ed
 ) + 
ioff
, 
Pªd
 , 8 * (
img≥l
));

868  
DECODING_OK
;

869 
	}
}

881 
ölöe
 
	$öåa8x8_vît_right_¥ed
(
Ma¸oblock
 *
cuºMB
,

882 
Cﬁ‹Pœ√
 
∂
,

883 
ioff
,

884 
joff
)

886 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

887 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

889 
img≥l
 
PªdPñ
[25];

890 
img≥l
 
PªdAºay
[22];

891 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

893 
PixñPos
 
pix_a
;

894 
PixñPos
 
pix_b
, 
pix_c
, 
pix_d
;

896 
block_avaûabÀ_up
;

897 
block_avaûabÀ_À·
;

898 
block_avaûabÀ_up_À·
;

899 
block_avaûabÀ_up_right
;

901 
img≥l
 *
¥ed_≥ls
;

902 
img≥l
 **
mb_¥ed
 = &
cuºSli˚
->mb_¥ed[
∂
][
joff
];

903 *
mb_size
 = 
p_Vid
->mb_size[
IS_LUMA
];

905 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 , 
mb_size
, &
pix_a
);

906 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 , 
joff
 - 1, 
mb_size
, &
pix_b
);

907 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 + 8, 
joff
 - 1, 
mb_size
, &
pix_c
);

908 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 - 1, 
mb_size
, &
pix_d
);

910 
pix_c
.
avaûabÀ
 =Öix_c.avaûabÀ &&!(
ioff
 =8 && 
joff
 == 8);

912 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

914 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_a.
mb_addr
]: 0;

915 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_b.
mb_addr
] : 0;

916 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_c.
mb_addr
] : 0;

917 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_d.
mb_addr
] : 0;

921 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
;

922 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

923 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
;

924 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
;

927 i‡((!
block_avaûabÀ_up
)||(!
block_avaûabÀ_À·
)||(!
block_avaûabÀ_up_À·
))

928 
	`¥ötf
 ("w¨nög: I¡ø_8x8_Vîtiˇl_Righà¥edi˘i⁄ modênŸáŒowedáàmb %d\n", (Ë
cuºSli˚
->
cuºít_mb_ƒ
);

931 i‡(
block_avaûabÀ_up
)

933 
	`mem˝y
(&
PªdPñ
[1], &
imgY
[
pix_b
.
pos_y
][pix_b.
pos_x
], 
BLOCK_SIZE_8x8
 * (
img≥l
));

937 #i‡(
IMGTYPE
 == 0)

938 
	`mem£t
(&
PªdPñ
[1], 
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
], 
BLOCK_SIZE_8x8
 * (
img≥l
));

940 
P_A
 = 
P_B
 = 
P_C
 = 
P_D
 = 
P_E
 = 
P_F
 = 
P_G
 = 
P_H
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

944 i‡(
block_avaûabÀ_up_right
)

946 
	`mem˝y
(&
PªdPñ
[9], &
imgY
[
pix_c
.
pos_y
][pix_c.
pos_x
], 
BLOCK_SIZE_8x8
 * (
img≥l
));

950 #i‡(
IMGTYPE
 == 0)

951 
	`mem£t
(&
PªdPñ
[9], PªdPñ[8], 
BLOCK_SIZE_8x8
 * (
img≥l
));

953 
P_I
 = 
P_J
 = 
P_K
 = 
P_L
 = 
P_M
 = 
P_N
 = 
P_O
 = 
P_P
 = 
P_H
;

957 i‡(
block_avaûabÀ_À·
)

959 
img≥l
 **
img_¥ed
 = &
imgY
[
pix_a
.
pos_y
];

960 
pos_x
 = 
pix_a
.pos_x;

961 
P_Q
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

962 
P_R
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

963 
P_S
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

964 
P_T
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

965 
P_U
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

966 
P_V
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

967 
P_W
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

968 
P_X
 = *(*(
img_¥ed
 ) + 
pos_x
);

972 
P_Q
 = 
P_R
 = 
P_S
 = 
P_T
 = 
P_U
 = 
P_V
 = 
P_W
 = 
P_X
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

975 i‡(
block_avaûabÀ_up_À·
)

977 
P_Z
 = 
imgY
[
pix_d
.
pos_y
][pix_d.
pos_x
];

981 
P_Z
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

984 
	`LowPassF‹I¡ø8x8Pªd
(
PªdPñ
, 
block_avaûabÀ_up_À·
, 
block_avaûabÀ_up
, 
block_avaûabÀ_À·
);

986 
¥ed_≥ls
 = 
PªdAºay
;

987 *
¥ed_≥ls
++ = (
img≥l
Ë((
P_V
 + 
P_T
 + ((
P_U
) << 1) + 2) >> 2);

988 *
¥ed_≥ls
++ = (
img≥l
Ë((
P_T
 + 
P_R
 + ((
P_S
) << 1) + 2) >> 2);

989 *
¥ed_≥ls
++ = (
img≥l
Ë((
P_R
 + 
P_Z
 + ((
P_Q
) << 1) + 2) >> 2);

990 *
¥ed_≥ls
++ = (
img≥l
Ë((
P_Z
 + 
P_A
 + 1) >> 1);

991 *
¥ed_≥ls
++ = (
img≥l
Ë((
P_A
 + 
P_B
 + 1) >> 1);

992 *
¥ed_≥ls
++ = (
img≥l
Ë((
P_B
 + 
P_C
 + 1) >> 1);

993 *
¥ed_≥ls
++ = (
img≥l
Ë((
P_C
 + 
P_D
 + 1) >> 1);

994 *
¥ed_≥ls
++ = (
img≥l
Ë((
P_D
 + 
P_E
 + 1) >> 1);

995 *
¥ed_≥ls
++ = (
img≥l
Ë((
P_E
 + 
P_F
 + 1) >> 1);

996 *
¥ed_≥ls
++ = (
img≥l
Ë((
P_F
 + 
P_G
 + 1) >> 1);

997 *
¥ed_≥ls
++ = (
img≥l
Ë((
P_G
 + 
P_H
 + 1) >> 1);

999 *
¥ed_≥ls
++ = (
img≥l
Ë((
P_W
 + 
P_U
 + ((
P_V
) << 1) + 2) >> 2);

1000 *
¥ed_≥ls
++ = (
img≥l
Ë((
P_U
 + 
P_S
 + ((
P_T
) << 1) + 2) >> 2);

1001 *
¥ed_≥ls
++ = (
img≥l
Ë((
P_S
 + 
P_Q
 + ((
P_R
) << 1) + 2) >> 2);

1002 *
¥ed_≥ls
++ = (
img≥l
Ë((
P_Q
 + 
P_A
 + ((
P_Z
) << 1) + 2) >> 2);

1003 *
¥ed_≥ls
++ = (
img≥l
Ë((
P_Z
 + 
P_B
 + ((
P_A
) << 1) + 2) >> 2);

1004 *
¥ed_≥ls
++ = (
img≥l
Ë((
P_A
 + 
P_C
 + ((
P_B
) << 1) + 2) >> 2);

1005 *
¥ed_≥ls
++ = (
img≥l
Ë((
P_B
 + 
P_D
 + ((
P_C
) << 1) + 2) >> 2);

1006 *
¥ed_≥ls
++ = (
img≥l
Ë((
P_C
 + 
P_E
 + ((
P_D
) << 1) + 2) >> 2);

1007 *
¥ed_≥ls
++ = (
img≥l
Ë((
P_D
 + 
P_F
 + ((
P_E
) << 1) + 2) >> 2);

1008 *
¥ed_≥ls
++ = (
img≥l
Ë((
P_E
 + 
P_G
 + ((
P_F
) << 1) + 2) >> 2);

1009 *
¥ed_≥ls
 = (
img≥l
Ë((
P_F
 + 
P_H
 + ((
P_G
) << 1) + 2) >> 2);

1011 
	`mem˝y
((*
mb_¥ed
++Ë+ 
ioff
, &
PªdAºay
[ 3], 8 * (
img≥l
));

1012 
	`mem˝y
((*
mb_¥ed
++Ë+ 
ioff
, &
PªdAºay
[14], 8 * (
img≥l
));

1013 
	`mem˝y
((*
mb_¥ed
++Ë+ 
ioff
, &
PªdAºay
[ 2], 8 * (
img≥l
));

1014 
	`mem˝y
((*
mb_¥ed
++Ë+ 
ioff
, &
PªdAºay
[13], 8 * (
img≥l
));

1015 
	`mem˝y
((*
mb_¥ed
++Ë+ 
ioff
, &
PªdAºay
[ 1], 8 * (
img≥l
));

1016 
	`mem˝y
((*
mb_¥ed
++Ë+ 
ioff
, &
PªdAºay
[12], 8 * (
img≥l
));

1017 
	`mem˝y
((*
mb_¥ed
++Ë+ 
ioff
, &
PªdAºay
[ 0], 8 * (
img≥l
));

1018 
	`mem˝y
((*
mb_¥ed
 ) + 
ioff
, &
PªdAºay
[11], 8 * (
img≥l
));

1020  
DECODING_OK
;

1021 
	}
}

1034 
ölöe
 
	$öåa8x8_vît_À·_¥ed
(
Ma¸oblock
 *
cuºMB
,

1035 
Cﬁ‹Pœ√
 
∂
,

1036 
ioff
,

1037 
joff
)

1039 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1040 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1042 
img≥l
 
PªdPñ
[25];

1043 
img≥l
 
PªdAºay
[22];

1044 
img≥l
 *
¥ed_≥l
 = &
PªdAºay
[0];

1045 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

1047 
PixñPos
 
pix_a
;

1048 
PixñPos
 
pix_b
, 
pix_c
, 
pix_d
;

1050 
block_avaûabÀ_up
;

1051 
block_avaûabÀ_À·
;

1052 
block_avaûabÀ_up_À·
;

1053 
block_avaûabÀ_up_right
;

1055 
img≥l
 **
mb_¥ed
 = &
cuºSli˚
->mb_¥ed[
∂
][
joff
];

1056 *
mb_size
 = 
p_Vid
->mb_size[
IS_LUMA
];

1058 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 , 
mb_size
, &
pix_a
);

1059 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 , 
joff
 - 1, 
mb_size
, &
pix_b
);

1060 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 + 8, 
joff
 - 1, 
mb_size
, &
pix_c
);

1061 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 - 1, 
mb_size
, &
pix_d
);

1063 
pix_c
.
avaûabÀ
 =Öix_c.avaûabÀ &&!(
ioff
 =8 && 
joff
 == 8);

1065 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

1067 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_a.
mb_addr
] : 0;

1068 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_b.
mb_addr
] : 0;

1069 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_c.
mb_addr
] : 0;

1070 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_d.
mb_addr
] : 0;

1074 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
;

1075 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

1076 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
;

1077 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
;

1080 i‡(!
block_avaûabÀ_up
)

1081 
	`¥ötf
 ("w¨nög: I¡ø_4x4_Vîtiˇl_Le·Öªdi˘i⁄ modênŸáŒowedáàmb %d\n", (Ë
cuºSli˚
->
cuºít_mb_ƒ
);

1084 i‡(
block_avaûabÀ_up
)

1086 
	`mem˝y
(&
PªdPñ
[1], &
imgY
[
pix_b
.
pos_y
][pix_b.
pos_x
], 
BLOCK_SIZE_8x8
 * (
img≥l
));

1090 #i‡(
IMGTYPE
 == 0)

1091 
	`mem£t
(&
PªdPñ
[1], 
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
], 
BLOCK_SIZE_8x8
 * (
img≥l
));

1093 
P_A
 = 
P_B
 = 
P_C
 = 
P_D
 = 
P_E
 = 
P_F
 = 
P_G
 = 
P_H
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

1097 i‡(
block_avaûabÀ_up_right
)

1099 
	`mem˝y
(&
PªdPñ
[9], &
imgY
[
pix_c
.
pos_y
][pix_c.
pos_x
], 
BLOCK_SIZE_8x8
 * (
img≥l
));

1103 #i‡(
IMGTYPE
 == 0)

1104 
	`mem£t
(&
PªdPñ
[9], PªdPñ[8], 
BLOCK_SIZE_8x8
 * (
img≥l
));

1106 
P_I
 = 
P_J
 = 
P_K
 = 
P_L
 = 
P_M
 = 
P_N
 = 
P_O
 = 
P_P
 = 
P_H
;

1110 i‡(
block_avaûabÀ_À·
)

1112 
img≥l
 **
img_¥ed
 = &
imgY
[
pix_a
.
pos_y
];

1113 
pos_x
 = 
pix_a
.pos_x;

1114 
P_Q
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

1115 
P_R
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

1116 
P_S
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

1117 
P_T
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

1118 
P_U
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

1119 
P_V
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

1120 
P_W
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

1121 
P_X
 = *(*(
img_¥ed
 ) + 
pos_x
);

1125 
P_Q
 = 
P_R
 = 
P_S
 = 
P_T
 = 
P_U
 = 
P_V
 = 
P_W
 = 
P_X
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

1128 i‡(
block_avaûabÀ_up_À·
)

1130 
P_Z
 = 
imgY
[
pix_d
.
pos_y
][pix_d.
pos_x
];

1134 
P_Z
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

1137 
	`LowPassF‹I¡ø8x8Pªd
(
PªdPñ
, 
block_avaûabÀ_up_À·
, 
block_avaûabÀ_up
, 
block_avaûabÀ_À·
);

1139 *
¥ed_≥l
++ = (
img≥l
Ë((
P_A
 + 
P_B
 + 1) >> 1);

1140 *
¥ed_≥l
++ = (
img≥l
Ë((
P_B
 + 
P_C
 + 1) >> 1);

1141 *
¥ed_≥l
++ = (
img≥l
Ë((
P_C
 + 
P_D
 + 1) >> 1);

1142 *
¥ed_≥l
++ = (
img≥l
Ë((
P_D
 + 
P_E
 + 1) >> 1);

1143 *
¥ed_≥l
++ = (
img≥l
Ë((
P_E
 + 
P_F
 + 1) >> 1);

1144 *
¥ed_≥l
++ = (
img≥l
Ë((
P_F
 + 
P_G
 + 1) >> 1);

1145 *
¥ed_≥l
++ = (
img≥l
Ë((
P_G
 + 
P_H
 + 1) >> 1);

1146 *
¥ed_≥l
++ = (
img≥l
Ë((
P_H
 + 
P_I
 + 1) >> 1);

1147 *
¥ed_≥l
++ = (
img≥l
Ë((
P_I
 + 
P_J
 + 1) >> 1);

1148 *
¥ed_≥l
++ = (
img≥l
Ë((
P_J
 + 
P_K
 + 1) >> 1);

1149 *
¥ed_≥l
++ = (
img≥l
Ë((
P_K
 + 
P_L
 + 1) >> 1);

1150 *
¥ed_≥l
++ = (
img≥l
Ë((
P_A
 + 
P_C
 + ((
P_B
) << 1) + 2) >> 2);

1151 *
¥ed_≥l
++ = (
img≥l
Ë((
P_B
 + 
P_D
 + ((
P_C
) << 1) + 2) >> 2);

1152 *
¥ed_≥l
++ = (
img≥l
Ë((
P_C
 + 
P_E
 + ((
P_D
) << 1) + 2) >> 2);

1153 *
¥ed_≥l
++ = (
img≥l
Ë((
P_D
 + 
P_F
 + ((
P_E
) << 1) + 2) >> 2);

1154 *
¥ed_≥l
++ = (
img≥l
Ë((
P_E
 + 
P_G
 + ((
P_F
) << 1) + 2) >> 2);

1155 *
¥ed_≥l
++ = (
img≥l
Ë((
P_F
 + 
P_H
 + ((
P_G
) << 1) + 2) >> 2);

1156 *
¥ed_≥l
++ = (
img≥l
Ë((
P_G
 + 
P_I
 + ((
P_H
) << 1) + 2) >> 2);

1157 *
¥ed_≥l
++ = (
img≥l
Ë((
P_H
 + 
P_J
 + ((
P_I
) << 1) + 2) >> 2);

1158 *
¥ed_≥l
++ = (
img≥l
Ë((
P_I
 + 
P_K
 + ((
P_J
) << 1) + 2) >> 2);

1159 *
¥ed_≥l
++ = (
img≥l
Ë((
P_J
 + 
P_L
 + ((
P_K
) << 1) + 2) >> 2);

1160 *
¥ed_≥l
 = (
img≥l
Ë((
P_K
 + 
P_M
 + ((
P_L
) << 1) + 2) >> 2);

1162 
	`mem˝y
((*
mb_¥ed
++Ë+ 
ioff
, &
PªdAºay
[ 0], 8 * (
img≥l
));

1163 
	`mem˝y
((*
mb_¥ed
++Ë+ 
ioff
, &
PªdAºay
[11], 8 * (
img≥l
));

1164 
	`mem˝y
((*
mb_¥ed
++Ë+ 
ioff
, &
PªdAºay
[ 1], 8 * (
img≥l
));

1165 
	`mem˝y
((*
mb_¥ed
++Ë+ 
ioff
, &
PªdAºay
[12], 8 * (
img≥l
));

1166 
	`mem˝y
((*
mb_¥ed
++Ë+ 
ioff
, &
PªdAºay
[ 2], 8 * (
img≥l
));

1167 
	`mem˝y
((*
mb_¥ed
++Ë+ 
ioff
, &
PªdAºay
[13], 8 * (
img≥l
));

1168 
	`mem˝y
((*
mb_¥ed
++Ë+ 
ioff
, &
PªdAºay
[ 3], 8 * (
img≥l
));

1169 
	`mem˝y
((*
mb_¥ed
 ) + 
ioff
, &
PªdAºay
[14], 8 * (
img≥l
));

1171  
DECODING_OK
;

1172 
	}
}

1184 
ölöe
 
	$öåa8x8_h‹_up_¥ed
(
Ma¸oblock
 *
cuºMB
,

1185 
Cﬁ‹Pœ√
 
∂
,

1186 
ioff
,

1187 
joff
)

1189 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1190 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1192 
img≥l
 
PªdPñ
[25];

1193 
img≥l
 
PªdAºay
[22];

1194 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

1196 
PixñPos
 
pix_a
;

1197 
PixñPos
 
pix_b
, 
pix_c
, 
pix_d
;

1199 
block_avaûabÀ_up
;

1200 
block_avaûabÀ_À·
;

1201 
block_avaûabÀ_up_À·
;

1202 
block_avaûabÀ_up_right
;

1203 
jpos0
 = 
joff
 , 
jpos1
 = jof‡+ 1, 
jpos2
 = jof‡+ 2, 
jpos3
 = joff + 3;

1204 
jpos4
 = 
joff
 + 4, 
jpos5
 = jof‡+ 5, 
jpos6
 = jof‡+ 6, 
jpos7
 = joff + 7;

1206 
img≥l
 **
m¥
 = 
cuºSli˚
->
mb_¥ed
[
∂
];

1207 *
mb_size
 = 
p_Vid
->mb_size[
IS_LUMA
];

1209 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 , 
mb_size
, &
pix_a
);

1210 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 , 
joff
 - 1, 
mb_size
, &
pix_b
);

1211 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 + 8, 
joff
 - 1, 
mb_size
, &
pix_c
);

1212 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 - 1, 
mb_size
, &
pix_d
);

1214 
pix_c
.
avaûabÀ
 =Öix_c.avaûabÀ &&!(
ioff
 =8 && 
joff
 == 8);

1216 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

1218 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_a.
mb_addr
] : 0;

1219 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_b.
mb_addr
] : 0;

1220 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_c.
mb_addr
] : 0;

1221 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_d.
mb_addr
] : 0;

1225 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
;

1226 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

1227 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
;

1228 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
;

1231 i‡(!
block_avaûabÀ_À·
)

1232 
	`¥ötf
 ("w¨nög: I¡ø_8x8_H‹iz⁄èl_U∞¥edi˘i⁄ modênŸáŒowedáàmb %d\n", (Ë
cuºSli˚
->
cuºít_mb_ƒ
);

1235 i‡(
block_avaûabÀ_up
)

1237 
	`mem˝y
(&
PªdPñ
[1], &
imgY
[
pix_b
.
pos_y
][pix_b.
pos_x
], 
BLOCK_SIZE_8x8
 * (
img≥l
));

1241 #i‡(
IMGTYPE
 == 0)

1242 
	`mem£t
(&
PªdPñ
[1], 
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
], 
BLOCK_SIZE_8x8
 * (
img≥l
));

1244 
P_A
 = 
P_B
 = 
P_C
 = 
P_D
 = 
P_E
 = 
P_F
 = 
P_G
 = 
P_H
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

1248 i‡(
block_avaûabÀ_up_right
)

1250 
	`mem˝y
(&
PªdPñ
[9], &
imgY
[
pix_c
.
pos_y
][pix_c.
pos_x
], 
BLOCK_SIZE_8x8
 * (
img≥l
));

1254 #i‡(
IMGTYPE
 == 0)

1255 
	`mem£t
(&
PªdPñ
[9], PªdPñ[8], 
BLOCK_SIZE_8x8
 * (
img≥l
));

1257 
P_I
 = 
P_J
 = 
P_K
 = 
P_L
 = 
P_M
 = 
P_N
 = 
P_O
 = 
P_P
 = 
P_H
;

1261 i‡(
block_avaûabÀ_À·
)

1263 
img≥l
 **
img_¥ed
 = &
imgY
[
pix_a
.
pos_y
];

1264 
pos_x
 = 
pix_a
.pos_x;

1265 
P_Q
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

1266 
P_R
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

1267 
P_S
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

1268 
P_T
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

1269 
P_U
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

1270 
P_V
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

1271 
P_W
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

1272 
P_X
 = *(*(
img_¥ed
 ) + 
pos_x
);

1276 
P_Q
 = 
P_R
 = 
P_S
 = 
P_T
 = 
P_U
 = 
P_V
 = 
P_W
 = 
P_X
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

1279 i‡(
block_avaûabÀ_up_À·
)

1281 
P_Z
 = 
imgY
[
pix_d
.
pos_y
][pix_d.
pos_x
];

1285 
P_Z
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

1288 
	`LowPassF‹I¡ø8x8Pªd
(
PªdPñ
, 
block_avaûabÀ_up_À·
, 
block_avaûabÀ_up
, 
block_avaûabÀ_À·
);

1290 
PªdAºay
[ 0] = (
img≥l
Ë((
P_Q
 + 
P_R
 + 1) >> 1);

1291 
PªdAºay
[ 1] = (
img≥l
Ë((
P_S
 + 
P_Q
 + ((
P_R
) << 1) + 2) >> 2);

1292 
PªdAºay
[ 2] = (
img≥l
Ë((
P_R
 + 
P_S
 + 1) >> 1);

1293 
PªdAºay
[ 3] = (
img≥l
Ë((
P_T
 + 
P_R
 + ((
P_S
) << 1) + 2) >> 2);

1294 
PªdAºay
[ 4] = (
img≥l
Ë((
P_S
 + 
P_T
 + 1) >> 1);

1295 
PªdAºay
[ 5] = (
img≥l
Ë((
P_U
 + 
P_S
 + ((
P_T
) << 1) + 2) >> 2);

1296 
PªdAºay
[ 6] = (
img≥l
Ë((
P_T
 + 
P_U
 + 1) >> 1);

1297 
PªdAºay
[ 7] = (
img≥l
Ë((
P_V
 + 
P_T
 + ((
P_U
) << 1) + 2) >> 2);

1298 
PªdAºay
[ 8] = (
img≥l
Ë((
P_U
 + 
P_V
 + 1) >> 1);

1299 
PªdAºay
[ 9] = (
img≥l
Ë((
P_W
 + 
P_U
 + ((
P_V
) << 1) + 2) >> 2);

1300 
PªdAºay
[10] = (
img≥l
Ë((
P_V
 + 
P_W
 + 1) >> 1);

1301 
PªdAºay
[11] = (
img≥l
Ë((
P_X
 + 
P_V
 + ((
P_W
) << 1) + 2) >> 2);

1302 
PªdAºay
[12] = (
img≥l
Ë((
P_W
 + 
P_X
 + 1) >> 1);

1303 
PªdAºay
[13] = (
img≥l
Ë((
P_W
 + 
P_X
 + ((P_X) << 1) + 2) >> 2);

1304 
PªdAºay
[14] = (
img≥l
Ë
P_X
;

1305 
PªdAºay
[15] = (
img≥l
Ë
P_X
;

1306 
PªdAºay
[16] = (
img≥l
Ë
P_X
;

1307 
PªdAºay
[17] = (
img≥l
Ë
P_X
;

1308 
PªdAºay
[18] = (
img≥l
Ë
P_X
;

1309 
PªdAºay
[19] = (
img≥l
Ë
P_X
;

1310 
PªdAºay
[20] = (
img≥l
Ë
P_X
;

1311 
PªdAºay
[21] = (
img≥l
Ë
P_X
;

1313 
	`mem˝y
(&
m¥
[
jpos0
][
ioff
], &
PªdAºay
[0], 8 * (
img≥l
));

1314 
	`mem˝y
(&
m¥
[
jpos1
][
ioff
], &
PªdAºay
[2], 8 * (
img≥l
));

1315 
	`mem˝y
(&
m¥
[
jpos2
][
ioff
], &
PªdAºay
[4], 8 * (
img≥l
));

1316 
	`mem˝y
(&
m¥
[
jpos3
][
ioff
], &
PªdAºay
[6], 8 * (
img≥l
));

1317 
	`mem˝y
(&
m¥
[
jpos4
][
ioff
], &
PªdAºay
[8], 8 * (
img≥l
));

1318 
	`mem˝y
(&
m¥
[
jpos5
][
ioff
], &
PªdAºay
[10], 8 * (
img≥l
));

1319 
	`mem˝y
(&
m¥
[
jpos6
][
ioff
], &
PªdAºay
[12], 8 * (
img≥l
));

1320 
	`mem˝y
(&
m¥
[
jpos7
][
ioff
], &
PªdAºay
[14], 8 * (
img≥l
));

1322  
DECODING_OK
;

1323 
	}
}

1335 
ölöe
 
	$öåa8x8_h‹_down_¥ed
(
Ma¸oblock
 *
cuºMB
,

1336 
Cﬁ‹Pœ√
 
∂
,

1337 
ioff
,

1338 
joff
)

1340 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1341 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1343 
img≥l
 
PªdPñ
[25];

1344 
img≥l
 
PªdAºay
[22];

1345 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

1347 
PixñPos
 
pix_a
;

1348 
PixñPos
 
pix_b
, 
pix_c
, 
pix_d
;

1350 
block_avaûabÀ_up
;

1351 
block_avaûabÀ_À·
;

1352 
block_avaûabÀ_up_À·
;

1353 
block_avaûabÀ_up_right
;

1355 
img≥l
 *
¥ed_≥ls
;

1356 
img≥l
 **
mb_¥ed
 = &
cuºSli˚
->mb_¥ed[
∂
][
joff
];

1357 *
mb_size
 = 
p_Vid
->mb_size[
IS_LUMA
];

1359 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 , 
mb_size
, &
pix_a
);

1360 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 , 
joff
 - 1, 
mb_size
, &
pix_b
);

1361 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 + 8, 
joff
 - 1, 
mb_size
, &
pix_c
);

1362 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 - 1, 
mb_size
, &
pix_d
);

1364 
pix_c
.
avaûabÀ
 =Öix_c.avaûabÀ &&!(
ioff
 =8 && 
joff
 == 8);

1366 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

1368 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_a.
mb_addr
] : 0;

1369 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_b.
mb_addr
] : 0;

1370 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_c.
mb_addr
] : 0;

1371 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_d.
mb_addr
] : 0;

1375 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
;

1376 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

1377 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
;

1378 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
;

1381 i‡((!
block_avaûabÀ_up
)||(!
block_avaûabÀ_À·
)||(!
block_avaûabÀ_up_À·
))

1382 
	`¥ötf
 ("w¨nög: I¡ø_8x8_H‹iz⁄èl_Dow¿¥edi˘i⁄ modênŸáŒowedáàmb %d\n", (Ë
cuºSli˚
->
cuºít_mb_ƒ
);

1385 i‡(
block_avaûabÀ_up
)

1387 
	`mem˝y
(&
PªdPñ
[1], &
imgY
[
pix_b
.
pos_y
][pix_b.
pos_x
], 
BLOCK_SIZE_8x8
 * (
img≥l
));

1391 #i‡(
IMGTYPE
 == 0)

1392 
	`mem£t
(&
PªdPñ
[1], 
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
], 
BLOCK_SIZE_8x8
 * (
img≥l
));

1394 
P_A
 = 
P_B
 = 
P_C
 = 
P_D
 = 
P_E
 = 
P_F
 = 
P_G
 = 
P_H
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

1398 i‡(
block_avaûabÀ_up_right
)

1400 
	`mem˝y
(&
PªdPñ
[9], &
imgY
[
pix_c
.
pos_y
][pix_c.
pos_x
], 
BLOCK_SIZE_8x8
 * (
img≥l
));

1404 #i‡(
IMGTYPE
 == 0)

1405 
	`mem£t
(&
PªdPñ
[9], PªdPñ[8], 
BLOCK_SIZE_8x8
 * (
img≥l
));

1407 
P_I
 = 
P_J
 = 
P_K
 = 
P_L
 = 
P_M
 = 
P_N
 = 
P_O
 = 
P_P
 = 
P_H
;

1411 i‡(
block_avaûabÀ_À·
)

1413 
img≥l
 **
img_¥ed
 = &
imgY
[
pix_a
.
pos_y
];

1414 
pos_x
 = 
pix_a
.pos_x;

1415 
P_Q
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

1416 
P_R
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

1417 
P_S
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

1418 
P_T
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

1419 
P_U
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

1420 
P_V
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

1421 
P_W
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

1422 
P_X
 = *(*(
img_¥ed
 ) + 
pos_x
);

1426 
P_Q
 = 
P_R
 = 
P_S
 = 
P_T
 = 
P_U
 = 
P_V
 = 
P_W
 = 
P_X
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

1429 i‡(
block_avaûabÀ_up_À·
)

1431 
P_Z
 = 
imgY
[
pix_d
.
pos_y
][pix_d.
pos_x
];

1435 
P_Z
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

1438 
	`LowPassF‹I¡ø8x8Pªd
(
PªdPñ
, 
block_avaûabÀ_up_À·
, 
block_avaûabÀ_up
, 
block_avaûabÀ_À·
);

1440 
¥ed_≥ls
 = 
PªdAºay
;

1442 *
¥ed_≥ls
++ = (
img≥l
Ë((
P_X
 + 
P_W
 + 1) >> 1);

1443 *
¥ed_≥ls
++ = (
img≥l
Ë((
P_V
 + 
P_X
 + (
P_W
 << 1) + 2) >> 2);

1444 *
¥ed_≥ls
++ = (
img≥l
Ë((
P_W
 + 
P_V
 + 1) >> 1);

1445 *
¥ed_≥ls
++ = (
img≥l
Ë((
P_U
 + 
P_W
 + ((
P_V
) << 1) + 2) >> 2);

1446 *
¥ed_≥ls
++ = (
img≥l
Ë((
P_V
 + 
P_U
 + 1) >> 1);

1447 *
¥ed_≥ls
++ = (
img≥l
Ë((
P_T
 + 
P_V
 + ((
P_U
) << 1) + 2) >> 2);

1448 *
¥ed_≥ls
++ = (
img≥l
Ë((
P_U
 + 
P_T
 + 1) >> 1);

1449 *
¥ed_≥ls
++ = (
img≥l
Ë((
P_S
 + 
P_U
 + ((
P_T
) << 1) + 2) >> 2);

1450 *
¥ed_≥ls
++ = (
img≥l
Ë((
P_T
 + 
P_S
 + 1) >> 1);

1451 *
¥ed_≥ls
++ = (
img≥l
Ë((
P_R
 + 
P_T
 + ((
P_S
) << 1) + 2) >> 2);

1452 *
¥ed_≥ls
++ = (
img≥l
Ë((
P_S
 + 
P_R
 + 1) >> 1);

1453 *
¥ed_≥ls
++ = (
img≥l
Ë((
P_Q
 + 
P_S
 + ((
P_R
) << 1) + 2) >> 2);

1454 *
¥ed_≥ls
++ = (
img≥l
Ë((
P_R
 + 
P_Q
 + 1) >> 1);

1455 *
¥ed_≥ls
++ = (
img≥l
Ë((
P_Z
 + 
P_R
 + ((
P_Q
) << 1) + 2) >> 2);

1456 *
¥ed_≥ls
++ = (
img≥l
Ë((
P_Q
 + 
P_Z
 + 1) >> 1);

1457 *
¥ed_≥ls
++ = (
img≥l
Ë((
P_Q
 + 
P_A
 + ((
P_Z
) << 1) + 2) >> 2);

1458 *
¥ed_≥ls
++ = (
img≥l
Ë((
P_Z
 + 
P_B
 + ((
P_A
) << 1) + 2) >> 2);

1459 *
¥ed_≥ls
++ = (
img≥l
Ë((
P_A
 + 
P_C
 + ((
P_B
) << 1) + 2) >> 2);

1460 *
¥ed_≥ls
++ = (
img≥l
Ë((
P_B
 + 
P_D
 + ((
P_C
) << 1) + 2) >> 2);

1461 *
¥ed_≥ls
++ = (
img≥l
Ë((
P_C
 + 
P_E
 + ((
P_D
) << 1) + 2) >> 2);

1462 *
¥ed_≥ls
++ = (
img≥l
Ë((
P_D
 + 
P_F
 + ((
P_E
) << 1) + 2) >> 2);

1463 *
¥ed_≥ls
 = (
img≥l
Ë((
P_E
 + 
P_G
 + ((
P_F
) << 1) + 2) >> 2);

1465 
¥ed_≥ls
 = &
PªdAºay
[14];

1466 
	`mem˝y
((*
mb_¥ed
++Ë+ 
ioff
, 
¥ed_≥ls
, 8 * (
img≥l
));

1467 
¥ed_≥ls
 -= 2;

1468 
	`mem˝y
((*
mb_¥ed
++Ë+ 
ioff
, 
¥ed_≥ls
, 8 * (
img≥l
));

1469 
¥ed_≥ls
 -= 2;

1470 
	`mem˝y
((*
mb_¥ed
++Ë+ 
ioff
, 
¥ed_≥ls
, 8 * (
img≥l
));

1471 
¥ed_≥ls
 -= 2;

1472 
	`mem˝y
((*
mb_¥ed
++Ë+ 
ioff
, 
¥ed_≥ls
, 8 * (
img≥l
));

1473 
¥ed_≥ls
 -= 2;

1474 
	`mem˝y
((*
mb_¥ed
++Ë+ 
ioff
, 
¥ed_≥ls
, 8 * (
img≥l
));

1475 
¥ed_≥ls
 -= 2;

1476 
	`mem˝y
((*
mb_¥ed
++Ë+ 
ioff
, 
¥ed_≥ls
, 8 * (
img≥l
));

1477 
¥ed_≥ls
 -= 2;

1478 
	`mem˝y
((*
mb_¥ed
++Ë+ 
ioff
, 
¥ed_≥ls
, 8 * (
img≥l
));

1479 
¥ed_≥ls
 -= 2;

1480 
	`mem˝y
((*
mb_¥ed
 ) + 
ioff
, 
¥ed_≥ls
, 8 * (
img≥l
));

1482  
DECODING_OK
;

1483 
	}
}

1499 
	$öåa_¥ed_8x8_n‹mÆ
(
Ma¸oblock
 *
cuºMB
,

1500 
Cﬁ‹Pœ√
 
∂
,

1501 
ioff
,

1502 
joff
)

1505 
block_x
 = (
cuºMB
->block_xË+ (
ioff
 >> 2);

1506 
block_y
 = (
cuºMB
->block_yË+ (
joff
 >> 2);

1507 
byã
 
¥edmode
 = 
cuºMB
->
p_Sli˚
->
ùªdmode
[
block_y
][
block_x
];

1509 
cuºMB
->
ùmode_DPCM
 = 
¥edmode
;

1511 
¥edmode
)

1513 
DC_PRED
:

1514  (
	`öåa8x8_dc_¥ed
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

1516 
VERT_PRED
:

1517  (
	`öåa8x8_vît_¥ed
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

1519 
HOR_PRED
:

1520  (
	`öåa8x8_h‹_¥ed
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

1522 
DIAG_DOWN_RIGHT_PRED
:

1523  (
	`öåa8x8_düg_down_right_¥ed
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

1525 
DIAG_DOWN_LEFT_PRED
:

1526  (
	`öåa8x8_düg_down_À·_¥ed
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

1528 
VERT_RIGHT_PRED
:

1529  (
	`öåa8x8_vît_right_¥ed
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

1531 
VERT_LEFT_PRED
:

1532  (
	`öåa8x8_vît_À·_¥ed
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

1534 
HOR_UP_PRED
:

1535  (
	`öåa8x8_h‹_up_¥ed
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

1537 
HOR_DOWN_PRED
:

1538  (
	`öåa8x8_h‹_down_¥ed
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

1540 
	`¥ötf
("Eº‹: iŒegÆ i¡ø_8x8Öªdi˘i⁄ mode: %d\n", (Ë
¥edmode
);

1541  
SEARCH_SYNC
;

1544 
	}
}

	@ldecod/src/intra8x8_pred_mbaff.c

17 
	~"globÆ.h
"

18 
	~"öåa8x8_¥ed.h
"

19 
	~"mb_ac˚ss.h
"

20 
	~"image.h
"

38 
	#P_Z
 (
PªdPñ
[0])

	)

39 
	#P_A
 (
PªdPñ
[1])

	)

40 
	#P_B
 (
PªdPñ
[2])

	)

41 
	#P_C
 (
PªdPñ
[3])

	)

42 
	#P_D
 (
PªdPñ
[4])

	)

43 
	#P_E
 (
PªdPñ
[5])

	)

44 
	#P_F
 (
PªdPñ
[6])

	)

45 
	#P_G
 (
PªdPñ
[7])

	)

46 
	#P_H
 (
PªdPñ
[8])

	)

47 
	#P_I
 (
PªdPñ
[9])

	)

48 
	#P_J
 (
PªdPñ
[10])

	)

49 
	#P_K
 (
PªdPñ
[11])

	)

50 
	#P_L
 (
PªdPñ
[12])

	)

51 
	#P_M
 (
PªdPñ
[13])

	)

52 
	#P_N
 (
PªdPñ
[14])

	)

53 
	#P_O
 (
PªdPñ
[15])

	)

54 
	#P_P
 (
PªdPñ
[16])

	)

55 
	#P_Q
 (
PªdPñ
[17])

	)

56 
	#P_R
 (
PªdPñ
[18])

	)

57 
	#P_S
 (
PªdPñ
[19])

	)

58 
	#P_T
 (
PªdPñ
[20])

	)

59 
	#P_U
 (
PªdPñ
[21])

	)

60 
	#P_V
 (
PªdPñ
[22])

	)

61 
	#P_W
 (
PªdPñ
[23])

	)

62 
	#P_X
 (
PªdPñ
[24])

	)

70 
ölöe
 
	$LowPassF‹I¡ø8x8Pªd
(
img≥l
 *
PªdPñ
, 
block_up_À·
, 
block_up
, 
block_À·
)

72 
i
;

73 
img≥l
 
Lo›Aºay
[25];

75 
	`mem˝y
(&
Lo›Aºay
[0], &
PªdPñ
[0], 25 * (
img≥l
));

77 if(
block_up_À·
)

79 if(
block_up
 && 
block_À·
)

81 
Lo›Aºay
[0] = (
img≥l
Ë((
P_Q
 + (
P_Z
<<1Ë+ 
P_A
 + 2)>>2);

85 if(
block_up
)

86 
Lo›Aºay
[0] = (
img≥l
Ë((
P_Z
 + (P_Z<<1Ë+ 
P_A
 + 2)>>2);

87 i‡(
block_À·
)

88 
Lo›Aºay
[0] = (
img≥l
Ë((
P_Z
 + (P_Z<<1Ë+ 
P_Q
 + 2)>>2);

92 if(
block_up
)

94 if(
block_up_À·
)

96 
Lo›Aºay
[1] = (
img≥l
Ë((
PªdPñ
[0] + (PredPel[1]<<1) + PredPel[2] + 2)>>2);

99 
Lo›Aºay
[1] = (
img≥l
Ë((
PªdPñ
[1] + (PredPel[1]<<1) + PredPel[2] + 2)>>2);

102 
i
 = 2; i <16; i++)

104 
Lo›Aºay
[
i
] = (
img≥l
Ë((
PªdPñ
[i-1] + (PredPel[i]<<1) + PredPel[i+1] + 2)>>2);

106 
Lo›Aºay
[16] = (
img≥l
Ë((
P_P
 + (P_P<<1Ë+ 
P_O
 + 2)>>2);

109 if(
block_À·
)

111 if(
block_up_À·
)

112 
Lo›Aºay
[17] = (
img≥l
Ë((
P_Z
 + (
P_Q
<<1Ë+ 
P_R
 + 2)>>2);

114 
Lo›Aºay
[17] = (
img≥l
Ë((
P_Q
 + (P_Q<<1Ë+ 
P_R
 + 2)>>2);

116 
i
 = 18; i <24; i++)

118 
Lo›Aºay
[
i
] = (
img≥l
Ë((
PªdPñ
[i-1] + (PredPel[i]<<1) + PredPel[i+1] + 2)>>2);

120 
Lo›Aºay
[24] = (
img≥l
Ë((
P_W
 + (
P_X
<<1) + P_X + 2) >> 2);

123 
	`mem˝y
(&
PªdPñ
[0], &
Lo›Aºay
[0], 25 * (
img≥l
));

124 
	}
}

132 
ölöe
 
	$LowPassF‹I¡ø8x8PªdH‹
(
img≥l
 *
PªdPñ
, 
block_up_À·
, 
block_up
, 
block_À·
)

134 
i
;

135 
img≥l
 
Lo›Aºay
[25];

137 
	`mem˝y
(&
Lo›Aºay
[0], &
PªdPñ
[0], 25 * (
img≥l
));

139 if(
block_up_À·
)

141 if(
block_up
 && 
block_À·
)

143 
Lo›Aºay
[0] = (
img≥l
Ë((
P_Q
 + (
P_Z
<<1Ë+ 
P_A
 + 2)>>2);

147 if(
block_up
)

148 
Lo›Aºay
[0] = (
img≥l
Ë((
P_Z
 + (P_Z<<1Ë+ 
P_A
 + 2)>>2);

149 i‡(
block_À·
)

150 
Lo›Aºay
[0] = (
img≥l
Ë((
P_Z
 + (P_Z<<1Ë+ 
P_Q
 + 2)>>2);

154 if(
block_up
)

156 if(
block_up_À·
)

158 
Lo›Aºay
[1] = (
img≥l
Ë((
PªdPñ
[0] + (PredPel[1]<<1) + PredPel[2] + 2)>>2);

161 
Lo›Aºay
[1] = (
img≥l
Ë((
PªdPñ
[1] + (PredPel[1]<<1) + PredPel[2] + 2)>>2);

164 
i
 = 2; i <16; i++)

166 
Lo›Aºay
[
i
] = (
img≥l
Ë((
PªdPñ
[i-1] + (PredPel[i]<<1) + PredPel[i+1] + 2)>>2);

168 
Lo›Aºay
[16] = (
img≥l
Ë((
P_P
 + (P_P<<1Ë+ 
P_O
 + 2)>>2);

172 
	`mem˝y
(&
PªdPñ
[0], &
Lo›Aºay
[0], 17 * (
img≥l
));

173 
	}
}

181 
ölöe
 
	$LowPassF‹I¡ø8x8PªdVî
(
img≥l
 *
PªdPñ
, 
block_up_À·
, 
block_up
, 
block_À·
)

185 
i
;

186 
img≥l
 
Lo›Aºay
[25];

188 
	`mem˝y
(&
Lo›Aºay
[0], &
PªdPñ
[0], 25 * (
img≥l
));

190 if(
block_up_À·
)

192 if(
block_up
 && 
block_À·
)

194 
Lo›Aºay
[0] = (
img≥l
Ë((
P_Q
 + (
P_Z
<<1Ë+ 
P_A
 + 2)>>2);

198 if(
block_up
)

199 
Lo›Aºay
[0] = (
img≥l
Ë((
P_Z
 + (P_Z<<1Ë+ 
P_A
 + 2)>>2);

200 i‡(
block_À·
)

201 
Lo›Aºay
[0] = (
img≥l
Ë((
P_Z
 + (P_Z<<1Ë+ 
P_Q
 + 2)>>2);

205 if(
block_À·
)

207 if(
block_up_À·
)

208 
Lo›Aºay
[17] = (
img≥l
Ë((
P_Z
 + (
P_Q
<<1Ë+ 
P_R
 + 2)>>2);

210 
Lo›Aºay
[17] = (
img≥l
Ë((
P_Q
 + (P_Q<<1Ë+ 
P_R
 + 2)>>2);

212 
i
 = 18; i <24; i++)

214 
Lo›Aºay
[
i
] = (
img≥l
Ë((
PªdPñ
[i-1] + (PredPel[i]<<1) + PredPel[i+1] + 2)>>2);

216 
Lo›Aºay
[24] = (
img≥l
Ë((
P_W
 + (
P_X
<<1) + P_X + 2) >> 2);

219 
	`mem˝y
(&
PªdPñ
[0], &
Lo›Aºay
[0], 25 * (
img≥l
));

220 
	}
}

233 
ölöe
 
	$öåa8x8_dc_¥ed_mbaff
(
Ma¸oblock
 *
cuºMB
,

234 
Cﬁ‹Pœ√
 
∂
,

235 
ioff
,

236 
joff
)

238 
i
,
j
;

239 
s0
 = 0;

240 
img≥l
 
PªdPñ
[25];

241 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

242 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

244 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
cuºSli˚
->dec_picture;

245 
img≥l
 **
imgY
 = (
∂
Ë? 
dec_pi˘uª
->
imgUV
[pl - 1] : dec_picture->imgY;

247 
PixñPos
 
pix_a
[8];

248 
PixñPos
 
pix_b
, 
pix_c
, 
pix_d
;

250 
block_avaûabÀ_up
;

251 
block_avaûabÀ_À·
;

252 
block_avaûabÀ_up_À·
;

253 
block_avaûabÀ_up_right
;

256 
img≥l
 **
m¥
 = 
cuºSli˚
->
mb_¥ed
[
∂
];

257 *
mb_size
 = 
p_Vid
->mb_size[
IS_LUMA
];

259 
i
=0;i<8;i++)

261 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 + 
i
, 
mb_size
, &
pix_a
[i]);

264 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 , 
joff
 - 1, 
mb_size
, &
pix_b
);

265 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 + 8, 
joff
 - 1, 
mb_size
, &
pix_c
);

266 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 - 1, 
mb_size
, &
pix_d
);

268 
pix_c
.
avaûabÀ
 =Öix_c.avaûabÀ &&!(
ioff
 =8 && 
joff
 == 8);

270 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

272 
i
=0, 
block_avaûabÀ_À·
=1; i<8;i++)

273 
block_avaûabÀ_À·
 &
pix_a
[
i
].
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[pix_a[i].
mb_addr
]: 0;

274 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_b.
mb_addr
] : 0;

275 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_c.
mb_addr
] : 0;

276 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_d.
mb_addr
] : 0;

280 
block_avaûabÀ_À·
 = 
pix_a
[0].
avaûabÀ
;

281 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

282 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
;

283 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
;

287 i‡(
block_avaûabÀ_up
)

289 
	`mem˝y
(&
PªdPñ
[1], &
imgY
[
pix_b
.
pos_y
][pix_b.
pos_x
], 
BLOCK_SIZE_8x8
 * (
img≥l
));

293 #i‡(
IMGTYPE
 == 0)

294 
	`mem£t
(&
PªdPñ
[1], 
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
], 
BLOCK_SIZE_8x8
 * (
img≥l
));

296 
P_A
 = 
P_B
 = 
P_C
 = 
P_D
 = 
P_E
 = 
P_F
 = 
P_G
 = 
P_H
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

300 i‡(
block_avaûabÀ_up_right
)

302 
	`mem˝y
(&
PªdPñ
[9], &
imgY
[
pix_c
.
pos_y
][pix_c.
pos_x
], 
BLOCK_SIZE_8x8
 * (
img≥l
));

306 #i‡(
IMGTYPE
 == 0)

307 
	`mem£t
(&
PªdPñ
[9], PªdPñ[8], 
BLOCK_SIZE_8x8
 * (
img≥l
));

309 
P_I
 = 
P_J
 = 
P_K
 = 
P_L
 = 
P_M
 = 
P_N
 = 
P_O
 = 
P_P
 = 
P_H
;

313 i‡(
block_avaûabÀ_À·
)

315 
P_Q
 = 
imgY
[
pix_a
[0].
pos_y
][pix_a[0].
pos_x
];

316 
P_R
 = 
imgY
[
pix_a
[1].
pos_y
][pix_a[1].
pos_x
];

317 
P_S
 = 
imgY
[
pix_a
[2].
pos_y
][pix_a[2].
pos_x
];

318 
P_T
 = 
imgY
[
pix_a
[3].
pos_y
][pix_a[3].
pos_x
];

319 
P_U
 = 
imgY
[
pix_a
[4].
pos_y
][pix_a[4].
pos_x
];

320 
P_V
 = 
imgY
[
pix_a
[5].
pos_y
][pix_a[5].
pos_x
];

321 
P_W
 = 
imgY
[
pix_a
[6].
pos_y
][pix_a[6].
pos_x
];

322 
P_X
 = 
imgY
[
pix_a
[7].
pos_y
][pix_a[7].
pos_x
];

326 
P_Q
 = 
P_R
 = 
P_S
 = 
P_T
 = 
P_U
 = 
P_V
 = 
P_W
 = 
P_X
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

329 i‡(
block_avaûabÀ_up_À·
)

331 
P_Z
 = 
imgY
[
pix_d
.
pos_y
][pix_d.
pos_x
];

335 
P_Z
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

338 
	`LowPassF‹I¡ø8x8Pªd
(
PªdPñ
, 
block_avaûabÀ_up_À·
, 
block_avaûabÀ_up
, 
block_avaûabÀ_À·
);

340 i‡(
block_avaûabÀ_up
 && 
block_avaûabÀ_À·
)

343 
s0
 = (
P_A
 + 
P_B
 + 
P_C
 + 
P_D
 + 
P_E
 + 
P_F
 + 
P_G
 + 
P_H
 + 
P_Q
 + 
P_R
 + 
P_S
 + 
P_T
 + 
P_U
 + 
P_V
 + 
P_W
 + 
P_X
 + 8) >> 4;

345 i‡(!
block_avaûabÀ_up
 && 
block_avaûabÀ_À·
)

348 
s0
 = (
P_Q
 + 
P_R
 + 
P_S
 + 
P_T
 + 
P_U
 + 
P_V
 + 
P_W
 + 
P_X
 + 4) >> 3;

350 i‡(
block_avaûabÀ_up
 && !
block_avaûabÀ_À·
)

353 
s0
 = (
P_A
 + 
P_B
 + 
P_C
 + 
P_D
 + 
P_E
 + 
P_F
 + 
P_G
 + 
P_H
 + 4) >> 3;

358 
s0
 = 
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

361 
j
 = 
joff
; j < jof‡+ 
BLOCK_SIZE_8x8
; j++)

362 
i
 = 
ioff
; i < iof‡+ 
BLOCK_SIZE_8x8
; i++)

363 
m¥
[
j
][
i
] = (
img≥l
Ë
s0
;

365  
DECODING_OK
;

366 
	}
}

378 
ölöe
 
	$öåa8x8_vît_¥ed_mbaff
(
Ma¸oblock
 *
cuºMB
,

379 
Cﬁ‹Pœ√
 
∂
,

380 
ioff
,

381 
joff
)

383 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

384 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

386 
i
;

387 
img≥l
 
PªdPñ
[25];

388 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

390 
PixñPos
 
pix_a
[8];

391 
PixñPos
 
pix_b
, 
pix_c
, 
pix_d
;

393 
block_avaûabÀ_up
;

394 
block_avaûabÀ_À·
;

395 
block_avaûabÀ_up_À·
;

396 
block_avaûabÀ_up_right
;

399 
img≥l
 **
m¥
 = 
cuºSli˚
->
mb_¥ed
[
∂
];

400 *
mb_size
 = 
p_Vid
->mb_size[
IS_LUMA
];

402 
i
=0;i<8;i++)

404 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 + 
i
, 
mb_size
, &
pix_a
[i]);

407 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 , 
joff
 - 1, 
mb_size
, &
pix_b
);

408 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 + 8, 
joff
 - 1, 
mb_size
, &
pix_c
);

409 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 - 1, 
mb_size
, &
pix_d
);

411 
pix_c
.
avaûabÀ
 =Öix_c.avaûabÀ &&!(
ioff
 =8 && 
joff
 == 8);

413 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

415 
i
=0, 
block_avaûabÀ_À·
=1; i<8;i++)

416 
block_avaûabÀ_À·
 &
pix_a
[
i
].
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[pix_a[i].
mb_addr
]: 0;

417 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_b.
mb_addr
] : 0;

418 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_c.
mb_addr
] : 0;

419 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_d.
mb_addr
] : 0;

423 
block_avaûabÀ_À·
 = 
pix_a
[0].
avaûabÀ
;

424 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

425 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
;

426 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
;

429 i‡(!
block_avaûabÀ_up
)

430 
	`¥ötf
 ("w¨nög: I¡ø_8x8_Vîtiˇ»¥edi˘i⁄ modênŸáŒowedáàmb %d\n", (Ë
cuºSli˚
->
cuºít_mb_ƒ
);

433 i‡(
block_avaûabÀ_up
)

435 
	`mem˝y
(&
PªdPñ
[1], &
imgY
[
pix_b
.
pos_y
][pix_b.
pos_x
], 
BLOCK_SIZE_8x8
 * (
img≥l
));

439 #i‡(
IMGTYPE
 == 0)

440 
	`mem£t
(&
PªdPñ
[1], 
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
], 
BLOCK_SIZE_8x8
 * (
img≥l
));

442 
P_A
 = 
P_B
 = 
P_C
 = 
P_D
 = 
P_E
 = 
P_F
 = 
P_G
 = 
P_H
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

446 i‡(
block_avaûabÀ_up_right
)

448 
	`mem˝y
(&
PªdPñ
[9], &
imgY
[
pix_c
.
pos_y
][pix_c.
pos_x
], 
BLOCK_SIZE_8x8
 * (
img≥l
));

452 #i‡(
IMGTYPE
 == 0)

453 
	`mem£t
(&
PªdPñ
[9], PªdPñ[8], 
BLOCK_SIZE_8x8
 * (
img≥l
));

455 
P_I
 = 
P_J
 = 
P_K
 = 
P_L
 = 
P_M
 = 
P_N
 = 
P_O
 = 
P_P
 = 
P_H
;

459 i‡(
block_avaûabÀ_up_À·
)

461 
P_Z
 = 
imgY
[
pix_d
.
pos_y
][pix_d.
pos_x
];

465 
P_Z
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

468 
	`LowPassF‹I¡ø8x8PªdH‹
(&(
P_Z
), 
block_avaûabÀ_up_À·
, 
block_avaûabÀ_up
, 
block_avaûabÀ_À·
);

470 
i
=
joff
; i < jof‡+ 
BLOCK_SIZE_8x8
; i++)

472 
	`mem˝y
(&
m¥
[
i
][
ioff
], &
PªdPñ
[1], 
BLOCK_SIZE_8x8
 * (
img≥l
));

475  
DECODING_OK
;

476 
	}
}

488 
ölöe
 
	$öåa8x8_h‹_¥ed_mbaff
(
Ma¸oblock
 *
cuºMB
,

489 
Cﬁ‹Pœ√
 
∂
,

490 
ioff
,

491 
joff
)

493 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

494 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

497 
i
,
j
;

498 
img≥l
 
PªdPñ
[25];

499 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

501 
PixñPos
 
pix_a
[8];

502 
PixñPos
 
pix_b
, 
pix_c
, 
pix_d
;

504 
block_avaûabÀ_up
;

505 
block_avaûabÀ_À·
;

506 
block_avaûabÀ_up_À·
;

508 #i‡(
IMGTYPE
 != 0)

509 
ùos0
 = 
ioff
 , 
ùos1
 = iof‡+ 1, 
ùos2
 = iof‡+ 2, 
ùos3
 = ioff + 3;

510 
ùos4
 = 
ioff
 + 4, 
ùos5
 = iof‡+ 5, 
ùos6
 = iof‡+ 6, 
ùos7
 = ioff + 7;

512 
jpos
;

513 
img≥l
 **
m¥
 = 
cuºSli˚
->
mb_¥ed
[
∂
];

514 *
mb_size
 = 
p_Vid
->mb_size[
IS_LUMA
];

516 
i
=0;i<8;i++)

518 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 + 
i
, 
mb_size
, &
pix_a
[i]);

521 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 , 
joff
 - 1, 
mb_size
, &
pix_b
);

522 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 + 8, 
joff
 - 1, 
mb_size
, &
pix_c
);

523 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 - 1, 
mb_size
, &
pix_d
);

525 
pix_c
.
avaûabÀ
 =Öix_c.avaûabÀ &&!(
ioff
 =8 && 
joff
 == 8);

527 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

529 
i
=0, 
block_avaûabÀ_À·
=1; i<8;i++)

530 
block_avaûabÀ_À·
 &
pix_a
[
i
].
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[pix_a[i].
mb_addr
]: 0;

531 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_b.
mb_addr
] : 0;

532 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_d.
mb_addr
] : 0;

536 
block_avaûabÀ_À·
 = 
pix_a
[0].
avaûabÀ
;

537 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

538 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
;

541 i‡(!
block_avaûabÀ_À·
)

542 
	`¥ötf
 ("w¨nög: I¡ø_8x8_H‹iz⁄è»¥edi˘i⁄ modênŸáŒowedáàmb %d\n", (Ë
cuºSli˚
->
cuºít_mb_ƒ
);

545 i‡(
block_avaûabÀ_À·
)

547 
P_Q
 = 
imgY
[
pix_a
[0].
pos_y
][pix_a[0].
pos_x
];

548 
P_R
 = 
imgY
[
pix_a
[1].
pos_y
][pix_a[1].
pos_x
];

549 
P_S
 = 
imgY
[
pix_a
[2].
pos_y
][pix_a[2].
pos_x
];

550 
P_T
 = 
imgY
[
pix_a
[3].
pos_y
][pix_a[3].
pos_x
];

551 
P_U
 = 
imgY
[
pix_a
[4].
pos_y
][pix_a[4].
pos_x
];

552 
P_V
 = 
imgY
[
pix_a
[5].
pos_y
][pix_a[5].
pos_x
];

553 
P_W
 = 
imgY
[
pix_a
[6].
pos_y
][pix_a[6].
pos_x
];

554 
P_X
 = 
imgY
[
pix_a
[7].
pos_y
][pix_a[7].
pos_x
];

558 
P_Q
 = 
P_R
 = 
P_S
 = 
P_T
 = 
P_U
 = 
P_V
 = 
P_W
 = 
P_X
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

561 i‡(
block_avaûabÀ_up_À·
)

563 
P_Z
 = 
imgY
[
pix_d
.
pos_y
][pix_d.
pos_x
];

567 
P_Z
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

570 
	`LowPassF‹I¡ø8x8PªdVî
(&(
P_Z
), 
block_avaûabÀ_up_À·
, 
block_avaûabÀ_up
, 
block_avaûabÀ_À·
);

572 
j
=0; j < 
BLOCK_SIZE_8x8
; j++)

574 
jpos
 = 
j
 + 
joff
;

575 #i‡(
IMGTYPE
 == 0)

576 
	`mem£t
(&
m¥
[
jpos
][
ioff
], (
img≥l
Ë(&
P_Q
)[
j
], 8 * (imgpel));

578 
m¥
[
jpos
][
ùos0
] =

579 
m¥
[
jpos
][
ùos1
] =

580 
m¥
[
jpos
][
ùos2
] =

581 
m¥
[
jpos
][
ùos3
] =

582 
m¥
[
jpos
][
ùos4
] =

583 
m¥
[
jpos
][
ùos5
] =

584 
m¥
[
jpos
][
ùos6
] =

585 
m¥
[
jpos
][
ùos7
] = (
img≥l
Ë(&
P_Q
)[
j
];

589  
DECODING_OK
;

590 
	}
}

602 
ölöe
 
	$öåa8x8_düg_down_right_¥ed_mbaff
(
Ma¸oblock
 *
cuºMB
,

603 
Cﬁ‹Pœ√
 
∂
,

604 
ioff
,

605 
joff
)

607 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

608 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

611 
i
;

612 
img≥l
 
PªdPñ
[25];

613 
img≥l
 
PªdAºay
[16];

614 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

616 
PixñPos
 
pix_a
[8];

617 
PixñPos
 
pix_b
, 
pix_c
, 
pix_d
;

619 
block_avaûabÀ_up
;

620 
block_avaûabÀ_À·
;

621 
block_avaûabÀ_up_À·
;

622 
block_avaûabÀ_up_right
;

624 
img≥l
 **
m¥
 = 
cuºSli˚
->
mb_¥ed
[
∂
];

625 *
mb_size
 = 
p_Vid
->mb_size[
IS_LUMA
];

627 
i
=0;i<8;i++)

629 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 + 
i
, 
mb_size
, &
pix_a
[i]);

632 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 , 
joff
 - 1, 
mb_size
, &
pix_b
);

633 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 + 8, 
joff
 - 1, 
mb_size
, &
pix_c
);

634 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 - 1, 
mb_size
, &
pix_d
);

636 
pix_c
.
avaûabÀ
 =Öix_c.avaûabÀ &&!(
ioff
 =8 && 
joff
 == 8);

638 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

640 
i
=0, 
block_avaûabÀ_À·
=1; i<8;i++)

641 
block_avaûabÀ_À·
 &
pix_a
[
i
].
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[pix_a[i].
mb_addr
]: 0;

642 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_b.
mb_addr
] : 0;

643 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_c.
mb_addr
] : 0;

644 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_d.
mb_addr
] : 0;

648 
block_avaûabÀ_À·
 = 
pix_a
[0].
avaûabÀ
;

649 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

650 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
;

651 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
;

654 i‡((!
block_avaûabÀ_up
)||(!
block_avaûabÀ_À·
)||(!
block_avaûabÀ_up_À·
))

655 
	`¥ötf
 ("w¨nög: I¡ø_8x8_Düg⁄Æ_Down_Righà¥edi˘i⁄ modênŸáŒowedáàmb %d\n", (Ë
cuºSli˚
->
cuºít_mb_ƒ
);

658 i‡(
block_avaûabÀ_up
)

660 
	`mem˝y
(&
PªdPñ
[1], &
imgY
[
pix_b
.
pos_y
][pix_b.
pos_x
], 
BLOCK_SIZE_8x8
 * (
img≥l
));

664 #i‡(
IMGTYPE
 == 0)

665 
	`mem£t
(&
PªdPñ
[1], 
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
], 
BLOCK_SIZE_8x8
 * (
img≥l
));

667 
P_A
 = 
P_B
 = 
P_C
 = 
P_D
 = 
P_E
 = 
P_F
 = 
P_G
 = 
P_H
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

671 i‡(
block_avaûabÀ_up_right
)

673 
	`mem˝y
(&
PªdPñ
[9], &
imgY
[
pix_c
.
pos_y
][pix_c.
pos_x
], 
BLOCK_SIZE_8x8
 * (
img≥l
));

677 #i‡(
IMGTYPE
 == 0)

678 
	`mem£t
(&
PªdPñ
[9], PªdPñ[8], 
BLOCK_SIZE_8x8
 * (
img≥l
));

680 
P_I
 = 
P_J
 = 
P_K
 = 
P_L
 = 
P_M
 = 
P_N
 = 
P_O
 = 
P_P
 = 
P_H
;

684 i‡(
block_avaûabÀ_À·
)

686 
P_Q
 = 
imgY
[
pix_a
[0].
pos_y
][pix_a[0].
pos_x
];

687 
P_R
 = 
imgY
[
pix_a
[1].
pos_y
][pix_a[1].
pos_x
];

688 
P_S
 = 
imgY
[
pix_a
[2].
pos_y
][pix_a[2].
pos_x
];

689 
P_T
 = 
imgY
[
pix_a
[3].
pos_y
][pix_a[3].
pos_x
];

690 
P_U
 = 
imgY
[
pix_a
[4].
pos_y
][pix_a[4].
pos_x
];

691 
P_V
 = 
imgY
[
pix_a
[5].
pos_y
][pix_a[5].
pos_x
];

692 
P_W
 = 
imgY
[
pix_a
[6].
pos_y
][pix_a[6].
pos_x
];

693 
P_X
 = 
imgY
[
pix_a
[7].
pos_y
][pix_a[7].
pos_x
];

697 
P_Q
 = 
P_R
 = 
P_S
 = 
P_T
 = 
P_U
 = 
P_V
 = 
P_W
 = 
P_X
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

700 i‡(
block_avaûabÀ_up_À·
)

702 
P_Z
 = 
imgY
[
pix_d
.
pos_y
][pix_d.
pos_x
];

706 
P_Z
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

709 
	`LowPassF‹I¡ø8x8Pªd
(
PªdPñ
, 
block_avaûabÀ_up_À·
, 
block_avaûabÀ_up
, 
block_avaûabÀ_À·
);

712 
PªdAºay
[ 0] = (
img≥l
Ë((
P_X
 + 
P_V
 + 2*(
P_W
) + 2) >> 2);

713 
PªdAºay
[ 1] = (
img≥l
Ë((
P_W
 + 
P_U
 + 2*(
P_V
) + 2) >> 2);

714 
PªdAºay
[ 2] = (
img≥l
Ë((
P_V
 + 
P_T
 + 2*(
P_U
) + 2) >> 2);

715 
PªdAºay
[ 3] = (
img≥l
Ë((
P_U
 + 
P_S
 + 2*(
P_T
) + 2) >> 2);

716 
PªdAºay
[ 4] = (
img≥l
Ë((
P_T
 + 
P_R
 + 2*(
P_S
) + 2) >> 2);

717 
PªdAºay
[ 5] = (
img≥l
Ë((
P_S
 + 
P_Q
 + 2*(
P_R
) + 2) >> 2);

718 
PªdAºay
[ 6] = (
img≥l
Ë((
P_R
 + 
P_Z
 + 2*(
P_Q
) + 2) >> 2);

719 
PªdAºay
[ 7] = (
img≥l
Ë((
P_Q
 + 
P_A
 + 2*(
P_Z
) + 2) >> 2);

720 
PªdAºay
[ 8] = (
img≥l
Ë((
P_Z
 + 
P_B
 + 2*(
P_A
) + 2) >> 2);

721 
PªdAºay
[ 9] = (
img≥l
Ë((
P_A
 + 
P_C
 + 2*(
P_B
) + 2) >> 2);

722 
PªdAºay
[10] = (
img≥l
Ë((
P_B
 + 
P_D
 + 2*(
P_C
) + 2) >> 2);

723 
PªdAºay
[11] = (
img≥l
Ë((
P_C
 + 
P_E
 + 2*(
P_D
) + 2) >> 2);

724 
PªdAºay
[12] = (
img≥l
Ë((
P_D
 + 
P_F
 + 2*(
P_E
) + 2) >> 2);

725 
PªdAºay
[13] = (
img≥l
Ë((
P_E
 + 
P_G
 + 2*(
P_F
) + 2) >> 2);

726 
PªdAºay
[14] = (
img≥l
Ë((
P_F
 + 
P_H
 + 2*(
P_G
) + 2) >> 2);

728 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], &
PªdAºay
[7], 8 * (
img≥l
));

729 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], &
PªdAºay
[6], 8 * (
img≥l
));

730 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], &
PªdAºay
[5], 8 * (
img≥l
));

731 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], &
PªdAºay
[4], 8 * (
img≥l
));

732 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], &
PªdAºay
[3], 8 * (
img≥l
));

733 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], &
PªdAºay
[2], 8 * (
img≥l
));

734 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], &
PªdAºay
[1], 8 * (
img≥l
));

735 
	`mem˝y
(&
m¥
[
joff
 ][
ioff
], &
PªdAºay
[0], 8 * (
img≥l
));

737  
DECODING_OK
;

738 
	}
}

750 
ölöe
 
	$öåa8x8_düg_down_À·_¥ed_mbaff
(
Ma¸oblock
 *
cuºMB
,

751 
Cﬁ‹Pœ√
 
∂
,

752 
ioff
,

753 
joff
)

755 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

756 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

758 
i
;

759 
img≥l
 
PªdPñ
[25];

760 
img≥l
 
PªdAºay
[16];

761 
img≥l
 *
Pªd
 = &
PªdAºay
[0];

762 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

764 
PixñPos
 
pix_a
[8];

765 
PixñPos
 
pix_b
, 
pix_c
, 
pix_d
;

767 
block_avaûabÀ_up
;

768 
block_avaûabÀ_À·
;

769 
block_avaûabÀ_up_À·
;

770 
block_avaûabÀ_up_right
;

772 
img≥l
 **
m¥
 = 
cuºSli˚
->
mb_¥ed
[
∂
];

773 *
mb_size
 = 
p_Vid
->mb_size[
IS_LUMA
];

775 
i
=0;i<8;i++)

777 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 + 
i
, 
mb_size
, &
pix_a
[i]);

780 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 , 
joff
 - 1, 
mb_size
, &
pix_b
);

781 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 + 8, 
joff
 - 1, 
mb_size
, &
pix_c
);

782 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 - 1, 
mb_size
, &
pix_d
);

784 
pix_c
.
avaûabÀ
 =Öix_c.avaûabÀ &&!(
ioff
 =8 && 
joff
 == 8);

786 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

788 
i
=0, 
block_avaûabÀ_À·
=1; i<8;i++)

789 
block_avaûabÀ_À·
 &
pix_a
[
i
].
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[pix_a[i].
mb_addr
]: 0;

790 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_b.
mb_addr
] : 0;

791 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_c.
mb_addr
] : 0;

792 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_d.
mb_addr
] : 0;

796 
block_avaûabÀ_À·
 = 
pix_a
[0].
avaûabÀ
;

797 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

798 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
;

799 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
;

802 i‡(!
block_avaûabÀ_up
)

803 
	`¥ötf
 ("w¨nög: I¡ø_8x8_Düg⁄Æ_Down_Le·Öªdi˘i⁄ modênŸáŒowedáàmb %d\n", (Ë
cuºSli˚
->
cuºít_mb_ƒ
);

806 i‡(
block_avaûabÀ_up
)

808 
	`mem˝y
(&
PªdPñ
[1], &
imgY
[
pix_b
.
pos_y
][pix_b.
pos_x
], 
BLOCK_SIZE_8x8
 * (
img≥l
));

812 #i‡(
IMGTYPE
 == 0)

813 
	`mem£t
(&
PªdPñ
[1], 
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
], 
BLOCK_SIZE_8x8
 * (
img≥l
));

815 
P_A
 = 
P_B
 = 
P_C
 = 
P_D
 = 
P_E
 = 
P_F
 = 
P_G
 = 
P_H
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

819 i‡(
block_avaûabÀ_up_right
)

821 
	`mem˝y
(&
PªdPñ
[9], &
imgY
[
pix_c
.
pos_y
][pix_c.
pos_x
], 
BLOCK_SIZE_8x8
 * (
img≥l
));

825 #i‡(
IMGTYPE
 == 0)

826 
	`mem£t
(&
PªdPñ
[9], PªdPñ[8], 
BLOCK_SIZE_8x8
 * (
img≥l
));

828 
P_I
 = 
P_J
 = 
P_K
 = 
P_L
 = 
P_M
 = 
P_N
 = 
P_O
 = 
P_P
 = 
P_H
;

832 i‡(
block_avaûabÀ_À·
)

834 
P_Q
 = 
imgY
[
pix_a
[0].
pos_y
][pix_a[0].
pos_x
];

835 
P_R
 = 
imgY
[
pix_a
[1].
pos_y
][pix_a[1].
pos_x
];

836 
P_S
 = 
imgY
[
pix_a
[2].
pos_y
][pix_a[2].
pos_x
];

837 
P_T
 = 
imgY
[
pix_a
[3].
pos_y
][pix_a[3].
pos_x
];

838 
P_U
 = 
imgY
[
pix_a
[4].
pos_y
][pix_a[4].
pos_x
];

839 
P_V
 = 
imgY
[
pix_a
[5].
pos_y
][pix_a[5].
pos_x
];

840 
P_W
 = 
imgY
[
pix_a
[6].
pos_y
][pix_a[6].
pos_x
];

841 
P_X
 = 
imgY
[
pix_a
[7].
pos_y
][pix_a[7].
pos_x
];

845 
P_Q
 = 
P_R
 = 
P_S
 = 
P_T
 = 
P_U
 = 
P_V
 = 
P_W
 = 
P_X
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

848 i‡(
block_avaûabÀ_up_À·
)

850 
P_Z
 = 
imgY
[
pix_d
.
pos_y
][pix_d.
pos_x
];

854 
P_Z
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

857 
	`LowPassF‹I¡ø8x8Pªd
(
PªdPñ
, 
block_avaûabÀ_up_À·
, 
block_avaûabÀ_up
, 
block_avaûabÀ_À·
);

860 *
Pªd
++ = (
img≥l
Ë((
P_A
 + 
P_C
 + 2*(
P_B
) + 2) >> 2);

861 *
Pªd
++ = (
img≥l
Ë((
P_B
 + 
P_D
 + 2*(
P_C
) + 2) >> 2);

862 *
Pªd
++ = (
img≥l
Ë((
P_C
 + 
P_E
 + 2*(
P_D
) + 2) >> 2);

863 *
Pªd
++ = (
img≥l
Ë((
P_D
 + 
P_F
 + 2*(
P_E
) + 2) >> 2);

864 *
Pªd
++ = (
img≥l
Ë((
P_E
 + 
P_G
 + 2*(
P_F
) + 2) >> 2);

865 *
Pªd
++ = (
img≥l
Ë((
P_F
 + 
P_H
 + 2*(
P_G
) + 2) >> 2);

866 *
Pªd
++ = (
img≥l
Ë((
P_G
 + 
P_I
 + 2*(
P_H
) + 2) >> 2);

867 *
Pªd
++ = (
img≥l
Ë((
P_H
 + 
P_J
 + 2*(
P_I
) + 2) >> 2);

868 *
Pªd
++ = (
img≥l
Ë((
P_I
 + 
P_K
 + 2*(
P_J
) + 2) >> 2);

869 *
Pªd
++ = (
img≥l
Ë((
P_J
 + 
P_L
 + 2*(
P_K
) + 2) >> 2);

870 *
Pªd
++ = (
img≥l
Ë((
P_K
 + 
P_M
 + 2*(
P_L
) + 2) >> 2);

871 *
Pªd
++ = (
img≥l
Ë((
P_L
 + 
P_N
 + 2*(
P_M
) + 2) >> 2);

872 *
Pªd
++ = (
img≥l
Ë((
P_M
 + 
P_O
 + 2*(
P_N
) + 2) >> 2);

873 *
Pªd
++ = (
img≥l
Ë((
P_N
 + 
P_P
 + 2*(
P_O
) + 2) >> 2);

874 *
Pªd
 = (
img≥l
Ë((
P_O
 + 3*(
P_P
) + 2) >> 2);

876 
Pªd
 = &
PªdAºay
[ 0];

878 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], 
Pªd
++, 8 * (
img≥l
));

879 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], 
Pªd
++, 8 * (
img≥l
));

880 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], 
Pªd
++, 8 * (
img≥l
));

881 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], 
Pªd
++, 8 * (
img≥l
));

882 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], 
Pªd
++, 8 * (
img≥l
));

883 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], 
Pªd
++, 8 * (
img≥l
));

884 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], 
Pªd
++, 8 * (
img≥l
));

885 
	`mem˝y
(&
m¥
[
joff
 ][
ioff
], 
Pªd
 , 8 * (
img≥l
));

887  
DECODING_OK
;

888 
	}
}

900 
ölöe
 
	$öåa8x8_vît_right_¥ed_mbaff
(
Ma¸oblock
 *
cuºMB
,

901 
Cﬁ‹Pœ√
 
∂
,

902 
ioff
,

903 
joff
)

905 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

906 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

908 
i
;

909 
img≥l
 
PªdPñ
[25];

910 
img≥l
 
PªdAºay
[22];

911 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

913 
PixñPos
 
pix_a
[8];

914 
PixñPos
 
pix_b
, 
pix_c
, 
pix_d
;

916 
block_avaûabÀ_up
;

917 
block_avaûabÀ_À·
;

918 
block_avaûabÀ_up_À·
;

919 
block_avaûabÀ_up_right
;

921 
img≥l
 **
m¥
 = 
cuºSli˚
->
mb_¥ed
[
∂
];

922 *
mb_size
 = 
p_Vid
->mb_size[
IS_LUMA
];

924 
i
=0;i<8;i++)

926 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 + 
i
, 
mb_size
, &
pix_a
[i]);

929 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 , 
joff
 - 1, 
mb_size
, &
pix_b
);

930 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 + 8, 
joff
 - 1, 
mb_size
, &
pix_c
);

931 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 - 1, 
mb_size
, &
pix_d
);

933 
pix_c
.
avaûabÀ
 =Öix_c.avaûabÀ &&!(
ioff
 =8 && 
joff
 == 8);

935 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

937 
i
=0, 
block_avaûabÀ_À·
=1; i<8;i++)

938 
block_avaûabÀ_À·
 &
pix_a
[
i
].
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[pix_a[i].
mb_addr
]: 0;

939 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_b.
mb_addr
] : 0;

940 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_c.
mb_addr
] : 0;

941 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_d.
mb_addr
] : 0;

945 
block_avaûabÀ_À·
 = 
pix_a
[0].
avaûabÀ
;

946 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

947 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
;

948 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
;

951 i‡((!
block_avaûabÀ_up
)||(!
block_avaûabÀ_À·
)||(!
block_avaûabÀ_up_À·
))

952 
	`¥ötf
 ("w¨nög: I¡ø_8x8_Vîtiˇl_Righà¥edi˘i⁄ modênŸáŒowedáàmb %d\n", (Ë
cuºSli˚
->
cuºít_mb_ƒ
);

955 i‡(
block_avaûabÀ_up
)

957 
	`mem˝y
(&
PªdPñ
[1], &
imgY
[
pix_b
.
pos_y
][pix_b.
pos_x
], 
BLOCK_SIZE_8x8
 * (
img≥l
));

961 #i‡(
IMGTYPE
 == 0)

962 
	`mem£t
(&
PªdPñ
[1], 
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
], 
BLOCK_SIZE_8x8
 * (
img≥l
));

964 
P_A
 = 
P_B
 = 
P_C
 = 
P_D
 = 
P_E
 = 
P_F
 = 
P_G
 = 
P_H
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

968 i‡(
block_avaûabÀ_up_right
)

970 
	`mem˝y
(&
PªdPñ
[9], &
imgY
[
pix_c
.
pos_y
][pix_c.
pos_x
], 
BLOCK_SIZE_8x8
 * (
img≥l
));

974 #i‡(
IMGTYPE
 == 0)

975 
	`mem£t
(&
PªdPñ
[9], PªdPñ[8], 
BLOCK_SIZE_8x8
 * (
img≥l
));

977 
P_I
 = 
P_J
 = 
P_K
 = 
P_L
 = 
P_M
 = 
P_N
 = 
P_O
 = 
P_P
 = 
P_H
;

981 i‡(
block_avaûabÀ_À·
)

983 
P_Q
 = 
imgY
[
pix_a
[0].
pos_y
][pix_a[0].
pos_x
];

984 
P_R
 = 
imgY
[
pix_a
[1].
pos_y
][pix_a[1].
pos_x
];

985 
P_S
 = 
imgY
[
pix_a
[2].
pos_y
][pix_a[2].
pos_x
];

986 
P_T
 = 
imgY
[
pix_a
[3].
pos_y
][pix_a[3].
pos_x
];

987 
P_U
 = 
imgY
[
pix_a
[4].
pos_y
][pix_a[4].
pos_x
];

988 
P_V
 = 
imgY
[
pix_a
[5].
pos_y
][pix_a[5].
pos_x
];

989 
P_W
 = 
imgY
[
pix_a
[6].
pos_y
][pix_a[6].
pos_x
];

990 
P_X
 = 
imgY
[
pix_a
[7].
pos_y
][pix_a[7].
pos_x
];

994 
P_Q
 = 
P_R
 = 
P_S
 = 
P_T
 = 
P_U
 = 
P_V
 = 
P_W
 = 
P_X
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

997 i‡(
block_avaûabÀ_up_À·
)

999 
P_Z
 = 
imgY
[
pix_d
.
pos_y
][pix_d.
pos_x
];

1003 
P_Z
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

1006 
	`LowPassF‹I¡ø8x8Pªd
(
PªdPñ
, 
block_avaûabÀ_up_À·
, 
block_avaûabÀ_up
, 
block_avaûabÀ_À·
);

1008 
PªdAºay
[ 0] = (
img≥l
Ë((
P_V
 + 
P_T
 + (
P_U
 << 1) + 2) >> 2);

1009 
PªdAºay
[ 1] = (
img≥l
Ë((
P_T
 + 
P_R
 + (
P_S
 << 1) + 2) >> 2);

1010 
PªdAºay
[ 2] = (
img≥l
Ë((
P_R
 + 
P_Z
 + (
P_Q
 << 1) + 2) >> 2);

1011 
PªdAºay
[ 3] = (
img≥l
Ë((
P_Z
 + 
P_A
 + 1) >> 1);

1012 
PªdAºay
[ 4] = (
img≥l
Ë((
P_A
 + 
P_B
 + 1) >> 1);

1013 
PªdAºay
[ 5] = (
img≥l
Ë((
P_B
 + 
P_C
 + 1) >> 1);

1014 
PªdAºay
[ 6] = (
img≥l
Ë((
P_C
 + 
P_D
 + 1) >> 1);

1015 
PªdAºay
[ 7] = (
img≥l
Ë((
P_D
 + 
P_E
 + 1) >> 1);

1016 
PªdAºay
[ 8] = (
img≥l
Ë((
P_E
 + 
P_F
 + 1) >> 1);

1017 
PªdAºay
[ 9] = (
img≥l
Ë((
P_F
 + 
P_G
 + 1) >> 1);

1018 
PªdAºay
[10] = (
img≥l
Ë((
P_G
 + 
P_H
 + 1) >> 1);

1020 
PªdAºay
[11] = (
img≥l
Ë((
P_W
 + 
P_U
 + (
P_V
 << 1) + 2) >> 2);

1021 
PªdAºay
[12] = (
img≥l
Ë((
P_U
 + 
P_S
 + (
P_T
 << 1) + 2) >> 2);

1022 
PªdAºay
[13] = (
img≥l
Ë((
P_S
 + 
P_Q
 + (
P_R
 << 1) + 2) >> 2);

1023 
PªdAºay
[14] = (
img≥l
Ë((
P_Q
 + 
P_A
 + 2*
P_Z
 + 2) >> 2);

1024 
PªdAºay
[15] = (
img≥l
Ë((
P_Z
 + 
P_B
 + 2*
P_A
 + 2) >> 2);

1025 
PªdAºay
[16] = (
img≥l
Ë((
P_A
 + 
P_C
 + 2*
P_B
 + 2) >> 2);

1026 
PªdAºay
[17] = (
img≥l
Ë((
P_B
 + 
P_D
 + 2*
P_C
 + 2) >> 2);

1027 
PªdAºay
[18] = (
img≥l
Ë((
P_C
 + 
P_E
 + 2*
P_D
 + 2) >> 2);

1028 
PªdAºay
[19] = (
img≥l
Ë((
P_D
 + 
P_F
 + 2*
P_E
 + 2) >> 2);

1029 
PªdAºay
[20] = (
img≥l
Ë((
P_E
 + 
P_G
 + 2*
P_F
 + 2) >> 2);

1030 
PªdAºay
[21] = (
img≥l
Ë((
P_F
 + 
P_H
 + 2*
P_G
 + 2) >> 2);

1032 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], &
PªdAºay
[ 3], 8 * (
img≥l
));

1033 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], &
PªdAºay
[14], 8 * (
img≥l
));

1034 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], &
PªdAºay
[ 2], 8 * (
img≥l
));

1035 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], &
PªdAºay
[13], 8 * (
img≥l
));

1036 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], &
PªdAºay
[ 1], 8 * (
img≥l
));

1037 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], &
PªdAºay
[12], 8 * (
img≥l
));

1038 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], &
PªdAºay
[ 0], 8 * (
img≥l
));

1039 
	`mem˝y
(&
m¥
[
joff
 ][
ioff
], &
PªdAºay
[11], 8 * (
img≥l
));

1041  
DECODING_OK
;

1042 
	}
}

1055 
ölöe
 
	$öåa8x8_vît_À·_¥ed_mbaff
(
Ma¸oblock
 *
cuºMB
,

1056 
Cﬁ‹Pœ√
 
∂
,

1057 
ioff
,

1058 
joff
)

1060 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1061 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1063 
i
;

1064 
img≥l
 
PªdPñ
[25];

1065 
img≥l
 
PªdAºay
[22];

1066 
img≥l
 *
¥ed_≥l
 = &
PªdAºay
[0];

1067 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

1069 
PixñPos
 
pix_a
[8];

1070 
PixñPos
 
pix_b
, 
pix_c
, 
pix_d
;

1072 
block_avaûabÀ_up
;

1073 
block_avaûabÀ_À·
;

1074 
block_avaûabÀ_up_À·
;

1075 
block_avaûabÀ_up_right
;

1077 
img≥l
 **
m¥
 = 
cuºSli˚
->
mb_¥ed
[
∂
];

1078 *
mb_size
 = 
p_Vid
->mb_size[
IS_LUMA
];

1080 
i
=0;i<8;i++)

1082 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 + 
i
, 
mb_size
, &
pix_a
[i]);

1085 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 , 
joff
 - 1, 
mb_size
, &
pix_b
);

1086 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 + 8, 
joff
 - 1, 
mb_size
, &
pix_c
);

1087 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 - 1, 
mb_size
, &
pix_d
);

1089 
pix_c
.
avaûabÀ
 =Öix_c.avaûabÀ &&!(
ioff
 =8 && 
joff
 == 8);

1091 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

1093 
i
=0, 
block_avaûabÀ_À·
=1; i<8;i++)

1094 
block_avaûabÀ_À·
 &
pix_a
[
i
].
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[pix_a[i].
mb_addr
]: 0;

1095 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_b.
mb_addr
] : 0;

1096 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_c.
mb_addr
] : 0;

1097 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_d.
mb_addr
] : 0;

1101 
block_avaûabÀ_À·
 = 
pix_a
[0].
avaûabÀ
;

1102 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

1103 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
;

1104 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
;

1107 i‡(!
block_avaûabÀ_up
)

1108 
	`¥ötf
 ("w¨nög: I¡ø_4x4_Vîtiˇl_Le·Öªdi˘i⁄ modênŸáŒowedáàmb %d\n", (Ë
cuºSli˚
->
cuºít_mb_ƒ
);

1111 i‡(
block_avaûabÀ_up
)

1113 
	`mem˝y
(&
PªdPñ
[1], &
imgY
[
pix_b
.
pos_y
][pix_b.
pos_x
], 
BLOCK_SIZE_8x8
 * (
img≥l
));

1117 #i‡(
IMGTYPE
 == 0)

1118 
	`mem£t
(&
PªdPñ
[1], 
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
], 
BLOCK_SIZE_8x8
 * (
img≥l
));

1120 
P_A
 = 
P_B
 = 
P_C
 = 
P_D
 = 
P_E
 = 
P_F
 = 
P_G
 = 
P_H
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

1124 i‡(
block_avaûabÀ_up_right
)

1126 
	`mem˝y
(&
PªdPñ
[9], &
imgY
[
pix_c
.
pos_y
][pix_c.
pos_x
], 
BLOCK_SIZE_8x8
 * (
img≥l
));

1130 #i‡(
IMGTYPE
 == 0)

1131 
	`mem£t
(&
PªdPñ
[9], PªdPñ[8], 
BLOCK_SIZE_8x8
 * (
img≥l
));

1133 
P_I
 = 
P_J
 = 
P_K
 = 
P_L
 = 
P_M
 = 
P_N
 = 
P_O
 = 
P_P
 = 
P_H
;

1137 i‡(
block_avaûabÀ_À·
)

1139 
P_Q
 = 
imgY
[
pix_a
[0].
pos_y
][pix_a[0].
pos_x
];

1140 
P_R
 = 
imgY
[
pix_a
[1].
pos_y
][pix_a[1].
pos_x
];

1141 
P_S
 = 
imgY
[
pix_a
[2].
pos_y
][pix_a[2].
pos_x
];

1142 
P_T
 = 
imgY
[
pix_a
[3].
pos_y
][pix_a[3].
pos_x
];

1143 
P_U
 = 
imgY
[
pix_a
[4].
pos_y
][pix_a[4].
pos_x
];

1144 
P_V
 = 
imgY
[
pix_a
[5].
pos_y
][pix_a[5].
pos_x
];

1145 
P_W
 = 
imgY
[
pix_a
[6].
pos_y
][pix_a[6].
pos_x
];

1146 
P_X
 = 
imgY
[
pix_a
[7].
pos_y
][pix_a[7].
pos_x
];

1150 
P_Q
 = 
P_R
 = 
P_S
 = 
P_T
 = 
P_U
 = 
P_V
 = 
P_W
 = 
P_X
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

1153 i‡(
block_avaûabÀ_up_À·
)

1155 
P_Z
 = 
imgY
[
pix_d
.
pos_y
][pix_d.
pos_x
];

1159 
P_Z
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

1162 
	`LowPassF‹I¡ø8x8Pªd
(
PªdPñ
, 
block_avaûabÀ_up_À·
, 
block_avaûabÀ_up
, 
block_avaûabÀ_À·
);

1164 *
¥ed_≥l
++ = (
img≥l
Ë((
P_A
 + 
P_B
 + 1) >> 1);

1165 *
¥ed_≥l
++ = (
img≥l
Ë((
P_B
 + 
P_C
 + 1) >> 1);

1166 *
¥ed_≥l
++ = (
img≥l
Ë((
P_C
 + 
P_D
 + 1) >> 1);

1167 *
¥ed_≥l
++ = (
img≥l
Ë((
P_D
 + 
P_E
 + 1) >> 1);

1168 *
¥ed_≥l
++ = (
img≥l
Ë((
P_E
 + 
P_F
 + 1) >> 1);

1169 *
¥ed_≥l
++ = (
img≥l
Ë((
P_F
 + 
P_G
 + 1) >> 1);

1170 *
¥ed_≥l
++ = (
img≥l
Ë((
P_G
 + 
P_H
 + 1) >> 1);

1171 *
¥ed_≥l
++ = (
img≥l
Ë((
P_H
 + 
P_I
 + 1) >> 1);

1172 *
¥ed_≥l
++ = (
img≥l
Ë((
P_I
 + 
P_J
 + 1) >> 1);

1173 *
¥ed_≥l
++ = (
img≥l
Ë((
P_J
 + 
P_K
 + 1) >> 1);

1174 *
¥ed_≥l
++ = (
img≥l
Ë((
P_K
 + 
P_L
 + 1) >> 1);

1175 *
¥ed_≥l
++ = (
img≥l
Ë((
P_A
 + 
P_C
 + 2*
P_B
 + 2) >> 2);

1176 *
¥ed_≥l
++ = (
img≥l
Ë((
P_B
 + 
P_D
 + 2*
P_C
 + 2) >> 2);

1177 *
¥ed_≥l
++ = (
img≥l
Ë((
P_C
 + 
P_E
 + 2*
P_D
 + 2) >> 2);

1178 *
¥ed_≥l
++ = (
img≥l
Ë((
P_D
 + 
P_F
 + 2*
P_E
 + 2) >> 2);

1179 *
¥ed_≥l
++ = (
img≥l
Ë((
P_E
 + 
P_G
 + 2*
P_F
 + 2) >> 2);

1180 *
¥ed_≥l
++ = (
img≥l
Ë((
P_F
 + 
P_H
 + 2*
P_G
 + 2) >> 2);

1181 *
¥ed_≥l
++ = (
img≥l
Ë((
P_G
 + 
P_I
 + 2*
P_H
 + 2) >> 2);

1182 *
¥ed_≥l
++ = (
img≥l
Ë((
P_H
 + 
P_J
 + (
P_I
 << 1) + 2) >> 2);

1183 *
¥ed_≥l
++ = (
img≥l
Ë((
P_I
 + 
P_K
 + (
P_J
 << 1) + 2) >> 2);

1184 *
¥ed_≥l
++ = (
img≥l
Ë((
P_J
 + 
P_L
 + (
P_K
 << 1) + 2) >> 2);

1185 *
¥ed_≥l
 = (
img≥l
Ë((
P_K
 + 
P_M
 + (
P_L
 << 1) + 2) >> 2);

1187 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], &
PªdAºay
[ 0], 8 * (
img≥l
));

1188 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], &
PªdAºay
[11], 8 * (
img≥l
));

1189 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], &
PªdAºay
[ 1], 8 * (
img≥l
));

1190 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], &
PªdAºay
[12], 8 * (
img≥l
));

1191 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], &
PªdAºay
[ 2], 8 * (
img≥l
));

1192 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], &
PªdAºay
[13], 8 * (
img≥l
));

1193 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], &
PªdAºay
[ 3], 8 * (
img≥l
));

1194 
	`mem˝y
(&
m¥
[
joff
 ][
ioff
], &
PªdAºay
[14], 8 * (
img≥l
));

1196  
DECODING_OK
;

1197 
	}
}

1209 
ölöe
 
	$öåa8x8_h‹_up_¥ed_mbaff
(
Ma¸oblock
 *
cuºMB
,

1210 
Cﬁ‹Pœ√
 
∂
,

1211 
ioff
,

1212 
joff
)

1214 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1215 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1217 
i
;

1218 
img≥l
 
PªdPñ
[25];

1219 
img≥l
 
PªdAºay
[22];

1220 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

1222 
PixñPos
 
pix_a
[8];

1223 
PixñPos
 
pix_b
, 
pix_c
, 
pix_d
;

1225 
block_avaûabÀ_up
;

1226 
block_avaûabÀ_À·
;

1227 
block_avaûabÀ_up_À·
;

1228 
block_avaûabÀ_up_right
;

1229 
jpos0
 = 
joff
 , 
jpos1
 = jof‡+ 1, 
jpos2
 = jof‡+ 2, 
jpos3
 = joff + 3;

1230 
jpos4
 = 
joff
 + 4, 
jpos5
 = jof‡+ 5, 
jpos6
 = jof‡+ 6, 
jpos7
 = joff + 7;

1232 
img≥l
 **
m¥
 = 
cuºSli˚
->
mb_¥ed
[
∂
];

1233 *
mb_size
 = 
p_Vid
->mb_size[
IS_LUMA
];

1235 
i
=0;i<8;i++)

1237 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 + 
i
, 
mb_size
, &
pix_a
[i]);

1240 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 , 
joff
 - 1, 
mb_size
, &
pix_b
);

1241 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 + 8, 
joff
 - 1, 
mb_size
, &
pix_c
);

1242 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 - 1, 
mb_size
, &
pix_d
);

1244 
pix_c
.
avaûabÀ
 =Öix_c.avaûabÀ &&!(
ioff
 =8 && 
joff
 == 8);

1246 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

1248 
i
=0, 
block_avaûabÀ_À·
=1; i<8;i++)

1249 
block_avaûabÀ_À·
 &
pix_a
[
i
].
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[pix_a[i].
mb_addr
]: 0;

1250 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_b.
mb_addr
] : 0;

1251 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_c.
mb_addr
] : 0;

1252 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_d.
mb_addr
] : 0;

1256 
block_avaûabÀ_À·
 = 
pix_a
[0].
avaûabÀ
;

1257 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

1258 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
;

1259 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
;

1262 i‡(!
block_avaûabÀ_À·
)

1263 
	`¥ötf
 ("w¨nög: I¡ø_8x8_H‹iz⁄èl_U∞¥edi˘i⁄ modênŸáŒowedáàmb %d\n", (Ë
cuºSli˚
->
cuºít_mb_ƒ
);

1266 i‡(
block_avaûabÀ_up
)

1268 
	`mem˝y
(&
PªdPñ
[1], &
imgY
[
pix_b
.
pos_y
][pix_b.
pos_x
], 
BLOCK_SIZE_8x8
 * (
img≥l
));

1272 #i‡(
IMGTYPE
 == 0)

1273 
	`mem£t
(&
PªdPñ
[1], 
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
], 
BLOCK_SIZE_8x8
 * (
img≥l
));

1275 
P_A
 = 
P_B
 = 
P_C
 = 
P_D
 = 
P_E
 = 
P_F
 = 
P_G
 = 
P_H
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

1279 i‡(
block_avaûabÀ_up_right
)

1281 
	`mem˝y
(&
PªdPñ
[9], &
imgY
[
pix_c
.
pos_y
][pix_c.
pos_x
], 
BLOCK_SIZE_8x8
 * (
img≥l
));

1285 #i‡(
IMGTYPE
 == 0)

1286 
	`mem£t
(&
PªdPñ
[9], PªdPñ[8], 
BLOCK_SIZE_8x8
 * (
img≥l
));

1288 
P_I
 = 
P_J
 = 
P_K
 = 
P_L
 = 
P_M
 = 
P_N
 = 
P_O
 = 
P_P
 = 
P_H
;

1292 i‡(
block_avaûabÀ_À·
)

1294 
P_Q
 = 
imgY
[
pix_a
[0].
pos_y
][pix_a[0].
pos_x
];

1295 
P_R
 = 
imgY
[
pix_a
[1].
pos_y
][pix_a[1].
pos_x
];

1296 
P_S
 = 
imgY
[
pix_a
[2].
pos_y
][pix_a[2].
pos_x
];

1297 
P_T
 = 
imgY
[
pix_a
[3].
pos_y
][pix_a[3].
pos_x
];

1298 
P_U
 = 
imgY
[
pix_a
[4].
pos_y
][pix_a[4].
pos_x
];

1299 
P_V
 = 
imgY
[
pix_a
[5].
pos_y
][pix_a[5].
pos_x
];

1300 
P_W
 = 
imgY
[
pix_a
[6].
pos_y
][pix_a[6].
pos_x
];

1301 
P_X
 = 
imgY
[
pix_a
[7].
pos_y
][pix_a[7].
pos_x
];

1305 
P_Q
 = 
P_R
 = 
P_S
 = 
P_T
 = 
P_U
 = 
P_V
 = 
P_W
 = 
P_X
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

1308 i‡(
block_avaûabÀ_up_À·
)

1310 
P_Z
 = 
imgY
[
pix_d
.
pos_y
][pix_d.
pos_x
];

1314 
P_Z
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

1317 
	`LowPassF‹I¡ø8x8Pªd
(
PªdPñ
, 
block_avaûabÀ_up_À·
, 
block_avaûabÀ_up
, 
block_avaûabÀ_À·
);

1319 
PªdAºay
[ 0] = (
img≥l
Ë((
P_Q
 + 
P_R
 + 1) >> 1);

1320 
PªdAºay
[ 1] = (
img≥l
Ë((
P_S
 + 
P_Q
 + (
P_R
 << 1) + 2) >> 2);

1321 
PªdAºay
[ 2] = (
img≥l
Ë((
P_R
 + 
P_S
 + 1) >> 1);

1322 
PªdAºay
[ 3] = (
img≥l
Ë((
P_T
 + 
P_R
 + (
P_S
 << 1) + 2) >> 2);

1323 
PªdAºay
[ 4] = (
img≥l
Ë((
P_S
 + 
P_T
 + 1) >> 1);

1324 
PªdAºay
[ 5] = (
img≥l
Ë((
P_U
 + 
P_S
 + (
P_T
 << 1) + 2) >> 2);

1325 
PªdAºay
[ 6] = (
img≥l
Ë((
P_T
 + 
P_U
 + 1) >> 1);

1326 
PªdAºay
[ 7] = (
img≥l
Ë((
P_V
 + 
P_T
 + (
P_U
 << 1) + 2) >> 2);

1327 
PªdAºay
[ 8] = (
img≥l
Ë((
P_U
 + 
P_V
 + 1) >> 1);

1328 
PªdAºay
[ 9] = (
img≥l
Ë((
P_W
 + 
P_U
 + (
P_V
 << 1) + 2) >> 2);

1329 
PªdAºay
[10] = (
img≥l
Ë((
P_V
 + 
P_W
 + 1) >> 1);

1330 
PªdAºay
[11] = (
img≥l
Ë((
P_X
 + 
P_V
 + (
P_W
 << 1) + 2) >> 2);

1331 
PªdAºay
[12] = (
img≥l
Ë((
P_W
 + 
P_X
 + 1) >> 1);

1332 
PªdAºay
[13] = (
img≥l
Ë((
P_W
 + 
P_X
 + (P_X << 1) + 2) >> 2);

1333 
PªdAºay
[14] = (
img≥l
Ë
P_X
;

1334 
PªdAºay
[15] = (
img≥l
Ë
P_X
;

1335 
PªdAºay
[16] = (
img≥l
Ë
P_X
;

1336 
PªdAºay
[17] = (
img≥l
Ë
P_X
;

1337 
PªdAºay
[18] = (
img≥l
Ë
P_X
;

1338 
PªdAºay
[19] = (
img≥l
Ë
P_X
;

1339 
PªdAºay
[20] = (
img≥l
Ë
P_X
;

1340 
PªdAºay
[21] = (
img≥l
Ë
P_X
;

1342 
	`mem˝y
(&
m¥
[
jpos0
][
ioff
], &
PªdAºay
[0], 8 * (
img≥l
));

1343 
	`mem˝y
(&
m¥
[
jpos1
][
ioff
], &
PªdAºay
[2], 8 * (
img≥l
));

1344 
	`mem˝y
(&
m¥
[
jpos2
][
ioff
], &
PªdAºay
[4], 8 * (
img≥l
));

1345 
	`mem˝y
(&
m¥
[
jpos3
][
ioff
], &
PªdAºay
[6], 8 * (
img≥l
));

1346 
	`mem˝y
(&
m¥
[
jpos4
][
ioff
], &
PªdAºay
[8], 8 * (
img≥l
));

1347 
	`mem˝y
(&
m¥
[
jpos5
][
ioff
], &
PªdAºay
[10], 8 * (
img≥l
));

1348 
	`mem˝y
(&
m¥
[
jpos6
][
ioff
], &
PªdAºay
[12], 8 * (
img≥l
));

1349 
	`mem˝y
(&
m¥
[
jpos7
][
ioff
], &
PªdAºay
[14], 8 * (
img≥l
));

1351  
DECODING_OK
;

1352 
	}
}

1364 
ölöe
 
	$öåa8x8_h‹_down_¥ed_mbaff
(
Ma¸oblock
 *
cuºMB
,

1365 
Cﬁ‹Pœ√
 
∂
,

1366 
ioff
,

1367 
joff
)

1369 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1370 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1372 
i
;

1373 
img≥l
 
PªdPñ
[25];

1374 
img≥l
 
PªdAºay
[22];

1375 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

1377 
PixñPos
 
pix_a
[8];

1378 
PixñPos
 
pix_b
, 
pix_c
, 
pix_d
;

1380 
block_avaûabÀ_up
;

1381 
block_avaûabÀ_À·
;

1382 
block_avaûabÀ_up_À·
;

1383 
block_avaûabÀ_up_right
;

1384 
jpos0
 = 
joff
 , 
jpos1
 = jof‡+ 1, 
jpos2
 = jof‡+ 2, 
jpos3
 = joff + 3;

1385 
jpos4
 = 
joff
 + 4, 
jpos5
 = jof‡+ 5, 
jpos6
 = jof‡+ 6, 
jpos7
 = joff + 7;

1387 
img≥l
 **
m¥
 = 
cuºSli˚
->
mb_¥ed
[
∂
];

1388 *
mb_size
 = 
p_Vid
->mb_size[
IS_LUMA
];

1390 
i
=0;i<8;i++)

1392 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 + 
i
, 
mb_size
, &
pix_a
[i]);

1395 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 , 
joff
 - 1, 
mb_size
, &
pix_b
);

1396 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 + 8, 
joff
 - 1, 
mb_size
, &
pix_c
);

1397 
	`gëAffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 - 1, 
mb_size
, &
pix_d
);

1399 
pix_c
.
avaûabÀ
 =Öix_c.avaûabÀ &&!(
ioff
 =8 && 
joff
 == 8);

1401 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

1403 
i
=0, 
block_avaûabÀ_À·
=1; i<8;i++)

1404 
block_avaûabÀ_À·
 &
pix_a
[
i
].
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[pix_a[i].
mb_addr
]: 0;

1405 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_b.
mb_addr
] : 0;

1406 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_c.
mb_addr
] : 0;

1407 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_d.
mb_addr
] : 0;

1411 
block_avaûabÀ_À·
 = 
pix_a
[0].
avaûabÀ
;

1412 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

1413 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
;

1414 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
;

1417 i‡((!
block_avaûabÀ_up
)||(!
block_avaûabÀ_À·
)||(!
block_avaûabÀ_up_À·
))

1418 
	`¥ötf
 ("w¨nög: I¡ø_8x8_H‹iz⁄èl_Dow¿¥edi˘i⁄ modênŸáŒowedáàmb %d\n", (Ë
cuºSli˚
->
cuºít_mb_ƒ
);

1421 i‡(
block_avaûabÀ_up
)

1423 
	`mem˝y
(&
PªdPñ
[1], &
imgY
[
pix_b
.
pos_y
][pix_b.
pos_x
], 
BLOCK_SIZE_8x8
 * (
img≥l
));

1427 #i‡(
IMGTYPE
 == 0)

1428 
	`mem£t
(&
PªdPñ
[1], 
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
], 
BLOCK_SIZE_8x8
 * (
img≥l
));

1430 
P_A
 = 
P_B
 = 
P_C
 = 
P_D
 = 
P_E
 = 
P_F
 = 
P_G
 = 
P_H
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

1434 i‡(
block_avaûabÀ_up_right
)

1436 
	`mem˝y
(&
PªdPñ
[9], &
imgY
[
pix_c
.
pos_y
][pix_c.
pos_x
], 
BLOCK_SIZE_8x8
 * (
img≥l
));

1440 #i‡(
IMGTYPE
 == 0)

1441 
	`mem£t
(&
PªdPñ
[9], PªdPñ[8], 
BLOCK_SIZE_8x8
 * (
img≥l
));

1443 
P_I
 = 
P_J
 = 
P_K
 = 
P_L
 = 
P_M
 = 
P_N
 = 
P_O
 = 
P_P
 = 
P_H
;

1447 i‡(
block_avaûabÀ_À·
)

1449 
P_Q
 = 
imgY
[
pix_a
[0].
pos_y
][pix_a[0].
pos_x
];

1450 
P_R
 = 
imgY
[
pix_a
[1].
pos_y
][pix_a[1].
pos_x
];

1451 
P_S
 = 
imgY
[
pix_a
[2].
pos_y
][pix_a[2].
pos_x
];

1452 
P_T
 = 
imgY
[
pix_a
[3].
pos_y
][pix_a[3].
pos_x
];

1453 
P_U
 = 
imgY
[
pix_a
[4].
pos_y
][pix_a[4].
pos_x
];

1454 
P_V
 = 
imgY
[
pix_a
[5].
pos_y
][pix_a[5].
pos_x
];

1455 
P_W
 = 
imgY
[
pix_a
[6].
pos_y
][pix_a[6].
pos_x
];

1456 
P_X
 = 
imgY
[
pix_a
[7].
pos_y
][pix_a[7].
pos_x
];

1460 
P_Q
 = 
P_R
 = 
P_S
 = 
P_T
 = 
P_U
 = 
P_V
 = 
P_W
 = 
P_X
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

1463 i‡(
block_avaûabÀ_up_À·
)

1465 
P_Z
 = 
imgY
[
pix_d
.
pos_y
][pix_d.
pos_x
];

1469 
P_Z
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

1472 
	`LowPassF‹I¡ø8x8Pªd
(
PªdPñ
, 
block_avaûabÀ_up_À·
, 
block_avaûabÀ_up
, 
block_avaûabÀ_À·
);

1474 
PªdAºay
[ 0] = (
img≥l
Ë((
P_X
 + 
P_W
 + 1) >> 1);

1475 
PªdAºay
[ 1] = (
img≥l
Ë((
P_V
 + 
P_X
 + (
P_W
 << 1) + 2) >> 2);

1476 
PªdAºay
[ 2] = (
img≥l
Ë((
P_W
 + 
P_V
 + 1) >> 1);

1477 
PªdAºay
[ 3] = (
img≥l
Ë((
P_U
 + 
P_W
 + (
P_V
 << 1) + 2) >> 2);

1478 
PªdAºay
[ 4] = (
img≥l
Ë((
P_V
 + 
P_U
 + 1) >> 1);

1479 
PªdAºay
[ 5] = (
img≥l
Ë((
P_T
 + 
P_V
 + (
P_U
 << 1) + 2) >> 2);

1480 
PªdAºay
[ 6] = (
img≥l
Ë((
P_U
 + 
P_T
 + 1) >> 1);

1481 
PªdAºay
[ 7] = (
img≥l
Ë((
P_S
 + 
P_U
 + (
P_T
 << 1) + 2) >> 2);

1482 
PªdAºay
[ 8] = (
img≥l
Ë((
P_T
 + 
P_S
 + 1) >> 1);

1483 
PªdAºay
[ 9] = (
img≥l
Ë((
P_R
 + 
P_T
 + (
P_S
 << 1) + 2) >> 2);

1484 
PªdAºay
[10] = (
img≥l
Ë((
P_S
 + 
P_R
 + 1) >> 1);

1485 
PªdAºay
[11] = (
img≥l
Ë((
P_Q
 + 
P_S
 + (
P_R
 << 1) + 2) >> 2);

1486 
PªdAºay
[12] = (
img≥l
Ë((
P_R
 + 
P_Q
 + 1) >> 1);

1487 
PªdAºay
[13] = (
img≥l
Ë((
P_Z
 + 
P_R
 + (
P_Q
 << 1) + 2) >> 2);

1488 
PªdAºay
[14] = (
img≥l
Ë((
P_Q
 + 
P_Z
 + 1) >> 1);

1489 
PªdAºay
[15] = (
img≥l
Ë((
P_Q
 + 
P_A
 + 2*
P_Z
 + 2) >> 2);

1490 
PªdAºay
[16] = (
img≥l
Ë((
P_Z
 + 
P_B
 + 2*
P_A
 + 2) >> 2);

1491 
PªdAºay
[17] = (
img≥l
Ë((
P_A
 + 
P_C
 + 2*
P_B
 + 2) >> 2);

1492 
PªdAºay
[18] = (
img≥l
Ë((
P_B
 + 
P_D
 + 2*
P_C
 + 2) >> 2);

1493 
PªdAºay
[19] = (
img≥l
Ë((
P_C
 + 
P_E
 + 2*
P_D
 + 2) >> 2);

1494 
PªdAºay
[20] = (
img≥l
Ë((
P_D
 + 
P_F
 + 2*
P_E
 + 2) >> 2);

1495 
PªdAºay
[21] = (
img≥l
Ë((
P_E
 + 
P_G
 + 2*
P_F
 + 2) >> 2);

1497 
	`mem˝y
(&
m¥
[
jpos0
][
ioff
], &
PªdAºay
[14], 8 * (
img≥l
));

1498 
	`mem˝y
(&
m¥
[
jpos1
][
ioff
], &
PªdAºay
[12], 8 * (
img≥l
));

1499 
	`mem˝y
(&
m¥
[
jpos2
][
ioff
], &
PªdAºay
[10], 8 * (
img≥l
));

1500 
	`mem˝y
(&
m¥
[
jpos3
][
ioff
], &
PªdAºay
[ 8], 8 * (
img≥l
));

1501 
	`mem˝y
(&
m¥
[
jpos4
][
ioff
], &
PªdAºay
[ 6], 8 * (
img≥l
));

1502 
	`mem˝y
(&
m¥
[
jpos5
][
ioff
], &
PªdAºay
[ 4], 8 * (
img≥l
));

1503 
	`mem˝y
(&
m¥
[
jpos6
][
ioff
], &
PªdAºay
[ 2], 8 * (
img≥l
));

1504 
	`mem˝y
(&
m¥
[
jpos7
][
ioff
], &
PªdAºay
[ 0], 8 * (
img≥l
));

1506  
DECODING_OK
;

1507 
	}
}

1523 
	$öåa_¥ed_8x8_mbaff
(
Ma¸oblock
 *
cuºMB
,

1524 
Cﬁ‹Pœ√
 
∂
,

1525 
ioff
,

1526 
joff
)

1529 
block_x
 = (
cuºMB
->block_xË+ (
ioff
 >> 2);

1530 
block_y
 = (
cuºMB
->block_yË+ (
joff
 >> 2);

1531 
byã
 
¥edmode
 = 
cuºMB
->
p_Sli˚
->
ùªdmode
[
block_y
][
block_x
];

1533 
cuºMB
->
ùmode_DPCM
 = 
¥edmode
;

1535 
¥edmode
)

1537 
DC_PRED
:

1538  (
	`öåa8x8_dc_¥ed_mbaff
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

1540 
VERT_PRED
:

1541  (
	`öåa8x8_vît_¥ed_mbaff
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

1543 
HOR_PRED
:

1544  (
	`öåa8x8_h‹_¥ed_mbaff
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

1546 
DIAG_DOWN_RIGHT_PRED
:

1547  (
	`öåa8x8_düg_down_right_¥ed_mbaff
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

1549 
DIAG_DOWN_LEFT_PRED
:

1550  (
	`öåa8x8_düg_down_À·_¥ed_mbaff
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

1552 
VERT_RIGHT_PRED
:

1553  (
	`öåa8x8_vît_right_¥ed_mbaff
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

1555 
VERT_LEFT_PRED
:

1556  (
	`öåa8x8_vît_À·_¥ed_mbaff
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

1558 
HOR_UP_PRED
:

1559  (
	`öåa8x8_h‹_up_¥ed_mbaff
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

1561 
HOR_DOWN_PRED
:

1562  (
	`öåa8x8_h‹_down_¥ed_mbaff
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

1564 
	`¥ötf
("Eº‹: iŒegÆ i¡ø_8x8Öªdi˘i⁄ mode: %d\n", (Ë
¥edmode
);

1565  
SEARCH_SYNC
;

1568 
	}
}

	@ldecod/src/intra8x8_pred_normal.c

17 
	~"globÆ.h
"

18 
	~"öåa8x8_¥ed.h
"

19 
	~"mb_ac˚ss.h
"

20 
	~"image.h
"

38 
	#P_Z
 (
PªdPñ
[0])

	)

39 
	#P_A
 (
PªdPñ
[1])

	)

40 
	#P_B
 (
PªdPñ
[2])

	)

41 
	#P_C
 (
PªdPñ
[3])

	)

42 
	#P_D
 (
PªdPñ
[4])

	)

43 
	#P_E
 (
PªdPñ
[5])

	)

44 
	#P_F
 (
PªdPñ
[6])

	)

45 
	#P_G
 (
PªdPñ
[7])

	)

46 
	#P_H
 (
PªdPñ
[8])

	)

47 
	#P_I
 (
PªdPñ
[9])

	)

48 
	#P_J
 (
PªdPñ
[10])

	)

49 
	#P_K
 (
PªdPñ
[11])

	)

50 
	#P_L
 (
PªdPñ
[12])

	)

51 
	#P_M
 (
PªdPñ
[13])

	)

52 
	#P_N
 (
PªdPñ
[14])

	)

53 
	#P_O
 (
PªdPñ
[15])

	)

54 
	#P_P
 (
PªdPñ
[16])

	)

55 
	#P_Q
 (
PªdPñ
[17])

	)

56 
	#P_R
 (
PªdPñ
[18])

	)

57 
	#P_S
 (
PªdPñ
[19])

	)

58 
	#P_T
 (
PªdPñ
[20])

	)

59 
	#P_U
 (
PªdPñ
[21])

	)

60 
	#P_V
 (
PªdPñ
[22])

	)

61 
	#P_W
 (
PªdPñ
[23])

	)

62 
	#P_X
 (
PªdPñ
[24])

	)

70 
ölöe
 
	$LowPassF‹I¡ø8x8Pªd
(
img≥l
 *
PªdPñ
, 
block_up_À·
, 
block_up
, 
block_À·
)

72 
i
;

73 
img≥l
 
Lo›Aºay
[25];

75 
	`mem˝y
(&
Lo›Aºay
[0], &
PªdPñ
[0], 25 * (
img≥l
));

77 if(
block_up_À·
)

79 if(
block_up
 && 
block_À·
)

81 
Lo›Aºay
[0] = (
img≥l
Ë((
P_Q
 + (
P_Z
<<1Ë+ 
P_A
 + 2)>>2);

85 if(
block_up
)

86 
Lo›Aºay
[0] = (
img≥l
Ë((
P_Z
 + (P_Z<<1Ë+ 
P_A
 + 2)>>2);

87 i‡(
block_À·
)

88 
Lo›Aºay
[0] = (
img≥l
Ë((
P_Z
 + (P_Z<<1Ë+ 
P_Q
 + 2)>>2);

92 if(
block_up
)

94 if(
block_up_À·
)

96 
Lo›Aºay
[1] = (
img≥l
Ë((
PªdPñ
[0] + (PredPel[1]<<1) + PredPel[2] + 2)>>2);

99 
Lo›Aºay
[1] = (
img≥l
Ë((
PªdPñ
[1] + (PredPel[1]<<1) + PredPel[2] + 2)>>2);

102 
i
 = 2; i <16; i++)

104 
Lo›Aºay
[
i
] = (
img≥l
Ë((
PªdPñ
[i-1] + (PredPel[i]<<1) + PredPel[i+1] + 2)>>2);

106 
Lo›Aºay
[16] = (
img≥l
Ë((
P_P
 + (P_P<<1Ë+ 
P_O
 + 2)>>2);

109 if(
block_À·
)

111 if(
block_up_À·
)

112 
Lo›Aºay
[17] = (
img≥l
Ë((
P_Z
 + (
P_Q
<<1Ë+ 
P_R
 + 2)>>2);

114 
Lo›Aºay
[17] = (
img≥l
Ë((
P_Q
 + (P_Q<<1Ë+ 
P_R
 + 2)>>2);

116 
i
 = 18; i <24; i++)

118 
Lo›Aºay
[
i
] = (
img≥l
Ë((
PªdPñ
[i-1] + (PredPel[i]<<1) + PredPel[i+1] + 2)>>2);

120 
Lo›Aºay
[24] = (
img≥l
Ë((
P_W
 + (
P_X
<<1) + P_X + 2) >> 2);

123 
	`mem˝y
(&
PªdPñ
[0], &
Lo›Aºay
[0], 25 * (
img≥l
));

124 
	}
}

132 
ölöe
 
	$LowPassF‹I¡ø8x8PªdH‹
(
img≥l
 *
PªdPñ
, 
block_up_À·
, 
block_up
, 
block_À·
)

134 
i
;

135 
img≥l
 
Lo›Aºay
[25];

137 
	`mem˝y
(&
Lo›Aºay
[0], &
PªdPñ
[0], 25 * (
img≥l
));

139 if(
block_up_À·
)

141 if(
block_up
 && 
block_À·
)

143 
Lo›Aºay
[0] = (
img≥l
Ë((
P_Q
 + (
P_Z
<<1Ë+ 
P_A
 + 2)>>2);

147 if(
block_up
)

148 
Lo›Aºay
[0] = (
img≥l
Ë((
P_Z
 + (P_Z<<1Ë+ 
P_A
 + 2)>>2);

149 i‡(
block_À·
)

150 
Lo›Aºay
[0] = (
img≥l
Ë((
P_Z
 + (P_Z<<1Ë+ 
P_Q
 + 2)>>2);

154 if(
block_up
)

156 if(
block_up_À·
)

158 
Lo›Aºay
[1] = (
img≥l
Ë((
PªdPñ
[0] + (PredPel[1]<<1) + PredPel[2] + 2)>>2);

161 
Lo›Aºay
[1] = (
img≥l
Ë((
PªdPñ
[1] + (PredPel[1]<<1) + PredPel[2] + 2)>>2);

164 
i
 = 2; i <16; i++)

166 
Lo›Aºay
[
i
] = (
img≥l
Ë((
PªdPñ
[i-1] + (PredPel[i]<<1) + PredPel[i+1] + 2)>>2);

168 
Lo›Aºay
[16] = (
img≥l
Ë((
P_P
 + (P_P<<1Ë+ 
P_O
 + 2)>>2);

172 
	`mem˝y
(&
PªdPñ
[0], &
Lo›Aºay
[0], 17 * (
img≥l
));

173 
	}
}

181 
ölöe
 
	$LowPassF‹I¡ø8x8PªdVî
(
img≥l
 *
PªdPñ
, 
block_up_À·
, 
block_up
, 
block_À·
)

185 
i
;

186 
img≥l
 
Lo›Aºay
[25];

188 
	`mem˝y
(&
Lo›Aºay
[0], &
PªdPñ
[0], 25 * (
img≥l
));

190 if(
block_up_À·
)

192 if(
block_up
 && 
block_À·
)

194 
Lo›Aºay
[0] = (
img≥l
Ë((
P_Q
 + (
P_Z
<<1Ë+ 
P_A
 + 2)>>2);

198 if(
block_up
)

199 
Lo›Aºay
[0] = (
img≥l
Ë((
P_Z
 + (P_Z<<1Ë+ 
P_A
 + 2)>>2);

200 i‡(
block_À·
)

201 
Lo›Aºay
[0] = (
img≥l
Ë((
P_Z
 + (P_Z<<1Ë+ 
P_Q
 + 2)>>2);

205 if(
block_À·
)

207 if(
block_up_À·
)

208 
Lo›Aºay
[17] = (
img≥l
Ë((
P_Z
 + (
P_Q
<<1Ë+ 
P_R
 + 2)>>2);

210 
Lo›Aºay
[17] = (
img≥l
Ë((
P_Q
 + (P_Q<<1Ë+ 
P_R
 + 2)>>2);

212 
i
 = 18; i <24; i++)

214 
Lo›Aºay
[
i
] = (
img≥l
Ë((
PªdPñ
[i-1] + (PredPel[i]<<1) + PredPel[i+1] + 2)>>2);

216 
Lo›Aºay
[24] = (
img≥l
Ë((
P_W
 + (
P_X
<<1) + P_X + 2) >> 2);

219 
	`mem˝y
(&
PªdPñ
[0], &
Lo›Aºay
[0], 25 * (
img≥l
));

220 
	}
}

233 
ölöe
 
	$öåa8x8_dc_¥ed
(
Ma¸oblock
 *
cuºMB
,

234 
Cﬁ‹Pœ√
 
∂
,

235 
ioff
,

236 
joff
)

238 
i
,
j
;

239 
s0
 = 0;

240 
img≥l
 
PªdPñ
[25];

241 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

242 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

244 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
cuºSli˚
->dec_picture;

245 
img≥l
 **
imgY
 = (
∂
Ë? 
dec_pi˘uª
->
imgUV
[pl - 1] : dec_picture->imgY;

247 
PixñPos
 
pix_a
;

248 
PixñPos
 
pix_b
, 
pix_c
, 
pix_d
;

250 
block_avaûabÀ_up
;

251 
block_avaûabÀ_À·
;

252 
block_avaûabÀ_up_À·
;

253 
block_avaûabÀ_up_right
;

256 
img≥l
 *
¥ed_≥ls
, **
m¥
 = 
cuºSli˚
->
mb_¥ed
[
∂
];

257 *
mb_size
 = 
p_Vid
->mb_size[
IS_LUMA
];

259 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
, 
mb_size
, &
pix_a
);

260 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 , 
joff
 - 1, 
mb_size
, &
pix_b
);

261 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 + 8, 
joff
 - 1, 
mb_size
, &
pix_c
);

262 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 - 1, 
mb_size
, &
pix_d
);

264 
pix_c
.
avaûabÀ
 =Öix_c.avaûabÀ &&!(
ioff
 =8 && 
joff
 == 8);

266 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

268 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_a.
mb_addr
]: 0;

269 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_b.
mb_addr
] : 0;

270 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_c.
mb_addr
] : 0;

271 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_d.
mb_addr
] : 0;

275 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
;

276 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

277 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
;

278 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
;

282 i‡(
block_avaûabÀ_up
)

284 
¥ed_≥ls
 = &
imgY
[
pix_b
.
pos_y
][pix_b.
pos_x
];

285 
P_A
 = 
¥ed_≥ls
[0];

286 
P_B
 = 
¥ed_≥ls
[1];

287 
P_C
 = 
¥ed_≥ls
[2];

288 
P_D
 = 
¥ed_≥ls
[3];

289 
P_E
 = 
¥ed_≥ls
[4];

290 
P_F
 = 
¥ed_≥ls
[5];

291 
P_G
 = 
¥ed_≥ls
[6];

292 
P_H
 = 
¥ed_≥ls
[7];

296 
P_A
 = 
P_B
 = 
P_C
 = 
P_D
 = 
P_E
 = 
P_F
 = 
P_G
 = 
P_H
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

299 i‡(
block_avaûabÀ_up_right
)

301 
¥ed_≥ls
 = &
imgY
[
pix_c
.
pos_y
][pix_c.
pos_x
];

302 
P_I
 = 
¥ed_≥ls
[0];

303 
P_J
 = 
¥ed_≥ls
[1];

304 
P_K
 = 
¥ed_≥ls
[2];

305 
P_L
 = 
¥ed_≥ls
[3];

306 
P_M
 = 
¥ed_≥ls
[4];

307 
P_N
 = 
¥ed_≥ls
[5];

308 
P_O
 = 
¥ed_≥ls
[6];

309 
P_P
 = 
¥ed_≥ls
[7];

314 
P_I
 = 
P_J
 = 
P_K
 = 
P_L
 = 
P_M
 = 
P_N
 = 
P_O
 = 
P_P
 = 
P_H
;

317 i‡(
block_avaûabÀ_À·
)

319 
img≥l
 **
img_¥ed
 = &
imgY
[
pix_a
.
pos_y
];

320 
pos_x
 = 
pix_a
.pos_x;

321 
P_Q
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

322 
P_R
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

323 
P_S
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

324 
P_T
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

325 
P_U
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

326 
P_V
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

327 
P_W
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

328 
P_X
 = *(*(
img_¥ed
 ) + 
pos_x
);

332 
P_Q
 = 
P_R
 = 
P_S
 = 
P_T
 = 
P_U
 = 
P_V
 = 
P_W
 = 
P_X
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

335 i‡(
block_avaûabÀ_up_À·
)

337 
P_Z
 = 
imgY
[
pix_d
.
pos_y
][pix_d.
pos_x
];

341 
P_Z
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

344 
	`LowPassF‹I¡ø8x8Pªd
(&(
P_Z
), 
block_avaûabÀ_up_À·
, 
block_avaûabÀ_up
, 
block_avaûabÀ_À·
);

346 i‡(
block_avaûabÀ_up
 && 
block_avaûabÀ_À·
)

349 
s0
 = (
P_A
 + 
P_B
 + 
P_C
 + 
P_D
 + 
P_E
 + 
P_F
 + 
P_G
 + 
P_H
 + 
P_Q
 + 
P_R
 + 
P_S
 + 
P_T
 + 
P_U
 + 
P_V
 + 
P_W
 + 
P_X
 + 8) >> 4;

351 i‡(!
block_avaûabÀ_up
 && 
block_avaûabÀ_À·
)

354 
s0
 = (
P_Q
 + 
P_R
 + 
P_S
 + 
P_T
 + 
P_U
 + 
P_V
 + 
P_W
 + 
P_X
 + 4) >> 3;

356 i‡(
block_avaûabÀ_up
 && !
block_avaûabÀ_À·
)

359 
s0
 = (
P_A
 + 
P_B
 + 
P_C
 + 
P_D
 + 
P_E
 + 
P_F
 + 
P_G
 + 
P_H
 + 4) >> 3;

364 
s0
 = 
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

367 
j
 = 
joff
; j < jof‡+ 
BLOCK_SIZE_8x8
; j++)

368 
i
 = 
ioff
; i < iof‡+ 
BLOCK_SIZE_8x8
; i++)

369 
m¥
[
j
][
i
] = (
img≥l
Ë
s0
;

371  
DECODING_OK
;

372 
	}
}

384 
ölöe
 
	$öåa8x8_vît_¥ed
(
Ma¸oblock
 *
cuºMB
,

385 
Cﬁ‹Pœ√
 
∂
,

386 
ioff
,

387 
joff
)

389 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

390 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

392 
i
;

393 
img≥l
 
PªdPñ
[25];

394 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

396 
PixñPos
 
pix_a
;

397 
PixñPos
 
pix_b
, 
pix_c
, 
pix_d
;

399 
block_avaûabÀ_up
;

400 
block_avaûabÀ_À·
;

401 
block_avaûabÀ_up_À·
;

402 
block_avaûabÀ_up_right
;

405 
img≥l
 *
¥ed_≥ls
, **
m¥
 = 
cuºSli˚
->
mb_¥ed
[
∂
];

406 *
mb_size
 = 
p_Vid
->mb_size[
IS_LUMA
];

408 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 , 
mb_size
, &
pix_a
);

409 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 , 
joff
 - 1, 
mb_size
, &
pix_b
);

410 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 + 8, 
joff
 - 1, 
mb_size
, &
pix_c
);

411 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 - 1, 
mb_size
, &
pix_d
);

413 
pix_c
.
avaûabÀ
 =Öix_c.avaûabÀ &&!(
ioff
 =8 && 
joff
 == 8);

415 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

417 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_a.
mb_addr
] : 0;

418 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_b.
mb_addr
] : 0;

419 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_c.
mb_addr
] : 0;

420 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_d.
mb_addr
] : 0;

424 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
;

425 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

426 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
;

427 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
;

430 i‡(!
block_avaûabÀ_up
)

431 
	`¥ötf
 ("w¨nög: I¡ø_8x8_Vîtiˇ»¥edi˘i⁄ modênŸáŒowedáàmb %d\n", (Ë
cuºSli˚
->
cuºít_mb_ƒ
);

434 i‡(
block_avaûabÀ_up
)

436 
¥ed_≥ls
 = &
imgY
[
pix_b
.
pos_y
][pix_b.
pos_x
];

437 
P_A
 = *(
¥ed_≥ls
 ++);

438 
P_B
 = *(
¥ed_≥ls
 ++);

439 
P_C
 = *(
¥ed_≥ls
 ++);

440 
P_D
 = *(
¥ed_≥ls
 ++);

441 
P_E
 = *(
¥ed_≥ls
 ++);

442 
P_F
 = *(
¥ed_≥ls
 ++);

443 
P_G
 = *(
¥ed_≥ls
 ++);

444 
P_H
 = *
¥ed_≥ls
;

448 
P_A
 = 
P_B
 = 
P_C
 = 
P_D
 = 
P_E
 = 
P_F
 = 
P_G
 = 
P_H
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

451 i‡(
block_avaûabÀ_up_right
)

453 
¥ed_≥ls
 = &
imgY
[
pix_c
.
pos_y
][pix_c.
pos_x
];

454 
P_I
 = *(
¥ed_≥ls
 ++);

455 
P_J
 = *(
¥ed_≥ls
 ++);

456 
P_K
 = *(
¥ed_≥ls
 ++);

457 
P_L
 = *(
¥ed_≥ls
 ++);

458 
P_M
 = *(
¥ed_≥ls
 ++);

459 
P_N
 = *(
¥ed_≥ls
 ++);

460 
P_O
 = *(
¥ed_≥ls
 ++);

461 
P_P
 = *
¥ed_≥ls
;

465 
P_I
 = 
P_J
 = 
P_K
 = 
P_L
 = 
P_M
 = 
P_N
 = 
P_O
 = 
P_P
 = 
P_H
;

468 i‡(
block_avaûabÀ_up_À·
)

470 
P_Z
 = 
imgY
[
pix_d
.
pos_y
][pix_d.
pos_x
];

474 
P_Z
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

477 
	`LowPassF‹I¡ø8x8PªdH‹
(&(
P_Z
), 
block_avaûabÀ_up_À·
, 
block_avaûabÀ_up
, 
block_avaûabÀ_À·
);

479 
i
=
joff
; i < jof‡+ 
BLOCK_SIZE_8x8
; i++)

481 
	`mem˝y
(&
m¥
[
i
][
ioff
], (&
P_A
), 
BLOCK_SIZE_8x8
 * (
img≥l
));

484  
DECODING_OK
;

485 
	}
}

497 
ölöe
 
	$öåa8x8_h‹_¥ed
(
Ma¸oblock
 *
cuºMB
,

498 
Cﬁ‹Pœ√
 
∂
,

499 
ioff
,

500 
joff
)

502 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

503 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

506 
j
;

507 
img≥l
 
PªdPñ
[25];

508 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

510 
PixñPos
 
pix_a
;

511 
PixñPos
 
pix_b
, 
pix_d
;

513 
block_avaûabÀ_up
;

514 
block_avaûabÀ_À·
;

515 
block_avaûabÀ_up_À·
;

517 #i‡(
IMGTYPE
 != 0)

518 
ùos0
 = 
ioff
 , 
ùos1
 = iof‡+ 1, 
ùos2
 = iof‡+ 2, 
ùos3
 = ioff + 3;

519 
ùos4
 = 
ioff
 + 4, 
ùos5
 = iof‡+ 5, 
ùos6
 = iof‡+ 6, 
ùos7
 = ioff + 7;

521 
jpos
;

522 
img≥l
 **
m¥
 = 
cuºSli˚
->
mb_¥ed
[
∂
];

523 *
mb_size
 = 
p_Vid
->mb_size[
IS_LUMA
];

525 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 , 
mb_size
, &
pix_a
);

526 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 , 
joff
 - 1, 
mb_size
, &
pix_b
);

527 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 - 1, 
mb_size
, &
pix_d
);

529 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

531 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_a.
mb_addr
]: 0;

532 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_b.
mb_addr
] : 0;

533 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_d.
mb_addr
] : 0;

537 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
;

538 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

539 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
;

542 i‡(!
block_avaûabÀ_À·
)

543 
	`¥ötf
 ("w¨nög: I¡ø_8x8_H‹iz⁄è»¥edi˘i⁄ modênŸáŒowedáàmb %d\n", (Ë
cuºSli˚
->
cuºít_mb_ƒ
);

546 i‡(
block_avaûabÀ_À·
)

548 
img≥l
 **
img_¥ed
 = &
imgY
[
pix_a
.
pos_y
];

549 
pos_x
 = 
pix_a
.pos_x;

550 
P_Q
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

551 
P_R
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

552 
P_S
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

553 
P_T
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

554 
P_U
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

555 
P_V
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

556 
P_W
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

557 
P_X
 = *(*(
img_¥ed
 ) + 
pos_x
);

561 
P_Q
 = 
P_R
 = 
P_S
 = 
P_T
 = 
P_U
 = 
P_V
 = 
P_W
 = 
P_X
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

564 i‡(
block_avaûabÀ_up_À·
)

566 
P_Z
 = 
imgY
[
pix_d
.
pos_y
][pix_d.
pos_x
];

570 
P_Z
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

573 
	`LowPassF‹I¡ø8x8PªdVî
(&(
P_Z
), 
block_avaûabÀ_up_À·
, 
block_avaûabÀ_up
, 
block_avaûabÀ_À·
);

575 
j
=0; j < 
BLOCK_SIZE_8x8
; j++)

577 
jpos
 = 
j
 + 
joff
;

578 #i‡(
IMGTYPE
 == 0)

579 
	`mem£t
(&
m¥
[
jpos
][
ioff
], (
img≥l
Ë(&
P_Q
)[
j
], 8 * (imgpel));

581 
m¥
[
jpos
][
ùos0
] =

582 
m¥
[
jpos
][
ùos1
] =

583 
m¥
[
jpos
][
ùos2
] =

584 
m¥
[
jpos
][
ùos3
] =

585 
m¥
[
jpos
][
ùos4
] =

586 
m¥
[
jpos
][
ùos5
] =

587 
m¥
[
jpos
][
ùos6
] =

588 
m¥
[
jpos
][
ùos7
] = (
img≥l
Ë(&
P_Q
)[
j
];

592  
DECODING_OK
;

593 
	}
}

605 
ölöe
 
	$öåa8x8_düg_down_right_¥ed
(
Ma¸oblock
 *
cuºMB
,

606 
Cﬁ‹Pœ√
 
∂
,

607 
ioff
,

608 
joff
)

610 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

611 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

613 
img≥l
 
PªdPñ
[25];

614 
img≥l
 
PªdAºay
[16];

615 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

617 
PixñPos
 
pix_a
;

618 
PixñPos
 
pix_b
, 
pix_c
, 
pix_d
;

620 
block_avaûabÀ_up
;

621 
block_avaûabÀ_À·
;

622 
block_avaûabÀ_up_À·
;

623 
block_avaûabÀ_up_right
;

625 
img≥l
 *
¥ed_≥ls
, **
m¥
 = 
cuºSli˚
->
mb_¥ed
[
∂
];

626 *
mb_size
 = 
p_Vid
->mb_size[
IS_LUMA
];

628 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 , 
mb_size
, &
pix_a
);

629 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 , 
joff
 - 1, 
mb_size
, &
pix_b
);

630 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 + 8, 
joff
 - 1, 
mb_size
, &
pix_c
);

631 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 - 1, 
mb_size
, &
pix_d
);

633 
pix_c
.
avaûabÀ
 =Öix_c.avaûabÀ &&!(
ioff
 =8 && 
joff
 == 8);

635 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

637 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_a.
mb_addr
]: 0;

638 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_b.
mb_addr
] : 0;

639 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_c.
mb_addr
] : 0;

640 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_d.
mb_addr
] : 0;

644 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
;

645 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

646 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
;

647 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
;

650 i‡((!
block_avaûabÀ_up
)||(!
block_avaûabÀ_À·
)||(!
block_avaûabÀ_up_À·
))

651 
	`¥ötf
 ("w¨nög: I¡ø_8x8_Düg⁄Æ_Down_Righà¥edi˘i⁄ modênŸáŒowedáàmb %d\n", (Ë
cuºSli˚
->
cuºít_mb_ƒ
);

654 i‡(
block_avaûabÀ_up
)

656 
¥ed_≥ls
 = &
imgY
[
pix_b
.
pos_y
][pix_b.
pos_x
];

657 
P_A
 = 
¥ed_≥ls
[0];

658 
P_B
 = 
¥ed_≥ls
[1];

659 
P_C
 = 
¥ed_≥ls
[2];

660 
P_D
 = 
¥ed_≥ls
[3];

661 
P_E
 = 
¥ed_≥ls
[4];

662 
P_F
 = 
¥ed_≥ls
[5];

663 
P_G
 = 
¥ed_≥ls
[6];

664 
P_H
 = 
¥ed_≥ls
[7];

668 
P_A
 = 
P_B
 = 
P_C
 = 
P_D
 = 
P_E
 = 
P_F
 = 
P_G
 = 
P_H
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

671 i‡(
block_avaûabÀ_up_right
)

673 
¥ed_≥ls
 = &
imgY
[
pix_c
.
pos_y
][pix_c.
pos_x
];

674 
P_I
 = 
¥ed_≥ls
[0];

675 
P_J
 = 
¥ed_≥ls
[1];

676 
P_K
 = 
¥ed_≥ls
[2];

677 
P_L
 = 
¥ed_≥ls
[3];

678 
P_M
 = 
¥ed_≥ls
[4];

679 
P_N
 = 
¥ed_≥ls
[5];

680 
P_O
 = 
¥ed_≥ls
[6];

681 
P_P
 = 
¥ed_≥ls
[7];

686 
P_I
 = 
P_J
 = 
P_K
 = 
P_L
 = 
P_M
 = 
P_N
 = 
P_O
 = 
P_P
 = 
P_H
;

689 i‡(
block_avaûabÀ_À·
)

691 
img≥l
 **
img_¥ed
 = &
imgY
[
pix_a
.
pos_y
];

692 
pos_x
 = 
pix_a
.pos_x;

693 
P_Q
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

694 
P_R
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

695 
P_S
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

696 
P_T
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

697 
P_U
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

698 
P_V
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

699 
P_W
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

700 
P_X
 = *(*(
img_¥ed
 ) + 
pos_x
);

704 
P_Q
 = 
P_R
 = 
P_S
 = 
P_T
 = 
P_U
 = 
P_V
 = 
P_W
 = 
P_X
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

707 i‡(
block_avaûabÀ_up_À·
)

709 
P_Z
 = 
imgY
[
pix_d
.
pos_y
][pix_d.
pos_x
];

713 
P_Z
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

716 
	`LowPassF‹I¡ø8x8Pªd
(&(
P_Z
), 
block_avaûabÀ_up_À·
, 
block_avaûabÀ_up
, 
block_avaûabÀ_À·
);

719 
PªdAºay
[ 0] = (
img≥l
Ë((
P_X
 + 
P_V
 + 2*(
P_W
) + 2) >> 2);

720 
PªdAºay
[ 1] = (
img≥l
Ë((
P_W
 + 
P_U
 + 2*(
P_V
) + 2) >> 2);

721 
PªdAºay
[ 2] = (
img≥l
Ë((
P_V
 + 
P_T
 + 2*(
P_U
) + 2) >> 2);

722 
PªdAºay
[ 3] = (
img≥l
Ë((
P_U
 + 
P_S
 + 2*(
P_T
) + 2) >> 2);

723 
PªdAºay
[ 4] = (
img≥l
Ë((
P_T
 + 
P_R
 + 2*(
P_S
) + 2) >> 2);

724 
PªdAºay
[ 5] = (
img≥l
Ë((
P_S
 + 
P_Q
 + 2*(
P_R
) + 2) >> 2);

725 
PªdAºay
[ 6] = (
img≥l
Ë((
P_R
 + 
P_Z
 + 2*(
P_Q
) + 2) >> 2);

726 
PªdAºay
[ 7] = (
img≥l
Ë((
P_Q
 + 
P_A
 + 2*(
P_Z
) + 2) >> 2);

727 
PªdAºay
[ 8] = (
img≥l
Ë((
P_Z
 + 
P_B
 + 2*(
P_A
) + 2) >> 2);

728 
PªdAºay
[ 9] = (
img≥l
Ë((
P_A
 + 
P_C
 + 2*(
P_B
) + 2) >> 2);

729 
PªdAºay
[10] = (
img≥l
Ë((
P_B
 + 
P_D
 + 2*(
P_C
) + 2) >> 2);

730 
PªdAºay
[11] = (
img≥l
Ë((
P_C
 + 
P_E
 + 2*(
P_D
) + 2) >> 2);

731 
PªdAºay
[12] = (
img≥l
Ë((
P_D
 + 
P_F
 + 2*(
P_E
) + 2) >> 2);

732 
PªdAºay
[13] = (
img≥l
Ë((
P_E
 + 
P_G
 + 2*(
P_F
) + 2) >> 2);

733 
PªdAºay
[14] = (
img≥l
Ë((
P_F
 + 
P_H
 + 2*(
P_G
) + 2) >> 2);

735 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], &
PªdAºay
[7], 8 * (
img≥l
));

736 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], &
PªdAºay
[6], 8 * (
img≥l
));

737 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], &
PªdAºay
[5], 8 * (
img≥l
));

738 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], &
PªdAºay
[4], 8 * (
img≥l
));

739 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], &
PªdAºay
[3], 8 * (
img≥l
));

740 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], &
PªdAºay
[2], 8 * (
img≥l
));

741 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], &
PªdAºay
[1], 8 * (
img≥l
));

742 
	`mem˝y
(&
m¥
[
joff
 ][
ioff
], &
PªdAºay
[0], 8 * (
img≥l
));

744  
DECODING_OK
;

745 
	}
}

757 
ölöe
 
	$öåa8x8_düg_down_À·_¥ed
(
Ma¸oblock
 *
cuºMB
,

758 
Cﬁ‹Pœ√
 
∂
,

759 
ioff
,

760 
joff
)

762 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

763 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

765 
img≥l
 
PªdPñ
[25];

766 
img≥l
 
PªdAºay
[16];

767 
img≥l
 *
Pªd
 = &
PªdAºay
[0];

768 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

770 
PixñPos
 
pix_a
;

771 
PixñPos
 
pix_b
, 
pix_c
, 
pix_d
;

773 
block_avaûabÀ_up
;

774 
block_avaûabÀ_À·
;

775 
block_avaûabÀ_up_À·
;

776 
block_avaûabÀ_up_right
;

778 
img≥l
 *
¥ed_≥ls
, **
m¥
 = 
cuºSli˚
->
mb_¥ed
[
∂
];

779 *
mb_size
 = 
p_Vid
->mb_size[
IS_LUMA
];

781 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 , 
mb_size
, &
pix_a
);

782 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 , 
joff
 - 1, 
mb_size
, &
pix_b
);

783 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 + 8, 
joff
 - 1, 
mb_size
, &
pix_c
);

784 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 - 1, 
mb_size
, &
pix_d
);

786 
pix_c
.
avaûabÀ
 =Öix_c.avaûabÀ &&!(
ioff
 =8 && 
joff
 == 8);

788 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

790 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_a.
mb_addr
]: 0;

791 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_b.
mb_addr
] : 0;

792 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_c.
mb_addr
] : 0;

793 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_d.
mb_addr
] : 0;

797 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
;

798 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

799 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
;

800 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
;

803 i‡(!
block_avaûabÀ_up
)

804 
	`¥ötf
 ("w¨nög: I¡ø_8x8_Düg⁄Æ_Down_Le·Öªdi˘i⁄ modênŸáŒowedáàmb %d\n", (Ë
cuºSli˚
->
cuºít_mb_ƒ
);

807 i‡(
block_avaûabÀ_up
)

809 
¥ed_≥ls
 = &
imgY
[
pix_b
.
pos_y
][pix_b.
pos_x
];

810 
P_A
 = 
¥ed_≥ls
[0];

811 
P_B
 = 
¥ed_≥ls
[1];

812 
P_C
 = 
¥ed_≥ls
[2];

813 
P_D
 = 
¥ed_≥ls
[3];

814 
P_E
 = 
¥ed_≥ls
[4];

815 
P_F
 = 
¥ed_≥ls
[5];

816 
P_G
 = 
¥ed_≥ls
[6];

817 
P_H
 = 
¥ed_≥ls
[7];

821 
P_A
 = 
P_B
 = 
P_C
 = 
P_D
 = 
P_E
 = 
P_F
 = 
P_G
 = 
P_H
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

824 i‡(
block_avaûabÀ_up_right
)

826 
¥ed_≥ls
 = &
imgY
[
pix_c
.
pos_y
][pix_c.
pos_x
];

827 
P_I
 = 
¥ed_≥ls
[0];

828 
P_J
 = 
¥ed_≥ls
[1];

829 
P_K
 = 
¥ed_≥ls
[2];

830 
P_L
 = 
¥ed_≥ls
[3];

831 
P_M
 = 
¥ed_≥ls
[4];

832 
P_N
 = 
¥ed_≥ls
[5];

833 
P_O
 = 
¥ed_≥ls
[6];

834 
P_P
 = 
¥ed_≥ls
[7];

839 
P_I
 = 
P_J
 = 
P_K
 = 
P_L
 = 
P_M
 = 
P_N
 = 
P_O
 = 
P_P
 = 
P_H
;

842 i‡(
block_avaûabÀ_À·
)

844 
img≥l
 **
img_¥ed
 = &
imgY
[
pix_a
.
pos_y
];

845 
pos_x
 = 
pix_a
.pos_x;

846 
P_Q
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

847 
P_R
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

848 
P_S
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

849 
P_T
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

850 
P_U
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

851 
P_V
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

852 
P_W
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

853 
P_X
 = *(*(
img_¥ed
 ) + 
pos_x
);

857 
P_Q
 = 
P_R
 = 
P_S
 = 
P_T
 = 
P_U
 = 
P_V
 = 
P_W
 = 
P_X
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

860 i‡(
block_avaûabÀ_up_À·
)

862 
P_Z
 = 
imgY
[
pix_d
.
pos_y
][pix_d.
pos_x
];

866 
P_Z
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

869 
	`LowPassF‹I¡ø8x8Pªd
(&(
P_Z
), 
block_avaûabÀ_up_À·
, 
block_avaûabÀ_up
, 
block_avaûabÀ_À·
);

872 *
Pªd
++ = (
img≥l
Ë((
P_A
 + 
P_C
 + 2*(
P_B
) + 2) >> 2);

873 *
Pªd
++ = (
img≥l
Ë((
P_B
 + 
P_D
 + 2*(
P_C
) + 2) >> 2);

874 *
Pªd
++ = (
img≥l
Ë((
P_C
 + 
P_E
 + 2*(
P_D
) + 2) >> 2);

875 *
Pªd
++ = (
img≥l
Ë((
P_D
 + 
P_F
 + 2*(
P_E
) + 2) >> 2);

876 *
Pªd
++ = (
img≥l
Ë((
P_E
 + 
P_G
 + 2*(
P_F
) + 2) >> 2);

877 *
Pªd
++ = (
img≥l
Ë((
P_F
 + 
P_H
 + 2*(
P_G
) + 2) >> 2);

878 *
Pªd
++ = (
img≥l
Ë((
P_G
 + 
P_I
 + 2*(
P_H
) + 2) >> 2);

879 *
Pªd
++ = (
img≥l
Ë((
P_H
 + 
P_J
 + 2*(
P_I
) + 2) >> 2);

880 *
Pªd
++ = (
img≥l
Ë((
P_I
 + 
P_K
 + 2*(
P_J
) + 2) >> 2);

881 *
Pªd
++ = (
img≥l
Ë((
P_J
 + 
P_L
 + 2*(
P_K
) + 2) >> 2);

882 *
Pªd
++ = (
img≥l
Ë((
P_K
 + 
P_M
 + 2*(
P_L
) + 2) >> 2);

883 *
Pªd
++ = (
img≥l
Ë((
P_L
 + 
P_N
 + 2*(
P_M
) + 2) >> 2);

884 *
Pªd
++ = (
img≥l
Ë((
P_M
 + 
P_O
 + 2*(
P_N
) + 2) >> 2);

885 *
Pªd
++ = (
img≥l
Ë((
P_N
 + 
P_P
 + 2*(
P_O
) + 2) >> 2);

886 *
Pªd
 = (
img≥l
Ë((
P_O
 + 3*(
P_P
) + 2) >> 2);

888 
Pªd
 = &
PªdAºay
[ 0];

890 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], 
Pªd
++, 8 * (
img≥l
));

891 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], 
Pªd
++, 8 * (
img≥l
));

892 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], 
Pªd
++, 8 * (
img≥l
));

893 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], 
Pªd
++, 8 * (
img≥l
));

894 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], 
Pªd
++, 8 * (
img≥l
));

895 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], 
Pªd
++, 8 * (
img≥l
));

896 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], 
Pªd
++, 8 * (
img≥l
));

897 
	`mem˝y
(&
m¥
[
joff
 ][
ioff
], 
Pªd
 , 8 * (
img≥l
));

899  
DECODING_OK
;

900 
	}
}

912 
ölöe
 
	$öåa8x8_vît_right_¥ed
(
Ma¸oblock
 *
cuºMB
,

913 
Cﬁ‹Pœ√
 
∂
,

914 
ioff
,

915 
joff
)

917 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

918 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

920 
img≥l
 
PªdPñ
[25];

921 
img≥l
 
PªdAºay
[22];

922 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

924 
PixñPos
 
pix_a
;

925 
PixñPos
 
pix_b
, 
pix_c
, 
pix_d
;

927 
block_avaûabÀ_up
;

928 
block_avaûabÀ_À·
;

929 
block_avaûabÀ_up_À·
;

930 
block_avaûabÀ_up_right
;

932 
img≥l
 *
¥ed_≥ls
, **
m¥
 = 
cuºSli˚
->
mb_¥ed
[
∂
];

933 *
mb_size
 = 
p_Vid
->mb_size[
IS_LUMA
];

935 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 , 
mb_size
, &
pix_a
);

936 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 , 
joff
 - 1, 
mb_size
, &
pix_b
);

937 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 + 8, 
joff
 - 1, 
mb_size
, &
pix_c
);

938 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 - 1, 
mb_size
, &
pix_d
);

940 
pix_c
.
avaûabÀ
 =Öix_c.avaûabÀ &&!(
ioff
 =8 && 
joff
 == 8);

942 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

944 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_a.
mb_addr
]: 0;

945 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_b.
mb_addr
] : 0;

946 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_c.
mb_addr
] : 0;

947 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_d.
mb_addr
] : 0;

951 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
;

952 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

953 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
;

954 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
;

957 i‡((!
block_avaûabÀ_up
)||(!
block_avaûabÀ_À·
)||(!
block_avaûabÀ_up_À·
))

958 
	`¥ötf
 ("w¨nög: I¡ø_8x8_Vîtiˇl_Righà¥edi˘i⁄ modênŸáŒowedáàmb %d\n", (Ë
cuºSli˚
->
cuºít_mb_ƒ
);

961 i‡(
block_avaûabÀ_up
)

963 
¥ed_≥ls
 = &
imgY
[
pix_b
.
pos_y
][pix_b.
pos_x
];

964 
P_A
 = 
¥ed_≥ls
[0];

965 
P_B
 = 
¥ed_≥ls
[1];

966 
P_C
 = 
¥ed_≥ls
[2];

967 
P_D
 = 
¥ed_≥ls
[3];

968 
P_E
 = 
¥ed_≥ls
[4];

969 
P_F
 = 
¥ed_≥ls
[5];

970 
P_G
 = 
¥ed_≥ls
[6];

971 
P_H
 = 
¥ed_≥ls
[7];

975 
P_A
 = 
P_B
 = 
P_C
 = 
P_D
 = 
P_E
 = 
P_F
 = 
P_G
 = 
P_H
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

978 i‡(
block_avaûabÀ_up_right
)

980 
¥ed_≥ls
 = &
imgY
[
pix_c
.
pos_y
][pix_c.
pos_x
];

981 
P_I
 = 
¥ed_≥ls
[0];

982 
P_J
 = 
¥ed_≥ls
[1];

983 
P_K
 = 
¥ed_≥ls
[2];

984 
P_L
 = 
¥ed_≥ls
[3];

985 
P_M
 = 
¥ed_≥ls
[4];

986 
P_N
 = 
¥ed_≥ls
[5];

987 
P_O
 = 
¥ed_≥ls
[6];

988 
P_P
 = 
¥ed_≥ls
[7];

993 
P_I
 = 
P_J
 = 
P_K
 = 
P_L
 = 
P_M
 = 
P_N
 = 
P_O
 = 
P_P
 = 
P_H
;

996 i‡(
block_avaûabÀ_À·
)

998 
img≥l
 **
img_¥ed
 = &
imgY
[
pix_a
.
pos_y
];

999 
pos_x
 = 
pix_a
.pos_x;

1000 
P_Q
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

1001 
P_R
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

1002 
P_S
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

1003 
P_T
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

1004 
P_U
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

1005 
P_V
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

1006 
P_W
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

1007 
P_X
 = *(*(
img_¥ed
 ) + 
pos_x
);

1011 
P_Q
 = 
P_R
 = 
P_S
 = 
P_T
 = 
P_U
 = 
P_V
 = 
P_W
 = 
P_X
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

1014 i‡(
block_avaûabÀ_up_À·
)

1016 
P_Z
 = 
imgY
[
pix_d
.
pos_y
][pix_d.
pos_x
];

1020 
P_Z
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

1023 
	`LowPassF‹I¡ø8x8Pªd
(&(
P_Z
), 
block_avaûabÀ_up_À·
, 
block_avaûabÀ_up
, 
block_avaûabÀ_À·
);

1025 
PªdAºay
[ 0] = (
img≥l
Ë((
P_V
 + 
P_T
 + 2*
P_U
 + 2) >> 2);

1026 
PªdAºay
[ 1] = (
img≥l
Ë((
P_T
 + 
P_R
 + 2*
P_S
 + 2) >> 2);

1027 
PªdAºay
[ 2] = (
img≥l
Ë((
P_R
 + 
P_Z
 + 2*
P_Q
 + 2) >> 2);

1028 
PªdAºay
[ 3] = (
img≥l
Ë((
P_Z
 + 
P_A
 + 1) >> 1);

1029 
PªdAºay
[ 4] = (
img≥l
Ë((
P_A
 + 
P_B
 + 1) >> 1);

1030 
PªdAºay
[ 5] = (
img≥l
Ë((
P_B
 + 
P_C
 + 1) >> 1);

1031 
PªdAºay
[ 6] = (
img≥l
Ë((
P_C
 + 
P_D
 + 1) >> 1);

1032 
PªdAºay
[ 7] = (
img≥l
Ë((
P_D
 + 
P_E
 + 1) >> 1);

1033 
PªdAºay
[ 8] = (
img≥l
Ë((
P_E
 + 
P_F
 + 1) >> 1);

1034 
PªdAºay
[ 9] = (
img≥l
Ë((
P_F
 + 
P_G
 + 1) >> 1);

1035 
PªdAºay
[10] = (
img≥l
Ë((
P_G
 + 
P_H
 + 1) >> 1);

1037 
PªdAºay
[11] = (
img≥l
Ë((
P_W
 + 
P_U
 + 2*
P_V
 + 2) >> 2);

1038 
PªdAºay
[12] = (
img≥l
Ë((
P_U
 + 
P_S
 + 2*
P_T
 + 2) >> 2);

1039 
PªdAºay
[13] = (
img≥l
Ë((
P_S
 + 
P_Q
 + 2*
P_R
 + 2) >> 2);

1040 
PªdAºay
[14] = (
img≥l
Ë((
P_Q
 + 
P_A
 + 2*
P_Z
 + 2) >> 2);

1041 
PªdAºay
[15] = (
img≥l
Ë((
P_Z
 + 
P_B
 + 2*
P_A
 + 2) >> 2);

1042 
PªdAºay
[16] = (
img≥l
Ë((
P_A
 + 
P_C
 + 2*
P_B
 + 2) >> 2);

1043 
PªdAºay
[17] = (
img≥l
Ë((
P_B
 + 
P_D
 + 2*
P_C
 + 2) >> 2);

1044 
PªdAºay
[18] = (
img≥l
Ë((
P_C
 + 
P_E
 + 2*
P_D
 + 2) >> 2);

1045 
PªdAºay
[19] = (
img≥l
Ë((
P_D
 + 
P_F
 + 2*
P_E
 + 2) >> 2);

1046 
PªdAºay
[20] = (
img≥l
Ë((
P_E
 + 
P_G
 + 2*
P_F
 + 2) >> 2);

1047 
PªdAºay
[21] = (
img≥l
Ë((
P_F
 + 
P_H
 + 2*
P_G
 + 2) >> 2);

1049 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], &
PªdAºay
[ 3], 8 * (
img≥l
));

1050 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], &
PªdAºay
[14], 8 * (
img≥l
));

1051 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], &
PªdAºay
[ 2], 8 * (
img≥l
));

1052 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], &
PªdAºay
[13], 8 * (
img≥l
));

1053 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], &
PªdAºay
[ 1], 8 * (
img≥l
));

1054 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], &
PªdAºay
[12], 8 * (
img≥l
));

1055 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], &
PªdAºay
[ 0], 8 * (
img≥l
));

1056 
	`mem˝y
(&
m¥
[
joff
 ][
ioff
], &
PªdAºay
[11], 8 * (
img≥l
));

1058  
DECODING_OK
;

1059 
	}
}

1072 
ölöe
 
	$öåa8x8_vît_À·_¥ed
(
Ma¸oblock
 *
cuºMB
,

1073 
Cﬁ‹Pœ√
 
∂
,

1074 
ioff
,

1075 
joff
)

1077 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1078 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1080 
img≥l
 
PªdPñ
[25];

1081 
img≥l
 
PªdAºay
[22];

1082 
img≥l
 *
¥ed_≥l
 = &
PªdAºay
[0];

1083 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

1085 
PixñPos
 
pix_a
;

1086 
PixñPos
 
pix_b
, 
pix_c
, 
pix_d
;

1088 
block_avaûabÀ_up
;

1089 
block_avaûabÀ_À·
;

1090 
block_avaûabÀ_up_À·
;

1091 
block_avaûabÀ_up_right
;

1093 
img≥l
 *
¥ed_≥ls
, **
m¥
 = 
cuºSli˚
->
mb_¥ed
[
∂
];

1094 *
mb_size
 = 
p_Vid
->mb_size[
IS_LUMA
];

1096 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 , 
mb_size
, &
pix_a
);

1097 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 , 
joff
 - 1, 
mb_size
, &
pix_b
);

1098 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 + 8, 
joff
 - 1, 
mb_size
, &
pix_c
);

1099 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 - 1, 
mb_size
, &
pix_d
);

1101 
pix_c
.
avaûabÀ
 =Öix_c.avaûabÀ &&!(
ioff
 =8 && 
joff
 == 8);

1103 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

1105 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_a.
mb_addr
] : 0;

1106 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_b.
mb_addr
] : 0;

1107 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_c.
mb_addr
] : 0;

1108 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_d.
mb_addr
] : 0;

1112 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
;

1113 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

1114 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
;

1115 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
;

1118 i‡(!
block_avaûabÀ_up
)

1119 
	`¥ötf
 ("w¨nög: I¡ø_4x4_Vîtiˇl_Le·Öªdi˘i⁄ modênŸáŒowedáàmb %d\n", (Ë
cuºSli˚
->
cuºít_mb_ƒ
);

1122 i‡(
block_avaûabÀ_up
)

1124 
¥ed_≥ls
 = &
imgY
[
pix_b
.
pos_y
][pix_b.
pos_x
];

1125 
P_A
 = 
¥ed_≥ls
[0];

1126 
P_B
 = 
¥ed_≥ls
[1];

1127 
P_C
 = 
¥ed_≥ls
[2];

1128 
P_D
 = 
¥ed_≥ls
[3];

1129 
P_E
 = 
¥ed_≥ls
[4];

1130 
P_F
 = 
¥ed_≥ls
[5];

1131 
P_G
 = 
¥ed_≥ls
[6];

1132 
P_H
 = 
¥ed_≥ls
[7];

1136 
P_A
 = 
P_B
 = 
P_C
 = 
P_D
 = 
P_E
 = 
P_F
 = 
P_G
 = 
P_H
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

1139 i‡(
block_avaûabÀ_up_right
)

1141 
¥ed_≥ls
 = &
imgY
[
pix_c
.
pos_y
][pix_c.
pos_x
];

1142 
P_I
 = 
¥ed_≥ls
[0];

1143 
P_J
 = 
¥ed_≥ls
[1];

1144 
P_K
 = 
¥ed_≥ls
[2];

1145 
P_L
 = 
¥ed_≥ls
[3];

1146 
P_M
 = 
¥ed_≥ls
[4];

1147 
P_N
 = 
¥ed_≥ls
[5];

1148 
P_O
 = 
¥ed_≥ls
[6];

1149 
P_P
 = 
¥ed_≥ls
[7];

1154 
P_I
 = 
P_J
 = 
P_K
 = 
P_L
 = 
P_M
 = 
P_N
 = 
P_O
 = 
P_P
 = 
P_H
;

1157 i‡(
block_avaûabÀ_À·
)

1159 
img≥l
 **
img_¥ed
 = &
imgY
[
pix_a
.
pos_y
];

1160 
pos_x
 = 
pix_a
.pos_x;

1161 
P_Q
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

1162 
P_R
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

1163 
P_S
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

1164 
P_T
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

1165 
P_U
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

1166 
P_V
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

1167 
P_W
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

1168 
P_X
 = *(*(
img_¥ed
 ) + 
pos_x
);

1172 
P_Q
 = 
P_R
 = 
P_S
 = 
P_T
 = 
P_U
 = 
P_V
 = 
P_W
 = 
P_X
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

1175 i‡(
block_avaûabÀ_up_À·
)

1177 
P_Z
 = 
imgY
[
pix_d
.
pos_y
][pix_d.
pos_x
];

1181 
P_Z
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

1184 
	`LowPassF‹I¡ø8x8Pªd
(&(
P_Z
), 
block_avaûabÀ_up_À·
, 
block_avaûabÀ_up
, 
block_avaûabÀ_À·
);

1186 *
¥ed_≥l
++ = (
img≥l
Ë((
P_A
 + 
P_B
 + 1) >> 1);

1187 *
¥ed_≥l
++ = (
img≥l
Ë((
P_B
 + 
P_C
 + 1) >> 1);

1188 *
¥ed_≥l
++ = (
img≥l
Ë((
P_C
 + 
P_D
 + 1) >> 1);

1189 *
¥ed_≥l
++ = (
img≥l
Ë((
P_D
 + 
P_E
 + 1) >> 1);

1190 *
¥ed_≥l
++ = (
img≥l
Ë((
P_E
 + 
P_F
 + 1) >> 1);

1191 *
¥ed_≥l
++ = (
img≥l
Ë((
P_F
 + 
P_G
 + 1) >> 1);

1192 *
¥ed_≥l
++ = (
img≥l
Ë((
P_G
 + 
P_H
 + 1) >> 1);

1193 *
¥ed_≥l
++ = (
img≥l
Ë((
P_H
 + 
P_I
 + 1) >> 1);

1194 *
¥ed_≥l
++ = (
img≥l
Ë((
P_I
 + 
P_J
 + 1) >> 1);

1195 *
¥ed_≥l
++ = (
img≥l
Ë((
P_J
 + 
P_K
 + 1) >> 1);

1196 *
¥ed_≥l
++ = (
img≥l
Ë((
P_K
 + 
P_L
 + 1) >> 1);

1197 *
¥ed_≥l
++ = (
img≥l
Ë((
P_A
 + 
P_C
 + 2*
P_B
 + 2) >> 2);

1198 *
¥ed_≥l
++ = (
img≥l
Ë((
P_B
 + 
P_D
 + 2*
P_C
 + 2) >> 2);

1199 *
¥ed_≥l
++ = (
img≥l
Ë((
P_C
 + 
P_E
 + 2*
P_D
 + 2) >> 2);

1200 *
¥ed_≥l
++ = (
img≥l
Ë((
P_D
 + 
P_F
 + 2*
P_E
 + 2) >> 2);

1201 *
¥ed_≥l
++ = (
img≥l
Ë((
P_E
 + 
P_G
 + 2*
P_F
 + 2) >> 2);

1202 *
¥ed_≥l
++ = (
img≥l
Ë((
P_F
 + 
P_H
 + 2*
P_G
 + 2) >> 2);

1203 *
¥ed_≥l
++ = (
img≥l
Ë((
P_G
 + 
P_I
 + 2*
P_H
 + 2) >> 2);

1204 *
¥ed_≥l
++ = (
img≥l
Ë((
P_H
 + 
P_J
 + 2*
P_I
 + 2) >> 2);

1205 *
¥ed_≥l
++ = (
img≥l
Ë((
P_I
 + 
P_K
 + 2*
P_J
 + 2) >> 2);

1206 *
¥ed_≥l
++ = (
img≥l
Ë((
P_J
 + 
P_L
 + 2*
P_K
 + 2) >> 2);

1207 *
¥ed_≥l
 = (
img≥l
Ë((
P_K
 + 
P_M
 + 2*
P_L
 + 2) >> 2);

1209 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], &
PªdAºay
[ 0], 8 * (
img≥l
));

1210 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], &
PªdAºay
[11], 8 * (
img≥l
));

1211 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], &
PªdAºay
[ 1], 8 * (
img≥l
));

1212 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], &
PªdAºay
[12], 8 * (
img≥l
));

1213 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], &
PªdAºay
[ 2], 8 * (
img≥l
));

1214 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], &
PªdAºay
[13], 8 * (
img≥l
));

1215 
	`mem˝y
(&
m¥
[
joff
++][
ioff
], &
PªdAºay
[ 3], 8 * (
img≥l
));

1216 
	`mem˝y
(&
m¥
[
joff
 ][
ioff
], &
PªdAºay
[14], 8 * (
img≥l
));

1218  
DECODING_OK
;

1219 
	}
}

1231 
ölöe
 
	$öåa8x8_h‹_up_¥ed
(
Ma¸oblock
 *
cuºMB
,

1232 
Cﬁ‹Pœ√
 
∂
,

1233 
ioff
,

1234 
joff
)

1236 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1237 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1239 
img≥l
 
PªdPñ
[25];

1240 
img≥l
 
PªdAºay
[16];

1241 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

1243 
PixñPos
 
pix_a
;

1244 
PixñPos
 
pix_b
, 
pix_c
, 
pix_d
;

1246 
block_avaûabÀ_up
;

1247 
block_avaûabÀ_À·
;

1248 
block_avaûabÀ_up_À·
;

1249 
block_avaûabÀ_up_right
;

1250 
jpos0
 = 
joff
 , 
jpos1
 = jof‡+ 1, 
jpos2
 = jof‡+ 2, 
jpos3
 = joff + 3;

1251 
jpos4
 = 
joff
 + 4, 
jpos5
 = jof‡+ 5, 
jpos6
 = jof‡+ 6, 
jpos7
 = joff + 7;

1253 #i‡(
IMGTYPE
 == 0)

1254 
ùos3
 = 
ioff
 + 3, 
ùos5
 = iof‡+ 5, 
ùos7
 = ioff + 7;

1256 
ùos0
 = 
ioff
 , 
ùos1
 = iof‡+ 1, 
ùos2
 = iof‡+ 2, 
ùos3
 = ioff + 3;

1257 
ùos4
 = 
ioff
 + 4, 
ùos5
 = iof‡+ 5, 
ùos6
 = iof‡+ 6, 
ùos7
 = ioff + 7;

1259 
img≥l
 *
¥ed_≥ls
, **
m¥
 = 
cuºSli˚
->
mb_¥ed
[
∂
];

1260 *
mb_size
 = 
p_Vid
->mb_size[
IS_LUMA
];

1262 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 , 
mb_size
, &
pix_a
);

1263 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 , 
joff
 - 1, 
mb_size
, &
pix_b
);

1264 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 + 8, 
joff
 - 1, 
mb_size
, &
pix_c
);

1265 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 - 1, 
mb_size
, &
pix_d
);

1267 
pix_c
.
avaûabÀ
 =Öix_c.avaûabÀ &&!(
ioff
 =8 && 
joff
 == 8);

1269 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

1271 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_a.
mb_addr
] : 0;

1272 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_b.
mb_addr
] : 0;

1273 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_c.
mb_addr
] : 0;

1274 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_d.
mb_addr
] : 0;

1278 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
;

1279 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

1280 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
;

1281 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
;

1284 i‡(!
block_avaûabÀ_À·
)

1285 
	`¥ötf
 ("w¨nög: I¡ø_8x8_H‹iz⁄èl_U∞¥edi˘i⁄ modênŸáŒowedáàmb %d\n", (Ë
cuºSli˚
->
cuºít_mb_ƒ
);

1288 i‡(
block_avaûabÀ_up
)

1290 
¥ed_≥ls
 = &
imgY
[
pix_b
.
pos_y
][pix_b.
pos_x
];

1291 
P_A
 = 
¥ed_≥ls
[0];

1292 
P_B
 = 
¥ed_≥ls
[1];

1293 
P_C
 = 
¥ed_≥ls
[2];

1294 
P_D
 = 
¥ed_≥ls
[3];

1295 
P_E
 = 
¥ed_≥ls
[4];

1296 
P_F
 = 
¥ed_≥ls
[5];

1297 
P_G
 = 
¥ed_≥ls
[6];

1298 
P_H
 = 
¥ed_≥ls
[7];

1302 
P_A
 = 
P_B
 = 
P_C
 = 
P_D
 = 
P_E
 = 
P_F
 = 
P_G
 = 
P_H
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

1305 i‡(
block_avaûabÀ_up_right
)

1307 
¥ed_≥ls
 = &
imgY
[
pix_c
.
pos_y
][pix_c.
pos_x
];

1308 
P_I
 = 
¥ed_≥ls
[0];

1309 
P_J
 = 
¥ed_≥ls
[1];

1310 
P_K
 = 
¥ed_≥ls
[2];

1311 
P_L
 = 
¥ed_≥ls
[3];

1312 
P_M
 = 
¥ed_≥ls
[4];

1313 
P_N
 = 
¥ed_≥ls
[5];

1314 
P_O
 = 
¥ed_≥ls
[6];

1315 
P_P
 = 
¥ed_≥ls
[7];

1320 
P_I
 = 
P_J
 = 
P_K
 = 
P_L
 = 
P_M
 = 
P_N
 = 
P_O
 = 
P_P
 = 
P_H
;

1323 i‡(
block_avaûabÀ_À·
)

1325 
img≥l
 **
img_¥ed
 = &
imgY
[
pix_a
.
pos_y
];

1326 
pos_x
 = 
pix_a
.pos_x;

1327 
P_Q
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

1328 
P_R
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

1329 
P_S
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

1330 
P_T
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

1331 
P_U
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

1332 
P_V
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

1333 
P_W
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

1334 
P_X
 = *(*(
img_¥ed
 ) + 
pos_x
);

1338 
P_Q
 = 
P_R
 = 
P_S
 = 
P_T
 = 
P_U
 = 
P_V
 = 
P_W
 = 
P_X
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

1341 i‡(
block_avaûabÀ_up_À·
)

1343 
P_Z
 = 
imgY
[
pix_d
.
pos_y
][pix_d.
pos_x
];

1347 
P_Z
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

1350 
	`LowPassF‹I¡ø8x8Pªd
(&(
P_Z
), 
block_avaûabÀ_up_À·
, 
block_avaûabÀ_up
, 
block_avaûabÀ_À·
);

1352 
PªdAºay
[ 0] = (
img≥l
Ë((
P_Q
 + 
P_R
 + 1) >> 1);

1353 
PªdAºay
[ 1] = (
img≥l
Ë((
P_S
 + 
P_Q
 + 2*
P_R
 + 2) >> 2);

1354 
PªdAºay
[ 2] = (
img≥l
Ë((
P_R
 + 
P_S
 + 1) >> 1);

1355 
PªdAºay
[ 3] = (
img≥l
Ë((
P_T
 + 
P_R
 + 2*
P_S
 + 2) >> 2);

1356 
PªdAºay
[ 4] = (
img≥l
Ë((
P_S
 + 
P_T
 + 1) >> 1);

1357 
PªdAºay
[ 5] = (
img≥l
Ë((
P_U
 + 
P_S
 + 2*
P_T
 + 2) >> 2);

1358 
PªdAºay
[ 6] = (
img≥l
Ë((
P_T
 + 
P_U
 + 1) >> 1);

1359 
PªdAºay
[ 7] = (
img≥l
Ë((
P_V
 + 
P_T
 + 2*
P_U
 + 2) >> 2);

1360 
PªdAºay
[ 8] = (
img≥l
Ë((
P_U
 + 
P_V
 + 1) >> 1);

1361 
PªdAºay
[ 9] = (
img≥l
Ë((
P_W
 + 
P_U
 + 2*
P_V
 + 2) >> 2);

1362 
PªdAºay
[10] = (
img≥l
Ë((
P_V
 + 
P_W
 + 1) >> 1);

1363 
PªdAºay
[11] = (
img≥l
Ë((
P_X
 + 
P_V
 + 2*
P_W
 + 2) >> 2);

1364 
PªdAºay
[12] = (
img≥l
Ë((
P_W
 + 
P_X
 + 1) >> 1);

1365 
PªdAºay
[13] = (
img≥l
Ë((
P_W
 + 3*
P_X
 + 2) >> 2);

1366 
PªdAºay
[14] = (
img≥l
Ë
P_X
;

1368 
	`mem˝y
(&
m¥
[
jpos0
][
ioff
], &
PªdAºay
[0], 8 * (
img≥l
));

1369 
	`mem˝y
(&
m¥
[
jpos1
][
ioff
], &
PªdAºay
[2], 8 * (
img≥l
));

1370 
	`mem˝y
(&
m¥
[
jpos2
][
ioff
], &
PªdAºay
[4], 8 * (
img≥l
));

1371 
	`mem˝y
(&
m¥
[
jpos3
][
ioff
], &
PªdAºay
[6], 8 * (
img≥l
));

1372 
	`mem˝y
(&
m¥
[
jpos4
][
ioff
], &
PªdAºay
[8], 7 * (
img≥l
));

1373 
	`mem˝y
(&
m¥
[
jpos5
][
ioff
], &
PªdAºay
[10], 5 * (
img≥l
));

1374 
	`mem˝y
(&
m¥
[
jpos6
][
ioff
], &
PªdAºay
[12], 3 * (
img≥l
));

1376 #i‡(
IMGTYPE
 == 0)

1377 
m¥
[
jpos4
][
ùos7
] = 
PªdAºay
[14];

1378 
	`mem£t
(&
m¥
[
jpos5
][
ùos5
], 
PªdAºay
[14], 3 * (
img≥l
));

1379 
	`mem£t
(&
m¥
[
jpos6
][
ùos3
], 
PªdAºay
[14], 5 * (
img≥l
));

1380 
	`mem£t
(&
m¥
[
jpos7
][
ioff
 ], 
PªdAºay
[14], 8 * (
img≥l
));

1382 
m¥
[
jpos4
][
ùos7
] = 
PªdAºay
[14];

1383 
m¥
[
jpos5
][
ùos5
] = m¥[jpos5][
ùos6
] = m¥[jpos5][
ùos7
] = 
PªdAºay
[14];

1384 
m¥
[
jpos6
][
ùos3
] = m¥[jpos6][
ùos4
] = m¥[jpos6][
ùos5
] = m¥[jpos6][
ùos6
] = m¥[jpos6][
ùos7
] = 
PªdAºay
[14];

1385 
m¥
[
jpos7
][
ùos0
] = m¥[jpos7][
ùos1
] = m¥[jpos7][
ùos2
] = m¥[jpos7][
ùos3
] =

1386 
m¥
[
jpos7
][
ùos4
] = m¥[jpos7][
ùos5
] = m¥[jpos7][
ùos6
] = m¥[jpos7][
ùos7
] = 
PªdAºay
[14];

1388  
DECODING_OK
;

1389 
	}
}

1401 
ölöe
 
	$öåa8x8_h‹_down_¥ed
(
Ma¸oblock
 *
cuºMB
,

1402 
Cﬁ‹Pœ√
 
∂
,

1403 
ioff
,

1404 
joff
)

1406 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1407 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1409 
img≥l
 
PªdPñ
[25];

1410 
img≥l
 
PªdAºay
[22];

1411 
img≥l
 **
imgY
 = (
∂
Ë? 
cuºSli˚
->
dec_pi˘uª
->
imgUV
[pl - 1] : currSlice->dec_picture->imgY;

1413 
PixñPos
 
pix_a
;

1414 
PixñPos
 
pix_b
, 
pix_c
, 
pix_d
;

1416 
block_avaûabÀ_up
;

1417 
block_avaûabÀ_À·
;

1418 
block_avaûabÀ_up_À·
;

1419 
block_avaûabÀ_up_right
;

1420 
jpos0
 = 
joff
 , 
jpos1
 = jof‡+ 1, 
jpos2
 = jof‡+ 2, 
jpos3
 = joff + 3;

1421 
jpos4
 = 
joff
 + 4, 
jpos5
 = jof‡+ 5, 
jpos6
 = jof‡+ 6, 
jpos7
 = joff + 7;

1423 
img≥l
 *
¥ed_≥ls
, **
m¥
 = 
cuºSli˚
->
mb_¥ed
[
∂
];

1424 *
mb_size
 = 
p_Vid
->mb_size[
IS_LUMA
];

1426 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 , 
mb_size
, &
pix_a
);

1427 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 , 
joff
 - 1, 
mb_size
, &
pix_b
);

1428 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 + 8, 
joff
 - 1, 
mb_size
, &
pix_c
);

1429 
	`gëN⁄AffNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 - 1, 
mb_size
, &
pix_d
);

1431 
pix_c
.
avaûabÀ
 =Öix_c.avaûabÀ &&!(
ioff
 =8 && 
joff
 == 8);

1433 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

1435 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_a.
mb_addr
] : 0;

1436 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_b.
mb_addr
] : 0;

1437 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_c.
mb_addr
] : 0;

1438 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
 [pix_d.
mb_addr
] : 0;

1442 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
;

1443 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

1444 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
;

1445 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
;

1448 i‡((!
block_avaûabÀ_up
)||(!
block_avaûabÀ_À·
)||(!
block_avaûabÀ_up_À·
))

1449 
	`¥ötf
 ("w¨nög: I¡ø_8x8_H‹iz⁄èl_Dow¿¥edi˘i⁄ modênŸáŒowedáàmb %d\n", (Ë
cuºSli˚
->
cuºít_mb_ƒ
);

1452 i‡(
block_avaûabÀ_up
)

1454 
¥ed_≥ls
 = &
imgY
[
pix_b
.
pos_y
][pix_b.
pos_x
];

1455 
P_A
 = 
¥ed_≥ls
[0];

1456 
P_B
 = 
¥ed_≥ls
[1];

1457 
P_C
 = 
¥ed_≥ls
[2];

1458 
P_D
 = 
¥ed_≥ls
[3];

1459 
P_E
 = 
¥ed_≥ls
[4];

1460 
P_F
 = 
¥ed_≥ls
[5];

1461 
P_G
 = 
¥ed_≥ls
[6];

1462 
P_H
 = 
¥ed_≥ls
[7];

1466 
P_A
 = 
P_B
 = 
P_C
 = 
P_D
 = 
P_E
 = 
P_F
 = 
P_G
 = 
P_H
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

1469 i‡(
block_avaûabÀ_up_right
)

1471 
¥ed_≥ls
 = &
imgY
[
pix_c
.
pos_y
][pix_c.
pos_x
];

1472 
P_I
 = 
¥ed_≥ls
[0];

1473 
P_J
 = 
¥ed_≥ls
[1];

1474 
P_K
 = 
¥ed_≥ls
[2];

1475 
P_L
 = 
¥ed_≥ls
[3];

1476 
P_M
 = 
¥ed_≥ls
[4];

1477 
P_N
 = 
¥ed_≥ls
[5];

1478 
P_O
 = 
¥ed_≥ls
[6];

1479 
P_P
 = 
¥ed_≥ls
[7];

1484 
P_I
 = 
P_J
 = 
P_K
 = 
P_L
 = 
P_M
 = 
P_N
 = 
P_O
 = 
P_P
 = 
P_H
;

1487 i‡(
block_avaûabÀ_À·
)

1489 
img≥l
 **
img_¥ed
 = &
imgY
[
pix_a
.
pos_y
];

1490 
pos_x
 = 
pix_a
.pos_x;

1491 
P_Q
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

1492 
P_R
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

1493 
P_S
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

1494 
P_T
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

1495 
P_U
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

1496 
P_V
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

1497 
P_W
 = *(*(
img_¥ed
 ++Ë+ 
pos_x
);

1498 
P_X
 = *(*(
img_¥ed
 ) + 
pos_x
);

1502 
P_Q
 = 
P_R
 = 
P_S
 = 
P_T
 = 
P_U
 = 
P_V
 = 
P_W
 = 
P_X
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

1505 i‡(
block_avaûabÀ_up_À·
)

1507 
P_Z
 = 
imgY
[
pix_d
.
pos_y
][pix_d.
pos_x
];

1511 
P_Z
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

1514 
	`LowPassF‹I¡ø8x8Pªd
(&(
P_Z
), 
block_avaûabÀ_up_À·
, 
block_avaûabÀ_up
, 
block_avaûabÀ_À·
);

1516 
PªdAºay
[ 0] = (
img≥l
Ë((
P_X
 + 
P_W
 + 1) >> 1);

1517 
PªdAºay
[ 1] = (
img≥l
Ë((
P_V
 + 
P_X
 + 2*
P_W
 + 2) >> 2);

1518 
PªdAºay
[ 2] = (
img≥l
Ë((
P_W
 + 
P_V
 + 1) >> 1);

1519 
PªdAºay
[ 3] = (
img≥l
Ë((
P_U
 + 
P_W
 + 2*
P_V
 + 2) >> 2);

1520 
PªdAºay
[ 4] = (
img≥l
Ë((
P_V
 + 
P_U
 + 1) >> 1);

1521 
PªdAºay
[ 5] = (
img≥l
Ë((
P_T
 + 
P_V
 + 2*
P_U
 + 2) >> 2);

1522 
PªdAºay
[ 6] = (
img≥l
Ë((
P_U
 + 
P_T
 + 1) >> 1);

1523 
PªdAºay
[ 7] = (
img≥l
Ë((
P_S
 + 
P_U
 + 2*
P_T
 + 2) >> 2);

1524 
PªdAºay
[ 8] = (
img≥l
Ë((
P_T
 + 
P_S
 + 1) >> 1);

1525 
PªdAºay
[ 9] = (
img≥l
Ë((
P_R
 + 
P_T
 + 2*
P_S
 + 2) >> 2);

1526 
PªdAºay
[10] = (
img≥l
Ë((
P_S
 + 
P_R
 + 1) >> 1);

1527 
PªdAºay
[11] = (
img≥l
Ë((
P_Q
 + 
P_S
 + 2*
P_R
 + 2) >> 2);

1528 
PªdAºay
[12] = (
img≥l
Ë((
P_R
 + 
P_Q
 + 1) >> 1);

1529 
PªdAºay
[13] = (
img≥l
Ë((
P_Z
 + 
P_R
 + 2*
P_Q
 + 2) >> 2);

1530 
PªdAºay
[14] = (
img≥l
Ë((
P_Q
 + 
P_Z
 + 1) >> 1);

1531 
PªdAºay
[15] = (
img≥l
Ë((
P_Q
 + 
P_A
 + 2*
P_Z
 + 2) >> 2);

1532 
PªdAºay
[16] = (
img≥l
Ë((
P_Z
 + 
P_B
 + 2*
P_A
 + 2) >> 2);

1533 
PªdAºay
[17] = (
img≥l
Ë((
P_A
 + 
P_C
 + 2*
P_B
 + 2) >> 2);

1534 
PªdAºay
[18] = (
img≥l
Ë((
P_B
 + 
P_D
 + 2*
P_C
 + 2) >> 2);

1535 
PªdAºay
[19] = (
img≥l
Ë((
P_C
 + 
P_E
 + 2*
P_D
 + 2) >> 2);

1536 
PªdAºay
[20] = (
img≥l
Ë((
P_D
 + 
P_F
 + 2*
P_E
 + 2) >> 2);

1537 
PªdAºay
[21] = (
img≥l
Ë((
P_E
 + 
P_G
 + 2*
P_F
 + 2) >> 2);

1539 
	`mem˝y
(&
m¥
[
jpos0
][
ioff
], &
PªdAºay
[14], 8 * (
img≥l
));

1540 
	`mem˝y
(&
m¥
[
jpos1
][
ioff
], &
PªdAºay
[12], 8 * (
img≥l
));

1541 
	`mem˝y
(&
m¥
[
jpos2
][
ioff
], &
PªdAºay
[10], 8 * (
img≥l
));

1542 
	`mem˝y
(&
m¥
[
jpos3
][
ioff
], &
PªdAºay
[ 8], 8 * (
img≥l
));

1543 
	`mem˝y
(&
m¥
[
jpos4
][
ioff
], &
PªdAºay
[ 6], 8 * (
img≥l
));

1544 
	`mem˝y
(&
m¥
[
jpos5
][
ioff
], &
PªdAºay
[ 4], 8 * (
img≥l
));

1545 
	`mem˝y
(&
m¥
[
jpos6
][
ioff
], &
PªdAºay
[ 2], 8 * (
img≥l
));

1546 
	`mem˝y
(&
m¥
[
jpos7
][
ioff
], &
PªdAºay
[ 0], 8 * (
img≥l
));

1548  
DECODING_OK
;

1549 
	}
}

1565 
	$öå≠ªd8x8_n‹mÆ
(
Ma¸oblock
 *
cuºMB
,

1566 
Cﬁ‹Pœ√
 
∂
,

1567 
ioff
,

1568 
joff
)

1571 
block_x
 = (
cuºMB
->block_xË+ (
ioff
 >> 2);

1572 
block_y
 = (
cuºMB
->block_yË+ (
joff
 >> 2);

1573 
byã
 
¥edmode
 = 
cuºMB
->
p_Sli˚
->
ùªdmode
[
block_y
][
block_x
];

1575 
cuºMB
->
ùmode_DPCM
 = 
¥edmode
;

1577 
¥edmode
)

1579 
DC_PRED
:

1580  (
	`öåa8x8_dc_¥ed
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

1582 
VERT_PRED
:

1583  (
	`öåa8x8_vît_¥ed
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

1585 
HOR_PRED
:

1586  (
	`öåa8x8_h‹_¥ed
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

1588 
DIAG_DOWN_RIGHT_PRED
:

1589  (
	`öåa8x8_düg_down_right_¥ed
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

1591 
DIAG_DOWN_LEFT_PRED
:

1592  (
	`öåa8x8_düg_down_À·_¥ed
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

1594 
VERT_RIGHT_PRED
:

1595  (
	`öåa8x8_vît_right_¥ed
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

1597 
VERT_LEFT_PRED
:

1598  (
	`öåa8x8_vît_À·_¥ed
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

1600 
HOR_UP_PRED
:

1601  (
	`öåa8x8_h‹_up_¥ed
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

1603 
HOR_DOWN_PRED
:

1604  (
	`öåa8x8_h‹_down_¥ed
(
cuºMB
, 
∂
, 
ioff
, 
joff
));

1606 
	`¥ötf
("Eº‹: iŒegÆ i¡ø_8x8Öªdi˘i⁄ mode: %d\n", (Ë
¥edmode
);

1607  
SEARCH_SYNC
;

1610 
	}
}

	@ldecod/src/intra_chroma_pred.c

15 
	~"globÆ.h
"

16 
	~"block.h
"

17 
	~"mb_ac˚ss.h
"

18 
	~"image.h
"

21 
	$öåa_chroma_DC_sögÀ
(
img≥l
 **
cuº_img
, 
up_avaû
, 
À·_avaû
, 
PixñPos
 
up
, PixñPo†
À·
, 
blk_x
, 
blk_y
, *
¥ed
, 
dúe˘i⁄
 )

23 
i
;

24 
s0
 = 0;

26 i‡((
dúe˘i⁄
 && 
up_avaû
Ë|| (!
À·_avaû
 && up_avail))

28 
img≥l
 *
cur_≥l
 = &
cuº_img
[
up
.
pos_y
][up.
pos_x
 + 
blk_x
];

29 
i
 = 0; i < 4;++i)

30 
s0
 +*(
cur_≥l
++);

31 *
¥ed
 = (
s0
 + 2) >> 2;

33 i‡(
À·_avaû
)

35 
img≥l
 **
cur_≥l
 = &(
cuº_img
[
À·
.
pos_y
 + 
blk_y
 - 1]);

36 
pos_x
 = 
À·
.pos_x;

37 
i
 = 0; i < 4;++i)

38 
s0
 +*((*
cur_≥l
++Ë+ 
pos_x
);

39 *
¥ed
 = (
s0
 + 2) >> 2;

41 
	}
}

44 
	$öåa_chroma_DC_Æl
(
img≥l
 **
cuº_img
, 
up_avaû
, 
À·_avaû
, 
PixñPos
 
up
, PixñPo†
À·
, 
blk_x
, 
blk_y
, *
¥ed
 )

46 
i
;

47 
s0
 = 0, 
s1
 = 0;

49 i‡(
up_avaû
)

51 
img≥l
 *
cur_≥l
 = &
cuº_img
[
up
.
pos_y
][up.
pos_x
 + 
blk_x
];

52 
i
 = 0; i < 4;++i)

53 
s0
 +*(
cur_≥l
++);

56 i‡(
À·_avaû
)

58 
img≥l
 **
cur_≥l
 = &(
cuº_img
[
À·
.
pos_y
 + 
blk_y
 - 1]);

59 
pos_x
 = 
À·
.pos_x;

60 
i
 = 0; i < 4;++i)

61 
s1
 +*((*
cur_≥l
++Ë+ 
pos_x
);

64 i‡(
up_avaû
 && 
À·_avaû
)

65 *
¥ed
 = (
s0
 + 
s1
 + 4) >> 3;

66 i‡(
up_avaû
)

67 *
¥ed
 = (
s0
 + 2) >> 2;

68 i‡(
À·_avaû
)

69 *
¥ed
 = (
s1
 + 2) >> 2;

70 
	}
}

72 
	$öå≠ªd_chroma_dc
(
Ma¸oblock
 *
cuºMB
)

74 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

75 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

76 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
cuºSli˚
->dec_picture;

77 
b8
, 
b4
;

78 
yuv
 = 
dec_pi˘uª
->
chroma_f‹m©_idc
 - 1;

79 
blk_x
, 
blk_y
;

80 
¥ed
, 
¥ed1
;

81 c⁄° 
block_pos
[3][4][4]=

88 
PixñPos
 
up
;

89 
PixñPos
 
À·
;

90 
up_avaû
, 
À·_avaû
;

91 
img≥l
 **
imgUV0
 = 
dec_pi˘uª
->
imgUV
[0];

92 
img≥l
 **
imgUV1
 = 
dec_pi˘uª
->
imgUV
[1];

93 
img≥l
 **
mb_¥ed0
 = 
cuºSli˚
->
mb_¥ed
[0 + 1];

94 
img≥l
 **
mb_¥ed1
 = 
cuºSli˚
->
mb_¥ed
[1 + 1];

97 
	`gëN⁄AffNeighbour
(
cuºMB
, -1, 0, 
p_Vid
->
mb_size
[
IS_CHROMA
], &
À·
);

98 
	`gëN⁄AffNeighbour
(
cuºMB
, 0, -1, 
p_Vid
->
mb_size
[
IS_CHROMA
], &
up
);

100 i‡(!
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

102 
up_avaû
 = 
up
.
avaûabÀ
;

103 
À·_avaû
 = 
À·
.
avaûabÀ
;

107 
up_avaû
 = 
up
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[up.
mb_addr
] : 0;

108 
À·_avaû
 = 
À·
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[À·.
mb_addr
]: 0;

114 
b8
 = 0; b8 < (
p_Vid
->
num_uv_blocks
) ;++b8)

116 
b4
 = 0; b4 < 4; ++b4)

118 
blk_y
 = 
subblk_off£t_y
[
yuv
][
b8
][
b4
];

119 
blk_x
 = 
subblk_off£t_x
[
yuv
][
b8
][
b4
];

120 
¥ed
 = 
p_Vid
->
dc_¥ed_vÆue_comp
[1];

121 
¥ed1
 = 
p_Vid
->
dc_¥ed_vÆue_comp
[2];

123 
block_pos
[
yuv
][
b8
][
b4
])

126 
	`öåa_chroma_DC_Æl
 (
imgUV0
, 
up_avaû
, 
À·_avaû
, 
up
, 
À·
, 
blk_x
, 
blk_y
 + 1, &
¥ed
);

127 
	`öåa_chroma_DC_Æl
 (
imgUV1
, 
up_avaû
, 
À·_avaû
, 
up
, 
À·
, 
blk_x
, 
blk_y
 + 1, &
¥ed1
);

130 
	`öåa_chroma_DC_sögÀ
(
imgUV0
, 
up_avaû
, 
À·_avaû
, 
up
, 
À·
, 
blk_x
, 
blk_y
 + 1, &
¥ed
, 1);

131 
	`öåa_chroma_DC_sögÀ
(
imgUV1
, 
up_avaû
, 
À·_avaû
, 
up
, 
À·
, 
blk_x
, 
blk_y
 + 1, &
¥ed1
, 1);

134 
	`öåa_chroma_DC_sögÀ
(
imgUV0
, 
up_avaû
, 
À·_avaû
, 
up
, 
À·
, 
blk_x
, 
blk_y
 + 1, &
¥ed
, 0);

135 
	`öåa_chroma_DC_sögÀ
(
imgUV1
, 
up_avaû
, 
À·_avaû
, 
up
, 
À·
, 
blk_x
, 
blk_y
 + 1, &
¥ed1
, 0);

138 
	`öåa_chroma_DC_Æl
 (
imgUV0
, 
up_avaû
, 
À·_avaû
, 
up
, 
À·
, 
blk_x
, 
blk_y
 + 1, &
¥ed
);

139 
	`öåa_chroma_DC_Æl
 (
imgUV1
, 
up_avaû
, 
À·_avaû
, 
up
, 
À·
, 
blk_x
, 
blk_y
 + 1, &
¥ed1
);

143 #i‡(
IMGTYPE
 == 0)

145 
jj
;

146 
jj
 = 
blk_y
; jj < blk_y + 
BLOCK_SIZE
; ++jj)

148 
	`mem£t
(&
mb_¥ed0
[
jj
][
blk_x
], 
¥ed
, 
BLOCK_SIZE
 * (
img≥l
));

149 
	`mem£t
(&
mb_¥ed1
[
jj
][
blk_x
], 
¥ed1
, 
BLOCK_SIZE
 * (
img≥l
));

154 
jj
, 
ii
;

155 
jj
 = 
blk_y
; jj < blk_y + 
BLOCK_SIZE
; ++jj)

157 
ii
 = 
blk_x
; iò< blk_x + 
BLOCK_SIZE
; ++ii)

159 
mb_¥ed0
[
jj
][
ii
]=(
img≥l
Ë
¥ed
;

160 
mb_¥ed1
[
jj
][
ii
]=(
img≥l
Ë
¥ed1
;

167 
	}
}

169 
	$öå≠ªd_chroma_h‹
(
Ma¸oblock
 *
cuºMB
)

171 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

172 
PixñPos
 
a
;

173 
À·_avaû
;

175 
	`gëN⁄AffNeighbour
(
cuºMB
, -1, 0, 
p_Vid
->
mb_size
[
IS_CHROMA
], &
a
);

177 i‡(!
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

178 
À·_avaû
 = 
a
.
avaûabÀ
;

180 
À·_avaû
 = 
a
.
avaûabÀ
 ? 
cuºMB
->
p_Sli˚
->
öåa_block
[a.
mb_addr
]: 0;

182 i‡(!
À·_avaû
 )

183 
	`îr‹
("unexpected HOR_PRED_8 chroma intraÖrediction mode",-1);

186 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

187 
¸_MB_x
 = 
p_Vid
->
mb_¸_size_x
;

188 
¸_MB_y
 = 
p_Vid
->
mb_¸_size_y
;

190 
j
;

191 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
cuºSli˚
->dec_picture;

192 #i‡(
IMGTYPE
 != 0)

193 
i
, 
¥ed
, 
¥ed1
;

195 
pos_y
 = 
a
.pos_y;

196 
pos_x
 = 
a
.pos_x;

197 
img≥l
 **
mb_¥ed0
 = 
cuºSli˚
->
mb_¥ed
[0 + 1];

198 
img≥l
 **
mb_¥ed1
 = 
cuºSli˚
->
mb_¥ed
[1 + 1];

199 
img≥l
 **
i0
 = &
dec_pi˘uª
->
imgUV
[0][
pos_y
];

200 
img≥l
 **
i1
 = &
dec_pi˘uª
->
imgUV
[1][
pos_y
];

202 
j
 = 0; j < 
¸_MB_y
; ++j)

204 #i‡(
IMGTYPE
 == 0)

205 
	`mem£t
(
mb_¥ed0
[
j
], (*
i0
++)[
pos_x
], 
¸_MB_x
 * (
img≥l
));

206 
	`mem£t
(
mb_¥ed1
[
j
], (*
i1
++)[
pos_x
], 
¸_MB_x
 * (
img≥l
));

208 
¥ed
 = (*
i0
++)[
pos_x
];

209 
¥ed1
 = (*
i1
++)[
pos_x
];

210 
i
 = 0; i < 
¸_MB_x
; ++i)

212 
mb_¥ed0
[
j
][
i
]=(
img≥l
Ë
¥ed
;

213 
mb_¥ed1
[
j
][
i
]=(
img≥l
Ë
¥ed1
;

219 
	}
}

221 
	$öå≠ªd_chroma_vî
(
Ma¸oblock
 *
cuºMB
)

223 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

224 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

225 
j
;

226 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
cuºSli˚
->dec_picture;

228 
PixñPos
 
up
;

229 
up_avaû
;

230 
¸_MB_x
 = 
p_Vid
->
mb_¸_size_x
;

231 
¸_MB_y
 = 
p_Vid
->
mb_¸_size_y
;

232 
	`gëN⁄AffNeighbour
(
cuºMB
, 0, -1, 
p_Vid
->
mb_size
[
IS_CHROMA
], &
up
);

234 i‡(!
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

235 
up_avaû
 = 
up
.
avaûabÀ
;

237 
up_avaû
 = 
up
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[up.
mb_addr
] : 0;

239 i‡(!
up_avaû
)

240 
	`îr‹
("unexpected VERT_PRED_8 chroma intraÖrediction mode",-1);

243 
img≥l
 **
mb_¥ed0
 = 
cuºSli˚
->
mb_¥ed
[1];

244 
img≥l
 **
mb_¥ed1
 = 
cuºSli˚
->
mb_¥ed
[2];

245 
img≥l
 *
i0
 = &(
dec_pi˘uª
->
imgUV
[0][
up
.
pos_y
][up.
pos_x
]);

246 
img≥l
 *
i1
 = &(
dec_pi˘uª
->
imgUV
[1][
up
.
pos_y
][up.
pos_x
]);

248 
j
 = 0; j < 
¸_MB_y
; ++j)

250 
	`mem˝y
(
mb_¥ed0
[
j
], 
i0
, 
¸_MB_x
 * (
img≥l
));

251 
	`mem˝y
(
mb_¥ed1
[
j
], 
i1
, 
¸_MB_x
 * (
img≥l
));

254 
	}
}

256 
	$öå≠ªd_chroma_∂™e
(
Ma¸oblock
 *
cuºMB
)

258 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

259 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

260 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
cuºSli˚
->dec_picture;

262 
PixñPos
 
up
;

263 
PixñPos
 
up_À·
;

264 
PixñPos
 
À·
;

265 
up_avaû
, 
À·_avaû
, 
À·_up_avaû
;

267 
	`gëN⁄AffNeighbour
(
cuºMB
, -1, -1, 
p_Vid
->
mb_size
[
IS_CHROMA
], &
up_À·
);

268 
	`gëN⁄AffNeighbour
(
cuºMB
, -1, 0, 
p_Vid
->
mb_size
[
IS_CHROMA
], &
À·
);

269 
	`gëN⁄AffNeighbour
(
cuºMB
, 0, -1, 
p_Vid
->
mb_size
[
IS_CHROMA
], &
up
);

271 i‡(!
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

273 
up_avaû
 = 
up
.
avaûabÀ
;

274 
À·_avaû
 = 
À·
.
avaûabÀ
;

275 
À·_up_avaû
 = 
up_À·
.
avaûabÀ
;

279 
up_avaû
 = 
up
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[up.
mb_addr
] : 0;

280 
À·_avaû
 = 
À·
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[À·.
mb_addr
]: 0;

281 
À·_up_avaû
 = 
up_À·
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[up_À·.
mb_addr
]: 0;

284 i‡(!
À·_up_avaû
 || !
À·_avaû
 || !
up_avaû
)

285 
	`îr‹
("unexpected PLANE_8 chroma intraÖrediction mode",-1);

288 
¸_MB_x
 = 
p_Vid
->
mb_¸_size_x
;

289 
¸_MB_y
 = 
p_Vid
->
mb_¸_size_y
;

290 
¸_MB_y2
 = (
¸_MB_y
 >> 1);

291 
¸_MB_x2
 = (
¸_MB_x
 >> 1);

293 
i
,
j
;

294 
ih
, 
iv
, 
ib
, 
ic
, 
üa
;

295 
uv
;

296 
uv
 = 0; uv < 2; uv++)

298 
img≥l
 **
imgUV
 = 
dec_pi˘uª
->imgUV[
uv
];

299 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_¥ed[
uv
 + 1];

300 
max_img≥l_vÆue
 = 
p_Vid
->
max_≥l_vÆue_comp
[
uv
 + 1];

301 
img≥l
 *
upPªd
 = &
imgUV
[
up
.
pos_y
][up.
pos_x
];

302 
pos_x
 = 
up_À·
.pos_x;

303 
pos_y1
 = 
À·
.
pos_y
 + 
¸_MB_y2
;

304 
pos_y2
 = 
pos_y1
 - 2;

306 
img≥l
 **
¥edU2
 = &
imgUV
[
pos_y2
];

307 
ih
 = 
¸_MB_x2
 * (
upPªd
[
¸_MB_x
 - 1] - 
imgUV
[
up_À·
.
pos_y
][
pos_x
]);

309 
i
 = 0; i < 
¸_MB_x2
 - 1; ++i)

310 
ih
 +(
i
 + 1Ë* (
upPªd
[
¸_MB_x2
 + i] - upPred[cr_MB_x2 - 2 - i]);

312 
iv
 = 
¸_MB_y2
 * (
imgUV
[
À·
.
pos_y
 + 
¸_MB_y
 - 1][
pos_x
] - imgUV[
up_À·
.pos_y][pos_x]);

314 
i
 = 0; i < 
¸_MB_y2
 - 1; ++i)

316 
iv
 +(
i
 + 1)*(*(
imgUV
[
pos_y1
++] + 
pos_x
Ë- *((*
¥edU2
--) +Öos_x));

319 
ib
((
¸_MB_x
 =8 ? 17 : 5Ë* 
ih
 + 2 * cr_MB_x)>>(cr_MB_x == 8 ? 5 : 6);

320 
ic
((
¸_MB_y
 =8 ? 17 : 5Ë* 
iv
 + 2 * cr_MB_y)>>(cr_MB_y == 8 ? 5 : 6);

322 
üa
 = ((
imgUV
[
pos_y1
][
pos_x
] + 
upPªd
[
¸_MB_x
-1]) << 4);

324 
j
 = 0; j < 
¸_MB_y
; ++j)

326 
∂™e
 = 
üa
 + (
j
 - 
¸_MB_y2
 + 1Ë* 
ic
 + 16 - (
¸_MB_x2
 - 1Ë* 
ib
;

328 
i
 = 0; i < 
¸_MB_x
; ++i)

329 
mb_¥ed
[
j
][
i
]=(
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((ò* 
ib
 + 
∂™e
) >> 5));

333 
	}
}

342 
	$öåa_¥ed_chroma
(
Ma¸oblock
 *
cuºMB
)

344 
cuºMB
->
c_ùªd_mode
)

346 
DC_PRED_8
:

347 
	`öå≠ªd_chroma_dc
(
cuºMB
);

349 
HOR_PRED_8
:

350 
	`öå≠ªd_chroma_h‹
(
cuºMB
);

352 
VERT_PRED_8
:

353 
	`öå≠ªd_chroma_vî
(
cuºMB
);

355 
PLANE_8
:

356 
	`öå≠ªd_chroma_∂™e
(
cuºMB
);

359 
	`îr‹
("illegal chroma intraÖrediction mode", 600);

362 
	}
}

	@ldecod/src/intra_chroma_pred_mbaff.c

15 
	~"globÆ.h
"

16 
	~"block.h
"

17 
	~"mb_ac˚ss.h
"

18 
	~"image.h
"

20 
	$öåa_chroma_DC_sögÀ_mbaff
(
img≥l
 **
cuº_img
, 
up_avaû
, 
À·_avaû
, 
PixñPos
 
up
, PixñPo†
À·
[17], 
blk_x
, 
blk_y
, *
¥ed
, 
dúe˘i⁄
 )

22 
i
;

23 
s0
 = 0;

25 i‡((
dúe˘i⁄
 && 
up_avaû
Ë|| (!
À·_avaû
 && up_avail))

27 
i
 = 
blk_x
; i < (blk_x + 4);++i)

28 
s0
 +
cuº_img
[
up
.
pos_y
][up.
pos_x
 + 
i
];

29 *
¥ed
 = (
s0
 + 2) >> 2;

31 i‡(
À·_avaû
)

33 
i
 = 
blk_y
; i < (blk_y + 4);++i)

34 
s0
 +
cuº_img
[
À·
[
i
].
pos_y
][À·[i].
pos_x
];

35 *
¥ed
 = (
s0
 + 2) >> 2;

37 
	}
}

39 
	$öå≠ªd_chroma_vî_mbaff
(
Ma¸oblock
 *
cuºMB
)

41 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

42 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

43 
j
;

44 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
cuºSli˚
->dec_picture;

46 
PixñPos
 
up
;

47 
up_avaû
;

48 
¸_MB_x
 = 
p_Vid
->
mb_¸_size_x
;

49 
¸_MB_y
 = 
p_Vid
->
mb_¸_size_y
;

51 
	`gëAffNeighbour
(
cuºMB
, 0, -1, 
p_Vid
->
mb_size
[
IS_CHROMA
], &
up
);

53 i‡(!
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

54 
up_avaû
 = 
up
.
avaûabÀ
;

56 
up_avaû
 = 
up
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[up.
mb_addr
] : 0;

58 i‡(!
up_avaû
)

59 
	`îr‹
("unexpected VERT_PRED_8 chroma intraÖrediction mode",-1);

62 
img≥l
 **
mb_¥ed0
 = 
cuºSli˚
->
mb_¥ed
[1];

63 
img≥l
 **
mb_¥ed1
 = 
cuºSli˚
->
mb_¥ed
[2];

64 
img≥l
 *
i0
 = &(
dec_pi˘uª
->
imgUV
[0][
up
.
pos_y
][up.
pos_x
]);

65 
img≥l
 *
i1
 = &(
dec_pi˘uª
->
imgUV
[1][
up
.
pos_y
][up.
pos_x
]);

67 
j
 = 0; j < 
¸_MB_y
; ++j)

69 
	`mem˝y
(&(
mb_¥ed0
[
j
][0]),
i0
, 
¸_MB_x
 * (
img≥l
));

70 
	`mem˝y
(&(
mb_¥ed1
[
j
][0]),
i1
, 
¸_MB_x
 * (
img≥l
));

73 
	}
}

76 
	$öåa_chroma_DC_Æl_mbaff
(
img≥l
 **
cuº_img
, 
up_avaû
, 
À·_avaû
, 
PixñPos
 
up
, PixñPo†
À·
[17], 
blk_x
, 
blk_y
, *
¥ed
 )

78 
i
;

79 
s0
 = 0, 
s1
 = 0;

81 i‡(
up_avaû
)

82 
i
 = 
blk_x
; i < (blk_x + 4);++i)

83 
s0
 +
cuº_img
[
up
.
pos_y
][up.
pos_x
 + 
i
];

85 i‡(
À·_avaû
)

86 
i
 = 
blk_y
; i < (blk_y + 4);++i)

87 
s1
 +
cuº_img
[
À·
[
i
].
pos_y
][À·[i].
pos_x
];

89 i‡(
up_avaû
 && 
À·_avaû
)

90 *
¥ed
 = (
s0
 + 
s1
 + 4) >> 3;

91 i‡(
up_avaû
)

92 *
¥ed
 = (
s0
 + 2) >> 2;

93 i‡(
À·_avaû
)

94 *
¥ed
 = (
s1
 + 2) >> 2;

95 
	}
}

105 
	$öåa_¥ed_chroma_mbaff
(
Ma¸oblock
 *
cuºMB
)

107 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

108 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

109 
i
,
j
, 
ii
, 
jj
;

110 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
cuºSli˚
->dec_picture;

112 
ih
, 
iv
, 
ib
, 
ic
, 
üa
;

114 
b8
, 
b4
;

115 
yuv
 = 
dec_pi˘uª
->
chroma_f‹m©_idc
 - 1;

116 
blk_x
, 
blk_y
;

117 
¥ed
;

118 c⁄° 
block_pos
[3][4][4]=

125 
cuºMB
->
c_ùªd_mode
)

127 
DC_PRED_8
:

129 
PixñPos
 
up
;

130 
PixñPos
 
À·
[17];

132 
up_avaû
, 
À·_avaû
[2];

134 
¸_MB_y
 = 
p_Vid
->
mb_¸_size_y
;

135 
¸_MB_y2
 = (
¸_MB_y
 >> 1);

137 
i
=0; i < 
¸_MB_y
 + 1 ; ++i)

138 
	`gëAffNeighbour
(
cuºMB
, -1, 
i
-1, 
p_Vid
->
mb_size
[
IS_CHROMA
], &
À·
[i]);

139 
	`gëAffNeighbour
(
cuºMB
, 0, -1, 
p_Vid
->
mb_size
[
IS_CHROMA
], &
up
);

141 i‡(!
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

143 
up_avaû
 = 
up
.
avaûabÀ
;

144 
À·_avaû
[0] =Üe·_avaû[1] = 
À·
[1].
avaûabÀ
;

148 
up_avaû
 = 
up
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[up.
mb_addr
] : 0;

149 
i
=0, 
À·_avaû
[0] = 1; i < 
¸_MB_y2
;++i)

150 
À·_avaû
[0] &
À·
[
i
 + 1].
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[À·[ò+ 1].
mb_addr
]: 0;

152 
i
 = 
¸_MB_y2
, 
À·_avaû
[1] = 1; i<
¸_MB_y
;++i)

153 
À·_avaû
[1] &
À·
[
i
 + 1].
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[À·[ò+ 1].
mb_addr
]: 0;

160 
¥ed1
;

161 
img≥l
 **
imgUV0
 = 
dec_pi˘uª
->
imgUV
[0];

162 
img≥l
 **
imgUV1
 = 
dec_pi˘uª
->
imgUV
[1];

163 
img≥l
 **
mb_¥ed0
 = 
cuºSli˚
->
mb_¥ed
[0 + 1];

164 
img≥l
 **
mb_¥ed1
 = 
cuºSli˚
->
mb_¥ed
[1 + 1];

165 
b8
 = 0; b8 < (
p_Vid
->
num_uv_blocks
) ;++b8)

167 
b4
 = 0; b4 < 4; ++b4)

169 
blk_y
 = 
subblk_off£t_y
[
yuv
][
b8
][
b4
];

170 
blk_x
 = 
subblk_off£t_x
[
yuv
][
b8
][
b4
];

172 
¥ed
 = 
p_Vid
->
dc_¥ed_vÆue_comp
[1];

173 
¥ed1
 = 
p_Vid
->
dc_¥ed_vÆue_comp
[2];

175 
block_pos
[
yuv
][
b8
][
b4
])

178 
	`öåa_chroma_DC_Æl_mbaff
 (
imgUV0
, 
up_avaû
, 
À·_avaû
[0], 
up
, 
À·
, 
blk_x
, 
blk_y
 + 1, &
¥ed
);

179 
	`öåa_chroma_DC_Æl_mbaff
 (
imgUV1
, 
up_avaû
, 
À·_avaû
[0], 
up
, 
À·
, 
blk_x
, 
blk_y
 + 1, &
¥ed1
);

182 
	`öåa_chroma_DC_sögÀ_mbaff
 (
imgUV0
, 
up_avaû
, 
À·_avaû
[0], 
up
, 
À·
, 
blk_x
, 
blk_y
 + 1, &
¥ed
, 1);

183 
	`öåa_chroma_DC_sögÀ_mbaff
 (
imgUV1
, 
up_avaû
, 
À·_avaû
[0], 
up
, 
À·
, 
blk_x
, 
blk_y
 + 1, &
¥ed1
, 1);

186 
	`öåa_chroma_DC_sögÀ_mbaff
 (
imgUV0
, 
up_avaû
, 
À·_avaû
[1], 
up
, 
À·
, 
blk_x
, 
blk_y
 + 1, &
¥ed
, 0);

187 
	`öåa_chroma_DC_sögÀ_mbaff
 (
imgUV1
, 
up_avaû
, 
À·_avaû
[1], 
up
, 
À·
, 
blk_x
, 
blk_y
 + 1, &
¥ed1
, 0);

190 
	`öåa_chroma_DC_Æl_mbaff
 (
imgUV0
, 
up_avaû
, 
À·_avaû
[1], 
up
, 
À·
, 
blk_x
, 
blk_y
 + 1, &
¥ed
);

191 
	`öåa_chroma_DC_Æl_mbaff
 (
imgUV1
, 
up_avaû
, 
À·_avaû
[1], 
up
, 
À·
, 
blk_x
, 
blk_y
 + 1, &
¥ed1
);

195 
jj
 = 
blk_y
; jj < blk_y + 
BLOCK_SIZE
; ++jj)

197 
ii
 = 
blk_x
; iò< blk_x + 
BLOCK_SIZE
; ++ii)

199 
mb_¥ed0
[
jj
][
ii
]=(
img≥l
Ë
¥ed
;

200 
mb_¥ed1
[
jj
][
ii
]=(
img≥l
Ë
¥ed1
;

208 
HOR_PRED_8
:

210 
PixñPos
 
À·
[17];

212 
À·_avaû
[2];

214 
¸_MB_x
 = 
p_Vid
->
mb_¸_size_x
;

215 
¸_MB_y
 = 
p_Vid
->
mb_¸_size_y
;

216 
¸_MB_y2
 = (
¸_MB_y
 >> 1);

218 
i
=0; i < 
¸_MB_y
 + 1 ; ++i)

219 
	`gëAffNeighbour
(
cuºMB
, -1, 
i
-1, 
p_Vid
->
mb_size
[
IS_CHROMA
], &
À·
[i]);

221 i‡(!
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

223 
À·_avaû
[0] =Üe·_avaû[1] = 
À·
[1].
avaûabÀ
;

227 
i
=0, 
À·_avaû
[0] = 1; i < 
¸_MB_y2
;++i)

228 
À·_avaû
[0] &
À·
[
i
 + 1].
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[À·[ò+ 1].
mb_addr
]: 0;

230 
i
 = 
¸_MB_y2
, 
À·_avaû
[1] = 1; i<
¸_MB_y
;++i)

231 
À·_avaû
[1] &
À·
[
i
 + 1].
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[À·[ò+ 1].
mb_addr
]: 0;

234 i‡(!
À·_avaû
[0] || !left_avail[1])

235 
	`îr‹
("unexpected HOR_PRED_8 chroma intraÖrediction mode",-1);

238 
¥ed1
;

239 
img≥l
 **
mb_¥ed0
 = 
cuºSli˚
->
mb_¥ed
[0 + 1];

240 
img≥l
 **
mb_¥ed1
 = 
cuºSli˚
->
mb_¥ed
[1 + 1];

241 
img≥l
 **
i0
 = 
dec_pi˘uª
->
imgUV
[0];

242 
img≥l
 **
i1
 = 
dec_pi˘uª
->
imgUV
[1];

243 
j
 = 0; j < 
¸_MB_y
; ++j)

245 
¥ed
 = 
i0
[
À·
[1 + 
j
].
pos_y
][À·[1 + j].
pos_x
];

246 
¥ed1
 = 
i1
[
À·
[1 + 
j
].
pos_y
][À·[1 + j].
pos_x
];

247 
i
 = 0; i < 
¸_MB_x
; ++i)

249 
mb_¥ed0
[
j
][
i
]=(
img≥l
Ë
¥ed
;

250 
mb_¥ed1
[
j
][
i
]=(
img≥l
Ë
¥ed1
;

256 
VERT_PRED_8
:

258 
PixñPos
 
up
;

260 
up_avaû
;

262 
¸_MB_x
 = 
p_Vid
->
mb_¸_size_x
;

263 
¸_MB_y
 = 
p_Vid
->
mb_¸_size_y
;

265 
	`gëAffNeighbour
(
cuºMB
, 0, -1, 
p_Vid
->
mb_size
[
IS_CHROMA
], &
up
);

267 i‡(!
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

268 
up_avaû
 = 
up
.
avaûabÀ
;

270 
up_avaû
 = 
up
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[up.
mb_addr
] : 0;

272 i‡(!
up_avaû
)

273 
	`îr‹
("unexpected VERT_PRED_8 chroma intraÖrediction mode",-1);

276 
img≥l
 **
mb_¥ed0
 = 
cuºSli˚
->
mb_¥ed
[0 + 1];

277 
img≥l
 **
mb_¥ed1
 = 
cuºSli˚
->
mb_¥ed
[1 + 1];

278 
img≥l
 *
i0
 = &(
dec_pi˘uª
->
imgUV
[0][
up
.
pos_y
][up.
pos_x
]);

279 
img≥l
 *
i1
 = &(
dec_pi˘uª
->
imgUV
[1][
up
.
pos_y
][up.
pos_x
]);

280 
j
 = 0; j < 
¸_MB_y
; ++j)

282 
	`mem˝y
(&(
mb_¥ed0
[
j
][0]),
i0
, 
¸_MB_x
 * (
img≥l
));

283 
	`mem˝y
(&(
mb_¥ed1
[
j
][0]),
i1
, 
¸_MB_x
 * (
img≥l
));

288 
PLANE_8
:

290 
PixñPos
 
up
;

291 
PixñPos
 
À·
[17];

293 
up_avaû
, 
À·_avaû
[2], 
À·_up_avaû
;

295 
¸_MB_x
 = 
p_Vid
->
mb_¸_size_x
;

296 
¸_MB_y
 = 
p_Vid
->
mb_¸_size_y
;

297 
¸_MB_y2
 = (
¸_MB_y
 >> 1);

298 
¸_MB_x2
 = (
¸_MB_x
 >> 1);

300 
i
=0; i < 
¸_MB_y
 + 1 ; ++i)

301 
	`gëAffNeighbour
(
cuºMB
, -1, 
i
-1, 
p_Vid
->
mb_size
[
IS_CHROMA
], &
À·
[i]);

302 
	`gëAffNeighbour
(
cuºMB
, 0, -1, 
p_Vid
->
mb_size
[
IS_CHROMA
], &
up
);

304 i‡(!
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

306 
up_avaû
 = 
up
.
avaûabÀ
;

307 
À·_avaû
[0] =Üe·_avaû[1] = 
À·
[1].
avaûabÀ
;

308 
À·_up_avaû
 = 
À·
[0].
avaûabÀ
;

312 
up_avaû
 = 
up
.
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[up.
mb_addr
] : 0;

313 
i
=0, 
À·_avaû
[0] = 1; i < 
¸_MB_y2
;++i)

314 
À·_avaû
[0] &
À·
[
i
 + 1].
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[À·[ò+ 1].
mb_addr
]: 0;

316 
i
 = 
¸_MB_y2
, 
À·_avaû
[1] = 1; i<
¸_MB_y
;++i)

317 
À·_avaû
[1] &
À·
[
i
 + 1].
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[À·[ò+ 1].
mb_addr
]: 0;

319 
À·_up_avaû
 = 
À·
[0].
avaûabÀ
 ? 
cuºSli˚
->
öåa_block
[À·[0].
mb_addr
]: 0;

322 i‡(!
À·_up_avaû
 || !
À·_avaû
[0] || !À·_avaû[1] || !
up_avaû
)

323 
	`îr‹
("unexpected PLANE_8 chroma intraÖrediction mode",-1);

326 
uv
;

327 
uv
 = 0; uv < 2; uv++)

329 
img≥l
 **
imgUV
 = 
dec_pi˘uª
->imgUV[
uv
];

330 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_¥ed[
uv
 + 1];

331 
max_img≥l_vÆue
 = 
p_Vid
->
max_≥l_vÆue_comp
[
uv
 + 1];

332 
img≥l
 *
upPªd
 = &
imgUV
[
up
.
pos_y
][up.
pos_x
];

334 
ih
 = 
¸_MB_x2
 * (
upPªd
[
¸_MB_x
 - 1] - 
imgUV
[
À·
[0].
pos_y
][À·[0].
pos_x
]);

335 
i
 = 0; i < 
¸_MB_x2
 - 1; ++i)

336 
ih
 +(
i
 + 1Ë* (
upPªd
[
¸_MB_x2
 + i] - upPred[cr_MB_x2 - 2 - i]);

338 
iv
 = 
¸_MB_y2
 * (
imgUV
[
À·
[
¸_MB_y
].
pos_y
][À·[¸_MB_y].
pos_x
] - imgUV[left[0].pos_y][left[0].pos_x]);

339 
i
 = 0; i < 
¸_MB_y2
 - 1; ++i)

340 
iv
 +(
i
 + 1)*(
imgUV
[
À·
[
¸_MB_y2
 + 1 + i].
pos_y
][À·[¸_MB_y2 + 1 + i].
pos_x
] -

341 
imgUV
[
À·
[
¸_MB_y2
 - 1 - 
i
].
pos_y
][À·[¸_MB_y2 - 1 - i].
pos_x
]);

343 
ib
((
¸_MB_x
 =8 ? 17 : 5Ë* 
ih
 + 2 * cr_MB_x)>>(cr_MB_x == 8 ? 5 : 6);

344 
ic
((
¸_MB_y
 =8 ? 17 : 5Ë* 
iv
 + 2 * cr_MB_y)>>(cr_MB_y == 8 ? 5 : 6);

346 
üa
=16*(
imgUV
[
À·
[
¸_MB_y
].
pos_y
][À·[¸_MB_y].
pos_x
] + 
upPªd
[
¸_MB_x
-1]);

348 
j
 = 0; j < 
¸_MB_y
; ++j)

349 
i
 = 0; i < 
¸_MB_x
; ++i)

350 
mb_¥ed
[
j
][
i
]=(
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((
üa
 + (ò- 
¸_MB_x2
 + 1Ë* 
ib
 + (j - 
¸_MB_y2
 + 1Ë* 
ic
 + 16) >> 5));

356 
	`îr‹
("illegal chroma intraÖrediction mode", 600);

359 
	}
}

	@ldecod/src/intra_pred_common.c

15 
	~"globÆ.h
"

16 
	~"öåa4x4_¥ed.h
"

17 
	~"öåa8x8_¥ed.h
"

18 
	~"öåa16x16_¥ed.h
"

19 
	~"mb_ac˚ss.h
"

20 
	~"image.h
"

23 
öåa_¥ed_chroma
 (
Ma¸oblock
 *
cuºMB
);

24 
öåa_¥ed_chroma_mbaff
(
Ma¸oblock
 *
cuºMB
);

27 
	$£t_öåa_¥edi˘i⁄_modes
(
Sli˚
 *
cuºSli˚
)

29 i‡(
cuºSli˚
->
mb_aff_‰ame_Êag
)

31 
cuºSli˚
->
öåa_¥ed_4x4
 = 
öåa_¥ed_4x4_mbaff
;

32 
cuºSli˚
->
öåa_¥ed_8x8
 = 
öåa_¥ed_8x8_mbaff
;

33 
cuºSli˚
->
öåa_¥ed_16x16
 = 
öåa_¥ed_16x16_mbaff
;

34 
cuºSli˚
->
öåa_¥ed_chroma
 = 
öåa_¥ed_chroma_mbaff
;

38 
cuºSli˚
->
öåa_¥ed_4x4
 = 
öåa_¥ed_4x4_n‹mÆ
;

39 
cuºSli˚
->
öåa_¥ed_8x8
 = 
öåa_¥ed_8x8_n‹mÆ
;

40 
cuºSli˚
->
öåa_¥ed_16x16
 = 
öåa_¥ed_16x16_n‹mÆ
;

41 
cuºSli˚
->
öåa_¥ed_chroma
 = intra_pred_chroma;

43 
	}
}

	@ldecod/src/ldecod.c

45 
	~"c⁄åibut‹s.h
"

49 
	~"globÆ.h
"

50 
	~"™√xb.h
"

51 
	~"image.h
"

52 
	~"memÆloc.h
"

53 
	~"mc_¥edi˘i⁄.h
"

54 
	~"mbuf„r.h
"

55 
	~"Àaky_buckë.h
"

56 
	~"fmo.h
"

57 
	~"ouçut.h
"

58 
	~"ˇbac.h
"

59 
	~"∑r£t.h
"

60 
	~"£i.h
"

61 
	~"îc_≠i.h
"

62 
	~"qu™t.h
"

63 
	~"block.h
"

64 
	~"«lu.h
"

65 
	~"img_io.h
"

66 
	~"lo›fûãr.h
"

67 
	~"πp.h
"

68 
	~"öput.h
"

69 
	~"ouçut.h
"

70 
	~"h264decodî.h
"

71 
	~"dec_°©i°ics.h
"

73 
	#LOGFILE
 "log.dec"

	)

74 
	#DATADECFILE
 "d©aDec.txt"

	)

75 
	#TRACEFILE
 "åa˚_dec.txt"

	)

79 
DecodîP¨ams
 *
	gp_Dec
;

80 
	gîr‹ãxt
[
ET_SIZE
];

83 
Rï‹t
 (
VideoP¨amëîs
 *
p_Vid
);

84 
öô
 (
VideoP¨amëîs
 *
p_Vid
);

85 
‰ì_¶i˚
 (
Sli˚
 *
cuºSli˚
);

87 
öô_‰ext
(
VideoP¨amëîs
 *
p_Vid
);

100 
	$îr‹
(*
ãxt
, 
code
)

102 
	`Ârötf
(
°dîr
, "%s\n", 
ãxt
);

103 i‡(
p_Dec
)

105 
	`Êush_dpb
(
p_Dec
->
p_Vid
->
p_Dpb_œyî
[0]);

106 #i‡(
MVC_EXTENSION_ENABLE
)

107 
	`Êush_dpb
(
p_Dec
->
p_Vid
->
p_Dpb_œyî
[1]);

111 
	`exô
(
code
);

112 
	}
}

114 
	$ª£t_dpb
–
VideoP¨amëîs
 *
p_Vid
, 
DecodedPi˘uªBuf„r
 *
p_Dpb
 )

116 
p_Dpb
->
p_Vid
 =Ö_Vid;

117 
p_Dpb
->
öô_d⁄e
 = 0;

118 
	}
}

127 
	$Æloc_video_∑øms
–
VideoP¨amëîs
 **
p_Vid
)

129 
i
;

130 i‡((*
p_Vid
 = (
VideoP¨amëîs
 *Ë
	`ˇŒoc
(1, (VideoP¨amëîs)))==
NULL
)

131 
	`no_mem_exô
("alloc_video_params:Ö_Vid");

133 i‡(((*
p_Vid
)->
ﬁd_¶i˚
 = (
OldSli˚P¨ams
 *Ë
	`ˇŒoc
(1, (OldSli˚P¨ams)))==
NULL
)

134 
	`no_mem_exô
("alloc_video_params:Ö_Vid->old_slice");

136 i‡(((*
p_Vid
)->
¢r
 = (
SNRP¨amëîs
 *)
	`ˇŒoc
(1, (SNRP¨amëîs)))==
NULL
)

137 
	`no_mem_exô
("alloc_video_params:Ö_Vid->snr");

140 
i
 = 0; i < 
MAX_NUM_DPB_LAYERS
; i++)

142 i‡(((*
p_Vid
)->
p_Dpb_œyî
[
i
] = (
DecodedPi˘uªBuf„r
*)
	`ˇŒoc
(1, (DecodedPi˘uªBuf„r)))==
NULL
)

143 
	`no_mem_exô
("alloc_video_params:Ö_Vid->p_Dpb_layer[i]");

144 (*
p_Vid
)->
p_Dpb_œyî
[
i
]->
œyî_id
 = i;

145 
	`ª£t_dpb
(*
p_Vid
, (*p_Vid)->
p_Dpb_œyî
[
i
]);

146 if(((*
p_Vid
)->
p_EncodeP¨
[
i
] = (
CodögP¨amëîs
 *)
	`ˇŒoc
(1, (CodögP¨amëîs))Ë=
NULL
)

147 
	`no_mem_exô
("alloc_video_params:p_Vid->p_EncodePar[i]");

148 ((*
p_Vid
)->
p_EncodeP¨
[
i
])->
œyî_id
 = i;

149 if(((*
p_Vid
)->
p_LayîP¨
[
i
] = (
LayîP¨amëîs
 *)
	`ˇŒoc
(1, (LayîP¨amëîs))Ë=
NULL
)

150 
	`no_mem_exô
("alloc_video_params:p_Vid->p_LayerPar[i]");

151 ((*
p_Vid
)->
p_LayîP¨
[
i
])->
œyî_id
 = i;

153 (*
p_Vid
)->
globÆ_öô_d⁄e
[0] = (*p_Vid)->global_init_done[1] = 0;

155 #i‡(
ENABLE_OUTPUT_TONEMAPPING
)

156 i‡(((*
p_Vid
)->
£iT⁄eM≠pög
 = (
T⁄eM≠pögSEI
*)
	`ˇŒoc
(1, (T⁄eM≠pögSEI)))==
NULL
)

157 
	`no_mem_exô
("alloc_video_params: (*p_Vid)->seiToneMapping");

160 if(((*
p_Vid
)->
µSli˚Li°
 = (
Sli˚
 **Ë
	`ˇŒoc
(
MAX_NUM_DECSLICES
, (Sli˚ *))Ë=
NULL
)

162 
	`no_mem_exô
("alloc_video_params:Ö_Vid->ppSliceList");

164 (*
p_Vid
)->
iNumOfSli˚sAŒoˇãd
 = 
MAX_NUM_DECSLICES
;

166 (*
p_Vid
)->
pNextSli˚
 = 
NULL
;

167 (*
p_Vid
)->
«lu
 = 
	`AŒocNALU
(
MAX_CODED_FRAME_SIZE
);

168 (*
p_Vid
)->
pDecOuputPic
 = (
DecodedPicLi°
 *)
	`ˇŒoc
(1, (DecodedPicList));

169 (*
p_Vid
)->
pNextPPS
 = 
	`AŒocPPS
();

170 (*
p_Vid
)->
fú°_•s
 = 
TRUE
;

171 
	}
}

182 
	$Æloc_∑øms
–
I≈utP¨amëîs
 **
p_I≈
 )

184 i‡((*
p_I≈
 = (
I≈utP¨amëîs
 *Ë
	`ˇŒoc
(1, (I≈utP¨amëîs)))==
NULL
)

185 
	`no_mem_exô
("alloc_params:Ö_Inp");

186 
	}
}

196 
	$Æloc_decodî
–
DecodîP¨ams
 **
p_Dec
)

198 i‡((*
p_Dec
 = (
DecodîP¨ams
 *Ë
	`ˇŒoc
(1, (DecodîP¨ams)))==
NULL
)

200 
	`Ârötf
(
°dîr
, "alloc_decoder:Ö_Dec\n");

204 
	`Æloc_video_∑øms
(&((*
p_Dec
)->
p_Vid
));

205 
	`Æloc_∑øms
(&((*
p_Dec
)->
p_I≈
));

206 (*
p_Dec
)->
p_Vid
->
p_I≈
 = (*p_Dec)->p_Inp;

207 (*
p_Dec
)->
p_åa˚
 = 
NULL
;

208 (*
p_Dec
)->
buf„rSize
 = 0;

209 (*
p_Dec
)->
bôcou¡î
 = 0;

211 
	}
}

221 
	$‰ì_img
–
VideoP¨amëîs
 *
p_Vid
)

223 
i
;

224 i‡(
p_Vid
 !
NULL
)

226 i‡–
p_Vid
->
p_I≈
->
FûeF‹m©
 =
PAR_OF_ANNEXB
 )

228 
	`‰ì_™√x_b
 (&
p_Vid
->
™√x_b
);

230 #i‡(
ENABLE_OUTPUT_TONEMAPPING
)

231 i‡(
p_Vid
->
£iT⁄eM≠pög
 !
NULL
)

233 
	`‰ì
 (
p_Vid
->
£iT⁄eM≠pög
);

234 
p_Vid
->
£iT⁄eM≠pög
 = 
NULL
;

239 
i
 = 0; i < 
MAX_NUM_DPB_LAYERS
; i++)

241 i‡(
p_Vid
->
p_Dpb_œyî
[
i
] !
NULL
)

243 
	`‰ì
 (
p_Vid
->
p_Dpb_œyî
[
i
]);

244 
p_Vid
->
p_Dpb_œyî
[
i
] = 
NULL
;

246 if(
p_Vid
->
p_EncodeP¨
[
i
])

248 
	`‰ì
(
p_Vid
->
p_EncodeP¨
[
i
]);

249 
p_Vid
->
p_EncodeP¨
[
i
] = 
NULL
;

251 if(
p_Vid
->
p_LayîP¨
[
i
])

253 
	`‰ì
(
p_Vid
->
p_LayîP¨
[
i
]);

254 
p_Vid
->
p_LayîP¨
[
i
] = 
NULL
;

257 i‡(
p_Vid
->
¢r
 !
NULL
)

259 
	`‰ì
 (
p_Vid
->
¢r
);

260 
p_Vid
->
¢r
 = 
NULL
;

262 i‡(
p_Vid
->
ﬁd_¶i˚
 !
NULL
)

264 
	`‰ì
 (
p_Vid
->
ﬁd_¶i˚
);

265 
p_Vid
->
ﬁd_¶i˚
 = 
NULL
;

268 if(
p_Vid
->
pNextSli˚
)

270 
	`‰ì_¶i˚
(
p_Vid
->
pNextSli˚
);

271 
p_Vid
->
pNextSli˚
=
NULL
;

273 if(
p_Vid
->
µSli˚Li°
)

275 
i
;

276 
i
=0; i<
p_Vid
->
iNumOfSli˚sAŒoˇãd
; i++)

277 if(
p_Vid
->
µSli˚Li°
[
i
])

278 
	`‰ì_¶i˚
(
p_Vid
->
µSli˚Li°
[
i
]);

279 
	`‰ì
(
p_Vid
->
µSli˚Li°
);

281 if(
p_Vid
->
«lu
)

283 
	`FªeNALU
(
p_Vid
->
«lu
);

284 
p_Vid
->
«lu
=
NULL
;

287 
	`FªeDecPicLi°
(
p_Vid
->
pDecOuputPic
);

288 if(
p_Vid
->
pNextPPS
)

290 
	`FªePPS
(
p_Vid
->
pNextPPS
);

291 
p_Vid
->
pNextPPS
 = 
NULL
;

295 #i‡
ENABLE_DEC_STATS


296 
	`dñëe_dec_°©s
(
p_Vid
->
dec_°©s
);

297 
	`‰ì
 (
p_Vid
->
dec_°©s
);

300 
	`‰ì
 (
p_Vid
);

301 
p_Vid
 = 
NULL
;

303 
	}
}

305 
	$FªeDecPicLi°
(
DecodedPicLi°
 *
pDecPicLi°
)

307 
pDecPicLi°
)

309 
DecodedPicLi°
 *
pPicNext
 = 
pDecPicLi°
->
pNext
;

310 if(
pDecPicLi°
->
pY
)

312 
	`‰ì
(
pDecPicLi°
->
pY
);

313 
pDecPicLi°
->
pY
 = 
NULL
;

314 
pDecPicLi°
->
pU
 = 
NULL
;

315 
pDecPicLi°
->
pV
 = 
NULL
;

317 
	`‰ì
(
pDecPicLi°
);

318 
pDecPicLi°
 = 
pPicNext
;

320 
	}
}

328 
	$öô
(
VideoP¨amëîs
 *
p_Vid
)

331 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

332 
p_Vid
->
ﬁdFømeSizeInMbs
 = () -1;

334 
p_Vid
->
imgY_ªf
 = 
NULL
;

335 
p_Vid
->
imgUV_ªf
 = 
NULL
;

337 
p_Vid
->
ªcovîy_poöt
 = 0;

338 
p_Vid
->
ªcovîy_poöt_found
 = 0;

339 
p_Vid
->
ªcovîy_poc
 = 0x7fffffff;

341 
p_Vid
->
idr_p¢r_numbî
 = 
p_I≈
->
ªf_off£t
;

342 
p_Vid
->
p¢r_numbî
=0;

344 
p_Vid
->
numbî
 = 0;

345 
p_Vid
->
ty≥
 = 
I_SLICE
;

349 
p_Vid
->
g_nFøme
 = 0;

351 
p_Vid
->
B‰ame_˘r
 =Ö_Vid->
¢r
->
‰ame_˘r
 = 0;

354 
p_Vid
->
tŸ_time
 = 0;

356 
p_Vid
->
dec_pi˘uª
 = 
NULL
;

363 
p_Vid
->
MbToSli˚GroupM≠
 = 
NULL
;

364 
p_Vid
->
M≠UnôToSli˚GroupM≠
 = 
NULL
;

366 
p_Vid
->
La°Ac˚ssUnôExi°s
 = 0;

367 
p_Vid
->
NALUCou¡
 = 0;

370 
p_Vid
->
out_buf„r
 = 
NULL
;

371 
p_Vid
->
≥ndög_ouçut
 = 
NULL
;

372 
p_Vid
->
≥ndög_ouçut_°©e
 = 
FRAME
;

373 
p_Vid
->
ªcovîy_Êag
 = 0;

376 #i‡(
ENABLE_OUTPUT_TONEMAPPING
)

377 
	`öô_t⁄e_m≠pög_£i
(
p_Vid
->
£iT⁄eM≠pög
);

380 #i‡(
MVC_EXTENSION_ENABLE
)

381 
p_Vid
->
œ°_pic_width_ö_mbs_möus1
 = 0;

382 
p_Vid
->
œ°_pic_height_ö_m≠_unôs_möus1
 = 0;

383 
p_Vid
->
œ°_max_dec_‰ame_buf„rög
 = 0;

386 
p_Vid
->
√w‰ame
 = 0;

387 
p_Vid
->
¥evious_‰ame_num
 = 0;

389 
p_Vid
->
iLumaPadX
 = 
MCBUF_LUMA_PAD_X
;

390 
p_Vid
->
iLumaPadY
 = 
MCBUF_LUMA_PAD_Y
;

391 
p_Vid
->
iChromaPadX
 = 
MCBUF_CHROMA_PAD_X
;

392 
p_Vid
->
iChromaPadY
 = 
MCBUF_CHROMA_PAD_Y
;

394 
p_Vid
->
iPo°Pro˚ss
 = 0;

395 
p_Vid
->
bDeblockE«bÀ
 = 0x3;

396 
p_Vid
->
œ°_dec_võw_id
 = -1;

397 
p_Vid
->
œ°_dec_œyî_id
 = -1;

399 #i‡
ENABLE_DEC_STATS


400 i‡((
p_Vid
->
dec_°©s
 = (
DecSètP¨amëîs
 *Ë
	`mÆloc
 ( (DecSètP¨amëîs)))=
NULL
)

401 
	`no_mem_exô
 ("init:Ö_Vid->dec_stats");

402 
	`öô_dec_°©s
(
p_Vid
->
dec_°©s
);

404 
	}
}

412 
	$öô_‰ext
(
VideoP¨amëîs
 *
p_Vid
)

415 
p_Vid
->
bôdïth_luma_qp_sˇÀ
 = 6 * (p_Vid->
bôdïth_luma
 - 8);

417 if(
p_Vid
->
bôdïth_luma
 >Ö_Vid->
bôdïth_chroma
 ||Ö_Vid->
a˘ive_•s
->
chroma_f‹m©_idc
 =
YUV400
)

418 
p_Vid
->
pic_unô_bôsize_⁄_disk
 = (p_Vid->
bôdïth_luma
 > 8)? 16:8;

420 
p_Vid
->
pic_unô_bôsize_⁄_disk
 = (p_Vid->
bôdïth_chroma
 > 8)? 16:8;

421 
p_Vid
->
dc_¥ed_vÆue_comp
[0] = 1<<’_Vid->
bôdïth_luma
 - 1);

422 
p_Vid
->
max_≥l_vÆue_comp
[0] = (1<<p_Vid->
bôdïth_luma
) - 1;

423 
p_Vid
->
mb_size
[0][0] =Ö_Vid->mb_size[0][1] = 
MB_BLOCK_SIZE
;

425 i‡(
p_Vid
->
a˘ive_•s
->
chroma_f‹m©_idc
 !
YUV400
)

428 
p_Vid
->
bôdïth_chroma_qp_sˇÀ
 = 6 * (p_Vid->
bôdïth_chroma
 - 8);

429 
p_Vid
->
dc_¥ed_vÆue_comp
[1] = (1 << (p_Vid->
bôdïth_chroma
 - 1));

430 
p_Vid
->
dc_¥ed_vÆue_comp
[2] =Ö_Vid->dc_pred_value_comp[1];

431 
p_Vid
->
max_≥l_vÆue_comp
[1] = (1 <<Ö_Vid->
bôdïth_chroma
) - 1;

432 
p_Vid
->
max_≥l_vÆue_comp
[2] = (1 <<Ö_Vid->
bôdïth_chroma
) - 1;

433 
p_Vid
->
num_blk8x8_uv
 = (1 <<Ö_Vid->
a˘ive_•s
->
chroma_f‹m©_idc
) & (~(0x1));

434 
p_Vid
->
num_uv_blocks
 = (p_Vid->
num_blk8x8_uv
 >> 1);

435 
p_Vid
->
num_cdc_c€ff
 = (p_Vid->
num_blk8x8_uv
 << 1);

436 
p_Vid
->
mb_size
[1][0] =Ö_Vid->mb_size[2][0] =Ö_Vid->
mb_¸_size_x
 = (p_Vid->
a˘ive_•s
->
chroma_f‹m©_idc
==
YUV420
 ||Ö_Vid->a˘ive_•s->chroma_f‹m©_idc==
YUV422
)? 8 : 16;

437 
p_Vid
->
mb_size
[1][1] =Ö_Vid->mb_size[2][1] =Ö_Vid->
mb_¸_size_y
 = (p_Vid->
a˘ive_•s
->
chroma_f‹m©_idc
==
YUV444
 ||Ö_Vid->a˘ive_•s->chroma_f‹m©_idc==
YUV422
)? 16 : 8;

439 
p_Vid
->
sub≥l_x
 =Ö_Vid->
mb_¸_size_x
 == 8 ? 7 : 3;

440 
p_Vid
->
sub≥l_y
 =Ö_Vid->
mb_¸_size_y
 == 8 ? 7 : 3;

441 
p_Vid
->
shi·≥l_x
 =Ö_Vid->
mb_¸_size_x
 == 8 ? 3 : 2;

442 
p_Vid
->
shi·≥l_y
 =Ö_Vid->
mb_¸_size_y
 == 8 ? 3 : 2;

443 
p_Vid
->
tŸÆ_sˇÀ
 =Ö_Vid->
shi·≥l_x
 +Ö_Vid->
shi·≥l_y
;

447 
p_Vid
->
bôdïth_chroma_qp_sˇÀ
 = 0;

448 
p_Vid
->
max_≥l_vÆue_comp
[1] = 0;

449 
p_Vid
->
max_≥l_vÆue_comp
[2] = 0;

450 
p_Vid
->
num_blk8x8_uv
 = 0;

451 
p_Vid
->
num_uv_blocks
 = 0;

452 
p_Vid
->
num_cdc_c€ff
 = 0;

453 
p_Vid
->
mb_size
[1][0] =Ö_Vid->mb_size[2][0] =Ö_Vid->
mb_¸_size_x
 = 0;

454 
p_Vid
->
mb_size
[1][1] =Ö_Vid->mb_size[2][1] =Ö_Vid->
mb_¸_size_y
 = 0;

455 
p_Vid
->
sub≥l_x
 = 0;

456 
p_Vid
->
sub≥l_y
 = 0;

457 
p_Vid
->
shi·≥l_x
 = 0;

458 
p_Vid
->
shi·≥l_y
 = 0;

459 
p_Vid
->
tŸÆ_sˇÀ
 = 0;

462 
p_Vid
->
mb_¸_size
 =Ö_Vid->
mb_¸_size_x
 *Ö_Vid->
mb_¸_size_y
;

463 
p_Vid
->
mb_size_blk
[0][0] =Ö_Vid->mb_size_blk[0][1] =Ö_Vid->
mb_size
[0][0] >> 2;

464 
p_Vid
->
mb_size_blk
[1][0] =Ö_Vid->mb_size_blk[2][0] =Ö_Vid->
mb_size
[1][0] >> 2;

465 
p_Vid
->
mb_size_blk
[1][1] =Ö_Vid->mb_size_blk[2][1] =Ö_Vid->
mb_size
[1][1] >> 2;

467 
p_Vid
->
mb_size_shi·
[0][0] =Ö_Vid->mb_size_shi·[0][1] = 
	`CeûLog2_sf
 (p_Vid->
mb_size
[0][0]);

468 
p_Vid
->
mb_size_shi·
[1][0] =Ö_Vid->mb_size_shi·[2][0] = 
	`CeûLog2_sf
 (p_Vid->
mb_size
[1][0]);

469 
p_Vid
->
mb_size_shi·
[1][1] =Ö_Vid->mb_size_shi·[2][1] = 
	`CeûLog2_sf
 (p_Vid->
mb_size
[1][1]);

470 
	}
}

486 
	$Rï‹t
(
VideoP¨amëîs
 *
p_Vid
)

488 c⁄° 
yuv_f‹m©s
[4][4]= { {"400"}, {"420"}, {"422"}, {"444"} };

489 
pic_∑ømëî_£t_rb•_t
 *
a˘ive_µs
 = 
p_Vid
->active_pps;

490 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

491 
SNRP¨amëîs
 *
¢r
 = 
p_Vid
->snr;

492 
	#OUTSTRING_SIZE
 255

	)

493 
°rög
[
OUTSTRING_SIZE
];

494 
FILE
 *
p_log
;

496 #i‚de‡
WIN32


497 
time_t
 
now
;

498 
tm
 *
l_time
;

500 
timebuf
[128];

504 
p_Vid
->
tŸ_time
 = 
	`timí‹m
(p_Vid->tot_time);

506 i‡(
p_I≈
->
sûít
 =
FALSE
)

508 
	`Ârötf
(
°dout
,"-------------------- Average SNRáll frames ------------------------------\n");

509 
	`Ârötf
(
°dout
," SNR Y(dBË : %5.2f\n",
¢r
->
¢ø
[0]);

510 
	`Ârötf
(
°dout
," SNR U(dBË : %5.2f\n",
¢r
->
¢ø
[1]);

511 
	`Ârötf
(
°dout
," SNR V(dBË : %5.2f\n",
¢r
->
¢ø
[2]);

512 
	`Ârötf
(
°dout
," TŸÆ decodögÅimê: %.3‡£¯(%.3‡Âs)[%d frm/%" 
FORMAT_OFF_T
 " ms]\n",
p_Vid
->
tŸ_time
*0.001,(
¢r
->
‰ame_˘r
 ) * 1000.0 /Ö_Vid->tot_time, snr->frame_ctr,Ö_Vid->tot_time);

513 
	`Ârötf
(
°dout
,"--------------------------------------------------------------------------\n");

514 
	`Ârötf
(
°dout
," Exô JM %†decodî, vî %†",
JM
, 
VERSION
);

515 
	`Ârötf
(
°dout
,"\n");

519 
	`Ârötf
(
°dout
,"\n----------------------- Decoding Completed -------------------------------\n");

520 
	`Ârötf
(
°dout
," TŸÆ decodögÅimê: %.3‡£¯(%.3‡Âs)[%d frm/%" 
FORMAT_OFF_T
 " ms]\n",
p_Vid
->
tŸ_time
*0.001, (
¢r
->
‰ame_˘r
) * 1000.0 /Ö_Vid->tot_time, snr->frame_ctr,Ö_Vid->tot_time);

521 
	`Ârötf
(
°dout
,"--------------------------------------------------------------------------\n");

522 
	`Ârötf
(
°dout
," Exô JM %†decodî, vî %†",
JM
, 
VERSION
);

523 
	`Ârötf
(
°dout
,"\n");

527 
	`Ârötf
(
°dout
," Ouçuà°©u†fûê : %†\n",
LOGFILE
);

528 
	`¢¥ötf
(
°rög
, 
OUTSTRING_SIZE
, "%s", 
LOGFILE
);

530 i‡((
p_log
=
	`f›í
(
°rög
,"r"))==0)

532 i‡((
p_log
=
	`f›í
(
°rög
,"a"))==0)

534 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Eº‹ o≥¿fûê%†f‹áµídög",
°rög
);

535 
	`îr‹
(
îr‹ãxt
, 500);

539 
	`Ârötf
(
p_log
," -------------------------------------------------------------------------------------------------------------------\n");

540 
	`Ârötf
(
p_log
,"| Decoder statistics. This file is made firstÅime,ÜaterÑunsáreáppended |\n");

541 
	`Ârötf
(
p_log
," ------------------------------------------------------------------------------------------------------------------- \n");

542 
	`Ârötf
(
p_log
,"| ver | Date | Time | Sequence |#Img| Format | YUV |Coding|SNRY 1|SNRU 1|SNRV 1|SNRY N|SNRU N|SNRV N|\n");

543 
	`Ârötf
(
p_log
," -------------------------------------------------------------------------------------------------------------------\n");

548 
	`f˛o£
(
p_log
);

549 
p_log
=
	`f›í
(
°rög
,"a");

552 
	`Ârötf
(
p_log
,"|%s/%-4s", 
VERSION
, 
EXT_VERSION
);

554 #ifde‡
WIN32


555 
	`_°rd©e
–
timebuf
 );

556 
	`Ârötf
(
p_log
,"| %1.5†|",
timebuf
 );

558 
	`_°πime
–
timebuf
);

559 
	`Ârötf
(
p_log
," % 1.5†|",
timebuf
);

561 
now
 = 
	`time
 ((
time_t
 *Ë
NULL
);

562 
	`time
 (&
now
);

563 
l_time
 = 
	`loˇ…ime
 (&
now
);

564 
	`°r·ime
 (
°rög
,  såög, "%d-%b-%Y", 
l_time
);

565 
	`Ârötf
(
p_log
,"| %1.5†|",
°rög
 );

567 
	`°r·ime
 (
°rög
,  såög, "%H:%M:%S", 
l_time
);

568 
	`Ârötf
(
p_log
,"| %1.5†|",
°rög
 );

571 
	`Ârötf
(
p_log
,"%20.20s|",
p_I≈
->
öfûe
);

573 
	`Ârötf
(
p_log
,"%3d |",
p_Vid
->
numbî
);

574 
	`Ârötf
(
p_log
,"%4dx%-4d|", 
p_Vid
->
width
,Ö_Vid->
height
);

575 
	`Ârötf
(
p_log
," %†|", &(
yuv_f‹m©s
[
p_Vid
->
yuv_f‹m©
][0]));

577 i‡(
a˘ive_µs
)

579 i‡(
a˘ive_µs
->
íå›y_codög_mode_Êag
 =(
Boﬁón
Ë
CAVLC
)

580 
	`Ârötf
(
p_log
," CAVLC|");

582 
	`Ârötf
(
p_log
," CABAC|");

585 
	`Ârötf
(
p_log
,"%6.3f|",
¢r
->
¢r1
[0]);

586 
	`Ârötf
(
p_log
,"%6.3f|",
¢r
->
¢r1
[1]);

587 
	`Ârötf
(
p_log
,"%6.3f|",
¢r
->
¢r1
[2]);

588 
	`Ârötf
(
p_log
,"%6.3f|",
¢r
->
¢ø
[0]);

589 
	`Ârötf
(
p_log
,"%6.3f|",
¢r
->
¢ø
[1]);

590 
	`Ârötf
(
p_log
,"%6.3f|",
¢r
->
¢ø
[2]);

591 
	`Ârötf
(
p_log
,"\n");

592 
	`f˛o£
(
p_log
);

594 
	`¢¥ötf
(
°rög
, 
OUTSTRING_SIZE
,"%s", 
DATADECFILE
);

595 
p_log
=
	`f›í
(
°rög
,"a");

597 if(
p_Vid
->
B‰ame_˘r
 != 0)

599 
	`Ârötf
(
p_log
, "%3d %2d %2d %2.2f %2.2f %2.2f %5d "

602 
p_Vid
->
numbî
, 0,Ö_Vid->
µSli˚Li°
[0]->
qp
,

603 
¢r
->
¢r1
[0],

604 
¢r
->
¢r1
[1],

605 
¢r
->
¢r1
[2],

611 
¢r
->
¢ø
[0],

612 
¢r
->
¢ø
[1],

613 
¢r
->
¢ø
[2],

615 ()0.001*
p_Vid
->
tŸ_time
/’_Vid->
numbî
 +Ö_Vid->
B‰ame_˘r
 - 1));

619 
	`Ârötf
(
p_log
, "%3d %2d %2d %2.2f %2.2f %2.2f %5d "

622 
p_Vid
->
numbî
, 0,Ö_Vid->
µSli˚Li°
[0]?Ö_Vid->µSli˚Li°[0]->
qp
: 0,

623 
¢r
->
¢r1
[0],

624 
¢r
->
¢r1
[1],

625 
¢r
->
¢r1
[2],

631 
¢r
->
¢ø
[0],

632 
¢r
->
¢ø
[1],

633 
¢r
->
¢ø
[2],

635 
p_Vid
->
numbî
 ? (()0.001*p_Vid->
tŸ_time
/p_Vid->number) : 0.0);

637 
	`f˛o£
(
p_log
);

638 
	}
}

654 
D©aP¨tôi⁄
 *
	$AŒocP¨tôi⁄
(
n
)

656 
D©aP¨tôi⁄
 *
∑πAº
, *
d©aP¨t
;

657 
i
;

659 
∑πAº
 = (
D©aP¨tôi⁄
 *Ë
	`ˇŒoc
(
n
, (DataPartition));

660 i‡(
∑πAº
 =
NULL
)

662 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "AllocPartition: Memoryállocation for Data Partition failed");

663 
	`îr‹
(
îr‹ãxt
, 100);

666 
i
 = 0; i < 
n
; ++i)

668 
d©aP¨t
 = &(
∑πAº
[
i
]);

669 
d©aP¨t
->
bô°ªam
 = (
Bô°ªam
 *Ë
	`ˇŒoc
(1, (Bitstream));

670 i‡(
d©aP¨t
->
bô°ªam
 =
NULL
)

672 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "AllocPartition: Memoryállocation for Bitstream failed");

673 
	`îr‹
(
îr‹ãxt
, 100);

675 
d©aP¨t
->
bô°ªam
->
°ªamBuf„r
 = (
byã
 *Ë
	`ˇŒoc
(
MAX_CODED_FRAME_SIZE
, (byte));

676 i‡(
d©aP¨t
->
bô°ªam
->
°ªamBuf„r
 =
NULL
)

678 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "AllocPartition: Memoryállocation for streamBuffer failed");

679 
	`îr‹
(
îr‹ãxt
, 100);

682  
∑πAº
;

683 
	}
}

703 
	$FªeP¨tôi⁄
 (
D©aP¨tôi⁄
 *
dp
, 
n
)

705 
i
;

707 
	`as£π
 (
dp
 !
NULL
);

708 
	`as£π
 (
dp
->
bô°ªam
 !
NULL
);

709 
	`as£π
 (
dp
->
bô°ªam
->
°ªamBuf„r
 !
NULL
);

710 
i
=0; i<
n
; ++i)

712 
	`‰ì
 (
dp
[
i
].
bô°ªam
->
°ªamBuf„r
);

713 
	`‰ì
 (
dp
[
i
].
bô°ªam
);

715 
	`‰ì
 (
dp
);

716 
	}
}

729 
Sli˚
 *
	$mÆloc_¶i˚
(
I≈utP¨amëîs
 *
p_I≈
, 
VideoP¨amëîs
 *
p_Vid
)

731 
i
, 
j
, 
mem‹y_size
 = 0;

732 
Sli˚
 *
cuºSli˚
;

734 
cuºSli˚
 = (
Sli˚
 *Ë
	`ˇŒoc
(1, (Slice));

735 i‡–
cuºSli˚
 =
NULL
)

737 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Mem‹yáŒoˇti⁄ f‹ Sli˚ d©a°ru˘ i¿NAL-modê%d faûed", 
p_I≈
->
FûeF‹m©
);

738 
	`îr‹
(
îr‹ãxt
,100);

742 
cuºSli˚
->
mŸ_˘x
 = 
	`¸óã_c⁄ãxts_MŸi⁄Info
();

743 
cuºSli˚
->
ãx_˘x
 = 
	`¸óã_c⁄ãxts_TextuªInfo
();

745 
cuºSli˚
->
max_∑π_ƒ
 = 3;

746 
cuºSli˚
->
∑πAº
 = 
	`AŒocP¨tôi⁄
(cuºSli˚->
max_∑π_ƒ
);

748 
mem‹y_size
 +
	`gë_mem2Dwp
 (&(
cuºSli˚
->
wp_∑øms
), 2, 
MAX_REFERENCE_PICTURES
);

750 
mem‹y_size
 +
	`gë_mem3Döt
(&(
cuºSli˚
->
wp_weight
), 2, 
MAX_REFERENCE_PICTURES
, 3);

751 
mem‹y_size
 +
	`gë_mem3Döt
(&(
cuºSli˚
->
wp_off£t
), 6, 
MAX_REFERENCE_PICTURES
, 3);

752 
mem‹y_size
 +
	`gë_mem4Döt
(&(
cuºSli˚
->
wbp_weight
), 6, 
MAX_REFERENCE_PICTURES
, MAX_REFERENCE_PICTURES, 3);

754 
mem‹y_size
 +
	`gë_mem3D≥l
(&(
cuºSli˚
->
mb_¥ed
), 
MAX_PLANE
, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE);

755 
mem‹y_size
 +
	`gë_mem3D≥l
(&(
cuºSli˚
->
mb_ªc
 ), 
MAX_PLANE
, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE);

756 
mem‹y_size
 +
	`gë_mem3Döt
(&(
cuºSli˚
->
mb_ºes
), 
MAX_PLANE
, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE);

757 
mem‹y_size
 +
	`gë_mem3Döt
(&(
cuºSli˚
->
cof
 ), 
MAX_PLANE
, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE);

759 
	`Æloˇã_¥ed_mem
(
cuºSli˚
);

760 #i‡(
MVC_EXTENSION_ENABLE
)

761 
cuºSli˚
->
võw_id
 = 
MVC_INIT_VIEW_ID
;

762 
cuºSli˚
->
öãr_võw_Êag
 = 0;

763 
cuºSli˚
->
™ch‹_pic_Êag
 = 0;

766 
i
=0;i<17;++i)

768 
cuºSli˚
->
ªf_Êag
[
i
] = 1;

770 
i
 = 0; i < 6; i++)

772 
cuºSli˚
->
li°X
[
i
] = 
	`ˇŒoc
(
MAX_LIST_SIZE
,  (
St‹abÀPi˘uª
*));

773 i‡(
NULL
==
cuºSli˚
->
li°X
[
i
])

774 
	`no_mem_exô
("malloc_slice: currSlice->listX[i]");

776 
j
 = 0; j < 6; j++)

778 
i
 = 0; i < 
MAX_LIST_SIZE
; i++)

780 
cuºSli˚
->
li°X
[
j
][
i
] = 
NULL
;

782 
cuºSli˚
->
li°Xsize
[
j
]=0;

785  
cuºSli˚
;

786 
	}
}

799 
	$‰ì_¶i˚
(
Sli˚
 *
cuºSli˚
)

801 
i
;

803 i‡(
cuºSli˚
->
¶i˚_ty≥
 !
I_SLICE
 && cuºSli˚->¶i˚_ty≥ !
SI_SLICE
)

804 
	`‰ì_ªf_pic_li°_ª‹dîög_buf„r
(
cuºSli˚
);

805 
	`‰ì_¥ed_mem
(
cuºSli˚
);

806 
	`‰ì_mem3Döt
(
cuºSli˚
->
cof
 );

807 
	`‰ì_mem3Döt
(
cuºSli˚
->
mb_ºes
);

808 
	`‰ì_mem3D≥l
(
cuºSli˚
->
mb_ªc
 );

809 
	`‰ì_mem3D≥l
(
cuºSli˚
->
mb_¥ed
);

811 
	`‰ì_mem2Dwp
 (
cuºSli˚
->
wp_∑øms
 );

812 
	`‰ì_mem3Döt
(
cuºSli˚
->
wp_weight
 );

813 
	`‰ì_mem3Döt
(
cuºSli˚
->
wp_off£t
 );

814 
	`‰ì_mem4Döt
(
cuºSli˚
->
wbp_weight
);

816 
	`FªeP¨tôi⁄
 (
cuºSli˚
->
∑πAº
, 3);

821 
	`dñëe_c⁄ãxts_MŸi⁄Info
 (
cuºSli˚
->
mŸ_˘x
);

822 
	`dñëe_c⁄ãxts_TextuªInfo
(
cuºSli˚
->
ãx_˘x
);

825 
i
=0; i<6; i++)

827 i‡(
cuºSli˚
->
li°X
[
i
])

829 
	`‰ì
 (
cuºSli˚
->
li°X
[
i
]);

830 
cuºSli˚
->
li°X
[
i
] = 
NULL
;

833 
cuºSli˚
->
dec_ªf_pic_m¨kög_buf„r
)

835 
DecRefPicM¨kög_t
 *
tmp_dΩm
=
cuºSli˚
->
dec_ªf_pic_m¨kög_buf„r
;

836 
cuºSli˚
->
dec_ªf_pic_m¨kög_buf„r
=
tmp_dΩm
->
Next
;

837 
	`‰ì
 (
tmp_dΩm
);

840 
	`‰ì
(
cuºSli˚
);

841 
cuºSli˚
 = 
NULL
;

842 
	}
}

858 
	$öô_globÆ_buf„rs
(
VideoP¨amëîs
 *
p_Vid
, 
œyî_id
)

860 
mem‹y_size
=0;

861 
i
;

862 
CodögP¨amëîs
 *
˝s
 = 
p_Vid
->
p_EncodeP¨
[
œyî_id
];

863 
BlockPos
* 
PicPos
;

865 i‡(
p_Vid
->
globÆ_öô_d⁄e
[
œyî_id
])

867 
	`‰ì_œyî_buf„rs
(
p_Vid
, 
œyî_id
);

871 
mem‹y_size
 +
	`gë_mem2D≥l
(&
˝s
->
imgY_ªf
, cps->
height
, cps->
width
);

872 i‡(
˝s
->
yuv_f‹m©
 !
YUV400
)

874 
mem‹y_size
 +
	`gë_mem3D≥l
(&
˝s
->
imgUV_ªf
, 2, cps->
height_¸
, cps->
width_¸
);

877 
˝s
->
imgUV_ªf
 = 
NULL
;

880 if–(
˝s
->
£∑øã_cﬁour_∂™e_Êag
 != 0) )

882  
i
=0; i<
MAX_PLANE
; ++i )

884 if(((
˝s
->
mb_d©a_JV
[
i
]Ë(
Ma¸oblock
 *Ë
	`ˇŒoc
(˝s->
FømeSizeInMbs
, (Ma¸oblock))Ë=
NULL
)

885 
	`no_mem_exô
("init_global_buffers: cps->mb_data_JV");

887 
˝s
->
mb_d©a
 = 
NULL
;

891 if(((
˝s
->
mb_d©a
Ë(
Ma¸oblock
 *Ë
	`ˇŒoc
(˝s->
FømeSizeInMbs
, (Ma¸oblock))Ë=
NULL
)

892 
	`no_mem_exô
("init_global_buffers: cps->mb_data");

894 if–(
˝s
->
£∑øã_cﬁour_∂™e_Êag
 != 0) )

896  
i
=0; i<
MAX_PLANE
; ++i )

898 if(((
˝s
->
öåa_block_JV
[
i
]Ë(*Ë
	`ˇŒoc
(˝s->
FømeSizeInMbs
, ())Ë=
NULL
)

899 
	`no_mem_exô
("init_global_buffers: cps->intra_block_JV");

901 
˝s
->
öåa_block
 = 
NULL
;

905 if(((
˝s
->
öåa_block
Ë(*Ë
	`ˇŒoc
(˝s->
FømeSizeInMbs
, ())Ë=
NULL
)

906 
	`no_mem_exô
("init_global_buffers: cps->intra_block");

911 if(((
˝s
->
PicPos
Ë(
BlockPos
*Ë
	`ˇŒoc
(˝s->
FømeSizeInMbs
 + 1, (BlockPos))Ë=
NULL
)

912 
	`no_mem_exô
("init_global_buffers: PicPos");

914 
PicPos
 = 
˝s
->PicPos;

915 
i
 = 0; i < (Ë
˝s
->
FømeSizeInMbs
 + 1;++i)

917 
PicPos
[
i
].
x
 = (Ë(ò% 
˝s
->
PicWidthInMbs
);

918 
PicPos
[
i
].
y
 = (Ë(ò/ 
˝s
->
PicWidthInMbs
);

921 if–(
˝s
->
£∑øã_cﬁour_∂™e_Êag
 != 0) )

923  
i
=0; i<
MAX_PLANE
; ++i )

925 
	`gë_mem2D
(&(
˝s
->
ùªdmode_JV
[
i
]), 4*˝s->
FømeHeightInMbs
, 4*˝s->
PicWidthInMbs
);

927 
˝s
->
ùªdmode
 = 
NULL
;

930 
mem‹y_size
 +
	`gë_mem2D
(&(
˝s
->
ùªdmode
), 4*˝s->
FømeHeightInMbs
, 4*˝s->
PicWidthInMbs
);

933 
mem‹y_size
 +
	`gë_mem4D
(&(
˝s
->
nz_c€ff
), cps->
FømeSizeInMbs
, 3, 
BLOCK_SIZE
, BLOCK_SIZE);

934 if–(
˝s
->
£∑øã_cﬁour_∂™e_Êag
 != 0) )

936  
i
=0; i<
MAX_PLANE
; ++i )

938 
	`gë_mem2Döt
(&(
˝s
->
siblock_JV
[
i
]), cps->
FømeHeightInMbs
, cps->
PicWidthInMbs
);

939 if(
˝s
->
siblock_JV
[
i
]=
NULL
)

940 
	`no_mem_exô
("init_global_buffers:Ö_Vid->siblock_JV");

942 
˝s
->
siblock
 = 
NULL
;

946 
mem‹y_size
 +
	`gë_mem2Döt
(&(
˝s
->
siblock
), cps->
FømeHeightInMbs
, cps->
PicWidthInMbs
);

948 
	`öô_qp_¥o˚ss
(
˝s
);

949 
˝s
->
ﬁdFømeSizeInMbs
 = cps->
FømeSizeInMbs
;

951 if(
œyî_id
 == 0 )

952 
	`öô_ouçut
(
˝s
, ((˝s->
pic_unô_bôsize_⁄_disk
+7) >> 3));

954 
˝s
->
img2buf
 = 
p_Vid
->
p_EncodeP¨
[0]->img2buf;

955 
p_Vid
->
globÆ_öô_d⁄e
[
œyî_id
] = 1;

957  (
mem‹y_size
);

958 
	}
}

975 
	$‰ì_œyî_buf„rs
(
VideoP¨amëîs
 *
p_Vid
, 
œyî_id
)

977 
CodögP¨amëîs
 *
˝s
 = 
p_Vid
->
p_EncodeP¨
[
œyî_id
];

979 if(!
p_Vid
->
globÆ_öô_d⁄e
[
œyî_id
])

982 i‡(
˝s
->
imgY_ªf
)

984 
	`‰ì_mem2D≥l
 (
˝s
->
imgY_ªf
);

985 
˝s
->
imgY_ªf
 = 
NULL
;

987 i‡(
˝s
->
imgUV_ªf
)

989 
	`‰ì_mem3D≥l
 (
˝s
->
imgUV_ªf
);

990 
˝s
->
imgUV_ªf
 = 
NULL
;

993 i‡(
˝s
->
nz_c€ff
)

995 
	`‰ì_mem4D
(
˝s
->
nz_c€ff
);

996 
˝s
->
nz_c€ff
 = 
NULL
;

1000 if–(
˝s
->
£∑øã_cﬁour_∂™e_Êag
 != 0) )

1002 
i
;

1003 
i
=0; i<
MAX_PLANE
; i++)

1005 
	`‰ì
(
˝s
->
mb_d©a_JV
[
i
]);

1006 
˝s
->
mb_d©a_JV
[
i
] = 
NULL
;

1007 
	`‰ì_mem2Döt
(
˝s
->
siblock_JV
[
i
]);

1008 
˝s
->
siblock_JV
[
i
] = 
NULL
;

1009 
	`‰ì_mem2D
(
˝s
->
ùªdmode_JV
[
i
]);

1010 
˝s
->
ùªdmode_JV
[
i
] = 
NULL
;

1011 
	`‰ì
 (
˝s
->
öåa_block_JV
[
i
]);

1012 
˝s
->
öåa_block_JV
[
i
] = 
NULL
;

1017 i‡(
˝s
->
mb_d©a
 !
NULL
)

1019 
	`‰ì
(
˝s
->
mb_d©a
);

1020 
˝s
->
mb_d©a
 = 
NULL
;

1022 if(
˝s
->
siblock
)

1024 
	`‰ì_mem2Döt
(
˝s
->
siblock
);

1025 
˝s
->
siblock
 = 
NULL
;

1027 if(
˝s
->
ùªdmode
)

1029 
	`‰ì_mem2D
(
˝s
->
ùªdmode
);

1030 
˝s
->
ùªdmode
 = 
NULL
;

1032 if(
˝s
->
öåa_block
)

1034 
	`‰ì
 (
˝s
->
öåa_block
);

1035 
˝s
->
öåa_block
 = 
NULL
;

1038 if(
˝s
->
PicPos
)

1040 
	`‰ì
(
˝s
->
PicPos
);

1041 
˝s
->
PicPos
 = 
NULL
;

1044 
	`‰ì_qp_m©ri˚s
(
˝s
);

1047 
p_Vid
->
globÆ_öô_d⁄e
[
œyî_id
] = 0;

1048 
	}
}

1050 
	$‰ì_globÆ_buf„rs
(
VideoP¨amëîs
 *
p_Vid
)

1052 if(
p_Vid
->
dec_pi˘uª
)

1054 
	`‰ì_°‹abÀ_pi˘uª
(
p_Vid
->
dec_pi˘uª
);

1055 
p_Vid
->
dec_pi˘uª
 = 
NULL
;

1057 #i‡
MVC_EXTENSION_ENABLE


1058 if(
p_Vid
->
a˘ive_sub£t_•s
 &&Ö_Vid->a˘ive_sub£t_•s->
•s
.
VÆid
 && (p_Vid->a˘ive_sub£t_•s->•s.
¥ofûe_idc
==
MVC_HIGH
||p_Vid->a˘ive_sub£t_•s->•s.¥ofûe_id¯=
STEREO_HIGH
))

1059 
	`‰ì_img_d©a
–
p_Vid
, &’_Vid->
ãmpD©a3
) );

1061 
	}
}

1063 
	$ªp‹t_°©s_⁄_îr‹
()

1066 
	`exô
 (-1);

1067 
	}
}

1069 
	$CÀ¨DecPicLi°
(
VideoP¨amëîs
 *
p_Vid
)

1071 
DecodedPicLi°
 *
pPic
 = 
p_Vid
->
pDecOuputPic
, *
pPri‹
 = 
NULL
;

1073 
pPic
 && !pPic->
bVÆid
)

1075 
pPri‹
 = 
pPic
;

1076 
pPic
 =ÖPic->
pNext
;

1079 if(
pPic
 && (pPi¯!
p_Vid
->
pDecOuputPic
))

1082 
DecodedPicLi°
 *
pPicTaû
 = 
pPic
;

1083 
pPicTaû
->
pNext
)

1084 
pPicTaû
 =ÖPicTaû->
pNext
;

1086 
pPicTaû
->
pNext
 = 
p_Vid
->
pDecOuputPic
;

1087 
p_Vid
->
pDecOuputPic
 = 
pPic
;

1088 
pPri‹
->
pNext
 = 
NULL
;

1090 
	}
}

1092 
DecodedPicLi°
 *
	$gë_⁄e_avaû_dec_pic_‰om_li°
(
DecodedPicLi°
 *
pDecPicLi°
, 
b3D
, 
võw_id
)

1094 
DecodedPicLi°
 *
pPic
 = 
pDecPicLi°
, *
pPri‹
 = 
NULL
;

1095 if(
b3D
)

1097 
pPic
 && (pPic->
bVÆid
 &(1<<
võw_id
)))

1099 
pPri‹
 = 
pPic
;

1100 
pPic
 =ÖPic->
pNext
;

1105 
pPic
 && (pPic->
bVÆid
))

1107 
pPri‹
 = 
pPic
;

1108 
pPic
 =ÖPic->
pNext
;

1112 if(!
pPic
)

1114 
pPic
 = (
DecodedPicLi°
 *)
	`ˇŒoc
(1, (*pPic));

1115 
pPri‹
->
pNext
 = 
pPic
;

1118  
pPic
;

1119 
	}
}

1126 
	$O≥nDecodî
(
I≈utP¨amëîs
 *
p_I≈
)

1128 
iRë
;

1129 
DecodîP¨ams
 *
pDecodî
;

1131 
iRë
 = 
	`Æloc_decodî
(&
p_Dec
);

1132 if(
iRë
)

1134  (
iRë
|
DEC_ERRMASK
);

1136 
	`öô_time
();

1138 
pDecodî
 = 
p_Dec
;

1140 
	`mem˝y
(
pDecodî
->
p_I≈
,Ö_I≈, (
I≈utP¨amëîs
));

1141 
pDecodî
->
p_Vid
->
c⁄˚Æ_mode
 = 
p_I≈
->conceal_mode;

1142 
pDecodî
->
p_Vid
->
ªf_poc_g≠
 = 
p_I≈
->ref_poc_gap;

1143 
pDecodî
->
p_Vid
->
poc_g≠
 = 
p_I≈
->poc_gap;

1144 #i‡
TRACE


1145 i‡((
pDecodî
->
p_åa˚
 = 
	`f›í
(
TRACEFILE
,"w"))==0)

1147 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Eº‹ o≥¿fûê%s!",
TRACEFILE
);

1153 #i‡(!
MVC_EXTENSION_ENABLE
)

1154 if((
	`°rˇ£cmp
(
p_I≈
->
outfûe
, "\"\"")!=0Ë&& (
	`°æí
(p_Inp->outfile)>0))

1156 i‡((
pDecodî
->
p_Vid
->
p_out
 = 
	`›í
(
p_I≈
->
outfûe
, 
OPENFLAGS_WRITE
, 
OPEN_PERMISSIONS
))==-1)

1158 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Eº‹ o≥¿fûê%†",
p_I≈
->
outfûe
);

1159 
	`îr‹
(
îr‹ãxt
,500);

1163 
pDecodî
->
p_Vid
->
p_out
 = -1;

1166 
i
;

1167 
VideoP¨amëîs
 *
p_Vid
 = 
pDecodî
->p_Vid;

1169 
p_Vid
->
p_out
 = -1;

1170 
i
 = 0; i < 
MAX_VIEW_NUM
; i++)

1172 
p_Vid
->
p_out_mvc
[
i
] = -1;

1175 i‡(
p_I≈
->
DecodeAŒLayîs
 == 1)

1177 
	`O≥nOuçutFûes
(
p_Vid
, 0, 1);

1181 if((
	`°rˇ£cmp
(
p_I≈
->
outfûe
, "\"\"")!=0Ë&& (
	`°æí
(p_Inp->outfile)>0))

1183 if–(
	`°rˇ£cmp
(
p_I≈
->
outfûe
, "\"\"")!=0Ë&& ((
p_Vid
->
p_out_mvc
[0]=
	`›í
’_I≈->outfûe, 
OPENFLAGS_WRITE
, 
OPEN_PERMISSIONS
))==-1) )

1185 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Eº‹ o≥¿fûê%†",
p_I≈
->
outfûe
);

1186 
	`îr‹
(
îr‹ãxt
,500);

1189 
p_Vid
->
p_out
 =Ö_Vid->
p_out_mvc
[0];

1195 if(
	`°æí
(
pDecodî
->
p_I≈
->
ªffûe
)>0 && 
	`°rcmp
(pDecoder->p_Inp->reffile, "\"\""))

1197 i‡((
pDecodî
->
p_Vid
->
p_ªf
 = 
	`›í
’Decodî->
p_I≈
->
ªffûe
, 
OPENFLAGS_READ
))==-1)

1199 
	`Ârötf
(
°dout
," I≈uàª„ªn˚ fûê : %†d€†nŸÉxi° \n",
pDecodî
->
p_I≈
->
ªffûe
);

1200 
	`Ârötf
(
°dout
," SNR valuesáreÇotávailable\n");

1204 
pDecodî
->
p_Vid
->
p_ªf
 = -1;

1206  
pDecodî
->
p_I≈
->
FûeF‹m©
 )

1209 
PAR_OF_ANNEXB
:

1210 
	`mÆloc_™√x_b
(
pDecodî
->
p_Vid
, &pDecodî->p_Vid->
™√x_b
);

1211 
	`›í_™√x_b
(
pDecodî
->
p_I≈
->
öfûe
,ÖDecodî->
p_Vid
->
™√x_b
);

1213 
PAR_OF_RTP
:

1214 
	`O≥nRTPFûe
(
pDecodî
->
p_I≈
->
öfûe
, &pDecodî->
p_Vid
->
BôSåómFûe
);

1221 
	`öô_ﬁd_¶i˚
(
pDecodî
->
p_Vid
->
ﬁd_¶i˚
);

1223 
	`öô
(
pDecodî
->
p_Vid
);

1225 
	`öô_out_buf„r
(
pDecodî
->
p_Vid
);

1227 #i‡(
MVC_EXTENSION_ENABLE
)

1228 
pDecodî
->
p_Vid
->
a˘ive_•s
 = 
NULL
;

1229 
pDecodî
->
p_Vid
->
a˘ive_sub£t_•s
 = 
NULL
;

1230 
	`öô_sub£t_•s_li°
(
pDecodî
->
p_Vid
->
Sub£tSeqP¨Së
, 
MAXSPS
);

1234 #i‡
_FLTDBG_


1235 
pDecodî
->
p_Vid
->
ÂDbg
 = 
	`f›í
("c:/fltdbg.txt", "a");

1236 
	`Ârötf
(
pDecodî
->
p_Vid
->
ÂDbg
, "\ndecoder is opened.\n");

1239  
DEC_OPEN_NOERR
;

1240 
	}
}

1249 
	$DecodeO√Føme
(
DecodedPicLi°
 **
µDecPicLi°
)

1251 
iRë
;

1252 
DecodîP¨ams
 *
pDecodî
 = 
p_Dec
;

1253 
	`CÀ¨DecPicLi°
(
pDecodî
->
p_Vid
);

1254 
iRë
 = 
	`decode_⁄e_‰ame
(
pDecodî
);

1255 if(
iRë
 =
SOP
)

1257 
iRë
 = 
DEC_SUCCEED
;

1259 if(
iRë
 =
EOS
)

1261 
iRë
 = 
DEC_EOS
;

1265 
iRë
 |
DEC_ERRMASK
;

1268 *
µDecPicLi°
 = 
pDecodî
->
p_Vid
->
pDecOuputPic
;

1269  
iRë
;

1270 
	}
}

1272 
	$FöôDecodî
(
DecodedPicLi°
 **
µDecPicLi°
)

1274 
DecodîP¨ams
 *
pDecodî
 = 
p_Dec
;

1275 if(!
pDecodî
)

1276  
DEC_GEN_NOERR
;

1277 
	`CÀ¨DecPicLi°
(
pDecodî
->
p_Vid
);

1278 #i‡(
MVC_EXTENSION_ENABLE
)

1279 
	`Êush_dpb
(
pDecodî
->
p_Vid
->
p_Dpb_œyî
[0]);

1280 
	`Êush_dpb
(
pDecodî
->
p_Vid
->
p_Dpb_œyî
[1]);

1282 
	`Êush_dpb
(
pDecodî
->
p_Vid
->
p_Dpb_œyî
[0]);

1284 #i‡(
PAIR_FIELDS_IN_OUTPUT
)

1285 
	`Êush_≥ndög_ouçut
(
pDecodî
->
p_Vid
,ÖDecodî->p_Vid->
p_out
);

1287 i‡(
pDecodî
->
p_I≈
->
FûeF‹m©
 =
PAR_OF_ANNEXB
)

1289 
	`ª£t_™√x_b
(
pDecodî
->
p_Vid
->
™√x_b
);

1291 
pDecodî
->
p_Vid
->
√w‰ame
 = 0;

1292 
pDecodî
->
p_Vid
->
¥evious_‰ame_num
 = 0;

1293 *
µDecPicLi°
 = 
pDecodî
->
p_Vid
->
pDecOuputPic
;

1294  
DEC_GEN_NOERR
;

1295 
	}
}

1297 
	$Clo£Decodî
()

1299 
i
;

1301 
DecodîP¨ams
 *
pDecodî
 = 
p_Dec
;

1302 if(!
pDecodî
)

1303  
DEC_CLOSE_NOERR
;

1305 
	`Rï‹t
 (
pDecodî
->
p_Vid
);

1306 
	`FmoFöô
(
pDecodî
->
p_Vid
);

1307 
	`‰ì_œyî_buf„rs
(
pDecodî
->
p_Vid
, 0);

1308 
	`‰ì_œyî_buf„rs
(
pDecodî
->
p_Vid
, 1);

1309 
	`‰ì_globÆ_buf„rs
(
pDecodî
->
p_Vid
);

1310  
pDecodî
->
p_I≈
->
FûeF‹m©
 )

1313 
PAR_OF_ANNEXB
:

1314 
	`˛o£_™√x_b
(
pDecodî
->
p_Vid
->
™√x_b
);

1316 
PAR_OF_RTP
:

1317 
	`Clo£RTPFûe
(&
pDecodî
->
p_Vid
->
BôSåómFûe
);

1321 #i‡(
MVC_EXTENSION_ENABLE
)

1322 
i
=0;i<
MAX_VIEW_NUM
;i++)

1324 i‡(
pDecodî
->
p_Vid
->
p_out_mvc
[
i
] != -1)

1326 
	`˛o£
(
pDecodî
->
p_Vid
->
p_out_mvc
[
i
]);

1330 if(
pDecodî
->
p_Vid
->
p_out
 >=0)

1331 
	`˛o£
(
pDecodî
->
p_Vid
->
p_out
);

1334 i‡(
pDecodî
->
p_Vid
->
p_ªf
 != -1)

1335 
	`˛o£
(
pDecodî
->
p_Vid
->
p_ªf
);

1337 #i‡
TRACE


1338 
	`f˛o£
(
pDecodî
->
p_åa˚
);

1341 
	`îcClo£
(
pDecodî
->
p_Vid
,ÖDecodî->p_Vid->
îc_îr‹V¨
);

1343 
	`CÀ™UpPPS
(
pDecodî
->
p_Vid
);

1344 #i‡(
MVC_EXTENSION_ENABLE
)

1345 
i
=0; i<
MAXSPS
; i++)

1347 
	`ª£t_sub£t_•s
(
pDecodî
->
p_Vid
->
Sub£tSeqP¨Së
+
i
);

1351 
i
=0; i<
MAX_NUM_DPB_LAYERS
; i++)

1352 
	`‰ì_dpb
(
pDecodî
->
p_Vid
->
p_Dpb_œyî
[
i
]);

1355 
	`unöô_out_buf„r
(
pDecodî
->
p_Vid
);

1356 #i‡
_FLTDBG_


1357 if(
pDecodî
->
p_Vid
->
ÂDbg
)

1359 
	`Ârötf
(
pDecodî
->
p_Vid
->
ÂDbg
, "decoder is closed.\n");

1360 
	`f˛o£
(
pDecodî
->
p_Vid
->
ÂDbg
);

1361 
pDecodî
->
p_Vid
->
ÂDbg
 = 
NULL
;

1365 
	`‰ì_img
 (
pDecodî
->
p_Vid
);

1366 
	`‰ì
 (
pDecodî
->
p_I≈
);

1367 
	`‰ì
(
pDecodî
);

1369 
p_Dec
 = 
NULL
;

1370  
DEC_CLOSE_NOERR
;

1371 
	}
}

1373 #i‡(
MVC_EXTENSION_ENABLE
)

1374 
	$O≥nOuçutFûes
(
VideoP¨amëîs
 *
p_Vid
, 
võw0_id
, 
võw1_id
)

1376 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

1377 
out_VõwFûeName
[2][
FILE_NAME_SIZE
], 
chBuf
[FILE_NAME_SIZE], *
pch
;

1378 i‡((
	`°rˇ£cmp
(
p_I≈
->
outfûe
, "\"\"")!=0Ë&& (
	`°æí
(p_Inp->outfile)>0))

1380 
	`°r˝y
(
chBuf
, 
p_I≈
->
outfûe
);

1381 
pch
 = 
	`°ºchr
(
chBuf
, '.');

1382 if(
pch
)

1383 *
pch
 = '\0';

1384 i‡(
	`°rcmp
("nul", 
chBuf
))

1386 
	`•rötf
(
out_VõwFûeName
[0], "%s_VõwId%04d.yuv", 
chBuf
, 
võw0_id
);

1387 
	`•rötf
(
out_VõwFûeName
[1], "%s_VõwId%04d.yuv", 
chBuf
, 
võw1_id
);

1388 if(
p_Vid
->
p_out_mvc
[0] >= 0)

1390 
	`˛o£
(
p_Vid
->
p_out_mvc
[0]);

1391 
p_Vid
->
p_out_mvc
[0] = -1;

1393 i‡((
p_Vid
->
p_out_mvc
[0]=
	`›í
(
out_VõwFûeName
[0], 
OPENFLAGS_WRITE
, 
OPEN_PERMISSIONS
))==-1)

1395 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Eº‹ o≥¿fûê%†", 
out_VõwFûeName
[0]);

1396 
	`Ârötf
(
°dîr
, "%s\n", 
îr‹ãxt
);

1397 
	`exô
(500);

1400 if(
p_Vid
->
p_out_mvc
[1] >= 0)

1402 
	`˛o£
(
p_Vid
->
p_out_mvc
[1]);

1403 
p_Vid
->
p_out_mvc
[1] = -1;

1405 i‡((
p_Vid
->
p_out_mvc
[1]=
	`›í
(
out_VõwFûeName
[1], 
OPENFLAGS_WRITE
, 
OPEN_PERMISSIONS
))==-1)

1407 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Eº‹ o≥¿fûê%†", 
out_VõwFûeName
[1]);

1408 
	`Ârötf
(
°dîr
, "%s\n", 
îr‹ãxt
);

1409 
	`exô
(500);

1413 
	}
}

1416 
	$£t_globÆ_codög_∑r
(
VideoP¨amëîs
 *
p_Vid
, 
CodögP¨amëîs
 *
˝s
)

1418 
p_Vid
->
bôdïth_chroma
 = 0;

1419 
p_Vid
->
width_¸
 = 0;

1420 
p_Vid
->
height_¸
 = 0;

1421 
p_Vid
->
los¶ess_qµrime_Êag
 = 
˝s
->lossless_qpprime_flag;

1422 
p_Vid
->
max_vmv_r
 = 
˝s
->max_vmv_r;

1425 
p_Vid
->
bôdïth_luma
 = 
˝s
->bitdepth_luma;

1426 
p_Vid
->
bôdïth_sˇÀ
[0] = 
˝s
->bitdepth_scale[0];

1427 
p_Vid
->
bôdïth_chroma
 = 
˝s
->bitdepth_chroma;

1428 
p_Vid
->
bôdïth_sˇÀ
[1] = 
˝s
->bitdepth_scale[1];

1430 
p_Vid
->
max_‰ame_num
 = 
˝s
->max_frame_num;

1431 
p_Vid
->
PicWidthInMbs
 = 
˝s
->PicWidthInMbs;

1432 
p_Vid
->
PicHeightInM≠Unôs
 = 
˝s
->PicHeightInMapUnits;

1433 
p_Vid
->
FømeHeightInMbs
 = 
˝s
->FrameHeightInMbs;

1434 
p_Vid
->
FømeSizeInMbs
 = 
˝s
->FrameSizeInMbs;

1436 
p_Vid
->
yuv_f‹m©
 = 
˝s
->yuv_format;

1437 
p_Vid
->
£∑øã_cﬁour_∂™e_Êag
 = 
˝s
->separate_colour_plane_flag;

1438 
p_Vid
->
ChromaAºayTy≥
 = 
˝s
->ChromaArrayType;

1440 
p_Vid
->
width
 = 
˝s
->width;

1441 
p_Vid
->
height
 = 
˝s
->height;

1442 
p_Vid
->
iLumaPadX
 = 
MCBUF_LUMA_PAD_X
;

1443 
p_Vid
->
iLumaPadY
 = 
MCBUF_LUMA_PAD_Y
;

1444 
p_Vid
->
iChromaPadX
 = 
MCBUF_CHROMA_PAD_X
;

1445 
p_Vid
->
iChromaPadY
 = 
MCBUF_CHROMA_PAD_Y
;

1446 i‡(
p_Vid
->
yuv_f‹m©
 =
YUV420
)

1448 
p_Vid
->
width_¸
 = (p_Vid->
width
 >> 1);

1449 
p_Vid
->
height_¸
 = (p_Vid->
height
 >> 1);

1451 i‡(
p_Vid
->
yuv_f‹m©
 =
YUV422
)

1453 
p_Vid
->
width_¸
 = (p_Vid->
width
 >> 1);

1454 
p_Vid
->
height_¸
 =Ö_Vid->
height
;

1455 
p_Vid
->
iChromaPadY
 = 
MCBUF_CHROMA_PAD_Y
*2;

1457 i‡(
p_Vid
->
yuv_f‹m©
 =
YUV444
)

1460 
p_Vid
->
width_¸
 =Ö_Vid->
width
;

1461 
p_Vid
->
height_¸
 =Ö_Vid->
height
;

1462 
p_Vid
->
iChromaPadX
 =Ö_Vid->
iLumaPadX
;

1463 
p_Vid
->
iChromaPadY
 =Ö_Vid->
iLumaPadY
;

1466 
	`öô_‰ext
(
p_Vid
);

1467 
	}
}

	@ldecod/src/leaky_bucket.c

15 
	~"c⁄åibut‹s.h
"

16 
	~"globÆ.h
"

18 #ifde‡
_LEAKYBUCKET_


38 
	$GëBigDoubÀW‹d
(
FILE
 *
Â
)

40 
dw
;

41 
dw
 = (Ë(
	`fgëc
(
Â
) & 0xFF);

42 
dw
 = ((Ë(
	`fgëc
(
Â
) & 0xFF)) | (dw << 0x08);

43 
dw
 = ((Ë(
	`fgëc
(
Â
) & 0xFF)) | (dw << 0x08);

44 
dw
 = ((Ë(
	`fgëc
(
Â
) & 0xFF)) | (dw << 0x08);

45 (
dw
);

46 
	}
}

69 
	$ˇlc_buf„r
(
I≈utP¨amëîs
 *
p_I≈
)

71 
NumbîLókyBuckës
, *
Rmö
, *
Bmö
, *
Fmö
;

72 
B_öãΩ
, 
F_öãΩ
;

73 
iBuckë
;

74 
dƒ
, 
‰ac1
, 
‰ac2
;

75 
R_decodî
, 
B_decodî
, 
F_decodî
;

76 
FILE
 *
outf
;

78 i‡((
outf
=
	`f›í
(
p_I≈
->
LókyBuckëP¨amFûe
,"rb"))==
NULL
)

80 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Eº‹ o≥¿fûê%†\n",
p_I≈
->
LókyBuckëP¨amFûe
);

81 
	`îr‹
(
îr‹ãxt
,1);

84 
NumbîLókyBuckës
 = 
	`GëBigDoubÀW‹d
(
outf
);

85 
	`¥ötf
(" Numbî Lóky Buckës: %8ld \n\n", 
NumbîLókyBuckës
);

86 
Rmö
 = 
	`ˇŒoc
(
NumbîLókyBuckës
, ());

87 
Bmö
 = 
	`ˇŒoc
(
NumbîLókyBuckës
, ());

88 
Fmö
 = 
	`ˇŒoc
(
NumbîLókyBuckës
, ());

90 
iBuckë
 =0; iBuckë < 
NumbîLókyBuckës
; iBucket++)

92 
Rmö
[
iBuckë
] = 
	`GëBigDoubÀW‹d
(
outf
);

93 
Bmö
[
iBuckë
] = 
	`GëBigDoubÀW‹d
(
outf
);

94 
Fmö
[
iBuckë
] = 
	`GëBigDoubÀW‹d
(
outf
);

95 
	`¥ötf
(" %8ld %8ld %8ld \n", 
Rmö
[
iBuckë
], 
Bmö
[iBuckë], 
Fmö
[iBucket]);

97 
	`f˛o£
(
outf
);

99 
R_decodî
 = 
p_I≈
->R_decoder;

100 
F_decodî
 = 
p_I≈
->F_decoder;

101 
B_decodî
 = 
p_I≈
->B_decoder;

103  
iBuckë
 =0; iBuckë < 
NumbîLókyBuckës
; iBucket++)

105 if(
R_decodî
 < 
Rmö
[
iBuckë
])

109 
	`¥ötf
("\n");

110 if(
iBuckë
 > 0 )

112 if(
iBuckë
 < 
NumbîLókyBuckës
)

114 
dƒ
 = (Ë(
Rmö
[
iBuckë
] - Rmin[iBucket-1]);

115 
‰ac1
 = (Ë(
R_decodî
 - 
Rmö
[
iBuckë
-1]);

116 
‰ac2
 = (Ë(
Rmö
[
iBuckë
] - 
R_decodî
);

117 
B_öãΩ
 = (Ë(
Bmö
[
iBuckë
] * 
‰ac1
 + Bmö[iBuckë-1] * 
‰ac2
Ë/
dƒ
;

118 
F_öãΩ
 = (Ë(
Fmö
[
iBuckë
] * 
‰ac1
 + Fmö[iBuckë-1] * 
‰ac2
Ë/
dƒ
;

121 
B_öãΩ
 = (Ë
Bmö
[
iBuckë
-1];

122 
F_öãΩ
 = (Ë
Fmö
[
iBuckë
-1];

124 
	`¥ötf
(" Mö.buf„∏%8.2‡Decodî buf„∏sizê%ld \¿Möimum Dñay %8.2‡DecodîDñay %ld \n", 
B_öãΩ
, 
B_decodî
, 
F_öãΩ
, 
F_decodî
);

125 if(
B_decodî
 > 
B_öãΩ
 && 
F_decodî
 > 
F_öãΩ
)

126 
	`¥ötf
(" HRD Compliant \n");

128 
	`¥ötf
(" HRD Non Compliant \n");

131 
	`¥ötf
(" Decoder Rate isÅoo small; HRD cannot be verified \n");

134 
	`‰ì
(
Rmö
);

135 
	`‰ì
(
Bmö
);

136 
	`‰ì
(
Fmö
);

138 
	}
}

	@ldecod/src/loopFilter.c

23 
	~"globÆ.h
"

24 
	~"image.h
"

25 
	~"mb_ac˚ss.h
"

26 
	~"lo›fûãr.h
"

27 
	~"lo›_fûãr.h
"

29 
DeblockMb
 (
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
p
, 
MbQAddr
);

30 
≥rf‹m_db
 (
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
p
, 
MbQAddr
);

31 
gë_db_°ªngth
(
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
p
, 
MbQAddr
);

33 
£t_lo›_fûãr_fun˘i⁄s_mbaff
(
VideoP¨amëîs
 *
p_Vid
);

34 
£t_lo›_fûãr_fun˘i⁄s_n‹mÆ
(
VideoP¨amëîs
 *
p_Vid
);

35 
deblock_n‹mÆ
(
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
p
);

36 
gë_°ªngth_vî_MBAff
 (
byã
 *
Såígth
, 
Ma¸oblock
 *
MbQ
, 
edge
, 
mvlimô
, 
St‹abÀPi˘uª
 *
p
);

37 
gë_°ªngth_h‹_MBAff
 (
byã
 *
Såígth
, 
Ma¸oblock
 *
MbQ
, 
edge
, 
mvlimô
, 
St‹abÀPi˘uª
 *
p
);

39 #i‡(
JM_PARALLEL_DEBLOCK
 == 0)

46 
	$DeblockPi˘uª
(
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
p
)

48 
i
;

49 i‡(
p
->
mb_aff_‰ame_Êag
)

51 
i
 = 0; i < 
p
->
PicSizeInMbs
; ++i)

53 
	`DeblockMb
–
p_Vid
, 
p
, 
i
 ) ;

60 
i
 = 0; i < 
p
->
PicSizeInMbs
; ++i)

62 
	`gë_db_°ªngth
–
p_Vid
, 
p
, 
i
 ) ;

64 
i
 = 0; i < 
p
->
PicSizeInMbs
; ++i)

66 
	`≥rf‹m_db
–
p_Vid
, 
p
, 
i
 ) ;

70 
	}
}

72 
	$DeblockP¨ÆÀl
(
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
p
, 
cﬁumn
, 
block
, 
n_œ°
)

74 
i
, 
j
;

76 
j
 = 0; j < 
GROUP_SIZE
; j++)

78 
i
 = 
block
++ * (
p_Vid
->
PicWidthInMbs
 - 2Ë+ 
cﬁumn
;

80 
	`≥rf‹m_db
–
p_Vid
, 
p
, 
i
 ) ;

81 i‡(
block
 =
n_œ°
) ;

83 
	}
}

91 
	$DeblockPi˘uª
(
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
p
)

93 
iheightMBs
 =(
p_Vid
->
PicSizeInMbs
/p_Vid->
PicWidthInMbs
);

94 
i
, 
k
 = 
p
->
PicWidthInMbs
 + 2 * (
iheightMBs
 - 1);

96 #i‡
	`deföed
(
OPENMP
)

97 
j
;

98 #¥agm®
omp
 
∑øŒñ
 

100 
j
 = 0; j < 
p
->
PicSizeInMbs
; ++j)

102 
	`gë_db_°ªngth
–
p_Vid
, 
p
, 
j
 ) ;

105 
i
 = 0; i < 
k
; i++)

107 
¬
;

108 
n_œ°
 = 
	`imö
(
iheightMBs
, (
i
 >> 1) + 1);

109 
n_°¨t
 = (
i
 < 
p
->
PicWidthInMbs
) ? 0 : ((i -Ö->PicWidthInMbs) >> 1) + 1;

111 #i‡
	`deföed
(
OPENMP
)

112 #¥agm®
omp
 
∑øŒñ
 

114 
¬
 = 
n_°¨t
;Ç¿< 
n_œ°
;Ç¿+
GROUP_SIZE
)

115 
	`DeblockP¨ÆÀl
(
p_Vid
, 
p
, 
i
, 
¬
, 
n_œ°
);

117 
	}
}

121 
	$öô_√ighb‹s
(
VideoP¨amëîs
 *
p_Vid
)

123 
i
, 
j
;

124 
width
 = 
p_Vid
->
PicWidthInMbs
;

125 
height
 = 
p_Vid
->
PicHeightInMbs
;

126 
size
 = 
p_Vid
->
PicSizeInMbs
;

127 
Ma¸oblock
 *
cuºMB
 = &
p_Vid
->
mb_d©a
[0];

129 
cuºMB
->
mbup
 = 
NULL
;

130 
cuºMB
->
mbÀ·
 = 
NULL
;

131 
cuºMB
++;

133 
i
 = 1; i < 
width
; i++)

135 
cuºMB
->
mbup
 = 
NULL
;

136 
cuºMB
->
mbÀ·
 = currMB - 1;

137 
cuºMB
++;

141 
i
 = 
width
; i < 
size
; i += width)

143 
cuºMB
->
mbup
 = cuºMB - 
width
;

144 
cuºMB
->
mbÀ·
 = 
NULL
;

145 
cuºMB
 +
width
;

148 
j
 = 
width
 + 1; j < width * 
height
 + 1; j += width)

150 
cuºMB
 = &
p_Vid
->
mb_d©a
[
j
];

151 
i
 = 1; i < 
width
; i++)

153 
cuºMB
->
mbup
 = cuºMB - 
width
;

154 
cuºMB
->
mbÀ·
 = currMB - 1;

155 
cuºMB
++;

158 
	}
}

161 
	$öô_Deblock
(
VideoP¨amëîs
 *
p_Vid
, 
mb_aff_‰ame_Êag
)

163 if(
p_Vid
->
yuv_f‹m©
 =
YUV444
 &&Ö_Vid->
£∑øã_cﬁour_∂™e_Êag
)

165 
	`ch™ge_∂™e_JV
(
p_Vid
, 
PLANE_Y
, 
NULL
);

166 
	`öô_√ighb‹s
(
p_Dec
->
p_Vid
);

167 
	`ch™ge_∂™e_JV
(
p_Vid
, 
PLANE_U
, 
NULL
);

168 
	`öô_√ighb‹s
(
p_Dec
->
p_Vid
);

169 
	`ch™ge_∂™e_JV
(
p_Vid
, 
PLANE_V
, 
NULL
);

170 
	`öô_√ighb‹s
(
p_Dec
->
p_Vid
);

171 
	`ch™ge_∂™e_JV
(
p_Vid
, 
PLANE_Y
, 
NULL
);

174 
	`öô_√ighb‹s
(
p_Dec
->
p_Vid
);

175 i‡(
mb_aff_‰ame_Êag
 == 1)

177 
	`£t_lo›_fûãr_fun˘i⁄s_mbaff
(
p_Vid
);

181 
	`£t_lo›_fûãr_fun˘i⁄s_n‹mÆ
(
p_Vid
);

183 
	}
}

192 
	$DeblockMb
(
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
p
, 
MbQAddr
)

194 
Ma¸oblock
 *
MbQ
 = &(
p_Vid
->
mb_d©a
[
MbQAddr
]) ;

197 i‡(
MbQ
->
DFDißbÀIdc
 == 1)

199 
MbQ
->
DeblockCÆl
 = 0;

203 
edge
;

205 
byã
 
Såígth
[16];

206 
öt64
 *
p_Såígth64
 = (öt64 *Ë
Såígth
;

207 
mb_x
, 
mb_y
;

209 
fûãrN⁄8x8LumaEdgesFœg
[4] = {1,1,1,1};

210 
fûãrLe·MbEdgeFœg
;

211 
fûãrT›MbEdgeFœg
;

212 
edge_¸
;

214 
img≥l
 **
imgY
 = 
p
->imgY;

215 
img≥l
 ***
imgUV
 = 
p
->imgUV;

216 
Sli˚
 *
cuºSli˚
 = 
MbQ
->
p_Sli˚
;

217 
mvlimô
 = ((
p
->
°ru˘uª
!=
FRAME
Ë|| (p->
mb_aff_‰ame_Êag
 && 
MbQ
->
mb_fõld
)) ? 2 : 4;

219 
£q_∑ømëî_£t_rb•_t
 *
a˘ive_•s
 = 
p_Vid
->active_sps;

221 
MbQ
->
DeblockCÆl
 = 1;

222 
	`gë_mb_pos
 (
p_Vid
, 
MbQAddr
,Ö_Vid->
mb_size
[
IS_LUMA
], &
mb_x
, &
mb_y
);

224 i‡(
MbQ
->
mb_ty≥
 =
I8MB
)

225 
	`as£π
(
MbQ
->
luma_å™sf‹m_size_8x8_Êag
);

227 
fûãrN⁄8x8LumaEdgesFœg
[1] =

228 
fûãrN⁄8x8LumaEdgesFœg
[3] = !(
MbQ
->
luma_å™sf‹m_size_8x8_Êag
);

230 
fûãrLe·MbEdgeFœg
 = (
mb_x
 != 0);

231 
fûãrT›MbEdgeFœg
 = (
mb_y
 != 0);

233 i‡(
p
->
mb_aff_‰ame_Êag
 && 
mb_y
 =
MB_BLOCK_SIZE
 && 
MbQ
->
mb_fõld
)

234 
fûãrT›MbEdgeFœg
 = 0;

236 i‡(
MbQ
->
DFDißbÀIdc
==2)

239 
fûãrLe·MbEdgeFœg
 = 
MbQ
->
mbAvaûA
;

241 
fûãrT›MbEdgeFœg
 = (
p
->
mb_aff_‰ame_Êag
 && !
MbQ
->
mb_fõld
 && (
MbQAddr
 & 0x01)Ë? 1 : MbQ->
mbAvaûB
;

244 i‡(
p
->
mb_aff_‰ame_Êag
 == 1)

245 
	`CheckAvaûabûôyOfNeighb‹sMBAFF
(
MbQ
);

248 
edge
 = 0;Édge < 4 ; ++edge )

251 i‡(
MbQ
->
cbp
 =0 && (
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
 || cuºSli˚->¶i˚_ty≥ =
B_SLICE
))

253 i‡(
fûãrN⁄8x8LumaEdgesFœg
[
edge
] =0 && 
a˘ive_•s
->
chroma_f‹m©_idc
 !
YUV444
)

255 i‡(
edge
 > 0)

257 i‡(((
MbQ
->
mb_ty≥
 =
PSKIP
 && 
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
Ë|| (MbQ->mb_ty≥ =
P16x16
Ë|| (MbQ->mb_ty≥ =
P16x8
)))

259 i‡((
edge
 & 0x01Ë&& ((
MbQ
->
mb_ty≥
 =
P8x16
Ë|| (
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
 && MbQ->mb_ty≥ =
BSKIP_DIRECT
 && 
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
)))

264 if–
edge
 || 
fûãrLe·MbEdgeFœg
 )

267 
	`gë_°ªngth_vî_MBAff
(
Såígth
, 
MbQ
, 
edge
 << 2, 
mvlimô
, 
p
);

269 i‡((
p_Såígth64
[0]) || (p_Strength64[1]))

271 i‡(
fûãrN⁄8x8LumaEdgesFœg
[
edge
])

273 
p_Vid
->
	`EdgeLo›LumaVî
–
PLANE_Y
, 
imgY
, 
Såígth
, 
MbQ
, 
edge
 << 2);

274 if(
cuºSli˚
->
chroma444_nŸ_£∑øã
)

276 
p_Vid
->
	`EdgeLo›LumaVî
(
PLANE_U
, 
imgUV
[0], 
Såígth
, 
MbQ
, 
edge
 << 2);

277 
p_Vid
->
	`EdgeLo›LumaVî
(
PLANE_V
, 
imgUV
[1], 
Såígth
, 
MbQ
, 
edge
 << 2);

280 i‡(
a˘ive_•s
->
chroma_f‹m©_idc
==
YUV420
 ||á˘ive_•s->chroma_f‹m©_idc==
YUV422
)

282 
edge_¸
 = 
chroma_edge
[0][
edge
][
p
->
chroma_f‹m©_idc
];

283 if–(
imgUV
 !
NULL
Ë&& (
edge_¸
 >= 0))

285 
p_Vid
->
	`EdgeLo›ChromaVî
–
imgUV
[0], 
Såígth
, 
MbQ
, 
edge_¸
, 0, 
p
);

286 
p_Vid
->
	`EdgeLo›ChromaVî
–
imgUV
[1], 
Såígth
, 
MbQ
, 
edge_¸
, 1, 
p
);

294  
edge
 = 0;Édge < 4 ; ++edge )

297 i‡(
MbQ
->
cbp
 =0 && (
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
 || cuºSli˚->¶i˚_ty≥ =
B_SLICE
))

299 i‡(
fûãrN⁄8x8LumaEdgesFœg
[
edge
] =0 && 
a˘ive_•s
->
chroma_f‹m©_idc
==
YUV420
)

301 i‡(
edge
 > 0)

303 i‡(((
MbQ
->
mb_ty≥
 =
PSKIP
 && 
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
Ë|| (MbQ->mb_ty≥ =
P16x16
Ë|| (MbQ->mb_ty≥ =
P8x16
)))

305 i‡((
edge
 & 0x01Ë&& ((
MbQ
->
mb_ty≥
 =
P16x8
Ë|| (
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
 && MbQ->mb_ty≥ =
BSKIP_DIRECT
 && 
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
)))

310 if–
edge
 || 
fûãrT›MbEdgeFœg
 )

313 
	`gë_°ªngth_h‹_MBAff
(
Såígth
, 
MbQ
, 
edge
 << 2, 
mvlimô
, 
p
);

315 i‡((
p_Såígth64
[0]) || (p_Strength64[1]))

317 i‡(
fûãrN⁄8x8LumaEdgesFœg
[
edge
])

319 
p_Vid
->
	`EdgeLo›LumaH‹
–
PLANE_Y
, 
imgY
, 
Såígth
, 
MbQ
, 
edge
 << 2, 
p
) ;

320 if(
cuºSli˚
->
chroma444_nŸ_£∑øã
)

322 
p_Vid
->
	`EdgeLo›LumaH‹
(
PLANE_U
, 
imgUV
[0], 
Såígth
, 
MbQ
, 
edge
 << 2, 
p
);

323 
p_Vid
->
	`EdgeLo›LumaH‹
(
PLANE_V
, 
imgUV
[1], 
Såígth
, 
MbQ
, 
edge
 << 2, 
p
);

327 i‡(
a˘ive_•s
->
chroma_f‹m©_idc
==
YUV420
 ||á˘ive_•s->chroma_f‹m©_idc==
YUV422
)

329 
edge_¸
 = 
chroma_edge
[1][
edge
][
p
->
chroma_f‹m©_idc
];

330 if–(
imgUV
 !
NULL
Ë&& (
edge_¸
 >= 0))

332 
p_Vid
->
	`EdgeLo›ChromaH‹
–
imgUV
[0], 
Såígth
, 
MbQ
, 
edge_¸
, 0, 
p
);

333 
p_Vid
->
	`EdgeLo›ChromaH‹
–
imgUV
[1], 
Såígth
, 
MbQ
, 
edge_¸
, 1, 
p
);

338 i‡(!
edge
 && !
MbQ
->
mb_fõld
 && MbQ->
mixedModeEdgeFœg
)

341 
MbQ
->
DeblockCÆl
 = 2;

342 
	`gë_°ªngth_h‹_MBAff
(
Såígth
, 
MbQ
, 
MB_BLOCK_SIZE
, 
mvlimô
, 
p
);

346 i‡(
fûãrN⁄8x8LumaEdgesFœg
[
edge
])

349 
p_Vid
->
	`EdgeLo›LumaH‹
(
PLANE_Y
, 
imgY
, 
Såígth
, 
MbQ
, 
MB_BLOCK_SIZE
, 
p
) ;

350 if(
cuºSli˚
->
chroma444_nŸ_£∑øã
)

352 
p_Vid
->
	`EdgeLo›LumaH‹
(
PLANE_U
, 
imgUV
[0], 
Såígth
, 
MbQ
, 
MB_BLOCK_SIZE
, 
p
) ;

353 
p_Vid
->
	`EdgeLo›LumaH‹
(
PLANE_V
, 
imgUV
[1], 
Såígth
, 
MbQ
, 
MB_BLOCK_SIZE
, 
p
) ;

356 i‡(
a˘ive_•s
->
chroma_f‹m©_idc
==
YUV420
 ||á˘ive_•s->chroma_f‹m©_idc==
YUV422
)

358 
edge_¸
 = 
chroma_edge
[1][
edge
][
p
->
chroma_f‹m©_idc
];

359 if–(
imgUV
 !
NULL
Ë&& (
edge_¸
 >= 0))

361 
p_Vid
->
	`EdgeLo›ChromaH‹
–
imgUV
[0], 
Såígth
, 
MbQ
, 
MB_BLOCK_SIZE
, 0, 
p
) ;

362 
p_Vid
->
	`EdgeLo›ChromaH‹
–
imgUV
[1], 
Såígth
, 
MbQ
, 
MB_BLOCK_SIZE
, 1, 
p
) ;

366 
MbQ
->
DeblockCÆl
 = 1;

371 
MbQ
->
DeblockCÆl
 = 0;

373 
	}
}

381 
	$gë_db_°ªngth
(
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
p
, 
MbQAddr
)

383 
Ma¸oblock
 *
MbQ
 = &(
p_Vid
->
mb_d©a
[
MbQAddr
]) ;

386 i‡(
MbQ
->
DFDißbÀIdc
 == 1)

388 
MbQ
->
DeblockCÆl
 = 0;

392 
edge
;

394 
mb_x
, 
mb_y
;

396 
fûãrN⁄8x8LumaEdgesFœg
[4] = {1,1,1,1};

397 
fûãrLe·MbEdgeFœg
;

398 
fûãrT›MbEdgeFœg
;

400 
Sli˚
 *
cuºSli˚
 = 
MbQ
->
p_Sli˚
;

401 
mvlimô
 = ((
p
->
°ru˘uª
!=
FRAME
Ë|| (p->
mb_aff_‰ame_Êag
 && 
MbQ
->
mb_fõld
)) ? 2 : 4;

403 
£q_∑ømëî_£t_rb•_t
 *
a˘ive_•s
 = 
p_Vid
->active_sps;

405 
MbQ
->
DeblockCÆl
 = 1;

406 
	`gë_mb_pos
 (
p_Vid
, 
MbQAddr
,Ö_Vid->
mb_size
[
IS_LUMA
], &
mb_x
, &
mb_y
);

408 i‡(
MbQ
->
mb_ty≥
 =
I8MB
)

409 
	`as£π
(
MbQ
->
luma_å™sf‹m_size_8x8_Êag
);

411 
fûãrN⁄8x8LumaEdgesFœg
[1] =

412 
fûãrN⁄8x8LumaEdgesFœg
[3] = !(
MbQ
->
luma_å™sf‹m_size_8x8_Êag
);

414 
fûãrLe·MbEdgeFœg
 = (
mb_x
 != 0);

415 
fûãrT›MbEdgeFœg
 = (
mb_y
 != 0);

417 i‡(
p
->
mb_aff_‰ame_Êag
 && 
mb_y
 =
MB_BLOCK_SIZE
 && 
MbQ
->
mb_fõld
)

418 
fûãrT›MbEdgeFœg
 = 0;

420 i‡(
MbQ
->
DFDißbÀIdc
==2)

423 
fûãrLe·MbEdgeFœg
 = 
MbQ
->
mbAvaûA
;

425 
fûãrT›MbEdgeFœg
 = (
p
->
mb_aff_‰ame_Êag
 && !
MbQ
->
mb_fõld
 && (
MbQAddr
 & 0x01)Ë? 1 : MbQ->
mbAvaûB
;

428 i‡(
p
->
mb_aff_‰ame_Êag
 == 1)

429 
	`CheckAvaûabûôyOfNeighb‹sMBAFF
(
MbQ
);

432 
edge
 = 0;Édge < 4 ; ++edge )

435 i‡(
MbQ
->
cbp
 =0 && (
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
 || cuºSli˚->¶i˚_ty≥ =
B_SLICE
))

437 i‡(
fûãrN⁄8x8LumaEdgesFœg
[
edge
] =0 && 
a˘ive_•s
->
chroma_f‹m©_idc
 !
YUV444
)

439 i‡(
edge
 > 0)

441 i‡(((
MbQ
->
mb_ty≥
 =
PSKIP
 && 
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
Ë|| (MbQ->mb_ty≥ =
P16x16
Ë|| (MbQ->mb_ty≥ =
P16x8
)))

443 i‡((
edge
 & 0x01Ë&& ((
MbQ
->
mb_ty≥
 =
P8x16
Ë|| (
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
 && MbQ->mb_ty≥ =
BSKIP_DIRECT
 && 
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
)))

448 if–
edge
 || 
fûãrLe·MbEdgeFœg
 )

451 
p_Vid
->
	`GëSåígthVî
(
MbQ
, 
edge
, 
mvlimô
, 
p
);

456  
edge
 = 0;Édge < 4 ; ++edge )

459 i‡(
MbQ
->
cbp
 =0 && (
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
 || cuºSli˚->¶i˚_ty≥ =
B_SLICE
))

461 i‡(
fûãrN⁄8x8LumaEdgesFœg
[
edge
] =0 && 
a˘ive_•s
->
chroma_f‹m©_idc
==
YUV420
)

463 i‡(
edge
 > 0)

465 i‡(((
MbQ
->
mb_ty≥
 =
PSKIP
 && 
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
Ë|| (MbQ->mb_ty≥ =
P16x16
Ë|| (MbQ->mb_ty≥ =
P8x16
)))

467 i‡((
edge
 & 0x01Ë&& ((
MbQ
->
mb_ty≥
 =
P16x8
Ë|| (
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
 && MbQ->mb_ty≥ =
BSKIP_DIRECT
 && 
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
)))

472 if–
edge
 || 
fûãrT›MbEdgeFœg
 )

474 
p_Vid
->
	`GëSåígthH‹
(
MbQ
, 
edge
, 
mvlimô
, 
p
);

478 
MbQ
->
DeblockCÆl
 = 0;

480 
	}
}

483 
	$≥rf‹m_db
(
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
p
, 
MbQAddr
)

485 
Ma¸oblock
 *
MbQ
 = &(
p_Vid
->
mb_d©a
[
MbQAddr
]) ;

488 i‡(
MbQ
->
DFDißbÀIdc
 == 1)

490 
MbQ
->
DeblockCÆl
 = 0;

494 
edge
;

496 
mb_x
, 
mb_y
;

498 
fûãrN⁄8x8LumaEdgesFœg
[4] = {1,1,1,1};

499 
fûãrLe·MbEdgeFœg
;

500 
fûãrT›MbEdgeFœg
;

501 
edge_¸
;

503 
img≥l
 **
imgY
 = 
p
->imgY;

504 
img≥l
 ***
imgUV
 = 
p
->imgUV;

505 
Sli˚
 *
cuºSli˚
 = 
MbQ
->
p_Sli˚
;

506 
mvlimô
 = ((
p
->
°ru˘uª
!=
FRAME
Ë|| (p->
mb_aff_‰ame_Êag
 && 
MbQ
->
mb_fõld
)) ? 2 : 4;

508 
£q_∑ømëî_£t_rb•_t
 *
a˘ive_•s
 = 
p_Vid
->active_sps;

510 
MbQ
->
DeblockCÆl
 = 1;

511 
	`gë_mb_pos
 (
p_Vid
, 
MbQAddr
,Ö_Vid->
mb_size
[
IS_LUMA
], &
mb_x
, &
mb_y
);

513 i‡(
MbQ
->
mb_ty≥
 =
I8MB
)

514 
	`as£π
(
MbQ
->
luma_å™sf‹m_size_8x8_Êag
);

516 
fûãrN⁄8x8LumaEdgesFœg
[1] =

517 
fûãrN⁄8x8LumaEdgesFœg
[3] = !(
MbQ
->
luma_å™sf‹m_size_8x8_Êag
);

519 
fûãrLe·MbEdgeFœg
 = (
mb_x
 != 0);

520 
fûãrT›MbEdgeFœg
 = (
mb_y
 != 0);

522 i‡(
p
->
mb_aff_‰ame_Êag
 && 
mb_y
 =
MB_BLOCK_SIZE
 && 
MbQ
->
mb_fõld
)

523 
fûãrT›MbEdgeFœg
 = 0;

525 i‡(
MbQ
->
DFDißbÀIdc
==2)

528 
fûãrLe·MbEdgeFœg
 = 
MbQ
->
mbAvaûA
;

530 
fûãrT›MbEdgeFœg
 = (
p
->
mb_aff_‰ame_Êag
 && !
MbQ
->
mb_fõld
 && (
MbQAddr
 & 0x01)Ë? 1 : MbQ->
mbAvaûB
;

533 i‡(
p
->
mb_aff_‰ame_Êag
 == 1)

534 
	`CheckAvaûabûôyOfNeighb‹sMBAFF
(
MbQ
);

537 
edge
 = 0;Édge < 4 ; ++edge )

540 i‡(
MbQ
->
cbp
 =0 && (
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
 || cuºSli˚->¶i˚_ty≥ =
B_SLICE
))

542 i‡(
fûãrN⁄8x8LumaEdgesFœg
[
edge
] =0 && 
a˘ive_•s
->
chroma_f‹m©_idc
 !
YUV444
)

544 i‡(
edge
 > 0)

546 i‡(((
MbQ
->
mb_ty≥
 =
PSKIP
 && 
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
Ë|| (MbQ->mb_ty≥ =
P16x16
Ë|| (MbQ->mb_ty≥ =
P16x8
)))

548 i‡((
edge
 & 0x01Ë&& ((
MbQ
->
mb_ty≥
 =
P8x16
Ë|| (
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
 && MbQ->mb_ty≥ =
BSKIP_DIRECT
 && 
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
)))

553 if–
edge
 || 
fûãrLe·MbEdgeFœg
 )

555 
byã
 *
Såígth
 = 
MbQ
->
°ªngth_vî
[
edge
];

557 i‡((*((*Ë
Såígth
)))

559 i‡(
fûãrN⁄8x8LumaEdgesFœg
[
edge
])

561 
p_Vid
->
	`EdgeLo›LumaVî
–
PLANE_Y
, 
imgY
, 
Såígth
, 
MbQ
, 
edge
 << 2);

562 if(
cuºSli˚
->
chroma444_nŸ_£∑øã
)

564 
p_Vid
->
	`EdgeLo›LumaVî
(
PLANE_U
, 
imgUV
[0], 
Såígth
, 
MbQ
, 
edge
 << 2);

565 
p_Vid
->
	`EdgeLo›LumaVî
(
PLANE_V
, 
imgUV
[1], 
Såígth
, 
MbQ
, 
edge
 << 2);

568 i‡(
a˘ive_•s
->
chroma_f‹m©_idc
==
YUV420
 ||á˘ive_•s->chroma_f‹m©_idc==
YUV422
)

570 
edge_¸
 = 
chroma_edge
[0][
edge
][
p
->
chroma_f‹m©_idc
];

571 if–(
imgUV
 !
NULL
Ë&& (
edge_¸
 >= 0))

573 
p_Vid
->
	`EdgeLo›ChromaVî
–
imgUV
[0], 
Såígth
, 
MbQ
, 
edge_¸
, 0, 
p
);

574 
p_Vid
->
	`EdgeLo›ChromaVî
–
imgUV
[1], 
Såígth
, 
MbQ
, 
edge_¸
, 1, 
p
);

582  
edge
 = 0;Édge < 4 ; ++edge )

585 i‡(
MbQ
->
cbp
 =0 && (
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
 || cuºSli˚->¶i˚_ty≥ =
B_SLICE
))

587 i‡(
fûãrN⁄8x8LumaEdgesFœg
[
edge
] =0 && 
a˘ive_•s
->
chroma_f‹m©_idc
==
YUV420
)

589 i‡(
edge
 > 0)

591 i‡(((
MbQ
->
mb_ty≥
 =
PSKIP
 && 
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
Ë|| (MbQ->mb_ty≥ =
P16x16
Ë|| (MbQ->mb_ty≥ =
P8x16
)))

593 i‡((
edge
 & 0x01Ë&& ((
MbQ
->
mb_ty≥
 =
P16x8
Ë|| (
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
 && MbQ->mb_ty≥ =
BSKIP_DIRECT
 && 
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
)))

598 if–
edge
 || 
fûãrT›MbEdgeFœg
 )

600 
byã
 *
Såígth
 = 
MbQ
->
°ªngth_h‹
[
edge
];

602 i‡((*((
öt64
 *Ë
Såígth
)) || ((*(((int64 *) Strength) + 1))))

604 i‡(
fûãrN⁄8x8LumaEdgesFœg
[
edge
])

606 
p_Vid
->
	`EdgeLo›LumaH‹
–
PLANE_Y
, 
imgY
, 
Såígth
, 
MbQ
, 
edge
 << 2, 
p
) ;

607 if(
cuºSli˚
->
chroma444_nŸ_£∑øã
)

609 
p_Vid
->
	`EdgeLo›LumaH‹
(
PLANE_U
, 
imgUV
[0], 
Såígth
, 
MbQ
, 
edge
 << 2, 
p
);

610 
p_Vid
->
	`EdgeLo›LumaH‹
(
PLANE_V
, 
imgUV
[1], 
Såígth
, 
MbQ
, 
edge
 << 2, 
p
);

614 i‡(
a˘ive_•s
->
chroma_f‹m©_idc
==
YUV420
 ||á˘ive_•s->chroma_f‹m©_idc==
YUV422
)

616 
edge_¸
 = 
chroma_edge
[1][
edge
][
p
->
chroma_f‹m©_idc
];

617 if–(
imgUV
 !
NULL
Ë&& (
edge_¸
 >= 0))

619 
p_Vid
->
	`EdgeLo›ChromaH‹
–
imgUV
[0], 
Såígth
, 
MbQ
, 
edge_¸
, 0, 
p
);

620 
p_Vid
->
	`EdgeLo›ChromaH‹
–
imgUV
[1], 
Såígth
, 
MbQ
, 
edge_¸
, 1, 
p
);

625 i‡(!
edge
 && !
MbQ
->
mb_fõld
 && MbQ->
mixedModeEdgeFœg
)

628 
MbQ
->
DeblockCÆl
 = 2;

629 
p_Vid
->
	`GëSåígthH‹
(
MbQ
, 4, 
mvlimô
, 
p
);

633 i‡(
fûãrN⁄8x8LumaEdgesFœg
[
edge
])

636 
p_Vid
->
	`EdgeLo›LumaH‹
(
PLANE_Y
, 
imgY
, 
Såígth
, 
MbQ
, 
MB_BLOCK_SIZE
, 
p
) ;

637 if(
cuºSli˚
->
chroma444_nŸ_£∑øã
)

639 
p_Vid
->
	`EdgeLo›LumaH‹
(
PLANE_U
, 
imgUV
[0], 
Såígth
, 
MbQ
, 
MB_BLOCK_SIZE
, 
p
) ;

640 
p_Vid
->
	`EdgeLo›LumaH‹
(
PLANE_V
, 
imgUV
[1], 
Såígth
, 
MbQ
, 
MB_BLOCK_SIZE
, 
p
) ;

643 i‡(
a˘ive_•s
->
chroma_f‹m©_idc
==
YUV420
 ||á˘ive_•s->chroma_f‹m©_idc==
YUV422
)

645 
edge_¸
 = 
chroma_edge
[1][
edge
][
p
->
chroma_f‹m©_idc
];

646 if–(
imgUV
 !
NULL
Ë&& (
edge_¸
 >= 0))

648 
p_Vid
->
	`EdgeLo›ChromaH‹
–
imgUV
[0], 
Såígth
, 
MbQ
, 
MB_BLOCK_SIZE
, 0, 
p
) ;

649 
p_Vid
->
	`EdgeLo›ChromaH‹
–
imgUV
[1], 
Såígth
, 
MbQ
, 
MB_BLOCK_SIZE
, 1, 
p
) ;

653 
MbQ
->
DeblockCÆl
 = 1;

658 
MbQ
->
DeblockCÆl
 = 0;

660 
	}
}

	@ldecod/src/loop_filter_mbaff.c

23 
	~"globÆ.h
"

24 
	~"image.h
"

25 
	~"mb_ac˚ss.h
"

26 
	~"lo›fûãr.h
"

27 
	~"lo›_fûãr.h
"

31 
edge_lo›_luma_vî_MBAff
 (
Cﬁ‹Pœ√
 
∂
, 
img≥l
** 
Img
, 
byã
 *
Såígth
, 
Ma¸oblock
 *
MbQ
, 
edge
);

32 
edge_lo›_luma_h‹_MBAff
 (
Cﬁ‹Pœ√
 
∂
, 
img≥l
** 
Img
, 
byã
 *
Såígth
, 
Ma¸oblock
 *
MbQ
, 
edge
, 
St‹abÀPi˘uª
 *
p
);

33 
edge_lo›_chroma_vî_MBAff
 (
img≥l
** 
Img
, 
byã
 *
Såígth
, 
Ma¸oblock
 *
MbQ
, 
edge
, 
uv
, 
St‹abÀPi˘uª
 *
p
);

34 
edge_lo›_chroma_h‹_MBAff
 (
img≥l
** 
Img
, 
byã
 *
Såígth
, 
Ma¸oblock
 *
MbQ
, 
edge
, 
uv
, 
St‹abÀPi˘uª
 *
p
);

36 
	$£t_lo›_fûãr_fun˘i⁄s_mbaff
(
VideoP¨amëîs
 *
p_Vid
)

40 
p_Vid
->
EdgeLo›LumaVî
 = 
edge_lo›_luma_vî_MBAff
;

41 
p_Vid
->
EdgeLo›LumaH‹
 = 
edge_lo›_luma_h‹_MBAff
;

42 
p_Vid
->
EdgeLo›ChromaVî
 = 
edge_lo›_chroma_vî_MBAff
;

43 
p_Vid
->
EdgeLo›ChromaH‹
 = 
edge_lo›_chroma_h‹_MBAff
;

44 
	}
}

47 
Ma¸oblock
* 
	$gë_n⁄_aff_√ighb‹_luma
(
Ma¸oblock
 *
mb
, 
xN
, 
yN
)

49 i‡(
xN
 < 0)

50 (
mb
->
mbÀ·
);

51 i‡(
yN
 < 0)

52 (
mb
->
mbup
);

54 (
mb
);

55 
	}
}

57 
Ma¸oblock
* 
	$gë_n⁄_aff_√ighb‹_chroma
(
Ma¸oblock
 *
mb
, 
xN
, 
yN
, 
block_width
,
block_height
)

59 i‡(
xN
 < 0)

61 i‡(
yN
 < 
block_height
)

62 (
mb
->
mbÀ·
);

64 (
NULL
);

66 i‡(
xN
 < 
block_width
)

68 i‡(
yN
 < 0)

69 (
mb
->
mbup
);

70 i‡(
yN
 < 
block_height
)

71 (
mb
);

73 (
NULL
);

76 (
NULL
);

77 
	}
}

86 
	$gë_°ªngth_vî_MBAff
(
byã
 *
Såígth
, 
Ma¸oblock
 *
MbQ
, 
edge
, 
mvlimô
, 
St‹abÀPi˘uª
 *
p
)

89 
blkP
, 
blkQ
, 
idx
;

92 
SåVÆue
;

93 
mb_x
, 
mb_y
;

95 
Ma¸oblock
 *
MbP
;

97 
PixñPos
 
pixP
;

98 
VideoP¨amëîs
 *
p_Vid
 = 
MbQ
->p_Vid;

99 
BlockPos
 *
PicPos
 = 
p_Vid
->PicPos;

101 i‡((
p
->
¶i˚_ty≥
==
SP_SLICE
)||’->¶i˚_ty≥==
SI_SLICE
) )

103  
idx
 = 0; idx < 
MB_BLOCK_SIZE
; ++idx )

105 
	`gëAffNeighbour
(
MbQ
, 
edge
 - 1, 
idx
, 
p_Vid
->
mb_size
[
IS_LUMA
], &
pixP
);

106 
blkQ
 = (Ë((
idx
 & 0xFFFCË+ (
edge
 >> 2));

107 
blkP
 = (Ë((
pixP
.
y
 & 0xFFFCË+ (pixP.
x
 >> 2));

109 
MbP
 = &(
p_Vid
->
mb_d©a
[
pixP
.
mb_addr
]);

110 
MbQ
->
mixedModeEdgeFœg
 = (
byã
Ë(MbQ->
mb_fõld
 !
MbP
->mb_field);

112 
Såígth
[
idx
] = (
edge
 == 0) ? 4 : 3;

117 
	`gëAffNeighbour
(
MbQ
, 
edge
 - 1, 0, 
p_Vid
->
mb_size
[
IS_LUMA
], &
pixP
);

119 
MbP
 = &(
p_Vid
->
mb_d©a
[
pixP
.
mb_addr
]);

121 i‡((
MbQ
->
mb_fõld
 =
FALSE
 && 
MbP
->mb_field == FALSE))

123 
MbQ
->
mixedModeEdgeFœg
 = (
byã
Ë(MbQ->
mb_fõld
 !
MbP
->mb_field);

124 i‡(
MbQ
->
is_öåa_block
 =
TRUE
 || 
MbP
->is_intra_block == TRUE)

128 
SåVÆue
 = (
edge
 == 0) ? 4 : 3;

129 
	`mem£t
(
Såígth
, (
byã
Ë
SåVÆue
, 
MB_BLOCK_SIZE
 * (byte));

133 
	`gë_mb_block_pos_mbaff
 (
PicPos
, 
MbQ
->
mbAddrX
, &
mb_x
, &
mb_y
);

134  
idx
 = 0; idx < 
MB_BLOCK_SIZE
; idx +
BLOCK_SIZE
)

136 
blkQ
 = (Ë((
idx
 & 0xFFFCË+ (
edge
 >> 2));

137 
blkP
 = (Ë((
pixP
.
y
 & 0xFFFCË+ (pixP.
x
 >> 2));

139 i‡(((
MbQ
->
s_cbp
[0].
blk
 & 
	`i64_powî2
(
blkQ
)Ë!0Ë|| ((
MbP
->s_cbp[0].blk & i64_powî2(
blkP
)) != 0))

140 
SåVÆue
 = 2;

141 i‡(
edge
 && ((
MbQ
->
mb_ty≥
 == 1) || (MbQ->mb_type == 2)))

142 
SåVÆue
 = 0;

145 
blk_y
 = ((
mb_y
<<2Ë+ (
blkQ
 >> 2));

146 
blk_x
 = ((
mb_x
<<2Ë+ (
blkQ
 & 3));

147 
blk_y2
 = (
pixP
.
pos_y
 >> 2);

148 
blk_x2
 = (
pixP
.
pos_x
 >> 2);

150 
PicMŸi⁄P¨ams
 *
mv_öfo_p
 = &
p
->
mv_öfo
[
blk_y
 ][
blk_x
 ];

151 
PicMŸi⁄P¨ams
 *
mv_öfo_q
 = &
p
->
mv_öfo
[
blk_y2
][
blk_x2
];

152 
St‹abÀPi˘uªPå
 
ªf_p0
 = 
mv_öfo_p
->
ªf_pic
[
LIST_0
];

153 
St‹abÀPi˘uªPå
 
ªf_q0
 = 
mv_öfo_q
->
ªf_pic
[
LIST_0
];

154 
St‹abÀPi˘uªPå
 
ªf_p1
 = 
mv_öfo_p
->
ªf_pic
[
LIST_1
];

155 
St‹abÀPi˘uªPå
 
ªf_q1
 = 
mv_öfo_q
->
ªf_pic
[
LIST_1
];

157 i‡–((
ªf_p0
==
ªf_q0
Ë&& (
ªf_p1
==
ªf_q1
))||((ref_p0==ref_q1) && (ref_p1==ref_q0)))

160 i‡(
ªf_p0
 !
ªf_p1
)

163 i‡(
ªf_p0
==
ªf_q0
)

165 
SåVÆue
 = (
byã
) (

166 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_0
], &
mv_öfo_q
->mv[LIST_0], 
mvlimô
) ||

167 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_1
], &
mv_öfo_q
->mv[LIST_1], 
mvlimô
));

171 
SåVÆue
 = (
byã
) (

172 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_0
], &
mv_öfo_q
->mv[
LIST_1
], 
mvlimô
) ||

173 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_1
], &
mv_öfo_q
->mv[
LIST_0
], 
mvlimô
));

179 
SåVÆue
 = (
byã
) ((

180 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_0
], &
mv_öfo_q
->mv[LIST_0], 
mvlimô
) ||

181 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_1
], &
mv_öfo_q
->mv[LIST_1], 
mvlimô
))

183 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_0
], &
mv_öfo_q
->mv[
LIST_1
], 
mvlimô
) ||

184 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_1
], &
mv_öfo_q
->mv[
LIST_0
], 
mvlimô
)));

189 
SåVÆue
 = 1;

192 *(*)(
Såígth
+
idx
Ë
SåVÆue
 * 0x01010101;

193 
pixP
.
y
 += 4;

194 
pixP
.
pos_y
 += 4;

200  
idx
 = 0; idx < 
MB_BLOCK_SIZE
; ++idx )

202 
	`gëAffNeighbour
(
MbQ
, 
edge
 - 1, 
idx
, 
p_Vid
->
mb_size
[
IS_LUMA
], &
pixP
);

203 
blkQ
 = (Ë((
idx
 & 0xFFFCË+ (
edge
 >> 2));

204 
blkP
 = (Ë((
pixP
.
y
 & 0xFFFCË+ (pixP.
x
 >> 2));

206 
MbP
 = &(
p_Vid
->
mb_d©a
[
pixP
.
mb_addr
]);

207 
MbQ
->
mixedModeEdgeFœg
 = (
byã
Ë(MbQ->
mb_fõld
 !
MbP
->mb_field);

210 
Såígth
[
idx
] = (
edge
 =0 && (((!
p
->
mb_aff_‰ame_Êag
 && (p->
°ru˘uª
==
FRAME
)) ||

211 (
p
->
mb_aff_‰ame_Êag
 && !
MbP
->
mb_fõld
 && !
MbQ
->mb_field)) ||

212 ((
p
->
mb_aff_‰ame_Êag
 || (p->
°ru˘uª
!=
FRAME
))))) ? 4 : 3;

214 i‡(
MbQ
->
is_öåa_block
 =
FALSE
 && 
MbP
->is_intra_block == FALSE)

216 i‡(((
MbQ
->
s_cbp
[0].
blk
 & 
	`i64_powî2
(
blkQ
)Ë!0Ë|| ((
MbP
->s_cbp[0].blk & i64_powî2(
blkP
)) != 0))

217 
Såígth
[
idx
] = 2 ;

223 if(
MbQ
->
mixedModeEdgeFœg
)

225 
Såígth
[
idx
] = 1;

229 
	`gë_mb_block_pos_mbaff
 (
PicPos
, 
MbQ
->
mbAddrX
, &
mb_x
, &
mb_y
);

231 
blk_y
 = ((
mb_y
<<2Ë+ (
blkQ
 >> 2));

232 
blk_x
 = ((
mb_x
<<2Ë+ (
blkQ
 & 3));

233 
blk_y2
 = (
pixP
.
pos_y
 >> 2);

234 
blk_x2
 = (
pixP
.
pos_x
 >> 2);

236 
PicMŸi⁄P¨ams
 *
mv_öfo_p
 = &
p
->
mv_öfo
[
blk_y
 ][
blk_x
 ];

237 
PicMŸi⁄P¨ams
 *
mv_öfo_q
 = &
p
->
mv_öfo
[
blk_y2
][
blk_x2
];

238 
St‹abÀPi˘uªPå
 
ªf_p0
 = 
mv_öfo_p
->
ªf_pic
[
LIST_0
];

239 
St‹abÀPi˘uªPå
 
ªf_q0
 = 
mv_öfo_q
->
ªf_pic
[
LIST_0
];

240 
St‹abÀPi˘uªPå
 
ªf_p1
 = 
mv_öfo_p
->
ªf_pic
[
LIST_1
];

241 
St‹abÀPi˘uªPå
 
ªf_q1
 = 
mv_öfo_q
->
ªf_pic
[
LIST_1
];

243 i‡–((
ªf_p0
==
ªf_q0
Ë&& (
ªf_p1
==
ªf_q1
))||((ref_p0==ref_q1) && (ref_p1==ref_q0)))

245 
Såígth
[
idx
]=0;

247 i‡(
ªf_p0
 !
ªf_p1
)

250 i‡(
ªf_p0
==
ªf_q0
)

252 
Såígth
[
idx
] = (
byã
) (

253 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_0
], &
mv_öfo_q
->mv[LIST_0], 
mvlimô
) ||

254 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_1
], &
mv_öfo_q
->mv[LIST_1], 
mvlimô
));

258 
Såígth
[
idx
] = (
byã
) (

259 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_0
], &
mv_öfo_q
->mv[
LIST_1
], 
mvlimô
) ||

260 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_1
], &
mv_öfo_q
->mv[
LIST_0
], 
mvlimô
));

266 
Såígth
[
idx
] = (
byã
) ((

267 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_0
], &
mv_öfo_q
->mv[LIST_0], 
mvlimô
) ||

268 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_1
], &
mv_öfo_q
->mv[LIST_1], 
mvlimô
))

270 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_0
], &
mv_öfo_q
->mv[
LIST_1
], 
mvlimô
) ||

271 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_1
], &
mv_öfo_q
->mv[
LIST_0
], 
mvlimô
)));

276 
Såígth
[
idx
] = 1;

285 
	}
}

293 
	$gë_°ªngth_h‹_MBAff
(
byã
 *
Såígth
, 
Ma¸oblock
 *
MbQ
, 
edge
, 
mvlimô
, 
St‹abÀPi˘uª
 *
p
)

295 
blkP
, 
blkQ
, 
idx
;

296 
blk_x
, 
blk_x2
, 
blk_y
, 
blk_y2
 ;

298 
SåVÆue
;

299 
xQ
, 
yQ
 = (
edge
 < 
MB_BLOCK_SIZE
 ?Édge : 1);

300 
mb_x
, 
mb_y
;

302 
Ma¸oblock
 *
MbP
;

304 
PixñPos
 
pixP
;

305 
VideoP¨amëîs
 *
p_Vid
 = 
MbQ
->p_Vid;

306 
BlockPos
 *
PicPos
 = 
p_Vid
->PicPos;

308 i‡((
p
->
¶i˚_ty≥
==
SP_SLICE
)||’->¶i˚_ty≥==
SI_SLICE
) )

310  
idx
 = 0; idx < 
MB_BLOCK_SIZE
; idx +
BLOCK_SIZE
)

312 
xQ
 = 
idx
;

313 
	`gëAffNeighbour
(
MbQ
, 
xQ
, 
yQ
 - 1, 
p_Vid
->
mb_size
[
IS_LUMA
], &
pixP
);

315 
blkQ
 = (Ë((
yQ
 & 0xFFFCË+ (
xQ
 >> 2));

316 
blkP
 = (Ë((
pixP
.
y
 & 0xFFFCË+ (pixP.
x
 >> 2));

318 
MbP
 = &(
p_Vid
->
mb_d©a
[
pixP
.
mb_addr
]);

319 
MbQ
->
mixedModeEdgeFœg
 = (
byã
Ë(MbQ->
mb_fõld
 !
MbP
->mb_field);

321 
SåVÆue
 = (
edge
 =0 && (!
MbP
->
mb_fõld
 && !
MbQ
->mb_field)) ? 4 : 3;

323 *(*)(
Såígth
+
idx
Ë
SåVÆue
 * 0x01010101;

328 
	`gëAffNeighbour
(
MbQ
, 0, 
yQ
 - 1, 
p_Vid
->
mb_size
[
IS_LUMA
], &
pixP
);

329 
MbP
 = &(
p_Vid
->
mb_d©a
[
pixP
.
mb_addr
]);

330 
MbQ
->
mixedModeEdgeFœg
 = (
byã
Ë(MbQ->
mb_fõld
 !
MbP
->mb_field);

333 i‡(
MbQ
->
is_öåa_block
 =
TRUE
 || 
MbP
->is_intra_block == TRUE)

335 
SåVÆue
 = (
edge
 =0 && (!
MbP
->
mb_fõld
 && !
MbQ
->mb_field)) ? 4 : 3;

336 
	`mem£t
(
Såígth
, (
byã
Ë
SåVÆue
, 
MB_BLOCK_SIZE
 * (byte));

340  
idx
 = 0; idx < 
MB_BLOCK_SIZE
; idx +
BLOCK_SIZE
 )

342 
xQ
 = 
idx
;

343 
	`gëAffNeighbour
(
MbQ
, 
xQ
, 
yQ
 - 1, 
p_Vid
->
mb_size
[
IS_LUMA
], &
pixP
);

345 
blkQ
 = (Ë((
yQ
 & 0xFFFCË+ (
xQ
 >> 2));

346 
blkP
 = (Ë((
pixP
.
y
 & 0xFFFCË+ (pixP.
x
 >> 2));

348 i‡(((
MbQ
->
s_cbp
[0].
blk
 & 
	`i64_powî2
(
blkQ
)Ë!0Ë|| ((
MbP
->s_cbp[0].blk & i64_powî2(
blkP
)) != 0))

350 
SåVÆue
 = 2;

357 if(
MbQ
->
mixedModeEdgeFœg
)

359 
SåVÆue
 = 1;

363 
	`gë_mb_block_pos_mbaff
 (
PicPos
, 
MbQ
->
mbAddrX
, &
mb_x
, &
mb_y
);

364 
blk_y
 = (Ë((
mb_y
<<2Ë+ (
blkQ
 >> 2));

365 
blk_x
 = (Ë((
mb_x
<<2Ë+ (
blkQ
 & 3));

366 
blk_y2
 = (Ë(
pixP
.
pos_y
 >> 2);

367 
blk_x2
 = (Ë(
pixP
.
pos_x
 >> 2);

370 
PicMŸi⁄P¨ams
 *
mv_öfo_p
 = &
p
->
mv_öfo
[
blk_y
 ][
blk_x
 ];

371 
PicMŸi⁄P¨ams
 *
mv_öfo_q
 = &
p
->
mv_öfo
[
blk_y2
][
blk_x2
];

372 
St‹abÀPi˘uªPå
 
ªf_p0
 = 
mv_öfo_p
->
ªf_pic
[
LIST_0
];

373 
St‹abÀPi˘uªPå
 
ªf_q0
 = 
mv_öfo_q
->
ªf_pic
[
LIST_0
];

374 
St‹abÀPi˘uªPå
 
ªf_p1
 = 
mv_öfo_p
->
ªf_pic
[
LIST_1
];

375 
St‹abÀPi˘uªPå
 
ªf_q1
 = 
mv_öfo_q
->
ªf_pic
[
LIST_1
];

377 i‡–((
ªf_p0
==
ªf_q0
Ë&& (
ªf_p1
==
ªf_q1
)) ||

378 ((
ªf_p0
==
ªf_q1
Ë&& (
ªf_p1
==
ªf_q0
)))

380 
SåVÆue
 = 0;

382 i‡(
ªf_p0
 !
ªf_p1
)

385 i‡(
ªf_p0
==
ªf_q0
)

387 
SåVÆue
 = (
byã
) (

388 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_0
], &
mv_öfo_q
->mv[LIST_0], 
mvlimô
) ||

389 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_1
], &
mv_öfo_q
->mv[LIST_1], 
mvlimô
));

393 
SåVÆue
 = (
byã
) (

394 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_0
], &
mv_öfo_q
->mv[
LIST_1
], 
mvlimô
) ||

395 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_1
], &
mv_öfo_q
->mv[
LIST_0
], 
mvlimô
));

400 
SåVÆue
 = (
byã
) ((

401 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_0
], &
mv_öfo_q
->mv[LIST_0], 
mvlimô
) ||

402 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_1
], &
mv_öfo_q
->mv[LIST_1], 
mvlimô
))

404 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_0
], &
mv_öfo_q
->mv[
LIST_1
], 
mvlimô
) ||

405 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_1
], &
mv_öfo_q
->mv[
LIST_0
], 
mvlimô
)));

410 
SåVÆue
 = 1;

415 *(*)(
Såígth
+
idx
Ë
SåVÆue
 * 0x01010101;

419 
	}
}

428 
	$edge_lo›_luma_vî_MBAff
(
Cﬁ‹Pœ√
 
∂
, 
img≥l
** 
Img
, 
byã
 *
Såígth
, 
Ma¸oblock
 *
MbQ
, 
edge
)

430 
≥l
, 
Sång
 ;

431 
img≥l
 
L2
 = 0, 
L1
, 
L0
, 
R0
, 
R1
, 
R2
 = 0;

432 
AÕha
 = 0, 
Bëa
 = 0 ;

433 c⁄° 
byã
* 
ClùTab
 = 
NULL
;

434 
ödexA
, 
ödexB
;

436 
QP
;

438 
PixñPos
 
pixP
, 
pixQ
;

440 
VideoP¨amëîs
 *
p_Vid
 = 
MbQ
->p_Vid;

441 
bôdïth_sˇÀ
 = 
∂
? 
p_Vid
->bôdïth_sˇÀ[
IS_CHROMA
] :Ö_Vid->bôdïth_sˇÀ[
IS_LUMA
];

442 
max_img≥l_vÆue
 = 
p_Vid
->
max_≥l_vÆue_comp
[
∂
];

444 
AÕhaC0Off£t
 = 
MbQ
->
DFAÕhaC0Off£t
;

445 
BëaOff£t
 = 
MbQ
->
DFBëaOff£t
;

447 
Ma¸oblock
 *
MbP
;

448 
img≥l
 *
SrcPåP
, *
SrcPåQ
;

450 i‡(
MbQ
->
DFDißbÀIdc
 == 0)

452  
≥l
 = 0 ;Öñ < 
MB_BLOCK_SIZE
 ; ++pel )

454 
	`gëAffNeighbour
(
MbQ
, 
edge
 - 1, 
≥l
, 
p_Vid
->
mb_size
[
IS_LUMA
], &
pixP
);

456 i‡(
pixP
.
avaûabÀ
)

458 if–(
Sång
 = 
Såígth
[
≥l
]) != 0)

460 
	`gëAffNeighbour
(
MbQ
, 
edge
, 
≥l
, 
p_Vid
->
mb_size
[
IS_LUMA
], &
pixQ
);

462 
MbP
 = &(
p_Vid
->
mb_d©a
[
pixP
.
mb_addr
]);

464 
SrcPåQ
 = &(
Img
[
pixQ
.
pos_y
][pixQ.
pos_x
]);

465 
SrcPåP
 = &(
Img
[
pixP
.
pos_y
][pixP.
pos_x
]);

468 
QP
 = 
∂
? ((
MbP
->
qpc
[∂-1] + 
MbQ
->qpc[∂-1] + 1Ë>> 1Ë: (MbP->
qp
 + MbQ->qp + 1) >> 1;

470 
ödexA
 = 
	`iClù3
(0, 
MAX_QP
, 
QP
 + 
AÕhaC0Off£t
);

471 
ödexB
 = 
	`iClù3
(0, 
MAX_QP
, 
QP
 + 
BëaOff£t
);

473 
AÕha
 = 
ALPHA_TABLE
[
ödexA
] * 
bôdïth_sˇÀ
;

474 
Bëa
 = 
BETA_TABLE
 [
ödexB
] * 
bôdïth_sˇÀ
;

475 
ClùTab
 = 
CLIP_TAB
[
ödexA
];

477 
L0
 = 
SrcPåP
[ 0] ;

478 
R0
 = 
SrcPåQ
[ 0] ;

480 if–
	`übs
–
R0
 - 
L0
 ) < 
AÕha
 )

482 
L1
 = 
SrcPåP
[-1];

483 
R1
 = 
SrcPåQ
[ 1];

485 i‡((
	`übs
–
R0
 - 
R1
Ë< 
Bëa
 ) && (übs(
L0
 - 
L1
) < Beta ))

487 
L2
 = 
SrcPåP
[-2];

488 
R2
 = 
SrcPåQ
[ 2];

489 if(
Sång
 == 4 )

491 
RL0
 = 
L0
 + 
R0
;

492 
smÆl_g≠
 = (
	`übs
–
R0
 - 
L0
 ) < ((
AÕha
 >> 2) + 2));

493 
aq
 = ( 
	`übs
–
R0
 - 
R2
Ë< 
Bëa
 ) & 
smÆl_g≠
;

494 
≠
 = ( 
	`übs
–
L0
 - 
L2
Ë< 
Bëa
 ) & 
smÆl_g≠
;

496 i‡(
≠
)

498 
L3
 = 
SrcPåP
[-3];

499 
SrcPåP
[-2 ] = (
img≥l
Ë((((
L3
 + 
L2
Ë<< 1Ë+ L2 + 
L1
 + 
RL0
 + 4) >> 3);

500 
SrcPåP
[-1 ] = (
img≥l
Ë(–
L2
 + 
L1
 + 
L0
 + 
R0
 + 2) >> 2);

501 
SrcPåP
[ 0 ] = (
img≥l
Ë(–
R1
 + ((
L1
 + 
RL0
Ë<< 1Ë+ 
L2
 + 4) >> 3);

505 
SrcPåP
[ 0 ] = (
img≥l
Ë(((
L1
 << 1Ë+ 
L0
 + 
R1
 + 2) >> 2) ;

508 i‡(
aq
)

510 
img≥l
 
R3
 = 
SrcPåQ
[ 3];

511 
SrcPåQ
[ 0 ] = (
img≥l
Ë(–
L1
 + ((
R1
 + 
RL0
Ë<< 1Ë+ 
R2
 + 4) >> 3);

512 
SrcPåQ
[ 1 ] = (
img≥l
Ë(–
R2
 + 
R0
 + 
R1
 + 
L0
 + 2) >> 2);

513 
SrcPåQ
[ 2 ] = (
img≥l
Ë((((
R3
 + 
R2
Ë<< 1Ë+ R2 + 
R1
 + 
RL0
 + 4) >> 3);

517 
SrcPåQ
[ 0 ] = (
img≥l
Ë(((
R1
 << 1Ë+ 
R0
 + 
L1
 + 2) >> 2);

522 
RL0
 = (
L0
 + 
R0
 + 1) >> 1;

523 
aq
 = (
	`übs
–
R0
 - 
R2
Ë< 
Bëa
);

524 
≠
 = (
	`übs
–
L0
 - 
L2
Ë< 
Bëa
);

526 
C0
 = 
ClùTab
[ 
Sång
 ] * 
bôdïth_sˇÀ
;

527 
tc0
 = (
C0
 + 
≠
 + 
aq
) ;

528 
dif
 = 
	`iClù3
–-
tc0
,Åc0, (((
R0
 - 
L0
Ë<< 2Ë+ (
L1
 - 
R1
) + 4) >> 3) ;

530 if–
≠
 && (
C0
 != 0))

531 *(
SrcPåP
 - 1Ë+
	`iClù3
–-
C0
, C0, ( 
L2
 + 
RL0
 - (
L1
 << 1)) >> 1 ) ;

533 i‡(
dif
)

535 *
SrcPåP
 = (
img≥l
Ë
	`iClù1
 (
max_img≥l_vÆue
, 
L0
 + 
dif
) ;

536 *
SrcPåQ
 = (
img≥l
Ë
	`iClù1
 (
max_img≥l_vÆue
, 
R0
 - 
dif
) ;

539 if–
aq
 && (
C0
 != 0))

540 *(
SrcPåQ
 + 1Ë+
	`iClù3
–-
C0
, C0, ( 
R2
 + 
RL0
 - (
R1
 << 1)) >> 1 ) ;

548 
	}
}

556 
	$edge_lo›_luma_h‹_MBAff
(
Cﬁ‹Pœ√
 
∂
, 
img≥l
** 
Img
, 
byã
 *
Såígth
, 
Ma¸oblock
 *
MbQ
,

557 
edge
, 
St‹abÀPi˘uª
 *
p
)

559 
width
 = 
p
->
iLumaSåide
;

560 
≥l
, 
Sång
 ;

561 
PñNum
 = 
∂
? 
≥ um_¸
[1][
p
->
chroma_f‹m©_idc
] : 
MB_BLOCK_SIZE
;

563 
yQ
 = (
edge
 < 
MB_BLOCK_SIZE
 ?Édge : 1);

565 
PixñPos
 
pixP
, 
pixQ
;

567 
VideoP¨amëîs
 *
p_Vid
 = 
MbQ
->p_Vid;

568 
bôdïth_sˇÀ
 = 
∂
? 
p_Vid
->bôdïth_sˇÀ[
IS_CHROMA
] :Ö_Vid->bôdïth_sˇÀ[
IS_LUMA
];

569 
max_img≥l_vÆue
 = 
p_Vid
->
max_≥l_vÆue_comp
[
∂
];

571 
	`gëAffNeighbour
(
MbQ
, 0, 
yQ
 - 1, 
p_Vid
->
mb_size
[
IS_LUMA
], &
pixP
);

573 i‡(
pixP
.
avaûabÀ
 || (
MbQ
->
DFDißbÀIdc
 == 0))

575 
AÕhaC0Off£t
 = 
MbQ
->
DFAÕhaC0Off£t
;

576 
BëaOff£t
 = 
MbQ
->
DFBëaOff£t
;

578 
Ma¸oblock
 *
MbP
 = &(
p_Vid
->
mb_d©a
[
pixP
.
mb_addr
]);

580 
öcQ
 = ((
MbP
->
mb_fõld
 && !
MbQ
->mb_fõldË? 2 * 
width
 : width);

581 
öcP
 = ((
MbQ
->
mb_fõld
 && !
MbP
->mb_fõldË? 2 * 
width
 : width);

584 
QP
 = 
∂
? ((
MbP
->
qpc
[∂ - 1] + 
MbQ
->qpc[∂ - 1] + 1Ë>> 1Ë: (MbP->
qp
 + MbQ->qp + 1) >> 1;

586 
ödexA
 = 
	`iClù3
(0, 
MAX_QP
, 
QP
 + 
AÕhaC0Off£t
);

587 
ödexB
 = 
	`iClù3
(0, 
MAX_QP
, 
QP
 + 
BëaOff£t
);

589 
AÕha
 = 
ALPHA_TABLE
[
ödexA
] * 
bôdïth_sˇÀ
;

590 
Bëa
 = 
BETA_TABLE
 [
ödexB
] * 
bôdïth_sˇÀ
;

592 i‡((
AÕha
 | 
Bëa
 )!= 0)

594 c⁄° 
byã
* 
ClùTab
 = 
CLIP_TAB
[
ödexA
];

595 
	`gëAffNeighbour
(
MbQ
, 0, 
yQ
, 
p_Vid
->
mb_size
[
IS_LUMA
], &
pixQ
);

597  
≥l
 = 0 ;Öñ < 
PñNum
 ; ++pel )

599 if–(
Sång
 = 
Såígth
[
≥l
]) != 0)

601 
img≥l
 *
SrcPåQ
 = &(
Img
[
pixQ
.
pos_y
][pixQ.
pos_x
]);

602 
img≥l
 *
SrcPåP
 = &(
Img
[
pixP
.
pos_y
][pixP.
pos_x
]);

604 
img≥l
 
L0
 = *
SrcPåP
;

605 
img≥l
 
R0
 = *
SrcPåQ
;

607 if–
	`übs
–
R0
 - 
L0
 ) < 
AÕha
 )

609 
img≥l
 
L1
 = 
SrcPåP
[-
öcP
];

610 
img≥l
 
R1
 = 
SrcPåQ
[ 
öcQ
];

612 i‡((
	`übs
–
R0
 - 
R1
Ë< 
Bëa
 ) && (übs(
L0
 - 
L1
) < Beta ))

614 
img≥l
 
L2
 = 
SrcPåP
[-
öcP
*2];

615 
img≥l
 
R2
 = 
SrcPåQ
[ 
öcQ
*2];

616 if(
Sång
 == 4 )

618 
RL0
 = 
L0
 + 
R0
;

619 
smÆl_g≠
 = (
	`übs
–
R0
 - 
L0
 ) < ((
AÕha
 >> 2) + 2));

620 
aq
 = ( 
	`übs
–
R0
 - 
R2
Ë< 
Bëa
 ) & 
smÆl_g≠
;

621 
≠
 = ( 
	`übs
–
L0
 - 
L2
Ë< 
Bëa
 ) & 
smÆl_g≠
;

623 i‡(
≠
)

625 
img≥l
 
L3
 = 
SrcPåP
[-
öcP
*3];

626 
SrcPåP
[-
öcP
 * 2] = (
img≥l
Ë((((
L3
 + 
L2
Ë<< 1Ë+ L2 + 
L1
 + 
RL0
 + 4) >> 3);

627 
SrcPåP
[-
öcP
 ] = (
img≥l
Ë(–
L2
 + 
L1
 + 
L0
 + 
R0
 + 2) >> 2);

628 
SrcPåP
[ 0 ] = (
img≥l
Ë(–
R1
 + ((
L1
 + 
RL0
Ë<< 1Ë+ 
L2
 + 4) >> 3);

632 
SrcPåP
[ 0 ] = (
img≥l
Ë(((
L1
 << 1Ë+ 
L0
 + 
R1
 + 2) >> 2) ;

635 i‡(
aq
)

637 
img≥l
 
R3
 = 
SrcPåQ
[ 
öcQ
*3];

638 
SrcPåQ
[ 0 ] = (
img≥l
Ë(–
L1
 + ((
R1
 + 
RL0
Ë<< 1Ë+ 
R2
 + 4) >> 3);

639 
SrcPåQ
[ 
öcQ
 ] = (
img≥l
Ë(–
R2
 + 
R0
 + 
R1
 + 
L0
 + 2) >> 2);

640 
SrcPåQ
[ 
öcQ
 * 2 ] = (
img≥l
Ë((((
R3
 + 
R2
Ë<< 1Ë+ R2 + 
R1
 + 
RL0
 + 4) >> 3);

644 
SrcPåQ
[ 0 ] = (
img≥l
Ë(((
R1
 << 1Ë+ 
R0
 + 
L1
 + 2) >> 2);

649 
RL0
 = (
L0
 + 
R0
 + 1) >> 1;

650 
aq
 = (
	`übs
–
R0
 - 
R2
Ë< 
Bëa
);

651 
≠
 = (
	`übs
–
L0
 - 
L2
Ë< 
Bëa
);

653 
C0
 = 
ClùTab
[ 
Sång
 ] * 
bôdïth_sˇÀ
;

654 
tc0
 = (
C0
 + 
≠
 + 
aq
) ;

655 
dif
 = 
	`iClù3
–-
tc0
,Åc0, (((
R0
 - 
L0
Ë<< 2Ë+ (
L1
 - 
R1
) + 4) >> 3) ;

657 if–
≠
 && (
C0
 != 0))

658 *(
SrcPåP
 - 
öcP
Ë+
	`iClù3
–-
C0
, C0, ( 
L2
 + 
RL0
 - (
L1
 << 1)) >> 1 ) ;

660 i‡(
dif
)

662 *
SrcPåP
 = (
img≥l
Ë
	`iClù1
 (
max_img≥l_vÆue
, 
L0
 + 
dif
) ;

663 *
SrcPåQ
 = (
img≥l
Ë
	`iClù1
 (
max_img≥l_vÆue
, 
R0
 - 
dif
) ;

666 if–
aq
 && (
C0
 != 0))

667 *(
SrcPåQ
 + 
öcQ
Ë+
	`iClù3
–-
C0
, C0, ( 
R2
 + 
RL0
 - (
R1
 << 1)) >> 1 ) ;

672 
pixP
.
pos_x
++;

673 
pixQ
.
pos_x
++;

677 
	}
}

687 
	$edge_lo›_chroma_vî_MBAff
(
img≥l
** 
Img
, 
byã
 *
Såígth
, 
Ma¸oblock
 *
MbQ
, 
edge
, 
uv
, 
St‹abÀPi˘uª
 *
p
)

689 
≥l
, 
Sång
 ;

691 
img≥l
 
L1
, 
L0
, 
R0
, 
R1
;

692 
AÕha
 = 0, 
Bëa
 = 0;

693 c⁄° 
byã
* 
ClùTab
 = 
NULL
;

694 
ödexA
, 
ödexB
;

695 
VideoP¨amëîs
 *
p_Vid
 = 
MbQ
->p_Vid;

696 
PñNum
 = 
≥ um_¸
[0][
p
->
chroma_f‹m©_idc
];

697 
SåígthIdx
;

698 
QP
;

699 
xQ
 = 
edge
, 
yQ
;

700 
PixñPos
 
pixP
, 
pixQ
;

701 
bôdïth_sˇÀ
 = 
p_Vid
->bôdïth_sˇÀ[
IS_CHROMA
];

702 
max_img≥l_vÆue
 = 
p_Vid
->
max_≥l_vÆue_comp
[
uv
 + 1];

704 
AÕhaC0Off£t
 = 
MbQ
->
DFAÕhaC0Off£t
;

705 
BëaOff£t
 = 
MbQ
->
DFBëaOff£t
;

706 
Ma¸oblock
 *
MbP
;

707 
img≥l
 *
SrcPåP
, *
SrcPåQ
;

710  
≥l
 = 0 ;Öñ < 
PñNum
 ; ++pel )

712 
yQ
 = 
≥l
;

713 
	`gëAffNeighbour
(
MbQ
, 
xQ
, 
yQ
, 
p_Vid
->
mb_size
[
IS_CHROMA
], &
pixQ
);

714 
	`gëAffNeighbour
(
MbQ
, 
xQ
 - 1, 
yQ
, 
p_Vid
->
mb_size
[
IS_CHROMA
], &
pixP
);

715 
MbP
 = &(
p_Vid
->
mb_d©a
[
pixP
.
mb_addr
]);

716 
SåígthIdx
 = (
PñNum
 =8Ë? ((
MbQ
->
mb_fõld
 && !
MbP
->mb_fõldË? 
≥l
 << 1 :((pel >> 1) << 2) + (pel & 0x01)) :Öel;

718 i‡(
pixP
.
avaûabÀ
 || (
MbQ
->
DFDißbÀIdc
 == 0))

720 if–(
Sång
 = 
Såígth
[
SåígthIdx
]) != 0)

722 
SrcPåQ
 = &(
Img
[
pixQ
.
pos_y
][pixQ.
pos_x
]);

723 
SrcPåP
 = &(
Img
[
pixP
.
pos_y
][pixP.
pos_x
]);

726 
QP
 = (
MbP
->
qpc
[
uv
] + 
MbQ
->qpc[uv] + 1) >> 1;

728 
ödexA
 = 
	`iClù3
(0, 
MAX_QP
, 
QP
 + 
AÕhaC0Off£t
);

729 
ödexB
 = 
	`iClù3
(0, 
MAX_QP
, 
QP
 + 
BëaOff£t
);

731 
AÕha
 = 
ALPHA_TABLE
[
ödexA
] * 
bôdïth_sˇÀ
;

732 
Bëa
 = 
BETA_TABLE
 [
ödexB
] * 
bôdïth_sˇÀ
;

733 
ClùTab
 = 
CLIP_TAB
[
ödexA
];

735 
L0
 = *
SrcPåP
;

736 
R0
 = *
SrcPåQ
;

738 if–
	`übs
–
R0
 - 
L0
 ) < 
AÕha
 )

740 
L1
 = 
SrcPåP
[-1];

741 
R1
 = 
SrcPåQ
[ 1];

742 if–((
	`übs
–
R0
 - 
R1
Ë- 
Bëa
 < 0Ë&& (übs(
L0
 - 
L1
) - Beta < 0 )) )

744 if–
Sång
 == 4 )

746 
SrcPåQ
[0] = (
img≥l
Ë–((
R1
 << 1Ë+ 
R0
 + 
L1
 + 2) >> 2 );

747 
SrcPåP
[0] = (
img≥l
Ë–((
L1
 << 1Ë+ 
L0
 + 
R1
 + 2) >> 2 );

751 
C0
 = 
ClùTab
[ 
Sång
 ] * 
bôdïth_sˇÀ
;

752 
tc0
 = (
C0
 + 1);

753 
dif
 = 
	`iClù3
–-
tc0
,Åc0, ( ((
R0
 - 
L0
Ë<< 2Ë+ (
L1
 - 
R1
) + 4) >> 3 );

755 i‡(
dif
)

757 *
SrcPåP
 = (
img≥l
Ë
	`iClù1
 ( 
max_img≥l_vÆue
, 
L0
 + 
dif
 );

758 *
SrcPåQ
 = (
img≥l
Ë
	`iClù1
 ( 
max_img≥l_vÆue
, 
R0
 - 
dif
 );

766 
	}
}

774 
	$edge_lo›_chroma_h‹_MBAff
(
img≥l
** 
Img
, 
byã
 *
Såígth
, 
Ma¸oblock
 *
MbQ
, 
edge
, 
uv
, 
St‹abÀPi˘uª
 *
p
)

776 
VideoP¨amëîs
 *
p_Vid
 = 
MbQ
->p_Vid;

777 
PñNum
 = 
≥ um_¸
[1][
p
->
chroma_f‹m©_idc
];

778 
yQ
 = (
edge
 < 
MB_BLOCK_SIZE
?Édge : 1);

779 
PixñPos
 
pixP
, 
pixQ
;

780 
bôdïth_sˇÀ
 = 
p_Vid
->bôdïth_sˇÀ[
IS_CHROMA
];

781 
max_img≥l_vÆue
 = 
p_Vid
->
max_≥l_vÆue_comp
[
uv
 + 1];

783 
AÕhaC0Off£t
 = 
MbQ
->
DFAÕhaC0Off£t
;

784 
BëaOff£t
 = 
MbQ
->
DFBëaOff£t
;

785 
width
 = 
p
->
iChromaSåide
;

787 
	`gëAffNeighbour
(
MbQ
, 0, 
yQ
 - 1, 
p_Vid
->
mb_size
[
IS_CHROMA
], &
pixP
);

788 
	`gëAffNeighbour
(
MbQ
, 0, 
yQ
, 
p_Vid
->
mb_size
[
IS_CHROMA
], &
pixQ
);

790 i‡(
pixP
.
avaûabÀ
 || (
MbQ
->
DFDißbÀIdc
 == 0))

792 
Ma¸oblock
 *
MbP
 = &(
p_Vid
->
mb_d©a
[
pixP
.
mb_addr
]);

794 
öcQ
 = ((
MbP
->
mb_fõld
 && !
MbQ
->mb_fõldË? 2 * 
width
 : width);

795 
öcP
 = ((
MbQ
->
mb_fõld
 && !
MbP
->mb_fõldË? 2 * 
width
 : width);

798 
QP
 = (
MbP
->
qpc
[
uv
] + 
MbQ
->qpc[uv] + 1) >> 1;

800 
ödexA
 = 
	`iClù3
(0, 
MAX_QP
, 
QP
 + 
AÕhaC0Off£t
);

801 
ödexB
 = 
	`iClù3
(0, 
MAX_QP
, 
QP
 + 
BëaOff£t
);

803 
AÕha
 = 
ALPHA_TABLE
[
ödexA
] * 
bôdïth_sˇÀ
;

804 
Bëa
 = 
BETA_TABLE
 [
ödexB
] * 
bôdïth_sˇÀ
;

806 i‡((
AÕha
 | 
Bëa
 )!= 0)

808 c⁄° 
byã
* 
ClùTab
 = 
CLIP_TAB
[
ödexA
];

809 
≥l
, 
Sång
 ;

810 
SåígthIdx
;

811  
≥l
 = 0 ;Öñ < 
PñNum
 ; ++pel )

813 
SåígthIdx
 = (
PñNum
 =8Ë? ((
MbQ
->
mb_fõld
 && !
MbP
->mb_fõldË? 
≥l
 << 1 :((pel >> 1) << 2) + (pel & 0x01)) :Öel;

815 if–(
Sång
 = 
Såígth
[
SåígthIdx
]) != 0)

817 
img≥l
 *
SrcPåQ
 = &(
Img
[
pixQ
.
pos_y
][pixQ.
pos_x
]);

818 
img≥l
 *
SrcPåP
 = &(
Img
[
pixP
.
pos_y
][pixP.
pos_x
]);

820 
img≥l
 
L0
 = *
SrcPåP
;

821 
img≥l
 
R0
 = *
SrcPåQ
;

823 if–
	`übs
–
R0
 - 
L0
 ) < 
AÕha
 )

825 
img≥l
 
L1
 = 
SrcPåP
[-
öcP
];

826 
img≥l
 
R1
 = 
SrcPåQ
[ 
öcQ
];

827 if–((
	`übs
–
R0
 - 
R1
Ë- 
Bëa
 < 0Ë&& (übs(
L0
 - 
L1
) - Beta < 0 )) )

829 if–
Sång
 == 4 )

831 
SrcPåQ
[0] = (
img≥l
Ë–((
R1
 << 1Ë+ 
R0
 + 
L1
 + 2) >> 2 );

832 
SrcPåP
[0] = (
img≥l
Ë–((
L1
 << 1Ë+ 
L0
 + 
R1
 + 2) >> 2 );

836 
C0
 = 
ClùTab
[ 
Sång
 ] * 
bôdïth_sˇÀ
;

837 
tc0
 = (
C0
 + 1);

838 
dif
 = 
	`iClù3
–-
tc0
,Åc0, ( ((
R0
 - 
L0
Ë<< 2Ë+ (
L1
 - 
R1
) + 4) >> 3 );

840 i‡(
dif
)

842 *
SrcPåP
 = (
img≥l
Ë
	`iClù1
 ( 
max_img≥l_vÆue
, 
L0
 + 
dif
 );

843 *
SrcPåQ
 = (
img≥l
Ë
	`iClù1
 ( 
max_img≥l_vÆue
, 
R0
 - 
dif
 );

849 
pixP
.
pos_x
++;

850 
pixQ
.
pos_x
++;

854 
	}
}

863 
	$gë_db_°ªngth_mbaff
(
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
p
, 
MbQAddr
)

865 
Ma¸oblock
 *
MbQ
 = &(
p_Vid
->
mb_d©a
[
MbQAddr
]) ;

868 i‡(
MbQ
->
DFDißbÀIdc
 == 1)

870 
MbQ
->
DeblockCÆl
 = 0;

874 
edge
;

876 
mb_x
, 
mb_y
;

878 
fûãrN⁄8x8LumaEdgesFœg
[4] = {1,1,1,1};

879 
fûãrLe·MbEdgeFœg
;

880 
fûãrT›MbEdgeFœg
;

882 
Sli˚
 *
cuºSli˚
 = 
MbQ
->
p_Sli˚
;

883 
mvlimô
 = ((
p
->
°ru˘uª
!=
FRAME
Ë|| (p->
mb_aff_‰ame_Êag
 && 
MbQ
->
mb_fõld
)) ? 2 : 4;

885 
£q_∑ømëî_£t_rb•_t
 *
a˘ive_•s
 = 
p_Vid
->active_sps;

887 
MbQ
->
DeblockCÆl
 = 1;

888 
	`gë_mb_pos
 (
p_Vid
, 
MbQAddr
,Ö_Vid->
mb_size
[
IS_LUMA
], &
mb_x
, &
mb_y
);

890 i‡(
MbQ
->
mb_ty≥
 =
I8MB
)

891 
	`as£π
(
MbQ
->
luma_å™sf‹m_size_8x8_Êag
);

893 
fûãrN⁄8x8LumaEdgesFœg
[1] =

894 
fûãrN⁄8x8LumaEdgesFœg
[3] = !(
MbQ
->
luma_å™sf‹m_size_8x8_Êag
);

896 
fûãrLe·MbEdgeFœg
 = (
mb_x
 != 0);

897 
fûãrT›MbEdgeFœg
 = (
mb_y
 != 0);

899 i‡(
p
->
mb_aff_‰ame_Êag
 && 
mb_y
 =
MB_BLOCK_SIZE
 && 
MbQ
->
mb_fõld
)

900 
fûãrT›MbEdgeFœg
 = 0;

902 i‡(
MbQ
->
DFDißbÀIdc
==2)

905 
fûãrLe·MbEdgeFœg
 = 
MbQ
->
mbAvaûA
;

907 
fûãrT›MbEdgeFœg
 = (
p
->
mb_aff_‰ame_Êag
 && !
MbQ
->
mb_fõld
 && (
MbQAddr
 & 0x01)Ë? 1 : MbQ->
mbAvaûB
;

910 
	`CheckAvaûabûôyOfNeighb‹sMBAFF
(
MbQ
);

913 
edge
 = 0;Édge < 4 ; ++edge )

916 i‡(
MbQ
->
cbp
 == 0)

918 i‡(
fûãrN⁄8x8LumaEdgesFœg
[
edge
] =0 && 
a˘ive_•s
->
chroma_f‹m©_idc
 !
YUV444
)

920 i‡(
edge
 > 0)

922 i‡(((
MbQ
->
mb_ty≥
 =
PSKIP
 && 
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
Ë|| (MbQ->mb_ty≥ =
P16x16
Ë|| (MbQ->mb_ty≥ =
P16x8
)))

924 i‡((
edge
 & 0x01Ë&& ((
MbQ
->
mb_ty≥
 =
P8x16
Ë|| (
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
 && MbQ->mb_ty≥ =
BSKIP_DIRECT
 && 
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
)))

929 if–
edge
 || 
fûãrLe·MbEdgeFœg
 )

932 
p_Vid
->
	`GëSåígthVî
(
MbQ
, 
edge
, 
mvlimô
, 
p
);

937  
edge
 = 0;Édge < 4 ; ++edge )

940 i‡(
MbQ
->
cbp
 == 0)

942 i‡(
fûãrN⁄8x8LumaEdgesFœg
[
edge
] =0 && 
a˘ive_•s
->
chroma_f‹m©_idc
==
YUV420
)

944 i‡(
edge
 > 0)

946 i‡(((
MbQ
->
mb_ty≥
 =
PSKIP
 && 
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
Ë|| (MbQ->mb_ty≥ =
P16x16
Ë|| (MbQ->mb_ty≥ =
P8x16
)))

948 i‡((
edge
 & 0x01Ë&& ((
MbQ
->
mb_ty≥
 =
P16x8
Ë|| (
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
 && MbQ->mb_ty≥ =
BSKIP_DIRECT
 && 
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
)))

953 if–
edge
 || 
fûãrT›MbEdgeFœg
 )

955 
p_Vid
->
	`GëSåígthH‹
(
MbQ
, 
edge
, 
mvlimô
, 
p
);

959 
MbQ
->
DeblockCÆl
 = 0;

961 
	}
}

970 
	$≥rf‹m_db_mbaff
(
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
p
, 
MbQAddr
)

972 
Ma¸oblock
 *
MbQ
 = &(
p_Vid
->
mb_d©a
[
MbQAddr
]) ;

975 i‡(
MbQ
->
DFDißbÀIdc
 == 1)

977 
MbQ
->
DeblockCÆl
 = 0;

981 
edge
;

983 
mb_x
, 
mb_y
;

985 
fûãrN⁄8x8LumaEdgesFœg
[4] = {1,1,1,1};

986 
fûãrLe·MbEdgeFœg
;

987 
fûãrT›MbEdgeFœg
;

988 
edge_¸
;

990 
img≥l
 **
imgY
 = 
p
->imgY;

991 
img≥l
 ***
imgUV
 = 
p
->imgUV;

992 
Sli˚
 *
cuºSli˚
 = 
MbQ
->
p_Sli˚
;

993 
mvlimô
 = ((
p
->
°ru˘uª
!=
FRAME
Ë|| (p->
mb_aff_‰ame_Êag
 && 
MbQ
->
mb_fõld
)) ? 2 : 4;

995 
£q_∑ømëî_£t_rb•_t
 *
a˘ive_•s
 = 
p_Vid
->active_sps;

997 
MbQ
->
DeblockCÆl
 = 1;

998 
	`gë_mb_pos
 (
p_Vid
, 
MbQAddr
,Ö_Vid->
mb_size
[
IS_LUMA
], &
mb_x
, &
mb_y
);

1000 i‡(
MbQ
->
mb_ty≥
 =
I8MB
)

1001 
	`as£π
(
MbQ
->
luma_å™sf‹m_size_8x8_Êag
);

1003 
fûãrN⁄8x8LumaEdgesFœg
[1] =

1004 
fûãrN⁄8x8LumaEdgesFœg
[3] = !(
MbQ
->
luma_å™sf‹m_size_8x8_Êag
);

1006 
fûãrLe·MbEdgeFœg
 = (
mb_x
 != 0);

1007 
fûãrT›MbEdgeFœg
 = (
mb_y
 != 0);

1009 i‡(
p
->
mb_aff_‰ame_Êag
 && 
mb_y
 =
MB_BLOCK_SIZE
 && 
MbQ
->
mb_fõld
)

1010 
fûãrT›MbEdgeFœg
 = 0;

1012 i‡(
MbQ
->
DFDißbÀIdc
==2)

1015 
fûãrLe·MbEdgeFœg
 = 
MbQ
->
mbAvaûA
;

1017 
fûãrT›MbEdgeFœg
 = (
p
->
mb_aff_‰ame_Êag
 && !
MbQ
->
mb_fõld
 && (
MbQAddr
 & 0x01)Ë? 1 : MbQ->
mbAvaûB
;

1020 
	`CheckAvaûabûôyOfNeighb‹sMBAFF
(
MbQ
);

1023 
edge
 = 0;Édge < 4 ; ++edge )

1026 i‡(
MbQ
->
cbp
 == 0)

1028 i‡(
fûãrN⁄8x8LumaEdgesFœg
[
edge
] =0 && 
a˘ive_•s
->
chroma_f‹m©_idc
 !
YUV444
)

1030 i‡(
edge
 > 0 && (
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
 || cuºSli˚->¶i˚_ty≥ =
B_SLICE
))

1032 i‡(((
MbQ
->
mb_ty≥
 =
PSKIP
 && 
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
Ë|| (MbQ->mb_ty≥ =
P16x16
Ë|| (MbQ->mb_ty≥ =
P16x8
)))

1034 i‡((
edge
 & 0x01Ë&& ((
MbQ
->
mb_ty≥
 =
P8x16
Ë|| (
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
 && MbQ->mb_ty≥ =
BSKIP_DIRECT
 && 
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
)))

1039 if–
edge
 || 
fûãrLe·MbEdgeFœg
 )

1041 
byã
 *
Såígth
 = 
MbQ
->
°ªngth_vî
[
edge
];

1043 i‡((*((
öt64
 *Ë
Såígth
)) || ((*(((int64 *) Strength) + 1))))

1045 i‡(
fûãrN⁄8x8LumaEdgesFœg
[
edge
])

1047 
p_Vid
->
	`EdgeLo›LumaVî
–
PLANE_Y
, 
imgY
, 
Såígth
, 
MbQ
, 
edge
 << 2);

1048 if(
cuºSli˚
->
chroma444_nŸ_£∑øã
)

1050 
p_Vid
->
	`EdgeLo›LumaVî
(
PLANE_U
, 
imgUV
[0], 
Såígth
, 
MbQ
, 
edge
 << 2);

1051 
p_Vid
->
	`EdgeLo›LumaVî
(
PLANE_V
, 
imgUV
[1], 
Såígth
, 
MbQ
, 
edge
 << 2);

1054 i‡(
a˘ive_•s
->
chroma_f‹m©_idc
==
YUV420
 ||á˘ive_•s->chroma_f‹m©_idc==
YUV422
)

1056 
edge_¸
 = 
chroma_edge
[0][
edge
][
p
->
chroma_f‹m©_idc
];

1057 if–(
imgUV
 !
NULL
Ë&& (
edge_¸
 >= 0))

1059 
p_Vid
->
	`EdgeLo›ChromaVî
–
imgUV
[0], 
Såígth
, 
MbQ
, 
edge_¸
, 0, 
p
);

1060 
p_Vid
->
	`EdgeLo›ChromaVî
–
imgUV
[1], 
Såígth
, 
MbQ
, 
edge_¸
, 1, 
p
);

1068  
edge
 = 0;Édge < 4 ; ++edge )

1071 i‡(
MbQ
->
cbp
 == 0)

1073 i‡(
fûãrN⁄8x8LumaEdgesFœg
[
edge
] =0 && 
a˘ive_•s
->
chroma_f‹m©_idc
==
YUV420
)

1075 i‡(
edge
 > 0 && (
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
 || cuºSli˚->¶i˚_ty≥ =
B_SLICE
))

1077 i‡(((
MbQ
->
mb_ty≥
 =
PSKIP
 && 
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
Ë|| (MbQ->mb_ty≥ =
P16x16
Ë|| (MbQ->mb_ty≥ =
P8x16
)))

1079 i‡((
edge
 & 0x01Ë&& ((
MbQ
->
mb_ty≥
 =
P16x8
Ë|| (
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
 && MbQ->mb_ty≥ =
BSKIP_DIRECT
 && 
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
)))

1084 if–
edge
 || 
fûãrT›MbEdgeFœg
 )

1086 
byã
 *
Såígth
 = 
MbQ
->
°ªngth_h‹
[
edge
];

1088 i‡((*((
öt64
 *Ë
Såígth
)) || ((*(((int64 *) Strength) + 1))))

1090 i‡(
fûãrN⁄8x8LumaEdgesFœg
[
edge
])

1092 
p_Vid
->
	`EdgeLo›LumaH‹
–
PLANE_Y
, 
imgY
, 
Såígth
, 
MbQ
, 
edge
 << 2, 
p
) ;

1093 if(
cuºSli˚
->
chroma444_nŸ_£∑øã
)

1095 
p_Vid
->
	`EdgeLo›LumaH‹
(
PLANE_U
, 
imgUV
[0], 
Såígth
, 
MbQ
, 
edge
 << 2, 
p
);

1096 
p_Vid
->
	`EdgeLo›LumaH‹
(
PLANE_V
, 
imgUV
[1], 
Såígth
, 
MbQ
, 
edge
 << 2, 
p
);

1100 i‡(
a˘ive_•s
->
chroma_f‹m©_idc
==
YUV420
 ||á˘ive_•s->chroma_f‹m©_idc==
YUV422
)

1102 
edge_¸
 = 
chroma_edge
[1][
edge
][
p
->
chroma_f‹m©_idc
];

1103 if–(
imgUV
 !
NULL
Ë&& (
edge_¸
 >= 0))

1105 
p_Vid
->
	`EdgeLo›ChromaH‹
–
imgUV
[0], 
Såígth
, 
MbQ
, 
edge_¸
, 0, 
p
);

1106 
p_Vid
->
	`EdgeLo›ChromaH‹
–
imgUV
[1], 
Såígth
, 
MbQ
, 
edge_¸
, 1, 
p
);

1111 i‡(!
edge
 && !
MbQ
->
mb_fõld
 && MbQ->
mixedModeEdgeFœg
)

1114 
MbQ
->
DeblockCÆl
 = 2;

1115 
p_Vid
->
	`GëSåígthH‹
(
MbQ
, 4, 
mvlimô
, 
p
);

1119 i‡(
fûãrN⁄8x8LumaEdgesFœg
[
edge
])

1122 
p_Vid
->
	`EdgeLo›LumaH‹
(
PLANE_Y
, 
imgY
, 
Såígth
, 
MbQ
, 
MB_BLOCK_SIZE
, 
p
) ;

1123 if(
cuºSli˚
->
chroma444_nŸ_£∑øã
)

1125 
p_Vid
->
	`EdgeLo›LumaH‹
(
PLANE_U
, 
imgUV
[0], 
Såígth
, 
MbQ
, 
MB_BLOCK_SIZE
, 
p
) ;

1126 
p_Vid
->
	`EdgeLo›LumaH‹
(
PLANE_V
, 
imgUV
[1], 
Såígth
, 
MbQ
, 
MB_BLOCK_SIZE
, 
p
) ;

1129 i‡(
a˘ive_•s
->
chroma_f‹m©_idc
==
YUV420
 ||á˘ive_•s->chroma_f‹m©_idc==
YUV422
)

1131 
edge_¸
 = 
chroma_edge
[1][
edge
][
p
->
chroma_f‹m©_idc
];

1132 if–(
imgUV
 !
NULL
Ë&& (
edge_¸
 >= 0))

1134 
p_Vid
->
	`EdgeLo›ChromaH‹
–
imgUV
[0], 
Såígth
, 
MbQ
, 
MB_BLOCK_SIZE
, 0, 
p
) ;

1135 
p_Vid
->
	`EdgeLo›ChromaH‹
–
imgUV
[1], 
Såígth
, 
MbQ
, 
MB_BLOCK_SIZE
, 1, 
p
) ;

1139 
MbQ
->
DeblockCÆl
 = 1;

1144 
MbQ
->
DeblockCÆl
 = 0;

1146 
	}
}

	@ldecod/src/loop_filter_normal.c

23 
	~"globÆ.h
"

24 
	~"image.h
"

25 
	~"mb_ac˚ss.h
"

26 
	~"lo›fûãr.h
"

27 
	~"lo›_fûãr.h
"

29 
gë_°ªngth_vî
 (
Ma¸oblock
 *
MbQ
, 
edge
, 
mvlimô
, 
St‹abÀPi˘uª
 *
p
);

30 
gë_°ªngth_h‹
 (
Ma¸oblock
 *
MbQ
, 
edge
, 
mvlimô
, 
St‹abÀPi˘uª
 *
p
);

31 
edge_lo›_luma_vî
 (
Cﬁ‹Pœ√
 
∂
, 
img≥l
** 
Img
, 
byã
 *
Såígth
, 
Ma¸oblock
 *
MbQ
, 
edge
);

32 
edge_lo›_luma_h‹
 (
Cﬁ‹Pœ√
 
∂
, 
img≥l
** 
Img
, 
byã
 *
Såígth
, 
Ma¸oblock
 *
MbQ
, 
edge
, 
St‹abÀPi˘uª
 *
p
);

33 
edge_lo›_chroma_vî
 (
img≥l
** 
Img
, 
byã
 *
Såígth
, 
Ma¸oblock
 *
MbQ
, 
edge
, 
uv
, 
St‹abÀPi˘uª
 *
p
);

34 
edge_lo›_chroma_h‹
 (
img≥l
** 
Img
, 
byã
 *
Såígth
, 
Ma¸oblock
 *
MbQ
, 
edge
, 
uv
, 
St‹abÀPi˘uª
 *
p
);

37 
	$£t_lo›_fûãr_fun˘i⁄s_n‹mÆ
(
VideoP¨amëîs
 *
p_Vid
)

39 
p_Vid
->
GëSåígthVî
 = 
gë_°ªngth_vî
;

40 
p_Vid
->
GëSåígthH‹
 = 
gë_°ªngth_h‹
;

41 
p_Vid
->
EdgeLo›LumaVî
 = 
edge_lo›_luma_vî
;

42 
p_Vid
->
EdgeLo›LumaH‹
 = 
edge_lo›_luma_h‹
;

43 
p_Vid
->
EdgeLo›ChromaVî
 = 
edge_lo›_chroma_vî
;

44 
p_Vid
->
EdgeLo›ChromaH‹
 = 
edge_lo›_chroma_h‹
;

45 
	}
}

48 
Ma¸oblock
* 
	$gë_n⁄_aff_√ighb‹_luma
(
Ma¸oblock
 *
mb
, 
xN
, 
yN
)

50 i‡(
xN
 < 0)

51 (
mb
->
mbÀ·
);

52 i‡(
yN
 < 0)

53 (
mb
->
mbup
);

55 (
mb
);

56 
	}
}

58 
Ma¸oblock
* 
	$gë_n⁄_aff_√ighb‹_chroma
(
Ma¸oblock
 *
mb
, 
xN
, 
yN
, 
block_width
,
block_height
)

60 i‡(
xN
 < 0)

62 i‡(
yN
 < 
block_height
)

63 (
mb
->
mbÀ·
);

65 (
NULL
);

67 i‡(
xN
 < 
block_width
)

69 i‡(
yN
 < 0)

70 (
mb
->
mbup
);

71 i‡(
yN
 < 
block_height
)

72 (
mb
);

74 (
NULL
);

77 (
NULL
);

78 
	}
}

80 
	#gë_x_luma
(
x
Ë(x & 15)

	)

81 
	#gë_y_luma
(
y
Ë(y & 15)

	)

82 
	#gë_pos_x_luma
(
mb
,
x
Ë(mb->
pix_x
 + (x & 15))

	)

83 
	#gë_pos_y_luma
(
mb
,
y
Ë(mb->
pix_y
 + (y & 15))

	)

84 
	#gë_pos_x_chroma
(
mb
,
x
,
max
Ë(mb->
pix_c_x
 + (x & max))

	)

85 
	#gë_pos_y_chroma
(
mb
,
y
,
max
Ë(mb->
pix_c_y
 + (y & max))

	)

93 
	$gë_°ªngth_vî
(
Ma¸oblock
 *
MbQ
, 
edge
, 
mvlimô
, 
St‹abÀPi˘uª
 *
p
)

95 
byã
 *
Såígth
 = 
MbQ
->
°ªngth_vî
[
edge
];

96 
Sli˚
 *
cuºSli˚
 = 
MbQ
->
p_Sli˚
;

97 
SåVÆue
;

98 
BlockPos
 *
PicPos
 = 
MbQ
->
p_Vid
->PicPos;

100 i‡((
cuºSli˚
->
¶i˚_ty≥
==
SP_SLICE
)||(cuºSli˚->¶i˚_ty≥==
SI_SLICE
) )

103 
SåVÆue
 = (
edge
 == 0) ? 4 : 3;

104 
	`mem£t
(
Såígth
, (
byã
Ë
SåVÆue
, 
BLOCK_SIZE
 * (byte));

108 i‡(
MbQ
->
is_öåa_block
 =
FALSE
)

110 
Ma¸oblock
 *
MbP
;

111 
xQ
 = (
edge
 << 2) - 1;

112 
Ma¸oblock
 *
√ighb‹
 = 
	`gë_n⁄_aff_√ighb‹_luma
(
MbQ
, 
xQ
, 0);

113 
MbP
 = (
edge
Ë? 
MbQ
 : 
√ighb‹
;

115 i‡(
edge
 || 
MbP
->
is_öåa_block
 =
FALSE
)

117 i‡(
edge
 && (
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
 && 
MbQ
->
mb_ty≥
 =
PSKIP
))

119 
	`mem£t
(
Såígth
, 0, 
BLOCK_SIZE
 * (
byã
));

121 i‡(
edge
 && ((
MbQ
->
mb_ty≥
 =
P16x16
Ë|| (MbQ->mb_ty≥ =
P16x8
)))

123 
blkP
, 
blkQ
, 
idx
;

125  
idx
 = 0 ; idx < 
MB_BLOCK_SIZE
 ; idx +
BLOCK_SIZE
 )

127 
blkQ
 = 
idx
 + (
edge
);

128 
blkP
 = 
idx
 + (
	`gë_x_luma
(
xQ
) >> 2);

129 i‡((
MbQ
->
s_cbp
[0].
blk
 & (
	`i64_powî2
(
blkQ
Ë| i64_powî2(
blkP
))) != 0)

130 
SåVÆue
 = 2;

132 
SåVÆue
 = 0;

134 
Såígth
[
idx
 >> 2] = 
SåVÆue
;

139 
blkP
, 
blkQ
, 
idx
;

140 
BlockPos
 
mb
 = 
PicPos
[ 
MbQ
->
mbAddrX
 ];

141 
mb
.
x
 <<
BLOCK_SHIFT
;

142 
mb
.
y
 <<
BLOCK_SHIFT
;

144  
idx
 = 0 ; idx < 
MB_BLOCK_SIZE
 ; idx +
BLOCK_SIZE
 )

146 
blkQ
 = 
idx
 + (
edge
);

147 
blkP
 = 
idx
 + (
	`gë_x_luma
(
xQ
) >> 2);

148 i‡(((
MbQ
->
s_cbp
[0].
blk
 & 
	`i64_powî2
(
blkQ
)Ë!0Ë|| ((
MbP
->s_cbp[0].blk & i64_powî2(
blkP
)) != 0))

149 
SåVÆue
 = 2;

152 
blk_y
 = 
mb
.
y
 + (
blkQ
 >> 2);

153 
blk_x
 = 
mb
.
x
 + (
blkQ
 & 3);

154 
blk_y2
 = ()(
	`gë_pos_y_luma
(
√ighb‹
, 0Ë+ 
idx
) >> 2;

155 
blk_x2
 = ()(
	`gë_pos_x_luma
(
√ighb‹
, 
xQ
) ) >> 2;

156 
PicMŸi⁄P¨ams
 *
mv_öfo_p
 = &
p
->
mv_öfo
[
blk_y
 ][
blk_x
 ];

157 
PicMŸi⁄P¨ams
 *
mv_öfo_q
 = &
p
->
mv_öfo
[
blk_y2
][
blk_x2
];

158 
St‹abÀPi˘uªPå
 
ªf_p0
 = 
mv_öfo_p
->
ªf_pic
[
LIST_0
];

159 
St‹abÀPi˘uªPå
 
ªf_q0
 = 
mv_öfo_q
->
ªf_pic
[
LIST_0
];

160 
St‹abÀPi˘uªPå
 
ªf_p1
 = 
mv_öfo_p
->
ªf_pic
[
LIST_1
];

161 
St‹abÀPi˘uªPå
 
ªf_q1
 = 
mv_öfo_q
->
ªf_pic
[
LIST_1
];

163 i‡–((
ªf_p0
==
ªf_q0
Ë&& (
ªf_p1
==
ªf_q1
)) || ((ref_p0==ref_q1) && (ref_p1==ref_q0)))

166 i‡(
ªf_p0
 !
ªf_p1
)

169 i‡(
ªf_p0
 =
ªf_q0
)

171 
SåVÆue
 =

172 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_0
], &
mv_öfo_q
->mv[LIST_0], 
mvlimô
) |

173 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_1
], &
mv_öfo_q
->mv[LIST_1], 
mvlimô
);

177 
SåVÆue
 =

178 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_0
], &
mv_öfo_q
->mv[
LIST_1
], 
mvlimô
) |

179 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_1
], &
mv_öfo_q
->mv[
LIST_0
], 
mvlimô
);

184 
SåVÆue
 = ((

185 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_0
], &
mv_öfo_q
->mv[LIST_0], 
mvlimô
) |

186 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_1
], &
mv_öfo_q
->mv[LIST_1], 
mvlimô
))

188 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_0
], &
mv_öfo_q
->mv[
LIST_1
], 
mvlimô
) |

189 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_1
], &
mv_öfo_q
->mv[
LIST_0
], 
mvlimô
)

194 
SåVÆue
 = 1;

197 
Såígth
[
idx
 >> 2] = 
SåVÆue
;

204 
SåVÆue
 = (
edge
 == 0) ? 4 : 3;

205 
	`mem£t
(
Såígth
, (
byã
Ë
SåVÆue
, 
BLOCK_SIZE
 * (byte));

211 
SåVÆue
 = (
edge
 == 0) ? 4 : 3;

212 
	`mem£t
(
Såígth
, (
byã
Ë
SåVÆue
, 
BLOCK_SIZE
 * (byte));

215 
	}
}

223 
	$gë_°ªngth_h‹
(
Ma¸oblock
 *
MbQ
, 
edge
, 
mvlimô
, 
St‹abÀPi˘uª
 *
p
)

225 
byã
 *
Såígth
 = 
MbQ
->
°ªngth_h‹
[
edge
];

226 
SåVÆue
;

227 
Sli˚
 *
cuºSli˚
 = 
MbQ
->
p_Sli˚
;

228 
BlockPos
 *
PicPos
 = 
MbQ
->
p_Vid
->PicPos;

230 i‡((
cuºSli˚
->
¶i˚_ty≥
==
SP_SLICE
)||(cuºSli˚->¶i˚_ty≥==
SI_SLICE
) )

233 
SåVÆue
 = (
edge
 =0 && (((
p
->
°ru˘uª
==
FRAME
)))) ? 4 : 3;

234 
	`mem£t
(
Såígth
, (
byã
Ë
SåVÆue
, 
BLOCK_SIZE
 * (byte));

238 i‡(
MbQ
->
is_öåa_block
 =
FALSE
)

240 
Ma¸oblock
 *
MbP
;

241 
yQ
 = (
edge
 < 
BLOCK_SIZE
 ? (edge << 2) - 1: 0);

243 
Ma¸oblock
 *
√ighb‹
 = 
	`gë_n⁄_aff_√ighb‹_luma
(
MbQ
, 0, 
yQ
);

245 
MbP
 = (
edge
Ë? 
MbQ
 : 
√ighb‹
;

247 i‡(
edge
 || 
MbP
->
is_öåa_block
 =
FALSE
)

249 i‡(
edge
 && (
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
 && 
MbQ
->
mb_ty≥
 =
PSKIP
))

251 
	`mem£t
(
Såígth
, 0, 
BLOCK_SIZE
 * (
byã
));

253 i‡(
edge
 && ((
MbQ
->
mb_ty≥
 =
P16x16
Ë|| (MbQ->mb_ty≥ =
P8x16
)))

255 
blkP
, 
blkQ
, 
idx
;

257  
idx
 = 0 ; idx < 
BLOCK_SIZE
 ; idx ++ )

259 
blkQ
 = (
yQ
 + 1Ë+ 
idx
;

260 
blkP
 = (
	`gë_y_luma
(
yQ
Ë& 0xFFFCË+ 
idx
;

262 i‡((
MbQ
->
s_cbp
[0].
blk
 & (
	`i64_powî2
(
blkQ
Ë| i64_powî2(
blkP
))) != 0)

263 
SåVÆue
 = 2;

265 
SåVÆue
 = 0;

267 *(*)(
Såígth
 + 
idx
Ë
SåVÆue
;

272 
blkP
, 
blkQ
, 
idx
;

273 
BlockPos
 
mb
 = 
PicPos
[ 
MbQ
->
mbAddrX
 ];

274 
mb
.
x
 <<= 2;

275 
mb
.
y
 <<= 2;

277  
idx
 = 0 ; idx < 
BLOCK_SIZE
 ; idx ++)

279 
blkQ
 = (
yQ
 + 1Ë+ 
idx
;

280 
blkP
 = (
	`gë_y_luma
(
yQ
Ë& 0xFFFCË+ 
idx
;

282 i‡(((
MbQ
->
s_cbp
[0].
blk
 & 
	`i64_powî2
(
blkQ
)Ë!0Ë|| ((
MbP
->s_cbp[0].blk & i64_powî2(
blkP
)) != 0))

283 
SåVÆue
 = 2;

286 
blk_y
 = 
mb
.
y
 + (
blkQ
 >> 2);

287 
blk_x
 = 
mb
.
x
 + (
blkQ
 & 3);

288 
blk_y2
 = 
	`gë_pos_y_luma
(
√ighb‹
,
yQ
) >> 2;

289 
blk_x2
 = (()(
	`gë_pos_x_luma
(
√ighb‹
,0)Ë>> 2Ë+ 
idx
;

291 
PicMŸi⁄P¨ams
 *
mv_öfo_p
 = &
p
->
mv_öfo
[
blk_y
 ][
blk_x
 ];

292 
PicMŸi⁄P¨ams
 *
mv_öfo_q
 = &
p
->
mv_öfo
[
blk_y2
][
blk_x2
];

294 
St‹abÀPi˘uªPå
 
ªf_p0
 = 
mv_öfo_p
->
ªf_pic
[
LIST_0
];

295 
St‹abÀPi˘uªPå
 
ªf_q0
 = 
mv_öfo_q
->
ªf_pic
[
LIST_0
];

296 
St‹abÀPi˘uªPå
 
ªf_p1
 = 
mv_öfo_p
->
ªf_pic
[
LIST_1
];

297 
St‹abÀPi˘uªPå
 
ªf_q1
 = 
mv_öfo_q
->
ªf_pic
[
LIST_1
];

299 i‡–((
ªf_p0
==
ªf_q0
Ë&& (
ªf_p1
==
ªf_q1
)) || ((ref_p0==ref_q1) && (ref_p1==ref_q0)))

302 i‡(
ªf_p0
 !
ªf_p1
)

305 i‡(
ªf_p0
 =
ªf_q0
)

307 
SåVÆue
 =

308 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_0
], &
mv_öfo_q
->mv[LIST_0], 
mvlimô
) |

309 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_1
], &
mv_öfo_q
->mv[LIST_1], 
mvlimô
);

313 
SåVÆue
 =

314 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_0
], &
mv_öfo_q
->mv[
LIST_1
], 
mvlimô
) |

315 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_1
], &
mv_öfo_q
->mv[
LIST_0
], 
mvlimô
);

320 
SåVÆue
 = ((

321 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_0
], &
mv_öfo_q
->mv[LIST_0], 
mvlimô
) |

322 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_1
], &
mv_öfo_q
->mv[LIST_1], 
mvlimô
))

324 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_0
], &
mv_öfo_q
->mv[
LIST_1
], 
mvlimô
) |

325 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_1
], &
mv_öfo_q
->mv[
LIST_0
], 
mvlimô
)

330 
SåVÆue
 = 1;

332 *(*)(
Såígth
 + 
idx
Ë
SåVÆue
;

339 
SåVÆue
 = (
edge
 =0 && (
p
->
°ru˘uª
 =
FRAME
)) ? 4 : 3;

340 
	`mem£t
(
Såígth
, (
byã
Ë
SåVÆue
, 
BLOCK_SIZE
 * (byte));

346 
SåVÆue
 = (
edge
 =0 && (
p
->
°ru˘uª
 =
FRAME
)) ? 4 : 3;

347 
	`mem£t
(
Såígth
, (
byã
Ë
SåVÆue
, 
BLOCK_SIZE
 * (byte));

350 
	}
}

358 
	$luma_vî_deblock_°r⁄g
(
img≥l
 **
cur_img
, 
pos_x1
, 
AÕha
, 
Bëa
)

360 
i
;

361  
i
 = 0 ; i < 
BLOCK_SIZE
 ; ++i )

363 
img≥l
 *
SrcPåP
 = *(
cur_img
++Ë+ 
pos_x1
;

364 
img≥l
 *
SrcPåQ
 = 
SrcPåP
 + 1;

365 
img≥l
 
L0
 = *
SrcPåP
;

366 
img≥l
 
R0
 = *
SrcPåQ
;

368 if–
	`übs
–
R0
 - 
L0
 ) < 
AÕha
 )

370 
img≥l
 
R1
 = *(
SrcPåQ
 + 1);

371 
img≥l
 
L1
 = *(
SrcPåP
 - 1);

372 i‡((
	`übs
–
R0
 - 
R1
Ë< 
Bëa
Ë&& (übs(
L0
 - 
L1
) < Beta))

374 i‡((
	`übs
–
R0
 - 
L0
 ) < ((
AÕha
 >> 2) + 2)))

376 
img≥l
 
R2
 = *(
SrcPåQ
 + 2);

377 
img≥l
 
L2
 = *(
SrcPåP
 - 2);

378 
RL0
 = 
L0
 + 
R0
;

380 i‡(–
	`übs
–
L0
 - 
L2
Ë< 
Bëa
 ))

382 
img≥l
 
L3
 = *(
SrcPåP
 - 3);

383 *(
SrcPåP
--Ë(
img≥l
Ë(–
R1
 + ((
L1
 + 
RL0
Ë<< 1Ë+ 
L2
 + 4) >> 3);

384 *(
SrcPåP
--Ë(
img≥l
Ë(–
L2
 + 
L1
 + 
RL0
 + 2) >> 2);

385 *(
SrcPåP
 ) = (
img≥l
Ë((((
L3
 + 
L2
Ë<<1Ë+ L2 + 
L1
 + 
RL0
 + 4) >> 3);

389 *
SrcPåP
 = (
img≥l
Ë(((
L1
 << 1Ë+ 
L0
 + 
R1
 + 2) >> 2);

392 i‡(–
	`übs
–
R0
 - 
R2
Ë< 
Bëa
 ))

394 
img≥l
 
R3
 = *(
SrcPåQ
 + 3);

395 *(
SrcPåQ
++Ë(
img≥l
Ë(–
L1
 + ((
R1
 + 
RL0
Ë<< 1Ë+ 
R2
 + 4) >> 3);

396 *(
SrcPåQ
++Ë(
img≥l
Ë(–
R2
 + 
R0
 + 
L0
 + 
R1
 + 2) >> 2);

397 *(
SrcPåQ
 ) = (
img≥l
Ë((((
R3
 + 
R2
Ë<<1Ë+ R2 + 
R1
 + 
RL0
 + 4) >> 3);

401 *
SrcPåQ
 = (
img≥l
Ë(((
R1
 << 1Ë+ 
R0
 + 
L1
 + 2) >> 2);

406 *
SrcPåP
 = (
img≥l
Ë(((
L1
 << 1Ë+ 
L0
 + 
R1
 + 2) >> 2);

407 *
SrcPåQ
 = (
img≥l
Ë(((
R1
 << 1Ë+ 
R0
 + 
L1
 + 2) >> 2);

412 
	}
}

420 
	$luma_vî_deblock_n‹mÆ
(
img≥l
 **
cur_img
, 
pos_x1
, 
AÕha
, 
Bëa
, 
C0
, 
max_img≥l_vÆue
)

422 
i
;

423 
img≥l
 *
SrcPåP
, *
SrcPåQ
;

424 
edge_diff
;

426 i‡(
C0
 == 0)

428  
i
0 ; i < 
BLOCK_SIZE
 ; ++i )

430 
SrcPåP
 = *(
cur_img
++Ë+ 
pos_x1
;

431 
SrcPåQ
 = 
SrcPåP
 + 1;

432 
edge_diff
 = *
SrcPåQ
 - *
SrcPåP
;

434 if–
	`übs
–
edge_diff
 ) < 
AÕha
 )

436 
img≥l
 *
SrcPåQ1
 = 
SrcPåQ
 + 1;

437 
img≥l
 *
SrcPåP1
 = 
SrcPåP
 - 1;

439 i‡((
	`übs
–*
SrcPåQ
 - *
SrcPåQ1
Ë< 
Bëa
Ë&& (übs(*
SrcPåP
 - *
SrcPåP1
) < Beta))

441 
img≥l
 
R2
 = *(
SrcPåQ1
 + 1);

442 
img≥l
 
L2
 = *(
SrcPåP1
 - 1);

444 
aq
 = (
	`übs
(*
SrcPåQ
 - 
R2
Ë< 
Bëa
);

445 
≠
 = (
	`übs
(*
SrcPåP
 - 
L2
Ë< 
Bëa
);

447 
tc0
 = (
≠
 + 
aq
) ;

448 
dif
 = 
	`iClù3
–-
tc0
,Åc0, (((
edge_diff
Ë<< 2Ë+ (*
SrcPåP1
 - *
SrcPåQ1
) + 4) >> 3 );

450 i‡(
dif
 != 0)

452 *
SrcPåP
 = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, *SrcPåP + 
dif
);

453 *
SrcPåQ
 = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, *SrcPåQ - 
dif
);

461  
i
0 ; i < 
BLOCK_SIZE
 ; ++i )

463 
SrcPåP
 = *(
cur_img
++Ë+ 
pos_x1
;

464 
SrcPåQ
 = 
SrcPåP
 + 1;

465 
edge_diff
 = *
SrcPåQ
 - *
SrcPåP
;

467 if–
	`übs
–
edge_diff
 ) < 
AÕha
 )

469 
img≥l
 *
SrcPåQ1
 = 
SrcPåQ
 + 1;

470 
img≥l
 *
SrcPåP1
 = 
SrcPåP
 - 1;

472 i‡((
	`übs
–*
SrcPåQ
 - *
SrcPåQ1
Ë< 
Bëa
Ë&& (übs(*
SrcPåP
 - *
SrcPåP1
) < Beta))

474 
RL0
 = (*
SrcPåP
 + *
SrcPåQ
 + 1) >> 1;

475 
img≥l
 
R2
 = *(
SrcPåQ1
 + 1);

476 
img≥l
 
L2
 = *(
SrcPåP1
 - 1);

478 
aq
 = (
	`übs
(*
SrcPåQ
 - 
R2
Ë< 
Bëa
);

479 
≠
 = (
	`übs
(*
SrcPåP
 - 
L2
Ë< 
Bëa
);

481 
tc0
 = (
C0
 + 
≠
 + 
aq
) ;

482 
dif
 = 
	`iClù3
–-
tc0
,Åc0, (((
edge_diff
Ë<< 2Ë+ (*
SrcPåP1
 - *
SrcPåQ1
) + 4) >> 3 );

484 if–
≠
 )

485 *
SrcPåP1
 = (
img≥l
Ë(*SrcPåP1 + 
	`iClù3
–-
C0
, C0, (
L2
 + 
RL0
 - (*SrcPtrP1<<1)) >> 1 ));

487 i‡(
dif
 != 0)

489 *
SrcPåP
 = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, *SrcPåP + 
dif
);

490 *
SrcPåQ
 = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, *SrcPåQ - 
dif
);

493 if–
aq
 )

494 *
SrcPåQ1
 = (
img≥l
Ë(*SrcPåQ1 + 
	`iClù3
–-
C0
, C0, (
R2
 + 
RL0
 - (*SrcPtrQ1<<1)) >> 1 ));

499 
	}
}

507 
	$edge_lo›_luma_vî
(
Cﬁ‹Pœ√
 
∂
, 
img≥l
** 
Img
, 
byã
 *
Såígth
, 
Ma¸oblock
 *
MbQ
, 
edge
)

509 
VideoP¨amëîs
 *
p_Vid
 = 
MbQ
->p_Vid;

511 
Ma¸oblock
 *
MbP
 = 
	`gë_n⁄_aff_√ighb‹_luma
(
MbQ
, 
edge
 - 1, 0);

513 i‡(
MbP
 || (
MbQ
->
DFDißbÀIdc
== 0))

515 
bôdïth_sˇÀ
 = 
∂
 ? 
p_Vid
->bôdïth_sˇÀ[
IS_CHROMA
] :Ö_Vid->bôdïth_sˇÀ[
IS_LUMA
];

518 
QP
 = 
∂
? ((
MbP
->
qpc
[∂-1] + 
MbQ
->qpc[∂-1] + 1Ë>> 1Ë: (MbP->
qp
 + MbQ->qp + 1) >> 1;

520 
ödexA
 = 
	`iClù3
(0, 
MAX_QP
, 
QP
 + 
MbQ
->
DFAÕhaC0Off£t
);

521 
ödexB
 = 
	`iClù3
(0, 
MAX_QP
, 
QP
 + 
MbQ
->
DFBëaOff£t
);

523 
AÕha
 = 
ALPHA_TABLE
[
ödexA
] * 
bôdïth_sˇÀ
;

524 
Bëa
 = 
BETA_TABLE
 [
ödexB
] * 
bôdïth_sˇÀ
;

526 i‡((
AÕha
 | 
Bëa
 )!= 0)

528 c⁄° 
byã
 *
ClùTab
 = 
CLIP_TAB
[
ödexA
];

529 
max_img≥l_vÆue
 = 
p_Vid
->
max_≥l_vÆue_comp
[
∂
];

531 
pos_x1
 = 
	`gë_pos_x_luma
(
MbP
, (
edge
 - 1));

532 
img≥l
 **
cur_img
 = &
Img
[
	`gë_pos_y_luma
(
MbP
, 0)];

533 
≥l
;

535  
≥l
 = 0 ;Öñ < 
MB_BLOCK_SIZE
 ;Öel += 4 )

537 if(*
Såígth
 == 4 )

539 
	`luma_vî_deblock_°r⁄g
(
cur_img
, 
pos_x1
, 
AÕha
, 
Bëa
);

541 if–*
Såígth
 != 0)

543 
	`luma_vî_deblock_n‹mÆ
(
cur_img
, 
pos_x1
, 
AÕha
, 
Bëa
, 
ClùTab
[ *
Såígth
 ] * 
bôdïth_sˇÀ
, 
max_img≥l_vÆue
);

545 
cur_img
 += 4;

546 
Såígth
 ++;

550 
	}
}

558 
	$luma_h‹_deblock_°r⁄g
(
img≥l
 *
imgP
, img≥»*
imgQ
, 
width
, 
AÕha
, 
Bëa
)

560 
pixñ
;

561 
öc_dim2
 = 
width
 * 2;

562 
öc_dim3
 = 
width
 * 3;

563  
pixñ
 = 0 ;Öixñ < 
BLOCK_SIZE
 ; ++pixel )

565 
img≥l
 *
SrcPåP
 = 
imgP
++;

566 
img≥l
 *
SrcPåQ
 = 
imgQ
++;

567 
img≥l
 
L0
 = *
SrcPåP
;

568 
img≥l
 
R0
 = *
SrcPåQ
;

570 if–
	`übs
–
R0
 - 
L0
 ) < 
AÕha
 )

572 
img≥l
 
L1
 = *(
SrcPåP
 - 
width
);

573 
img≥l
 
R1
 = *(
SrcPåQ
 + 
width
);

575 i‡((
	`übs
–
R0
 - 
R1
Ë< 
Bëa
Ë&& (übs(
L0
 - 
L1
) < Beta))

577 i‡((
	`übs
–
R0
 - 
L0
 ) < ((
AÕha
 >> 2) + 2)))

579 
img≥l
 
L2
 = *(
SrcPåP
 - 
öc_dim2
);

580 
img≥l
 
R2
 = *(
SrcPåQ
 + 
öc_dim2
);

581 
RL0
 = 
L0
 + 
R0
;

583 i‡(–
	`übs
–
L0
 - 
L2
Ë< 
Bëa
 ))

585 
img≥l
 
L3
 = *(
SrcPåP
 - 
öc_dim3
);

586 *(
SrcPåP
 ) = (
img≥l
Ë(–
R1
 + ((
L1
 + 
RL0
Ë<< 1Ë+ 
L2
 + 4) >> 3);

587 *(
SrcPåP
 -
width
Ë(
img≥l
Ë(–
L2
 + 
L1
 + 
RL0
 + 2) >> 2);

588 *(
SrcPåP
 - 
width
Ë(
img≥l
Ë((((
L3
 + 
L2
Ë<<1Ë+ L2 + 
L1
 + 
RL0
 + 4) >> 3);

592 *
SrcPåP
 = (
img≥l
Ë(((
L1
 << 1Ë+ 
L0
 + 
R1
 + 2) >> 2);

595 i‡(–
	`übs
–
R0
 - 
R2
Ë< 
Bëa
 ))

597 
img≥l
 
R3
 = *(
SrcPåQ
 + 
öc_dim3
);

598 *(
SrcPåQ
 ) = (
img≥l
Ë(–
L1
 + ((
R1
 + 
RL0
Ë<< 1Ë+ 
R2
 + 4) >> 3);

599 *(
SrcPåQ
 +
width
 ) = (
img≥l
Ë(–
R2
 + 
R0
 + 
L0
 + 
R1
 + 2) >> 2);

600 *(
SrcPåQ
 + 
width
 ) = (
img≥l
Ë((((
R3
 + 
R2
Ë<<1Ë+ R2 + 
R1
 + 
RL0
 + 4) >> 3);

604 *
SrcPåQ
 = (
img≥l
Ë(((
R1
 << 1Ë+ 
R0
 + 
L1
 + 2) >> 2);

609 *
SrcPåP
 = (
img≥l
Ë(((
L1
 << 1Ë+ 
L0
 + 
R1
 + 2) >> 2);

610 *
SrcPåQ
 = (
img≥l
Ë(((
R1
 << 1Ë+ 
R0
 + 
L1
 + 2) >> 2);

615 
	}
}

623 
	$luma_h‹_deblock_n‹mÆ
(
img≥l
 *
imgP
, img≥»*
imgQ
, 
width
, 
AÕha
, 
Bëa
, 
C0
, 
max_img≥l_vÆue
)

625 
i
;

626 
edge_diff
;

627 
tc0
, 
dif
, 
aq
, 
≠
;

629 i‡(
C0
 == 0)

631  
i
0 ; i < 
BLOCK_SIZE
 ; ++i )

633 
edge_diff
 = *
imgQ
 - *
imgP
;

635 if–
	`übs
–
edge_diff
 ) < 
AÕha
 )

637 
img≥l
 *
SrcPåQ1
 = 
imgQ
 + 
width
;

638 
img≥l
 *
SrcPåP1
 = 
imgP
 - 
width
;

640 i‡((
	`übs
–*
imgQ
 - *
SrcPåQ1
Ë< 
Bëa
Ë&& (übs(*
imgP
 - *
SrcPåP1
) < Beta))

642 
img≥l
 
R2
 = *(
SrcPåQ1
 + 
width
);

643 
img≥l
 
L2
 = *(
SrcPåP1
 - 
width
);

645 
aq
 = (
	`übs
(*
imgQ
 - 
R2
Ë< 
Bëa
);

646 
≠
 = (
	`übs
(*
imgP
 - 
L2
Ë< 
Bëa
);

648 
tc0
 = (
≠
 + 
aq
) ;

649 
dif
 = 
	`iClù3
–-
tc0
,Åc0, (((
edge_diff
Ë<< 2Ë+ (*
SrcPåP1
 - *
SrcPåQ1
) + 4) >> 3 );

651 i‡(
dif
 != 0)

653 *
imgP
 = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, *imgP + 
dif
);

654 *
imgQ
 = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, *imgQ - 
dif
);

658 
imgP
++;

659 
imgQ
++;

664  
i
0 ; i < 
BLOCK_SIZE
 ; ++i )

666 
edge_diff
 = *
imgQ
 - *
imgP
;

668 if–
	`übs
–
edge_diff
 ) < 
AÕha
 )

670 
img≥l
 *
SrcPåQ1
 = 
imgQ
 + 
width
;

671 
img≥l
 *
SrcPåP1
 = 
imgP
 - 
width
;

673 i‡((
	`übs
–*
imgQ
 - *
SrcPåQ1
Ë< 
Bëa
Ë&& (übs(*
imgP
 - *
SrcPåP1
) < Beta))

675 
RL0
 = (*
imgP
 + *
imgQ
 + 1) >> 1;

676 
img≥l
 
R2
 = *(
SrcPåQ1
 + 
width
);

677 
img≥l
 
L2
 = *(
SrcPåP1
 - 
width
);

679 
aq
 = (
	`übs
(*
imgQ
 - 
R2
Ë< 
Bëa
);

680 
≠
 = (
	`übs
(*
imgP
 - 
L2
Ë< 
Bëa
);

682 
tc0
 = (
C0
 + 
≠
 + 
aq
) ;

683 
dif
 = 
	`iClù3
–-
tc0
,Åc0, (((
edge_diff
Ë<< 2Ë+ (*
SrcPåP1
 - *
SrcPåQ1
) + 4) >> 3 );

685 if–
≠
 )

686 *
SrcPåP1
 = (
img≥l
Ë(*SrcPåP1 + 
	`iClù3
–-
C0
, C0, (
L2
 + 
RL0
 - (*SrcPtrP1<<1)) >> 1 ));

688 i‡(
dif
 != 0)

690 *
imgP
 = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, *imgP + 
dif
);

691 *
imgQ
 = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, *imgQ - 
dif
);

694 if–
aq
 )

695 *
SrcPåQ1
 = (
img≥l
Ë(*SrcPåQ1 + 
	`iClù3
–-
C0
, C0, (
R2
 + 
RL0
 - (*SrcPtrQ1<<1)) >> 1 ));

698 
imgP
++;

699 
imgQ
++;

702 
	}
}

710 
	$edge_lo›_luma_h‹
(
Cﬁ‹Pœ√
 
∂
, 
img≥l
** 
Img
, 
byã
 *
Såígth
, 
Ma¸oblock
 *
MbQ
, 
edge
, 
St‹abÀPi˘uª
 *
p
)

712 
VideoP¨amëîs
 *
p_Vid
 = 
MbQ
->p_Vid;

714 
ypos
 = (
edge
 < 
MB_BLOCK_SIZE
 ?Édge - 1: 0);

715 
Ma¸oblock
 *
MbP
 = 
	`gë_n⁄_aff_√ighb‹_luma
(
MbQ
, 0, 
ypos
);

717 i‡(
MbP
 || (
MbQ
->
DFDißbÀIdc
== 0))

719 
bôdïth_sˇÀ
 = 
∂
 ? 
p_Vid
->bôdïth_sˇÀ[
IS_CHROMA
] :Ö_Vid->bôdïth_sˇÀ[
IS_LUMA
];

722 
QP
 = 
∂
? ((
MbP
->
qpc
[∂-1] + 
MbQ
->qpc[∂-1] + 1Ë>> 1Ë: (MbP->
qp
 + MbQ->qp + 1) >> 1;

724 
ödexA
 = 
	`iClù3
(0, 
MAX_QP
, 
QP
 + 
MbQ
->
DFAÕhaC0Off£t
);

725 
ödexB
 = 
	`iClù3
(0, 
MAX_QP
, 
QP
 + 
MbQ
->
DFBëaOff£t
);

727 
AÕha
 = 
ALPHA_TABLE
[
ödexA
] * 
bôdïth_sˇÀ
;

728 
Bëa
 = 
BETA_TABLE
 [
ödexB
] * 
bôdïth_sˇÀ
;

730 i‡((
AÕha
 | 
Bëa
 )!= 0)

732 c⁄° 
byã
 *
ClùTab
 = 
CLIP_TAB
[
ödexA
];

733 
max_img≥l_vÆue
 = 
p_Vid
->
max_≥l_vÆue_comp
[
∂
];

734 
width
 = 
p
->
iLumaSåide
;

736 
img≥l
 *
imgP
 = &
Img
[
	`gë_pos_y_luma
(
MbP
, 
ypos
)][
	`gë_pos_x_luma
(MbP, 0)];

737 
img≥l
 *
imgQ
 = 
imgP
 + 
width
;

738 
≥l
;

740  
≥l
 = 0 ;Öñ < 
BLOCK_SIZE
 ;Öel++ )

742 if(*
Såígth
 == 4 )

744 
	`luma_h‹_deblock_°r⁄g
(
imgP
, 
imgQ
, 
width
, 
AÕha
, 
Bëa
);

746 if–*
Såígth
 != 0)

748 
	`luma_h‹_deblock_n‹mÆ
(
imgP
, 
imgQ
, 
width
, 
AÕha
, 
Bëa
, 
ClùTab
[ *
Såígth
 ] * 
bôdïth_sˇÀ
, 
max_img≥l_vÆue
);

750 
imgP
 += 4;

751 
imgQ
 += 4;

752 
Såígth
 ++;

756 
	}
}

765 
	$edge_lo›_chroma_vî
(
img≥l
** 
Img
, 
byã
 *
Såígth
, 
Ma¸oblock
 *
MbQ
, 
edge
, 
uv
, 
St‹abÀPi˘uª
 *
p
)

767 
VideoP¨amëîs
 *
p_Vid
 = 
MbQ
->p_Vid;

769 
block_width
 = 
p_Vid
->
mb_¸_size_x
;

770 
block_height
 = 
p_Vid
->
mb_¸_size_y
;

771 
xQ
 = 
edge
 - 1;

772 
yQ
 = 0;

774 
Ma¸oblock
 *
MbP
 = 
	`gë_n⁄_aff_√ighb‹_chroma
(
MbQ
,
xQ
,
yQ
,
block_width
,
block_height
);

776 i‡(
MbP
 || (
MbQ
->
DFDißbÀIdc
 == 0))

778 
bôdïth_sˇÀ
 = 
p_Vid
->bôdïth_sˇÀ[
IS_CHROMA
];

779 
max_img≥l_vÆue
 = 
p_Vid
->
max_≥l_vÆue_comp
[
uv
 + 1];

781 
AÕhaC0Off£t
 = 
MbQ
->
DFAÕhaC0Off£t
;

782 
BëaOff£t
 = 
MbQ
->
DFBëaOff£t
;

785 
QP
 = (
MbP
->
qpc
[
uv
] + 
MbQ
->qpc[uv] + 1) >> 1;

787 
ödexA
 = 
	`iClù3
(0, 
MAX_QP
, 
QP
 + 
AÕhaC0Off£t
);

788 
ödexB
 = 
	`iClù3
(0, 
MAX_QP
, 
QP
 + 
BëaOff£t
);

790 
AÕha
 = 
ALPHA_TABLE
[
ödexA
] * 
bôdïth_sˇÀ
;

791 
Bëa
 = 
BETA_TABLE
 [
ödexB
] * 
bôdïth_sˇÀ
;

793 i‡((
AÕha
 | 
Bëa
) != 0)

795 c⁄° 
PñNum
 = 
≥ um_¸
[0][
p
->
chroma_f‹m©_idc
];

796 c⁄° 
byã
 *
ClùTab
 = 
CLIP_TAB
[
ödexA
];

798 
≥l
;

799 
pos_x1
 = 
	`gë_pos_x_chroma
(
MbP
, 
xQ
, (
block_width
 - 1));

800 
img≥l
 **
cur_img
 = &
Img
[
	`gë_pos_y_chroma
(
MbP
,
yQ
, (
block_height
 - 1))];

802  
≥l
 = 0 ;Öñ < 
PñNum
 ; ++pel )

804 
Sång
 = 
Såígth
[(
PñNum
 =8Ë? (
≥l
 >> 1) : (pel >> 2)];

806 if–
Sång
 != 0)

808 
img≥l
 *
SrcPåP
 = *
cur_img
 + 
pos_x1
;

809 
img≥l
 *
SrcPåQ
 = 
SrcPåP
 + 1;

810 
edge_diff
 = *
SrcPåQ
 - *
SrcPåP
;

812 i‡–
	`übs
–
edge_diff
 ) < 
AÕha
 )

814 
img≥l
 
R1
 = *(
SrcPåQ
 + 1);

815 i‡–
	`übs
(*
SrcPåQ
 - 
R1
Ë< 
Bëa
 )

817 
img≥l
 
L1
 = *(
SrcPåP
 - 1);

818 i‡–
	`übs
(*
SrcPåP
 - 
L1
Ë< 
Bëa
 )

820 if–
Sång
 == 4 )

822 *
SrcPåP
 = (
img≥l
Ë–((
L1
 << 1Ë+ *SrcPåP + 
R1
 + 2) >> 2 );

823 *
SrcPåQ
 = (
img≥l
Ë–((
R1
 << 1Ë+ *SrcPåQ + 
L1
 + 2) >> 2 );

827 
tc0
 = 
ClùTab
[ 
Sång
 ] * 
bôdïth_sˇÀ
 + 1;

828 
dif
 = 
	`iClù3
–-
tc0
,Åc0, ( ((
edge_diff
Ë<< 2Ë+ (
L1
 - 
R1
) + 4) >> 3 );

830 i‡(
dif
 != 0)

832 *
SrcPåP
 = (
img≥l
Ë
	`iClù1
 ( 
max_img≥l_vÆue
, *SrcPåP + 
dif
 );

833 *
SrcPåQ
 = (
img≥l
Ë
	`iClù1
 ( 
max_img≥l_vÆue
, *SrcPåQ - 
dif
 );

840 
cur_img
++;

844 
	}
}

853 
	$edge_lo›_chroma_h‹
(
img≥l
** 
Img
, 
byã
 *
Såígth
, 
Ma¸oblock
 *
MbQ
, 
edge
, 
uv
, 
St‹abÀPi˘uª
 *
p
)

855 
VideoP¨amëîs
 *
p_Vid
 = 
MbQ
->p_Vid;

856 
block_width
 = 
p_Vid
->
mb_¸_size_x
;

857 
block_height
 = 
p_Vid
->
mb_¸_size_y
;

858 
xQ
 = 0;

859 
yQ
 = (
edge
 < 16 ?Édge - 1: 0);

861 
Ma¸oblock
 *
MbP
 = 
	`gë_n⁄_aff_√ighb‹_chroma
(
MbQ
,
xQ
,
yQ
,
block_width
,
block_height
);

863 i‡(
MbP
 || (
MbQ
->
DFDißbÀIdc
 == 0))

865 
bôdïth_sˇÀ
 = 
p_Vid
->bôdïth_sˇÀ[
IS_CHROMA
];

866 
max_img≥l_vÆue
 = 
p_Vid
->
max_≥l_vÆue_comp
[
uv
 + 1];

868 
AÕhaC0Off£t
 = 
MbQ
->
DFAÕhaC0Off£t
;

869 
BëaOff£t
 = 
MbQ
->
DFBëaOff£t
;

870 
width
 = 
p
->
iChromaSåide
;

873 
QP
 = (
MbP
->
qpc
[
uv
] + 
MbQ
->qpc[uv] + 1) >> 1;

875 
ödexA
 = 
	`iClù3
(0, 
MAX_QP
, 
QP
 + 
AÕhaC0Off£t
);

876 
ödexB
 = 
	`iClù3
(0, 
MAX_QP
, 
QP
 + 
BëaOff£t
);

878 
AÕha
 = 
ALPHA_TABLE
[
ödexA
] * 
bôdïth_sˇÀ
;

879 
Bëa
 = 
BETA_TABLE
 [
ödexB
] * 
bôdïth_sˇÀ
;

881 i‡((
AÕha
 | 
Bëa
) != 0)

883 c⁄° 
PñNum
 = 
≥ um_¸
[1][
p
->
chroma_f‹m©_idc
];

884 c⁄° 
byã
 *
ClùTab
 = 
CLIP_TAB
[
ödexA
];

886 
≥l
;

888 
img≥l
 *
imgP
 = &
Img
[
	`gë_pos_y_chroma
(
MbP
,
yQ
, (
block_height
-1))][
	`gë_pos_x_chroma
(MbP,
xQ
, (
block_width
 - 1))];

889 
img≥l
 *
imgQ
 = 
imgP
 + 
width
 ;

891  
≥l
 = 0 ;Öñ < 
PñNum
 ; ++pel )

893 
Sång
 = 
Såígth
[(
PñNum
 =8Ë? (
≥l
 >> 1) : (pel >> 2)];

895 if–
Sång
 != 0)

897 
img≥l
 *
SrcPåP
 = 
imgP
;

898 
img≥l
 *
SrcPåQ
 = 
imgQ
;

899 
edge_diff
 = *
imgQ
 - *
imgP
;

901 i‡–
	`übs
–
edge_diff
 ) < 
AÕha
 )

903 
img≥l
 
R1
 = *(
SrcPåQ
 + 
width
);

904 i‡–
	`übs
(*
SrcPåQ
 - 
R1
Ë< 
Bëa
 )

906 
img≥l
 
L1
 = *(
SrcPåP
 - 
width
);

907 i‡–
	`übs
(*
SrcPåP
 - 
L1
Ë< 
Bëa
 )

909 if–
Sång
 == 4 )

911 *
SrcPåP
 = (
img≥l
Ë–((
L1
 << 1Ë+ *SrcPåP + 
R1
 + 2) >> 2 );

912 *
SrcPåQ
 = (
img≥l
Ë–((
R1
 << 1Ë+ *SrcPåQ + 
L1
 + 2) >> 2 );

916 
tc0
 = 
ClùTab
[ 
Sång
 ] * 
bôdïth_sˇÀ
 + 1;

917 
dif
 = 
	`iClù3
–-
tc0
,Åc0, ( ((
edge_diff
Ë<< 2Ë+ (
L1
 - 
R1
) + 4) >> 3 );

919 i‡(
dif
 != 0)

921 *
SrcPåP
 = (
img≥l
Ë
	`iClù1
 ( 
max_img≥l_vÆue
, *SrcPåP + 
dif
 );

922 *
SrcPåQ
 = (
img≥l
Ë
	`iClù1
 ( 
max_img≥l_vÆue
, *SrcPåQ - 
dif
 );

929 
imgP
++;

930 
imgQ
++;

934 
	}
}

936 
	$≥rf‹m_db_dï_n‹mÆ
(
Ma¸oblock
 *
MbQ
, 
St‹abÀPi˘uª
 *
p
)

938 
VideoP¨amëîs
 *
p_Vid
 = 
MbQ
->p_Vid;

939 
Sli˚
 *
cuºSli˚
 = 
MbQ
->
p_Sli˚
;

940 
edge
;

942 
mb_x
, 
mb_y
;

944 
fûãrLe·MbEdgeFœg
;

945 
fûãrT›MbEdgeFœg
;

947 
img≥l
 **
imgY
 = 
p
->imgY;

948 
img≥l
 ***
imgUV
 = 
p
->imgUV;

950 
£q_∑ømëî_£t_rb•_t
 *
a˘ive_•s
 = 
p_Vid
->active_sps;

952 
MbQ
->
DeblockCÆl
 = 1;

953 
	`gë_mb_pos
 (
p_Vid
, 
MbQ
->
mbAddrX
,Ö_Vid->
mb_size
[
IS_LUMA
], &
mb_x
, &
mb_y
);

955 
fûãrLe·MbEdgeFœg
 = (
mb_x
 != 0);

956 
fûãrT›MbEdgeFœg
 = (
mb_y
 != 0);

958 i‡(
MbQ
->
DFDißbÀIdc
 == 2)

961 
fûãrLe·MbEdgeFœg
 = 
MbQ
->
mbAvaûA
;

963 
fûãrT›MbEdgeFœg
 = 
MbQ
->
mbAvaûB
;

966 i‡(
MbQ
->
luma_å™sf‹m_size_8x8_Êag
)

969 
edge
 = 0;Édge < 4 ;Édge += 2)

972 i‡(
MbQ
->
cbp
 =0 && (
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
 || cuºSli˚->¶i˚_ty≥ =
B_SLICE
))

975 i‡(
edge
 > 0)

977 i‡(((
MbQ
->
mb_ty≥
 =
PSKIP
 && 
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
Ë|| (MbQ->mb_ty≥ =
P16x16
Ë|| (MbQ->mb_ty≥ =
P16x8
)))

982 if–
edge
 || 
fûãrLe·MbEdgeFœg
 )

984 
byã
 *
Såígth
 = 
MbQ
->
°ªngth_vî
[
edge
];

986 i‡((*((*Ë
Såígth
)))

988 
	`edge_lo›_luma_vî
–
PLANE_Y
, 
imgY
, 
Såígth
, 
MbQ
, 
edge
 << 2);

989 
	`edge_lo›_luma_vî
(
PLANE_U
, 
imgUV
[0], 
Såígth
, 
MbQ
, 
edge
 << 2);

990 
	`edge_lo›_luma_vî
(
PLANE_V
, 
imgUV
[1], 
Såígth
, 
MbQ
, 
edge
 << 2);

996  
edge
 = 0;Édge < 4 ;Édge += 2 )

999 i‡(
MbQ
->
cbp
 =0 && (
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
 || cuºSli˚->¶i˚_ty≥ =
B_SLICE
))

1001 i‡(
edge
 > 0)

1003 i‡(((
MbQ
->
mb_ty≥
 =
PSKIP
 && 
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
Ë|| (MbQ->mb_ty≥ =
P16x16
Ë|| (MbQ->mb_ty≥ =
P8x16
)))

1008 if–
edge
 || 
fûãrT›MbEdgeFœg
 )

1010 
byã
 *
Såígth
 = 
MbQ
->
°ªngth_h‹
[
edge
];

1012 i‡((*((*Ë
Såígth
)))

1014 
	`edge_lo›_luma_h‹
–
PLANE_Y
, 
imgY
, 
Såígth
, 
MbQ
, 
edge
 << 2, 
p
) ;

1015 
	`edge_lo›_luma_h‹
(
PLANE_U
, 
imgUV
[0], 
Såígth
, 
MbQ
, 
edge
 << 2, 
p
);

1016 
	`edge_lo›_luma_h‹
(
PLANE_V
, 
imgUV
[1], 
Såígth
, 
MbQ
, 
edge
 << 2, 
p
);

1024 
edge
 = 0;Édge < 4 ; ++edge )

1027 i‡(
MbQ
->
cbp
 =0 && (
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
 || cuºSli˚->¶i˚_ty≥ =
B_SLICE
))

1029 i‡(
edge
 > 0)

1031 i‡(((
MbQ
->
mb_ty≥
 =
PSKIP
 && 
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
Ë|| (MbQ->mb_ty≥ =
P16x16
Ë|| (MbQ->mb_ty≥ =
P16x8
)))

1033 i‡((
edge
 & 0x01Ë&& ((
MbQ
->
mb_ty≥
 =
P8x16
Ë|| (
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
 && MbQ->mb_ty≥ =
BSKIP_DIRECT
 && 
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
)))

1038 if–
edge
 || 
fûãrLe·MbEdgeFœg
 )

1040 
byã
 *
Såígth
 = 
MbQ
->
°ªngth_vî
[
edge
];

1042 i‡((*((*Ë
Såígth
)))

1044 
	`edge_lo›_luma_vî
–
PLANE_Y
, 
imgY
, 
Såígth
, 
MbQ
, 
edge
 << 2);

1045 
	`edge_lo›_luma_vî
(
PLANE_U
, 
imgUV
[0], 
Såígth
, 
MbQ
, 
edge
 << 2);

1046 
	`edge_lo›_luma_vî
(
PLANE_V
, 
imgUV
[1], 
Såígth
, 
MbQ
, 
edge
 << 2);

1052  
edge
 = 0;Édge < 4 ; ++edge )

1055 i‡(
MbQ
->
cbp
 =0 && (
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
 || cuºSli˚->¶i˚_ty≥ =
B_SLICE
))

1057 i‡(
edge
 > 0)

1059 i‡(((
MbQ
->
mb_ty≥
 =
PSKIP
 && 
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
Ë|| (MbQ->mb_ty≥ =
P16x16
Ë|| (MbQ->mb_ty≥ =
P8x16
)))

1061 i‡((
edge
 & 0x01Ë&& ((
MbQ
->
mb_ty≥
 =
P16x8
Ë|| (
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
 && MbQ->mb_ty≥ =
BSKIP_DIRECT
 && 
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
)))

1066 if–
edge
 || 
fûãrT›MbEdgeFœg
 )

1068 
byã
 *
Såígth
 = 
MbQ
->
°ªngth_h‹
[
edge
];

1070 i‡((*((*Ë
Såígth
)))

1072 
	`edge_lo›_luma_h‹
–
PLANE_Y
, 
imgY
, 
Såígth
, 
MbQ
, 
edge
 << 2, 
p
) ;

1073 
	`edge_lo›_luma_h‹
(
PLANE_U
, 
imgUV
[0], 
Såígth
, 
MbQ
, 
edge
 << 2, 
p
);

1074 
	`edge_lo›_luma_h‹
(
PLANE_V
, 
imgUV
[1], 
Såígth
, 
MbQ
, 
edge
 << 2, 
p
);

1079 
	}
}

1081 
	$≥rf‹m_db_öd_n‹mÆ
(
Ma¸oblock
 *
MbQ
, 
St‹abÀPi˘uª
 *
p
)

1083 
VideoP¨amëîs
 *
p_Vid
 = 
MbQ
->p_Vid;

1084 
Sli˚
 *
cuºSli˚
 = 
MbQ
->
p_Sli˚
;

1087 
fûãrLe·MbEdgeFœg
;

1088 
fûãrT›MbEdgeFœg
;

1090 
img≥l
 **
imgY
 = 
p
->imgY;

1091 
img≥l
 ***
imgUV
 = 
p
->imgUV;

1093 
£q_∑ømëî_£t_rb•_t
 *
a˘ive_•s
 = 
p_Vid
->active_sps;

1095 
MbQ
->
DeblockCÆl
 = 1;

1098 
fûãrLe·MbEdgeFœg
 = (
MbQ
->
pix_x
 != 0);

1099 
fûãrT›MbEdgeFœg
 = (
MbQ
->
pix_y
 != 0);

1101 i‡(
MbQ
->
DFDißbÀIdc
 == 2)

1104 
fûãrLe·MbEdgeFœg
 = 
MbQ
->
mbAvaûA
;

1106 
fûãrT›MbEdgeFœg
 = 
MbQ
->
mbAvaûB
;

1109 i‡(
MbQ
->
luma_å™sf‹m_size_8x8_Êag
)

1111 
edge
, 
edge_¸
;

1114 
edge
 = 0;Édge < 4 ;Édge += 2)

1116 if–
edge
 || 
fûãrLe·MbEdgeFœg
 )

1118 
byã
 *
Såígth
 = 
MbQ
->
°ªngth_vî
[
edge
];

1120 i‡((*((*Ë
Såígth
)))

1122 
	`edge_lo›_luma_vî
–
PLANE_Y
, 
imgY
, 
Såígth
, 
MbQ
, 
edge
 << 2);

1124 i‡(
a˘ive_•s
->
chroma_f‹m©_idc
==
YUV420
 ||á˘ive_•s->chroma_f‹m©_idc==
YUV422
)

1126 
edge_¸
 = 
chroma_edge
[0][
edge
][
p
->
chroma_f‹m©_idc
];

1127 if–(
imgUV
 !
NULL
Ë&& (
edge_¸
 >= 0))

1129 
	`edge_lo›_chroma_vî
–
imgUV
[0], 
Såígth
, 
MbQ
, 
edge_¸
, 0, 
p
);

1130 
	`edge_lo›_chroma_vî
–
imgUV
[1], 
Såígth
, 
MbQ
, 
edge_¸
, 1, 
p
);

1138  
edge
 = 0;Édge < 4 ;Édge += 2 )

1140 if–
edge
 || 
fûãrT›MbEdgeFœg
 )

1142 
byã
 *
Såígth
 = 
MbQ
->
°ªngth_h‹
[
edge
];

1144 i‡((*((*Ë
Såígth
)))

1146 
	`edge_lo›_luma_h‹
–
PLANE_Y
, 
imgY
, 
Såígth
, 
MbQ
, 
edge
 << 2, 
p
) ;

1148 i‡(
a˘ive_•s
->
chroma_f‹m©_idc
==
YUV420
 ||á˘ive_•s->chroma_f‹m©_idc==
YUV422
)

1150 
edge_¸
 = 
chroma_edge
[1][
edge
][
p
->
chroma_f‹m©_idc
];

1151 if–(
imgUV
 !
NULL
Ë&& (
edge_¸
 >= 0))

1153 
	`edge_lo›_chroma_h‹
–
imgUV
[0], 
Såígth
, 
MbQ
, 
edge_¸
, 0, 
p
);

1154 
	`edge_lo›_chroma_h‹
–
imgUV
[1], 
Såígth
, 
MbQ
, 
edge_¸
, 1, 
p
);

1163 i‡(((
MbQ
->
mb_ty≥
 =
PSKIP
Ë&& (
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
)Ë|| ((MbQ->mb_ty≥ =
P16x16
Ë&& (MbQ->
cbp
 == 0)))

1166 if–
fûãrLe·MbEdgeFœg
 )

1168 
byã
 *
Såígth
 = 
MbQ
->
°ªngth_vî
[0];

1170 i‡((*((*Ë
Såígth
)))

1172 
	`edge_lo›_luma_vî
–
PLANE_Y
, 
imgY
, 
Såígth
, 
MbQ
, 0);

1174 i‡(
a˘ive_•s
->
chroma_f‹m©_idc
==
YUV420
 ||á˘ive_•s->chroma_f‹m©_idc==
YUV422
)

1176 if–(
imgUV
 !
NULL
))

1178 
	`edge_lo›_chroma_vî
–
imgUV
[0], 
Såígth
, 
MbQ
, 0, 0, 
p
);

1179 
	`edge_lo›_chroma_vî
–
imgUV
[1], 
Såígth
, 
MbQ
, 0, 1, 
p
);

1187 if–
fûãrT›MbEdgeFœg
 )

1189 
byã
 *
Såígth
 = 
MbQ
->
°ªngth_h‹
[0];

1191 i‡((*((*Ë
Såígth
)))

1193 
	`edge_lo›_luma_h‹
–
PLANE_Y
, 
imgY
, 
Såígth
, 
MbQ
, 0, 
p
) ;

1195 i‡(
a˘ive_•s
->
chroma_f‹m©_idc
==
YUV420
 ||á˘ive_•s->chroma_f‹m©_idc==
YUV422
)

1197 if–(
imgUV
 !
NULL
))

1199 
	`edge_lo›_chroma_h‹
–
imgUV
[0], 
Såígth
, 
MbQ
, 0, 0, 
p
);

1200 
	`edge_lo›_chroma_h‹
–
imgUV
[1], 
Såígth
, 
MbQ
, 0, 1, 
p
);

1206 i‡((
MbQ
->
mb_ty≥
 =
P16x8
Ë&& (MbQ->
cbp
 == 0))

1208 
edge
, 
edge_¸
;

1210 if–
fûãrLe·MbEdgeFœg
 )

1212 
byã
 *
Såígth
 = 
MbQ
->
°ªngth_vî
[0];

1214 i‡((*((*Ë
Såígth
)))

1216 
	`edge_lo›_luma_vî
–
PLANE_Y
, 
imgY
, 
Såígth
, 
MbQ
, 0);

1218 i‡(
a˘ive_•s
->
chroma_f‹m©_idc
==
YUV420
 ||á˘ive_•s->chroma_f‹m©_idc==
YUV422
)

1220 i‡(
imgUV
 !
NULL
)

1222 
	`edge_lo›_chroma_vî
–
imgUV
[0], 
Såígth
, 
MbQ
, 0, 0, 
p
);

1223 
	`edge_lo›_chroma_vî
–
imgUV
[1], 
Såígth
, 
MbQ
, 0, 1, 
p
);

1230  
edge
 = 0;Édge < 4 ;Édge += 2)

1232 if–
edge
 || 
fûãrT›MbEdgeFœg
 )

1234 
byã
 *
Såígth
 = 
MbQ
->
°ªngth_h‹
[
edge
];

1236 i‡((*((*Ë
Såígth
)))

1238 
	`edge_lo›_luma_h‹
–
PLANE_Y
, 
imgY
, 
Såígth
, 
MbQ
, 
edge
 << 2, 
p
) ;

1240 i‡(
a˘ive_•s
->
chroma_f‹m©_idc
==
YUV420
 ||á˘ive_•s->chroma_f‹m©_idc==
YUV422
)

1242 
edge_¸
 = 
chroma_edge
[1][
edge
][
p
->
chroma_f‹m©_idc
];

1243 if–(
imgUV
 !
NULL
Ë&& (
edge_¸
 >= 0))

1245 
	`edge_lo›_chroma_h‹
–
imgUV
[0], 
Såígth
, 
MbQ
, 
edge_¸
, 0, 
p
);

1246 
	`edge_lo›_chroma_h‹
–
imgUV
[1], 
Såígth
, 
MbQ
, 
edge_¸
, 1, 
p
);

1253 i‡((
MbQ
->
mb_ty≥
 =
P8x16
Ë&& (MbQ->
cbp
 == 0))

1255 
edge
, 
edge_¸
;

1257 
edge
 = 0;Édge < 4 ;Édge += 2)

1259 if–
edge
 || 
fûãrLe·MbEdgeFœg
 )

1261 
byã
 *
Såígth
 = 
MbQ
->
°ªngth_vî
[
edge
];

1263 i‡((*((*Ë
Såígth
)))

1265 
	`edge_lo›_luma_vî
–
PLANE_Y
, 
imgY
, 
Såígth
, 
MbQ
, 
edge
 << 2);

1267 i‡(
a˘ive_•s
->
chroma_f‹m©_idc
==
YUV420
 ||á˘ive_•s->chroma_f‹m©_idc==
YUV422
)

1269 
edge_¸
 = 
chroma_edge
[0][
edge
][
p
->
chroma_f‹m©_idc
];

1270 if–(
imgUV
 !
NULL
Ë&& (
edge_¸
 >= 0))

1272 
	`edge_lo›_chroma_vî
–
imgUV
[0], 
Såígth
, 
MbQ
, 
edge_¸
, 0, 
p
);

1273 
	`edge_lo›_chroma_vî
–
imgUV
[1], 
Såígth
, 
MbQ
, 
edge_¸
, 1, 
p
);

1281 if–
fûãrT›MbEdgeFœg
 )

1283 
byã
 *
Såígth
 = 
MbQ
->
°ªngth_h‹
[0];

1285 i‡((*((*Ë
Såígth
)))

1287 
	`edge_lo›_luma_h‹
–
PLANE_Y
, 
imgY
, 
Såígth
, 
MbQ
, 0, 
p
) ;

1289 i‡(
a˘ive_•s
->
chroma_f‹m©_idc
==
YUV420
 ||á˘ive_•s->chroma_f‹m©_idc==
YUV422
)

1291 i‡(
imgUV
 !
NULL
)

1293 
	`edge_lo›_chroma_h‹
–
imgUV
[0], 
Såígth
, 
MbQ
, 0, 0, 
p
);

1294 
	`edge_lo›_chroma_h‹
–
imgUV
[1], 
Såígth
, 
MbQ
, 0, 1, 
p
);

1300 i‡((
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
Ë&& (
MbQ
->
mb_ty≥
 =
BSKIP_DIRECT
Ë&& (
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
Ë&& (MbQ->
cbp
 == 0))

1302 
edge
, 
edge_¸
;

1304 
edge
 = 0;Édge < 4 ;Édge += 2)

1306 if–
edge
 || 
fûãrLe·MbEdgeFœg
 )

1308 
byã
 *
Såígth
 = 
MbQ
->
°ªngth_vî
[
edge
];

1310 i‡((*((*Ë
Såígth
)))

1312 
	`edge_lo›_luma_vî
–
PLANE_Y
, 
imgY
, 
Såígth
, 
MbQ
, 
edge
 << 2);

1314 i‡(
a˘ive_•s
->
chroma_f‹m©_idc
==
YUV420
 ||á˘ive_•s->chroma_f‹m©_idc==
YUV422
)

1316 
edge_¸
 = 
chroma_edge
[0][
edge
][
p
->
chroma_f‹m©_idc
];

1317 if–(
imgUV
 !
NULL
Ë&& (
edge_¸
 >= 0))

1319 
	`edge_lo›_chroma_vî
–
imgUV
[0], 
Såígth
, 
MbQ
, 
edge_¸
, 0, 
p
);

1320 
	`edge_lo›_chroma_vî
–
imgUV
[1], 
Såígth
, 
MbQ
, 
edge_¸
, 1, 
p
);

1328  
edge
 = 0;Édge < 4 ;Édge += 2)

1330 if–
edge
 || 
fûãrT›MbEdgeFœg
 )

1332 
byã
 *
Såígth
 = 
MbQ
->
°ªngth_h‹
[
edge
];

1334 i‡((*((*Ë
Såígth
)))

1336 
	`edge_lo›_luma_h‹
–
PLANE_Y
, 
imgY
, 
Såígth
, 
MbQ
, 
edge
 << 2, 
p
) ;

1338 i‡(
a˘ive_•s
->
chroma_f‹m©_idc
==
YUV420
 ||á˘ive_•s->chroma_f‹m©_idc==
YUV422
)

1340 
edge_¸
 = 
chroma_edge
[1][
edge
][
p
->
chroma_f‹m©_idc
];

1341 if–(
imgUV
 !
NULL
Ë&& (
edge_¸
 >= 0))

1343 
	`edge_lo›_chroma_h‹
–
imgUV
[0], 
Såígth
, 
MbQ
, 
edge_¸
, 0, 
p
);

1344 
	`edge_lo›_chroma_h‹
–
imgUV
[1], 
Såígth
, 
MbQ
, 
edge_¸
, 1, 
p
);

1353 
edge
, 
edge_¸
;

1355 
edge
 = 0;Édge < 4 ; ++edge )

1357 if–
edge
 || 
fûãrLe·MbEdgeFœg
 )

1359 
byã
 *
Såígth
 = 
MbQ
->
°ªngth_vî
[
edge
];

1361 i‡((*((*Ë
Såígth
)))

1363 
	`edge_lo›_luma_vî
–
PLANE_Y
, 
imgY
, 
Såígth
, 
MbQ
, 
edge
 << 2);

1365 i‡(
a˘ive_•s
->
chroma_f‹m©_idc
==
YUV420
 ||á˘ive_•s->chroma_f‹m©_idc==
YUV422
)

1367 
edge_¸
 = 
chroma_edge
[0][
edge
][
p
->
chroma_f‹m©_idc
];

1368 if–(
imgUV
 !
NULL
Ë&& (
edge_¸
 >= 0))

1370 
	`edge_lo›_chroma_vî
–
imgUV
[0], 
Såígth
, 
MbQ
, 
edge_¸
, 0, 
p
);

1371 
	`edge_lo›_chroma_vî
–
imgUV
[1], 
Såígth
, 
MbQ
, 
edge_¸
, 1, 
p
);

1379  
edge
 = 0;Édge < 4 ; ++edge )

1381 if–
edge
 || 
fûãrT›MbEdgeFœg
 )

1383 
byã
 *
Såígth
 = 
MbQ
->
°ªngth_h‹
[
edge
];

1385 i‡((*((*Ë
Såígth
)))

1387 
	`edge_lo›_luma_h‹
–
PLANE_Y
, 
imgY
, 
Såígth
, 
MbQ
, 
edge
 << 2, 
p
) ;

1389 i‡(
a˘ive_•s
->
chroma_f‹m©_idc
==
YUV420
 ||á˘ive_•s->chroma_f‹m©_idc==
YUV422
)

1391 
edge_¸
 = 
chroma_edge
[1][
edge
][
p
->
chroma_f‹m©_idc
];

1392 if–(
imgUV
 !
NULL
Ë&& (
edge_¸
 >= 0))

1394 
	`edge_lo›_chroma_h‹
–
imgUV
[0], 
Såígth
, 
MbQ
, 
edge_¸
, 0, 
p
);

1395 
	`edge_lo›_chroma_h‹
–
imgUV
[1], 
Såígth
, 
MbQ
, 
edge_¸
, 1, 
p
);

1403 
	}
}

1411 
	$≥rf‹m_db_n‹mÆ
(
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
p
, 
MbQAddr
)

1413 
Ma¸oblock
 *
MbQ
 = &(
p_Vid
->
mb_d©a
[
MbQAddr
]) ;

1416 i‡(
MbQ
->
DFDißbÀIdc
 == 1)

1418 
MbQ
->
DeblockCÆl
 = 0;

1422 if(
MbQ
->
p_Sli˚
->
chroma444_nŸ_£∑øã
)

1423 
	`≥rf‹m_db_dï_n‹mÆ
(
MbQ
, 
p
);

1425 
	`≥rf‹m_db_öd_n‹mÆ
(
MbQ
, 
p
);

1426 
MbQ
->
DeblockCÆl
 = 0;

1428 
	}
}

1436 
	$gë_db_°ªngth_n‹mÆ
(
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
p
, 
MbQAddr
, *
piC¡
)

1438 
Ma¸oblock
 *
MbQ
 = &(
p_Vid
->
mb_d©a
[
MbQAddr
]) ;

1441 i‡(
MbQ
->
DFDißbÀIdc
 == 1)

1443 
MbQ
->
DeblockCÆl
 = 0;

1447 *
piC¡
 = (*piC¡ < 0)? 
MbQAddr
: (*piCnt);

1448 if(
MbQ
->
luma_å™sf‹m_size_8x8_Êag
)

1450 
fûãrLe·MbEdgeFœg
 = (
MbQ
->
pix_x
 != 0);

1451 
fûãrT›MbEdgeFœg
 = (
MbQ
->
pix_y
 != 0);

1453 
mvlimô
 = (
p
->
°ru˘uª
!=
FRAME
) ? 2 : 4;

1455 
MbQ
->
DeblockCÆl
 = 1;

1458 i‡(
MbQ
->
DFDißbÀIdc
==2)

1461 
fûãrLe·MbEdgeFœg
 = 
MbQ
->
mbAvaûA
;

1463 
fûãrT›MbEdgeFœg
 = 
MbQ
->
mbAvaûB
;

1467 if–
fûãrLe·MbEdgeFœg
 )

1468 
	`gë_°ªngth_vî
(
MbQ
, 0, 
mvlimô
, 
p
);

1469 
	`gë_°ªngth_vî
(
MbQ
, 2, 
mvlimô
, 
p
);

1472 if–
fûãrT›MbEdgeFœg
 )

1473 
	`gë_°ªngth_h‹
(
MbQ
, 0, 
mvlimô
, 
p
);

1474 
	`gë_°ªngth_h‹
(
MbQ
, 2, 
mvlimô
, 
p
);

1478 
fûãrLe·MbEdgeFœg
;

1479 
fûãrT›MbEdgeFœg
;

1481 
Sli˚
 *
cuºSli˚
 = 
MbQ
->
p_Sli˚
;

1482 
mvlimô
 = (
p
->
°ru˘uª
!=
FRAME
) ? 2 : 4;

1484 
MbQ
->
DeblockCÆl
 = 1;

1487 
fûãrLe·MbEdgeFœg
 = (
MbQ
->
pix_x
 != 0);

1488 
fûãrT›MbEdgeFœg
 = (
MbQ
->
pix_y
 != 0);

1490 i‡(
MbQ
->
DFDißbÀIdc
==2)

1493 
fûãrLe·MbEdgeFœg
 = 
MbQ
->
mbAvaûA
;

1495 
fûãrT›MbEdgeFœg
 = 
MbQ
->
mbAvaûB
;

1498 i‡((
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
 && 
MbQ
->
mb_ty≥
 =
PSKIP
Ë|| ((MbQ->mb_ty≥ =
P16x16
Ë&& (MbQ->
cbp
 == 0)))

1501 if–
fûãrLe·MbEdgeFœg
 )

1502 
	`gë_°ªngth_vî
(
MbQ
, 0, 
mvlimô
, 
p
);

1505 if–
fûãrT›MbEdgeFœg
 )

1506 
	`gë_°ªngth_h‹
(
MbQ
, 0, 
mvlimô
, 
p
);

1508 i‡((
MbQ
->
mb_ty≥
 =
P16x8
Ë&& (MbQ->
cbp
 == 0))

1511 if–
fûãrLe·MbEdgeFœg
 )

1512 
	`gë_°ªngth_vî
(
MbQ
, 0, 
mvlimô
, 
p
);

1515 if–
fûãrT›MbEdgeFœg
 )

1516 
	`gë_°ªngth_h‹
(
MbQ
, 0, 
mvlimô
, 
p
);

1517 
	`gë_°ªngth_h‹
(
MbQ
, 2, 
mvlimô
, 
p
);

1519 i‡((
MbQ
->
mb_ty≥
 =
P8x16
Ë&& (MbQ->
cbp
 == 0))

1522 if–
fûãrLe·MbEdgeFœg
 )

1523 
	`gë_°ªngth_vî
(
MbQ
, 0, 
mvlimô
, 
p
);

1524 
	`gë_°ªngth_vî
(
MbQ
, 2, 
mvlimô
, 
p
);

1527 if–
fûãrT›MbEdgeFœg
 )

1528 
	`gë_°ªngth_h‹
(
MbQ
, 0, 
mvlimô
, 
p
);

1530 i‡((
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
Ë&& (
MbQ
->
mb_ty≥
 =
BSKIP_DIRECT
Ë&& (
p_Vid
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
Ë&& (MbQ->
cbp
 == 0))

1533 if–
fûãrLe·MbEdgeFœg
 )

1534 
	`gë_°ªngth_vî
(
MbQ
, 0, 
mvlimô
, 
p
);

1535 
	`gë_°ªngth_vî
(
MbQ
, 2, 
mvlimô
, 
p
);

1538 if–
fûãrT›MbEdgeFœg
 )

1539 
	`gë_°ªngth_h‹
(
MbQ
, 0, 
mvlimô
, 
p
);

1540 
	`gë_°ªngth_h‹
(
MbQ
, 2, 
mvlimô
, 
p
);

1545 if–
fûãrLe·MbEdgeFœg
 )

1546 
	`gë_°ªngth_vî
(
MbQ
, 0, 
mvlimô
, 
p
);

1547 
	`gë_°ªngth_vî
(
MbQ
, 1, 
mvlimô
, 
p
);

1548 
	`gë_°ªngth_vî
(
MbQ
, 2, 
mvlimô
, 
p
);

1549 
	`gë_°ªngth_vî
(
MbQ
, 3, 
mvlimô
, 
p
);

1552 if–
fûãrT›MbEdgeFœg
 )

1553 
	`gë_°ªngth_h‹
(
MbQ
, 0, 
mvlimô
, 
p
);

1554 
	`gë_°ªngth_h‹
(
MbQ
, 1, 
mvlimô
, 
p
);

1555 
	`gë_°ªngth_h‹
(
MbQ
, 2, 
mvlimô
, 
p
);

1556 
	`gë_°ªngth_h‹
(
MbQ
, 3, 
mvlimô
, 
p
);

1559 
MbQ
->
DeblockCÆl
 = 0;

1561 
	}
}

1564 
	$deblock_n‹mÆ
(
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
p
)

1566 
i
;

1567 
j
=-1;

1568 
i
 = 0; i < 
p
->
PicSizeInMbs
; ++i)

1570 
	`gë_db_°ªngth_n‹mÆ
–
p_Vid
, 
p
, 
i
, &
j
) ;

1572 
i
 = 0; i < 
p
->
PicSizeInMbs
; ++i)

1574 
	`≥rf‹m_db_n‹mÆ
–
p_Vid
, 
p
, 
i
 ) ;

1576 
	}
}

	@ldecod/src/macroblock.c

23 
	~"c⁄åibut‹s.h
"

25 
	~<m©h.h
>

27 
	~"block.h
"

28 
	~"globÆ.h
"

29 
	~"mbuf„r.h
"

30 
	~"mbuf„r_mvc.h
"

31 
	~"ñemíts.h
"

33 
	~"ma¸oblock.h
"

34 
	~"fmo.h
"

35 
	~"ˇbac.h
"

36 
	~"vlc.h
"

37 
	~"image.h
"

38 
	~"mb_ac˚ss.h
"

39 
	~"büridecod.h
"

40 
	~"å™sf‹m.h
"

41 
	~"mc_¥edi˘i⁄.h
"

42 
	~"qu™t.h
"

43 
	~"mv_¥edi˘i⁄.h
"

44 
	~"mb_¥edi˘i⁄.h
"

45 
	~"Á°_mem‹y.h
"

46 
	~"fûeh™dÀ.h
"

49 #i‡
TRACE


50 
	#TRACE_STRING
(
s
Ë
	`°∫˝y
(
cuºSE
.
åa˚°rög
, s, 
TRACESTRING_SIZE
)

	)

51 
	#TRACE_DECBITS
(
i
Ë
	`de˘ø˚bô˙t
(1)

	)

52 
	#TRACE_PRINTF
(
s
Ë
	`•rötf
(
ty≥
, "%s", s);

	)

53 
	#TRACE_STRING_P
(
s
Ë
	`°∫˝y
(
cuºSE
->
åa˚°rög
, s, 
TRACESTRING_SIZE
)

	)

55 
	#TRACE_STRING
(
s
)

	)

56 
	#TRACE_DECBITS
(
i
)

	)

57 
	#TRACE_PRINTF
(
s
)

	)

58 
	#TRACE_STRING_P
(
s
)

	)

62 
de˘ø˚bô˙t
(
cou¡
);

65 
£tup_ªad_ma¸oblock
 (
Sli˚
 *
cuºSli˚
);

66 
£t_ªad_CBP_™d_c€ffs_ˇbac
 (
Sli˚
 *
cuºSli˚
);

67 
£t_ªad_CBP_™d_c€ffs_ˇvlc
 (
Sli˚
 *
cuºSli˚
);

68 
ªad_c€ff_4x4_CAVLC
 (
Ma¸oblock
 *
cuºMB
, 
block_ty≥
, 
i
, 
j
, 
Àv¨r
[16], 
ru«º
[16], *
numbî_c€fficõ¡s
);

69 
ªad_c€ff_4x4_CAVLC_444
 (
Ma¸oblock
 *
cuºMB
, 
block_ty≥
, 
i
, 
j
, 
Àv¨r
[16], 
ru«º
[16], *
numbî_c€fficõ¡s
);

71 
ªad_mŸi⁄_öfo_‰om_NAL_p_¶i˚
 (
Ma¸oblock
 *
cuºMB
);

72 
ªad_mŸi⁄_öfo_‰om_NAL_b_¶i˚
 (
Ma¸oblock
 *
cuºMB
);

74 
decode_⁄e_comp⁄ít_i_¶i˚
 (
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
cuº_∂™e
, 
img≥l
 **
cuºImg
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
);

75 
decode_⁄e_comp⁄ít_p_¶i˚
 (
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
cuº_∂™e
, 
img≥l
 **
cuºImg
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
);

76 
decode_⁄e_comp⁄ít_b_¶i˚
 (
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
cuº_∂™e
, 
img≥l
 **
cuºImg
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
);

77 
decode_⁄e_comp⁄ít_•_¶i˚
 (
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
cuº_∂™e
, 
img≥l
 **
cuºImg
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
);

78 
upd©e_dúe˘_ty≥s
 (
Sli˚
 *
cuºSli˚
);

79 
£t_öåa_¥edi˘i⁄_modes
 (
Sli˚
 *
cuºSli˚
);

87 
ölöe
 
	$BTy≥2CtxRef
 (
bty≥
)

89  (
bty≥
 >= 4);

90 
	}
}

98 
	$ªadRefPi˘uªIdx_VLC
(
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
cuºSE
, 
D©aP¨tôi⁄
 *
dP
, 
b8mode
, 
li°
)

100 #i‡
TRACE


101 
	`åa˚_öfo
(
cuºSE
, "ªf_idx_l", 
li°
);

103 
cuºSE
->
c⁄ãxt
 = 
	`BTy≥2CtxRef
 (
b8mode
);

104 
cuºSE
->
vÆue2
 = 
li°
;

105 
dP
->
	`ªadSy¡axEÀmít
 (
cuºMB
, 
cuºSE
, dP);

106  (Ë
cuºSE
->
vÆue1
;

107 
	}
}

115 
	$ªadRefPi˘uªIdx_FLC
(
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
cuºSE
, 
D©aP¨tôi⁄
 *
dP
, 
b8mode
, 
li°
)

117 #i‡
TRACE


118 
	`åa˚_öfo
(
cuºSE
, "ªf_idx_l", 
li°
);

121 
cuºSE
->
c⁄ãxt
 = 
	`BTy≥2CtxRef
 (
b8mode
);

122 
cuºSE
->
Àn
 = 1;

123 
	`ªadSy¡axEÀmít_FLC
(
cuºSE
, 
dP
->
bô°ªam
);

124 
cuºSE
->
vÆue1
 = 1 - currSE->value1;

126  (Ë
cuºSE
->
vÆue1
;

127 
	}
}

135 
	$ªadRefPi˘uªIdx_NuŒ
(
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
cuºSE
, 
D©aP¨tôi⁄
 *
dP
, 
b8mode
, 
li°
)

138 
	}
}

146 
	$¥ï¨eLi°f‹RefIdx
 ( 
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
cuºSE
, 
D©aP¨tôi⁄
 *
dP
, 
num_ªf_idx_a˘ive
, 
ªfidx_¥e£¡
)

148 if(
num_ªf_idx_a˘ive
 > 1)

150 i‡(
cuºMB
->
p_Vid
->
a˘ive_µs
->
íå›y_codög_mode_Êag
 =(
Boﬁón
Ë
CAVLC
 || 
dP
->
bô°ªam
->
ei_Êag
)

152 
cuºSE
->
m≠pög
 = 
löfo_ue
;

153 i‡(
ªfidx_¥e£¡
)

154 
cuºMB
->
ªadRefPi˘uªIdx
 = (
num_ªf_idx_a˘ive
 =2Ë? 
ªadRefPi˘uªIdx_FLC
 : 
ªadRefPi˘uªIdx_VLC
;

156 
cuºMB
->
ªadRefPi˘uªIdx
 = 
ªadRefPi˘uªIdx_NuŒ
;

160 
cuºSE
->
ªadög
 = 
ªadRefFøme_CABAC
;

161 
cuºMB
->
ªadRefPi˘uªIdx
 = (
ªfidx_¥e£¡
Ë? 
ªadRefPi˘uªIdx_VLC
 : 
ªadRefPi˘uªIdx_NuŒ
;

165 
cuºMB
->
ªadRefPi˘uªIdx
 = 
ªadRefPi˘uªIdx_NuŒ
;

166 
	}
}

168 
	$£t_chroma_qp
(
Ma¸oblock
* 
cuºMB
)

170 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

171 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
cuºMB
->
p_Sli˚
->dec_picture;

172 
i
;

174 
i
=0; i<2; ++i)

176 
cuºMB
->
qpc
[
i
] = 
	`iClù3
 ( -
p_Vid
->
bôdïth_chroma_qp_sˇÀ
, 51, cuºMB->
qp
 + 
dec_pi˘uª
->
chroma_qp_off£t
[i] );

177 
cuºMB
->
qpc
[
i
] = cuºMB->qpc[i] < 0 ? cuºMB->qpc[i] : 
QP_SCALE_CR
[currMB->qpc[i]];

178 
cuºMB
->
qp_sˇÀd
[
i
 + 1] = cuºMB->
qpc
[i] + 
p_Vid
->
bôdïth_chroma_qp_sˇÀ
;

180 
	}
}

188 
	$upd©e_qp
(
Ma¸oblock
 *
cuºMB
, 
qp
)

190 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

191 
cuºMB
->
qp
 = qp;

192 
cuºMB
->
qp_sˇÀd
[0] = 
qp
 + 
p_Vid
->
bôdïth_luma_qp_sˇÀ
;

193 
	`£t_chroma_qp
(
cuºMB
);

194 
cuºMB
->
is_los¶ess
 = (
Boﬁón
Ë((cuºMB->
qp_sˇÀd
[0] =0Ë&& (
p_Vid
->
los¶ess_qµrime_Êag
 == 1));

195 
	}
}

197 
	$ªad_dñè_qu™t
(
Sy¡axEÀmít
 *
cuºSE
, 
D©aP¨tôi⁄
 *
dP
, 
Ma¸oblock
 *
cuºMB
, c⁄° 
byã
 *
∑πM≠
, 
ty≥
)

199 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

200 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

202 
cuºSE
->
ty≥
 =Åype;

204 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
cuºSE
->
ty≥
]]);

206 i‡(
p_Vid
->
a˘ive_µs
->
íå›y_codög_mode_Êag
 =(
Boﬁón
Ë
CAVLC
 || 
dP
->
bô°ªam
->
ei_Êag
)

208 
cuºSE
->
m≠pög
 = 
löfo_£
;

211 
cuºSE
->
ªadög

ªad_dQu™t_CABAC
;

213 
	`TRACE_STRING_P
("mb_qp_delta");

215 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, 
cuºSE
, dP);

216 
cuºMB
->
dñè_qu™t
 = (Ë
cuºSE
->
vÆue1
;

217 i‡((
cuºMB
->
dñè_qu™t
 < -(26 + 
p_Vid
->
bôdïth_luma_qp_sˇÀ
/2)) || (currMB->delta_quant > (25 +Ö_Vid->bitdepth_luma_qp_scale/2)))

219 
	`¥ötf
("mb_qp_dñè i†ouào‡øngê(%d)\n", 
cuºMB
->
dñè_qu™t
);

220 
cuºMB
->
dñè_qu™t
 = 
	`iClù3
(-(26 + 
p_Vid
->
bôdïth_luma_qp_sˇÀ
/2), (25 +Ö_Vid->bitdepth_luma_qp_scale/2), currMB->delta_quant);

225 
cuºSli˚
->
qp
 = ((cuºSli˚->q∞+ 
cuºMB
->
dñè_qu™t
 + 52 + 2*
p_Vid
->
bôdïth_luma_qp_sˇÀ
)%(52+p_Vid->bitdepth_luma_qp_scale)) -Ö_Vid->bitdepth_luma_qp_scale;

226 
	`upd©e_qp
(
cuºMB
, 
cuºSli˚
->
qp
);

227 
	}
}

235 
	$ªadMBRefPi˘uªIdx
 (
Sy¡axEÀmít
 *
cuºSE
, 
D©aP¨tôi⁄
 *
dP
, 
Ma¸oblock
 *
cuºMB
, 
PicMŸi⁄P¨ams
 **
mv_öfo
, 
li°
, 
°ï_v0
, 
°ï_h0
)

237 i‡(
cuºMB
->
mb_ty≥
 == 1)

239 i‡((
cuºMB
->
b8pdú
[0] =
li°
 || cuºMB->b8pdú[0] =
BI_PRED
))

241 
j
, 
i
;

242 
ªf‰ame
;

245 
cuºMB
->
subblock_x
 = 0;

246 
cuºMB
->
subblock_y
 = 0;

247 
ªf‰ame
 = 
cuºMB
->
	`ªadRefPi˘uªIdx
(cuºMB, 
cuºSE
, 
dP
, 1, 
li°
);

248 
j
 = 0; j < 
°ï_v0
; ++j)

250 *
ªf_idx
 = &
mv_öfo
[
j
][
cuºMB
->
block_x
].ªf_idx[
li°
];

252 
i
 = 0; i < 
°ï_h0
; ++i)

255 *
ªf_idx
 = 
ªf‰ame
;

256 
ªf_idx
 +(
PicMŸi⁄P¨ams
);

261 i‡(
cuºMB
->
mb_ty≥
 == 2)

263 
k
, 
j
, 
i
, 
j0
;

264 
ªf‰ame
;

266 
j0
 = 0; j0 < 4; j0 +
°ï_v0
)

268 
k
 = 
j0
;

270 i‡((
cuºMB
->
b8pdú
[
k
] =
li°
 || cuºMB->b8pdú[k] =
BI_PRED
))

272 
cuºMB
->
subblock_y
 = 
j0
 << 2;

273 
cuºMB
->
subblock_x
 = 0;

274 
ªf‰ame
 = 
cuºMB
->
	`ªadRefPi˘uªIdx
(cuºMB, 
cuºSE
, 
dP
, cuºMB->
b8mode
[
k
], 
li°
);

275 
j
 = 
j0
; j < j0 + 
°ï_v0
; ++j)

277 *
ªf_idx
 = &
mv_öfo
[
j
][
cuºMB
->
block_x
].ªf_idx[
li°
];

279 
i
 = 0; i < 
°ï_h0
; ++i)

282 *
ªf_idx
 = 
ªf‰ame
;

283 
ªf_idx
 +(
PicMŸi⁄P¨ams
);

289 i‡(
cuºMB
->
mb_ty≥
 == 3)

291 
k
, 
j
, 
i
, 
i0
;

292 
ªf‰ame
;

294 
cuºMB
->
subblock_y
 = 0;

295 
i0
 = 0; i0 < 4; i0 +
°ï_h0
)

297 
k
 = (
i0
 >> 1);

299 i‡((
cuºMB
->
b8pdú
[
k
] =
li°
 || cuºMB->b8pdú[k] =
BI_PRED
Ë&& cuºMB->
b8mode
[k] != 0)

301 
cuºMB
->
subblock_x
 = 
i0
 << 2;

302 
ªf‰ame
 = 
cuºMB
->
	`ªadRefPi˘uªIdx
(cuºMB, 
cuºSE
, 
dP
, cuºMB->
b8mode
[
k
], 
li°
);

303 
j
 = 0; j < 
°ï_v0
; ++j)

305 *
ªf_idx
 = &
mv_öfo
[
j
][
cuºMB
->
block_x
 + 
i0
].ªf_idx[
li°
];

307 
i
 = 0; i < 
°ï_h0
; ++i)

310 *
ªf_idx
 = 
ªf‰ame
;

311 
ªf_idx
 +(
PicMŸi⁄P¨ams
);

319 
k
, 
j
, 
i
, 
j0
, 
i0
;

320 
ªf‰ame
;

322 
j0
 = 0; j0 < 4; j0 +
°ï_v0
)

324 
cuºMB
->
subblock_y
 = 
j0
 << 2;

325 
i0
 = 0; i0 < 4; i0 +
°ï_h0
)

327 
k
 = 2 * (
j0
 >> 1Ë+ (
i0
 >> 1);

329 i‡((
cuºMB
->
b8pdú
[
k
] =
li°
 || cuºMB->b8pdú[k] =
BI_PRED
Ë&& cuºMB->
b8mode
[k] != 0)

331 
cuºMB
->
subblock_x
 = 
i0
 << 2;

332 
ªf‰ame
 = 
cuºMB
->
	`ªadRefPi˘uªIdx
(cuºMB, 
cuºSE
, 
dP
, cuºMB->
b8mode
[
k
], 
li°
);

333 
j
 = 
j0
; j < j0 + 
°ï_v0
; ++j)

335 *
ªf_idx
 = &
mv_öfo
[
j
][
cuºMB
->
block_x
 + 
i0
].ªf_idx[
li°
];

337 
i
 = 0; i < 
°ï_h0
; ++i)

340 *
ªf_idx
 = 
ªf‰ame
;

341 
ªf_idx
 +(
PicMŸi⁄P¨ams
);

348 
	}
}

356 
	$ªadMBMŸi⁄Ve˘‹s
 (
Sy¡axEÀmít
 *
cuºSE
, 
D©aP¨tôi⁄
 *
dP
, 
Ma¸oblock
 *
cuºMB
, 
li°
, 
°ï_h0
, 
°ï_v0
)

358 i‡(
cuºMB
->
mb_ty≥
 == 1)

360 i‡((
cuºMB
->
b8pdú
[0] =
li°
 || cuºMB->b8pdú[0]=
BI_PRED
))

362 
i4
, 
j4
, 
ii
, 
jj
;

363 
cuº_mvd
[2];

364 
MŸi⁄Ve˘‹
 
¥ed_mv
, 
cuº_mv
;

365 (*
mvd
)[4][2];

367 
PicMŸi⁄P¨ams
 **
mv_öfo
 = 
cuºMB
->
p_Sli˚
->
dec_pi˘uª
->mv_info;

368 
PixñPos
 
block
[4];

370 
cuºMB
->
subblock_x
 = 0;

371 
cuºMB
->
subblock_y
 = 0;

372 
i4
 = 
cuºMB
->
block_x
;

373 
j4
 = 
cuºMB
->
block_y
;

374 
mvd
 = &
cuºMB
->mvd [
li°
][0];

376 
	`gë_√ighb‹s
(
cuºMB
, 
block
, 0, 0, 
°ï_h0
 << 2);

379 
cuºMB
->
	`GëMVPªdi˘‹
 (cuºMB, 
block
, &
¥ed_mv
, 
mv_öfo
[
j4
][
i4
].
ªf_idx
[
li°
], mv_öfo,Üi°, 0, 0, 
°ï_h0
 << 2, 
°ï_v0
 << 2);

382 #i‡
TRACE


383 
	`åa˚_öfo
(
cuºSE
, "mvd0_l", 
li°
);

385 
cuºSE
->
vÆue2
 = 
li°
;

386 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, 
cuºSE
, dP);

387 
cuº_mvd
[0] = (Ë
cuºSE
->
vÆue1
;

390 #i‡
TRACE


391 
	`åa˚_öfo
(
cuºSE
, "mvd1_l", 
li°
);

393 
cuºSE
->
vÆue2
 += 2;

394 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, 
cuºSE
, dP);

395 
cuº_mvd
[1] = (Ë
cuºSE
->
vÆue1
;

397 
cuº_mv
.
mv_x
 = ()(
cuº_mvd
[0] + 
¥ed_mv
.mv_x);

398 
cuº_mv
.
mv_y
 = ()(
cuº_mvd
[1] + 
¥ed_mv
.mv_y);

400 
jj
 = 
j4
; jj < j4 + 
°ï_v0
; ++jj)

402 
PicMŸi⁄P¨ams
 *
mvöfo
 = 
mv_öfo
[
jj
] + 
i4
;

403 
ii
 = 
i4
; iò< i4 + 
°ï_h0
; ++ii)

405 (
mvöfo
++)->
mv
[
li°
] = 
cuº_mv
;

410 
ii
 = 0; iò< 
°ï_h0
; ++ii)

413 
mvd
[0][
ii
][0] = 
cuº_mvd
[0];

414 
mvd
[0][
ii
][1] = 
cuº_mvd
[1];

418 
jj
 = 1; jj < 
°ï_v0
; ++jj)

420 
	`mem˝y
(
mvd
[
jj
][0], mvd[0][0], 2 * 
°ï_h0
 * ());

426 
i4
, 
j4
, 
ii
, 
jj
;

427 
cuº_mvd
[2];

428 
MŸi⁄Ve˘‹
 
¥ed_mv
, 
cuº_mv
;

429 (*
mvd
)[4][2];

431 
PicMŸi⁄P¨ams
 **
mv_öfo
 = 
cuºMB
->
p_Sli˚
->
dec_pi˘uª
->mv_info;

432 
PixñPos
 
block
[4];

434 
i
, 
j
, 
i0
, 
j0
, 
kk
, 
k
;

435 
j0
=0; j0<4; j0+=
°ï_v0
)

437 
i0
=0; i0<4; i0+=
°ï_h0
)

439 
kk
 = 2 * (
j0
 >> 1Ë+ (
i0
 >> 1);

441 i‡((
cuºMB
->
b8pdú
[
kk
] =
li°
 || cuºMB->b8pdú[kk]=
BI_PRED
Ë&& (cuºMB->
b8mode
[kk] != 0))

443 
cur_ªf_idx
 = 
mv_öfo
[
cuºMB
->
block_y
+
j0
][cuºMB->
block_x
+
i0
].
ªf_idx
[
li°
];

444 
mv_mode
 = 
cuºMB
->
b8mode
[
kk
];

445 
°ï_h
 = 
BLOCK_STEP
 [
mv_mode
][0];

446 
°ï_v
 = 
BLOCK_STEP
 [
mv_mode
][1];

447 
°ï_h4
 = 
°ï_h
 << 2;

448 
°ï_v4
 = 
°ï_v
 << 2;

450 
j
 = 
j0
; j < j0 + 
°ï_v0
; j +
°ï_v
)

452 
cuºMB
->
subblock_y
 = 
j
 << 2;

453 
j4
 = 
cuºMB
->
block_y
 + 
j
;

454 
mvd
 = &
cuºMB
->mvd [
li°
][
j
];

456 
i
 = 
i0
; i < i0 + 
°ï_h0
; i +
°ï_h
)

458 
cuºMB
->
subblock_x
 = 
i
 << 2;

459 
i4
 = 
cuºMB
->
block_x
 + 
i
;

461 
	`gë_√ighb‹s
(
cuºMB
, 
block
, 
BLOCK_SIZE
 * 
i
, BLOCK_SIZE * 
j
, 
°ï_h4
);

464 
cuºMB
->
	`GëMVPªdi˘‹
 (cuºMB, 
block
, &
¥ed_mv
, 
cur_ªf_idx
, 
mv_öfo
, 
li°
, 
BLOCK_SIZE
 * 
i
, BLOCK_SIZE * 
j
, 
°ï_h4
, 
°ï_v4
);

466 
k
=0; k < 2; ++k)

468 #i‡
TRACE


469 
	`åa˚_öfo
(
cuºSE
, "mvd_l", 
li°
);

471 
cuºSE
->
vÆue2
 = (
k
 << 1Ë+ 
li°
;

472 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, 
cuºSE
, dP);

473 
cuº_mvd
[
k
] = (Ë
cuºSE
->
vÆue1
;

476 
cuº_mv
.
mv_x
 = ()(
cuº_mvd
[0] + 
¥ed_mv
.mv_x);

477 
cuº_mv
.
mv_y
 = ()(
cuº_mvd
[1] + 
¥ed_mv
.mv_y);

479 
jj
 = 
j4
; jj < j4 + 
°ï_v
; ++jj)

481 
PicMŸi⁄P¨ams
 *
mvöfo
 = 
mv_öfo
[
jj
] + 
i4
;

482 
ii
 = 
i4
; iò< i4 + 
°ï_h
; ++ii)

484 (
mvöfo
++)->
mv
[
li°
] = 
cuº_mv
;

489 
ii
 = 
i
; iò< i + 
°ï_h
; ++ii)

492 
mvd
[0][
ii
][0] = 
cuº_mvd
[0];

493 
mvd
[0][
ii
][1] = 
cuº_mvd
[1];

497 
jj
 = 1; jj < 
°ï_v
; ++jj)

499 
	`mem˝y
(&
mvd
[
jj
][
i
][0], &mvd[0][i][0], 2 * 
°ï_h
 * ());

507 
	}
}

509 
övSˇÀC€ff
(
Ma¸oblock
 *
cuºMB
, 
Àvñ
, 
run
, 
qp_≥r
, 
i
, 
j
, 
i0
, 
j0
, 
c€f_˘r
, c⁄° 
byã
 (*
pos_sˇn4x4
)[2], (*
InvLevñSˇÀ4x4
)[4])

511 i‡(
	gÀvñ
 != 0)

513 
c€f_˘r
 +
run
 + 1;

515 
	gi0
 = 
pos_sˇn4x4
[
c€f_˘r
][0];

516 
	gj0
 = 
pos_sˇn4x4
[
c€f_˘r
][1];

518 
	gcuºMB
->
	gs_cbp
[0].
	gblk
 |
i64_powî2
((
j
 << 2Ë+ 
i
) ;

519 
	gcuºMB
->
	gp_Sli˚
->
	gcof
[0][(
j
<<2Ë+ 
j0
][(
i
<<2Ë+ 
i0
]
rshi·_∫d_sf
((
Àvñ
 * 
InvLevñSˇÀ4x4
[j0][i0]Ë<< 
qp_≥r
, 4);

523 
ölöe
 
	$£tup_mb_pos_öfo
(
Ma¸oblock
 *
cuºMB
)

525 
mb_x
 = 
cuºMB
->
mb
.
x
;

526 
mb_y
 = 
cuºMB
->
mb
.
y
;

527 
cuºMB
->
block_x
 = 
mb_x
 << 
BLOCK_SHIFT
;

528 
cuºMB
->
block_y
 = 
mb_y
 << 
BLOCK_SHIFT
;

529 
cuºMB
->
block_y_aff
 = cuºMB->
block_y
;

530 
cuºMB
->
pix_x
 = 
mb_x
 << 
MB_BLOCK_SHIFT
;

531 
cuºMB
->
pix_y
 = 
mb_y
 << 
MB_BLOCK_SHIFT
;

532 
cuºMB
->
pix_c_x
 = 
mb_x
 * cuºMB->
p_Vid
->
mb_¸_size_x
;

533 
cuºMB
->
pix_c_y
 = 
mb_y
 * cuºMB->
p_Vid
->
mb_¸_size_y
;

534 
	}
}

542 
	$°¨t_ma¸oblock
(
Sli˚
 *
cuºSli˚
, 
Ma¸oblock
 **
cuºMB
)

544 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

545 
mb_ƒ
 = 
cuºSli˚
->
cuºít_mb_ƒ
;

547 *
cuºMB
 = &
cuºSli˚
->
mb_d©a
[
mb_ƒ
];

549 (*
cuºMB
)->
p_Sli˚
 = 
cuºSli˚
;

550 (*
cuºMB
)->
p_Vid
 =Ö_Vid;

551 (*
cuºMB
)->
mbAddrX
 = 
mb_ƒ
;

556 i‡(
cuºSli˚
->
mb_aff_‰ame_Êag
)

558 (*
cuºMB
)->
mb
.
x
 = (Ë–(
mb_ƒ
Ë% ((2*
p_Vid
->
width
Ë/ 
MB_BLOCK_SIZE
));

559 (*
cuºMB
)->
mb
.
y
 = (Ë(2*((
mb_ƒ
Ë/ ((2*
p_Vid
->
width
Ë/ 
MB_BLOCK_SIZE
)));

561 (*
cuºMB
)->
mb
.
y
 +((*cuºMB)->mb.
x
 & 0x01);

562 (*
cuºMB
)->
mb
.
x
 >>= 1;

566 (*
cuºMB
)->
mb
 = 
p_Vid
->
PicPos
[
mb_ƒ
];

570 
	`£tup_mb_pos_öfo
(*
cuºMB
);

573 (*
cuºMB
)->
is_öåa_block
 = 
FALSE
;

575 (*
cuºMB
)->
mb_ty≥
 = 0;

576 (*
cuºMB
)->
dñè_qu™t
 = 0;

577 (*
cuºMB
)->
cbp
 = 0;

578 (*
cuºMB
)->
c_ùªd_mode
 = 
DC_PRED_8
;

582 (*
cuºMB
)->
¶i˚_ƒ
 = (Ë
cuºSli˚
->
cuºít_¶i˚_ƒ
;

584 
	`CheckAvaûabûôyOfNeighb‹s
(*
cuºMB
);

587 
	`öô_mŸi⁄_ve˘‹_¥edi˘i⁄
(*
cuºMB
, 
cuºSli˚
->
mb_aff_‰ame_Êag
);

589 
	`£t_ªad_™d_°‹e_CBP
(
cuºMB
, 
cuºSli˚
->
a˘ive_•s
->
chroma_f‹m©_idc
);

593 i‡(
cuºSli˚
->
¶i˚_ty≥
 !
I_SLICE
)

595 i‡(
cuºSli˚
->
¶i˚_ty≥
 !
B_SLICE
)

596 
	`Á°_mem£t
((*
cuºMB
)->
mvd
[0][0][0], 0, 
MB_BLOCK_PARTITIONS
 * 2 * ());

598 
	`Á°_mem£t
((*
cuºMB
)->
mvd
[0][0][0], 0, 2 * 
MB_BLOCK_PARTITIONS
 * 2 * ());

601 
	`Á°_mem£t
((*
cuºMB
)->
s_cbp
, 0, 3 * (
CBPSåu˘uª
));

604 i‡(
cuºSli˚
->
is_ª£t_c€ff
 =
FALSE
)

606 
	`Á°_mem£t_zîo
–
cuºSli˚
->
mb_ºes
[0][0], 
MB_PIXELS
 * ());

607 
	`Á°_mem£t_zîo
–
cuºSli˚
->
mb_ºes
[1][0], 
p_Vid
->
mb_¸_size
 * ());

608 
	`Á°_mem£t_zîo
–
cuºSli˚
->
mb_ºes
[2][0], 
p_Vid
->
mb_¸_size
 * ());

609 i‡(
cuºSli˚
->
is_ª£t_c€ff_¸
 =
FALSE
)

611 
	`Á°_mem£t_zîo
–
cuºSli˚
->
cof
[0][0], 3 * 
MB_PIXELS
 * ());

612 
cuºSli˚
->
is_ª£t_c€ff_¸
 = 
TRUE
;

616 
	`Á°_mem£t_zîo
–
cuºSli˚
->
cof
[0][0], 
MB_PIXELS
 * ());

626 
cuºSli˚
->
is_ª£t_c€ff
 = 
TRUE
;

630 (*
cuºMB
)->
DFDißbÀIdc
 = 
cuºSli˚
->DFDisableIdc;

631 (*
cuºMB
)->
DFAÕhaC0Off£t
 = 
cuºSli˚
->DFAlphaC0Offset;

632 (*
cuºMB
)->
DFBëaOff£t
 = 
cuºSli˚
->DFBetaOffset;

633 (*
cuºMB
)->
li°_off£t
 = 0;

634 (*
cuºMB
)->
mixedModeEdgeFœg
 = 0;

635 
	}
}

644 
Boﬁón
 
	$exô_ma¸oblock
(
Sli˚
 *
cuºSli˚
, 
eos_bô
)

646 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

654 ++(
cuºSli˚
->
num_dec_mb
);

656 if(
cuºSli˚
->
cuºít_mb_ƒ
 =
p_Vid
->
PicSizeInMbs
 - 1)

658  
TRUE
;

664 
cuºSli˚
->
cuºít_mb_ƒ
 = 
	`FmoGëNextMBNr
 (
p_Vid
, currSlice->current_mb_nr);

666 i‡(
cuºSli˚
->
cuºít_mb_ƒ
 == -1)

668 
	`as£π
 (
cuºSli˚
->
	`«l_°¨tcode_fﬁlows
 (cuºSli˚, 
eos_bô
Ë=
TRUE
);

669  
TRUE
;

672 if(
cuºSli˚
->
	`«l_°¨tcode_fﬁlows
(cuºSli˚, 
eos_bô
Ë=
FALSE
)

673  
FALSE
;

675 if(
cuºSli˚
->
¶i˚_ty≥
 =
I_SLICE
 || cuºSli˚->¶i˚_ty≥ =
SI_SLICE
 || 
p_Vid
->
a˘ive_µs
->
íå›y_codög_mode_Êag
 =(
Boﬁón
Ë
CABAC
)

676  
TRUE
;

677 if(
cuºSli˚
->
cod_cou¡î
 <= 0)

678  
TRUE
;

679  
FALSE
;

681 
	}
}

689 
	$öãΩªt_mb_mode_P
(
Ma¸oblock
 *
cuºMB
)

691 c⁄° 
ICBPTAB
[6] = {0,16,32,15,31,47};

692 
mbmode
 = 
cuºMB
->
mb_ty≥
;

694 if(
mbmode
 < 4)

696 
cuºMB
->
mb_ty≥
 = 
mbmode
;

697 
	`mem£t
(
cuºMB
->
b8mode
, 
mbmode
, 4 * ());

698 
	`mem£t
(
cuºMB
->
b8pdú
, 0, 4 * ());

700 if((
mbmode
 == 4 || mbmode == 5))

702 
cuºMB
->
mb_ty≥
 = 
P8x8
;

703 
cuºMB
->
p_Sli˚
->
ÆÃefzîo
 = (
mbmode
 == 5);

705 if(
mbmode
 == 6)

707 
cuºMB
->
is_öåa_block
 = 
TRUE
;

708 
cuºMB
->
mb_ty≥
 = 
I4MB
;

709 
	`mem£t
(
cuºMB
->
b8mode
, 
IBLOCK
, 4 * ());

710 
	`mem£t
(
cuºMB
->
b8pdú
, -1, 4 * ());

712 if(
mbmode
 == 31)

714 
cuºMB
->
is_öåa_block
 = 
TRUE
;

715 
cuºMB
->
mb_ty≥
 = 
IPCM
;

716 
cuºMB
->
cbp
 = -1;

717 
cuºMB
->
i16mode
 = 0;

719 
	`mem£t
(
cuºMB
->
b8mode
, 0, 4 * ());

720 
	`mem£t
(
cuºMB
->
b8pdú
,-1, 4 * ());

724 
cuºMB
->
is_öåa_block
 = 
TRUE
;

725 
cuºMB
->
mb_ty≥
 = 
I16MB
;

726 
cuºMB
->
cbp
 = 
ICBPTAB
[((
mbmode
-7))>>2];

727 
cuºMB
->
i16mode
 = ((
mbmode
-7)) & 0x03;

728 
	`mem£t
(
cuºMB
->
b8mode
, 0, 4 * ());

729 
	`mem£t
(
cuºMB
->
b8pdú
,-1, 4 * ());

731 
	}
}

739 
	$öãΩªt_mb_mode_I
(
Ma¸oblock
 *
cuºMB
)

741 c⁄° 
ICBPTAB
[6] = {0,16,32,15,31,47};

742 
mbmode
 = 
cuºMB
->
mb_ty≥
;

744 i‡(
mbmode
 == 0)

746 
cuºMB
->
is_öåa_block
 = 
TRUE
;

747 
cuºMB
->
mb_ty≥
 = 
I4MB
;

748 
	`mem£t
(
cuºMB
->
b8mode
,
IBLOCK
,4 * ());

749 
	`mem£t
(
cuºMB
->
b8pdú
,-1,4 * ());

751 if(
mbmode
 == 25)

753 
cuºMB
->
is_öåa_block
 = 
TRUE
;

754 
cuºMB
->
mb_ty≥
=
IPCM
;

755 
cuºMB
->
cbp
= -1;

756 
cuºMB
->
i16mode
 = 0;

758 
	`mem£t
(
cuºMB
->
b8mode
, 0,4 * ());

759 
	`mem£t
(
cuºMB
->
b8pdú
,-1,4 * ());

763 
cuºMB
->
is_öåa_block
 = 
TRUE
;

764 
cuºMB
->
mb_ty≥
 = 
I16MB
;

765 
cuºMB
->
cbp

ICBPTAB
[(
mbmode
-1)>>2];

766 
cuºMB
->
i16mode
 = (
mbmode
-1) & 0x03;

767 
	`mem£t
(
cuºMB
->
b8mode
, 0, 4 * ());

768 
	`mem£t
(
cuºMB
->
b8pdú
,-1, 4 * ());

770 
	}
}

778 
	$öãΩªt_mb_mode_B
(
Ma¸oblock
 *
cuºMB
)

780 c⁄° 
off£t2pdú16x16
[12] = {0, 0, 1, 2, 0,0,0,0,0,0,0,0};

781 c⁄° 
off£t2pdú16x8
[22][2] = {{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{1,1},{0,0},{0,1},{0,0},{1,0},

783 c⁄° 
off£t2pdú8x16
[22][2] = {{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{1,1},{0,0},{0,1},{0,0},

786 c⁄° 
ICBPTAB
[6] = {0,16,32,15,31,47};

788 
i
, 
mbmode
;

789 
mbty≥
 = 
cuºMB
->
mb_ty≥
;

792 i‡(
mbty≥
 == 0)

794 
mbmode
=0;

795 
	`mem£t
(
cuºMB
->
b8mode
, 0, 4 * ());

796 
	`mem£t
(
cuºMB
->
b8pdú
, 2, 4 * ());

798 i‡(
mbty≥
 == 23)

800 
cuºMB
->
is_öåa_block
 = 
TRUE
;

801 
mbmode
=
I4MB
;

802 
	`mem£t
(
cuºMB
->
b8mode
, 
IBLOCK
,4 * ());

803 
	`mem£t
(
cuºMB
->
b8pdú
, -1,4 * ());

805 i‡((
mbty≥
 > 23) && (mbtype < 48) )

807 
cuºMB
->
is_öåa_block
 = 
TRUE
;

808 
mbmode
=
I16MB
;

809 
	`mem£t
(
cuºMB
->
b8mode
, 0, 4 * ());

810 
	`mem£t
(
cuºMB
->
b8pdú
, -1, 4 * ());

812 
cuºMB
->
cbp
 = (Ë
ICBPTAB
[(
mbty≥
-24)>>2];

813 
cuºMB
->
i16mode
 = (
mbty≥
-24) & 0x03;

815 i‡(
mbty≥
 == 22)

817 
mbmode
=
P8x8
;

819 i‡(
mbty≥
 < 4)

821 
mbmode
 = 1;

822 
	`mem£t
(
cuºMB
->
b8mode
, 1,4 * ());

823 
	`mem£t
(
cuºMB
->
b8pdú
, 
off£t2pdú16x16
[
mbty≥
], 4 * ());

825 if(
mbty≥
 == 48)

827 
cuºMB
->
is_öåa_block
 = 
TRUE
;

828 
mbmode
=
IPCM
;

829 
	`mem£t
(
cuºMB
->
b8mode
, 0,4 * ());

830 
	`mem£t
(
cuºMB
->
b8pdú
,-1,4 * ());

832 
cuºMB
->
cbp
= -1;

833 
cuºMB
->
i16mode
 = 0;

835 i‡((
mbty≥
 & 0x01) == 0)

837 
mbmode
 = 2;

838 
	`mem£t
(
cuºMB
->
b8mode
, 2,4 * ());

839 
i
=0;i<4;++i)

841 
cuºMB
->
b8pdú
[
i
] = 
off£t2pdú16x8
 [
mbty≥
][i>>1];

846 
mbmode
=3;

847 
	`mem£t
(
cuºMB
->
b8mode
, 3,4 * ());

848 
i
=0;i<4; ++i)

850 
cuºMB
->
b8pdú
[
i
] = 
off£t2pdú8x16
 [
mbty≥
][i&0x01];

853 
cuºMB
->
mb_ty≥
 = 
mbmode
;

854 
	}
}

862 
	$öãΩªt_mb_mode_SI
(
Ma¸oblock
 *
cuºMB
)

865 c⁄° 
ICBPTAB
[6] = {0,16,32,15,31,47};

866 
mbmode
 = 
cuºMB
->
mb_ty≥
;

868 i‡(
mbmode
 == 0)

870 
cuºMB
->
is_öåa_block
 = 
TRUE
;

871 
cuºMB
->
mb_ty≥
 = 
SI4MB
;

872 
	`mem£t
(
cuºMB
->
b8mode
,
IBLOCK
,4 * ());

873 
	`mem£t
(
cuºMB
->
b8pdú
,-1,4 * ());

874 
cuºMB
->
p_Sli˚
->
siblock
[cuºMB->
mb
.
y
][cuºMB->mb.
x
]=1;

876 i‡(
mbmode
 == 1)

878 
cuºMB
->
is_öåa_block
 = 
TRUE
;

879 
cuºMB
->
mb_ty≥
 = 
I4MB
;

880 
	`mem£t
(
cuºMB
->
b8mode
,
IBLOCK
,4 * ());

881 
	`mem£t
(
cuºMB
->
b8pdú
,-1,4 * ());

883 if(
mbmode
 == 26)

885 
cuºMB
->
is_öåa_block
 = 
TRUE
;

886 
cuºMB
->
mb_ty≥
=
IPCM
;

887 
cuºMB
->
cbp
= -1;

888 
cuºMB
->
i16mode
 = 0;

889 
	`mem£t
(
cuºMB
->
b8mode
,0,4 * ());

890 
	`mem£t
(
cuºMB
->
b8pdú
,-1,4 * ());

895 
cuºMB
->
is_öåa_block
 = 
TRUE
;

896 
cuºMB
->
mb_ty≥
 = 
I16MB
;

897 
cuºMB
->
cbp

ICBPTAB
[(
mbmode
-2)>>2];

898 
cuºMB
->
i16mode
 = (
mbmode
-2) & 0x03;

899 
	`mem£t
(
cuºMB
->
b8mode
,0,4 * ());

900 
	`mem£t
(
cuºMB
->
b8pdú
,-1,4 * ());

902 
	}
}

911 
	$£tup_¶i˚_mëhods
(
Sli˚
 *
cuºSli˚
)

913 
	`£tup_ªad_ma¸oblock
 (
cuºSli˚
);

914 
cuºSli˚
->
¶i˚_ty≥
)

916 
P_SLICE
:

917 
cuºSli˚
->
öãΩªt_mb_mode
 = 
öãΩªt_mb_mode_P
;

918 
cuºSli˚
->
ªad_mŸi⁄_öfo_‰om_NAL
 = 
ªad_mŸi⁄_öfo_‰om_NAL_p_¶i˚
;

919 
cuºSli˚
->
decode_⁄e_comp⁄ít
 = 
decode_⁄e_comp⁄ít_p_¶i˚
;

920 
cuºSli˚
->
upd©e_dúe˘_mv_öfo
 = 
NULL
;

921 #i‡(
MVC_EXTENSION_ENABLE
)

922 
cuºSli˚
->
öô_li°s
 = cuºSli˚->
võw_id
 ? 
öô_li°s_p_¶i˚_mvc
 : 
öô_li°s_p_¶i˚
;

924 
cuºSli˚
->
öô_li°s
 = 
öô_li°s_p_¶i˚
;

927 
SP_SLICE
:

928 
cuºSli˚
->
öãΩªt_mb_mode
 = 
öãΩªt_mb_mode_P
;

929 
cuºSli˚
->
ªad_mŸi⁄_öfo_‰om_NAL
 = 
ªad_mŸi⁄_öfo_‰om_NAL_p_¶i˚
;

930 
cuºSli˚
->
decode_⁄e_comp⁄ít
 = 
decode_⁄e_comp⁄ít_•_¶i˚
;

931 
cuºSli˚
->
upd©e_dúe˘_mv_öfo
 = 
NULL
;

932 #i‡(
MVC_EXTENSION_ENABLE
)

933 
cuºSli˚
->
öô_li°s
 = cuºSli˚->
võw_id
 ? 
öô_li°s_p_¶i˚_mvc
 : 
öô_li°s_p_¶i˚
;

935 
cuºSli˚
->
öô_li°s
 = 
öô_li°s_p_¶i˚
;

938 
B_SLICE
:

939 
cuºSli˚
->
öãΩªt_mb_mode
 = 
öãΩªt_mb_mode_B
;

940 
cuºSli˚
->
ªad_mŸi⁄_öfo_‰om_NAL
 = 
ªad_mŸi⁄_öfo_‰om_NAL_b_¶i˚
;

941 
cuºSli˚
->
decode_⁄e_comp⁄ít
 = 
decode_⁄e_comp⁄ít_b_¶i˚
;

942 
	`upd©e_dúe˘_ty≥s
(
cuºSli˚
);

943 #i‡(
MVC_EXTENSION_ENABLE
)

944 
cuºSli˚
->
öô_li°s
 = cuºSli˚->
võw_id
 ? 
öô_li°s_b_¶i˚_mvc
 : 
öô_li°s_b_¶i˚
;

946 
cuºSli˚
->
öô_li°s
 = 
öô_li°s_b_¶i˚
;

949 
I_SLICE
:

950 
cuºSli˚
->
öãΩªt_mb_mode
 = 
öãΩªt_mb_mode_I
;

951 
cuºSli˚
->
ªad_mŸi⁄_öfo_‰om_NAL
 = 
NULL
;

952 
cuºSli˚
->
decode_⁄e_comp⁄ít
 = 
decode_⁄e_comp⁄ít_i_¶i˚
;

953 
cuºSli˚
->
upd©e_dúe˘_mv_öfo
 = 
NULL
;

954 #i‡(
MVC_EXTENSION_ENABLE
)

955 
cuºSli˚
->
öô_li°s
 = cuºSli˚->
võw_id
 ? 
öô_li°s_i_¶i˚_mvc
 : 
öô_li°s_i_¶i˚
;

957 
cuºSli˚
->
öô_li°s
 = 
öô_li°s_i_¶i˚
;

960 
SI_SLICE
:

961 
cuºSli˚
->
öãΩªt_mb_mode
 = 
öãΩªt_mb_mode_SI
;

962 
cuºSli˚
->
ªad_mŸi⁄_öfo_‰om_NAL
 = 
NULL
;

963 
cuºSli˚
->
decode_⁄e_comp⁄ít
 = 
decode_⁄e_comp⁄ít_i_¶i˚
;

964 
cuºSli˚
->
upd©e_dúe˘_mv_öfo
 = 
NULL
;

965 #i‡(
MVC_EXTENSION_ENABLE
)

966 
cuºSli˚
->
öô_li°s
 = cuºSli˚->
võw_id
 ? 
öô_li°s_i_¶i˚_mvc
 : 
öô_li°s_i_¶i˚
;

968 
cuºSli˚
->
öô_li°s
 = 
öô_li°s_i_¶i˚
;

972 
	`¥ötf
("Unsupported sliceÅype\n");

976 
	`£t_öåa_¥edi˘i⁄_modes
(
cuºSli˚
);

978 i‡–
cuºSli˚
->
p_Vid
->
a˘ive_•s
->
chroma_f‹m©_idc
==
YUV444
 && (cuºSli˚->p_Vid->
£∑øã_cﬁour_∂™e_Êag
 == 0) )

979 
cuºSli˚
->
ªad_c€ff_4x4_CAVLC
 = 
ªad_c€ff_4x4_CAVLC_444
;

981 
cuºSli˚
->
ªad_c€ff_4x4_CAVLC
 =Ñead_coeff_4x4_CAVLC;

983 
cuºSli˚
->
p_Vid
->
a˘ive_µs
->
íå›y_codög_mode_Êag
)

985 
CABAC
:

986 
	`£t_ªad_CBP_™d_c€ffs_ˇbac
(
cuºSli˚
);

988 
CAVLC
:

989 
	`£t_ªad_CBP_™d_c€ffs_ˇvlc
(
cuºSli˚
);

992 
	`¥ötf
("UnsupportedÉntropy coding mode\n");

995 
	}
}

1004 
	$gë_√ighb‹s
(
Ma¸oblock
 *
cuºMB
,

1005 
PixñPos
 *
block
,

1006 
mb_x
,

1007 
mb_y
,

1008 
blocksh≠e_x


1011 *
mb_size
 = 
cuºMB
->
p_Vid
->mb_size[
IS_LUMA
];

1013 
	`gë4x4Neighbour
(
cuºMB
, 
mb_x
 - 1, 
mb_y
 , 
mb_size
, 
block
 );

1014 
	`gë4x4Neighbour
(
cuºMB
, 
mb_x
, 
mb_y
 - 1, 
mb_size
, 
block
 + 1);

1015 
	`gë4x4Neighbour
(
cuºMB
, 
mb_x
 + 
blocksh≠e_x
, 
mb_y
 - 1, 
mb_size
, 
block
 + 2);

1017 i‡(
mb_y
 > 0)

1019 i‡(
mb_x
 < 8)

1021 i‡(
mb_y
 == 8 )

1023 i‡(
blocksh≠e_x
 =
MB_BLOCK_SIZE
)

1024 
block
[2].
avaûabÀ
 = 0;

1026 i‡(
mb_x
 + 
blocksh≠e_x
 == 8)

1028 
block
[2].
avaûabÀ
 = 0;

1031 i‡(
mb_x
 + 
blocksh≠e_x
 =
MB_BLOCK_SIZE
)

1033 
block
[2].
avaûabÀ
 = 0;

1037 i‡(!
block
[2].
avaûabÀ
)

1039 
	`gë4x4Neighbour
(
cuºMB
, 
mb_x
 - 1, 
mb_y
 - 1, 
mb_size
, 
block
 + 3);

1040 
block
[2] = block[3];

1042 
	}
}

1050 
	$ªad_mŸi⁄_öfo_‰om_NAL_p_¶i˚
 (
Ma¸oblock
 *
cuºMB
)

1052 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1053 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1055 
Sy¡axEÀmít
 
cuºSE
;

1056 
D©aP¨tôi⁄
 *
dP
 = 
NULL
;

1057 c⁄° 
byã
 *
∑πM≠
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
dp_mode
];

1058 
∑πmode
 = ((
cuºMB
->
mb_ty≥
 =
P8x8
) ? 4 : currMB->mb_type);

1059 
°ï_h0
 = 
BLOCK_STEP
 [
∑πmode
][0];

1060 
°ï_v0
 = 
BLOCK_STEP
 [
∑πmode
][1];

1062 
j4
;

1063 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
cuºSli˚
->dec_picture;

1064 
PicMŸi⁄P¨ams
 *
mv_öfo
 = 
NULL
;

1066 
li°_off£t
 = 
cuºMB
->list_offset;

1067 
St‹abÀPi˘uª
 **
li°0
 = 
cuºSli˚
->
li°X
[
LIST_0
 + 
li°_off£t
];

1068 
PicMŸi⁄P¨ams
 **
p_mv_öfo
 = &
dec_pi˘uª
->
mv_öfo
[
cuºMB
->
block_y
];

1071 
cuºSE
.
ty≥
 = 
SE_REFFRAME
;

1072 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_REFFRAME
]]);

1075 
	`¥ï¨eLi°f‹RefIdx
 (
cuºMB
, &
cuºSE
, 
dP
, 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
], (cuºMB->
mb_ty≥
 !
P8x8
Ë|| (!cuºSli˚->
ÆÃefzîo
));

1076 
	`ªadMBRefPi˘uªIdx
 (&
cuºSE
, 
dP
, 
cuºMB
, 
p_mv_öfo
, 
LIST_0
, 
°ï_v0
, 
°ï_h0
);

1079 
cuºSE
.
ty≥
 = 
SE_MVD
;

1080 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_MVD
]]);

1082 i‡(
p_Vid
->
a˘ive_µs
->
íå›y_codög_mode_Êag
 =(
Boﬁón
Ë
CAVLC
 || 
dP
->
bô°ªam
->
ei_Êag
)

1083 
cuºSE
.
m≠pög
 = 
löfo_£
;

1085 
cuºSE
.
ªadög
 = 
cuºSli˚
->
mb_aff_‰ame_Êag
 ? 
ªad_mvd_CABAC_mbaff
 : 
ªad_MVD_CABAC
;

1088 
	`ªadMBMŸi⁄Ve˘‹s
 (&
cuºSE
, 
dP
, 
cuºMB
, 
LIST_0
, 
°ï_h0
, 
°ï_v0
);

1091 
j4
 = 0; j4 < 4;++j4)

1093 
mv_öfo
 = &
p_mv_öfo
[
j4
][
cuºMB
->
block_x
];

1094 
mv_öfo
->
ªf_pic
[
LIST_0
] = 
li°0
[(Ëmv_öfo->
ªf_idx
[LIST_0]];

1095 
mv_öfo
++;

1096 
mv_öfo
->
ªf_pic
[
LIST_0
] = 
li°0
[(Ëmv_öfo->
ªf_idx
[LIST_0]];

1097 
mv_öfo
++;

1098 
mv_öfo
->
ªf_pic
[
LIST_0
] = 
li°0
[(Ëmv_öfo->
ªf_idx
[LIST_0]];

1099 
mv_öfo
++;

1100 
mv_öfo
->
ªf_pic
[
LIST_0
] = 
li°0
[(Ëmv_öfo->
ªf_idx
[LIST_0]];

1102 
	}
}

1111 
	$ªad_mŸi⁄_öfo_‰om_NAL_b_¶i˚
 (
Ma¸oblock
 *
cuºMB
)

1113 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1114 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1115 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
cuºSli˚
->dec_picture;

1116 
Sy¡axEÀmít
 
cuºSE
;

1117 
D©aP¨tôi⁄
 *
dP
 = 
NULL
;

1118 c⁄° 
byã
 *
∑πM≠
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
dp_mode
];

1119 
∑πmode
 = ((
cuºMB
->
mb_ty≥
 =
P8x8
) ? 4 : currMB->mb_type);

1120 
°ï_h0
 = 
BLOCK_STEP
 [
∑πmode
][0];

1121 
°ï_v0
 = 
BLOCK_STEP
 [
∑πmode
][1];

1123 
j4
, 
i4
;

1125 
li°_off£t
 = 
cuºMB
->list_offset;

1126 
St‹abÀPi˘uª
 **
li°0
 = 
cuºSli˚
->
li°X
[
LIST_0
 + 
li°_off£t
];

1127 
St‹abÀPi˘uª
 **
li°1
 = 
cuºSli˚
->
li°X
[
LIST_1
 + 
li°_off£t
];

1128 
PicMŸi⁄P¨ams
 **
p_mv_öfo
 = &
dec_pi˘uª
->
mv_öfo
[
cuºMB
->
block_y
];

1130 i‡(
cuºMB
->
mb_ty≥
 =
P8x8
)

1131 
cuºSli˚
->
	`upd©e_dúe˘_mv_öfo
(
cuºMB
);

1134 
cuºSE
.
ty≥
 = 
SE_REFFRAME
;

1135 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_REFFRAME
]]);

1138 
	`¥ï¨eLi°f‹RefIdx
 (
cuºMB
, &
cuºSE
, 
dP
, 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
], 
TRUE
);

1139 
	`ªadMBRefPi˘uªIdx
 (&
cuºSE
, 
dP
, 
cuºMB
, 
p_mv_öfo
, 
LIST_0
, 
°ï_v0
, 
°ï_h0
);

1142 
	`¥ï¨eLi°f‹RefIdx
 (
cuºMB
, &
cuºSE
, 
dP
, 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_1
], 
TRUE
);

1143 
	`ªadMBRefPi˘uªIdx
 (&
cuºSE
, 
dP
, 
cuºMB
, 
p_mv_öfo
, 
LIST_1
, 
°ï_v0
, 
°ï_h0
);

1146 
cuºSE
.
ty≥
 = 
SE_MVD
;

1147 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_MVD
]]);

1149 i‡(
p_Vid
->
a˘ive_µs
->
íå›y_codög_mode_Êag
 =(
Boﬁón
Ë
CAVLC
 || 
dP
->
bô°ªam
->
ei_Êag
)

1150 
cuºSE
.
m≠pög
 = 
löfo_£
;

1152 
cuºSE
.
ªadög
 = 
cuºSli˚
->
mb_aff_‰ame_Êag
 ? 
ªad_mvd_CABAC_mbaff
 : 
ªad_MVD_CABAC
;

1155 
	`ªadMBMŸi⁄Ve˘‹s
 (&
cuºSE
, 
dP
, 
cuºMB
, 
LIST_0
, 
°ï_h0
, 
°ï_v0
);

1157 
	`ªadMBMŸi⁄Ve˘‹s
 (&
cuºSE
, 
dP
, 
cuºMB
, 
LIST_1
, 
°ï_h0
, 
°ï_v0
);

1161 
j4
 = 0; j4 < 4; ++j4)

1163 
i4
 = 
cuºMB
->
block_x
; i4 < (currMB->block_x + 4); ++i4)

1165 
PicMŸi⁄P¨ams
 *
mv_öfo
 = &
p_mv_öfo
[
j4
][
i4
];

1166 
ªf_idx
 = 
mv_öfo
->ªf_idx[
LIST_0
];

1168 
mv_öfo
->
ªf_pic
[
LIST_0
] = (
ªf_idx
 >0Ë? 
li°0
[ªf_idx] : 
NULL
;

1169 
ªf_idx
 = 
mv_öfo
->ªf_idx[
LIST_1
];

1170 
mv_öfo
->
ªf_pic
[
LIST_1
] = (
ªf_idx
 >0Ë? 
li°1
[ªf_idx] : 
NULL
;

1173 
	}
}

1184 
	$check_dp_√ighb‹s
 (
Ma¸oblock
 *
cuºMB
)

1186 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1187 
PixñPos
 
up
, 
À·
;

1189 
p_Vid
->
	`gëNeighbour
(
cuºMB
, -1, 0,Ö_Vid->
mb_size
[1], &
À·
);

1190 
p_Vid
->
	`gëNeighbour
(
cuºMB
, 0, -1,Ö_Vid->
mb_size
[1], &
up
);

1192 i‡((
cuºMB
->
is_öåa_block
 =
FALSE
Ë|| (!(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)) )

1194 i‡(
À·
.
avaûabÀ
)

1196 
cuºMB
->
d∂_Êag
 |
p_Vid
->
mb_d©a
[
À·
.
mb_addr
].dpl_flag;

1198 i‡(
up
.
avaûabÀ
)

1200 
cuºMB
->
d∂_Êag
 |
p_Vid
->
mb_d©a
[
up
.
mb_addr
].dpl_flag;

1203 
	}
}

1213 
	$decode_⁄e_comp⁄ít_i_¶i˚
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
cuº_∂™e
, 
img≥l
 **
cuºImg
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
)

1216 
cuºMB
->
ùmode_DPCM
 = 
NO_INTRA_PMODE
;

1217 if(
cuºMB
->
mb_ty≥
 =
IPCM
)

1218 
	`mb_¥ed_ùcm
(
cuºMB
);

1219 i‡(
cuºMB
->
mb_ty≥
==
I16MB
)

1220 
	`mb_¥ed_öåa16x16
(
cuºMB
, 
cuº_∂™e
, 
dec_pi˘uª
);

1221 i‡(
cuºMB
->
mb_ty≥
 =
I4MB
)

1222 
	`mb_¥ed_öåa4x4
(
cuºMB
, 
cuº_∂™e
, 
cuºImg
, 
dec_pi˘uª
);

1223 i‡(
cuºMB
->
mb_ty≥
 =
I8MB
)

1224 
	`mb_¥ed_öåa8x8
(
cuºMB
, 
cuº_∂™e
, 
cuºImg
, 
dec_pi˘uª
);

1227 
	}
}

1235 
	$decode_⁄e_comp⁄ít_p_¶i˚
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
cuº_∂™e
, 
img≥l
 **
cuºImg
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
)

1238 
cuºMB
->
ùmode_DPCM
 = 
NO_INTRA_PMODE
;

1239 if(
cuºMB
->
mb_ty≥
 =
IPCM
)

1240 
	`mb_¥ed_ùcm
(
cuºMB
);

1241 i‡(
cuºMB
->
mb_ty≥
==
I16MB
)

1242 
	`mb_¥ed_öåa16x16
(
cuºMB
, 
cuº_∂™e
, 
dec_pi˘uª
);

1243 i‡(
cuºMB
->
mb_ty≥
 =
I4MB
)

1244 
	`mb_¥ed_öåa4x4
(
cuºMB
, 
cuº_∂™e
, 
cuºImg
, 
dec_pi˘uª
);

1245 i‡(
cuºMB
->
mb_ty≥
 =
I8MB
)

1246 
	`mb_¥ed_öåa8x8
(
cuºMB
, 
cuº_∂™e
, 
cuºImg
, 
dec_pi˘uª
);

1247 i‡(
cuºMB
->
mb_ty≥
 =
PSKIP
)

1248 
	`mb_¥ed_skù
(
cuºMB
, 
cuº_∂™e
, 
cuºImg
, 
dec_pi˘uª
);

1249 i‡(
cuºMB
->
mb_ty≥
 =
P16x16
)

1250 
	`mb_¥ed_p_öãr16x16
(
cuºMB
, 
cuº_∂™e
, 
dec_pi˘uª
);

1251 i‡(
cuºMB
->
mb_ty≥
 =
P16x8
)

1252 
	`mb_¥ed_p_öãr16x8
(
cuºMB
, 
cuº_∂™e
, 
dec_pi˘uª
);

1253 i‡(
cuºMB
->
mb_ty≥
 =
P8x16
)

1254 
	`mb_¥ed_p_öãr8x16
(
cuºMB
, 
cuº_∂™e
, 
dec_pi˘uª
);

1256 
	`mb_¥ed_p_öãr8x8
(
cuºMB
, 
cuº_∂™e
, 
dec_pi˘uª
);

1259 
	}
}

1268 
	$decode_⁄e_comp⁄ít_•_¶i˚
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
cuº_∂™e
, 
img≥l
 **
cuºImg
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
)

1271 
cuºMB
->
ùmode_DPCM
 = 
NO_INTRA_PMODE
;

1273 i‡(
cuºMB
->
mb_ty≥
 =
IPCM
)

1274 
	`mb_¥ed_ùcm
(
cuºMB
);

1275 i‡(
cuºMB
->
mb_ty≥
==
I16MB
)

1276 
	`mb_¥ed_öåa16x16
(
cuºMB
, 
cuº_∂™e
, 
dec_pi˘uª
);

1277 i‡(
cuºMB
->
mb_ty≥
 =
I4MB
)

1278 
	`mb_¥ed_öåa4x4
(
cuºMB
, 
cuº_∂™e
, 
cuºImg
, 
dec_pi˘uª
);

1279 i‡(
cuºMB
->
mb_ty≥
 =
I8MB
)

1280 
	`mb_¥ed_öåa8x8
(
cuºMB
, 
cuº_∂™e
, 
cuºImg
, 
dec_pi˘uª
);

1281 i‡(
cuºMB
->
mb_ty≥
 =
PSKIP
)

1282 
	`mb_¥ed_•_skù
(
cuºMB
, 
cuº_∂™e
, 
dec_pi˘uª
);

1283 i‡(
cuºMB
->
mb_ty≥
 =
P16x16
)

1284 
	`mb_¥ed_p_öãr16x16
(
cuºMB
, 
cuº_∂™e
, 
dec_pi˘uª
);

1285 i‡(
cuºMB
->
mb_ty≥
 =
P16x8
)

1286 
	`mb_¥ed_p_öãr16x8
(
cuºMB
, 
cuº_∂™e
, 
dec_pi˘uª
);

1287 i‡(
cuºMB
->
mb_ty≥
 =
P8x16
)

1288 
	`mb_¥ed_p_öãr8x16
(
cuºMB
, 
cuº_∂™e
, 
dec_pi˘uª
);

1290 
	`mb_¥ed_p_öãr8x8
(
cuºMB
, 
cuº_∂™e
, 
dec_pi˘uª
);

1293 
	}
}

1304 
	$decode_⁄e_comp⁄ít_b_¶i˚
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
cuº_∂™e
, 
img≥l
 **
cuºImg
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
)

1307 
cuºMB
->
ùmode_DPCM
 = 
NO_INTRA_PMODE
;

1309 if(
cuºMB
->
mb_ty≥
 =
IPCM
)

1310 
	`mb_¥ed_ùcm
(
cuºMB
);

1311 i‡(
cuºMB
->
mb_ty≥
==
I16MB
)

1312 
	`mb_¥ed_öåa16x16
(
cuºMB
, 
cuº_∂™e
, 
dec_pi˘uª
);

1313 i‡(
cuºMB
->
mb_ty≥
 =
I4MB
)

1314 
	`mb_¥ed_öåa4x4
(
cuºMB
, 
cuº_∂™e
, 
cuºImg
, 
dec_pi˘uª
);

1315 i‡(
cuºMB
->
mb_ty≥
 =
I8MB
)

1316 
	`mb_¥ed_öåa8x8
(
cuºMB
, 
cuº_∂™e
, 
cuºImg
, 
dec_pi˘uª
);

1317 i‡(
cuºMB
->
mb_ty≥
 =
P16x16
)

1318 
	`mb_¥ed_p_öãr16x16
(
cuºMB
, 
cuº_∂™e
, 
dec_pi˘uª
);

1319 i‡(
cuºMB
->
mb_ty≥
 =
P16x8
)

1320 
	`mb_¥ed_p_öãr16x8
(
cuºMB
, 
cuº_∂™e
, 
dec_pi˘uª
);

1321 i‡(
cuºMB
->
mb_ty≥
 =
P8x16
)

1322 
	`mb_¥ed_p_öãr8x16
(
cuºMB
, 
cuº_∂™e
, 
dec_pi˘uª
);

1323 i‡(
cuºMB
->
mb_ty≥
 =
BSKIP_DIRECT
)

1325 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1326 i‡(
cuºSli˚
->
dúe˘_•©ül_mv_¥ed_Êag
 == 0)

1328 i‡(
cuºSli˚
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
)

1329 
	`mb_¥ed_b_d8x8ãmp‹Æ
 (
cuºMB
, 
cuº_∂™e
, 
cuºImg
, 
dec_pi˘uª
);

1331 
	`mb_¥ed_b_d4x4ãmp‹Æ
 (
cuºMB
, 
cuº_∂™e
, 
cuºImg
, 
dec_pi˘uª
);

1335 i‡(
cuºSli˚
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
)

1336 
	`mb_¥ed_b_d8x8•©ül
 (
cuºMB
, 
cuº_∂™e
, 
cuºImg
, 
dec_pi˘uª
);

1338 
	`mb_¥ed_b_d4x4•©ül
 (
cuºMB
, 
cuº_∂™e
, 
cuºImg
, 
dec_pi˘uª
);

1342 
	`mb_¥ed_b_öãr8x8
 (
cuºMB
, 
cuº_∂™e
, 
dec_pi˘uª
);

1345 
	}
}

1350 
	$öô_cur_imgy
(
VideoP¨amëîs
 *
p_Vid
,
Sli˚
 *
cuºSli˚
,
∂
)

1352 
i
,
j
;

1353 i‡(
p_Vid
->
£∑øã_cﬁour_∂™e_Êag
 == 0)

1355 
St‹abÀPi˘uª
 *
vidªf
 = 
p_Vid
->
no_ª„ªn˚_pi˘uª
;

1356 
n‹ef
 = (
cuºSli˚
->
‰amïoc
 < 
p_Vid
->
ªcovîy_poc
);

1357 i‡(
∂
==
PLANE_Y
)

1359 
j
 = 0; j < 6; j++)

1361 
i
 = 0; i < 
cuºSli˚
->
li°Xsize
[
j
] ; i++)

1363 
St‹abÀPi˘uª
 *
cuº_ªf
 = 
cuºSli˚
->
li°X
[
j
][
i
];

1364 i‡(
cuº_ªf
)

1366 
cuº_ªf
->
no_ªf
 = 
n‹ef
 && (cuº_ª‡=
vidªf
);

1367 
cuº_ªf
->
cur_imgY
 = cuº_ªf->
imgY
;

1374 
j
 = 0; j < 6; j++)

1376 
i
 = 0; i < 
cuºSli˚
->
li°Xsize
[
j
]; i++)

1378 
St‹abÀPi˘uª
 *
cuº_ªf
 = 
cuºSli˚
->
li°X
[
j
][
i
];

1379 i‡(
cuº_ªf
)

1381 
cuº_ªf
->
no_ªf
 = 
n‹ef
 && (cuº_ª‡=
vidªf
);

1382 
cuº_ªf
->
cur_imgY
 = cuº_ªf->
imgUV
[
∂
-1];

1388 
	}
}

1398 
	$decode_⁄e_ma¸oblock
(
Ma¸oblock
 *
cuºMB
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
)

1400 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1401 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1404 i‡(
cuºSli˚
->
chroma444_nŸ_£∑øã
)

1406 i‡(!
cuºMB
->
is_öåa_block
)

1408 
	`öô_cur_imgy
(
p_Vid
, 
cuºSli˚
, 
PLANE_Y
);

1409 
cuºSli˚
->
	`decode_⁄e_comp⁄ít
(
cuºMB
, 
PLANE_Y
, 
dec_pi˘uª
->
imgY
, dec_picture);

1410 
	`öô_cur_imgy
(
p_Vid
, 
cuºSli˚
, 
PLANE_U
);

1411 
cuºSli˚
->
	`decode_⁄e_comp⁄ít
(
cuºMB
, 
PLANE_U
, 
dec_pi˘uª
->
imgUV
[0], dec_picture);

1412 
	`öô_cur_imgy
(
p_Vid
, 
cuºSli˚
, 
PLANE_V
);

1413 
cuºSli˚
->
	`decode_⁄e_comp⁄ít
(
cuºMB
, 
PLANE_V
, 
dec_pi˘uª
->
imgUV
[1], dec_picture);

1417 
cuºSli˚
->
	`decode_⁄e_comp⁄ít
(
cuºMB
, 
PLANE_Y
, 
dec_pi˘uª
->
imgY
, dec_picture);

1418 
cuºSli˚
->
	`decode_⁄e_comp⁄ít
(
cuºMB
, 
PLANE_U
, 
dec_pi˘uª
->
imgUV
[0], dec_picture);

1419 
cuºSli˚
->
	`decode_⁄e_comp⁄ít
(
cuºMB
, 
PLANE_V
, 
dec_pi˘uª
->
imgUV
[1], dec_picture);

1421 
cuºSli˚
->
is_ª£t_c€ff
 = 
FALSE
;

1422 
cuºSli˚
->
is_ª£t_c€ff_¸
 = 
FALSE
;

1426 
cuºSli˚
->
	`decode_⁄e_comp⁄ít
(
cuºMB
, 
PLANE_Y
, 
dec_pi˘uª
->
imgY
, dec_picture);

1430 
	}
}

1440 
	$ch™ge_∂™e_JV
–
VideoP¨amëîs
 *
p_Vid
, 
≈œ√
, 
Sli˚
 *
pSli˚
)

1444 
p_Vid
->
mb_d©a
 =Ö_Vid->
mb_d©a_JV
[
≈œ√
];

1445 
p_Vid
->
dec_pi˘uª
 =Ö_Vid->
dec_pi˘uª_JV
[
≈œ√
];

1446 
p_Vid
->
siblock
 =Ö_Vid->
siblock_JV
[
≈œ√
];

1447 
p_Vid
->
ùªdmode
 =Ö_Vid->
ùªdmode_JV
[
≈œ√
];

1448 
p_Vid
->
öåa_block
 =Ö_Vid->
öåa_block_JV
[
≈œ√
];

1449 if(
pSli˚
)

1451 
pSli˚
->
mb_d©a
 = 
p_Vid
->
mb_d©a_JV
[
≈œ√
];

1452 
pSli˚
->
dec_pi˘uª
 = 
p_Vid
->
dec_pi˘uª_JV
[
≈œ√
];

1453 
pSli˚
->
siblock
 = 
p_Vid
->
siblock_JV
[
≈œ√
];

1454 
pSli˚
->
ùªdmode
 = 
p_Vid
->
ùªdmode_JV
[
≈œ√
];

1455 
pSli˚
->
öåa_block
 = 
p_Vid
->
öåa_block_JV
[
≈œ√
];

1457 
	}
}

1466 
	$make_‰ame_pi˘uª_JV
(
VideoP¨amëîs
 *
p_Vid
)

1468 
uv
, 
löe
;

1469 
nsize
;

1470 
p_Vid
->
dec_pi˘uª
 =Ö_Vid->
dec_pi˘uª_JV
[0];

1472 if(
p_Vid
->
dec_pi˘uª
->
u£d_f‹_ª„ªn˚
)

1474 
nsize
 = (
p_Vid
->
dec_pi˘uª
->
size_y
/
BLOCK_SIZE
)*’_Vid->dec_pi˘uª->
size_x
/BLOCK_SIZE)*(
PicMŸi⁄P¨ams
);

1475 
	`mem˝y
–&(
p_Vid
->
dec_pi˘uª
->
JVmv_öfo
[
PLANE_Y
][0][0]), &’_Vid->
dec_pi˘uª_JV
[PLANE_Y]->
mv_öfo
[0][0]), 
nsize
);

1476 
	`mem˝y
–&(
p_Vid
->
dec_pi˘uª
->
JVmv_öfo
[
PLANE_U
][0][0]), &’_Vid->
dec_pi˘uª_JV
[PLANE_U]->
mv_öfo
[0][0]), 
nsize
);

1477 
	`mem˝y
–&(
p_Vid
->
dec_pi˘uª
->
JVmv_öfo
[
PLANE_V
][0][0]), &’_Vid->
dec_pi˘uª_JV
[PLANE_V]->
mv_öfo
[0][0]), 
nsize
);

1481  
uv
=0; uv<2; uv++ )

1483  
löe
=0;Üöe<
p_Vid
->
height
;Üine++ )

1485 
nsize
 = (
img≥l
Ë* 
p_Vid
->
width
;

1486 
	`mem˝y
–
p_Vid
->
dec_pi˘uª
->
imgUV
[
uv
][
löe
],Ö_Vid->
dec_pi˘uª_JV
[uv+1]->
imgY
[löe], 
nsize
 );

1488 
	`‰ì_°‹abÀ_pi˘uª
(
p_Vid
->
dec_pi˘uª_JV
[
uv
+1]);

1490 
	}
}

	@ldecod/src/mb_access.c

15 
	~"globÆ.h
"

16 
	~"mbuf„r.h
"

17 
	~"mb_ac˚ss.h
"

25 
Boﬁón
 
	$mb_is_avaûabÀ
(
mbAddr
, 
Ma¸oblock
 *
cuºMB
)

27 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

28 i‡((
mbAddr
 < 0Ë|| (mbAdd∏> (()
cuºSli˚
->
dec_pi˘uª
->
PicSizeInMbs
 - 1)))

29  
FALSE
;

32 i‡(!
cuºMB
->
DeblockCÆl
)

34 i‡(
cuºSli˚
->
mb_d©a
[
mbAddr
].
¶i˚_ƒ
 !
cuºMB
->slice_nr)

35  
FALSE
;

38  
TRUE
;

39 
	}
}

49 
	$CheckAvaûabûôyOfNeighb‹s
(
Ma¸oblock
 *
cuºMB
)

51 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

52 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
cuºSli˚
->dec_picture;

53 c⁄° 
mb_ƒ
 = 
cuºMB
->
mbAddrX
;

54 
BlockPos
 *
PicPos
 = 
cuºMB
->
p_Vid
->PicPos;

56 i‡(
dec_pi˘uª
->
mb_aff_‰ame_Êag
)

58 
cur_mb_∑ú
 = 
mb_ƒ
 >> 1;

59 
cuºMB
->
mbAddrA
 = 2 * (
cur_mb_∑ú
 - 1);

60 
cuºMB
->
mbAddrB
 = 2 * (
cur_mb_∑ú
 - 
dec_pi˘uª
->
PicWidthInMbs
);

61 
cuºMB
->
mbAddrC
 = 2 * (
cur_mb_∑ú
 - 
dec_pi˘uª
->
PicWidthInMbs
 + 1);

62 
cuºMB
->
mbAddrD
 = 2 * (
cur_mb_∑ú
 - 
dec_pi˘uª
->
PicWidthInMbs
 - 1);

64 
cuºMB
->
mbAvaûA
 = (
Boﬁón
Ë(
	`mb_is_avaûabÀ
(cuºMB->
mbAddrA
, cuºMBË&& ((
PicPos
[
cur_mb_∑ú
 ].
x
)!=0));

65 
cuºMB
->
mbAvaûB
 = (
Boﬁón
Ë(
	`mb_is_avaûabÀ
(cuºMB->
mbAddrB
, currMB));

66 
cuºMB
->
mbAvaûC
 = (
Boﬁón
Ë(
	`mb_is_avaûabÀ
(cuºMB->
mbAddrC
, cuºMBË&& ((
PicPos
[
cur_mb_∑ú
 + 1].
x
)!=0));

67 
cuºMB
->
mbAvaûD
 = (
Boﬁón
Ë(
	`mb_is_avaûabÀ
(cuºMB->
mbAddrD
, cuºMBË&& ((
PicPos
[
cur_mb_∑ú
 ].
x
)!=0));

71 
BlockPos
 *
p_pic_pos
 = &
PicPos
[
mb_ƒ
 ];

72 
cuºMB
->
mbAddrA
 = 
mb_ƒ
 - 1;

73 
cuºMB
->
mbAddrD
 = cuºMB->
mbAddrA
 - 
dec_pi˘uª
->
PicWidthInMbs
;

74 
cuºMB
->
mbAddrB
 = cuºMB->
mbAddrD
 + 1;

75 
cuºMB
->
mbAddrC
 = cuºMB->
mbAddrB
 + 1;

78 
cuºMB
->
mbAvaûA
 = (
Boﬁón
Ë(
	`mb_is_avaûabÀ
(cuºMB->
mbAddrA
, cuºMBË&& ((
p_pic_pos
->
x
)!=0));

79 
cuºMB
->
mbAvaûD
 = (
Boﬁón
Ë(
	`mb_is_avaûabÀ
(cuºMB->
mbAddrD
, cuºMBË&& ((
p_pic_pos
->
x
)!=0));

80 
cuºMB
->
mbAvaûC
 = (
Boﬁón
Ë(
	`mb_is_avaûabÀ
(cuºMB->
mbAddrC
, cuºMBË&& (((
p_pic_pos
 + 1)->
x
)!=0));

81 
cuºMB
->
mbAvaûB
 = (
Boﬁón
Ë(
	`mb_is_avaûabÀ
(cuºMB->
mbAddrB
, currMB));

84 
cuºMB
->
mb_À·
 = (cuºMB->
mbAvaûA
Ë? &(
cuºSli˚
->
mb_d©a
[cuºMB->
mbAddrA
]Ë: 
NULL
;

85 
cuºMB
->
mb_up
 = (cuºMB->
mbAvaûB
Ë? &(
cuºSli˚
->
mb_d©a
[cuºMB->
mbAddrB
]Ë: 
NULL
;

86 
	}
}

95 
	$CheckAvaûabûôyOfNeighb‹sN‹mÆ
(
Ma¸oblock
 *
cuºMB
)

97 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

98 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
cuºSli˚
->dec_picture;

99 c⁄° 
mb_ƒ
 = 
cuºMB
->
mbAddrX
;

100 
BlockPos
 *
PicPos
 = 
cuºMB
->
p_Vid
->PicPos;

102 
BlockPos
 *
p_pic_pos
 = &
PicPos
[
mb_ƒ
 ];

103 
cuºMB
->
mbAddrA
 = 
mb_ƒ
 - 1;

104 
cuºMB
->
mbAddrD
 = cuºMB->
mbAddrA
 - 
dec_pi˘uª
->
PicWidthInMbs
;

105 
cuºMB
->
mbAddrB
 = cuºMB->
mbAddrD
 + 1;

106 
cuºMB
->
mbAddrC
 = cuºMB->
mbAddrB
 + 1;

109 
cuºMB
->
mbAvaûA
 = (
Boﬁón
Ë(
	`mb_is_avaûabÀ
(cuºMB->
mbAddrA
, cuºMBË&& ((
p_pic_pos
->
x
)!=0));

110 
cuºMB
->
mbAvaûD
 = (
Boﬁón
Ë(
	`mb_is_avaûabÀ
(cuºMB->
mbAddrD
, cuºMBË&& ((
p_pic_pos
->
x
)!=0));

111 
cuºMB
->
mbAvaûC
 = (
Boﬁón
Ë(
	`mb_is_avaûabÀ
(cuºMB->
mbAddrC
, cuºMBË&& (((
p_pic_pos
 + 1)->
x
)!=0));

112 
cuºMB
->
mbAvaûB
 = (
Boﬁón
Ë(
	`mb_is_avaûabÀ
(cuºMB->
mbAddrB
, currMB));

115 
cuºMB
->
mb_À·
 = (cuºMB->
mbAvaûA
Ë? &(
cuºSli˚
->
mb_d©a
[cuºMB->
mbAddrA
]Ë: 
NULL
;

116 
cuºMB
->
mb_up
 = (cuºMB->
mbAvaûB
Ë? &(
cuºSli˚
->
mb_d©a
[cuºMB->
mbAddrB
]Ë: 
NULL
;

117 
	}
}

126 
	$CheckAvaûabûôyOfNeighb‹sMBAFF
(
Ma¸oblock
 *
cuºMB
)

128 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

129 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
cuºSli˚
->dec_picture;

130 c⁄° 
mb_ƒ
 = 
cuºMB
->
mbAddrX
;

131 
BlockPos
 *
PicPos
 = 
cuºMB
->
p_Vid
->PicPos;

133 
cur_mb_∑ú
 = 
mb_ƒ
 >> 1;

134 
cuºMB
->
mbAddrA
 = 2 * (
cur_mb_∑ú
 - 1);

135 
cuºMB
->
mbAddrB
 = 2 * (
cur_mb_∑ú
 - 
dec_pi˘uª
->
PicWidthInMbs
);

136 
cuºMB
->
mbAddrC
 = 2 * (
cur_mb_∑ú
 - 
dec_pi˘uª
->
PicWidthInMbs
 + 1);

137 
cuºMB
->
mbAddrD
 = 2 * (
cur_mb_∑ú
 - 
dec_pi˘uª
->
PicWidthInMbs
 - 1);

139 
cuºMB
->
mbAvaûA
 = (
Boﬁón
Ë(
	`mb_is_avaûabÀ
(cuºMB->
mbAddrA
, cuºMBË&& ((
PicPos
[
cur_mb_∑ú
 ].
x
)!=0));

140 
cuºMB
->
mbAvaûB
 = (
Boﬁón
Ë(
	`mb_is_avaûabÀ
(cuºMB->
mbAddrB
, currMB));

141 
cuºMB
->
mbAvaûC
 = (
Boﬁón
Ë(
	`mb_is_avaûabÀ
(cuºMB->
mbAddrC
, cuºMBË&& ((
PicPos
[
cur_mb_∑ú
 + 1].
x
)!=0));

142 
cuºMB
->
mbAvaûD
 = (
Boﬁón
Ë(
	`mb_is_avaûabÀ
(cuºMB->
mbAddrD
, cuºMBË&& ((
PicPos
[
cur_mb_∑ú
 ].
x
)!=0));

144 
cuºMB
->
mb_À·
 = (cuºMB->
mbAvaûA
Ë? &(
cuºSli˚
->
mb_d©a
[cuºMB->
mbAddrA
]Ë: 
NULL
;

145 
cuºMB
->
mb_up
 = (cuºMB->
mbAvaûB
Ë? &(
cuºSli˚
->
mb_d©a
[cuºMB->
mbAddrB
]Ë: 
NULL
;

146 
	}
}

155 
	$gë_mb_block_pos_n‹mÆ
 (
BlockPos
 *
PicPos
, 
mb_addr
, *
x
, *
y
)

157 
BlockPos
 *
pPos
 = &
PicPos
[ 
mb_addr
 ];

158 *
x
 = (Ë
pPos
->x;

159 *
y
 = (Ë
pPos
->y;

160 
	}
}

169 
	$gë_mb_block_pos_mbaff
 (
BlockPos
 *
PicPos
, 
mb_addr
, *
x
, *
y
)

171 
BlockPos
 *
pPos
 = &
PicPos
[ 
mb_addr
 >> 1 ];

172 *
x
 = (Ë
pPos
->x;

173 *
y
 = (Ë((
pPos
->y << 1Ë+ (
mb_addr
 & 0x01));

174 
	}
}

182 
	$gë_mb_pos
 (
VideoP¨amëîs
 *
p_Vid
, 
mb_addr
, 
mb_size
[2], *
x
, *
y
)

184 
p_Vid
->
	`gë_mb_block_pos
’_Vid->
PicPos
, 
mb_addr
, 
x
, 
y
);

186 (*
x
Ë(Ë((*xË* 
mb_size
[0]);

187 (*
y
Ë(Ë((*yË* 
mb_size
[1]);

188 
	}
}

207 
	$gëN⁄AffNeighbour
(
Ma¸oblock
 *
cuºMB
, 
xN
, 
yN
, 
mb_size
[2], 
PixñPos
 *
pix
)

209 
maxW
 = 
mb_size
[0], 
maxH
 = mb_size[1];

211 i‡(
xN
 < 0)

213 i‡(
yN
 < 0)

215 
pix
->
mb_addr
 = 
cuºMB
->
mbAddrD
;

216 
pix
->
avaûabÀ
 = 
cuºMB
->
mbAvaûD
;

218 i‡(
yN
 < 
maxH
)

220 
pix
->
mb_addr
 = 
cuºMB
->
mbAddrA
;

221 
pix
->
avaûabÀ
 = 
cuºMB
->
mbAvaûA
;

225 
pix
->
avaûabÀ
 = 
FALSE
;

228 i‡(
xN
 < 
maxW
)

230 i‡(
yN
 < 0)

232 
pix
->
mb_addr
 = 
cuºMB
->
mbAddrB
;

233 
pix
->
avaûabÀ
 = 
cuºMB
->
mbAvaûB
;

235 i‡(
yN
 < 
maxH
)

237 
pix
->
mb_addr
 = 
cuºMB
->
mbAddrX
;

238 
pix
->
avaûabÀ
 = 
TRUE
;

242 
pix
->
avaûabÀ
 = 
FALSE
;

245 i‡((
xN
 >
maxW
Ë&& (
yN
 < 0))

247 
pix
->
mb_addr
 = 
cuºMB
->
mbAddrC
;

248 
pix
->
avaûabÀ
 = 
cuºMB
->
mbAvaûC
;

252 
pix
->
avaûabÀ
 = 
FALSE
;

255 i‡(
pix
->
avaûabÀ
 || 
cuºMB
->
DeblockCÆl
)

257 
BlockPos
 *
CurPos
 = &(
cuºMB
->
p_Vid
->
PicPos
[ 
pix
->
mb_addr
 ]);

258 
pix
->
x
 = (Ë(
xN
 & (
maxW
 - 1));

259 
pix
->
y
 = (Ë(
yN
 & (
maxH
 - 1));

260 
pix
->
pos_x
 = (Ë’ix->
x
 + 
CurPos
->x * 
maxW
);

261 
pix
->
pos_y
 = (Ë’ix->
y
 + 
CurPos
->y * 
maxH
);

263 
	}
}

281 
	$gëAffNeighbour
(
Ma¸oblock
 *
cuºMB
, 
xN
, 
yN
, 
mb_size
[2], 
PixñPos
 *
pix
)

283 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

284 
maxW
, 
maxH
;

285 
yM
 = -1;

287 
maxW
 = 
mb_size
[0];

288 
maxH
 = 
mb_size
[1];

291 
pix
->
avaûabÀ
 = 
FALSE
;

293 if(
yN
 > (
maxH
 - 1))

297 i‡(
xN
 > (
maxW
 - 1Ë&& 
yN
 >0 && yN < 
maxH
)

302 i‡(
xN
 < 0)

304 i‡(
yN
 < 0)

306 if(!
cuºMB
->
mb_fõld
)

309 i‡((
cuºMB
->
mbAddrX
 & 0x01) == 0)

312 
pix
->
mb_addr
 = 
cuºMB
->
mbAddrD
 + 1;

313 
pix
->
avaûabÀ
 = 
cuºMB
->
mbAvaûD
;

314 
yM
 = 
yN
;

319 
pix
->
mb_addr
 = 
cuºMB
->
mbAddrA
;

320 
pix
->
avaûabÀ
 = 
cuºMB
->
mbAvaûA
;

321 i‡(
cuºMB
->
mbAvaûA
)

323 if(!
p_Vid
->
mb_d©a
[
cuºMB
->
mbAddrA
].
mb_fõld
)

325 
yM
 = 
yN
;

329 (
pix
->
mb_addr
)++;

330 
yM
 = (
yN
 + 
maxH
) >> 1;

338 i‡((
cuºMB
->
mbAddrX
 & 0x01) == 0)

341 
pix
->
mb_addr
 = 
cuºMB
->
mbAddrD
;

342 
pix
->
avaûabÀ
 = 
cuºMB
->
mbAvaûD
;

343 i‡(
cuºMB
->
mbAvaûD
)

345 if(!
p_Vid
->
mb_d©a
[
cuºMB
->
mbAddrD
].
mb_fõld
)

347 (
pix
->
mb_addr
)++;

348 
yM
 = 2 * 
yN
;

352 
yM
 = 
yN
;

359 
pix
->
mb_addr
 = 
cuºMB
->
mbAddrD
+1;

360 
pix
->
avaûabÀ
 = 
cuºMB
->
mbAvaûD
;

361 
yM
 = 
yN
;

367 i‡(
yN
 >0 && yN <
maxH
)

369 i‡(!
cuºMB
->
mb_fõld
)

372 i‡((
cuºMB
->
mbAddrX
 & 0x01) == 0)

375 
pix
->
mb_addr
 = 
cuºMB
->
mbAddrA
;

376 
pix
->
avaûabÀ
 = 
cuºMB
->
mbAvaûA
;

377 i‡(
cuºMB
->
mbAvaûA
)

379 if(!
p_Vid
->
mb_d©a
[
cuºMB
->
mbAddrA
].
mb_fõld
)

381 
yM
 = 
yN
;

385 (
pix
->
mb_addr
)+((
yN
 & 0x01) != 0);

386 
yM
 = 
yN
 >> 1;

393 
pix
->
mb_addr
 = 
cuºMB
->
mbAddrA
;

394 
pix
->
avaûabÀ
 = 
cuºMB
->
mbAvaûA
;

395 i‡(
cuºMB
->
mbAvaûA
)

397 if(!
p_Vid
->
mb_d©a
[
cuºMB
->
mbAddrA
].
mb_fõld
)

399 (
pix
->
mb_addr
)++;

400 
yM
 = 
yN
;

404 (
pix
->
mb_addr
)+((
yN
 & 0x01) != 0);

405 
yM
 = (
yN
 + 
maxH
) >> 1;

413 i‡((
cuºMB
->
mbAddrX
 & 0x01) == 0)

416 
pix
->
mb_addr
 = 
cuºMB
->
mbAddrA
;

417 
pix
->
avaûabÀ
 = 
cuºMB
->
mbAvaûA
;

418 i‡(
cuºMB
->
mbAvaûA
)

420 if(!
p_Vid
->
mb_d©a
[
cuºMB
->
mbAddrA
].
mb_fõld
)

422 i‡(
yN
 < (
maxH
 >> 1))

424 
yM
 = 
yN
 << 1;

428 (
pix
->
mb_addr
)++;

429 
yM
 = (
yN
 << 1 ) - 
maxH
;

434 
yM
 = 
yN
;

441 
pix
->
mb_addr
 = 
cuºMB
->
mbAddrA
;

442 
pix
->
avaûabÀ
 = 
cuºMB
->
mbAvaûA
;

443 i‡(
cuºMB
->
mbAvaûA
)

445 if(!
p_Vid
->
mb_d©a
[
cuºMB
->
mbAddrA
].
mb_fõld
)

447 i‡(
yN
 < (
maxH
 >> 1))

449 
yM
 = (
yN
 << 1) + 1;

453 (
pix
->
mb_addr
)++;

454 
yM
 = (
yN
 << 1 ) + 1 - 
maxH
;

459 (
pix
->
mb_addr
)++;

460 
yM
 = 
yN
;

470 i‡(
xN
 >0 && xN < 
maxW
)

472 i‡(
yN
<0)

474 i‡(!
cuºMB
->
mb_fõld
)

477 i‡((
cuºMB
->
mbAddrX
 & 0x01) == 0)

480 
pix
->
mb_addr
 = 
cuºMB
->
mbAddrB
;

483 i‡(
cuºMB
->
mbAvaûB
)

485 i‡(!(
cuºMB
->
DeblockCÆl
 =1 && (
p_Vid
->
mb_d©a
[cuºMB->
mbAddrB
]).
mb_fõld
))

486 
pix
->
mb_addr
 += 1;

489 
pix
->
avaûabÀ
 = 
cuºMB
->
mbAvaûB
;

490 
yM
 = 
yN
;

495 
pix
->
mb_addr
 = 
cuºMB
->
mbAddrX
 - 1;

496 
pix
->
avaûabÀ
 = 
TRUE
;

497 
yM
 = 
yN
;

503 i‡((
cuºMB
->
mbAddrX
 & 0x01) == 0)

506 
pix
->
mb_addr
 = 
cuºMB
->
mbAddrB
;

507 
pix
->
avaûabÀ
 = 
cuºMB
->
mbAvaûB
;

508 i‡(
cuºMB
->
mbAvaûB
)

510 if(!
p_Vid
->
mb_d©a
[
cuºMB
->
mbAddrB
].
mb_fõld
)

512 (
pix
->
mb_addr
)++;

513 
yM
 = 2* 
yN
;

517 
yM
 = 
yN
;

524 
pix
->
mb_addr
 = 
cuºMB
->
mbAddrB
 + 1;

525 
pix
->
avaûabÀ
 = 
cuºMB
->
mbAvaûB
;

526 
yM
 = 
yN
;

534 i‡(
yN
 =0 && 
cuºMB
->
DeblockCÆl
 == 2)

536 
pix
->
mb_addr
 = 
cuºMB
->
mbAddrB
 + 1;

537 
pix
->
avaûabÀ
 = 
TRUE
;

538 
yM
 = 
yN
 - 1;

541 i‡((
yN
 >0Ë&& (yN <
maxH
))

543 
pix
->
mb_addr
 = 
cuºMB
->
mbAddrX
;

544 
pix
->
avaûabÀ
 = 
TRUE
;

545 
yM
 = 
yN
;

551 if(
yN
 < 0)

553 i‡(!
cuºMB
->
mb_fõld
)

556 i‡((
cuºMB
->
mbAddrX
 & 0x01) == 0)

559 
pix
->
mb_addr
 = 
cuºMB
->
mbAddrC
 + 1;

560 
pix
->
avaûabÀ
 = 
cuºMB
->
mbAvaûC
;

561 
yM
 = 
yN
;

566 
pix
->
avaûabÀ
 = 
FALSE
;

572 i‡((
cuºMB
->
mbAddrX
 & 0x01) == 0)

575 
pix
->
mb_addr
 = 
cuºMB
->
mbAddrC
;

576 
pix
->
avaûabÀ
 = 
cuºMB
->
mbAvaûC
;

577 i‡(
cuºMB
->
mbAvaûC
)

579 if(!
p_Vid
->
mb_d©a
[
cuºMB
->
mbAddrC
].
mb_fõld
)

581 (
pix
->
mb_addr
)++;

582 
yM
 = 2* 
yN
;

586 
yM
 = 
yN
;

593 
pix
->
mb_addr
 = 
cuºMB
->
mbAddrC
 + 1;

594 
pix
->
avaûabÀ
 = 
cuºMB
->
mbAvaûC
;

595 
yM
 = 
yN
;

601 i‡(
pix
->
avaûabÀ
 || 
cuºMB
->
DeblockCÆl
)

603 
pix
->
x
 = (Ë(
xN
 & (
maxW
 - 1));

604 
pix
->
y
 = (Ë(
yM
 & (
maxH
 - 1));

605 
	`gë_mb_pos
(
p_Vid
, 
pix
->
mb_addr
, 
mb_size
, &’ix->
pos_x
), &’ix->
pos_y
));

606 
pix
->
pos_x
 =Öix->pos_x +Öix->
x
;

607 
pix
->
pos_y
 =Öix->pos_y +Öix->
y
;

609 
	}
}

628 
	$gë4x4Neighbour
 (
Ma¸oblock
 *
cuºMB
, 
block_x
, 
block_y
, 
mb_size
[2], 
PixñPos
 *
pix
)

630 
cuºMB
->
p_Vid
->
	`gëNeighbour
(cuºMB, 
block_x
, 
block_y
, 
mb_size
, 
pix
);

632 i‡(
pix
->
avaûabÀ
)

634 
pix
->
x
 >>= 2;

635 
pix
->
y
 >>= 2;

636 
pix
->
pos_x
 >>= 2;

637 
pix
->
pos_y
 >>= 2;

639 
	}
}

657 
	$gë4x4NeighbourBa£
 (
Ma¸oblock
 *
cuºMB
, 
block_x
, 
block_y
, 
mb_size
[2], 
PixñPos
 *
pix
)

659 
cuºMB
->
p_Vid
->
	`gëNeighbour
(cuºMB, 
block_x
, 
block_y
, 
mb_size
, 
pix
);

661 i‡(
pix
->
avaûabÀ
)

663 
pix
->
x
 >>= 2;

664 
pix
->
y
 >>= 2;

666 
	}
}

	@ldecod/src/mb_prediction.c

14 
	~"c⁄åibut‹s.h
"

16 
	~"block.h
"

17 
	~"globÆ.h
"

18 
	~"mbuf„r.h
"

19 
	~"ñemíts.h
"

20 
	~"îr‹c⁄˚Æmít.h
"

21 
	~"ma¸oblock.h
"

22 
	~"fmo.h
"

23 
	~"ˇbac.h
"

24 
	~"vlc.h
"

25 
	~"image.h
"

26 
	~"mb_ac˚ss.h
"

27 
	~"büridecod.h
"

28 
	~"å™sf‹m8x8.h
"

29 
	~"å™sf‹m.h
"

30 
	~"mc_¥edi˘i⁄.h
"

31 
	~"qu™t.h
"

32 
	~"öåa4x4_¥ed.h
"

33 
	~"öåa8x8_¥ed.h
"

34 
	~"öåa16x16_¥ed.h
"

35 
	~"mv_¥edi˘i⁄.h
"

36 
	~"mb_¥edi˘i⁄.h
"

38 
gë_cﬁoˇãd_öfo_8x8
 (
Ma¸oblock
 *
cuºMB
, 
St‹abÀPi˘uª
 *
li°1
, 
i
, 
j
);

39 
gë_cﬁoˇãd_öfo_4x4
 (
Ma¸oblock
 *
cuºMB
, 
St‹abÀPi˘uª
 *
li°1
, 
i
, 
j
);

42 
	$mb_¥ed_öåa4x4
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
cuº_∂™e
, 
img≥l
 **
cuºImg
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
)

44 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

45 
yuv
 = 
dec_pi˘uª
->
chroma_f‹m©_idc
 - 1;

46 
i
=0, 
j
=0,
k
, 
j4
=0,
i4
=0;

47 
j_pos
, 
i_pos
;

48 
ioff
,
joff
;

49 
block8x8
;

50 
cuºMB
->
ôøns_4x4
 = (cuºMB->
is_los¶ess
 =
FALSE
Ë? 
ôøns4x4
 : 
Inv_ResiduÆ_å™s_4x4
;

52 
block8x8
 = 0; block8x8 < 4; block8x8++)

54 
k
 = 
block8x8
 * 4; k < block8x8 * 4 + 4; k ++)

56 
i
 = (
decode_block_sˇn
[
k
] & 3);

57 
j
 = ((
decode_block_sˇn
[
k
] >> 2) & 3);

59 
ioff
 = (
i
 << 2);

60 
joff
 = (
j
 << 2);

61 
i4
 = 
cuºMB
->
block_x
 + 
i
;

62 
j4
 = 
cuºMB
->
block_y
 + 
j
;

63 
j_pos
 = 
j4
 * 
BLOCK_SIZE
;

64 
i_pos
 = 
i4
 * 
BLOCK_SIZE
;

68 i‡(
cuºSli˚
->
	`öåa_¥ed_4x4
(
cuºMB
, 
cuº_∂™e
, 
ioff
,
joff
,
i4
,
j4
Ë=
SEARCH_SYNC
)

69  
SEARCH_SYNC
;

72 
cuºMB
->
	`ôøns_4x4
 (cuºMB, 
cuº_∂™e
, 
ioff
, 
joff
);

74 
	`c›y_image_d©a_4x4
(&
cuºImg
[
j_pos
], &
cuºSli˚
->
mb_ªc
[
cuº_∂™e
][
joff
], 
i_pos
, 
ioff
);

79 i‡((
dec_pi˘uª
->
chroma_f‹m©_idc
 !
YUV400
Ë&& (dec_pi˘uª->chroma_f‹m©_id¯!
YUV444
))

81 
	`öåa_¸_decodög
(
cuºMB
, 
yuv
);

84 i‡(
cuºMB
->
cbp
 != 0)

85 
cuºSli˚
->
is_ª£t_c€ff
 = 
FALSE
;

87 
	}
}

90 
	$mb_¥ed_öåa16x16
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
cuº_∂™e
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
)

92 
yuv
 = 
dec_pi˘uª
->
chroma_f‹m©_idc
 - 1;

94 
cuºMB
->
p_Sli˚
->
	`öåa_¥ed_16x16
(cuºMB, 
cuº_∂™e
, cuºMB->
i16mode
);

95 
cuºMB
->
ùmode_DPCM
 = (ËcuºMB->
i16mode
;

98 
	`iMBå™s4x4
(
cuºMB
, 
cuº_∂™e
, 0);

101 i‡((
dec_pi˘uª
->
chroma_f‹m©_idc
 !
YUV400
Ë&& (dec_pi˘uª->chroma_f‹m©_id¯!
YUV444
))

103 
	`öåa_¸_decodög
(
cuºMB
, 
yuv
);

106 
cuºMB
->
p_Sli˚
->
is_ª£t_c€ff
 = 
FALSE
;

108 
	}
}

110 
	$mb_¥ed_öåa8x8
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
cuº_∂™e
, 
img≥l
 **
cuºImg
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
)

112 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

113 
yuv
 = 
dec_pi˘uª
->
chroma_f‹m©_idc
 - 1;

115 
block8x8
;

116 
cuºMB
->
ôøns_8x8
 = (cuºMB->
is_los¶ess
 =
FALSE
Ë? 
ôøns8x8
 : 
Inv_ResiduÆ_å™s_8x8
;

118 
block8x8
 = 0; block8x8 < 4; block8x8++)

121 
ioff
 = (
block8x8
 & 0x01) << 3;

122 
joff
 = (
block8x8
 >> 1 ) << 3;

125 
cuºSli˚
->
	`öåa_¥ed_8x8
(
cuºMB
, 
cuº_∂™e
, 
ioff
, 
joff
);

126 i‡(
cuºMB
->
cbp
 & (1 << 
block8x8
))

127 
cuºMB
->
	`ôøns_8x8
 (cuºMB, 
cuº_∂™e
, 
ioff
,
joff
);

129 
	`ic›y8x8
(
cuºMB
, 
cuº_∂™e
, 
ioff
,
joff
);

131 
	`c›y_image_d©a_8x8
(&
cuºImg
[
cuºMB
->
pix_y
 + 
joff
], &
cuºSli˚
->
mb_ªc
[
cuº_∂™e
][joff], cuºMB->
pix_x
 + 
ioff
, ioff);

134 i‡((
dec_pi˘uª
->
chroma_f‹m©_idc
 !
YUV400
Ë&& (dec_pi˘uª->chroma_f‹m©_id¯!
YUV444
))

136 
	`öåa_¸_decodög
(
cuºMB
, 
yuv
);

139 i‡(
cuºMB
->
cbp
 != 0)

140 
cuºSli˚
->
is_ª£t_c€ff
 = 
FALSE
;

142 
	}
}

145 
	$£t_chroma_ve˘‹
(
Ma¸oblock
 *
cuºMB
)

147 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

148 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

150 i‡(!
cuºSli˚
->
mb_aff_‰ame_Êag
)

152 if(
cuºSli˚
->
°ru˘uª
 =
TOP_FIELD
)

154 
k
,
l
;

155 
l
 = 
LIST_0
;Ü <(
LIST_1
);Ü++)

157 
k
 = 0; k < 
cuºSli˚
->
li°Xsize
[
l
]; k++)

159 if(
p_Vid
->
°ru˘uª
 !
cuºSli˚
->
li°X
[
l
][
k
]->structure)

160 
cuºSli˚
->
chroma_ve˘‹_adju°mít
[
l
][
k
] = -2;

162 
cuºSli˚
->
chroma_ve˘‹_adju°mít
[
l
][
k
] = 0;

166 if(
cuºSli˚
->
°ru˘uª
 =
BOTTOM_FIELD
)

168 
k
,
l
;

169 
l
 = 
LIST_0
;Ü <(
LIST_1
);Ü++)

171 
k
 = 0; k < 
cuºSli˚
->
li°Xsize
[
l
]; k++)

173 i‡(
p_Vid
->
°ru˘uª
 !
cuºSli˚
->
li°X
[
l
][
k
]->structure)

174 
cuºSli˚
->
chroma_ve˘‹_adju°mít
[
l
][
k
] = 2;

176 
cuºSli˚
->
chroma_ve˘‹_adju°mít
[
l
][
k
] = 0;

182 
k
,
l
;

183 
l
 = 
LIST_0
;Ü <(
LIST_1
);Ü++)

185 
k
 = 0; k < 
cuºSli˚
->
li°Xsize
[
l
]; k++)

187 
cuºSli˚
->
chroma_ve˘‹_adju°mít
[
l
][
k
] = 0;

194 
mb_ƒ
 = (
cuºMB
->
mbAddrX
 & 0x01);

195 
k
,
l
;

199 i‡(
cuºMB
->
mb_fõld
)

201 
li°_off£t
 = 
cuºMB
->list_offset;

203 
l
 = 
LIST_0
 + 
li°_off£t
;Ü <(
LIST_1
 +Üist_offset);Ü++)

205 
k
 = 0; k < 
cuºSli˚
->
li°Xsize
[
l
]; k++)

207 if(
mb_ƒ
 =0 && 
cuºSli˚
->
li°X
[
l
][
k
]->
°ru˘uª
 =
BOTTOM_FIELD
)

208 
cuºSli˚
->
chroma_ve˘‹_adju°mít
[
l
][
k
] = -2;

209 if(
mb_ƒ
 =1 && 
cuºSli˚
->
li°X
[
l
][
k
]->
°ru˘uª
 =
TOP_FIELD
)

210 
cuºSli˚
->
chroma_ve˘‹_adju°mít
[
l
][
k
] = 2;

212 
cuºSli˚
->
chroma_ve˘‹_adju°mít
[
l
][
k
] = 0;

218 
l
 = 
LIST_0
;Ü <(
LIST_1
);Ü++)

220 
k
 = 0; k < 
cuºSli˚
->
li°Xsize
[
l
]; k++)

222 
cuºSli˚
->
chroma_ve˘‹_adju°mít
[
l
][
k
] = 0;

228 
cuºSli˚
->
max_mb_vmv_r
 = (cuºSli˚->
°ru˘uª
 !
FRAME
 || ( 
cuºMB
->
mb_fõld
 )Ë? 
p_Vid
->
max_vmv_r
 >> 1 :Ö_Vid->max_vmv_r;

229 
	}
}

231 
	$mb_¥ed_skù
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
cuº_∂™e
, 
img≥l
 **
cuºImg
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
)

233 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

234 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

236 
	`£t_chroma_ve˘‹
(
cuºMB
);

238 
	`≥rf‹m_mc
(
cuºMB
, 
cuº_∂™e
, 
dec_pi˘uª
, 
LIST_0
, 0, 0, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE);

240 
	`c›y_image_d©a_16x16
(&
cuºImg
[
cuºMB
->
pix_y
], 
cuºSli˚
->
mb_¥ed
[
cuº_∂™e
], cuºMB->
pix_x
, 0);

242 i‡((
dec_pi˘uª
->
chroma_f‹m©_idc
 !
YUV400
Ë&& (dec_pi˘uª->chroma_f‹m©_id¯!
YUV444
))

245 
	`c›y_image_d©a
(&
dec_pi˘uª
->
imgUV
[0][
cuºMB
->
pix_c_y
], 
cuºSli˚
->
mb_¥ed
[1], cuºMB->
pix_c_x
, 0, 
p_Vid
->
mb_size
[1][0],Ö_Vid->mb_size[1][1]);

246 
	`c›y_image_d©a
(&
dec_pi˘uª
->
imgUV
[1][
cuºMB
->
pix_c_y
], 
cuºSli˚
->
mb_¥ed
[2], cuºMB->
pix_c_x
, 0, 
p_Vid
->
mb_size
[1][0],Ö_Vid->mb_size[1][1]);

249 
	}
}

251 
	$mb_¥ed_•_skù
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
cuº_∂™e
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
)

253 
	`£t_chroma_ve˘‹
(
cuºMB
);

255 
	`≥rf‹m_mc
(
cuºMB
, 
cuº_∂™e
, 
dec_pi˘uª
, 
LIST_0
, 0, 0, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE);

256 
	`iTønsf‹m
(
cuºMB
, 
cuº_∂™e
, 1);

258 
	}
}

260 
	$mb_¥ed_p_öãr8x8
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
cuº_∂™e
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
)

262 
block8x8
;

263 
i
=0, 
j
=0,
k
;

265 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

266 
smb
 = 
cuºSli˚
->
¶i˚_ty≥
 =
SP_SLICE
 && (
cuºMB
->
is_öåa_block
 =
FALSE
);

268 
	`£t_chroma_ve˘‹
(
cuºMB
);

270 
block8x8
=0; block8x8<4; block8x8++)

272 
mv_mode
 = 
cuºMB
->
b8mode
[
block8x8
];

273 
¥ed_dú
 = 
cuºMB
->
b8pdú
[
block8x8
];

275 
k_°¨t
 = (
block8x8
 << 2);

276 
k_öc
 = (
mv_mode
 =
SMB8x4
) ? 2 : 1;

277 
k_íd
 = (
mv_mode
 =
SMB8x8
Ë? 
k_°¨t
 + 1 : ((mv_modê=
SMB4x4
Ë? k_°¨à+ 4 : k_°¨à+ 
k_öc
 + 1);

279 
block_size_x
 = ( 
mv_mode
 =
SMB8x4
 || mv_modê=
SMB8x8
 ) ? 
SMB_BLOCK_SIZE
 : 
BLOCK_SIZE
;

280 
block_size_y
 = ( 
mv_mode
 =
SMB4x8
 || mv_modê=
SMB8x8
 ) ? 
SMB_BLOCK_SIZE
 : 
BLOCK_SIZE
;

282 
k
 = 
k_°¨t
; k < 
k_íd
; k +
k_öc
)

284 
i
 = (
decode_block_sˇn
[
k
] & 3);

285 
j
 = ((
decode_block_sˇn
[
k
] >> 2) & 3);

286 
	`≥rf‹m_mc
(
cuºMB
, 
cuº_∂™e
, 
dec_pi˘uª
, 
¥ed_dú
, 
i
, 
j
, 
block_size_x
, 
block_size_y
);

290 
	`iTønsf‹m
(
cuºMB
, 
cuº_∂™e
, 
smb
);

292 i‡(
cuºMB
->
cbp
 != 0)

293 
cuºSli˚
->
is_ª£t_c€ff
 = 
FALSE
;

295 
	}
}

297 
	$mb_¥ed_p_öãr16x16
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
cuº_∂™e
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
)

299 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

300 
smb
 = (
cuºSli˚
->
¶i˚_ty≥
 =
SP_SLICE
);

302 
	`£t_chroma_ve˘‹
(
cuºMB
);

303 
	`≥rf‹m_mc
(
cuºMB
, 
cuº_∂™e
, 
dec_pi˘uª
, cuºMB->
b8pdú
[0], 0, 0, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE);

304 
	`iTønsf‹m
(
cuºMB
, 
cuº_∂™e
, 
smb
);

306 i‡(
cuºMB
->
cbp
 != 0)

307 
cuºSli˚
->
is_ª£t_c€ff
 = 
FALSE
;

309 
	}
}

311 
	$mb_¥ed_p_öãr16x8
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
cuº_∂™e
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
)

313 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

314 
smb
 = (
cuºSli˚
->
¶i˚_ty≥
 =
SP_SLICE
);

316 
	`£t_chroma_ve˘‹
(
cuºMB
);

318 
	`≥rf‹m_mc
(
cuºMB
, 
cuº_∂™e
, 
dec_pi˘uª
, cuºMB->
b8pdú
[0], 0, 0, 
MB_BLOCK_SIZE
, 
BLOCK_SIZE_8x8
);

319 
	`≥rf‹m_mc
(
cuºMB
, 
cuº_∂™e
, 
dec_pi˘uª
, cuºMB->
b8pdú
[2], 0, 2, 
MB_BLOCK_SIZE
, 
BLOCK_SIZE_8x8
);

320 
	`iTønsf‹m
(
cuºMB
, 
cuº_∂™e
, 
smb
);

322 i‡(
cuºMB
->
cbp
 != 0)

323 
cuºSli˚
->
is_ª£t_c€ff
 = 
FALSE
;

325 
	}
}

327 
	$mb_¥ed_p_öãr8x16
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
cuº_∂™e
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
)

329 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

330 
smb
 = (
cuºSli˚
->
¶i˚_ty≥
 =
SP_SLICE
);

332 
	`£t_chroma_ve˘‹
(
cuºMB
);

334 
	`≥rf‹m_mc
(
cuºMB
, 
cuº_∂™e
, 
dec_pi˘uª
, cuºMB->
b8pdú
[0], 0, 0, 
BLOCK_SIZE_8x8
, 
MB_BLOCK_SIZE
);

335 
	`≥rf‹m_mc
(
cuºMB
, 
cuº_∂™e
, 
dec_pi˘uª
, cuºMB->
b8pdú
[1], 2, 0, 
BLOCK_SIZE_8x8
, 
MB_BLOCK_SIZE
);

336 
	`iTønsf‹m
(
cuºMB
, 
cuº_∂™e
, 
smb
);

338 i‡(
cuºMB
->
cbp
 != 0)

339 
cuºSli˚
->
is_ª£t_c€ff
 = 
FALSE
;

341 
	}
}

343 
ölöe
 
	$upd©e_√ighb‹_mvs
(
PicMŸi⁄P¨ams
 **
mŸi⁄
, c⁄° PicMŸi⁄P¨am†*
mv_öfo
, 
i4
)

345 (*
mŸi⁄
++)[
i4
 + 1] = *
mv_öfo
;

346 (*
mŸi⁄
 )[
i4
 ] = *
mv_öfo
;

347 (*
mŸi⁄
 )[
i4
 + 1] = *
mv_öfo
;

348 
	}
}

350 
	$mb_¥ed_b_d8x8ãmp‹Æ
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
cuº_∂™e
, 
img≥l
 **
cuºImg
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
)

352 
ªf_idx
;

353 
ªfLi°
;

355 
k
, 
i
, 
j
, 
i4
, 
j4
, 
j6
;

356 
block8x8
;

357 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

358 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

359 
PicMŸi⁄P¨ams
 *
mv_öfo
 = 
NULL
, *
cﬁoˇãd
 = NULL;

361 
li°_off£t
 = 
cuºMB
->list_offset;

362 
St‹abÀPi˘uª
 **
li°0
 = 
cuºSli˚
->
li°X
[
LIST_0
 + 
li°_off£t
];

363 
St‹abÀPi˘uª
 **
li°1
 = 
cuºSli˚
->
li°X
[
LIST_1
 + 
li°_off£t
];

365 
	`£t_chroma_ve˘‹
(
cuºMB
);

368 
block8x8
=0; block8x8<4; block8x8++)

370 
¥ed_dú
 = 
cuºMB
->
b8pdú
[
block8x8
];

372 
k_°¨t
 = (
block8x8
 << 2);

373 
k_íd
 = 
k_°¨t
 + 1;

375 
k
 = 
k_°¨t
; k < k_°¨à+ 
BLOCK_MULTIPLE
; k ++)

378 
i
 = (
decode_block_sˇn
[
k
] & 3);

379 
j
 = ((
decode_block_sˇn
[
k
] >> 2) & 3);

380 
i4
 = 
cuºMB
->
block_x
 + 
i
;

381 
j4
 = 
cuºMB
->
block_y
 + 
j
;

382 
j6
 = 
cuºMB
->
block_y_aff
 + 
j
;

383 
mv_öfo
 = &
dec_pi˘uª
->mv_öfo[
j4
][
i4
];

384 
cﬁoˇãd
 = &
li°1
[0]->
mv_öfo
[
	`RSD
(
j6
)][RSD(
i4
)];

385 if(
cuºMB
->
p_Vid
->
£∑øã_cﬁour_∂™e_Êag
 && cuºMB->p_Vid->
yuv_f‹m©
==
YUV444
)

386 
cﬁoˇãd
 = &
li°1
[0]->
JVmv_öfo
[
cuºMB
->
p_Sli˚
->
cﬁour_∂™e_id
][
	`RSD
(
j6
)][RSD(
i4
)];

387 if(
cuºSli˚
->
mb_aff_‰ame_Êag
 )

389 
	`as£π
(
p_Vid
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
);

390 if(!
cuºMB
->
mb_fõld
 && ((
cuºSli˚
->
li°X
[
LIST_1
][0]->
iCodögTy≥
==
FRAME_MB_PAIR_CODING
 && cuºSli˚->li°X[LIST_1][0]->
mŸi⁄
.mb_fõld[cuºMB->
mbAddrX
]) ||

391 (
cuºSli˚
->
li°X
[
LIST_1
][0]->
iCodögTy≥
==
FIELD_CODING
)))

393 i‡(
	`übs
(
dec_pi˘uª
->
poc
 - 
cuºSli˚
->
li°X
[
LIST_1
+4][0]->poc)> iabs(dec_picture->poc -currSlice->listX[LIST_1+2][0]->poc) )

395 
cﬁoˇãd
 = 
p_Vid
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
 ?

396 &
cuºSli˚
->
li°X
[
LIST_1
+2][0]->
mv_öfo
[
	`RSD
(
j6
)>>1][RSD(
i4
)] : &currSlice->listX[LIST_1+2][0]->mv_info[j6>>1][i4];

400 
cﬁoˇãd
 = 
p_Vid
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
 ?

401 &
cuºSli˚
->
li°X
[
LIST_1
+4][0]->
mv_öfo
[
	`RSD
(
j6
)>>1][RSD(
i4
)] : &currSlice->listX[LIST_1+4][0]->mv_info[j6>>1][i4];

405 if–!
p_Vid
->
a˘ive_•s
->
‰ame_mbs_⁄ly_Êag
 &&

406 (!
cuºSli˚
->
fõld_pic_Êag
 && cuºSli˚->
li°X
[
LIST_1
][0]->
iCodögTy≥
!=
FRAME_CODING
))

408 i‡(
	`übs
(
dec_pi˘uª
->
poc
 - 
li°1
[0]->
bŸtom_fõld
->poc)> iabs(dec_pi˘uª->po¯-li°1[0]->
t›_fõld
->poc) )

410 
cﬁoˇãd
 = 
p_Vid
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
 ?

411 &
li°1
[0]->
t›_fõld
->
mv_öfo
[
	`RSD
(
j6
)>>1][RSD(
i4
)] : &list1[0]->top_field->mv_info[j6>>1][i4];

415 
cﬁoˇãd
 = 
p_Vid
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
 ?

416 &
li°1
[0]->
bŸtom_fõld
->
mv_öfo
[
	`RSD
(
j6
)>>1][RSD(
i4
)] : &list1[0]->bottom_field->mv_info[j6>>1][i4];

419 if(!
p_Vid
->
a˘ive_•s
->
‰ame_mbs_⁄ly_Êag
 && 
cuºSli˚
->
fõld_pic_Êag
 && cuºSli˚->
°ru˘uª
!=
li°1
[0]->°ru˘uª &&Üi°1[0]->
coded_‰ame
)

421 i‡(
cuºSli˚
->
°ru˘uª
 =
TOP_FIELD
)

423 
cﬁoˇãd
 = 
p_Vid
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
 ?

424 &
li°1
[0]->
‰ame
->
t›_fõld
->
mv_öfo
[
	`RSD
(
j6
)][RSD(
i4
)] : &list1[0]->frame->top_field->mv_info[j6][i4];

428 
cﬁoˇãd
 = 
p_Vid
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
 ?

429 &
li°1
[0]->
‰ame
->
bŸtom_fõld
->
mv_öfo
[
	`RSD
(
j6
)][RSD(
i4
)] : &list1[0]->frame->bottom_field->mv_info[j6][i4];

434 
	`as£π
 (
¥ed_dú
<=2);

436 
ªfLi°
 = (
cﬁoˇãd
->
ªf_idx
[
LIST_0
]=-1 ? 
LIST_1
 : LIST_0);

437 
ªf_idx
 = 
cﬁoˇãd
->ªf_idx[
ªfLi°
];

439 if(
ªf_idx
==-1)

441 
mv_öfo
->
mv
[
LIST_0
] = 
zîo_mv
;

442 
mv_öfo
->
mv
[
LIST_1
] = 
zîo_mv
;

444 
mv_öfo
->
ªf_idx
[
LIST_0
] = 0;

445 
mv_öfo
->
ªf_idx
[
LIST_1
] = 0;

449 
m≠≥d_idx
=0;

450 
úef
;

451 if–(
cuºSli˚
->
mb_aff_‰ame_Êag
 && ( (
cuºMB
->
mb_fõld
 && 
cﬁoˇãd
->
ªf_pic
[
ªfLi°
]->
°ru˘uª
==
FRAME
) ||

452 (!
cuºMB
->
mb_fõld
 && 
cﬁoˇãd
->
ªf_pic
[
ªfLi°
]->
°ru˘uª
!=
FRAME
))) ||

453 (!
cuºSli˚
->
mb_aff_‰ame_Êag
 && ((cuºSli˚->
fõld_pic_Êag
==0 && 
cﬁoˇãd
->
ªf_pic
[
ªfLi°
]->
°ru˘uª
!=
FRAME
)

454 ||(
cuºSli˚
->
fõld_pic_Êag
==1 && 
cﬁoˇãd
->
ªf_pic
[
ªfLi°
]->
°ru˘uª
==
FRAME
))) )

456 
úef
 = 0; iª‡< 
	`imö
(
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
], cuºSli˚->
li°Xsize
[LIST_0 + 
li°_off£t
]);iref++)

458 if(
cuºSli˚
->
li°X
[
LIST_0
 + 
li°_off£t
][
úef
]->
t›_fõld
 =
cﬁoˇãd
->
ªf_pic
[
ªfLi°
] ||

459 
cuºSli˚
->
li°X
[
LIST_0
 + 
li°_off£t
][
úef
]->
bŸtom_fõld
 =
cﬁoˇãd
->
ªf_pic
[
ªfLi°
] ||

460 
cuºSli˚
->
li°X
[
LIST_0
 + 
li°_off£t
][
úef
]->
‰ame
 =
cﬁoˇãd
->
ªf_pic
[
ªfLi°
])

462 i‡((
cuºSli˚
->
fõld_pic_Êag
==1Ë&& (cuºSli˚->
li°X
[
LIST_0
 + 
li°_off£t
][
úef
]->
°ru˘uª
 != currSlice->structure))

464 
m≠≥d_idx
=
INVALIDINDEX
;

468 
m≠≥d_idx
 = 
úef
;

474 
m≠≥d_idx
=
INVALIDINDEX
;

480 
úef
 = 0; iª‡< 
	`imö
(
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
], cuºSli˚->
li°Xsize
[LIST_0 + 
li°_off£t
]);iref++)

482 if(
cuºSli˚
->
li°X
[
LIST_0
 + 
li°_off£t
][
úef
] =
cﬁoˇãd
->
ªf_pic
[
ªfLi°
])

484 
m≠≥d_idx
 = 
úef
;

489 
m≠≥d_idx
=
INVALIDINDEX
;

494 if(
INVALIDINDEX
 !
m≠≥d_idx
)

496 
mv_sˇÀ
 = 
cuºSli˚
->
mvsˇÀ
[
LIST_0
 + 
li°_off£t
][
m≠≥d_idx
];

497 
mv_y
 = 
cﬁoˇãd
->
mv
[
ªfLi°
].mv_y;

498 if((
cuºSli˚
->
mb_aff_‰ame_Êag
 && !
cuºMB
->
mb_fõld
 && 
cﬁoˇãd
->
ªf_pic
[
ªfLi°
]->
°ru˘uª
!=
FRAME
) ||

499 (!
cuºSli˚
->
mb_aff_‰ame_Êag
 && cuºSli˚->
fõld_pic_Êag
==0 && 
cﬁoˇãd
->
ªf_pic
[
ªfLi°
]->
°ru˘uª
!=
FRAME
) )

500 
mv_y
 *= 2;

501 if((
cuºSli˚
->
mb_aff_‰ame_Êag
 && 
cuºMB
->
mb_fõld
 && 
cﬁoˇãd
->
ªf_pic
[
ªfLi°
]->
°ru˘uª
==
FRAME
) ||

502 (!
cuºSli˚
->
mb_aff_‰ame_Êag
 && cuºSli˚->
fõld_pic_Êag
==1 && 
cﬁoˇãd
->
ªf_pic
[
ªfLi°
]->
°ru˘uª
==
FRAME
) )

503 
mv_y
 /= 2;

506 i‡(
mv_sˇÀ
 =9999 || 
cuºSli˚
->
li°X
[
LIST_0
 + 
li°_off£t
][
m≠≥d_idx
]->
is_l⁄g_ãrm
)

508 
mv_öfo
->
mv
[
LIST_0
].
mv_x
 = 
cﬁoˇãd
->mv[
ªfLi°
].mv_x;

509 
mv_öfo
->
mv
[
LIST_0
].
mv_y
 = () mv_y;

510 
mv_öfo
->
mv
[
LIST_1
] = 
zîo_mv
;

514 
mv_öfo
->
mv
[
LIST_0
].
mv_x
 = (Ë((
mv_sˇÀ
 * 
cﬁoˇãd
->mv[
ªfLi°
].mv_x + 128 ) >> 8);

515 
mv_öfo
->
mv
[
LIST_0
].
mv_y
 = (Ë((
mv_sˇÀ
 * mv_y + 128 ) >> 8);

517 
mv_öfo
->
mv
[
LIST_1
].
mv_x
 = (Ë(mv_öfo->mv[
LIST_0
].mv_x - 
cﬁoˇãd
->mv[
ªfLi°
].mv_x);

518 
mv_öfo
->
mv
[
LIST_1
].
mv_y
 = (Ë(mv_öfo->mv[
LIST_0
].mv_y - mv_y );

521 
mv_öfo
->
ªf_idx
[
LIST_0
] = (Ë
m≠≥d_idx
;

522 
mv_öfo
->
ªf_idx
[
LIST_1
] = 0;

524 i‡(
INVALIDINDEX
 =
m≠≥d_idx
)

526 
	`îr‹
("temporal directÉrror: colocated block hasÑefÅhat is unavailable",-1111);

531 
mv_öfo
->
ªf_pic
[
LIST_0
] = 
li°0
[()mv_öfo->
ªf_idx
[LIST_0]];

532 
mv_öfo
->
ªf_pic
[
LIST_1
] = 
li°1
[()mv_öfo->
ªf_idx
[LIST_1]];

535 
k
 = 
k_°¨t
; k < 
k_íd
; k ++)

537 
i
 = (
decode_block_sˇn
[
k
] & 3);

538 
j
 = ((
decode_block_sˇn
[
k
] >> 2) & 3);

539 
	`≥rf‹m_mc
(
cuºMB
, 
cuº_∂™e
, 
dec_pi˘uª
, 
¥ed_dú
, 
i
, 
j
, 
SMB_BLOCK_SIZE
, SMB_BLOCK_SIZE);

543 i‡(
cuºMB
->
cbp
 == 0)

545 
	`c›y_image_d©a_16x16
(&
cuºImg
[
cuºMB
->
pix_y
], 
cuºSli˚
->
mb_¥ed
[
cuº_∂™e
], cuºMB->
pix_x
, 0);

547 i‡((
dec_pi˘uª
->
chroma_f‹m©_idc
 !
YUV400
Ë&& (dec_pi˘uª->chroma_f‹m©_id¯!
YUV444
))

549 
	`c›y_image_d©a
(&
dec_pi˘uª
->
imgUV
[0][
cuºMB
->
pix_c_y
], 
cuºSli˚
->
mb_¥ed
[1], cuºMB->
pix_c_x
, 0, 
p_Vid
->
mb_size
[1][0],Ö_Vid->mb_size[1][1]);

550 
	`c›y_image_d©a
(&
dec_pi˘uª
->
imgUV
[1][
cuºMB
->
pix_c_y
], 
cuºSli˚
->
mb_¥ed
[2], cuºMB->
pix_c_x
, 0, 
p_Vid
->
mb_size
[1][0],Ö_Vid->mb_size[1][1]);

555 
	`iTønsf‹m
(
cuºMB
, 
cuº_∂™e
, 0);

556 
cuºSli˚
->
is_ª£t_c€ff
 = 
FALSE
;

559 
	}
}

561 
	$mb_¥ed_b_d4x4ãmp‹Æ
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
cuº_∂™e
, 
img≥l
 **
cuºImg
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
)

563 
ªf_idx
;

564 
ªfLi°
;

566 
k
;

567 
block8x8
;

568 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

569 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

571 
li°_off£t
 = 
cuºMB
->list_offset;

572 
St‹abÀPi˘uª
 **
li°0
 = 
cuºSli˚
->
li°X
[
LIST_0
 + 
li°_off£t
];

573 
St‹abÀPi˘uª
 **
li°1
 = 
cuºSli˚
->
li°X
[
LIST_1
 + 
li°_off£t
];

575 
	`£t_chroma_ve˘‹
(
cuºMB
);

577 
block8x8
=0; block8x8<4; block8x8++)

579 
¥ed_dú
 = 
cuºMB
->
b8pdú
[
block8x8
];

581 
k_°¨t
 = (
block8x8
 << 2);

582 
k_íd
 = 
k_°¨t
 + 
BLOCK_MULTIPLE
;

584 
k
 = 
k_°¨t
; k < 
k_íd
; k ++)

587 
i
 = (
decode_block_sˇn
[
k
] & 3);

588 
j
 = ((
decode_block_sˇn
[
k
] >> 2) & 3);

589 
i4
 = 
cuºMB
->
block_x
 + 
i
;

590 
j4
 = 
cuºMB
->
block_y
 + 
j
;

591 
j6
 = 
cuºMB
->
block_y_aff
 + 
j
;

592 
PicMŸi⁄P¨ams
 *
mv_öfo
 = &
dec_pi˘uª
->mv_öfo[
j4
][
i4
];

593 
PicMŸi⁄P¨ams
 *
cﬁoˇãd
 = &
li°1
[0]->
mv_öfo
[
j6
][
i4
];

594 if(
cuºMB
->
p_Vid
->
£∑øã_cﬁour_∂™e_Êag
 && cuºMB->p_Vid->
yuv_f‹m©
==
YUV444
)

595 
cﬁoˇãd
 = &
li°1
[0]->
JVmv_öfo
[
cuºMB
->
p_Sli˚
->
cﬁour_∂™e_id
][
	`RSD
(
j6
)][RSD(
i4
)];

596 
	`as£π
 (
¥ed_dú
<=2);

598 
ªfLi°
 = (
cﬁoˇãd
->
ªf_idx
[
LIST_0
]=-1 ? 
LIST_1
 : LIST_0);

599 
ªf_idx
 = 
cﬁoˇãd
->ªf_idx[
ªfLi°
];

601 if(
ªf_idx
==-1)

603 
mv_öfo
->
mv
[
LIST_0
] = 
zîo_mv
;

604 
mv_öfo
->
mv
[
LIST_1
] = 
zîo_mv
;

606 
mv_öfo
->
ªf_idx
[
LIST_0
] = 0;

607 
mv_öfo
->
ªf_idx
[
LIST_1
] = 0;

611 
m≠≥d_idx
=0;

612 
úef
;

614 
úef
=0;úef<
	`imö
(
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
], cuºSli˚->
li°Xsize
[LIST_0 + 
li°_off£t
]);iref++)

616 if(
cuºSli˚
->
li°X
[
LIST_0
 + 
li°_off£t
][
úef
] =
cﬁoˇãd
->
ªf_pic
[
ªfLi°
])

618 
m≠≥d_idx
=
úef
;

623 
m≠≥d_idx
=
INVALIDINDEX
;

626 i‡(
INVALIDINDEX
 =
m≠≥d_idx
)

628 
	`îr‹
("temporal directÉrror: colocated block hasÑefÅhat is unavailable",-1111);

632 
mv_sˇÀ
 = 
cuºSli˚
->
mvsˇÀ
[
LIST_0
 + 
li°_off£t
][
m≠≥d_idx
];

635 i‡(
mv_sˇÀ
 =9999 || 
cuºSli˚
->
li°X
[
LIST_0
+
li°_off£t
][
m≠≥d_idx
]->
is_l⁄g_ãrm
)

637 
mv_öfo
->
mv
[
LIST_0
] = 
cﬁoˇãd
->mv[
ªfLi°
];

638 
mv_öfo
->
mv
[
LIST_1
] = 
zîo_mv
;

642 
mv_öfo
->
mv
[
LIST_0
].
mv_x
 = (Ë((
mv_sˇÀ
 * 
cﬁoˇãd
->mv[
ªfLi°
].mv_x + 128 ) >> 8);

643 
mv_öfo
->
mv
[
LIST_0
].
mv_y
 = (Ë((
mv_sˇÀ
 * 
cﬁoˇãd
->mv[
ªfLi°
].mv_y + 128 ) >> 8);

645 
mv_öfo
->
mv
[
LIST_1
].
mv_x
 = (Ë(mv_öfo->mv[
LIST_0
].mv_x - 
cﬁoˇãd
->mv[
ªfLi°
].mv_x);

646 
mv_öfo
->
mv
[
LIST_1
].
mv_y
 = (Ë(mv_öfo->mv[
LIST_0
].mv_y - 
cﬁoˇãd
->mv[
ªfLi°
].mv_y);

649 
mv_öfo
->
ªf_idx
[
LIST_0
] = (Ë
m≠≥d_idx
;

650 
mv_öfo
->
ªf_idx
[
LIST_1
] = 0;

654 
mv_öfo
->
ªf_pic
[
LIST_0
] = 
li°0
[()mv_öfo->
ªf_idx
[LIST_0]];

655 
mv_öfo
->
ªf_pic
[
LIST_1
] = 
li°1
[()mv_öfo->
ªf_idx
[LIST_1]];

658 
k
 = 
k_°¨t
; k < 
k_íd
; k ++)

660 
i
 = (
decode_block_sˇn
[
k
] & 3);

661 
j
 = ((
decode_block_sˇn
[
k
] >> 2) & 3);

662 
	`≥rf‹m_mc
(
cuºMB
, 
cuº_∂™e
, 
dec_pi˘uª
, 
¥ed_dú
, 
i
, 
j
, 
BLOCK_SIZE
, BLOCK_SIZE);

667 i‡(
cuºMB
->
cbp
 == 0)

669 
	`c›y_image_d©a_16x16
(&
cuºImg
[
cuºMB
->
pix_y
], 
cuºSli˚
->
mb_¥ed
[
cuº_∂™e
], cuºMB->
pix_x
, 0);

671 i‡((
dec_pi˘uª
->
chroma_f‹m©_idc
 !
YUV400
Ë&& (dec_pi˘uª->chroma_f‹m©_id¯!
YUV444
))

673 
	`c›y_image_d©a
(&
dec_pi˘uª
->
imgUV
[0][
cuºMB
->
pix_c_y
], 
cuºSli˚
->
mb_¥ed
[1], cuºMB->
pix_c_x
, 0, 
p_Vid
->
mb_size
[1][0],Ö_Vid->mb_size[1][1]);

674 
	`c›y_image_d©a
(&
dec_pi˘uª
->
imgUV
[1][
cuºMB
->
pix_c_y
], 
cuºSli˚
->
mb_¥ed
[2], cuºMB->
pix_c_x
, 0, 
p_Vid
->
mb_size
[1][0],Ö_Vid->mb_size[1][1]);

679 
	`iTønsf‹m
(
cuºMB
, 
cuº_∂™e
, 0);

680 
cuºSli˚
->
is_ª£t_c€ff
 = 
FALSE
;

684 
	}
}

687 
	$mb_¥ed_b_d8x8•©ül
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
cuº_∂™e
, 
img≥l
 **
cuºImg
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
)

689 
l0_rFøme
 = -1, 
l1_rFøme
 = -1;

690 
MŸi⁄Ve˘‹
 
pmvl0
 = 
zîo_mv
, 
pmvl1
 = zero_mv;

691 
i4
, 
j4
;

692 
block8x8
;

693 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

694 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

696 
PicMŸi⁄P¨ams
 *
mv_öfo
;

697 
li°_off£t
 = 
cuºMB
->list_offset;

698 
St‹abÀPi˘uª
 **
li°0
 = 
cuºSli˚
->
li°X
[
LIST_0
 + 
li°_off£t
];

699 
St‹abÀPi˘uª
 **
li°1
 = 
cuºSli˚
->
li°X
[
LIST_1
 + 
li°_off£t
];

701 
¥ed_dú
 = 0;

703 
	`£t_chroma_ve˘‹
(
cuºMB
);

705 
	`¥ï¨e_dúe˘_∑øms
(
cuºMB
, 
dec_pi˘uª
, &
pmvl0
, &
pmvl1
, &
l0_rFøme
, &
l1_rFøme
);

707 i‡(
l0_rFøme
 =0 || 
l1_rFøme
 == 0)

709 
is_nŸ_movög
;

711 
block8x8
 = 0; block8x8 < 4; block8x8++)

713 
k_°¨t
 = (
block8x8
 << 2);

715 
i
 = (
decode_block_sˇn
[
k_°¨t
] & 3);

716 
j
 = ((
decode_block_sˇn
[
k_°¨t
] >> 2) & 3);

717 
i4
 = 
cuºMB
->
block_x
 + 
i
;

718 
j4
 = 
cuºMB
->
block_y
 + 
j
;

720 
is_nŸ_movög
 = (
	`gë_cﬁoˇãd_öfo_8x8
(
cuºMB
, 
li°1
[0], 
i4
, cuºMB->
block_y_aff
 + 
j
) == 0);

722 
mv_öfo
 = &
dec_pi˘uª
->mv_öfo[
j4
][
i4
];

725 i‡(
l1_rFøme
 == -1)

727 i‡(
is_nŸ_movög
)

729 
mv_öfo
->
ªf_pic
[
LIST_0
] = 
li°0
[0];

730 
mv_öfo
->
ªf_pic
[
LIST_1
] = 
NULL
;

731 
mv_öfo
->
mv
[
LIST_0
] = 
zîo_mv
;

732 
mv_öfo
->
mv
[
LIST_1
] = 
zîo_mv
;

733 
mv_öfo
->
ªf_idx
[
LIST_0
] = 0;

734 
mv_öfo
->
ªf_idx
[
LIST_1
] = -1;

738 
mv_öfo
->
ªf_pic
[
LIST_0
] = 
li°0
[(Ë
l0_rFøme
];

739 
mv_öfo
->
ªf_pic
[
LIST_1
] = 
NULL
;

740 
mv_öfo
->
mv
[
LIST_0
] = 
pmvl0
;

741 
mv_öfo
->
mv
[
LIST_1
] = 
zîo_mv
;

742 
mv_öfo
->
ªf_idx
[
LIST_0
] = 
l0_rFøme
;

743 
mv_öfo
->
ªf_idx
[
LIST_1
] = -1;

745 
¥ed_dú
 = 0;

747 i‡(
l0_rFøme
 == -1)

749 i‡(
is_nŸ_movög
)

751 
mv_öfo
->
ªf_pic
[
LIST_0
] = 
NULL
;

752 
mv_öfo
->
ªf_pic
[
LIST_1
] = 
li°1
[0];

753 
mv_öfo
->
mv
[
LIST_0
] = 
zîo_mv
;

754 
mv_öfo
->
mv
[
LIST_1
] = 
zîo_mv
;

755 
mv_öfo
->
ªf_idx
[
LIST_0
] = -1;

756 
mv_öfo
->
ªf_idx
[
LIST_1
] = 0;

760 
mv_öfo
->
ªf_pic
[
LIST_0
] = 
NULL
;

761 
mv_öfo
->
ªf_pic
[
LIST_1
] = 
li°1
[(Ë
l1_rFøme
];

762 
mv_öfo
->
mv
[
LIST_0
] = 
zîo_mv
;

763 
mv_öfo
->
mv
[
LIST_1
] = 
pmvl1
;

764 
mv_öfo
->
ªf_idx
[
LIST_0
] = -1;

765 
mv_öfo
->
ªf_idx
[
LIST_1
] = 
l1_rFøme
;

767 
¥ed_dú
 = 1;

771 i‡(
l0_rFøme
 =0 && ((
is_nŸ_movög
)))

773 
mv_öfo
->
ªf_pic
[
LIST_0
] = 
li°0
[0];

774 
mv_öfo
->
mv
[
LIST_0
] = 
zîo_mv
;

775 
mv_öfo
->
ªf_idx
[
LIST_0
] = 0;

779 
mv_öfo
->
ªf_pic
[
LIST_0
] = 
li°0
[(Ë
l0_rFøme
];

780 
mv_öfo
->
mv
[
LIST_0
] = 
pmvl0
;

781 
mv_öfo
->
ªf_idx
[
LIST_0
] = 
l0_rFøme
;

784 i‡(
l1_rFøme
 =0 && ((
is_nŸ_movög
)))

786 
mv_öfo
->
ªf_pic
[
LIST_1
] = 
li°1
[0];

787 
mv_öfo
->
mv
[
LIST_1
] = 
zîo_mv
;

788 
mv_öfo
->
ªf_idx
[
LIST_1
] = 0;

792 
mv_öfo
->
ªf_pic
[
LIST_1
] = 
li°1
[(Ë
l1_rFøme
];

793 
mv_öfo
->
mv
[
LIST_1
] = 
pmvl1
;

794 
mv_öfo
->
ªf_idx
[
LIST_1
] = 
l1_rFøme
;

796 
¥ed_dú
 = 2;

799 
	`upd©e_√ighb‹_mvs
(&
dec_pi˘uª
->
mv_öfo
[
j4
], mv_öfo, 
i4
);

800 
	`≥rf‹m_mc
(
cuºMB
, 
cuº_∂™e
, 
dec_pi˘uª
, 
¥ed_dú
, 
i
, 
j
, 
SMB_BLOCK_SIZE
, SMB_BLOCK_SIZE);

806 i‡(
l0_rFøme
 < 0 && 
l1_rFøme
 < 0)

808 
¥ed_dú
 = 2;

809 
j4
 = 
cuºMB
->
block_y
; j4 < cuºMB->block_y + 
BLOCK_MULTIPLE
; j4 += 2)

811 
i4
 = 
cuºMB
->
block_x
; i4 < cuºMB->block_x + 
BLOCK_MULTIPLE
; i4 += 2)

813 
mv_öfo
 = &
dec_pi˘uª
->mv_öfo[
j4
][
i4
];

815 
mv_öfo
->
ªf_pic
[
LIST_0
] = 
li°0
[0];

816 
mv_öfo
->
ªf_pic
[
LIST_1
] = 
li°1
[0];

817 
mv_öfo
->
mv
[
LIST_0
] = 
zîo_mv
;

818 
mv_öfo
->
mv
[
LIST_1
] = 
zîo_mv
;

819 
mv_öfo
->
ªf_idx
[
LIST_0
] = 0;

820 
mv_öfo
->
ªf_idx
[
LIST_1
] = 0;

822 
	`upd©e_√ighb‹_mvs
(&
dec_pi˘uª
->
mv_öfo
[
j4
], mv_öfo, 
i4
);

826 i‡(
l1_rFøme
 == -1)

828 
¥ed_dú
 = 0;

830 
j4
 = 
cuºMB
->
block_y
; j4 < cuºMB->block_y + 
BLOCK_MULTIPLE
; j4 += 2)

832 
i4
 = 
cuºMB
->
block_x
; i4 < cuºMB->block_x + 
BLOCK_MULTIPLE
; i4 += 2)

834 
mv_öfo
 = &
dec_pi˘uª
->mv_öfo[
j4
][
i4
];

836 
mv_öfo
->
ªf_pic
[
LIST_0
] = 
li°0
[(Ë
l0_rFøme
];

837 
mv_öfo
->
ªf_pic
[
LIST_1
] = 
NULL
;

838 
mv_öfo
->
mv
[
LIST_0
] = 
pmvl0
;

839 
mv_öfo
->
mv
[
LIST_1
] = 
zîo_mv
;

840 
mv_öfo
->
ªf_idx
[
LIST_0
] = 
l0_rFøme
;

841 
mv_öfo
->
ªf_idx
[
LIST_1
] = -1;

843 
	`upd©e_√ighb‹_mvs
(&
dec_pi˘uª
->
mv_öfo
[
j4
], mv_öfo, 
i4
);

847 i‡(
l0_rFøme
 == -1)

849 
¥ed_dú
 = 1;

850 
j4
 = 
cuºMB
->
block_y
; j4 < cuºMB->block_y + 
BLOCK_MULTIPLE
; j4 += 2)

852 
i4
 = 
cuºMB
->
block_x
; i4 < cuºMB->block_x + 
BLOCK_MULTIPLE
; i4 += 2)

854 
mv_öfo
 = &
dec_pi˘uª
->mv_öfo[
j4
][
i4
];

856 
mv_öfo
->
ªf_pic
[
LIST_0
] = 
NULL
;

857 
mv_öfo
->
ªf_pic
[
LIST_1
] = 
li°1
[(Ë
l1_rFøme
];

858 
mv_öfo
->
mv
[
LIST_0
] = 
zîo_mv
;

859 
mv_öfo
->
mv
[
LIST_1
] = 
pmvl1
;

860 
mv_öfo
->
ªf_idx
[
LIST_0
] = -1;

861 
mv_öfo
->
ªf_idx
[
LIST_1
] = 
l1_rFøme
;

863 
	`upd©e_√ighb‹_mvs
(&
dec_pi˘uª
->
mv_öfo
[
j4
], mv_öfo, 
i4
);

869 
¥ed_dú
 = 2;

871 
j4
 = 
cuºMB
->
block_y
; j4 < cuºMB->block_y + 
BLOCK_MULTIPLE
; j4 += 2)

873 
i4
 = 
cuºMB
->
block_x
; i4 < cuºMB->block_x + 
BLOCK_MULTIPLE
; i4 += 2)

875 
mv_öfo
 = &
dec_pi˘uª
->mv_öfo[
j4
][
i4
];

877 
mv_öfo
->
ªf_pic
[
LIST_0
] = 
li°0
[(Ë
l0_rFøme
];

878 
mv_öfo
->
ªf_pic
[
LIST_1
] = 
li°1
[(Ë
l1_rFøme
];

879 
mv_öfo
->
mv
[
LIST_0
] = 
pmvl0
;

880 
mv_öfo
->
mv
[
LIST_1
] = 
pmvl1
;

881 
mv_öfo
->
ªf_idx
[
LIST_0
] = 
l0_rFøme
;

882 
mv_öfo
->
ªf_idx
[
LIST_1
] = 
l1_rFøme
;

884 
	`upd©e_√ighb‹_mvs
(&
dec_pi˘uª
->
mv_öfo
[
j4
], mv_öfo, 
i4
);

889 
	`≥rf‹m_mc
(
cuºMB
, 
cuº_∂™e
, 
dec_pi˘uª
, 
¥ed_dú
, 0, 0, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE);

892 i‡(
cuºMB
->
cbp
 == 0)

894 
	`c›y_image_d©a_16x16
(&
cuºImg
[
cuºMB
->
pix_y
], 
cuºSli˚
->
mb_¥ed
[
cuº_∂™e
], cuºMB->
pix_x
, 0);

896 i‡((
dec_pi˘uª
->
chroma_f‹m©_idc
 !
YUV400
Ë&& (dec_pi˘uª->chroma_f‹m©_id¯!
YUV444
))

898 
	`c›y_image_d©a
(&
dec_pi˘uª
->
imgUV
[0][
cuºMB
->
pix_c_y
], 
cuºSli˚
->
mb_¥ed
[1], cuºMB->
pix_c_x
, 0, 
p_Vid
->
mb_size
[1][0],Ö_Vid->mb_size[1][1]);

899 
	`c›y_image_d©a
(&
dec_pi˘uª
->
imgUV
[1][
cuºMB
->
pix_c_y
], 
cuºSli˚
->
mb_¥ed
[2], cuºMB->
pix_c_x
, 0, 
p_Vid
->
mb_size
[1][0],Ö_Vid->mb_size[1][1]);

904 
	`iTønsf‹m
(
cuºMB
, 
cuº_∂™e
, 0);

905 
cuºSli˚
->
is_ª£t_c€ff
 = 
FALSE
;

909 
	}
}

912 
	$mb_¥ed_b_d4x4•©ül
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
cuº_∂™e
, 
img≥l
 **
cuºImg
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
)

914 
l0_rFøme
 = -1, 
l1_rFøme
 = -1;

915 
MŸi⁄Ve˘‹
 
pmvl0
 = 
zîo_mv
, 
pmvl1
 = zero_mv;

916 
k
;

917 
block8x8
;

918 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

919 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

921 
PicMŸi⁄P¨ams
 *
mv_öfo
;

922 
li°_off£t
 = 
cuºMB
->list_offset;

923 
St‹abÀPi˘uª
 **
li°0
 = 
cuºSli˚
->
li°X
[
LIST_0
 + 
li°_off£t
];

924 
St‹abÀPi˘uª
 **
li°1
 = 
cuºSli˚
->
li°X
[
LIST_1
 + 
li°_off£t
];

926 
¥ed_dú
 = 0;

928 
	`£t_chroma_ve˘‹
(
cuºMB
);

930 
	`¥ï¨e_dúe˘_∑øms
(
cuºMB
, 
dec_pi˘uª
, &
pmvl0
, &
pmvl1
, &
l0_rFøme
, &
l1_rFøme
);

932 
block8x8
 = 0; block8x8 < 4; block8x8++)

934 
k_°¨t
 = (
block8x8
 << 2);

935 
k_íd
 = 
k_°¨t
 + 
BLOCK_MULTIPLE
;

937 
k
 = 
k_°¨t
; k < 
k_íd
; k ++)

939 
i
 = (
decode_block_sˇn
[
k
] & 3);

940 
j
 = ((
decode_block_sˇn
[
k
] >> 2) & 3);

941 
i4
 = 
cuºMB
->
block_x
 + 
i
;

942 
j4
 = 
cuºMB
->
block_y
 + 
j
;

944 
mv_öfo
 = &
dec_pi˘uª
->mv_öfo[
j4
][
i4
];

946 i‡(
l0_rFøme
 =0 || 
l1_rFøme
 == 0)

948 
is_nŸ_movög
 = (
	`gë_cﬁoˇãd_öfo_4x4
(
cuºMB
, 
li°1
[0], 
i4
, cuºMB->
block_y_aff
 + 
j
) == 0);

950 i‡(
l1_rFøme
 == -1)

952 i‡(
is_nŸ_movög
)

954 
mv_öfo
->
ªf_pic
[
LIST_0
] = 
li°0
[0];

955 
mv_öfo
->
ªf_pic
[
LIST_1
] = 
NULL
;

956 
mv_öfo
->
mv
[
LIST_0
] = 
zîo_mv
;

957 
mv_öfo
->
mv
[
LIST_1
] = 
zîo_mv
;

958 
mv_öfo
->
ªf_idx
[
LIST_0
] = 0;

959 
mv_öfo
->
ªf_idx
[
LIST_1
] = -1;

963 
mv_öfo
->
ªf_pic
[
LIST_0
] = 
li°0
[(Ë
l0_rFøme
];

964 
mv_öfo
->
ªf_pic
[
LIST_1
] = 
NULL
;

965 
mv_öfo
->
mv
[
LIST_0
] = 
pmvl0
;

966 
mv_öfo
->
mv
[
LIST_1
] = 
zîo_mv
;

967 
mv_öfo
->
ªf_idx
[
LIST_0
] = 
l0_rFøme
;

968 
mv_öfo
->
ªf_idx
[
LIST_1
] = -1;

970 
¥ed_dú
 = 0;

972 i‡(
l0_rFøme
 == -1)

974 i‡(
is_nŸ_movög
)

976 
mv_öfo
->
ªf_pic
[
LIST_0
] = 
NULL
;

977 
mv_öfo
->
ªf_pic
[
LIST_1
] = 
li°1
[0];

978 
mv_öfo
->
mv
[
LIST_0
] = 
zîo_mv
;

979 
mv_öfo
->
mv
[
LIST_1
] = 
zîo_mv
;

980 
mv_öfo
->
ªf_idx
[
LIST_0
] = -1;

981 
mv_öfo
->
ªf_idx
[
LIST_1
] = 0;

985 
mv_öfo
->
ªf_pic
[
LIST_0
] = 
NULL
;

986 
mv_öfo
->
ªf_pic
[
LIST_1
] = 
li°1
[(Ë
l1_rFøme
];

987 
mv_öfo
->
mv
[
LIST_0
] = 
zîo_mv
;

988 
mv_öfo
->
mv
[
LIST_1
] = 
pmvl1
;

989 
mv_öfo
->
ªf_idx
[
LIST_0
] = -1;

990 
mv_öfo
->
ªf_idx
[
LIST_1
] = 
l1_rFøme
;

992 
¥ed_dú
 = 1;

996 i‡(
l0_rFøme
 =0 && ((
is_nŸ_movög
)))

998 
mv_öfo
->
ªf_pic
[
LIST_0
] = 
li°0
[0];

999 
mv_öfo
->
mv
[
LIST_0
] = 
zîo_mv
;

1000 
mv_öfo
->
ªf_idx
[
LIST_0
] = 0;

1004 
mv_öfo
->
ªf_pic
[
LIST_0
] = 
li°0
[(Ë
l0_rFøme
];

1005 
mv_öfo
->
mv
[
LIST_0
] = 
pmvl0
;

1006 
mv_öfo
->
ªf_idx
[
LIST_0
] = 
l0_rFøme
;

1009 i‡(
l1_rFøme
 =0 && ((
is_nŸ_movög
)))

1011 
mv_öfo
->
ªf_pic
[
LIST_1
] = 
li°1
[0];

1012 
mv_öfo
->
mv
[
LIST_1
] = 
zîo_mv
;

1013 
mv_öfo
->
ªf_idx
[
LIST_1
] = 0;

1017 
mv_öfo
->
ªf_pic
[
LIST_1
] = 
li°1
[(Ë
l1_rFøme
];

1018 
mv_öfo
->
mv
[
LIST_1
] = 
pmvl1
;

1019 
mv_öfo
->
ªf_idx
[
LIST_1
] = 
l1_rFøme
;

1021 
¥ed_dú
 = 2;

1026 
mv_öfo
 = &
dec_pi˘uª
->mv_öfo[
j4
][
i4
];

1028 i‡(
l0_rFøme
 < 0 && 
l1_rFøme
 < 0)

1030 
¥ed_dú
 = 2;

1031 
mv_öfo
->
ªf_pic
[
LIST_0
] = 
li°0
[0];

1032 
mv_öfo
->
ªf_pic
[
LIST_1
] = 
li°1
[0];

1033 
mv_öfo
->
mv
[
LIST_0
] = 
zîo_mv
;

1034 
mv_öfo
->
mv
[
LIST_1
] = 
zîo_mv
;

1035 
mv_öfo
->
ªf_idx
[
LIST_0
] = 0;

1036 
mv_öfo
->
ªf_idx
[
LIST_1
] = 0;

1038 i‡(
l1_rFøme
 == -1)

1040 
¥ed_dú
 = 0;

1041 
mv_öfo
->
ªf_pic
[
LIST_0
] = 
li°0
[(Ë
l0_rFøme
];

1042 
mv_öfo
->
ªf_pic
[
LIST_1
] = 
NULL
;

1043 
mv_öfo
->
mv
[
LIST_0
] = 
pmvl0
;

1044 
mv_öfo
->
mv
[
LIST_1
] = 
zîo_mv
;

1045 
mv_öfo
->
ªf_idx
[
LIST_0
] = 
l0_rFøme
;

1046 
mv_öfo
->
ªf_idx
[
LIST_1
] = -1;

1048 i‡(
l0_rFøme
 == -1)

1050 
¥ed_dú
 = 1;

1051 
mv_öfo
->
ªf_pic
[
LIST_0
] = 
NULL
;

1052 
mv_öfo
->
ªf_pic
[
LIST_1
] = 
li°1
[(Ë
l1_rFøme
];

1053 
mv_öfo
->
mv
[
LIST_0
] = 
zîo_mv
;

1054 
mv_öfo
->
mv
[
LIST_1
] = 
pmvl1
;

1055 
mv_öfo
->
ªf_idx
[
LIST_0
] = -1;

1056 
mv_öfo
->
ªf_idx
[
LIST_1
] = 
l1_rFøme
;

1060 
¥ed_dú
 = 2;

1061 
mv_öfo
->
ªf_pic
[
LIST_0
] = 
li°0
[(Ë
l0_rFøme
];

1062 
mv_öfo
->
ªf_pic
[
LIST_1
] = 
li°1
[(Ë
l1_rFøme
];

1063 
mv_öfo
->
mv
[
LIST_0
] = 
pmvl0
;

1064 
mv_öfo
->
mv
[
LIST_1
] = 
pmvl1
;

1065 
mv_öfo
->
ªf_idx
[
LIST_0
] = 
l0_rFøme
;

1066 
mv_öfo
->
ªf_idx
[
LIST_1
] = 
l1_rFøme
;

1071 
k
 = 
k_°¨t
; k < 
k_íd
; k ++)

1073 
i
 = (
decode_block_sˇn
[
k
] & 3);

1074 
j
 = ((
decode_block_sˇn
[
k
] >> 2) & 3);

1076 
	`≥rf‹m_mc
(
cuºMB
, 
cuº_∂™e
, 
dec_pi˘uª
, 
¥ed_dú
, 
i
, 
j
, 
BLOCK_SIZE
, BLOCK_SIZE);

1080 i‡(
cuºMB
->
cbp
 == 0)

1082 
	`c›y_image_d©a_16x16
(&
cuºImg
[
cuºMB
->
pix_y
], 
cuºSli˚
->
mb_¥ed
[
cuº_∂™e
], cuºMB->
pix_x
, 0);

1084 i‡((
dec_pi˘uª
->
chroma_f‹m©_idc
 !
YUV400
Ë&& (dec_pi˘uª->chroma_f‹m©_id¯!
YUV444
))

1086 
	`c›y_image_d©a
(&
dec_pi˘uª
->
imgUV
[0][
cuºMB
->
pix_c_y
], 
cuºSli˚
->
mb_¥ed
[1], cuºMB->
pix_c_x
, 0, 
p_Vid
->
mb_size
[1][0],Ö_Vid->mb_size[1][1]);

1087 
	`c›y_image_d©a
(&
dec_pi˘uª
->
imgUV
[1][
cuºMB
->
pix_c_y
], 
cuºSli˚
->
mb_¥ed
[2], cuºMB->
pix_c_x
, 0, 
p_Vid
->
mb_size
[1][0],Ö_Vid->mb_size[1][1]);

1092 
	`iTønsf‹m
(
cuºMB
, 
cuº_∂™e
, 0);

1093 
cuºSli˚
->
is_ª£t_c€ff
 = 
FALSE
;

1097 
	}
}

1099 
	$mb_¥ed_b_öãr8x8
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
cuº_∂™e
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
)

1101 
l0_rFøme
 = -1, 
l1_rFøme
 = -1;

1102 
MŸi⁄Ve˘‹
 
pmvl0
 = 
zîo_mv
, 
pmvl1
 = zero_mv;

1103 
block_size_x
, 
block_size_y
;

1104 
k
;

1105 
block8x8
;

1106 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1107 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1109 
li°_off£t
 = 
cuºMB
->list_offset;

1110 
St‹abÀPi˘uª
 **
li°0
 = 
cuºSli˚
->
li°X
[
LIST_0
 + 
li°_off£t
];

1111 
St‹abÀPi˘uª
 **
li°1
 = 
cuºSli˚
->
li°X
[
LIST_1
 + 
li°_off£t
];

1113 
	`£t_chroma_ve˘‹
(
cuºMB
);

1116 i‡(
cuºSli˚
->
dúe˘_•©ül_mv_¥ed_Êag
 && (!(
cuºMB
->
b8mode
[0] && currMB->b8mode[1] && currMB->b8mode[2] && currMB->b8mode[3])))

1117 
	`¥ï¨e_dúe˘_∑øms
(
cuºMB
, 
dec_pi˘uª
, &
pmvl0
, &
pmvl1
, &
l0_rFøme
, &
l1_rFøme
);

1119 
block8x8
=0; block8x8<4; block8x8++)

1121 
mv_mode
 = 
cuºMB
->
b8mode
[
block8x8
];

1122 
¥ed_dú
 = 
cuºMB
->
b8pdú
[
block8x8
];

1124 i‡–
mv_mode
 != 0 )

1126 
k_°¨t
 = (
block8x8
 << 2);

1127 
k_öc
 = (
mv_mode
 =
SMB8x4
) ? 2 : 1;

1128 
k_íd
 = (
mv_mode
 =
SMB8x8
Ë? 
k_°¨t
 + 1 : ((mv_modê=
SMB4x4
Ë? k_°¨à+ 4 : k_°¨à+ 
k_öc
 + 1);

1130 
block_size_x
 = ( 
mv_mode
 =
SMB8x4
 || mv_modê=
SMB8x8
 ) ? 
SMB_BLOCK_SIZE
 : 
BLOCK_SIZE
;

1131 
block_size_y
 = ( 
mv_mode
 =
SMB4x8
 || mv_modê=
SMB8x8
 ) ? 
SMB_BLOCK_SIZE
 : 
BLOCK_SIZE
;

1133 
k
 = 
k_°¨t
; k < 
k_íd
; k +
k_öc
)

1135 
i
 = (
decode_block_sˇn
[
k
] & 3);

1136 
j
 = ((
decode_block_sˇn
[
k
] >> 2) & 3);

1137 
	`≥rf‹m_mc
(
cuºMB
, 
cuº_∂™e
, 
dec_pi˘uª
, 
¥ed_dú
, 
i
, 
j
, 
block_size_x
, 
block_size_y
);

1142 
k_°¨t
 = (
block8x8
 << 2);

1143 
k_íd
 = 
k_°¨t
;

1145 i‡(
p_Vid
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
)

1147 
block_size_x
 = 
SMB_BLOCK_SIZE
;

1148 
block_size_y
 = 
SMB_BLOCK_SIZE
;

1149 
k_íd
 ++;

1153 
block_size_x
 = 
BLOCK_SIZE
;

1154 
block_size_y
 = 
BLOCK_SIZE
;

1155 
k_íd
 +
BLOCK_MULTIPLE
;

1159 i‡(
cuºSli˚
->
dúe˘_•©ül_mv_¥ed_Êag
)

1161 
k
 = 
k_°¨t
; k < k_°¨à+ 
BLOCK_MULTIPLE
; k ++)

1163 
i
 = (
decode_block_sˇn
[
k
] & 3);

1164 
j
 = ((
decode_block_sˇn
[
k
] >> 2) & 3);

1165 
i4
 = 
cuºMB
->
block_x
 + 
i
;

1166 
j4
 = 
cuºMB
->
block_y
 + 
j
;

1167 
PicMŸi⁄P¨ams
 *
mv_öfo
 = &
dec_pi˘uª
->mv_öfo[
j4
][
i4
];

1169 
	`as£π
 (
¥ed_dú
<=2);

1173 i‡(
mv_öfo
->
ªf_idx
[
LIST_1
] == -1)

1175 
¥ed_dú
 = 0;

1177 i‡(
mv_öfo
->
ªf_idx
[
LIST_0
] == -1)

1179 
¥ed_dú
 = 1;

1183 
¥ed_dú
 = 2;

1189 
k
 = 
k_°¨t
; k < k_°¨à+ 
BLOCK_MULTIPLE
; k ++)

1192 
i
 = (
decode_block_sˇn
[
k
] & 3);

1193 
j
 = ((
decode_block_sˇn
[
k
] >> 2) & 3);

1194 
i4
 = 
cuºMB
->
block_x
 + 
i
;

1195 
j4
 = 
cuºMB
->
block_y
 + 
j
;

1196 
PicMŸi⁄P¨ams
 *
mv_öfo
 = &
dec_pi˘uª
->mv_öfo[
j4
][
i4
];

1198 
	`as£π
 (
¥ed_dú
<=2);

1201 
mv_öfo
->
ªf_pic
[
LIST_0
] = 
li°0
[()mv_öfo->
ªf_idx
[LIST_0]];

1202 
mv_öfo
->
ªf_pic
[
LIST_1
] = 
li°1
[()mv_öfo->
ªf_idx
[LIST_1]];

1206 
k
 = 
k_°¨t
; k < 
k_íd
; k ++)

1208 
i
 = (
decode_block_sˇn
[
k
] & 3);

1209 
j
 = ((
decode_block_sˇn
[
k
] >> 2) & 3);

1210 
	`≥rf‹m_mc
(
cuºMB
, 
cuº_∂™e
, 
dec_pi˘uª
, 
¥ed_dú
, 
i
, 
j
, 
block_size_x
, 
block_size_y
);

1215 
	`iTønsf‹m
(
cuºMB
, 
cuº_∂™e
, 0);

1216 i‡(
cuºMB
->
cbp
 != 0)

1217 
cuºSli˚
->
is_ª£t_c€ff
 = 
FALSE
;

1219 
	}
}

1232 
	$mb_¥ed_ùcm
(
Ma¸oblock
 *
cuºMB
)

1234 
i
, 
j
, 
k
;

1235 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1236 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1237 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
cuºSli˚
->dec_picture;

1242 
i
 = 0; i < 
MB_BLOCK_SIZE
; ++i)

1244 
j
 = 0;j < 
MB_BLOCK_SIZE
 ; ++j)

1246 
dec_pi˘uª
->
imgY
[
cuºMB
->
pix_y
 + 
i
][cuºMB->
pix_x
 + 
j
] = (
img≥l
Ë
cuºSli˚
->
cof
[0][i][j];

1250 i‡((
dec_pi˘uª
->
chroma_f‹m©_idc
 !
YUV400
Ë&& (
p_Vid
->
£∑øã_cﬁour_∂™e_Êag
 == 0))

1252 
k
 = 0; k < 2; ++k)

1254 
i
 = 0; i < 
p_Vid
->
mb_¸_size_y
; ++i)

1256 
j
 = 0;j < 
p_Vid
->
mb_¸_size_x
; ++j)

1258 
dec_pi˘uª
->
imgUV
[
k
][
cuºMB
->
pix_c_y
+
i
][cuºMB->
pix_c_x
 + 
j
] = (
img≥l
Ë
cuºSli˚
->
cof
[k + 1][i][j];

1265 
	`upd©e_qp
(
cuºMB
, 0);

1269 
	`mem£t
(
p_Vid
->
nz_c€ff
[
cuºMB
->
mbAddrX
][0][0], 16, 3 * 
BLOCK_PIXELS
 * (
byã
));

1272 
cuºMB
->
skù_Êag
 = 0;

1275 
cuºMB
->
s_cbp
[0].
blk
 = 0xFFFF;

1278 
cuºSli˚
->
œ°_dqu™t
 = 0;

1279 
cuºSli˚
->
is_ª£t_c€ff
 = 
FALSE
;

1280 
cuºSli˚
->
is_ª£t_c€ff_¸
 = 
FALSE
;

1282 
	}
}

	@ldecod/src/mb_read.c

23 
	~"c⁄åibut‹s.h
"

25 
	~<m©h.h
>

27 
	~"block.h
"

28 
	~"globÆ.h
"

29 
	~"mbuf„r.h
"

30 
	~"mbuf„r_mvc.h
"

31 
	~"ñemíts.h
"

33 
	~"ma¸oblock.h
"

34 
	~"fmo.h
"

35 
	~"ˇbac.h
"

36 
	~"vlc.h
"

37 
	~"image.h
"

38 
	~"mb_ac˚ss.h
"

39 
	~"büridecod.h
"

40 
	~"å™sf‹m.h
"

41 
	~"mc_¥edi˘i⁄.h
"

42 
	~"qu™t.h
"

43 
	~"mv_¥edi˘i⁄.h
"

44 
	~"mb_¥edi˘i⁄.h
"

45 
	~"Á°_mem‹y.h
"

46 
	~"fûeh™dÀ.h
"

48 #i‡
TRACE


49 
	#TRACE_STRING
(
s
Ë
	`°∫˝y
(
cuºSE
.
åa˚°rög
, s, 
TRACESTRING_SIZE
)

	)

50 
	#TRACE_DECBITS
(
i
Ë
	`de˘ø˚bô˙t
(1)

	)

51 
	#TRACE_PRINTF
(
s
Ë
	`•rötf
(
ty≥
, "%s", s);

	)

52 
	#TRACE_STRING_P
(
s
Ë
	`°∫˝y
(
cuºSE
->
åa˚°rög
, s, 
TRACESTRING_SIZE
)

	)

54 
	#TRACE_STRING
(
s
)

	)

55 
	#TRACE_DECBITS
(
i
)

	)

56 
	#TRACE_PRINTF
(
s
)

	)

57 
	#TRACE_STRING_P
(
s
)

	)

60 
£t_ªad_comp_c€ff_ˇbac
 (
Ma¸oblock
 *
cuºMB
);

61 
£t_ªad_comp_c€ff_ˇvlc
 (
Ma¸oblock
 *
cuºMB
);

63 
ölöe
 
	$upd©e_pixñ_pos8
(
PixñPos
 *
pos_block
, c⁄° PixñPo†*
pos_mb
, 
pos
)

65 *
pos_block
 = *
pos_mb
;

66 i‡(
pos_block
->
avaûabÀ
)

68 i‡(
pos
 == 1)

70 
pos_block
->
pos_x
 += 2;

72 i‡(
pos
 == 2)

74 
pos_block
->
pos_y
 += 2;

76 i‡(
pos
 == 3)

78 
pos_block
->
pos_y
 += 2;

79 
pos_block
->
pos_x
 += 2;

82 
	}
}

91 
	$ªad_ùªd_8x8_modes_mbaff
(
Ma¸oblock
 *
cuºMB
)

93 
b8
, 
bi
, 
bj
, 
bx
, 
by
, 
dec
;

94 
Sy¡axEÀmít
 
cuºSE
;

95 
D©aP¨tôi⁄
 *
dP
;

96 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

97 c⁄° 
byã
 *
∑πM≠
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
dp_mode
];

98 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

100 
mo°ProbabÀI¡øPªdMode
;

101 
upI¡øPªdMode
;

102 
À·I¡øPªdMode
;

104 
PixñPos
 
À·_block
, 
t›_block
;

106 
cuºSE
.
ty≥
 = 
SE_INTRAPREDMODE
;

108 
	`TRACE_STRING
("intra4x4_pred_mode");

109 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_INTRAPREDMODE
]]);

111 i‡(!(
p_Vid
->
a˘ive_µs
->
íå›y_codög_mode_Êag
 =(
Boﬁón
Ë
CAVLC
 || 
dP
->
bô°ªam
->
ei_Êag
))

112 
cuºSE
.
ªadög
 = 
ªadI¡øPªdMode_CABAC
;

114 
b8
 = 0; b8 < 4; ++b8)

116 
by
 = (
b8
 & 0x02);

117 
bj
 = 
cuºMB
->
block_y
 + 
by
;

119 
bx
 = ((
b8
 & 0x01) << 1);

120 
bi
 = 
cuºMB
->
block_x
 + 
bx
;

122 i‡(
p_Vid
->
a˘ive_µs
->
íå›y_codög_mode_Êag
 =(
Boﬁón
Ë
CAVLC
 || 
dP
->
bô°ªam
->
ei_Êag
)

123 
	`ªadSy¡axEÀmít_I¡ø4x4Pªdi˘i⁄Mode
(&
cuºSE
, 
dP
->
bô°ªam
);

126 
cuºSE
.
c⁄ãxt
 = (
b8
 << 2);

127 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, &
cuºSE
, dP);

130 
	`gë4x4Neighbour
(
cuºMB
, (
bx
 << 2Ë- 1, (
by
 << 2), 
p_Vid
->
mb_size
[
IS_LUMA
], &
À·_block
);

131 
	`gë4x4Neighbour
(
cuºMB
, (
bx
 << 2), (
by
 << 2Ë- 1, 
p_Vid
->
mb_size
[
IS_LUMA
], &
t›_block
 );

135 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

137 
À·_block
.
avaûabÀ
 =Üe·_block.avaûabÀ ? 
cuºSli˚
->
öåa_block
[À·_block.
mb_addr
] : 0;

138 
t›_block
.
avaûabÀ
 =Å›_block.avaûabÀ ? 
cuºSli˚
->
öåa_block
[t›_block.
mb_addr
] : 0;

141 
upI¡øPªdMode
 = (
t›_block
.
avaûabÀ
 ) ? 
cuºSli˚
->
ùªdmode
[t›_block.
pos_y
 ][t›_block.
pos_x
 ] : -1;

142 
À·I¡øPªdMode
 = (
À·_block
.
avaûabÀ
Ë? 
cuºSli˚
->
ùªdmode
[À·_block.
pos_y
][À·_block.
pos_x
] : -1;

144 
mo°ProbabÀI¡øPªdMode
 = (
upI¡øPªdMode
 < 0 || 
À·I¡øPªdMode
 < 0Ë? 
DC_PRED
 : upIntraPredMode <ÜeftIntraPredMode ? upIntraPredMode :ÜeftIntraPredMode;

146 
dec
 = (
cuºSE
.
vÆue1
 =-1Ë? 
mo°ProbabÀI¡øPªdMode
 : currSE.value1 + (currSE.value1 >= mostProbableIntraPredMode);

150 
cuºSli˚
->
ùªdmode
[
bj
 ][
bi
 ] = (
byã
Ë
dec
;

151 
cuºSli˚
->
ùªdmode
[
bj
 ][
bi
 + 1] = (
byã
Ë
dec
;

152 
cuºSli˚
->
ùªdmode
[
bj
 + 1][
bi
 ] = (
byã
Ë
dec
;

153 
cuºSli˚
->
ùªdmode
[
bj
 + 1][
bi
 + 1] = (
byã
Ë
dec
;

155 
	}
}

164 
	$ªad_ùªd_8x8_modes
(
Ma¸oblock
 *
cuºMB
)

166 
b8
, 
bi
, 
bj
, 
bx
, 
by
, 
dec
;

167 
Sy¡axEÀmít
 
cuºSE
;

168 
D©aP¨tôi⁄
 *
dP
;

169 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

170 c⁄° 
byã
 *
∑πM≠
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
dp_mode
];

171 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

173 
mo°ProbabÀI¡øPªdMode
;

174 
upI¡øPªdMode
;

175 
À·I¡øPªdMode
;

177 
PixñPos
 
À·_mb
, 
t›_mb
;

178 
PixñPos
 
À·_block
, 
t›_block
;

180 
cuºSE
.
ty≥
 = 
SE_INTRAPREDMODE
;

182 
	`TRACE_STRING
("intra4x4_pred_mode");

183 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_INTRAPREDMODE
]]);

185 i‡(!(
p_Vid
->
a˘ive_µs
->
íå›y_codög_mode_Êag
 =(
Boﬁón
Ë
CAVLC
 || 
dP
->
bô°ªam
->
ei_Êag
))

186 
cuºSE
.
ªadög
 = 
ªadI¡øPªdMode_CABAC
;

188 
	`gë4x4Neighbour
(
cuºMB
, -1, 0, 
p_Vid
->
mb_size
[
IS_LUMA
], &
À·_mb
);

189 
	`gë4x4Neighbour
(
cuºMB
, 0, -1, 
p_Vid
->
mb_size
[
IS_LUMA
], &
t›_mb
 );

191 
b8
 = 0; b8 < 4; ++b8)

195 
by
 = (
b8
 & 0x02);

196 
bj
 = 
cuºMB
->
block_y
 + 
by
;

198 
bx
 = ((
b8
 & 0x01) << 1);

199 
bi
 = 
cuºMB
->
block_x
 + 
bx
;

202 i‡(
p_Vid
->
a˘ive_µs
->
íå›y_codög_mode_Êag
 =(
Boﬁón
Ë
CAVLC
 || 
dP
->
bô°ªam
->
ei_Êag
)

203 
	`ªadSy¡axEÀmít_I¡ø4x4Pªdi˘i⁄Mode
(&
cuºSE
, 
dP
->
bô°ªam
);

206 
cuºSE
.
c⁄ãxt
 = (
b8
 << 2);

207 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, &
cuºSE
, dP);

210 
	`gë4x4Neighbour
(
cuºMB
, (
bx
<<2Ë- 1, (
by
<<2), 
p_Vid
->
mb_size
[
IS_LUMA
], &
À·_block
);

211 
	`gë4x4Neighbour
(
cuºMB
, (
bx
<<2), (
by
<<2Ë- 1, 
p_Vid
->
mb_size
[
IS_LUMA
], &
t›_block
 );

215 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

217 
À·_block
.
avaûabÀ
 =Üe·_block.avaûabÀ ? 
cuºSli˚
->
öåa_block
[À·_block.
mb_addr
] : 0;

218 
t›_block
.
avaûabÀ
 =Å›_block.avaûabÀ ? 
cuºSli˚
->
öåa_block
[t›_block.
mb_addr
] : 0;

221 
upI¡øPªdMode
 = (
t›_block
.
avaûabÀ
 ) ? 
cuºSli˚
->
ùªdmode
[t›_block.
pos_y
 ][t›_block.
pos_x
 ] : -1;

222 
À·I¡øPªdMode
 = (
À·_block
.
avaûabÀ
Ë? 
cuºSli˚
->
ùªdmode
[À·_block.
pos_y
][À·_block.
pos_x
] : -1;

224 
mo°ProbabÀI¡øPªdMode
 = (
upI¡øPªdMode
 < 0 || 
À·I¡øPªdMode
 < 0Ë? 
DC_PRED
 : upIntraPredMode <ÜeftIntraPredMode ? upIntraPredMode :ÜeftIntraPredMode;

226 
dec
 = (
cuºSE
.
vÆue1
 =-1Ë? 
mo°ProbabÀI¡øPªdMode
 : currSE.value1 + (currSE.value1 >= mostProbableIntraPredMode);

230 
cuºSli˚
->
ùªdmode
[
bj
 ][
bi
 ] = (
byã
Ë
dec
;

231 
cuºSli˚
->
ùªdmode
[
bj
 ][
bi
 + 1] = (
byã
Ë
dec
;

232 
cuºSli˚
->
ùªdmode
[
bj
 + 1][
bi
 ] = (
byã
Ë
dec
;

233 
cuºSli˚
->
ùªdmode
[
bj
 + 1][
bi
 + 1] = (
byã
Ë
dec
;

235 
	}
}

244 
	$ªad_ùªd_4x4_modes_mbaff
(
Ma¸oblock
 *
cuºMB
)

246 
b8
,
i
,
j
,
bi
,
bj
,
bx
,
by
;

247 
Sy¡axEÀmít
 
cuºSE
;

248 
D©aP¨tôi⁄
 *
dP
;

249 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

250 c⁄° 
byã
 *
∑πM≠
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
dp_mode
];

251 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

252 
BlockPos
 *
PicPos
 = 
p_Vid
->PicPos;

254 
ts
, 
ls
;

255 
mo°ProbabÀI¡øPªdMode
;

256 
upI¡øPªdMode
;

257 
À·I¡øPªdMode
;

259 
PixñPos
 
À·_block
, 
t›_block
;

261 
cuºSE
.
ty≥
 = 
SE_INTRAPREDMODE
;

263 
	`TRACE_STRING
("intra4x4_pred_mode");

264 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_INTRAPREDMODE
]]);

266 i‡(!(
p_Vid
->
a˘ive_µs
->
íå›y_codög_mode_Êag
 =(
Boﬁón
Ë
CAVLC
 || 
dP
->
bô°ªam
->
ei_Êag
))

267 
cuºSE
.
ªadög
 = 
ªadI¡øPªdMode_CABAC
;

269 
b8
 = 0; b8 < 4; ++b8)

271 
j
 = 0; j < 2; j++)

273 
by
 = (
b8
 & 0x02Ë+ 
j
;

274 
bj
 = 
cuºMB
->
block_y
 + 
by
;

276 
i
 = 0; i < 2; i++)

278 
bx
 = ((
b8
 & 1Ë<< 1Ë+ 
i
;

279 
bi
 = 
cuºMB
->
block_x
 + 
bx
;

281 i‡(
p_Vid
->
a˘ive_µs
->
íå›y_codög_mode_Êag
 =(
Boﬁón
Ë
CAVLC
 || 
dP
->
bô°ªam
->
ei_Êag
)

282 
	`ªadSy¡axEÀmít_I¡ø4x4Pªdi˘i⁄Mode
(&
cuºSE
, 
dP
->
bô°ªam
);

285 
cuºSE
.
c⁄ãxt
=(
b8
<<2Ë+ (
j
<<1Ë+
i
;

286 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, &
cuºSE
, dP);

289 
	`gë4x4Neighbour
(
cuºMB
, (
bx
<<2Ë- 1, (
by
<<2), 
p_Vid
->
mb_size
[
IS_LUMA
], &
À·_block
);

290 
	`gë4x4Neighbour
(
cuºMB
, (
bx
<<2), (
by
<<2Ë- 1, 
p_Vid
->
mb_size
[
IS_LUMA
], &
t›_block
 );

294 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

296 
À·_block
.
avaûabÀ
 =Üe·_block.avaûabÀ ? 
cuºSli˚
->
öåa_block
[À·_block.
mb_addr
] : 0;

297 
t›_block
.
avaûabÀ
 =Å›_block.avaûabÀ ? 
cuºSli˚
->
öåa_block
[t›_block.
mb_addr
] : 0;

301 
ts
 = 
ls
 = 0;

302 i‡(
cuºSli˚
->
¶i˚_ty≥
 =
SI_SLICE
)

304 i‡(
À·_block
.
avaûabÀ
)

305 i‡(
cuºSli˚
->
siblock
 [
PicPos
[
À·_block
.
mb_addr
].
y
][PicPos[À·_block.mb_addr].
x
])

306 
ls
=1;

308 i‡(
t›_block
.
avaûabÀ
)

309 i‡(
cuºSli˚
->
siblock
 [
PicPos
[
t›_block
.
mb_addr
].
y
][PicPos[t›_block.mb_addr].
x
])

310 
ts
=1;

313 
upI¡øPªdMode
 = (
t›_block
.
avaûabÀ
 &&(
ts
 =0)Ë? 
cuºSli˚
->
ùªdmode
[t›_block.
pos_y
 ][t›_block.
pos_x
 ] : -1;

314 
À·I¡øPªdMode
 = (
À·_block
.
avaûabÀ
 &&(
ls
 =0)Ë? 
cuºSli˚
->
ùªdmode
[À·_block.
pos_y
][À·_block.
pos_x
] : -1;

316 
mo°ProbabÀI¡øPªdMode
 = (
upI¡øPªdMode
 < 0 || 
À·I¡øPªdMode
 < 0Ë? 
DC_PRED
 : upIntraPredMode <ÜeftIntraPredMode ? upIntraPredMode :ÜeftIntraPredMode;

318 
cuºSli˚
->
ùªdmode
[
bj
][
bi
] = (
byã
Ë((
cuºSE
.
vÆue1
 =-1Ë? 
mo°ProbabÀI¡øPªdMode
 : currSE.value1 + (currSE.value1 >= mostProbableIntraPredMode));

322 
	}
}

332 
	$ªad_ùªd_4x4_modes
(
Ma¸oblock
 *
cuºMB
)

334 
b8
,
i
,
j
,
bi
,
bj
,
bx
,
by
;

335 
Sy¡axEÀmít
 
cuºSE
;

336 
D©aP¨tôi⁄
 *
dP
;

337 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

338 c⁄° 
byã
 *
∑πM≠
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
dp_mode
];

339 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

340 
BlockPos
 *
PicPos
 = 
p_Vid
->PicPos;

342 
ts
, 
ls
;

343 
mo°ProbabÀI¡øPªdMode
;

344 
upI¡øPªdMode
;

345 
À·I¡øPªdMode
;

347 
PixñPos
 
À·_mb
, 
t›_mb
;

348 
PixñPos
 
À·_block
, 
t›_block
;

350 
cuºSE
.
ty≥
 = 
SE_INTRAPREDMODE
;

352 
	`TRACE_STRING
("intra4x4_pred_mode");

353 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_INTRAPREDMODE
]]);

355 i‡(!(
p_Vid
->
a˘ive_µs
->
íå›y_codög_mode_Êag
 =(
Boﬁón
Ë
CAVLC
 || 
dP
->
bô°ªam
->
ei_Êag
))

356 
cuºSE
.
ªadög
 = 
ªadI¡øPªdMode_CABAC
;

358 
	`gë4x4Neighbour
(
cuºMB
, -1, 0, 
p_Vid
->
mb_size
[
IS_LUMA
], &
À·_mb
);

359 
	`gë4x4Neighbour
(
cuºMB
, 0, -1, 
p_Vid
->
mb_size
[
IS_LUMA
], &
t›_mb
 );

361 
b8
 = 0; b8 < 4; ++b8)

363 
j
 = 0; j < 2; j++)

365 
by
 = (
b8
 & 0x02Ë+ 
j
;

366 
bj
 = 
cuºMB
->
block_y
 + 
by
;

368 
i
 = 0; i < 2; i++)

370 
bx
 = ((
b8
 & 1Ë<< 1Ë+ 
i
;

371 
bi
 = 
cuºMB
->
block_x
 + 
bx
;

373 i‡(
p_Vid
->
a˘ive_µs
->
íå›y_codög_mode_Êag
 =(
Boﬁón
Ë
CAVLC
 || 
dP
->
bô°ªam
->
ei_Êag
)

374 
	`ªadSy¡axEÀmít_I¡ø4x4Pªdi˘i⁄Mode
(&
cuºSE
, 
dP
->
bô°ªam
);

377 
cuºSE
.
c⁄ãxt
=(
b8
<<2Ë+ (
j
<<1Ë+
i
;

378 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, &
cuºSE
, dP);

381 
	`gë4x4Neighbour
(
cuºMB
, (
bx
<<2Ë- 1, (
by
<<2), 
p_Vid
->
mb_size
[
IS_LUMA
], &
À·_block
);

382 
	`gë4x4Neighbour
(
cuºMB
, (
bx
<<2), (
by
<<2Ë- 1, 
p_Vid
->
mb_size
[
IS_LUMA
], &
t›_block
 );

386 i‡(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

388 
À·_block
.
avaûabÀ
 =Üe·_block.avaûabÀ ? 
cuºSli˚
->
öåa_block
[À·_block.
mb_addr
] : 0;

389 
t›_block
.
avaûabÀ
 =Å›_block.avaûabÀ ? 
cuºSli˚
->
öåa_block
[t›_block.
mb_addr
] : 0;

393 
ts
 = 
ls
 = 0;

394 i‡(
cuºSli˚
->
¶i˚_ty≥
 =
SI_SLICE
)

396 i‡(
À·_block
.
avaûabÀ
)

397 i‡(
cuºSli˚
->
siblock
 [
PicPos
[
À·_block
.
mb_addr
].
y
][PicPos[À·_block.mb_addr].
x
])

398 
ls
=1;

400 i‡(
t›_block
.
avaûabÀ
)

401 i‡(
cuºSli˚
->
siblock
 [
PicPos
[
t›_block
.
mb_addr
].
y
][PicPos[t›_block.mb_addr].
x
])

402 
ts
=1;

405 
upI¡øPªdMode
 = (
t›_block
.
avaûabÀ
 &&(
ts
 =0)Ë? 
cuºSli˚
->
ùªdmode
[t›_block.
pos_y
 ][t›_block.
pos_x
 ] : -1;

406 
À·I¡øPªdMode
 = (
À·_block
.
avaûabÀ
 &&(
ls
 =0)Ë? 
cuºSli˚
->
ùªdmode
[À·_block.
pos_y
][À·_block.
pos_x
] : -1;

408 
mo°ProbabÀI¡øPªdMode
 = (
upI¡øPªdMode
 < 0 || 
À·I¡øPªdMode
 < 0Ë? 
DC_PRED
 : upIntraPredMode <ÜeftIntraPredMode ? upIntraPredMode :ÜeftIntraPredMode;

410 
cuºSli˚
->
ùªdmode
[
bj
][
bi
] = (
byã
Ë((
cuºSE
.
vÆue1
 =-1Ë? 
mo°ProbabÀI¡øPªdMode
 : currSE.value1 + (currSE.value1 >= mostProbableIntraPredMode));

414 
	}
}

424 
	$ªad_ùªd_modes
(
Ma¸oblock
 *
cuºMB
)

426 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

427 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
cuºSli˚
->dec_picture;

429 i‡(
cuºSli˚
->
mb_aff_‰ame_Êag
)

431 i‡(
cuºMB
->
mb_ty≥
 =
I8MB
)

432 
	`ªad_ùªd_8x8_modes_mbaff
(
cuºMB
);

433 i‡(
cuºMB
->
mb_ty≥
 =
I4MB
)

434 
	`ªad_ùªd_4x4_modes_mbaff
(
cuºMB
);

438 i‡(
cuºMB
->
mb_ty≥
 =
I8MB
)

439 
	`ªad_ùªd_8x8_modes
(
cuºMB
);

440 i‡(
cuºMB
->
mb_ty≥
 =
I4MB
)

441 
	`ªad_ùªd_4x4_modes
(
cuºMB
);

444 i‡((
dec_pi˘uª
->
chroma_f‹m©_idc
 !
YUV400
Ë&& (dec_pi˘uª->chroma_f‹m©_id¯!
YUV444
))

446 
Sy¡axEÀmít
 
cuºSE
;

447 
D©aP¨tôi⁄
 *
dP
;

448 c⁄° 
byã
 *
∑πM≠
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
dp_mode
];

449 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

451 
cuºSE
.
ty≥
 = 
SE_INTRAPREDMODE
;

452 
	`TRACE_STRING
("intra_chroma_pred_mode");

453 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_INTRAPREDMODE
]]);

455 i‡(
p_Vid
->
a˘ive_µs
->
íå›y_codög_mode_Êag
 =(
Boﬁón
Ë
CAVLC
 || 
dP
->
bô°ªam
->
ei_Êag
)

456 
cuºSE
.
m≠pög
 = 
löfo_ue
;

458 
cuºSE
.
ªadög
 = 
ªadCIPªdMode_CABAC
;

460 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, &
cuºSE
, dP);

461 
cuºMB
->
c_ùªd_mode
 = (Ë
cuºSE
.
vÆue1
;

463 i‡(
cuºMB
->
c_ùªd_mode
 < 
DC_PRED_8
 || cuºMB->c_ùªd_modê> 
PLANE_8
)

465 
	`îr‹
("illegal chroma intraÖred mode!\n", 600);

468 
	}
}

471 
ölöe
 
	$ª£t_mbs
(
Ma¸oblock
 *
cuºMB
)

473 
cuºMB
->
¶i˚_ƒ
 = -1;

474 
cuºMB
->
ei_Êag
 = 1;

475 
cuºMB
->
d∂_Êag
 = 0;

476 
	}
}

478 
ölöe
 
	$ª£t_mv_öfo
(
PicMŸi⁄P¨ams
 *
mv_öfo
, 
¶i˚_no
)

480 
mv_öfo
->
ªf_pic
[
LIST_0
] = 
NULL
;

481 
mv_öfo
->
ªf_pic
[
LIST_1
] = 
NULL
;

482 
mv_öfo
->
mv
[
LIST_0
] = 
zîo_mv
;

483 
mv_öfo
->
mv
[
LIST_1
] = 
zîo_mv
;

484 
mv_öfo
->
ªf_idx
[
LIST_0
] = -1;

485 
mv_öfo
->
ªf_idx
[
LIST_1
] = -1;

486 
mv_öfo
->
¶i˚_no
 = slice_no;

487 
	}
}

489 
ölöe
 
	$ª£t_mv_öfo_li°
(
PicMŸi⁄P¨ams
 *
mv_öfo
, 
li°
, 
¶i˚_no
)

491 
mv_öfo
->
ªf_pic
[
li°
] = 
NULL
;

492 
mv_öfo
->
mv
[
li°
] = 
zîo_mv
;

493 
mv_öfo
->
ªf_idx
[
li°
] = -1;

494 
mv_öfo
->
¶i˚_no
 = slice_no;

495 
	}
}

503 
	$öô_ma¸oblock_basic
(
Ma¸oblock
 *
cuºMB
)

505 
j
, 
i
;

506 
PicMŸi⁄P¨ams
 **
mv_öfo
 = &
cuºMB
->
p_Sli˚
->
dec_pi˘uª
->mv_öfo[cuºMB->
block_y
];

507 
¶i˚_no
 = 
cuºMB
->
p_Sli˚
->
cuºít_¶i˚_ƒ
;

509 
j
 = 0; j < 
BLOCK_SIZE
; ++j)

511 
i
 = 
cuºMB
->
block_x
;

512 
	`ª£t_mv_öfo_li°
(*
mv_öfo
 + (
i
++), 
LIST_1
, 
¶i˚_no
);

513 
	`ª£t_mv_öfo_li°
(*
mv_öfo
 + (
i
++), 
LIST_1
, 
¶i˚_no
);

514 
	`ª£t_mv_öfo_li°
(*
mv_öfo
 + (
i
++), 
LIST_1
, 
¶i˚_no
);

515 
	`ª£t_mv_öfo_li°
(*(
mv_öfo
++Ë+ 
i
, 
LIST_1
, 
¶i˚_no
);

517 
	}
}

525 
	$öô_ma¸oblock_dúe˘
(
Ma¸oblock
 *
cuºMB
)

527 
¶i˚_no
 = 
cuºMB
->
p_Sli˚
->
cuºít_¶i˚_ƒ
;

528 
PicMŸi⁄P¨ams
 **
mv_öfo
 = &
cuºMB
->
p_Sli˚
->
dec_pi˘uª
->mv_öfo[cuºMB->
block_y
];

529 
i
, 
j
;

531 
	`£t_ªad_comp_c€ff_ˇbac
(
cuºMB
);

532 
	`£t_ªad_comp_c€ff_ˇvlc
(
cuºMB
);

533 
i
 = 
cuºMB
->
block_x
;

534 
j
 = 0; j < 
BLOCK_SIZE
; ++j)

536 (*
mv_öfo
+
i
)->
¶i˚_no
 = slice_no;

537 (*
mv_öfo
+
i
+1)->
¶i˚_no
 = slice_no;

538 (*
mv_öfo
+
i
+2)->
¶i˚_no
 = slice_no;

539 (*(
mv_öfo
++)+
i
+3)->
¶i˚_no
 = slice_no;

541 
	}
}

550 
	$öô_ma¸oblock
(
Ma¸oblock
 *
cuºMB
)

552 
j
, 
i
;

553 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

554 
PicMŸi⁄P¨ams
 **
mv_öfo
 = &
cuºSli˚
->
dec_pi˘uª
->mv_öfo[
cuºMB
->
block_y
];

555 
¶i˚_no
 = 
cuºSli˚
->
cuºít_¶i˚_ƒ
;

558 
j
 = 0; j < 
BLOCK_SIZE
; ++j)

560 
i
 = 
cuºMB
->
block_x
;

561 
	`ª£t_mv_öfo
(*
mv_öfo
 + (
i
++), 
¶i˚_no
);

562 
	`ª£t_mv_öfo
(*
mv_öfo
 + (
i
++), 
¶i˚_no
);

563 
	`ª£t_mv_öfo
(*
mv_öfo
 + (
i
++), 
¶i˚_no
);

564 
	`ª£t_mv_öfo
(*(
mv_öfo
++Ë+ 
i
, 
¶i˚_no
);

567 
	`£t_ªad_comp_c€ff_ˇbac
(
cuºMB
);

568 
	`£t_ªad_comp_c€ff_ˇvlc
(
cuºMB
);

569 
	}
}

571 
	$c⁄˚ÆIPCMc€ffs
(
Ma¸oblock
 *
cuºMB
)

573 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

574 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

575 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
cuºSli˚
->dec_picture;

576 
i
, 
j
, 
k
;

578 
i
=0;i<
MB_BLOCK_SIZE
;++i)

580 
j
=0;j<
MB_BLOCK_SIZE
;++j)

582 
cuºSli˚
->
cof
[0][
i
][
j
] = 
p_Vid
->
dc_¥ed_vÆue_comp
[0];

587 i‡((
dec_pi˘uª
->
chroma_f‹m©_idc
 !
YUV400
Ë&& (
p_Vid
->
£∑øã_cﬁour_∂™e_Êag
 == 0))

589 
k
 = 0; k < 2; ++k)

591 
i
=0;i<
p_Vid
->
mb_¸_size_y
;++i)

593 
j
=0;j<
p_Vid
->
mb_¸_size_x
;++j)

595 
cuºSli˚
->
cof
[
k
][
i
][
j
] = 
p_Vid
->
dc_¥ed_vÆue_comp
[k];

601 
	}
}

613 
	$öô_decodög_ígöe_IPCM
(
Sli˚
 *
cuºSli˚
)

615 
Bô°ªam
 *
cuºSåóm
;

616 
ByãSèπPosôi⁄
;

617 
P¨tôi⁄Numbî
;

618 
i
;

620 if(
cuºSli˚
->
dp_mode
==
PAR_DP_1
)

621 
P¨tôi⁄Numbî
=1;

622 if(
cuºSli˚
->
dp_mode
==
PAR_DP_3
)

623 
P¨tôi⁄Numbî
=3;

626 
	`¥ötf
("Partition Mode isÇot supported\n");

627 
	`exô
(1);

630 
i
=0;i<
P¨tôi⁄Numbî
;++i)

632 
cuºSåóm
 = 
cuºSli˚
->
∑πAº
[
i
].
bô°ªam
;

633 
ByãSèπPosôi⁄
 = 
cuºSåóm
->
ªad_Àn
;

635 
	`¨ideco_°¨t_decodög
 (&
cuºSli˚
->
∑πAº
[
i
].
de_ˇbac
, 
cuºSåóm
->
°ªamBuf„r
, 
ByãSèπPosôi⁄
, &cuºSåóm->
ªad_Àn
);

637 
	}
}

649 
	$ªad_IPCM_c€ffs_‰om_NAL
(
Sli˚
 *
cuºSli˚
, 
d©≠¨tôi⁄_dec
 *
dP
)

651 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

653 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
cuºSli˚
->dec_picture;

654 
Sy¡axEÀmít
 
cuºSE
;

655 
i
,
j
;

659 if(
p_Vid
->
a˘ive_µs
->
íå›y_codög_mode_Êag
 =(
Boﬁón
Ë
CABAC
)

661 
	`ªadIPCM_CABAC
(
cuºSli˚
, 
dP
);

662 
	`öô_decodög_ígöe_IPCM
(
cuºSli˚
);

668 if(((
dP
->
bô°ªam
->
‰ame_bôoff£t
) & 0x07) != 0)

670 
	`TRACE_STRING
("pcm_alignment_zero_bit");

671 
cuºSE
.
Àn
 = (8 - ((
dP
->
bô°ªam
->
‰ame_bôoff£t
) & 0x07));

672 
	`ªadSy¡axEÀmít_FLC
(&
cuºSE
, 
dP
->
bô°ªam
);

676 
cuºSE
.
Àn
=
p_Vid
->
bôdïth_luma
;

677 
	`TRACE_STRING
("pcm_sample_luma");

679 
i
=0;i<
MB_BLOCK_SIZE
;++i)

681 
j
=0;j<
MB_BLOCK_SIZE
;++j)

683 
	`ªadSy¡axEÀmít_FLC
(&
cuºSE
, 
dP
->
bô°ªam
);

684 
cuºSli˚
->
cof
[0][
i
][
j
] = 
cuºSE
.
vÆue1
;

688 
cuºSE
.
Àn
=
p_Vid
->
bôdïth_chroma
;

689 i‡((
dec_pi˘uª
->
chroma_f‹m©_idc
 !
YUV400
Ë&& (
p_Vid
->
£∑øã_cﬁour_∂™e_Êag
 == 0))

691 
	`TRACE_STRING
("pcm_sample_chroma (u)");

692 
i
=0;i<
p_Vid
->
mb_¸_size_y
;++i)

694 
j
=0;j<
p_Vid
->
mb_¸_size_x
;++j)

696 
	`ªadSy¡axEÀmít_FLC
(&
cuºSE
, 
dP
->
bô°ªam
);

697 
cuºSli˚
->
cof
[1][
i
][
j
] = 
cuºSE
.
vÆue1
;

701 
	`TRACE_STRING
("pcm_sample_chroma (v)");

702 
i
=0;i<
p_Vid
->
mb_¸_size_y
;++i)

704 
j
=0;j<
p_Vid
->
mb_¸_size_x
;++j)

706 
	`ªadSy¡axEÀmít_FLC
(&
cuºSE
, 
dP
->
bô°ªam
);

707 
cuºSli˚
->
cof
[2][
i
][
j
] = 
cuºSE
.
vÆue1
;

713 
	}
}

721 
ölöe
 
	$SëB8Mode
 (
Ma¸oblock
* 
cuºMB
, 
vÆue
, 
i
)

723 
Sli˚
* 
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

724 c⁄° 
p_v2b8
 [ 5] = {4, 5, 6, 7, 
IBLOCK
};

725 c⁄° 
p_v2pd
 [ 5] = {0, 0, 0, 0, -1};

726 c⁄° 
b_v2b8
 [14] = {0, 4, 4, 4, 5, 6, 5, 6, 5, 6, 7, 7, 7, 
IBLOCK
};

727 c⁄° 
b_v2pd
 [14] = {2, 0, 1, 2, 0, 0, 1, 1, 2, 2, 0, 1, 2, -1};

729 i‡(
cuºSli˚
->
¶i˚_ty≥
==
B_SLICE
)

731 
cuºMB
->
b8mode
[
i
] = 
b_v2b8
[
vÆue
];

732 
cuºMB
->
b8pdú
[
i
] = 
b_v2pd
[
vÆue
];

736 
cuºMB
->
b8mode
[
i
] = 
p_v2b8
[
vÆue
];

737 
cuºMB
->
b8pdú
[
i
] = 
p_v2pd
[
vÆue
];

739 
	}
}

741 
ölöe
 
	$ª£t_c€ffs
(
Ma¸oblock
 *
cuºMB
)

743 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

746 i‡(
p_Vid
->
a˘ive_µs
->
íå›y_codög_mode_Êag
 =(
Boﬁón
Ë
CAVLC
)

747 
	`Á°_mem£t
(
p_Vid
->
nz_c€ff
[
cuºMB
->
mbAddrX
][0][0], 0, 3 * 
BLOCK_PIXELS
 * (
byã
));

748 
	}
}

750 
ölöe
 
	$fõld_Êag_ö„ªn˚
(
Ma¸oblock
 *
cuºMB
)

752 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

753 i‡(
cuºMB
->
mbAvaûA
)

755 
cuºMB
->
mb_fõld
 = 
p_Vid
->
mb_d©a
[cuºMB->
mbAddrA
].mb_field;

760 
cuºMB
->
mb_fõld
 = cuºMB->
mbAvaûB
 ? 
p_Vid
->
mb_d©a
[cuºMB->
mbAddrB
].mb_fõld : 
FALSE
;

762 
	}
}

765 
	$skù_ma¸oblock
(
Ma¸oblock
 *
cuºMB
)

767 
MŸi⁄Ve˘‹
 
¥ed_mv
;

768 
zîoMŸi⁄Above
;

769 
zîoMŸi⁄Le·
;

770 
PixñPos
 
mb
[4];

771 
i
, 
j
;

772 
a_mv_y
 = 0;

773 
a_ªf_idx
 = 0;

774 
b_mv_y
 = 0;

775 
b_ªf_idx
 = 0;

776 
img_block_y
 = 
cuºMB
->
block_y
;

777 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

778 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

779 
li°_off£t
 = 
LIST_0
 + 
cuºMB
->list_offset;

780 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
cuºSli˚
->dec_picture;

781 
MŸi⁄Ve˘‹
 *
a_mv
 = 
NULL
;

782 
MŸi⁄Ve˘‹
 *
b_mv
 = 
NULL
;

784 
	`gë_√ighb‹s
(
cuºMB
, 
mb
, 0, 0, 
MB_BLOCK_SIZE
);

785 i‡(
cuºSli˚
->
mb_aff_‰ame_Êag
 == 0)

787 i‡(
mb
[0].
avaûabÀ
)

789 
a_mv
 = &
dec_pi˘uª
->
mv_öfo
[
mb
[0].
pos_y
][mb[0].
pos_x
].
mv
[
LIST_0
];

790 
a_mv_y
 = 
a_mv
->
mv_y
;

791 
a_ªf_idx
 = 
dec_pi˘uª
->
mv_öfo
[
mb
[0].
pos_y
][mb[0].
pos_x
].
ªf_idx
[
LIST_0
];

794 i‡(
mb
[1].
avaûabÀ
)

796 
b_mv
 = &
dec_pi˘uª
->
mv_öfo
[
mb
[1].
pos_y
][mb[1].
pos_x
].
mv
[
LIST_0
];

797 
b_mv_y
 = 
b_mv
->
mv_y
;

798 
b_ªf_idx
 = 
dec_pi˘uª
->
mv_öfo
[
mb
[1].
pos_y
][mb[1].
pos_x
].
ªf_idx
[
LIST_0
];

803 i‡(
mb
[0].
avaûabÀ
)

805 
a_mv
 = &
dec_pi˘uª
->
mv_öfo
[
mb
[0].
pos_y
][mb[0].
pos_x
].
mv
[
LIST_0
];

806 
a_mv_y
 = 
a_mv
->
mv_y
;

807 
a_ªf_idx
 = 
dec_pi˘uª
->
mv_öfo
[
mb
[0].
pos_y
][mb[0].
pos_x
].
ªf_idx
[
LIST_0
];

809 i‡(
cuºMB
->
mb_fõld
 && !
p_Vid
->
mb_d©a
[
mb
[0].
mb_addr
].mb_field)

811 
a_mv_y
 /=2;

812 
a_ªf_idx
 *=2;

814 i‡(!
cuºMB
->
mb_fõld
 && 
p_Vid
->
mb_d©a
[
mb
[0].
mb_addr
].mb_field)

816 
a_mv_y
 *=2;

817 
a_ªf_idx
 >>=1;

821 i‡(
mb
[1].
avaûabÀ
)

823 
b_mv
 = &
dec_pi˘uª
->
mv_öfo
[
mb
[1].
pos_y
][mb[1].
pos_x
].
mv
[
LIST_0
];

824 
b_mv_y
 = 
b_mv
->
mv_y
;

825 
b_ªf_idx
 = 
dec_pi˘uª
->
mv_öfo
[
mb
[1].
pos_y
][mb[1].
pos_x
].
ªf_idx
[
LIST_0
];

827 i‡(
cuºMB
->
mb_fõld
 && !
p_Vid
->
mb_d©a
[
mb
[1].
mb_addr
].mb_field)

829 
b_mv_y
 /=2;

830 
b_ªf_idx
 *=2;

832 i‡(!
cuºMB
->
mb_fõld
 && 
p_Vid
->
mb_d©a
[
mb
[1].
mb_addr
].mb_field)

834 
b_mv_y
 *=2;

835 
b_ªf_idx
 >>=1;

840 
zîoMŸi⁄Le·
 = !
mb
[0].
avaûabÀ
 ? 1 : 
a_ªf_idx
==0 && 
a_mv
->
mv_x
 =0 && 
a_mv_y
==0 ? 1 : 0;

841 
zîoMŸi⁄Above
 = !
mb
[1].
avaûabÀ
 ? 1 : 
b_ªf_idx
==0 && 
b_mv
->
mv_x
 =0 && 
b_mv_y
==0 ? 1 : 0;

843 
cuºMB
->
cbp
 = 0;

844 
	`ª£t_c€ffs
(
cuºMB
);

846 i‡(
zîoMŸi⁄Above
 || 
zîoMŸi⁄Le·
)

848 
PicMŸi⁄P¨ams
 **
dec_mv_öfo
 = &
dec_pi˘uª
->
mv_öfo
[
img_block_y
];

849 
St‹abÀPi˘uª
 *
cur_pic
 = 
cuºSli˚
->
li°X
[
li°_off£t
][0];

850 
PicMŸi⁄P¨ams
 *
mv_öfo
 = 
NULL
;

852 
j
 = 0; j < 
BLOCK_SIZE
; ++j)

854 
i
 = 
cuºMB
->
block_x
; i < cuºMB->block_x + 
BLOCK_SIZE
; ++i)

856 
mv_öfo
 = &
dec_mv_öfo
[
j
][
i
];

857 
mv_öfo
->
ªf_pic
[
LIST_0
] = 
cur_pic
;

858 
mv_öfo
->
mv
 [
LIST_0
] = 
zîo_mv
;

859 
mv_öfo
->
ªf_idx
[
LIST_0
] = 0;

865 
PicMŸi⁄P¨ams
 **
dec_mv_öfo
 = &
dec_pi˘uª
->
mv_öfo
[
img_block_y
];

866 
PicMŸi⁄P¨ams
 *
mv_öfo
 = 
NULL
;

867 
St‹abÀPi˘uª
 *
cur_pic
 = 
cuºSli˚
->
li°X
[
li°_off£t
][0];

868 
cuºMB
->
	`GëMVPªdi˘‹
 (cuºMB, 
mb
, &
¥ed_mv
, 0, 
dec_pi˘uª
->
mv_öfo
, 
LIST_0
, 0, 0, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE);

871 
j
 = 0; j < 
BLOCK_SIZE
; ++j)

873 
i
 = 
cuºMB
->
block_x
; i < cuºMB->block_x + 
BLOCK_SIZE
; ++i)

875 
mv_öfo
 = &
dec_mv_öfo
[
j
][
i
];

876 
mv_öfo
->
ªf_pic
[
LIST_0
] = 
cur_pic
;

877 
mv_öfo
->
mv
 [
LIST_0
] = 
¥ed_mv
;

878 
mv_öfo
->
ªf_idx
[
LIST_0
] = 0;

882 
	}
}

889 
	$ªad_skù_ma¸oblock
(
Ma¸oblock
 *
cuºMB
)

891 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
FALSE
;

893 if(
cuºMB
->
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

895 
mb_ƒ
 = 
cuºMB
->
mbAddrX
;

896 
cuºMB
->
p_Sli˚
->
öåa_block
[
mb_ƒ
] = 0;

900 
	`öô_ma¸oblock_basic
(
cuºMB
);

902 
	`skù_ma¸oblock
(
cuºMB
);

903 
	}
}

911 
	$ªad_öåa_ma¸oblock
(
Ma¸oblock
 *
cuºMB
)

914 
cuºMB
->
NoMbP¨tLessTh™8x8Fœg
 = 
TRUE
;

919 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
FALSE
;

922 
	`öô_ma¸oblock
(
cuºMB
);

925 
	`ªad_ùªd_modes
(
cuºMB
);

928 
cuºMB
->
p_Sli˚
->
	`ªad_CBP_™d_c€ffs_‰om_NAL
 (currMB);

929 
	}
}

938 
	$ªad_öåa4x4_ma¸oblock_ˇvlc
(
Ma¸oblock
 *
cuºMB
, c⁄° 
byã
 *
∑πM≠
)

940 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

944 i‡(
cuºSli˚
->
Tønsf‹m8x8Mode
)

946 
Sy¡axEÀmít
 
cuºSE
;

947 
D©aP¨tôi⁄
 *
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_HEADER
]]);

948 
cuºSE
.
ty≥
 = 
SE_HEADER
;

949 
	`TRACE_STRING
("transform_size_8x8_flag");

952 
cuºSE
.
Àn
 = (
öt64
) 1;

953 
	`ªadSy¡axEÀmít_FLC
(&
cuºSE
, 
dP
->
bô°ªam
);

955 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = (
Boﬁón
Ë
cuºSE
.
vÆue1
;

957 i‡(
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
)

959 
cuºMB
->
mb_ty≥
 = 
I8MB
;

960 
	`mem£t
(&
cuºMB
->
b8mode
, 
I8MB
, 4 * ());

961 
	`mem£t
(&
cuºMB
->
b8pdú
, -1, 4 * ());

966 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
FALSE
;

970 
	`öô_ma¸oblock
(
cuºMB
);

973 
	`ªad_ùªd_modes
(
cuºMB
);

976 
cuºSli˚
->
	`ªad_CBP_™d_c€ffs_‰om_NAL
 (
cuºMB
);

977 
	}
}

985 
	$ªad_öåa4x4_ma¸oblock_ˇbac
(
Ma¸oblock
 *
cuºMB
, c⁄° 
byã
 *
∑πM≠
)

987 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

991 i‡(
cuºSli˚
->
Tønsf‹m8x8Mode
)

993 
Sy¡axEÀmít
 
cuºSE
;

994 
D©aP¨tôi⁄
 *
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_HEADER
]]);

995 
cuºSE
.
ty≥
 = 
SE_HEADER
;

996 
cuºSE
.
ªadög
 = 
ªadMB_å™sf‹m_size_Êag_CABAC
;

997 
	`TRACE_STRING
("transform_size_8x8_flag");

1000 i‡(
dP
->
bô°ªam
->
ei_Êag
)

1002 
cuºSE
.
Àn
 = (
öt64
) 1;

1003 
	`ªadSy¡axEÀmít_FLC
(&
cuºSE
, 
dP
->
bô°ªam
);

1007 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, &
cuºSE
, dP);

1010 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = (
Boﬁón
Ë
cuºSE
.
vÆue1
;

1012 i‡(
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
)

1014 
cuºMB
->
mb_ty≥
 = 
I8MB
;

1015 
	`mem£t
(&
cuºMB
->
b8mode
, 
I8MB
, 4 * ());

1016 
	`mem£t
(&
cuºMB
->
b8pdú
, -1, 4 * ());

1021 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
FALSE
;

1025 
	`öô_ma¸oblock
(
cuºMB
);

1028 
	`ªad_ùªd_modes
(
cuºMB
);

1031 
cuºSli˚
->
	`ªad_CBP_™d_c€ffs_‰om_NAL
 (
cuºMB
);

1032 
	}
}

1042 
	$ªad_öãr_ma¸oblock
(
Ma¸oblock
 *
cuºMB
)

1044 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1046 
cuºMB
->
NoMbP¨tLessTh™8x8Fœg
 = 
TRUE
;

1047 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
FALSE
;

1049 if(
cuºMB
->
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

1051 
mb_ƒ
 = 
cuºMB
->
mbAddrX
;

1052 
cuºSli˚
->
öåa_block
[
mb_ƒ
] = 0;

1056 
	`öô_ma¸oblock
(
cuºMB
);

1059 
cuºSli˚
->
	`ªad_mŸi⁄_öfo_‰om_NAL
 (
cuºMB
);

1061 
cuºSli˚
->
	`ªad_CBP_™d_c€ffs_‰om_NAL
 (
cuºMB
);

1062 
	}
}

1070 
	$ªad_i_pcm_ma¸oblock
(
Ma¸oblock
 *
cuºMB
, c⁄° 
byã
 *
∑πM≠
)

1072 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1073 
cuºMB
->
NoMbP¨tLessTh™8x8Fœg
 = 
TRUE
;

1074 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
FALSE
;

1077 
	`öô_ma¸oblock
(
cuºMB
);

1083 i‡–
cuºSli˚
->
dp_mode
 && cuºSli˚->
dpB_NŸPª£¡
 )

1085 
	`c⁄˚ÆIPCMc€ffs
(
cuºMB
);

1089 
D©aP¨tôi⁄
 *
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_LUM_DC_INTRA
]]);

1090 
	`ªad_IPCM_c€ffs_‰om_NAL
(
cuºSli˚
, 
dP
);

1092 
	}
}

1100 
	$ªad_P8x8_ma¸oblock
(
Ma¸oblock
 *
cuºMB
, 
D©aP¨tôi⁄
 *
dP
, 
Sy¡axEÀmít
 *
cuºSE
)

1102 
i
;

1103 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1105 
cuºMB
->
NoMbP¨tLessTh™8x8Fœg
 = 
TRUE
;

1106 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
FALSE
;

1108 
i
 = 0; i < 4; ++i)

1110 
	`TRACE_STRING_P
("sub_mb_type");

1111 
dP
->
	`ªadSy¡axEÀmít
 (
cuºMB
, 
cuºSE
, dP);

1112 
	`SëB8Mode
 (
cuºMB
, 
cuºSE
->
vÆue1
, 
i
);

1115 
cuºMB
->
NoMbP¨tLessTh™8x8Fœg
 &(cuºMB->
b8mode
[
i
] =0 && 
cuºSli˚
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
) ||

1116 (
cuºMB
->
b8mode
[
i
] == 4);

1120 
	`öô_ma¸oblock
 (
cuºMB
);

1121 
cuºSli˚
->
	`ªad_mŸi⁄_öfo_‰om_NAL
 (
cuºMB
);

1123 if(
cuºMB
->
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

1125 
mb_ƒ
 = 
cuºMB
->
mbAddrX
;

1126 
cuºSli˚
->
öåa_block
[
mb_ƒ
] = 0;

1130 
cuºSli˚
->
	`ªad_CBP_™d_c€ffs_‰om_NAL
 (
cuºMB
);

1131 
	}
}

1139 
	$ªad_⁄e_ma¸oblock_i_¶i˚_ˇvlc
(
Ma¸oblock
 *
cuºMB
)

1141 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1143 
Sy¡axEÀmít
 
cuºSE
;

1144 
mb_ƒ
 = 
cuºMB
->
mbAddrX
;

1146 
D©aP¨tôi⁄
 *
dP
;

1147 c⁄° 
byã
 *
∑πM≠
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
dp_mode
];

1148 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
cuºSli˚
->dec_picture;

1149 
PicMŸi⁄P¨amsOld
 *
mŸi⁄
 = &
dec_pi˘uª
->motion;

1151 
cuºMB
->
mb_fõld
 = ((
mb_ƒ
&0x01Ë=0)? 
FALSE
 : 
cuºSli˚
->
mb_d©a
[mb_nr-1].mb_field;

1153 
	`upd©e_qp
(
cuºMB
, 
cuºSli˚
->
qp
);

1154 
cuºSE
.
ty≥
 = 
SE_MBTYPE
;

1157 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_MBTYPE
]]);

1159 
cuºSE
.
m≠pög
 = 
löfo_ue
;

1162 i‡(
cuºSli˚
->
mb_aff_‰ame_Êag
 && (
mb_ƒ
&0x01)==0)

1164 
	`TRACE_STRING
("mb_field_decoding_flag");

1165 
cuºSE
.
Àn
 = (
öt64
) 1;

1166 
	`ªadSy¡axEÀmít_FLC
(&
cuºSE
, 
dP
->
bô°ªam
);

1167 
cuºMB
->
mb_fõld
 = (
Boﬁón
Ë
cuºSE
.
vÆue1
;

1171 
	`TRACE_STRING
("mb_type");

1172 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, &
cuºSE
, dP);

1174 
cuºMB
->
mb_ty≥
 = (Ë
cuºSE
.
vÆue1
;

1175 if(!
dP
->
bô°ªam
->
ei_Êag
)

1176 
cuºMB
->
ei_Êag
 = 0;

1178 
mŸi⁄
->
mb_fõld
[
mb_ƒ
] = (
byã
Ë
cuºMB
->mb_field;

1180 
cuºMB
->
block_y_aff
 = ((
cuºSli˚
->
mb_aff_‰ame_Êag
Ë&& (cuºMB->
mb_fõld
)Ë? (
mb_ƒ
&0x01Ë? (cuºMB->
block_y
 - 4)>>1 : currMB->block_y >> 1 : currMB->block_y;

1182 
cuºSli˚
->
siblock
[
cuºMB
->
mb
.
y
][cuºMB->mb.
x
] = 0;

1184 
cuºSli˚
->
	`öãΩªt_mb_mode
(
cuºMB
);

1187 
cuºMB
->
NoMbP¨tLessTh™8x8Fœg
 = 
TRUE
;

1189 if(
cuºMB
->
mb_ty≥
 =
IPCM
)

1191 
	`ªad_i_pcm_ma¸oblock
(
cuºMB
, 
∑πM≠
);

1193 i‡(
cuºMB
->
mb_ty≥
 =
I4MB
)

1195 
	`ªad_öåa4x4_ma¸oblock_ˇvlc
(
cuºMB
, 
∑πM≠
);

1199 
	`ªad_öåa_ma¸oblock
(
cuºMB
);

1202 
	}
}

1210 
	$ªad_⁄e_ma¸oblock_i_¶i˚_ˇbac
(
Ma¸oblock
 *
cuºMB
)

1212 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1214 
Sy¡axEÀmít
 
cuºSE
;

1215 
mb_ƒ
 = 
cuºMB
->
mbAddrX
;

1217 
D©aP¨tôi⁄
 *
dP
;

1218 c⁄° 
byã
 *
∑πM≠
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
dp_mode
];

1219 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
cuºSli˚
->dec_picture;

1220 
PicMŸi⁄P¨amsOld
 *
mŸi⁄
 = &
dec_pi˘uª
->motion;

1222 
cuºMB
->
mb_fõld
 = ((
mb_ƒ
&0x01Ë=0)? 
FALSE
 : 
cuºSli˚
->
mb_d©a
[mb_nr-1].mb_field;

1224 
	`upd©e_qp
(
cuºMB
, 
cuºSli˚
->
qp
);

1225 
cuºSE
.
ty≥
 = 
SE_MBTYPE
;

1228 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_MBTYPE
]]);

1230 i‡(
dP
->
bô°ªam
->
ei_Êag
)

1231 
cuºSE
.
m≠pög
 = 
löfo_ue
;

1234 i‡(
cuºSli˚
->
mb_aff_‰ame_Êag
 && (
mb_ƒ
&0x01)==0)

1236 
	`TRACE_STRING
("mb_field_decoding_flag");

1237 i‡(
dP
->
bô°ªam
->
ei_Êag
)

1239 
cuºSE
.
Àn
 = (
öt64
) 1;

1240 
	`ªadSy¡axEÀmít_FLC
(&
cuºSE
, 
dP
->
bô°ªam
);

1244 
cuºSE
.
ªadög
 = 
ªadFõldModeInfo_CABAC
;

1245 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, &
cuºSE
, dP);

1247 
cuºMB
->
mb_fõld
 = (
Boﬁón
Ë
cuºSE
.
vÆue1
;

1250 
	`CheckAvaûabûôyOfNeighb‹sCABAC
(
cuºMB
);

1253 
	`TRACE_STRING
("mb_type");

1254 
cuºSE
.
ªadög
 = 
ªadMB_ty≥Info_CABAC_i_¶i˚
;

1255 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, &
cuºSE
, dP);

1257 
cuºMB
->
mb_ty≥
 = (Ë
cuºSE
.
vÆue1
;

1258 if(!
dP
->
bô°ªam
->
ei_Êag
)

1259 
cuºMB
->
ei_Êag
 = 0;

1261 
mŸi⁄
->
mb_fõld
[
mb_ƒ
] = (
byã
Ë
cuºMB
->mb_field;

1263 
cuºMB
->
block_y_aff
 = ((
cuºSli˚
->
mb_aff_‰ame_Êag
Ë&& (cuºMB->
mb_fõld
)Ë? (
mb_ƒ
&0x01Ë? (cuºMB->
block_y
 - 4)>>1 : currMB->block_y >> 1 : currMB->block_y;

1265 
cuºSli˚
->
siblock
[
cuºMB
->
mb
.
y
][cuºMB->mb.
x
] = 0;

1267 
cuºSli˚
->
	`öãΩªt_mb_mode
(
cuºMB
);

1270 
cuºMB
->
NoMbP¨tLessTh™8x8Fœg
 = 
TRUE
;

1272 if(
cuºMB
->
mb_ty≥
 =
IPCM
)

1274 
	`ªad_i_pcm_ma¸oblock
(
cuºMB
, 
∑πM≠
);

1276 i‡(
cuºMB
->
mb_ty≥
 =
I4MB
)

1281 i‡(
cuºSli˚
->
Tønsf‹m8x8Mode
)

1283 
cuºSE
.
ty≥
 = 
SE_HEADER
;

1284 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_HEADER
]]);

1285 
cuºSE
.
ªadög
 = 
ªadMB_å™sf‹m_size_Êag_CABAC
;

1286 
	`TRACE_STRING
("transform_size_8x8_flag");

1289 i‡(
dP
->
bô°ªam
->
ei_Êag
)

1291 
cuºSE
.
Àn
 = (
öt64
) 1;

1292 
	`ªadSy¡axEÀmít_FLC
(&
cuºSE
, 
dP
->
bô°ªam
);

1296 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, &
cuºSE
, dP);

1299 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = (
Boﬁón
Ë
cuºSE
.
vÆue1
;

1301 i‡(
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
)

1303 
cuºMB
->
mb_ty≥
 = 
I8MB
;

1304 
	`mem£t
(&
cuºMB
->
b8mode
, 
I8MB
, 4 * ());

1305 
	`mem£t
(&
cuºMB
->
b8pdú
, -1, 4 * ());

1310 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
FALSE
;

1314 
	`öô_ma¸oblock
(
cuºMB
);

1317 
	`ªad_ùªd_modes
(
cuºMB
);

1320 
cuºSli˚
->
	`ªad_CBP_™d_c€ffs_‰om_NAL
 (
cuºMB
);

1324 
	`ªad_öåa_ma¸oblock
(
cuºMB
);

1327 
	}
}

1335 
	$ªad_⁄e_ma¸oblock_p_¶i˚_ˇvlc
(
Ma¸oblock
 *
cuºMB
)

1337 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1338 
Sy¡axEÀmít
 
cuºSE
;

1339 
mb_ƒ
 = 
cuºMB
->
mbAddrX
;

1341 
D©aP¨tôi⁄
 *
dP
;

1342 c⁄° 
byã
 *
∑πM≠
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
dp_mode
];

1344 i‡(
cuºSli˚
->
mb_aff_‰ame_Êag
 == 0)

1346 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
cuºSli˚
->dec_picture;

1347 
PicMŸi⁄P¨amsOld
 *
mŸi⁄
 = &
dec_pi˘uª
->motion;

1349 
cuºMB
->
mb_fõld
 = 
FALSE
;

1351 
	`upd©e_qp
(
cuºMB
, 
cuºSli˚
->
qp
);

1352 
cuºSE
.
ty≥
 = 
SE_MBTYPE
;

1355 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_MBTYPE
]]);

1357 
cuºSE
.
m≠pög
 = 
löfo_ue
;

1360 if(
cuºSli˚
->
cod_cou¡î
 == -1)

1362 
	`TRACE_STRING
("mb_skip_run");

1363 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, &
cuºSE
, dP);

1364 
cuºSli˚
->
cod_cou¡î
 = 
cuºSE
.
vÆue1
;

1367 i‡(
cuºSli˚
->
cod_cou¡î
==0)

1370 
	`TRACE_STRING
("mb_type");

1371 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, &
cuºSE
, dP);

1372 ++(
cuºSE
.
vÆue1
);

1373 
cuºMB
->
mb_ty≥
 = (Ë
cuºSE
.
vÆue1
;

1374 if(!
dP
->
bô°ªam
->
ei_Êag
)

1375 
cuºMB
->
ei_Êag
 = 0;

1376 
cuºSli˚
->
cod_cou¡î
--;

1377 
cuºMB
->
skù_Êag
 = 0;

1381 
cuºSli˚
->
cod_cou¡î
--;

1382 
cuºMB
->
mb_ty≥
 = 0;

1383 
cuºMB
->
ei_Êag
 = 0;

1384 
cuºMB
->
skù_Êag
 = 1;

1387 
cuºMB
->
li°_off£t
 = 0;

1389 
mŸi⁄
->
mb_fõld
[
mb_ƒ
] = (
byã
Ë
FALSE
;

1391 
cuºMB
->
block_y_aff
 = cuºMB->
block_y
;

1393 
cuºSli˚
->
siblock
[
cuºMB
->
mb
.
y
][cuºMB->mb.
x
] = 0;

1395 
cuºSli˚
->
	`öãΩªt_mb_mode
(
cuºMB
);

1399 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1401 
Ma¸oblock
 *
t›MB
 = 
NULL
;

1402 
¥evMbSkù≥d
 = 0;

1403 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
cuºSli˚
->dec_picture;

1404 
PicMŸi⁄P¨amsOld
 *
mŸi⁄
 = &
dec_pi˘uª
->motion;

1406 i‡(
mb_ƒ
&0x01)

1408 
t›MB
&
p_Vid
->
mb_d©a
[
mb_ƒ
-1];

1409 
¥evMbSkù≥d
 = (
t›MB
->
mb_ty≥
 == 0);

1412 
¥evMbSkù≥d
 = 0;

1414 
cuºMB
->
mb_fõld
 = ((
mb_ƒ
&0x01Ë=0)? 
FALSE
 : 
p_Vid
->
mb_d©a
[mb_nr-1].mb_field;

1416 
	`upd©e_qp
(
cuºMB
, 
cuºSli˚
->
qp
);

1417 
cuºSE
.
ty≥
 = 
SE_MBTYPE
;

1420 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_MBTYPE
]]);

1422 
cuºSE
.
m≠pög
 = 
löfo_ue
;

1425 if(
cuºSli˚
->
cod_cou¡î
 == -1)

1427 
	`TRACE_STRING
("mb_skip_run");

1428 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, &
cuºSE
, dP);

1429 
cuºSli˚
->
cod_cou¡î
 = 
cuºSE
.
vÆue1
;

1432 i‡(
cuºSli˚
->
cod_cou¡î
==0)

1435 i‡((((
mb_ƒ
&0x01)==0Ë|| ((mb_ƒ&0x01Ë&& 
¥evMbSkù≥d
)))

1437 
	`TRACE_STRING
("mb_field_decoding_flag");

1438 
cuºSE
.
Àn
 = (
öt64
) 1;

1439 
	`ªadSy¡axEÀmít_FLC
(&
cuºSE
, 
dP
->
bô°ªam
);

1440 
cuºMB
->
mb_fõld
 = (
Boﬁón
Ë
cuºSE
.
vÆue1
;

1444 
	`TRACE_STRING
("mb_type");

1445 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, &
cuºSE
, dP);

1446 ++(
cuºSE
.
vÆue1
);

1447 
cuºMB
->
mb_ty≥
 = (Ë
cuºSE
.
vÆue1
;

1448 if(!
dP
->
bô°ªam
->
ei_Êag
)

1449 
cuºMB
->
ei_Êag
 = 0;

1450 
cuºSli˚
->
cod_cou¡î
--;

1451 
cuºMB
->
skù_Êag
 = 0;

1455 
cuºSli˚
->
cod_cou¡î
--;

1456 
cuºMB
->
mb_ty≥
 = 0;

1457 
cuºMB
->
ei_Êag
 = 0;

1458 
cuºMB
->
skù_Êag
 = 1;

1461 if(
cuºSli˚
->
cod_cou¡î
 =0 && ((
mb_ƒ
&0x01) == 0))

1463 
	`TRACE_STRING
("mb_field_decoding_flag (of coded bottom mb)");

1464 
cuºSE
.
Àn
 = (
öt64
) 1;

1465 
	`ªadSy¡axEÀmít_FLC
(&
cuºSE
, 
dP
->
bô°ªam
);

1466 
dP
->
bô°ªam
->
‰ame_bôoff£t
--;

1467 
	`TRACE_DECBITS
(1);

1468 
cuºMB
->
mb_fõld
 = (
Boﬁón
Ë
cuºSE
.
vÆue1
;

1470 i‡(
cuºSli˚
->
cod_cou¡î
 > 0 && ((
mb_ƒ
 & 0x01) == 0))

1473 i‡(
	`mb_is_avaûabÀ
(
mb_ƒ
 - 2, 
cuºMB
Ë&& ((mb_ƒ % (
p_Vid
->
PicWidthInMbs
 * 2))!=0))

1475 
cuºMB
->
mb_fõld
 = 
p_Vid
->
mb_d©a
[
mb_ƒ
-2].mb_field;

1480 i‡(
	`mb_is_avaûabÀ
(
mb_ƒ
 - 2*
p_Vid
->
PicWidthInMbs
, 
cuºMB
))

1482 
cuºMB
->
mb_fõld
 = 
p_Vid
->
mb_d©a
[
mb_ƒ
-2*p_Vid->
PicWidthInMbs
].mb_field;

1485 
cuºMB
->
mb_fõld
 = 
FALSE
;

1490 
cuºMB
->
li°_off£t
 = (cuºMB->
mb_fõld
)? ((
mb_ƒ
&0x01)? 4: 2): 0;

1492 
mŸi⁄
->
mb_fõld
[
mb_ƒ
] = (
byã
Ë
cuºMB
->mb_field;

1494 
cuºMB
->
block_y_aff
 = (cuºMB->
mb_fõld
Ë? (
mb_ƒ
&0x01Ë? (cuºMB->
block_y
 - 4)>>1 : currMB->block_y >> 1 : currMB->block_y;

1496 
cuºSli˚
->
siblock
[
cuºMB
->
mb
.
y
][cuºMB->mb.
x
] = 0;

1498 
cuºSli˚
->
	`öãΩªt_mb_mode
(
cuºMB
);

1500 if(
cuºMB
->
mb_fõld
)

1502 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
] <<=1;

1503 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_1
] <<=1;

1507 
cuºMB
->
NoMbP¨tLessTh™8x8Fœg
 = 
TRUE
;

1509 i‡(
cuºMB
->
mb_ty≥
 =
IPCM
)

1511 
	`ªad_i_pcm_ma¸oblock
(
cuºMB
, 
∑πM≠
);

1513 i‡(
cuºMB
->
mb_ty≥
 =
I4MB
)

1515 
	`ªad_öåa4x4_ma¸oblock_ˇvlc
(
cuºMB
, 
∑πM≠
);

1517 i‡(
cuºMB
->
mb_ty≥
 =
P8x8
)

1519 
cuºSE
.
ty≥
 = 
SE_MBTYPE
;

1520 
cuºSE
.
m≠pög
 = 
löfo_ue
;

1521 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_MBTYPE
]]);

1523 
	`ªad_P8x8_ma¸oblock
(
cuºMB
, 
dP
, &
cuºSE
);

1525 i‡(
cuºMB
->
mb_ty≥
 =
PSKIP
)

1527 
	`ªad_skù_ma¸oblock
(
cuºMB
);

1529 i‡(
cuºMB
->
is_öåa_block
)

1531 
	`ªad_öåa_ma¸oblock
(
cuºMB
);

1535 
	`ªad_öãr_ma¸oblock
(
cuºMB
);

1540 
	}
}

1548 
	$ªad_⁄e_ma¸oblock_p_¶i˚_ˇbac
(
Ma¸oblock
 *
cuºMB
)

1550 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1551 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1552 
mb_ƒ
 = 
cuºMB
->
mbAddrX
;

1553 
Sy¡axEÀmít
 
cuºSE
;

1554 
D©aP¨tôi⁄
 *
dP
;

1555 c⁄° 
byã
 *
∑πM≠
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
dp_mode
];

1557 i‡(
cuºSli˚
->
mb_aff_‰ame_Êag
 == 0)

1559 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
cuºSli˚
->dec_picture;

1560 
PicMŸi⁄P¨amsOld
 *
mŸi⁄
 = &
dec_pi˘uª
->motion;

1562 
cuºMB
->
mb_fõld
 = 
FALSE
;

1564 
	`upd©e_qp
(
cuºMB
, 
cuºSli˚
->
qp
);

1565 
cuºSE
.
ty≥
 = 
SE_MBTYPE
;

1568 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_MBTYPE
]]);

1570 i‡(
dP
->
bô°ªam
->
ei_Êag
)

1571 
cuºSE
.
m≠pög
 = 
löfo_ue
;

1573 
	`CheckAvaûabûôyOfNeighb‹sCABAC
(
cuºMB
);

1574 
	`TRACE_STRING
("mb_skip_flag");

1575 
cuºSE
.
ªadög
 = 
ªad_skù_Êag_CABAC_p_¶i˚
;

1576 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, &
cuºSE
, dP);

1578 
cuºMB
->
mb_ty≥
 = (Ë
cuºSE
.
vÆue1
;

1579 
cuºMB
->
skù_Êag
 = (Ë(!(
cuºSE
.
vÆue1
));

1581 i‡(!
dP
->
bô°ªam
->
ei_Êag
)

1582 
cuºMB
->
ei_Êag
 = 0;

1585 i‡(
cuºMB
->
mb_ty≥
 != 0 )

1587 
cuºSE
.
ªadög
 = 
ªadMB_ty≥Info_CABAC_p_¶i˚
;

1588 
	`TRACE_STRING
("mb_type");

1589 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, &
cuºSE
, dP);

1590 
cuºMB
->
mb_ty≥
 = (Ë
cuºSE
.
vÆue1
;

1591 if(!
dP
->
bô°ªam
->
ei_Êag
)

1592 
cuºMB
->
ei_Êag
 = 0;

1595 
mŸi⁄
->
mb_fõld
[
mb_ƒ
] = (
byã
Ë
FALSE
;

1596 
cuºMB
->
block_y_aff
 = cuºMB->
block_y
;

1597 
cuºSli˚
->
siblock
[
cuºMB
->
mb
.
y
][cuºMB->mb.
x
] = 0;

1598 
cuºSli˚
->
	`öãΩªt_mb_mode
(
cuºMB
);

1602 
Ma¸oblock
 *
t›MB
 = 
NULL
;

1603 
¥evMbSkù≥d
 = 0;

1604 
check_bŸtom
, 
ªad_bŸtom
, 
ªad_t›
;

1605 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
cuºSli˚
->dec_picture;

1606 
PicMŸi⁄P¨amsOld
 *
mŸi⁄
 = &
dec_pi˘uª
->motion;

1607 i‡(
mb_ƒ
&0x01)

1609 
t›MB
&
p_Vid
->
mb_d©a
[
mb_ƒ
-1];

1610 
¥evMbSkù≥d
 = (
t›MB
->
mb_ty≥
 == 0);

1613 
¥evMbSkù≥d
 = 0;

1615 
cuºMB
->
mb_fõld
 = ((
mb_ƒ
&0x01Ë=0)? 
FALSE
 : 
p_Vid
->
mb_d©a
[mb_nr-1].mb_field;

1617 
	`upd©e_qp
(
cuºMB
, 
cuºSli˚
->
qp
);

1618 
cuºSE
.
ty≥
 = 
SE_MBTYPE
;

1621 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_MBTYPE
]]);

1623 i‡(
dP
->
bô°ªam
->
ei_Êag
)

1624 
cuºSE
.
m≠pög
 = 
löfo_ue
;

1627 i‡(((
mb_ƒ
&0x01Ë=0||
¥evMbSkù≥d
))

1628 
	`fõld_Êag_ö„ªn˚
(
cuºMB
);

1630 
	`CheckAvaûabûôyOfNeighb‹sCABAC
(
cuºMB
);

1631 
	`TRACE_STRING
("mb_skip_flag");

1632 
cuºSE
.
ªadög
 = 
ªad_skù_Êag_CABAC_p_¶i˚
;

1633 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, &
cuºSE
, dP);

1635 
cuºMB
->
mb_ty≥
 = (Ë
cuºSE
.
vÆue1
;

1636 
cuºMB
->
skù_Êag
 = (Ë(!(
cuºSE
.
vÆue1
));

1638 i‡(!
dP
->
bô°ªam
->
ei_Êag
)

1639 
cuºMB
->
ei_Êag
 = 0;

1642 
check_bŸtom
=
ªad_bŸtom
=
ªad_t›
=0;

1643 i‡((
mb_ƒ
&0x01)==0)

1645 
check_bŸtom
 = 
cuºMB
->
skù_Êag
;

1646 
ªad_t›
 = !
check_bŸtom
;

1650 
ªad_bŸtom
 = (
t›MB
->
skù_Êag
 && (!
cuºMB
->skip_flag));

1653 i‡(
ªad_bŸtom
 || 
ªad_t›
)

1655 
	`TRACE_STRING
("mb_field_decoding_flag");

1656 
cuºSE
.
ªadög
 = 
ªadFõldModeInfo_CABAC
;

1657 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, &
cuºSE
, dP);

1658 
cuºMB
->
mb_fõld
 = (
Boﬁón
Ë
cuºSE
.
vÆue1
;

1661 i‡(
check_bŸtom
)

1662 
	`check_√xt_mb_™d_gë_fõld_mode_CABAC_p_¶i˚
(
cuºSli˚
, &
cuºSE
, 
dP
);

1665 
cuºMB
->
li°_off£t
 = (cuºMB->
mb_fõld
)? ((
mb_ƒ
&0x01)? 4: 2): 0;

1668 
	`CheckAvaûabûôyOfNeighb‹sCABAC
(
cuºMB
);

1671 i‡(
cuºMB
->
mb_ty≥
 != 0 )

1673 
cuºSE
.
ªadög
 = 
ªadMB_ty≥Info_CABAC_p_¶i˚
;

1674 
	`TRACE_STRING
("mb_type");

1675 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, &
cuºSE
, dP);

1676 
cuºMB
->
mb_ty≥
 = (Ë
cuºSE
.
vÆue1
;

1677 if(!
dP
->
bô°ªam
->
ei_Êag
)

1678 
cuºMB
->
ei_Êag
 = 0;

1681 
mŸi⁄
->
mb_fõld
[
mb_ƒ
] = (
byã
Ë
cuºMB
->mb_field;

1683 
cuºMB
->
block_y_aff
 = (cuºMB->
mb_fõld
Ë? (
mb_ƒ
&0x01Ë? (cuºMB->
block_y
 - 4)>>1 : currMB->block_y >> 1 : currMB->block_y;

1685 
cuºSli˚
->
siblock
[
cuºMB
->
mb
.
y
][cuºMB->mb.
x
] = 0;

1687 
cuºSli˚
->
	`öãΩªt_mb_mode
(
cuºMB
);

1689 if(
cuºMB
->
mb_fõld
)

1691 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
] <<=1;

1692 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_1
] <<=1;

1696 
cuºMB
->
NoMbP¨tLessTh™8x8Fœg
 = 
TRUE
;

1698 i‡(
cuºMB
->
mb_ty≥
 =
IPCM
)

1700 
	`ªad_i_pcm_ma¸oblock
(
cuºMB
, 
∑πM≠
);

1702 i‡(
cuºMB
->
mb_ty≥
 =
I4MB
)

1704 
	`ªad_öåa4x4_ma¸oblock_ˇbac
(
cuºMB
, 
∑πM≠
);

1706 i‡(
cuºMB
->
mb_ty≥
 =
P8x8
)

1708 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_MBTYPE
]]);

1709 
cuºSE
.
ty≥
 = 
SE_MBTYPE
;

1711 i‡(
dP
->
bô°ªam
->
ei_Êag
)

1712 
cuºSE
.
m≠pög
 = 
löfo_ue
;

1714 
cuºSE
.
ªadög
 = 
ªadB8_ty≥Info_CABAC_p_¶i˚
;

1716 
	`ªad_P8x8_ma¸oblock
(
cuºMB
, 
dP
, &
cuºSE
);

1718 i‡(
cuºMB
->
mb_ty≥
 =
PSKIP
)

1720 
	`ªad_skù_ma¸oblock
 (
cuºMB
);

1722 i‡(
cuºMB
->
is_öåa_block
 =
TRUE
)

1724 
	`ªad_öåa_ma¸oblock
(
cuºMB
);

1728 
	`ªad_öãr_ma¸oblock
(
cuºMB
);

1732 
	}
}

1740 
	$ªad_⁄e_ma¸oblock_b_¶i˚_ˇvlc
(
Ma¸oblock
 *
cuºMB
)

1742 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1743 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1744 
mb_ƒ
 = 
cuºMB
->
mbAddrX
;

1745 
D©aP¨tôi⁄
 *
dP
;

1746 
Sy¡axEÀmít
 
cuºSE
;

1747 c⁄° 
byã
 *
∑πM≠
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
dp_mode
];

1749 i‡(
cuºSli˚
->
mb_aff_‰ame_Êag
 == 0)

1751 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
cuºSli˚
->dec_picture;

1752 
PicMŸi⁄P¨amsOld
 *
mŸi⁄
 = &
dec_pi˘uª
->motion;

1754 
cuºMB
->
mb_fõld
 = 
FALSE
;

1756 
	`upd©e_qp
(
cuºMB
, 
cuºSli˚
->
qp
);

1757 
cuºSE
.
ty≥
 = 
SE_MBTYPE
;

1760 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_MBTYPE
]]);

1762 
cuºSE
.
m≠pög
 = 
löfo_ue
;

1764 if(
cuºSli˚
->
cod_cou¡î
 == -1)

1766 
	`TRACE_STRING
("mb_skip_run");

1767 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, &
cuºSE
, dP);

1768 
cuºSli˚
->
cod_cou¡î
 = 
cuºSE
.
vÆue1
;

1770 i‡(
cuºSli˚
->
cod_cou¡î
==0)

1773 
	`TRACE_STRING
("mb_type");

1774 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, &
cuºSE
, dP);

1775 
cuºMB
->
mb_ty≥
 = (Ë
cuºSE
.
vÆue1
;

1776 if(!
dP
->
bô°ªam
->
ei_Êag
)

1777 
cuºMB
->
ei_Êag
 = 0;

1778 
cuºSli˚
->
cod_cou¡î
--;

1779 
cuºMB
->
skù_Êag
 = 0;

1783 
cuºSli˚
->
cod_cou¡î
--;

1784 
cuºMB
->
mb_ty≥
 = 0;

1785 
cuºMB
->
ei_Êag
 = 0;

1786 
cuºMB
->
skù_Êag
 = 1;

1790 
cuºMB
->
li°_off£t
 = 0;

1792 
mŸi⁄
->
mb_fõld
[
mb_ƒ
] = 
FALSE
;

1793 
cuºMB
->
block_y_aff
 = cuºMB->
block_y
;

1794 
cuºSli˚
->
siblock
[
cuºMB
->
mb
.
y
][cuºMB->mb.
x
] = 0;

1796 
cuºSli˚
->
	`öãΩªt_mb_mode
(
cuºMB
);

1800 
Ma¸oblock
 *
t›MB
 = 
NULL
;

1801 
¥evMbSkù≥d
 = 0;

1802 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
cuºSli˚
->dec_picture;

1803 
PicMŸi⁄P¨amsOld
 *
mŸi⁄
 = &
dec_pi˘uª
->motion;

1805 i‡(
mb_ƒ
&0x01)

1807 
t›MB
&
p_Vid
->
mb_d©a
[
mb_ƒ
-1];

1808 
¥evMbSkù≥d
 = 
t›MB
->
skù_Êag
;

1811 
¥evMbSkù≥d
 = 0;

1813 
cuºMB
->
mb_fõld
 = ((
mb_ƒ
&0x01Ë=0)? 
FALSE
 : 
p_Vid
->
mb_d©a
[mb_nr-1].mb_field;

1815 
	`upd©e_qp
(
cuºMB
, 
cuºSli˚
->
qp
);

1816 
cuºSE
.
ty≥
 = 
SE_MBTYPE
;

1819 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_MBTYPE
]]);

1821 
cuºSE
.
m≠pög
 = 
löfo_ue
;

1823 if(
cuºSli˚
->
cod_cou¡î
 == -1)

1825 
	`TRACE_STRING
("mb_skip_run");

1826 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, &
cuºSE
, dP);

1827 
cuºSli˚
->
cod_cou¡î
 = 
cuºSE
.
vÆue1
;

1829 i‡(
cuºSli˚
->
cod_cou¡î
==0)

1832 i‡((((
mb_ƒ
&0x01)==0Ë|| ((mb_ƒ&0x01Ë&& 
¥evMbSkù≥d
)))

1834 
	`TRACE_STRING
("mb_field_decoding_flag");

1835 
cuºSE
.
Àn
 = (
öt64
) 1;

1836 
	`ªadSy¡axEÀmít_FLC
(&
cuºSE
, 
dP
->
bô°ªam
);

1837 
cuºMB
->
mb_fõld
 = (
Boﬁón
Ë
cuºSE
.
vÆue1
;

1841 
	`TRACE_STRING
("mb_type");

1842 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, &
cuºSE
, dP);

1843 
cuºMB
->
mb_ty≥
 = (Ë
cuºSE
.
vÆue1
;

1844 if(!
dP
->
bô°ªam
->
ei_Êag
)

1845 
cuºMB
->
ei_Êag
 = 0;

1846 
cuºSli˚
->
cod_cou¡î
--;

1847 
cuºMB
->
skù_Êag
 = 0;

1851 
cuºSli˚
->
cod_cou¡î
--;

1852 
cuºMB
->
mb_ty≥
 = 0;

1853 
cuºMB
->
ei_Êag
 = 0;

1854 
cuºMB
->
skù_Êag
 = 1;

1857 if(
cuºSli˚
->
cod_cou¡î
 =0 && ((
mb_ƒ
&0x01) == 0))

1859 
	`TRACE_STRING
("mb_field_decoding_flag (of coded bottom mb)");

1860 
cuºSE
.
Àn
 = (
öt64
) 1;

1861 
	`ªadSy¡axEÀmít_FLC
(&
cuºSE
, 
dP
->
bô°ªam
);

1862 
dP
->
bô°ªam
->
‰ame_bôoff£t
--;

1863 
	`TRACE_DECBITS
(1);

1864 
cuºMB
->
mb_fõld
 = (
Boﬁón
Ë
cuºSE
.
vÆue1
;

1866 i‡(
cuºSli˚
->
cod_cou¡î
 > 0 && ((
mb_ƒ
 & 0x01) == 0))

1869 i‡(
	`mb_is_avaûabÀ
(
mb_ƒ
 - 2, 
cuºMB
Ë&& ((mb_ƒ % (
p_Vid
->
PicWidthInMbs
 * 2))!=0))

1871 
cuºMB
->
mb_fõld
 = 
p_Vid
->
mb_d©a
[
mb_ƒ
-2].mb_field;

1876 i‡(
	`mb_is_avaûabÀ
(
mb_ƒ
 - 2*
p_Vid
->
PicWidthInMbs
, 
cuºMB
))

1878 
cuºMB
->
mb_fõld
 = 
p_Vid
->
mb_d©a
[
mb_ƒ
-2*p_Vid->
PicWidthInMbs
].mb_field;

1881 
cuºMB
->
mb_fõld
 = 
FALSE
;

1886 
cuºMB
->
li°_off£t
 = (cuºMB->
mb_fõld
)? ((
mb_ƒ
&0x01)? 4: 2): 0;

1888 
mŸi⁄
->
mb_fõld
[
mb_ƒ
] = (
byã
Ë
cuºMB
->mb_field;

1890 
cuºMB
->
block_y_aff
 = (cuºMB->
mb_fõld
Ë? (
mb_ƒ
&0x01Ë? (cuºMB->
block_y
 - 4)>>1 : currMB->block_y >> 1 : currMB->block_y;

1892 
cuºSli˚
->
siblock
[
cuºMB
->
mb
.
y
][cuºMB->mb.
x
] = 0;

1894 
cuºSli˚
->
	`öãΩªt_mb_mode
(
cuºMB
);

1896 if(
cuºSli˚
->
mb_aff_‰ame_Êag
)

1898 if(
cuºMB
->
mb_fõld
)

1900 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
] <<=1;

1901 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_1
] <<=1;

1906 i‡(
cuºMB
->
mb_ty≥
 =
IPCM
)

1908 
	`ªad_i_pcm_ma¸oblock
(
cuºMB
, 
∑πM≠
);

1910 i‡(
cuºMB
->
mb_ty≥
 =
I4MB
)

1912 
	`ªad_öåa4x4_ma¸oblock_ˇvlc
(
cuºMB
, 
∑πM≠
);

1914 i‡(
cuºMB
->
mb_ty≥
 =
P8x8
)

1916 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_MBTYPE
]]);

1917 
cuºSE
.
ty≥
 = 
SE_MBTYPE
;

1918 
cuºSE
.
m≠pög
 = 
löfo_ue
;

1920 
	`ªad_P8x8_ma¸oblock
(
cuºMB
, 
dP
, &
cuºSE
);

1922 i‡(
cuºMB
->
mb_ty≥
 =
BSKIP_DIRECT
)

1925 
cuºMB
->
NoMbP¨tLessTh™8x8Fœg
 = (!(
cuºSli˚
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
))? 
FALSE
: 
TRUE
;

1927 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
FALSE
;

1929 if(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

1931 
cuºSli˚
->
öåa_block
[
mb_ƒ
] = 0;

1935 
	`öô_ma¸oblock_dúe˘
(
cuºMB
);

1937 i‡(
cuºSli˚
->
cod_cou¡î
 >= 0)

1939 
cuºMB
->
cbp
 = 0;

1940 
	`ª£t_c€ffs
(
cuºMB
);

1945 
cuºSli˚
->
	`ªad_CBP_™d_c€ffs_‰om_NAL
 (
cuºMB
);

1948 i‡(
cuºMB
->
is_öåa_block
 =
TRUE
)

1950 
	`ªad_öåa_ma¸oblock
(
cuºMB
);

1954 
	`ªad_öãr_ma¸oblock
(
cuºMB
);

1958 
	}
}

1966 
	$ªad_⁄e_ma¸oblock_b_¶i˚_ˇbac
(
Ma¸oblock
 *
cuºMB
)

1968 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1969 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1970 
mb_ƒ
 = 
cuºMB
->
mbAddrX
;

1971 
Sy¡axEÀmít
 
cuºSE
;

1973 
D©aP¨tôi⁄
 *
dP
;

1974 c⁄° 
byã
 *
∑πM≠
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
dp_mode
];

1976 i‡(
cuºSli˚
->
mb_aff_‰ame_Êag
 == 0)

1978 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
cuºSli˚
->dec_picture;

1979 
PicMŸi⁄P¨amsOld
 *
mŸi⁄
 = &
dec_pi˘uª
->motion;

1981 
cuºMB
->
mb_fõld
 = 
FALSE
;

1983 
	`upd©e_qp
(
cuºMB
, 
cuºSli˚
->
qp
);

1984 
cuºSE
.
ty≥
 = 
SE_MBTYPE
;

1987 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_MBTYPE
]]);

1989 i‡(
dP
->
bô°ªam
->
ei_Êag
)

1990 
cuºSE
.
m≠pög
 = 
löfo_ue
;

1992 
	`CheckAvaûabûôyOfNeighb‹sCABAC
(
cuºMB
);

1993 
	`TRACE_STRING
("mb_skip_flag");

1994 
cuºSE
.
ªadög
 = 
ªad_skù_Êag_CABAC_b_¶i˚
;

1995 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, &
cuºSE
, dP);

1997 
cuºMB
->
mb_ty≥
 = (Ë
cuºSE
.
vÆue1
;

1998 
cuºMB
->
skù_Êag
 = (Ë(!(
cuºSE
.
vÆue1
));

2000 
cuºMB
->
cbp
 = 
cuºSE
.
vÆue2
;

2002 i‡(!
dP
->
bô°ªam
->
ei_Êag
)

2003 
cuºMB
->
ei_Êag
 = 0;

2005 i‡(
cuºSE
.
vÆue1
 =0 && cuºSE.
vÆue2
 == 0)

2006 
cuºSli˚
->
cod_cou¡î
=0;

2009 i‡(
cuºMB
->
mb_ty≥
 != 0 )

2011 
cuºSE
.
ªadög
 = 
ªadMB_ty≥Info_CABAC_b_¶i˚
;

2012 
	`TRACE_STRING
("mb_type");

2013 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, &
cuºSE
, dP);

2014 
cuºMB
->
mb_ty≥
 = (Ë
cuºSE
.
vÆue1
;

2015 if(!
dP
->
bô°ªam
->
ei_Êag
)

2016 
cuºMB
->
ei_Êag
 = 0;

2019 
mŸi⁄
->
mb_fõld
[
mb_ƒ
] = (
byã
Ë
FALSE
;

2020 
cuºMB
->
block_y_aff
 = cuºMB->
block_y
;

2021 
cuºSli˚
->
siblock
[
cuºMB
->
mb
.
y
][cuºMB->mb.
x
] = 0;

2022 
cuºSli˚
->
	`öãΩªt_mb_mode
(
cuºMB
);

2026 
Ma¸oblock
 *
t›MB
 = 
NULL
;

2027 
¥evMbSkù≥d
 = 0;

2028 
check_bŸtom
, 
ªad_bŸtom
, 
ªad_t›
;

2029 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
cuºSli˚
->dec_picture;

2030 
PicMŸi⁄P¨amsOld
 *
mŸi⁄
 = &
dec_pi˘uª
->motion;

2032 i‡(
mb_ƒ
&0x01)

2034 
t›MB
&
p_Vid
->
mb_d©a
[
mb_ƒ
-1];

2035 
¥evMbSkù≥d
 = 
t›MB
->
skù_Êag
;

2038 
¥evMbSkù≥d
 = 0;

2040 
cuºMB
->
mb_fõld
 = ((
mb_ƒ
&0x01Ë=0)? 
FALSE
 : 
p_Vid
->
mb_d©a
[mb_nr-1].mb_field;

2042 
	`upd©e_qp
(
cuºMB
, 
cuºSli˚
->
qp
);

2043 
cuºSE
.
ty≥
 = 
SE_MBTYPE
;

2046 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_MBTYPE
]]);

2048 i‡(
dP
->
bô°ªam
->
ei_Êag
)

2049 
cuºSE
.
m≠pög
 = 
löfo_ue
;

2052 i‡(((
mb_ƒ
&0x01Ë=0||
¥evMbSkù≥d
))

2053 
	`fõld_Êag_ö„ªn˚
(
cuºMB
);

2055 
	`CheckAvaûabûôyOfNeighb‹sCABAC
(
cuºMB
);

2056 
	`TRACE_STRING
("mb_skip_flag");

2057 
cuºSE
.
ªadög
 = 
ªad_skù_Êag_CABAC_b_¶i˚
;

2058 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, &
cuºSE
, dP);

2060 
cuºMB
->
mb_ty≥
 = (Ë
cuºSE
.
vÆue1
;

2061 
cuºMB
->
skù_Êag
 = (Ë(!(
cuºSE
.
vÆue1
));

2063 
cuºMB
->
cbp
 = 
cuºSE
.
vÆue2
;

2065 i‡(!
dP
->
bô°ªam
->
ei_Êag
)

2066 
cuºMB
->
ei_Êag
 = 0;

2068 i‡(
cuºSE
.
vÆue1
 =0 && cuºSE.
vÆue2
 == 0)

2069 
cuºSli˚
->
cod_cou¡î
=0;

2072 
check_bŸtom
=
ªad_bŸtom
=
ªad_t›
=0;

2073 i‡((
mb_ƒ
 & 0x01) == 0)

2075 
check_bŸtom
 = 
cuºMB
->
skù_Êag
;

2076 
ªad_t›
 = !
check_bŸtom
;

2080 
ªad_bŸtom
 = (
t›MB
->
skù_Êag
 && (!
cuºMB
->skip_flag));

2083 i‡(
ªad_bŸtom
 || 
ªad_t›
)

2085 
	`TRACE_STRING
("mb_field_decoding_flag");

2086 
cuºSE
.
ªadög
 = 
ªadFõldModeInfo_CABAC
;

2087 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, &
cuºSE
, dP);

2088 
cuºMB
->
mb_fõld
 = (
Boﬁón
Ë
cuºSE
.
vÆue1
;

2090 i‡(
check_bŸtom
)

2091 
	`check_√xt_mb_™d_gë_fõld_mode_CABAC_b_¶i˚
(
cuºSli˚
, &
cuºSE
, 
dP
);

2094 
cuºMB
->
li°_off£t
 = (cuºMB->
mb_fõld
)? ((
mb_ƒ
&0x01)? 4: 2): 0;

2096 
	`CheckAvaûabûôyOfNeighb‹sCABAC
(
cuºMB
);

2099 i‡(
cuºMB
->
mb_ty≥
 != 0 )

2101 
cuºSE
.
ªadög
 = 
ªadMB_ty≥Info_CABAC_b_¶i˚
;

2102 
	`TRACE_STRING
("mb_type");

2103 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, &
cuºSE
, dP);

2104 
cuºMB
->
mb_ty≥
 = (Ë
cuºSE
.
vÆue1
;

2105 if(!
dP
->
bô°ªam
->
ei_Êag
)

2106 
cuºMB
->
ei_Êag
 = 0;

2110 
mŸi⁄
->
mb_fõld
[
mb_ƒ
] = (
byã
Ë
cuºMB
->mb_field;

2112 
cuºMB
->
block_y_aff
 = (cuºMB->
mb_fõld
Ë? (
mb_ƒ
&0x01Ë? (cuºMB->
block_y
 - 4)>>1 : currMB->block_y >> 1 : currMB->block_y;

2114 
cuºSli˚
->
siblock
[
cuºMB
->
mb
.
y
][cuºMB->mb.
x
] = 0;

2116 
cuºSli˚
->
	`öãΩªt_mb_mode
(
cuºMB
);

2118 if(
cuºMB
->
mb_fõld
)

2120 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
] <<=1;

2121 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_1
] <<=1;

2125 if(
cuºMB
->
mb_ty≥
 =
IPCM
)

2127 
	`ªad_i_pcm_ma¸oblock
(
cuºMB
, 
∑πM≠
);

2129 i‡(
cuºMB
->
mb_ty≥
 =
I4MB
)

2131 
	`ªad_öåa4x4_ma¸oblock_ˇbac
(
cuºMB
, 
∑πM≠
);

2133 i‡(
cuºMB
->
mb_ty≥
 =
P8x8
)

2135 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_MBTYPE
]]);

2136 
cuºSE
.
ty≥
 = 
SE_MBTYPE
;

2138 i‡(
dP
->
bô°ªam
->
ei_Êag
)

2139 
cuºSE
.
m≠pög
 = 
löfo_ue
;

2141 
cuºSE
.
ªadög
 = 
ªadB8_ty≥Info_CABAC_b_¶i˚
;

2143 
	`ªad_P8x8_ma¸oblock
(
cuºMB
, 
dP
, &
cuºSE
);

2145 i‡(
cuºMB
->
mb_ty≥
 =
BSKIP_DIRECT
)

2148 
cuºMB
->
NoMbP¨tLessTh™8x8Fœg
 = (!(
cuºSli˚
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
))? 
FALSE
: 
TRUE
;

2153 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
FALSE
;

2155 if(
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
)

2157 
cuºSli˚
->
öåa_block
[
mb_ƒ
] = 0;

2161 
	`öô_ma¸oblock_dúe˘
(
cuºMB
);

2163 i‡(
cuºSli˚
->
cod_cou¡î
 >= 0)

2165 
cuºSli˚
->
is_ª£t_c€ff
 = 
TRUE
;

2166 
cuºMB
->
cbp
 = 0;

2167 
cuºSli˚
->
cod_cou¡î
 = -1;

2172 
cuºSli˚
->
	`ªad_CBP_™d_c€ffs_‰om_NAL
 (
cuºMB
);

2175 i‡(
cuºMB
->
is_öåa_block
 =
TRUE
)

2177 
	`ªad_öåa_ma¸oblock
(
cuºMB
);

2181 
	`ªad_öãr_ma¸oblock
(
cuºMB
);

2185 
	}
}

2188 
	$£tup_ªad_ma¸oblock
(
Sli˚
 *
cuºSli˚
)

2190 i‡(
cuºSli˚
->
p_Vid
->
a˘ive_µs
->
íå›y_codög_mode_Êag
 =(
Boﬁón
Ë
CABAC
)

2192 
cuºSli˚
->
¶i˚_ty≥
)

2194 
P_SLICE
:

2195 
SP_SLICE
:

2196 
cuºSli˚
->
ªad_⁄e_ma¸oblock
 = 
ªad_⁄e_ma¸oblock_p_¶i˚_ˇbac
;

2198 
B_SLICE
:

2199 
cuºSli˚
->
ªad_⁄e_ma¸oblock
 = 
ªad_⁄e_ma¸oblock_b_¶i˚_ˇbac
;

2201 
I_SLICE
:

2202 
SI_SLICE
:

2203 
cuºSli˚
->
ªad_⁄e_ma¸oblock
 = 
ªad_⁄e_ma¸oblock_i_¶i˚_ˇbac
;

2206 
	`¥ötf
("Unsupported sliceÅype\n");

2212 
cuºSli˚
->
¶i˚_ty≥
)

2214 
P_SLICE
:

2215 
SP_SLICE
:

2216 
cuºSli˚
->
ªad_⁄e_ma¸oblock
 = 
ªad_⁄e_ma¸oblock_p_¶i˚_ˇvlc
;

2218 
B_SLICE
:

2219 
cuºSli˚
->
ªad_⁄e_ma¸oblock
 = 
ªad_⁄e_ma¸oblock_b_¶i˚_ˇvlc
;

2221 
I_SLICE
:

2222 
SI_SLICE
:

2223 
cuºSli˚
->
ªad_⁄e_ma¸oblock
 = 
ªad_⁄e_ma¸oblock_i_¶i˚_ˇvlc
;

2226 
	`¥ötf
("Unsupported sliceÅype\n");

2230 
	}
}

	@ldecod/src/mbuffer.c

22 
	~<limôs.h
>

24 
	~"globÆ.h
"

25 
	~"îc_≠i.h
"

26 
	~"hódî.h
"

27 
	~"image.h
"

28 
	~"mbuf„r.h
"

29 
	~"mbuf„r_comm⁄.h
"

30 
	~"memÆloc.h
"

31 
	~"ouçut.h
"

32 
	~"mbuf„r_mvc.h
"

33 
	~"Á°_mem‹y.h
"

34 
	~"öput.h
"

36 
ö£π_pi˘uª_ö_dpb
 (
VideoP¨amëîs
 *
p_Vid
, 
FømeSt‹e
* 
fs
, 
St‹abÀPi˘uª
* 
p
);

37 
ouçut_⁄e_‰ame_‰om_dpb
 (
DecodedPi˘uªBuf„r
 *
p_Dpb
);

38 
gí_fõld_ªf_ids
 (
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
p
);

40 
	#MAX_LIST_SIZE
 33

	)

48 
	$dump_dpb
(
DecodedPi˘uªBuf„r
 *
p_Dpb
)

50 #i‡
DUMP_DPB


51 
i
;

53 
i
=0; i<
p_Dpb
->
u£d_size
;i++)

55 
	`¥ötf
("(");

56 
	`¥ötf
("‚=%d ", 
p_Dpb
->
fs
[
i
]->
‰ame_num
);

57 i‡(
p_Dpb
->
fs
[
i
]->
is_u£d
 & 1)

59 i‡(
p_Dpb
->
fs
[
i
]->
t›_fõld
)

60 
	`¥ötf
("T:Öoc=%d ", 
p_Dpb
->
fs
[
i
]->
t›_fõld
->
poc
);

62 
	`¥ötf
("T:Öoc=%d ", 
p_Dpb
->
fs
[
i
]->
‰ame
->
t›_poc
);

64 i‡(
p_Dpb
->
fs
[
i
]->
is_u£d
 & 2)

66 i‡(
p_Dpb
->
fs
[
i
]->
bŸtom_fõld
)

67 
	`¥ötf
("B:Öoc=%d ", 
p_Dpb
->
fs
[
i
]->
bŸtom_fõld
->
poc
);

69 
	`¥ötf
("B:Öoc=%d ", 
p_Dpb
->
fs
[
i
]->
‰ame
->
bŸtom_poc
);

71 i‡(
p_Dpb
->
fs
[
i
]->
is_u£d
 == 3)

72 
	`¥ötf
("F:Öoc=%d ", 
p_Dpb
->
fs
[
i
]->
‰ame
->
poc
);

73 
	`¥ötf
("G:Öoc=%dË ", 
p_Dpb
->
fs
[
i
]->
poc
);

74 i‡(
p_Dpb
->
fs
[
i
]->
is_ª„ªn˚
Ë
	`¥ötf
 ("ref (%d) ",Ö_Dpb->fs[i]->is_reference);

75 i‡(
p_Dpb
->
fs
[
i
]->
is_l⁄g_ãrm
Ë
	`¥ötf
 ("…_ª‡(%dË",Ö_Dpb->fs[i]->
is_ª„ªn˚
);

76 i‡(
p_Dpb
->
fs
[
i
]->
is_ouçut
Ë
	`¥ötf
 ("out ");

77 i‡(
p_Dpb
->
fs
[
i
]->
is_u£d
 == 3)

79 i‡(
p_Dpb
->
fs
[
i
]->
‰ame
->
n⁄_exi°ög
Ë
	`¥ötf
 ("ne ");

81 #i‡(
MVC_EXTENSION_ENABLE
)

82 i‡(
p_Dpb
->
fs
[
i
]->
is_ª„ªn˚
)

83 
	`¥ötf
 ("võw_id (%dË", 
p_Dpb
->
fs
[
i
]->
võw_id
);

85 
	`¥ötf
 ("\n");

88 
	}
}

98 
	$gëDpbSize
(
VideoP¨amëîs
 *
p_Vid
, 
£q_∑ømëî_£t_rb•_t
 *
a˘ive_•s
)

100 
pic_size
 = (
a˘ive_•s
->
pic_width_ö_mbs_möus1
 + 1Ë* (a˘ive_•s->
pic_height_ö_m≠_unôs_möus1
 + 1Ë* (a˘ive_•s->
‰ame_mbs_⁄ly_Êag
?1:2) * 384;

102 
size
 = 0;

104 
a˘ive_•s
->
Àvñ_idc
)

107 
size
 = 152064;

110 
size
 = 152064;

113 i‡(!
	`is_FREXT_¥ofûe
(
a˘ive_•s
->
¥ofûe_idc
Ë&& (a˘ive_•s->
c⁄°øöed_£t3_Êag
 == 1))

114 
size
 = 152064;

116 
size
 = 345600;

119 
size
 = 912384;

122 
size
 = 912384;

125 
size
 = 912384;

128 
size
 = 1824768;

131 
size
 = 3110400;

134 
size
 = 3110400;

137 
size
 = 6912000;

140 
size
 = 7864320;

143 
size
 = 12582912;

146 
size
 = 12582912;

149 
size
 = 13369344;

152 
size
 = 42393600;

155 
size
 = 70778880;

158 
size
 = 70778880;

161 
	`îr‹
 ("undefinedÜevel", 500);

165 
size
 /
pic_size
;

166 #i‡
MVC_EXTENSION_ENABLE


167 if(
p_Vid
->
¥ofûe_idc
 =
MVC_HIGH
 ||Ö_Vid->¥ofûe_id¯=
STEREO_HIGH
)

169 
num_võws
 = 
p_Vid
->
a˘ive_sub£t_•s
->
num_võws_möus1
+1;

170 
size
 = 
	`imö
(2*size, 
	`imax
(1, 
	`RoundLog2
(
num_võws
))*16)/num_views;

175 
size
 = 
	`imö
( size, 16);

178 i‡(
a˘ive_•s
->
vui_∑ømëîs_¥e£¡_Êag
 &&á˘ive_•s->
vui_£q_∑ømëîs
.
bô°ªam_ª°ri˘i⁄_Êag
)

180 
size_vui
;

181 i‡(()
a˘ive_•s
->
vui_£q_∑ømëîs
.
max_dec_‰ame_buf„rög
 > 
size
)

183 
	`îr‹
 ("max_dec_frame_bufferingÜargerÅhan MaxDpbSize", 500);

185 
size_vui
 = 
	`imax
 (1, 
a˘ive_•s
->
vui_£q_∑ømëîs
.
max_dec_‰ame_buf„rög
);

186 #ifde‡
_DEBUG


187 if(
size_vui
 < 
size
)

189 
	`¥ötf
("W¨nög: max_dec_‰ame_buf„rög(%dËi†Às†th™ DPB size(%dËˇlcuœãd from Profûe/Levñ.\n", 
size_vui
, 
size
);

192 
size
 = 
size_vui
;

195  
size
;

196 
	}
}

206 
	$check_num_ªf
(
DecodedPi˘uªBuf„r
 *
p_Dpb
)

208 i‡(()(
p_Dpb
->
…ªf_‰ames_ö_buf„r
 +Ö_Dpb->
ªf_‰ames_ö_buf„r
 ) > 
	`imax
(1,Ö_Dpb->
num_ªf_‰ames
))

210 
	`îr‹
 ("Max.Çumber ofÑeference framesÉxceeded. Invalid stream.", 500);

212 
	}
}

222 
	$öô_dpb
(
VideoP¨amëîs
 *
p_Vid
, 
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
ty≥
)

224 
i
;

225 
£q_∑ømëî_£t_rb•_t
 *
a˘ive_•s
 = 
p_Vid
->active_sps;

227 
p_Dpb
->
p_Vid
 =Ö_Vid;

228 i‡(
p_Dpb
->
öô_d⁄e
)

230 
	`‰ì_dpb
(
p_Dpb
);

233 
p_Dpb
->
size
 = 
	`gëDpbSize
(
p_Vid
, 
a˘ive_•s
Ë+Ö_Vid->
p_I≈
->
dpb_∂us
[
ty≥
==2? 1: 0];

234 
p_Dpb
->
num_ªf_‰ames
 = 
a˘ive_•s
->num_ref_frames;

236 #i‡(
MVC_EXTENSION_ENABLE
)

237 i‡(()
a˘ive_•s
->
max_dec_‰ame_buf„rög
 <á˘ive_•s->
num_ªf_‰ames
)

239 i‡(
p_Dpb
->
size
 < 
a˘ive_•s
->
num_ªf_‰ames
)

242 
	`îr‹
 ("DPB sizeát specifiedÜevel is smallerÅhanÅhe specifiedÇumber ofÑeference frames. This isÇotállowed.\n", 1000);

245 
p_Dpb
->
u£d_size
 = 0;

246 
p_Dpb
->
œ°_pi˘uª
 = 
NULL
;

248 
p_Dpb
->
ªf_‰ames_ö_buf„r
 = 0;

249 
p_Dpb
->
…ªf_‰ames_ö_buf„r
 = 0;

251 
p_Dpb
->
fs
 = 
	`ˇŒoc
’_Dpb->
size
,  (
FømeSt‹e
*));

252 i‡(
NULL
==
p_Dpb
->
fs
)

253 
	`no_mem_exô
("init_dpb:Ö_Dpb->fs");

255 
p_Dpb
->
fs_ªf
 = 
	`ˇŒoc
’_Dpb->
size
,  (
FømeSt‹e
*));

256 i‡(
NULL
==
p_Dpb
->
fs_ªf
)

257 
	`no_mem_exô
("init_dpb:Ö_Dpb->fs_ref");

259 
p_Dpb
->
fs_…ªf
 = 
	`ˇŒoc
’_Dpb->
size
,  (
FømeSt‹e
*));

260 i‡(
NULL
==
p_Dpb
->
fs_…ªf
)

261 
	`no_mem_exô
("init_dpb:Ö_Dpb->fs_ltref");

263 #i‡(
MVC_EXTENSION_ENABLE
)

264 
p_Dpb
->
fs_ûªf
 = 
	`ˇŒoc
(1,  (
FømeSt‹e
*));

265 i‡(
NULL
==
p_Dpb
->
fs_ûªf
)

266 
	`no_mem_exô
("init_dpb:Ö_Dpb->fs_ilref");

269 
i
 = 0; i < 
p_Dpb
->
size
; i++)

271 
p_Dpb
->
fs
[
i
] = 
	`Æloc_‰ame_°‹e
();

272 
p_Dpb
->
fs_ªf
[
i
] = 
NULL
;

273 
p_Dpb
->
fs_…ªf
[
i
] = 
NULL
;

274 
p_Dpb
->
fs
[
i
]->
œyî_id
 = 
MVC_INIT_VIEW_ID
;

275 #i‡(
MVC_EXTENSION_ENABLE
)

276 
p_Dpb
->
fs
[
i
]->
võw_id
 = 
MVC_INIT_VIEW_ID
;

277 
p_Dpb
->
fs
[
i
]->
öãr_võw_Êag
[0] =Ö_Dpb->fs[i]->inter_view_flag[1] = 0;

278 
p_Dpb
->
fs
[
i
]->
™ch‹_pic_Êag
[0] =Ö_Dpb->fs[i]->anchor_pic_flag[1] = 0;

281 #i‡(
MVC_EXTENSION_ENABLE
)

282 i‡(
ty≥
 == 2)

284 
p_Dpb
->
fs_ûªf
[0] = 
	`Æloc_‰ame_°‹e
();

286 
p_Dpb
->
fs_ûªf
[0]->
võw_id
 = 
MVC_INIT_VIEW_ID
;

287 
p_Dpb
->
fs_ûªf
[0]->
öãr_võw_Êag
[0] =Ö_Dpb->fs_ilref[0]->inter_view_flag[1] = 0;

288 
p_Dpb
->
fs_ûªf
[0]->
™ch‹_pic_Êag
[0] =Ö_Dpb->fs_ilref[0]->anchor_pic_flag[1] = 0;

292 
p_Dpb
->
fs_ûªf
[0] = 
NULL
;

304 if(!
p_Vid
->
no_ª„ªn˚_pi˘uª
)

306 
p_Vid
->
no_ª„ªn˚_pi˘uª
 = 
	`Æloc_°‹abÀ_pi˘uª
 (p_Vid, 
FRAME
,Ö_Vid->
width
,Ö_Vid->
height
,Ö_Vid->
width_¸
,Ö_Vid->
height_¸
, 1);

307 
p_Vid
->
no_ª„ªn˚_pi˘uª
->
t›_fõld
 =Ö_Vid->no_reference_picture;

308 
p_Vid
->
no_ª„ªn˚_pi˘uª
->
bŸtom_fõld
 =Ö_Vid->no_reference_picture;

309 
p_Vid
->
no_ª„ªn˚_pi˘uª
->
‰ame
 =Ö_Vid->no_reference_picture;

311 
p_Dpb
->
œ°_ouçut_poc
 = 
INT_MIN
;

313 #i‡(
MVC_EXTENSION_ENABLE
)

314 
p_Dpb
->
œ°_ouçut_võw_id
 = -1;

317 
p_Vid
->
œ°_has_mmco_5
 = 0;

319 
p_Dpb
->
öô_d⁄e
 = 1;

322 if(
p_Vid
->
c⁄˚Æ_mode
 !=0 && !p_Vid->
œ°_out_fs
)

323 
p_Vid
->
œ°_out_fs
 = 
	`Æloc_‰ame_°‹e
();

325 
	}
}

327 
	$ª_öô_dpb
(
VideoP¨amëîs
 *
p_Vid
, 
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
ty≥
)

329 
i
;

330 
£q_∑ømëî_£t_rb•_t
 *
a˘ive_•s
 = 
p_Vid
->active_sps;

331 
iDpbSize
;

333 
iDpbSize
 = 
	`gëDpbSize
(
p_Vid
, 
a˘ive_•s
)+p_Vid->
p_I≈
->
dpb_∂us
[
ty≥
==2? 1: 0];

334 
p_Dpb
->
num_ªf_‰ames
 = 
a˘ive_•s
->num_ref_frames;

335 if–
iDpbSize
 > ()
p_Dpb
->
size
)

337 #i‡(
MVC_EXTENSION_ENABLE
)

338 i‡(()
a˘ive_•s
->
max_dec_‰ame_buf„rög
 <á˘ive_•s->
num_ªf_‰ames
)

340 i‡(
p_Dpb
->
size
 < 
a˘ive_•s
->
num_ªf_‰ames
)

343 
	`îr‹
 ("DPB sizeát specifiedÜevel is smallerÅhanÅhe specifiedÇumber ofÑeference frames. This isÇotállowed.\n", 1000);

346 
p_Dpb
->
fs
 = 
	`ªÆloc
’_Dpb->fs, 
iDpbSize
 *  (
FømeSt‹e
*));

347 i‡(
NULL
==
p_Dpb
->
fs
)

348 
	`no_mem_exô
("re_init_dpb:Ö_Dpb->fs");

350 
p_Dpb
->
fs_ªf
 = 
	`ªÆloc
’_Dpb->fs_ªf, 
iDpbSize
 *  (
FømeSt‹e
*));

351 i‡(
NULL
==
p_Dpb
->
fs_ªf
)

352 
	`no_mem_exô
("re_init_dpb:Ö_Dpb->fs_ref");

354 
p_Dpb
->
fs_…ªf
 = 
	`ªÆloc
’_Dpb->fs_…ªf, 
iDpbSize
 *  (
FømeSt‹e
*));

355 i‡(
NULL
==
p_Dpb
->
fs_…ªf
)

356 
	`no_mem_exô
("re_init_dpb:Ö_Dpb->fs_ltref");

358 #i‡(
MVC_EXTENSION_ENABLE
)

359 if(!
p_Dpb
->
fs_ûªf
)

361 
p_Dpb
->
fs_ûªf
 = 
	`ˇŒoc
(1,  (
FømeSt‹e
*));

362 i‡(
NULL
==
p_Dpb
->
fs_ûªf
)

363 
	`no_mem_exô
("init_dpb:Ö_Dpb->fs_ilref");

367 
i
 = 
p_Dpb
->
size
; i < 
iDpbSize
; i++)

369 
p_Dpb
->
fs
[
i
] = 
	`Æloc_‰ame_°‹e
();

370 
p_Dpb
->
fs_ªf
[
i
] = 
NULL
;

371 
p_Dpb
->
fs_…ªf
[
i
] = 
NULL
;

372 #i‡(
MVC_EXTENSION_ENABLE
)

373 
p_Dpb
->
fs
[
i
]->
võw_id
 = 
MVC_INIT_VIEW_ID
;

374 
p_Dpb
->
fs
[
i
]->
öãr_võw_Êag
[0] =Ö_Dpb->fs[i]->inter_view_flag[1] = 0;

375 
p_Dpb
->
fs
[
i
]->
™ch‹_pic_Êag
[0] =Ö_Dpb->fs[i]->anchor_pic_flag[1] = 0;

379 #i‡(
MVC_EXTENSION_ENABLE
)

380 i‡(
ty≥
 =2 && !
p_Dpb
->
fs_ûªf
[0])

382 
p_Dpb
->
fs_ûªf
[0] = 
	`Æloc_‰ame_°‹e
();

384 
p_Dpb
->
fs_ûªf
[0]->
võw_id
 = 
MVC_INIT_VIEW_ID
;

385 
p_Dpb
->
fs_ûªf
[0]->
öãr_võw_Êag
[0] =Ö_Dpb->fs_ilref[0]->inter_view_flag[1] = 0;

386 
p_Dpb
->
fs_ûªf
[0]->
™ch‹_pic_Êag
[0] =Ö_Dpb->fs_ilref[0]->anchor_pic_flag[1] = 0;

390 
p_Dpb
->
fs_ûªf
[0] = 
NULL
;

393 
p_Dpb
->
size
 = 
iDpbSize
;

394 
p_Dpb
->
œ°_ouçut_poc
 = 
INT_MIN
;

395 #i‡(
MVC_EXTENSION_ENABLE
)

396 
p_Dpb
->
œ°_ouçut_võw_id
 = -1;

398 
p_Dpb
->
öô_d⁄e
 = 1;

401 
	}
}

409 
	$‰ì_dpb
(
DecodedPi˘uªBuf„r
 *
p_Dpb
)

411 
VideoP¨amëîs
 *
p_Vid
 = 
p_Dpb
->p_Vid;

412 
i
;

413 i‡(
p_Dpb
->
fs
)

415 
i
=0; i<
p_Dpb
->
size
; i++)

417 
	`‰ì_‰ame_°‹e
(
p_Dpb
->
fs
[
i
]);

419 
	`‰ì
 (
p_Dpb
->
fs
);

420 
p_Dpb
->
fs
=
NULL
;

423 i‡(
p_Dpb
->
fs_ªf
)

425 
	`‰ì
 (
p_Dpb
->
fs_ªf
);

427 i‡(
p_Dpb
->
fs_…ªf
)

429 
	`‰ì
 (
p_Dpb
->
fs_…ªf
);

432 #i‡(
MVC_EXTENSION_ENABLE
)

433 i‡(
p_Dpb
->
fs_ûªf
)

435 
i
=0; i<1; i++)

437 
	`‰ì_‰ame_°‹e
(
p_Dpb
->
fs_ûªf
[
i
]);

439 
	`‰ì
 (
p_Dpb
->
fs_ûªf
);

440 
p_Dpb
->
fs_ûªf
=
NULL
;

443 
p_Dpb
->
œ°_ouçut_võw_id
 = -1;

446 
p_Dpb
->
œ°_ouçut_poc
 = 
INT_MIN
;

448 
p_Dpb
->
öô_d⁄e
 = 0;

451 if(
p_Vid
->
c⁄˚Æ_mode
 !0 ||Ö_Vid->
œ°_out_fs
)

452 
	`‰ì_‰ame_°‹e
(
p_Vid
->
œ°_out_fs
);

454 if(
p_Vid
->
no_ª„ªn˚_pi˘uª
)

456 
	`‰ì_°‹abÀ_pi˘uª
(
p_Vid
->
no_ª„ªn˚_pi˘uª
);

457 
p_Vid
->
no_ª„ªn˚_pi˘uª
 = 
NULL
;

459 
	}
}

471 
FømeSt‹e
* 
	$Æloc_‰ame_°‹e
()

473 
FømeSt‹e
 *
f
;

475 
f
 = 
	`ˇŒoc
 (1, (
FømeSt‹e
));

476 i‡(
NULL
==
f
)

477 
	`no_mem_exô
("alloc_frame_store: f");

479 
f
->
is_u£d
 = 0;

480 
f
->
is_ª„ªn˚
 = 0;

481 
f
->
is_l⁄g_ãrm
 = 0;

482 
f
->
is_‹ig_ª„ªn˚
 = 0;

484 
f
->
is_ouçut
 = 0;

486 
f
->
‰ame
 = 
NULL
;;

487 
f
->
t›_fõld
 = 
NULL
;

488 
f
->
bŸtom_fõld
 = 
NULL
;

490  
f
;

491 
	}
}

493 
	$Æloc_pic_mŸi⁄
(
PicMŸi⁄P¨amsOld
 *
mŸi⁄
, 
size_y
, 
size_x
)

495 
mŸi⁄
->
mb_fõld
 = 
	`ˇŒoc
 (
size_y
 * 
size_x
, (
byã
));

496 i‡(
mŸi⁄
->
mb_fõld
 =
NULL
)

497 
	`no_mem_exô
("alloc_storable_picture: motion->mb_field");

498 
	}
}

522 
St‹abÀPi˘uª
* 
	$Æloc_°‹abÀ_pi˘uª
(
VideoP¨amëîs
 *
p_Vid
, 
Pi˘uªSåu˘uª
 
°ru˘uª
, 
size_x
, 
size_y
, 
size_x_¸
, 
size_y_¸
, 
is_ouçut
)

524 
£q_∑ømëî_£t_rb•_t
 *
a˘ive_•s
 = 
p_Vid
->active_sps;

526 
St‹abÀPi˘uª
 *
s
;

527 
≈œ√
;

531 
s
 = 
	`ˇŒoc
 (1, (
St‹abÀPi˘uª
));

532 i‡(
NULL
==
s
)

533 
	`no_mem_exô
("alloc_storable_picture: s");

535 i‡(
°ru˘uª
!=
FRAME
)

537 
size_y
 /= 2;

538 
size_y_¸
 /= 2;

541 
s
->
PicSizeInMbs
 = (
size_x
*
size_y
)/256;

542 
s
->
imgUV
 = 
NULL
;

544 
	`gë_mem2D≥l_∑d
 (&(
s
->
imgY
), 
size_y
, 
size_x
, 
p_Vid
->
iLumaPadY
,Ö_Vid->
iLumaPadX
);

545 
s
->
iLumaSåide
 = 
size_x
+2*
p_Vid
->
iLumaPadX
;

546 
s
->
iLumaEx∑ndedHeight
 = 
size_y
+2*
p_Vid
->
iLumaPadY
;

548 i‡(
a˘ive_•s
->
chroma_f‹m©_idc
 !
YUV400
)

550 
	`gë_mem3D≥l_∑d
(&(
s
->
imgUV
), 2, 
size_y_¸
, 
size_x_¸
, 
p_Vid
->
iChromaPadY
,Ö_Vid->
iChromaPadX
);

553 
s
->
iChromaSåide
 =
size_x_¸
 + 2*
p_Vid
->
iChromaPadX
;

554 
s
->
iChromaEx∑ndedHeight
 = 
size_y_¸
 + 2*
p_Vid
->
iChromaPadY
;

555 
s
->
iLumaPadY
 = 
p_Vid
->iLumaPadY;

556 
s
->
iLumaPadX
 = 
p_Vid
->iLumaPadX;

557 
s
->
iChromaPadY
 = 
p_Vid
->iChromaPadY;

558 
s
->
iChromaPadX
 = 
p_Vid
->iChromaPadX;

560 
s
->
£∑øã_cﬁour_∂™e_Êag
 = 
p_Vid
->separate_colour_plane_flag;

562 
	`gë_mem2Dmp
 ( &
s
->
mv_öfo
, (
size_y
 >> 
BLOCK_SHIFT
), (
size_x
 >> BLOCK_SHIFT));

563 
	`Æloc_pic_mŸi⁄
–&
s
->
mŸi⁄
 , (
size_y
 >> 
BLOCK_SHIFT
), (
size_x
 >> BLOCK_SHIFT));

565 if–(
p_Vid
->
£∑øã_cﬁour_∂™e_Êag
 != 0) )

567  
≈œ√
=0;Ç∂™e<
MAX_PLANE
;Çplane++ )

569 
	`gë_mem2Dmp
 (&
s
->
JVmv_öfo
[
≈œ√
], (
size_y
 >> 
BLOCK_SHIFT
), (
size_x
 >> BLOCK_SHIFT));

570 
	`Æloc_pic_mŸi⁄
(&
s
->
JVmŸi⁄
[
≈œ√
] , (
size_y
 >> 
BLOCK_SHIFT
), (
size_x
 >> BLOCK_SHIFT));

574 
s
->
pic_num
 = 0;

575 
s
->
‰ame_num
 = 0;

576 
s
->
l⁄g_ãrm_‰ame_idx
 = 0;

577 
s
->
l⁄g_ãrm_pic_num
 = 0;

578 
s
->
u£d_f‹_ª„ªn˚
 = 0;

579 
s
->
is_l⁄g_ãrm
 = 0;

580 
s
->
n⁄_exi°ög
 = 0;

581 
s
->
is_ouçut
 = 0;

582 
s
->
max_¶i˚_id
 = 0;

583 #i‡(
MVC_EXTENSION_ENABLE
)

584 
s
->
võw_id
 = -1;

587 
s
->
°ru˘uª
=structure;

589 
s
->
size_x
 = size_x;

590 
s
->
size_y
 = size_y;

591 
s
->
size_x_¸
 = size_x_cr;

592 
s
->
size_y_¸
 = size_y_cr;

593 
s
->
size_x_m1
 = 
size_x
 - 1;

594 
s
->
size_y_m1
 = 
size_y
 - 1;

595 
s
->
size_x_¸_m1
 = 
size_x_¸
 - 1;

596 
s
->
size_y_¸_m1
 = 
size_y_¸
 - 1;

598 
s
->
t›_fõld
 = 
p_Vid
->
no_ª„ªn˚_pi˘uª
;

599 
s
->
bŸtom_fõld
 = 
p_Vid
->
no_ª„ªn˚_pi˘uª
;

600 
s
->
‰ame
 = 
p_Vid
->
no_ª„ªn˚_pi˘uª
;

602 
s
->
dec_ªf_pic_m¨kög_buf„r
 = 
NULL
;

604 
s
->
coded_‰ame
 = 0;

605 
s
->
mb_aff_‰ame_Êag
 = 0;

607 
s
->
t›_poc
 = s->
bŸtom_poc
 = s->
poc
 = 0;

608 
s
->
£iHasT⁄e_m≠pög
 = 0;

610 if(!
p_Vid
->
a˘ive_•s
->
‰ame_mbs_⁄ly_Êag
 && 
°ru˘uª
 !
FRAME
)

612 
i
, 
j
;

613 
j
 = 0; j < 
MAX_NUM_SLICES
; j++)

615 
i
 = 0; i < 2; i++)

617 
s
->
li°X
[
j
][
i
] = 
	`ˇŒoc
(
MAX_LIST_SIZE
,  (
St‹abÀPi˘uª
*));

618 i‡(
NULL
==
s
->
li°X
[
j
][
i
])

619 
	`no_mem_exô
("alloc_storable_picture: s->listX[i]");

624  
s
;

625 
	}
}

639 
	$‰ì_‰ame_°‹e
(
FømeSt‹e
* 
f
)

641 i‡(
f
)

643 i‡(
f
->
‰ame
)

645 
	`‰ì_°‹abÀ_pi˘uª
(
f
->
‰ame
);

646 
f
->
‰ame
=
NULL
;

648 i‡(
f
->
t›_fõld
)

650 
	`‰ì_°‹abÀ_pi˘uª
(
f
->
t›_fõld
);

651 
f
->
t›_fõld
=
NULL
;

653 i‡(
f
->
bŸtom_fõld
)

655 
	`‰ì_°‹abÀ_pi˘uª
(
f
->
bŸtom_fõld
);

656 
f
->
bŸtom_fõld
=
NULL
;

658 
	`‰ì
(
f
);

660 
	}
}

662 
	$‰ì_pic_mŸi⁄
(
PicMŸi⁄P¨amsOld
 *
mŸi⁄
)

664 i‡(
mŸi⁄
->
mb_fõld
)

666 
	`‰ì
(
mŸi⁄
->
mb_fõld
);

667 
mŸi⁄
->
mb_fõld
 = 
NULL
;

669 
	}
}

682 
	$‰ì_°‹abÀ_pi˘uª
(
St‹abÀPi˘uª
* 
p
)

684 
≈œ√
;

685 i‡(
p
)

687 i‡(
p
->
mv_öfo
)

689 
	`‰ì_mem2Dmp
(
p
->
mv_öfo
);

690 
p
->
mv_öfo
 = 
NULL
;

692 
	`‰ì_pic_mŸi⁄
(&
p
->
mŸi⁄
);

694 if–(
p
->
£∑øã_cﬁour_∂™e_Êag
 != 0) )

696  
≈œ√
=0;Ç∂™e<
MAX_PLANE
;Çplane++ )

698 i‡(
p
->
JVmv_öfo
[
≈œ√
])

700 
	`‰ì_mem2Dmp
(
p
->
JVmv_öfo
[
≈œ√
]);

701 
p
->
JVmv_öfo
[
≈œ√
] = 
NULL
;

703 
	`‰ì_pic_mŸi⁄
(&
p
->
JVmŸi⁄
[
≈œ√
]);

707 i‡(
p
->
imgY
)

709 
	`‰ì_mem2D≥l_∑d
(
p
->
imgY
,Ö->
iLumaPadY
,Ö->
iLumaPadX
);

710 
p
->
imgY
 = 
NULL
;

713 i‡(
p
->
imgUV
)

715 
	`‰ì_mem3D≥l_∑d
(
p
->
imgUV
, 2,Ö->
iChromaPadY
,Ö->
iChromaPadX
);

716 
p
->
imgUV
=
NULL
;

720 i‡(
p
->
£iHasT⁄e_m≠pög
)

721 
	`‰ì
(
p
->
t⁄e_m≠pög_lut
);

724 
i
, 
j
;

725 
j
 = 0; j < 
MAX_NUM_SLICES
; j++)

727 
i
=0; i<2; i++)

729 if(
p
->
li°X
[
j
][
i
])

731 
	`‰ì
(
p
->
li°X
[
j
][
i
]);

732 
p
->
li°X
[
j
][
i
] = 
NULL
;

737 
	`‰ì
(
p
);

738 
p
 = 
NULL
;

740 
	}
}

749 
	$unm¨k_f‹_ª„ªn˚
(
FømeSt‹e
* 
fs
)

751 i‡(
fs
->
is_u£d
 & 1)

753 i‡(
fs
->
t›_fõld
)

755 
fs
->
t›_fõld
->
u£d_f‹_ª„ªn˚
 = 0;

758 i‡(
fs
->
is_u£d
 & 2)

760 i‡(
fs
->
bŸtom_fõld
)

762 
fs
->
bŸtom_fõld
->
u£d_f‹_ª„ªn˚
 = 0;

765 i‡(
fs
->
is_u£d
 == 3)

767 i‡(
fs
->
t›_fõld
 && fs->
bŸtom_fõld
)

769 
fs
->
t›_fõld
->
u£d_f‹_ª„ªn˚
 = 0;

770 
fs
->
bŸtom_fõld
->
u£d_f‹_ª„ªn˚
 = 0;

772 
fs
->
‰ame
->
u£d_f‹_ª„ªn˚
 = 0;

775 
fs
->
is_ª„ªn˚
 = 0;

777 if(
fs
->
‰ame
)

779 
	`‰ì_pic_mŸi⁄
(&
fs
->
‰ame
->
mŸi⁄
);

782 i‡(
fs
->
t›_fõld
)

784 
	`‰ì_pic_mŸi⁄
(&
fs
->
t›_fõld
->
mŸi⁄
);

787 i‡(
fs
->
bŸtom_fõld
)

789 
	`‰ì_pic_mŸi⁄
(&
fs
->
bŸtom_fõld
->
mŸi⁄
);

791 
	}
}

801 
	$unm¨k_f‹_l⁄g_ãrm_ª„ªn˚
(
FømeSt‹e
* 
fs
)

803 i‡(
fs
->
is_u£d
 & 1)

805 i‡(
fs
->
t›_fõld
)

807 
fs
->
t›_fõld
->
u£d_f‹_ª„ªn˚
 = 0;

808 
fs
->
t›_fõld
->
is_l⁄g_ãrm
 = 0;

811 i‡(
fs
->
is_u£d
 & 2)

813 i‡(
fs
->
bŸtom_fõld
)

815 
fs
->
bŸtom_fõld
->
u£d_f‹_ª„ªn˚
 = 0;

816 
fs
->
bŸtom_fõld
->
is_l⁄g_ãrm
 = 0;

819 i‡(
fs
->
is_u£d
 == 3)

821 i‡(
fs
->
t›_fõld
 && fs->
bŸtom_fõld
)

823 
fs
->
t›_fõld
->
u£d_f‹_ª„ªn˚
 = 0;

824 
fs
->
t›_fõld
->
is_l⁄g_ãrm
 = 0;

825 
fs
->
bŸtom_fõld
->
u£d_f‹_ª„ªn˚
 = 0;

826 
fs
->
bŸtom_fõld
->
is_l⁄g_ãrm
 = 0;

828 
fs
->
‰ame
->
u£d_f‹_ª„ªn˚
 = 0;

829 
fs
->
‰ame
->
is_l⁄g_ãrm
 = 0;

832 
fs
->
is_ª„ªn˚
 = 0;

833 
fs
->
is_l⁄g_ãrm
 = 0;

834 
	}
}

838 
	$upd©e_pic_num
(
Sli˚
 *
cuºSli˚
)

840 
i
;

841 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

842 
DecodedPi˘uªBuf„r
 *
p_Dpb
 = 
cuºSli˚
->p_Dpb;

843 
£q_∑ømëî_£t_rb•_t
 *
a˘ive_•s
 = 
p_Vid
->active_sps;

845 
add_t›
 = 0, 
add_bŸtom
 = 0;

846 
max_‰ame_num
 = 1 << (
a˘ive_•s
->
log2_max_‰ame_num_möus4
 + 4);

848 i‡(
cuºSli˚
->
°ru˘uª
 =
FRAME
)

850 
i
=0; i<
p_Dpb
->
ªf_‰ames_ö_buf„r
; i++)

852 i‡–
p_Dpb
->
fs_ªf
[
i
]->
is_u£d
==3 )

854 i‡((
p_Dpb
->
fs_ªf
[
i
]->
‰ame
->
u£d_f‹_ª„ªn˚
)&&(!p_Dpb->fs_ªf[i]->‰ame->
is_l⁄g_ãrm
))

856 if–
p_Dpb
->
fs_ªf
[
i
]->
‰ame_num
 > 
cuºSli˚
->frame_num )

858 
p_Dpb
->
fs_ªf
[
i
]->
‰ame_num_wøp
 =Ö_Dpb->fs_ªf[i]->
‰ame_num
 - 
max_‰ame_num
;

862 
p_Dpb
->
fs_ªf
[
i
]->
‰ame_num_wøp
 =Ö_Dpb->fs_ªf[i]->
‰ame_num
;

864 
p_Dpb
->
fs_ªf
[
i
]->
‰ame
->
pic_num
 =Ö_Dpb->fs_ªf[i]->
‰ame_num_wøp
;

869 
i
 = 0; i < 
p_Dpb
->
…ªf_‰ames_ö_buf„r
; i++)

871 i‡(
p_Dpb
->
fs_…ªf
[
i
]->
is_u£d
==3)

873 i‡(
p_Dpb
->
fs_…ªf
[
i
]->
‰ame
->
is_l⁄g_ãrm
)

875 
p_Dpb
->
fs_…ªf
[
i
]->
‰ame
->
l⁄g_ãrm_pic_num
 =Ö_Dpb->fs_…ªf[i]->‰ame->
l⁄g_ãrm_‰ame_idx
;

882 i‡(
cuºSli˚
->
°ru˘uª
 =
TOP_FIELD
)

884 
add_t›
 = 1;

885 
add_bŸtom
 = 0;

889 
add_t›
 = 0;

890 
add_bŸtom
 = 1;

893 
i
=0; i<
p_Dpb
->
ªf_‰ames_ö_buf„r
; i++)

895 i‡(
p_Dpb
->
fs_ªf
[
i
]->
is_ª„ªn˚
)

897 if–
p_Dpb
->
fs_ªf
[
i
]->
‰ame_num
 > 
cuºSli˚
->frame_num )

899 
p_Dpb
->
fs_ªf
[
i
]->
‰ame_num_wøp
 =Ö_Dpb->fs_ªf[i]->
‰ame_num
 - 
max_‰ame_num
;

903 
p_Dpb
->
fs_ªf
[
i
]->
‰ame_num_wøp
 =Ö_Dpb->fs_ªf[i]->
‰ame_num
;

905 i‡(
p_Dpb
->
fs_ªf
[
i
]->
is_ª„ªn˚
 & 1)

907 
p_Dpb
->
fs_ªf
[
i
]->
t›_fõld
->
pic_num
 = (2 *Ö_Dpb->fs_ªf[i]->
‰ame_num_wøp
Ë+ 
add_t›
;

909 i‡(
p_Dpb
->
fs_ªf
[
i
]->
is_ª„ªn˚
 & 2)

911 
p_Dpb
->
fs_ªf
[
i
]->
bŸtom_fõld
->
pic_num
 = (2 *Ö_Dpb->fs_ªf[i]->
‰ame_num_wøp
Ë+ 
add_bŸtom
;

916 
i
=0; i<
p_Dpb
->
…ªf_‰ames_ö_buf„r
; i++)

918 i‡(
p_Dpb
->
fs_…ªf
[
i
]->
is_l⁄g_ãrm
 & 1)

920 
p_Dpb
->
fs_…ªf
[
i
]->
t›_fõld
->
l⁄g_ãrm_pic_num
 = 2 *Ö_Dpb->fs_…ªf[i]->t›_fõld->
l⁄g_ãrm_‰ame_idx
 + 
add_t›
;

922 i‡(
p_Dpb
->
fs_…ªf
[
i
]->
is_l⁄g_ãrm
 & 2)

924 
p_Dpb
->
fs_…ªf
[
i
]->
bŸtom_fõld
->
l⁄g_ãrm_pic_num
 = 2 *Ö_Dpb->fs_…ªf[i]->bŸtom_fõld->
l⁄g_ãrm_‰ame_idx
 + 
add_bŸtom
;

928 
	}
}

936 
	$öô_li°s_i_¶i˚
(
Sli˚
 *
cuºSli˚
)

939 #i‡(
MVC_EXTENSION_ENABLE
)

940 
cuºSli˚
->
li°öãrvõwidx0
 = 0;

941 
cuºSli˚
->
li°öãrvõwidx1
 = 0;

944 
cuºSli˚
->
li°Xsize
[0] = 0;

945 
cuºSli˚
->
li°Xsize
[1] = 0;

946 
	}
}

955 
	$öô_li°s_p_¶i˚
(
Sli˚
 *
cuºSli˚
)

957 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

958 
DecodedPi˘uªBuf„r
 *
p_Dpb
 = 
cuºSli˚
->p_Dpb;

960 
i
;

962 
li°0idx
 = 0;

963 
li°…idx
 = 0;

965 
FømeSt‹e
 **
fs_li°0
;

966 
FømeSt‹e
 **
fs_li°…
;

968 #i‡(
MVC_EXTENSION_ENABLE
)

969 
cuºSli˚
->
li°öãrvõwidx0
 = 0;

970 
cuºSli˚
->
li°öãrvõwidx1
 = 0;

973 i‡(
cuºSli˚
->
°ru˘uª
 =
FRAME
)

975 
i
=0; i<
p_Dpb
->
ªf_‰ames_ö_buf„r
; i++)

977 i‡(
p_Dpb
->
fs_ªf
[
i
]->
is_u£d
==3)

979 i‡((
p_Dpb
->
fs_ªf
[
i
]->
‰ame
->
u£d_f‹_ª„ªn˚
Ë&& (!p_Dpb->fs_ªf[i]->‰ame->
is_l⁄g_ãrm
))

981 
cuºSli˚
->
li°X
[0][
li°0idx
++] = 
p_Dpb
->
fs_ªf
[
i
]->
‰ame
;

986 
	`qs‹t
((*)
cuºSli˚
->
li°X
[0], 
li°0idx
, (
St‹abÀPi˘uª
*), 
com∑ª_pic_by_pic_num_desc
);

987 
cuºSli˚
->
li°Xsize
[0] = (Ë
li°0idx
;

991 
i
=0; i<
p_Dpb
->
…ªf_‰ames_ö_buf„r
; i++)

993 i‡(
p_Dpb
->
fs_…ªf
[
i
]->
is_u£d
==3)

995 i‡(
p_Dpb
->
fs_…ªf
[
i
]->
‰ame
->
is_l⁄g_ãrm
)

997 
cuºSli˚
->
li°X
[0][
li°0idx
++] = 
p_Dpb
->
fs_…ªf
[
i
]->
‰ame
;

1001 
	`qs‹t
((*)&
cuºSli˚
->
li°X
[0][(ËcuºSli˚->
li°Xsize
[0]], 
li°0idx
 - cuºSli˚->li°Xsize[0], (
St‹abÀPi˘uª
*), 
com∑ª_pic_by_…_pic_num_asc
);

1002 
cuºSli˚
->
li°Xsize
[0] = (Ë
li°0idx
;

1006 
fs_li°0
 = 
	`ˇŒoc
(
p_Dpb
->
size
,  (
FømeSt‹e
*));

1007 i‡(
NULL
==
fs_li°0
)

1008 
	`no_mem_exô
("init_lists: fs_list0");

1009 
fs_li°…
 = 
	`ˇŒoc
(
p_Dpb
->
size
,  (
FømeSt‹e
*));

1010 i‡(
NULL
==
fs_li°…
)

1011 
	`no_mem_exô
("init_lists: fs_listlt");

1013 
i
=0; i<
p_Dpb
->
ªf_‰ames_ö_buf„r
; i++)

1015 i‡(
p_Dpb
->
fs_ªf
[
i
]->
is_ª„ªn˚
)

1017 
fs_li°0
[
li°0idx
++] = 
p_Dpb
->
fs_ªf
[
i
];

1021 
	`qs‹t
((*)
fs_li°0
, 
li°0idx
, (
FømeSt‹e
*), 
com∑ª_fs_by_‰ame_num_desc
);

1025 
cuºSli˚
->
li°Xsize
[0] = 0;

1026 
	`gí_pic_li°_‰om_‰ame_li°
(
cuºSli˚
->
°ru˘uª
, 
fs_li°0
, 
li°0idx
, cuºSli˚->
li°X
[0], &cuºSli˚->
li°Xsize
[0], 0);

1031 
i
=0; i<
p_Dpb
->
…ªf_‰ames_ö_buf„r
; i++)

1033 
fs_li°…
[
li°…idx
++]=
p_Dpb
->
fs_…ªf
[
i
];

1036 
	`qs‹t
((*)
fs_li°…
, 
li°…idx
, (
FømeSt‹e
*), 
com∑ª_fs_by_…_pic_idx_asc
);

1038 
	`gí_pic_li°_‰om_‰ame_li°
(
cuºSli˚
->
°ru˘uª
, 
fs_li°…
, 
li°…idx
, cuºSli˚->
li°X
[0], &cuºSli˚->
li°Xsize
[0], 1);

1040 
	`‰ì
(
fs_li°0
);

1041 
	`‰ì
(
fs_li°…
);

1043 
cuºSli˚
->
li°Xsize
[1] = 0;

1047 
cuºSli˚
->
li°Xsize
[0] = (Ë
	`imö
 (cuºSli˚->li°Xsize[0], cuºSli˚->
num_ªf_idx_a˘ive
[
LIST_0
]);

1048 
cuºSli˚
->
li°Xsize
[1] = (Ë
	`imö
 (cuºSli˚->li°Xsize[1], cuºSli˚->
num_ªf_idx_a˘ive
[
LIST_1
]);

1051 
i
=
cuºSli˚
->
li°Xsize
[0]; i< (
MAX_LIST_SIZE
) ; i++)

1053 
cuºSli˚
->
li°X
[0][
i
] = 
p_Vid
->
no_ª„ªn˚_pi˘uª
;

1055 
i
=
cuºSli˚
->
li°Xsize
[1]; i< (
MAX_LIST_SIZE
) ; i++)

1057 
cuºSli˚
->
li°X
[1][
i
] = 
p_Vid
->
no_ª„ªn˚_pi˘uª
;

1060 #i‡
PRINTREFLIST


1061 #i‡(
MVC_EXTENSION_ENABLE
)

1063 if((
p_Vid
->
¥ofûe_idc
 =
MVC_HIGH
 ||Ö_Vid->¥ofûe_id¯=
STEREO_HIGH
Ë&& 
cuºSli˚
->
cuºít_¶i˚_ƒ
==0)

1065 if(
cuºSli˚
->
li°Xsize
[0]>0)

1067 
	`¥ötf
("\n");

1068 
	`¥ötf
(" ** (CurVõwID:%d %dË%†Re‡Pi¯Li° 0 ****\n", 
cuºSli˚
->
võw_id
, cuºSli˚->
ThisPOC
, cuºSli˚->
°ru˘uª
==
FRAME
 ? "FRM":(cuºSli˚->°ru˘uª==
TOP_FIELD
 ? "TOP":"BOT"));

1069 
i
=0; i<()(
cuºSli˚
->
li°Xsize
[0]); i++)

1071 
	`¥ötf
(" %2d -> POC: %4d PicNum: %4d VõwID: %d\n", 
i
, 
cuºSli˚
->
li°X
[0][i]->
poc
, cuºSli˚->li°X[0][i]->
pic_num
, cuºSli˚->li°X[0][i]->
võw_id
);

1077 
	}
}

1087 
	$öô_li°s_b_¶i˚
(
Sli˚
 *
cuºSli˚
)

1089 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

1090 
DecodedPi˘uªBuf„r
 *
p_Dpb
 = 
cuºSli˚
->p_Dpb;

1092 
i
;

1093 
j
;

1095 
li°0idx
 = 0;

1096 
li°0idx_1
 = 0;

1097 
li°…idx
 = 0;

1099 
FømeSt‹e
 **
fs_li°0
;

1100 
FømeSt‹e
 **
fs_li°1
;

1101 
FømeSt‹e
 **
fs_li°…
;

1103 #i‡(
MVC_EXTENSION_ENABLE
)

1104 
cuºSli˚
->
li°öãrvõwidx0
 = 0;

1105 
cuºSli˚
->
li°öãrvõwidx1
 = 0;

1110 i‡(
cuºSli˚
->
°ru˘uª
 =
FRAME
)

1112 
i
 = 0; i < 
p_Dpb
->
ªf_‰ames_ö_buf„r
; i++)

1114 i‡(
p_Dpb
->
fs_ªf
[
i
]->
is_u£d
==3)

1116 i‡((
p_Dpb
->
fs_ªf
[
i
]->
‰ame
->
u£d_f‹_ª„ªn˚
)&&(!p_Dpb->fs_ªf[i]->‰ame->
is_l⁄g_ãrm
))

1118 i‡(
cuºSli˚
->
‰amïoc
 >
p_Dpb
->
fs_ªf
[
i
]->
‰ame
->
poc
)

1120 
cuºSli˚
->
li°X
[0][
li°0idx
++] = 
p_Dpb
->
fs_ªf
[
i
]->
‰ame
;

1125 
	`qs‹t
((*)
cuºSli˚
->
li°X
[0], 
li°0idx
, (
St‹abÀPi˘uª
*), 
com∑ª_pic_by_poc_desc
);

1128 
li°0idx_1
 = 
li°0idx
;

1129 
i
=0; i<
p_Dpb
->
ªf_‰ames_ö_buf„r
; i++)

1131 i‡(
p_Dpb
->
fs_ªf
[
i
]->
is_u£d
==3)

1133 i‡((
p_Dpb
->
fs_ªf
[
i
]->
‰ame
->
u£d_f‹_ª„ªn˚
)&&(!p_Dpb->fs_ªf[i]->‰ame->
is_l⁄g_ãrm
))

1135 i‡(
cuºSli˚
->
‰amïoc
 < 
p_Dpb
->
fs_ªf
[
i
]->
‰ame
->
poc
)

1137 
cuºSli˚
->
li°X
[0][
li°0idx
++] = 
p_Dpb
->
fs_ªf
[
i
]->
‰ame
;

1142 
	`qs‹t
((*)&
cuºSli˚
->
li°X
[0][
li°0idx_1
], 
li°0idx
-li°0idx_1, (
St‹abÀPi˘uª
*), 
com∑ª_pic_by_poc_asc
);

1144 
j
=0; j<
li°0idx_1
; j++)

1146 
cuºSli˚
->
li°X
[1][
li°0idx
-
li°0idx_1
+
j
]=currSlice->listX[0][j];

1148 
j
=
li°0idx_1
; j<
li°0idx
; j++)

1150 
cuºSli˚
->
li°X
[1][
j
-
li°0idx_1
]=currSlice->listX[0][j];

1153 
cuºSli˚
->
li°Xsize
[0] = cuºSli˚->li°Xsize[1] = (Ë
li°0idx
;

1161 
i
=0; i<
p_Dpb
->
…ªf_‰ames_ö_buf„r
; i++)

1163 i‡(
p_Dpb
->
fs_…ªf
[
i
]->
is_u£d
==3)

1165 i‡(
p_Dpb
->
fs_…ªf
[
i
]->
‰ame
->
is_l⁄g_ãrm
)

1167 
cuºSli˚
->
li°X
[0][
li°0idx
] = 
p_Dpb
->
fs_…ªf
[
i
]->
‰ame
;

1168 
cuºSli˚
->
li°X
[1][
li°0idx
++] = 
p_Dpb
->
fs_…ªf
[
i
]->
‰ame
;

1172 
	`qs‹t
((*)&
cuºSli˚
->
li°X
[0][(ËcuºSli˚->
li°Xsize
[0]], 
li°0idx
 - cuºSli˚->li°Xsize[0], (
St‹abÀPi˘uª
*), 
com∑ª_pic_by_…_pic_num_asc
);

1173 
	`qs‹t
((*)&
cuºSli˚
->
li°X
[1][(ËcuºSli˚->
li°Xsize
[0]], 
li°0idx
 - cuºSli˚->li°Xsize[0], (
St‹abÀPi˘uª
*), 
com∑ª_pic_by_…_pic_num_asc
);

1174 
cuºSli˚
->
li°Xsize
[0] = cuºSli˚->li°Xsize[1] = (Ë
li°0idx
;

1178 
fs_li°0
 = 
	`ˇŒoc
(
p_Dpb
->
size
,  (
FømeSt‹e
*));

1179 i‡(
NULL
==
fs_li°0
)

1180 
	`no_mem_exô
("init_lists: fs_list0");

1181 
fs_li°1
 = 
	`ˇŒoc
(
p_Dpb
->
size
,  (
FømeSt‹e
*));

1182 i‡(
NULL
==
fs_li°1
)

1183 
	`no_mem_exô
("init_lists: fs_list1");

1184 
fs_li°…
 = 
	`ˇŒoc
(
p_Dpb
->
size
,  (
FømeSt‹e
*));

1185 i‡(
NULL
==
fs_li°…
)

1186 
	`no_mem_exô
("init_lists: fs_listlt");

1188 
cuºSli˚
->
li°Xsize
[0] = 0;

1189 
cuºSli˚
->
li°Xsize
[1] = 1;

1191 
i
=0; i<
p_Dpb
->
ªf_‰ames_ö_buf„r
; i++)

1193 i‡(
p_Dpb
->
fs_ªf
[
i
]->
is_u£d
)

1195 i‡(
cuºSli˚
->
ThisPOC
 >
p_Dpb
->
fs_ªf
[
i
]->
poc
)

1197 
fs_li°0
[
li°0idx
++] = 
p_Dpb
->
fs_ªf
[
i
];

1201 
	`qs‹t
((*)
fs_li°0
, 
li°0idx
, (
FømeSt‹e
*), 
com∑ª_fs_by_poc_desc
);

1202 
li°0idx_1
 = 
li°0idx
;

1203 
i
=0; i<
p_Dpb
->
ªf_‰ames_ö_buf„r
; i++)

1205 i‡(
p_Dpb
->
fs_ªf
[
i
]->
is_u£d
)

1207 i‡(
cuºSli˚
->
ThisPOC
 < 
p_Dpb
->
fs_ªf
[
i
]->
poc
)

1209 
fs_li°0
[
li°0idx
++] = 
p_Dpb
->
fs_ªf
[
i
];

1213 
	`qs‹t
((*)&
fs_li°0
[
li°0idx_1
], 
li°0idx
-li°0idx_1, (
FømeSt‹e
*), 
com∑ª_fs_by_poc_asc
);

1215 
j
=0; j<
li°0idx_1
; j++)

1217 
fs_li°1
[
li°0idx
-
li°0idx_1
+
j
]=
fs_li°0
[j];

1219 
j
=
li°0idx_1
; j<
li°0idx
; j++)

1221 
fs_li°1
[
j
-
li°0idx_1
]=
fs_li°0
[j];

1227 
cuºSli˚
->
li°Xsize
[0] = 0;

1228 
cuºSli˚
->
li°Xsize
[1] = 0;

1229 
	`gí_pic_li°_‰om_‰ame_li°
(
cuºSli˚
->
°ru˘uª
, 
fs_li°0
, 
li°0idx
, cuºSli˚->
li°X
[0], &cuºSli˚->
li°Xsize
[0], 0);

1230 
	`gí_pic_li°_‰om_‰ame_li°
(
cuºSli˚
->
°ru˘uª
, 
fs_li°1
, 
li°0idx
, cuºSli˚->
li°X
[1], &cuºSli˚->
li°Xsize
[1], 0);

1236 
i
=0; i<
p_Dpb
->
…ªf_‰ames_ö_buf„r
; i++)

1238 
fs_li°…
[
li°…idx
++]=
p_Dpb
->
fs_…ªf
[
i
];

1241 
	`qs‹t
((*)
fs_li°…
, 
li°…idx
, (
FømeSt‹e
*), 
com∑ª_fs_by_…_pic_idx_asc
);

1243 
	`gí_pic_li°_‰om_‰ame_li°
(
cuºSli˚
->
°ru˘uª
, 
fs_li°…
, 
li°…idx
, cuºSli˚->
li°X
[0], &cuºSli˚->
li°Xsize
[0], 1);

1244 
	`gí_pic_li°_‰om_‰ame_li°
(
cuºSli˚
->
°ru˘uª
, 
fs_li°…
, 
li°…idx
, cuºSli˚->
li°X
[1], &cuºSli˚->
li°Xsize
[1], 1);

1246 
	`‰ì
(
fs_li°0
);

1247 
	`‰ì
(
fs_li°1
);

1248 
	`‰ì
(
fs_li°…
);

1252 i‡((
cuºSli˚
->
li°Xsize
[0] == currSlice->listXsize[1]) && (currSlice->listXsize[0] > 1))

1255 
diff
=0;

1256 
j
 = 0; j< 
cuºSli˚
->
li°Xsize
[0]; j++)

1258 i‡(
cuºSli˚
->
li°X
[0][
j
] != currSlice->listX[1][j])

1260 
diff
 = 1;

1264 i‡(!
diff
)

1266 
St‹abÀPi˘uª
 *
tmp_s
 = 
cuºSli˚
->
li°X
[1][0];

1267 
cuºSli˚
->
li°X
[1][0]=currSlice->listX[1][1];

1268 
cuºSli˚
->
li°X
[1][1]=
tmp_s
;

1273 
cuºSli˚
->
li°Xsize
[0] = (Ë
	`imö
 (cuºSli˚->li°Xsize[0], cuºSli˚->
num_ªf_idx_a˘ive
[
LIST_0
]);

1274 
cuºSli˚
->
li°Xsize
[1] = (Ë
	`imö
 (cuºSli˚->li°Xsize[1], cuºSli˚->
num_ªf_idx_a˘ive
[
LIST_1
]);

1277 
i
=
cuºSli˚
->
li°Xsize
[0]; i< (
MAX_LIST_SIZE
) ; i++)

1279 
cuºSli˚
->
li°X
[0][
i
] = 
p_Vid
->
no_ª„ªn˚_pi˘uª
;

1281 
i
=
cuºSli˚
->
li°Xsize
[1]; i< (
MAX_LIST_SIZE
) ; i++)

1283 
cuºSli˚
->
li°X
[1][
i
] = 
p_Vid
->
no_ª„ªn˚_pi˘uª
;

1286 #i‡
PRINTREFLIST


1287 #i‡(
MVC_EXTENSION_ENABLE
)

1289 if((
p_Vid
->
¥ofûe_idc
 =
MVC_HIGH
 ||Ö_Vid->¥ofûe_id¯=
STEREO_HIGH
Ë&& 
cuºSli˚
->
cuºít_¶i˚_ƒ
==0)

1291 if((
cuºSli˚
->
li°Xsize
[0]>0) || (currSlice->listXsize[1]>0))

1292 
	`¥ötf
("\n");

1293 if(
cuºSli˚
->
li°Xsize
[0]>0)

1295 
	`¥ötf
(" ** (CurVõwID:%d %dË%†Re‡Pi¯Li° 0 ****\n", 
cuºSli˚
->
võw_id
, cuºSli˚->
ThisPOC
, cuºSli˚->
°ru˘uª
==
FRAME
 ? "FRM":(cuºSli˚->°ru˘uª==
TOP_FIELD
 ? "TOP":"BOT"));

1296 
i
=0; i<()(
cuºSli˚
->
li°Xsize
[0]); i++)

1298 
	`¥ötf
(" %2d -> POC: %4d PicNum: %4d VõwID: %d\n", 
i
, 
cuºSli˚
->
li°X
[0][i]->
poc
, cuºSli˚->li°X[0][i]->
pic_num
, cuºSli˚->li°X[0][i]->
võw_id
);

1301 if(
cuºSli˚
->
li°Xsize
[1]>0)

1303 
	`¥ötf
(" ** (CurVõwID:%d %dË%†Re‡Pi¯Li° 1 ****\n", 
cuºSli˚
->
võw_id
, cuºSli˚->
ThisPOC
, cuºSli˚->
°ru˘uª
==
FRAME
 ? "FRM":(cuºSli˚->°ru˘uª==
TOP_FIELD
 ? "TOP":"BOT"));

1304 
i
=0; i<()(
cuºSli˚
->
li°Xsize
[1]); i++)

1306 
	`¥ötf
(" %2d -> POC: %4d PicNum: %4d VõwID: %d\n", 
i
, 
cuºSli˚
->
li°X
[1][i]->
poc
, cuºSli˚->li°X[1][i]->
pic_num
, cuºSli˚->li°X[1][i]->
võw_id
);

1312 
	}
}

1325 
	$öô_mbaff_li°s
(
VideoP¨amëîs
 *
p_Vid
, 
Sli˚
 *
cuºSli˚
)

1327 
j
;

1328 
i
;

1330 
i
=2;i<6;i++)

1332 
j
=0; j<
MAX_LIST_SIZE
; j++)

1334 
cuºSli˚
->
li°X
[
i
][
j
] = 
p_Vid
->
no_ª„ªn˚_pi˘uª
;

1336 
cuºSli˚
->
li°Xsize
[
i
]=0;

1339 
i
 = 0; i < 
cuºSli˚
->
li°Xsize
[0]; i++)

1341 
cuºSli˚
->
li°X
[2][2*
i
 ] = cuºSli˚->li°X[0][i]->
t›_fõld
;

1342 
cuºSli˚
->
li°X
[2][2*
i
+1] = cuºSli˚->li°X[0][i]->
bŸtom_fõld
;

1343 
cuºSli˚
->
li°X
[4][2*
i
 ] = cuºSli˚->li°X[0][i]->
bŸtom_fõld
;

1344 
cuºSli˚
->
li°X
[4][2*
i
+1] = cuºSli˚->li°X[0][i]->
t›_fõld
;

1346 
cuºSli˚
->
li°Xsize
[2] = currSlice->listXsize[4] = currSlice->listXsize[0] * 2;

1348 
i
 = 0; i < 
cuºSli˚
->
li°Xsize
[1]; i++)

1350 
cuºSli˚
->
li°X
[3][2*
i
 ] = cuºSli˚->li°X[1][i]->
t›_fõld
;

1351 
cuºSli˚
->
li°X
[3][2*
i
+1] = cuºSli˚->li°X[1][i]->
bŸtom_fõld
;

1352 
cuºSli˚
->
li°X
[5][2*
i
 ] = cuºSli˚->li°X[1][i]->
bŸtom_fõld
;

1353 
cuºSli˚
->
li°X
[5][2*
i
+1] = cuºSli˚->li°X[1][i]->
t›_fõld
;

1355 
cuºSli˚
->
li°Xsize
[3] = currSlice->listXsize[5] = currSlice->listXsize[1] * 2;

1356 
	}
}

1365 
St‹abÀPi˘uª
* 
	$gë_sh‹t_ãrm_pic
(
Sli˚
 *
cuºSli˚
, 
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
picNum
)

1367 
i
;

1369 
i
 = 0; i < 
p_Dpb
->
ªf_‰ames_ö_buf„r
; i++)

1371 i‡(
cuºSli˚
->
°ru˘uª
 =
FRAME
)

1373 i‡(
p_Dpb
->
fs_ªf
[
i
]->
is_ª„ªn˚
 == 3)

1374 i‡((!
p_Dpb
->
fs_ªf
[
i
]->
‰ame
->
is_l⁄g_ãrm
)&&’_Dpb->fs_ªf[i]->‰ame->
pic_num
 =
picNum
))

1375  
p_Dpb
->
fs_ªf
[
i
]->
‰ame
;

1379 i‡(
p_Dpb
->
fs_ªf
[
i
]->
is_ª„ªn˚
 & 1)

1380 i‡((!
p_Dpb
->
fs_ªf
[
i
]->
t›_fõld
->
is_l⁄g_ãrm
)&&’_Dpb->fs_ªf[i]->t›_fõld->
pic_num
 =
picNum
))

1381  
p_Dpb
->
fs_ªf
[
i
]->
t›_fõld
;

1382 i‡(
p_Dpb
->
fs_ªf
[
i
]->
is_ª„ªn˚
 & 2)

1383 i‡((!
p_Dpb
->
fs_ªf
[
i
]->
bŸtom_fõld
->
is_l⁄g_ãrm
)&&’_Dpb->fs_ªf[i]->bŸtom_fõld->
pic_num
 =
picNum
))

1384  
p_Dpb
->
fs_ªf
[
i
]->
bŸtom_fõld
;

1388  
cuºSli˚
->
p_Vid
->
no_ª„ªn˚_pi˘uª
;

1389 
	}
}

1393 #i‡(!
MVC_EXTENSION_ENABLE
)

1401 
	$ª‹dî_sh‹t_ãrm
(
Sli˚
 *
cuºSli˚
, 
cur_li°
, 
num_ªf_idx_lX_a˘ive_möus1
, 
picNumLX
, *
ªfIdxLX
)

1403 
St‹abÀPi˘uª
 **
RefPicLi°X
 = 
cuºSli˚
->
li°X
[
cur_li°
];

1404 
cIdx
, 
nIdx
;

1406 
St‹abÀPi˘uª
 *
picLX
;

1408 
picLX
 = 
	`gë_sh‹t_ãrm_pic
(
cuºSli˚
, cuºSli˚->
p_Dpb
, 
picNumLX
);

1410  
cIdx
 = 
num_ªf_idx_lX_a˘ive_möus1
+1; cIdx > *
ªfIdxLX
; cIdx-- )

1411 
RefPicLi°X
[ 
cIdx
 ] = RefPicListX[ cIdx - 1];

1413 
RefPicLi°X
[ (*
ªfIdxLX
)++ ] = 
picLX
;

1415 
nIdx
 = *
ªfIdxLX
;

1417  
cIdx
 = *
ªfIdxLX
; cIdx <
num_ªf_idx_lX_a˘ive_möus1
+1; cIdx++ )

1419 i‡(
RefPicLi°X
[ 
cIdx
 ])

1420 if–(
RefPicLi°X
[ 
cIdx
 ]->
is_l⁄g_ãrm
 ) || (RefPicLi°X[ cIdx ]->
pic_num
 !
picNumLX
 ))

1421 
RefPicLi°X
[ 
nIdx
++ ] = RefPicLi°X[ 
cIdx
 ];

1423 
	}
}

1433 
	$ª‹dî_l⁄g_ãrm
(
Sli˚
 *
cuºSli˚
, 
St‹abÀPi˘uª
 **
RefPicLi°X
, 
num_ªf_idx_lX_a˘ive_möus1
, 
L⁄gTîmPicNum
, *
ªfIdxLX
)

1435 
cIdx
, 
nIdx
;

1437 
St‹abÀPi˘uª
 *
picLX
;

1439 
picLX
 = 
	`gë_l⁄g_ãrm_pic
(
cuºSli˚
, cuºSli˚->
p_Dpb
, 
L⁄gTîmPicNum
);

1441  
cIdx
 = 
num_ªf_idx_lX_a˘ive_möus1
+1; cIdx > *
ªfIdxLX
; cIdx-- )

1442 
RefPicLi°X
[ 
cIdx
 ] = RefPicListX[ cIdx - 1];

1444 
RefPicLi°X
[ (*
ªfIdxLX
)++ ] = 
picLX
;

1446 
nIdx
 = *
ªfIdxLX
;

1448  
cIdx
 = *
ªfIdxLX
; cIdx <
num_ªf_idx_lX_a˘ive_möus1
+1; cIdx++ )

1450 i‡(
RefPicLi°X
[ 
cIdx
 ])

1452 if–(!
RefPicLi°X
[ 
cIdx
 ]->
is_l⁄g_ãrm
 ) || (RefPicLi°X[ cIdx ]->
l⁄g_ãrm_pic_num
 !
L⁄gTîmPicNum
 ))

1453 
RefPicLi°X
[ 
nIdx
++ ] = RefPicLi°X[ 
cIdx
 ];

1456 
	}
}

1466 
	$ª‹dî_ªf_pic_li°
(
Sli˚
 *
cuºSli˚
, 
cur_li°
)

1468 *
modifiˇti⁄_of_pic_nums_idc
 = 
cuºSli˚
->modifiˇti⁄_of_pic_nums_idc[
cur_li°
];

1469 *
abs_diff_pic_num_möus1
 = 
cuºSli˚
->abs_diff_pic_num_möus1[
cur_li°
];

1470 *
l⁄g_ãrm_pic_idx
 = 
cuºSli˚
->l⁄g_ãrm_pic_idx[
cur_li°
];

1471 
num_ªf_idx_lX_a˘ive_möus1
 = 
cuºSli˚
->
num_ªf_idx_a˘ive
[
cur_li°
] - 1;

1473 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

1474 
i
;

1476 
maxPicNum
, 
cuºPicNum
, 
picNumLXNoWøp
, 
picNumLXPªd
, 
picNumLX
;

1477 
ªfIdxLX
 = 0;

1479 i‡(
p_Vid
->
°ru˘uª
==
FRAME
)

1481 
maxPicNum
 = 
p_Vid
->
max_‰ame_num
;

1482 
cuºPicNum
 = 
cuºSli˚
->
‰ame_num
;

1486 
maxPicNum
 = 2 * 
p_Vid
->
max_‰ame_num
;

1487 
cuºPicNum
 = 2 * 
cuºSli˚
->
‰ame_num
 + 1;

1490 
picNumLXPªd
 = 
cuºPicNum
;

1492 
i
=0; 
modifiˇti⁄_of_pic_nums_idc
[i]!=3; i++)

1494 i‡(
modifiˇti⁄_of_pic_nums_idc
[
i
]>3)

1495 
	`îr‹
 ("Invalid modification_of_pic_nums_idc command", 500);

1497 i‡(
modifiˇti⁄_of_pic_nums_idc
[
i
] < 2)

1499 i‡(
modifiˇti⁄_of_pic_nums_idc
[
i
] == 0)

1501 if–
picNumLXPªd
 - ( 
abs_diff_pic_num_möus1
[
i
] + 1 ) < 0 )

1502 
picNumLXNoWøp
 = 
picNumLXPªd
 - ( 
abs_diff_pic_num_möus1
[
i
] + 1 ) + 
maxPicNum
;

1504 
picNumLXNoWøp
 = 
picNumLXPªd
 - ( 
abs_diff_pic_num_möus1
[
i
] + 1 );

1508 if–
picNumLXPªd
 + ( 
abs_diff_pic_num_möus1
[
i
] + 1 ) >
maxPicNum
 )

1509 
picNumLXNoWøp
 = 
picNumLXPªd
 + ( 
abs_diff_pic_num_möus1
[
i
] + 1 ) - 
maxPicNum
;

1511 
picNumLXNoWøp
 = 
picNumLXPªd
 + ( 
abs_diff_pic_num_möus1
[
i
] + 1 );

1513 
picNumLXPªd
 = 
picNumLXNoWøp
;

1515 if–
picNumLXNoWøp
 > 
cuºPicNum
 )

1516 
picNumLX
 = 
picNumLXNoWøp
 - 
maxPicNum
;

1518 
picNumLX
 = 
picNumLXNoWøp
;

1520 #i‡(
MVC_EXTENSION_ENABLE
)

1521 
	`ª‹dî_sh‹t_ãrm
(
cuºSli˚
, 
cur_li°
, 
num_ªf_idx_lX_a˘ive_möus1
, 
picNumLX
, &
ªfIdxLX
, -1);

1523 
	`ª‹dî_sh‹t_ãrm
(
cuºSli˚
, 
cur_li°
, 
num_ªf_idx_lX_a˘ive_möus1
, 
picNumLX
, &
ªfIdxLX
);

1528 #i‡(
MVC_EXTENSION_ENABLE
)

1529 
	`ª‹dî_l⁄g_ãrm
(
cuºSli˚
, cuºSli˚->
li°X
[
cur_li°
], 
num_ªf_idx_lX_a˘ive_möus1
, 
l⁄g_ãrm_pic_idx
[
i
], &
ªfIdxLX
, -1);

1531 
	`ª‹dî_l⁄g_ãrm
(
cuºSli˚
, cuºSli˚->
li°X
[
cur_li°
], 
num_ªf_idx_lX_a˘ive_möus1
, 
l⁄g_ãrm_pic_idx
[
i
], &
ªfIdxLX
);

1537 
cuºSli˚
->
li°Xsize
[
cur_li°
] = (Ë(
num_ªf_idx_lX_a˘ive_möus1
 + 1);

1538 
	}
}

1550 
	$idr_mem‹y_m™agemít
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
St‹abÀPi˘uª
* 
p
)

1552 
uöt32
 
i
;

1554 i‡(
p
->
no_ouçut_of_¥i‹_pics_Êag
)

1557 
i
=0; i<
p_Dpb
->
u£d_size
; i++)

1560 
	`‰ì_‰ame_°‹e
(
p_Dpb
->
fs
[
i
]);

1561 
p_Dpb
->
fs
[
i
] = 
	`Æloc_‰ame_°‹e
();

1563 
i
 = 0; i < 
p_Dpb
->
ªf_‰ames_ö_buf„r
; i++)

1565 
p_Dpb
->
fs_ªf
[
i
]=
NULL
;

1567 
i
=0; i<
p_Dpb
->
…ªf_‰ames_ö_buf„r
; i++)

1569 
p_Dpb
->
fs_…ªf
[
i
]=
NULL
;

1571 
p_Dpb
->
u£d_size
=0;

1575 
	`Êush_dpb
(
p_Dpb
);

1577 
p_Dpb
->
œ°_pi˘uª
 = 
NULL
;

1579 
	`upd©e_ªf_li°
(
p_Dpb
);

1580 
	`upd©e_…ªf_li°
(
p_Dpb
);

1581 
p_Dpb
->
œ°_ouçut_poc
 = 
INT_MIN
;

1583 i‡(
p
->
l⁄g_ãrm_ª„ªn˚_Êag
)

1585 
p_Dpb
->
max_l⁄g_ãrm_pic_idx
 = 0;

1586 
p
->
is_l⁄g_ãrm
 = 1;

1587 
p
->
l⁄g_ãrm_‰ame_idx
 = 0;

1591 
p_Dpb
->
max_l⁄g_ãrm_pic_idx
 = -1;

1592 
p
->
is_l⁄g_ãrm
 = 0;

1595 #i‡(
MVC_EXTENSION_ENABLE
)

1596 
p_Dpb
->
œ°_ouçut_võw_id
 = -1;

1599 
	}
}

1608 
	$¶idög_wödow_mem‹y_m™agemít
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
St‹abÀPi˘uª
* 
p
)

1610 
uöt32
 
i
;

1612 
	`as£π
 (!
p
->
idr_Êag
);

1615 i‡(
p_Dpb
->
ªf_‰ames_ö_buf„r
 =
	`imax
(1,Ö_Dpb->
num_ªf_‰ames
Ë-Ö_Dpb->
…ªf_‰ames_ö_buf„r
)

1617 
i
 = 0; i < 
p_Dpb
->
u£d_size
; i++)

1619 i‡(
p_Dpb
->
fs
[
i
]->
is_ª„ªn˚
 && (!’_Dpb->fs[i]->
is_l⁄g_ãrm
)))

1621 
	`unm¨k_f‹_ª„ªn˚
(
p_Dpb
->
fs
[
i
]);

1622 
	`upd©e_ªf_li°
(
p_Dpb
);

1628 
p
->
is_l⁄g_ãrm
 = 0;

1629 
	}
}

1638 
	$ad≠tive_mem‹y_m™agemít
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
St‹abÀPi˘uª
* 
p
)

1640 
DecRefPicM¨kög_t
 *
tmp_dΩm
;

1641 
VideoP¨amëîs
 *
p_Vid
 = 
p_Dpb
->p_Vid;

1643 
p_Vid
->
œ°_has_mmco_5
 = 0;

1645 
	`as£π
 (!
p
->
idr_Êag
);

1646 
	`as£π
 (
p
->
ad≠tive_ªf_pic_buf„rög_Êag
);

1648 
p
->
dec_ªf_pic_m¨kög_buf„r
)

1650 
tmp_dΩm
 = 
p
->
dec_ªf_pic_m¨kög_buf„r
;

1651 
tmp_dΩm
->
mem‹y_m™agemít_c⁄åﬁ_›î©i⁄
)

1654 i‡(
tmp_dΩm
->
Next
 !
NULL
)

1656 
	`îr‹
 ("memory_management_control_operation = 0ÇotÜast operation in buffer", 500);

1660 
	`mm_unm¨k_sh‹t_ãrm_f‹_ª„ªn˚
(
p_Dpb
, 
p
, 
tmp_dΩm
->
dif„ªn˚_of_pic_nums_möus1
);

1661 
	`upd©e_ªf_li°
(
p_Dpb
);

1664 
	`mm_unm¨k_l⁄g_ãrm_f‹_ª„ªn˚
(
p_Dpb
, 
p
, 
tmp_dΩm
->
l⁄g_ãrm_pic_num
);

1665 
	`upd©e_…ªf_li°
(
p_Dpb
);

1668 
	`mm_assign_l⁄g_ãrm_‰ame_idx
(
p_Dpb
, 
p
, 
tmp_dΩm
->
dif„ªn˚_of_pic_nums_möus1
,Åmp_dΩm->
l⁄g_ãrm_‰ame_idx
);

1669 
	`upd©e_ªf_li°
(
p_Dpb
);

1670 
	`upd©e_…ªf_li°
(
p_Dpb
);

1673 
	`mm_upd©e_max_l⁄g_ãrm_‰ame_idx
 (
p_Dpb
, 
tmp_dΩm
->
max_l⁄g_ãrm_‰ame_idx_∂us1
);

1674 
	`upd©e_…ªf_li°
(
p_Dpb
);

1677 
	`mm_unm¨k_Æl_sh‹t_ãrm_f‹_ª„ªn˚
(
p_Dpb
);

1678 
	`mm_unm¨k_Æl_l⁄g_ãrm_f‹_ª„ªn˚
(
p_Dpb
);

1679 
p_Vid
->
œ°_has_mmco_5
 = 1;

1682 
	`mm_m¨k_cuºít_pi˘uª_l⁄g_ãrm
(
p_Dpb
, 
p
, 
tmp_dΩm
->
l⁄g_ãrm_‰ame_idx
);

1683 
	`check_num_ªf
(
p_Dpb
);

1686 
	`îr‹
 ("invalid memory_management_control_operation in buffer", 500);

1688 
p
->
dec_ªf_pic_m¨kög_buf„r
 = 
tmp_dΩm
->
Next
;

1689 
	`‰ì
 (
tmp_dΩm
);

1691 i‡–
p_Vid
->
œ°_has_mmco_5
 )

1693 
p
->
pic_num
 =Ö->
‰ame_num
 = 0;

1695 
p
->
°ru˘uª
)

1697 
TOP_FIELD
:

1700 
p
->
poc
 =Ö->
t›_poc
 = 0;

1703 
BOTTOM_FIELD
:

1706 
p
->
poc
 =Ö->
bŸtom_poc
 = 0;

1709 
FRAME
:

1711 
p
->
t›_poc
 -p->
poc
;

1712 
p
->
bŸtom_poc
 -p->
poc
;

1717 
p
->
poc
 = 
	`imö
 (p->
t›_poc
,Ö->
bŸtom_poc
);

1723 #i‡(
MVC_EXTENSION_ENABLE
)

1724 if(
p
->
võw_id
 == 0)

1726 
	`Êush_dpb
(
p_Vid
->
p_Dpb_œyî
[0]);

1727 
	`Êush_dpb
(
p_Vid
->
p_Dpb_œyî
[1]);

1731 
	`Êush_dpb
(
p_Dpb
);

1734 
	`Êush_dpb
(
p_Dpb
);

1737 
	}
}

1756 
	$°‹e_pi˘uª_ö_dpb
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
St‹abÀPi˘uª
* 
p
)

1758 
VideoP¨amëîs
 *
p_Vid
 = 
p_Dpb
->p_Vid;

1759 
i
;

1760 
poc
, 
pos
;

1766 
	`as£π
 (
p
!=
NULL
);

1768 
p_Vid
->
œ°_has_mmco_5
=0;

1769 
p_Vid
->
œ°_pic_bŸtom_fõld
 = (
p
->
°ru˘uª
 =
BOTTOM_FIELD
);

1771 i‡(
p
->
idr_Êag
)

1773 
	`idr_mem‹y_m™agemít
(
p_Dpb
, 
p
);

1775 
	`mem£t
(
p_Vid
->
pocs_ö_dpb
, 0, ()*100);

1780 i‡(
p
->
u£d_f‹_ª„ªn˚
 && (p->
ad≠tive_ªf_pic_buf„rög_Êag
))

1781 
	`ad≠tive_mem‹y_m™agemít
(
p_Dpb
, 
p
);

1784 i‡((
p
->
°ru˘uª
==
TOP_FIELD
)||’->°ru˘uª==
BOTTOM_FIELD
))

1787 i‡(
p_Dpb
->
œ°_pi˘uª
)

1789 i‡(()
p_Dpb
->
œ°_pi˘uª
->
‰ame_num
 =
p
->
pic_num
)

1791 i‡(((
p
->
°ru˘uª
==
TOP_FIELD
)&&(
p_Dpb
->
œ°_pi˘uª
->
is_u£d
==2))||(’->°ru˘uª==
BOTTOM_FIELD
)&&(p_Dpb->last_picture->is_used==1)))

1793 i‡((
p
->
u£d_f‹_ª„ªn˚
 && (
p_Dpb
->
œ°_pi˘uª
->
is_‹ig_ª„ªn˚
!=0))||

1794 (!
p
->
u£d_f‹_ª„ªn˚
 && (
p_Dpb
->
œ°_pi˘uª
->
is_‹ig_ª„ªn˚
==0)))

1796 
	`ö£π_pi˘uª_ö_dpb
(
p_Vid
, 
p_Dpb
->
œ°_pi˘uª
, 
p
);

1797 
	`upd©e_ªf_li°
(
p_Dpb
);

1798 
	`upd©e_…ªf_li°
(
p_Dpb
);

1799 
	`dump_dpb
(
p_Dpb
);

1800 
p_Dpb
->
œ°_pi˘uª
 = 
NULL
;

1811 i‡((!
p
->
idr_Êag
)&&’->
u£d_f‹_ª„ªn˚
 && (!p->
ad≠tive_ªf_pic_buf„rög_Êag
)))

1813 
	`¶idög_wödow_mem‹y_m™agemít
(
p_Dpb
, 
p
);

1817 if(
p_Vid
->
c⁄˚Æ_mode
 != 0)

1819 
i
=0;i<
p_Dpb
->
size
;i++)

1820 if(
p_Dpb
->
fs
[
i
]->
is_ª„ªn˚
)

1821 
p_Dpb
->
fs
[
i
]->
c⁄˚Æmít_ª„ªn˚
 = 1;

1825 i‡(
p_Dpb
->
u£d_size
=ı_Dpb->
size
)

1828 i‡(
p_Vid
->
c⁄˚Æ_mode
 != 0)

1829 
	`c⁄˚Æ_n⁄_ªf_pics
(
p_Dpb
, 2);

1831 
	`ªmove_unu£d_‰ame_‰om_dpb
(
p_Dpb
);

1833 if(
p_Vid
->
c⁄˚Æ_mode
 != 0)

1834 
	`¶idög_wödow_poc_m™agemít
(
p_Dpb
, 
p
);

1838 
p_Dpb
->
u£d_size
 =p_Dpb->
size
)

1841 i‡(!
p
->
u£d_f‹_ª„ªn˚
)

1843 
	`gë_smÆÀ°_poc
(
p_Dpb
, &
poc
, &
pos
);

1844 i‡((-1==
pos
Ë|| (
p
->
poc
 <Öoc))

1846 #i‡(
_DEBUG
 && 
MVC_EXTENSION_ENABLE
)

1847 if((
p_Vid
->
¥ofûe_idc
 >
MVC_HIGH
))

1848 
	`¥ötf
("Di•œy ordî mighànŸ bêc‹ª˘, %d, %d\n", 
p
->
võw_id
,Ö->
poc
);

1850 #i‡(
MVC_EXTENSION_ENABLE
)

1851 
	`dúe˘_ouçut
(
p_Vid
, 
p
,Ö_Vid->
p_out_mvc
[
p_Dpb
->
œyî_id
]);

1853 
	`dúe˘_ouçut
(
p_Vid
, 
p
,Ö_Vid->
p_out
);

1859 
	`ouçut_⁄e_‰ame_‰om_dpb
(
p_Dpb
);

1863 i‡((
p
->
u£d_f‹_ª„ªn˚
)&&(!p->
is_l⁄g_ãrm
))

1865 
i
=0; i<
p_Dpb
->
ªf_‰ames_ö_buf„r
; i++)

1867 i‡(
p_Dpb
->
fs_ªf
[
i
]->
‰ame_num
 =
p
->frame_num)

1869 
	`îr‹
("duplicate frame_num in short-termÑeferenceÖicture buffer", 500);

1874 
	`ö£π_pi˘uª_ö_dpb
(
p_Vid
, 
p_Dpb
->
fs
[p_Dpb->
u£d_size
],
p
);

1877 i‡(
p
->
idr_Êag
)

1879 
p_Vid
->
óæõr_missög_poc
 = 0;

1882 i‡(
p
->
°ru˘uª
 !
FRAME
)

1884 
p_Dpb
->
œ°_pi˘uª
 =Ö_Dpb->
fs
[p_Dpb->
u£d_size
];

1888 
p_Dpb
->
œ°_pi˘uª
 = 
NULL
;

1891 
p_Dpb
->
u£d_size
++;

1893 if(
p_Vid
->
c⁄˚Æ_mode
 != 0)

1894 
p_Vid
->
pocs_ö_dpb
[
p_Dpb
->
u£d_size
-1] = 
p
->
poc
;

1896 
	`upd©e_ªf_li°
(
p_Dpb
);

1897 
	`upd©e_…ªf_li°
(
p_Dpb
);

1899 
	`check_num_ªf
(
p_Dpb
);

1901 
	`dump_dpb
(
p_Dpb
);

1902 
	}
}

1920 
	$ö£π_pi˘uª_ö_dpb
(
VideoP¨amëîs
 *
p_Vid
, 
FømeSt‹e
* 
fs
, 
St‹abÀPi˘uª
* 
p
)

1922 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

1924 
	`as£π
 (
p
!=
NULL
);

1925 
	`as£π
 (
fs
!=
NULL
);

1926 
p
->
°ru˘uª
)

1928 
FRAME
:

1929 
fs
->
‰ame
 = 
p
;

1930 
fs
->
is_u£d
 = 3;

1931 i‡(
p
->
u£d_f‹_ª„ªn˚
)

1933 
fs
->
is_ª„ªn˚
 = 3;

1934 
fs
->
is_‹ig_ª„ªn˚
 = 3;

1935 i‡(
p
->
is_l⁄g_ãrm
)

1937 
fs
->
is_l⁄g_ãrm
 = 3;

1938 
fs
->
l⁄g_ãrm_‰ame_idx
 = 
p
->long_term_frame_idx;

1941 
fs
->
œyî_id
 = 
p
->layer_id;

1942 #i‡(
MVC_EXTENSION_ENABLE
)

1943 
fs
->
võw_id
 = 
p
->view_id;

1944 
fs
->
öãr_võw_Êag
[0] = fs->öãr_võw_Êag[1] = 
p
->inter_view_flag;

1945 
fs
->
™ch‹_pic_Êag
[0] = fs->™ch‹_pic_Êag[1] = 
p
->anchor_pic_flag;

1948 
	`dpb_•lô_fõld
(
p_Vid
, 
fs
);

1950 
TOP_FIELD
:

1951 
fs
->
t›_fõld
 = 
p
;

1952 
fs
->
is_u£d
 |= 1;

1953 
fs
->
œyî_id
 = 
p
->layer_id;

1954 #i‡(
MVC_EXTENSION_ENABLE
)

1955 
fs
->
võw_id
 = 
p
->view_id;

1956 
fs
->
öãr_võw_Êag
[0] = 
p
->inter_view_flag;

1957 
fs
->
™ch‹_pic_Êag
[0] = 
p
->anchor_pic_flag;

1959 i‡(
p
->
u£d_f‹_ª„ªn˚
)

1961 
fs
->
is_ª„ªn˚
 |= 1;

1962 
fs
->
is_‹ig_ª„ªn˚
 |= 1;

1963 i‡(
p
->
is_l⁄g_ãrm
)

1965 
fs
->
is_l⁄g_ãrm
 |= 1;

1966 
fs
->
l⁄g_ãrm_‰ame_idx
 = 
p
->long_term_frame_idx;

1969 i‡(
fs
->
is_u£d
 == 3)

1972 
	`dpb_comböe_fõld
(
p_Vid
, 
fs
);

1976 
fs
->
poc
 = 
p
->poc;

1978 
	`gí_fõld_ªf_ids
(
p_Vid
, 
p
);

1980 
BOTTOM_FIELD
:

1981 
fs
->
bŸtom_fõld
 = 
p
;

1982 
fs
->
is_u£d
 |= 2;

1983 
fs
->
œyî_id
 = 
p
->layer_id;

1984 #i‡(
MVC_EXTENSION_ENABLE
)

1985 
fs
->
võw_id
 = 
p
->view_id;

1986 
fs
->
öãr_võw_Êag
[1] = 
p
->inter_view_flag;

1987 
fs
->
™ch‹_pic_Êag
[1] = 
p
->anchor_pic_flag;

1989 i‡(
p
->
u£d_f‹_ª„ªn˚
)

1991 
fs
->
is_ª„ªn˚
 |= 2;

1992 
fs
->
is_‹ig_ª„ªn˚
 |= 2;

1993 i‡(
p
->
is_l⁄g_ãrm
)

1995 
fs
->
is_l⁄g_ãrm
 |= 2;

1996 
fs
->
l⁄g_ãrm_‰ame_idx
 = 
p
->long_term_frame_idx;

1999 i‡(
fs
->
is_u£d
 == 3)

2002 
	`dpb_comböe_fõld
(
p_Vid
, 
fs
);

2006 
fs
->
poc
 = 
p
->poc;

2008 
	`gí_fõld_ªf_ids
(
p_Vid
, 
p
);

2011 
fs
->
‰ame_num
 = 
p
->
pic_num
;

2012 
fs
->
ªcovîy_‰ame
 = 
p
->recovery_frame;

2014 
fs
->
is_ouçut
 = 
p
->is_output;

2016 i‡(
fs
->
is_u£d
==3)

2018 
	`ˇlcuœã_‰ame_no
(
p_Vid
, 
p
);

2019 i‡(-1 !
p_Vid
->
p_ªf
 && !
p_I≈
->
sûít
)

2020 
	`föd_¢r
(
p_Vid
, 
fs
->
‰ame
, &p_Vid->
p_ªf
);

2022 
	}
}

2031 
	$ªmove_‰ame_‰om_dpb
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
pos
)

2033 
FømeSt‹e
* 
fs
 = 
p_Dpb
->fs[
pos
];

2034 
FømeSt‹e
* 
tmp
;

2035 
i
;

2038 
fs
->
is_u£d
)

2041 
	`‰ì_°‹abÀ_pi˘uª
(
fs
->
‰ame
);

2042 
	`‰ì_°‹abÀ_pi˘uª
(
fs
->
t›_fõld
);

2043 
	`‰ì_°‹abÀ_pi˘uª
(
fs
->
bŸtom_fõld
);

2044 
fs
->
‰ame
=
NULL
;

2045 
fs
->
t›_fõld
=
NULL
;

2046 
fs
->
bŸtom_fõld
=
NULL
;

2049 
	`‰ì_°‹abÀ_pi˘uª
(
fs
->
bŸtom_fõld
);

2050 
fs
->
bŸtom_fõld
=
NULL
;

2053 
	`‰ì_°‹abÀ_pi˘uª
(
fs
->
t›_fõld
);

2054 
fs
->
t›_fõld
=
NULL
;

2059 
	`îr‹
("invalid frame storeÅype",500);

2061 
fs
->
is_u£d
 = 0;

2062 
fs
->
is_l⁄g_ãrm
 = 0;

2063 
fs
->
is_ª„ªn˚
 = 0;

2064 
fs
->
is_‹ig_ª„ªn˚
 = 0;

2067 
tmp
 = 
p_Dpb
->
fs
[
pos
];

2069 
i
=
pos
; i<
p_Dpb
->
u£d_size
-1;i++)

2071 
p_Dpb
->
fs
[
i
] =Ö_Dpb->fs[i+1];

2073 
p_Dpb
->
fs
[p_Dpb->
u£d_size
-1] = 
tmp
;

2074 
p_Dpb
->
u£d_size
--;

2075 
	}
}

2086 
	$ouçut_⁄e_‰ame_‰om_dpb
(
DecodedPi˘uªBuf„r
 *
p_Dpb
)

2088 
VideoP¨amëîs
 *
p_Vid
 = 
p_Dpb
->p_Vid;

2089 
poc
, 
pos
;

2091 i‡(
p_Dpb
->
u£d_size
 < 1)

2093 
	`îr‹
("Cannot output frame, DPBÉmpty.",150);

2097 
	`gë_smÆÀ°_poc
(
p_Dpb
, &
poc
, &
pos
);

2099 if(
pos
==-1)

2108 if(
p_Vid
->
c⁄˚Æ_mode
 != 0)

2110 if(
p_Dpb
->
œ°_ouçut_poc
 == 0)

2112 
	`wrôe_lo°_ªf_a·î_idr
(
p_Dpb
, 
pos
);

2114 #i‡(
MVC_EXTENSION_ENABLE
)

2115 
	`wrôe_lo°_n⁄_ªf_pic
(
p_Dpb
, 
poc
, 
p_Vid
->
p_out_mvc
[p_Dpb->
œyî_id
]);

2117 
	`wrôe_lo°_n⁄_ªf_pic
(
p_Dpb
, 
poc
, 
p_Vid
->
p_out
);

2123 #i‡(
MVC_EXTENSION_ENABLE
)

2124 
	`wrôe_°‹ed_‰ame
(
p_Vid
, 
p_Dpb
->
fs
[
pos
],Ö_Vid->
p_out_mvc
[p_Dpb->
œyî_id
]);

2126 
	`wrôe_°‹ed_‰ame
(
p_Vid
, 
p_Dpb
->
fs
[
pos
],Ö_Vid->
p_out
);

2130 if(
p_Vid
->
c⁄˚Æ_mode
 == 0)

2132 i‡(
p_Dpb
->
œ°_ouçut_poc
 >
poc
)

2134 
	`îr‹
 ("output POC must be ináscending order", 150);

2138 
p_Dpb
->
œ°_ouçut_poc
 = 
poc
;

2141 i‡(!
	`is_u£d_f‹_ª„ªn˚
(
p_Dpb
->
fs
[
pos
]))

2143 
	`ªmove_‰ame_‰om_dpb
(
p_Dpb
, 
pos
);

2146 
	}
}

2156 
	$Êush_dpb
(
DecodedPi˘uªBuf„r
 *
p_Dpb
)

2158 
VideoP¨amëîs
 *
p_Vid
 = 
p_Dpb
->p_Vid;

2159 
uöt32
 
i
;

2163 if(!
p_Dpb
->
öô_d⁄e
)

2166 i‡(
p_Vid
->
c⁄˚Æ_mode
 != 0)

2167 
	`c⁄˚Æ_n⁄_ªf_pics
(
p_Dpb
, 0);

2170 
i
=0; i<
p_Dpb
->
u£d_size
; i++)

2172 #i‡
MVC_EXTENSION_ENABLE


2173 
	`as£π
–
p_Dpb
->
fs
[
i
]->
võw_id
 =p_Dpb->
œyî_id
);

2175 
	`unm¨k_f‹_ª„ªn˚
 (
p_Dpb
->
fs
[
i
]);

2178 
	`ªmove_unu£d_‰ame_‰om_dpb
(
p_Dpb
)) ;

2181 
p_Dpb
->
u£d_size
 && 
	`ouçut_⁄e_‰ame_‰om_dpb
(p_Dpb)) ;

2183 
p_Dpb
->
œ°_ouçut_poc
 = 
INT_MIN
;

2184 
	}
}

2186 #i‡(
MVC_EXTENSION_ENABLE
)

2187 
	$Êush_dpbs
(
DecodedPi˘uªBuf„r
 **
p_Dpb_œyîs
, 
nLayîs
)

2189 
VideoP¨amëîs
 *
p_Vid
 = 
p_Dpb_œyîs
[0]->p_Vid;

2190 
DecodedPi˘uªBuf„r
 *
p_Dpb
;

2191 
i
, 
j
, 
u£d_size
;

2197 i‡(
p_Vid
->
c⁄˚Æ_mode
 != 0)

2199 
	`c⁄˚Æ_n⁄_ªf_pics
(
p_Dpb_œyîs
[0], 0);

2203 
j
=0; j<
nLayîs
; j++)

2205 
p_Dpb
 = 
p_Dpb_œyîs
[
j
];

2206 if(
p_Dpb
->
öô_d⁄e
)

2208 
i
=0; i<()
p_Dpb
->
u£d_size
; i++)

2210 
	`unm¨k_f‹_ª„ªn˚
 (
p_Dpb
->
fs
[
i
]);

2212 
	`ªmove_unu£d_‰ame_‰om_dpb
(
p_Dpb
)) ;

2216 
u£d_size
 = 
p_Dpb_œyîs
[0]->used_size;

2217 
j
=1; j<
nLayîs
; j++)

2219 
p_Dpb
 = 
p_Dpb_œyîs
[
j
];

2220 if(
p_Dpb
->
öô_d⁄e
)

2222 if(
p_Dpb
->
u£d_size
 && (p_Dpb->used_size != used_size))

2224 
	`as£π
(!"DPB used_size isÇotÉqual!");

2226 if(()
p_Dpb
->
u£d_size
 > used_size)

2228 
u£d_size
 = ()
p_Dpb
->used_size;

2232 
u£d_size
)

2234 
j
=0; j<
nLayîs
; j++)

2236 
p_Dpb
 = 
p_Dpb_œyîs
[
j
];

2237 if(
p_Dpb
->
u£d_size
)

2238 
	`ouçut_⁄e_‰ame_‰om_dpb
(
p_Dpb
);

2240 
u£d_size
--;

2242 
j
=0; j<
nLayîs
; j++)

2244 
p_Dpb
 = 
p_Dpb_œyîs
[
j
];

2245 
p_Dpb
->
œ°_ouçut_poc
 = 
INT_MIN
;

2247 
	}
}

2250 
	$gí_fõld_ªf_ids
(
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
p
)

2252 
i
,
j
;

2256 
j
=0; j<
p_Vid
->
iSli˚NumOfCuºPic
; j++)

2258 if(
p
->
li°X
[
j
][
LIST_0
])

2260 
p
->
li°Xsize
[
j
][
LIST_0
] = 
p_Vid
->
µSli˚Li°
[j]->listXsize[LIST_0];

2261 
i
=0; i<
p
->
li°Xsize
[
j
][
LIST_0
]; i++)

2262 
p
->
li°X
[
j
][
LIST_0
][
i
] = 
p_Vid
->
µSli˚Li°
[j]->listX[LIST_0][i];

2264 if(
p
->
li°X
[
j
][
LIST_1
])

2266 
p
->
li°Xsize
[
j
][
LIST_1
] = 
p_Vid
->
µSli˚Li°
[j]->listXsize[LIST_1];

2267 
i
=0; i<
p
->
li°Xsize
[
j
][
LIST_1
]; i++)

2268 
p
->
li°X
[
j
][
LIST_1
][
i
] = 
p_Vid
->
µSli˚Li°
[j]->listX[LIST_1][i];

2271 
	}
}

2279 
	$dpb_•lô_fõld
(
VideoP¨amëîs
 *
p_Vid
, 
FømeSt‹e
 *
fs
)

2281 
i
, 
j
, 
ii
, 
jj
, 
jj4
;

2282 
idiv
,
jdiv
;

2283 
cuºítmb
;

2284 
twosz16
 = 2 * (
fs
->
‰ame
->
size_x
 >> 4);

2285 
St‹abÀPi˘uª
 *
fs_t›
 = 
NULL
, *
fs_btm
 = NULL;

2286 
St‹abÀPi˘uª
 *
‰ame
 = 
fs
->frame;

2288 
fs
->
poc
 = 
‰ame
->poc;

2290 i‡(!
‰ame
->
‰ame_mbs_⁄ly_Êag
)

2292 
fs_t›
 = 
fs
->
t›_fõld
 = 
	`Æloc_°‹abÀ_pi˘uª
(
p_Vid
, 
TOP_FIELD
, 
‰ame
->
size_x
, føme->
size_y
, føme->
size_x_¸
, føme->
size_y_¸
, 1);

2293 
fs_btm
 = 
fs
->
bŸtom_fõld
 = 
	`Æloc_°‹abÀ_pi˘uª
(
p_Vid
, 
BOTTOM_FIELD
, 
‰ame
->
size_x
, føme->
size_y
, føme->
size_x_¸
, føme->
size_y_¸
, 1);

2295 
i
 = 0; i < (
‰ame
->
size_y
 >> 1); i++)

2297 
	`mem˝y
(
fs_t›
->
imgY
[
i
], 
‰ame
->imgY[i*2], føme->
size_x
*(
img≥l
));

2300 
i
 = 0; i< (
‰ame
->
size_y_¸
 >> 1); i++)

2302 
	`mem˝y
(
fs_t›
->
imgUV
[0][
i
], 
‰ame
->imgUV[0][i*2], føme->
size_x_¸
*(
img≥l
));

2303 
	`mem˝y
(
fs_t›
->
imgUV
[1][
i
], 
‰ame
->imgUV[1][i*2], føme->
size_x_¸
*(
img≥l
));

2306 
i
 = 0; i < (
‰ame
->
size_y
>>1); i++)

2308 
	`mem˝y
(
fs_btm
->
imgY
[
i
], 
‰ame
->imgY[i*2 + 1], føme->
size_x
*(
img≥l
));

2311 
i
 = 0; i < (
‰ame
->
size_y_¸
>>1); i++)

2313 
	`mem˝y
(
fs_btm
->
imgUV
[0][
i
], 
‰ame
->imgUV[0][i*2 + 1], føme->
size_x_¸
*(
img≥l
));

2314 
	`mem˝y
(
fs_btm
->
imgUV
[1][
i
], 
‰ame
->imgUV[1][i*2 + 1], føme->
size_x_¸
*(
img≥l
));

2317 
fs_t›
->
poc
 = 
‰ame
->
t›_poc
;

2318 
fs_btm
->
poc
 = 
‰ame
->
bŸtom_poc
;

2320 #i‡(
MVC_EXTENSION_ENABLE
)

2321 
fs_t›
->
võw_id
 = 
‰ame
->view_id;

2322 
fs_btm
->
võw_id
 = 
‰ame
->view_id;

2325 
fs_t›
->
‰ame_poc
 = 
‰ame
->frame_poc;

2327 
fs_t›
->
bŸtom_poc
 = 
fs_btm
->bŸtom_po¯
‰ame
->bottom_poc;

2328 
fs_t›
->
t›_poc
 = 
fs_btm
->t›_po¯
‰ame
->top_poc;

2329 
fs_btm
->
‰ame_poc
 = 
‰ame
->frame_poc;

2331 
fs_t›
->
u£d_f‹_ª„ªn˚
 = 
fs_btm
->used_for_reference

2332 
‰ame
->
u£d_f‹_ª„ªn˚
;

2333 
fs_t›
->
is_l⁄g_ãrm
 = 
fs_btm
->is_long_term

2334 
‰ame
->
is_l⁄g_ãrm
;

2335 
fs
->
l⁄g_ãrm_‰ame_idx
 = 
fs_t›
->long_term_frame_idx

2336 
fs_btm
->
l⁄g_ãrm_‰ame_idx


2337 
‰ame
->
l⁄g_ãrm_‰ame_idx
;

2339 
fs_t›
->
coded_‰ame
 = 
fs_btm
->coded_frame = 1;

2340 
fs_t›
->
mb_aff_‰ame_Êag
 = 
fs_btm
->mb_aff_frame_flag

2341 
‰ame
->
mb_aff_‰ame_Êag
;

2343 
‰ame
->
t›_fõld
 = 
fs_t›
;

2344 
‰ame
->
bŸtom_fõld
 = 
fs_btm
;

2345 
‰ame
->frame = frame;

2346 
fs_t›
->
bŸtom_fõld
 = 
fs_btm
;

2347 
fs_t›
->
‰ame
 = frame;

2348 
fs_t›
->
t›_fõld
 = fs_top;

2349 
fs_btm
->
t›_fõld
 = 
fs_t›
;

2350 
fs_btm
->
‰ame
 = frame;

2351 
fs_btm
->
bŸtom_fõld
 = fs_btm;

2353 #i‡(
MVC_EXTENSION_ENABLE
)

2354 
fs_t›
->
võw_id
 = 
fs_btm
->võw_id = 
fs
->view_id;

2355 
fs_t›
->
öãr_võw_Êag
 = 
fs
->inter_view_flag[0];

2356 
fs_btm
->
öãr_võw_Êag
 = 
fs
->inter_view_flag[1];

2359 
fs_t›
->
chroma_f‹m©_idc
 = 
fs_btm
->chroma_f‹m©_id¯
‰ame
->chroma_format_idc;

2360 
fs_t›
->
iCodögTy≥
 = 
fs_btm
->iCodögTy≥ = 
‰ame
->iCodingType;

2361 if(
‰ame
->
u£d_f‹_ª„ªn˚
)

2363 
	`∑d_dec_pi˘uª
(
p_Vid
, 
fs_t›
);

2364 
	`∑d_dec_pi˘uª
(
p_Vid
, 
fs_btm
);

2369 
fs
->
t›_fõld
 = 
NULL
;

2370 
fs
->
bŸtom_fõld
 = 
NULL
;

2371 
‰ame
->
t›_fõld
 = 
NULL
;

2372 
‰ame
->
bŸtom_fõld
 = 
NULL
;

2373 
‰ame
->frame = frame;

2376 i‡(!
‰ame
->
‰ame_mbs_⁄ly_Êag
)

2378 i‡(
‰ame
->
mb_aff_‰ame_Êag
)

2380 
PicMŸi⁄P¨amsOld
 *
‰m_mŸi⁄
 = &
‰ame
->
mŸi⁄
;

2381 
j
=0 ; j< (
‰ame
->
size_y
 >> 3); j++)

2383 
jj
 = (
j
 >> 2)*8 + (j & 0x03);

2384 
jj4
 = 
jj
 + 4;

2385 
jdiv
 = (
j
 >> 1);

2386 
i
=0 ; i < (
‰ame
->
size_x
>>2); i++)

2388 
idiv
 = (
i
 >> 2);

2390 
cuºítmb
 = 
twosz16
*(
jdiv
 >> 1)+ (
idiv
)*2 + (jdiv & 0x01);

2392 i‡(
‰m_mŸi⁄
->
mb_fõld
[
cuºítmb
])

2394 
fs_btm
->
mv_öfo
[
j
][
i
].
mv
[
LIST_0
] = 
‰ame
->mv_öfo[
jj4
][i].mv[LIST_0];

2395 
fs_btm
->
mv_öfo
[
j
][
i
].
mv
[
LIST_1
] = 
‰ame
->mv_öfo[
jj4
][i].mv[LIST_1];

2396 
fs_btm
->
mv_öfo
[
j
][
i
].
ªf_idx
[
LIST_0
] = 
‰ame
->mv_öfo[
jj4
][i].ref_idx[LIST_0];

2397 if(
fs_btm
->
mv_öfo
[
j
][
i
].
ªf_idx
[
LIST_0
] >=0)

2398 
fs_btm
->
mv_öfo
[
j
][
i
].
ªf_pic
[
LIST_0
] = 
p_Vid
->
µSli˚Li°
[
‰ame
->mv_öfo[
jj4
][i].
¶i˚_no
]->
li°X
[4][(Ëfs_btm->mv_öfo[j][i].
ªf_idx
[LIST_0]];

2400 
fs_btm
->
mv_öfo
[
j
][
i
].
ªf_pic
[
LIST_0
] = 
NULL
;

2401 
fs_btm
->
mv_öfo
[
j
][
i
].
ªf_idx
[
LIST_1
] = 
‰ame
->mv_öfo[
jj4
][i].ref_idx[LIST_1];

2402 if(
fs_btm
->
mv_öfo
[
j
][
i
].
ªf_idx
[
LIST_1
] >=0)

2403 
fs_btm
->
mv_öfo
[
j
][
i
].
ªf_pic
[
LIST_1
] = 
p_Vid
->
µSli˚Li°
[
‰ame
->mv_öfo[
jj4
][i].
¶i˚_no
]->
li°X
[5][(Ëfs_btm->mv_öfo[j][i].
ªf_idx
[LIST_1]];

2405 
fs_btm
->
mv_öfo
[
j
][
i
].
ªf_pic
[
LIST_1
] = 
NULL
;

2407 
fs_t›
->
mv_öfo
[
j
][
i
].
mv
[
LIST_0
] = 
‰ame
->mv_öfo[
jj
][i].mv[LIST_0];

2408 
fs_t›
->
mv_öfo
[
j
][
i
].
mv
[
LIST_1
] = 
‰ame
->mv_öfo[
jj
][i].mv[LIST_1];

2409 
fs_t›
->
mv_öfo
[
j
][
i
].
ªf_idx
[
LIST_0
] = 
‰ame
->mv_öfo[
jj
][i].ref_idx[LIST_0];

2410 if(
fs_t›
->
mv_öfo
[
j
][
i
].
ªf_idx
[
LIST_0
] >=0)

2411 
fs_t›
->
mv_öfo
[
j
][
i
].
ªf_pic
[
LIST_0
] = 
p_Vid
->
µSli˚Li°
[
‰ame
->mv_öfo[
jj
][i].
¶i˚_no
]->
li°X
[2][(Ëfs_t›->mv_öfo[j][i].
ªf_idx
[LIST_0]];

2413 
fs_t›
->
mv_öfo
[
j
][
i
].
ªf_pic
[
LIST_0
] = 
NULL
;

2414 
fs_t›
->
mv_öfo
[
j
][
i
].
ªf_idx
[
LIST_1
] = 
‰ame
->mv_öfo[
jj
][i].ref_idx[LIST_1];

2415 if(
fs_t›
->
mv_öfo
[
j
][
i
].
ªf_idx
[
LIST_1
] >=0)

2416 
fs_t›
->
mv_öfo
[
j
][
i
].
ªf_pic
[
LIST_1
] = 
p_Vid
->
µSli˚Li°
[
‰ame
->mv_öfo[
jj
][i].
¶i˚_no
]->
li°X
[3][(Ëfs_t›->mv_öfo[j][i].
ªf_idx
[LIST_1]];

2418 
fs_t›
->
mv_öfo
[
j
][
i
].
ªf_pic
[
LIST_1
] = 
NULL
;

2425 
j
=0 ; j < (
‰ame
->
size_y
 >> 3) ; j++)

2427 
jj
 = 2* 
	`RSD
(
j
);

2428 
jdiv
 = (
j
 >> 1);

2429 
i
=0 ; i < (
‰ame
->
size_x
 >> 2) ; i++)

2431 
ii
 = 
	`RSD
(
i
);

2432 
idiv
 = (
i
 >> 2);

2434 
cuºítmb
 = 
twosz16
 * (
jdiv
 >> 1)+ (
idiv
)*2 + (jdiv & 0x01);

2436 i‡(!
‰ame
->
mb_aff_‰ame_Êag
 || !‰ame->
mŸi⁄
.
mb_fõld
[
cuºítmb
])

2438 
fs_t›
->
mv_öfo
[
j
][
i
].
mv
[
LIST_0
] = 
fs_btm
->mv_öfo[j][i].mv[LIST_0] = 
‰ame
->mv_öfo[
jj
][
ii
].mv[LIST_0];

2439 
fs_t›
->
mv_öfo
[
j
][
i
].
mv
[
LIST_1
] = 
fs_btm
->mv_öfo[j][i].mv[LIST_1] = 
‰ame
->mv_öfo[
jj
][
ii
].mv[LIST_1];

2442 i‡(
‰ame
->
mv_öfo
[
jj
][
ii
].
ªf_idx
[
LIST_0
] == -1)

2444 
fs_t›
->
mv_öfo
[
j
][
i
].
ªf_idx
[
LIST_0
] = 
fs_btm
->mv_info[j][i].ref_idx[LIST_0] = - 1;

2445 
fs_t›
->
mv_öfo
[
j
][
i
].
ªf_pic
[
LIST_0
] = 
fs_btm
->mv_öfo[j][i].ªf_pic[LIST_0] = 
NULL
;

2449 
fs_t›
->
mv_öfo
[
j
][
i
].
ªf_idx
[
LIST_0
] = 
fs_btm
->mv_öfo[j][i].ªf_idx[LIST_0] = 
‰ame
->mv_öfo[
jj
][
ii
].ref_idx[LIST_0];

2450 
fs_t›
->
mv_öfo
[
j
][
i
].
ªf_pic
[
LIST_0
] = 
fs_btm
->mv_öfo[j][i].ªf_pic[LIST_0] = 
p_Vid
->
µSli˚Li°
[
‰ame
->mv_öfo[
jj
][
ii
].
¶i˚_no
]->
li°X
[LIST_0][(Ë‰ame->mv_öfo[jj][ii].
ªf_idx
[LIST_0]];

2453 i‡(
‰ame
->
mv_öfo
[
jj
][
ii
].
ªf_idx
[
LIST_1
] == -1)

2455 
fs_t›
->
mv_öfo
[
j
][
i
].
ªf_idx
[
LIST_1
] = 
fs_btm
->mv_info[j][i].ref_idx[LIST_1] = - 1;

2456 
fs_t›
->
mv_öfo
[
j
][
i
].
ªf_pic
[
LIST_1
] = 
fs_btm
->mv_öfo[j][i].ªf_pic[LIST_1] = 
NULL
;

2460 
fs_t›
->
mv_öfo
[
j
][
i
].
ªf_idx
[
LIST_1
] = 
fs_btm
->mv_öfo[j][i].ªf_idx[LIST_1] = 
‰ame
->mv_öfo[
jj
][
ii
].ref_idx[LIST_1];

2461 
fs_t›
->
mv_öfo
[
j
][
i
].
ªf_pic
[
LIST_1
] = 
fs_btm
->mv_öfo[j][i].ªf_pic[LIST_1] = 
p_Vid
->
µSli˚Li°
[
‰ame
->mv_öfo[
jj
][
ii
].
¶i˚_no
]->
li°X
[LIST_1][(Ë‰ame->mv_öfo[jj][ii].
ªf_idx
[LIST_1]];

2467 
	}
}

2477 
	$dpb_comböe_fõld_yuv
(
VideoP¨amëîs
 *
p_Vid
, 
FømeSt‹e
 *
fs
)

2479 
i
, 
j
;

2481 i‡(!
fs
->
‰ame
)

2483 
fs
->
‰ame
 = 
	`Æloc_°‹abÀ_pi˘uª
(
p_Vid
, 
FRAME
, fs->
t›_fõld
->
size_x
, fs->t›_fõld->
size_y
*2, fs->t›_fõld->
size_x_¸
, fs->t›_fõld->
size_y_¸
*2, 1);

2486 
i
=0; i<
fs
->
t›_fõld
->
size_y
; i++)

2488 
	`mem˝y
(
fs
->
‰ame
->
imgY
[
i
*2], fs->
t›_fõld
->imgY[i] , fs->t›_fõld->
size_x
 * (
img≥l
));

2489 
	`mem˝y
(
fs
->
‰ame
->
imgY
[
i
*2 + 1], fs->
bŸtom_fõld
->imgY[i], fs->bŸtom_fõld->
size_x
 * (
img≥l
));

2492 
j
 = 0; j < 2; j++)

2494 
i
=0; i<
fs
->
t›_fõld
->
size_y_¸
; i++)

2496 
	`mem˝y
(
fs
->
‰ame
->
imgUV
[
j
][
i
*2], fs->
t›_fõld
->imgUV[j][i], fs->t›_fõld->
size_x_¸
*(
img≥l
));

2497 
	`mem˝y
(
fs
->
‰ame
->
imgUV
[
j
][
i
*2 + 1], fs->
bŸtom_fõld
->imgUV[j][i], fs->bŸtom_fõld->
size_x_¸
*(
img≥l
));

2500 
fs
->
poc
=fs->
‰ame
->po¯=fs->‰ame->
‰ame_poc
 = 
	`imö
 (fs->
t›_fõld
->poc, fs->
bŸtom_fõld
->poc);

2502 
fs
->
bŸtom_fõld
->
‰ame_poc
=fs->
t›_fõld
->‰ame_poc=fs->
‰ame
->
poc
;

2504 
fs
->
bŸtom_fõld
->
t›_poc
=fs->
‰ame
->t›_poc=fs->
t›_fõld
->
poc
;

2505 
fs
->
t›_fõld
->
bŸtom_poc
=fs->
‰ame
->bŸtom_poc=fs->
bŸtom_fõld
->
poc
;

2507 
fs
->
‰ame
->
u£d_f‹_ª„ªn˚
 = (fs->
t›_fõld
->u£d_f‹_ª„ªn˚ && fs->
bŸtom_fõld
->used_for_reference );

2508 
fs
->
‰ame
->
is_l⁄g_ãrm
 = (fs->
t›_fõld
->is_l⁄g_ãrm && fs->
bŸtom_fõld
->is_long_term );

2510 i‡(
fs
->
‰ame
->
is_l⁄g_ãrm
)

2511 
fs
->
‰ame
->
l⁄g_ãrm_‰ame_idx
 = fs->long_term_frame_idx;

2513 
fs
->
‰ame
->
t›_fõld
 = fs->top_field;

2514 
fs
->
‰ame
->
bŸtom_fõld
 = fs->bottom_field;

2515 
fs
->
‰ame
->frame = fs->frame;

2517 
fs
->
‰ame
->
coded_‰ame
 = 0;

2519 
fs
->
‰ame
->
chroma_f‹m©_idc
 = fs->
t›_fõld
->chroma_format_idc;

2520 
fs
->
‰ame
->
‰ame_¸›pög_Êag
 = fs->
t›_fõld
->frame_cropping_flag;

2521 i‡(
fs
->
‰ame
->
‰ame_¸›pög_Êag
)

2523 
fs
->
‰ame
->
‰ame_¸›_t›_off£t
 = fs->
t›_fõld
->frame_crop_top_offset;

2524 
fs
->
‰ame
->
‰ame_¸›_bŸtom_off£t
 = fs->
t›_fõld
->frame_crop_bottom_offset;

2525 
fs
->
‰ame
->
‰ame_¸›_À·_off£t
 = fs->
t›_fõld
->frame_crop_left_offset;

2526 
fs
->
‰ame
->
‰ame_¸›_right_off£t
 = fs->
t›_fõld
->frame_crop_right_offset;

2529 
fs
->
t›_fõld
->
‰ame
 = fs->
bŸtom_fõld
->frame = fs->frame;

2530 
fs
->
t›_fõld
->top_field = fs->top_field;

2531 
fs
->
t›_fõld
->
bŸtom_fõld
 = fs->bottom_field;

2532 
fs
->
bŸtom_fõld
->
t›_fõld
 = fs->top_field;

2533 
fs
->
bŸtom_fõld
->bottom_field = fs->bottom_field;

2534 if(
fs
->
t›_fõld
->
u£d_f‹_ª„ªn˚
 || fs->
bŸtom_fõld
->used_for_reference)

2536 
	`∑d_dec_pi˘uª
(
p_Vid
, 
fs
->
‰ame
);

2539 
	}
}

2548 
	$dpb_comböe_fõld
(
VideoP¨amëîs
 *
p_Vid
, 
FømeSt‹e
 *
fs
)

2550 
i
,
j
, 
jj
, 
jj4
, 
k
, 
l
;

2552 
	`dpb_comböe_fõld_yuv
(
p_Vid
, 
fs
);

2554 #i‡(
MVC_EXTENSION_ENABLE
)

2555 
fs
->
‰ame
->
võw_id
 = fs->view_id;

2557 
fs
->
‰ame
->
iCodögTy≥
 = fs->
t›_fõld
->iCodingType;

2562 
j
=0 ; j < (
fs
->
t›_fõld
->
size_y
 >> 2) ; j++)

2564 
jj
 = (
j
<<1);

2565 
jj4
 = 
jj
 + 1;

2566 
i
=0 ; i< (
fs
->
t›_fõld
->
size_x
 >> 2) ; i++)

2568 
fs
->
‰ame
->
mv_öfo
[
jj
][
i
].
mv
[
LIST_0
] = fs->
t›_fõld
->mv_öfo[
j
][i].mv[LIST_0];

2569 
fs
->
‰ame
->
mv_öfo
[
jj
][
i
].
mv
[
LIST_1
] = fs->
t›_fõld
->mv_öfo[
j
][i].mv[LIST_1];

2571 
fs
->
‰ame
->
mv_öfo
[
jj
][
i
].
ªf_idx
[
LIST_0
] = fs->
t›_fõld
->mv_öfo[
j
][i].ref_idx[LIST_0];

2572 
fs
->
‰ame
->
mv_öfo
[
jj
][
i
].
ªf_idx
[
LIST_1
] = fs->
t›_fõld
->mv_öfo[
j
][i].ref_idx[LIST_1];

2575 
l
 = 
fs
->
t›_fõld
->
mv_öfo
[
j
][
i
].
¶i˚_no
;

2576 
k
 = 
fs
->
t›_fõld
->
mv_öfo
[
j
][
i
].
ªf_idx
[
LIST_0
];

2577 
fs
->
‰ame
->
mv_öfo
[
jj
][
i
].
ªf_pic
[
LIST_0
] = 
k
>=0? fs->
t›_fõld
->
li°X
[
l
][LIST_0][k]: 
NULL
;

2578 
k
 = 
fs
->
t›_fõld
->
mv_öfo
[
j
][
i
].
ªf_idx
[
LIST_1
];

2579 
fs
->
‰ame
->
mv_öfo
[
jj
][
i
].
ªf_pic
[
LIST_1
] = 
k
>=0? fs->
t›_fõld
->
li°X
[
l
][LIST_1][k]: 
NULL
;

2582 
fs
->
‰ame
->
mv_öfo
[
jj4
][
i
].
mv
[
LIST_0
] = fs->
bŸtom_fõld
->mv_öfo[
j
][i].mv[LIST_0];

2583 
fs
->
‰ame
->
mv_öfo
[
jj4
][
i
].
mv
[
LIST_1
] = fs->
bŸtom_fõld
->mv_öfo[
j
][i].mv[LIST_1];

2585 
fs
->
‰ame
->
mv_öfo
[
jj4
][
i
].
ªf_idx
[
LIST_0
] = fs->
bŸtom_fõld
->mv_öfo[
j
][i].ref_idx[LIST_0];

2586 
fs
->
‰ame
->
mv_öfo
[
jj4
][
i
].
ªf_idx
[
LIST_1
] = fs->
bŸtom_fõld
->mv_öfo[
j
][i].ref_idx[LIST_1];

2587 
l
 = 
fs
->
bŸtom_fõld
->
mv_öfo
[
j
][
i
].
¶i˚_no
;

2589 
k
 = 
fs
->
bŸtom_fõld
->
mv_öfo
[
j
][
i
].
ªf_idx
[
LIST_0
];

2590 
fs
->
‰ame
->
mv_öfo
[
jj4
][
i
].
ªf_pic
[
LIST_0
] = 
k
>=0? fs->
bŸtom_fõld
->
li°X
[
l
][LIST_0][k]: 
NULL
;

2591 
k
 = 
fs
->
bŸtom_fõld
->
mv_öfo
[
j
][
i
].
ªf_idx
[
LIST_1
];

2592 
fs
->
‰ame
->
mv_öfo
[
jj4
][
i
].
ªf_pic
[
LIST_1
] = 
k
>=0? fs->
bŸtom_fõld
->
li°X
[
l
][LIST_1][k]: 
NULL
;

2595 
	}
}

2604 
	$Æloc_ªf_pic_li°_ª‹dîög_buf„r
(
Sli˚
 *
cuºSli˚
)

2606 i‡(
cuºSli˚
->
¶i˚_ty≥
 !
I_SLICE
 && cuºSli˚->¶i˚_ty≥ !
SI_SLICE
)

2608 
size
 = 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
] + 1;

2609 i‡((
cuºSli˚
->
modifiˇti⁄_of_pic_nums_idc
[
LIST_0
] = 
	`ˇŒoc
(
size
 ,()))==
NULL
)

2610 
	`no_mem_exô
("alloc_ref_pic_list_reordering_buffer: modification_of_pic_nums_idc_l0");

2611 i‡((
cuºSli˚
->
abs_diff_pic_num_möus1
[
LIST_0
] = 
	`ˇŒoc
(
size
,()))==
NULL
)

2612 
	`no_mem_exô
("alloc_ref_pic_list_reordering_buffer:ábs_diff_pic_num_minus1_l0");

2613 i‡((
cuºSli˚
->
l⁄g_ãrm_pic_idx
[
LIST_0
] = 
	`ˇŒoc
(
size
,()))==
NULL
)

2614 
	`no_mem_exô
("alloc_ref_pic_list_reordering_buffer:Üong_term_pic_idx_l0");

2615 #i‡(
MVC_EXTENSION_ENABLE
)

2616 i‡((
cuºSli˚
->
abs_diff_võw_idx_möus1
[
LIST_0
] = 
	`ˇŒoc
(
size
,()))==
NULL
)

2617 
	`no_mem_exô
("alloc_ref_pic_list_reordering_buffer:ábs_diff_view_idx_minus1_l0");

2622 
cuºSli˚
->
modifiˇti⁄_of_pic_nums_idc
[
LIST_0
] = 
NULL
;

2623 
cuºSli˚
->
abs_diff_pic_num_möus1
[
LIST_0
] = 
NULL
;

2624 
cuºSli˚
->
l⁄g_ãrm_pic_idx
[
LIST_0
] = 
NULL
;

2625 #i‡(
MVC_EXTENSION_ENABLE
)

2626 
cuºSli˚
->
abs_diff_võw_idx_möus1
[
LIST_0
] = 
NULL
;

2630 i‡(
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
)

2632 
size
 = 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_1
] + 1;

2633 i‡((
cuºSli˚
->
modifiˇti⁄_of_pic_nums_idc
[
LIST_1
] = 
	`ˇŒoc
(
size
,()))==
NULL
)

2634 
	`no_mem_exô
("alloc_ref_pic_list_reordering_buffer: modification_of_pic_nums_idc_l1");

2635 i‡((
cuºSli˚
->
abs_diff_pic_num_möus1
[
LIST_1
] = 
	`ˇŒoc
(
size
,()))==
NULL
)

2636 
	`no_mem_exô
("alloc_ref_pic_list_reordering_buffer:ábs_diff_pic_num_minus1_l1");

2637 i‡((
cuºSli˚
->
l⁄g_ãrm_pic_idx
[
LIST_1
] = 
	`ˇŒoc
(
size
,()))==
NULL
)

2638 
	`no_mem_exô
("alloc_ref_pic_list_reordering_buffer:Üong_term_pic_idx_l1");

2639 #i‡(
MVC_EXTENSION_ENABLE
)

2640 i‡((
cuºSli˚
->
abs_diff_võw_idx_möus1
[
LIST_1
] = 
	`ˇŒoc
(
size
,()))==
NULL
)

2641 
	`no_mem_exô
("alloc_ref_pic_list_reordering_buffer:ábs_diff_view_idx_minus1_l1");

2646 
cuºSli˚
->
modifiˇti⁄_of_pic_nums_idc
[
LIST_1
] = 
NULL
;

2647 
cuºSli˚
->
abs_diff_pic_num_möus1
[
LIST_1
] = 
NULL
;

2648 
cuºSli˚
->
l⁄g_ãrm_pic_idx
[
LIST_1
] = 
NULL
;

2649 #i‡(
MVC_EXTENSION_ENABLE
)

2650 
cuºSli˚
->
abs_diff_võw_idx_möus1
[
LIST_1
] = 
NULL
;

2653 
	}
}

2662 
	$‰ì_ªf_pic_li°_ª‹dîög_buf„r
(
Sli˚
 *
cuºSli˚
)

2664 i‡(
cuºSli˚
->
modifiˇti⁄_of_pic_nums_idc
[
LIST_0
])

2665 
	`‰ì
(
cuºSli˚
->
modifiˇti⁄_of_pic_nums_idc
[
LIST_0
]);

2666 i‡(
cuºSli˚
->
abs_diff_pic_num_möus1
[
LIST_0
])

2667 
	`‰ì
(
cuºSli˚
->
abs_diff_pic_num_möus1
[
LIST_0
]);

2668 i‡(
cuºSli˚
->
l⁄g_ãrm_pic_idx
[
LIST_0
])

2669 
	`‰ì
(
cuºSli˚
->
l⁄g_ãrm_pic_idx
[
LIST_0
]);

2671 
cuºSli˚
->
modifiˇti⁄_of_pic_nums_idc
[
LIST_0
] = 
NULL
;

2672 
cuºSli˚
->
abs_diff_pic_num_möus1
[
LIST_0
] = 
NULL
;

2673 
cuºSli˚
->
l⁄g_ãrm_pic_idx
[
LIST_0
] = 
NULL
;

2675 i‡(
cuºSli˚
->
modifiˇti⁄_of_pic_nums_idc
[
LIST_1
])

2676 
	`‰ì
(
cuºSli˚
->
modifiˇti⁄_of_pic_nums_idc
[
LIST_1
]);

2677 i‡(
cuºSli˚
->
abs_diff_pic_num_möus1
[
LIST_1
])

2678 
	`‰ì
(
cuºSli˚
->
abs_diff_pic_num_möus1
[
LIST_1
]);

2679 i‡(
cuºSli˚
->
l⁄g_ãrm_pic_idx
[
LIST_1
])

2680 
	`‰ì
(
cuºSli˚
->
l⁄g_ãrm_pic_idx
[
LIST_1
]);

2682 
cuºSli˚
->
modifiˇti⁄_of_pic_nums_idc
[
LIST_1
] = 
NULL
;

2683 
cuºSli˚
->
abs_diff_pic_num_möus1
[
LIST_1
] = 
NULL
;

2684 
cuºSli˚
->
l⁄g_ãrm_pic_idx
[
LIST_1
] = 
NULL
;

2686 #i‡(
MVC_EXTENSION_ENABLE
)

2687 i‡(
cuºSli˚
->
abs_diff_võw_idx_möus1
[
LIST_0
])

2688 
	`‰ì
(
cuºSli˚
->
abs_diff_võw_idx_möus1
[
LIST_0
]);

2689 
cuºSli˚
->
abs_diff_võw_idx_möus1
[
LIST_0
] = 
NULL
;

2690 i‡(
cuºSli˚
->
abs_diff_võw_idx_möus1
[
LIST_1
])

2691 
	`‰ì
(
cuºSli˚
->
abs_diff_võw_idx_möus1
[
LIST_1
]);

2692 
cuºSli˚
->
abs_diff_võw_idx_möus1
[
LIST_1
] = 
NULL
;

2694 
	}
}

2708 
	$fûl_‰ame_num_g≠
(
VideoP¨amëîs
 *
p_Vid
, 
Sli˚
 *
cuºSli˚
)

2710 
£q_∑ømëî_£t_rb•_t
 *
a˘ive_•s
 = 
p_Vid
->active_sps;

2712 
CuºFømeNum
;

2713 
Unu£dSh‹tTîmFømeNum
;

2714 
St‹abÀPi˘uª
 *
pi˘uª
 = 
NULL
;

2715 
tmp1
 = 
cuºSli˚
->
dñè_pic_‹dî_˙t
[0];

2716 
tmp2
 = 
cuºSli˚
->
dñè_pic_‹dî_˙t
[1];

2717 
cuºSli˚
->
dñè_pic_‹dî_˙t
[0] = currSlice->delta_pic_order_cnt[1] = 0;

2719 
	`¥ötf
("A gap in frameÇumber is found,ÅryÅo fill it.\n");

2721 
Unu£dSh‹tTîmFømeNum
 = (
p_Vid
->
¥e_‰ame_num
 + 1Ë%Ö_Vid->
max_‰ame_num
;

2722 
CuºFømeNum
 = 
cuºSli˚
->
‰ame_num
;

2724 
CuºFømeNum
 !
Unu£dSh‹tTîmFømeNum
)

2726 
pi˘uª
 = 
	`Æloc_°‹abÀ_pi˘uª
 (
p_Vid
, 
FRAME
,Ö_Vid->
width
,Ö_Vid->
height
,Ö_Vid->
width_¸
,Ö_Vid->
height_¸
, 1);

2727 
pi˘uª
->
coded_‰ame
 = 1;

2728 
pi˘uª
->
pic_num
 = 
Unu£dSh‹tTîmFømeNum
;

2729 
pi˘uª
->
‰ame_num
 = 
Unu£dSh‹tTîmFømeNum
;

2730 
pi˘uª
->
n⁄_exi°ög
 = 1;

2731 
pi˘uª
->
is_ouçut
 = 1;

2732 
pi˘uª
->
u£d_f‹_ª„ªn˚
 = 1;

2733 
pi˘uª
->
ad≠tive_ªf_pic_buf„rög_Êag
 = 0;

2734 #i‡(
MVC_EXTENSION_ENABLE
)

2735 
pi˘uª
->
võw_id
 = 
cuºSli˚
->view_id;

2738 
cuºSli˚
->
‰ame_num
 = 
Unu£dSh‹tTîmFømeNum
;

2739 i‡(
a˘ive_•s
->
pic_‹dî_˙t_ty≥
!=0)

2741 
	`decode_poc
(
p_Vid
,Ö_Vid->
µSli˚Li°
[0]);

2743 
pi˘uª
->
t›_poc
 = 
cuºSli˚
->
t›poc
;

2744 
pi˘uª
->
bŸtom_poc
 = 
cuºSli˚
->
bŸtompoc
;

2745 
pi˘uª
->
‰ame_poc
 = 
cuºSli˚
->
‰amïoc
;

2746 
pi˘uª
->
poc
 = 
cuºSli˚
->
‰amïoc
;

2748 
	`°‹e_pi˘uª_ö_dpb
(
cuºSli˚
->
p_Dpb
, 
pi˘uª
);

2750 
pi˘uª
=
NULL
;

2751 
p_Vid
->
¥e_‰ame_num
 = 
Unu£dSh‹tTîmFømeNum
;

2752 
Unu£dSh‹tTîmFømeNum
 = (Unu£dSh‹tTîmFømeNum + 1Ë% 
p_Vid
->
max_‰ame_num
;

2754 
cuºSli˚
->
dñè_pic_‹dî_˙t
[0] = 
tmp1
;

2755 
cuºSli˚
->
dñè_pic_‹dî_˙t
[1] = 
tmp2
;

2756 
cuºSli˚
->
‰ame_num
 = 
CuºFømeNum
;

2757 
	}
}

2767 
	$compuã_cﬁoˇãd
 (
Sli˚
 *
cuºSli˚
, 
St‹abÀPi˘uª
 **
li°X
[6])

2769 
i
, 
j
;

2771 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

2773 i‡(
cuºSli˚
->
dúe˘_•©ül_mv_¥ed_Êag
 == 0)

2775 
j
 = 0; j < 2 + (
cuºSli˚
->
mb_aff_‰ame_Êag
 * 4); j += 2)

2777 
i
 = 0; i < 
cuºSli˚
->
li°Xsize
[
j
];i++)

2779 
¥esˇÀ
, 
iTRb
, 
iTRp
;

2781 i‡(
j
==0)

2783 
iTRb
 = 
	`iClù3
–-128, 127, 
p_Vid
->
dec_pi˘uª
->
poc
 - 
li°X
[
LIST_0
 + 
j
][
i
]->poc );

2785 i‡(
j
 == 2)

2787 
iTRb
 = 
	`iClù3
–-128, 127, 
p_Vid
->
dec_pi˘uª
->
t›_poc
 - 
li°X
[
LIST_0
 + 
j
][
i
]->
poc
 );

2791 
iTRb
 = 
	`iClù3
–-128, 127, 
p_Vid
->
dec_pi˘uª
->
bŸtom_poc
 - 
li°X
[
LIST_0
 + 
j
][
i
]->
poc
 );

2794 
iTRp
 = 
	`iClù3
–-128, 127, 
li°X
[
LIST_1
 + 
j
][0]->
poc
 -Üi°X[
LIST_0
 + j][
i
]->poc);

2796 i‡(
iTRp
!=0)

2798 
¥esˇÀ
 = ( 16384 + 
	`übs
–
iTRp
 / 2 ) ) / iTRp;

2799 
cuºSli˚
->
mvsˇÀ
[
j
][
i
] = 
	`iClù3
–-1024, 1023, ( 
iTRb
 * 
¥esˇÀ
 + 32 ) >> 6 ) ;

2803 
cuºSli˚
->
mvsˇÀ
[
j
][
i
] = 9999;

2808 
	}
}

2811 #i‡(
MVC_EXTENSION_ENABLE
)

2812 
	$GëMaxDecFømeBuf„rög
(
VideoP¨amëîs
 *
p_Vid
)

2814 
i
, 
j
, 
iMax
, 
iMax_1
 = 0, 
iMax_2
 = 0;

2815 
sub£t_£q_∑ømëî_£t_rb•_t
 *
cuº_sub£t_•s
;

2816 
£q_∑ømëî_£t_rb•_t
 *
cuº_•s
;

2818 
cuº_sub£t_•s
 = 
p_Vid
->
Sub£tSeqP¨Së
;

2819 
cuº_•s
 = 
p_Vid
->
SeqP¨Së
;

2820 
i
=0; i<
MAXSPS
; i++)

2822 if(
cuº_sub£t_•s
->
VÆid
 && cuº_sub£t_•s->
•s
.
£q_∑ømëî_£t_id
 < 
MAXSPS
)

2824 
j
 = 
cuº_sub£t_•s
->
•s
.
max_dec_‰ame_buf„rög
;

2826 i‡(
cuº_sub£t_•s
->
•s
.
vui_∑ømëîs_¥e£¡_Êag
 && cuº_sub£t_•s->•s.
vui_£q_∑ømëîs
.
bô°ªam_ª°ri˘i⁄_Êag
)

2828 i‡(()
cuº_sub£t_•s
->
•s
.
vui_£q_∑ømëîs
.
max_dec_‰ame_buf„rög
 > 
j
)

2830 
	`îr‹
 ("max_dec_frame_bufferingÜargerÅhan MaxDpbSize", 500);

2832 
j
 = 
	`imax
 (1, 
cuº_sub£t_•s
->
•s
.
vui_£q_∑ømëîs
.
max_dec_‰ame_buf„rög
);

2835 if(
j
 > 
iMax_2
)

2836 
iMax_2
 = 
j
;

2839 if(
cuº_•s
->
VÆid
)

2841 
j
 = 
cuº_•s
->
max_dec_‰ame_buf„rög
;

2843 i‡(
cuº_•s
->
vui_∑ømëîs_¥e£¡_Êag
 && cuº_•s->
vui_£q_∑ømëîs
.
bô°ªam_ª°ri˘i⁄_Êag
)

2845 i‡(()
cuº_•s
->
vui_£q_∑ømëîs
.
max_dec_‰ame_buf„rög
 > 
j
)

2847 
	`îr‹
 ("max_dec_frame_bufferingÜargerÅhan MaxDpbSize", 500);

2849 
j
 = 
	`imax
 (1, 
cuº_•s
->
vui_£q_∑ømëîs
.
max_dec_‰ame_buf„rög
);

2852 if(
j
 > 
iMax_1
)

2853 
iMax_1
 = 
j
;

2855 
cuº_sub£t_•s
++;

2856 
cuº_•s
++;

2859 i‡(
iMax_1
 > 0 && 
iMax_2
 > 0)

2860 
iMax
 = 
iMax_1
 + 
iMax_2
;

2862 
iMax
 = (
iMax_1
 >0? iMax_1*2 : 
iMax_2
*2);

2863  
iMax
;

2864 
	}
}

2866 
	$is_võw_id_ö_ªf_võw_li°
(
võw_id
, *
ªf_võw_id
, 
num_ªf_võws
)

2868 
i
;

2869 
i
=0; i<
num_ªf_võws
; i++)

2871 if(
võw_id
 =
ªf_võw_id
[
i
])

2875  (
num_ªf_võws
 && (
i
<num_ref_views));

2876 
	}
}

2878 
	$≠≥nd_öãrvõw_li°
(
DecodedPi˘uªBuf„r
 *
p_Dpb
,

2879 
Pi˘uªSåu˘uª
 
cuºPicSåu˘uª
,

2880 
li°_idx
,

2881 
FømeSt‹e
 **
li°
,

2882 *
li°Xsize
,

2883 
cuºPOC
,

2884 
cuº_võw_id
,

2885 
™ch‹_pic_Êag
)

2887 
VideoP¨amëîs
 *
p_Vid
 = 
p_Dpb
->p_Vid;

2888 
iVOIdx
 = 
cuº_võw_id
;

2889 
pic_avaû
;

2890 
poc
 = 0;

2891 
Êd_idx
;

2892 
num_ªf_võws
, *
ªf_võw_id
;

2893 
FømeSt‹e
 *
fs
 = 
p_Dpb
->
fs_ûªf
[0];

2896 if(
iVOIdx
 <0)

2897 
	`¥ötf
("Eº‹: iVOIdx: %d i†nŸÜes†th™ 0\n", 
iVOIdx
);

2899 if(
™ch‹_pic_Êag
)

2901 
num_ªf_võws
 = 
li°_idx
? 
p_Vid
->
a˘ive_sub£t_•s
->
num_™ch‹_ªfs_l1
[
iVOIdx
] :Ö_Vid->a˘ive_sub£t_•s->
num_™ch‹_ªfs_l0
[iVOIdx];

2902 
ªf_võw_id
 = 
li°_idx
? 
p_Vid
->
a˘ive_sub£t_•s
->
™ch‹_ªf_l1
[
iVOIdx
]:p_Vid->a˘ive_sub£t_•s->
™ch‹_ªf_l0
[iVOIdx];

2906 
num_ªf_võws
 = 
li°_idx
? 
p_Vid
->
a˘ive_sub£t_•s
->
num_n⁄_™ch‹_ªfs_l1
[
iVOIdx
] :Ö_Vid->a˘ive_sub£t_•s->
num_n⁄_™ch‹_ªfs_l0
[iVOIdx];

2907 
ªf_võw_id
 = 
li°_idx
? 
p_Vid
->
a˘ive_sub£t_•s
->
n⁄_™ch‹_ªf_l1
[
iVOIdx
]:p_Vid->a˘ive_sub£t_•s->
n⁄_™ch‹_ªf_l0
[iVOIdx];

2913 if(
cuºPicSåu˘uª
 =
BOTTOM_FIELD
)

2914 
Êd_idx
 = 1;

2916 
Êd_idx
 = 0;

2918 if(
cuºPicSåu˘uª
==
FRAME
)

2920 
pic_avaû
 = (
fs
->
is_u£d
 == 3);

2921 i‡(
pic_avaû
)

2922 
poc
 = 
fs
->
‰ame
->poc;

2924 if(
cuºPicSåu˘uª
==
TOP_FIELD
)

2926 
pic_avaû
 = 
fs
->
is_u£d
 & 1;

2927 i‡(
pic_avaû
)

2928 
poc
 = 
fs
->
t›_fõld
->poc;

2930 if(
cuºPicSåu˘uª
==
BOTTOM_FIELD
)

2932 
pic_avaû
 = 
fs
->
is_u£d
 & 2;

2933 i‡(
pic_avaû
)

2934 
poc
 = 
fs
->
bŸtom_fõld
->poc;

2937 
pic_avaû
 =0;

2939 if(
pic_avaû
 && 
fs
->
öãr_võw_Êag
[
Êd_idx
])

2941 if(
poc
 =
cuºPOC
)

2943 if(
	`is_võw_id_ö_ªf_võw_li°
(
fs
->
võw_id
, 
ªf_võw_id
, 
num_ªf_võws
))

2946 
li°
[*
li°Xsize
] = 
fs
;

2948 (*
li°Xsize
)++;

2952 
	}
}

2956 
	$¥o˚ss_pi˘uª_ö_dpb_s
(
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
p_pic
)

2959 
ImageD©a
 *
p_img_out
 = &
p_Vid
->
ãmpD©a3
;

2960 
img≥l
*** 
d_img
;

2961 
i
;

2963 if(
p_Vid
->
ãmpD©a3
.
‰m_d©a
[0] =
NULL
)

2964 
	`öô_img_d©a
–
p_Vid
, &’_Vid->
ãmpD©a3
),Ö_Vid->
a˘ive_•s
);

2966 i‡(
p_pic
->
°ru˘uª
 =
FRAME
)

2968 
d_img
 = 
p_img_out
->
‰m_d©a
;

2972 i‡(
p_pic
->
°ru˘uª
 =
TOP_FIELD
)

2974 
d_img
 = 
p_img_out
->
t›_d©a
;

2978 
d_img
 = 
p_img_out
->
bŸ_d©a
;

2982 
i
=0; i<
p_pic
->
size_y
; i++)

2983 
	`mem˝y
(
d_img
[0][
i
], 
p_pic
->
imgY
[i],Ö_pic->
size_x
*(
img≥l
));

2984 i‡(
p_Vid
->
yuv_f‹m©
 !
YUV400
)

2986 
i
=0; i<
p_pic
->
size_y_¸
; i++)

2987 
	`mem˝y
(
d_img
[1][
i
], 
p_pic
->
imgUV
[0][i],Ö_pic->
size_x_¸
 * (
img≥l
));

2988 
i
=0; i<
p_pic
->
size_y_¸
; i++)

2989 
	`mem˝y
(
d_img
[2][
i
], 
p_pic
->
imgUV
[1][i],Ö_pic->
size_x_¸
 * (
img≥l
));

2991 
	}
}

2993 
	$öô_img_d©a
(
VideoP¨amëîs
 *
p_Vid
, 
ImageD©a
 *
p_ImgD©a
, 
£q_∑ømëî_£t_rb•_t
 *
•s
)

2995 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

2996 
mem‹y_size
 = 0;

2997 
≈œ√
;

3000 
p_ImgD©a
->
f‹m©
 = 
p_I≈
->
ouçut
;

3001 
p_ImgD©a
->
f‹m©
.
width
[0] = 
p_Vid
->width;

3002 
p_ImgD©a
->
f‹m©
.
width
[1] = 
p_Vid
->
width_¸
;

3003 
p_ImgD©a
->
f‹m©
.
width
[2] = 
p_Vid
->
width_¸
;

3004 
p_ImgD©a
->
f‹m©
.
height
[0] = 
p_Vid
->height;

3005 
p_ImgD©a
->
f‹m©
.
height
[1] = 
p_Vid
->
height_¸
;

3006 
p_ImgD©a
->
f‹m©
.
height
[2] = 
p_Vid
->
height_¸
;

3007 
p_ImgD©a
->
f‹m©
.
yuv_f‹m©
 = (
Cﬁ‹F‹m©
Ë
•s
->
chroma_f‹m©_idc
;

3008 
p_ImgD©a
->
f‹m©
.
auto_¸›_bŸtom
 = 
p_I≈
->
ouçut
.auto_crop_bottom;

3009 
p_ImgD©a
->
f‹m©
.
auto_¸›_right
 = 
p_I≈
->
ouçut
.auto_crop_right;

3010 
p_ImgD©a
->
f‹m©
.
auto_¸›_bŸtom_¸
 = 
p_I≈
->
ouçut
.auto_crop_bottom_cr;

3011 
p_ImgD©a
->
f‹m©
.
auto_¸›_right_¸
 = 
p_I≈
->
ouçut
.auto_crop_right_cr;

3012 
p_ImgD©a
->
‰m_°ride
[0] = 
p_Vid
->
width
;

3013 
p_ImgD©a
->
‰m_°ride
[1] =Ö_ImgD©a->‰m_°ride[2] = 
p_Vid
->
width_¸
;

3014 
p_ImgD©a
->
t›_°ride
[0] =Ö_ImgD©a->
bŸ_°ride
[0] =Ö_ImgD©a->
‰m_°ride
[0] << 1;

3015 
p_ImgD©a
->
t›_°ride
[1] =Ö_ImgD©a->t›_°ride[2] =Ö_ImgD©a->
bŸ_°ride
[1] =Ö_ImgD©a->bŸ_°ride[2] =Ö_ImgD©a->
‰m_°ride
[1] << 1;

3017 if–
•s
->
£∑øã_cﬁour_∂™e_Êag
 )

3019  
≈œ√
=0;Ç∂™ê< 
MAX_PLANE
;Çplane++ )

3021 
mem‹y_size
 +
	`gë_mem2D≥l
(&(
p_ImgD©a
->
‰m_d©a
[
≈œ√
]), 
p_Vid
->
height
,Ö_Vid->
width
);

3026 
mem‹y_size
 +
	`gë_mem2D≥l
(&(
p_ImgD©a
->
‰m_d©a
[0]), 
p_Vid
->
height
,Ö_Vid->
width
);

3028 i‡(
p_Vid
->
yuv_f‹m©
 !
YUV400
)

3030 
i
, 
j
, 
k
;

3031 
mem‹y_size
 +
	`gë_mem2D≥l
(&(
p_ImgD©a
->
‰m_d©a
[1]), 
p_Vid
->
height_¸
,Ö_Vid->
width_¸
);

3032 
mem‹y_size
 +
	`gë_mem2D≥l
(&(
p_ImgD©a
->
‰m_d©a
[2]), 
p_Vid
->
height_¸
,Ö_Vid->
width_¸
);

3034 i‡((
img≥l
) == ())

3036 
k
 = 1; k < 3; k++)

3037 
	`Á°_mem£t
(
p_ImgD©a
->
‰m_d©a
[
k
][0], 128, 
p_Vid
->
height_¸
 *Ö_Vid->
width_¸
 * (
img≥l
));

3041 
img≥l
 
món_vÆ
;

3043 
k
 = 1; k < 3; k++)

3045 
món_vÆ
 = (
img≥l
Ë((
p_Vid
->
max_≥l_vÆue_comp
[
k
] + 1) >> 1);

3047 
j
 = 0; j < 
p_Vid
->
height_¸
; j++)

3049 
i
 = 0; i < 
p_Vid
->
width_¸
; i++)

3050 
p_ImgD©a
->
‰m_d©a
[
k
][
j
][
i
] = 
món_vÆ
;

3057 i‡(!
p_Vid
->
a˘ive_•s
->
‰ame_mbs_⁄ly_Êag
)

3060 
mem‹y_size
 +
	`öô_t›_bŸ_∂™es
(
p_ImgD©a
->
‰m_d©a
[0], 
p_Vid
->
height
, &’_ImgD©a->
t›_d©a
[0]), &’_ImgD©a->
bŸ_d©a
[0]));

3062 i‡(
p_Vid
->
yuv_f‹m©
 !
YUV400
)

3064 
mem‹y_size
 +4*((
img≥l
**));

3066 
mem‹y_size
 +
	`öô_t›_bŸ_∂™es
(
p_ImgD©a
->
‰m_d©a
[1], 
p_Vid
->
height_¸
, &’_ImgD©a->
t›_d©a
[1]), &’_ImgD©a->
bŸ_d©a
[1]));

3067 
mem‹y_size
 +
	`öô_t›_bŸ_∂™es
(
p_ImgD©a
->
‰m_d©a
[2], 
p_Vid
->
height_¸
, &’_ImgD©a->
t›_d©a
[2]), &’_ImgD©a->
bŸ_d©a
[2]));

3071  
mem‹y_size
;

3072 
	}
}

3074 
	$‰ì_img_d©a
(
VideoP¨amëîs
 *
p_Vid
, 
ImageD©a
 *
p_ImgD©a
)

3076 i‡–
p_Vid
->
£∑øã_cﬁour_∂™e_Êag
 )

3078 
≈œ√
;

3080  
≈œ√
=0;Ç∂™e<
MAX_PLANE
;Çplane++ )

3082 i‡(
p_ImgD©a
->
‰m_d©a
[
≈œ√
])

3084 
	`‰ì_mem2D≥l
(
p_ImgD©a
->
‰m_d©a
[
≈œ√
]);

3085 
p_ImgD©a
->
‰m_d©a
[
≈œ√
] = 
NULL
;

3091 i‡(
p_ImgD©a
->
‰m_d©a
[0])

3093 
	`‰ì_mem2D≥l
(
p_ImgD©a
->
‰m_d©a
[0]);

3094 
p_ImgD©a
->
‰m_d©a
[0] = 
NULL
;

3097 i‡(
p_ImgD©a
->
f‹m©
.
yuv_f‹m©
 !
YUV400
)

3099 i‡(
p_ImgD©a
->
‰m_d©a
[1])

3101 
	`‰ì_mem2D≥l
(
p_ImgD©a
->
‰m_d©a
[1]);

3102 
p_ImgD©a
->
‰m_d©a
[1] = 
NULL
;

3104 i‡(
p_ImgD©a
->
‰m_d©a
[2])

3106 
	`‰ì_mem2D≥l
(
p_ImgD©a
->
‰m_d©a
[2]);

3107 
p_ImgD©a
->
‰m_d©a
[2] = 
NULL
;

3112 i‡(!
p_Vid
->
a˘ive_•s
->
‰ame_mbs_⁄ly_Êag
)

3114 
	`‰ì_t›_bŸ_∂™es
(
p_ImgD©a
->
t›_d©a
[0],Ö_ImgD©a->
bŸ_d©a
[0]);

3116 i‡(
p_ImgD©a
->
f‹m©
.
yuv_f‹m©
 !
YUV400
)

3118 
	`‰ì_t›_bŸ_∂™es
(
p_ImgD©a
->
t›_d©a
[1],Ö_ImgD©a->
bŸ_d©a
[1]);

3119 
	`‰ì_t›_bŸ_∂™es
(
p_ImgD©a
->
t›_d©a
[2],Ö_ImgD©a->
bŸ_d©a
[2]);

3122 
	}
}

3124 
ölöe
 
	$c›y_img_d©a
(
img≥l
 *
out_img
, img≥»*
ö_img
, 
o°ride
, 
i°ride
, 
size_y
, 
size_x
)

3126 
i
;

3127 
i
 = 0; i < 
size_y
; i++)

3129 
	`Á°_mem˝y
(
out_img
, 
ö_img
, 
size_x
);

3130 
out_img
 +
o°ride
;

3131 
ö_img
 +
i°ride
;

3133 
	}
}

3141 #i‡!
MVC_EXTENSION_ENABLE


3142 
	$ªmove_unu£d_¥oc_pic_‰om_dpb
(
DecodedPi˘uªBuf„r
 *
p_Dpb
)

3144 
	`as£π
(!"The function isÇotávailable\n");

3146 
	}
}

3165 #i‡(
MVC_EXTENSION_ENABLE
)

3166 
	$°‹e_¥oc_pi˘uª_ö_dpb
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
St‹abÀPi˘uª
* 
p
)

3168 
VideoP¨amëîs
 *
p_Vid
 = 
p_Dpb
->p_Vid;

3169 
FømeSt‹e
 *
fs
 = 
p_Dpb
->
fs_ûªf
[0];

3170 if(
p_Dpb
->
u£d_size_û
>0 && 
fs
->
is_u£d
==3)

3173 #ifde‡
_DEBUG


3174 if(
p
->
°ru˘uª
==
FRAME
)

3175 
	`as£π
(
fs
->
‰ame
->
‰ame_poc
 !
p
->
poc
);

3176 if(
p
->
°ru˘uª
==
TOP_FIELD
)

3177 
	`as£π
(
fs
->
t›_fõld
->
t›_poc
 !
p
->
poc
);

3178 if(
p
->
°ru˘uª
==
BOTTOM_FIELD
)

3179 
	`as£π
(
fs
->
bŸtom_fõld
->
bŸtom_poc
 !
p
->
poc
);

3181 if(
fs
->
‰ame
)

3183 
	`‰ì_°‹abÀ_pi˘uª
(
fs
->
‰ame
);

3184 
fs
->
‰ame
 = 
NULL
;

3186 if(
fs
->
t›_fõld
)

3188 
	`‰ì_°‹abÀ_pi˘uª
(
fs
->
t›_fõld
);

3189 
fs
->
t›_fõld
 = 
NULL
;

3191 if(
fs
->
bŸtom_fõld
)

3193 
	`‰ì_°‹abÀ_pi˘uª
(
fs
->
bŸtom_fõld
);

3194 
fs
->
bŸtom_fõld
 = 
NULL
;

3196 
fs
->
is_u£d
 = 0;

3197 
fs
->
is_ª„ªn˚
 = 0;

3198 
p_Dpb
->
u£d_size_û
--;

3200 #ifde‡
_DEBUG


3201 if(
fs
->
is_u£d
>0)

3204 if(
p
->
°ru˘uª
==
FRAME
)

3205 
	`as£π
(
fs
->
‰ame
 =
NULL
);

3206 if(
p
->
°ru˘uª
==
TOP_FIELD
)

3207 
	`as£π
(
fs
->
t›_fõld
 =
NULL
);

3208 if(
p
->
°ru˘uª
==
BOTTOM_FIELD
)

3209 
	`as£π
(
fs
->
bŸtom_fõld
 =
NULL
);

3213 
	`ö£π_pi˘uª_ö_dpb
(
p_Vid
, 
fs
, 
p
);

3214 if((
p
->
°ru˘uª
==
FRAME
 && 
fs
->
is_u£d
 == 3) || (p->structure!=FRAME && fs->is_used && fs->is_used <3))

3215 
p_Dpb
->
u£d_size_û
++;

3216 
	}
}

3224 
St‹abÀPi˘uª
 * 
	$˛⁄e_°‹abÀ_pi˘uª
–
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
p_pic
 )

3226 
i
, 
j
;

3227 
≈œ√
;

3228 *
i°ride
 = 
NULL
;

3229 
o°ride
[2];

3230 
img≥l
 ***
img_ö
 = 
NULL
;

3232 
St‹abÀPi˘uª
 *
p_°‹ed_pic
 = 
	`Æloc_°‹abÀ_pi˘uª
 (
p_Vid
, (
Pi˘uªSåu˘uª
Ëp_Vid->
°ru˘uª
,Ö_Vid->
width
,Ö_Vid->
height
,Ö_Vid->
width_¸
,Ö_Vid->
height_¸
, 0);

3234 
p_°‹ed_pic
->
pic_num
 = 
p_pic
->pic_num;

3235 
p_°‹ed_pic
->
‰ame_num
 = 
p_pic
->frame_num;

3236 
p_°‹ed_pic
->
l⁄g_ãrm_‰ame_idx
 = 
p_pic
->long_term_frame_idx;

3237 
p_°‹ed_pic
->
l⁄g_ãrm_pic_num
 = 
p_pic
->long_term_pic_num;

3239 
p_°‹ed_pic
->
is_l⁄g_ãrm
 = 0;

3240 
p_°‹ed_pic
->
n⁄_exi°ög
 = 
p_pic
->non_existing;

3241 
p_°‹ed_pic
->
max_¶i˚_id
 = 
p_pic
->max_slice_id;

3242 
p_°‹ed_pic
->
°ru˘uª
 = 
p_pic
->structure;

3243 
p_°‹ed_pic
->
size_x
 = 
p_pic
->size_x;

3244 
p_°‹ed_pic
->
size_y
 = 
p_pic
->size_y;

3245 
p_°‹ed_pic
->
size_x_¸
 = 
p_pic
->size_x_cr;

3246 
p_°‹ed_pic
->
size_y_¸
 = 
p_pic
->size_y_cr;

3247 
p_°‹ed_pic
->
size_x_m1
 = 
p_pic
->
size_x
 - 1;

3248 
p_°‹ed_pic
->
size_y_m1
 = 
p_pic
->
size_y
 - 1;

3249 
p_°‹ed_pic
->
size_x_¸_m1
 = 
p_pic
->
size_x_¸
 - 1;

3250 
p_°‹ed_pic
->
size_y_¸_m1
 = 
p_pic
->
size_y_¸
 - 1;

3252 
p_°‹ed_pic
->
mb_aff_‰ame_Êag
 = 
p_pic
->mb_aff_frame_flag;

3253 
p_°‹ed_pic
->
£iHasT⁄e_m≠pög
 = 
p_pic
->seiHasTone_mapping;

3254 
p_°‹ed_pic
->
poc
 = 
p_pic
->poc;

3255 
p_°‹ed_pic
->
t›_poc
 = 
p_pic
->top_poc;

3256 
p_°‹ed_pic
->
bŸtom_poc
 = 
p_pic
->bottom_poc;

3257 
p_°‹ed_pic
->
‰ame_poc
 = 
p_pic
->frame_poc;

3258 
p_°‹ed_pic
->
pic_num
 = 
p_pic
->pic_num;

3259 
p_°‹ed_pic
->
‰ame_num
 = 
p_pic
->frame_num;

3260 
p_°‹ed_pic
->
coded_‰ame
 = 1;

3261 
p_°‹ed_pic
->
qp
 = 
p_pic
->qp;

3262 
p_°‹ed_pic
->
¶i˚_qp_dñè
 = 
p_pic
->slice_qp_delta;

3263 
p_°‹ed_pic
->
chroma_qp_off£t
[0] = 
p_pic
->chroma_qp_offset[0];

3264 
p_°‹ed_pic
->
chroma_qp_off£t
[1] = 
p_pic
->chroma_qp_offset[1];

3266 
p_°‹ed_pic
->
¶i˚_ty≥
 = 
p_pic
->slice_type;

3267 
p_°‹ed_pic
->
idr_Êag
 = 
p_pic
->idr_flag;

3268 
p_°‹ed_pic
->
no_ouçut_of_¥i‹_pics_Êag
 = 
p_pic
->no_output_of_prior_pics_flag;

3269 
p_°‹ed_pic
->
l⁄g_ãrm_ª„ªn˚_Êag
 = 0;

3270 
p_°‹ed_pic
->
ad≠tive_ªf_pic_buf„rög_Êag
 = 0;

3271 
p_°‹ed_pic
->
dec_ªf_pic_m¨kög_buf„r
 = 
NULL
;

3272 
p_°‹ed_pic
->
PicWidthInMbs
 = 
p_pic
->PicWidthInMbs;

3273 
p_°‹ed_pic
->
ªcovîy_‰ame
 = 
p_pic
->recovery_frame;

3274 
p_°‹ed_pic
->
chroma_f‹m©_idc
 = 
p_pic
->chroma_format_idc;

3275 
p_°‹ed_pic
->
‰ame_mbs_⁄ly_Êag
 = 
p_pic
->frame_mbs_only_flag;

3276 
p_°‹ed_pic
->
‰ame_¸›pög_Êag
 = 
p_pic
->frame_cropping_flag;

3278 i‡(
p_°‹ed_pic
->
‰ame_¸›pög_Êag
)

3280 
p_°‹ed_pic
->
‰ame_¸›_À·_off£t
 = 
p_pic
->frame_crop_left_offset;

3281 
p_°‹ed_pic
->
‰ame_¸›_right_off£t
 = 
p_pic
->frame_crop_right_offset;

3282 
p_°‹ed_pic
->
‰ame_¸›_t›_off£t
 = 
p_pic
->frame_crop_top_offset;

3283 
p_°‹ed_pic
->
‰ame_¸›_bŸtom_off£t
 = 
p_pic
->frame_crop_bottom_offset;

3289 
o°ride
[0] = 
p_°‹ed_pic
->
iLumaSåide
;

3290 
o°ride
[1] = 
p_°‹ed_pic
->
iChromaSåide
;

3291 i‡(
p_°‹ed_pic
->
°ru˘uª
 =
FRAME
)

3293 
i°ride
 = 
p_Vid
->
ãmpD©a3
.
‰m_°ride
;

3294 
img_ö
 = 
p_Vid
->
ãmpD©a3
.
‰m_d©a
;

3296 i‡(
p_°‹ed_pic
->
°ru˘uª
 =
TOP_FIELD
)

3298 
i°ride
 = 
p_Vid
->
ãmpD©a3
.
t›_°ride
;

3299 
img_ö
 = 
p_Vid
->
ãmpD©a3
.
t›_d©a
;

3303 
i°ride
 = 
p_Vid
->
ãmpD©a3
.
bŸ_°ride
;

3304 
img_ö
 = 
p_Vid
->
ãmpD©a3
.
bŸ_d©a
;

3307 
	`c›y_img_d©a
(&
p_°‹ed_pic
->
imgY
[0][0], &
img_ö
[0][0][0], 
o°ride
[0], 
i°ride
[0], 
p_pic
->
size_y
,Ö_pic->
size_x
 * (
img≥l
));

3309 
	`∑d_buf
(*
p_°‹ed_pic
->
imgY
,Ö_°‹ed_pic->
size_x
,Ö_°‹ed_pic->
size_y
,Ö_°‹ed_pic->
iLumaSåide
, 
p_Vid
->
iLumaPadX
,Ö_Vid->
iLumaPadY
);

3311 i‡(
p_Vid
->
a˘ive_•s
->
chroma_f‹m©_idc
 !
YUV400
)

3315 
	`c›y_img_d©a
(&
p_°‹ed_pic
->
imgUV
[0][0][0], &
img_ö
[1][0][0], 
o°ride
[1], 
i°ride
[1], 
p_pic
->
size_y_¸
,Ö_pic->
size_x_¸
*(
img≥l
));

3316 
	`∑d_buf
(*
p_°‹ed_pic
->
imgUV
[0],Ö_°‹ed_pic->
size_x_¸
,Ö_°‹ed_pic->
size_y_¸
,Ö_°‹ed_pic->
iChromaSåide
, 
p_Vid
->
iChromaPadX
,Ö_Vid->
iChromaPadY
);

3317 
	`c›y_img_d©a
(&
p_°‹ed_pic
->
imgUV
[1][0][0], &
img_ö
[2][0][0], 
o°ride
[1], 
i°ride
[2], 
p_pic
->
size_y_¸
,Ö_pic->
size_x_¸
*(
img≥l
));

3318 
	`∑d_buf
(*
p_°‹ed_pic
->
imgUV
[1],Ö_°‹ed_pic->
size_x_¸
,Ö_°‹ed_pic->
size_y_¸
,Ö_°‹ed_pic->
iChromaSåide
, 
p_Vid
->
iChromaPadX
,Ö_Vid->
iChromaPadY
);

3321 
j
 = 0; j < (
p_pic
->
size_y
 >> 
BLOCK_SHIFT
); j++)

3324 *
ªf_idx
 = 
p_°‹ed_pic
->
mv_öfo
[
j
][0].ref_idx;

3325 
i
 = 0; i < (
p_pic
->
size_x
 >> 
BLOCK_SHIFT
); i++)

3328 *((*Ë
ªf_idx
) = -1;

3329 
ªf_idx
 +(
PicMŸi⁄P¨ams
);

3333 if–(
p_Vid
->
£∑øã_cﬁour_∂™e_Êag
 != 0) )

3335  
≈œ√
=0;Ç∂™e<
MAX_PLANE
;Çplane++ )

3337 
j
 = 0; j < (
p_pic
->
size_y
 >> 
BLOCK_SHIFT
); j++)

3339 
i
 = 0; i < (
p_pic
->
size_x
 >> 
BLOCK_SHIFT
); i++)

3341 
p_°‹ed_pic
->
JVmv_öfo
[
≈œ√
][
j
][
i
].
ªf_idx
[
LIST_0
] = -1;

3342 
p_°‹ed_pic
->
JVmv_öfo
[
≈œ√
][
j
][
i
].
ªf_idx
[
LIST_1
] = -1;

3349 
p_°‹ed_pic
->
öãr_võw_Êag
 = 
p_pic
->inter_view_flag;

3350 
p_°‹ed_pic
->
™ch‹_pic_Êag
 = 0;

3351 
p_°‹ed_pic
->
võw_id
 = 0;

3352 
p_°‹ed_pic
->
¥oc_Êag
 = 1;

3353 
p_°‹ed_pic
->
is_ouçut
 = 1;

3354 
p_°‹ed_pic
->
u£d_f‹_ª„ªn˚
 = 1;

3356  
p_°‹ed_pic
;

3357 
	}
}

	@ldecod/src/mbuffer_mvc.c

18 
	~<limôs.h
>

20 
	~"globÆ.h
"

21 
	~"hódî.h
"

22 
	~"image.h
"

23 
	~"mbuf„r.h
"

24 
	~"mbuf„r_comm⁄.h
"

25 
	~"mbuf„r_mvc.h
"

26 
	~"memÆloc.h
"

27 
	~"ouçut.h
"

29 #i‡(
MVC_EXTENSION_ENABLE
)

38 
	$ª‹dî_sh‹t_ãrm
(
Sli˚
 *
cuºSli˚
, 
cur_li°
, 
num_ªf_idx_lX_a˘ive_möus1
, 
picNumLX
, *
ªfIdxLX
, 
cuºVõwID
)

40 
St‹abÀPi˘uª
 **
RefPicLi°X
 = 
cuºSli˚
->
li°X
[
cur_li°
];

41 
cIdx
, 
nIdx
;

43 
St‹abÀPi˘uª
 *
picLX
;

45 
picLX
 = 
	`gë_sh‹t_ãrm_pic
(
cuºSli˚
, cuºSli˚->
p_Dpb
, 
picNumLX
);

47  
cIdx
 = 
num_ªf_idx_lX_a˘ive_möus1
+1; cIdx > *
ªfIdxLX
; cIdx-- )

48 
RefPicLi°X
[ 
cIdx
 ] = RefPicListX[ cIdx - 1];

50 
RefPicLi°X
[ (*
ªfIdxLX
)++ ] = 
picLX
;

52 
nIdx
 = *
ªfIdxLX
;

54  
cIdx
 = *
ªfIdxLX
; cIdx <
num_ªf_idx_lX_a˘ive_möus1
+1; cIdx++ )

55 i‡(
RefPicLi°X
[ 
cIdx
 ])

57 if–(
RefPicLi°X
[ 
cIdx
 ]->
is_l⁄g_ãrm
 ) || (RefPicLi°X[ cIdx ]->
pic_num
 !
picNumLX
 ) ||

58 –
cuºVõwID
 !-1 && 
RefPicLi°X
[ 
cIdx
 ]->
œyî_id
 != currViewID )

60 
RefPicLi°X
[ 
nIdx
++ ] = RefPicLi°X[ 
cIdx
 ];

62 
	}
}

72 
	$ª‹dî_l⁄g_ãrm
(
Sli˚
 *
cuºSli˚
, 
St‹abÀPi˘uª
 **
RefPicLi°X
, 
num_ªf_idx_lX_a˘ive_möus1
, 
L⁄gTîmPicNum
, *
ªfIdxLX
, 
cuºVõwID
)

74 
cIdx
, 
nIdx
;

76 
St‹abÀPi˘uª
 *
picLX
;

78 
picLX
 = 
	`gë_l⁄g_ãrm_pic
(
cuºSli˚
, cuºSli˚->
p_Dpb
, 
L⁄gTîmPicNum
);

80  
cIdx
 = 
num_ªf_idx_lX_a˘ive_möus1
+1; cIdx > *
ªfIdxLX
; cIdx-- )

81 
RefPicLi°X
[ 
cIdx
 ] = RefPicListX[ cIdx - 1];

83 
RefPicLi°X
[ (*
ªfIdxLX
)++ ] = 
picLX
;

85 
nIdx
 = *
ªfIdxLX
;

87  
cIdx
 = *
ªfIdxLX
; cIdx <
num_ªf_idx_lX_a˘ive_möus1
+1; cIdx++ )

89 i‡(
RefPicLi°X
[ 
cIdx
 ])

91 if–(!
RefPicLi°X
[ 
cIdx
 ]->
is_l⁄g_ãrm
 ) || (RefPicLi°X[ cIdx ]->
l⁄g_ãrm_pic_num
 !
L⁄gTîmPicNum
 ) ||

92 –
cuºVõwID
 !-1 && 
RefPicLi°X
[ 
cIdx
 ]->
œyî_id
 != currViewID )

94 
RefPicLi°X
[ 
nIdx
++ ] = RefPicLi°X[ 
cIdx
 ];

97 
	}
}

106 
St‹abÀPi˘uª
* 
	$gë_öãr_võw_pic
(
VideoP¨amëîs
 *
p_Vid
, 
Sli˚
 *
cuºSli˚
, 
èrgëVõwID
, 
cuºPOC
, 
li°idx
)

108 
i
;

109 
li°öãrvõw_size
;

110 
FømeSt‹e
 **
fs_li°öãrvõw
;

112 i‡(
li°idx
 == 0)

114 
fs_li°öãrvõw
 = 
cuºSli˚
->
fs_li°öãrvõw0
;

115 
li°öãrvõw_size
 = 
cuºSli˚
->
li°öãrvõwidx0
;

119 
fs_li°öãrvõw
 = 
cuºSli˚
->
fs_li°öãrvõw1
;

120 
li°öãrvõw_size
 = 
cuºSli˚
->
li°öãrvõwidx1
;

123 
i
=0; i<
li°öãrvõw_size
; i++)

125 i‡(
fs_li°öãrvõw
[
i
]->
œyî_id
 =
	`GëVOIdx
–
p_Vid
, 
èrgëVõwID
 ))

127 if(
p_Vid
->
°ru˘uª
==
FRAME
 && 
fs_li°öãrvõw
[
i
]->
‰ame
->
poc
 =
cuºPOC
)

129  
fs_li°öãrvõw
[
i
]->
‰ame
;

131 if(
p_Vid
->
°ru˘uª
==
TOP_FIELD
 && 
fs_li°öãrvõw
[
i
]->
t›_fõld
->
poc
 =
cuºPOC
)

133  
fs_li°öãrvõw
[
i
]->
t›_fõld
;

135 if(
p_Vid
->
°ru˘uª
==
BOTTOM_FIELD
 && 
fs_li°öãrvõw
[
i
]->
bŸtom_fõld
->
poc
 =
cuºPOC
)

137  
fs_li°öãrvõw
[
i
]->
bŸtom_fõld
;

142  
NULL
;

143 
	}
}

152 
	$gí_pic_li°_‰om_‰ame_öãrvõw_li°
(
Pi˘uªSåu˘uª
 
cuºSåu˘uª
, 
FømeSt‹e
 **
fs_li°
, 
li°_idx
, 
St‹abÀPi˘uª
 **
li°
, *
li°_size
)

154 
i
;

156 i‡(
cuºSåu˘uª
 =
TOP_FIELD
)

158 
i
=0; i<
li°_idx
; i++)

160 
li°
[()(*
li°_size
)] = 
fs_li°
[
i
]->
t›_fõld
;

161 (*
li°_size
)++;

164 i‡(
cuºSåu˘uª
 =
BOTTOM_FIELD
)

166 
i
=0; i<
li°_idx
; i++)

168 
li°
[()(*
li°_size
)] = 
fs_li°
[
i
]->
bŸtom_fõld
;

169 (*
li°_size
)++;

172 
	}
}

182 
	$öô_li°s_i_¶i˚_mvc
(
Sli˚
 *
cuºSli˚
)

186 
cuºSli˚
->
li°öãrvõwidx0
 = 0;

187 
cuºSli˚
->
li°öãrvõwidx1
 = 0;

189 
cuºSli˚
->
li°Xsize
[0] = 0;

190 
cuºSli˚
->
li°Xsize
[1] = 0;

191 
	}
}

200 
	$öô_li°s_p_¶i˚_mvc
(
Sli˚
 *
cuºSli˚
)

202 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

203 
DecodedPi˘uªBuf„r
 *
p_Dpb
 = 
cuºSli˚
->p_Dpb;

205 
i
;

207 
li°0idx
 = 0;

208 
li°…idx
 = 0;

210 
FømeSt‹e
 **
fs_li°0
;

211 
FømeSt‹e
 **
fs_li°…
;

213 
cuºPOC
 = 
cuºSli˚
->
ThisPOC
;

214 
™ch‹_pic_Êag
 = 
cuºSli˚
->anchor_pic_flag;

216 
cuºSli˚
->
li°öãrvõwidx0
 = 0;

217 
cuºSli˚
->
li°öãrvõwidx1
 = 0;

219 i‡(
cuºSli˚
->
°ru˘uª
 =
FRAME
)

221 
i
=0; i<
p_Dpb
->
ªf_‰ames_ö_buf„r
; i++)

223 i‡(
p_Dpb
->
fs_ªf
[
i
]->
is_u£d
==3)

225 i‡((
p_Dpb
->
fs_ªf
[
i
]->
‰ame
->
u£d_f‹_ª„ªn˚
)&&(!p_Dpb->fs_ªf[i]->‰ame->
is_l⁄g_ãrm
))

227 
cuºSli˚
->
li°X
[0][
li°0idx
++] = 
p_Dpb
->
fs_ªf
[
i
]->
‰ame
;

232 
	`qs‹t
((*)
cuºSli˚
->
li°X
[0], 
li°0idx
, (
St‹abÀPi˘uª
*), 
com∑ª_pic_by_pic_num_desc
);

233 
cuºSli˚
->
li°Xsize
[0] = (Ë
li°0idx
;

237 
i
=0; i<
p_Dpb
->
…ªf_‰ames_ö_buf„r
; i++)

239 i‡(
p_Dpb
->
fs_…ªf
[
i
]->
is_u£d
==3)

241 i‡(
p_Dpb
->
fs_…ªf
[
i
]->
‰ame
->
is_l⁄g_ãrm
)

243 
cuºSli˚
->
li°X
[0][
li°0idx
++]=
p_Dpb
->
fs_…ªf
[
i
]->
‰ame
;

247 
	`qs‹t
((*)&
cuºSli˚
->
li°X
[0][(ËcuºSli˚->
li°Xsize
[0]], 
li°0idx
 - cuºSli˚->li°Xsize[0], (
St‹abÀPi˘uª
*), 
com∑ª_pic_by_…_pic_num_asc
);

248 
cuºSli˚
->
li°Xsize
[0] = (Ë
li°0idx
;

252 
fs_li°0
 = 
	`ˇŒoc
(
p_Dpb
->
size
,  (
FømeSt‹e
*));

253 i‡(
NULL
==
fs_li°0
)

254 
	`no_mem_exô
("init_lists: fs_list0");

255 
fs_li°…
 = 
	`ˇŒoc
(
p_Dpb
->
size
,  (
FømeSt‹e
*));

256 i‡(
NULL
==
fs_li°…
)

257 
	`no_mem_exô
("init_lists: fs_listlt");

259 
i
=0; i<
p_Dpb
->
ªf_‰ames_ö_buf„r
; i++)

261 i‡(
p_Dpb
->
fs_ªf
[
i
]->
is_ª„ªn˚
)

263 
fs_li°0
[
li°0idx
++] = 
p_Dpb
->
fs_ªf
[
i
];

267 
	`qs‹t
((*)
fs_li°0
, 
li°0idx
, (
FømeSt‹e
*), 
com∑ª_fs_by_‰ame_num_desc
);

271 
cuºSli˚
->
li°Xsize
[0] = 0;

272 
	`gí_pic_li°_‰om_‰ame_li°
(
cuºSli˚
->
°ru˘uª
, 
fs_li°0
, 
li°0idx
, cuºSli˚->
li°X
[0], &cuºSli˚->
li°Xsize
[0], 0);

277 
i
=0; i<
p_Dpb
->
…ªf_‰ames_ö_buf„r
; i++)

279 
fs_li°…
[
li°…idx
++]=
p_Dpb
->
fs_…ªf
[
i
];

282 
	`qs‹t
((*)
fs_li°…
, 
li°…idx
, (
FømeSt‹e
*), 
com∑ª_fs_by_…_pic_idx_asc
);

284 
	`gí_pic_li°_‰om_‰ame_li°
(
cuºSli˚
->
°ru˘uª
, 
fs_li°…
, 
li°…idx
, cuºSli˚->
li°X
[0], &cuºSli˚->
li°Xsize
[0], 1);

286 
	`‰ì
(
fs_li°0
);

287 
	`‰ì
(
fs_li°…
);

290 
cuºSli˚
->
li°Xsize
[1] = 0;

292 #i‡!
SIMULCAST_ENABLE


293 i‡(
cuºSli˚
->
svc_exãnsi⁄_Êag
 == 0)

295 
cuº_võw_id
 = 
cuºSli˚
->
œyî_id
;

296 
cuºSli˚
->
fs_li°öãrvõw0
 = 
	`ˇŒoc
(
p_Dpb
->
size
,  (
FømeSt‹e
*));

297 i‡(
NULL
==
cuºSli˚
->
fs_li°öãrvõw0
)

298 
	`no_mem_exô
("init_lists: fs_listinterview0");

299 
li°0idx
 = 
cuºSli˚
->
li°Xsize
[0];

300 i‡(
cuºSli˚
->
°ru˘uª
 =
FRAME
)

302 
	`≠≥nd_öãrvõw_li°
(
p_Vid
->
p_Dpb_œyî
[1], 0, 0, 
cuºSli˚
->
fs_li°öãrvõw0
, &cuºSli˚->
li°öãrvõwidx0
, 
cuºPOC
, 
cuº_võw_id
, 
™ch‹_pic_Êag
);

303 
i
=0; i<()
cuºSli˚
->
li°öãrvõwidx0
; i++)

305 
cuºSli˚
->
li°X
[0][
li°0idx
++]=cuºSli˚->
fs_li°öãrvõw0
[
i
]->
‰ame
;

307 
cuºSli˚
->
li°Xsize
[0] = (Ë
li°0idx
;

311 
	`≠≥nd_öãrvõw_li°
(
p_Vid
->
p_Dpb_œyî
[1], 
cuºSli˚
->
°ru˘uª
, 0, cuºSli˚->
fs_li°öãrvõw0
, &cuºSli˚->
li°öãrvõwidx0
, 
cuºPOC
, 
cuº_võw_id
, 
™ch‹_pic_Êag
);

312 
	`gí_pic_li°_‰om_‰ame_öãrvõw_li°
(
cuºSli˚
->
°ru˘uª
, cuºSli˚->
fs_li°öãrvõw0
, cuºSli˚->
li°öãrvõwidx0
, cuºSli˚->
li°X
[0], &cuºSli˚->
li°Xsize
[0]);

317 
cuºSli˚
->
li°Xsize
[0] = (Ë
	`imö
 (cuºSli˚->li°Xsize[0], cuºSli˚->
num_ªf_idx_a˘ive
[
LIST_0
]);

318 
cuºSli˚
->
li°Xsize
[1] = (Ë
	`imö
 (cuºSli˚->li°Xsize[1], cuºSli˚->
num_ªf_idx_a˘ive
[
LIST_1
]);

321 
i
=
cuºSli˚
->
li°Xsize
[0]; i< (
MAX_LIST_SIZE
) ; i++)

323 
cuºSli˚
->
li°X
[0][
i
] = 
p_Vid
->
no_ª„ªn˚_pi˘uª
;

325 
i
=
cuºSli˚
->
li°Xsize
[1]; i< (
MAX_LIST_SIZE
) ; i++)

327 
cuºSli˚
->
li°X
[1][
i
] = 
p_Vid
->
no_ª„ªn˚_pi˘uª
;

330 #i‡
PRINTREFLIST


332 if((
p_Vid
->
¥ofûe_idc
 =
MVC_HIGH
 ||Ö_Vid->¥ofûe_id¯=
STEREO_HIGH
Ë&& 
cuºSli˚
->
cuºít_¶i˚_ƒ
==0)

334 if(
cuºSli˚
->
li°Xsize
[0]>0)

336 
	`¥ötf
("\n");

337 
	`¥ötf
(" ** (CurVõwID:%d %dË%†Re‡Pi¯Li° 0 ****\n", 
cuºSli˚
->
võw_id
, cuºSli˚->
ThisPOC
, cuºSli˚->
°ru˘uª
==
FRAME
 ? "FRM":(cuºSli˚->°ru˘uª==
TOP_FIELD
 ? "TOP":"BOT"));

338 
i
=0; i<()(
cuºSli˚
->
li°Xsize
[0]); i++)

340 
	`¥ötf
(" %2d -> POC: %4d PicNum: %4d VõwID: %d\n", 
i
, 
cuºSli˚
->
li°X
[0][i]->
poc
, cuºSli˚->li°X[0][i]->
pic_num
, cuºSli˚->li°X[0][i]->
võw_id
);

345 
	}
}

354 
	$öô_li°s_b_¶i˚_mvc
(
Sli˚
 *
cuºSli˚
)

356 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

357 
DecodedPi˘uªBuf„r
 *
p_Dpb
 = 
cuºSli˚
->p_Dpb;

359 
i
;

360 
j
;

362 
li°0idx
 = 0;

363 
li°0idx_1
 = 0;

364 
li°…idx
 = 0;

366 
FømeSt‹e
 **
fs_li°0
;

367 
FømeSt‹e
 **
fs_li°1
;

368 
FømeSt‹e
 **
fs_li°…
;

370 
cuºPOC
 = 
cuºSli˚
->
ThisPOC
;

371 
™ch‹_pic_Êag
 = 
cuºSli˚
->anchor_pic_flag;

373 
cuºSli˚
->
li°öãrvõwidx0
 = 0;

374 
cuºSli˚
->
li°öãrvõwidx1
 = 0;

378 i‡(
cuºSli˚
->
°ru˘uª
 =
FRAME
)

380 
i
=0; i<
p_Dpb
->
ªf_‰ames_ö_buf„r
; i++)

382 i‡(
p_Dpb
->
fs_ªf
[
i
]->
is_u£d
==3)

384 i‡((
p_Dpb
->
fs_ªf
[
i
]->
‰ame
->
u£d_f‹_ª„ªn˚
)&&(!p_Dpb->fs_ªf[i]->‰ame->
is_l⁄g_ãrm
))

386 i‡(
cuºSli˚
->
‰amïoc
 >
p_Dpb
->
fs_ªf
[
i
]->
‰ame
->
poc
)

389 
cuºSli˚
->
li°X
[0][
li°0idx
++] = 
p_Dpb
->
fs_ªf
[
i
]->
‰ame
;

394 
	`qs‹t
((*)
cuºSli˚
->
li°X
[0], 
li°0idx
, (
St‹abÀPi˘uª
*), 
com∑ª_pic_by_poc_desc
);

395 
li°0idx_1
 = 
li°0idx
;

396 
i
=0; i<
p_Dpb
->
ªf_‰ames_ö_buf„r
; i++)

398 i‡(
p_Dpb
->
fs_ªf
[
i
]->
is_u£d
==3)

400 i‡((
p_Dpb
->
fs_ªf
[
i
]->
‰ame
->
u£d_f‹_ª„ªn˚
)&&(!p_Dpb->fs_ªf[i]->‰ame->
is_l⁄g_ãrm
))

402 i‡(
cuºSli˚
->
‰amïoc
 < 
p_Dpb
->
fs_ªf
[
i
]->
‰ame
->
poc
)

404 
cuºSli˚
->
li°X
[0][
li°0idx
++] = 
p_Dpb
->
fs_ªf
[
i
]->
‰ame
;

409 
	`qs‹t
((*)&
cuºSli˚
->
li°X
[0][
li°0idx_1
], 
li°0idx
-li°0idx_1, (
St‹abÀPi˘uª
*), 
com∑ª_pic_by_poc_asc
);

411 
j
=0; j<
li°0idx_1
; j++)

413 
cuºSli˚
->
li°X
[1][
li°0idx
-
li°0idx_1
+
j
]=currSlice->listX[0][j];

415 
j
=
li°0idx_1
; j<
li°0idx
; j++)

417 
cuºSli˚
->
li°X
[1][
j
-
li°0idx_1
]=currSlice->listX[0][j];

420 
cuºSli˚
->
li°Xsize
[0] = cuºSli˚->li°Xsize[1] = (Ë
li°0idx
;

426 
i
=0; i<
p_Dpb
->
…ªf_‰ames_ö_buf„r
; i++)

428 i‡(
p_Dpb
->
fs_…ªf
[
i
]->
is_u£d
==3)

430 i‡(
p_Dpb
->
fs_…ªf
[
i
]->
‰ame
->
is_l⁄g_ãrm
)

432 
cuºSli˚
->
li°X
[0][
li°0idx
] = 
p_Dpb
->
fs_…ªf
[
i
]->
‰ame
;

433 
cuºSli˚
->
li°X
[1][
li°0idx
++] = 
p_Dpb
->
fs_…ªf
[
i
]->
‰ame
;

437 
	`qs‹t
((*)&
cuºSli˚
->
li°X
[0][(ËcuºSli˚->
li°Xsize
[0]], 
li°0idx
 - cuºSli˚->li°Xsize[0], (
St‹abÀPi˘uª
*), 
com∑ª_pic_by_…_pic_num_asc
);

438 
	`qs‹t
((*)&
cuºSli˚
->
li°X
[1][(ËcuºSli˚->
li°Xsize
[0]], 
li°0idx
 - cuºSli˚->li°Xsize[0], (
St‹abÀPi˘uª
*), 
com∑ª_pic_by_…_pic_num_asc
);

439 
cuºSli˚
->
li°Xsize
[0] = cuºSli˚->li°Xsize[1] = (Ë
li°0idx
;

443 
fs_li°0
 = 
	`ˇŒoc
(
p_Dpb
->
size
,  (
FømeSt‹e
*));

444 i‡(
NULL
==
fs_li°0
)

445 
	`no_mem_exô
("init_lists: fs_list0");

446 
fs_li°1
 = 
	`ˇŒoc
(
p_Dpb
->
size
,  (
FømeSt‹e
*));

447 i‡(
NULL
==
fs_li°1
)

448 
	`no_mem_exô
("init_lists: fs_list1");

449 
fs_li°…
 = 
	`ˇŒoc
(
p_Dpb
->
size
,  (
FømeSt‹e
*));

450 i‡(
NULL
==
fs_li°…
)

451 
	`no_mem_exô
("init_lists: fs_listlt");

453 
cuºSli˚
->
li°Xsize
[0] = 0;

454 
cuºSli˚
->
li°Xsize
[1] = 1;

456 
i
=0; i<
p_Dpb
->
ªf_‰ames_ö_buf„r
; i++)

458 i‡(
p_Dpb
->
fs_ªf
[
i
]->
is_u£d
)

460 i‡(
cuºSli˚
->
ThisPOC
 >
p_Dpb
->
fs_ªf
[
i
]->
poc
)

462 
fs_li°0
[
li°0idx
++] = 
p_Dpb
->
fs_ªf
[
i
];

466 
	`qs‹t
((*)
fs_li°0
, 
li°0idx
, (
FømeSt‹e
*), 
com∑ª_fs_by_poc_desc
);

467 
li°0idx_1
 = 
li°0idx
;

468 
i
=0; i<
p_Dpb
->
ªf_‰ames_ö_buf„r
; i++)

470 i‡(
p_Dpb
->
fs_ªf
[
i
]->
is_u£d
)

472 i‡(
cuºSli˚
->
ThisPOC
 < 
p_Dpb
->
fs_ªf
[
i
]->
poc
)

474 
fs_li°0
[
li°0idx
++] = 
p_Dpb
->
fs_ªf
[
i
];

478 
	`qs‹t
((*)&
fs_li°0
[
li°0idx_1
], 
li°0idx
-li°0idx_1, (
FømeSt‹e
*), 
com∑ª_fs_by_poc_asc
);

480 
j
=0; j<
li°0idx_1
; j++)

482 
fs_li°1
[
li°0idx
-
li°0idx_1
+
j
]=
fs_li°0
[j];

484 
j
=
li°0idx_1
; j<
li°0idx
; j++)

486 
fs_li°1
[
j
-
li°0idx_1
]=
fs_li°0
[j];

492 
cuºSli˚
->
li°Xsize
[0] = 0;

493 
cuºSli˚
->
li°Xsize
[1] = 0;

494 
	`gí_pic_li°_‰om_‰ame_li°
(
cuºSli˚
->
°ru˘uª
, 
fs_li°0
, 
li°0idx
, cuºSli˚->
li°X
[0], &cuºSli˚->
li°Xsize
[0], 0);

495 
	`gí_pic_li°_‰om_‰ame_li°
(
cuºSli˚
->
°ru˘uª
, 
fs_li°1
, 
li°0idx
, cuºSli˚->
li°X
[1], &cuºSli˚->
li°Xsize
[1], 0);

501 
i
=0; i<
p_Dpb
->
…ªf_‰ames_ö_buf„r
; i++)

503 
fs_li°…
[
li°…idx
++]=
p_Dpb
->
fs_…ªf
[
i
];

506 
	`qs‹t
((*)
fs_li°…
, 
li°…idx
, (
FømeSt‹e
*), 
com∑ª_fs_by_…_pic_idx_asc
);

508 
	`gí_pic_li°_‰om_‰ame_li°
(
cuºSli˚
->
°ru˘uª
, 
fs_li°…
, 
li°…idx
, cuºSli˚->
li°X
[0], &cuºSli˚->
li°Xsize
[0], 1);

509 
	`gí_pic_li°_‰om_‰ame_li°
(
cuºSli˚
->
°ru˘uª
, 
fs_li°…
, 
li°…idx
, cuºSli˚->
li°X
[1], &cuºSli˚->
li°Xsize
[1], 1);

511 
	`‰ì
(
fs_li°0
);

512 
	`‰ì
(
fs_li°1
);

513 
	`‰ì
(
fs_li°…
);

517 i‡((
cuºSli˚
->
li°Xsize
[0] == currSlice->listXsize[1]) && (currSlice->listXsize[0] > 1))

520 
diff
=0;

521 
j
 = 0; j< 
cuºSli˚
->
li°Xsize
[0]; j++)

523 i‡(
cuºSli˚
->
li°X
[0][
j
] != currSlice->listX[1][j])

525 
diff
 = 1;

529 i‡(!
diff
)

531 
St‹abÀPi˘uª
 *
tmp_s
 = 
cuºSli˚
->
li°X
[1][0];

532 
cuºSli˚
->
li°X
[1][0]=currSlice->listX[1][1];

533 
cuºSli˚
->
li°X
[1][1]=
tmp_s
;

537 #i‡!
SIMULCAST_ENABLE


538 i‡(
cuºSli˚
->
svc_exãnsi⁄_Êag
 == 0)

540 
cuº_võw_id
 = 
cuºSli˚
->
võw_id
;

542 
cuºSli˚
->
fs_li°öãrvõw0
 = 
	`ˇŒoc
(
p_Dpb
->
size
,  (
FømeSt‹e
*));

543 i‡(
NULL
==
cuºSli˚
->
fs_li°öãrvõw0
)

544 
	`no_mem_exô
("init_lists: fs_listinterview0");

545 
cuºSli˚
->
fs_li°öãrvõw1
 = 
	`ˇŒoc
(
p_Dpb
->
size
,  (
FømeSt‹e
*));

546 i‡(
NULL
==
cuºSli˚
->
fs_li°öãrvõw1
)

547 
	`no_mem_exô
("init_lists: fs_listinterview1");

548 
li°0idx
 = 
cuºSli˚
->
li°Xsize
[0];

550 i‡(
cuºSli˚
->
°ru˘uª
 =
FRAME
)

552 
	`≠≥nd_öãrvõw_li°
(

553 
p_Vid
->
p_Dpb_œyî
[1],

554 0, 0, 
cuºSli˚
->
fs_li°öãrvõw0
, &cuºSli˚->
li°öãrvõwidx0
, 
cuºPOC
, 
cuº_võw_id
, 
™ch‹_pic_Êag
);

555 
	`≠≥nd_öãrvõw_li°
(

556 
p_Vid
->
p_Dpb_œyî
[1],

557 0, 1, 
cuºSli˚
->
fs_li°öãrvõw1
, &cuºSli˚->
li°öãrvõwidx1
, 
cuºPOC
, 
cuº_võw_id
, 
™ch‹_pic_Êag
);

558 
i
=0; i<()
cuºSli˚
->
li°öãrvõwidx0
; i++)

560 
cuºSli˚
->
li°X
[0][
li°0idx
++]=cuºSli˚->
fs_li°öãrvõw0
[
i
]->
‰ame
;

562 
cuºSli˚
->
li°Xsize
[0] = (Ë
li°0idx
;

563 
li°0idx
 = 
cuºSli˚
->
li°Xsize
[1];

564 
i
=0; i<()
cuºSli˚
->
li°öãrvõwidx1
; i++)

566 
cuºSli˚
->
li°X
[1][
li°0idx
++] = cuºSli˚->
fs_li°öãrvõw1
[
i
]->
‰ame
;

568 
cuºSli˚
->
li°Xsize
[1] = (Ë
li°0idx
;

572 
	`≠≥nd_öãrvõw_li°
(

573 
p_Vid
->
p_Dpb_œyî
[1],

574 
cuºSli˚
->
°ru˘uª
, 0, cuºSli˚->
fs_li°öãrvõw0
, &cuºSli˚->
li°öãrvõwidx0
, 
cuºPOC
, 
cuº_võw_id
, 
™ch‹_pic_Êag
);

575 
	`gí_pic_li°_‰om_‰ame_öãrvõw_li°
(
cuºSli˚
->
°ru˘uª
, cuºSli˚->
fs_li°öãrvõw0
, cuºSli˚->
li°öãrvõwidx0
, cuºSli˚->
li°X
[0], &cuºSli˚->
li°Xsize
[0]);

576 
	`≠≥nd_öãrvõw_li°
(

577 
p_Vid
->
p_Dpb_œyî
[1],

578 
cuºSli˚
->
°ru˘uª
, 1, cuºSli˚->
fs_li°öãrvõw1
, &cuºSli˚->
li°öãrvõwidx1
, 
cuºPOC
, 
cuº_võw_id
, 
™ch‹_pic_Êag
);

579 
	`gí_pic_li°_‰om_‰ame_öãrvõw_li°
(
cuºSli˚
->
°ru˘uª
, cuºSli˚->
fs_li°öãrvõw1
, cuºSli˚->
li°öãrvõwidx1
, cuºSli˚->
li°X
[1], &cuºSli˚->
li°Xsize
[1]);

584 
cuºSli˚
->
li°Xsize
[0] = (Ë
	`imö
 (cuºSli˚->li°Xsize[0], cuºSli˚->
num_ªf_idx_a˘ive
[
LIST_0
]);

585 
cuºSli˚
->
li°Xsize
[1] = (Ë
	`imö
 (cuºSli˚->li°Xsize[1], cuºSli˚->
num_ªf_idx_a˘ive
[
LIST_1
]);

588 
i
=
cuºSli˚
->
li°Xsize
[0]; i< (
MAX_LIST_SIZE
) ; i++)

590 
cuºSli˚
->
li°X
[0][
i
] = 
p_Vid
->
no_ª„ªn˚_pi˘uª
;

592 
i
=
cuºSli˚
->
li°Xsize
[1]; i< (
MAX_LIST_SIZE
) ; i++)

594 
cuºSli˚
->
li°X
[1][
i
] = 
p_Vid
->
no_ª„ªn˚_pi˘uª
;

596 #i‡
PRINTREFLIST


598 if((
p_Vid
->
¥ofûe_idc
 =
MVC_HIGH
 ||Ö_Vid->¥ofûe_id¯=
STEREO_HIGH
Ë&& 
cuºSli˚
->
cuºít_¶i˚_ƒ
==0)

600 if((
cuºSli˚
->
li°Xsize
[0]>0) || (currSlice->listXsize[1]>0))

601 
	`¥ötf
("\n");

602 if(
cuºSli˚
->
li°Xsize
[0]>0)

604 
	`¥ötf
(" ** (CurVõwID:%d %dË%†Re‡Pi¯Li° 0 ****\n", 
cuºSli˚
->
võw_id
, cuºSli˚->
ThisPOC
, cuºSli˚->
°ru˘uª
==
FRAME
 ? "FRM":(cuºSli˚->°ru˘uª==
TOP_FIELD
 ? "TOP":"BOT"));

605 
i
=0; i<()(
cuºSli˚
->
li°Xsize
[0]); i++)

607 
	`¥ötf
(" %2d -> POC: %4d PicNum: %4d VõwID: %d\n", 
i
, 
cuºSli˚
->
li°X
[0][i]->
poc
, cuºSli˚->li°X[0][i]->
pic_num
, cuºSli˚->li°X[0][i]->
võw_id
);

610 if(
cuºSli˚
->
li°Xsize
[1]>0)

612 
	`¥ötf
(" ** (CurVõwID:%d %dË%†Re‡Pi¯Li° 1 ****\n", 
cuºSli˚
->
võw_id
, cuºSli˚->
ThisPOC
, cuºSli˚->
°ru˘uª
==
FRAME
 ? "FRM":(cuºSli˚->°ru˘uª==
TOP_FIELD
 ? "TOP":"BOT"));

613 
i
=0; i<()(
cuºSli˚
->
li°Xsize
[1]); i++)

615 
	`¥ötf
(" %2d -> POC: %4d PicNum: %4d VõwID: %d\n", 
i
, 
cuºSli˚
->
li°X
[1][i]->
poc
, cuºSli˚->li°X[1][i]->
pic_num
, cuºSli˚->li°X[1][i]->
võw_id
);

620 
	}
}

630 
	$ª‹dî_öãrvõw
(
VideoP¨amëîs
 *
p_Vid
, 
Sli˚
 *
cuºSli˚
, 
St‹abÀPi˘uª
 **
RefPicLi°X
, 
num_ªf_idx_lX_a˘ive_möus1
, *
ªfIdxLX
, 
èrgëVõwID
, 
cuºPOC
, 
li°idx
)

632 
cIdx
, 
nIdx
;

633 
St‹abÀPi˘uª
 *
picLX
;

635 
picLX
 = 
	`gë_öãr_võw_pic
(
p_Vid
, 
cuºSli˚
, 
èrgëVõwID
, 
cuºPOC
, 
li°idx
);

637 i‡(
picLX
)

639  
cIdx
 = 
num_ªf_idx_lX_a˘ive_möus1
+1; cIdx > *
ªfIdxLX
; cIdx-- )

640 
RefPicLi°X
[ 
cIdx
 ] = RefPicListX[ cIdx - 1];

642 
RefPicLi°X
[ (*
ªfIdxLX
)++ ] = 
picLX
;

644 
nIdx
 = *
ªfIdxLX
;

646  
cIdx
 = *
ªfIdxLX
; cIdx <
num_ªf_idx_lX_a˘ive_möus1
+1; cIdx++ )

648 if((
	`GëVõwIdx
–
p_Vid
, 
RefPicLi°X
[
cIdx
]->
võw_id
 ) !
èrgëVõwID
Ë|| (RefPicLi°X[cIdx]->
poc
 !
cuºPOC
))

649 
RefPicLi°X
[ 
nIdx
++ ] = RefPicLi°X[ 
cIdx
 ];

652 
	}
}

661 
	$ª‹dî_ªf_pic_li°_mvc
(
Sli˚
 *
cuºSli˚
, 
cur_li°
, **
™ch‹_ªf
, **
n⁄_™ch‹_ªf
, 
võw_id
, 
™ch‹_pic_Êag
, 
cuºPOC
, 
li°idx
)

663 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

664 *
modifiˇti⁄_of_pic_nums_idc
 = 
cuºSli˚
->modifiˇti⁄_of_pic_nums_idc[
cur_li°
];

665 *
abs_diff_pic_num_möus1
 = 
cuºSli˚
->abs_diff_pic_num_möus1[
cur_li°
];

666 *
l⁄g_ãrm_pic_idx
 = 
cuºSli˚
->l⁄g_ãrm_pic_idx[
cur_li°
];

667 
num_ªf_idx_lX_a˘ive_möus1
 = 
cuºSli˚
->
num_ªf_idx_a˘ive
[
cur_li°
] - 1;

668 *
abs_diff_võw_idx_möus1
 = 
cuºSli˚
->abs_diff_võw_idx_möus1[
cur_li°
];

670 
i
;

672 
maxPicNum
, 
cuºPicNum
, 
picNumLXNoWøp
, 
picNumLXPªd
, 
picNumLX
;

673 
picVõwIdxLX
, 
èrgëVõwID
;

674 
ªfIdxLX
 = 0;

675 
maxVõwIdx
 =0;

676 
cuº_VOIdx
 = -1;

677 
picVõwIdxLXPªd
=-1;

679 i‡(
p_Vid
->
°ru˘uª
==
FRAME
)

681 
maxPicNum
 = 
p_Vid
->
max_‰ame_num
;

682 
cuºPicNum
 = 
cuºSli˚
->
‰ame_num
;

686 
maxPicNum
 = 2 * 
p_Vid
->
max_‰ame_num
;

687 
cuºPicNum
 = 2 * 
cuºSli˚
->
‰ame_num
 + 1;

690 if(
cuºSli˚
->
svc_exãnsi⁄_Êag
==0)

692 
cuº_VOIdx
 = 
võw_id
;

693 
maxVõwIdx
 = 
	`gë_maxVõwIdx
(
p_Vid
, 
võw_id
, 
™ch‹_pic_Êag
, 0);

694 
picVõwIdxLXPªd
=-1;

697 
picNumLXPªd
 = 
cuºPicNum
;

699 
i
=0; 
modifiˇti⁄_of_pic_nums_idc
[i]!=3; i++)

701 i‡(
modifiˇti⁄_of_pic_nums_idc
[
i
] > 5)

702 
	`îr‹
 ("Invalid modification_of_pic_nums_idc command", 500);

704 i‡(
modifiˇti⁄_of_pic_nums_idc
[
i
] < 2)

706 i‡(
modifiˇti⁄_of_pic_nums_idc
[
i
] == 0)

708 if–
picNumLXPªd
 - ( 
abs_diff_pic_num_möus1
[
i
] + 1 ) < 0 )

709 
picNumLXNoWøp
 = 
picNumLXPªd
 - ( 
abs_diff_pic_num_möus1
[
i
] + 1 ) + 
maxPicNum
;

711 
picNumLXNoWøp
 = 
picNumLXPªd
 - ( 
abs_diff_pic_num_möus1
[
i
] + 1 );

715 if–
picNumLXPªd
 + ( 
abs_diff_pic_num_möus1
[
i
] + 1 ) >
maxPicNum
 )

716 
picNumLXNoWøp
 = 
picNumLXPªd
 + ( 
abs_diff_pic_num_möus1
[
i
] + 1 ) - 
maxPicNum
;

718 
picNumLXNoWøp
 = 
picNumLXPªd
 + ( 
abs_diff_pic_num_möus1
[
i
] + 1 );

720 
picNumLXPªd
 = 
picNumLXNoWøp
;

722 if–
picNumLXNoWøp
 > 
cuºPicNum
 )

723 
picNumLX
 = 
picNumLXNoWøp
 - 
maxPicNum
;

725 
picNumLX
 = 
picNumLXNoWøp
;

727 
	`ª‹dî_sh‹t_ãrm
(
cuºSli˚
, 
cur_li°
, 
num_ªf_idx_lX_a˘ive_möus1
, 
picNumLX
, &
ªfIdxLX
, 
võw_id
);

729 i‡(
modifiˇti⁄_of_pic_nums_idc
[
i
] == 2)

731 
	`ª‹dî_l⁄g_ãrm
(
cuºSli˚
, cuºSli˚->
li°X
[
cur_li°
], 
num_ªf_idx_lX_a˘ive_möus1
, 
l⁄g_ãrm_pic_idx
[
i
], &
ªfIdxLX
, 
võw_id
);

735 if(
modifiˇti⁄_of_pic_nums_idc
[
i
] == 4)

737 
picVõwIdxLX
 = 
picVõwIdxLXPªd
 - (
abs_diff_võw_idx_möus1
[
i
] + 1);

738 if–
picVõwIdxLX
 <0)

739 
picVõwIdxLX
 +
maxVõwIdx
;

743 
picVõwIdxLX
 = 
picVõwIdxLXPªd
 + (
abs_diff_võw_idx_möus1
[
i
] + 1);

744 if–
picVõwIdxLX
 >
maxVõwIdx
)

745 
picVõwIdxLX
 -
maxVõwIdx
;

747 
picVõwIdxLXPªd
 = 
picVõwIdxLX
;

749 i‡(
™ch‹_pic_Êag
)

750 
èrgëVõwID
 = 
™ch‹_ªf
[
cuº_VOIdx
][
picVõwIdxLX
];

752 
èrgëVõwID
 = 
n⁄_™ch‹_ªf
[
cuº_VOIdx
][
picVõwIdxLX
];

754 
	`ª‹dî_öãrvõw
(
p_Vid
, 
cuºSli˚
, cuºSli˚->
li°X
[
cur_li°
], 
num_ªf_idx_lX_a˘ive_möus1
, &
ªfIdxLX
, 
èrgëVõwID
, 
cuºPOC
, 
li°idx
);

758 
cuºSli˚
->
li°Xsize
[
cur_li°
] = (Ë(
num_ªf_idx_lX_a˘ive_möus1
 + 1);

759 
	}
}

761 
	$ª‹dî_li°s_mvc
(
Sli˚
 * 
cuºSli˚
, 
cuºPOC
)

763 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

765 i‡((
cuºSli˚
->
¶i˚_ty≥
 !
I_SLICE
)&&(cuºSli˚->¶i˚_ty≥ !
SI_SLICE
))

767 i‡(
cuºSli˚
->
ªf_pic_li°_ª‹dîög_Êag
[
LIST_0
])

769 
	`ª‹dî_ªf_pic_li°_mvc
(
cuºSli˚
, 
LIST_0
,

770 
p_Vid
->
a˘ive_sub£t_•s
->
™ch‹_ªf_l0
,

771 
p_Vid
->
a˘ive_sub£t_•s
->
n⁄_™ch‹_ªf_l0
,

772 
cuºSli˚
->
võw_id
, cuºSli˚->
™ch‹_pic_Êag
, 
cuºPOC
, 0);

774 i‡(
p_Vid
->
no_ª„ªn˚_pi˘uª
 =
cuºSli˚
->
li°X
[0][cuºSli˚->
num_ªf_idx_a˘ive
[
LIST_0
]-1])

776 i‡(
p_Vid
->
n⁄_c⁄f‹mög_°ªam
)

777 
	`¥ötf
("RefPicLi°0[ %d ] i†equÆÅÿ'nÿª„ªn˚Öi˘uª'\n", 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
] - 1);

779 
	`îr‹
("RefPicList0[Çum_ref_idx_l0_active_minus1 ] in MVCÜayer isÉqualÅo 'noÑeferenceÖicture', invalid bitstream",500);

782 
cuºSli˚
->
li°Xsize
[0] = ()cuºSli˚->
num_ªf_idx_a˘ive
[
LIST_0
];

784 i‡(
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
)

786 i‡(
cuºSli˚
->
ªf_pic_li°_ª‹dîög_Êag
[
LIST_1
])

788 
	`ª‹dî_ªf_pic_li°_mvc
(
cuºSli˚
, 
LIST_1
,

789 
p_Vid
->
a˘ive_sub£t_•s
->
™ch‹_ªf_l1
,

790 
p_Vid
->
a˘ive_sub£t_•s
->
n⁄_™ch‹_ªf_l1
,

791 
cuºSli˚
->
võw_id
, cuºSli˚->
™ch‹_pic_Êag
, 
cuºPOC
, 1);

793 i‡(
p_Vid
->
no_ª„ªn˚_pi˘uª
 =
cuºSli˚
->
li°X
[1][cuºSli˚->
num_ªf_idx_a˘ive
[
LIST_1
]-1])

795 i‡(
p_Vid
->
n⁄_c⁄f‹mög_°ªam
)

796 
	`¥ötf
("RefPicLi°1[ %d ] i†equÆÅÿ'nÿª„ªn˚Öi˘uª'\n", 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_1
] - 1);

798 
	`îr‹
("RefPicList1[Çum_ref_idx_l1_active_minus1 ] isÉqualÅo 'noÑeferenceÖicture', invalid bitstream",500);

801 
cuºSli˚
->
li°Xsize
[1] = ()cuºSli˚->
num_ªf_idx_a˘ive
[
LIST_1
];

804 
	`‰ì_ªf_pic_li°_ª‹dîög_buf„r
(
cuºSli˚
);

806 i‡–
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
 )

808 #i‡
PRINTREFLIST


809 
i
;

811 if((
p_Vid
->
¥ofûe_idc
 =
MVC_HIGH
 ||Ö_Vid->¥ofûe_id¯=
STEREO_HIGH
Ë&& 
cuºSli˚
->
cuºít_¶i˚_ƒ
==0)

813 if(
cuºSli˚
->
li°Xsize
[0]>0)

815 
	`¥ötf
("\n");

816 
	`¥ötf
(" ** (FöÆVõwID:%d %dË%†Re‡Pi¯Li° 0 ****\n", 
cuºSli˚
->
võw_id
, cuºSli˚->
ThisPOC
, cuºSli˚->
°ru˘uª
==
FRAME
 ? "FRM":(cuºSli˚->°ru˘uª==
TOP_FIELD
 ? "TOP":"BOT"));

817 
i
=0; i<()(
cuºSli˚
->
li°Xsize
[0]); i++)

819 
	`¥ötf
(" %2d -> POC: %4d PicNum: %4d VõwID: %d\n", 
i
, 
cuºSli˚
->
li°X
[0][i]->
poc
, cuºSli˚->li°X[0][i]->
pic_num
, cuºSli˚->li°X[0][i]->
võw_id
);

825 i‡–
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
 )

827 #i‡
PRINTREFLIST


828 
i
;

830 if((
p_Vid
->
¥ofûe_idc
 =
MVC_HIGH
 ||Ö_Vid->¥ofûe_id¯=
STEREO_HIGH
Ë&& 
cuºSli˚
->
cuºít_¶i˚_ƒ
==0)

832 if((
cuºSli˚
->
li°Xsize
[0]>0) || (currSlice->listXsize[1]>0))

833 
	`¥ötf
("\n");

834 if(
cuºSli˚
->
li°Xsize
[0]>0)

836 
	`¥ötf
(" ** (FöÆVõwID:%dË%†Re‡Pi¯Li° 0 ****\n", 
cuºSli˚
->
võw_id
, cuºSli˚->
°ru˘uª
==
FRAME
 ? "FRM":(cuºSli˚->°ru˘uª==
TOP_FIELD
 ? "TOP":"BOT"));

837 
i
=0; i<()(
cuºSli˚
->
li°Xsize
[0]); i++)

839 
	`¥ötf
(" %2d -> POC: %4d PicNum: %4d VõwID: %d\n", 
i
, 
cuºSli˚
->
li°X
[0][i]->
poc
, cuºSli˚->li°X[0][i]->
pic_num
, cuºSli˚->li°X[0][i]->
võw_id
);

842 if(
cuºSli˚
->
li°Xsize
[1]>0)

844 
	`¥ötf
(" ** (FöÆVõwID:%dË%†Re‡Pi¯Li° 1 ****\n", 
cuºSli˚
->
võw_id
, cuºSli˚->
°ru˘uª
==
FRAME
 ? "FRM":(cuºSli˚->°ru˘uª==
TOP_FIELD
 ? "TOP":"BOT"));

845 
i
=0; i<()(
cuºSli˚
->
li°Xsize
[1]); i++)

847 
	`¥ötf
(" %2d -> POC: %4d PicNum: %4d VõwID: %d\n", 
i
, 
cuºSli˚
->
li°X
[1][i]->
poc
, cuºSli˚->li°X[1][i]->
pic_num
, cuºSli˚->li°X[1][i]->
võw_id
);

853 
	}
}

	@ldecod/src/mc_direct.c

17 
	~"globÆ.h
"

18 
	~"block.h
"

19 
	~"mc_¥edi˘i⁄.h
"

20 
	~"mbuf„r.h
"

21 
	~"mb_ac˚ss.h
"

22 
	~"ma¸oblock.h
"

23 
	~"memÆloc.h
"

25 
	$upd©e_dúe˘_mv_öfo_ãmp‹Æ
(
Ma¸oblock
 *
cuºMB
)

27 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

28 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

29 
j
,
k
;

30 
∑πmode
 = ((
cuºMB
->
mb_ty≥
 =
P8x8
) ? 4 : currMB->mb_type);

31 
°ï_h0
 = 
BLOCK_STEP
 [
∑πmode
][0];

32 
°ï_v0
 = 
BLOCK_STEP
 [
∑πmode
][1];

34 
i0
, 
j0
, 
j6
;

36 
j4
, 
i4
;

37 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
cuºSli˚
->dec_picture;

39 
li°_off£t
 = 
cuºMB
->list_offset;

40 
St‹abÀPi˘uª
 **
li°0
 = 
cuºSli˚
->
li°X
[
LIST_0
 + 
li°_off£t
];

41 
St‹abÀPi˘uª
 **
li°1
 = 
cuºSli˚
->
li°X
[
LIST_1
 + 
li°_off£t
];

43 
Boﬁón
 
has_dúe˘
 = (
cuºMB
->
b8mode
[0] == 0) | (currMB->b8mode[1] == 0) | (currMB->b8mode[2] == 0) | (currMB->b8mode[3] == 0);

45 i‡(
has_dúe˘
)

47 
mv_sˇÀ
 = 0;

49 
k
 = 0; k < 4; ++k)

51 i‡(
cuºMB
->
b8mode
[
k
] == 0)

53 
cuºMB
->
b8pdú
[
k
] = 2;

54 
j0
 = 2 * (
k
 >> 1); j0 < 2 * (k >> 1Ë+ 2; j0 +
°ï_v0
)

56 
i0
 = 
cuºMB
->
block_x
 + 2*(
k
 & 0x01); i0 < cuºMB->block_x + 2 * (k & 0x01)+2; i0 +
°ï_h0
)

58 
PicMŸi⁄P¨ams
 *
cﬁoˇãd
;

59 
ªfLi°
;

60 
ªf_idx
;

61 
m≠≥d_idx
 = -1, 
úef
;

63 
cﬁoˇãd
 = 
p_Vid
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
 ?

64 &
li°1
[0]->
mv_öfo
[
	`RSD
(
cuºMB
->
block_y_aff
 + 
j0
)][RSD(
i0
)] : &list1[0]->mv_info[currMB->block_y_aff + j0][i0];

65 if(
cuºSli˚
->
mb_aff_‰ame_Êag
)

67 
	`as£π
(
p_Vid
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
);

68 if(!
cuºMB
->
mb_fõld
 && ((
cuºSli˚
->
li°X
[
LIST_1
][0]->
iCodögTy≥
==
FRAME_MB_PAIR_CODING
 && cuºSli˚->li°X[LIST_1][0]->
mŸi⁄
.mb_fõld[cuºMB->
mbAddrX
]) ||

69 (
cuºSli˚
->
li°X
[
LIST_1
][0]->
iCodögTy≥
==
FIELD_CODING
)))

71 i‡(
	`übs
(
dec_pi˘uª
->
poc
 - 
cuºSli˚
->
li°X
[
LIST_1
+4][0]->poc)> iabs(dec_picture->poc -currSlice->listX[LIST_1+2][0]->poc) )

73 
cﬁoˇãd
 = 
p_Vid
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
 ?

74 &
cuºSli˚
->
li°X
[
LIST_1
+2][0]->
mv_öfo
[
	`RSD
(
cuºMB
->
block_y_aff
 + 
j0
)>>1][RSD(
i0
)] : &currSlice->listX[LIST_1+2][0]->mv_info[(currMB->block_y_aff + j0)>>1][i0];

78 
cﬁoˇãd
 = 
p_Vid
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
 ?

79 &
cuºSli˚
->
li°X
[
LIST_1
+4][0]->
mv_öfo
[
	`RSD
(
cuºMB
->
block_y_aff
 + 
j0
)>>1][RSD(
i0
)] : &currSlice->listX[LIST_1+4][0]->mv_info[(currMB->block_y_aff + j0)>>1][i0];

83 if(!
p_Vid
->
a˘ive_•s
->
‰ame_mbs_⁄ly_Êag
 && !
cuºSli˚
->
fõld_pic_Êag
 && cuºSli˚->
li°X
[
LIST_1
][0]->
iCodögTy≥
 !
FRAME_CODING
)

85 i‡(
	`übs
(
dec_pi˘uª
->
poc
 - 
li°1
[0]->
bŸtom_fõld
->poc)> iabs(dec_pi˘uª->po¯-li°1[0]->
t›_fõld
->poc) )

87 
cﬁoˇãd
 = 
p_Vid
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
 ?

88 &
li°1
[0]->
t›_fõld
->
mv_öfo
[
	`RSD
(
cuºMB
->
block_y_aff
 + 
j0
)>>1][RSD(
i0
)] : &list1[0]->top_field->mv_info[(currMB->block_y_aff + j0)>>1][i0];

92 
cﬁoˇãd
 = 
p_Vid
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
 ?

93 &
li°1
[0]->
bŸtom_fõld
->
mv_öfo
[
	`RSD
(
cuºMB
->
block_y_aff
 + 
j0
)>>1][RSD(
i0
)] : &list1[0]->bottom_field->mv_info[(currMB->block_y_aff + j0)>>1][i0];

96 if(!
p_Vid
->
a˘ive_•s
->
‰ame_mbs_⁄ly_Êag
 && 
cuºSli˚
->
fõld_pic_Êag
 && cuºSli˚->
°ru˘uª
!=
li°1
[0]->°ru˘uª &&Üi°1[0]->
coded_‰ame
)

98 i‡(
cuºSli˚
->
°ru˘uª
 =
TOP_FIELD
)

100 
cﬁoˇãd
 = 
p_Vid
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
 ?

101 &
li°1
[0]->
‰ame
->
t›_fõld
->
mv_öfo
[
	`RSD
(
cuºMB
->
block_y_aff
 + 
j0
)][RSD(
i0
)] : &list1[0]->frame->top_field->mv_info[currMB->block_y_aff + j0][i0];

105 
cﬁoˇãd
 = 
p_Vid
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
 ?

106 &
li°1
[0]->
‰ame
->
bŸtom_fõld
->
mv_öfo
[
	`RSD
(
cuºMB
->
block_y_aff
 + 
j0
)][RSD(
i0
)] : &list1[0]->frame->bottom_field->mv_info[currMB->block_y_aff + j0][i0];

110 
ªfLi°
 = 
cﬁoˇãd
->
ªf_idx
[
LIST_0
 ]=-1 ? 
LIST_1
 : LIST_0;

111 
ªf_idx
 = 
cﬁoˇãd
->ªf_idx[
ªfLi°
];

113 i‡(
ªf_idx
 == -1)

115 
j4
 = 
cuºMB
->
block_y
 + 
j0
; j4 < cuºMB->block_y + j0 + 
°ï_v0
; ++j4)

117 
i4
 = 
i0
; i4 < i0 + 
°ï_h0
; ++i4)

119 
PicMŸi⁄P¨ams
 *
mv_öfo
 = &
dec_pi˘uª
->mv_öfo[
j4
][
i4
];

120 
mv_öfo
->
ªf_pic
[
LIST_0
] = 
li°0
[0];

121 
mv_öfo
->
ªf_pic
[
LIST_1
] = 
li°1
[0];

122 
mv_öfo
->
mv
 [
LIST_0
] = 
zîo_mv
;

123 
mv_öfo
->
mv
 [
LIST_1
] = 
zîo_mv
;

124 
mv_öfo
->
ªf_idx
 [
LIST_0
] = 0;

125 
mv_öfo
->
ªf_idx
 [
LIST_1
] = 0;

131 if–(
cuºSli˚
->
mb_aff_‰ame_Êag
 && ( (
cuºMB
->
mb_fõld
 && 
cﬁoˇãd
->
ªf_pic
[
ªfLi°
]->
°ru˘uª
==
FRAME
) ||

132 (!
cuºMB
->
mb_fõld
 && 
cﬁoˇãd
->
ªf_pic
[
ªfLi°
]->
°ru˘uª
!=
FRAME
))) ||

133 (!
cuºSli˚
->
mb_aff_‰ame_Êag
 && ((cuºSli˚->
fõld_pic_Êag
==0 && 
cﬁoˇãd
->
ªf_pic
[
ªfLi°
]->
°ru˘uª
!=
FRAME
)||

134 (
cuºSli˚
->
fõld_pic_Êag
==1 && 
cﬁoˇãd
->
ªf_pic
[
ªfLi°
]->
°ru˘uª
==
FRAME
))) )

137 
úef
 = 0; iª‡< 
	`imö
(
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
], cuºSli˚->
li°Xsize
[LIST_0 + 
li°_off£t
]); ++iref)

139 i‡(
cuºSli˚
->
li°X
[
LIST_0
 + 
li°_off£t
][
úef
]->
t›_fõld
 =
cﬁoˇãd
->
ªf_pic
[
ªfLi°
] ||

140 
cuºSli˚
->
li°X
[
LIST_0
 + 
li°_off£t
][
úef
]->
bŸtom_fõld
 =
cﬁoˇãd
->
ªf_pic
[
ªfLi°
] ||

141 
cuºSli˚
->
li°X
[
LIST_0
 + 
li°_off£t
][
úef
]->
‰ame
 =
cﬁoˇãd
->
ªf_pic
[
ªfLi°
] )

143 i‡((
cuºSli˚
->
fõld_pic_Êag
==1Ë&& (cuºSli˚->
li°X
[
LIST_0
 + 
li°_off£t
][
úef
]->
°ru˘uª
 != currSlice->structure))

145 
m≠≥d_idx
=
INVALIDINDEX
;

149 
m≠≥d_idx
 = 
úef
;

154 
m≠≥d_idx
=
INVALIDINDEX
;

159 
úef
 = 0; iª‡< 
	`imö
(
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
], cuºSli˚->
li°Xsize
[LIST_0 + 
li°_off£t
]); ++iref)

161 i‡(
cuºSli˚
->
li°X
[
LIST_0
 + 
li°_off£t
][
úef
] =
cﬁoˇãd
->
ªf_pic
[
ªfLi°
])

163 
m≠≥d_idx
=
úef
;

167 
m≠≥d_idx
=
INVALIDINDEX
;

171 i‡(
m≠≥d_idx
 !
INVALIDINDEX
)

173 
j
 = 
j0
; j < j0 + 
°ï_v0
; ++j)

175 
j4
 = 
cuºMB
->
block_y
 + 
j
;

176 
j6
 = 
cuºMB
->
block_y_aff
 + 
j
;

178 
i4
 = 
i0
; i4 < i0 + 
°ï_h0
; ++i4)

180 
PicMŸi⁄P¨ams
 *
cﬁoˇãd
 = 
p_Vid
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
 ?

181 &
li°1
[0]->
mv_öfo
[
	`RSD
(
j6
)][RSD(
i4
)] : &list1[0]->mv_info[j6][i4];

182 
PicMŸi⁄P¨ams
 *
mv_öfo
 = &
dec_pi˘uª
->mv_öfo[
j4
][
i4
];

183 
mv_y
;

184 if(
cuºSli˚
->
mb_aff_‰ame_Êag
 )

186 if(!
cuºMB
->
mb_fõld
 && ((
cuºSli˚
->
li°X
[
LIST_1
][0]->
iCodögTy≥
==
FRAME_MB_PAIR_CODING
 && cuºSli˚->li°X[LIST_1][0]->
mŸi⁄
.mb_fõld[cuºMB->
mbAddrX
]) ||

187 (
cuºSli˚
->
li°X
[
LIST_1
][0]->
iCodögTy≥
==
FIELD_CODING
)))

189 i‡(
	`übs
(
dec_pi˘uª
->
poc
 - 
cuºSli˚
->
li°X
[
LIST_1
+4][0]->poc)> iabs(dec_picture->poc -currSlice->listX[LIST_1+2][0]->poc) )

191 
cﬁoˇãd
 = 
p_Vid
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
 ?

192 &
cuºSli˚
->
li°X
[
LIST_1
+2][0]->
mv_öfo
[
	`RSD
(
j6
)>>1][RSD(
i4
)] : &currSlice->listX[LIST_1+2][0]->mv_info[j6>>1][i4];

196 
cﬁoˇãd
 = 
p_Vid
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
 ?

197 &
cuºSli˚
->
li°X
[
LIST_1
+4][0]->
mv_öfo
[
	`RSD
(
j6
)>>1][RSD(
i4
)] : &currSlice->listX[LIST_1+4][0]->mv_info[j6>>1][i4];

201 if–!
p_Vid
->
a˘ive_•s
->
‰ame_mbs_⁄ly_Êag
 && !
cuºSli˚
->
fõld_pic_Êag
 && cuºSli˚->
li°X
[
LIST_1
][0]->
iCodögTy≥
!=
FRAME_CODING
)

203 i‡(
	`übs
(
dec_pi˘uª
->
poc
 - 
li°1
[0]->
bŸtom_fõld
->poc)> iabs(dec_pi˘uª->po¯-li°1[0]->
t›_fõld
->poc) )

205 
cﬁoˇãd
 = 
p_Vid
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
 ?

206 &
li°1
[0]->
t›_fõld
->
mv_öfo
[
	`RSD
(
j6
)>>1][RSD(
i4
)] : &list1[0]->top_field->mv_info[(j6)>>1][i4];

210 
cﬁoˇãd
 = 
p_Vid
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
 ?

211 &
li°1
[0]->
bŸtom_fõld
->
mv_öfo
[
	`RSD
(
j6
)>>1][RSD(
i4
)] : &list1[0]->bottom_field->mv_info[(j6)>>1][i4];

214 if(!
p_Vid
->
a˘ive_•s
->
‰ame_mbs_⁄ly_Êag
 && 
cuºSli˚
->
fõld_pic_Êag
 && cuºSli˚->
°ru˘uª
!=
li°1
[0]->°ru˘uª &&Üi°1[0]->
coded_‰ame
)

216 i‡(
cuºSli˚
->
°ru˘uª
 =
TOP_FIELD
)

218 
cﬁoˇãd
 = 
p_Vid
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
 ?

219 &
li°1
[0]->
‰ame
->
t›_fõld
->
mv_öfo
[
	`RSD
(
j6
)][RSD(
i4
)] : &list1[0]->frame->top_field->mv_info[j6][i4];

223 
cﬁoˇãd
 = 
p_Vid
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
 ?

224 &
li°1
[0]->
‰ame
->
bŸtom_fõld
->
mv_öfo
[
	`RSD
(
j6
)][RSD(
i4
)] : &list1[0]->frame->bottom_field->mv_info[j6][i4];

228 
mv_y
 = 
cﬁoˇãd
->
mv
[
ªfLi°
].mv_y;

229 if((
cuºSli˚
->
mb_aff_‰ame_Êag
 && !
cuºMB
->
mb_fõld
 && 
cﬁoˇãd
->
ªf_pic
[
ªfLi°
]->
°ru˘uª
!=
FRAME
) ||

230 (!
cuºSli˚
->
mb_aff_‰ame_Êag
 && cuºSli˚->
fõld_pic_Êag
==0 && 
cﬁoˇãd
->
ªf_pic
[
ªfLi°
]->
°ru˘uª
!=
FRAME
))

231 
mv_y
 *= 2;

232 if((
cuºSli˚
->
mb_aff_‰ame_Êag
 && 
cuºMB
->
mb_fõld
 && 
cﬁoˇãd
->
ªf_pic
[
ªfLi°
]->
°ru˘uª
==
FRAME
) ||

233 (!
cuºSli˚
->
mb_aff_‰ame_Êag
 && cuºSli˚->
fõld_pic_Êag
==1 && 
cﬁoˇãd
->
ªf_pic
[
ªfLi°
]->
°ru˘uª
==
FRAME
))

234 
mv_y
 /= 2;

236 
mv_sˇÀ
 = 
cuºSli˚
->
mvsˇÀ
[
LIST_0
 + 
li°_off£t
][
m≠≥d_idx
];

238 
mv_öfo
->
ªf_idx
 [
LIST_0
] = (Ë
m≠≥d_idx
;

239 
mv_öfo
->
ªf_idx
 [
LIST_1
] = 0;

241 
mv_öfo
->
ªf_pic
[
LIST_0
] = 
li°0
[
m≠≥d_idx
];

242 
mv_öfo
->
ªf_pic
[
LIST_1
] = 
li°1
[0];

244 i‡(
mv_sˇÀ
 =9999 || 
cuºSli˚
->
li°X
[
LIST_0
+
li°_off£t
][
m≠≥d_idx
]->
is_l⁄g_ãrm
)

246 
mv_öfo
->
mv
[
LIST_0
].
mv_x
 = 
cﬁoˇãd
->mv[
ªfLi°
].mv_x;

247 
mv_öfo
->
mv
[
LIST_0
].
mv_y
 = () mv_y;

248 
mv_öfo
->
mv
[
LIST_1
] = 
zîo_mv
;

252 
mv_öfo
->
mv
[
LIST_0
].
mv_x
 = (Ë((
mv_sˇÀ
 * 
cﬁoˇãd
->mv[
ªfLi°
].mv_x + 128 ) >> 8);

253 
mv_öfo
->
mv
[
LIST_0
].
mv_y
 = (Ë((
mv_sˇÀ
 * mv_y + 128 ) >> 8);

254 
mv_öfo
->
mv
[
LIST_1
].
mv_x
 = (Ë(mv_öfo->mv[
LIST_0
].mv_x - 
cﬁoˇãd
->mv[
ªfLi°
].mv_x);

255 
mv_öfo
->
mv
[
LIST_1
].
mv_y
 = (Ë(mv_öfo->mv[
LIST_0
].mv_y - mv_y );

260 i‡(
INVALIDINDEX
 =
m≠≥d_idx
)

262 
	`îr‹
("temporal directÉrror: colocated block hasÑefÅhat is unavailable",-1111);

270 
	}
}

273 
ölöe
 
	$upd©e_√ighb‹_mvs
(
PicMŸi⁄P¨ams
 **
mŸi⁄
, c⁄° PicMŸi⁄P¨am†*
mv_öfo
, 
i4
)

275 (*
mŸi⁄
++)[
i4
 + 1] = *
mv_öfo
;

276 (*
mŸi⁄
 )[
i4
 ] = *
mv_öfo
;

277 (*
mŸi⁄
 )[
i4
 + 1] = *
mv_öfo
;

278 
	}
}

286 
	$gë_cﬁoˇãd_öfo_4x4
(
Ma¸oblock
 *
cuºMB
, 
St‹abÀPi˘uª
 *
li°1
, 
i
, 
j
)

288 i‡(
li°1
->
is_l⁄g_ãrm
)

292 
PicMŸi⁄P¨ams
 *
fs
 = &
li°1
->
mv_öfo
[
j
][
i
];

294 
movög
 = !(((

295 (
fs
->
ªf_idx
[
LIST_0
] == 0)

296 && (
	`übs
(
fs
->
mv
[
LIST_0
].
mv_x
)>>1 == 0)

297 && (
	`übs
(
fs
->
mv
[
LIST_0
].
mv_y
)>>1 == 0)))

298 || ((
fs
->
ªf_idx
[
LIST_0
] == -1)

299 && (
fs
->
ªf_idx
[
LIST_1
] == 0)

300 && (
	`übs
(
fs
->
mv
[
LIST_1
].
mv_x
)>>1 == 0)

301 && (
	`übs
(
fs
->
mv
[
LIST_1
].
mv_y
)>>1 == 0)));

303  
movög
;

305 
	}
}

314 
	$gë_cﬁoˇãd_öfo_8x8
(
Ma¸oblock
 *
cuºMB
, 
St‹abÀPi˘uª
 *
li°1
, 
i
, 
j
)

316 i‡(
li°1
->
is_l⁄g_ãrm
)

320 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

321 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

322 if–(
cuºSli˚
->
mb_aff_‰ame_Êag
) ||

323 (!
p_Vid
->
a˘ive_•s
->
‰ame_mbs_⁄ly_Êag
 && ((!
cuºSli˚
->
°ru˘uª
 && 
li°1
->
iCodögTy≥
 =
FIELD_CODING
)||(cuºSli˚->°ru˘uª!ˆi°1->°ru˘uª &&Üi°1->
coded_‰ame
))))

325 
jj
 = 
	`RSD
(
j
);

326 
ii
 = 
	`RSD
(
i
);

327 
jdiv
 = (
jj
>>1);

328 
movög
;

329 
PicMŸi⁄P¨ams
 *
fs
 = &
li°1
->
mv_öfo
[
jj
][
ii
];

331 if(
cuºSli˚
->
fõld_pic_Êag
 && cuºSli˚->
°ru˘uª
!=
li°1
->°ru˘uª &&Üi°1->
coded_‰ame
)

333 if(
cuºSli˚
->
°ru˘uª
 =
TOP_FIELD
)

334 
fs
 = 
li°1
->
t›_fõld
->
mv_öfo
[
jj
] + 
ii
;

336 
fs
 = 
li°1
->
bŸtom_fõld
->
mv_öfo
[
jj
] + 
ii
;

340 if–(
cuºSli˚
->
mb_aff_‰ame_Êag
 && ((!
cuºMB
->
mb_fõld
 && 
li°1
->
mŸi⁄
.mb_fõld[cuºMB->
mbAddrX
]) ||

341 (!
cuºMB
->
mb_fõld
 && 
li°1
->
iCodögTy≥
 =
FIELD_CODING
)))

342 || (!
cuºSli˚
->
mb_aff_‰ame_Êag
))

344 i‡(
	`übs
(
cuºSli˚
->
dec_pi˘uª
->
poc
 - 
li°1
->
bŸtom_fõld
->poc)> iabs(cuºSli˚->dec_pi˘uª->po¯-li°1->
t›_fõld
->poc) )

346 
fs
 = 
li°1
->
t›_fõld
->
mv_öfo
[
jdiv
] + 
ii
;

350 
fs
 = 
li°1
->
bŸtom_fõld
->
mv_öfo
[
jdiv
] + 
ii
;

354 
movög
 = !((((
fs
->
ªf_idx
[
LIST_0
] == 0)

355 && (
	`übs
(
fs
->
mv
[
LIST_0
].
mv_x
)>>1 == 0)

356 && (
	`übs
(
fs
->
mv
[
LIST_0
].
mv_y
)>>1 == 0)))

357 || ((
fs
->
ªf_idx
[
LIST_0
] == -1)

358 && (
fs
->
ªf_idx
[
LIST_1
] == 0)

359 && (
	`übs
(
fs
->
mv
[
LIST_1
].
mv_x
)>>1 == 0)

360 && (
	`übs
(
fs
->
mv
[
LIST_1
].
mv_y
)>>1 == 0)));

361  
movög
;

365 
PicMŸi⁄P¨ams
 *
fs
 = &
li°1
->
mv_öfo
[
	`RSD
(
j
)][RSD(
i
)];

366 
movög
;

367 if(
cuºMB
->
p_Vid
->
£∑øã_cﬁour_∂™e_Êag
 && cuºMB->p_Vid->
yuv_f‹m©
==
YUV444
)

368 
fs
 = &
li°1
->
JVmv_öfo
[
cuºMB
->
p_Sli˚
->
cﬁour_∂™e_id
][
	`RSD
(
j
)][RSD(
i
)];

369 
movög
!((((
fs
->
ªf_idx
[
LIST_0
] == 0)

370 && (
	`übs
(
fs
->
mv
[
LIST_0
].
mv_x
)>>1 == 0)

371 && (
	`übs
(
fs
->
mv
[
LIST_0
].
mv_y
)>>1 == 0)))

372 || ((
fs
->
ªf_idx
[
LIST_0
] == -1)

373 && (
fs
->
ªf_idx
[
LIST_1
] == 0)

374 && (
	`übs
(
fs
->
mv
[
LIST_1
].
mv_x
)>>1 == 0)

375 && (
	`übs
(
fs
->
mv
[
LIST_1
].
mv_y
)>>1 == 0)));

376  
movög
;

379 
	}
}

382 
	$upd©e_dúe˘_mv_öfo_•©ül_8x8
(
Ma¸oblock
 *
cuºMB
)

384 
Boﬁón
 
has_dúe˘
 = (
cuºMB
->
b8mode
[0] == 0) | (currMB->b8mode[1] == 0) | (currMB->b8mode[2] == 0) | (currMB->b8mode[3] == 0);

386 i‡(
has_dúe˘
)

389 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

390 
i
,
j
,
k
;

392 
j4
, 
i4
;

393 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
cuºSli˚
->dec_picture;

395 
li°_off£t
 = 
cuºMB
->list_offset;

396 
St‹abÀPi˘uª
 **
li°0
 = 
cuºSli˚
->
li°X
[
LIST_0
 + 
li°_off£t
];

397 
St‹abÀPi˘uª
 **
li°1
 = 
cuºSli˚
->
li°X
[
LIST_1
 + 
li°_off£t
];

399 
l0_rFøme
, 
l1_rFøme
;

400 
MŸi⁄Ve˘‹
 
pmvl0
, 
pmvl1
;

401 
is_nŸ_movög
;

402 
PicMŸi⁄P¨ams
 *
mv_öfo
 = 
NULL
;

404 
	`¥ï¨e_dúe˘_∑øms
(
cuºMB
, 
dec_pi˘uª
, &
pmvl0
, &
pmvl1
, &
l0_rFøme
, &
l1_rFøme
);

406 
k
 = 0; k < 4; ++k)

408 i‡(
cuºMB
->
b8mode
[
k
] == 0)

410 
i
 = 2 * (
k
 & 0x01);

411 
j
 = 2 * (
k
 >> 1);

414 
j4
 = 
cuºMB
->
block_y
 + 
j
;

415 
i4
 = 
cuºMB
->
block_x
 + 
i
;

417 
mv_öfo
 = &
dec_pi˘uª
->mv_öfo[
j4
][
i4
];

419 
is_nŸ_movög
 = (
	`gë_cﬁoˇãd_öfo_8x8
(
cuºMB
, 
li°1
[0], 
i4
, cuºMB->
block_y_aff
 + 
j
) == 0);

421 i‡(
is_nŸ_movög
 && (
l0_rFøme
 =0 || 
l1_rFøme
 == 0))

423 i‡(
l1_rFøme
 == -1)

425 i‡(
l0_rFøme
 == 0)

427 
mv_öfo
->
ªf_pic
[
LIST_0
] = 
li°0
[0];

428 
mv_öfo
->
ªf_pic
[
LIST_1
] = 
li°1
[0];

429 
mv_öfo
->
mv
[
LIST_0
] = 
zîo_mv
;

430 
mv_öfo
->
mv
[
LIST_1
] = 
zîo_mv
;

431 
mv_öfo
->
ªf_idx
[
LIST_0
] = 0;

432 
mv_öfo
->
ªf_idx
[
LIST_1
] = -1;

436 
mv_öfo
->
ªf_pic
[
LIST_0
] = 
li°0
[(Ë
l0_rFøme
];

437 
mv_öfo
->
ªf_pic
[
LIST_1
] = 
NULL
;

438 
mv_öfo
->
mv
[
LIST_0
] = 
pmvl0
;

439 
mv_öfo
->
mv
[
LIST_1
] = 
zîo_mv
;

440 
mv_öfo
->
ªf_idx
[
LIST_0
] = 
l0_rFøme
;

441 
mv_öfo
->
ªf_idx
[
LIST_1
] = -1;

444 i‡(
l0_rFøme
 == -1)

446 i‡(
l1_rFøme
 == 0)

448 
mv_öfo
->
ªf_pic
[
LIST_0
] = 
NULL
;

449 
mv_öfo
->
ªf_pic
[
LIST_1
] = 
li°1
[0];

450 
mv_öfo
->
mv
[
LIST_0
] = 
zîo_mv
;

451 
mv_öfo
->
mv
[
LIST_1
] = 
zîo_mv
;

452 
mv_öfo
->
ªf_idx
[
LIST_0
] = -1;

453 
mv_öfo
->
ªf_idx
[
LIST_1
] = 0;

457 
mv_öfo
->
ªf_pic
[
LIST_0
] = 
NULL
;

458 
mv_öfo
->
ªf_pic
[
LIST_1
] = 
li°1
[(Ë
l1_rFøme
];

459 
mv_öfo
->
mv
[
LIST_0
] = 
zîo_mv
;

460 
mv_öfo
->
mv
[
LIST_1
] = 
pmvl1
;

461 
mv_öfo
->
ªf_idx
[
LIST_0
] = -1;

462 
mv_öfo
->
ªf_idx
[
LIST_1
] = 
l1_rFøme
;

467 i‡(
l0_rFøme
 == 0)

469 
mv_öfo
->
ªf_pic
[
LIST_0
] = 
li°0
[0];

470 
mv_öfo
->
mv
[
LIST_0
] = 
zîo_mv
;

471 
mv_öfo
->
ªf_idx
[
LIST_0
] = 0;

475 
mv_öfo
->
ªf_pic
[
LIST_1
] = 
li°1
[(Ë
l0_rFøme
];

476 
mv_öfo
->
mv
[
LIST_0
] = 
pmvl0
;

477 
mv_öfo
->
ªf_idx
[
LIST_0
] = 
l0_rFøme
;

480 i‡(
l1_rFøme
 == 0)

482 
mv_öfo
->
ªf_pic
[
LIST_1
] = 
li°1
[0];

483 
mv_öfo
->
mv
[
LIST_1
] = 
zîo_mv
;

484 
mv_öfo
->
ªf_idx
[
LIST_1
] = 0;

488 
mv_öfo
->
ªf_pic
[
LIST_1
] = 
li°1
[(Ë
l1_rFøme
];

489 
mv_öfo
->
mv
[
LIST_1
] = 
pmvl1
;

490 
mv_öfo
->
ªf_idx
[
LIST_1
] = 
l1_rFøme
;

496 i‡(
l0_rFøme
 < 0 && 
l1_rFøme
 < 0)

498 
mv_öfo
->
ªf_pic
[
LIST_0
] = 
li°0
[0];

499 
mv_öfo
->
ªf_pic
[
LIST_1
] = 
li°1
[0];

500 
mv_öfo
->
mv
[
LIST_0
] = 
zîo_mv
;

501 
mv_öfo
->
mv
[
LIST_1
] = 
zîo_mv
;

502 
mv_öfo
->
ªf_idx
[
LIST_0
] = 0;

503 
mv_öfo
->
ªf_idx
[
LIST_1
] = 0;

505 i‡(
l0_rFøme
 < 0)

507 
mv_öfo
->
ªf_pic
[
LIST_0
] = 
NULL
;

508 
mv_öfo
->
ªf_pic
[
LIST_1
] = 
li°1
[(Ë
l1_rFøme
];

509 
mv_öfo
->
mv
[
LIST_0
] = 
zîo_mv
;

510 
mv_öfo
->
mv
[
LIST_1
] = 
pmvl1
;

511 
mv_öfo
->
ªf_idx
[
LIST_0
] = -1;

512 
mv_öfo
->
ªf_idx
[
LIST_1
] = 
l1_rFøme
;

514 i‡(
l1_rFøme
 < 0)

516 
mv_öfo
->
ªf_pic
[
LIST_0
] = 
li°0
[(Ë
l0_rFøme
];

517 
mv_öfo
->
ªf_pic
[
LIST_1
] = 
NULL
;

519 
mv_öfo
->
mv
[
LIST_0
] = 
pmvl0
;

520 
mv_öfo
->
mv
[
LIST_1
] = 
zîo_mv
;

521 
mv_öfo
->
ªf_idx
[
LIST_0
] = 
l0_rFøme
;

522 
mv_öfo
->
ªf_idx
[
LIST_1
] = -1;

526 
mv_öfo
->
ªf_pic
[
LIST_0
] = 
li°0
[(Ë
l0_rFøme
];

527 
mv_öfo
->
ªf_pic
[
LIST_1
] = 
li°1
[(Ë
l1_rFøme
];

528 
mv_öfo
->
mv
[
LIST_0
] = 
pmvl0
;

529 
mv_öfo
->
mv
[
LIST_1
] = 
pmvl1
;

530 
mv_öfo
->
ªf_idx
[
LIST_0
] = 
l0_rFøme
;

531 
mv_öfo
->
ªf_idx
[
LIST_1
] = 
l1_rFøme
;

534 
	`upd©e_√ighb‹_mvs
(&
dec_pi˘uª
->
mv_öfo
[
j4
], mv_öfo, 
i4
);

538 
	}
}

540 
	$upd©e_dúe˘_mv_öfo_•©ül_4x4
(
Ma¸oblock
 *
cuºMB
)

542 
Boﬁón
 
has_dúe˘
 = (
cuºMB
->
b8mode
[0] == 0) | (currMB->b8mode[1] == 0) | (currMB->b8mode[2] == 0) | (currMB->b8mode[3] == 0);

544 i‡(
has_dúe˘
)

546 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

547 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

548 
i
,
j
,
k
;

550 
j4
, 
i4
;

551 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
p_Vid
->dec_picture;

553 
li°_off£t
 = 
cuºMB
->list_offset;

554 
St‹abÀPi˘uª
 **
li°0
 = 
cuºSli˚
->
li°X
[
LIST_0
 + 
li°_off£t
];

555 
St‹abÀPi˘uª
 **
li°1
 = 
cuºSli˚
->
li°X
[
LIST_1
 + 
li°_off£t
];

557 
l0_rFøme
, 
l1_rFøme
;

558 
MŸi⁄Ve˘‹
 
pmvl0
, 
pmvl1
;

560 
	`¥ï¨e_dúe˘_∑øms
(
cuºMB
, 
dec_pi˘uª
, &
pmvl0
, &
pmvl1
, &
l0_rFøme
, &
l1_rFøme
);

561 
k
 = 0; k < 4; ++k)

563 i‡(
cuºMB
->
b8mode
[
k
] == 0)

566 
i
 = 2 * (
k
 & 0x01);

567 
j
 = 2 * (
k
 >> 1); j < 2 * (k >> 1)+2;++j)

569 
j4
 = 
cuºMB
->
block_y
 + 
j
;

571 
i4
 = 
cuºMB
->
block_x
 + 
i
; i4 < currMB->block_x + i + 2; ++i4)

573 
PicMŸi⁄P¨ams
 *
mv_öfo
 = &
dec_pi˘uª
->mv_öfo[
j4
][
i4
];

575 i‡(
l0_rFøme
 =0 || 
l1_rFøme
 == 0)

577 
is_nŸ_movög
 = (
	`gë_cﬁoˇãd_öfo_4x4
(
cuºMB
, 
li°1
[0], 
i4
, cuºMB->
block_y_aff
 + 
j
) == 0);

579 i‡(
l1_rFøme
 == -1)

581 i‡(
is_nŸ_movög
)

583 
mv_öfo
->
ªf_pic
[
LIST_0
] = 
li°0
[0];

584 
mv_öfo
->
ªf_pic
[
LIST_1
] = 
NULL
;

585 
mv_öfo
->
mv
[
LIST_0
] = 
zîo_mv
;

586 
mv_öfo
->
mv
[
LIST_1
] = 
zîo_mv
;

587 
mv_öfo
->
ªf_idx
[
LIST_0
] = 0;

588 
mv_öfo
->
ªf_idx
[
LIST_1
] = -1;

592 
mv_öfo
->
ªf_pic
[
LIST_0
] = 
li°0
[(Ë
l0_rFøme
];

593 
mv_öfo
->
ªf_pic
[
LIST_1
] = 
NULL
;

594 
mv_öfo
->
mv
[
LIST_0
] = 
pmvl0
;

595 
mv_öfo
->
mv
[
LIST_1
] = 
zîo_mv
;

596 
mv_öfo
->
ªf_idx
[
LIST_0
] = 
l0_rFøme
;

597 
mv_öfo
->
ªf_idx
[
LIST_1
] = -1;

600 i‡(
l0_rFøme
 == -1)

602 i‡(
is_nŸ_movög
)

604 
mv_öfo
->
ªf_pic
[
LIST_0
] = 
NULL
;

605 
mv_öfo
->
ªf_pic
[
LIST_1
] = 
li°1
[0];

606 
mv_öfo
->
mv
[
LIST_0
] = 
zîo_mv
;

607 
mv_öfo
->
mv
[
LIST_1
] = 
zîo_mv
;

608 
mv_öfo
->
ªf_idx
[
LIST_0
] = -1;

609 
mv_öfo
->
ªf_idx
[
LIST_1
] = 0;

613 
mv_öfo
->
ªf_pic
[
LIST_0
] = 
NULL
;

614 
mv_öfo
->
ªf_pic
[
LIST_1
] = 
li°1
[(Ë
l1_rFøme
];

615 
mv_öfo
->
mv
[
LIST_0
] = 
zîo_mv
;

616 
mv_öfo
->
mv
[
LIST_1
] = 
pmvl1
;

617 
mv_öfo
->
ªf_idx
[
LIST_0
] = -1;

618 
mv_öfo
->
ªf_idx
[
LIST_1
] = 
l1_rFøme
;

623 i‡(
l0_rFøme
 =0 && ((
is_nŸ_movög
)))

625 
mv_öfo
->
ªf_pic
[
LIST_0
] = 
li°0
[0];

626 
mv_öfo
->
mv
[
LIST_0
] = 
zîo_mv
;

627 
mv_öfo
->
ªf_idx
[
LIST_0
] = 0;

631 
mv_öfo
->
ªf_pic
[
LIST_0
] = 
li°0
[(Ë
l0_rFøme
];

632 
mv_öfo
->
mv
[
LIST_0
] = 
pmvl0
;

633 
mv_öfo
->
ªf_idx
[
LIST_0
] = 
l0_rFøme
;

636 i‡(
l1_rFøme
 =0 && ((
is_nŸ_movög
)))

638 
mv_öfo
->
ªf_pic
[
LIST_1
] = 
li°1
[0];

639 
mv_öfo
->
mv
[
LIST_1
] = 
zîo_mv
;

640 
mv_öfo
->
ªf_idx
[
LIST_1
] = 0;

644 
mv_öfo
->
ªf_pic
[
LIST_1
] = 
li°1
[(Ë
l1_rFøme
];

645 
mv_öfo
->
mv
[
LIST_1
] = 
pmvl1
;

646 
mv_öfo
->
ªf_idx
[
LIST_1
] = 
l1_rFøme
;

652 
mv_öfo
 = &
dec_pi˘uª
->mv_öfo[
j4
][
i4
];

654 i‡(
l0_rFøme
 < 0 && 
l1_rFøme
 < 0)

656 
mv_öfo
->
ªf_pic
[
LIST_0
] = 
li°0
[0];

657 
mv_öfo
->
ªf_pic
[
LIST_1
] = 
li°1
[0];

658 
mv_öfo
->
mv
[
LIST_0
] = 
zîo_mv
;

659 
mv_öfo
->
mv
[
LIST_1
] = 
zîo_mv
;

660 
mv_öfo
->
ªf_idx
[
LIST_0
] = 0;

661 
mv_öfo
->
ªf_idx
[
LIST_1
] = 0;

663 i‡(
l1_rFøme
 == -1)

665 
mv_öfo
->
ªf_pic
[
LIST_0
] = 
li°0
[(Ë
l0_rFøme
];

666 
mv_öfo
->
ªf_pic
[
LIST_1
] = 
NULL
;

667 
mv_öfo
->
mv
[
LIST_0
] = 
pmvl0
;

668 
mv_öfo
->
mv
[
LIST_1
] = 
zîo_mv
;

669 
mv_öfo
->
ªf_idx
[
LIST_0
] = 
l0_rFøme
;

670 
mv_öfo
->
ªf_idx
[
LIST_1
] = -1;

672 i‡(
l0_rFøme
 == -1)

674 
mv_öfo
->
ªf_pic
[
LIST_0
] = 
NULL
;

675 
mv_öfo
->
ªf_pic
[
LIST_1
] = 
li°1
[(Ë
l1_rFøme
];

676 
mv_öfo
->
mv
[
LIST_0
] = 
zîo_mv
;

677 
mv_öfo
->
mv
[
LIST_1
] = 
pmvl1
;

678 
mv_öfo
->
ªf_idx
[
LIST_0
] = -1;

679 
mv_öfo
->
ªf_idx
[
LIST_1
] = 
l1_rFøme
;

683 
mv_öfo
->
ªf_pic
[
LIST_0
] = 
li°0
[(Ë
l0_rFøme
];

684 
mv_öfo
->
ªf_pic
[
LIST_1
] = 
li°1
[(Ë
l1_rFøme
];

685 
mv_öfo
->
mv
[
LIST_0
] = 
pmvl0
;

686 
mv_öfo
->
mv
[
LIST_1
] = 
pmvl1
;

687 
mv_öfo
->
ªf_idx
[
LIST_0
] = 
l0_rFøme
;

688 
mv_öfo
->
ªf_idx
[
LIST_1
] = 
l1_rFøme
;

696 
	}
}

699 
	$upd©e_dúe˘_ty≥s
(
Sli˚
 *
cuºSli˚
)

701 i‡(
cuºSli˚
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
)

702 
cuºSli˚
->
upd©e_dúe˘_mv_öfo
 = cuºSli˚->
dúe˘_•©ül_mv_¥ed_Êag
 ? 
upd©e_dúe˘_mv_öfo_•©ül_8x8
 : 
upd©e_dúe˘_mv_öfo_ãmp‹Æ
;

704 
cuºSli˚
->
upd©e_dúe˘_mv_öfo
 = cuºSli˚->
dúe˘_•©ül_mv_¥ed_Êag
 ? 
upd©e_dúe˘_mv_öfo_•©ül_4x4
 : 
upd©e_dúe˘_mv_öfo_ãmp‹Æ
;

705 
	}
}

	@ldecod/src/mc_prediction.c

17 
	~"globÆ.h
"

18 
	~"block.h
"

19 
	~"mc_¥edi˘i⁄.h
"

20 
	~"mbuf„r.h
"

21 
	~"mb_ac˚ss.h
"

22 
	~"ma¸oblock.h
"

23 
	~"memÆloc.h
"

24 
	~"dec_°©i°ics.h
"

26 
	$Æloˇã_¥ed_mem
(
Sli˚
 *
cuºSli˚
)

28 
Æloc_size
 = 0;

29 
Æloc_size
 +
	`gë_mem2D≥l
(&
cuºSli˚
->
tmp_block_l0
, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE);

30 
Æloc_size
 +
	`gë_mem2D≥l
(&
cuºSli˚
->
tmp_block_l1
, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE);

31 
Æloc_size
 +
	`gë_mem2D≥l
(&
cuºSli˚
->
tmp_block_l2
, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE);

32 
Æloc_size
 +
	`gë_mem2D≥l
(&
cuºSli˚
->
tmp_block_l3
, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE);

33 
Æloc_size
 +
	`gë_mem2Döt
(&
cuºSli˚
->
tmp_ªs
, 
MB_BLOCK_SIZE
 + 5, MB_BLOCK_SIZE + 5);

34  (
Æloc_size
);

35 
	}
}

37 
	$‰ì_¥ed_mem
(
Sli˚
 *
cuºSli˚
)

39 
	`‰ì_mem2Döt
(
cuºSli˚
->
tmp_ªs
);

40 
	`‰ì_mem2D≥l
(
cuºSli˚
->
tmp_block_l0
);

41 
	`‰ì_mem2D≥l
(
cuºSli˚
->
tmp_block_l1
);

42 
	`‰ì_mem2D≥l
(
cuºSli˚
->
tmp_block_l2
);

43 
	`‰ì_mem2D≥l
(
cuºSli˚
->
tmp_block_l3
);

44 
	}
}

46 c⁄° 
	gCOEF
[6] = { 1, -5, 20, 20, -5, 1 };

54 
	$mc_¥edi˘i⁄
(
img≥l
 **
mb_¥ed
, img≥»**
block
, 
block_size_y
, 
block_size_x
, 
ioff
)

57 
j
;

59 
j
 = 0; j < 
block_size_y
; j++)

61 
	`mem˝y
(&
mb_¥ed
[
j
][
ioff
], 
block
[j], 
block_size_x
 * (
img≥l
));

63 
	}
}

71 
	$weighãd_mc_¥edi˘i⁄
(
img≥l
 **
mb_¥ed
,

72 
img≥l
 **
block
,

73 
block_size_y
,

74 
block_size_x
,

75 
ioff
,

76 
wp_sˇÀ
,

77 
wp_off£t
,

78 
weight_díom
,

79 
cﬁ‹_˛ù
)

81 
i
, 
j
;

82 
ªsu…
;

84 
j
 = 0; j < 
block_size_y
; j++)

86 
i
 = 0; i < 
block_size_x
; i++)

88 
ªsu…
 = 
	`rshi·_∫d
((
wp_sˇÀ
 * 
block
[
j
][
i
]), 
weight_díom
Ë+ 
wp_off£t
;

89 
mb_¥ed
[
j
][
i
 + 
ioff
] = (
img≥l
)
	`iClù3
(0, 
cﬁ‹_˛ù
, 
ªsu…
);

92 
	}
}

102 
	$bi_¥edi˘i⁄
(
img≥l
 **
mb_¥ed
,

103 
img≥l
 **
block_l0
,

104 
img≥l
 **
block_l1
,

105 
block_size_y
,

106 
block_size_x
,

107 
ioff
)

109 
img≥l
 *
m¥
 = &
mb_¥ed
[0][
ioff
];

110 
img≥l
 *
b0
 = 
block_l0
[0];

111 
img≥l
 *
b1
 = 
block_l1
[0];

112 
ii
, 
jj
;

113 
row_öc
 = 
MB_BLOCK_SIZE
 - 
block_size_x
;

114 
jj
 = 0;jj < 
block_size_y
;jj++)

117 
ii
 = 0; iò< 
block_size_x
; ii += 2)

119 *(
m¥
++Ë(
img≥l
)(((*(
b0
++Ë+ *(
b1
++)) + 1) >> 1);

120 *(
m¥
++Ë(
img≥l
)(((*(
b0
++Ë+ *(
b1
++)) + 1) >> 1);

122 
m¥
 +
row_öc
;

123 
b0
 +
row_öc
;

124 
b1
 +
row_öc
;

126 
	}
}

136 
	$weighãd_bi_¥edi˘i⁄
(
img≥l
 *
mb_¥ed
,

137 
img≥l
 *
block_l0
,

138 
img≥l
 *
block_l1
,

139 
block_size_y
,

140 
block_size_x
,

141 
wp_sˇÀ_l0
,

142 
wp_sˇÀ_l1
,

143 
wp_off£t
,

144 
weight_díom
,

145 
cﬁ‹_˛ù
)

147 
i
, 
j
, 
ªsu…
;

148 
row_öc
 = 
MB_BLOCK_SIZE
 - 
block_size_x
;

150 
j
 = 0; j < 
block_size_y
; j++)

152 
i
 = 0; i < 
block_size_x
; i++)

154 
ªsu…
 = 
	`rshi·_∫d_sf
((
wp_sˇÀ_l0
 * *(
block_l0
++Ë+ 
wp_sˇÀ_l1
 * *(
block_l1
++)), 
weight_díom
);

156 *(
mb_¥ed
++Ë(
img≥l
Ë
	`iClù1
(
cﬁ‹_˛ù
, 
ªsu…
 + 
wp_off£t
);

158 
mb_¥ed
 +
row_öc
;

159 
block_l0
 +
row_öc
;

160 
block_l1
 +
row_öc
;

162 
	}
}

170 
	$gë_block_00
(
img≥l
 *
block
, img≥»*
cur_img
, 
•™
, 
block_size_y
)

174 
j
;

176 
j
 = 0; j < 
block_size_y
; j += 2)

178 
	`mem˝y
(
block
, 
cur_img
, 
MB_BLOCK_SIZE
 * (
img≥l
));

179 
block
 +
MB_BLOCK_SIZE
;

180 
cur_img
 +
•™
;

181 
	`mem˝y
(
block
, 
cur_img
, 
MB_BLOCK_SIZE
 * (
img≥l
));

182 
block
 +
MB_BLOCK_SIZE
;

183 
cur_img
 +
•™
;

185 
	}
}

194 
	$gë_luma_10
(
img≥l
 **
block
, img≥»**
cur_imgY
, 
block_size_y
, 
block_size_x
, 
x_pos
 , 
max_img≥l_vÆue
)

196 
img≥l
 *
p0
, *
p1
, *
p2
, *
p3
, *
p4
, *
p5
;

197 
img≥l
 *
‹ig_löe
, *
cur_löe
;

198 
i
, 
j
;

199 
ªsu…
;

201 
j
 = 0; j < 
block_size_y
; j++)

203 
cur_löe
 = &(
cur_imgY
[
j
][
x_pos
]);

204 
p0
 = &
cur_imgY
[
j
][
x_pos
 - 2];

205 
p1
 = 
p0
 + 1;

206 
p2
 = 
p1
 + 1;

207 
p3
 = 
p2
 + 1;

208 
p4
 = 
p3
 + 1;

209 
p5
 = 
p4
 + 1;

210 
‹ig_löe
 = 
block
[
j
];

212 
i
 = 0; i < 
block_size_x
; i++)

214 
ªsu…
 = (*(
p0
++Ë+ *(
p5
++)Ë- 5 * (*(
p1
++Ë+ *(
p4
++)Ë+ 20 * (*(
p2
++Ë+ *(
p3
++));

216 *
‹ig_löe
 = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((
ªsu…
 + 16)>>5));

217 *
‹ig_löe
 = (
img≥l
Ë((*‹ig_löê+ *(
cur_löe
++) + 1 ) >> 1);

218 
‹ig_löe
++;

221 
	}
}

229 
	$gë_luma_20
(
img≥l
 **
block
, img≥»**
cur_imgY
, 
block_size_y
, 
block_size_x
, 
x_pos
 , 
max_img≥l_vÆue
)

231 
img≥l
 *
p0
, *
p1
, *
p2
, *
p3
, *
p4
, *
p5
;

232 
img≥l
 *
‹ig_löe
;

233 
i
, 
j
;

234 
ªsu…
;

235 
j
 = 0; j < 
block_size_y
; j++)

237 
p0
 = &
cur_imgY
[
j
][
x_pos
 - 2];

238 
p1
 = 
p0
 + 1;

239 
p2
 = 
p1
 + 1;

240 
p3
 = 
p2
 + 1;

241 
p4
 = 
p3
 + 1;

242 
p5
 = 
p4
 + 1;

243 
‹ig_löe
 = 
block
[
j
];

245 
i
 = 0; i < 
block_size_x
; i++)

247 
ªsu…
 = (*(
p0
++Ë+ *(
p5
++)Ë- 5 * (*(
p1
++Ë+ *(
p4
++)Ë+ 20 * (*(
p2
++Ë+ *(
p3
++));

249 *
‹ig_löe
++ = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((
ªsu…
 + 16)>>5));

252 
	}
}

260 
	$gë_luma_30
(
img≥l
 **
block
, img≥»**
cur_imgY
, 
block_size_y
, 
block_size_x
, 
x_pos
 , 
max_img≥l_vÆue
)

262 
img≥l
 *
p0
, *
p1
, *
p2
, *
p3
, *
p4
, *
p5
;

263 
img≥l
 *
‹ig_löe
, *
cur_löe
;

264 
i
, 
j
;

265 
ªsu…
;

267 
j
 = 0; j < 
block_size_y
; j++)

269 
cur_löe
 = &(
cur_imgY
[
j
][
x_pos
 + 1]);

270 
p0
 = &
cur_imgY
[
j
][
x_pos
 - 2];

271 
p1
 = 
p0
 + 1;

272 
p2
 = 
p1
 + 1;

273 
p3
 = 
p2
 + 1;

274 
p4
 = 
p3
 + 1;

275 
p5
 = 
p4
 + 1;

276 
‹ig_löe
 = 
block
[
j
];

278 
i
 = 0; i < 
block_size_x
; i++)

280 
ªsu…
 = (*(
p0
++Ë+ *(
p5
++)Ë- 5 * (*(
p1
++Ë+ *(
p4
++)Ë+ 20 * (*(
p2
++Ë+ *(
p3
++));

282 *
‹ig_löe
 = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((
ªsu…
 + 16)>>5));

283 *
‹ig_löe
 = (
img≥l
Ë((*‹ig_löê+ *(
cur_löe
++) + 1 ) >> 1);

284 
‹ig_löe
++;

287 
	}
}

295 
	$gë_luma_01
(
img≥l
 **
block
, img≥»**
cur_imgY
, 
block_size_y
, 
block_size_x
, 
x_pos
, 
shi·_x
, 
max_img≥l_vÆue
)

297 
img≥l
 *
p0
, *
p1
, *
p2
, *
p3
, *
p4
, *
p5
;

298 
img≥l
 *
‹ig_löe
, *
cur_löe
;

299 
i
, 
j
;

300 
ªsu…
;

301 
jj
 = 0;

302 
p0
 = &(
cur_imgY
[ - 2][
x_pos
]);

303 
j
 = 0; j < 
block_size_y
; j++)

305 
p1
 = 
p0
 + 
shi·_x
;

306 
p2
 = 
p1
 + 
shi·_x
;

307 
p3
 = 
p2
 + 
shi·_x
;

308 
p4
 = 
p3
 + 
shi·_x
;

309 
p5
 = 
p4
 + 
shi·_x
;

310 
‹ig_löe
 = 
block
[
j
];

311 
cur_löe
 = &(
cur_imgY
[
jj
++][
x_pos
]);

313 
i
 = 0; i < 
block_size_x
; i++)

315 
ªsu…
 = (*(
p0
++Ë+ *(
p5
++)Ë- 5 * (*(
p1
++Ë+ *(
p4
++)Ë+ 20 * (*(
p2
++Ë+ *(
p3
++));

317 *
‹ig_löe
 = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((
ªsu…
 + 16)>>5));

318 *
‹ig_löe
 = (
img≥l
Ë((*‹ig_löê+ *(
cur_löe
++) + 1 ) >> 1);

319 
‹ig_löe
++;

321 
p0
 = 
p1
 - 
block_size_x
;

323 
	}
}

332 
	$gë_luma_02
(
img≥l
 **
block
, img≥»**
cur_imgY
, 
block_size_y
, 
block_size_x
, 
x_pos
, 
shi·_x
, 
max_img≥l_vÆue
)

334 
img≥l
 *
p0
, *
p1
, *
p2
, *
p3
, *
p4
, *
p5
;

335 
img≥l
 *
‹ig_löe
;

336 
i
, 
j
;

337 
ªsu…
;

338 
p0
 = &(
cur_imgY
[ - 2][
x_pos
]);

339 
j
 = 0; j < 
block_size_y
; j++)

341 
p1
 = 
p0
 + 
shi·_x
;

342 
p2
 = 
p1
 + 
shi·_x
;

343 
p3
 = 
p2
 + 
shi·_x
;

344 
p4
 = 
p3
 + 
shi·_x
;

345 
p5
 = 
p4
 + 
shi·_x
;

346 
‹ig_löe
 = 
block
[
j
];

348 
i
 = 0; i < 
block_size_x
; i++)

350 
ªsu…
 = (*(
p0
++Ë+ *(
p5
++)Ë- 5 * (*(
p1
++Ë+ *(
p4
++)Ë+ 20 * (*(
p2
++Ë+ *(
p3
++));

352 *
‹ig_löe
++ = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((
ªsu…
 + 16)>>5));

354 
p0
 = 
p1
 - 
block_size_x
;

356 
	}
}

365 
	$gë_luma_03
(
img≥l
 **
block
, img≥»**
cur_imgY
, 
block_size_y
, 
block_size_x
, 
x_pos
, 
shi·_x
, 
max_img≥l_vÆue
)

367 
img≥l
 *
p0
, *
p1
, *
p2
, *
p3
, *
p4
, *
p5
;

368 
img≥l
 *
‹ig_löe
, *
cur_löe
;

369 
i
, 
j
;

370 
ªsu…
;

371 
jj
 = 1;

373 
p0
 = &(
cur_imgY
[ -2][
x_pos
]);

374 
j
 = 0; j < 
block_size_y
; j++)

376 
p1
 = 
p0
 + 
shi·_x
;

377 
p2
 = 
p1
 + 
shi·_x
;

378 
p3
 = 
p2
 + 
shi·_x
;

379 
p4
 = 
p3
 + 
shi·_x
;

380 
p5
 = 
p4
 + 
shi·_x
;

381 
‹ig_löe
 = 
block
[
j
];

382 
cur_löe
 = &(
cur_imgY
[
jj
++][
x_pos
]);

384 
i
 = 0; i < 
block_size_x
; i++)

386 
ªsu…
 = (*(
p0
++Ë+ *(
p5
++)Ë- 5 * (*(
p1
++Ë+ *(
p4
++)Ë+ 20 * (*(
p2
++Ë+ *(
p3
++));

388 *
‹ig_löe
 = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((
ªsu…
 + 16)>>5));

389 *
‹ig_löe
 = (
img≥l
Ë((*‹ig_löê+ *(
cur_löe
++) + 1 ) >> 1);

390 
‹ig_löe
++;

392 
p0
 = 
p1
 - 
block_size_x
;

394 
	}
}

402 
	$gë_luma_21
(
img≥l
 **
block
, img≥»**
cur_imgY
, **
tmp_ªs
, 
block_size_y
, 
block_size_x
, 
x_pos
, 
max_img≥l_vÆue
)

404 
i
, 
j
;

406 *
tmp_löe
;

407 
img≥l
 *
p0
, *
p1
, *
p2
, *
p3
, *
p4
, *
p5
;

408 *
x0
, *
x1
, *
x2
, *
x3
, *
x4
, *
x5
;

409 
img≥l
 *
‹ig_löe
;

410 
ªsu…
;

412 
jj
 = -2;

414 
j
 = 0; j < 
block_size_y
 + 5; j++)

416 
p0
 = &
cur_imgY
[
jj
++][
x_pos
 - 2];

417 
p1
 = 
p0
 + 1;

418 
p2
 = 
p1
 + 1;

419 
p3
 = 
p2
 + 1;

420 
p4
 = 
p3
 + 1;

421 
p5
 = 
p4
 + 1;

422 
tmp_löe
 = 
tmp_ªs
[
j
];

424 
i
 = 0; i < 
block_size_x
; i++)

426 *(
tmp_löe
++Ë(*(
p0
++Ë+ *(
p5
++)Ë- 5 * (*(
p1
++Ë+ *(
p4
++)Ë+ 20 * (*(
p2
++Ë+ *(
p3
++));

430 
jj
 = 2;

431 
j
 = 0; j < 
block_size_y
; j++)

433 
tmp_löe
 = 
tmp_ªs
[
jj
++];

434 
x0
 = 
tmp_ªs
[
j
 ];

435 
x1
 = 
tmp_ªs
[
j
 + 1];

436 
x2
 = 
tmp_ªs
[
j
 + 2];

437 
x3
 = 
tmp_ªs
[
j
 + 3];

438 
x4
 = 
tmp_ªs
[
j
 + 4];

439 
x5
 = 
tmp_ªs
[
j
 + 5];

440 
‹ig_löe
 = 
block
[
j
];

442 
i
 = 0; i < 
block_size_x
; i++)

444 
ªsu…
 = (*
x0
++ + *
x5
++Ë- 5 * (*
x1
++ + *
x4
++Ë+ 20 * (*
x2
++ + *
x3
++);

446 *
‹ig_löe
 = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((
ªsu…
 + 512)>>10));

447 *
‹ig_löe
 = (
img≥l
Ë((*‹ig_löê+ 
	`iClù1
(
max_img≥l_vÆue
, ((*(
tmp_löe
++) + 16) >> 5)) + 1 )>> 1);

448 
‹ig_löe
++;

451 
	}
}

459 
	$gë_luma_22
(
img≥l
 **
block
, img≥»**
cur_imgY
, **
tmp_ªs
, 
block_size_y
, 
block_size_x
, 
x_pos
, 
max_img≥l_vÆue
)

461 
i
, 
j
;

463 *
tmp_löe
;

464 
img≥l
 *
p0
, *
p1
, *
p2
, *
p3
, *
p4
, *
p5
;

465 *
x0
, *
x1
, *
x2
, *
x3
, *
x4
, *
x5
;

466 
img≥l
 *
‹ig_löe
;

467 
ªsu…
;

469 
jj
 = - 2;

471 
j
 = 0; j < 
block_size_y
 + 5; j++)

473 
p0
 = &
cur_imgY
[
jj
++][
x_pos
 - 2];

474 
p1
 = 
p0
 + 1;

475 
p2
 = 
p1
 + 1;

476 
p3
 = 
p2
 + 1;

477 
p4
 = 
p3
 + 1;

478 
p5
 = 
p4
 + 1;

479 
tmp_löe
 = 
tmp_ªs
[
j
];

481 
i
 = 0; i < 
block_size_x
; i++)

483 *(
tmp_löe
++Ë(*(
p0
++Ë+ *(
p5
++)Ë- 5 * (*(
p1
++Ë+ *(
p4
++)Ë+ 20 * (*(
p2
++Ë+ *(
p3
++));

487 
j
 = 0; j < 
block_size_y
; j++)

489 
x0
 = 
tmp_ªs
[
j
 ];

490 
x1
 = 
tmp_ªs
[
j
 + 1];

491 
x2
 = 
tmp_ªs
[
j
 + 2];

492 
x3
 = 
tmp_ªs
[
j
 + 3];

493 
x4
 = 
tmp_ªs
[
j
 + 4];

494 
x5
 = 
tmp_ªs
[
j
 + 5];

495 
‹ig_löe
 = 
block
[
j
];

497 
i
 = 0; i < 
block_size_x
; i++)

499 
ªsu…
 = (*
x0
++ + *
x5
++Ë- 5 * (*
x1
++ + *
x4
++Ë+ 20 * (*
x2
++ + *
x3
++);

501 *(
‹ig_löe
++Ë(
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((
ªsu…
 + 512)>>10));

504 
	}
}

512 
	$gë_luma_23
(
img≥l
 **
block
, img≥»**
cur_imgY
, **
tmp_ªs
, 
block_size_y
, 
block_size_x
, 
x_pos
, 
max_img≥l_vÆue
)

514 
i
, 
j
;

516 *
tmp_löe
;

517 
img≥l
 *
p0
, *
p1
, *
p2
, *
p3
, *
p4
, *
p5
;

518 *
x0
, *
x1
, *
x2
, *
x3
, *
x4
, *
x5
;

519 
img≥l
 *
‹ig_löe
;

520 
ªsu…
;

522 
jj
 = -2;

524 
j
 = 0; j < 
block_size_y
 + 5; j++)

526 
p0
 = &
cur_imgY
[
jj
++][
x_pos
 - 2];

527 
p1
 = 
p0
 + 1;

528 
p2
 = 
p1
 + 1;

529 
p3
 = 
p2
 + 1;

530 
p4
 = 
p3
 + 1;

531 
p5
 = 
p4
 + 1;

532 
tmp_löe
 = 
tmp_ªs
[
j
];

534 
i
 = 0; i < 
block_size_x
; i++)

536 *(
tmp_löe
++Ë(*(
p0
++Ë+ *(
p5
++)Ë- 5 * (*(
p1
++Ë+ *(
p4
++)Ë+ 20 * (*(
p2
++Ë+ *(
p3
++));

540 
jj
 = 3;

541 
j
 = 0; j < 
block_size_y
; j++)

543 
tmp_löe
 = 
tmp_ªs
[
jj
++];

544 
x0
 = 
tmp_ªs
[
j
 ];

545 
x1
 = 
tmp_ªs
[
j
 + 1];

546 
x2
 = 
tmp_ªs
[
j
 + 2];

547 
x3
 = 
tmp_ªs
[
j
 + 3];

548 
x4
 = 
tmp_ªs
[
j
 + 4];

549 
x5
 = 
tmp_ªs
[
j
 + 5];

550 
‹ig_löe
 = 
block
[
j
];

552 
i
 = 0; i < 
block_size_x
; i++)

554 
ªsu…
 = (*
x0
++ + *
x5
++Ë- 5 * (*
x1
++ + *
x4
++Ë+ 20 * (*
x2
++ + *
x3
++);

556 *
‹ig_löe
 = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((
ªsu…
 + 512)>>10));

557 *
‹ig_löe
 = (
img≥l
Ë((*‹ig_löê+ 
	`iClù1
(
max_img≥l_vÆue
, ((*(
tmp_löe
++) + 16) >> 5)) + 1 )>> 1);

558 
‹ig_löe
++;

561 
	}
}

569 
	$gë_luma_12
(
img≥l
 **
block
, img≥»**
cur_imgY
, **
tmp_ªs
, 
block_size_y
, 
block_size_x
, 
x_pos
, 
shi·_x
, 
max_img≥l_vÆue
)

571 
i
, 
j
;

572 *
tmp_löe
;

573 
img≥l
 *
p0
, *
p1
, *
p2
, *
p3
, *
p4
, *
p5
;

574 *
x0
, *
x1
, *
x2
, *
x3
, *
x4
, *
x5
;

575 
img≥l
 *
‹ig_löe
;

576 
ªsu…
;

578 
p0
 = &(
cur_imgY
[ -2][
x_pos
 - 2]);

579 
j
 = 0; j < 
block_size_y
; j++)

581 
p1
 = 
p0
 + 
shi·_x
;

582 
p2
 = 
p1
 + 
shi·_x
;

583 
p3
 = 
p2
 + 
shi·_x
;

584 
p4
 = 
p3
 + 
shi·_x
;

585 
p5
 = 
p4
 + 
shi·_x
;

586 
tmp_löe
 = 
tmp_ªs
[
j
];

588 
i
 = 0; i < 
block_size_x
 + 5; i++)

590 *(
tmp_löe
++Ë(*(
p0
++Ë+ *(
p5
++)Ë- 5 * (*(
p1
++Ë+ *(
p4
++)Ë+ 20 * (*(
p2
++Ë+ *(
p3
++));

592 
p0
 = 
p1
 - (
block_size_x
 + 5);

595 
j
 = 0; j < 
block_size_y
; j++)

597 
tmp_löe
 = &
tmp_ªs
[
j
][2];

598 
‹ig_löe
 = 
block
[
j
];

599 
x0
 = 
tmp_ªs
[
j
];

600 
x1
 = 
x0
 + 1;

601 
x2
 = 
x1
 + 1;

602 
x3
 = 
x2
 + 1;

603 
x4
 = 
x3
 + 1;

604 
x5
 = 
x4
 + 1;

606 
i
 = 0; i < 
block_size_x
; i++)

608 
ªsu…
 = (*(
x0
++Ë+ *(
x5
++)Ë- 5 * (*(
x1
++Ë+ *(
x4
++)Ë+ 20 * (*(
x2
++Ë+ *(
x3
++));

610 *
‹ig_löe
 = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((
ªsu…
 + 512)>>10));

611 *
‹ig_löe
 = (
img≥l
Ë((*‹ig_löê+ 
	`iClù1
(
max_img≥l_vÆue
, ((*(
tmp_löe
++) + 16)>>5))+1)>>1);

612 
‹ig_löe
 ++;

615 
	}
}

624 
	$gë_luma_32
(
img≥l
 **
block
, img≥»**
cur_imgY
, **
tmp_ªs
, 
block_size_y
, 
block_size_x
, 
x_pos
, 
shi·_x
, 
max_img≥l_vÆue
)

626 
i
, 
j
;

627 *
tmp_löe
;

628 
img≥l
 *
p0
, *
p1
, *
p2
, *
p3
, *
p4
, *
p5
;

629 *
x0
, *
x1
, *
x2
, *
x3
, *
x4
, *
x5
;

630 
img≥l
 *
‹ig_löe
;

631 
ªsu…
;

633 
p0
 = &(
cur_imgY
[ -2][
x_pos
 - 2]);

634 
j
 = 0; j < 
block_size_y
; j++)

636 
p1
 = 
p0
 + 
shi·_x
;

637 
p2
 = 
p1
 + 
shi·_x
;

638 
p3
 = 
p2
 + 
shi·_x
;

639 
p4
 = 
p3
 + 
shi·_x
;

640 
p5
 = 
p4
 + 
shi·_x
;

641 
tmp_löe
 = 
tmp_ªs
[
j
];

643 
i
 = 0; i < 
block_size_x
 + 5; i++)

645 *(
tmp_löe
++Ë(*(
p0
++Ë+ *(
p5
++)Ë- 5 * (*(
p1
++Ë+ *(
p4
++)Ë+ 20 * (*(
p2
++Ë+ *(
p3
++));

647 
p0
 = 
p1
 - (
block_size_x
 + 5);

650 
j
 = 0; j < 
block_size_y
; j++)

652 
tmp_löe
 = &
tmp_ªs
[
j
][3];

653 
‹ig_löe
 = 
block
[
j
];

654 
x0
 = 
tmp_ªs
[
j
];

655 
x1
 = 
x0
 + 1;

656 
x2
 = 
x1
 + 1;

657 
x3
 = 
x2
 + 1;

658 
x4
 = 
x3
 + 1;

659 
x5
 = 
x4
 + 1;

661 
i
 = 0; i < 
block_size_x
; i++)

663 
ªsu…
 = (*(
x0
++Ë+ *(
x5
++)Ë- 5 * (*(
x1
++Ë+ *(
x4
++)Ë+ 20 * (*(
x2
++Ë+ *(
x3
++));

665 *
‹ig_löe
 = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((
ªsu…
 + 512)>>10));

666 *
‹ig_löe
 = (
img≥l
Ë((*‹ig_löê+ 
	`iClù1
(
max_img≥l_vÆue
, ((*(
tmp_löe
++) + 16)>>5))+1)>>1);

667 
‹ig_löe
 ++;

670 
	}
}

678 
	$gë_luma_33
(
img≥l
 **
block
, img≥»**
cur_imgY
, 
block_size_y
, 
block_size_x
, 
x_pos
, 
shi·_x
, 
max_img≥l_vÆue
)

680 
i
, 
j
;

681 
img≥l
 *
p0
, *
p1
, *
p2
, *
p3
, *
p4
, *
p5
;

682 
img≥l
 *
‹ig_löe
;

683 
ªsu…
;

685 
jj
 = 1;

687 
j
 = 0; j < 
block_size_y
; j++)

689 
p0
 = &
cur_imgY
[
jj
++][
x_pos
 - 2];

690 
p1
 = 
p0
 + 1;

691 
p2
 = 
p1
 + 1;

692 
p3
 = 
p2
 + 1;

693 
p4
 = 
p3
 + 1;

694 
p5
 = 
p4
 + 1;

696 
‹ig_löe
 = 
block
[
j
];

698 
i
 = 0; i < 
block_size_x
; i++)

700 
ªsu…
 = (*(
p0
++Ë+ *(
p5
++)Ë- 5 * (*(
p1
++Ë+ *(
p4
++)Ë+ 20 * (*(
p2
++Ë+ *(
p3
++));

702 *(
‹ig_löe
++Ë(
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((
ªsu…
 + 16)>>5));

706 
p0
 = &(
cur_imgY
[-2][
x_pos
 + 1]);

707 
j
 = 0; j < 
block_size_y
; j++)

709 
p1
 = 
p0
 + 
shi·_x
;

710 
p2
 = 
p1
 + 
shi·_x
;

711 
p3
 = 
p2
 + 
shi·_x
;

712 
p4
 = 
p3
 + 
shi·_x
;

713 
p5
 = 
p4
 + 
shi·_x
;

714 
‹ig_löe
 = 
block
[
j
];

716 
i
 = 0; i < 
block_size_x
; i++)

718 
ªsu…
 = (*(
p0
++Ë+ *(
p5
++)Ë- 5 * (*(
p1
++Ë+ *(
p4
++)Ë+ 20 * (*(
p2
++Ë+ *(
p3
++));

720 *
‹ig_löe
 = (
img≥l
Ë((*‹ig_löê+ 
	`iClù1
(
max_img≥l_vÆue
, ((
ªsu…
 + 16) >> 5)) + 1) >> 1);

721 
‹ig_löe
++;

723 
p0
 = 
p1
 - 
block_size_x
 ;

725 
	}
}

735 
	$gë_luma_11
(
img≥l
 **
block
, img≥»**
cur_imgY
, 
block_size_y
, 
block_size_x
, 
x_pos
, 
shi·_x
, 
max_img≥l_vÆue
)

737 
i
, 
j
;

738 
img≥l
 *
p0
, *
p1
, *
p2
, *
p3
, *
p4
, *
p5
;

739 
img≥l
 *
‹ig_löe
;

740 
ªsu…
;

742 
jj
 = 0;

744 
j
 = 0; j < 
block_size_y
; j++)

746 
p0
 = &
cur_imgY
[
jj
++][
x_pos
 - 2];

747 
p1
 = 
p0
 + 1;

748 
p2
 = 
p1
 + 1;

749 
p3
 = 
p2
 + 1;

750 
p4
 = 
p3
 + 1;

751 
p5
 = 
p4
 + 1;

753 
‹ig_löe
 = 
block
[
j
];

755 
i
 = 0; i < 
block_size_x
; i++)

757 
ªsu…
 = (*(
p0
++Ë+ *(
p5
++)Ë- 5 * (*(
p1
++Ë+ *(
p4
++)Ë+ 20 * (*(
p2
++Ë+ *(
p3
++));

759 *(
‹ig_löe
++Ë(
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((
ªsu…
 + 16)>>5));

763 
p0
 = &(
cur_imgY
[-2][
x_pos
]);

764 
j
 = 0; j < 
block_size_y
; j++)

766 
p1
 = 
p0
 + 
shi·_x
;

767 
p2
 = 
p1
 + 
shi·_x
;

768 
p3
 = 
p2
 + 
shi·_x
;

769 
p4
 = 
p3
 + 
shi·_x
;

770 
p5
 = 
p4
 + 
shi·_x
;

771 
‹ig_löe
 = 
block
[
j
];

773 
i
 = 0; i < 
block_size_x
; i++)

775 
ªsu…
 = (*(
p0
++Ë+ *(
p5
++)Ë- 5 * (*(
p1
++Ë+ *(
p4
++)Ë+ 20 * (*(
p2
++Ë+ *(
p3
++));

777 *
‹ig_löe
 = (
img≥l
Ë((*‹ig_löê+ 
	`iClù1
(
max_img≥l_vÆue
, ((
ªsu…
 + 16) >> 5)) + 1) >> 1);

778 
‹ig_löe
++;

780 
p0
 = 
p1
 - 
block_size_x
 ;

782 
	}
}

790 
	$gë_luma_13
(
img≥l
 **
block
, img≥»**
cur_imgY
, 
block_size_y
, 
block_size_x
, 
x_pos
, 
shi·_x
, 
max_img≥l_vÆue
)

793 
i
, 
j
;

794 
img≥l
 *
p0
, *
p1
, *
p2
, *
p3
, *
p4
, *
p5
;

795 
img≥l
 *
‹ig_löe
;

796 
ªsu…
;

798 
jj
 = 1;

800 
j
 = 0; j < 
block_size_y
; j++)

802 
p0
 = &
cur_imgY
[
jj
++][
x_pos
 - 2];

803 
p1
 = 
p0
 + 1;

804 
p2
 = 
p1
 + 1;

805 
p3
 = 
p2
 + 1;

806 
p4
 = 
p3
 + 1;

807 
p5
 = 
p4
 + 1;

809 
‹ig_löe
 = 
block
[
j
];

811 
i
 = 0; i < 
block_size_x
; i++)

813 
ªsu…
 = (*(
p0
++Ë+ *(
p5
++)Ë- 5 * (*(
p1
++Ë+ *(
p4
++)Ë+ 20 * (*(
p2
++Ë+ *(
p3
++));

815 *(
‹ig_löe
++Ë(
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((
ªsu…
 + 16)>>5));

819 
p0
 = &(
cur_imgY
[-2][
x_pos
]);

820 
j
 = 0; j < 
block_size_y
; j++)

822 
p1
 = 
p0
 + 
shi·_x
;

823 
p2
 = 
p1
 + 
shi·_x
;

824 
p3
 = 
p2
 + 
shi·_x
;

825 
p4
 = 
p3
 + 
shi·_x
;

826 
p5
 = 
p4
 + 
shi·_x
;

827 
‹ig_löe
 = 
block
[
j
];

829 
i
 = 0; i < 
block_size_x
; i++)

831 
ªsu…
 = (*(
p0
++Ë+ *(
p5
++)Ë- 5 * (*(
p1
++Ë+ *(
p4
++)Ë+ 20 * (*(
p2
++Ë+ *(
p3
++));

833 *
‹ig_löe
 = (
img≥l
Ë((*‹ig_löê+ 
	`iClù1
(
max_img≥l_vÆue
, ((
ªsu…
 + 16) >> 5)) + 1) >> 1);

834 
‹ig_löe
++;

836 
p0
 = 
p1
 - 
block_size_x
 ;

838 
	}
}

846 
	$gë_luma_31
(
img≥l
 **
block
, img≥»**
cur_imgY
, 
block_size_y
, 
block_size_x
, 
x_pos
, 
shi·_x
, 
max_img≥l_vÆue
)

849 
i
, 
j
;

850 
img≥l
 *
p0
, *
p1
, *
p2
, *
p3
, *
p4
, *
p5
;

851 
img≥l
 *
‹ig_löe
;

852 
ªsu…
;

854 
jj
 = 0;

856 
j
 = 0; j < 
block_size_y
; j++)

858 
p0
 = &
cur_imgY
[
jj
++][
x_pos
 - 2];

859 
p1
 = 
p0
 + 1;

860 
p2
 = 
p1
 + 1;

861 
p3
 = 
p2
 + 1;

862 
p4
 = 
p3
 + 1;

863 
p5
 = 
p4
 + 1;

865 
‹ig_löe
 = 
block
[
j
];

867 
i
 = 0; i < 
block_size_x
; i++)

869 
ªsu…
 = (*(
p0
++Ë+ *(
p5
++)Ë- 5 * (*(
p1
++Ë+ *(
p4
++)Ë+ 20 * (*(
p2
++Ë+ *(
p3
++));

871 *(
‹ig_löe
++Ë(
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((
ªsu…
 + 16)>>5));

875 
p0
 = &(
cur_imgY
[-2][
x_pos
 + 1]);

876 
j
 = 0; j < 
block_size_y
; j++)

878 
p1
 = 
p0
 + 
shi·_x
;

879 
p2
 = 
p1
 + 
shi·_x
;

880 
p3
 = 
p2
 + 
shi·_x
;

881 
p4
 = 
p3
 + 
shi·_x
;

882 
p5
 = 
p4
 + 
shi·_x
;

883 
‹ig_löe
 = 
block
[
j
];

885 
i
 = 0; i < 
block_size_x
; i++)

887 
ªsu…
 = (*(
p0
++Ë+ *(
p5
++)Ë- 5 * (*(
p1
++Ë+ *(
p4
++)Ë+ 20 * (*(
p2
++Ë+ *(
p3
++));

889 *
‹ig_löe
 = (
img≥l
Ë((*‹ig_löê+ 
	`iClù1
(
max_img≥l_vÆue
, ((
ªsu…
 + 16) >> 5)) + 1) >> 1);

890 
‹ig_löe
++;

892 
p0
 = 
p1
 - 
block_size_x
 ;

894 
	}
}

902 
	$gë_block_luma
(
St‹abÀPi˘uª
 *
cuº_ªf
, 
x_pos
, 
y_pos
, 
block_size_x
, 
block_size_y
, 
img≥l
 **
block
,

903 
shi·_x
, 
maxﬁd_x
, 
maxﬁd_y
, **
tmp_ªs
, 
max_img≥l_vÆue
, 
img≥l
 
no_ªf_vÆue
, 
Ma¸oblock
 *
cuºMB
)

905 i‡(
cuº_ªf
->
no_ªf
) {

907 
	`mem£t
(
block
[0],
no_ªf_vÆue
,
block_size_y
 * 
block_size_x
 * (
img≥l
));

911 
img≥l
 **
cur_imgY
 = (
cuºMB
->
p_Vid
->
£∑øã_cﬁour_∂™e_Êag
 && cuºMB->
p_Sli˚
->
cﬁour_∂™e_id
>
PLANE_Y
)? 
cuº_ªf
->
imgUV
[currMB->p_Slice->colour_plane_id-1] : curr_ref->cur_imgY;

912 
dx
 = (
x_pos
 & 3);

913 
dy
 = (
y_pos
 & 3);

914 
x_pos
 >>= 2;

915 
y_pos
 >>= 2;

916 
x_pos
 = 
	`iClù3
(-18, 
maxﬁd_x
+2, x_pos);

917 
y_pos
 = 
	`iClù3
(-10, 
maxﬁd_y
+2, y_pos);

919 i‡(
dx
 =0 && 
dy
 == 0)

920 
	`gë_block_00
(&
block
[0][0], &
cur_imgY
[
y_pos
][
x_pos
], 
cuº_ªf
->
iLumaSåide
, 
block_size_y
);

923 i‡(
dy
 == 0)

925 i‡(
dx
 == 1)

926 
	`gë_luma_10
(
block
, &
cur_imgY
[ 
y_pos
], 
block_size_y
, 
block_size_x
, 
x_pos
, 
max_img≥l_vÆue
);

927 i‡(
dx
 == 2)

928 
	`gë_luma_20
(
block
, &
cur_imgY
[ 
y_pos
], 
block_size_y
, 
block_size_x
, 
x_pos
, 
max_img≥l_vÆue
);

930 
	`gë_luma_30
(
block
, &
cur_imgY
[ 
y_pos
], 
block_size_y
, 
block_size_x
, 
x_pos
, 
max_img≥l_vÆue
);

932 i‡(
dx
 == 0)

934 i‡(
dy
 == 1)

935 
	`gë_luma_01
(
block
, &
cur_imgY
[
y_pos
], 
block_size_y
, 
block_size_x
, 
x_pos
, 
shi·_x
, 
max_img≥l_vÆue
);

936 i‡(
dy
 == 2)

937 
	`gë_luma_02
(
block
, &
cur_imgY
[ 
y_pos
], 
block_size_y
, 
block_size_x
, 
x_pos
, 
shi·_x
, 
max_img≥l_vÆue
);

939 
	`gë_luma_03
(
block
, &
cur_imgY
[ 
y_pos
], 
block_size_y
, 
block_size_x
, 
x_pos
, 
shi·_x
, 
max_img≥l_vÆue
);

941 i‡(
dx
 == 2)

943 i‡(
dy
 == 1)

944 
	`gë_luma_21
(
block
, &
cur_imgY
[ 
y_pos
], 
tmp_ªs
, 
block_size_y
, 
block_size_x
, 
x_pos
, 
max_img≥l_vÆue
);

945 i‡(
dy
 == 2)

946 
	`gë_luma_22
(
block
, &
cur_imgY
[ 
y_pos
], 
tmp_ªs
, 
block_size_y
, 
block_size_x
, 
x_pos
, 
max_img≥l_vÆue
);

948 
	`gë_luma_23
(
block
, &
cur_imgY
[ 
y_pos
], 
tmp_ªs
, 
block_size_y
, 
block_size_x
, 
x_pos
, 
max_img≥l_vÆue
);

950 i‡(
dy
 == 2)

952 i‡(
dx
 == 1)

953 
	`gë_luma_12
(
block
, &
cur_imgY
[ 
y_pos
], 
tmp_ªs
, 
block_size_y
, 
block_size_x
, 
x_pos
, 
shi·_x
, 
max_img≥l_vÆue
);

955 
	`gë_luma_32
(
block
, &
cur_imgY
[ 
y_pos
], 
tmp_ªs
, 
block_size_y
, 
block_size_x
, 
x_pos
, 
shi·_x
, 
max_img≥l_vÆue
);

959 i‡(
dx
 == 1)

961 i‡(
dy
 == 1)

962 
	`gë_luma_11
(
block
, &
cur_imgY
[ 
y_pos
], 
block_size_y
, 
block_size_x
, 
x_pos
, 
shi·_x
, 
max_img≥l_vÆue
);

964 
	`gë_luma_13
(
block
, &
cur_imgY
[ 
y_pos
], 
block_size_y
, 
block_size_x
, 
x_pos
, 
shi·_x
, 
max_img≥l_vÆue
);

968 i‡(
dy
 == 1)

969 
	`gë_luma_31
(
block
, &
cur_imgY
[ 
y_pos
], 
block_size_y
, 
block_size_x
, 
x_pos
, 
shi·_x
, 
max_img≥l_vÆue
);

971 
	`gë_luma_33
(
block
, &
cur_imgY
[ 
y_pos
], 
block_size_y
, 
block_size_x
, 
x_pos
, 
shi·_x
, 
max_img≥l_vÆue
);

976 
	}
}

985 
	$gë_chroma_0X
(
img≥l
 *
block
, img≥»*
cur_img
, 
•™
, 
block_size_y
, 
block_size_x
, 
w00
, 
w01
, 
tŸÆ_sˇÀ
)

987 
img≥l
 *
cur_row
 = 
cur_img
;

988 
img≥l
 *
nxt_row
 = 
cur_img
 + 
•™
;

991 
img≥l
 *
cur_löe
, *
cur_löe_p1
;

992 
img≥l
 *
blk_löe
;

993 
ªsu…
;

994 
i
, 
j
;

995 
j
 = 0; j < 
block_size_y
; j++)

997 
cur_löe
 = 
cur_row
;

998 
cur_löe_p1
 = 
nxt_row
;

999 
blk_löe
 = 
block
;

1000 
block
 += 16;

1001 
cur_row
 = 
nxt_row
;

1002 
nxt_row
 +
•™
;

1003 
i
 = 0; i < 
block_size_x
; i++)

1005 
ªsu…
 = (
w00
 * *
cur_löe
++ + 
w01
 * *
cur_löe_p1
++);

1006 *(
blk_löe
++Ë(
img≥l
Ë
	`rshi·_∫d_sf
(
ªsu…
, 
tŸÆ_sˇÀ
);

1009 
	}
}

1018 
	$gë_chroma_X0
(
img≥l
 *
block
, img≥»*
cur_img
, 
•™
, 
block_size_y
, 
block_size_x
, 
w00
, 
w10
, 
tŸÆ_sˇÀ
)

1020 
img≥l
 *
cur_row
 = 
cur_img
;

1023 
img≥l
 *
cur_löe
, *
cur_löe_p1
;

1024 
img≥l
 *
blk_löe
;

1025 
ªsu…
;

1026 
i
, 
j
;

1027 
j
 = 0; j < 
block_size_y
; j++)

1029 
cur_löe
 = 
cur_row
;

1030 
cur_löe_p1
 = 
cur_löe
 + 1;

1031 
blk_löe
 = 
block
;

1032 
block
 += 16;

1033 
cur_row
 +
•™
;

1034 
i
 = 0; i < 
block_size_x
; i++)

1036 
ªsu…
 = (
w00
 * *
cur_löe
++ + 
w10
 * *
cur_löe_p1
++);

1038 *(
blk_löe
++Ë(
img≥l
Ë
	`rshi·_∫d_sf
(
ªsu…
, 
tŸÆ_sˇÀ
);

1041 
	}
}

1049 
	$gë_chroma_XY
(
img≥l
 *
block
, img≥»*
cur_img
, 
•™
, 
block_size_y
, 
block_size_x
, 
w00
, 
w01
, 
w10
, 
w11
, 
tŸÆ_sˇÀ
)

1051 
img≥l
 *
cur_row
 = 
cur_img
;

1052 
img≥l
 *
nxt_row
 = 
cur_img
 + 
•™
;

1056 
img≥l
 *
cur_löe
, *
cur_löe_p1
;

1057 
img≥l
 *
blk_löe
;

1058 
ªsu…
;

1059 
i
, 
j
;

1060 
j
 = 0; j < 
block_size_y
; j++)

1062 
cur_löe
 = 
cur_row
;

1063 
cur_löe_p1
 = 
nxt_row
;

1064 
blk_löe
 = 
block
;

1065 
block
 += 16;

1066 
cur_row
 = 
nxt_row
;

1067 
nxt_row
 +
•™
;

1068 
i
 = 0; i < 
block_size_x
; i++)

1070 
ªsu…
 = (
w00
 * *(
cur_löe
++Ë+ 
w01
 * *(
cur_löe_p1
++));

1071 
ªsu…
 +(
w10
 * *(
cur_löe
 ) + 
w11
 * *(
cur_löe_p1
 ));

1072 *(
blk_löe
++Ë(
img≥l
Ë
	`rshi·_∫d_sf
(
ªsu…
, 
tŸÆ_sˇÀ
);

1076 
	}
}

1078 
	$gë_block_chroma
(
St‹abÀPi˘uª
 *
cuº_ªf
, 
x_pos
, 
y_pos
, 
sub≥l_x
, 
sub≥l_y
, 
maxﬁd_x
, 
maxﬁd_y
,

1079 
block_size_x
, 
vît_block_size
, 
shi·≥l_x
, 
shi·≥l_y
,

1080 
img≥l
 *
block1
, img≥»*
block2
, 
tŸÆ_sˇÀ
, img≥»
no_ªf_vÆue
, 
VideoP¨amëîs
 *
p_Vid
)

1082 
img≥l
 *
img1
,*
img2
;

1083 
dx
,
dy
;

1084 
•™
 = 
cuº_ªf
->
iChromaSåide
;

1085 i‡(
cuº_ªf
->
no_ªf
) {

1087 
	`mem£t
(
block1
,
no_ªf_vÆue
,
vît_block_size
 * 
block_size_x
 * (
img≥l
));

1088 
	`mem£t
(
block2
,
no_ªf_vÆue
,
vît_block_size
 * 
block_size_x
 * (
img≥l
));

1092 
dx
 = (Ë(
x_pos
 & 
sub≥l_x
);

1093 
dy
 = (Ë(
y_pos
 & 
sub≥l_y
);

1094 
x_pos
 = x_po†>> 
shi·≥l_x
;

1095 
y_pos
 = y_po†>> 
shi·≥l_y
;

1097 
	`as£π
(
vît_block_size
 <=
p_Vid
->
iChromaPadY
 && 
block_size_x
<ı_Vid->
iChromaPadX
);

1098 
x_pos
 = 
	`iClù3
(-
p_Vid
->
iChromaPadX
, 
maxﬁd_x
, x_pos);

1099 
y_pos
 = 
	`iClù3
(-
p_Vid
->
iChromaPadY
, 
maxﬁd_y
, y_pos);

1100 
img1
 = &
cuº_ªf
->
imgUV
[0][
y_pos
][
x_pos
];

1101 
img2
 = &
cuº_ªf
->
imgUV
[1][
y_pos
][
x_pos
];

1103 i‡(
dx
 =0 && 
dy
 == 0)

1105 
	`gë_block_00
(
block1
, 
img1
, 
•™
, 
vît_block_size
);

1106 
	`gë_block_00
(
block2
, 
img2
, 
•™
, 
vît_block_size
);

1110 
dxcur
 = (Ë(
sub≥l_x
 + 1 - 
dx
);

1111 
dycur
 = (Ë(
sub≥l_y
 + 1 - 
dy
);

1112 
w00
 = 
dxcur
 * 
dycur
;

1113 i‡(
dx
 == 0)

1115 
w01
 = 
dxcur
 * 
dy
;

1116 
	`gë_chroma_0X
(
block1
, 
img1
, 
•™
, 
vît_block_size
, 
block_size_x
, 
w00
, 
w01
, 
tŸÆ_sˇÀ
);

1117 
	`gë_chroma_0X
(
block2
, 
img2
, 
•™
, 
vît_block_size
, 
block_size_x
, 
w00
, 
w01
, 
tŸÆ_sˇÀ
);

1119 i‡(
dy
 == 0)

1121 
w10
 = 
dx
 * 
dycur
;

1122 
	`gë_chroma_X0
(
block1
, 
img1
, 
•™
, 
vît_block_size
, 
block_size_x
, 
w00
, 
w10
, 
tŸÆ_sˇÀ
);

1123 
	`gë_chroma_X0
(
block2
, 
img2
, 
•™
, 
vît_block_size
, 
block_size_x
, 
w00
, 
w10
, 
tŸÆ_sˇÀ
);

1127 
w01
 = 
dxcur
 * 
dy
;

1128 
w10
 = 
dx
 * 
dycur
;

1129 
w11
 = 
dx
 * 
dy
;

1130 
	`gë_chroma_XY
(
block1
, 
img1
, 
•™
, 
vît_block_size
, 
block_size_x
, 
w00
, 
w01
, 
w10
, 
w11
, 
tŸÆ_sˇÀ
);

1131 
	`gë_chroma_XY
(
block2
, 
img2
, 
•™
, 
vît_block_size
, 
block_size_x
, 
w00
, 
w01
, 
w10
, 
w11
, 
tŸÆ_sˇÀ
);

1135 
	}
}

1137 
	$öåa_¸_decodög
(
Ma¸oblock
 *
cuºMB
, 
yuv
)

1139 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1140 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1141 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
cuºSli˚
->dec_picture;

1142 
img≥l
 **
curUV
;

1143 
uv
;

1144 
b8
,
b4
;

1145 
ioff
, 
joff
;

1146 
i
,
j
;

1148 
cuºSli˚
->
	`öåa_¥ed_chroma
(
cuºMB
);

1150 
uv
 = 0; uv < 2; uv++)

1152 
cuºMB
->
ôøns_4x4
 = (cuºMB->
is_los¶ess
 =
FALSE
Ë? 
ôøns4x4
 : 
ôøns4x4_ls
;

1154 
curUV
 = 
dec_pi˘uª
->
imgUV
[
uv
];

1156 if(
cuºMB
->
is_los¶ess
)

1158 i‡((
cuºMB
->
c_ùªd_mode
 =
VERT_PRED_8
)||(cuºMB->c_ùªd_modê=
HOR_PRED_8
))

1159 
	`Inv_ResiduÆ_å™s_Chroma
(
cuºMB
, 
uv
) ;

1162 
j
=0;j<
p_Vid
->
mb_¸_size_y
;j++)

1163 
i
=0;i<
p_Vid
->
mb_¸_size_x
;i++)

1164 
cuºSli˚
->
mb_ºes
 [
uv
+1][
j
][
i
]=cuºSli˚->
cof
[uv+1][j][i];

1168 i‡((!(
cuºMB
->
mb_ty≥
 =
SI4MB
Ë&& (cuºMB->
cbp
 >> 4)) )

1170 
b8
 = 0; b8 < (
p_Vid
->
num_uv_blocks
); b8++)

1172 
b4
 = 0; b4 < 4; b4++)

1174 
joff
 = 
subblk_off£t_y
[
yuv
][
b8
][
b4
];

1175 
ioff
 = 
subblk_off£t_x
[
yuv
][
b8
][
b4
];

1177 
cuºMB
->
	`ôøns_4x4
(cuºMB, (
Cﬁ‹Pœ√
Ë(
uv
 + 1), 
ioff
, 
joff
);

1179 
	`c›y_image_d©a_4x4
(&
curUV
[
cuºMB
->
pix_c_y
 + 
joff
], &(
cuºSli˚
->
mb_ªc
[
uv
 + 1][joff]), cuºMB->
pix_c_x
 + 
ioff
, ioff);

1182 
cuºSli˚
->
is_ª£t_c€ff_¸
 = 
FALSE
;

1184 i‡(
cuºMB
->
mb_ty≥
 =
SI4MB
)

1186 
	`ôøns_•_¸
(
cuºMB
, 
uv
);

1188 
joff
 = 0; joff < 8; joff += 4)

1190 
ioff
 = 0; ioff < 8;ioff+=4)

1192 
cuºMB
->
	`ôøns_4x4
(cuºMB, (
Cﬁ‹Pœ√
Ë(
uv
 + 1), 
ioff
, 
joff
);

1194 
	`c›y_image_d©a_4x4
(&
curUV
[
cuºMB
->
pix_c_y
 + 
joff
], &(
cuºSli˚
->
mb_ªc
[
uv
 + 1][joff]), cuºMB->
pix_c_x
 + 
ioff
, ioff);

1197 
cuºSli˚
->
is_ª£t_c€ff_¸
 = 
FALSE
;

1201 
b8
 = 0; b8 < (
p_Vid
->
num_uv_blocks
); b8++)

1203 
b4
 = 0; b4 < 4; b4++)

1205 
joff
 = 
subblk_off£t_y
[
yuv
][
b8
][
b4
];

1206 
ioff
 = 
subblk_off£t_x
[
yuv
][
b8
][
b4
];

1208 
	`c›y_image_d©a_4x4
(&
curUV
[
cuºMB
->
pix_c_y
 + 
joff
], &(
cuºSli˚
->
mb_¥ed
[
uv
 + 1][joff]), cuºMB->
pix_c_x
 + 
ioff
, ioff);

1213 
	}
}

1215 
ölöe
 
	$£t_dúe˘_ª„ªn˚s
(c⁄° 
PixñPos
 *
mb
, *
l0_rFøme
, *
l1_rFøme
, 
PicMŸi⁄P¨ams
 **
mv_öfo
)

1217 i‡(
mb
->
avaûabÀ
)

1219 *
ªf_idx
 = 
mv_öfo
[
mb
->
pos_y
][mb->
pos_x
].ref_idx;

1220 *
l0_rFøme
 = 
ªf_idx
[
LIST_0
];

1221 *
l1_rFøme
 = 
ªf_idx
[
LIST_1
];

1225 *
l0_rFøme
 = -1;

1226 *
l1_rFøme
 = -1;

1228 
	}
}

1231 
	$£t_dúe˘_ª„ªn˚s_mb_fõld
(c⁄° 
PixñPos
 *
mb
, *
l0_rFøme
, *
l1_rFøme
, 
PicMŸi⁄P¨ams
 **
mv_öfo
, 
Ma¸oblock
 *
mb_d©a
)

1233 i‡(
mb
->
avaûabÀ
)

1235 *
ªf_idx
 = 
mv_öfo
[
mb
->
pos_y
][mb->
pos_x
].ref_idx;

1236 i‡(
mb_d©a
[
mb
->
mb_addr
].
mb_fõld
)

1238 *
l0_rFøme
 = 
ªf_idx
[
LIST_0
];

1239 *
l1_rFøme
 = 
ªf_idx
[
LIST_1
];

1243 *
l0_rFøme
 = (
ªf_idx
[
LIST_0
] < 0) ?Ñef_idx[LIST_0] :Ñef_idx[LIST_0] * 2;

1244 *
l1_rFøme
 = (
ªf_idx
[
LIST_1
] < 0) ?Ñef_idx[LIST_1] :Ñef_idx[LIST_1] * 2;

1249 *
l0_rFøme
 = -1;

1250 *
l1_rFøme
 = -1;

1252 
	}
}

1254 
	$£t_dúe˘_ª„ªn˚s_mb_‰ame
(c⁄° 
PixñPos
 *
mb
, *
l0_rFøme
, *
l1_rFøme
, 
PicMŸi⁄P¨ams
 **
mv_öfo
, 
Ma¸oblock
 *
mb_d©a
)

1256 i‡(
mb
->
avaûabÀ
)

1258 *
ªf_idx
 = 
mv_öfo
[
mb
->
pos_y
][mb->
pos_x
].ref_idx;

1259 i‡(
mb_d©a
[
mb
->
mb_addr
].
mb_fõld
)

1261 *
l0_rFøme
 = (
ªf_idx
[
LIST_0
] >> 1);

1262 *
l1_rFøme
 = (
ªf_idx
[
LIST_1
] >> 1);

1266 *
l0_rFøme
 = 
ªf_idx
[
LIST_0
];

1267 *
l1_rFøme
 = 
ªf_idx
[
LIST_1
];

1272 *
l0_rFøme
 = -1;

1273 *
l1_rFøme
 = -1;

1275 
	}
}

1277 
	$¥ï¨e_dúe˘_∑øms
(
Ma¸oblock
 *
cuºMB
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
, 
MŸi⁄Ve˘‹
 *
pmvl0
, MŸi⁄Ve˘‹ *
pmvl1
, *
l0_rFøme
, *
l1_rFøme
)

1279 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1280 
l0_ªfA
, 
l0_ªfB
, 
l0_ªfC
;

1281 
l1_ªfA
, 
l1_ªfB
, 
l1_ªfC
;

1282 
PicMŸi⁄P¨ams
 **
mv_öfo
 = 
dec_pi˘uª
->mv_info;

1284 
PixñPos
 
mb
[4];

1286 
	`gë_√ighb‹s
(
cuºMB
, 
mb
, 0, 0, 16);

1288 i‡(!
cuºSli˚
->
mb_aff_‰ame_Êag
)

1290 
	`£t_dúe˘_ª„ªn˚s
(&
mb
[0], &
l0_ªfA
, &
l1_ªfA
, 
mv_öfo
);

1291 
	`£t_dúe˘_ª„ªn˚s
(&
mb
[1], &
l0_ªfB
, &
l1_ªfB
, 
mv_öfo
);

1292 
	`£t_dúe˘_ª„ªn˚s
(&
mb
[2], &
l0_ªfC
, &
l1_ªfC
, 
mv_öfo
);

1296 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1297 i‡(
cuºMB
->
mb_fõld
)

1299 
	`£t_dúe˘_ª„ªn˚s_mb_fõld
(&
mb
[0], &
l0_ªfA
, &
l1_ªfA
, 
mv_öfo
, 
p_Vid
->
mb_d©a
);

1300 
	`£t_dúe˘_ª„ªn˚s_mb_fõld
(&
mb
[1], &
l0_ªfB
, &
l1_ªfB
, 
mv_öfo
, 
p_Vid
->
mb_d©a
);

1301 
	`£t_dúe˘_ª„ªn˚s_mb_fõld
(&
mb
[2], &
l0_ªfC
, &
l1_ªfC
, 
mv_öfo
, 
p_Vid
->
mb_d©a
);

1305 
	`£t_dúe˘_ª„ªn˚s_mb_‰ame
(&
mb
[0], &
l0_ªfA
, &
l1_ªfA
, 
mv_öfo
, 
p_Vid
->
mb_d©a
);

1306 
	`£t_dúe˘_ª„ªn˚s_mb_‰ame
(&
mb
[1], &
l0_ªfB
, &
l1_ªfB
, 
mv_öfo
, 
p_Vid
->
mb_d©a
);

1307 
	`£t_dúe˘_ª„ªn˚s_mb_‰ame
(&
mb
[2], &
l0_ªfC
, &
l1_ªfC
, 
mv_öfo
, 
p_Vid
->
mb_d©a
);

1311 *
l0_rFøme
 = (Ë
	`imö
(imö((Ë
l0_ªfA
, (Ë
l0_ªfB
), (Ë
l0_ªfC
);

1312 *
l1_rFøme
 = (Ë
	`imö
(imö((Ë
l1_ªfA
, (Ë
l1_ªfB
), (Ë
l1_ªfC
);

1314 i‡(*
l0_rFøme
 >=0)

1315 
cuºMB
->
	`GëMVPªdi˘‹
 (cuºMB, 
mb
, 
pmvl0
, *
l0_rFøme
, 
mv_öfo
, 
LIST_0
, 0, 0, 16, 16);

1317 i‡(*
l1_rFøme
 >=0)

1318 
cuºMB
->
	`GëMVPªdi˘‹
 (cuºMB, 
mb
, 
pmvl1
, *
l1_rFøme
, 
mv_öfo
, 
LIST_1
, 0, 0, 16, 16);

1319 
	}
}

1321 
	$check_mŸi⁄_ve˘‹_ønge
(c⁄° 
MŸi⁄Ve˘‹
 *
mv
, 
Sli˚
 *
pSli˚
)

1323 i‡(
mv
->
mv_x
 > 8191 || mv->mv_x < -8192)

1325 
	`Ârötf
(
°dîr
,"WARNING! H‹iz⁄è»mŸi⁄ ve˘‹ %d i†ouào‡ÆlowedÑ™gê{-8192, 8191} i¿pi˘uª %d, ma¸oblock %d\n", 
mv
->
mv_x
, 
pSli˚
->
p_Vid
->
numbî
,ÖSli˚->
cuºít_mb_ƒ
);

1329 i‡(
mv
->
mv_y
 > (
pSli˚
->
max_mb_vmv_r
 - 1) || mv->mv_y < (-pSlice->max_mb_vmv_r))

1331 
	`Ârötf
(
°dîr
,"WARNING! Vîtiˇ»mŸi⁄ ve˘‹ %d i†ouào‡ÆlowedÑ™gê{%d, %d} i¿pi˘uª %d, ma¸oblock %d\n", 
mv
->
mv_y
, (-
pSli˚
->
max_mb_vmv_r
), (pSli˚->max_mb_vmv_∏- 1),ÖSli˚->
p_Vid
->
numbî
,ÖSli˚->
cuºít_mb_ƒ
);

1334 
	}
}

1336 
ölöe
 
	$check_vît_mv
(
Œimô
, 
vec1_y
,
æimô
)

1338 
y_pos
 = 
vec1_y
 >> 2;

1339 if(
y_pos
 < 
Œimô
 || y_po†> 
æimô
)

1343 
	}
}

1345 
	$≥rf‹m_mc_sögÀ_wp
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
, 
¥ed_dú
, 
i
, 
j
, 
block_size_x
, 
block_size_y
)

1347 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1348 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1349 
£q_∑ømëî_£t_rb•_t
 *
a˘ive_•s
 = 
cuºSli˚
->active_sps;

1350 
img≥l
 **
tmp_block_l0
 = 
cuºSli˚
->tmp_block_l0;

1351 
img≥l
 **
tmp_block_l1
 = 
cuºSli˚
->tmp_block_l1;

1352 c⁄° 
mv_mul
 = 16;

1353 
i4
 = 
cuºMB
->
block_x
 + 
i
;

1354 
j4
 = 
cuºMB
->
block_y
 + 
j
;

1355 
ty≥
 = 
cuºSli˚
->
¶i˚_ty≥
;

1356 
chroma_f‹m©_idc
 = 
dec_pi˘uª
->chroma_format_idc;

1358 
ioff
 = (
i
 << 2);

1359 
joff
 = (
j
 << 2);

1360 
PicMŸi⁄P¨ams
 *
mv_öfo
 = &
dec_pi˘uª
->mv_öfo[
j4
][
i4
];

1361 
ªf_idx
 = 
mv_öfo
->ªf_idx[
¥ed_dú
];

1362 
ªf_idx_wp
 = 
ªf_idx
;

1363 
MŸi⁄Ve˘‹
 *
mv_¨øy
 = &
mv_öfo
->
mv
[
¥ed_dú
];

1364 
li°_off£t
 = 
cuºMB
->list_offset;

1365 
St‹abÀPi˘uª
 *
li°
 = 
cuºSli˚
->
li°X
[
li°_off£t
 + 
¥ed_dú
][
ªf_idx
];

1366 
vec1_x
, 
vec1_y
;

1368 
maxﬁd_x
 = 
dec_pi˘uª
->
size_x_m1
;

1369 
maxﬁd_y
 = (
cuºMB
->
mb_fõld
Ë? (
dec_pi˘uª
->
size_y
 >> 1Ë- 1 : dec_pi˘uª->
size_y_m1
;

1370 
shi·_x
 = 
dec_pi˘uª
->
iLumaSåide
;

1371 **
tmp_ªs
 = 
cuºSli˚
->tmp_res;

1372 
max_img≥l_vÆue
 = 
p_Vid
->
max_≥l_vÆue_comp
[
∂
];

1373 
img≥l
 
no_ªf_vÆue
 = (img≥lË
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

1376 #i‡
ENABLE_DEC_STATS


1377 
p_Vid
->
dec_°©s
->
hi°ogøm_mv
[
LIST_0
][0][
mv_¨øy
->
mv_x
]++;

1378 
p_Vid
->
dec_°©s
->
hi°ogøm_mv
[
LIST_0
][1][
mv_¨øy
->
mv_y
]++;

1381 
	`check_mŸi⁄_ve˘‹_ønge
(
mv_¨øy
, 
cuºSli˚
);

1382 
vec1_x
 = 
i4
 * 
mv_mul
 + 
mv_¨øy
->
mv_x
;

1383 
vec1_y
 = (
cuºMB
->
block_y_aff
 + 
j
Ë* 
mv_mul
 + 
mv_¨øy
->
mv_y
;

1384 if(
block_size_y
 > (
p_Vid
->
iLumaPadY
-4Ë&& 
	`CheckVîtMV
(
cuºMB
, 
vec1_y
, block_size_y))

1386 
	`gë_block_luma
(
li°
, 
vec1_x
, 
vec1_y
, 
block_size_x
, 
BLOCK_SIZE_8x8
, 
tmp_block_l0
, 
shi·_x
,
maxﬁd_x
,
maxﬁd_y
,
tmp_ªs
,
max_img≥l_vÆue
,
no_ªf_vÆue
, 
cuºMB
);

1387 
	`gë_block_luma
(
li°
, 
vec1_x
, 
vec1_y
+
BLOCK_SIZE_8x8_SP
, 
block_size_x
, 
block_size_y
-
BLOCK_SIZE_8x8
, 
tmp_block_l0
+BLOCK_SIZE_8x8, 
shi·_x
,
maxﬁd_x
,
maxﬁd_y
,
tmp_ªs
,
max_img≥l_vÆue
,
no_ªf_vÆue
, 
cuºMB
);

1390 
	`gë_block_luma
(
li°
, 
vec1_x
, 
vec1_y
, 
block_size_x
, 
block_size_y
, 
tmp_block_l0
,
shi·_x
,
maxﬁd_x
,
maxﬁd_y
,
tmp_ªs
,
max_img≥l_vÆue
,
no_ªf_vÆue
, 
cuºMB
);

1394 
Æpha_l0
, 
wp_off£t
, 
wp_díom
;

1395 i‡(
cuºMB
->
mb_fõld
 && ((
p_Vid
->
a˘ive_µs
->
weighãd_¥ed_Êag
&&(
ty≥
==
P_SLICE
||Åy≥ =
SP_SLICE
))||’_Vid->a˘ive_µs->
weighãd_bùªd_idc
==1 && (ty≥==
B_SLICE
))))

1396 
ªf_idx_wp
 >>=1;

1397 
Æpha_l0
 = 
cuºSli˚
->
wp_weight
[
¥ed_dú
][
ªf_idx_wp
][
∂
];

1398 
wp_off£t
 = 
cuºSli˚
->wp_off£t[
¥ed_dú
][
ªf_idx_wp
][
∂
];

1399 
wp_díom
 = 
∂
 > 0 ? 
cuºSli˚
->
chroma_log2_weight_díom
 : cuºSli˚->
luma_log2_weight_díom
;

1400 
	`weighãd_mc_¥edi˘i⁄
(&
cuºSli˚
->
mb_¥ed
[
∂
][
joff
], 
tmp_block_l0
, 
block_size_y
, 
block_size_x
, 
ioff
, 
Æpha_l0
, 
wp_off£t
, 
wp_díom
, 
max_img≥l_vÆue
);

1403 i‡((
chroma_f‹m©_idc
 !
YUV400
Ë&& (chroma_f‹m©_id¯!
YUV444
) )

1405 
ioff_¸
,
joff_¸
,
block_size_x_¸
,
block_size_y_¸
;

1406 
vec1_y_¸
 = 
vec1_y
 + ((
a˘ive_•s
->
chroma_f‹m©_idc
 =1)? 
cuºSli˚
->
chroma_ve˘‹_adju°mít
[
li°_off£t
 + 
¥ed_dú
][
ªf_idx
] : 0);

1407 
tŸÆ_sˇÀ
 = 
p_Vid
->total_scale;

1408 
maxﬁd_x
 = 
dec_pi˘uª
->
size_x_¸_m1
;

1409 
maxﬁd_y
 = (
cuºMB
->
mb_fõld
Ë? (
dec_pi˘uª
->
size_y_¸
 >> 1Ë- 1 : dec_pi˘uª->
size_y_¸_m1
;

1410 
chroma_log2_weight
 = 
cuºSli˚
->
chroma_log2_weight_díom
;

1411 i‡(
p_Vid
->
mb_¸_size_x
 =
MB_BLOCK_SIZE
)

1413 
ioff_¸
 = 
ioff
;

1414 
block_size_x_¸
 = 
block_size_x
;

1418 
ioff_¸
 = 
ioff
 >> 1;

1419 
block_size_x_¸
 = 
block_size_x
 >> 1;

1421 i‡(
p_Vid
->
mb_¸_size_y
 =
MB_BLOCK_SIZE
)

1423 
joff_¸
 = 
joff
;

1424 
block_size_y_¸
 = 
block_size_y
;

1428 
joff_¸
 = 
joff
 >> 1;

1429 
block_size_y_¸
 = 
block_size_y
 >> 1;

1431 
no_ªf_vÆue
 = (
img≥l
)
p_Vid
->
dc_¥ed_vÆue_comp
[1];

1433 *
weight
 = 
cuºSli˚
->
wp_weight
[
¥ed_dú
][
ªf_idx_wp
];

1434 *
off£t
 = 
cuºSli˚
->
wp_off£t
[
¥ed_dú
][
ªf_idx_wp
];

1435 
	`gë_block_chroma
(
li°
,
vec1_x
,
vec1_y_¸
,
p_Vid
->
sub≥l_x
,p_Vid->
sub≥l_y
,
maxﬁd_x
,
maxﬁd_y
,
block_size_x_¸
,
block_size_y_¸
,p_Vid->
shi·≥l_x
,p_Vid->
shi·≥l_y
,&
tmp_block_l0
[0][0],&
tmp_block_l1
[0][0] ,
tŸÆ_sˇÀ
,
no_ªf_vÆue
,p_Vid);

1436 
	`weighãd_mc_¥edi˘i⁄
(&
cuºSli˚
->
mb_¥ed
[1][
joff_¸
], 
tmp_block_l0
, 
block_size_y_¸
, 
block_size_x_¸
, 
ioff_¸
, 
weight
[1], 
off£t
[1], 
chroma_log2_weight
, 
p_Vid
->
max_≥l_vÆue_comp
[1]);

1437 
	`weighãd_mc_¥edi˘i⁄
(&
cuºSli˚
->
mb_¥ed
[2][
joff_¸
], 
tmp_block_l1
, 
block_size_y_¸
, 
block_size_x_¸
, 
ioff_¸
, 
weight
[2], 
off£t
[2], 
chroma_log2_weight
, 
p_Vid
->
max_≥l_vÆue_comp
[2]);

1440 
	}
}

1443 
	$≥rf‹m_mc_sögÀ
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
, 
¥ed_dú
, 
i
, 
j
, 
block_size_x
, 
block_size_y
)

1445 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1446 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1447 
£q_∑ømëî_£t_rb•_t
 *
a˘ive_•s
 = 
cuºSli˚
->active_sps;

1448 
img≥l
 **
tmp_block_l0
 = 
cuºSli˚
->tmp_block_l0;

1449 
img≥l
 **
tmp_block_l1
 = 
cuºSli˚
->tmp_block_l1;

1450 c⁄° 
mv_mul
 = 16;

1451 
i4
 = 
cuºMB
->
block_x
 + 
i
;

1452 
j4
 = 
cuºMB
->
block_y
 + 
j
;

1453 
chroma_f‹m©_idc
 = 
dec_pi˘uª
->chroma_format_idc;

1455 
ioff
 = (
i
 << 2);

1456 
joff
 = (
j
 << 2);

1457 
PicMŸi⁄P¨ams
 *
mv_öfo
 = &
dec_pi˘uª
->mv_öfo[
j4
][
i4
];

1458 
MŸi⁄Ve˘‹
 *
mv_¨øy
 = &
mv_öfo
->
mv
[
¥ed_dú
];

1459 
ªf_idx
 = 
mv_öfo
->ªf_idx[
¥ed_dú
];

1460 
li°_off£t
 = 
cuºMB
->list_offset;

1461 
St‹abÀPi˘uª
 *
li°
 = 
cuºSli˚
->
li°X
[
li°_off£t
 + 
¥ed_dú
][
ªf_idx
];

1462 
vec1_x
, 
vec1_y
;

1464 
maxﬁd_x
 = 
dec_pi˘uª
->
size_x_m1
;

1465 
maxﬁd_y
 = (
cuºMB
->
mb_fõld
Ë? (
dec_pi˘uª
->
size_y
 >> 1Ë- 1 : dec_pi˘uª->
size_y_m1
;

1466 
shi·_x
 = 
dec_pi˘uª
->
iLumaSåide
;

1467 **
tmp_ªs
 = 
cuºSli˚
->tmp_res;

1468 
max_img≥l_vÆue
 = 
p_Vid
->
max_≥l_vÆue_comp
[
∂
];

1469 
img≥l
 
no_ªf_vÆue
 = (img≥lË
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

1471 #i‡
ENABLE_DEC_STATS


1472 
p_Vid
->
dec_°©s
->
hi°ogøm_mv
[
LIST_0
][0][
mv_¨øy
->
mv_x
]++;

1473 
p_Vid
->
dec_°©s
->
hi°ogøm_mv
[
LIST_0
][1][
mv_¨øy
->
mv_y
]++;

1479 
	`check_mŸi⁄_ve˘‹_ønge
(
mv_¨øy
, 
cuºSli˚
);

1480 
vec1_x
 = 
i4
 * 
mv_mul
 + 
mv_¨øy
->
mv_x
;

1481 
vec1_y
 = (
cuºMB
->
block_y_aff
 + 
j
Ë* 
mv_mul
 + 
mv_¨øy
->
mv_y
;

1483 i‡(
block_size_y
 > (
p_Vid
->
iLumaPadY
-4Ë&& 
	`CheckVîtMV
(
cuºMB
, 
vec1_y
, block_size_y))

1485 
	`gë_block_luma
(
li°
, 
vec1_x
, 
vec1_y
, 
block_size_x
, 
BLOCK_SIZE_8x8
, 
tmp_block_l0
, 
shi·_x
,
maxﬁd_x
,
maxﬁd_y
,
tmp_ªs
,
max_img≥l_vÆue
,
no_ªf_vÆue
, 
cuºMB
);

1486 
	`gë_block_luma
(
li°
, 
vec1_x
, 
vec1_y
+
BLOCK_SIZE_8x8_SP
, 
block_size_x
, 
block_size_y
-
BLOCK_SIZE_8x8
, 
tmp_block_l0
+BLOCK_SIZE_8x8, 
shi·_x
,
maxﬁd_x
,
maxﬁd_y
,
tmp_ªs
,
max_img≥l_vÆue
,
no_ªf_vÆue
, 
cuºMB
);

1489 
	`gë_block_luma
(
li°
, 
vec1_x
, 
vec1_y
, 
block_size_x
, 
block_size_y
, 
tmp_block_l0
,
shi·_x
,
maxﬁd_x
,
maxﬁd_y
,
tmp_ªs
,
max_img≥l_vÆue
,
no_ªf_vÆue
, 
cuºMB
);

1491 
	`mc_¥edi˘i⁄
(&
cuºSli˚
->
mb_¥ed
[
∂
][
joff
], 
tmp_block_l0
, 
block_size_y
, 
block_size_x
, 
ioff
);

1493 i‡((
chroma_f‹m©_idc
 !
YUV400
Ë&& (chroma_f‹m©_id¯!
YUV444
) )

1495 
ioff_¸
,
joff_¸
,
block_size_x_¸
,
block_size_y_¸
;

1496 
vec1_y_¸
 = 
vec1_y
 + ((
a˘ive_•s
->
chroma_f‹m©_idc
 =1)? 
cuºSli˚
->
chroma_ve˘‹_adju°mít
[
li°_off£t
 + 
¥ed_dú
][
ªf_idx
] : 0);

1497 
tŸÆ_sˇÀ
 = 
p_Vid
->total_scale;

1498 
maxﬁd_x
 = 
dec_pi˘uª
->
size_x_¸_m1
;

1499 
maxﬁd_y
 = (
cuºMB
->
mb_fõld
Ë? (
dec_pi˘uª
->
size_y_¸
 >> 1Ë- 1 : dec_pi˘uª->
size_y_¸_m1
;

1500 i‡(
p_Vid
->
mb_¸_size_x
 =
MB_BLOCK_SIZE
)

1502 
ioff_¸
 = 
ioff
;

1503 
block_size_x_¸
 = 
block_size_x
;

1507 
ioff_¸
 = 
ioff
 >> 1;

1508 
block_size_x_¸
 = 
block_size_x
 >> 1;

1510 i‡(
p_Vid
->
mb_¸_size_y
 =
MB_BLOCK_SIZE
)

1512 
joff_¸
 = 
joff
;

1513 
block_size_y_¸
 = 
block_size_y
;

1517 
joff_¸
 = 
joff
 >> 1;

1518 
block_size_y_¸
 = 
block_size_y
 >> 1;

1520 
no_ªf_vÆue
 = (
img≥l
)
p_Vid
->
dc_¥ed_vÆue_comp
[1];

1521 
	`gë_block_chroma
(
li°
,
vec1_x
,
vec1_y_¸
,
p_Vid
->
sub≥l_x
,p_Vid->
sub≥l_y
,
maxﬁd_x
,
maxﬁd_y
,
block_size_x_¸
,
block_size_y_¸
,p_Vid->
shi·≥l_x
,p_Vid->
shi·≥l_y
,&
tmp_block_l0
[0][0],&
tmp_block_l1
[0][0] ,
tŸÆ_sˇÀ
,
no_ªf_vÆue
,p_Vid);

1522 
	`mc_¥edi˘i⁄
(&
cuºSli˚
->
mb_¥ed
[1][
joff_¸
], 
tmp_block_l0
, 
block_size_y_¸
, 
block_size_x_¸
, 
ioff_¸
);

1523 
	`mc_¥edi˘i⁄
(&
cuºSli˚
->
mb_¥ed
[2][
joff_¸
], 
tmp_block_l1
, 
block_size_y_¸
, 
block_size_x_¸
, 
ioff_¸
);

1525 
	}
}

1527 
	$≥rf‹m_mc_bi_wp
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
, 
i
, 
j
, 
block_size_x
, 
block_size_y
)

1529 c⁄° 
mv_mul
 = 16;

1530 
vec1_x
, 
vec1_y
, 
vec2_x
, 
vec2_y
;

1531 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1532 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1534 
weighãd_bùªd_idc
 = 
p_Vid
->
a˘ive_µs
->weighted_bipred_idc;

1535 
block_y_aff
 = 
cuºMB
->block_y_aff;

1536 
i4
 = 
cuºMB
->
block_x
 + 
i
;

1537 
j4
 = 
cuºMB
->
block_y
 + 
j
;

1538 
ioff
 = (
i
 << 2);

1539 
joff
 = (
j
 << 2);

1540 
chroma_f‹m©_idc
 = 
dec_pi˘uª
->chroma_format_idc;

1541 
li°_off£t
 = 
cuºMB
->list_offset;

1542 
PicMŸi⁄P¨ams
 *
mv_öfo
 = &
dec_pi˘uª
->mv_öfo[
j4
][
i4
];

1543 
MŸi⁄Ve˘‹
 *
l0_mv_¨øy
 = &
mv_öfo
->
mv
[
LIST_0
];

1544 
MŸi⁄Ve˘‹
 *
l1_mv_¨øy
 = &
mv_öfo
->
mv
[
LIST_1
];

1545 
l0_ªf‰ame
 = 
mv_öfo
->
ªf_idx
[
LIST_0
];

1546 
l1_ªf‰ame
 = 
mv_öfo
->
ªf_idx
[
LIST_1
];

1547 
l0_ªf_idx
 = (
cuºMB
->
mb_fõld
 && 
weighãd_bùªd_idc
 =1Ë? 
l0_ªf‰ame
 >> 1:Ü0_refframe;

1548 
l1_ªf_idx
 = (
cuºMB
->
mb_fõld
 && 
weighãd_bùªd_idc
 =1Ë? 
l1_ªf‰ame
 >> 1:Ü1_refframe;

1552 
wt_li°_off£t
 = (
weighãd_bùªd_idc
==2)? 
li°_off£t
 : 0;

1553 *
weight0
 = 
cuºSli˚
->
wbp_weight
[
LIST_0
 + 
wt_li°_off£t
][
l0_ªf_idx
][
l1_ªf_idx
];

1554 *
weight1
 = 
cuºSli˚
->
wbp_weight
[
LIST_1
 + 
wt_li°_off£t
][
l0_ªf_idx
][
l1_ªf_idx
];

1555 *
off£t0
 = 
cuºSli˚
->
wp_off£t
[
LIST_0
 + 
wt_li°_off£t
][
l0_ªf_idx
];

1556 *
off£t1
 = 
cuºSli˚
->
wp_off£t
[
LIST_1
 + 
wt_li°_off£t
][
l1_ªf_idx
];

1557 
maxﬁd_y
 = (
cuºMB
->
mb_fõld
Ë? (
dec_pi˘uª
->
size_y
 >> 1Ë- 1 : dec_pi˘uª->
size_y_m1
;

1558 
∑dy
 = 
p_Vid
->
iLumaPadY
;

1559 
æimô
 = 
maxﬁd_y
 + 
∑dy
 - 
block_size_y
 - 2;

1560 
Œimô
 = 2 - 
∑dy
;

1561 
big_blocky
 = 
block_size_y
 > (
∑dy
 - 4);

1562 
St‹abÀPi˘uª
 *
li°0
 = 
cuºSli˚
->
li°X
[
LIST_0
 + 
li°_off£t
][
l0_ªf‰ame
];

1563 
St‹abÀPi˘uª
 *
li°1
 = 
cuºSli˚
->
li°X
[
LIST_1
 + 
li°_off£t
][
l1_ªf‰ame
];

1564 
img≥l
 **
tmp_block_l0
 = 
cuºSli˚
->tmp_block_l0;

1565 
img≥l
 *
block0
 = 
tmp_block_l0
[0];

1566 
img≥l
 **
tmp_block_l1
 = 
cuºSli˚
->tmp_block_l1;

1567 
img≥l
 *
block1
 = 
tmp_block_l1
[0];

1568 
img≥l
 **
tmp_block_l2
 = 
cuºSli˚
->tmp_block_l2;

1569 
img≥l
 *
block2
 = 
tmp_block_l2
[0];

1570 
img≥l
 **
tmp_block_l3
 = 
cuºSli˚
->tmp_block_l3;

1571 
img≥l
 *
block3
 = 
tmp_block_l3
[0];

1572 
wp_off£t
;

1573 
wp_díom
;

1576 
maxﬁd_x
 = 
dec_pi˘uª
->
size_x_m1
;

1577 
shi·_x
 = 
dec_pi˘uª
->
iLumaSåide
;

1578 **
tmp_ªs
 = 
cuºSli˚
->tmp_res;

1579 
max_img≥l_vÆue
 = 
p_Vid
->
max_≥l_vÆue_comp
[
∂
];

1580 
img≥l
 
no_ªf_vÆue
 = (img≥lË
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

1582 
	`check_mŸi⁄_ve˘‹_ønge
(
l0_mv_¨øy
, 
cuºSli˚
);

1583 
	`check_mŸi⁄_ve˘‹_ønge
(
l1_mv_¨øy
, 
cuºSli˚
);

1584 
vec1_x
 = 
i4
 * 
mv_mul
 + 
l0_mv_¨øy
->
mv_x
;

1585 
vec2_x
 = 
i4
 * 
mv_mul
 + 
l1_mv_¨øy
->
mv_x
;

1586 
vec1_y
 = (
block_y_aff
 + 
j
Ë* 
mv_mul
 + 
l0_mv_¨øy
->
mv_y
;

1587 
vec2_y
 = (
block_y_aff
 + 
j
Ë* 
mv_mul
 + 
l1_mv_¨øy
->
mv_y
;

1589 i‡(
big_blocky
 && 
	`check_vît_mv
(
Œimô
, 
vec1_y
, 
æimô
))

1591 
	`gë_block_luma
(
li°0
, 
vec1_x
, 
vec1_y
, 
block_size_x
, 
BLOCK_SIZE_8x8
, 
tmp_block_l0
, 
shi·_x
,
maxﬁd_x
,
maxﬁd_y
,
tmp_ªs
,
max_img≥l_vÆue
,
no_ªf_vÆue
, 
cuºMB
);

1592 
	`gë_block_luma
(
li°0
, 
vec1_x
, 
vec1_y
+
BLOCK_SIZE_8x8_SP
, 
block_size_x
, 
block_size_y
-
BLOCK_SIZE_8x8
, 
tmp_block_l0
+BLOCK_SIZE_8x8, 
shi·_x
,
maxﬁd_x
,
maxﬁd_y
,
tmp_ªs
,
max_img≥l_vÆue
,
no_ªf_vÆue
, 
cuºMB
);

1595 
	`gë_block_luma
(
li°0
, 
vec1_x
, 
vec1_y
, 
block_size_x
, 
block_size_y
, 
tmp_block_l0
,
shi·_x
,
maxﬁd_x
,
maxﬁd_y
,
tmp_ªs
,
max_img≥l_vÆue
,
no_ªf_vÆue
, 
cuºMB
);

1596 i‡(
big_blocky
 && 
	`check_vît_mv
(
Œimô
, 
vec2_y
,
æimô
))

1598 
	`gë_block_luma
(
li°1
, 
vec2_x
, 
vec2_y
, 
block_size_x
, 
BLOCK_SIZE_8x8
, 
tmp_block_l1
, 
shi·_x
,
maxﬁd_x
,
maxﬁd_y
,
tmp_ªs
,
max_img≥l_vÆue
,
no_ªf_vÆue
, 
cuºMB
);

1599 
	`gë_block_luma
(
li°1
, 
vec2_x
, 
vec2_y
+
BLOCK_SIZE_8x8_SP
, 
block_size_x
, 
block_size_y
-
BLOCK_SIZE_8x8
, 
tmp_block_l1
 + BLOCK_SIZE_8x8, 
shi·_x
,
maxﬁd_x
,
maxﬁd_y
,
tmp_ªs
,
max_img≥l_vÆue
,
no_ªf_vÆue
, 
cuºMB
);

1602 
	`gë_block_luma
(
li°1
, 
vec2_x
, 
vec2_y
, 
block_size_x
, 
block_size_y
, 
tmp_block_l1
,
shi·_x
,
maxﬁd_x
,
maxﬁd_y
,
tmp_ªs
,
max_img≥l_vÆue
,
no_ªf_vÆue
, 
cuºMB
);

1605 
wp_off£t
 = ((
off£t0
[
∂
] + 
off£t1
[pl] + 1) >>1);

1606 
wp_díom
 = 
∂
 > 0 ? 
cuºSli˚
->
chroma_log2_weight_díom
 : cuºSli˚->
luma_log2_weight_díom
;

1607 
	`weighãd_bi_¥edi˘i⁄
(&
cuºSli˚
->
mb_¥ed
[
∂
][
joff
][
ioff
], 
block0
, 
block1
, 
block_size_y
, 
block_size_x
, 
weight0
[∂], 
weight1
[∂], 
wp_off£t
, 
wp_díom
 + 1, 
max_img≥l_vÆue
);

1609 i‡((
chroma_f‹m©_idc
 !
YUV400
Ë&& (chroma_f‹m©_id¯!
YUV444
) )

1611 
ioff_¸
, 
joff_¸
,
block_size_y_¸
,
block_size_x_¸
,
vec2_y_¸
,
vec1_y_¸
;

1612 
maxﬁd_x
 = 
dec_pi˘uª
->
size_x_¸_m1
;

1613 
maxﬁd_y
 = (
cuºMB
->
mb_fõld
Ë? (
dec_pi˘uª
->
size_y_¸
 >> 1Ë- 1 : dec_pi˘uª->
size_y_¸_m1
;

1614 
shi·≥l_x
 = 
p_Vid
->shiftpel_x;

1615 
shi·≥l_y
 = 
p_Vid
->shiftpel_y;

1616 
sub≥l_x
 = 
p_Vid
->subpel_x;

1617 
sub≥l_y
 = 
p_Vid
->subpel_y;

1618 
tŸÆ_sˇÀ
 = 
p_Vid
->total_scale;

1619 
chroma_log2
 = 
cuºSli˚
->
chroma_log2_weight_díom
 + 1;

1621 i‡(
p_Vid
->
mb_¸_size_x
 =
MB_BLOCK_SIZE
)

1623 
ioff_¸
 = 
ioff
;

1624 
block_size_x_¸
 = 
block_size_x
;

1628 
ioff_¸
 = 
ioff
 >> 1;

1629 
block_size_x_¸
 = 
block_size_x
 >> 1;

1632 i‡(
p_Vid
->
mb_¸_size_y
 =
MB_BLOCK_SIZE
)

1634 
joff_¸
 = 
joff
;

1635 
block_size_y_¸
 = 
block_size_y
;

1639 
joff_¸
 = 
joff
 >> 1;

1640 
block_size_y_¸
 = 
block_size_y
 >> 1;

1642 i‡(
chroma_f‹m©_idc
 == 1)

1644 
vec1_y_¸
 = 
vec1_y
 + 
cuºSli˚
->
chroma_ve˘‹_adju°mít
[
LIST_0
 + 
li°_off£t
][
l0_ªf‰ame
];

1645 
vec2_y_¸
 = 
vec2_y
 + 
cuºSli˚
->
chroma_ve˘‹_adju°mít
[
LIST_1
 + 
li°_off£t
][
l1_ªf‰ame
];

1649 
vec1_y_¸
 = 
vec1_y
;

1650 
vec2_y_¸
 = 
vec2_y
;

1652 
no_ªf_vÆue
 = (
img≥l
)
p_Vid
->
dc_¥ed_vÆue_comp
[1];

1654 
wp_off£t
 = ((
off£t0
[1] + 
off£t1
[1] + 1) >>1);

1655 
	`gë_block_chroma
(
li°0
,
vec1_x
,
vec1_y_¸
,
sub≥l_x
,
sub≥l_y
,
maxﬁd_x
,
maxﬁd_y
,
block_size_x_¸
,
block_size_y_¸
,
shi·≥l_x
,
shi·≥l_y
,
block0
,
block2
 ,
tŸÆ_sˇÀ
,
no_ªf_vÆue
,
p_Vid
);

1656 
	`gë_block_chroma
(
li°1
,
vec2_x
,
vec2_y_¸
,
sub≥l_x
,
sub≥l_y
,
maxﬁd_x
,
maxﬁd_y
,
block_size_x_¸
,
block_size_y_¸
,
shi·≥l_x
,
shi·≥l_y
,
block1
,
block3
 ,
tŸÆ_sˇÀ
,
no_ªf_vÆue
,
p_Vid
);

1657 
	`weighãd_bi_¥edi˘i⁄
(&
cuºSli˚
->
mb_¥ed
[1][
joff_¸
][
ioff_¸
],
block0
,
block1
,
block_size_y_¸
,
block_size_x_¸
,
weight0
[1],
weight1
[1],
wp_off£t
,
chroma_log2
,
p_Vid
->
max_≥l_vÆue_comp
[1]);

1658 
wp_off£t
 = ((
off£t0
[2] + 
off£t1
[2] + 1) >>1);

1659 
	`weighãd_bi_¥edi˘i⁄
(&
cuºSli˚
->
mb_¥ed
[2][
joff_¸
][
ioff_¸
],
block2
,
block3
,
block_size_y_¸
,
block_size_x_¸
,
weight0
[2],
weight1
[2],
wp_off£t
,
chroma_log2
,
p_Vid
->
max_≥l_vÆue_comp
[2]);

1661 
	}
}

1663 
	$≥rf‹m_mc_bi
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
, 
i
, 
j
, 
block_size_x
, 
block_size_y
)

1665 c⁄° 
mv_mul
 = 16;

1666 
vec1_x
=0, 
vec1_y
=0, 
vec2_x
=0, 
vec2_y
=0;

1667 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1668 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1670 
block_y_aff
 = 
cuºMB
->block_y_aff;

1671 
i4
 = 
cuºMB
->
block_x
 + 
i
;

1672 
j4
 = 
cuºMB
->
block_y
 + 
j
;

1673 
ioff
 = (
i
 << 2);

1674 
joff
 = (
j
 << 2);

1675 
chroma_f‹m©_idc
 = 
dec_pi˘uª
->chroma_format_idc;

1676 
PicMŸi⁄P¨ams
 *
mv_öfo
 = &
dec_pi˘uª
->mv_öfo[
j4
][
i4
];

1677 
MŸi⁄Ve˘‹
 *
l0_mv_¨øy
 = &
mv_öfo
->
mv
[
LIST_0
];

1678 
MŸi⁄Ve˘‹
 *
l1_mv_¨øy
 = &
mv_öfo
->
mv
[
LIST_1
];

1679 
l0_ªf‰ame
 = 
mv_öfo
->
ªf_idx
[
LIST_0
];

1680 
l1_ªf‰ame
 = 
mv_öfo
->
ªf_idx
[
LIST_1
];

1681 
li°_off£t
 = 
cuºMB
->list_offset;

1683 
maxﬁd_y
 = (
cuºMB
->
mb_fõld
Ë? (
dec_pi˘uª
->
size_y
 >> 1Ë- 1 : dec_pi˘uª->
size_y_m1
;

1684 
∑dy
 = 
p_Vid
->
iLumaPadY
;

1685 
æimô
 = 
maxﬁd_y
 + 
∑dy
 - 
block_size_y
 - 2;

1686 
Œimô
 = 2 - 
∑dy
;

1687 
big_blocky
 = 
block_size_y
 > (
∑dy
 - 4);

1688 
St‹abÀPi˘uª
 *
li°0
 = 
cuºSli˚
->
li°X
[
LIST_0
 + 
li°_off£t
][
l0_ªf‰ame
];

1689 
St‹abÀPi˘uª
 *
li°1
 = 
cuºSli˚
->
li°X
[
LIST_1
 + 
li°_off£t
][
l1_ªf‰ame
];

1690 
img≥l
 **
tmp_block_l0
 = 
cuºSli˚
->tmp_block_l0;

1691 
img≥l
 *
block0
 = 
tmp_block_l0
[0];

1692 
img≥l
 **
tmp_block_l1
 = 
cuºSli˚
->tmp_block_l1;

1693 
img≥l
 *
block1
 = 
tmp_block_l1
[0];

1694 
img≥l
 **
tmp_block_l2
 = 
cuºSli˚
->tmp_block_l2;

1695 
img≥l
 *
block2
 = 
tmp_block_l2
[0];

1696 
img≥l
 **
tmp_block_l3
 = 
cuºSli˚
->tmp_block_l3;

1697 
img≥l
 *
block3
 = 
tmp_block_l3
[0];

1699 
maxﬁd_x
 = 
dec_pi˘uª
->
size_x_m1
;

1700 
shi·_x
 = 
dec_pi˘uª
->
iLumaSåide
;

1701 **
tmp_ªs
 = 
cuºSli˚
->tmp_res;

1702 
max_img≥l_vÆue
 = 
p_Vid
->
max_≥l_vÆue_comp
[
∂
];

1703 
img≥l
 
no_ªf_vÆue
 = (img≥lË
p_Vid
->
dc_¥ed_vÆue_comp
[
∂
];

1704 
	`check_mŸi⁄_ve˘‹_ønge
(
l0_mv_¨øy
, 
cuºSli˚
);

1705 
	`check_mŸi⁄_ve˘‹_ønge
(
l1_mv_¨øy
, 
cuºSli˚
);

1706 
vec1_x
 = 
i4
 * 
mv_mul
 + 
l0_mv_¨øy
->
mv_x
;

1707 
vec2_x
 = 
i4
 * 
mv_mul
 + 
l1_mv_¨øy
->
mv_x
;

1708 
vec1_y
 = (
block_y_aff
 + 
j
Ë* 
mv_mul
 + 
l0_mv_¨øy
->
mv_y
;

1709 
vec2_y
 = (
block_y_aff
 + 
j
Ë* 
mv_mul
 + 
l1_mv_¨øy
->
mv_y
;

1710 i‡(
big_blocky
 && 
	`check_vît_mv
(
Œimô
, 
vec1_y
, 
æimô
))

1712 
	`gë_block_luma
(
li°0
, 
vec1_x
, 
vec1_y
, 
block_size_x
, 
BLOCK_SIZE_8x8
, 
tmp_block_l0
, 
shi·_x
,
maxﬁd_x
,
maxﬁd_y
,
tmp_ªs
,
max_img≥l_vÆue
,
no_ªf_vÆue
, 
cuºMB
);

1713 
	`gë_block_luma
(
li°0
, 
vec1_x
, 
vec1_y
+
BLOCK_SIZE_8x8_SP
, 
block_size_x
, 
block_size_y
-
BLOCK_SIZE_8x8
, 
tmp_block_l0
+BLOCK_SIZE_8x8, 
shi·_x
,
maxﬁd_x
,
maxﬁd_y
,
tmp_ªs
,
max_img≥l_vÆue
,
no_ªf_vÆue
, 
cuºMB
);

1716 
	`gë_block_luma
(
li°0
, 
vec1_x
, 
vec1_y
, 
block_size_x
, 
block_size_y
, 
tmp_block_l0
,
shi·_x
,
maxﬁd_x
,
maxﬁd_y
,
tmp_ªs
,
max_img≥l_vÆue
,
no_ªf_vÆue
, 
cuºMB
);

1717 i‡(
big_blocky
 && 
	`check_vît_mv
(
Œimô
, 
vec2_y
,
æimô
))

1719 
	`gë_block_luma
(
li°1
, 
vec2_x
, 
vec2_y
, 
block_size_x
, 
BLOCK_SIZE_8x8
, 
tmp_block_l1
, 
shi·_x
,
maxﬁd_x
,
maxﬁd_y
,
tmp_ªs
,
max_img≥l_vÆue
,
no_ªf_vÆue
, 
cuºMB
);

1720 
	`gë_block_luma
(
li°1
, 
vec2_x
, 
vec2_y
+
BLOCK_SIZE_8x8_SP
, 
block_size_x
, 
block_size_y
-
BLOCK_SIZE_8x8
, 
tmp_block_l1
 + BLOCK_SIZE_8x8, 
shi·_x
,
maxﬁd_x
,
maxﬁd_y
,
tmp_ªs
,
max_img≥l_vÆue
,
no_ªf_vÆue
, 
cuºMB
);

1723 
	`gë_block_luma
(
li°1
, 
vec2_x
, 
vec2_y
, 
block_size_x
, 
block_size_y
, 
tmp_block_l1
,
shi·_x
,
maxﬁd_x
,
maxﬁd_y
,
tmp_ªs
,
max_img≥l_vÆue
,
no_ªf_vÆue
, 
cuºMB
);

1724 
	`bi_¥edi˘i⁄
(&
cuºSli˚
->
mb_¥ed
[
∂
][
joff
],
tmp_block_l0
,
tmp_block_l1
, 
block_size_y
, 
block_size_x
, 
ioff
);

1726 i‡((
chroma_f‹m©_idc
 !
YUV400
Ë&& (chroma_f‹m©_id¯!
YUV444
) )

1728 
ioff_¸
, 
joff_¸
,
block_size_y_¸
,
block_size_x_¸
,
vec2_y_¸
,
vec1_y_¸
;

1729 
chroma_f‹m©_idc
 = 
p_Vid
->
a˘ive_•s
->chroma_format_idc;

1730 
maxﬁd_x
 = 
dec_pi˘uª
->
size_x_¸_m1
;

1731 
maxﬁd_y
 = (
cuºMB
->
mb_fõld
Ë? (
dec_pi˘uª
->
size_y_¸
 >> 1Ë- 1 : dec_pi˘uª->
size_y_¸_m1
;

1732 
shi·≥l_x
 = 
p_Vid
->shiftpel_x;

1733 
shi·≥l_y
 = 
p_Vid
->shiftpel_y;

1734 
sub≥l_x
 = 
p_Vid
->subpel_x;

1735 
sub≥l_y
 = 
p_Vid
->subpel_y;

1736 
tŸÆ_sˇÀ
 = 
p_Vid
->total_scale;

1737 i‡(
p_Vid
->
mb_¸_size_x
 =
MB_BLOCK_SIZE
)

1739 
ioff_¸
 = 
ioff
;

1740 
block_size_x_¸
 = 
block_size_x
;

1744 
ioff_¸
 = 
ioff
 >> 1;

1745 
block_size_x_¸
 = 
block_size_x
 >> 1;

1747 i‡(
p_Vid
->
mb_¸_size_y
 =
MB_BLOCK_SIZE
)

1749 
joff_¸
 = 
joff
;

1750 
block_size_y_¸
 = 
block_size_y
;

1754 
joff_¸
 = 
joff
 >> 1;

1755 
block_size_y_¸
 = 
block_size_y
 >> 1;

1757 i‡(
chroma_f‹m©_idc
 == 1)

1759 
vec1_y_¸
 = 
vec1_y
 + 
cuºSli˚
->
chroma_ve˘‹_adju°mít
[
LIST_0
 + 
li°_off£t
][
l0_ªf‰ame
];

1760 
vec2_y_¸
 = 
vec2_y
 + 
cuºSli˚
->
chroma_ve˘‹_adju°mít
[
LIST_1
 + 
li°_off£t
][
l1_ªf‰ame
];

1764 
vec1_y_¸
 = 
vec1_y
;

1765 
vec2_y_¸
 = 
vec2_y
;

1767 
no_ªf_vÆue
 = (
img≥l
)
p_Vid
->
dc_¥ed_vÆue_comp
[1];

1768 
	`gë_block_chroma
(
li°0
,
vec1_x
,
vec1_y_¸
,
sub≥l_x
,
sub≥l_y
,
maxﬁd_x
,
maxﬁd_y
,
block_size_x_¸
,
block_size_y_¸
,
shi·≥l_x
,
shi·≥l_y
,
block0
,
block2
 ,
tŸÆ_sˇÀ
,
no_ªf_vÆue
,
p_Vid
);

1769 
	`gë_block_chroma
(
li°1
,
vec2_x
,
vec2_y_¸
,
sub≥l_x
,
sub≥l_y
,
maxﬁd_x
,
maxﬁd_y
,
block_size_x_¸
,
block_size_y_¸
,
shi·≥l_x
,
shi·≥l_y
,
block1
,
block3
 ,
tŸÆ_sˇÀ
,
no_ªf_vÆue
,
p_Vid
);

1770 
	`bi_¥edi˘i⁄
(&
cuºSli˚
->
mb_¥ed
[1][
joff_¸
],
tmp_block_l0
,
tmp_block_l1
, 
block_size_y_¸
, 
block_size_x_¸
, 
ioff_¸
);

1771 
	`bi_¥edi˘i⁄
(&
cuºSli˚
->
mb_¥ed
[2][
joff_¸
],
tmp_block_l2
,
tmp_block_l3
, 
block_size_y_¸
, 
block_size_x_¸
, 
ioff_¸
);

1773 
	}
}

1776 
	$≥rf‹m_mc
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
, 
¥ed_dú
, 
i
, 
j
, 
block_size_x
, 
block_size_y
)

1778 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1779 
	`as£π
 (
¥ed_dú
<=2);

1780 i‡(
¥ed_dú
 != 2)

1782 i‡(
cuºSli˚
->
weighãd_¥ed_Êag
)

1783 
	`≥rf‹m_mc_sögÀ_wp
(
cuºMB
, 
∂
, 
dec_pi˘uª
, 
¥ed_dú
, 
i
, 
j
, 
block_size_x
, 
block_size_y
);

1785 
	`≥rf‹m_mc_sögÀ
(
cuºMB
, 
∂
, 
dec_pi˘uª
, 
¥ed_dú
, 
i
, 
j
, 
block_size_x
, 
block_size_y
);

1789 i‡(
cuºSli˚
->
weighãd_bùªd_idc
)

1790 
	`≥rf‹m_mc_bi_wp
(
cuºMB
, 
∂
, 
dec_pi˘uª
, 
i
, 
j
, 
block_size_x
, 
block_size_y
);

1792 
	`≥rf‹m_mc_bi
(
cuºMB
, 
∂
, 
dec_pi˘uª
, 
i
, 
j
, 
block_size_x
, 
block_size_y
);

1794 
	}
}

	@ldecod/src/nal.c

17 
	~"c⁄åibut‹s.h
"

18 
	~"globÆ.h
"

34 
	$RBSPtoSODB
(
byã
 *
°ªamBuf„r
, 
œ°_byã_pos
)

36 
˘r_bô
, 
bôoff£t
;

38 
bôoff£t
 = 0;

40 
˘r_bô
 = (
°ªamBuf„r
[
œ°_byã_pos
-1] & (0x01<<
bôoff£t
));

42 
˘r_bô
==0)

44 ++
bôoff£t
;

45 if(
bôoff£t
 == 8)

47 if(
œ°_byã_pos
 == 0)

48 
	`¥ötf
(" Panic: All zero data sequence in RBSP \n");

49 
	`as£π
(
œ°_byã_pos
 != 0);

50 --
œ°_byã_pos
;

51 
bôoff£t
 = 0;

53 
˘r_bô

°ªamBuf„r
[
œ°_byã_pos
 - 1] & (0x01<<(
bôoff£t
));

66 (
œ°_byã_pos
);

68 
	}
}

84 
	$EBSPtoRBSP
(
byã
 *
°ªamBuf„r
, 
íd_byãpos
, 
begö_byãpos
)

86 
i
, 
j
, 
cou¡
;

87 
cou¡
 = 0;

89 if(
íd_byãpos
 < 
begö_byãpos
)

90  
íd_byãpos
;

92 
j
 = 
begö_byãpos
;

94 
i
 = 
begö_byãpos
; i < 
íd_byãpos
; ++i)

97 if(
cou¡
 =
ZEROBYTES_SHORTSTARTCODE
 && 
°ªamBuf„r
[
i
] < 0x03)

99 if(
cou¡
 =
ZEROBYTES_SHORTSTARTCODE
 && 
°ªamBuf„r
[
i
] == 0x03)

102 if((
i
 < 
íd_byãpos
-1Ë&& (
°ªamBuf„r
[i+1] > 0x03))

105 if(
i
 =
íd_byãpos
-1)

106  
j
;

108 ++
i
;

109 
cou¡
 = 0;

111 
°ªamBuf„r
[
j
] = såómBuf„r[
i
];

112 if(
°ªamBuf„r
[
i
] == 0x00)

113 ++
cou¡
;

115 
cou¡
 = 0;

116 ++
j
;

119  
j
;

120 
	}
}

	@ldecod/src/nalu.c

15 
	~"globÆ.h
"

16 
	~"™√xb.h
"

17 
	~"«lu.h
"

18 
	~"memÆloc.h
"

19 
	~"πp.h
"

20 #i‡(
MVC_EXTENSION_ENABLE
)

21 
	~"vlc.h
"

37 
	$NALUtoRBSP
 (
NALU_t
 *
«lu
)

39 
	`as£π
 (
«lu
 !
NULL
);

41 
«lu
->
Àn
 = 
	`EBSPtoRBSP
 («lu->
buf
,Çalu->len, 1) ;

43  
«lu
->
Àn
 ;

44 
	}
}

52 
	$ªad_√xt_«lu
(
VideoP¨amëîs
 *
p_Vid
, 
NALU_t
 *
«lu
)

54 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

55 
ªt
;

57  
p_I≈
->
FûeF‹m©
 )

60 
PAR_OF_ANNEXB
:

61 
ªt
 = 
	`gë_™√x_b_NALU
(
p_Vid
, 
«lu
,Ö_Vid->
™√x_b
);

63 
PAR_OF_RTP
:

64 
ªt
 = 
	`GëRTPNALU
(
p_Vid
, 
«lu
,Ö_Vid->
BôSåómFûe
);

68 i‡(
ªt
 < 0)

70 
	`¢¥ötf
 (
îr‹ãxt
, 
ET_SIZE
, "Eº‹ whûêgëtögÅhêNALU i¿fûêf‹m© %s,Éxô\n", 
p_I≈
->
FûeF‹m©
==
PAR_OF_ANNEXB
?"Annex B":"RTP");

71 
	`îr‹
 (
îr‹ãxt
, 601);

73 i‡(
ªt
 == 0)

81 
	`CheckZîoByãN⁄VCL
(
p_Vid
, 
«lu
);

83 
ªt
 = 
	`NALUtoRBSP
(
«lu
);

85 i‡(
ªt
 < 0)

86 
	`îr‹
 ("Invalid startcodeÉmulationÖrevention found.", 602);

89 i‡(
«lu
->
f‹biddí_bô
)

91 
	`îr‹
 ("Found NALU with forbidden_bit set, bitÉrror?", 603);

94  
«lu
->
Àn
;

95 
	}
}

97 
	$CheckZîoByãN⁄VCL
(
VideoP¨amëîs
 *
p_Vid
, 
NALU_t
 *
«lu
)

99 
CheckZîoByã
=0;

102 if(
«lu
->
«l_unô_ty≥
>=1&&nalu->nal_unit_type<=5)

106 if(
«lu
->
«l_unô_ty≥
==
NALU_TYPE_SPS
 ||ÇÆu->«l_unô_ty≥==
NALU_TYPE_PPS
)

107 
CheckZîoByã
=1;

109 if(
«lu
->
«l_unô_ty≥
==
NALU_TYPE_AUD
 ||ÇÆu->«l_unô_ty≥==
NALU_TYPE_SPS
 ||

110 
«lu
->
«l_unô_ty≥
==
NALU_TYPE_PPS
 ||ÇÆu->«l_unô_ty≥==
NALU_TYPE_SEI
 ||

111 (
«lu
->
«l_unô_ty≥
>=13 &&Çalu->nal_unit_type<=18))

113 if(
p_Vid
->
La°Ac˚ssUnôExi°s
)

115 
p_Vid
->
La°Ac˚ssUnôExi°s
=0;

116 
p_Vid
->
NALUCou¡
=0;

119 
p_Vid
->
NALUCou¡
++;

121 if(
p_Vid
->
NALUCou¡
==1)

122 
CheckZîoByã
=1;

123 if(
CheckZîoByã
 && 
«lu
->
°¨tcodïªfix_Àn
==3)

125 
	`¥ötf
("Warning: zero_byte shallÉxist\n");

128 
	}
}

130 
	$CheckZîoByãVCL
(
VideoP¨amëîs
 *
p_Vid
, 
NALU_t
 *
«lu
)

132 
CheckZîoByã
=0;

135 if(!(
«lu
->
«l_unô_ty≥
>=
NALU_TYPE_SLICE
 &&ÇÆu->«l_unô_ty≥ <
NALU_TYPE_IDR
))

138 if(
p_Vid
->
La°Ac˚ssUnôExi°s
)

140 
p_Vid
->
NALUCou¡
=0;

142 
p_Vid
->
NALUCou¡
++;

145 if(
p_Vid
->
NALUCou¡
 == 1)

146 
CheckZîoByã
 = 1;

147 
p_Vid
->
La°Ac˚ssUnôExi°s
 = 1;

148 if(
CheckZîoByã
 && 
«lu
->
°¨tcodïªfix_Àn
==3)

150 
	`¥ötf
("warning: zero_byte shallÉxist\n");

153 
	}
}

155 #i‡(
MVC_EXTENSION_ENABLE
)

156 
	$«l_unô_hódî_mvc_exãnsi⁄
(
NALUnôHódîMVCExt_t
 *
NÆuHódîMVCExt
, 
Bô°ªam
 *
s
)

159 
NÆuHódîMVCExt
->
n⁄_idr_Êag
 = 
	`ªad_u_v
 (1, "n⁄_idr_Êag", 
s
, &
p_Dec
->
U£dBôs
);

160 
NÆuHódîMVCExt
->
¥i‹ôy_id
 = 
	`ªad_u_v
 (6, "¥i‹ôy_id", 
s
, &
p_Dec
->
U£dBôs
);

161 
NÆuHódîMVCExt
->
võw_id
 = 
	`ªad_u_v
 (10, "võw_id", 
s
, &
p_Dec
->
U£dBôs
);

162 
NÆuHódîMVCExt
->
ãmp‹Æ_id
 = 
	`ªad_u_v
 (3, "ãmp‹Æ_id", 
s
, &
p_Dec
->
U£dBôs
);

163 
NÆuHódîMVCExt
->
™ch‹_pic_Êag
 = 
	`ªad_u_v
 (1, "™ch‹_pic_Êag", 
s
, &
p_Dec
->
U£dBôs
);

164 
NÆuHódîMVCExt
->
öãr_võw_Êag
 = 
	`ªad_u_v
 (1, "öãr_võw_Êag", 
s
, &
p_Dec
->
U£dBôs
);

165 
NÆuHódîMVCExt
->
ª£rved_⁄e_bô
 = 
	`ªad_u_v
 (1, "ª£rved_⁄e_bô", 
s
, &
p_Dec
->
U£dBôs
);

166 if(
NÆuHódîMVCExt
->
ª£rved_⁄e_bô
 != 1)

168 
	`¥ötf
("Nalu Header MVC Extension:Ñeserved_one_bit isÇot 1!\n");

170 
	}
}

172 
	$«l_unô_hódî_svc_exãnsi⁄
( )

175 
	}
}

177 
	$¥efix_«l_unô_svc
( )

180 
	}
}

	@ldecod/src/output.c

15 
	~"c⁄åibut‹s.h
"

17 
	~"globÆ.h
"

18 
	~"mbuf„r.h
"

19 
	~"image.h
"

20 
	~"memÆloc.h
"

21 
	~"£i.h
"

22 
	~"öput.h
"

23 
	~"Á°_mem‹y.h
"

25 
wrôe_out_pi˘uª
(
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
p
, 
p_out
);

26 
img2buf_byã
 (
img≥l
** 
imgX
, * 
buf
, 
size_x
, 
size_y
, 
symbﬁ_size_ö_byãs
, 
¸›_À·
, 
¸›_right
, 
¸›_t›
, 
¸›_bŸtom
, 
iOutSåide
);

27 
img2buf_n‹mÆ
 (
img≥l
** 
imgX
, * 
buf
, 
size_x
, 
size_y
, 
symbﬁ_size_ö_byãs
, 
¸›_À·
, 
¸›_right
, 
¸›_t›
, 
¸›_bŸtom
, 
iOutSåide
);

28 
img2buf_ídün
 (
img≥l
** 
imgX
, * 
buf
, 
size_x
, 
size_y
, 
symbﬁ_size_ö_byãs
, 
¸›_À·
, 
¸›_right
, 
¸›_t›
, 
¸›_bŸtom
, 
iOutSåide
);

39 
	$öô_ouçut
(
CodögP¨amëîs
 *
p_˝s
, 
symbﬁ_size_ö_byãs
)

41 i‡(–(Ë= (
img≥l
)))

43 i‡–(Ë=
symbﬁ_size_ö_byãs
)

44 
p_˝s
->
img2buf
 = 
img2buf_byã
;

46 
p_˝s
->
img2buf
 = 
img2buf_n‹mÆ
;

50 i‡(
	`ã°Endün
())

51 
p_˝s
->
img2buf
 = 
img2buf_ídün
;

53 
p_˝s
->
img2buf
 = 
img2buf_n‹mÆ
;

55 
	}
}

81 
	$img2buf_n‹mÆ
 (
img≥l
** 
imgX
, * 
buf
, 
size_x
, 
size_y
, 
symbﬁ_size_ö_byãs
, 
¸›_À·
, 
¸›_right
, 
¸›_t›
, 
¸›_bŸtom
, 
iOutSåide
)

83 
i
,
j
;

85 
twidth
 = 
size_x
 - 
¸›_À·
 - 
¸›_right
;

86 
theight
 = 
size_y
 - 
¸›_t›
 - 
¸›_bŸtom
;

88 
size
 = 0;

92 i‡( (
img≥l
Ë< 
symbﬁ_size_ö_byãs
)

95 
size
 =  (
img≥l
);

97 
j
=0; j<
theight
; j++)

98 
	`mem£t
 (
buf
+
j
*
iOutSåide
, 0, (
twidth
 * 
symbﬁ_size_ö_byãs
));

102 
size
 = 
symbﬁ_size_ö_byãs
;

105 i‡((
¸›_t›
 || 
¸›_bŸtom
 || 
¸›_À·
 || 
¸›_right
Ë|| (
size
 != 1))

107 
i
=
¸›_t›
; i<
size_y
-
¸›_bŸtom
; i++)

109 
ùos
 = (
i
 - 
¸›_t›
Ë* 
iOutSåide
;

110 
j
=
¸›_À·
; j<
size_x
-
¸›_right
; j++)

112 
	`mem˝y
(
buf
+(
ùos
+(
j
-
¸›_À·
)*
symbﬁ_size_ö_byãs
),&(
imgX
[
i
][j]), 
size
);

118 #i‡(
IMGTYPE
 == 0)

122 
j
=0; j<
size_y
; j++)

123 
	`mem˝y
(
buf
+
j
*
iOutSåide
, 
imgX
[j], 
size_x
*(
img≥l
));

128 
img≥l
 *
cur_pixñ
;

129 *
pD°
;

130 
j
 = 0; j < 
size_y
; j++)

132 
cur_pixñ
 = 
imgX
[
j
];

133 
pD°
 = 
buf
 +
j
*
iOutSåide
;

134 
i
=0; i < 
size_x
; i++)

135 *(
pD°
++)=()*(
cur_pixñ
++);

140 
	}
}

166 
	$img2buf_byã
 (
img≥l
** 
imgX
, * 
buf
, 
size_x
, 
size_y
, 
symbﬁ_size_ö_byãs
, 
¸›_À·
, 
¸›_right
, 
¸›_t›
, 
¸›_bŸtom
, 
iOutSåide
)

168 
twidth
 = 
size_x
 - 
¸›_À·
 - 
¸›_right
;

169 
theight
 = 
size_y
 - 
¸›_t›
 - 
¸›_bŸtom
;

170 
img≥l
 **
img
 = &
imgX
[
¸›_t›
];

171 
i
;

172 
i
 = 0; i < 
theight
; i++)

174 
	`mem˝y
(
buf
, *
img
++ + 
¸›_À·
, 
twidth
);

175 
buf
 +
iOutSåide
;

177 
	}
}

203 
	$img2buf_ídün
 (
img≥l
** 
imgX
, * 
buf
, 
size_x
, 
size_y
, 
symbﬁ_size_ö_byãs
, 
¸›_À·
, 
¸›_right
, 
¸›_t›
, 
¸›_bŸtom
, 
iOutSåide
)

205 
i
,
j
;

206 
ui8
;

207 
uöt16
 
tmp16
, 
ui16
;

208 
tmp32
, 
ui32
;

213 
symbﬁ_size_ö_byãs
)

217 
i
=
¸›_t›
;i<
size_y
-
¸›_bŸtom
;i++)

218 
j
=
¸›_À·
;j<
size_x
-
¸›_right
;j++)

220 
ui8
 = (Ë(
imgX
[
i
][
j
]);

221 
buf
[(
j
-
¸›_À·
+((
i
-
¸›_t›
)*
iOutSåide
))] = 
ui8
;

227 
i
=
¸›_t›
;i<
size_y
-
¸›_bŸtom
;i++)

228 
j
=
¸›_À·
;j<
size_x
-
¸›_right
;j++)

230 
tmp16
 = (
uöt16
Ë(
imgX
[
i
][
j
]);

231 
ui16
 = (
uöt16
Ë((
tmp16
 >> 8) | ((tmp16&0xFF)<<8));

232 
	`mem˝y
(
buf
+((
j
-
¸›_À·
+((
i
-
¸›_t›
)*
iOutSåide
))*2),&(
ui16
), 2);

238 
i
=
¸›_t›
;i<
size_y
-
¸›_bŸtom
;i++)

239 
j
=
¸›_À·
;j<
size_x
-
¸›_right
;j++)

241 
tmp32
 = (Ë(
imgX
[
i
][
j
]);

242 
ui32
 = (Ë(((
tmp32
&0xFF00)<<8) | ((tmp32&0xFF)<<24) | ((tmp32&0xFF0000)>>8) | ((tmp32&0xFF000000)>>24));

243 
	`mem˝y
(
buf
+((
j
-
¸›_À·
+((
i
-
¸›_t›
)*
iOutSåide
))*4),&(
ui32
), 4);

249 
	`îr‹
 ("writing onlyÅo formats of 8, 16 or 32 bitállowed on bigÉndianárchitecture", 500);

253 
	}
}

256 #i‡(
PAIR_FIELDS_IN_OUTPUT
)

258 
˛ór_pi˘uª
(
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
p
);

268 
	$Êush_≥ndög_ouçut
(
VideoP¨amëîs
 *
p_Vid
, 
p_out
)

270 i‡(
p_Vid
->
≥ndög_ouçut_°©e
 !
FRAME
)

272 
	`wrôe_out_pi˘uª
(
p_Vid
,Ö_Vid->
≥ndög_ouçut
, 
p_out
);

275 i‡(
p_Vid
->
≥ndög_ouçut
->
imgY
)

277 
	`‰ì_mem2D≥l
 (
p_Vid
->
≥ndög_ouçut
->
imgY
);

278 
p_Vid
->
≥ndög_ouçut
->
imgY
=
NULL
;

280 i‡(
p_Vid
->
≥ndög_ouçut
->
imgUV
)

282 
	`‰ì_mem3D≥l
 (
p_Vid
->
≥ndög_ouçut
->
imgUV
);

283 
p_Vid
->
≥ndög_ouçut
->
imgUV
=
NULL
;

286 
p_Vid
->
≥ndög_ouçut_°©e
 = 
FRAME
;

287 
	}
}

302 
	$wrôe_pi˘uª
(
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
p
, 
p_out
, 
ªÆ_°ru˘uª
)

304 
i
, 
add
;

306 i‡(
ªÆ_°ru˘uª
==
FRAME
)

309 
	`Êush_≥ndög_ouçut
(
p_Vid
, 
p_out
);

310 
	`wrôe_out_pi˘uª
(
p_Vid
, 
p
, 
p_out
);

313 i‡(
ªÆ_°ru˘uª
 =
p_Vid
->
≥ndög_ouçut_°©e
)

315 
	`Êush_≥ndög_ouçut
(
p_Vid
, 
p_out
);

316 
	`wrôe_pi˘uª
(
p_Vid
, 
p
, 
p_out
, 
ªÆ_°ru˘uª
);

320 i‡(
p_Vid
->
≥ndög_ouçut_°©e
 =
FRAME
)

322 
p_Vid
->
≥ndög_ouçut
->
size_x
 = 
p
->size_x;

323 
p_Vid
->
≥ndög_ouçut
->
size_y
 = 
p
->size_y;

324 
p_Vid
->
≥ndög_ouçut
->
size_x_¸
 = 
p
->size_x_cr;

325 
p_Vid
->
≥ndög_ouçut
->
size_y_¸
 = 
p
->size_y_cr;

326 
p_Vid
->
≥ndög_ouçut
->
chroma_f‹m©_idc
 = 
p
->chroma_format_idc;

328 
p_Vid
->
≥ndög_ouçut
->
‰ame_mbs_⁄ly_Êag
 = 
p
->frame_mbs_only_flag;

329 
p_Vid
->
≥ndög_ouçut
->
‰ame_¸›pög_Êag
 = 
p
->frame_cropping_flag;

330 i‡(
p_Vid
->
≥ndög_ouçut
->
‰ame_¸›pög_Êag
)

332 
p_Vid
->
≥ndög_ouçut
->
‰ame_¸›_À·_off£t
 = 
p
->frame_crop_left_offset;

333 
p_Vid
->
≥ndög_ouçut
->
‰ame_¸›_right_off£t
 = 
p
->frame_crop_right_offset;

334 
p_Vid
->
≥ndög_ouçut
->
‰ame_¸›_t›_off£t
 = 
p
->frame_crop_top_offset;

335 
p_Vid
->
≥ndög_ouçut
->
‰ame_¸›_bŸtom_off£t
 = 
p
->frame_crop_bottom_offset;

338 
	`gë_mem2D≥l
 (&(
p_Vid
->
≥ndög_ouçut
->
imgY
),Ö_Vid->≥ndög_ouçut->
size_y
,Ö_Vid->≥ndög_ouçut->
size_x
);

339 
	`gë_mem3D≥l
 (&(
p_Vid
->
≥ndög_ouçut
->
imgUV
), 2,Ö_Vid->≥ndög_ouçut->
size_y_¸
,Ö_Vid->≥ndög_ouçut->
size_x_¸
);

341 
	`˛ór_pi˘uª
(
p_Vid
,Ö_Vid->
≥ndög_ouçut
);

344 i‡(
ªÆ_°ru˘uª
 =
TOP_FIELD
)

346 
add
 = 0;

350 
add
 = 1;

353 
i
=0; i<
p_Vid
->
≥ndög_ouçut
->
size_y
; i+=2)

355 
	`mem˝y
(
p_Vid
->
≥ndög_ouçut
->
imgY
[(
i
+
add
)], 
p
->imgY[(i+add)],Ö->
size_x
 * (
img≥l
));

357 
i
=0; i<
p_Vid
->
≥ndög_ouçut
->
size_y_¸
; i+=2)

359 
	`mem˝y
(
p_Vid
->
≥ndög_ouçut
->
imgUV
[0][(
i
+
add
)], 
p
->imgUV[0][(i+add)],Ö->
size_x_¸
 * (
img≥l
));

360 
	`mem˝y
(
p_Vid
->
≥ndög_ouçut
->
imgUV
[1][(
i
+
add
)], 
p
->imgUV[1][(i+add)],Ö->
size_x_¸
 * (
img≥l
));

362 
p_Vid
->
≥ndög_ouçut_°©e
 = 
ªÆ_°ru˘uª
;

366 i‡–(
p_Vid
->
≥ndög_ouçut
->
size_x
!=
p
->size_xË|| (p_Vid->≥ndög_ouçut->
size_y
!=Ö->size_y)

367 || (
p_Vid
->
≥ndög_ouçut
->
‰ame_mbs_⁄ly_Êag
 !
p
->frame_mbs_only_flag)

368 || (
p_Vid
->
≥ndög_ouçut
->
‰ame_¸›pög_Êag
 !
p
->frame_cropping_flag)

369 || ( 
p_Vid
->
≥ndög_ouçut
->
‰ame_¸›pög_Êag
 &&

370 –(
p_Vid
->
≥ndög_ouçut
->
‰ame_¸›_À·_off£t
 !
p
->frame_crop_left_offset)

371 ||(
p_Vid
->
≥ndög_ouçut
->
‰ame_¸›_right_off£t
 !
p
->frame_crop_right_offset)

372 ||(
p_Vid
->
≥ndög_ouçut
->
‰ame_¸›_t›_off£t
 !
p
->frame_crop_top_offset)

373 ||(
p_Vid
->
≥ndög_ouçut
->
‰ame_¸›_bŸtom_off£t
 !
p
->frame_crop_bottom_offset)

378 
	`Êush_≥ndög_ouçut
(
p_Vid
, 
p_out
);

379 
	`wrôe_pi˘uª
 (
p_Vid
, 
p
, 
p_out
, 
ªÆ_°ru˘uª
);

383 i‡(
ªÆ_°ru˘uª
 =
TOP_FIELD
)

385 
add
 = 0;

389 
add
 = 1;

392 
i
=0; i<
p_Vid
->
≥ndög_ouçut
->
size_y
; i+=2)

394 
	`mem˝y
(
p_Vid
->
≥ndög_ouçut
->
imgY
[(
i
+
add
)], 
p
->imgY[(i+add)],Ö->
size_x
 * (
img≥l
));

396 
i
=0; i<
p_Vid
->
≥ndög_ouçut
->
size_y_¸
; i+=2)

398 
	`mem˝y
(
p_Vid
->
≥ndög_ouçut
->
imgUV
[0][(
i
+
add
)], 
p
->imgUV[0][(i+add)],Ö->
size_x_¸
 * (
img≥l
));

399 
	`mem˝y
(
p_Vid
->
≥ndög_ouçut
->
imgUV
[1][(
i
+
add
)], 
p
->imgUV[1][(i+add)],Ö->
size_x_¸
 * (
img≥l
));

402 
	`Êush_≥ndög_ouçut
(
p_Vid
, 
p_out
);

404 
	}
}

423 
	$wrôe_pi˘uª
(
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
p
, 
p_out
, 
ªÆ_°ru˘uª
)

425 
	`wrôe_out_pi˘uª
(
p_Vid
, 
p
, 
p_out
);

426 
	}
}

431 
	$Æloˇã_p_dec_pic
(
VideoP¨amëîs
 *
p_Vid
, 
DecodedPicLi°
 *
pDecPic
, 
St‹abÀPi˘uª
 *
p
, 
iLumaSize
, 
iFømeSize
, 
iLumaSizeX
, 
iLumaSizeY
, 
iChromaSizeX
, 
iChromaSizeY
)

433 
symbﬁ_size_ö_byãs
 = ((
p_Vid
->
pic_unô_bôsize_⁄_disk
+7) >> 3);

435 if(
pDecPic
->
pY
)

436 
	`mem_‰ì
(
pDecPic
->
pY
);

437 
pDecPic
->
iBufSize
 = 
iFømeSize
;

438 
pDecPic
->
pY
 = 
	`mem_mÆloc
’DecPic->
iBufSize
);

439 
pDecPic
->
pU
 =ÖDecPic->
pY
+
iLumaSize
;

440 
pDecPic
->
pV
 =ÖDecPic->
pU
 + ((
iFømeSize
-
iLumaSize
)>>1);

442 
pDecPic
->
iYUVF‹m©
 = 
p
->
chroma_f‹m©_idc
;

443 
pDecPic
->
iYUVSt‹ageF‹m©
 = 0;

444 
pDecPic
->
iBôDïth
 = 
p_Vid
->
pic_unô_bôsize_⁄_disk
;

445 
pDecPic
->
iWidth
 = 
iLumaSizeX
;

446 
pDecPic
->
iHeight
 = 
iLumaSizeY
;

447 
pDecPic
->
iYBufSåide
 = 
iLumaSizeX
*
symbﬁ_size_ö_byãs
;

448 
pDecPic
->
iUVBufSåide
 = 
iChromaSizeX
*
symbﬁ_size_ö_byãs
;

449 
	}
}

464 
	$wrôe_out_pi˘uª
(
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
p
, 
p_out
)

466 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

467 
DecodedPicLi°
 *
pDecPic
;

469 c⁄° 
SubWidthC
 [4]= { 1, 2, 2, 1};

470 c⁄° 
SubHeightC
 [4]= { 1, 2, 1, 1};

472 
¸›_À·
, 
¸›_right
, 
¸›_t›
, 
¸›_bŸtom
;

473 
symbﬁ_size_ö_byãs
 = ((
p_Vid
->
pic_unô_bôsize_⁄_disk
+7) >> 3);

474 
rgb_ouçut
 = 
p_Vid
->
p_EncodeP¨
[
p
->
œyî_id
]->rgb_output;

475 *
buf
;

477 
iLumaSize
, 
iFømeSize
;

478 
iLumaSizeX
, 
iLumaSizeY
;

479 
iChromaSizeX
, 
iChromaSizeY
;

481 
ªt
;

483 i‡(
p
->
n⁄_exi°ög
)

486 #i‡(
ENABLE_OUTPUT_TONEMAPPING
)

488 i‡(
p
->
£iHasT⁄e_m≠pög
 && 
rgb_ouçut
)

491 
symbﬁ_size_ö_byãs
 = (
p
->
t⁄em≠≥d_bô_dïth
>8)? 2 : 1;

492 
	`t⁄e_m≠
(
p
->
imgY
,Ö->
t⁄e_m≠pög_lut
,Ö->
size_x
,Ö->
size_y
);

493 
	`t⁄e_m≠
(
p
->
imgUV
[0],Ö->
t⁄e_m≠pög_lut
,Ö->
size_x_¸
,Ö->
size_y_¸
);

494 
	`t⁄e_m≠
(
p
->
imgUV
[1],Ö->
t⁄e_m≠pög_lut
,Ö->
size_x_¸
,Ö->
size_y_¸
);

499 i‡(
p
->
‰ame_¸›pög_Êag
)

501 
¸›_À·
 = 
SubWidthC
 [
p
->
chroma_f‹m©_idc
] *Ö->
‰ame_¸›_À·_off£t
;

502 
¸›_right
 = 
SubWidthC
 [
p
->
chroma_f‹m©_idc
] *Ö->
‰ame_¸›_right_off£t
;

503 
¸›_t›
 = 
SubHeightC
[
p
->
chroma_f‹m©_idc
] * ( 2 -Ö->
‰ame_mbs_⁄ly_Êag
 ) *Ö->
‰ame_¸›_t›_off£t
;

504 
¸›_bŸtom
 = 
SubHeightC
[
p
->
chroma_f‹m©_idc
] * ( 2 -Ö->
‰ame_mbs_⁄ly_Êag
 ) *Ö->
‰ame_¸›_bŸtom_off£t
;

508 
¸›_À·
 = 
¸›_right
 = 
¸›_t›
 = 
¸›_bŸtom
 = 0;

510 
iChromaSizeX
 = 
p
->
size_x_¸
-Ö->
‰ame_¸›_À·_off£t
 -p->
‰ame_¸›_right_off£t
;

511 
iChromaSizeY
 = 
p
->
size_y_¸
 - ( 2 -Ö->
‰ame_mbs_⁄ly_Êag
 ) *Ö->
‰ame_¸›_t›_off£t
 -–2 -Ö->‰ame_mbs_⁄ly_Êag ) *Ö->
‰ame_¸›_bŸtom_off£t
;

512 
iLumaSizeX
 = 
p
->
size_x
 - 
¸›_À·
-
¸›_right
;

513 
iLumaSizeY
 = 
p
->
size_y
 - 
¸›_t›
 - 
¸›_bŸtom
;

514 
iLumaSize
 = 
iLumaSizeX
 * 
iLumaSizeY
 * 
symbﬁ_size_ö_byãs
;

515 
iFømeSize
 = (
iLumaSizeX
 * 
iLumaSizeY
 + 2 * (
iChromaSizeX
 * 
iChromaSizeY
)Ë* 
symbﬁ_size_ö_byãs
;

520 i‡(
p_out
 == -1)

526 
pDecPic
 = 
	`gë_⁄e_avaû_dec_pic_‰om_li°
(
p_Vid
->
pDecOuputPic
, 0, 0);

527 if–(
pDecPic
->
pY
 =
NULL
)

528 || (
pDecPic
->
iBufSize
 < 
iFømeSize
)

530 
	`Æloˇã_p_dec_pic
(
p_Vid
, 
pDecPic
, 
p
, 
iLumaSize
, 
iFømeSize
, 
iLumaSizeX
, 
iLumaSizeY
, 
iChromaSizeX
, 
iChromaSizeY
);

531 #i‡(
MVC_EXTENSION_ENABLE
)

533 
pDecPic
->
bVÆid
 = 1;

534 
pDecPic
->
iVõwId
 = 
p
->
võw_id
 >=0 ?Ö->view_id : -1;

537 
pDecPic
->
bVÆid
 = 1;

540 
pDecPic
->
iPOC
 = 
p
->
‰ame_poc
;

542 i‡(
NULL
==
pDecPic
->
pY
)

544 
	`no_mem_exô
("write_out_picture: buf");

548 if(
rgb_ouçut
)

550 
buf
 = 
	`mÆloc
 (
p
->
size_x
 *Ö->
size_y
 * 
symbﬁ_size_ö_byãs
);

551 
¸›_À·
 = 
p
->
‰ame_¸›_À·_off£t
;

552 
¸›_right
 = 
p
->
‰ame_¸›_right_off£t
;

553 
¸›_t›
 = ( 2 - 
p
->
‰ame_mbs_⁄ly_Êag
 ) *Ö->
‰ame_¸›_t›_off£t
;

554 
¸›_bŸtom
 = ( 2 - 
p
->
‰ame_mbs_⁄ly_Êag
 ) *Ö->
‰ame_¸›_bŸtom_off£t
;

556 
p_Vid
->
	`img2buf
 (
p
->
imgUV
[1], 
buf
,Ö->
size_x_¸
,Ö->
size_y_¸
, 
symbﬁ_size_ö_byãs
, 
¸›_À·
, 
¸›_right
, 
¸›_t›
, 
¸›_bŸtom
, 
pDecPic
->
iYBufSåide
);

557 i‡(
p_out
 >= 0)

559 
ªt
 = 
	`wrôe
(
p_out
, 
buf
, (
p
->
size_y_¸
-
¸›_bŸtom
-
¸›_t›
)*’->
size_x_¸
-
¸›_right
-
¸›_À·
)*
symbﬁ_size_ö_byãs
);

560 i‡(
ªt
 !((
p
->
size_y_¸
-
¸›_bŸtom
-
¸›_t›
)*’->
size_x_¸
-
¸›_right
-
¸›_À·
)*
symbﬁ_size_ö_byãs
))

562 
	`îr‹
 ("write_out_picture:Érror writingÅo RGB file", 500);

566 i‡(
p
->
‰ame_¸›pög_Êag
)

568 
¸›_À·
 = 
SubWidthC
[
p
->
chroma_f‹m©_idc
] *Ö->
‰ame_¸›_À·_off£t
;

569 
¸›_right
 = 
SubWidthC
[
p
->
chroma_f‹m©_idc
] *Ö->
‰ame_¸›_right_off£t
;

570 
¸›_t›
 = 
SubHeightC
[
p
->
chroma_f‹m©_idc
]*–2 -Ö->
‰ame_mbs_⁄ly_Êag
 ) *Ö->
‰ame_¸›_t›_off£t
;

571 
¸›_bŸtom
 = 
SubHeightC
[
p
->
chroma_f‹m©_idc
]*–2 -Ö->
‰ame_mbs_⁄ly_Êag
 ) *Ö->
‰ame_¸›_bŸtom_off£t
;

575 
¸›_À·
 = 
¸›_right
 = 
¸›_t›
 = 
¸›_bŸtom
 = 0;

577 if(
buf
)

578 
	`‰ì
(
buf
);

581 
buf
 = (
pDecPic
->
bVÆid
==1)?ÖDecPic->
pY
:ÖDecPic->pY+
iLumaSizeX
*
symbﬁ_size_ö_byãs
;

583 
p_Vid
->
	`img2buf
 (
p
->
imgY
, 
buf
,Ö->
size_x
,Ö->
size_y
, 
symbﬁ_size_ö_byãs
, 
¸›_À·
, 
¸›_right
, 
¸›_t›
, 
¸›_bŸtom
, 
pDecPic
->
iYBufSåide
);

584 if(
p_out
 >=0)

586 
ªt
 = 
	`wrôe
(
p_out
, 
buf
, (
p
->
size_y
-
¸›_bŸtom
-
¸›_t›
)*’->
size_x
-
¸›_right
-
¸›_À·
)*
symbﬁ_size_ö_byãs
);

587 i‡(
ªt
 !((
p
->
size_y
-
¸›_bŸtom
-
¸›_t›
)*’->
size_x
-
¸›_right
-
¸›_À·
)*
symbﬁ_size_ö_byãs
))

589 
	`îr‹
 ("write_out_picture:Érror writingÅo YUV file", 500);

593 i‡(
p
->
chroma_f‹m©_idc
!=
YUV400
)

595 
¸›_À·
 = 
p
->
‰ame_¸›_À·_off£t
;

596 
¸›_right
 = 
p
->
‰ame_¸›_right_off£t
;

597 
¸›_t›
 = ( 2 - 
p
->
‰ame_mbs_⁄ly_Êag
 ) *Ö->
‰ame_¸›_t›_off£t
;

598 
¸›_bŸtom
 = ( 2 - 
p
->
‰ame_mbs_⁄ly_Êag
 ) *Ö->
‰ame_¸›_bŸtom_off£t
;

599 
buf
 = (
pDecPic
->
bVÆid
==1)?ÖDecPic->
pU
 :ÖDecPic->pU + 
iChromaSizeX
*
symbﬁ_size_ö_byãs
;

600 
p_Vid
->
	`img2buf
 (
p
->
imgUV
[0], 
buf
,Ö->
size_x_¸
,Ö->
size_y_¸
, 
symbﬁ_size_ö_byãs
, 
¸›_À·
, 
¸›_right
, 
¸›_t›
, 
¸›_bŸtom
, 
pDecPic
->
iUVBufSåide
);

601 if(
p_out
 >= 0)

603 
ªt
 = 
	`wrôe
(
p_out
, 
buf
, (
p
->
size_y_¸
-
¸›_bŸtom
-
¸›_t›
)*’->
size_x_¸
-
¸›_right
-
¸›_À·
)* 
symbﬁ_size_ö_byãs
);

604 i‡(
ªt
 !((
p
->
size_y_¸
-
¸›_bŸtom
-
¸›_t›
)*’->
size_x_¸
-
¸›_right
-
¸›_À·
)* 
symbﬁ_size_ö_byãs
))

606 
	`îr‹
 ("write_out_picture:Érror writingÅo YUV file", 500);

610 i‡(!
rgb_ouçut
)

612 
buf
 = (
pDecPic
->
bVÆid
==1)?ÖDecPic->
pV
 :ÖDecPic->pV + 
iChromaSizeX
*
symbﬁ_size_ö_byãs
;

613 
p_Vid
->
	`img2buf
 (
p
->
imgUV
[1], 
buf
,Ö->
size_x_¸
,Ö->
size_y_¸
, 
symbﬁ_size_ö_byãs
, 
¸›_À·
, 
¸›_right
, 
¸›_t›
, 
¸›_bŸtom
, 
pDecPic
->
iUVBufSåide
);

615 if(
p_out
 >= 0)

617 
ªt
 = 
	`wrôe
(
p_out
, 
buf
, (
p
->
size_y_¸
-
¸›_bŸtom
-
¸›_t›
)*’->
size_x_¸
-
¸›_right
-
¸›_À·
)*
symbﬁ_size_ö_byãs
);

618 i‡(
ªt
 !((
p
->
size_y_¸
-
¸›_bŸtom
-
¸›_t›
)*’->
size_x_¸
-
¸›_right
-
¸›_À·
)*
symbﬁ_size_ö_byãs
))

620 
	`îr‹
 ("write_out_picture:Érror writingÅo YUV file", 500);

627 i‡(
p_I≈
->
wrôe_uv
)

629 
i
,
j
;

630 
img≥l
 
¸_vÆ
 = (img≥lË(1<<(
p_Vid
->
bôdïth_luma
 - 1));

632 
	`gë_mem3D≥l
 (&(
p
->
imgUV
), 1,Ö->
size_y
/2,Ö->
size_x
/2);

634 
j
=0; j<
p
->
size_y
/2; j++)

636 
i
=0; i<
p
->
size_x
/2; i++)

638 
p
->
imgUV
[0][
j
][
i
]=
¸_vÆ
;

643 
buf
 = 
	`mÆloc
 (
p
->
size_x
*p->
size_y
*
symbﬁ_size_ö_byãs
);

644 
p_Vid
->
	`img2buf
 (
p
->
imgUV
[0], 
buf
,Ö->
size_x
/2,Ö->
size_y
/2, 
symbﬁ_size_ö_byãs
, 
¸›_À·
/2, 
¸›_right
/2, 
¸›_t›
/2, 
¸›_bŸtom
/2, 
pDecPic
->
iYBufSåide
/2);

646 
ªt
 = 
	`wrôe
(
p_out
, 
buf
, 
symbﬁ_size_ö_byãs
 * (
p
->
size_y
-
¸›_bŸtom
-
¸›_t›
)/2 * (p->
size_x
-
¸›_right
-
¸›_À·
)/2 );

647 i‡(
ªt
 !(
symbﬁ_size_ö_byãs
 * (
p
->
size_y
-
¸›_bŸtom
-
¸›_t›
)/2 * (p->
size_x
-
¸›_right
-
¸›_À·
)/2))

649 
	`îr‹
 ("write_out_picture:Érror writingÅo YUV file", 500);

651 
ªt
 = 
	`wrôe
(
p_out
, 
buf
, 
symbﬁ_size_ö_byãs
 * (
p
->
size_y
-
¸›_bŸtom
-
¸›_t›
)/2 * (p->
size_x
-
¸›_right
-
¸›_À·
)/2 );

652 i‡(
ªt
 !(
symbﬁ_size_ö_byãs
 * (
p
->
size_y
-
¸›_bŸtom
-
¸›_t›
)/2 * (p->
size_x
-
¸›_right
-
¸›_À·
)/2))

654 
	`îr‹
 ("write_out_picture:Érror writingÅo YUV file", 500);

656 
	`‰ì
(
buf
);

657 
	`‰ì_mem3D≥l
(
p
->
imgUV
);

658 
p
->
imgUV
=
NULL
;

663 if(
p_out
 >=0)

664 
pDecPic
->
bVÆid
 = 0;

667 
	}
}

675 
	$öô_out_buf„r
(
VideoP¨amëîs
 *
p_Vid
)

677 
p_Vid
->
out_buf„r
 = 
	`Æloc_‰ame_°‹e
();

679 #i‡(
PAIR_FIELDS_IN_OUTPUT
)

680 
p_Vid
->
≥ndög_ouçut
 = 
	`ˇŒoc
 ((
St‹abÀPi˘uª
), 1);

681 i‡(
NULL
==
p_Vid
->
≥ndög_ouçut
Ë
	`no_mem_exô
("init_out_buffer");

682 
p_Vid
->
≥ndög_ouçut
->
imgUV
 = 
NULL
;

683 
p_Vid
->
≥ndög_ouçut
->
imgY
 = 
NULL
;

685 
	}
}

693 
	$unöô_out_buf„r
(
VideoP¨amëîs
 *
p_Vid
)

695 
	`‰ì_‰ame_°‹e
(
p_Vid
->
out_buf„r
);

696 
p_Vid
->
out_buf„r
=
NULL
;

697 #i‡(
PAIR_FIELDS_IN_OUTPUT
)

698 
	`Êush_≥ndög_ouçut
(
p_Vid
,Ö_Vid->
p_out
);

699 
	`‰ì
 (
p_Vid
->
≥ndög_ouçut
);

701 
	}
}

709 
	$˛ór_pi˘uª
(
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
p
)

711 
i
,
j
;

713 
i
=0;i<
p
->
size_y
;i++)

715 
j
=0; j<
p
->
size_x
; j++)

716 
p
->
imgY
[
i
][
j
] = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[0];

718 
i
=0;i<
p
->
size_y_¸
;i++)

720 
j
=0; j<
p
->
size_x_¸
; j++)

721 
p
->
imgUV
[0][
i
][
j
] = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[1];

723 
i
=0;i<
p
->
size_y_¸
;i++)

725 
j
=0; j<
p
->
size_x_¸
; j++)

726 
p
->
imgUV
[1][
i
][
j
] = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[2];

728 
	}
}

744 
	$wrôe_u≈aúed_fõld
(
VideoP¨amëîs
 *
p_Vid
, 
FømeSt‹e
* 
fs
, 
p_out
)

746 
St‹abÀPi˘uª
 *
p
;

747 
	`as£π
 (
fs
->
is_u£d
<3);

749 if(
fs
->
is_u£d
 & 0x01)

753 
p
 = 
fs
->
t›_fõld
;

754 
fs
->
bŸtom_fõld
 = 
	`Æloc_°‹abÀ_pi˘uª
(
p_Vid
, 
BOTTOM_FIELD
, 
p
->
size_x
, 2*p->
size_y
,Ö->
size_x_¸
, 2*p->
size_y_¸
, 1);

755 
fs
->
bŸtom_fõld
->
chroma_f‹m©_idc
 = 
p
->chroma_format_idc;

756 
	`˛ór_pi˘uª
(
p_Vid
, 
fs
->
bŸtom_fõld
);

757 
	`dpb_comböe_fõld_yuv
(
p_Vid
, 
fs
);

758 #i‡(
MVC_EXTENSION_ENABLE
)

759 
fs
->
‰ame
->
võw_id
 = fs->view_id;

761 
	`wrôe_pi˘uª
 (
p_Vid
, 
fs
->
‰ame
, 
p_out
, 
TOP_FIELD
);

764 if(
fs
->
is_u£d
 & 0x02)

768 
p
 = 
fs
->
bŸtom_fõld
;

769 
fs
->
t›_fõld
 = 
	`Æloc_°‹abÀ_pi˘uª
(
p_Vid
, 
TOP_FIELD
, 
p
->
size_x
, 2*p->
size_y
,Ö->
size_x_¸
, 2*p->
size_y_¸
, 1);

770 
fs
->
t›_fõld
->
chroma_f‹m©_idc
 = 
p
->chroma_format_idc;

771 
	`˛ór_pi˘uª
(
p_Vid
, 
fs
->
t›_fõld
);

772 
fs
 ->
t›_fõld
->
‰ame_¸›pög_Êag
 = fs->
bŸtom_fõld
->frame_cropping_flag;

773 if(
fs
 ->
t›_fõld
->
‰ame_¸›pög_Êag
)

775 
fs
 ->
t›_fõld
->
‰ame_¸›_t›_off£t
 = fs->
bŸtom_fõld
->frame_crop_top_offset;

776 
fs
 ->
t›_fõld
->
‰ame_¸›_bŸtom_off£t
 = fs->
bŸtom_fõld
->frame_crop_bottom_offset;

777 
fs
 ->
t›_fõld
->
‰ame_¸›_À·_off£t
 = fs->
bŸtom_fõld
->frame_crop_left_offset;

778 
fs
 ->
t›_fõld
->
‰ame_¸›_right_off£t
 = fs->
bŸtom_fõld
->frame_crop_right_offset;

780 
	`dpb_comböe_fõld_yuv
(
p_Vid
, 
fs
);

781 #i‡(
MVC_EXTENSION_ENABLE
)

782 
fs
->
‰ame
->
võw_id
 = fs->view_id;

784 
	`wrôe_pi˘uª
 (
p_Vid
, 
fs
->
‰ame
, 
p_out
, 
BOTTOM_FIELD
);

787 
fs
->
is_u£d
 = 3;

788 
	}
}

801 
	$Êush_dúe˘_ouçut
(
VideoP¨amëîs
 *
p_Vid
, 
p_out
)

803 
	`wrôe_u≈aúed_fõld
(
p_Vid
,Ö_Vid->
out_buf„r
, 
p_out
);

805 
	`‰ì_°‹abÀ_pi˘uª
(
p_Vid
->
out_buf„r
->
‰ame
);

806 
p_Vid
->
out_buf„r
->
‰ame
 = 
NULL
;

807 
	`‰ì_°‹abÀ_pi˘uª
(
p_Vid
->
out_buf„r
->
t›_fõld
);

808 
p_Vid
->
out_buf„r
->
t›_fõld
 = 
NULL
;

809 
	`‰ì_°‹abÀ_pi˘uª
(
p_Vid
->
out_buf„r
->
bŸtom_fõld
);

810 
p_Vid
->
out_buf„r
->
bŸtom_fõld
 = 
NULL
;

811 
p_Vid
->
out_buf„r
->
is_u£d
 = 0;

812 
	}
}

828 
	$wrôe_°‹ed_‰ame
–
VideoP¨amëîs
 *
p_Vid
, 
FømeSt‹e
 *
fs
, 
p_out
)

831 
	`Êush_dúe˘_ouçut
(
p_Vid
, 
p_out
);

833 i‡(
fs
->
is_u£d
<3)

835 
	`wrôe_u≈aúed_fõld
(
p_Vid
, 
fs
, 
p_out
);

839 i‡(
fs
->
ªcovîy_‰ame
)

840 
p_Vid
->
ªcovîy_Êag
 = 1;

841 i‡((!
p_Vid
->
n⁄_c⁄f‹mög_°ªam
Ë||Ö_Vid->
ªcovîy_Êag
)

842 
	`wrôe_pi˘uª
(
p_Vid
, 
fs
->
‰ame
, 
p_out
, 
FRAME
);

845 
fs
->
is_ouçut
 = 1;

846 
	}
}

862 
	$dúe˘_ouçut
(
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
p
, 
p_out
)

864 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

865 i‡(
p
->
°ru˘uª
==
FRAME
)

869 
	`Êush_dúe˘_ouçut
(
p_Vid
, 
p_out
);

870 
	`wrôe_pi˘uª
 (
p_Vid
, 
p
, 
p_out
, 
FRAME
);

871 
	`ˇlcuœã_‰ame_no
(
p_Vid
, 
p
);

872 i‡(-1 !
p_Vid
->
p_ªf
 && !
p_I≈
->
sûít
)

873 
	`föd_¢r
(
p_Vid
, 
p
, &p_Vid->
p_ªf
);

874 
	`‰ì_°‹abÀ_pi˘uª
(
p
);

878 i‡(
p
->
°ru˘uª
 =
TOP_FIELD
)

880 i‡(
p_Vid
->
out_buf„r
->
is_u£d
 &1)

881 
	`Êush_dúe˘_ouçut
(
p_Vid
, 
p_out
);

882 
p_Vid
->
out_buf„r
->
t›_fõld
 = 
p
;

883 
p_Vid
->
out_buf„r
->
is_u£d
 |= 1;

886 i‡(
p
->
°ru˘uª
 =
BOTTOM_FIELD
)

888 i‡(
p_Vid
->
out_buf„r
->
is_u£d
 &2)

889 
	`Êush_dúe˘_ouçut
(
p_Vid
, 
p_out
);

890 
p_Vid
->
out_buf„r
->
bŸtom_fõld
 = 
p
;

891 
p_Vid
->
out_buf„r
->
is_u£d
 |= 2;

894 i‡(
p_Vid
->
out_buf„r
->
is_u£d
 == 3)

897 
	`dpb_comböe_fõld_yuv
(
p_Vid
,Ö_Vid->
out_buf„r
);

898 #i‡(
MVC_EXTENSION_ENABLE
)

899 
p_Vid
->
out_buf„r
->
‰ame
->
võw_id
 =Ö_Vid->out_buffer->view_id;

901 
	`wrôe_pi˘uª
 (
p_Vid
,Ö_Vid->
out_buf„r
->
‰ame
, 
p_out
, 
FRAME
);

903 
	`ˇlcuœã_‰ame_no
(
p_Vid
, 
p
);

904 i‡(-1 !
p_Vid
->
p_ªf
 && !
p_I≈
->
sûít
)

905 
	`föd_¢r
(
p_Vid
,Ö_Vid->
out_buf„r
->
‰ame
, &p_Vid->
p_ªf
);

906 
	`‰ì_°‹abÀ_pi˘uª
(
p_Vid
->
out_buf„r
->
‰ame
);

907 
p_Vid
->
out_buf„r
->
‰ame
 = 
NULL
;

908 
	`‰ì_°‹abÀ_pi˘uª
(
p_Vid
->
out_buf„r
->
t›_fõld
);

909 
p_Vid
->
out_buf„r
->
t›_fõld
 = 
NULL
;

910 
	`‰ì_°‹abÀ_pi˘uª
(
p_Vid
->
out_buf„r
->
bŸtom_fõld
);

911 
p_Vid
->
out_buf„r
->
bŸtom_fõld
 = 
NULL
;

912 
p_Vid
->
out_buf„r
->
is_u£d
 = 0;

914 
	}
}

	@ldecod/src/parset.c

15 
	~"globÆ.h
"

16 
	~"image.h
"

17 
	~"∑r£tcomm⁄.h
"

18 
	~"∑r£t.h
"

19 
	~"«lu.h
"

20 
	~"memÆloc.h
"

21 
	~"fmo.h
"

22 
	~"ˇbac.h
"

23 
	~"vlc.h
"

24 
	~"mbuf„r.h
"

25 
	~"îc_≠i.h
"

27 #i‡
TRACE


28 
	#SYMTRACESTRING
(
s
Ë
	`°∫˝y
(
sym
->
åa˚°rög
,s,
TRACESTRING_SIZE
)

	)

30 
	#SYMTRACESTRING
(
s
)

32 

	)

33 
öô_‰ext
(
VideoP¨amëîs
 *
p_Vid
);

36 
	$Sˇlög_Li°
(*
sˇlögLi°
, 
sizeOfSˇlögLi°
, 
Boﬁón
 *
U£DeÁu…SˇlögM©rix
, 
Bô°ªam
 *
s
)

38 
j
, 
sˇnj
;

39 
dñè_sˇÀ
, 
œ°SˇÀ
, 
√xtSˇÀ
;

41 
œ°SˇÀ
 = 8;

42 
√xtSˇÀ
 = 8;

44 
j
=0; j<
sizeOfSˇlögLi°
; j++)

46 
sˇnj
 = (
sizeOfSˇlögLi°
==16Ë? 
ZZ_SCAN
[
j
]:
ZZ_SCAN8
[j];

48 if(
√xtSˇÀ
!=0)

50 
dñè_sˇÀ
 = 
	`ªad_£_v
 ( " : dñè_¶ " , 
s
, &
p_Dec
->
U£dBôs
);

51 
√xtSˇÀ
 = (
œ°SˇÀ
 + 
dñè_sˇÀ
 + 256) % 256;

52 *
U£DeÁu…SˇlögM©rix
 = (
Boﬁón
Ë(
sˇnj
==0 && 
√xtSˇÀ
==0);

55 
sˇlögLi°
[
sˇnj
] = (
√xtSˇÀ
==0Ë? 
œ°SˇÀ
:nextScale;

56 
œ°SˇÀ
 = 
sˇlögLi°
[
sˇnj
];

58 
	}
}

61 
	$I¡î¥ëSPS
 (
VideoP¨amëîs
 *
p_Vid
, 
D©aP¨tôi⁄
 *
p
, 
£q_∑ømëî_£t_rb•_t
 *
•s
)

63 
i
;

64 
n_SˇlögLi°
;

65 
ª£rved_zîo
;

66 
Bô°ªam
 *
s
 = 
p
->
bô°ªam
;

68 
	`as£π
 (
p
 !
NULL
);

69 
	`as£π
 (
p
->
bô°ªam
 !
NULL
);

70 
	`as£π
 (
p
->
bô°ªam
->
°ªamBuf„r
 != 0);

71 
	`as£π
 (
•s
 !
NULL
);

73 
p_Dec
->
U£dBôs
 = 0;

75 
•s
->
¥ofûe_idc
 = 
	`ªad_u_v
 (8, "SPS:Örofûe_idc" , 
s
, &
p_Dec
->
U£dBôs
);

77 i‡((
•s
->
¥ofûe_idc
!=
BASELINE
 ) &&

78 (
•s
->
¥ofûe_idc
!=
MAIN
 ) &&

79 (
•s
->
¥ofûe_idc
!=
EXTENDED
 ) &&

80 (
•s
->
¥ofûe_idc
!=
FREXT_HP
 ) &&

81 (
•s
->
¥ofûe_idc
!=
FREXT_Hi10P
 ) &&

82 (
•s
->
¥ofûe_idc
!=
FREXT_Hi422
 ) &&

83 (
•s
->
¥ofûe_idc
!=
FREXT_Hi444
 ) &&

84 (
•s
->
¥ofûe_idc
!=
FREXT_CAVLC444
 )

85 #i‡(
MVC_EXTENSION_ENABLE
)

86 && (
•s
->
¥ofûe_idc
!=
MVC_HIGH
)

87 && (
•s
->
¥ofûe_idc
!=
STEREO_HIGH
)

91 
	`¥ötf
("InvÆid ProfûêIDC (%dËícou¡îed. \n", 
•s
->
¥ofûe_idc
);

92  
p_Dec
->
U£dBôs
;

95 
•s
->
c⁄°øöed_£t0_Êag
 = 
	`ªad_u_1
 ( "SPS: c⁄°øöed_£t0_Êag" , 
s
, &
p_Dec
->
U£dBôs
);

96 
•s
->
c⁄°øöed_£t1_Êag
 = 
	`ªad_u_1
 ( "SPS: c⁄°øöed_£t1_Êag" , 
s
, &
p_Dec
->
U£dBôs
);

97 
•s
->
c⁄°øöed_£t2_Êag
 = 
	`ªad_u_1
 ( "SPS: c⁄°øöed_£t2_Êag" , 
s
, &
p_Dec
->
U£dBôs
);

98 
•s
->
c⁄°øöed_£t3_Êag
 = 
	`ªad_u_1
 ( "SPS: c⁄°øöed_£t3_Êag" , 
s
, &
p_Dec
->
U£dBôs
);

99 #i‡(
MVC_EXTENSION_ENABLE
)

100 
•s
->
c⁄°øöed_£t4_Êag
 = 
	`ªad_u_1
 ( "SPS: c⁄°øöed_£t4_Êag" , 
s
, &
p_Dec
->
U£dBôs
);

101 
•s
->
c⁄°øöed_£t5_Êag
 = 
	`ªad_u_1
 ( "SPS: c⁄°øöed_£t5_Êag" , 
s
, &
p_Dec
->
U£dBôs
);

102 
ª£rved_zîo
 = 
	`ªad_u_v
 (2, "SPS:Ñe£rved_zîo_2bôs" , 
s
, &
p_Dec
->
U£dBôs
);

104 
ª£rved_zîo
 = 
	`ªad_u_v
 (4, "SPS:Ñe£rved_zîo_4bôs" , 
s
, &
p_Dec
->
U£dBôs
);

107 i‡(
ª£rved_zîo
 != 0)

109 
	`¥ötf
("Warning,Ñeserved_zero flagÇotÉqualÅo 0. PossiblyÇew constrained_setX flag introduced.\n");

112 
•s
->
Àvñ_idc
 = 
	`ªad_u_v
 (8, "SPS:Üevñ_idc" , 
s
, &
p_Dec
->
U£dBôs
);

114 
•s
->
£q_∑ømëî_£t_id
 = 
	`ªad_ue_v
 ("SPS: seq_∑ømëî_£t_id" , 
s
, &
p_Dec
->
U£dBôs
);

117 
•s
->
chroma_f‹m©_idc
 = 1;

118 
•s
->
bô_dïth_luma_möus8
 = 0;

119 
•s
->
bô_dïth_chroma_möus8
 = 0;

120 
•s
->
los¶ess_qµrime_Êag
 = 0;

121 
•s
->
£∑øã_cﬁour_∂™e_Êag
 = 0;

123 if((
•s
->
¥ofûe_idc
==
FREXT_HP
 ) ||

124 (
•s
->
¥ofûe_idc
==
FREXT_Hi10P
) ||

125 (
•s
->
¥ofûe_idc
==
FREXT_Hi422
) ||

126 (
•s
->
¥ofûe_idc
==
FREXT_Hi444
) ||

127 (
•s
->
¥ofûe_idc
==
FREXT_CAVLC444
)

128 #i‡(
MVC_EXTENSION_ENABLE
)

129 || (
•s
->
¥ofûe_idc
==
MVC_HIGH
)

130 || (
•s
->
¥ofûe_idc
==
STEREO_HIGH
)

134 
•s
->
chroma_f‹m©_idc
 = 
	`ªad_ue_v
 ("SPS: chroma_f‹m©_idc" , 
s
, &
p_Dec
->
U£dBôs
);

136 if(
•s
->
chroma_f‹m©_idc
 =
YUV444
)

138 
•s
->
£∑øã_cﬁour_∂™e_Êag
 = 
	`ªad_u_1
 ("SPS: sï¨©e_cﬁour_∂™e_Êag" , 
s
, &
p_Dec
->
U£dBôs
);

141 
•s
->
bô_dïth_luma_möus8
 = 
	`ªad_ue_v
 ("SPS: bô_dïth_luma_möus8" , 
s
, &
p_Dec
->
U£dBôs
);

142 
•s
->
bô_dïth_chroma_möus8
 = 
	`ªad_ue_v
 ("SPS: bô_dïth_chroma_möus8" , 
s
, &
p_Dec
->
U£dBôs
);

144 if((
•s
->
bô_dïth_luma_möus8
+8 > (
img≥l
)*8Ë|| (•s->
bô_dïth_chroma_möus8
+8> (imgpel)*8))

145 
	`îr‹
 ("SourceÖicture has higher bit depthÅhan imgpel dataÅype. \nPleaseÑecompile withÜarger dataÅype for imgpel.", 500);

147 
•s
->
los¶ess_qµrime_Êag
 = 
	`ªad_u_1
 ("SPS:Üos¶ess_qµrime_y_zîo_Êag" , 
s
, &
p_Dec
->
U£dBôs
);

149 
•s
->
£q_sˇlög_m©rix_¥e£¡_Êag
 = 
	`ªad_u_1
 ( "SPS: seq_sˇlög_m©rix_¥e£¡_Êag" , 
s
, &
p_Dec
->
U£dBôs
);

151 if(
•s
->
£q_sˇlög_m©rix_¥e£¡_Êag
)

153 
n_SˇlögLi°
 = (
•s
->
chroma_f‹m©_idc
 !
YUV444
) ? 8 : 12;

154 
i
=0; i<
n_SˇlögLi°
; i++)

156 
•s
->
£q_sˇlög_li°_¥e£¡_Êag
[
i
] = 
	`ªad_u_1
 ( "SPS: seq_sˇlög_li°_¥e£¡_Êag" , 
s
, &
p_Dec
->
U£dBôs
);

157 if(
•s
->
£q_sˇlög_li°_¥e£¡_Êag
[
i
])

159 if(
i
<6)

160 
	`Sˇlög_Li°
(
•s
->
SˇlögLi°4x4
[
i
], 16, &•s->
U£DeÁu…SˇlögM©rix4x4Fœg
[i], 
s
);

162 
	`Sˇlög_Li°
(
•s
->
SˇlögLi°8x8
[
i
-6], 64, &•s->
U£DeÁu…SˇlögM©rix8x8Fœg
[i-6], 
s
);

168 
•s
->
log2_max_‰ame_num_möus4
 = 
	`ªad_ue_v
 ("SPS:Üog2_max_‰ame_num_möus4" , 
s
, &
p_Dec
->
U£dBôs
);

169 
•s
->
pic_‹dî_˙t_ty≥
 = 
	`ªad_ue_v
 ("SPS:Öic_‹dî_˙t_ty≥" , 
s
, &
p_Dec
->
U£dBôs
);

171 i‡(
•s
->
pic_‹dî_˙t_ty≥
 == 0)

172 
•s
->
log2_max_pic_‹dî_˙t_lsb_möus4
 = 
	`ªad_ue_v
 ("SPS:Üog2_max_pic_‹dî_˙t_lsb_möus4" , 
s
, &
p_Dec
->
U£dBôs
);

173 i‡(
•s
->
pic_‹dî_˙t_ty≥
 == 1)

175 
•s
->
dñè_pic_‹dî_Æways_zîo_Êag
 = 
	`ªad_u_1
 ("SPS: dñè_pic_‹dî_Æways_zîo_Êag" , 
s
, &
p_Dec
->
U£dBôs
);

176 
•s
->
off£t_f‹_n⁄_ªf_pic
 = 
	`ªad_£_v
 ("SPS: off£t_f‹_n⁄_ªf_pic" , 
s
, &
p_Dec
->
U£dBôs
);

177 
•s
->
off£t_f‹_t›_to_bŸtom_fõld
 = 
	`ªad_£_v
 ("SPS: off£t_f‹_t›_to_bŸtom_fõld" , 
s
, &
p_Dec
->
U£dBôs
);

178 
•s
->
num_ªf_‰ames_ö_pic_‹dî_˙t_cy˛e
 = 
	`ªad_ue_v
 ("SPS:Çum_ªf_‰ames_ö_pic_‹dî_˙t_cy˛e" , 
s
, &
p_Dec
->
U£dBôs
);

179 
i
=0; i<
•s
->
num_ªf_‰ames_ö_pic_‹dî_˙t_cy˛e
; i++)

180 
•s
->
off£t_f‹_ªf_‰ame
[
i
] = 
	`ªad_£_v
 ("SPS: off£t_f‹_ªf_‰ame[i]" , 
s
, &
p_Dec
->
U£dBôs
);

182 
•s
->
num_ªf_‰ames
 = 
	`ªad_ue_v
 ("SPS:Çum_ªf_‰ames" , 
s
, &
p_Dec
->
U£dBôs
);

183 
•s
->
g≠s_ö_‰ame_num_vÆue_Ælowed_Êag
 = 
	`ªad_u_1
 ("SPS: g≠s_ö_‰ame_num_vÆue_Ælowed_Êag" , 
s
, &
p_Dec
->
U£dBôs
);

184 
•s
->
pic_width_ö_mbs_möus1
 = 
	`ªad_ue_v
 ("SPS:Öic_width_ö_mbs_möus1" , 
s
, &
p_Dec
->
U£dBôs
);

185 
•s
->
pic_height_ö_m≠_unôs_möus1
 = 
	`ªad_ue_v
 ("SPS:Öic_height_ö_m≠_unôs_möus1" , 
s
, &
p_Dec
->
U£dBôs
);

186 
•s
->
‰ame_mbs_⁄ly_Êag
 = 
	`ªad_u_1
 ("SPS: føme_mbs_⁄ly_Êag" , 
s
, &
p_Dec
->
U£dBôs
);

187 i‡(!
•s
->
‰ame_mbs_⁄ly_Êag
)

189 
•s
->
mb_ad≠tive_‰ame_fõld_Êag
 = 
	`ªad_u_1
 ("SPS: mb_ad≠tive_‰ame_fõld_Êag" , 
s
, &
p_Dec
->
U£dBôs
);

192 
•s
->
dúe˘_8x8_ö„ªn˚_Êag
 = 
	`ªad_u_1
 ("SPS: dúe˘_8x8_ö„ªn˚_Êag" , 
s
, &
p_Dec
->
U£dBôs
);

193 
•s
->
‰ame_¸›pög_Êag
 = 
	`ªad_u_1
 ("SPS: føme_¸›pög_Êag" , 
s
, &
p_Dec
->
U£dBôs
);

195 i‡(
•s
->
‰ame_¸›pög_Êag
)

197 
•s
->
‰ame_¸›_À·_off£t
 = 
	`ªad_ue_v
 ("SPS: føme_¸›_À·_off£t" , 
s
, &
p_Dec
->
U£dBôs
);

198 
•s
->
‰ame_¸›_right_off£t
 = 
	`ªad_ue_v
 ("SPS: føme_¸›_right_off£t" , 
s
, &
p_Dec
->
U£dBôs
);

199 
•s
->
‰ame_¸›_t›_off£t
 = 
	`ªad_ue_v
 ("SPS: føme_¸›_t›_off£t" , 
s
, &
p_Dec
->
U£dBôs
);

200 
•s
->
‰ame_¸›_bŸtom_off£t
 = 
	`ªad_ue_v
 ("SPS: føme_¸›_bŸtom_off£t" , 
s
, &
p_Dec
->
U£dBôs
);

202 
•s
->
vui_∑ømëîs_¥e£¡_Êag
 = (
Boﬁón
Ë
	`ªad_u_1
 ("SPS: vui_∑ømëîs_¥e£¡_Êag" , 
s
, &
p_Dec
->
U£dBôs
);

204 
	`InôVUI
(
•s
);

205 
	`RódVUI
(
p
, 
•s
);

207 
•s
->
VÆid
 = 
TRUE
;

208  
p_Dec
->
U£dBôs
;

209 
	}
}

212 #i‡(
MVC_EXTENSION_ENABLE
)

213 
	$I¡î¥ëSub£tSPS
 (
VideoP¨amëîs
 *
p_Vid
, 
D©aP¨tôi⁄
 *
p
, *
cuº_£q_£t_id
)

215 
sub£t_£q_∑ømëî_£t_rb•_t
 *
sub£t_•s
;

216 
addôi⁄Æ_exãnsi⁄2_Êag
;

217 
Bô°ªam
 *
s
 = 
p
->
bô°ªam
;

218 
£q_∑ømëî_£t_rb•_t
 *
•s
 = 
	`AŒocSPS
();

220 
	`as£π
 (
p
 !
NULL
);

221 
	`as£π
 (
p
->
bô°ªam
 !
NULL
);

222 
	`as£π
 (
p
->
bô°ªam
->
°ªamBuf„r
 != 0);

224 
	`I¡î¥ëSPS
 (
p_Vid
, 
p
, 
•s
);

225 
	`gë_max_dec_‰ame_buf_size
(
•s
);

227 *
cuº_£q_£t_id
 = 
•s
->
£q_∑ømëî_£t_id
;

228 
sub£t_•s
 = 
p_Vid
->
Sub£tSeqP¨Së
 + 
•s
->
£q_∑ømëî_£t_id
;

229 if(
sub£t_•s
->
VÆid
 || sub£t_•s->
num_võws_möus1
>=0)

231 if(
	`memcmp
(&
sub£t_•s
->
•s
, sps,  (
£q_∑ømëî_£t_rb•_t
)-()))

232 
	`as£π
(0);

233 
	`ª£t_sub£t_•s
(
sub£t_•s
);

235 
	`mem˝y
 (&
sub£t_•s
->
•s
, sps,  (
£q_∑ømëî_£t_rb•_t
));

237 
	`as£π
 (
sub£t_•s
 !
NULL
);

238 
sub£t_•s
->
VÆid
 = 
FALSE
;

245 if–
	`is_MVC_¥ofûe
(
sub£t_•s
->
•s
.
¥ofûe_idc
))

247 
sub£t_•s
->
bô_equÆ_to_⁄e
 = 
	`ªad_u_1
("bô_equÆ_to_⁄e", 
s
, &
p_Dec
->
U£dBôs
);

249 if(
sub£t_•s
->
bô_equÆ_to_⁄e
 !=1 )

251 
	`¥ötf
("\nbit_equal_to_one isÇotÉqualÅo 1!\n");

252  
p_Dec
->
U£dBôs
;

255 
	`£q_∑ømëî_£t_mvc_exãnsi⁄
(
sub£t_•s
, 
s
);

257 
sub£t_•s
->
mvc_vui_∑ømëîs_¥e£¡_Êag
 = 
	`ªad_u_1
("mvc_vui_∑ømëîs_¥e£¡_Êag", 
s
, &
p_Dec
->
U£dBôs
);

258 if(
sub£t_•s
->
mvc_vui_∑ømëîs_¥e£¡_Êag
)

259 
	`mvc_vui_∑ømëîs_exãnsi⁄
(&(
sub£t_•s
->
MVCVUIP¨ams
), 
s
);

262 
addôi⁄Æ_exãnsi⁄2_Êag
 = 
	`ªad_u_1
("addôi⁄Æ_exãnsi⁄2_Êag", 
s
, &
p_Dec
->
U£dBôs
);

263 if(
addôi⁄Æ_exãnsi⁄2_Êag
)

265 
	`m‹e_rb•_d©a
(
s
->
°ªamBuf„r
, s->
‰ame_bôoff£t
,s->
bô°ªam_Àngth
))

266 
addôi⁄Æ_exãnsi⁄2_Êag
 = 
	`ªad_u_1
("addôi⁄Æ_exãnsi⁄2_Êag", 
s
, &
p_Dec
->
U£dBôs
);

269 i‡(
sub£t_•s
->
•s
.
VÆid
)

270 
sub£t_•s
->
VÆid
 = 
TRUE
;

272 
	`FªeSPS
 (
•s
);

273  
p_Dec
->
U£dBôs
;

275 
	}
}

278 
	$InôVUI
(
£q_∑ømëî_£t_rb•_t
 *
•s
)

280 
•s
->
vui_£q_∑ømëîs
.
m©rix_c€fficõ¡s
 = 2;

281 
	}
}

284 
	$RódVUI
(
D©aP¨tôi⁄
 *
p
, 
£q_∑ømëî_£t_rb•_t
 *
•s
)

286 
Bô°ªam
 *
s
 = 
p
->
bô°ªam
;

287 i‡(
•s
->
vui_∑ømëîs_¥e£¡_Êag
)

289 
•s
->
vui_£q_∑ømëîs
.
a•e˘_øtio_öfo_¥e£¡_Êag
 = 
	`ªad_u_1
 ("VUI:á•e˘_øtio_öfo_¥e£¡_Êag" , 
s
, &
p_Dec
->
U£dBôs
);

290 i‡(
•s
->
vui_£q_∑ømëîs
.
a•e˘_øtio_öfo_¥e£¡_Êag
)

292 
•s
->
vui_£q_∑ømëîs
.
a•e˘_øtio_idc
 = 
	`ªad_u_v
 ( 8, "VUI:á•e˘_øtio_idc" , 
s
, &
p_Dec
->
U£dBôs
);

293 i‡(255==
•s
->
vui_£q_∑ømëîs
.
a•e˘_øtio_idc
)

295 
•s
->
vui_£q_∑ømëîs
.
ßr_width
 = (Ë
	`ªad_u_v
 (16, "VUI: s¨_width" , 
s
, &
p_Dec
->
U£dBôs
);

296 
•s
->
vui_£q_∑ømëîs
.
ßr_height
 = (Ë
	`ªad_u_v
 (16, "VUI: s¨_height" , 
s
, &
p_Dec
->
U£dBôs
);

300 
•s
->
vui_£q_∑ømëîs
.
ovîsˇn_öfo_¥e£¡_Êag
 = 
	`ªad_u_1
 ("VUI: ovîsˇn_öfo_¥e£¡_Êag" , 
s
, &
p_Dec
->
U£dBôs
);

301 i‡(
•s
->
vui_£q_∑ømëîs
.
ovîsˇn_öfo_¥e£¡_Êag
)

303 
•s
->
vui_£q_∑ømëîs
.
ovîsˇn_≠¥›rüã_Êag
 = 
	`ªad_u_1
 ("VUI: ovîsˇn_≠¥›rüã_Êag" , 
s
, &
p_Dec
->
U£dBôs
);

306 
•s
->
vui_£q_∑ømëîs
.
video_sig«l_ty≥_¥e£¡_Êag
 = 
	`ªad_u_1
 ("VUI: video_sig«l_ty≥_¥e£¡_Êag" , 
s
, &
p_Dec
->
U£dBôs
);

307 i‡(
•s
->
vui_£q_∑ømëîs
.
video_sig«l_ty≥_¥e£¡_Êag
)

309 
•s
->
vui_£q_∑ømëîs
.
video_f‹m©
 = 
	`ªad_u_v
 ( 3,"VUI: video_f‹m©" , 
s
, &
p_Dec
->
U£dBôs
);

310 
•s
->
vui_£q_∑ømëîs
.
video_fuŒ_ønge_Êag
 = 
	`ªad_u_1
 ( "VUI: video_fuŒ_ønge_Êag" , 
s
, &
p_Dec
->
U£dBôs
);

311 
•s
->
vui_£q_∑ømëîs
.
cﬁour_des¸ùti⁄_¥e£¡_Êag
 = 
	`ªad_u_1
 ( "VUI: cﬁ‹_des¸ùti⁄_¥e£¡_Êag" , 
s
, &
p_Dec
->
U£dBôs
);

312 if(
•s
->
vui_£q_∑ømëîs
.
cﬁour_des¸ùti⁄_¥e£¡_Êag
)

314 
•s
->
vui_£q_∑ømëîs
.
cﬁour_¥im¨õs
 = 
	`ªad_u_v
 ( 8,"VUI: cﬁour_¥im¨õs" , 
s
, &
p_Dec
->
U£dBôs
);

315 
•s
->
vui_£q_∑ømëîs
.
å™s„r_ch¨a˘îi°ics
 = 
	`ªad_u_v
 ( 8,"VUI:Åøns„r_ch¨a˘îi°ics" , 
s
, &
p_Dec
->
U£dBôs
);

316 
•s
->
vui_£q_∑ømëîs
.
m©rix_c€fficõ¡s
 = 
	`ªad_u_v
 ( 8,"VUI: m©rix_c€fficõ¡s" , 
s
, &
p_Dec
->
U£dBôs
);

319 
•s
->
vui_£q_∑ømëîs
.
chroma_loˇti⁄_öfo_¥e£¡_Êag
 = 
	`ªad_u_1
 ( "VUI: chroma_loc_öfo_¥e£¡_Êag" , 
s
, &
p_Dec
->
U£dBôs
);

320 if(
•s
->
vui_£q_∑ømëîs
.
chroma_loˇti⁄_öfo_¥e£¡_Êag
)

322 
•s
->
vui_£q_∑ømëîs
.
chroma_ßm∂e_loc_ty≥_t›_fõld
 = 
	`ªad_ue_v
 ( "VUI: chroma_ßm∂e_loc_ty≥_t›_fõld" , 
s
, &
p_Dec
->
U£dBôs
);

323 
•s
->
vui_£q_∑ømëîs
.
chroma_ßm∂e_loc_ty≥_bŸtom_fõld
 = 
	`ªad_ue_v
 ( "VUI: chroma_ßm∂e_loc_ty≥_bŸtom_fõld" , 
s
, &
p_Dec
->
U£dBôs
);

325 
•s
->
vui_£q_∑ømëîs
.
timög_öfo_¥e£¡_Êag
 = 
	`ªad_u_1
 ("VUI:Åimög_öfo_¥e£¡_Êag" , 
s
, &
p_Dec
->
U£dBôs
);

326 i‡(
•s
->
vui_£q_∑ømëîs
.
timög_öfo_¥e£¡_Êag
)

328 
•s
->
vui_£q_∑ømëîs
.
num_unôs_ö_tick
 = 
	`ªad_u_v
 (32,"VUI:Çum_unôs_ö_tick" , 
s
, &
p_Dec
->
U£dBôs
);

329 
•s
->
vui_£q_∑ømëîs
.
time_sˇÀ
 = 
	`ªad_u_v
 (32,"VUI:Åime_sˇÀ" , 
s
, &
p_Dec
->
U£dBôs
);

330 
•s
->
vui_£q_∑ømëîs
.
fixed_‰ame_øã_Êag
 = 
	`ªad_u_1
 ( "VUI: fixed_‰ame_øã_Êag" , 
s
, &
p_Dec
->
U£dBôs
);

332 
•s
->
vui_£q_∑ømëîs
.
«l_hrd_∑ømëîs_¥e£¡_Êag
 = 
	`ªad_u_1
 ("VUI:ÇÆ_hrd_∑ømëîs_¥e£¡_Êag" , 
s
, &
p_Dec
->
U£dBôs
);

333 i‡(
•s
->
vui_£q_∑ømëîs
.
«l_hrd_∑ømëîs_¥e£¡_Êag
)

335 
	`RódHRDP¨amëîs
(
p
, &(
•s
->
vui_£q_∑ømëîs
.
«l_hrd_∑ømëîs
));

337 
•s
->
vui_£q_∑ømëîs
.
v˛_hrd_∑ømëîs_¥e£¡_Êag
 = 
	`ªad_u_1
 ("VUI: v˛_hrd_∑ømëîs_¥e£¡_Êag" , 
s
, &
p_Dec
->
U£dBôs
);

338 i‡(
•s
->
vui_£q_∑ømëîs
.
v˛_hrd_∑ømëîs_¥e£¡_Êag
)

340 
	`RódHRDP¨amëîs
(
p
, &(
•s
->
vui_£q_∑ømëîs
.
v˛_hrd_∑ømëîs
));

342 i‡(
•s
->
vui_£q_∑ømëîs
.
«l_hrd_∑ømëîs_¥e£¡_Êag
 || sps->vui_£q_∑ømëîs.
v˛_hrd_∑ømëîs_¥e£¡_Êag
)

344 
•s
->
vui_£q_∑ømëîs
.
low_dñay_hrd_Êag
 = 
	`ªad_u_1
 ("VUI:Üow_dñay_hrd_Êag" , 
s
, &
p_Dec
->
U£dBôs
);

346 
•s
->
vui_£q_∑ømëîs
.
pic_°ru˘_¥e£¡_Êag
 = 
	`ªad_u_1
 ("VUI:Öic_°ru˘_¥e£¡_Êag " , 
s
, &
p_Dec
->
U£dBôs
);

347 
•s
->
vui_£q_∑ømëîs
.
bô°ªam_ª°ri˘i⁄_Êag
 = 
	`ªad_u_1
 ("VUI: bô°ªam_ª°ri˘i⁄_Êag" , 
s
, &
p_Dec
->
U£dBôs
);

348 i‡(
•s
->
vui_£q_∑ømëîs
.
bô°ªam_ª°ri˘i⁄_Êag
)

350 
•s
->
vui_£q_∑ømëîs
.
mŸi⁄_ve˘‹s_ovî_pic_bound¨õs_Êag
 = 
	`ªad_u_1
 ("VUI: mŸi⁄_ve˘‹s_ovî_pic_bound¨õs_Êag", 
s
, &
p_Dec
->
U£dBôs
);

351 
•s
->
vui_£q_∑ømëîs
.
max_byãs_≥r_pic_díom
 = 
	`ªad_ue_v
 ("VUI: max_byãs_≥r_pic_díom" , 
s
, &
p_Dec
->
U£dBôs
);

352 
•s
->
vui_£q_∑ømëîs
.
max_bôs_≥r_mb_díom
 = 
	`ªad_ue_v
 ("VUI: max_bôs_≥r_mb_díom" , 
s
, &
p_Dec
->
U£dBôs
);

353 
•s
->
vui_£q_∑ømëîs
.
log2_max_mv_Àngth_h‹iz⁄èl
 = 
	`ªad_ue_v
 ("VUI:Üog2_max_mv_Àngth_h‹iz⁄èl" , 
s
, &
p_Dec
->
U£dBôs
);

354 
•s
->
vui_£q_∑ømëîs
.
log2_max_mv_Àngth_vîtiˇl
 = 
	`ªad_ue_v
 ("VUI:Üog2_max_mv_Àngth_vîtiˇl" , 
s
, &
p_Dec
->
U£dBôs
);

355 
•s
->
vui_£q_∑ømëîs
.
num_ª‹dî_‰ames
 = 
	`ªad_ue_v
 ("VUI:Çum_ª‹dî_‰ames" , 
s
, &
p_Dec
->
U£dBôs
);

356 
•s
->
vui_£q_∑ømëîs
.
max_dec_‰ame_buf„rög
 = 
	`ªad_ue_v
 ("VUI: max_dec_‰ame_buf„rög" , 
s
, &
p_Dec
->
U£dBôs
);

361 
	}
}

364 
	$RódHRDP¨amëîs
(
D©aP¨tôi⁄
 *
p
, 
hrd_∑ømëîs_t
 *
hrd
)

366 
Bô°ªam
 *
s
 = 
p
->
bô°ªam
;

367 
SchedSñIdx
;

369 
hrd
->
˝b_˙t_möus1
 = 
	`ªad_ue_v
 ( "VUI: cpb_˙t_möus1" , 
s
, &
p_Dec
->
U£dBôs
);

370 
hrd
->
bô_øã_sˇÀ
 = 
	`ªad_u_v
 ( 4,"VUI: bô_øã_sˇÀ" , 
s
, &
p_Dec
->
U£dBôs
);

371 
hrd
->
˝b_size_sˇÀ
 = 
	`ªad_u_v
 ( 4,"VUI: cpb_size_sˇÀ" , 
s
, &
p_Dec
->
U£dBôs
);

373  
SchedSñIdx
 = 0; SchedSñIdx <
hrd
->
˝b_˙t_möus1
; SchedSelIdx++ )

375 
hrd
->
bô_øã_vÆue_möus1
[ 
SchedSñIdx
 ] = 
	`ªad_ue_v
 ( "VUI: bô_øã_vÆue_möus1" , 
s
, &
p_Dec
->
U£dBôs
);

376 
hrd
->
˝b_size_vÆue_möus1
[ 
SchedSñIdx
 ] = 
	`ªad_ue_v
 ( "VUI: cpb_size_vÆue_möus1" , 
s
, &
p_Dec
->
U£dBôs
);

377 
hrd
->
cbr_Êag
[ 
SchedSñIdx
 ] = 
	`ªad_u_1
 ( "VUI: cbr_Êag" , 
s
, &
p_Dec
->
U£dBôs
);

380 
hrd
->
öôül_˝b_ªmovÆ_dñay_Àngth_möus1
 = 
	`ªad_u_v
 ( 5,"VUI: inôül_˝b_ªmovÆ_dñay_Àngth_möus1" , 
s
, &
p_Dec
->
U£dBôs
);

381 
hrd
->
˝b_ªmovÆ_dñay_Àngth_möus1
 = 
	`ªad_u_v
 ( 5,"VUI: cpb_ªmovÆ_dñay_Àngth_möus1" , 
s
, &
p_Dec
->
U£dBôs
);

382 
hrd
->
dpb_ouçut_dñay_Àngth_möus1
 = 
	`ªad_u_v
 ( 5,"VUI: dpb_ouçut_dñay_Àngth_möus1" , 
s
, &
p_Dec
->
U£dBôs
);

383 
hrd
->
time_off£t_Àngth
 = 
	`ªad_u_v
 ( 5,"VUI:Åime_off£t_Àngth" , 
s
, &
p_Dec
->
U£dBôs
);

386 
	}
}

389 
	$I¡î¥ëPPS
 (
VideoP¨amëîs
 *
p_Vid
, 
D©aP¨tôi⁄
 *
p
, 
pic_∑ømëî_£t_rb•_t
 *
µs
)

391 
i
;

392 
n_SˇlögLi°
;

393 
chroma_f‹m©_idc
;

394 
NumbîBôsPîSli˚GroupId
;

395 
Bô°ªam
 *
s
 = 
p
->
bô°ªam
;

397 
	`as£π
 (
p
 !
NULL
);

398 
	`as£π
 (
p
->
bô°ªam
 !
NULL
);

399 
	`as£π
 (
p
->
bô°ªam
->
°ªamBuf„r
 != 0);

400 
	`as£π
 (
µs
 !
NULL
);

402 
p_Dec
->
U£dBôs
 = 0;

404 
µs
->
pic_∑ømëî_£t_id
 = 
	`ªad_ue_v
 ("PPS:Öic_∑ømëî_£t_id" , 
s
, &
p_Dec
->
U£dBôs
);

405 
µs
->
£q_∑ømëî_£t_id
 = 
	`ªad_ue_v
 ("PPS: seq_∑ømëî_£t_id" , 
s
, &
p_Dec
->
U£dBôs
);

406 
µs
->
íå›y_codög_mode_Êag
 = 
	`ªad_u_1
 ("PPS:É¡r›y_codög_mode_Êag" , 
s
, &
p_Dec
->
U£dBôs
);

413 
µs
->
bŸtom_fõld_pic_‹dî_ö_‰ame_¥e£¡_Êag
 = 
	`ªad_u_1
 ("PPS: bŸtom_fõld_pic_‹dî_ö_‰ame_¥e£¡_Êag" , 
s
, &
p_Dec
->
U£dBôs
);

415 
µs
->
num_¶i˚_groups_möus1
 = 
	`ªad_ue_v
 ("PPS:Çum_¶i˚_groups_möus1" , 
s
, &
p_Dec
->
U£dBôs
);

418 i‡(
µs
->
num_¶i˚_groups_möus1
 > 0)

420 
µs
->
¶i˚_group_m≠_ty≥
 = 
	`ªad_ue_v
 ("PPS: sli˚_group_m≠_ty≥" , 
s
, &
p_Dec
->
U£dBôs
);

421 i‡(
µs
->
¶i˚_group_m≠_ty≥
 == 0)

423 
i
=0; i<=
µs
->
num_¶i˚_groups_möus1
; i++)

424 
µs
->
run_Àngth_möus1
 [
i
] = 
	`ªad_ue_v
 ("PPS:Ñun_Àngth_möus1 [i]" , 
s
, &
p_Dec
->
U£dBôs
);

426 i‡(
µs
->
¶i˚_group_m≠_ty≥
 == 2)

428 
i
=0; i<
µs
->
num_¶i˚_groups_möus1
; i++)

431 
µs
->
t›_À·
 [
i
] = 
	`ªad_ue_v
 ("PPS:Å›_À· [i]" , 
s
, &
p_Dec
->
U£dBôs
);

432 
µs
->
bŸtom_right
 [
i
] = 
	`ªad_ue_v
 ("PPS: bŸtom_righà[i]" , 
s
, &
p_Dec
->
U£dBôs
);

435 i‡(
µs
->
¶i˚_group_m≠_ty≥
 == 3 ||

436 
µs
->
¶i˚_group_m≠_ty≥
 == 4 ||

437 
µs
->
¶i˚_group_m≠_ty≥
 == 5)

439 
µs
->
¶i˚_group_ch™ge_dúe˘i⁄_Êag
 = 
	`ªad_u_1
 ("PPS: sli˚_group_ch™ge_dúe˘i⁄_Êag" , 
s
, &
p_Dec
->
U£dBôs
);

440 
µs
->
¶i˚_group_ch™ge_øã_möus1
 = 
	`ªad_ue_v
 ("PPS: sli˚_group_ch™ge_øã_möus1" , 
s
, &
p_Dec
->
U£dBôs
);

442 i‡(
µs
->
¶i˚_group_m≠_ty≥
 == 6)

444 i‡(
µs
->
num_¶i˚_groups_möus1
+1 >4)

445 
NumbîBôsPîSli˚GroupId
 = 3;

446 i‡(
µs
->
num_¶i˚_groups_möus1
+1 > 2)

447 
NumbîBôsPîSli˚GroupId
 = 2;

449 
NumbîBôsPîSli˚GroupId
 = 1;

450 
µs
->
pic_size_ö_m≠_unôs_möus1
 = 
	`ªad_ue_v
 ("PPS:Öic_size_ö_m≠_unôs_möus1" , 
s
, &
p_Dec
->
U£dBôs
);

451 i‡((
µs
->
¶i˚_group_id
 = 
	`ˇŒoc
 (µs->
pic_size_ö_m≠_unôs_möus1
+1, 1)Ë=
NULL
)

452 
	`no_mem_exô
 ("InterpretPPS: slice_group_id");

453 
i
=0; i<=
µs
->
pic_size_ö_m≠_unôs_möus1
; i++)

454 
µs
->
¶i˚_group_id
[
i
] = (
byã
Ë
	`ªad_u_v
 (
NumbîBôsPîSli˚GroupId
, "¶i˚_group_id[i]", 
s
, &
p_Dec
->
U£dBôs
);

460 
µs
->
num_ªf_idx_l0_deÁu…_a˘ive_möus1
 = 
	`ªad_ue_v
 ("PPS:Çum_ªf_idx_l0_deÁu…_a˘ive_möus1" , 
s
, &
p_Dec
->
U£dBôs
);

461 
µs
->
num_ªf_idx_l1_deÁu…_a˘ive_möus1
 = 
	`ªad_ue_v
 ("PPS:Çum_ªf_idx_l1_deÁu…_a˘ive_möus1" , 
s
, &
p_Dec
->
U£dBôs
);

462 
µs
->
weighãd_¥ed_Êag
 = 
	`ªad_u_1
 ("PPS: weighãd_¥ed_Êag" , 
s
, &
p_Dec
->
U£dBôs
);

463 
µs
->
weighãd_bùªd_idc
 = 
	`ªad_u_v
 ( 2, "PPS: weighãd_bùªd_idc" , 
s
, &
p_Dec
->
U£dBôs
);

464 
µs
->
pic_öô_qp_möus26
 = 
	`ªad_£_v
 ("PPS:Öic_öô_qp_möus26" , 
s
, &
p_Dec
->
U£dBôs
);

465 
µs
->
pic_öô_qs_möus26
 = 
	`ªad_£_v
 ("PPS:Öic_öô_qs_möus26" , 
s
, &
p_Dec
->
U£dBôs
);

467 
µs
->
chroma_qp_ödex_off£t
 = 
	`ªad_£_v
 ("PPS: chroma_qp_ödex_off£t" , 
s
, &
p_Dec
->
U£dBôs
);

469 
µs
->
deblockög_fûãr_c⁄åﬁ_¥e£¡_Êag
 = 
	`ªad_u_1
 ("PPS: deblockög_fûãr_c⁄åﬁ_¥e£¡_Êag" , 
s
, &
p_Dec
->
U£dBôs
);

470 
µs
->
c⁄°øöed_öåa_¥ed_Êag
 = 
	`ªad_u_1
 ("PPS: c⁄°øöed_öåa_¥ed_Êag" , 
s
, &
p_Dec
->
U£dBôs
);

471 
µs
->
ªdund™t_pic_˙t_¥e£¡_Êag
 = 
	`ªad_u_1
 ("PPS:Ñedund™t_pic_˙t_¥e£¡_Êag" , 
s
, &
p_Dec
->
U£dBôs
);

473 if(
	`m‹e_rb•_d©a
(
s
->
°ªamBuf„r
, s->
‰ame_bôoff£t
,s->
bô°ªam_Àngth
))

476 
µs
->
å™sf‹m_8x8_mode_Êag
 = 
	`ªad_u_1
 ("PPS:Åønsf‹m_8x8_mode_Êag" , 
s
, &
p_Dec
->
U£dBôs
);

477 
µs
->
pic_sˇlög_m©rix_¥e£¡_Êag
 = 
	`ªad_u_1
 ("PPS:Öic_sˇlög_m©rix_¥e£¡_Êag" , 
s
, &
p_Dec
->
U£dBôs
);

479 if(
µs
->
pic_sˇlög_m©rix_¥e£¡_Êag
)

481 
chroma_f‹m©_idc
 = 
p_Vid
->
SeqP¨Së
[
µs
->
£q_∑ømëî_£t_id
].chroma_format_idc;

482 
n_SˇlögLi°
 = 6 + ((
chroma_f‹m©_idc
 !
YUV444
Ë? 2 : 6Ë* 
µs
->
å™sf‹m_8x8_mode_Êag
;

483 
i
=0; i<
n_SˇlögLi°
; i++)

485 
µs
->
pic_sˇlög_li°_¥e£¡_Êag
[
i
]
	`ªad_u_1
 ("PPS:Öic_sˇlög_li°_¥e£¡_Êag" , 
s
, &
p_Dec
->
U£dBôs
);

487 if(
µs
->
pic_sˇlög_li°_¥e£¡_Êag
[
i
])

489 if(
i
<6)

490 
	`Sˇlög_Li°
(
µs
->
SˇlögLi°4x4
[
i
], 16, &µs->
U£DeÁu…SˇlögM©rix4x4Fœg
[i], 
s
);

492 
	`Sˇlög_Li°
(
µs
->
SˇlögLi°8x8
[
i
-6], 64, &µs->
U£DeÁu…SˇlögM©rix8x8Fœg
[i-6], 
s
);

496 
µs
->
£c⁄d_chroma_qp_ödex_off£t
 = 
	`ªad_£_v
 ("PPS: sec⁄d_chroma_qp_ödex_off£t" , 
s
, &
p_Dec
->
U£dBôs
);

500 
µs
->
£c⁄d_chroma_qp_ödex_off£t
 =Öps->
chroma_qp_ödex_off£t
;

503 
µs
->
VÆid
 = 
TRUE
;

504  
p_Dec
->
U£dBôs
;

505 
	}
}

508 
	$PPSC⁄si°ícyCheck
 (
pic_∑ømëî_£t_rb•_t
 *
µs
)

510 
	`¥ötf
 ("Consistency checkingáÖictureÖarset,Åo be implemented\n");

512 
	}
}

514 
	$SPSC⁄si°ícyCheck
 (
£q_∑ømëî_£t_rb•_t
 *
•s
)

516 
	`¥ötf
 ("Consistency checkingá sequenceÖarset,Åo be implemented\n");

517 
	}
}

519 #i‡(
MVC_EXTENSION_ENABLE
)

520 
	$Sub£tSPSC⁄si°ícyCheck
 (
sub£t_£q_∑ømëî_£t_rb•_t
 *
sub£t_•s
)

522 
	`¥ötf
 ("Consistency checkingá subset sequenceÖarset,Åo be implemented\n");

523 
	}
}

526 
	$MakePPSavaûabÀ
 (
VideoP¨amëîs
 *
p_Vid
, 
id
, 
pic_∑ømëî_£t_rb•_t
 *
µs
)

528 
	`as£π
 (
µs
->
VÆid
 =
TRUE
);

530 i‡(
p_Vid
->
PicP¨Së
[
id
].
VÆid
 =
TRUE
 &&Ö_Vid->PicP¨Së[id].
¶i˚_group_id
 !
NULL
)

531 
	`‰ì
 (
p_Vid
->
PicP¨Së
[
id
].
¶i˚_group_id
);

533 
	`mem˝y
 (&
p_Vid
->
PicP¨Së
[
id
], 
µs
,  (
pic_∑ømëî_£t_rb•_t
));

537 
p_Vid
->
PicP¨Së
[
id
].
¶i˚_group_id
 = 
µs
->slice_group_id;

538 
µs
->
¶i˚_group_id
 = 
NULL
;

539 
	}
}

541 
	$CÀ™UpPPS
(
VideoP¨amëîs
 *
p_Vid
)

543 
i
;

545 
i
=0; i<
MAXPPS
; i++)

547 i‡(
p_Vid
->
PicP¨Së
[
i
].
VÆid
 =
TRUE
 &&Ö_Vid->PicP¨Së[i].
¶i˚_group_id
 !
NULL
)

548 
	`‰ì
 (
p_Vid
->
PicP¨Së
[
i
].
¶i˚_group_id
);

550 
p_Vid
->
PicP¨Së
[
i
].
VÆid
 = 
FALSE
;

552 
	}
}

555 
	$MakeSPSavaûabÀ
 (
VideoP¨amëîs
 *
p_Vid
, 
id
, 
£q_∑ømëî_£t_rb•_t
 *
•s
)

557 
	`as£π
 (
•s
->
VÆid
 =
TRUE
);

558 
	`mem˝y
 (&
p_Vid
->
SeqP¨Së
[
id
], 
•s
,  (
£q_∑ømëî_£t_rb•_t
));

559 
	}
}

562 
	$Pro˚ssSPS
 (
VideoP¨amëîs
 *
p_Vid
, 
NALU_t
 *
«lu
)

564 
D©aP¨tôi⁄
 *
dp
 = 
	`AŒocP¨tôi⁄
(1);

565 
£q_∑ømëî_£t_rb•_t
 *
•s
 = 
	`AŒocSPS
();

567 
	`mem˝y
 (
dp
->
bô°ªam
->
°ªamBuf„r
, &
«lu
->
buf
[1],ÇÆu->
Àn
-1);

568 
dp
->
bô°ªam
->
code_Àn
 = dp->bô°ªam->
bô°ªam_Àngth
 = 
	`RBSPtoSODB
 (dp->bô°ªam->
°ªamBuf„r
, 
«lu
->
Àn
-1);

569 
dp
->
bô°ªam
->
ei_Êag
 = 0;

570 
dp
->
bô°ªam
->
ªad_Àn
 = dp->bô°ªam->
‰ame_bôoff£t
 = 0;

572 
	`I¡î¥ëSPS
 (
p_Vid
, 
dp
, 
•s
);

573 #i‡(
MVC_EXTENSION_ENABLE
)

574 
	`gë_max_dec_‰ame_buf_size
(
•s
);

577 i‡(
•s
->
VÆid
)

579 i‡(
p_Vid
->
a˘ive_•s
)

581 i‡(
•s
->
£q_∑ømëî_£t_id
 =
p_Vid
->
a˘ive_•s
->seq_parameter_set_id)

583 i‡(!
	`•s_is_equÆ
(
•s
, 
p_Vid
->
a˘ive_•s
))

585 i‡(
p_Vid
->
dec_pi˘uª
)

588 
	`exô_pi˘uª
(
p_Vid
, &p_Vid->
dec_pi˘uª
);

590 
p_Vid
->
a˘ive_•s
=
NULL
;

595 
	`MakeSPSavaûabÀ
 (
p_Vid
, 
•s
->
£q_∑ømëî_£t_id
, sps);

596 #i‡(
MVC_EXTENSION_ENABLE
)

597 i‡(
p_Vid
->
¥ofûe_idc
 < (Ë
•s
->profile_idc)

599 
p_Vid
->
¥ofûe_idc
 = 
•s
->profile_idc;

602 
p_Vid
->
¥ofûe_idc
 = 
•s
->profile_idc;

604 
p_Vid
->
£∑øã_cﬁour_∂™e_Êag
 = 
•s
->separate_colour_plane_flag;

605 if–
p_Vid
->
£∑øã_cﬁour_∂™e_Êag
 )

607 
p_Vid
->
ChromaAºayTy≥
 = 0;

611 
p_Vid
->
ChromaAºayTy≥
 = 
•s
->
chroma_f‹m©_idc
;

615 
	`FªeP¨tôi⁄
 (
dp
, 1);

616 
	`FªeSPS
 (
•s
);

617 
	}
}

619 #i‡(
MVC_EXTENSION_ENABLE
)

620 
	$Pro˚ssSub£tSPS
 (
VideoP¨amëîs
 *
p_Vid
, 
NALU_t
 *
«lu
)

622 
D©aP¨tôi⁄
 *
dp
 = 
	`AŒocP¨tôi⁄
(1);

623 
sub£t_£q_∑ømëî_£t_rb•_t
 *
sub£t_•s
;

624 
cuº_£q_£t_id
;

626 
	`mem˝y
 (
dp
->
bô°ªam
->
°ªamBuf„r
, &
«lu
->
buf
[1],ÇÆu->
Àn
-1);

627 
dp
->
bô°ªam
->
code_Àn
 = dp->bô°ªam->
bô°ªam_Àngth
 = 
	`RBSPtoSODB
 (dp->bô°ªam->
°ªamBuf„r
, 
«lu
->
Àn
-1);

628 
dp
->
bô°ªam
->
ei_Êag
 = 0;

629 
dp
->
bô°ªam
->
ªad_Àn
 = dp->bô°ªam->
‰ame_bôoff£t
 = 0;

630 
	`I¡î¥ëSub£tSPS
 (
p_Vid
, 
dp
, &
cuº_£q_£t_id
);

632 
sub£t_•s
 = 
p_Vid
->
Sub£tSeqP¨Së
 + 
cuº_£q_£t_id
;

633 
	`gë_max_dec_‰ame_buf_size
(&(
sub£t_•s
->
•s
));

635 if(
sub£t_•s
->
num_võws_möus1
>1)

637 
	`¥ötf
("W¨nög:Çum_võws:%d i†gª©îÅh™ 2, o∆y decodêba£œyî!\n", 
sub£t_•s
->
num_võws_möus1
+1);

638 
sub£t_•s
->
VÆid
 = 0;

639 
sub£t_•s
->
•s
.
VÆid
 = 0;

640 
p_Vid
->
p_I≈
->
DecodeAŒLayîs
 = 0;

642 if(
sub£t_•s
->
num_võws_möus1
==1 && (sub£t_•s->
võw_id
[0]!=0 || subset_sps->view_id[1]!=1))

644 
	`O≥nOuçutFûes
(
p_Vid
, 
sub£t_•s
->
võw_id
[0], subset_sps->view_id[1]);

647 i‡(
sub£t_•s
->
VÆid
)

650 
p_Vid
->
¥ofûe_idc
 = 
sub£t_•s
->
•s
.profile_idc;

651 
p_Vid
->
£∑øã_cﬁour_∂™e_Êag
 = 
sub£t_•s
->
•s
.separate_colour_plane_flag;

652 if–
p_Vid
->
£∑øã_cﬁour_∂™e_Êag
 )

654 
p_Vid
->
ChromaAºayTy≥
 = 0;

658 
p_Vid
->
ChromaAºayTy≥
 = 
sub£t_•s
->
•s
.
chroma_f‹m©_idc
;

662 
	`FªeP¨tôi⁄
 (
dp
, 1);

663 
	}
}

666 
	$Pro˚ssPPS
 (
VideoP¨amëîs
 *
p_Vid
, 
NALU_t
 *
«lu
)

668 
D©aP¨tôi⁄
 *
dp
 = 
	`AŒocP¨tôi⁄
(1);

669 
pic_∑ømëî_£t_rb•_t
 *
µs
 = 
	`AŒocPPS
();

671 
	`mem˝y
 (
dp
->
bô°ªam
->
°ªamBuf„r
, &
«lu
->
buf
[1],ÇÆu->
Àn
-1);

672 
dp
->
bô°ªam
->
code_Àn
 = dp->bô°ªam->
bô°ªam_Àngth
 = 
	`RBSPtoSODB
 (dp->bô°ªam->
°ªamBuf„r
, 
«lu
->
Àn
-1);

673 
dp
->
bô°ªam
->
ei_Êag
 = 0;

674 
dp
->
bô°ªam
->
ªad_Àn
 = dp->bô°ªam->
‰ame_bôoff£t
 = 0;

675 
	`I¡î¥ëPPS
 (
p_Vid
, 
dp
, 
µs
);

677 i‡(
p_Vid
->
a˘ive_µs
)

679 i‡(
µs
->
pic_∑ømëî_£t_id
 =
p_Vid
->
a˘ive_µs
->pic_parameter_set_id)

681 if(!
	`µs_is_equÆ
(
µs
, 
p_Vid
->
a˘ive_µs
))

684 
	`mem˝y
(
p_Vid
->
pNextPPS
,Ö_Vid->
a˘ive_µs
,  (
pic_∑ømëî_£t_rb•_t
));

686 i‡(
p_Vid
->
dec_pi˘uª
)

689 
	`exô_pi˘uª
(
p_Vid
, &p_Vid->
dec_pi˘uª
);

691 
p_Vid
->
a˘ive_µs
 = 
NULL
;

696 
	`MakePPSavaûabÀ
 (
p_Vid
, 
µs
->
pic_∑ømëî_£t_id
,Öps);

697 
	`FªeP¨tôi⁄
 (
dp
, 1);

698 
	`FªePPS
 (
µs
);

699 
	}
}

708 
	$upd©eMaxVÆue
(
FømeF‹m©
 *
f‹m©
)

710 
f‹m©
->
max_vÆue
[0] = (1 << f‹m©->
bô_dïth
[0]) - 1;

711 
f‹m©
->
max_vÆue_sq
[0] = f‹m©->
max_vÆue
[0] * format->max_value[0];

712 
f‹m©
->
max_vÆue
[1] = (1 << f‹m©->
bô_dïth
[1]) - 1;

713 
f‹m©
->
max_vÆue_sq
[1] = f‹m©->
max_vÆue
[1] * format->max_value[1];

714 
f‹m©
->
max_vÆue
[2] = (1 << f‹m©->
bô_dïth
[2]) - 1;

715 
f‹m©
->
max_vÆue_sq
[2] = f‹m©->
max_vÆue
[2] * format->max_value[2];

716 
	}
}

725 
	$ª£t_f‹m©_öfo
(
£q_∑ømëî_£t_rb•_t
 *
•s
, 
VideoP¨amëîs
 *
p_Vid
, 
FømeF‹m©
 *
sour˚
, FømeF‹m© *
ouçut
)

727 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

728 c⁄° 
SubWidthC
 [4]= { 1, 2, 2, 1};

729 c⁄° 
SubHeightC
 [4]= { 1, 2, 1, 1};

731 
¸›_À·
, 
¸›_right
;

732 
¸›_t›
, 
¸›_bŸtom
;

735 i‡(
•s
->
‰ame_¸›pög_Êag
)

737 
¸›_À·
 = 
SubWidthC
 [
•s
->
chroma_f‹m©_idc
] * sps->
‰ame_¸›_À·_off£t
;

738 
¸›_right
 = 
SubWidthC
 [
•s
->
chroma_f‹m©_idc
] * sps->
‰ame_¸›_right_off£t
;

739 
¸›_t›
 = 
SubHeightC
[
•s
->
chroma_f‹m©_idc
] * ( 2 - sps->
‰ame_mbs_⁄ly_Êag
 ) * sps->
‰ame_¸›_t›_off£t
;

740 
¸›_bŸtom
 = 
SubHeightC
[
•s
->
chroma_f‹m©_idc
] * ( 2 - sps->
‰ame_mbs_⁄ly_Êag
 ) * sps->
‰ame_¸›_bŸtom_off£t
;

744 
¸›_À·
 = 
¸›_right
 = 
¸›_t›
 = 
¸›_bŸtom
 = 0;

747 
sour˚
->
width
[0] = 
p_Vid
->width - 
¸›_À·
 - 
¸›_right
;

748 
sour˚
->
height
[0] = 
p_Vid
->heighà- 
¸›_t›
 - 
¸›_bŸtom
;

751 i‡(
•s
->
‰ame_¸›pög_Êag
)

753 
¸›_À·
 = 
•s
->
‰ame_¸›_À·_off£t
;

754 
¸›_right
 = 
•s
->
‰ame_¸›_right_off£t
;

755 
¸›_t›
 = ( 2 - 
•s
->
‰ame_mbs_⁄ly_Êag
 ) * sps->
‰ame_¸›_t›_off£t
;

756 
¸›_bŸtom
 = ( 2 - 
•s
->
‰ame_mbs_⁄ly_Êag
 ) * sps->
‰ame_¸›_bŸtom_off£t
;

760 
¸›_À·
 = 
¸›_right
 = 
¸›_t›
 = 
¸›_bŸtom
 = 0;

763 i‡((
•s
->
chroma_f‹m©_idc
==
YUV400
Ë&& 
p_I≈
->
wrôe_uv
)

765 
sour˚
->
width
[1] = (source->width[0] >> 1);

766 
sour˚
->
width
[2] = source->width[1];

767 
sour˚
->
height
[1] = (source->height[0] >> 1);

768 
sour˚
->
height
[2] = source->height[1];

772 
sour˚
->
width
[1] = 
p_Vid
->
width_¸
 - 
¸›_À·
 - 
¸›_right
;

773 
sour˚
->
width
[2] = source->width[1];

774 
sour˚
->
height
[1] = 
p_Vid
->
height_¸
 - 
¸›_t›
 - 
¸›_bŸtom
;

775 
sour˚
->
height
[2] = source->height[1];

778 
ouçut
->
width
[0] = 
p_Vid
->width;

779 
sour˚
->
width
[1] = 
p_Vid
->
width_¸
;

780 
sour˚
->
width
[2] = 
p_Vid
->
width_¸
;

781 
ouçut
->
height
[0] = 
p_Vid
->height;

782 
ouçut
->
height
[1] = 
p_Vid
->
height_¸
;

783 
ouçut
->
height
[2] = 
p_Vid
->
height_¸
;

785 
sour˚
->
size_cmp
[0] = sour˚->
width
[0] * sour˚->
height
[0];

786 
sour˚
->
size_cmp
[1] = sour˚->
width
[1] * sour˚->
height
[1];

787 
sour˚
->
size_cmp
[2] = source->size_cmp[1];

788 
sour˚
->
size
 = sour˚->
size_cmp
[0] + source->size_cmp[1] + source->size_cmp[2];

789 
sour˚
->
mb_width
 = sour˚->
width
[0] / 
MB_BLOCK_SIZE
;

790 
sour˚
->
mb_height
 = sour˚->
height
[0] / 
MB_BLOCK_SIZE
;

793 
ouçut
->
size_cmp
[0] = ouçut->
width
[0] * ouçut->
height
[0];

794 
ouçut
->
size_cmp
[1] = ouçut->
width
[1] * ouçut->
height
[1];

795 
ouçut
->
size_cmp
[2] = output->size_cmp[1];

796 
ouçut
->
size
 = ouçut->
size_cmp
[0] + output->size_cmp[1] + output->size_cmp[2];

797 
ouçut
->
mb_width
 = ouçut->
width
[0] / 
MB_BLOCK_SIZE
;

798 
ouçut
->
mb_height
 = ouçut->
height
[0] / 
MB_BLOCK_SIZE
;

801 
ouçut
->
bô_dïth
[0] = 
sour˚
->bô_dïth[0] = 
p_Vid
->
bôdïth_luma
;

802 
ouçut
->
bô_dïth
[1] = 
sour˚
->bô_dïth[1] = 
p_Vid
->
bôdïth_chroma
;

803 
ouçut
->
bô_dïth
[2] = 
sour˚
->bô_dïth[2] = 
p_Vid
->
bôdïth_chroma
;

804 
ouçut
->
pic_unô_size_⁄_disk
 = (
	`imax
(ouçut->
bô_dïth
[0], output->bit_depth[1]) > 8) ? 16 : 8;

805 
ouçut
->
pic_unô_size_shi·3
 = ouçut->
pic_unô_size_⁄_disk
 >> 3;

807 
ouçut
->
‰ame_øã
 = 
sour˚
->frame_rate;

808 
ouçut
->
cﬁ‹_modñ
 = 
sour˚
->color_model;

809 
ouçut
->
yuv_f‹m©
 = 
sour˚
->yuv_f‹m© = (
Cﬁ‹F‹m©
Ë
•s
->
chroma_f‹m©_idc
;

811 
ouçut
->
auto_¸›_bŸtom
 = 
¸›_bŸtom
;

812 
ouçut
->
auto_¸›_right
 = 
¸›_right
;

813 
ouçut
->
auto_¸›_bŸtom_¸
 = (
¸›_bŸtom
 * 
p_Vid
->
mb_¸_size_y
Ë/ 
MB_BLOCK_SIZE
;

814 
ouçut
->
auto_¸›_right_¸
 = (
¸›_right
 * 
p_Vid
->
mb_¸_size_x
Ë/ 
MB_BLOCK_SIZE
;

816 
sour˚
->
auto_¸›_bŸtom
 = 
ouçut
->auto_crop_bottom;

817 
sour˚
->
auto_¸›_right
 = 
ouçut
->auto_crop_right;

818 
sour˚
->
auto_¸›_bŸtom_¸
 = 
ouçut
->auto_crop_bottom_cr;

819 
sour˚
->
auto_¸›_right_¸
 = 
ouçut
->auto_crop_right_cr;

821 
	`upd©eMaxVÆue
(
sour˚
);

822 
	`upd©eMaxVÆue
(
ouçut
);

824 i‡(
p_Vid
->
fú°_•s
 =
TRUE
) {

825 
p_Vid
->
fú°_•s
 = 
FALSE
;

826 if(!
p_I≈
->
bDi•œyDecP¨ams
) {

827 
	`Ârötf
(
°dout
,"ProfûêIDC : %d\n", 
•s
->
¥ofûe_idc
);

828 
	`Ârötf
(
°dout
,"ImagêF‹m© : %dx%d (%dx%d)\n", 
sour˚
->
width
[0], sour˚->
height
[0], 
p_Vid
->width,Ö_Vid->height);

829 i‡(
p_Vid
->
yuv_f‹m©
 =
YUV400
)

830 
	`Ârötf
(
°dout
,"Color Format : 4:0:0 ");

831 i‡(
p_Vid
->
yuv_f‹m©
 =
YUV420
)

832 
	`Ârötf
(
°dout
,"Color Format : 4:2:0 ");

833 i‡(
p_Vid
->
yuv_f‹m©
 =
YUV422
)

834 
	`Ârötf
(
°dout
,"Color Format : 4:2:2 ");

836 
	`Ârötf
(
°dout
,"Color Format : 4:4:4 ");

838 
	`Ârötf
(
°dout
,"(%d:%d:%d)\n", 
sour˚
->
bô_dïth
[0], source->bit_depth[1], source->bit_depth[2]);

839 
	`Ârötf
(
°dout
,"--------------------------------------------------------------------------\n");

841 i‡(!
p_I≈
->
sûít
)

843 
	`Ârötf
(
°dout
,"POC must = frame# or field# for SNRsÅo be correct\n");

844 
	`Ârötf
(
°dout
,"--------------------------------------------------------------------------\n");

845 
	`Ârötf
(
°dout
," Frame POC Pic# QP SnrY SnrU SnrV Y:U:V Time(ms)\n");

846 
	`Ârötf
(
°dout
,"--------------------------------------------------------------------------\n");

849 
	}
}

851 
	$£tup_œyî_öfo
(
VideoP¨amëîs
 *
p_Vid
, 
£q_∑ømëî_£t_rb•_t
 *
•s
, 
LayîP¨amëîs
 *
p_Lps
)

853 
œyî_id
 = 
p_Lps
->layer_id;

854 
p_Lps
->
p_Vid
 =Ö_Vid;

855 
p_Lps
->
p_Cps
 = 
p_Vid
->
p_EncodeP¨
[
œyî_id
];

856 
p_Lps
->
p_SPS
 = 
•s
;

857 
p_Lps
->
p_Dpb
 = 
p_Vid
->
p_Dpb_œyî
[
œyî_id
];

858 
	}
}

860 
	$£t_codög_∑r
(
£q_∑ømëî_£t_rb•_t
 *
•s
, 
CodögP¨amëîs
 *
˝s
)

863 
˝s
->
¥ofûe_idc
 = 
•s
->profile_idc;

864 
˝s
->
los¶ess_qµrime_Êag
 = 
•s
->lossless_qpprime_flag;

865 i‡(
•s
->
Àvñ_idc
 <= 10)

867 
˝s
->
max_vmv_r
 = 64 * 4;

869 i‡(
•s
->
Àvñ_idc
 <= 20)

871 
˝s
->
max_vmv_r
 = 128 * 4;

873 i‡(
•s
->
Àvñ_idc
 <= 30)

875 
˝s
->
max_vmv_r
 = 256 * 4;

879 
˝s
->
max_vmv_r
 = 512 * 4;

883 
˝s
->
bôdïth_chroma
 = 0;

884 
˝s
->
width_¸
 = 0;

885 
˝s
->
height_¸
 = 0;

886 
˝s
->
bôdïth_luma
 = (Ë(
•s
->
bô_dïth_luma_möus8
 + 8);

887 
˝s
->
bôdïth_sˇÀ
[0] = 1 << 
•s
->
bô_dïth_luma_möus8
;

888 i‡(
•s
->
chroma_f‹m©_idc
 !
YUV400
)

890 
˝s
->
bôdïth_chroma
 = (Ë(
•s
->
bô_dïth_chroma_möus8
 + 8);

891 
˝s
->
bôdïth_sˇÀ
[1] = 1 << 
•s
->
bô_dïth_chroma_möus8
;

894 
˝s
->
max_‰ame_num
 = 1<<(
•s
->
log2_max_‰ame_num_möus4
+4);

895 
˝s
->
PicWidthInMbs
 = (
•s
->
pic_width_ö_mbs_möus1
 +1);

896 
˝s
->
PicHeightInM≠Unôs
 = (
•s
->
pic_height_ö_m≠_unôs_möus1
 +1);

897 
˝s
->
FømeHeightInMbs
 = ( 2 - 
•s
->
‰ame_mbs_⁄ly_Êag
 ) * cps->
PicHeightInM≠Unôs
;

898 
˝s
->
FømeSizeInMbs
 = cps->
PicWidthInMbs
 * cps->
FømeHeightInMbs
;

900 
˝s
->
yuv_f‹m©
=
•s
->
chroma_f‹m©_idc
;

901 
˝s
->
£∑øã_cﬁour_∂™e_Êag
 = 
•s
->separate_colour_plane_flag;

902 if–
˝s
->
£∑øã_cﬁour_∂™e_Êag
 )

904 
˝s
->
ChromaAºayTy≥
 = 0;

908 
˝s
->
ChromaAºayTy≥
 = 
•s
->
chroma_f‹m©_idc
;

911 
˝s
->
width
 = cps->
PicWidthInMbs
 * 
MB_BLOCK_SIZE
;

912 
˝s
->
height
 = cps->
FømeHeightInMbs
 * 
MB_BLOCK_SIZE
;

914 
˝s
->
iLumaPadX
 = 
MCBUF_LUMA_PAD_X
;

915 
˝s
->
iLumaPadY
 = 
MCBUF_LUMA_PAD_Y
;

916 
˝s
->
iChromaPadX
 = 
MCBUF_CHROMA_PAD_X
;

917 
˝s
->
iChromaPadY
 = 
MCBUF_CHROMA_PAD_Y
;

918 i‡(
•s
->
chroma_f‹m©_idc
 =
YUV420
)

920 
˝s
->
width_¸
 = (˝s->
width
 >> 1);

921 
˝s
->
height_¸
 = (˝s->
height
 >> 1);

923 i‡(
•s
->
chroma_f‹m©_idc
 =
YUV422
)

925 
˝s
->
width_¸
 = (˝s->
width
 >> 1);

926 
˝s
->
height_¸
 = cps->
height
;

927 
˝s
->
iChromaPadY
 = 
MCBUF_CHROMA_PAD_Y
*2;

929 i‡(
•s
->
chroma_f‹m©_idc
 =
YUV444
)

932 
˝s
->
width_¸
 = cps->
width
;

933 
˝s
->
height_¸
 = cps->
height
;

934 
˝s
->
iChromaPadX
 = cps->
iLumaPadX
;

935 
˝s
->
iChromaPadY
 = cps->
iLumaPadY
;

938 
˝s
->
bôdïth_luma_qp_sˇÀ
 = 6 * (˝s->
bôdïth_luma
 - 8);

940 if(
˝s
->
bôdïth_luma
 > cps->
bôdïth_chroma
 || 
•s
->
chroma_f‹m©_idc
 =
YUV400
)

941 
˝s
->
pic_unô_bôsize_⁄_disk
 = (˝s->
bôdïth_luma
 > 8)? 16:8;

943 
˝s
->
pic_unô_bôsize_⁄_disk
 = (˝s->
bôdïth_chroma
 > 8)? 16:8;

944 
˝s
->
dc_¥ed_vÆue_comp
[0] = 1<<(˝s->
bôdïth_luma
 - 1);

945 
˝s
->
max_≥l_vÆue_comp
[0] = (1<<˝s->
bôdïth_luma
) - 1;

946 
˝s
->
mb_size
[0][0] = cps->mb_size[0][1] = 
MB_BLOCK_SIZE
;

948 i‡(
•s
->
chroma_f‹m©_idc
 !
YUV400
)

951 
˝s
->
bôdïth_chroma_qp_sˇÀ
 = 6 * (˝s->
bôdïth_chroma
 - 8);

952 
˝s
->
dc_¥ed_vÆue_comp
[1] = (1 << (˝s->
bôdïth_chroma
 - 1));

953 
˝s
->
dc_¥ed_vÆue_comp
[2] = cps->dc_pred_value_comp[1];

954 
˝s
->
max_≥l_vÆue_comp
[1] = (1 << cps->
bôdïth_chroma
) - 1;

955 
˝s
->
max_≥l_vÆue_comp
[2] = (1 << cps->
bôdïth_chroma
) - 1;

956 
˝s
->
num_blk8x8_uv
 = (1 << 
•s
->
chroma_f‹m©_idc
) & (~(0x1));

957 
˝s
->
num_uv_blocks
 = (˝s->
num_blk8x8_uv
 >> 1);

958 
˝s
->
num_cdc_c€ff
 = (˝s->
num_blk8x8_uv
 << 1);

959 
˝s
->
mb_size
[1][0] = cps->mb_size[2][0] = cps->
mb_¸_size_x
 = (
•s
->
chroma_f‹m©_idc
==
YUV420
 || sps->chroma_f‹m©_idc==
YUV422
)? 8 : 16;

960 
˝s
->
mb_size
[1][1] = cps->mb_size[2][1] = cps->
mb_¸_size_y
 = (
•s
->
chroma_f‹m©_idc
==
YUV444
 || sps->chroma_f‹m©_idc==
YUV422
)? 16 : 8;

962 
˝s
->
sub≥l_x
 = cps->
mb_¸_size_x
 == 8 ? 7 : 3;

963 
˝s
->
sub≥l_y
 = cps->
mb_¸_size_y
 == 8 ? 7 : 3;

964 
˝s
->
shi·≥l_x
 = cps->
mb_¸_size_x
 == 8 ? 3 : 2;

965 
˝s
->
shi·≥l_y
 = cps->
mb_¸_size_y
 == 8 ? 3 : 2;

966 
˝s
->
tŸÆ_sˇÀ
 = cps->
shi·≥l_x
 + cps->
shi·≥l_y
;

970 
˝s
->
bôdïth_chroma_qp_sˇÀ
 = 0;

971 
˝s
->
max_≥l_vÆue_comp
[1] = 0;

972 
˝s
->
max_≥l_vÆue_comp
[2] = 0;

973 
˝s
->
num_blk8x8_uv
 = 0;

974 
˝s
->
num_uv_blocks
 = 0;

975 
˝s
->
num_cdc_c€ff
 = 0;

976 
˝s
->
mb_size
[1][0] = cps->mb_size[2][0] = cps->
mb_¸_size_x
 = 0;

977 
˝s
->
mb_size
[1][1] = cps->mb_size[2][1] = cps->
mb_¸_size_y
 = 0;

978 
˝s
->
sub≥l_x
 = 0;

979 
˝s
->
sub≥l_y
 = 0;

980 
˝s
->
shi·≥l_x
 = 0;

981 
˝s
->
shi·≥l_y
 = 0;

982 
˝s
->
tŸÆ_sˇÀ
 = 0;

985 
˝s
->
mb_¸_size
 = cps->
mb_¸_size_x
 * cps->
mb_¸_size_y
;

986 
˝s
->
mb_size_blk
[0][0] = cps->mb_size_blk[0][1] = cps->
mb_size
[0][0] >> 2;

987 
˝s
->
mb_size_blk
[1][0] = cps->mb_size_blk[2][0] = cps->
mb_size
[1][0] >> 2;

988 
˝s
->
mb_size_blk
[1][1] = cps->mb_size_blk[2][1] = cps->
mb_size
[1][1] >> 2;

990 
˝s
->
mb_size_shi·
[0][0] = cps->mb_size_shi·[0][1] = 
	`CeûLog2_sf
 (˝s->
mb_size
[0][0]);

991 
˝s
->
mb_size_shi·
[1][0] = cps->mb_size_shi·[2][0] = 
	`CeûLog2_sf
 (˝s->
mb_size
[1][0]);

992 
˝s
->
mb_size_shi·
[1][1] = cps->mb_size_shi·[2][1] = 
	`CeûLog2_sf
 (˝s->
mb_size
[1][1]);

994 
˝s
->
rgb_ouçut
 = (
•s
->
vui_£q_∑ømëîs
.
m©rix_c€fficõ¡s
==0);

995 
	}
}

1004 
	$a˘iv©e_•s
 (
VideoP¨amëîs
 *
p_Vid
, 
£q_∑ømëî_£t_rb•_t
 *
•s
)

1006 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

1008 i‡(
p_Vid
->
a˘ive_•s
 !
•s
)

1010 i‡(
p_Vid
->
dec_pi˘uª
)

1013 
	`exô_pi˘uª
(
p_Vid
, &p_Vid->
dec_pi˘uª
);

1015 
p_Vid
->
a˘ive_•s
 = 
•s
;

1017 if(
p_Vid
->
dpb_œyî_id
==0 && 
	`is_BL_¥ofûe
(
•s
->
¥ofûe_idc
Ë&& !p_Vid->
p_Dpb_œyî
[0]->
öô_d⁄e
)

1019 
	`£t_codög_∑r
(
•s
, 
p_Vid
->
p_EncodeP¨
[0]);

1020 
	`£tup_œyî_öfo
–
p_Vid
, 
•s
,Ö_Vid->
p_LayîP¨
[0]);

1022 if(
p_Vid
->
dpb_œyî_id
==1 && 
	`is_EL_¥ofûe
(
•s
->
¥ofûe_idc
Ë&& !p_Vid->
p_Dpb_œyî
[1]->
öô_d⁄e
)

1024 
	`£t_codög_∑r
(
•s
, 
p_Vid
->
p_EncodeP¨
[1]);

1025 
	`£tup_œyî_öfo
(
p_Vid
, 
•s
,Ö_Vid->
p_LayîP¨
[1]);

1029 
	`£t_globÆ_codög_∑r
(
p_Vid
,Ö_Vid->
p_EncodeP¨
[p_Vid->
dpb_œyî_id
]);

1032 #i‡(
MVC_EXTENSION_ENABLE
)

1037  (
p_Vid
->
œ°_¥ofûe_idc
 !p_Vid->
a˘ive_•s
->
¥ofûe_idc
 && 
	`is_BL_¥ofûe
’_Vid->a˘ive_•s->¥ofûe_idcË&& !p_Vid->
p_Dpb_œyî
[0]->
öô_d⁄e
 ))

1040 
	`öô_globÆ_buf„rs
(
p_Vid
, 0);

1042 i‡(!
p_Vid
->
no_ouçut_of_¥i‹_pics_Êag
)

1044 
	`Êush_dpb
(
p_Vid
->
p_Dpb_œyî
[0]);

1045 
	`Êush_dpb
(
p_Vid
->
p_Dpb_œyî
[1]);

1047 
	`öô_dpb
(
p_Vid
,Ö_Vid->
p_Dpb_œyî
[0], 1);

1049 if(
p_Vid
->
œ°_¥ofûe_idc
 !p_Vid->
a˘ive_•s
->
¥ofûe_idc
 && (

1050 
	`is_MVC_¥ofûe
(
p_Vid
->
œ°_¥ofûe_idc
Ë|| is_MVC_¥ofûe’_Vid->
a˘ive_•s
->
¥ofûe_idc
)

1051 )&& (!
p_Vid
->
p_Dpb_œyî
[1]->
öô_d⁄e
))

1053 
	`as£π
(
p_Vid
->
p_Dpb_œyî
[0]->
öô_d⁄e
);

1055 if(
p_Vid
->
p_Dpb_œyî
[0]->
öô_d⁄e
)

1057 
	`‰ì_dpb
(
p_Vid
->
p_Dpb_œyî
[0]);

1058 
	`öô_dpb
(
p_Vid
,Ö_Vid->
p_Dpb_œyî
[0], 1);

1060 
	`öô_globÆ_buf„rs
(
p_Vid
, 1);

1064 #i‡
MVC_EXTENSION_ENABLE


1065 
	`öô_dpb
(
p_Vid
,Ö_Vid->
p_Dpb_œyî
[1], 2);

1071 
p_Vid
->
œ°_pic_width_ö_mbs_möus1
 =Ö_Vid->
a˘ive_•s
->
pic_width_ö_mbs_möus1
;

1072 
p_Vid
->
œ°_pic_height_ö_m≠_unôs_möus1
 =Ö_Vid->
a˘ive_•s
->
pic_height_ö_m≠_unôs_möus1
;

1073 
p_Vid
->
œ°_max_dec_‰ame_buf„rög
 = 
	`GëMaxDecFømeBuf„rög
(p_Vid);

1074 
p_Vid
->
œ°_¥ofûe_idc
 =Ö_Vid->
a˘ive_•s
->
¥ofûe_idc
;

1078 
	`öô_globÆ_buf„rs
(
p_Vid
, 0);

1080 i‡(!
p_Vid
->
no_ouçut_of_¥i‹_pics_Êag
)

1082 
	`Êush_dpb
(
p_Vid
->
p_Dpb_œyî
[0]);

1084 
	`öô_dpb
(
p_Vid
,Ö_Vid->
p_Dpb_œyî
[0], 0);

1091 #i‡(
DISABLE_ERC
 == 0)

1092 
	`îcInô
(
p_Vid
,Ö_Vid->
width
,Ö_Vid->
height
, 1);

1093 if(
p_Vid
->
dec_pi˘uª
)

1095 
	`îcRe£t
(
p_Vid
->
îc_îr‹V¨
,Ö_Vid->
PicSizeInMbs
,Ö_Vid->PicSizeInMbs,Ö_Vid->
dec_pi˘uª
->
size_x
);

1096 
p_Vid
->
îc_mv≥rMB
 = 0;

1101 
	`ª£t_f‹m©_öfo
(
•s
, 
p_Vid
, &
p_I≈
->
sour˚
, &p_I≈->
ouçut
);

1102 
	}
}

1104 
	$a˘iv©e_µs
(
VideoP¨amëîs
 *
p_Vid
, 
pic_∑ømëî_£t_rb•_t
 *
µs
)

1106 i‡(
p_Vid
->
a˘ive_µs
 !
µs
)

1108 i‡(
p_Vid
->
dec_pi˘uª
)

1111 
	`exô_pi˘uª
(
p_Vid
, &p_Vid->
dec_pi˘uª
);

1114 
p_Vid
->
a˘ive_µs
 = 
µs
;

1116 
	}
}

1118 
	$U£P¨amëîSë
 (
Sli˚
 *
cuºSli˚
)

1120 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

1121 
PicP¨£tId
 = 
cuºSli˚
->
pic_∑ømëî_£t_id
;

1122 
pic_∑ømëî_£t_rb•_t
 *
µs
 = &
p_Vid
->
PicP¨Së
[
PicP¨£tId
];

1123 
£q_∑ømëî_£t_rb•_t
 *
•s
 = &
p_Vid
->
SeqP¨Së
[
µs
->
£q_∑ømëî_£t_id
];

1124 
i
;

1126 i‡(
µs
->
VÆid
 !
TRUE
)

1127 
	`¥ötf
 ("TryögÅÿu£á¿övÆid (unöôülizedËPi˘uª P¨amëî Së wôh ID %d,Éx≥˘Åhêu√x≥˘ed...\n", 
PicP¨£tId
);

1128 #i‡(
MVC_EXTENSION_ENABLE
)

1129 i‡(
cuºSli˚
->
svc_exãnsi⁄_Êag
 == -1)

1131 i‡(
•s
->
VÆid
 !
TRUE
)

1132 
	`¥ötf
 ("PicParset %dÑeferencesán invalid (uninitialized) Sequence Parameter Set with ID %d,ÉxpectÅhe unexpected...\n",

1133 
PicP¨£tId
, (Ë
µs
->
£q_∑ømëî_£t_id
);

1138 
p_Vid
->
a˘ive_sub£t_•s
 =Ö_Vid->
Sub£tSeqP¨Së
 + 
µs
->
£q_∑ømëî_£t_id
;

1139 
•s
 = &(
p_Vid
->
a˘ive_sub£t_•s
->sps);

1140 i‡(
p_Vid
->
Sub£tSeqP¨Së
[
µs
->
£q_∑ømëî_£t_id
].
VÆid
 !
TRUE
)

1141 
	`¥ötf
 ("PicParset %dÑeferencesán invalid (uninitialized) Subset Sequence Parameter Set with ID %d,ÉxpectÅhe unexpected...\n",

1142 
PicP¨£tId
, (Ë
µs
->
£q_∑ømëî_£t_id
);

1145 i‡(
•s
->
VÆid
 !
TRUE
)

1146 
	`¥ötf
 ("PicParset %dÑeferencesán invalid (uninitialized) Sequence Parameter Set with ID %d,ÉxpectÅhe unexpected...\n",

1147 
PicP¨£tId
, (Ë
µs
->
£q_∑ømëî_£t_id
);

1156 i‡((Ë
•s
->
pic_‹dî_˙t_ty≥
 < 0 || sps->pic_order_cnt_type > 2)

1158 
	`¥ötf
 ("övÆid sps->pic_‹dî_˙t_ty≥ = %d\n", (Ë
•s
->
pic_‹dî_˙t_ty≥
);

1159 
	`îr‹
 ("pic_order_cnt_type != 1", -1000);

1162 i‡(
•s
->
pic_‹dî_˙t_ty≥
 == 1)

1164 if(
•s
->
num_ªf_‰ames_ö_pic_‹dî_˙t_cy˛e
 >
MAXnum_ªf_‰ames_ö_pic_‹dî_˙t_cy˛e
)

1166 
	`îr‹
("num_ref_frames_in_pic_order_cnt_cycleÅooÜarge",-1011);

1169 
p_Vid
->
dpb_œyî_id
 = 
cuºSli˚
->
œyî_id
;

1170 
	`a˘iv©e_•s
(
p_Vid
, 
•s
);

1171 
	`a˘iv©e_µs
(
p_Vid
, 
µs
);

1174 i‡(
µs
->
íå›y_codög_mode_Êag
 =(
Boﬁón
Ë
CAVLC
)

1176 
cuºSli˚
->
«l_°¨tcode_fﬁlows
 = 
uvlc_°¨tcode_fﬁlows
;

1177 
i
=0; i<3; i++)

1179 
cuºSli˚
->
∑πAº
[
i
].
ªadSy¡axEÀmít
 = 
ªadSy¡axEÀmít_UVLC
;

1184 
cuºSli˚
->
«l_°¨tcode_fﬁlows
 = 
ˇbac_°¨tcode_fﬁlows
;

1185 
i
=0; i<3; i++)

1187 
cuºSli˚
->
∑πAº
[
i
].
ªadSy¡axEÀmít
 = 
ªadSy¡axEÀmít_CABAC
;

1190 
p_Vid
->
ty≥
 = 
cuºSli˚
->
¶i˚_ty≥
;

1191 
	}
}

1193 #i‡(
MVC_EXTENSION_ENABLE
)

1194 
	$£q_∑ømëî_£t_mvc_exãnsi⁄
(
sub£t_£q_∑ømëî_£t_rb•_t
 *
sub£t_•s
, 
Bô°ªam
 *
s
)

1196 
i
, 
j
, 
num_võws
;

1198 
sub£t_•s
->
num_võws_möus1
 = 
	`ªad_ue_v
("num_võws_möus1", 
s
, &
p_Dec
->
U£dBôs
);

1199 
num_võws
 = 1+
sub£t_•s
->
num_võws_möus1
;

1200 if–
num_võws
 >0)

1202 i‡((
sub£t_•s
->
võw_id
 = (*Ë
	`ˇŒoc
(
num_võws
, ())Ë=
NULL
)

1203 
	`no_mem_exô
("init_subset_seq_parameter_set: subset_sps->view_id");

1204 i‡((
sub£t_•s
->
num_™ch‹_ªfs_l0
 = (*Ë
	`ˇŒoc
(
num_võws
, ())Ë=
NULL
)

1205 
	`no_mem_exô
("init_subset_seq_parameter_set: subset_sps->num_anchor_refs_l0");

1206 i‡((
sub£t_•s
->
num_™ch‹_ªfs_l1
 = (*Ë
	`ˇŒoc
(
num_võws
, ())Ë=
NULL
)

1207 
	`no_mem_exô
("init_subset_seq_parameter_set: subset_sps->num_anchor_refs_l1");

1208 i‡((
sub£t_•s
->
™ch‹_ªf_l0
 = (**Ë
	`ˇŒoc
(
num_võws
, (*))Ë=
NULL
)

1209 
	`no_mem_exô
("init_subset_seq_parameter_set: subset_sps->anchor_ref_l0");

1210 i‡((
sub£t_•s
->
™ch‹_ªf_l1
 = (**Ë
	`ˇŒoc
(
num_võws
, (*))Ë=
NULL
)

1211 
	`no_mem_exô
("init_subset_seq_parameter_set: subset_sps->anchor_ref_l1");

1212 i‡((
sub£t_•s
->
num_n⁄_™ch‹_ªfs_l0
 = (*Ë
	`ˇŒoc
(
num_võws
, ())Ë=
NULL
)

1213 
	`no_mem_exô
("init_subset_seq_parameter_set: subset_sps->num_non_anchor_refs_l0");

1214 i‡((
sub£t_•s
->
num_n⁄_™ch‹_ªfs_l1
 = (*Ë
	`ˇŒoc
(
num_võws
, ())Ë=
NULL
)

1215 
	`no_mem_exô
("init_subset_seq_parameter_set: subset_sps->num_non_anchor_refs_l1");

1216 i‡((
sub£t_•s
->
n⁄_™ch‹_ªf_l0
 = (**Ë
	`ˇŒoc
(
num_võws
, (*))Ë=
NULL
)

1217 
	`no_mem_exô
("init_subset_seq_parameter_set: subset_sps->non_anchor_ref_l0");

1218 i‡((
sub£t_•s
->
n⁄_™ch‹_ªf_l1
 = (**Ë
	`ˇŒoc
(
num_võws
, (*))Ë=
NULL
)

1219 
	`no_mem_exô
("init_subset_seq_parameter_set: subset_sps->non_anchor_ref_l1");

1221 
i
=0; i<
num_võws
; i++)

1223 
sub£t_•s
->
võw_id
[
i
] = 
	`ªad_ue_v
("võw_id", 
s
, &
p_Dec
->
U£dBôs
);

1225 
i
=1; i<
num_võws
; i++)

1227 
sub£t_•s
->
num_™ch‹_ªfs_l0
[
i
] = 
	`ªad_ue_v
("num_™ch‹_ªfs_l0", 
s
, &
p_Dec
->
U£dBôs
);

1228 if(
sub£t_•s
->
num_™ch‹_ªfs_l0
[
i
]>0)

1230 i‡((
sub£t_•s
->
™ch‹_ªf_l0
[
i
] = (*Ë
	`ˇŒoc
(sub£t_•s->
num_™ch‹_ªfs_l0
[i], ())Ë=
NULL
)

1231 
	`no_mem_exô
("init_subset_seq_parameter_set: subset_sps->anchor_ref_l0[i]");

1232 
j
=0; j<
sub£t_•s
->
num_™ch‹_ªfs_l0
[
i
]; j++)

1233 
sub£t_•s
->
™ch‹_ªf_l0
[
i
][
j
] = 
	`ªad_ue_v
("™ch‹_ªf_l0", 
s
, &
p_Dec
->
U£dBôs
);

1236 
sub£t_•s
->
num_™ch‹_ªfs_l1
[
i
] = 
	`ªad_ue_v
("num_™ch‹_ªfs_l1", 
s
, &
p_Dec
->
U£dBôs
);

1237 if(
sub£t_•s
->
num_™ch‹_ªfs_l1
[
i
]>0)

1239 i‡((
sub£t_•s
->
™ch‹_ªf_l1
[
i
] = (*Ë
	`ˇŒoc
(sub£t_•s->
num_™ch‹_ªfs_l1
[i], ())Ë=
NULL
)

1240 
	`no_mem_exô
("init_subset_seq_parameter_set: subset_sps->anchor_ref_l1[i]");

1241 
j
=0; j<
sub£t_•s
->
num_™ch‹_ªfs_l1
[
i
]; j++)

1242 
sub£t_•s
->
™ch‹_ªf_l1
[
i
][
j
] = 
	`ªad_ue_v
("™ch‹_ªf_l1", 
s
, &
p_Dec
->
U£dBôs
);

1245 
i
=1; i<
num_võws
; i++)

1247 
sub£t_•s
->
num_n⁄_™ch‹_ªfs_l0
[
i
] = 
	`ªad_ue_v
("num_n⁄_™ch‹_ªfs_l0", 
s
, &
p_Dec
->
U£dBôs
);

1248 if(
sub£t_•s
->
num_n⁄_™ch‹_ªfs_l0
[
i
]>0)

1250 i‡((
sub£t_•s
->
n⁄_™ch‹_ªf_l0
[
i
] = (*Ë
	`ˇŒoc
(sub£t_•s->
num_n⁄_™ch‹_ªfs_l0
[i], ())Ë=
NULL
)

1251 
	`no_mem_exô
("init_subset_seq_parameter_set: subset_sps->non_anchor_ref_l0[i]");

1252 
j
=0; j<
sub£t_•s
->
num_n⁄_™ch‹_ªfs_l0
[
i
]; j++)

1253 
sub£t_•s
->
n⁄_™ch‹_ªf_l0
[
i
][
j
] = 
	`ªad_ue_v
("n⁄_™ch‹_ªf_l0", 
s
, &
p_Dec
->
U£dBôs
);

1255 
sub£t_•s
->
num_n⁄_™ch‹_ªfs_l1
[
i
] = 
	`ªad_ue_v
("num_n⁄_™ch‹_ªfs_l1", 
s
, &
p_Dec
->
U£dBôs
);

1256 if(
sub£t_•s
->
num_n⁄_™ch‹_ªfs_l1
[
i
]>0)

1258 i‡((
sub£t_•s
->
n⁄_™ch‹_ªf_l1
[
i
] = (*Ë
	`ˇŒoc
(sub£t_•s->
num_n⁄_™ch‹_ªfs_l1
[i], ())Ë=
NULL
)

1259 
	`no_mem_exô
("init_subset_seq_parameter_set: subset_sps->non_anchor_ref_l1[i]");

1260 
j
=0; j<
sub£t_•s
->
num_n⁄_™ch‹_ªfs_l1
[
i
]; j++)

1261 
sub£t_•s
->
n⁄_™ch‹_ªf_l1
[
i
][
j
] = 
	`ªad_ue_v
("n⁄_™ch‹_ªf_l1", 
s
, &
p_Dec
->
U£dBôs
);

1264 
sub£t_•s
->
num_Àvñ_vÆues_sig«Œed_möus1
 = 
	`ªad_ue_v
("num_Àvñ_vÆues_sig«Œed_möus1", 
s
, &
p_Dec
->
U£dBôs
);

1265 if(
sub£t_•s
->
num_Àvñ_vÆues_sig«Œed_möus1
 >=0)

1267 
i
 = 1+ 
sub£t_•s
->
num_Àvñ_vÆues_sig«Œed_möus1
;

1268 i‡((
sub£t_•s
->
Àvñ_idc
 = (*Ë
	`ˇŒoc
(
i
, ())Ë=
NULL
)

1269 
	`no_mem_exô
("init_subset_seq_parameter_set: subset_sps->level_idc");

1270 i‡((
sub£t_•s
->
num_≠∂iˇbÀ_›s_möus1
 = (*Ë
	`ˇŒoc
(
i
, ())Ë=
NULL
)

1271 
	`no_mem_exô
("init_subset_seq_parameter_set: subset_sps->num_applicable_ops_minus1");

1272 i‡((
sub£t_•s
->
≠∂iˇbÀ_›_ãmp‹Æ_id
 = (**Ë
	`ˇŒoc
(
i
, (*))Ë=
NULL
)

1273 
	`no_mem_exô
("init_subset_seq_parameter_set: subset_sps->applicable_op_temporal_id");

1274 i‡((
sub£t_•s
->
≠∂iˇbÀ_›_num_èrgë_võws_möus1
 = (**Ë
	`ˇŒoc
(
i
, (*))Ë=
NULL
)

1275 
	`no_mem_exô
("init_subset_seq_parameter_set: subset_sps->applicable_op_num_target_views_minus1");

1276 i‡((
sub£t_•s
->
≠∂iˇbÀ_›_èrgë_võw_id
 = (***Ë
	`ˇŒoc
(
i
, (**))Ë=
NULL
)

1277 
	`no_mem_exô
("init_subset_seq_parameter_set: subset_sps->applicable_op_target_view_id");

1278 i‡((
sub£t_•s
->
≠∂iˇbÀ_›_num_võws_möus1
 = (**Ë
	`ˇŒoc
(
i
, (*))Ë=
NULL
)

1279 
	`no_mem_exô
("init_subset_seq_parameter_set: subset_sps->applicable_op_num_views_minus1");

1281 
i
=0; i<=
sub£t_•s
->
num_Àvñ_vÆues_sig«Œed_möus1
; i++)

1283 
sub£t_•s
->
Àvñ_idc
[
i
] = 
	`ªad_u_v
(8, "Àvñ_idc", 
s
, &
p_Dec
->
U£dBôs
);

1284 
sub£t_•s
->
num_≠∂iˇbÀ_›s_möus1
[
i
] = 
	`ªad_ue_v
("num_≠∂iˇbÀ_›s_möus1", 
s
, &
p_Dec
->
U£dBôs
);

1285 if(
sub£t_•s
->
num_≠∂iˇbÀ_›s_möus1
[
i
]>=0)

1287 i‡((
sub£t_•s
->
≠∂iˇbÀ_›_ãmp‹Æ_id
[
i
] = (*Ë
	`ˇŒoc
(1+sub£t_•s->
num_≠∂iˇbÀ_›s_möus1
[i], ())Ë=
NULL
)

1288 
	`no_mem_exô
("init_subset_seq_parameter_set: subset_sps->applicable_op_temporal_id[i]");

1289 i‡((
sub£t_•s
->
≠∂iˇbÀ_›_num_èrgë_võws_möus1
[
i
] = (*Ë
	`ˇŒoc
(1+sub£t_•s->
num_≠∂iˇbÀ_›s_möus1
[i], ())Ë=
NULL
)

1290 
	`no_mem_exô
("init_subset_seq_parameter_set: subset_sps->applicable_op_num_target_views_minus1[i]");

1291 i‡((
sub£t_•s
->
≠∂iˇbÀ_›_èrgë_võw_id
[
i
] = (**Ë
	`ˇŒoc
(1+sub£t_•s->
num_≠∂iˇbÀ_›s_möus1
[i], (*))Ë=
NULL
)

1292 
	`no_mem_exô
("init_subset_seq_parameter_set: subset_sps->applicable_op_target_view_id[i]");

1293 i‡((
sub£t_•s
->
≠∂iˇbÀ_›_num_võws_möus1
[
i
] = (*Ë
	`ˇŒoc
(1+sub£t_•s->
num_≠∂iˇbÀ_›s_möus1
[i], ())Ë=
NULL
)

1294 
	`no_mem_exô
("init_subset_seq_parameter_set: subset_sps->applicable_op_num_views_minus1[i]");

1296 
j
=0; j<=
sub£t_•s
->
num_≠∂iˇbÀ_›s_möus1
[
i
]; j++)

1298 
k
;

1299 
sub£t_•s
->
≠∂iˇbÀ_›_ãmp‹Æ_id
[
i
][
j
] = 
	`ªad_u_v
(3, "≠∂iˇbÀ_›_ãmp‹Æ_id", 
s
, &
p_Dec
->
U£dBôs
);

1300 
sub£t_•s
->
≠∂iˇbÀ_›_num_èrgë_võws_möus1
[
i
][
j
] = 
	`ªad_ue_v
("≠∂iˇbÀ_›_num_èrgë_võws_möus1", 
s
, &
p_Dec
->
U£dBôs
);

1301 if(
sub£t_•s
->
≠∂iˇbÀ_›_num_èrgë_võws_möus1
[
i
][
j
]>=0)

1303 i‡((
sub£t_•s
->
≠∂iˇbÀ_›_èrgë_võw_id
[
i
][
j
] = (*Ë
	`ˇŒoc
(1+sub£t_•s->
≠∂iˇbÀ_›_num_èrgë_võws_möus1
[i][j], ())Ë=
NULL
)

1304 
	`no_mem_exô
("init_subset_seq_parameter_set: subset_sps->applicable_op_target_view_id[i][j]");

1305 
k
 = 0; k <
sub£t_•s
->
≠∂iˇbÀ_›_num_èrgë_võws_möus1
[
i
][
j
]; k++)

1306 
sub£t_•s
->
≠∂iˇbÀ_›_èrgë_võw_id
[
i
][
j
][
k
] = 
	`ªad_ue_v
("≠∂iˇbÀ_›_èrgë_võw_id", 
s
, &
p_Dec
->
U£dBôs
);

1308 
sub£t_•s
->
≠∂iˇbÀ_›_num_võws_möus1
[
i
][
j
] = 
	`ªad_ue_v
("≠∂iˇbÀ_›_num_võws_möus1", 
s
, &
p_Dec
->
U£dBôs
);

1312 
	}
}

1314 
	$MemAŒoc1D
(** 
µBuf
, 
iEÀSize
, 
iNum
)

1316 if(
iEÀSize
*
iNum
 <=0)

1319 *
µBuf
 = 
	`ˇŒoc
(
iNum
, 
iEÀSize
);

1320  (*
µBuf
 =
NULL
);

1321 
	}
}

1323 
	$hrd_∑ømëîs
(
MVCVUI_t
 *
pMVCVUI
, 
Bô°ªam
 *
s
)

1325 
i
;

1327 
pMVCVUI
->
˝b_˙t_möus1
 = (Ë
	`ªad_ue_v
("˝b_˙t_möus1", 
s
, &
p_Dec
->
U£dBôs
);

1328 
	`as£π
(
pMVCVUI
->
˝b_˙t_möus1
<=31);

1329 
pMVCVUI
->
bô_øã_sˇÀ
 = (Ë
	`ªad_u_v
(4, "bô_øã_sˇÀ", 
s
, &
p_Dec
->
U£dBôs
);

1330 
pMVCVUI
->
˝b_size_sˇÀ
 = (Ë
	`ªad_u_v
(4, "˝b_size_sˇÀ", 
s
, &
p_Dec
->
U£dBôs
);

1331 
i
=0; i<=
pMVCVUI
->
˝b_˙t_möus1
; i++)

1333 
pMVCVUI
->
bô_øã_vÆue_möus1
[
i
] = 
	`ªad_ue_v
("bô_øã_vÆue_möus1" , 
s
, &
p_Dec
->
U£dBôs
);

1334 
pMVCVUI
->
˝b_size_vÆue_möus1
[
i
] = 
	`ªad_ue_v
("˝b_size_vÆue_möus1" , 
s
, &
p_Dec
->
U£dBôs
);

1335 
pMVCVUI
->
cbr_Êag
[
i
] = (Ë
	`ªad_u_1
 ("cbr_Êag" , 
s
, &
p_Dec
->
U£dBôs
);

1337 
pMVCVUI
->
öôül_˝b_ªmovÆ_dñay_Àngth_möus1
 = (Ë
	`ªad_u_v
(5, "öôül_˝b_ªmovÆ_dñay_Àngth_möus1", 
s
, &
p_Dec
->
U£dBôs
);

1338 
pMVCVUI
->
˝b_ªmovÆ_dñay_Àngth_möus1
 = (Ë
	`ªad_u_v
(5, "˝b_ªmovÆ_dñay_Àngth_möus1", 
s
, &
p_Dec
->
U£dBôs
);

1339 
pMVCVUI
->
dpb_ouçut_dñay_Àngth_möus1
 = (Ë
	`ªad_u_v
(5, "dpb_ouçut_dñay_Àngth_möus1", 
s
, &
p_Dec
->
U£dBôs
);

1340 
pMVCVUI
->
time_off£t_Àngth
 = (Ë
	`ªad_u_v
(5, "time_off£t_Àngth", 
s
, &
p_Dec
->
U£dBôs
);

1342 
	}
}

1344 
	$mvc_vui_∑ømëîs_exãnsi⁄
(
MVCVUI_t
 *
pMVCVUI
, 
Bô°ªam
 *
s
)

1346 
i
, 
j
, 
iNumOps
;

1348 
pMVCVUI
->
num_›s_möus1
 = 
	`ªad_ue_v
("vui_mvc_num_›s_möus1", 
s
, &
p_Dec
->
U£dBôs
);

1349 
iNumOps
 = 1+ 
pMVCVUI
->
num_›s_möus1
;

1350 if(
iNumOps
 > 0)

1352 
	`MemAŒoc1D
((**)&(
pMVCVUI
->
ãmp‹Æ_id
), ’MVCVUI->ãmp‹Æ_id[0]), 
iNumOps
);

1353 
	`MemAŒoc1D
((**)&(
pMVCVUI
->
num_èrgë_ouçut_võws_möus1
), ’MVCVUI->num_èrgë_ouçut_võws_möus1[0]), 
iNumOps
);

1354 i‡((
pMVCVUI
->
võw_id
 = (**Ë
	`ˇŒoc
(
iNumOps
, (*))Ë=
NULL
)

1355 
	`no_mem_exô
("mvc_vui_parameters_extension:ÖMVCVUI->view_id");

1356 
	`MemAŒoc1D
((**)&(
pMVCVUI
->
timög_öfo_¥e£¡_Êag
), ’MVCVUI->timög_öfo_¥e£¡_Êag[0]), 
iNumOps
);

1357 
	`MemAŒoc1D
((**)&(
pMVCVUI
->
num_unôs_ö_tick
), ’MVCVUI->num_unôs_ö_tick[0]), 
iNumOps
);

1358 
	`MemAŒoc1D
((**)&(
pMVCVUI
->
time_sˇÀ
), ’MVCVUI->time_sˇÀ[0]), 
iNumOps
);

1359 
	`MemAŒoc1D
((**)&(
pMVCVUI
->
fixed_‰ame_øã_Êag
), ’MVCVUI->fixed_‰ame_øã_Êag[0]), 
iNumOps
);

1360 
	`MemAŒoc1D
((**)&(
pMVCVUI
->
«l_hrd_∑ømëîs_¥e£¡_Êag
), ’MVCVUI->«l_hrd_∑ømëîs_¥e£¡_Êag[0]), 
iNumOps
);

1361 
	`MemAŒoc1D
((**)&(
pMVCVUI
->
v˛_hrd_∑ømëîs_¥e£¡_Êag
), ’MVCVUI->v˛_hrd_∑ømëîs_¥e£¡_Êag[0]), 
iNumOps
);

1362 
	`MemAŒoc1D
((**)&(
pMVCVUI
->
low_dñay_hrd_Êag
), ’MVCVUI->low_dñay_hrd_Êag[0]), 
iNumOps
);

1363 
	`MemAŒoc1D
((**)&(
pMVCVUI
->
pic_°ru˘_¥e£¡_Êag
), ’MVCVUI->pic_°ru˘_¥e£¡_Êag[0]), 
iNumOps
);

1365 
i
=0; i<
iNumOps
; i++)

1367 
pMVCVUI
->
ãmp‹Æ_id
[
i
] = (Ë
	`ªad_u_v
(3, "vui_mvc_ãmp‹Æ_id", 
s
, &
p_Dec
->
U£dBôs
);

1368 
pMVCVUI
->
num_èrgë_ouçut_võws_möus1
[
i
] = 
	`ªad_ue_v
("vui_mvc_num_èrgë_ouçut_võws_möus1", 
s
, &
p_Dec
->
U£dBôs
);

1369 if(
pMVCVUI
->
num_èrgë_ouçut_võws_möus1
[
i
] >= 0)

1370 
	`MemAŒoc1D
((**)&(
pMVCVUI
->
võw_id
[
i
]), ’MVCVUI->võw_id[0][0]),ÖMVCVUI->
num_èrgë_ouçut_võws_möus1
[i]+1);

1371 
j
=0; j<=
pMVCVUI
->
num_èrgë_ouçut_võws_möus1
[
i
]; j++)

1372 
pMVCVUI
->
võw_id
[
i
][
j
] = 
	`ªad_ue_v
("vui_mvc_võw_id", 
s
, &
p_Dec
->
U£dBôs
);

1373 
pMVCVUI
->
timög_öfo_¥e£¡_Êag
[
i
] = (Ë
	`ªad_u_1
("vui_mvc_timög_öfo_¥e£¡_Êag", 
s
, &
p_Dec
->
U£dBôs
);

1374 if(
pMVCVUI
->
timög_öfo_¥e£¡_Êag
[
i
])

1376 
pMVCVUI
->
num_unôs_ö_tick
[
i
] = 
	`ªad_u_v
(32, "vui_mvc_num_unôs_ö_tick", 
s
, &
p_Dec
->
U£dBôs
);

1377 
pMVCVUI
->
time_sˇÀ
[
i
] = 
	`ªad_u_v
(32, "vui_mvc_time_sˇÀ" , 
s
, &
p_Dec
->
U£dBôs
);

1378 
pMVCVUI
->
fixed_‰ame_øã_Êag
[
i
] = (Ë
	`ªad_u_1
("vui_mvc_fixed_‰ame_øã_Êag", 
s
, &
p_Dec
->
U£dBôs
);

1380 
pMVCVUI
->
«l_hrd_∑ømëîs_¥e£¡_Êag
[
i
] = (Ë
	`ªad_u_1
("vui_mvc_«l_hrd_∑ømëîs_¥e£¡_Êag", 
s
, &
p_Dec
->
U£dBôs
);

1381 if(
pMVCVUI
->
«l_hrd_∑ømëîs_¥e£¡_Êag
[
i
])

1382 
	`hrd_∑ømëîs
(
pMVCVUI
, 
s
);

1383 
pMVCVUI
->
v˛_hrd_∑ømëîs_¥e£¡_Êag
[
i
] = (Ë
	`ªad_u_1
("v˛_hrd_∑ømëîs_¥e£¡_Êag", 
s
, &
p_Dec
->
U£dBôs
);

1384 if(
pMVCVUI
->
v˛_hrd_∑ømëîs_¥e£¡_Êag
[
i
])

1385 
	`hrd_∑ømëîs
(
pMVCVUI
, 
s
);

1386 if(
pMVCVUI
->
«l_hrd_∑ømëîs_¥e£¡_Êag
[
i
]||pMVCVUI->
v˛_hrd_∑ømëîs_¥e£¡_Êag
[i])

1387 
pMVCVUI
->
low_dñay_hrd_Êag
[
i
] = (Ë
	`ªad_u_1
("vui_mvc_low_dñay_hrd_Êag", 
s
, &
p_Dec
->
U£dBôs
);

1388 
pMVCVUI
->
pic_°ru˘_¥e£¡_Êag
[
i
] = (Ë
	`ªad_u_1
("vui_mvc_pic_°ru˘_¥e£¡_Êag", 
s
, &
p_Dec
->
U£dBôs
);

1391 
	}
}

1393 
	$öô_sub£t_•s_li°
(
sub£t_£q_∑ømëî_£t_rb•_t
 *
sub£t_•s_li°
, 
iSize
)

1395 
i
;

1396 
	`mem£t
(
sub£t_•s_li°
, 0, 
iSize
*(subset_sps_list[0]));

1397 
i
=0; i<
iSize
; i++)

1399 
sub£t_•s_li°
[
i
].
•s
.
£q_∑ømëî_£t_id
 = () -1;

1400 
sub£t_•s_li°
[
i
].
num_võws_möus1
 = -1;

1401 
sub£t_•s_li°
[
i
].
num_Àvñ_vÆues_sig«Œed_möus1
 = -1;

1402 
sub£t_•s_li°
[
i
].
MVCVUIP¨ams
.
num_›s_möus1
 = -1;

1404 
	}
}

1406 
	$ª£t_sub£t_•s
(
sub£t_£q_∑ømëî_£t_rb•_t
 *
sub£t_•s
)

1408 
i
, 
j
;

1410 if(
sub£t_•s
 && sub£t_•s->
num_võws_möus1
>=0)

1412 
sub£t_•s
->
•s
.
£q_∑ømëî_£t_id
 = () -1;

1414 
	`‰ì_poöãr
(
sub£t_•s
->
võw_id
);

1415 
i
=0; i<=
sub£t_•s
->
num_võws_möus1
; i++)

1417 
	`‰ì_poöãr
(
sub£t_•s
->
™ch‹_ªf_l0
[
i
]);

1418 
	`‰ì_poöãr
(
sub£t_•s
->
™ch‹_ªf_l1
[
i
]);

1420 
	`‰ì_poöãr
(
sub£t_•s
->
™ch‹_ªf_l0
);

1421 
	`‰ì_poöãr
(
sub£t_•s
->
™ch‹_ªf_l1
);

1422 
	`‰ì_poöãr
(
sub£t_•s
->
num_™ch‹_ªfs_l0
);

1423 
	`‰ì_poöãr
(
sub£t_•s
->
num_™ch‹_ªfs_l1
);

1425 
i
=0; i<=
sub£t_•s
->
num_võws_möus1
; i++)

1427 
	`‰ì_poöãr
(
sub£t_•s
->
n⁄_™ch‹_ªf_l0
[
i
]);

1428 
	`‰ì_poöãr
(
sub£t_•s
->
n⁄_™ch‹_ªf_l1
[
i
]);

1430 
	`‰ì_poöãr
(
sub£t_•s
->
n⁄_™ch‹_ªf_l0
);

1431 
	`‰ì_poöãr
(
sub£t_•s
->
n⁄_™ch‹_ªf_l1
);

1432 
	`‰ì_poöãr
(
sub£t_•s
->
num_n⁄_™ch‹_ªfs_l0
);

1433 
	`‰ì_poöãr
(
sub£t_•s
->
num_n⁄_™ch‹_ªfs_l1
);

1435 if(
sub£t_•s
->
num_Àvñ_vÆues_sig«Œed_möus1
 >= 0)

1437 
	`‰ì_poöãr
(
sub£t_•s
->
Àvñ_idc
);

1438 
i
=0; i<=
sub£t_•s
->
num_Àvñ_vÆues_sig«Œed_möus1
; i++)

1440 
j
=0; j<=
sub£t_•s
->
num_≠∂iˇbÀ_›s_möus1
[
i
]; j++)

1442 
	`‰ì_poöãr
(
sub£t_•s
->
≠∂iˇbÀ_›_èrgë_võw_id
[
i
][
j
]);

1444 
	`‰ì_poöãr
(
sub£t_•s
->
≠∂iˇbÀ_›_èrgë_võw_id
[
i
]);

1445 
	`‰ì_poöãr
(
sub£t_•s
->
≠∂iˇbÀ_›_ãmp‹Æ_id
[
i
]);

1446 
	`‰ì_poöãr
(
sub£t_•s
->
≠∂iˇbÀ_›_num_èrgë_võws_möus1
[
i
]);

1447 
	`‰ì_poöãr
(
sub£t_•s
->
≠∂iˇbÀ_›_num_võws_möus1
[
i
]);

1449 
	`‰ì_poöãr
(
sub£t_•s
->
≠∂iˇbÀ_›_èrgë_võw_id
);

1450 
	`‰ì_poöãr
(
sub£t_•s
->
≠∂iˇbÀ_›_ãmp‹Æ_id
);

1451 
	`‰ì_poöãr
(
sub£t_•s
->
≠∂iˇbÀ_›_num_èrgë_võws_möus1
);

1452 
	`‰ì_poöãr
(
sub£t_•s
->
≠∂iˇbÀ_›_num_võws_möus1
);

1453 
	`‰ì_poöãr
(
sub£t_•s
->
num_≠∂iˇbÀ_›s_möus1
);

1455 
sub£t_•s
->
num_Àvñ_vÆues_sig«Œed_möus1
 = -1;

1459 
sub£t_•s
->
num_võws_möus1
 = -1;

1462 if(
sub£t_•s
 && sub£t_•s->
mvc_vui_∑ømëîs_¥e£¡_Êag
)

1464 
MVCVUI_t
 *
pMVCVUI
 = &(
sub£t_•s
->
MVCVUIP¨ams
);

1465 if(
pMVCVUI
->
num_›s_möus1
 >=0)

1467 
	`‰ì_poöãr
(
pMVCVUI
->
ãmp‹Æ_id
);

1468 
	`‰ì_poöãr
(
pMVCVUI
->
num_èrgë_ouçut_võws_möus1
);

1469 
i
=0; i<=
pMVCVUI
->
num_›s_möus1
; i++)

1470 
	`‰ì_poöãr
(
pMVCVUI
->
võw_id
[
i
]);

1471 
	`‰ì_poöãr
(
pMVCVUI
->
võw_id
);

1472 
	`‰ì_poöãr
(
pMVCVUI
->
timög_öfo_¥e£¡_Êag
);

1473 
	`‰ì_poöãr
(
pMVCVUI
->
num_unôs_ö_tick
);

1474 
	`‰ì_poöãr
(
pMVCVUI
->
time_sˇÀ
);

1475 
	`‰ì_poöãr
(
pMVCVUI
->
fixed_‰ame_øã_Êag
);

1476 
	`‰ì_poöãr
(
pMVCVUI
->
«l_hrd_∑ømëîs_¥e£¡_Êag
);

1477 
	`‰ì_poöãr
(
pMVCVUI
->
v˛_hrd_∑ømëîs_¥e£¡_Êag
);

1478 
	`‰ì_poöãr
(
pMVCVUI
->
low_dñay_hrd_Êag
);

1479 
	`‰ì_poöãr
(
pMVCVUI
->
pic_°ru˘_¥e£¡_Êag
);

1481 
pMVCVUI
->
num_›s_möus1
 = -1;

1483 
sub£t_•s
->
mvc_vui_∑ømëîs_¥e£¡_Êag
 = 0;

1485 
	}
}

1487 
	$GëBa£VõwId
(
VideoP¨amëîs
 *
p_Vid
, 
sub£t_£q_∑ømëî_£t_rb•_t
 **
sub£t_•s
)

1489 
sub£t_£q_∑ømëî_£t_rb•_t
 *
cuº_sub£t_•s
;

1490 
i
, 
iBa£VõwId
=0;

1492 *
sub£t_•s
 = 
NULL
;

1493 
cuº_sub£t_•s
 = 
p_Vid
->
Sub£tSeqP¨Së
;

1494 
i
=0; i<
MAXSPS
; i++)

1496 if(
cuº_sub£t_•s
->
num_võws_möus1
>=0 && cuº_sub£t_•s->
•s
.
VÆid
)

1498 
iBa£VõwId
 = 
cuº_sub£t_•s
->
võw_id
[
BASE_VIEW_IDX
];

1501 
cuº_sub£t_•s
++;

1504 if(
i
<
MAXSPS
)

1505 *
sub£t_•s
 = 
cuº_sub£t_•s
;

1506  
iBa£VõwId
;

1507 
	}
}

1509 
	$gë_max_dec_‰ame_buf_size
(
£q_∑ømëî_£t_rb•_t
 *
•s
)

1511 
pic_size
 = (
•s
->
pic_width_ö_mbs_möus1
 + 1Ë* (•s->
pic_height_ö_m≠_unôs_möus1
 + 1Ë* (•s->
‰ame_mbs_⁄ly_Êag
?1:2) * 384;

1513 
size
 = 0;

1515 
•s
->
Àvñ_idc
)

1518 
size
 = 152064;

1521 
size
 = 152064;

1524 i‡(!
	`is_FREXT_¥ofûe
(
•s
->
¥ofûe_idc
Ë&& (•s->
c⁄°øöed_£t3_Êag
 == 1))

1525 
size
 = 152064;

1527 
size
 = 345600;

1530 
size
 = 912384;

1533 
size
 = 912384;

1536 
size
 = 912384;

1539 
size
 = 1824768;

1542 
size
 = 3110400;

1545 
size
 = 3110400;

1548 
size
 = 6912000;

1551 
size
 = 7864320;

1554 
size
 = 12582912;

1557 
size
 = 12582912;

1560 
size
 = 13369344;

1563 
size
 = 42393600;

1566 
size
 = 70778880;

1569 
size
 = 70778880;

1572 
	`îr‹
 ("undefinedÜevel", 500);

1576 
size
 /
pic_size
;

1577 
size
 = 
	`imö
( size, 16);

1578 
•s
->
max_dec_‰ame_buf„rög
 = 
size
;

1579 
	}
}

	@ldecod/src/quant.c

16 
	~"c⁄åibut‹s.h
"

18 
	~"globÆ.h
"

19 
	~"memÆloc.h
"

20 
	~"block.h
"

21 
	~"image.h
"

22 
	~"mb_ac˚ss.h
"

23 
	~"å™sf‹m.h
"

24 
	~"qu™t.h
"

26 
	gqu™t_öåa_deÁu…
[16] = {

33 
	gqu™t_öãr_deÁu…
[16] = {

40 
	gqu™t8_öåa_deÁu…
[64] = {

51 
	gqu™t8_öãr_deÁu…
[64] = {

62 
	gqu™t_‹g
[16] = {

69 
	gqu™t8_‹g
[64] = {

86 
	$öô_qp_¥o˚ss
(
CodögP¨amëîs
 *
˝s
)

88 
bôdïth_qp_sˇÀ
 = 
	`imax
(
˝s
->
bôdïth_luma_qp_sˇÀ
, cps->
bôdïth_chroma_qp_sˇÀ
);

89 
i
;

93 i‡(
˝s
->
qp_≥r_m©rix
 =
NULL
)

94 i‡((
˝s
->
qp_≥r_m©rix
 = (*)
	`mÆloc
((
MAX_QP
 + 1 + 
bôdïth_qp_sˇÀ
)*())Ë=
NULL
)

95 
	`no_mem_exô
("init_qp_process: cps->qp_per_matrix");

97 i‡(
˝s
->
qp_ªm_m©rix
 =
NULL
)

98 i‡((
˝s
->
qp_ªm_m©rix
 = (*)
	`mÆloc
((
MAX_QP
 + 1 + 
bôdïth_qp_sˇÀ
)*())Ë=
NULL
)

99 
	`no_mem_exô
("init_qp_process: cps->qp_rem_matrix");

101 
i
 = 0; i < 
MAX_QP
 + 
bôdïth_qp_sˇÀ
 + 1; i++)

103 
˝s
->
qp_≥r_m©rix
[
i
] = i / 6;

104 
˝s
->
qp_ªm_m©rix
[
i
] = i % 6;

106 
	}
}

108 
	$‰ì_qp_m©ri˚s
(
CodögP¨amëîs
 *
˝s
)

110 i‡(
˝s
->
qp_≥r_m©rix
 !
NULL
)

112 
	`‰ì
 (
˝s
->
qp_≥r_m©rix
);

113 
˝s
->
qp_≥r_m©rix
 = 
NULL
;

116 i‡(
˝s
->
qp_ªm_m©rix
 !
NULL
)

118 
	`‰ì
 (
˝s
->
qp_ªm_m©rix
);

119 
˝s
->
qp_ªm_m©rix
 = 
NULL
;

121 
	}
}

137 
	$assign_qu™t_∑øms
(
Sli˚
 *
cuºSli˚
)

139 
£q_∑ømëî_£t_rb•_t
* 
•s
 = 
cuºSli˚
->
a˘ive_•s
;

140 
pic_∑ømëî_£t_rb•_t
* 
µs
 = 
cuºSli˚
->
a˘ive_µs
;

141 
i
;

142 
n_SˇlögLi°
;

144 if(!
µs
->
pic_sˇlög_m©rix_¥e£¡_Êag
 && !
•s
->
£q_sˇlög_m©rix_¥e£¡_Êag
)

146 
i
=0; i<12; i++)

147 
cuºSli˚
->
qm©rix
[
i
] = (ò< 6Ë? 
qu™t_‹g
 : 
qu™t8_‹g
;

151 
n_SˇlögLi°
 = (
•s
->
chroma_f‹m©_idc
 !
YUV444
) ? 8 : 12;

152 if(
•s
->
£q_sˇlög_m©rix_¥e£¡_Êag
)

154 
i
=0; i<
n_SˇlögLi°
; i++)

156 if(
i
<6)

158 if(!
•s
->
£q_sˇlög_li°_¥e£¡_Êag
[
i
])

160 if(
i
==0)

161 
cuºSli˚
->
qm©rix
[
i
] = 
qu™t_öåa_deÁu…
;

162 if(
i
==3)

163 
cuºSli˚
->
qm©rix
[
i
] = 
qu™t_öãr_deÁu…
;

165 
cuºSli˚
->
qm©rix
[
i
] = currSlice->qmatrix[i-1];

169 if(
•s
->
U£DeÁu…SˇlögM©rix4x4Fœg
[
i
])

170 
cuºSli˚
->
qm©rix
[
i
] = (i<3Ë? 
qu™t_öåa_deÁu…
 : 
qu™t_öãr_deÁu…
;

172 
cuºSli˚
->
qm©rix
[
i
] = 
•s
->
SˇlögLi°4x4
[i];

177 if(!
•s
->
£q_sˇlög_li°_¥e£¡_Êag
[
i
])

179 if(
i
==6)

180 
cuºSli˚
->
qm©rix
[
i
] = 
qu™t8_öåa_deÁu…
;

181 if(
i
==7)

182 
cuºSli˚
->
qm©rix
[
i
] = 
qu™t8_öãr_deÁu…
;

184 
cuºSli˚
->
qm©rix
[
i
] = currSlice->qmatrix[i-2];

188 if(
•s
->
U£DeÁu…SˇlögM©rix8x8Fœg
[
i
-6])

189 
cuºSli˚
->
qm©rix
[
i
] = (i==6 || i==8 || i==10Ë? 
qu™t8_öåa_deÁu…
:
qu™t8_öãr_deÁu…
;

191 
cuºSli˚
->
qm©rix
[
i
] = 
•s
->
SˇlögLi°8x8
[i-6];

197 if(
µs
->
pic_sˇlög_m©rix_¥e£¡_Êag
)

199 
i
=0; i<
n_SˇlögLi°
; i++)

201 if(
i
<6)

203 if(!
µs
->
pic_sˇlög_li°_¥e£¡_Êag
[
i
])

205 i‡(
i
==0)

207 if(!
•s
->
£q_sˇlög_m©rix_¥e£¡_Êag
)

208 
cuºSli˚
->
qm©rix
[
i
] = 
qu™t_öåa_deÁu…
;

210 i‡(
i
==3)

212 if(!
•s
->
£q_sˇlög_m©rix_¥e£¡_Êag
)

213 
cuºSli˚
->
qm©rix
[
i
] = 
qu™t_öãr_deÁu…
;

216 
cuºSli˚
->
qm©rix
[
i
] = currSlice->qmatrix[i-1];

220 if(
µs
->
U£DeÁu…SˇlögM©rix4x4Fœg
[
i
])

221 
cuºSli˚
->
qm©rix
[
i
] = (i<3Ë? 
qu™t_öåa_deÁu…
:
qu™t_öãr_deÁu…
;

223 
cuºSli˚
->
qm©rix
[
i
] = 
µs
->
SˇlögLi°4x4
[i];

228 if(!
µs
->
pic_sˇlög_li°_¥e£¡_Êag
[
i
])

230 i‡(
i
==6)

232 if(!
•s
->
£q_sˇlög_m©rix_¥e£¡_Êag
)

233 
cuºSli˚
->
qm©rix
[
i
] = 
qu™t8_öåa_deÁu…
;

235 if(
i
==7)

237 if(!
•s
->
£q_sˇlög_m©rix_¥e£¡_Êag
)

238 
cuºSli˚
->
qm©rix
[
i
] = 
qu™t8_öãr_deÁu…
;

241 
cuºSli˚
->
qm©rix
[
i
] = currSlice->qmatrix[i-2];

245 if(
µs
->
U£DeÁu…SˇlögM©rix8x8Fœg
[
i
-6])

246 
cuºSli˚
->
qm©rix
[
i
] = (i==6 || i==8 || i==10Ë? 
qu™t8_öåa_deÁu…
:
qu™t8_öãr_deÁu…
;

248 
cuºSli˚
->
qm©rix
[
i
] = 
µs
->
SˇlögLi°8x8
[i-6];

255 
	`CÆcuœãQu™t4x4P¨am
(
cuºSli˚
);

256 if(
µs
->
å™sf‹m_8x8_mode_Êag
)

257 
	`CÆcuœãQu™t8x8P¨am
(
cuºSli˚
);

258 
	}
}

260 
£t_dequ™t4x4
((*
InvLevñSˇÀ4x4
)[4], c⁄° (*
dequ™t
)[4], *
qm©rix
)

262 
	gj
;

263 
	gj
=0; j<4; j++)

265 *(*
	gInvLevñSˇÀ4x4
 ) = *(*
dequ™t
 ) * *
qm©rix
++;

266 *(*
	gInvLevñSˇÀ4x4
 + 1Ë*(*
dequ™t
 + 1Ë* *
qm©rix
++;

267 *(*
	gInvLevñSˇÀ4x4
 + 2Ë*(*
dequ™t
 + 2Ë* *
qm©rix
++;

268 *(*
	gInvLevñSˇÀ4x4
++ + 3Ë*(*
dequ™t
++ + 3Ë* *
qm©rix
++;

272 
£t_dequ™t8x8
((*
InvLevñSˇÀ8x8
)[8], c⁄° (*
dequ™t
)[8], *
qm©rix
)

274 
	gj
;

275 
	gj
 = 0; j < 8; j++)

277 *(*
	gInvLevñSˇÀ8x8
 ) = *(*
dequ™t
 ) * *
qm©rix
++;

278 *(*
	gInvLevñSˇÀ8x8
 + 1Ë*(*
dequ™t
 + 1Ë* *
qm©rix
++;

279 *(*
	gInvLevñSˇÀ8x8
 + 2Ë*(*
dequ™t
 + 2Ë* *
qm©rix
++;

280 *(*
	gInvLevñSˇÀ8x8
 + 3Ë*(*
dequ™t
 + 3Ë* *
qm©rix
++;

281 *(*
	gInvLevñSˇÀ8x8
 + 4Ë*(*
dequ™t
 + 4Ë* *
qm©rix
++;

282 *(*
	gInvLevñSˇÀ8x8
 + 5Ë*(*
dequ™t
 + 5Ë* *
qm©rix
++;

283 *(*
	gInvLevñSˇÀ8x8
 + 6Ë*(*
dequ™t
 + 6Ë* *
qm©rix
++;

284 *(*
	gInvLevñSˇÀ8x8
++ + 7Ë*(*
dequ™t
++ + 7Ë* *
qm©rix
++;

295 
	$CÆcuœãQu™t4x4P¨am
(
Sli˚
 *
cuºSli˚
)

297 
k
;

298 c⁄° (*
p_dequ™t_c€f
)[4][4] = 
dequ™t_c€f
;

299 (*
InvLevñSˇÀ4x4_I¡ø_0
)[4][4] = 
cuºSli˚
->
InvLevñSˇÀ4x4_I¡ø
[0];

300 (*
InvLevñSˇÀ4x4_I¡ø_1
)[4][4] = 
cuºSli˚
->
InvLevñSˇÀ4x4_I¡ø
[1];

301 (*
InvLevñSˇÀ4x4_I¡ø_2
)[4][4] = 
cuºSli˚
->
InvLevñSˇÀ4x4_I¡ø
[2];

302 (*
InvLevñSˇÀ4x4_I¡î_0
)[4][4] = 
cuºSli˚
->
InvLevñSˇÀ4x4_I¡î
[0];

303 (*
InvLevñSˇÀ4x4_I¡î_1
)[4][4] = 
cuºSli˚
->
InvLevñSˇÀ4x4_I¡î
[1];

304 (*
InvLevñSˇÀ4x4_I¡î_2
)[4][4] = 
cuºSli˚
->
InvLevñSˇÀ4x4_I¡î
[2];

307 
k
=0; k<6; k++)

309 
	`£t_dequ™t4x4
(*
InvLevñSˇÀ4x4_I¡ø_0
++, *
p_dequ™t_c€f
 , 
cuºSli˚
->
qm©rix
[0]);

310 
	`£t_dequ™t4x4
(*
InvLevñSˇÀ4x4_I¡ø_1
++, *
p_dequ™t_c€f
 , 
cuºSli˚
->
qm©rix
[1]);

311 
	`£t_dequ™t4x4
(*
InvLevñSˇÀ4x4_I¡ø_2
++, *
p_dequ™t_c€f
 , 
cuºSli˚
->
qm©rix
[2]);

312 
	`£t_dequ™t4x4
(*
InvLevñSˇÀ4x4_I¡î_0
++, *
p_dequ™t_c€f
 , 
cuºSli˚
->
qm©rix
[3]);

313 
	`£t_dequ™t4x4
(*
InvLevñSˇÀ4x4_I¡î_1
++, *
p_dequ™t_c€f
 , 
cuºSli˚
->
qm©rix
[4]);

314 
	`£t_dequ™t4x4
(*
InvLevñSˇÀ4x4_I¡î_2
++, *
p_dequ™t_c€f
++, 
cuºSli˚
->
qm©rix
[5]);

316 
	}
}

325 
	$CÆcuœãQu™t8x8P¨am
(
Sli˚
 *
cuºSli˚
)

327 
k
;

328 c⁄° (*
p_dequ™t_c€f
)[8][8] = 
dequ™t_c€f8
;

329 (*
InvLevñSˇÀ8x8_I¡ø_0
)[8][8] = 
cuºSli˚
->
InvLevñSˇÀ8x8_I¡ø
[0];

330 (*
InvLevñSˇÀ8x8_I¡ø_1
)[8][8] = 
cuºSli˚
->
InvLevñSˇÀ8x8_I¡ø
[1];

331 (*
InvLevñSˇÀ8x8_I¡ø_2
)[8][8] = 
cuºSli˚
->
InvLevñSˇÀ8x8_I¡ø
[2];

332 (*
InvLevñSˇÀ8x8_I¡î_0
)[8][8] = 
cuºSli˚
->
InvLevñSˇÀ8x8_I¡î
[0];

333 (*
InvLevñSˇÀ8x8_I¡î_1
)[8][8] = 
cuºSli˚
->
InvLevñSˇÀ8x8_I¡î
[1];

334 (*
InvLevñSˇÀ8x8_I¡î_2
)[8][8] = 
cuºSli˚
->
InvLevñSˇÀ8x8_I¡î
[2];

336 
k
=0; k<6; k++)

338 
	`£t_dequ™t8x8
(*
InvLevñSˇÀ8x8_I¡ø_0
++, *
p_dequ™t_c€f
 , 
cuºSli˚
->
qm©rix
[6]);

339 
	`£t_dequ™t8x8
(*
InvLevñSˇÀ8x8_I¡î_0
++, *
p_dequ™t_c€f
++, 
cuºSli˚
->
qm©rix
[7]);

342 
p_dequ™t_c€f
 = 
dequ™t_c€f8
;

343 if–
cuºSli˚
->
a˘ive_•s
->
chroma_f‹m©_idc
 == 3 )

345 
k
=0; k<6; k++)

347 
	`£t_dequ™t8x8
(*
InvLevñSˇÀ8x8_I¡ø_1
++, *
p_dequ™t_c€f
 , 
cuºSli˚
->
qm©rix
[8]);

348 
	`£t_dequ™t8x8
(*
InvLevñSˇÀ8x8_I¡î_1
++, *
p_dequ™t_c€f
 , 
cuºSli˚
->
qm©rix
[9]);

349 
	`£t_dequ™t8x8
(*
InvLevñSˇÀ8x8_I¡ø_2
++, *
p_dequ™t_c€f
 , 
cuºSli˚
->
qm©rix
[10]);

350 
	`£t_dequ™t8x8
(*
InvLevñSˇÀ8x8_I¡î_2
++, *
p_dequ™t_c€f
++, 
cuºSli˚
->
qm©rix
[11]);

353 
	}
}

	@ldecod/src/read_comp_cabac.c

14 
	~"c⁄åibut‹s.h
"

16 
	~"globÆ.h
"

17 
	~"ñemíts.h
"

18 
	~"ma¸oblock.h
"

19 
	~"ˇbac.h
"

20 
	~"vlc.h
"

21 
	~"å™sf‹m.h
"

23 #i‡
TRACE


24 
	#TRACE_STRING
(
s
Ë
	`°∫˝y
(
cuºSE
.
åa˚°rög
, s, 
TRACESTRING_SIZE
)

	)

25 
	#TRACE_DECBITS
(
i
Ë
	`de˘ø˚bô˙t
(1)

	)

26 
	#TRACE_PRINTF
(
s
Ë
	`•rötf
(
ty≥
, "%s", s);

	)

27 
	#TRACE_STRING_P
(
s
Ë
	`°∫˝y
(
cuºSE
->
åa˚°rög
, s, 
TRACESTRING_SIZE
)

	)

29 
	#TRACE_STRING
(
s
)

	)

30 
	#TRACE_DECBITS
(
i
)

	)

31 
	#TRACE_PRINTF
(
s
)

	)

32 
	#TRACE_STRING_P
(
s
)

	)

35 
check_dp_√ighb‹s
 (
Ma¸oblock
 *
cuºMB
);

36 
ªad_dñè_qu™t
 (
Sy¡axEÀmít
 *
cuºSE
, 
D©aP¨tôi⁄
 *
dP
, 
Ma¸oblock
 *
cuºMB
, c⁄° 
byã
 *
∑πM≠
, 
ty≥
);

45 
	$ªad_comp_c€ff_4x4_smb_CABAC
 (
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
cuºSE
, 
Cﬁ‹Pœ√
 
∂
, 
block_y
, 
block_x
, 
°¨t_sˇn
, 
öt64
 *
cbp_blk
)

47 
i
,
j
,
k
;

48 
i0
, 
j0
;

49 
Àvñ
 = 1;

50 
D©aP¨tôi⁄
 *
dP
;

51 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

52 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

53 c⁄° 
byã
 *
∑πM≠
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
dp_mode
];

55 c⁄° 
	`byã
 (*
pos_sˇn4x4
)[2] = ((
p_Vid
->
°ru˘uª
 =
FRAME
Ë&& (!
cuºMB
->
mb_fõld
)Ë? 
SNGL_SCAN
 : 
FIELD_SCAN
;

56 c⁄° 
byã
 *
pos_sˇn_4x4
 = 
pos_sˇn4x4
[0];

57 **
cof
 = 
cuºSli˚
->cof[
∂
];

59 
j
 = 
block_y
; j < block_y + 
BLOCK_SIZE_8x8
; j += 4)

61 
cuºMB
->
subblock_y
 = 
j
;

63 
i
 = 
block_x
; i < block_x + 
BLOCK_SIZE_8x8
; i += 4)

65 
cuºMB
->
subblock_x
 = 
i
;

66 
pos_sˇn_4x4
 = 
pos_sˇn4x4
[
°¨t_sˇn
];

67 
Àvñ
 = 1;

69 i‡(
°¨t_sˇn
 == 0)

75 
cuºSE
->
ty≥
 = (
cuºMB
->
is_öåa_block
 ? 
SE_LUM_DC_INTRA
 : 
SE_LUM_DC_INTER
);

76 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
cuºSE
->
ty≥
]]);

77 i‡(
dP
->
bô°ªam
->
ei_Êag
)

78 
cuºSE
->
m≠pög
 = 
löfo_Àvrun_öãr
;

80 
cuºSE
->
ªadög
 = 
ªadRunLevñ_CABAC
;

82 #i‡
TRACE


83 i‡(
∂
 =
PLANE_Y
)

84 
	`•rötf
(
cuºSE
->
åa˚°rög
, "Luma sng ");

85 i‡(
∂
 =
PLANE_U
)

86 
	`•rötf
(
cuºSE
->
åa˚°rög
, "Cb sng ");

88 
	`•rötf
(
cuºSE
->
åa˚°rög
, "Cr sng ");

91 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, 
cuºSE
, dP);

92 
Àvñ
 = 
cuºSE
->
vÆue1
;

94 i‡(
Àvñ
 != 0)

96 
pos_sˇn_4x4
 +2 * 
cuºSE
->
vÆue2
;

98 
i0
 = *
pos_sˇn_4x4
++;

99 
j0
 = *
pos_sˇn_4x4
++;

101 *
cbp_blk
 |
	`i64_powî2
(
j
 + (
i
 >> 2)) ;

103 
cof
[
j
 + 
j0
][
i
 + 
i0
]
Àvñ
;

108 i‡(
Àvñ
 != 0)

111 
cuºSE
->
ty≥
 = (
cuºMB
->
is_öåa_block
 ? 
SE_LUM_AC_INTRA
 : 
SE_LUM_AC_INTER
);

112 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
cuºSE
->
ty≥
]]);

114 i‡(
dP
->
bô°ªam
->
ei_Êag
)

115 
cuºSE
->
m≠pög
 = 
löfo_Àvrun_öãr
;

117 
cuºSE
->
ªadög
 = 
ªadRunLevñ_CABAC
;

119 
k
 = 1; (k < 17Ë&& (
Àvñ
 != 0); ++k)

121 #i‡
TRACE


122 i‡(
∂
 =
PLANE_Y
)

123 
	`•rötf
(
cuºSE
->
åa˚°rög
, "Luma sng ");

124 i‡(
∂
 =
PLANE_U
)

125 
	`•rötf
(
cuºSE
->
åa˚°rög
, "Cb sng ");

127 
	`•rötf
(
cuºSE
->
åa˚°rög
, "Cr sng ");

130 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, 
cuºSE
, dP);

131 
Àvñ
 = 
cuºSE
->
vÆue1
;

133 i‡(
Àvñ
 != 0)

135 
pos_sˇn_4x4
 +2 * 
cuºSE
->
vÆue2
;

137 
i0
 = *
pos_sˇn_4x4
++;

138 
j0
 = *
pos_sˇn_4x4
++;

140 
cof
[
j
 + 
j0
][
i
 + 
i0
] = 
Àvñ
;

147 
	}
}

156 
ªad_comp_c€ff_4x4_CABAC
 (
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
cuºSE
, 
Cﬁ‹Pœ√
 
∂
, (*
InvLevñSˇÀ4x4
)[4], 
qp_≥r
, 
cbp
)

158 
Sli˚
 *
	gcuºSli˚
 = 
cuºMB
->
p_Sli˚
;

159 
VideoP¨amëîs
 *
	gp_Vid
 = 
cuºMB
->
p_Vid
;

160 
	g°¨t_sˇn
 = 
IS_I16MB
 (
cuºMB
)? 1 : 0;

161 
	gblock_y
, 
	gblock_x
;

162 
	gi
, 
	gj
;

163 
öt64
 *
	gcbp_blk
 = &
cuºMB
->
s_cbp
[
∂
].
blk
;

165 if–
	g∂
 =
PLANE_Y
 || (
p_Vid
->
£∑øã_cﬁour_∂™e_Êag
 != 0) )

166 
cuºSE
->
c⁄ãxt
 = (
IS_I16MB
(
cuºMB
Ë? 
LUMA_16AC
: 
LUMA_4x4
);

167 i‡(
	g∂
 =
PLANE_U
)

168 
cuºSE
->
c⁄ãxt
 = (
IS_I16MB
(
cuºMB
Ë? 
CB_16AC
: 
CB_4x4
);

170 
	gcuºSE
->
	gc⁄ãxt
 = (
IS_I16MB
(
cuºMB
Ë? 
CR_16AC
: 
CR_4x4
);

172 
	gblock_y
 = 0; block_y < 
	gMB_BLOCK_SIZE
; block_y +
BLOCK_SIZE_8x8
)

174 **
cof
 = &
cuºSli˚
->cof[
∂
][
block_y
];

175 
	gblock_x
 = 0; block_x < 
	gMB_BLOCK_SIZE
; block_x +
BLOCK_SIZE_8x8
)

177 i‡(
cbp
 & (1 << ((
block_y
 >> 2Ë+ (
block_x
 >> 3))))

179 
ªad_comp_c€ff_4x4_smb_CABAC
 (
cuºMB
, 
cuºSE
, 
∂
, 
block_y
, 
block_x
, 
°¨t_sˇn
, 
cbp_blk
);

181 i‡(
	g°¨t_sˇn
 == 0)

183 
j
 = 0; 
	gj
 < 
	gBLOCK_SIZE_8x8
; ++j)

185 *
	gc€f
 = &
cof
[
j
][
block_x
];

186 
	gjj
 = 
j
 & 0x03;

187 
	gi
 = 0; i < 
	gBLOCK_SIZE_8x8
; i+=4)

189 i‡(*
c€f
)

190 *
c€f
 = 
rshi·_∫d_sf
((*c€‡* 
InvLevñSˇÀ4x4
[
jj
][0]Ë<< 
qp_≥r
, 4);

191 
	gc€f
++;

192 i‡(*
	gc€f
)

193 *
	gc€f
 = 
rshi·_∫d_sf
((*
c€f
 * 
InvLevñSˇÀ4x4
[
jj
][1]Ë<< 
qp_≥r
, 4);

194 
	gc€f
++;

195 i‡(*
	gc€f
)

196 *
	gc€f
 = 
rshi·_∫d_sf
((*
c€f
 * 
InvLevñSˇÀ4x4
[
jj
][2]Ë<< 
qp_≥r
, 4);

197 
	gc€f
++;

198 i‡(*
	gc€f
)

199 *
	gc€f
 = 
rshi·_∫d_sf
((*
c€f
 * 
InvLevñSˇÀ4x4
[
jj
][3]Ë<< 
qp_≥r
, 4);

200 
	gc€f
++;

206 
	gj
 = 0; j < 
	gBLOCK_SIZE_8x8
; ++j)

208 *
	gc€f
 = &
cof
[
j
][
block_x
];

209 
	gjj
 = 
j
 & 0x03;

210 
	gi
 = 0; i < 
	gBLOCK_SIZE_8x8
; i += 4)

212 i‡((
jj
 !0Ë&& *
c€f
)

213 *
c€f

rshi·_∫d_sf
((*c€‡* 
InvLevñSˇÀ4x4
[
jj
][0]Ë<< 
qp_≥r
, 4);

214 
	gc€f
++;

215 i‡(*
	gc€f
)

216 *
	gc€f

rshi·_∫d_sf
((*
c€f
 * 
InvLevñSˇÀ4x4
[
jj
][1]Ë<< 
qp_≥r
, 4);

217 
	gc€f
++;

218 i‡(*
	gc€f
)

219 *
	gc€f

rshi·_∫d_sf
((*
c€f
 * 
InvLevñSˇÀ4x4
[
jj
][2]Ë<< 
qp_≥r
, 4);

220 
	gc€f
++;

221 i‡(*
	gc€f
)

222 *
	gc€f

rshi·_∫d_sf
((*
c€f
 * 
InvLevñSˇÀ4x4
[
jj
][3]Ë<< 
qp_≥r
, 4);

223 
	gc€f
++;

240 
ªad_comp_c€ff_4x4_CABAC_ls
 (
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
cuºSE
, 
Cﬁ‹Pœ√
 
∂
, (*
InvLevñSˇÀ4x4
)[4], 
qp_≥r
, 
cbp
)

242 
VideoP¨amëîs
 *
	gp_Vid
 = 
cuºMB
->
p_Vid
;

243 
	g°¨t_sˇn
 = 
IS_I16MB
 (
cuºMB
)? 1 : 0;

244 
	gblock_y
, 
	gblock_x
;

245 
öt64
 *
	gcbp_blk
 = &
cuºMB
->
s_cbp
[
∂
].
blk
;

247 if–
	g∂
 =
PLANE_Y
 || (
p_Vid
->
£∑øã_cﬁour_∂™e_Êag
 != 0) )

248 
cuºSE
->
c⁄ãxt
 = (
IS_I16MB
(
cuºMB
Ë? 
LUMA_16AC
: 
LUMA_4x4
);

249 i‡(
	g∂
 =
PLANE_U
)

250 
cuºSE
->
c⁄ãxt
 = (
IS_I16MB
(
cuºMB
Ë? 
CB_16AC
: 
CB_4x4
);

252 
	gcuºSE
->
	gc⁄ãxt
 = (
IS_I16MB
(
cuºMB
Ë? 
CR_16AC
: 
CR_4x4
);

254 
	gblock_y
 = 0; block_y < 
	gMB_BLOCK_SIZE
; block_y +
BLOCK_SIZE_8x8
)

256 
block_x
 = 0; 
	gblock_x
 < 
	gMB_BLOCK_SIZE
; block_x +
BLOCK_SIZE_8x8
)

258 i‡(
cbp
 & (1 << ((
block_y
 >> 2Ë+ (
block_x
 >> 3))))

260 
ªad_comp_c€ff_4x4_smb_CABAC
 (
cuºMB
, 
cuºSE
, 
∂
, 
block_y
, 
block_x
, 
°¨t_sˇn
, 
cbp_blk
);

274 
	$ªadCompC€ff8x8_CABAC
 (
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
cuºSE
, 
Cﬁ‹Pœ√
 
∂
, 
b8
)

276 i‡(
cuºMB
->
cbp
 & (1<<
b8
))

278 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

279 
å™sf‹m_∂
 = (
p_Vid
->
£∑øã_cﬁour_∂™e_Êag
 !0Ë? 
cuºMB
->
p_Sli˚
->
cﬁour_∂™e_id
 : 
∂
;

281 **
tc€ffs
;

282 
i
,
j
,
k
;

283 
Àvñ
 = 1;

285 
D©aP¨tôi⁄
 *
dP
;

286 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

287 c⁄° 
byã
 *
∑πM≠
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
dp_mode
];

288 
boff_x
, 
boff_y
;

290 
öt64
 
cbp_mask
 = (öt64Ë51 << (4 * 
b8
 - 2 * (b8 & 0x01));

291 
öt64
 *
cur_cbp
 = &
cuºMB
->
s_cbp
[
∂
].
blk
;

294 c⁄° 
	`byã
 (*
pos_sˇn8x8
Ë((
p_Vid
->
°ru˘uª
 =
FRAME
Ë&& (!
cuºMB
->
mb_fõld
)Ë? 
SNGL_SCAN8x8
[0] : 
FIELD_SCAN8x8
[0];

296 
qp_≥r
 = 
p_Vid
->
qp_≥r_m©rix
[ 
cuºMB
->
qp_sˇÀd
[
∂
] ];

297 
qp_ªm
 = 
p_Vid
->
qp_ªm_m©rix
[ 
cuºMB
->
qp_sˇÀd
[
∂
] ];

299 (*
InvLevñSˇÀ8x8
)[8] = (
cuºMB
->
is_öåa_block
 =
TRUE
Ë? 
cuºSli˚
->
InvLevñSˇÀ8x8_I¡ø
[
å™sf‹m_∂
][
qp_ªm
] : cuºSli˚->
InvLevñSˇÀ8x8_I¡î
[transform_pl][qp_rem];

302 
boff_x
 = (
b8
&0x01) << 3;

303 
boff_y
 = (
b8
 >> 1) << 3;

304 
tc€ffs
 = &
cuºSli˚
->
mb_ºes
[
∂
][
boff_y
];

306 
cuºMB
->
subblock_x
 = 
boff_x
;

307 
cuºMB
->
subblock_y
 = 
boff_y
;

309 i‡(
∂
==
PLANE_Y
 || (
p_Vid
->
£∑øã_cﬁour_∂™e_Êag
 != 0))

310 
cuºSE
->
c⁄ãxt
 = 
LUMA_8x8
;

311 i‡(
∂
==
PLANE_U
)

312 
cuºSE
->
c⁄ãxt
 = 
CB_8x8
;

314 
cuºSE
->
c⁄ãxt
 = 
CR_8x8
;

316 
cuºSE
->
ªadög
 = 
ªadRunLevñ_CABAC
;

319 
cuºSE
->
ty≥
 = ((
cuºMB
->
is_öåa_block
 =1Ë? 
SE_LUM_DC_INTRA
 : 
SE_LUM_DC_INTER
 );

320 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
cuºSE
->
ty≥
]]);

322 #i‡
TRACE


323 i‡(
∂
==
PLANE_Y
)

324 
	`•rötf
(
cuºSE
->
åa˚°rög
, "Luma8x8 DC sng ");

325 i‡(
∂
==
PLANE_U
)

326 
	`•rötf
(
cuºSE
->
åa˚°rög
, "Cb 8x8 DC sng ");

328 
	`•rötf
(
cuºSE
->
åa˚°rög
, "Cr 8x8 DC sng ");

331 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, 
cuºSE
, dP);

332 
Àvñ
 = 
cuºSE
->
vÆue1
;

335 i‡(
Àvñ
 != 0)

337 *
cur_cbp
 |
cbp_mask
;

339 
pos_sˇn8x8
 +2 * (
cuºSE
->
vÆue2
);

341 
i
 = *
pos_sˇn8x8
++;

342 
j
 = *
pos_sˇn8x8
++;

344 
tc€ffs
[
j
][
boff_x
 + 
i
] = 
	`rshi·_∫d_sf
((
Àvñ
 * 
InvLevñSˇÀ8x8
[j][i]Ë<< 
qp_≥r
, 6);

348 
cuºSE
->
ty≥
 = ((
cuºMB
->
is_öåa_block
 =1Ë? 
SE_LUM_AC_INTRA
 : 
SE_LUM_AC_INTER
);

349 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
cuºSE
->
ty≥
]]);

351 
k
 = 1;(k < 65Ë&& (
Àvñ
 != 0);++k)

353 #i‡
TRACE


354 i‡(
∂
==
PLANE_Y
)

355 
	`•rötf
(
cuºSE
->
åa˚°rög
, "Luma8x8 sng ");

356 i‡(
∂
==
PLANE_U
)

357 
	`•rötf
(
cuºSE
->
åa˚°rög
, "Cb 8x8 sng ");

359 
	`•rötf
(
cuºSE
->
åa˚°rög
, "Cr 8x8 sng ");

362 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, 
cuºSE
, dP);

363 
Àvñ
 = 
cuºSE
->
vÆue1
;

366 i‡(
Àvñ
 != 0)

368 
pos_sˇn8x8
 +2 * (
cuºSE
->
vÆue2
);

370 
i
 = *
pos_sˇn8x8
++;

371 
j
 = *
pos_sˇn8x8
++;

373 
tc€ffs
[ 
j
][
boff_x
 + 
i
] = 
	`rshi·_∫d_sf
((
Àvñ
 * 
InvLevñSˇÀ8x8
[j][i]Ë<< 
qp_≥r
, 6);

389 
	}
}

398 
	$ªadCompC€ff8x8_CABAC_los¶ess
 (
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
cuºSE
, 
Cﬁ‹Pœ√
 
∂
, 
b8
)

400 i‡(
cuºMB
->
cbp
 & (1<<
b8
))

402 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

404 **
tc€ffs
;

405 
i
,
j
,
k
;

406 
Àvñ
 = 1;

408 
D©aP¨tôi⁄
 *
dP
;

409 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

410 c⁄° 
byã
 *
∑πM≠
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
dp_mode
];

411 
boff_x
, 
boff_y
;

413 
öt64
 
cbp_mask
 = (öt64Ë51 << (4 * 
b8
 - 2 * (b8 & 0x01));

414 
öt64
 *
cur_cbp
 = &
cuºMB
->
s_cbp
[
∂
].
blk
;

417 c⁄° 
	`byã
 (*
pos_sˇn8x8
Ë((
p_Vid
->
°ru˘uª
 =
FRAME
Ë&& (!
cuºMB
->
mb_fõld
)Ë? 
SNGL_SCAN8x8
[0] : 
FIELD_SCAN8x8
[0];

420 
boff_x
 = (
b8
&0x01) << 3;

421 
boff_y
 = (
b8
 >> 1) << 3;

422 
tc€ffs
 = &
cuºSli˚
->
mb_ºes
[
∂
][
boff_y
];

424 
cuºMB
->
subblock_x
 = 
boff_x
;

425 
cuºMB
->
subblock_y
 = 
boff_y
;

427 i‡(
∂
==
PLANE_Y
 || (
p_Vid
->
£∑øã_cﬁour_∂™e_Êag
 != 0))

428 
cuºSE
->
c⁄ãxt
 = 
LUMA_8x8
;

429 i‡(
∂
==
PLANE_U
)

430 
cuºSE
->
c⁄ãxt
 = 
CB_8x8
;

432 
cuºSE
->
c⁄ãxt
 = 
CR_8x8
;

434 
cuºSE
->
ªadög
 = 
ªadRunLevñ_CABAC
;

436 
k
=0; (k < 65Ë&& (
Àvñ
 != 0);++k)

444 
cuºSE
->
ty≥
 = ((
cuºMB
->
is_öåa_block
 == 1)

445 ? (
k
==0 ? 
SE_LUM_DC_INTRA
 : 
SE_LUM_AC_INTRA
)

446 : (
k
==0 ? 
SE_LUM_DC_INTER
 : 
SE_LUM_AC_INTER
));

448 #i‡
TRACE


449 i‡(
∂
==
PLANE_Y
)

450 
	`•rötf
(
cuºSE
->
åa˚°rög
, "Luma8x8 sng ");

451 i‡(
∂
==
PLANE_U
)

452 
	`•rötf
(
cuºSE
->
åa˚°rög
, "Cb 8x8 sng ");

454 
	`•rötf
(
cuºSE
->
åa˚°rög
, "Cr 8x8 sng ");

457 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
cuºSE
->
ty≥
]]);

458 
cuºSE
->
ªadög
 = 
ªadRunLevñ_CABAC
;

460 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, 
cuºSE
, dP);

461 
Àvñ
 = 
cuºSE
->
vÆue1
;

464 i‡(
Àvñ
 != 0)

466 
pos_sˇn8x8
 +2 * (
cuºSE
->
vÆue2
);

468 
i
 = *
pos_sˇn8x8
++;

469 
j
 = *
pos_sˇn8x8
++;

471 *
cur_cbp
 |
cbp_mask
;

473 
tc€ffs
[
j
][
boff_x
 + 
i
] = 
Àvñ
;

477 
	}
}

487 
	$ªad_comp_c€ff_8x8_MB_CABAC
 (
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
cuºSE
, 
Cﬁ‹Pœ√
 
∂
)

490 
	`ªadCompC€ff8x8_CABAC
 (
cuºMB
, 
cuºSE
, 
∂
, 0);

491 
	`ªadCompC€ff8x8_CABAC
 (
cuºMB
, 
cuºSE
, 
∂
, 1);

492 
	`ªadCompC€ff8x8_CABAC
 (
cuºMB
, 
cuºSE
, 
∂
, 2);

493 
	`ªadCompC€ff8x8_CABAC
 (
cuºMB
, 
cuºSE
, 
∂
, 3);

494 
	}
}

504 
	$ªad_comp_c€ff_8x8_MB_CABAC_ls
 (
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
cuºSE
, 
Cﬁ‹Pœ√
 
∂
)

507 
	`ªadCompC€ff8x8_CABAC_los¶ess
 (
cuºMB
, 
cuºSE
, 
∂
, 0);

508 
	`ªadCompC€ff8x8_CABAC_los¶ess
 (
cuºMB
, 
cuºSE
, 
∂
, 1);

509 
	`ªadCompC€ff8x8_CABAC_los¶ess
 (
cuºMB
, 
cuºSE
, 
∂
, 2);

510 
	`ªadCompC€ff8x8_CABAC_los¶ess
 (
cuºMB
, 
cuºSE
, 
∂
, 3);

511 
	}
}

521 
	$ªad_CBP_™d_c€ffs_‰om_NAL_CABAC_420
(
Ma¸oblock
 *
cuºMB
)

523 
i
,
j
;

524 
Àvñ
;

525 
cbp
;

526 
Sy¡axEÀmít
 
cuºSE
;

527 
D©aP¨tôi⁄
 *
dP
 = 
NULL
;

528 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

529 c⁄° 
byã
 *
∑πM≠
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
dp_mode
];

530 
i0
, 
j0
;

532 
qp_≥r
, 
qp_ªm
;

533 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

534 
smb
 = ((
p_Vid
->
ty≥
==
SP_SLICE
Ë&& (
cuºMB
->
is_öåa_block
 =
FALSE
)Ë|| (p_Vid->ty≥ =
SI_SLICE
 && cuºMB->
mb_ty≥
 =
SI4MB
);

536 
qp_≥r_uv
[2];

537 
qp_ªm_uv
[2];

539 
öåa
 = (
cuºMB
->
is_öåa_block
 =
TRUE
);

541 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
cuºSli˚
->dec_picture;

542 
yuv
 = 
dec_pi˘uª
->
chroma_f‹m©_idc
 - 1;

544 (*
InvLevñSˇÀ4x4
)[4] = 
NULL
;

547 c⁄° 
	`byã
 (*
pos_sˇn4x4
)[2] = ((
p_Vid
->
°ru˘uª
 =
FRAME
Ë&& (!
cuºMB
->
mb_fõld
)Ë? 
SNGL_SCAN
 : 
FIELD_SCAN
;

548 c⁄° 
byã
 *
pos_sˇn_4x4
 = 
pos_sˇn4x4
[0];

550 i‡(!
	`IS_I16MB
 (
cuºMB
))

552 
√ed_å™sf‹m_size_Êag
;

555 
cuºSE
.
ty≥
 = (
cuºMB
->
mb_ty≥
 =
I4MB
 || cuºMB->mb_ty≥ =
SI4MB
 || cuºMB->mb_ty≥ =
I8MB
)

556 ? 
SE_CBP_INTRA


557 : 
SE_CBP_INTER
;

559 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
cuºSE
.
ty≥
]]);

561 i‡(
dP
->
bô°ªam
->
ei_Êag
)

563 
cuºSE
.
m≠pög
 = (
cuºMB
->
mb_ty≥
 =
I4MB
 || cuºMB->mb_ty≥ =
SI4MB
 || cuºMB->mb_ty≥ =
I8MB
)

564 ? 
cuºSli˚
->
löfo_cbp_öåa


565 : 
cuºSli˚
->
löfo_cbp_öãr
;

569 
cuºSE
.
ªadög
 = 
ªad_CBP_CABAC
;

572 
	`TRACE_STRING
("coded_block_pattern");

573 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, &
cuºSE
, dP);

574 
cuºMB
->
cbp
 = cb∞
cuºSE
.
vÆue1
;

578 
√ed_å™sf‹m_size_Êag
 = (((
cuºMB
->
mb_ty≥
 >= 1 && currMB->mb_type <= 3)||

579 (
	`IS_DIRECT
(
cuºMB
Ë&& 
p_Vid
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
) ||

580 (
cuºMB
->
NoMbP¨tLessTh™8x8Fœg
))

581 && 
cuºMB
->
mb_ty≥
 !
I8MB
 && cuºMB->mb_ty≥ !
I4MB


582 && (
cuºMB
->
cbp
&15)

583 && 
cuºSli˚
->
Tønsf‹m8x8Mode
);

585 i‡(
√ed_å™sf‹m_size_Êag
)

587 
cuºSE
.
ty≥
 = 
SE_HEADER
;

588 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_HEADER
]]);

589 
cuºSE
.
ªadög
 = 
ªadMB_å™sf‹m_size_Êag_CABAC
;

590 
	`TRACE_STRING
("transform_size_8x8_flag");

593 i‡(
dP
->
bô°ªam
->
ei_Êag
)

595 
cuºSE
.
Àn
 = 1;

596 
	`ªadSy¡axEÀmít_FLC
(&
cuºSE
, 
dP
->
bô°ªam
);

600 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, &
cuºSE
, dP);

602 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = (
Boﬁón
Ë
cuºSE
.
vÆue1
;

608 i‡(
cbp
 !=0)

610 
	`ªad_dñè_qu™t
(&
cuºSE
, 
dP
, 
cuºMB
, 
∑πM≠
, ((cuºMB->
is_öåa_block
 =
FALSE
)Ë? 
SE_DELTA_QUANT_INTER
 : 
SE_DELTA_QUANT_INTRA
);

612 i‡(
cuºSli˚
->
dp_mode
)

614 i‡((
cuºMB
->
is_öåa_block
 =
FALSE
Ë&& 
cuºSli˚
->
dpC_NŸPª£¡
 )

615 
cuºMB
->
d∂_Êag
 = 1;

617 if–
öåa
 && 
cuºSli˚
->
dpB_NŸPª£¡
 )

619 
cuºMB
->
ei_Êag
 = 1;

620 
cuºMB
->
d∂_Êag
 = 1;

624 
	`check_dp_√ighb‹s
 (
cuºMB
);

625 i‡(
cuºMB
->
d∂_Êag
)

627 
cbp
 = 0;

628 
cuºMB
->
cbp
 = cbp;

635 
cbp
 = 
cuºMB
->cbp;

637 
	`ªad_dñè_qu™t
(&
cuºSE
, 
dP
, 
cuºMB
, 
∑πM≠
, 
SE_DELTA_QUANT_INTRA
);

639 i‡(
cuºSli˚
->
dp_mode
)

641 i‡(
cuºSli˚
->
dpB_NŸPª£¡
)

643 
cuºMB
->
ei_Êag
 = 1;

644 
cuºMB
->
d∂_Êag
 = 1;

646 
	`check_dp_√ighb‹s
 (
cuºMB
);

647 i‡(
cuºMB
->
d∂_Êag
)

649 
cuºMB
->
cbp
 = cbp = 0;

653 i‡(!
cuºMB
->
d∂_Êag
)

655 **
cof
 = 
cuºSli˚
->cof[0];

656 
k
;

657 
pos_sˇn_4x4
 = 
pos_sˇn4x4
[0];

659 
cuºSE
.
ty≥
 = 
SE_LUM_DC_INTRA
;

660 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
cuºSE
.
ty≥
]]);

662 
cuºSE
.
c⁄ãxt
 = 
LUMA_16DC
;

663 
cuºSE
.
ty≥
 = 
SE_LUM_DC_INTRA
;

665 i‡(
dP
->
bô°ªam
->
ei_Êag
)

667 
cuºSE
.
m≠pög
 = 
löfo_Àvrun_öãr
;

671 
cuºSE
.
ªadög
 = 
ªadRunLevñ_CABAC
;

674 
Àvñ
 = 1;

676 
k
 = 0; (k < 17Ë&& (
Àvñ
 != 0); ++k)

678 #i‡
TRACE


679 
	`¢¥ötf
(
cuºSE
.
åa˚°rög
, 
TRACESTRING_SIZE
, "DCÜuma 16x16 ");

681 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, &
cuºSE
, dP);

682 
Àvñ
 = 
cuºSE
.
vÆue1
;

684 i‡(
Àvñ
 != 0)

686 
pos_sˇn_4x4
 +(2 * 
cuºSE
.
vÆue2
);

688 
i0
 = ((*
pos_sˇn_4x4
++) << 2);

689 
j0
 = ((*
pos_sˇn_4x4
++) << 2);

691 
cof
[
j0
][
i0
] = 
Àvñ
;

696 if(
cuºMB
->
is_los¶ess
 =
FALSE
)

697 
	`ôøns_2
(
cuºMB
, (
Cﬁ‹Pœ√
Ë
cuºSli˚
->
cﬁour_∂™e_id
);

701 
	`upd©e_qp
(
cuºMB
, 
cuºSli˚
->
qp
);

703 
qp_≥r
 = 
p_Vid
->
qp_≥r_m©rix
[ 
cuºMB
->
qp_sˇÀd
[
cuºSli˚
->
cﬁour_∂™e_id
] ];

704 
qp_ªm
 = 
p_Vid
->
qp_ªm_m©rix
[ 
cuºMB
->
qp_sˇÀd
[
cuºSli˚
->
cﬁour_∂™e_id
] ];

709 i‡(
cbp
)

711 if(
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
)

714 
cuºMB
->
	`ªad_comp_c€ff_8x8_CABAC
 (cuºMB, &
cuºSE
, 
PLANE_Y
);

718 
InvLevñSˇÀ4x4
 = 
öåa
? 
cuºSli˚
->
InvLevñSˇÀ4x4_I¡ø
[cuºSli˚->
cﬁour_∂™e_id
][
qp_ªm
] : cuºSli˚->
InvLevñSˇÀ4x4_I¡î
[currSlice->colour_plane_id][qp_rem];

719 
cuºMB
->
	`ªad_comp_c€ff_4x4_CABAC
 (cuºMB, &
cuºSE
, 
PLANE_Y
, 
InvLevñSˇÀ4x4
, 
qp_≥r
, 
cbp
);

724 
i
=0; i < 2; ++i)

726 
qp_≥r_uv
[
i
] = 
p_Vid
->
qp_≥r_m©rix
[ 
cuºMB
->
qp_sˇÀd
[i + 1] ];

727 
qp_ªm_uv
[
i
] = 
p_Vid
->
qp_ªm_m©rix
[ 
cuºMB
->
qp_sˇÀd
[i + 1] ];

733 if(
cbp
>15)

735 
CBPSåu˘uª
 *
s_cbp
 = &
cuºMB
->s_cbp[0];

736 
uv
, 
Œ
, 
k
, 
c€f_˘r
;

738 
Œ
 = 0;Ül < 3;Ül += 2)

740 
uv
 = 
Œ
 >> 1;

742 
InvLevñSˇÀ4x4
 = 
öåa
 ? 
cuºSli˚
->
InvLevñSˇÀ4x4_I¡ø
[
uv
 + 1][
qp_ªm_uv
[uv]] : cuºSli˚->
InvLevñSˇÀ4x4_I¡î
[uv + 1][qp_rem_uv[uv]];

744 
	`mem£t
(
cuºSli˚
->
cofu
, 0, 4 *());

745 
c€f_˘r
=-1;

747 
Àvñ
 = 1;

748 
cuºMB
->
is_v_block
 = 
Œ
;

749 
cuºSE
.
c⁄ãxt
 = 
CHROMA_DC
;

750 
cuºSE
.
ty≥
 = (
öåa
 ? 
SE_CHR_DC_INTRA
 : 
SE_CHR_DC_INTER
);

752 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
cuºSE
.
ty≥
]]);

754 i‡(
dP
->
bô°ªam
->
ei_Êag
)

755 
cuºSE
.
m≠pög
 = 
löfo_Àvrun_c2x2
;

757 
cuºSE
.
ªadög
 = 
ªadRunLevñ_CABAC
;

759 
k
 = 0; (k < (
p_Vid
->
num_cdc_c€ff
 + 1))&&(
Àvñ
!=0);++k)

761 #i‡
TRACE


762 
	`¢¥ötf
(
cuºSE
.
åa˚°rög
, 
TRACESTRING_SIZE
, "2x2 DC Chroma ");

765 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, &
cuºSE
, dP);

766 
Àvñ
 = 
cuºSE
.
vÆue1
;

768 i‡(
Àvñ
 != 0)

770 
s_cbp
->
blk
 |0xf0000 << (
Œ
<<1) ;

771 
c€f_˘r
 +
cuºSE
.
vÆue2
 + 1;

781 
	`as£π
 (
c€f_˘r
 < 
p_Vid
->
num_cdc_c€ff
);

782 
cuºSli˚
->
cofu
[
c€f_˘r
] = 
Àvñ
;

787 i‡(
smb
 || (
cuºMB
->
is_los¶ess
 =
TRUE
))

789 
cuºSli˚
->
cof
[
uv
 + 1][0][0] = cuºSli˚->
cofu
[0];

790 
cuºSli˚
->
cof
[
uv
 + 1][0][4] = cuºSli˚->
cofu
[1];

791 
cuºSli˚
->
cof
[
uv
 + 1][4][0] = cuºSli˚->
cofu
[2];

792 
cuºSli˚
->
cof
[
uv
 + 1][4][4] = cuºSli˚->
cofu
[3];

800 
ãmp
[4];

801 
sˇÀ_dc
 = 
InvLevñSˇÀ4x4
[0][0];

802 **
cof
 = 
cuºSli˚
->cof[
uv
 + 1];

804 
	`ihadam¨d2x2
(
cuºSli˚
->
cofu
, 
ãmp
);

811 
cof
[0][0] = (((
ãmp
[0] * 
sˇÀ_dc
Ë<< 
qp_≥r_uv
[
uv
]) >> 5);

812 
cof
[0][4] = (((
ãmp
[1] * 
sˇÀ_dc
Ë<< 
qp_≥r_uv
[
uv
]) >> 5);

813 
cof
[4][0] = (((
ãmp
[2] * 
sˇÀ_dc
Ë<< 
qp_≥r_uv
[
uv
]) >> 5);

814 
cof
[4][4] = (((
ãmp
[3] * 
sˇÀ_dc
Ë<< 
qp_≥r_uv
[
uv
]) >> 5);

822 i‡(
cbp
 >31)

824 
cuºSE
.
c⁄ãxt
 = 
CHROMA_AC
;

825 
cuºSE
.
ty≥
 = (
cuºMB
->
is_öåa_block
 ? 
SE_CHR_AC_INTRA
 : 
SE_CHR_AC_INTER
);

827 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
cuºSE
.
ty≥
]]);

829 i‡(
dP
->
bô°ªam
->
ei_Êag
)

830 
cuºSE
.
m≠pög
 = 
löfo_Àvrun_öãr
;

832 
cuºSE
.
ªadög
 = 
ªadRunLevñ_CABAC
;

834 if(
cuºMB
->
is_los¶ess
 =
FALSE
)

836 
b4
, 
b8
, 
uv
, 
k
;

837 **
cof
;

838 
CBPSåu˘uª
 *
s_cbp
 = &
cuºMB
->s_cbp[0];

839 
b8
=0; b8 < 
p_Vid
->
num_blk8x8_uv
; ++b8)

841 
cuºMB
->
is_v_block
 = 
uv
 = (
b8
 > ((
p_Vid
->
num_uv_blocks
) - 1 ));

842 
InvLevñSˇÀ4x4
 = 
öåa
 ? 
cuºSli˚
->
InvLevñSˇÀ4x4_I¡ø
[
uv
 + 1][
qp_ªm_uv
[uv]] : cuºSli˚->
InvLevñSˇÀ4x4_I¡î
[uv + 1][qp_rem_uv[uv]];

843 
cof
 = 
cuºSli˚
->cof[
uv
 + 1];

845 
b4
 = 0; b4 < 4; ++b4)

847 
i
 = 
cofuv_blk_x
[
yuv
][
b8
][
b4
];

848 
j
 = 
cofuv_blk_y
[
yuv
][
b8
][
b4
];

850 
cuºMB
->
subblock_y
 = 
subblk_off£t_y
[
yuv
][
b8
][
b4
];

851 
cuºMB
->
subblock_x
 = 
subblk_off£t_x
[
yuv
][
b8
][
b4
];

853 
pos_sˇn_4x4
 = 
pos_sˇn4x4
[1];

854 
Àvñ
 = 1;

856 
k
 = 0; (k < 16Ë&& (
Àvñ
 != 0);++k)

858 #i‡
TRACE


859 
	`¢¥ötf
(
cuºSE
.
åa˚°rög
, 
TRACESTRING_SIZE
, "AC Chroma ");

862 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, &
cuºSE
, dP);

863 
Àvñ
 = 
cuºSE
.
vÆue1
;

865 i‡(
Àvñ
 != 0)

867 
s_cbp
->
blk
 |
	`i64_powî2
(
cbp_blk_chroma
[
b8
][
b4
]);

868 
pos_sˇn_4x4
 +(
cuºSE
.
vÆue2
 << 1);

870 
i0
 = *
pos_sˇn_4x4
++;

871 
j0
 = *
pos_sˇn_4x4
++;

873 
cof
[(
j
<<2Ë+ 
j0
][(
i
<<2Ë+ 
i0
] = 
	`rshi·_∫d_sf
((
Àvñ
 * 
InvLevñSˇÀ4x4
[j0][i0])<<
qp_≥r_uv
[
uv
], 4);

882 
CBPSåu˘uª
 *
s_cbp
 = &
cuºMB
->s_cbp[0];

883 
b4
, 
b8
, 
k
;

884 
uv
;

885 
b8
=0; b8 < 
p_Vid
->
num_blk8x8_uv
; ++b8)

887 
cuºMB
->
is_v_block
 = 
uv
 = (
b8
 > ((
p_Vid
->
num_uv_blocks
) - 1 ));

889 
b4
=0; b4 < 4; ++b4)

891 
i
 = 
cofuv_blk_x
[
yuv
][
b8
][
b4
];

892 
j
 = 
cofuv_blk_y
[
yuv
][
b8
][
b4
];

894 
pos_sˇn_4x4
 = 
pos_sˇn4x4
[1];

895 
Àvñ
=1;

897 
cuºMB
->
subblock_y
 = 
subblk_off£t_y
[
yuv
][
b8
][
b4
];

898 
cuºMB
->
subblock_x
 = 
subblk_off£t_x
[
yuv
][
b8
][
b4
];

900 
k
=0;(k<16)&&(
Àvñ
!=0);++k)

902 #i‡
TRACE


903 
	`¢¥ötf
(
cuºSE
.
åa˚°rög
, 
TRACESTRING_SIZE
, "AC Chroma ");

905 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, &
cuºSE
, dP);

906 
Àvñ
 = 
cuºSE
.
vÆue1
;

908 i‡(
Àvñ
 != 0)

910 
s_cbp
->
blk
 |
	`i64_powî2
(
cbp_blk_chroma
[
b8
][
b4
]);

911 
pos_sˇn_4x4
 +(
cuºSE
.
vÆue2
 << 1);

913 
i0
 = *
pos_sˇn_4x4
++;

914 
j0
 = *
pos_sˇn_4x4
++;

916 
cuºSli˚
->
cof
[
uv
 + 1][(
j
<<2Ë+ 
j0
][(
i
<<2Ë+ 
i0
] = 
Àvñ
;

924 
	}
}

934 
	$ªad_CBP_™d_c€ffs_‰om_NAL_CABAC_400
(
Ma¸oblock
 *
cuºMB
)

936 
k
;

937 
Àvñ
;

938 
cbp
;

939 
Sy¡axEÀmít
 
cuºSE
;

940 
D©aP¨tôi⁄
 *
dP
 = 
NULL
;

941 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

942 c⁄° 
byã
 *
∑πM≠
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
dp_mode
];

943 
i0
, 
j0
;

945 
qp_≥r
, 
qp_ªm
;

946 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

948 
öåa
 = (
cuºMB
->
is_öåa_block
 =
TRUE
);

950 
√ed_å™sf‹m_size_Êag
;

952 (*
InvLevñSˇÀ4x4
)[4] = 
NULL
;

954 c⁄° 
	`byã
 (*
pos_sˇn4x4
)[2] = ((
p_Vid
->
°ru˘uª
 =
FRAME
Ë&& (!
cuºMB
->
mb_fõld
)Ë? 
SNGL_SCAN
 : 
FIELD_SCAN
;

955 c⁄° 
byã
 *
pos_sˇn_4x4
 = 
pos_sˇn4x4
[0];

959 i‡(!
	`IS_I16MB
 (
cuºMB
))

963 
cuºSE
.
ty≥
 = (
cuºMB
->
mb_ty≥
 =
I4MB
 || cuºMB->mb_ty≥ =
SI4MB
 || cuºMB->mb_ty≥ =
I8MB
)

964 ? 
SE_CBP_INTRA


965 : 
SE_CBP_INTER
;

967 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
cuºSE
.
ty≥
]]);

969 i‡(
dP
->
bô°ªam
->
ei_Êag
)

971 
cuºSE
.
m≠pög
 = (
cuºMB
->
mb_ty≥
 =
I4MB
 || cuºMB->mb_ty≥ =
SI4MB
 || cuºMB->mb_ty≥ =
I8MB
)

972 ? 
cuºSli˚
->
löfo_cbp_öåa


973 : 
cuºSli˚
->
löfo_cbp_öãr
;

977 
cuºSE
.
ªadög
 = 
ªad_CBP_CABAC
;

980 
	`TRACE_STRING
("coded_block_pattern");

981 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, &
cuºSE
, dP);

982 
cuºMB
->
cbp
 = cb∞
cuºSE
.
vÆue1
;

987 
√ed_å™sf‹m_size_Êag
 = (((
cuºMB
->
mb_ty≥
 >= 1 && currMB->mb_type <= 3)||

988 (
	`IS_DIRECT
(
cuºMB
Ë&& 
p_Vid
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
) ||

989 (
cuºMB
->
NoMbP¨tLessTh™8x8Fœg
))

990 && 
cuºMB
->
mb_ty≥
 !
I8MB
 && cuºMB->mb_ty≥ !
I4MB


991 && (
cuºMB
->
cbp
&15)

992 && 
cuºSli˚
->
Tønsf‹m8x8Mode
);

994 i‡(
√ed_å™sf‹m_size_Êag
)

996 
cuºSE
.
ty≥
 = 
SE_HEADER
;

997 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_HEADER
]]);

998 
cuºSE
.
ªadög
 = 
ªadMB_å™sf‹m_size_Êag_CABAC
;

999 
	`TRACE_STRING
("transform_size_8x8_flag");

1002 i‡(
dP
->
bô°ªam
->
ei_Êag
)

1004 
cuºSE
.
Àn
 = 1;

1005 
	`ªadSy¡axEÀmít_FLC
(&
cuºSE
, 
dP
->
bô°ªam
);

1009 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, &
cuºSE
, dP);

1011 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = (
Boﬁón
Ë
cuºSE
.
vÆue1
;

1017 i‡(
cbp
 !=0)

1019 
	`ªad_dñè_qu™t
(&
cuºSE
, 
dP
, 
cuºMB
, 
∑πM≠
, ((cuºMB->
is_öåa_block
 =
FALSE
)Ë? 
SE_DELTA_QUANT_INTER
 : 
SE_DELTA_QUANT_INTRA
);

1021 i‡(
cuºSli˚
->
dp_mode
)

1023 i‡((
cuºMB
->
is_öåa_block
 =
FALSE
Ë&& 
cuºSli˚
->
dpC_NŸPª£¡
 )

1024 
cuºMB
->
d∂_Êag
 = 1;

1026 if–
öåa
 && 
cuºSli˚
->
dpB_NŸPª£¡
 )

1028 
cuºMB
->
ei_Êag
 = 1;

1029 
cuºMB
->
d∂_Êag
 = 1;

1033 
	`check_dp_√ighb‹s
 (
cuºMB
);

1034 i‡(
cuºMB
->
d∂_Êag
)

1036 
cbp
 = 0;

1037 
cuºMB
->
cbp
 = cbp;

1044 
cbp
 = 
cuºMB
->cbp;

1045 
	`ªad_dñè_qu™t
(&
cuºSE
, 
dP
, 
cuºMB
, 
∑πM≠
, 
SE_DELTA_QUANT_INTRA
);

1047 i‡(
cuºSli˚
->
dp_mode
)

1049 i‡(
cuºSli˚
->
dpB_NŸPª£¡
)

1051 
cuºMB
->
ei_Êag
 = 1;

1052 
cuºMB
->
d∂_Êag
 = 1;

1054 
	`check_dp_√ighb‹s
 (
cuºMB
);

1055 i‡(
cuºMB
->
d∂_Êag
)

1057 
cuºMB
->
cbp
 = cbp = 0;

1061 i‡(!
cuºMB
->
d∂_Êag
)

1063 
pos_sˇn_4x4
 = 
pos_sˇn4x4
[0];

1066 
cuºSE
.
ty≥
 = 
SE_LUM_DC_INTRA
;

1067 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
cuºSE
.
ty≥
]]);

1069 
cuºSE
.
c⁄ãxt
 = 
LUMA_16DC
;

1070 
cuºSE
.
ty≥
 = 
SE_LUM_DC_INTRA
;

1072 i‡(
dP
->
bô°ªam
->
ei_Êag
)

1074 
cuºSE
.
m≠pög
 = 
löfo_Àvrun_öãr
;

1078 
cuºSE
.
ªadög
 = 
ªadRunLevñ_CABAC
;

1081 
Àvñ
 = 1;

1083 
k
 = 0; (k < 17Ë&& (
Àvñ
 != 0); ++k)

1085 #i‡
TRACE


1086 
	`¢¥ötf
(
cuºSE
.
åa˚°rög
, 
TRACESTRING_SIZE
, "DCÜuma 16x16 ");

1088 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, &
cuºSE
, dP);

1089 
Àvñ
 = 
cuºSE
.
vÆue1
;

1091 i‡(
Àvñ
 != 0)

1093 
pos_sˇn_4x4
 +(2 * 
cuºSE
.
vÆue2
);

1095 
i0
 = ((*
pos_sˇn_4x4
++) << 2);

1096 
j0
 = ((*
pos_sˇn_4x4
++) << 2);

1098 
cuºSli˚
->
cof
[0][
j0
][
i0
] = 
Àvñ
;

1104 if(
cuºMB
->
is_los¶ess
 =
FALSE
)

1105 
	`ôøns_2
(
cuºMB
, (
Cﬁ‹Pœ√
Ë
cuºSli˚
->
cﬁour_∂™e_id
);

1109 
	`upd©e_qp
(
cuºMB
, 
cuºSli˚
->
qp
);

1111 
qp_≥r
 = 
p_Vid
->
qp_≥r_m©rix
[ 
cuºMB
->
qp_sˇÀd
[
PLANE_Y
] ];

1112 
qp_ªm
 = 
p_Vid
->
qp_ªm_m©rix
[ 
cuºMB
->
qp_sˇÀd
[
PLANE_Y
] ];

1116 i‡(
cbp
)

1118 if(
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
)

1121 
cuºMB
->
	`ªad_comp_c€ff_8x8_CABAC
 (cuºMB, &
cuºSE
, 
PLANE_Y
);

1125 
InvLevñSˇÀ4x4
 = 
öåa
? 
cuºSli˚
->
InvLevñSˇÀ4x4_I¡ø
[cuºSli˚->
cﬁour_∂™e_id
][
qp_ªm
] : cuºSli˚->
InvLevñSˇÀ4x4_I¡î
[currSlice->colour_plane_id][qp_rem];

1126 
cuºMB
->
	`ªad_comp_c€ff_4x4_CABAC
 (cuºMB, &
cuºSE
, 
PLANE_Y
, 
InvLevñSˇÀ4x4
, 
qp_≥r
, 
cbp
);

1129 
	}
}

1138 
	$ªad_CBP_™d_c€ffs_‰om_NAL_CABAC_444
(
Ma¸oblock
 *
cuºMB
)

1140 
i
, 
k
;

1141 
Àvñ
;

1142 
cbp
;

1143 
Sy¡axEÀmít
 
cuºSE
;

1144 
D©aP¨tôi⁄
 *
dP
 = 
NULL
;

1145 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1146 c⁄° 
byã
 *
∑πM≠
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
dp_mode
];

1147 
c€f_˘r
, 
i0
, 
j0
;

1149 
qp_≥r
, 
qp_ªm
;

1150 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1152 
uv
;

1153 
qp_≥r_uv
[2];

1154 
qp_ªm_uv
[2];

1156 
öåa
 = (
cuºMB
->
is_öåa_block
 =
TRUE
);

1159 
√ed_å™sf‹m_size_Êag
;

1161 (*
InvLevñSˇÀ4x4
)[4] = 
NULL
;

1163 c⁄° 
	`byã
 (*
pos_sˇn4x4
)[2] = ((
p_Vid
->
°ru˘uª
 =
FRAME
Ë&& (!
cuºMB
->
mb_fõld
)Ë? 
SNGL_SCAN
 : 
FIELD_SCAN
;

1164 c⁄° 
byã
 *
pos_sˇn_4x4
 = 
pos_sˇn4x4
[0];

1168 
i
=0; i<2; ++i)

1170 
qp_≥r_uv
[
i
] = 
p_Vid
->
qp_≥r_m©rix
[ 
cuºMB
->
qp_sˇÀd
[i + 1] ];

1171 
qp_ªm_uv
[
i
] = 
p_Vid
->
qp_ªm_m©rix
[ 
cuºMB
->
qp_sˇÀd
[i + 1] ];

1176 i‡(!
	`IS_I16MB
 (
cuºMB
))

1180 
cuºSE
.
ty≥
 = (
cuºMB
->
mb_ty≥
 =
I4MB
 || cuºMB->mb_ty≥ =
SI4MB
 || cuºMB->mb_ty≥ =
I8MB
)

1181 ? 
SE_CBP_INTRA


1182 : 
SE_CBP_INTER
;

1184 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
cuºSE
.
ty≥
]]);

1186 i‡(
dP
->
bô°ªam
->
ei_Êag
)

1188 
cuºSE
.
m≠pög
 = (
cuºMB
->
mb_ty≥
 =
I4MB
 || cuºMB->mb_ty≥ =
SI4MB
 || cuºMB->mb_ty≥ =
I8MB
)

1189 ? 
cuºSli˚
->
löfo_cbp_öåa


1190 : 
cuºSli˚
->
löfo_cbp_öãr
;

1194 
cuºSE
.
ªadög
 = 
ªad_CBP_CABAC
;

1197 
	`TRACE_STRING
("coded_block_pattern");

1198 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, &
cuºSE
, dP);

1199 
cuºMB
->
cbp
 = cb∞
cuºSE
.
vÆue1
;

1204 
√ed_å™sf‹m_size_Êag
 = (((
cuºMB
->
mb_ty≥
 >= 1 && currMB->mb_type <= 3)||

1205 (
	`IS_DIRECT
(
cuºMB
Ë&& 
p_Vid
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
) ||

1206 (
cuºMB
->
NoMbP¨tLessTh™8x8Fœg
))

1207 && 
cuºMB
->
mb_ty≥
 !
I8MB
 && cuºMB->mb_ty≥ !
I4MB


1208 && (
cuºMB
->
cbp
&15)

1209 && 
cuºSli˚
->
Tønsf‹m8x8Mode
);

1211 i‡(
√ed_å™sf‹m_size_Êag
)

1213 
cuºSE
.
ty≥
 = 
SE_HEADER
;

1214 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_HEADER
]]);

1215 
cuºSE
.
ªadög
 = 
ªadMB_å™sf‹m_size_Êag_CABAC
;

1216 
	`TRACE_STRING
("transform_size_8x8_flag");

1219 i‡(
dP
->
bô°ªam
->
ei_Êag
)

1221 
cuºSE
.
Àn
 = 1;

1222 
	`ªadSy¡axEÀmít_FLC
(&
cuºSE
, 
dP
->
bô°ªam
);

1226 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, &
cuºSE
, dP);

1228 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = (
Boﬁón
Ë
cuºSE
.
vÆue1
;

1234 i‡(
cbp
 !=0)

1236 
	`ªad_dñè_qu™t
(&
cuºSE
, 
dP
, 
cuºMB
, 
∑πM≠
, ((cuºMB->
is_öåa_block
 =
FALSE
)Ë? 
SE_DELTA_QUANT_INTER
 : 
SE_DELTA_QUANT_INTRA
);

1238 i‡(
cuºSli˚
->
dp_mode
)

1240 i‡((
cuºMB
->
is_öåa_block
 =
FALSE
Ë&& 
cuºSli˚
->
dpC_NŸPª£¡
 )

1241 
cuºMB
->
d∂_Êag
 = 1;

1243 if–
öåa
 && 
cuºSli˚
->
dpB_NŸPª£¡
 )

1245 
cuºMB
->
ei_Êag
 = 1;

1246 
cuºMB
->
d∂_Êag
 = 1;

1250 
	`check_dp_√ighb‹s
 (
cuºMB
);

1251 i‡(
cuºMB
->
d∂_Êag
)

1253 
cbp
 = 0;

1254 
cuºMB
->
cbp
 = cbp;

1261 
cbp
 = 
cuºMB
->cbp;

1263 
	`ªad_dñè_qu™t
(&
cuºSE
, 
dP
, 
cuºMB
, 
∑πM≠
, 
SE_DELTA_QUANT_INTRA
);

1265 i‡(
cuºSli˚
->
dp_mode
)

1267 i‡(
cuºSli˚
->
dpB_NŸPª£¡
)

1269 
cuºMB
->
ei_Êag
 = 1;

1270 
cuºMB
->
d∂_Êag
 = 1;

1272 
	`check_dp_√ighb‹s
 (
cuºMB
);

1273 i‡(
cuºMB
->
d∂_Êag
)

1275 
cuºMB
->
cbp
 = cbp = 0;

1279 i‡(!
cuºMB
->
d∂_Êag
)

1281 
pos_sˇn_4x4
 = 
pos_sˇn4x4
[0];

1284 
cuºSE
.
ty≥
 = 
SE_LUM_DC_INTRA
;

1285 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
cuºSE
.
ty≥
]]);

1287 
cuºSE
.
c⁄ãxt
 = 
LUMA_16DC
;

1288 
cuºSE
.
ty≥
 = 
SE_LUM_DC_INTRA
;

1290 i‡(
dP
->
bô°ªam
->
ei_Êag
)

1292 
cuºSE
.
m≠pög
 = 
löfo_Àvrun_öãr
;

1296 
cuºSE
.
ªadög
 = 
ªadRunLevñ_CABAC
;

1299 
Àvñ
 = 1;

1301 
k
 = 0; (k < 17Ë&& (
Àvñ
 != 0); ++k)

1303 #i‡
TRACE


1304 
	`¢¥ötf
(
cuºSE
.
åa˚°rög
, 
TRACESTRING_SIZE
, "DCÜuma 16x16 ");

1306 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, &
cuºSE
, dP);

1307 
Àvñ
 = 
cuºSE
.
vÆue1
;

1309 i‡(
Àvñ
 != 0)

1311 
pos_sˇn_4x4
 +(2 * 
cuºSE
.
vÆue2
);

1313 
i0
 = ((*
pos_sˇn_4x4
++) << 2);

1314 
j0
 = ((*
pos_sˇn_4x4
++) << 2);

1316 
cuºSli˚
->
cof
[0][
j0
][
i0
] = 
Àvñ
;

1322 if(
cuºMB
->
is_los¶ess
 =
FALSE
)

1323 
	`ôøns_2
(
cuºMB
, (
Cﬁ‹Pœ√
Ë
cuºSli˚
->
cﬁour_∂™e_id
);

1327 
	`upd©e_qp
(
cuºMB
, 
cuºSli˚
->
qp
);

1329 
qp_≥r
 = 
p_Vid
->
qp_≥r_m©rix
[ 
cuºMB
->
qp_sˇÀd
[
cuºSli˚
->
cﬁour_∂™e_id
] ];

1330 
qp_ªm
 = 
p_Vid
->
qp_ªm_m©rix
[ 
cuºMB
->
qp_sˇÀd
[
cuºSli˚
->
cﬁour_∂™e_id
] ];

1333 
i
=0; i < 2; ++i)

1335 
qp_≥r_uv
[
i
] = 
p_Vid
->
qp_≥r_m©rix
[ 
cuºMB
->
qp_sˇÀd
[i + 1] ];

1336 
qp_ªm_uv
[
i
] = 
p_Vid
->
qp_ªm_m©rix
[ 
cuºMB
->
qp_sˇÀd
[i + 1] ];

1340 
InvLevñSˇÀ4x4
 = 
öåa
? 
cuºSli˚
->
InvLevñSˇÀ4x4_I¡ø
[cuºSli˚->
cﬁour_∂™e_id
][
qp_ªm
] : cuºSli˚->
InvLevñSˇÀ4x4_I¡î
[currSlice->colour_plane_id][qp_rem];

1346 i‡(
cbp
)

1348 if(
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
)

1351 
cuºMB
->
	`ªad_comp_c€ff_8x8_CABAC
 (cuºMB, &
cuºSE
, 
PLANE_Y
);

1355 
cuºMB
->
	`ªad_comp_c€ff_4x4_CABAC
 (cuºMB, &
cuºSE
, 
PLANE_Y
, 
InvLevñSˇÀ4x4
, 
qp_≥r
, 
cbp
);

1360 
uv
 = 0; uv < 2; ++uv )

1363 i‡(
	`IS_I16MB
 (
cuºMB
))

1366 
cuºSE
.
ty≥
 = 
SE_LUM_DC_INTRA
;

1367 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
cuºSE
.
ty≥
]]);

1369 if–(
p_Vid
->
£∑øã_cﬁour_∂™e_Êag
 != 0) )

1370 
cuºSE
.
c⁄ãxt
 = 
LUMA_16DC
;

1372 
cuºSE
.
c⁄ãxt
 = (
uv
==0Ë? 
CB_16DC
 : 
CR_16DC
;

1374 i‡(
dP
->
bô°ªam
->
ei_Êag
)

1376 
cuºSE
.
m≠pög
 = 
löfo_Àvrun_öãr
;

1380 
cuºSE
.
ªadög
 = 
ªadRunLevñ_CABAC
;

1383 
c€f_˘r
 = -1;

1384 
Àvñ
 = 1;

1386 
k
=0;(k<17Ë&& (
Àvñ
!=0);++k)

1388 #i‡
TRACE


1389 i‡(
uv
 == 0)

1390 
	`¢¥ötf
(
cuºSE
.
åa˚°rög
, 
TRACESTRING_SIZE
, "DC Cb 16x16 ");

1392 
	`¢¥ötf
(
cuºSE
.
åa˚°rög
, 
TRACESTRING_SIZE
, "DC Cr 16x16 ");

1395 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, &
cuºSE
, dP);

1396 
Àvñ
 = 
cuºSE
.
vÆue1
;

1398 i‡(
Àvñ
 != 0)

1400 
c€f_˘r
 +
cuºSE
.
vÆue2
 + 1;

1402 
i0
 = 
pos_sˇn4x4
[
c€f_˘r
][0];

1403 
j0
 = 
pos_sˇn4x4
[
c€f_˘r
][1];

1404 
cuºSli˚
->
cof
[
uv
 + 1][
j0
<<2][
i0
<<2] = 
Àvñ
;

1410 if(
cuºMB
->
is_los¶ess
 =
FALSE
)

1412 
	`ôøns_2
(
cuºMB
, (
Cﬁ‹Pœ√
Ë(
uv
 + 1));

1416 
	`upd©e_qp
(
cuºMB
, 
cuºSli˚
->
qp
);

1418 
qp_≥r
 = 
p_Vid
->
qp_≥r_m©rix
[ (
cuºSli˚
->
qp
 +Ö_Vid->
bôdïth_luma_qp_sˇÀ
) ];

1419 
qp_ªm
 = 
p_Vid
->
qp_ªm_m©rix
[ (
cuºSli˚
->
qp
 +Ö_Vid->
bôdïth_luma_qp_sˇÀ
) ];

1422 
qp_≥r_uv
[
uv
] = 
p_Vid
->
qp_≥r_m©rix
[ (
cuºMB
->
qpc
[uv] +Ö_Vid->
bôdïth_chroma_qp_sˇÀ
) ];

1423 
qp_ªm_uv
[
uv
] = 
p_Vid
->
qp_ªm_m©rix
[ (
cuºMB
->
qpc
[uv] +Ö_Vid->
bôdïth_chroma_qp_sˇÀ
) ];

1425 
InvLevñSˇÀ4x4
 = 
öåa
? 
cuºSli˚
->
InvLevñSˇÀ4x4_I¡ø
[
uv
 + 1][
qp_ªm_uv
[uv]] : cuºSli˚->
InvLevñSˇÀ4x4_I¡î
[uv + 1][qp_rem_uv[uv]];

1428 i‡(
cbp
)

1430 if(
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
)

1433 
cuºMB
->
	`ªad_comp_c€ff_8x8_CABAC
 (cuºMB, &
cuºSE
, (
Cﬁ‹Pœ√
Ë(
PLANE_U
 + 
uv
));

1437 
cuºMB
->
	`ªad_comp_c€ff_4x4_CABAC
 (cuºMB, &
cuºSE
, (
Cﬁ‹Pœ√
Ë(
PLANE_U
 + 
uv
), 
InvLevñSˇÀ4x4
, 
qp_≥r_uv
[uv], 
cbp
);

1442 
	}
}

1451 
	$ªad_CBP_™d_c€ffs_‰om_NAL_CABAC_422
(
Ma¸oblock
 *
cuºMB
)

1453 
i
,
j
,
k
;

1454 
Àvñ
;

1455 
cbp
;

1456 
Sy¡axEÀmít
 
cuºSE
;

1457 
D©aP¨tôi⁄
 *
dP
 = 
NULL
;

1458 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1459 c⁄° 
byã
 *
∑πM≠
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
dp_mode
];

1460 
c€f_˘r
, 
i0
, 
j0
, 
b8
;

1461 
Œ
;

1463 
qp_≥r
, 
qp_ªm
;

1464 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1466 
uv
;

1467 
qp_≥r_uv
[2];

1468 
qp_ªm_uv
[2];

1470 
öåa
 = (
cuºMB
->
is_öåa_block
 =
TRUE
);

1472 
b4
;

1473 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
cuºSli˚
->dec_picture;

1474 
yuv
 = 
dec_pi˘uª
->
chroma_f‹m©_idc
 - 1;

1475 
m6
[4];

1477 
√ed_å™sf‹m_size_Êag
;

1479 (*
InvLevñSˇÀ4x4
)[4] = 
NULL
;

1481 c⁄° 
	`byã
 (*
pos_sˇn4x4
)[2] = ((
p_Vid
->
°ru˘uª
 =
FRAME
Ë&& (!
cuºMB
->
mb_fõld
)Ë? 
SNGL_SCAN
 : 
FIELD_SCAN
;

1482 c⁄° 
byã
 *
pos_sˇn_4x4
 = 
pos_sˇn4x4
[0];

1486 
i
=0; i<2; ++i)

1488 
qp_≥r_uv
[
i
] = 
p_Vid
->
qp_≥r_m©rix
[ 
cuºMB
->
qp_sˇÀd
[i + 1] ];

1489 
qp_ªm_uv
[
i
] = 
p_Vid
->
qp_ªm_m©rix
[ 
cuºMB
->
qp_sˇÀd
[i + 1] ];

1493 i‡(!
	`IS_I16MB
 (
cuºMB
))

1497 
cuºSE
.
ty≥
 = (
cuºMB
->
mb_ty≥
 =
I4MB
 || cuºMB->mb_ty≥ =
SI4MB
 || cuºMB->mb_ty≥ =
I8MB
)

1498 ? 
SE_CBP_INTRA


1499 : 
SE_CBP_INTER
;

1501 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
cuºSE
.
ty≥
]]);

1503 i‡(
dP
->
bô°ªam
->
ei_Êag
)

1505 
cuºSE
.
m≠pög
 = (
cuºMB
->
mb_ty≥
 =
I4MB
 || cuºMB->mb_ty≥ =
SI4MB
 || cuºMB->mb_ty≥ =
I8MB
)

1506 ? 
cuºSli˚
->
löfo_cbp_öåa


1507 : 
cuºSli˚
->
löfo_cbp_öãr
;

1511 
cuºSE
.
ªadög
 = 
ªad_CBP_CABAC
;

1514 
	`TRACE_STRING
("coded_block_pattern");

1515 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, &
cuºSE
, dP);

1516 
cuºMB
->
cbp
 = cb∞
cuºSE
.
vÆue1
;

1521 
√ed_å™sf‹m_size_Êag
 = (((
cuºMB
->
mb_ty≥
 >= 1 && currMB->mb_type <= 3)||

1522 (
	`IS_DIRECT
(
cuºMB
Ë&& 
p_Vid
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
) ||

1523 (
cuºMB
->
NoMbP¨tLessTh™8x8Fœg
))

1524 && 
cuºMB
->
mb_ty≥
 !
I8MB
 && cuºMB->mb_ty≥ !
I4MB


1525 && (
cuºMB
->
cbp
&15)

1526 && 
cuºSli˚
->
Tønsf‹m8x8Mode
);

1528 i‡(
√ed_å™sf‹m_size_Êag
)

1530 
cuºSE
.
ty≥
 = 
SE_HEADER
;

1531 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_HEADER
]]);

1532 
cuºSE
.
ªadög
 = 
ªadMB_å™sf‹m_size_Êag_CABAC
;

1533 
	`TRACE_STRING
("transform_size_8x8_flag");

1536 i‡(
dP
->
bô°ªam
->
ei_Êag
)

1538 
cuºSE
.
Àn
 = 1;

1539 
	`ªadSy¡axEÀmít_FLC
(&
cuºSE
, 
dP
->
bô°ªam
);

1543 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, &
cuºSE
, dP);

1545 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = (
Boﬁón
Ë
cuºSE
.
vÆue1
;

1551 i‡(
cbp
 !=0)

1553 
	`ªad_dñè_qu™t
(&
cuºSE
, 
dP
, 
cuºMB
, 
∑πM≠
, ((cuºMB->
is_öåa_block
 =
FALSE
)Ë? 
SE_DELTA_QUANT_INTER
 : 
SE_DELTA_QUANT_INTRA
);

1555 i‡(
cuºSli˚
->
dp_mode
)

1557 i‡((
cuºMB
->
is_öåa_block
 =
FALSE
Ë&& 
cuºSli˚
->
dpC_NŸPª£¡
 )

1558 
cuºMB
->
d∂_Êag
 = 1;

1560 if–
öåa
 && 
cuºSli˚
->
dpB_NŸPª£¡
 )

1562 
cuºMB
->
ei_Êag
 = 1;

1563 
cuºMB
->
d∂_Êag
 = 1;

1567 
	`check_dp_√ighb‹s
 (
cuºMB
);

1568 i‡(
cuºMB
->
d∂_Êag
)

1570 
cbp
 = 0;

1571 
cuºMB
->
cbp
 = cbp;

1578 
cbp
 = 
cuºMB
->cbp;

1580 
	`ªad_dñè_qu™t
(&
cuºSE
, 
dP
, 
cuºMB
, 
∑πM≠
, 
SE_DELTA_QUANT_INTRA
);

1582 i‡(
cuºSli˚
->
dp_mode
)

1584 i‡(
cuºSli˚
->
dpB_NŸPª£¡
)

1586 
cuºMB
->
ei_Êag
 = 1;

1587 
cuºMB
->
d∂_Êag
 = 1;

1589 
	`check_dp_√ighb‹s
 (
cuºMB
);

1590 i‡(
cuºMB
->
d∂_Êag
)

1592 
cuºMB
->
cbp
 = cbp = 0;

1596 i‡(!
cuºMB
->
d∂_Êag
)

1598 
pos_sˇn_4x4
 = 
pos_sˇn4x4
[0];

1601 
cuºSE
.
ty≥
 = 
SE_LUM_DC_INTRA
;

1602 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
cuºSE
.
ty≥
]]);

1604 
cuºSE
.
c⁄ãxt
 = 
LUMA_16DC
;

1605 
cuºSE
.
ty≥
 = 
SE_LUM_DC_INTRA
;

1607 i‡(
dP
->
bô°ªam
->
ei_Êag
)

1609 
cuºSE
.
m≠pög
 = 
löfo_Àvrun_öãr
;

1613 
cuºSE
.
ªadög
 = 
ªadRunLevñ_CABAC
;

1616 
Àvñ
 = 1;

1618 
k
 = 0; (k < 17Ë&& (
Àvñ
 != 0); ++k)

1620 #i‡
TRACE


1621 
	`¢¥ötf
(
cuºSE
.
åa˚°rög
, 
TRACESTRING_SIZE
, "DCÜuma 16x16 ");

1623 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, &
cuºSE
, dP);

1624 
Àvñ
 = 
cuºSE
.
vÆue1
;

1626 i‡(
Àvñ
 != 0)

1628 
pos_sˇn_4x4
 +(2 * 
cuºSE
.
vÆue2
);

1630 
i0
 = ((*
pos_sˇn_4x4
++) << 2);

1631 
j0
 = ((*
pos_sˇn_4x4
++) << 2);

1633 
cuºSli˚
->
cof
[0][
j0
][
i0
] = 
Àvñ
;

1639 if(
cuºMB
->
is_los¶ess
 =
FALSE
)

1640 
	`ôøns_2
(
cuºMB
, (
Cﬁ‹Pœ√
Ë
cuºSli˚
->
cﬁour_∂™e_id
);

1644 
	`upd©e_qp
(
cuºMB
, 
cuºSli˚
->
qp
);

1646 
qp_≥r
 = 
p_Vid
->
qp_≥r_m©rix
[ 
cuºMB
->
qp_sˇÀd
[
cuºSli˚
->
cﬁour_∂™e_id
] ];

1647 
qp_ªm
 = 
p_Vid
->
qp_ªm_m©rix
[ 
cuºMB
->
qp_sˇÀd
[
cuºSli˚
->
cﬁour_∂™e_id
] ];

1650 
i
=0; i < 2; ++i)

1652 
qp_≥r_uv
[
i
] = 
p_Vid
->
qp_≥r_m©rix
[ 
cuºMB
->
qp_sˇÀd
[i + 1] ];

1653 
qp_ªm_uv
[
i
] = 
p_Vid
->
qp_ªm_m©rix
[ 
cuºMB
->
qp_sˇÀd
[i + 1] ];

1656 
InvLevñSˇÀ4x4
 = 
öåa
? 
cuºSli˚
->
InvLevñSˇÀ4x4_I¡ø
[cuºSli˚->
cﬁour_∂™e_id
][
qp_ªm
] : cuºSli˚->
InvLevñSˇÀ4x4_I¡î
[currSlice->colour_plane_id][qp_rem];

1662 i‡(
cbp
)

1664 if(
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
)

1667 
cuºMB
->
	`ªad_comp_c€ff_8x8_CABAC
 (cuºMB, &
cuºSE
, 
PLANE_Y
);

1671 
cuºMB
->
	`ªad_comp_c€ff_4x4_CABAC
 (cuºMB, &
cuºSE
, 
PLANE_Y
, 
InvLevñSˇÀ4x4
, 
qp_≥r
, 
cbp
);

1679 if(
cbp
>15)

1681 
Œ
=0;ll<3;ll+=2)

1683 (*
InvLevñSˇÀ4x4
)[4] = 
NULL
;

1684 
uv
 = 
Œ
>>1;

1686 **
imgcof
 = 
cuºSli˚
->
cof
[
uv
 + 1];

1687 
m3
[2][4] = {{0,0,0,0},{0,0,0,0}};

1688 
m4
[2][4] = {{0,0,0,0},{0,0,0,0}};

1689 
qp_≥r_uv_dc
 = 
p_Vid
->
qp_≥r_m©rix
[ (
cuºMB
->
qpc
[
uv
] + 3 +Ö_Vid->
bôdïth_chroma_qp_sˇÀ
) ];

1690 
qp_ªm_uv_dc
 = 
p_Vid
->
qp_ªm_m©rix
[ (
cuºMB
->
qpc
[
uv
] + 3 +Ö_Vid->
bôdïth_chroma_qp_sˇÀ
) ];

1691 i‡(
öåa
)

1692 
InvLevñSˇÀ4x4
 = 
cuºSli˚
->
InvLevñSˇÀ4x4_I¡ø
[
uv
 + 1][
qp_ªm_uv_dc
];

1694 
InvLevñSˇÀ4x4
 = 
cuºSli˚
->
InvLevñSˇÀ4x4_I¡î
[
uv
 + 1][
qp_ªm_uv_dc
];

1699 
CBPSåu˘uª
 *
s_cbp
 = &
cuºMB
->s_cbp[0];

1700 
c€f_˘r
=-1;

1701 
Àvñ
=1;

1702 
k
=0;(k<9)&&(
Àvñ
!=0);++k)

1704 
cuºSE
.
c⁄ãxt
 = 
CHROMA_DC_2x4
;

1705 
cuºSE
.
ty≥
 = ((
cuºMB
->
is_öåa_block
 =
TRUE
Ë? 
SE_CHR_DC_INTRA
 : 
SE_CHR_DC_INTER
);

1706 
cuºMB
->
is_v_block
 = 
Œ
;

1708 #i‡
TRACE


1709 
	`¢¥ötf
(
cuºSE
.
åa˚°rög
, 
TRACESTRING_SIZE
, "2x4 DC Chroma ");

1711 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
cuºSE
.
ty≥
]]);

1713 i‡(
dP
->
bô°ªam
->
ei_Êag
)

1714 
cuºSE
.
m≠pög
 = 
löfo_Àvrun_c2x2
;

1716 
cuºSE
.
ªadög
 = 
ªadRunLevñ_CABAC
;

1718 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, &
cuºSE
, dP);

1720 
Àvñ
 = 
cuºSE
.
vÆue1
;

1722 i‡(
Àvñ
 != 0)

1724 
s_cbp
->
blk
 |((
öt64
)0xff0000Ë<< (
Œ
<<2) ;

1725 
c€f_˘r
 +
cuºSE
.
vÆue2
 + 1;

1726 
	`as£π
 (
c€f_˘r
 < 
p_Vid
->
num_cdc_c€ff
);

1727 
i0
=
SCAN_YUV422
[
c€f_˘r
][0];

1728 
j0
=
SCAN_YUV422
[
c€f_˘r
][1];

1730 
m3
[
i0
][
j0
]=
Àvñ
;

1736 if(
cuºMB
->
is_los¶ess
 =
FALSE
)

1738 
m4
[0][0] = 
m3
[0][0] + m3[1][0];

1739 
m4
[0][1] = 
m3
[0][1] + m3[1][1];

1740 
m4
[0][2] = 
m3
[0][2] + m3[1][2];

1741 
m4
[0][3] = 
m3
[0][3] + m3[1][3];

1743 
m4
[1][0] = 
m3
[0][0] - m3[1][0];

1744 
m4
[1][1] = 
m3
[0][1] - m3[1][1];

1745 
m4
[1][2] = 
m3
[0][2] - m3[1][2];

1746 
m4
[1][3] = 
m3
[0][3] - m3[1][3];

1748 
i
 = 0; i < 2; ++i)

1750 
m6
[0] = 
m4
[
i
][0] + m4[i][2];

1751 
m6
[1] = 
m4
[
i
][0] - m4[i][2];

1752 
m6
[2] = 
m4
[
i
][1] - m4[i][3];

1753 
m6
[3] = 
m4
[
i
][1] + m4[i][3];

1755 
imgcof
[ 0][
i
<<2] = 
m6
[0] + m6[3];

1756 
imgcof
[ 4][
i
<<2] = 
m6
[1] + m6[2];

1757 
imgcof
[ 8][
i
<<2] = 
m6
[1] - m6[2];

1758 
imgcof
[12][
i
<<2] = 
m6
[0] - m6[3];

1761 
j
 = 0;j < 
p_Vid
->
mb_¸_size_y
; j +
BLOCK_SIZE
)

1763 
i
=0;ò< 
p_Vid
->
mb_¸_size_x
;i+=
BLOCK_SIZE
)

1765 
imgcof
[
j
][
i
] = 
	`rshi·_∫d_sf
((imgcof[j][i] * 
InvLevñSˇÀ4x4
[0][0]Ë<< 
qp_≥r_uv_dc
, 6);

1771 
j
=0;j<4;++j)

1773 
i
=0;i<2;++i)

1775 
cuºSli˚
->
cof
[
uv
 + 1][
j
<<2][
i
<<2] = 
m3
[i][j];

1788 i‡(
cbp
<=31)

1794 
cuºSE
.
c⁄ãxt
 = 
CHROMA_AC
;

1795 
cuºSE
.
ty≥
 = (
cuºMB
->
is_öåa_block
 ? 
SE_CHR_AC_INTRA
 : 
SE_CHR_AC_INTER
);

1797 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
cuºSE
.
ty≥
]]);

1799 i‡(
dP
->
bô°ªam
->
ei_Êag
)

1800 
cuºSE
.
m≠pög
 = 
löfo_Àvrun_öãr
;

1802 
cuºSE
.
ªadög
 = 
ªadRunLevñ_CABAC
;

1804 if(
cuºMB
->
is_los¶ess
 =
FALSE
)

1806 
CBPSåu˘uª
 *
s_cbp
 = &
cuºMB
->s_cbp[0];

1807 
b8
=0; b8 < 
p_Vid
->
num_blk8x8_uv
; ++b8)

1809 
cuºMB
->
is_v_block
 = 
uv
 = (
b8
 > ((
p_Vid
->
num_uv_blocks
) - 1 ));

1810 
InvLevñSˇÀ4x4
 = 
öåa
 ? 
cuºSli˚
->
InvLevñSˇÀ4x4_I¡ø
[
uv
 + 1][
qp_ªm_uv
[uv]] : cuºSli˚->
InvLevñSˇÀ4x4_I¡î
[uv + 1][qp_rem_uv[uv]];

1812 
b4
 = 0; b4 < 4; ++b4)

1814 
i
 = 
cofuv_blk_x
[
yuv
][
b8
][
b4
];

1815 
j
 = 
cofuv_blk_y
[
yuv
][
b8
][
b4
];

1817 
cuºMB
->
subblock_y
 = 
subblk_off£t_y
[
yuv
][
b8
][
b4
];

1818 
cuºMB
->
subblock_x
 = 
subblk_off£t_x
[
yuv
][
b8
][
b4
];

1820 
pos_sˇn_4x4
 = 
pos_sˇn4x4
[1];

1821 
Àvñ
=1;

1823 
k
 = 0; (k < 16Ë&& (
Àvñ
 != 0);++k)

1825 #i‡
TRACE


1826 
	`¢¥ötf
(
cuºSE
.
åa˚°rög
, 
TRACESTRING_SIZE
, "AC Chroma ");

1829 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, &
cuºSE
, dP);

1830 
Àvñ
 = 
cuºSE
.
vÆue1
;

1832 i‡(
Àvñ
 != 0)

1834 
s_cbp
->
blk
 |
	`i64_powî2
(
cbp_blk_chroma
[
b8
][
b4
]);

1835 
pos_sˇn_4x4
 +(
cuºSE
.
vÆue2
 << 1);

1837 
i0
 = *
pos_sˇn_4x4
++;

1838 
j0
 = *
pos_sˇn_4x4
++;

1840 
cuºSli˚
->
cof
[
uv
 + 1][(
j
<<2Ë+ 
j0
][(
i
<<2Ë+ 
i0
] = 
	`rshi·_∫d_sf
((
Àvñ
 * 
InvLevñSˇÀ4x4
[j0][i0])<<
qp_≥r_uv
[uv], 4);

1849 
CBPSåu˘uª
 *
s_cbp
 = &
cuºMB
->s_cbp[0];

1850 
b8
=0; b8 < 
p_Vid
->
num_blk8x8_uv
; ++b8)

1852 
cuºMB
->
is_v_block
 = 
uv
 = (
b8
 > ((
p_Vid
->
num_uv_blocks
) - 1 ));

1854 
b4
=0; b4 < 4; ++b4)

1856 
i
 = 
cofuv_blk_x
[
yuv
][
b8
][
b4
];

1857 
j
 = 
cofuv_blk_y
[
yuv
][
b8
][
b4
];

1859 
pos_sˇn_4x4
 = 
pos_sˇn4x4
[1];

1860 
Àvñ
=1;

1862 
cuºMB
->
subblock_y
 = 
subblk_off£t_y
[
yuv
][
b8
][
b4
];

1863 
cuºMB
->
subblock_x
 = 
subblk_off£t_x
[
yuv
][
b8
][
b4
];

1865 
k
=0;(k<16)&&(
Àvñ
!=0);++k)

1867 #i‡
TRACE


1868 
	`¢¥ötf
(
cuºSE
.
åa˚°rög
, 
TRACESTRING_SIZE
, "AC Chroma ");

1870 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, &
cuºSE
, dP);

1871 
Àvñ
 = 
cuºSE
.
vÆue1
;

1873 i‡(
Àvñ
 != 0)

1875 
s_cbp
->
blk
 |
	`i64_powî2
(
cbp_blk_chroma
[
b8
][
b4
]);

1876 
pos_sˇn_4x4
 +(
cuºSE
.
vÆue2
 << 1);

1878 
i0
 = *
pos_sˇn_4x4
++;

1879 
j0
 = *
pos_sˇn_4x4
++;

1881 
cuºSli˚
->
cof
[
uv
 + 1][(
j
<<2Ë+ 
j0
][(
i
<<2Ë+ 
i0
] = 
Àvñ
;

1890 
	}
}

1892 
	$£t_ªad_CBP_™d_c€ffs_ˇbac
(
Sli˚
 *
cuºSli˚
)

1894 
cuºSli˚
->
p_Vid
->
a˘ive_•s
->
chroma_f‹m©_idc
)

1896 
YUV444
:

1897 i‡(
cuºSli˚
->
p_Vid
->
£∑øã_cﬁour_∂™e_Êag
 == 0)

1899 
cuºSli˚
->
ªad_CBP_™d_c€ffs_‰om_NAL
 = 
ªad_CBP_™d_c€ffs_‰om_NAL_CABAC_444
;

1903 
cuºSli˚
->
ªad_CBP_™d_c€ffs_‰om_NAL
 = 
ªad_CBP_™d_c€ffs_‰om_NAL_CABAC_400
;

1906 
YUV422
:

1907 
cuºSli˚
->
ªad_CBP_™d_c€ffs_‰om_NAL
 = 
ªad_CBP_™d_c€ffs_‰om_NAL_CABAC_422
;

1909 
YUV420
:

1910 
cuºSli˚
->
ªad_CBP_™d_c€ffs_‰om_NAL
 = 
ªad_CBP_™d_c€ffs_‰om_NAL_CABAC_420
;

1912 
YUV400
:

1913 
cuºSli˚
->
ªad_CBP_™d_c€ffs_‰om_NAL
 = 
ªad_CBP_™d_c€ffs_‰om_NAL_CABAC_400
;

1916 
	`as£π
 (1);

1917 
cuºSli˚
->
ªad_CBP_™d_c€ffs_‰om_NAL
 = 
NULL
;

1920 
	}
}

1930 
	$£t_ªad_comp_c€ff_ˇbac
(
Ma¸oblock
 *
cuºMB
)

1932 i‡(
cuºMB
->
is_los¶ess
 =
FALSE
)

1934 
cuºMB
->
ªad_comp_c€ff_4x4_CABAC
 =Ñead_comp_coeff_4x4_CABAC;

1935 
cuºMB
->
ªad_comp_c€ff_8x8_CABAC
 = 
ªad_comp_c€ff_8x8_MB_CABAC
;

1939 
cuºMB
->
ªad_comp_c€ff_4x4_CABAC
 = 
ªad_comp_c€ff_4x4_CABAC_ls
;

1940 
cuºMB
->
ªad_comp_c€ff_8x8_CABAC
 = 
ªad_comp_c€ff_8x8_MB_CABAC_ls
;

1942 
	}
}

	@ldecod/src/read_comp_cavlc.c

14 
	~"c⁄åibut‹s.h
"

16 
	~"globÆ.h
"

17 
	~"ñemíts.h
"

18 
	~"ma¸oblock.h
"

19 
	~"vlc.h
"

20 
	~"Á°_mem‹y.h
"

21 
	~"å™sf‹m.h
"

22 
	~"mb_ac˚ss.h
"

24 #i‡
TRACE


25 
	#TRACE_STRING
(
s
Ë
	`°∫˝y
(
cuºSE
.
åa˚°rög
, s, 
TRACESTRING_SIZE
)

	)

26 
	#TRACE_DECBITS
(
i
Ë
	`de˘ø˚bô˙t
(1)

	)

27 
	#TRACE_PRINTF
(
s
Ë
	`•rötf
(
ty≥
, "%s", s);

	)

28 
	#TRACE_STRING_P
(
s
Ë
	`°∫˝y
(
cuºSE
->
åa˚°rög
, s, 
TRACESTRING_SIZE
)

	)

30 
	#TRACE_STRING
(
s
)

	)

31 
	#TRACE_DECBITS
(
i
)

	)

32 
	#TRACE_PRINTF
(
s
)

	)

33 
	#TRACE_STRING_P
(
s
)

	)

36 
check_dp_√ighb‹s
 (
Ma¸oblock
 *
cuºMB
);

37 
ªad_dñè_qu™t
 (
Sy¡axEÀmít
 *
cuºSE
, 
D©aP¨tôi⁄
 *
dP
, 
Ma¸oblock
 *
cuºMB
, c⁄° 
byã
 *
∑πM≠
, 
ty≥
);

48 
	$¥edi˘_¬z
(
Ma¸oblock
 *
cuºMB
, 
block_ty≥
, 
i
,
j
)

50 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

51 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

53 
PixñPos
 
pix
;

55 
¥ed_¬z
 = 0;

56 
˙t
 = 0;

59 
	`gë4x4Neighbour
(
cuºMB
, 
i
 - 1, 
j
, 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix
);

61 i‡((
cuºMB
->
is_öåa_block
 =
TRUE
Ë&& 
pix
.
avaûabÀ
 && 
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
 && (
cuºSli˚
->
dp_mode
 =
PAR_DP_3
))

63 
pix
.
avaûabÀ
 &
cuºSli˚
->
öåa_block
[pix.
mb_addr
];

64 i‡(!
pix
.
avaûabÀ
)

65 ++
˙t
;

68 i‡(
pix
.
avaûabÀ
)

70 
block_ty≥
)

72 
LUMA
:

73 
¥ed_¬z
 = 
p_Vid
->
nz_c€ff
 [
pix
.
mb_addr
 ][0][pix.
y
][pix.
x
];

74 ++
˙t
;

76 
CB
:

77 
¥ed_¬z
 = 
p_Vid
->
nz_c€ff
 [
pix
.
mb_addr
 ][1][pix.
y
][pix.
x
];

78 ++
˙t
;

80 
CR
:

81 
¥ed_¬z
 = 
p_Vid
->
nz_c€ff
 [
pix
.
mb_addr
 ][2][pix.
y
][pix.
x
];

82 ++
˙t
;

85 
	`îr‹
("writeCoeff4x4_CAVLC: Invalid blockÅype", 600);

91 
	`gë4x4Neighbour
(
cuºMB
, 
i
, 
j
 - 1, 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix
);

93 i‡((
cuºMB
->
is_öåa_block
 =
TRUE
Ë&& 
pix
.
avaûabÀ
 && 
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
 && (
cuºSli˚
->
dp_mode
==
PAR_DP_3
))

95 
pix
.
avaûabÀ
 &
cuºSli˚
->
öåa_block
[pix.
mb_addr
];

96 i‡(!
pix
.
avaûabÀ
)

97 ++
˙t
;

100 i‡(
pix
.
avaûabÀ
)

102 
block_ty≥
)

104 
LUMA
:

105 
¥ed_¬z
 +
p_Vid
->
nz_c€ff
 [
pix
.
mb_addr
 ][0][pix.
y
][pix.
x
];

106 ++
˙t
;

108 
CB
:

109 
¥ed_¬z
 +
p_Vid
->
nz_c€ff
 [
pix
.
mb_addr
 ][1][pix.
y
][pix.
x
];

110 ++
˙t
;

112 
CR
:

113 
¥ed_¬z
 +
p_Vid
->
nz_c€ff
 [
pix
.
mb_addr
 ][2][pix.
y
][pix.
x
];

114 ++
˙t
;

117 
	`îr‹
("writeCoeff4x4_CAVLC: Invalid blockÅype", 600);

122 i‡(
˙t
==2)

124 ++
¥ed_¬z
;

125 
¥ed_¬z
 >>= 1;

128  
¥ed_¬z
;

129 
	}
}

141 
	$¥edi˘_¬z_chroma
(
Ma¸oblock
 *
cuºMB
, 
i
,
j
)

143 
St‹abÀPi˘uª
 *
dec_pi˘uª
 = 
cuºMB
->
p_Sli˚
->dec_picture;

145 i‡(
dec_pi˘uª
->
chroma_f‹m©_idc
 !
YUV444
)

147 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

148 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

149 
PixñPos
 
pix
;

150 
¥ed_¬z
 = 0;

151 
˙t
 = 0;

155 
	`gë4x4Neighbour
(
cuºMB
, ((
i
&0x01)<<2Ë- 1, 
j
, 
p_Vid
->
mb_size
[
IS_CHROMA
], &
pix
);

157 i‡((
cuºMB
->
is_öåa_block
 =
TRUE
Ë&& 
pix
.
avaûabÀ
 && 
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
 && (
cuºSli˚
->
dp_mode
==
PAR_DP_3
))

159 
pix
.
avaûabÀ
 &
cuºSli˚
->
öåa_block
[pix.
mb_addr
];

160 i‡(!
pix
.
avaûabÀ
)

161 ++
˙t
;

164 i‡(
pix
.
avaûabÀ
)

166 
¥ed_¬z
 = 
p_Vid
->
nz_c€ff
 [
pix
.
mb_addr
 ][1][pix.
y
][2 * (
i
>>1Ë+Öix.
x
];

167 ++
˙t
;

171 
	`gë4x4Neighbour
(
cuºMB
, ((
i
&0x01)<<2), 
j
 - 1, 
p_Vid
->
mb_size
[
IS_CHROMA
], &
pix
);

173 i‡((
cuºMB
->
is_öåa_block
 =
TRUE
Ë&& 
pix
.
avaûabÀ
 && 
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
 && (
cuºSli˚
->
dp_mode
==
PAR_DP_3
))

175 
pix
.
avaûabÀ
 &
cuºSli˚
->
öåa_block
[pix.
mb_addr
];

176 i‡(!
pix
.
avaûabÀ
)

177 ++
˙t
;

180 i‡(
pix
.
avaûabÀ
)

182 
¥ed_¬z
 +
p_Vid
->
nz_c€ff
 [
pix
.
mb_addr
 ][1][pix.
y
][2 * (
i
>>1Ë+Öix.
x
];

183 ++
˙t
;

186 i‡(
˙t
==2)

188 ++
¥ed_¬z
;

189 
¥ed_¬z
 >>= 1;

191  
¥ed_¬z
;

195 
	}
}

207 
	$ªad_c€ff_4x4_CAVLC
 (
Ma¸oblock
 *
cuºMB
,

208 
block_ty≥
,

209 
i
, 
j
, 
Àv¨r
[16], 
ru«º
[16],

210 *
numbî_c€fficõ¡s
)

212 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

213 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

214 
mb_ƒ
 = 
cuºMB
->
mbAddrX
;

215 
Sy¡axEÀmít
 
cuºSE
;

216 
D©aP¨tôi⁄
 *
dP
;

217 c⁄° 
byã
 *
∑πM≠
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
dp_mode
];

218 
Bô°ªam
 *
cuºSåóm
;

220 
k
, 
code
, 
vl˙um
;

221 
numc€ff
 = 0, 
numåaûög⁄es
;

222 
Àvñ_two_‹_highî
;

223 
num⁄es
, 
tŸzîos
, 
ab¶evñ
, 
cdc
=0, 
ˇc
=0;

224 
zîo¶e·
, 
¡r
, 
d±y≥
 = 0;

225 
max_c€ff_num
 = 0, 
¬z
;

226 
ty≥
[15];

227 c⁄° 
öcVlc
[] = {0, 3, 6, 12, 24, 48, 32768};

229 
block_ty≥
)

231 
LUMA
:

232 
max_c€ff_num
 = 16;

233 
	`TRACE_PRINTF
("Luma");

234 
d±y≥
 = (
cuºMB
->
is_öåa_block
 =
TRUE
Ë? 
SE_LUM_AC_INTRA
 : 
SE_LUM_AC_INTER
;

235 
p_Vid
->
nz_c€ff
[
mb_ƒ
][0][
j
][
i
] = 0;

237 
LUMA_INTRA16x16DC
:

238 
max_c€ff_num
 = 16;

239 
	`TRACE_PRINTF
("Lum16DC");

240 
d±y≥
 = 
SE_LUM_DC_INTRA
;

241 
p_Vid
->
nz_c€ff
[
mb_ƒ
][0][
j
][
i
] = 0;

243 
LUMA_INTRA16x16AC
:

244 
max_c€ff_num
 = 15;

245 
	`TRACE_PRINTF
("Lum16AC");

246 
d±y≥
 = 
SE_LUM_AC_INTRA
;

247 
p_Vid
->
nz_c€ff
[
mb_ƒ
][0][
j
][
i
] = 0;

249 
CHROMA_DC
:

250 
max_c€ff_num
 = 
p_Vid
->
num_cdc_c€ff
;

251 
cdc
 = 1;

252 
	`TRACE_PRINTF
("ChrDC");

253 
d±y≥
 = (
cuºMB
->
is_öåa_block
 =
TRUE
Ë? 
SE_CHR_DC_INTRA
 : 
SE_CHR_DC_INTER
;

254 
p_Vid
->
nz_c€ff
[
mb_ƒ
][0][
j
][
i
] = 0;

256 
CHROMA_AC
:

257 
max_c€ff_num
 = 15;

258 
ˇc
 = 1;

259 
	`TRACE_PRINTF
("ChrAC");

260 
d±y≥
 = (
cuºMB
->
is_öåa_block
 =
TRUE
Ë? 
SE_CHR_AC_INTRA
 : 
SE_CHR_AC_INTER
;

261 
p_Vid
->
nz_c€ff
[
mb_ƒ
][0][
j
][
i
] = 0;

264 
	`îr‹
 ("read_coeff_4x4_CAVLC: invalid blockÅype", 600);

265 
p_Vid
->
nz_c€ff
[
mb_ƒ
][0][
j
][
i
] = 0;

269 
cuºSE
.
ty≥
 = 
d±y≥
;

270 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
d±y≥
]]);

271 
cuºSåóm
 = 
dP
->
bô°ªam
;

273 i‡(!
cdc
)

276 
¬z
 = (!
ˇc
Ë? 
	`¥edi˘_¬z
(
cuºMB
, 
LUMA
, 
i
<<2, 
j
<<2Ë: 
	`¥edi˘_¬z_chroma
(currMB, i, ((j-4)<<2));

278 
cuºSE
.
vÆue1
 = (
¬z
 < 2) ? 0 : ((nnz < 4) ? 1 : ((nnz < 8) ? 2 : 3));

280 
	`ªadSy¡axEÀmít_NumC€ffTøûögO√s
(&
cuºSE
, 
cuºSåóm
, 
ty≥
);

282 
numc€ff
 = 
cuºSE
.
vÆue1
;

283 
numåaûög⁄es
 = 
cuºSE
.
vÆue2
;

285 
p_Vid
->
nz_c€ff
[
mb_ƒ
][0][
j
][
i
] = (
byã
Ë
numc€ff
;

290 
	`ªadSy¡axEÀmít_NumC€ffTøûögO√sChromaDC
(
p_Vid
, &
cuºSE
, 
cuºSåóm
);

292 
numc€ff
 = 
cuºSE
.
vÆue1
;

293 
numåaûög⁄es
 = 
cuºSE
.
vÆue2
;

296 
	`mem£t
(
Àv¨r
, 0, 
max_c€ff_num
 * ());

297 
	`mem£t
(
ru«º
, 0, 
max_c€ff_num
 * ());

299 
num⁄es
 = 
numåaûög⁄es
;

300 *
numbî_c€fficõ¡s
 = 
numc€ff
;

302 i‡(
numc€ff
)

304 i‡(
numåaûög⁄es
)

306 
cuºSE
.
Àn
 = 
numåaûög⁄es
;

308 #i‡
TRACE


309 
	`¢¥ötf
(
cuºSE
.
åa˚°rög
,

310 
TRACESTRING_SIZE
, "%†åaûög o√†sig¿(%d,%d)", 
ty≥
, 
i
, 
j
);

313 
	`ªadSy¡axEÀmít_FLC
 (&
cuºSE
, 
cuºSåóm
);

315 
code
 = 
cuºSE
.
öf
;

316 
¡r
 = 
numåaûög⁄es
;

317 
k
 = 
numc€ff
 - 1; k >Çumc€f‡- 1 - 
numåaûög⁄es
; k--)

319 
¡r
 --;

320 
Àv¨r
[
k
] = (
code
>>
¡r
)&1 ? -1 : 1;

325 
Àvñ_two_‹_highî
 = (
numc€ff
 > 3 && 
numåaûög⁄es
 == 3)? 0 : 1;

326 
vl˙um
 = (
numc€ff
 > 10 && 
numåaûög⁄es
 < 3) ? 1 : 0;

328 
k
 = 
numc€ff
 - 1 - 
numåaûög⁄es
; k >= 0; k--)

331 #i‡
TRACE


332 
	`¢¥ötf
(
cuºSE
.
åa˚°rög
,

333 
TRACESTRING_SIZE
, "%†Àv (%d,%dËk=%d vlc=%d ", 
ty≥
, 
i
, 
j
, 
k
, 
vl˙um
);

336 i‡(
vl˙um
 == 0)

337 
	`ªadSy¡axEÀmít_Levñ_VLC0
(&
cuºSE
, 
cuºSåóm
);

339 
	`ªadSy¡axEÀmít_Levñ_VLCN
(&
cuºSE
, 
vl˙um
, 
cuºSåóm
);

341 i‡(
Àvñ_two_‹_highî
)

343 
cuºSE
.
öf
 += (currSE.inf > 0) ? 1 : -1;

344 
Àvñ_two_‹_highî
 = 0;

347 
Àv¨r
[
k
] = 
cuºSE
.
öf
;

348 
ab¶evñ
 = 
	`übs
(
Àv¨r
[
k
]);

349 i‡(
ab¶evñ
 == 1)

350 ++
num⁄es
;

353 i‡(
ab¶evñ
 > 
öcVlc
[
vl˙um
])

354 ++
vl˙um
;

356 i‡(
k
 =
numc€ff
 - 1 - 
numåaûög⁄es
 && 
ab¶evñ
 >3)

357 
vl˙um
 = 2;

360 i‡(
numc€ff
 < 
max_c€ff_num
)

363 
vl˙um
 = 
numc€ff
 - 1;

364 
cuºSE
.
vÆue1
 = 
vl˙um
;

366 #i‡
TRACE


367 
	`¢¥ötf
(
cuºSE
.
åa˚°rög
,

368 
TRACESTRING_SIZE
, "%†tŸÆru¿(%d,%dËvlc=%d ", 
ty≥
, 
i
,
j
, 
vl˙um
);

370 i‡(
cdc
)

371 
	`ªadSy¡axEÀmít_TŸÆZîosChromaDC
(
p_Vid
, &
cuºSE
, 
cuºSåóm
);

373 
	`ªadSy¡axEÀmít_TŸÆZîos
(&
cuºSE
, 
cuºSåóm
);

375 
tŸzîos
 = 
cuºSE
.
vÆue1
;

379 
tŸzîos
 = 0;

383 
zîo¶e·
 = 
tŸzîos
;

384 
i
 = 
numc€ff
 - 1;

386 i‡(
zîo¶e·
 > 0 && 
i
 > 0)

391 
vl˙um
 = 
	`imö
(
zîo¶e·
 - 1, 
RUNBEFORE_NUM_M1
);

393 
cuºSE
.
vÆue1
 = 
vl˙um
;

394 #i‡
TRACE


395 
	`¢¥ötf
(
cuºSE
.
åa˚°rög
,

396 
TRACESTRING_SIZE
, "%sÑun (%d,%d) k=%d vlc=%d ",

397 
ty≥
, 
i
, 
j
, i, 
vl˙um
);

400 
	`ªadSy¡axEÀmít_Run
(&
cuºSE
, 
cuºSåóm
);

401 
ru«º
[
i
] = 
cuºSE
.
vÆue1
;

403 
zîo¶e·
 -
ru«º
[
i
];

404 
i
 --;

405 } 
zîo¶e·
 !0 && 
i
 != 0);

407 
ru«º
[
i
] = 
zîo¶e·
;

409 
	}
}

421 
	$ªad_c€ff_4x4_CAVLC_444
 (
Ma¸oblock
 *
cuºMB
,

422 
block_ty≥
,

423 
i
, 
j
, 
Àv¨r
[16], 
ru«º
[16],

424 *
numbî_c€fficõ¡s
)

426 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

427 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

428 
mb_ƒ
 = 
cuºMB
->
mbAddrX
;

429 
Sy¡axEÀmít
 
cuºSE
;

430 
D©aP¨tôi⁄
 *
dP
;

431 c⁄° 
byã
 *
∑πM≠
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
dp_mode
];

432 
Bô°ªam
 *
cuºSåóm
;

434 
k
, 
code
, 
vl˙um
;

435 
numc€ff
 = 0, 
numåaûög⁄es
;

436 
Àvñ_two_‹_highî
;

437 
num⁄es
, 
tŸzîos
, 
ab¶evñ
, 
cdc
=0, 
ˇc
=0;

438 
zîo¶e·
, 
¡r
, 
d±y≥
 = 0;

439 
max_c€ff_num
 = 0, 
¬z
;

440 
ty≥
[15];

441 c⁄° 
öcVlc
[] = {0, 3, 6, 12, 24, 48, 32768};

443 
block_ty≥
)

445 
LUMA
:

446 
max_c€ff_num
 = 16;

447 
	`TRACE_PRINTF
("Luma");

448 
d±y≥
 = (
cuºMB
->
is_öåa_block
 =
TRUE
Ë? 
SE_LUM_AC_INTRA
 : 
SE_LUM_AC_INTER
;

449 
p_Vid
->
nz_c€ff
[
mb_ƒ
][0][
j
][
i
] = 0;

451 
LUMA_INTRA16x16DC
:

452 
max_c€ff_num
 = 16;

453 
	`TRACE_PRINTF
("Lum16DC");

454 
d±y≥
 = 
SE_LUM_DC_INTRA
;

455 
p_Vid
->
nz_c€ff
[
mb_ƒ
][0][
j
][
i
] = 0;

457 
LUMA_INTRA16x16AC
:

458 
max_c€ff_num
 = 15;

459 
	`TRACE_PRINTF
("Lum16AC");

460 
d±y≥
 = 
SE_LUM_AC_INTRA
;

461 
p_Vid
->
nz_c€ff
[
mb_ƒ
][0][
j
][
i
] = 0;

463 
CB
:

464 
max_c€ff_num
 = 16;

465 
	`TRACE_PRINTF
("Luma_add1");

466 
d±y≥
 = ((
cuºMB
->
is_öåa_block
 =
TRUE
)Ë? 
SE_LUM_AC_INTRA
 : 
SE_LUM_AC_INTER
;

467 
p_Vid
->
nz_c€ff
[
mb_ƒ
][1][
j
][
i
] = 0;

469 
CB_INTRA16x16DC
:

470 
max_c€ff_num
 = 16;

471 
	`TRACE_PRINTF
("Luma_add1_16DC");

472 
d±y≥
 = 
SE_LUM_DC_INTRA
;

473 
p_Vid
->
nz_c€ff
[
mb_ƒ
][1][
j
][
i
] = 0;

475 
CB_INTRA16x16AC
:

476 
max_c€ff_num
 = 15;

477 
	`TRACE_PRINTF
("Luma_add1_16AC");

478 
d±y≥
 = 
SE_LUM_AC_INTRA
;

479 
p_Vid
->
nz_c€ff
[
mb_ƒ
][1][
j
][
i
] = 0;

481 
CR
:

482 
max_c€ff_num
 = 16;

483 
	`TRACE_PRINTF
("Luma_add2");

484 
d±y≥
 = ((
cuºMB
->
is_öåa_block
 =
TRUE
)Ë? 
SE_LUM_AC_INTRA
 : 
SE_LUM_AC_INTER
;

485 
p_Vid
->
nz_c€ff
[
mb_ƒ
][2][
j
][
i
] = 0;

487 
CR_INTRA16x16DC
:

488 
max_c€ff_num
 = 16;

489 
	`TRACE_PRINTF
("Luma_add2_16DC");

490 
d±y≥
 = 
SE_LUM_DC_INTRA
;

491 
p_Vid
->
nz_c€ff
[
mb_ƒ
][2][
j
][
i
] = 0;

493 
CR_INTRA16x16AC
:

494 
max_c€ff_num
 = 15;

495 
	`TRACE_PRINTF
("Luma_add1_16AC");

496 
d±y≥
 = 
SE_LUM_AC_INTRA
;

497 
p_Vid
->
nz_c€ff
[
mb_ƒ
][2][
j
][
i
] = 0;

499 
CHROMA_DC
:

500 
max_c€ff_num
 = 
p_Vid
->
num_cdc_c€ff
;

501 
cdc
 = 1;

502 
	`TRACE_PRINTF
("ChrDC");

503 
d±y≥
 = (
cuºMB
->
is_öåa_block
 =
TRUE
Ë? 
SE_CHR_DC_INTRA
 : 
SE_CHR_DC_INTER
;

504 
p_Vid
->
nz_c€ff
[
mb_ƒ
][0][
j
][
i
] = 0;

506 
CHROMA_AC
:

507 
max_c€ff_num
 = 15;

508 
ˇc
 = 1;

509 
	`TRACE_PRINTF
("ChrAC");

510 
d±y≥
 = (
cuºMB
->
is_öåa_block
 =
TRUE
Ë? 
SE_CHR_AC_INTRA
 : 
SE_CHR_AC_INTER
;

511 
p_Vid
->
nz_c€ff
[
mb_ƒ
][0][
j
][
i
] = 0;

514 
	`îr‹
 ("read_coeff_4x4_CAVLC: invalid blockÅype", 600);

515 
p_Vid
->
nz_c€ff
[
mb_ƒ
][0][
j
][
i
] = 0;

519 
cuºSE
.
ty≥
 = 
d±y≥
;

520 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
d±y≥
]]);

521 
cuºSåóm
 = 
dP
->
bô°ªam
;

523 i‡(!
cdc
)

526 if(
block_ty≥
==
LUMA
 || block_ty≥==
LUMA_INTRA16x16DC
 || block_ty≥==
LUMA_INTRA16x16AC
 ||block_ty≥==
CHROMA_AC
)

528 
¬z
 = (!
ˇc
Ë? 
	`¥edi˘_¬z
(
cuºMB
, 
LUMA
, 
i
<<2, 
j
<<2Ë: 
	`¥edi˘_¬z_chroma
(currMB, i, ((j-4)<<2));

530 i‡(
block_ty≥
==
CB
 || block_ty≥==
CB_INTRA16x16DC
 || block_ty≥==
CB_INTRA16x16AC
)

532 
¬z
 = 
	`¥edi˘_¬z
(
cuºMB
, 
CB
, 
i
<<2, 
j
<<2);

536 
¬z
 = 
	`¥edi˘_¬z
(
cuºMB
, 
CR
, 
i
<<2, 
j
<<2);

539 
cuºSE
.
vÆue1
 = (
¬z
 < 2) ? 0 : ((nnz < 4) ? 1 : ((nnz < 8) ? 2 : 3));

541 
	`ªadSy¡axEÀmít_NumC€ffTøûögO√s
(&
cuºSE
, 
cuºSåóm
, 
ty≥
);

543 
numc€ff
 = 
cuºSE
.
vÆue1
;

544 
numåaûög⁄es
 = 
cuºSE
.
vÆue2
;

546 if(
block_ty≥
==
LUMA
 || block_ty≥==
LUMA_INTRA16x16DC
 || block_ty≥==
LUMA_INTRA16x16AC
 ||block_ty≥==
CHROMA_AC
)

547 
p_Vid
->
nz_c€ff
[
mb_ƒ
][0][
j
][
i
] = (
byã
Ë
numc€ff
;

548 i‡(
block_ty≥
==
CB
 || block_ty≥==
CB_INTRA16x16DC
 || block_ty≥==
CB_INTRA16x16AC
)

549 
p_Vid
->
nz_c€ff
[
mb_ƒ
][1][
j
][
i
] = (
byã
Ë
numc€ff
;

551 
p_Vid
->
nz_c€ff
[
mb_ƒ
][2][
j
][
i
] = (
byã
Ë
numc€ff
;

556 
	`ªadSy¡axEÀmít_NumC€ffTøûögO√sChromaDC
(
p_Vid
, &
cuºSE
, 
cuºSåóm
);

558 
numc€ff
 = 
cuºSE
.
vÆue1
;

559 
numåaûög⁄es
 = 
cuºSE
.
vÆue2
;

562 
	`mem£t
(
Àv¨r
, 0, 
max_c€ff_num
 * ());

563 
	`mem£t
(
ru«º
, 0, 
max_c€ff_num
 * ());

565 
num⁄es
 = 
numåaûög⁄es
;

566 *
numbî_c€fficõ¡s
 = 
numc€ff
;

568 i‡(
numc€ff
)

570 i‡(
numåaûög⁄es
)

572 
cuºSE
.
Àn
 = 
numåaûög⁄es
;

574 #i‡
TRACE


575 
	`¢¥ötf
(
cuºSE
.
åa˚°rög
,

576 
TRACESTRING_SIZE
, "%†åaûög o√†sig¿(%d,%d)", 
ty≥
, 
i
, 
j
);

579 
	`ªadSy¡axEÀmít_FLC
 (&
cuºSE
, 
cuºSåóm
);

581 
code
 = 
cuºSE
.
öf
;

582 
¡r
 = 
numåaûög⁄es
;

583 
k
 = 
numc€ff
 - 1; k >Çumc€f‡- 1 - 
numåaûög⁄es
; k--)

585 
¡r
 --;

586 
Àv¨r
[
k
] = (
code
>>
¡r
)&1 ? -1 : 1;

591 
Àvñ_two_‹_highî
 = (
numc€ff
 > 3 && 
numåaûög⁄es
 == 3)? 0 : 1;

592 
vl˙um
 = (
numc€ff
 > 10 && 
numåaûög⁄es
 < 3) ? 1 : 0;

594 
k
 = 
numc€ff
 - 1 - 
numåaûög⁄es
; k >= 0; k--)

597 #i‡
TRACE


598 
	`¢¥ötf
(
cuºSE
.
åa˚°rög
,

599 
TRACESTRING_SIZE
, "%†Àv (%d,%dËk=%d vlc=%d ", 
ty≥
, 
i
, 
j
, 
k
, 
vl˙um
);

602 i‡(
vl˙um
 == 0)

603 
	`ªadSy¡axEÀmít_Levñ_VLC0
(&
cuºSE
, 
cuºSåóm
);

605 
	`ªadSy¡axEÀmít_Levñ_VLCN
(&
cuºSE
, 
vl˙um
, 
cuºSåóm
);

607 i‡(
Àvñ_two_‹_highî
)

609 
cuºSE
.
öf
 += (currSE.inf > 0) ? 1 : -1;

610 
Àvñ_two_‹_highî
 = 0;

613 
Àv¨r
[
k
] = 
cuºSE
.
öf
;

614 
ab¶evñ
 = 
	`übs
(
Àv¨r
[
k
]);

615 i‡(
ab¶evñ
 == 1)

616 ++
num⁄es
;

619 i‡(
ab¶evñ
 > 
öcVlc
[
vl˙um
])

620 ++
vl˙um
;

622 i‡(
k
 =
numc€ff
 - 1 - 
numåaûög⁄es
 && 
ab¶evñ
 >3)

623 
vl˙um
 = 2;

626 i‡(
numc€ff
 < 
max_c€ff_num
)

629 
vl˙um
 = 
numc€ff
 - 1;

630 
cuºSE
.
vÆue1
 = 
vl˙um
;

632 #i‡
TRACE


633 
	`¢¥ötf
(
cuºSE
.
åa˚°rög
,

634 
TRACESTRING_SIZE
, "%†tŸÆru¿(%d,%dËvlc=%d ", 
ty≥
, 
i
,
j
, 
vl˙um
);

636 i‡(
cdc
)

637 
	`ªadSy¡axEÀmít_TŸÆZîosChromaDC
(
p_Vid
, &
cuºSE
, 
cuºSåóm
);

639 
	`ªadSy¡axEÀmít_TŸÆZîos
(&
cuºSE
, 
cuºSåóm
);

641 
tŸzîos
 = 
cuºSE
.
vÆue1
;

645 
tŸzîos
 = 0;

649 
zîo¶e·
 = 
tŸzîos
;

650 
i
 = 
numc€ff
 - 1;

652 i‡(
zîo¶e·
 > 0 && 
i
 > 0)

657 
vl˙um
 = 
	`imö
(
zîo¶e·
 - 1, 
RUNBEFORE_NUM_M1
);

659 
cuºSE
.
vÆue1
 = 
vl˙um
;

660 #i‡
TRACE


661 
	`¢¥ötf
(
cuºSE
.
åa˚°rög
,

662 
TRACESTRING_SIZE
, "%sÑun (%d,%d) k=%d vlc=%d ",

663 
ty≥
, 
i
, 
j
, i, 
vl˙um
);

666 
	`ªadSy¡axEÀmít_Run
(&
cuºSE
, 
cuºSåóm
);

667 
ru«º
[
i
] = 
cuºSE
.
vÆue1
;

669 
zîo¶e·
 -
ru«º
[
i
];

670 
i
 --;

671 } 
zîo¶e·
 !0 && 
i
 != 0);

673 
ru«º
[
i
] = 
zîo¶e·
;

675 
	}
}

684 
ªad_comp_c€ff_4x4_CAVLC
 (
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, (*
InvLevñSˇÀ4x4
)[4], 
qp_≥r
, 
cbp
, 
byã
 **
nzc€ff
)

686 
	gblock_y
, 
	gblock_x
, 
	gb8
;

687 
	gi
, 
	gj
, 
	gk
;

688 
	gi0
, 
	gj0
;

689 
	gÀv¨r
[16] = {0}, 
	gru«º
[16] = {0}, 
	gnumc€ff
;

690 
Sli˚
 *
	gcuºSli˚
 = 
cuºMB
->
p_Sli˚
;

691 
VideoP¨amëîs
 *
	gp_Vid
 = 
cuºMB
->
p_Vid
;

692 c⁄° 
byã
 (*
pos_sˇn4x4
)[2] = ((
p_Vid
->
°ru˘uª
 =
FRAME
Ë&& (!
cuºMB
->
mb_fõld
)Ë? 
SNGL_SCAN
 : 
FIELD_SCAN
;

693 c⁄° 
byã
 *
	gpos_sˇn_4x4
 = 
pos_sˇn4x4
[0];

694 
	g°¨t_sˇn
 = 
IS_I16MB
(
cuºMB
) ? 1 : 0;

695 
öt64
 *
	gcur_cbp
 = &
cuºMB
->
s_cbp
[
∂
].
blk
;

696 
	gcur_c⁄ãxt
;

697 
	gblock_y4
, 
	gblock_x4
;

699 i‡(
IS_I16MB
(
cuºMB
))

701 i‡(
	g∂
 =
PLANE_Y
)

702 
cur_c⁄ãxt
 = 
LUMA_INTRA16x16AC
;

703 i‡(
	g∂
 =
PLANE_U
)

704 
cur_c⁄ãxt
 = 
CB_INTRA16x16AC
;

706 
	gcur_c⁄ãxt
 = 
CR_INTRA16x16AC
;

710 i‡(
	g∂
 =
PLANE_Y
)

711 
cur_c⁄ãxt
 = 
LUMA
;

712 i‡(
	g∂
 =
PLANE_U
)

713 
cur_c⁄ãxt
 = 
CB
;

715 
	gcur_c⁄ãxt
 = 
CR
;

719 
	gblock_y
 = 0; block_y < 4; block_y += 2)

721 
block_y4
 = 
block_y
 << 2;

722 
	gblock_x
 = 0; block_x < 4; block_x += 2)

724 
block_x4
 = 
block_x
 << 2;

725 
	gb8
 = (
block_y
 + (
block_x
 >> 1));

727 i‡(
	gcbp
 & (1 << 
	gb8
))

729 
	gj
 = 
block_y4
; j < 
	gblock_y4
 + 8; j +
BLOCK_SIZE
)

731 
i
 = 
block_x4
; 
	gi
 < 
	gblock_x4
 + 8; i +
BLOCK_SIZE
)

733 
cuºSli˚
->
ªad_c€ff_4x4_CAVLC
(
cuºMB
, 
cur_c⁄ãxt
, 
i
 >> 2, 
j
 >> 2, 
Àv¨r
, 
ru«º
, &
numc€ff
);

734 
	gpos_sˇn_4x4
 = 
pos_sˇn4x4
[
°¨t_sˇn
];

736 
	gk
 = 0; k < 
	gnumc€ff
; ++k)

738 i‡(
	gÀv¨r
[
k
] != 0)

740 
pos_sˇn_4x4
 +(
ru«º
[
k
] << 1);

742 
	gi0
 = *
pos_sˇn_4x4
++;

743 
	gj0
 = *
pos_sˇn_4x4
++;

746 *
	gcur_cbp
 |
i64_powî2
(
j
 + (
i
 >> 2));

748 
	gcuºSli˚
->
	gcof
[
∂
][
j
 + 
j0
][
i
 + 
i0
]
rshi·_∫d_sf
((
Àv¨r
[
k
] * 
InvLevñSˇÀ4x4
[j0][i0])<<
qp_≥r
, 4);

757 
	gnzc€ff
[
block_y
 ][
block_x
 ] = 0;

758 
	gnzc€ff
[
block_y
 ][
block_x
 + 1] = 0;

759 
	gnzc€ff
[
block_y
 + 1][
block_x
 ] = 0;

760 
	gnzc€ff
[
block_y
 + 1][
block_x
 + 1] = 0;

773 
ªad_comp_c€ff_4x4_CAVLC_ls
 (
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, (*
InvLevñSˇÀ4x4
)[4], 
qp_≥r
, 
cbp
, 
byã
 **
nzc€ff
)

775 
	gblock_y
, 
	gblock_x
, 
	gb8
;

776 
	gi
, 
	gj
, 
	gk
;

777 
	gi0
, 
	gj0
;

778 
	gÀv¨r
[16] = {0}, 
	gru«º
[16] = {0}, 
	gnumc€ff
;

779 
Sli˚
 *
	gcuºSli˚
 = 
cuºMB
->
p_Sli˚
;

780 
VideoP¨amëîs
 *
	gp_Vid
 = 
cuºMB
->
p_Vid
;

781 c⁄° 
byã
 (*
pos_sˇn4x4
)[2] = ((
p_Vid
->
°ru˘uª
 =
FRAME
Ë&& (!
cuºMB
->
mb_fõld
)Ë? 
SNGL_SCAN
 : 
FIELD_SCAN
;

782 
	g°¨t_sˇn
 = 
IS_I16MB
(
cuºMB
) ? 1 : 0;

783 
öt64
 *
	gcur_cbp
 = &
cuºMB
->
s_cbp
[
∂
].
blk
;

784 
	gc€f_˘r
, 
	gcur_c⁄ãxt
;

786 i‡(
IS_I16MB
(
cuºMB
))

788 i‡(
	g∂
 =
PLANE_Y
)

789 
cur_c⁄ãxt
 = 
LUMA_INTRA16x16AC
;

790 i‡(
	g∂
 =
PLANE_U
)

791 
cur_c⁄ãxt
 = 
CB_INTRA16x16AC
;

793 
	gcur_c⁄ãxt
 = 
CR_INTRA16x16AC
;

797 i‡(
	g∂
 =
PLANE_Y
)

798 
cur_c⁄ãxt
 = 
LUMA
;

799 i‡(
	g∂
 =
PLANE_U
)

800 
cur_c⁄ãxt
 = 
CB
;

802 
	gcur_c⁄ãxt
 = 
CR
;

805 
	gblock_y
=0; block_y < 4; block_y += 2)

807 
block_x
=0; 
	gblock_x
 < 4; block_x += 2)

809 
b8
 = 2*(
block_y
>>1Ë+ (
block_x
>>1);

811 i‡(
	gcbp
 & (1<<
	gb8
))

813 
	gj
=
block_y
; j < 
	gblock_y
+2; ++j)

815 
	gi
=
block_x
; i < 
	gblock_x
+2; ++i)

817 
	gcuºSli˚
->
ªad_c€ff_4x4_CAVLC
(
cuºMB
, 
cur_c⁄ãxt
, 
i
, 
j
, 
Àv¨r
, 
ru«º
, &
numc€ff
);

819 
	gc€f_˘r
 = 
°¨t_sˇn
 - 1;

821 
	gk
 = 0; k < 
	gnumc€ff
; ++k)

823 i‡(
	gÀv¨r
[
k
] != 0)

825 
c€f_˘r
 +
ru«º
[
k
]+1;

827 
	gi0
=
pos_sˇn4x4
[
c€f_˘r
][0];

828 
	gj0
=
pos_sˇn4x4
[
c€f_˘r
][1];

830 *
	gcur_cbp
 |
i64_powî2
((
j
<<2Ë+ 
i
);

831 
	gcuºSli˚
->
	gcof
[
∂
][(
j
<<2Ë+ 
j0
][(
i
<<2Ë+ 
i0
]
Àv¨r
[
k
];

840 
	gnzc€ff
[
block_y
 ][
block_x
 ] = 0;

841 
	gnzc€ff
[
block_y
 ][
block_x
 + 1] = 0;

842 
	gnzc€ff
[
block_y
 + 1][
block_x
 ] = 0;

843 
	gnzc€ff
[
block_y
 + 1][
block_x
 + 1] = 0;

856 
ªad_comp_c€ff_8x8_CAVLC
 (
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, (*
InvLevñSˇÀ8x8
)[8], 
qp_≥r
, 
cbp
, 
byã
 **
nzc€ff
)

858 
	gblock_y
, 
	gblock_x
, 
	gb4
, 
	gb8
;

859 
	gblock_y4
, 
	gblock_x4
;

860 
	gi
, 
	gj
, 
	gk
;

861 
	gi0
, 
	gj0
;

862 
	gÀv¨r
[16] = {0}, 
	gru«º
[16] = {0}, 
	gnumc€ff
;

863 
Sli˚
 *
	gcuºSli˚
 = 
cuºMB
->
p_Sli˚
;

864 
VideoP¨amëîs
 *
	gp_Vid
 = 
cuºMB
->
p_Vid
;

865 c⁄° 
byã
 (*
pos_sˇn8x8
)[2] = ((
p_Vid
->
°ru˘uª
 =
FRAME
Ë&& (!
cuºMB
->
mb_fõld
)Ë? 
SNGL_SCAN8x8
 : 
FIELD_SCAN8x8
;

866 
	g°¨t_sˇn
 = 
IS_I16MB
(
cuºMB
) ? 1 : 0;

867 
öt64
 *
	gcur_cbp
 = &
cuºMB
->
s_cbp
[
∂
].
blk
;

868 
	gc€f_˘r
, 
	gcur_c⁄ãxt
;

870 i‡(
IS_I16MB
(
cuºMB
))

872 i‡(
	g∂
 =
PLANE_Y
)

873 
cur_c⁄ãxt
 = 
LUMA_INTRA16x16AC
;

874 i‡(
	g∂
 =
PLANE_U
)

875 
cur_c⁄ãxt
 = 
CB_INTRA16x16AC
;

877 
	gcur_c⁄ãxt
 = 
CR_INTRA16x16AC
;

881 i‡(
	g∂
 =
PLANE_Y
)

882 
cur_c⁄ãxt
 = 
LUMA
;

883 i‡(
	g∂
 =
PLANE_U
)

884 
cur_c⁄ãxt
 = 
CB
;

886 
	gcur_c⁄ãxt
 = 
CR
;

889 
	gblock_y
 = 0; block_y < 4; block_y += 2)

891 
block_y4
 = 
block_y
 << 2;

893 
	gblock_x
 = 0; block_x < 4; block_x += 2)

895 
block_x4
 = 
block_x
 << 2;

896 
	gb8
 = 
block_y
 + (
block_x
>>1);

898 i‡(
	gcbp
 & (1<<
	gb8
))

900 
	gj
 = 
block_y
; j < 
	gblock_y
 + 2; ++j)

902 
	gi
 = 
block_x
; i < 
	gblock_x
 + 2; ++i)

904 
	gcuºSli˚
->
ªad_c€ff_4x4_CAVLC
(
cuºMB
, 
cur_c⁄ãxt
, 
i
, 
j
, 
Àv¨r
, 
ru«º
, &
numc€ff
);

906 
	gc€f_˘r
 = 
°¨t_sˇn
 - 1;

908 
	gk
 = 0; k < 
	gnumc€ff
; ++k)

910 i‡(
	gÀv¨r
[
k
] != 0)

912 
c€f_˘r
 +
ru«º
[
k
] + 1;

916 *
	gcur_cbp
 |51 << (
block_y4
 + 
block_x
);

918 
	gb4
 = (
c€f_˘r
 << 2Ë+ 2*(
j
 - 
block_y
Ë+ (
i
 - 
block_x
);

920 
	gi0
 = 
pos_sˇn8x8
[
b4
][0];

921 
	gj0
 = 
pos_sˇn8x8
[
b4
][1];

923 
	gcuºSli˚
->
	gmb_ºes
[
∂
][
block_y4
 +
j0
][
block_x4
 +
i0
] = 
rshi·_∫d_sf
((
Àv¨r
[
k
] * 
InvLevñSˇÀ8x8
[j0][i0])<<
qp_≥r
, 6);

931 
	gnzc€ff
[
block_y
 ][
block_x
 ] = 0;

932 
	gnzc€ff
[
block_y
 ][
block_x
 + 1] = 0;

933 
	gnzc€ff
[
block_y
 + 1][
block_x
 ] = 0;

934 
	gnzc€ff
[
block_y
 + 1][
block_x
 + 1] = 0;

947 
ªad_comp_c€ff_8x8_CAVLC_ls
 (
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, (*
InvLevñSˇÀ8x8
)[8], 
qp_≥r
, 
cbp
, 
byã
 **
nzc€ff
)

949 
	gblock_y
, 
	gblock_x
, 
	gb4
, 
	gb8
;

950 
	gi
, 
	gj
, 
	gk
;

951 
	gÀv¨r
[16] = {0}, 
	gru«º
[16] = {0}, 
	gnumc€ff
;

952 
Sli˚
 *
	gcuºSli˚
 = 
cuºMB
->
p_Sli˚
;

953 
VideoP¨amëîs
 *
	gp_Vid
 = 
cuºMB
->
p_Vid
;

954 c⁄° 
byã
 (*
pos_sˇn8x8
)[2] = ((
p_Vid
->
°ru˘uª
 =
FRAME
Ë&& (!
cuºMB
->
mb_fõld
)Ë? 
SNGL_SCAN8x8
 : 
FIELD_SCAN8x8
;

955 
	g°¨t_sˇn
 = 
IS_I16MB
(
cuºMB
) ? 1 : 0;

956 
öt64
 *
	gcur_cbp
 = &
cuºMB
->
s_cbp
[
∂
].
blk
;

957 
	gc€f_˘r
, 
	gcur_c⁄ãxt
;

959 i‡(
IS_I16MB
(
cuºMB
))

961 i‡(
	g∂
 =
PLANE_Y
)

962 
cur_c⁄ãxt
 = 
LUMA_INTRA16x16AC
;

963 i‡(
	g∂
 =
PLANE_U
)

964 
cur_c⁄ãxt
 = 
CB_INTRA16x16AC
;

966 
	gcur_c⁄ãxt
 = 
CR_INTRA16x16AC
;

970 i‡(
	g∂
 =
PLANE_Y
)

971 
cur_c⁄ãxt
 = 
LUMA
;

972 i‡(
	g∂
 =
PLANE_U
)

973 
cur_c⁄ãxt
 = 
CB
;

975 
	gcur_c⁄ãxt
 = 
CR
;

978 
	gblock_y
=0; block_y < 4; block_y += 2)

980 
block_x
=0; 
	gblock_x
 < 4; block_x += 2)

982 
b8
 = 2*(
block_y
>>1Ë+ (
block_x
>>1);

984 i‡(
	gcbp
 & (1<<
	gb8
))

986 
	giz
, 
	gjz
;

988 
	gj
=
block_y
; j < 
	gblock_y
+2; ++j)

990 
	gi
=
block_x
; i < 
	gblock_x
+2; ++i)

993 
	gcuºSli˚
->
ªad_c€ff_4x4_CAVLC
(
cuºMB
, 
cur_c⁄ãxt
, 
i
, 
j
, 
Àv¨r
, 
ru«º
, &
numc€ff
);

995 
	gc€f_˘r
 = 
°¨t_sˇn
 - 1;

997 
	gk
 = 0; k < 
	gnumc€ff
; ++k)

999 i‡(
	gÀv¨r
[
k
] != 0)

1001 
c€f_˘r
 +
ru«º
[
k
]+1;

1005 *
	gcur_cbp
 |51 << ((
block_y
<<2Ë+ 
block_x
);

1007 
	gb4
 = 2*(
j
-
block_y
)+(
i
-
block_x
);

1009 
	giz
=
pos_sˇn8x8
[
c€f_˘r
*4+
b4
][0];

1010 
	gjz
=
pos_sˇn8x8
[
c€f_˘r
*4+
b4
][1];

1012 
	gcuºSli˚
->
	gmb_ºes
[
∂
][
block_y
*4 +
jz
][
block_x
*4 +
iz
] = 
Àv¨r
[
k
];

1020 
	gnzc€ff
[
block_y
 ][
block_x
 ] = 0;

1021 
	gnzc€ff
[
block_y
 ][
block_x
 + 1] = 0;

1022 
	gnzc€ff
[
block_y
 + 1][
block_x
 ] = 0;

1023 
	gnzc€ff
[
block_y
 + 1][
block_x
 + 1] = 0;

1036 
	$ªad_CBP_™d_c€ffs_‰om_NAL_CAVLC_400
(
Ma¸oblock
 *
cuºMB
)

1038 
k
;

1039 
mb_ƒ
 = 
cuºMB
->
mbAddrX
;

1040 
cbp
;

1041 
Sy¡axEÀmít
 
cuºSE
;

1042 
D©aP¨tôi⁄
 *
dP
 = 
NULL
;

1043 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1044 c⁄° 
byã
 *
∑πM≠
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
dp_mode
];

1045 
i0
, 
j0
;

1047 
Àv¨r
[16], 
ru«º
[16], 
numc€ff
;

1049 
qp_≥r
, 
qp_ªm
;

1050 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1052 
öåa
 = (
cuºMB
->
is_öåa_block
 =
TRUE
);

1054 
√ed_å™sf‹m_size_Êag
;

1056 (*
InvLevñSˇÀ4x4
)[4] = 
NULL
;

1057 (*
InvLevñSˇÀ8x8
)[8] = 
NULL
;

1059 c⁄° 
	`byã
 (*
pos_sˇn4x4
)[2] = ((
p_Vid
->
°ru˘uª
 =
FRAME
Ë&& (!
cuºMB
->
mb_fõld
)Ë? 
SNGL_SCAN
 : 
FIELD_SCAN
;

1060 c⁄° 
byã
 *
pos_sˇn_4x4
 = 
pos_sˇn4x4
[0];

1064 i‡(!
	`IS_I16MB
 (
cuºMB
))

1068 
cuºSE
.
ty≥
 = (
cuºMB
->
mb_ty≥
 =
I4MB
 || cuºMB->mb_ty≥ =
SI4MB
 || cuºMB->mb_ty≥ =
I8MB
)

1069 ? 
SE_CBP_INTRA


1070 : 
SE_CBP_INTER
;

1072 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
cuºSE
.
ty≥
]]);

1074 
cuºSE
.
m≠pög
 = (
cuºMB
->
mb_ty≥
 =
I4MB
 || cuºMB->mb_ty≥ =
SI4MB
 || cuºMB->mb_ty≥ =
I8MB
)

1075 ? 
cuºSli˚
->
löfo_cbp_öåa


1076 : 
cuºSli˚
->
löfo_cbp_öãr
;

1078 
	`TRACE_STRING
("coded_block_pattern");

1079 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, &
cuºSE
, dP);

1080 
cuºMB
->
cbp
 = cb∞
cuºSE
.
vÆue1
;

1085 
√ed_å™sf‹m_size_Êag
 = (((
cuºMB
->
mb_ty≥
 >= 1 && currMB->mb_type <= 3)||

1086 (
	`IS_DIRECT
(
cuºMB
Ë&& 
p_Vid
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
) ||

1087 (
cuºMB
->
NoMbP¨tLessTh™8x8Fœg
))

1088 && 
cuºMB
->
mb_ty≥
 !
I8MB
 && cuºMB->mb_ty≥ !
I4MB


1089 && (
cuºMB
->
cbp
&15)

1090 && 
cuºSli˚
->
Tønsf‹m8x8Mode
);

1092 i‡(
√ed_å™sf‹m_size_Êag
)

1094 
cuºSE
.
ty≥
 = 
SE_HEADER
;

1095 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_HEADER
]]);

1096 
	`TRACE_STRING
("transform_size_8x8_flag");

1099 
cuºSE
.
Àn
 = 1;

1100 
	`ªadSy¡axEÀmít_FLC
(&
cuºSE
, 
dP
->
bô°ªam
);

1102 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = (
Boﬁón
Ë
cuºSE
.
vÆue1
;

1108 i‡(
cbp
 !=0)

1110 
	`ªad_dñè_qu™t
(&
cuºSE
, 
dP
, 
cuºMB
, 
∑πM≠
, ((cuºMB->
is_öåa_block
 =
FALSE
)Ë? 
SE_DELTA_QUANT_INTER
 : 
SE_DELTA_QUANT_INTRA
);

1112 i‡(
cuºSli˚
->
dp_mode
)

1114 i‡((
cuºMB
->
is_öåa_block
 =
FALSE
Ë&& 
cuºSli˚
->
dpC_NŸPª£¡
 )

1115 
cuºMB
->
d∂_Êag
 = 1;

1117 if–
öåa
 && 
cuºSli˚
->
dpB_NŸPª£¡
 )

1119 
cuºMB
->
ei_Êag
 = 1;

1120 
cuºMB
->
d∂_Êag
 = 1;

1124 
	`check_dp_√ighb‹s
 (
cuºMB
);

1125 i‡(
cuºMB
->
d∂_Êag
)

1127 
cbp
 = 0;

1128 
cuºMB
->
cbp
 = cbp;

1135 
cbp
 = 
cuºMB
->cbp;

1137 
	`ªad_dñè_qu™t
(&
cuºSE
, 
dP
, 
cuºMB
, 
∑πM≠
, 
SE_DELTA_QUANT_INTRA
);

1139 i‡(
cuºSli˚
->
dp_mode
)

1141 i‡(
cuºSli˚
->
dpB_NŸPª£¡
)

1143 
cuºMB
->
ei_Êag
 = 1;

1144 
cuºMB
->
d∂_Êag
 = 1;

1146 
	`check_dp_√ighb‹s
 (
cuºMB
);

1147 i‡(
cuºMB
->
d∂_Êag
)

1149 
cuºMB
->
cbp
 = cbp = 0;

1153 i‡(!
cuºMB
->
d∂_Êag
)

1155 
pos_sˇn_4x4
 = 
pos_sˇn4x4
[0];

1157 
cuºSli˚
->
	`ªad_c€ff_4x4_CAVLC
(
cuºMB
, 
LUMA_INTRA16x16DC
, 0, 0, 
Àv¨r
, 
ru«º
, &
numc€ff
);

1159 
k
 = 0; k < 
numc€ff
; ++k)

1161 i‡(
Àv¨r
[
k
] != 0)

1163 
pos_sˇn_4x4
 +2 * 
ru«º
[
k
];

1165 
i0
 = ((*
pos_sˇn_4x4
++) << 2);

1166 
j0
 = ((*
pos_sˇn_4x4
++) << 2);

1168 
cuºSli˚
->
cof
[0][
j0
][
i0
] = 
Àv¨r
[
k
];

1174 if(
cuºMB
->
is_los¶ess
 =
FALSE
)

1175 
	`ôøns_2
(
cuºMB
, (
Cﬁ‹Pœ√
Ë
cuºSli˚
->
cﬁour_∂™e_id
);

1179 
	`upd©e_qp
(
cuºMB
, 
cuºSli˚
->
qp
);

1181 
qp_≥r
 = 
p_Vid
->
qp_≥r_m©rix
[ 
cuºMB
->
qp_sˇÀd
[
PLANE_Y
] ];

1182 
qp_ªm
 = 
p_Vid
->
qp_ªm_m©rix
[ 
cuºMB
->
qp_sˇÀd
[
PLANE_Y
] ];

1184 
InvLevñSˇÀ4x4
 = 
öåa
? 
cuºSli˚
->
InvLevñSˇÀ4x4_I¡ø
[cuºSli˚->
cﬁour_∂™e_id
][
qp_ªm
] : cuºSli˚->
InvLevñSˇÀ4x4_I¡î
[currSlice->colour_plane_id][qp_rem];

1185 
InvLevñSˇÀ8x8
 = 
öåa
? 
cuºSli˚
->
InvLevñSˇÀ8x8_I¡ø
[cuºSli˚->
cﬁour_∂™e_id
][
qp_ªm
] : cuºSli˚->
InvLevñSˇÀ8x8_I¡î
[currSlice->colour_plane_id][qp_rem];

1188 i‡(
cbp
)

1190 i‡(!
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
)

1192 
cuºMB
->
	`ªad_comp_c€ff_4x4_CAVLC
 (cuºMB, 
PLANE_Y
, 
InvLevñSˇÀ4x4
, 
qp_≥r
, 
cbp
, 
p_Vid
->
nz_c€ff
[
mb_ƒ
][PLANE_Y]);

1196 
cuºMB
->
	`ªad_comp_c€ff_8x8_CAVLC
 (cuºMB, 
PLANE_Y
, 
InvLevñSˇÀ8x8
, 
qp_≥r
, 
cbp
, 
p_Vid
->
nz_c€ff
[
mb_ƒ
][PLANE_Y]);

1201 
	`Á°_mem£t
(
p_Vid
->
nz_c€ff
[
mb_ƒ
][0][0], 0, 
BLOCK_PIXELS
 * (
byã
));

1203 
	}
}

1212 
	$ªad_CBP_™d_c€ffs_‰om_NAL_CAVLC_422
(
Ma¸oblock
 *
cuºMB
)

1214 
i
,
j
,
k
;

1215 
mb_ƒ
 = 
cuºMB
->
mbAddrX
;

1216 
cbp
;

1217 
Sy¡axEÀmít
 
cuºSE
;

1218 
D©aP¨tôi⁄
 *
dP
 = 
NULL
;

1219 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1220 c⁄° 
byã
 *
∑πM≠
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
dp_mode
];

1221 
c€f_˘r
, 
i0
, 
j0
, 
b8
;

1222 
Œ
;

1223 
Àv¨r
[16], 
ru«º
[16], 
numc€ff
;

1225 
qp_≥r
, 
qp_ªm
;

1226 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1228 
uv
;

1229 
qp_≥r_uv
[2];

1230 
qp_ªm_uv
[2];

1232 
öåa
 = (
cuºMB
->
is_öåa_block
 =
TRUE
);

1234 
b4
;

1236 
m6
[4];

1238 
√ed_å™sf‹m_size_Êag
;

1240 (*
InvLevñSˇÀ4x4
)[4] = 
NULL
;

1241 (*
InvLevñSˇÀ8x8
)[8] = 
NULL
;

1243 c⁄° 
	`byã
 (*
pos_sˇn4x4
)[2] = ((
p_Vid
->
°ru˘uª
 =
FRAME
Ë&& (!
cuºMB
->
mb_fõld
)Ë? 
SNGL_SCAN
 : 
FIELD_SCAN
;

1244 c⁄° 
byã
 *
pos_sˇn_4x4
 = 
pos_sˇn4x4
[0];

1248 i‡(!
	`IS_I16MB
 (
cuºMB
))

1252 
cuºSE
.
ty≥
 = (
cuºMB
->
mb_ty≥
 =
I4MB
 || cuºMB->mb_ty≥ =
SI4MB
 || cuºMB->mb_ty≥ =
I8MB
)

1253 ? 
SE_CBP_INTRA


1254 : 
SE_CBP_INTER
;

1256 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
cuºSE
.
ty≥
]]);

1258 
cuºSE
.
m≠pög
 = (
cuºMB
->
mb_ty≥
 =
I4MB
 || cuºMB->mb_ty≥ =
SI4MB
 || cuºMB->mb_ty≥ =
I8MB
)

1259 ? 
cuºSli˚
->
löfo_cbp_öåa


1260 : 
cuºSli˚
->
löfo_cbp_öãr
;

1262 
	`TRACE_STRING
("coded_block_pattern");

1263 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, &
cuºSE
, dP);

1264 
cuºMB
->
cbp
 = cb∞
cuºSE
.
vÆue1
;

1269 
√ed_å™sf‹m_size_Êag
 = (((
cuºMB
->
mb_ty≥
 >= 1 && currMB->mb_type <= 3)||

1270 (
	`IS_DIRECT
(
cuºMB
Ë&& 
p_Vid
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
) ||

1271 (
cuºMB
->
NoMbP¨tLessTh™8x8Fœg
))

1272 && 
cuºMB
->
mb_ty≥
 !
I8MB
 && cuºMB->mb_ty≥ !
I4MB


1273 && (
cuºMB
->
cbp
&15)

1274 && 
cuºSli˚
->
Tønsf‹m8x8Mode
);

1276 i‡(
√ed_å™sf‹m_size_Êag
)

1278 
cuºSE
.
ty≥
 = 
SE_HEADER
;

1279 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_HEADER
]]);

1280 
	`TRACE_STRING
("transform_size_8x8_flag");

1283 
cuºSE
.
Àn
 = 1;

1284 
	`ªadSy¡axEÀmít_FLC
(&
cuºSE
, 
dP
->
bô°ªam
);

1286 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = (
Boﬁón
Ë
cuºSE
.
vÆue1
;

1292 i‡(
cbp
 !=0)

1294 
	`ªad_dñè_qu™t
(&
cuºSE
, 
dP
, 
cuºMB
, 
∑πM≠
, ((cuºMB->
is_öåa_block
 =
FALSE
)Ë? 
SE_DELTA_QUANT_INTER
 : 
SE_DELTA_QUANT_INTRA
);

1296 i‡(
cuºSli˚
->
dp_mode
)

1298 i‡((
cuºMB
->
is_öåa_block
 =
FALSE
Ë&& 
cuºSli˚
->
dpC_NŸPª£¡
 )

1299 
cuºMB
->
d∂_Êag
 = 1;

1301 if–
öåa
 && 
cuºSli˚
->
dpB_NŸPª£¡
 )

1303 
cuºMB
->
ei_Êag
 = 1;

1304 
cuºMB
->
d∂_Êag
 = 1;

1308 
	`check_dp_√ighb‹s
 (
cuºMB
);

1309 i‡(
cuºMB
->
d∂_Êag
)

1311 
cbp
 = 0;

1312 
cuºMB
->
cbp
 = cbp;

1319 
cbp
 = 
cuºMB
->cbp;

1321 
	`ªad_dñè_qu™t
(&
cuºSE
, 
dP
, 
cuºMB
, 
∑πM≠
, 
SE_DELTA_QUANT_INTRA
);

1323 i‡(
cuºSli˚
->
dp_mode
)

1325 i‡(
cuºSli˚
->
dpB_NŸPª£¡
)

1327 
cuºMB
->
ei_Êag
 = 1;

1328 
cuºMB
->
d∂_Êag
 = 1;

1330 
	`check_dp_√ighb‹s
 (
cuºMB
);

1331 i‡(
cuºMB
->
d∂_Êag
)

1333 
cuºMB
->
cbp
 = cbp = 0;

1337 i‡(!
cuºMB
->
d∂_Êag
)

1339 
pos_sˇn_4x4
 = 
pos_sˇn4x4
[0];

1341 
cuºSli˚
->
	`ªad_c€ff_4x4_CAVLC
(
cuºMB
, 
LUMA_INTRA16x16DC
, 0, 0, 
Àv¨r
, 
ru«º
, &
numc€ff
);

1343 
k
 = 0; k < 
numc€ff
; ++k)

1345 i‡(
Àv¨r
[
k
] != 0)

1347 
pos_sˇn_4x4
 +2 * 
ru«º
[
k
];

1349 
i0
 = ((*
pos_sˇn_4x4
++) << 2);

1350 
j0
 = ((*
pos_sˇn_4x4
++) << 2);

1352 
cuºSli˚
->
cof
[0][
j0
][
i0
] = 
Àv¨r
[
k
];

1358 if(
cuºMB
->
is_los¶ess
 =
FALSE
)

1359 
	`ôøns_2
(
cuºMB
, (
Cﬁ‹Pœ√
Ë
cuºSli˚
->
cﬁour_∂™e_id
);

1363 
	`upd©e_qp
(
cuºMB
, 
cuºSli˚
->
qp
);

1365 
qp_≥r
 = 
p_Vid
->
qp_≥r_m©rix
[ 
cuºMB
->
qp_sˇÀd
[
cuºSli˚
->
cﬁour_∂™e_id
] ];

1366 
qp_ªm
 = 
p_Vid
->
qp_ªm_m©rix
[ 
cuºMB
->
qp_sˇÀd
[
cuºSli˚
->
cﬁour_∂™e_id
] ];

1369 
i
=0; i < 2; ++i)

1371 
qp_≥r_uv
[
i
] = 
p_Vid
->
qp_≥r_m©rix
[ 
cuºMB
->
qp_sˇÀd
[i + 1] ];

1372 
qp_ªm_uv
[
i
] = 
p_Vid
->
qp_ªm_m©rix
[ 
cuºMB
->
qp_sˇÀd
[i + 1] ];

1375 
InvLevñSˇÀ4x4
 = 
öåa
? 
cuºSli˚
->
InvLevñSˇÀ4x4_I¡ø
[cuºSli˚->
cﬁour_∂™e_id
][
qp_ªm
] : cuºSli˚->
InvLevñSˇÀ4x4_I¡î
[currSlice->colour_plane_id][qp_rem];

1376 
InvLevñSˇÀ8x8
 = 
öåa
? 
cuºSli˚
->
InvLevñSˇÀ8x8_I¡ø
[cuºSli˚->
cﬁour_∂™e_id
][
qp_ªm
] : cuºSli˚->
InvLevñSˇÀ8x8_I¡î
[currSlice->colour_plane_id][qp_rem];

1379 i‡(
cbp
)

1381 i‡(!
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
)

1383 
cuºMB
->
	`ªad_comp_c€ff_4x4_CAVLC
 (cuºMB, 
PLANE_Y
, 
InvLevñSˇÀ4x4
, 
qp_≥r
, 
cbp
, 
p_Vid
->
nz_c€ff
[
mb_ƒ
][PLANE_Y]);

1387 
cuºMB
->
	`ªad_comp_c€ff_8x8_CAVLC
 (cuºMB, 
PLANE_Y
, 
InvLevñSˇÀ8x8
, 
qp_≥r
, 
cbp
, 
p_Vid
->
nz_c€ff
[
mb_ƒ
][PLANE_Y]);

1392 
	`Á°_mem£t
(
p_Vid
->
nz_c€ff
[
mb_ƒ
][0][0], 0, 
BLOCK_PIXELS
 * (
byã
));

1398 if(
cbp
>15)

1400 
Œ
=0;ll<3;ll+=2)

1402 (*
InvLevñSˇÀ4x4
)[4] = 
NULL
;

1403 
uv
 = 
Œ
>>1;

1405 **
imgcof
 = 
cuºSli˚
->
cof
[
PLANE_U
 + 
uv
];

1406 
m3
[2][4] = {{0,0,0,0},{0,0,0,0}};

1407 
m4
[2][4] = {{0,0,0,0},{0,0,0,0}};

1408 
qp_≥r_uv_dc
 = 
p_Vid
->
qp_≥r_m©rix
[ (
cuºMB
->
qpc
[
uv
] + 3 +Ö_Vid->
bôdïth_chroma_qp_sˇÀ
) ];

1409 
qp_ªm_uv_dc
 = 
p_Vid
->
qp_ªm_m©rix
[ (
cuºMB
->
qpc
[
uv
] + 3 +Ö_Vid->
bôdïth_chroma_qp_sˇÀ
) ];

1410 i‡(
öåa
)

1411 
InvLevñSˇÀ4x4
 = 
cuºSli˚
->
InvLevñSˇÀ4x4_I¡ø
[
PLANE_U
 + 
uv
][
qp_ªm_uv_dc
];

1413 
InvLevñSˇÀ4x4
 = 
cuºSli˚
->
InvLevñSˇÀ4x4_I¡î
[
PLANE_U
 + 
uv
][
qp_ªm_uv_dc
];

1417 
cuºSli˚
->
	`ªad_c€ff_4x4_CAVLC
(
cuºMB
, 
CHROMA_DC
, 0, 0, 
Àv¨r
, 
ru«º
, &
numc€ff
);

1418 
c€f_˘r
=-1;

1419 
k
 = 0; k < 
numc€ff
; ++k)

1421 i‡(
Àv¨r
[
k
] != 0)

1423 
cuºMB
->
s_cbp
[0].
blk
 |((
öt64
)0xff0000Ë<< (
Œ
<<2);

1424 
c€f_˘r
 +
ru«º
[
k
]+1;

1425 
i0
 = 
SCAN_YUV422
[
c€f_˘r
][0];

1426 
j0
 = 
SCAN_YUV422
[
c€f_˘r
][1];

1428 
m3
[
i0
][
j0
]=
Àv¨r
[
k
];

1434 if(
cuºMB
->
is_los¶ess
 =
FALSE
)

1436 
m4
[0][0] = 
m3
[0][0] + m3[1][0];

1437 
m4
[0][1] = 
m3
[0][1] + m3[1][1];

1438 
m4
[0][2] = 
m3
[0][2] + m3[1][2];

1439 
m4
[0][3] = 
m3
[0][3] + m3[1][3];

1441 
m4
[1][0] = 
m3
[0][0] - m3[1][0];

1442 
m4
[1][1] = 
m3
[0][1] - m3[1][1];

1443 
m4
[1][2] = 
m3
[0][2] - m3[1][2];

1444 
m4
[1][3] = 
m3
[0][3] - m3[1][3];

1446 
i
 = 0; i < 2; ++i)

1448 
m6
[0] = 
m4
[
i
][0] + m4[i][2];

1449 
m6
[1] = 
m4
[
i
][0] - m4[i][2];

1450 
m6
[2] = 
m4
[
i
][1] - m4[i][3];

1451 
m6
[3] = 
m4
[
i
][1] + m4[i][3];

1453 
imgcof
[ 0][
i
<<2] = 
m6
[0] + m6[3];

1454 
imgcof
[ 4][
i
<<2] = 
m6
[1] + m6[2];

1455 
imgcof
[ 8][
i
<<2] = 
m6
[1] - m6[2];

1456 
imgcof
[12][
i
<<2] = 
m6
[0] - m6[3];

1459 
j
 = 0;j < 
p_Vid
->
mb_¸_size_y
; j +
BLOCK_SIZE
)

1461 
i
=0;ò< 
p_Vid
->
mb_¸_size_x
;i+=
BLOCK_SIZE
)

1463 
imgcof
[
j
][
i
] = 
	`rshi·_∫d_sf
((imgcof[j][i] * 
InvLevñSˇÀ4x4
[0][0]Ë<< 
qp_≥r_uv_dc
, 6);

1469 
j
=0;j<4;++j)

1471 
cuºSli˚
->
cof
[
PLANE_U
 + 
uv
][
j
<<2][0] = 
m3
[0][j];

1472 
cuºSli˚
->
cof
[
PLANE_U
 + 
uv
][
j
<<2][4] = 
m3
[1][j];

1483 i‡(
cbp
<=31)

1485 
	`Á°_mem£t
(
p_Vid
->
nz_c€ff
 [
mb_ƒ
 ][1][0], 0, 2 * 
BLOCK_PIXELS
 * (
byã
));

1489 if(
cuºMB
->
is_los¶ess
 =
FALSE
)

1491 
b8
=0; b8 < 
p_Vid
->
num_blk8x8_uv
; ++b8)

1493 
cuºMB
->
is_v_block
 = 
uv
 = (
b8
 > ((
p_Vid
->
num_uv_blocks
) - 1 ));

1494 
InvLevñSˇÀ4x4
 = 
öåa
 ? 
cuºSli˚
->
InvLevñSˇÀ4x4_I¡ø
[
PLANE_U
 + 
uv
][
qp_ªm_uv
[uv]] : cuºSli˚->
InvLevñSˇÀ4x4_I¡î
[PLANE_U + uv][qp_rem_uv[uv]];

1496 
b4
=0; b4 < 4; ++b4)

1498 
i
 = 
cofuv_blk_x
[1][
b8
][
b4
];

1499 
j
 = 
cofuv_blk_y
[1][
b8
][
b4
];

1501 
cuºSli˚
->
	`ªad_c€ff_4x4_CAVLC
(
cuºMB
, 
CHROMA_AC
, 
i
 + 2*
uv
, 
j
 + 4, 
Àv¨r
, 
ru«º
, &
numc€ff
);

1502 
c€f_˘r
 = 0;

1504 
k
 = 0; k < 
numc€ff
;++k)

1506 i‡(
Àv¨r
[
k
] != 0)

1508 
cuºMB
->
s_cbp
[0].
blk
 |
	`i64_powî2
(
cbp_blk_chroma
[
b8
][
b4
]);

1509 
c€f_˘r
 +
ru«º
[
k
] + 1;

1511 
i0
=
pos_sˇn4x4
[
c€f_˘r
][0];

1512 
j0
=
pos_sˇn4x4
[
c€f_˘r
][1];

1514 
cuºSli˚
->
cof
[
PLANE_U
 + 
uv
][(
j
<<2Ë+ 
j0
][(
i
<<2Ë+ 
i0
] = 
	`rshi·_∫d_sf
((
Àv¨r
[
k
] * 
InvLevñSˇÀ4x4
[j0][i0])<<
qp_≥r_uv
[uv], 4);

1523 
b8
=0; b8 < 
p_Vid
->
num_blk8x8_uv
; ++b8)

1525 
cuºMB
->
is_v_block
 = 
uv
 = (
b8
 > ((
p_Vid
->
num_uv_blocks
) - 1 ));

1527 
b4
=0; b4 < 4; ++b4)

1529 
i
 = 
cofuv_blk_x
[1][
b8
][
b4
];

1530 
j
 = 
cofuv_blk_y
[1][
b8
][
b4
];

1532 
cuºSli˚
->
	`ªad_c€ff_4x4_CAVLC
(
cuºMB
, 
CHROMA_AC
, 
i
 + 2*
uv
, 
j
 + 4, 
Àv¨r
, 
ru«º
, &
numc€ff
);

1533 
c€f_˘r
 = 0;

1535 
k
 = 0; k < 
numc€ff
;++k)

1537 i‡(
Àv¨r
[
k
] != 0)

1539 
cuºMB
->
s_cbp
[0].
blk
 |
	`i64_powî2
(
cbp_blk_chroma
[
b8
][
b4
]);

1540 
c€f_˘r
 +
ru«º
[
k
] + 1;

1542 
i0
=
pos_sˇn4x4
[
c€f_˘r
][0];

1543 
j0
=
pos_sˇn4x4
[
c€f_˘r
][1];

1545 
cuºSli˚
->
cof
[
PLANE_U
 + 
uv
][(
j
<<2Ë+ 
j0
][(
i
<<2Ë+ 
i0
] = 
Àv¨r
[
k
];

1552 
	}
}

1561 
	$ªad_CBP_™d_c€ffs_‰om_NAL_CAVLC_444
(
Ma¸oblock
 *
cuºMB
)

1563 
i
,
k
;

1564 
mb_ƒ
 = 
cuºMB
->
mbAddrX
;

1565 
cbp
;

1566 
Sy¡axEÀmít
 
cuºSE
;

1567 
D©aP¨tôi⁄
 *
dP
 = 
NULL
;

1568 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1569 c⁄° 
byã
 *
∑πM≠
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
dp_mode
];

1570 
c€f_˘r
, 
i0
, 
j0
;

1571 
Àv¨r
[16], 
ru«º
[16], 
numc€ff
;

1573 
qp_≥r
, 
qp_ªm
;

1574 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1576 
uv
;

1577 
qp_≥r_uv
[3];

1578 
qp_ªm_uv
[3];

1580 
öåa
 = (
cuºMB
->
is_öåa_block
 =
TRUE
);

1582 
√ed_å™sf‹m_size_Êag
;

1584 (*
InvLevñSˇÀ4x4
)[4] = 
NULL
;

1585 (*
InvLevñSˇÀ8x8
)[8] = 
NULL
;

1587 c⁄° 
	`byã
 (*
pos_sˇn4x4
)[2] = ((
p_Vid
->
°ru˘uª
 =
FRAME
Ë&& (!
cuºMB
->
mb_fõld
)Ë? 
SNGL_SCAN
 : 
FIELD_SCAN
;

1588 c⁄° 
byã
 *
pos_sˇn_4x4
 = 
pos_sˇn4x4
[0];

1591 i‡(!
	`IS_I16MB
 (
cuºMB
))

1595 
cuºSE
.
ty≥
 = (
cuºMB
->
mb_ty≥
 =
I4MB
 || cuºMB->mb_ty≥ =
SI4MB
 || cuºMB->mb_ty≥ =
I8MB
)

1596 ? 
SE_CBP_INTRA


1597 : 
SE_CBP_INTER
;

1599 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
cuºSE
.
ty≥
]]);

1601 
cuºSE
.
m≠pög
 = (
cuºMB
->
mb_ty≥
 =
I4MB
 || cuºMB->mb_ty≥ =
SI4MB
 || cuºMB->mb_ty≥ =
I8MB
)

1602 ? 
cuºSli˚
->
löfo_cbp_öåa


1603 : 
cuºSli˚
->
löfo_cbp_öãr
;

1605 
	`TRACE_STRING
("coded_block_pattern");

1606 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, &
cuºSE
, dP);

1607 
cuºMB
->
cbp
 = cb∞
cuºSE
.
vÆue1
;

1612 
√ed_å™sf‹m_size_Êag
 = (((
cuºMB
->
mb_ty≥
 >= 1 && currMB->mb_type <= 3)||

1613 (
	`IS_DIRECT
(
cuºMB
Ë&& 
p_Vid
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
) ||

1614 (
cuºMB
->
NoMbP¨tLessTh™8x8Fœg
))

1615 && 
cuºMB
->
mb_ty≥
 !
I8MB
 && cuºMB->mb_ty≥ !
I4MB


1616 && (
cuºMB
->
cbp
&15)

1617 && 
cuºSli˚
->
Tønsf‹m8x8Mode
);

1619 i‡(
√ed_å™sf‹m_size_Êag
)

1621 
cuºSE
.
ty≥
 = 
SE_HEADER
;

1622 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_HEADER
]]);

1623 
	`TRACE_STRING
("transform_size_8x8_flag");

1626 
cuºSE
.
Àn
 = 1;

1627 
	`ªadSy¡axEÀmít_FLC
(&
cuºSE
, 
dP
->
bô°ªam
);

1629 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = (
Boﬁón
Ë
cuºSE
.
vÆue1
;

1635 i‡(
cbp
 !=0)

1637 
	`ªad_dñè_qu™t
(&
cuºSE
, 
dP
, 
cuºMB
, 
∑πM≠
, ((cuºMB->
is_öåa_block
 =
FALSE
)Ë? 
SE_DELTA_QUANT_INTER
 : 
SE_DELTA_QUANT_INTRA
);

1639 i‡(
cuºSli˚
->
dp_mode
)

1641 i‡((
cuºMB
->
is_öåa_block
 =
FALSE
Ë&& 
cuºSli˚
->
dpC_NŸPª£¡
 )

1642 
cuºMB
->
d∂_Êag
 = 1;

1644 if–
öåa
 && 
cuºSli˚
->
dpB_NŸPª£¡
 )

1646 
cuºMB
->
ei_Êag
 = 1;

1647 
cuºMB
->
d∂_Êag
 = 1;

1651 
	`check_dp_√ighb‹s
 (
cuºMB
);

1652 i‡(
cuºMB
->
d∂_Êag
)

1654 
cbp
 = 0;

1655 
cuºMB
->
cbp
 = cbp;

1662 
cbp
 = 
cuºMB
->cbp;

1664 
	`ªad_dñè_qu™t
(&
cuºSE
, 
dP
, 
cuºMB
, 
∑πM≠
, 
SE_DELTA_QUANT_INTRA
);

1666 i‡(
cuºSli˚
->
dp_mode
)

1668 i‡(
cuºSli˚
->
dpB_NŸPª£¡
)

1670 
cuºMB
->
ei_Êag
 = 1;

1671 
cuºMB
->
d∂_Êag
 = 1;

1673 
	`check_dp_√ighb‹s
 (
cuºMB
);

1674 i‡(
cuºMB
->
d∂_Êag
)

1676 
cuºMB
->
cbp
 = cbp = 0;

1680 i‡(!
cuºMB
->
d∂_Êag
)

1682 
pos_sˇn_4x4
 = 
pos_sˇn4x4
[0];

1684 
cuºSli˚
->
	`ªad_c€ff_4x4_CAVLC
(
cuºMB
, 
LUMA_INTRA16x16DC
, 0, 0, 
Àv¨r
, 
ru«º
, &
numc€ff
);

1686 
k
 = 0; k < 
numc€ff
; ++k)

1688 i‡(
Àv¨r
[
k
] != 0)

1690 
pos_sˇn_4x4
 +2 * 
ru«º
[
k
];

1692 
i0
 = ((*
pos_sˇn_4x4
++) << 2);

1693 
j0
 = ((*
pos_sˇn_4x4
++) << 2);

1695 
cuºSli˚
->
cof
[0][
j0
][
i0
] = 
Àv¨r
[
k
];

1701 if(
cuºMB
->
is_los¶ess
 =
FALSE
)

1702 
	`ôøns_2
(
cuºMB
, (
Cﬁ‹Pœ√
Ë
cuºSli˚
->
cﬁour_∂™e_id
);

1706 
	`upd©e_qp
(
cuºMB
, 
cuºSli˚
->
qp
);

1708 
qp_≥r
 = 
p_Vid
->
qp_≥r_m©rix
[ 
cuºMB
->
qp_sˇÀd
[
cuºSli˚
->
cﬁour_∂™e_id
] ];

1709 
qp_ªm
 = 
p_Vid
->
qp_ªm_m©rix
[ 
cuºMB
->
qp_sˇÀd
[
cuºSli˚
->
cﬁour_∂™e_id
] ];

1712 
i
=
PLANE_U
; i <
PLANE_V
; ++i)

1714 
qp_≥r_uv
[
i
] = 
p_Vid
->
qp_≥r_m©rix
[ 
cuºMB
->
qp_sˇÀd
[i] ];

1715 
qp_ªm_uv
[
i
] = 
p_Vid
->
qp_ªm_m©rix
[ 
cuºMB
->
qp_sˇÀd
[i] ];

1718 
InvLevñSˇÀ4x4
 = 
öåa
? 
cuºSli˚
->
InvLevñSˇÀ4x4_I¡ø
[cuºSli˚->
cﬁour_∂™e_id
][
qp_ªm
] : cuºSli˚->
InvLevñSˇÀ4x4_I¡î
[currSlice->colour_plane_id][qp_rem];

1719 
InvLevñSˇÀ8x8
 = 
öåa
? 
cuºSli˚
->
InvLevñSˇÀ8x8_I¡ø
[cuºSli˚->
cﬁour_∂™e_id
][
qp_ªm
] : cuºSli˚->
InvLevñSˇÀ8x8_I¡î
[currSlice->colour_plane_id][qp_rem];

1722 i‡(
cbp
)

1724 i‡(!
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
)

1726 
cuºMB
->
	`ªad_comp_c€ff_4x4_CAVLC
 (cuºMB, 
PLANE_Y
, 
InvLevñSˇÀ4x4
, 
qp_≥r
, 
cbp
, 
p_Vid
->
nz_c€ff
[
mb_ƒ
][PLANE_Y]);

1730 
cuºMB
->
	`ªad_comp_c€ff_8x8_CAVLC
 (cuºMB, 
PLANE_Y
, 
InvLevñSˇÀ8x8
, 
qp_≥r
, 
cbp
, 
p_Vid
->
nz_c€ff
[
mb_ƒ
][PLANE_Y]);

1735 
	`Á°_mem£t
(
p_Vid
->
nz_c€ff
[
mb_ƒ
][0][0], 0, 
BLOCK_PIXELS
 * (
byã
));

1738 
uv
 = 
PLANE_U
; uv <
PLANE_V
; ++uv )

1741 i‡(
	`IS_I16MB
 (
cuºMB
))

1743 i‡(
uv
 =
PLANE_U
)

1744 
cuºSli˚
->
	`ªad_c€ff_4x4_CAVLC
(
cuºMB
, 
CB_INTRA16x16DC
, 0, 0, 
Àv¨r
, 
ru«º
, &
numc€ff
);

1746 
cuºSli˚
->
	`ªad_c€ff_4x4_CAVLC
(
cuºMB
, 
CR_INTRA16x16DC
, 0, 0, 
Àv¨r
, 
ru«º
, &
numc€ff
);

1748 
c€f_˘r
=-1;

1750 
k
 = 0; k < 
numc€ff
; ++k)

1752 i‡(
Àv¨r
[
k
] != 0)

1754 
c€f_˘r
 +
ru«º
[
k
] + 1;

1756 
i0
 = 
pos_sˇn4x4
[
c€f_˘r
][0];

1757 
j0
 = 
pos_sˇn4x4
[
c€f_˘r
][1];

1758 
cuºSli˚
->
cof
[
uv
][
j0
<<2][
i0
<<2] = 
Àv¨r
[
k
];

1763 if(
cuºMB
->
is_los¶ess
 =
FALSE
)

1765 
	`ôøns_2
(
cuºMB
, (
Cﬁ‹Pœ√
Ë(
uv
));

1769 
	`upd©e_qp
(
cuºMB
, 
cuºSli˚
->
qp
);

1772 
qp_≥r_uv
[
uv
] = 
p_Vid
->
qp_≥r_m©rix
[ 
cuºMB
->
qp_sˇÀd
[uv] ];

1773 
qp_ªm_uv
[
uv
] = 
p_Vid
->
qp_ªm_m©rix
[ 
cuºMB
->
qp_sˇÀd
[uv] ];

1775 
InvLevñSˇÀ4x4
 = 
öåa
? 
cuºSli˚
->
InvLevñSˇÀ4x4_I¡ø
[
uv
][
qp_ªm_uv
[uv]] : cuºSli˚->
InvLevñSˇÀ4x4_I¡î
[uv][qp_rem_uv[uv]];

1776 
InvLevñSˇÀ8x8
 = 
öåa
? 
cuºSli˚
->
InvLevñSˇÀ8x8_I¡ø
[
uv
][
qp_ªm_uv
[uv]] : cuºSli˚->
InvLevñSˇÀ8x8_I¡î
[uv][qp_rem_uv[uv]];

1778 i‡(!
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
)

1780 
cuºMB
->
	`ªad_comp_c€ff_4x4_CAVLC
 (cuºMB, (
Cﬁ‹Pœ√
Ë(
uv
), 
InvLevñSˇÀ4x4
, 
qp_≥r_uv
[uv], 
cbp
, 
p_Vid
->
nz_c€ff
[
mb_ƒ
][uv]);

1784 
cuºMB
->
	`ªad_comp_c€ff_8x8_CAVLC
 (cuºMB, (
Cﬁ‹Pœ√
Ë(
uv
), 
InvLevñSˇÀ8x8
, 
qp_≥r_uv
[uv], 
cbp
, 
p_Vid
->
nz_c€ff
[
mb_ƒ
][uv]);

1787 
	}
}

1796 
	$ªad_CBP_™d_c€ffs_‰om_NAL_CAVLC_420
(
Ma¸oblock
 *
cuºMB
)

1798 
i
,
j
,
k
;

1799 
mb_ƒ
 = 
cuºMB
->
mbAddrX
;

1800 
cbp
;

1801 
Sy¡axEÀmít
 
cuºSE
;

1802 
D©aP¨tôi⁄
 *
dP
 = 
NULL
;

1803 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1804 c⁄° 
byã
 *
∑πM≠
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
dp_mode
];

1805 
c€f_˘r
, 
i0
, 
j0
, 
b8
;

1806 
Œ
;

1807 
Àv¨r
[16], 
ru«º
[16], 
numc€ff
;

1809 
qp_≥r
, 
qp_ªm
;

1810 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1811 
smb
 = ((
p_Vid
->
ty≥
==
SP_SLICE
Ë&& (
cuºMB
->
is_öåa_block
 =
FALSE
)Ë|| (p_Vid->ty≥ =
SI_SLICE
 && cuºMB->
mb_ty≥
 =
SI4MB
);

1813 
uv
;

1814 
qp_≥r_uv
[2];

1815 
qp_ªm_uv
[2];

1817 
öåa
 = (
cuºMB
->
is_öåa_block
 =
TRUE
);

1818 
ãmp
[4];

1820 
b4
;

1823 
√ed_å™sf‹m_size_Êag
;

1825 (*
InvLevñSˇÀ4x4
)[4] = 
NULL
;

1826 (*
InvLevñSˇÀ8x8
)[8] = 
NULL
;

1828 c⁄° 
	`byã
 (*
pos_sˇn4x4
)[2] = ((
p_Vid
->
°ru˘uª
 =
FRAME
Ë&& (!
cuºMB
->
mb_fõld
)Ë? 
SNGL_SCAN
 : 
FIELD_SCAN
;

1829 c⁄° 
byã
 *
pos_sˇn_4x4
 = 
pos_sˇn4x4
[0];

1832 i‡(!
	`IS_I16MB
 (
cuºMB
))

1836 
cuºSE
.
ty≥
 = (
cuºMB
->
mb_ty≥
 =
I4MB
 || cuºMB->mb_ty≥ =
SI4MB
 || cuºMB->mb_ty≥ =
I8MB
)

1837 ? 
SE_CBP_INTRA


1838 : 
SE_CBP_INTER
;

1840 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
cuºSE
.
ty≥
]]);

1842 
cuºSE
.
m≠pög
 = (
cuºMB
->
mb_ty≥
 =
I4MB
 || cuºMB->mb_ty≥ =
SI4MB
 || cuºMB->mb_ty≥ =
I8MB
)

1843 ? 
cuºSli˚
->
löfo_cbp_öåa


1844 : 
cuºSli˚
->
löfo_cbp_öãr
;

1846 
	`TRACE_STRING
("coded_block_pattern");

1847 
dP
->
	`ªadSy¡axEÀmít
(
cuºMB
, &
cuºSE
, dP);

1848 
cuºMB
->
cbp
 = cb∞
cuºSE
.
vÆue1
;

1852 
√ed_å™sf‹m_size_Êag
 = (((
cuºMB
->
mb_ty≥
 >= 1 && currMB->mb_type <= 3)||

1853 (
	`IS_DIRECT
(
cuºMB
Ë&& 
p_Vid
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
) ||

1854 (
cuºMB
->
NoMbP¨tLessTh™8x8Fœg
))

1855 && 
cuºMB
->
mb_ty≥
 !
I8MB
 && cuºMB->mb_ty≥ !
I4MB


1856 && (
cuºMB
->
cbp
&15)

1857 && 
cuºSli˚
->
Tønsf‹m8x8Mode
);

1859 i‡(
√ed_å™sf‹m_size_Êag
)

1861 
cuºSE
.
ty≥
 = 
SE_HEADER
;

1862 
dP
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_HEADER
]]);

1863 
	`TRACE_STRING
("transform_size_8x8_flag");

1866 
cuºSE
.
Àn
 = 1;

1867 
	`ªadSy¡axEÀmít_FLC
(&
cuºSE
, 
dP
->
bô°ªam
);

1869 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = (
Boﬁón
Ë
cuºSE
.
vÆue1
;

1875 i‡(
cbp
 !=0)

1877 
	`ªad_dñè_qu™t
(&
cuºSE
, 
dP
, 
cuºMB
, 
∑πM≠
, ((cuºMB->
is_öåa_block
 =
FALSE
)Ë? 
SE_DELTA_QUANT_INTER
 : 
SE_DELTA_QUANT_INTRA
);

1879 i‡(
cuºSli˚
->
dp_mode
)

1881 i‡((
cuºMB
->
is_öåa_block
 =
FALSE
Ë&& 
cuºSli˚
->
dpC_NŸPª£¡
 )

1882 
cuºMB
->
d∂_Êag
 = 1;

1884 if–
öåa
 && 
cuºSli˚
->
dpB_NŸPª£¡
 )

1886 
cuºMB
->
ei_Êag
 = 1;

1887 
cuºMB
->
d∂_Êag
 = 1;

1891 
	`check_dp_√ighb‹s
 (
cuºMB
);

1892 i‡(
cuºMB
->
d∂_Êag
)

1894 
cbp
 = 0;

1895 
cuºMB
->
cbp
 = cbp;

1902 
cbp
 = 
cuºMB
->cbp;

1903 
	`ªad_dñè_qu™t
(&
cuºSE
, 
dP
, 
cuºMB
, 
∑πM≠
, 
SE_DELTA_QUANT_INTRA
);

1905 i‡(
cuºSli˚
->
dp_mode
)

1907 i‡(
cuºSli˚
->
dpB_NŸPª£¡
)

1909 
cuºMB
->
ei_Êag
 = 1;

1910 
cuºMB
->
d∂_Êag
 = 1;

1912 
	`check_dp_√ighb‹s
 (
cuºMB
);

1913 i‡(
cuºMB
->
d∂_Êag
)

1915 
cuºMB
->
cbp
 = cbp = 0;

1919 i‡(!
cuºMB
->
d∂_Êag
)

1921 
pos_sˇn_4x4
 = 
pos_sˇn4x4
[0];

1923 
cuºSli˚
->
	`ªad_c€ff_4x4_CAVLC
(
cuºMB
, 
LUMA_INTRA16x16DC
, 0, 0, 
Àv¨r
, 
ru«º
, &
numc€ff
);

1925 
k
 = 0; k < 
numc€ff
; ++k)

1927 i‡(
Àv¨r
[
k
] != 0)

1929 
pos_sˇn_4x4
 +2 * 
ru«º
[
k
];

1931 
i0
 = ((*
pos_sˇn_4x4
++) << 2);

1932 
j0
 = ((*
pos_sˇn_4x4
++) << 2);

1934 
cuºSli˚
->
cof
[0][
j0
][
i0
] = 
Àv¨r
[
k
];

1940 if(
cuºMB
->
is_los¶ess
 =
FALSE
)

1941 
	`ôøns_2
(
cuºMB
, (
Cﬁ‹Pœ√
Ë
cuºSli˚
->
cﬁour_∂™e_id
);

1945 
	`upd©e_qp
(
cuºMB
, 
cuºSli˚
->
qp
);

1947 
qp_≥r
 = 
p_Vid
->
qp_≥r_m©rix
[ 
cuºMB
->
qp_sˇÀd
[
cuºSli˚
->
cﬁour_∂™e_id
] ];

1948 
qp_ªm
 = 
p_Vid
->
qp_ªm_m©rix
[ 
cuºMB
->
qp_sˇÀd
[
cuºSli˚
->
cﬁour_∂™e_id
] ];

1951 
i
=0; i < 2; ++i)

1953 
qp_≥r_uv
[
i
] = 
p_Vid
->
qp_≥r_m©rix
[ 
cuºMB
->
qp_sˇÀd
[i + 1] ];

1954 
qp_ªm_uv
[
i
] = 
p_Vid
->
qp_ªm_m©rix
[ 
cuºMB
->
qp_sˇÀd
[i + 1] ];

1957 
InvLevñSˇÀ4x4
 = 
öåa
? 
cuºSli˚
->
InvLevñSˇÀ4x4_I¡ø
[cuºSli˚->
cﬁour_∂™e_id
][
qp_ªm
] : cuºSli˚->
InvLevñSˇÀ4x4_I¡î
[currSlice->colour_plane_id][qp_rem];

1958 
InvLevñSˇÀ8x8
 = 
öåa
? 
cuºSli˚
->
InvLevñSˇÀ8x8_I¡ø
[cuºSli˚->
cﬁour_∂™e_id
][
qp_ªm
] : cuºSli˚->
InvLevñSˇÀ8x8_I¡î
[currSlice->colour_plane_id][qp_rem];

1961 i‡(
cbp
)

1963 i‡(!
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
)

1965 
cuºMB
->
	`ªad_comp_c€ff_4x4_CAVLC
 (cuºMB, 
PLANE_Y
, 
InvLevñSˇÀ4x4
, 
qp_≥r
, 
cbp
, 
p_Vid
->
nz_c€ff
[
mb_ƒ
][PLANE_Y]);

1969 
cuºMB
->
	`ªad_comp_c€ff_8x8_CAVLC
 (cuºMB, 
PLANE_Y
, 
InvLevñSˇÀ8x8
, 
qp_≥r
, 
cbp
, 
p_Vid
->
nz_c€ff
[
mb_ƒ
][PLANE_Y]);

1974 
	`Á°_mem£t
(
p_Vid
->
nz_c€ff
[
mb_ƒ
][0][0], 0, 
BLOCK_PIXELS
 * (
byã
));

1980 if(
cbp
>15)

1982 
Œ
=0;ll<3;ll+=2)

1984 
uv
 = 
Œ
>>1;

1986 
InvLevñSˇÀ4x4
 = 
öåa
 ? 
cuºSli˚
->
InvLevñSˇÀ4x4_I¡ø
[
PLANE_U
 + 
uv
][
qp_ªm_uv
[uv]] : cuºSli˚->
InvLevñSˇÀ4x4_I¡î
[PLANE_U + uv][qp_rem_uv[uv]];

1988 
	`mem£t
(
cuºSli˚
->
cofu
, 0, 4 *());

1989 
c€f_˘r
=-1;

1991 
cuºSli˚
->
	`ªad_c€ff_4x4_CAVLC
(
cuºMB
, 
CHROMA_DC
, 0, 0, 
Àv¨r
, 
ru«º
, &
numc€ff
);

1993 
k
 = 0; k < 
numc€ff
; ++k)

1995 i‡(
Àv¨r
[
k
] != 0)

1997 
cuºMB
->
s_cbp
[0].
blk
 |0xf0000 << (
Œ
<<1) ;

1998 
c€f_˘r
 +
ru«º
[
k
] + 1;

1999 
cuºSli˚
->
cofu
[
c€f_˘r
]=
Àv¨r
[
k
];

2004 i‡(
smb
 || (
cuºMB
->
is_los¶ess
 =
TRUE
))

2006 
cuºSli˚
->
cof
[
PLANE_U
 + 
uv
][0][0] = cuºSli˚->
cofu
[0];

2007 
cuºSli˚
->
cof
[
PLANE_U
 + 
uv
][0][4] = cuºSli˚->
cofu
[1];

2008 
cuºSli˚
->
cof
[
PLANE_U
 + 
uv
][4][0] = cuºSli˚->
cofu
[2];

2009 
cuºSli˚
->
cof
[
PLANE_U
 + 
uv
][4][4] = cuºSli˚->
cofu
[3];

2017 
	`ihadam¨d2x2
(
cuºSli˚
->
cofu
, 
ãmp
);

2023 
cuºSli˚
->
cof
[
PLANE_U
 + 
uv
][0][0] = (((
ãmp
[0] * 
InvLevñSˇÀ4x4
[0][0])<<
qp_≥r_uv
[uv])>>5);

2024 
cuºSli˚
->
cof
[
PLANE_U
 + 
uv
][0][4] = (((
ãmp
[1] * 
InvLevñSˇÀ4x4
[0][0])<<
qp_≥r_uv
[uv])>>5);

2025 
cuºSli˚
->
cof
[
PLANE_U
 + 
uv
][4][0] = (((
ãmp
[2] * 
InvLevñSˇÀ4x4
[0][0])<<
qp_≥r_uv
[uv])>>5);

2026 
cuºSli˚
->
cof
[
PLANE_U
 + 
uv
][4][4] = (((
ãmp
[3] * 
InvLevñSˇÀ4x4
[0][0])<<
qp_≥r_uv
[uv])>>5);

2034 i‡(
cbp
<=31)

2036 
	`Á°_mem£t
(
p_Vid
->
nz_c€ff
 [
mb_ƒ
 ][1][0], 0, 2 * 
BLOCK_PIXELS
 * (
byã
));

2040 if(
cuºMB
->
is_los¶ess
 =
FALSE
)

2042 
b8
=0; b8 < 
p_Vid
->
num_blk8x8_uv
; ++b8)

2044 
cuºMB
->
is_v_block
 = 
uv
 = (
b8
 > ((
p_Vid
->
num_uv_blocks
) - 1 ));

2045 
InvLevñSˇÀ4x4
 = 
öåa
 ? 
cuºSli˚
->
InvLevñSˇÀ4x4_I¡ø
[
PLANE_U
 + 
uv
][
qp_ªm_uv
[uv]] : cuºSli˚->
InvLevñSˇÀ4x4_I¡î
[PLANE_U + uv][qp_rem_uv[uv]];

2047 
b4
=0; b4 < 4; ++b4)

2049 
i
 = 
cofuv_blk_x
[0][
b8
][
b4
];

2050 
j
 = 
cofuv_blk_y
[0][
b8
][
b4
];

2052 
cuºSli˚
->
	`ªad_c€ff_4x4_CAVLC
(
cuºMB
, 
CHROMA_AC
, 
i
 + 2*
uv
, 
j
 + 4, 
Àv¨r
, 
ru«º
, &
numc€ff
);

2053 
c€f_˘r
 = 0;

2055 
k
 = 0; k < 
numc€ff
;++k)

2057 i‡(
Àv¨r
[
k
] != 0)

2059 
cuºMB
->
s_cbp
[0].
blk
 |
	`i64_powî2
(
cbp_blk_chroma
[
b8
][
b4
]);

2060 
c€f_˘r
 +
ru«º
[
k
] + 1;

2062 
i0
=
pos_sˇn4x4
[
c€f_˘r
][0];

2063 
j0
=
pos_sˇn4x4
[
c€f_˘r
][1];

2065 
cuºSli˚
->
cof
[
PLANE_U
 + 
uv
][(
j
<<2Ë+ 
j0
][(
i
<<2Ë+ 
i0
] = 
	`rshi·_∫d_sf
((
Àv¨r
[
k
] * 
InvLevñSˇÀ4x4
[j0][i0])<<
qp_≥r_uv
[uv], 4);

2074 
b8
=0; b8 < 
p_Vid
->
num_blk8x8_uv
; ++b8)

2076 
cuºMB
->
is_v_block
 = 
uv
 = (
b8
 > ((
p_Vid
->
num_uv_blocks
) - 1 ));

2078 
b4
=0; b4 < 4; ++b4)

2080 
i
 = 
cofuv_blk_x
[0][
b8
][
b4
];

2081 
j
 = 
cofuv_blk_y
[0][
b8
][
b4
];

2083 
cuºSli˚
->
	`ªad_c€ff_4x4_CAVLC
(
cuºMB
, 
CHROMA_AC
, 
i
 + 2*
uv
, 
j
 + 4, 
Àv¨r
, 
ru«º
, &
numc€ff
);

2084 
c€f_˘r
 = 0;

2086 
k
 = 0; k < 
numc€ff
;++k)

2088 i‡(
Àv¨r
[
k
] != 0)

2090 
cuºMB
->
s_cbp
[0].
blk
 |
	`i64_powî2
(
cbp_blk_chroma
[
b8
][
b4
]);

2091 
c€f_˘r
 +
ru«º
[
k
] + 1;

2093 
i0
=
pos_sˇn4x4
[
c€f_˘r
][0];

2094 
j0
=
pos_sˇn4x4
[
c€f_˘r
][1];

2096 
cuºSli˚
->
cof
[
PLANE_U
 + 
uv
][(
j
<<2Ë+ 
j0
][(
i
<<2Ë+ 
i0
] = 
Àv¨r
[
k
];

2103 
	}
}

2113 
	$£t_ªad_comp_c€ff_ˇvlc
(
Ma¸oblock
 *
cuºMB
)

2115 i‡(
cuºMB
->
is_los¶ess
 =
FALSE
)

2117 
cuºMB
->
ªad_comp_c€ff_4x4_CAVLC
 =Ñead_comp_coeff_4x4_CAVLC;

2118 
cuºMB
->
ªad_comp_c€ff_8x8_CAVLC
 =Ñead_comp_coeff_8x8_CAVLC;

2122 
cuºMB
->
ªad_comp_c€ff_4x4_CAVLC
 = 
ªad_comp_c€ff_4x4_CAVLC_ls
;

2123 
cuºMB
->
ªad_comp_c€ff_8x8_CAVLC
 = 
ªad_comp_c€ff_8x8_CAVLC_ls
;

2125 
	}
}

2128 
	$£t_ªad_CBP_™d_c€ffs_ˇvlc
(
Sli˚
 *
cuºSli˚
)

2130 
cuºSli˚
->
p_Vid
->
a˘ive_•s
->
chroma_f‹m©_idc
)

2132 
YUV444
:

2133 i‡(
cuºSli˚
->
p_Vid
->
£∑øã_cﬁour_∂™e_Êag
 == 0)

2135 
cuºSli˚
->
ªad_CBP_™d_c€ffs_‰om_NAL
 = 
ªad_CBP_™d_c€ffs_‰om_NAL_CAVLC_444
;

2139 
cuºSli˚
->
ªad_CBP_™d_c€ffs_‰om_NAL
 = 
ªad_CBP_™d_c€ffs_‰om_NAL_CAVLC_400
;

2142 
YUV422
:

2143 
cuºSli˚
->
ªad_CBP_™d_c€ffs_‰om_NAL
 = 
ªad_CBP_™d_c€ffs_‰om_NAL_CAVLC_422
;

2145 
YUV420
:

2146 
cuºSli˚
->
ªad_CBP_™d_c€ffs_‰om_NAL
 = 
ªad_CBP_™d_c€ffs_‰om_NAL_CAVLC_420
;

2148 
YUV400
:

2149 
cuºSli˚
->
ªad_CBP_™d_c€ffs_‰om_NAL
 = 
ªad_CBP_™d_c€ffs_‰om_NAL_CAVLC_400
;

2152 
	`as£π
 (1);

2153 
cuºSli˚
->
ªad_CBP_™d_c€ffs_‰om_NAL
 = 
NULL
;

2156 
	}
}

	@ldecod/src/rtp.c

89 #i‡
deföed
(
WIN32
Ë|| deföed(
WIN64
)

90 
	~<Wösock2.h
>

92 
	~<√töë/ö.h
>

95 
	~"c⁄åibut‹s.h
"

96 
	~"globÆ.h
"

97 
	~"îr‹c⁄˚Æmít.h
"

98 
	~"πp.h
"

99 
	~"fmo.h
"

100 
	~"£i.h
"

101 
	~"memÆloc.h
"

103 
RTPRódPackë
 (
RTP∑ckë_t
 *
p
, 
bô°ªam
);

113 
	$O≥nRTPFûe
 (*
‚
, *
p_BôSåómFûe
)

115 i‡(((*
p_BôSåómFûe
Ë
	`›í
(
‚
, 
OPENFLAGS_READ
)) == -1)

117 
	`¢¥ötf
 (
îr‹ãxt
, 
ET_SIZE
, "C™nŸ o≥¿RTP fûê'%s'", 
‚
);

118 
	`îr‹
(
îr‹ãxt
,500);

120 
	}
}

129 
	$Clo£RTPFûe
(*
p_BôSåómFûe
)

131 i‡((*
p_BôSåómFûe
) != -1)

133 
	`˛o£
(*
p_BôSåómFûe
);

134 (*
p_BôSåómFûe
) = - 1;

136 
	}
}

154 
	$GëRTPNALU
 (
VideoP¨amëîs
 *
p_Vid
, 
NALU_t
 *
«lu
, 
BôSåómFûe
)

156 
uöt16
 
fú°_ˇŒ
 = 1;

157 
uöt16
 
ﬁd_£q
 = 0;

159 
RTP∑ckë_t
 *
p
;

160 
ªt
;

162 i‡((
p
=
	`mÆloc
 ( (
RTP∑ckë_t
)))=
NULL
)

163 
	`no_mem_exô
 ("GetRTPNALU-1");

164 i‡((
p
->
∑ckë
=
	`mÆloc
 (
MAXRTPPACKETSIZE
))=
NULL
)

165 
	`no_mem_exô
 ("GetRTPNALU-2");

166 i‡((
p
->
∑ylﬂd
=
	`mÆloc
 (
MAXRTPPACKETSIZE
))=
NULL
)

167 
	`no_mem_exô
 ("GetRTPNALU-3");

169 
ªt
 = 
	`RTPRódPackë
 (
p
, 
BôSåómFûe
);

170 
«lu
->
f‹biddí_bô
 = 1;

171 
«lu
->
Àn
 = 0;

173 i‡(
ªt
 > 0)

175 i‡(
fú°_ˇŒ
)

177 
fú°_ˇŒ
 = 0;

178 
ﬁd_£q
 = (
uöt16
Ë(
p
->
£q
 - 1);

181 
«lu
->
lo°_∑ckës
 = (
uöt16
Ë–
p
->
£q
 - (
ﬁd_£q
 + 1) );

182 
ﬁd_£q
 = 
p
->
£q
;

184 
	`as£π
 (
p
->
∑yÀn
 < 
«lu
->
max_size
);

186 
«lu
->
Àn
 = 
p
->
∑yÀn
;

187 
	`mem˝y
 (
«lu
->
buf
, 
p
->
∑ylﬂd
,Ö->
∑yÀn
);

188 
«lu
->
f‹biddí_bô
 = («lu->
buf
[0]>>7) & 1;

189 
«lu
->
«l_ª„ªn˚_idc
 = (
NÆRefIdc
Ë(“Æu->
buf
[0]>>5) & 3);

190 
«lu
->
«l_unô_ty≥
 = (
NÆuTy≥
Ë(“Æu->
buf
[0]) & 0x1f);

191 i‡(
«lu
->
lo°_∑ckës
)

193 
	`¥ötf
 ("Warning: RTP sequenceÇumber discontinuity detected\n");

198 
	`‰ì
 (
p
->
∑ylﬂd
);

199 
	`‰ì
 (
p
->
∑ckë
);

200 
	`‰ì
 (
p
);

204 i‡(
ªt
>0)

206  
«lu
->
Àn
;

209  
ªt
;

210 
	}
}

239 
	$Decompo£RTP∑ckë
 (
RTP∑ckë_t
 *
p
)

243 
	`as£π
 (
p
->
∑ckÀn
 < 65536 - 28);

244 
	`as£π
 (
p
->
∑ckÀn
 >= 12);

245 
	`as£π
 (
p
->
∑ylﬂd
 !
NULL
);

246 
	`as£π
 (
p
->
∑ckë
 !
NULL
);

250 
p
->
v
 = (p->
∑ckë
[0] >> 6) & 0x03;

251 
p
->∞’->
∑ckë
[0] >> 5) & 0x01;

252 
p
->
x
 = (p->
∑ckë
[0] >> 4) & 0x01;

253 
p
->
cc
 = (p->
∑ckë
[0] >> 0) & 0x0F;

255 
p
->
m
 = (p->
∑ckë
[1] >> 7) & 0x01;

256 
p
->
±
 = (p->
∑ckë
[1] >> 0) & 0x7F;

258 
	`mem˝y
 (&
p
->
£q
, &p->
∑ckë
[2], 2);

259 
p
->
£q
 = 
	`¡ohs
((
uöt16
)p->seq);

261 
	`mem˝y
 (&
p
->
time°amp
, &p->
∑ckë
[4], 4);

262 
p
->
time°amp
 = 
	`¡ohl
(p->timestamp);

263 
	`mem˝y
 (&
p
->
s§c
, &p->
∑ckë
[8], 4);

264 
p
->
s§c
 = 
	`¡ohl
(p->ssrc);

267 i‡–(
p
->
v
 != 2)

268 || (
p
->p != 0)

269 || (
p
->
x
 != 0)

270 || (
p
->
cc
 != 0) )

272 
	`¥ötf
 ("DecomposeRTPpacket, RTP header consistencyÖroblem, header follows\n");

273 
	`DumpRTPHódî
 (
p
);

276 
p
->
∑yÀn
 =Ö->
∑ckÀn
-12;

277 
	`mem˝y
 (
p
->
∑ylﬂd
, &p->
∑ckë
[12],Ö->
∑yÀn
);

279 
	}
}

303 
	$DumpRTPHódî
 (
RTP∑ckë_t
 *
p
)

306 
i
;

307 
i
=0; i< 30; i++)

308 
	`¥ötf
 ("%02x ", 
p
->
∑ckë
[
i
]);

309 
	`¥ötf
 ("Vîsi⁄ (V): %d\n", (Ë
p
->
v
);

310 
	`¥ötf
 ("Paddög (P): %d\n", (Ë
p
->p);

311 
	`¥ötf
 ("Exãnsi⁄ (X): %d\n", (Ë
p
->
x
);

312 
	`¥ötf
 ("CSRC cou¡ (CC): %d\n", (Ë
p
->
cc
);

313 
	`¥ötf
 ("M¨kî bô (M): %d\n", (Ë
p
->
m
);

314 
	`¥ötf
 ("Paylﬂd Ty≥ (PT): %d\n", (Ë
p
->
±
);

315 
	`¥ötf
 ("Sequí˚ Numbî: %d\n", (Ë
p
->
£q
);

316 
	`¥ötf
 ("Time°amp: %d\n", (Ë
p
->
time°amp
);

317 
	`¥ötf
 ("SSRC: %d\n", (Ë
p
->
s§c
);

318 
	}
}

348 
	$RTPRódPackë
 (
RTP∑ckë_t
 *
p
, 
bô°ªam
)

350 
öt64
 
Fûïos
;

351 
ötime
;

353 
	`as£π
 (
p
 !
NULL
);

354 
	`as£π
 (
p
->
∑ckë
 !
NULL
);

355 
	`as£π
 (
p
->
∑ylﬂd
 !
NULL
);

357 
Fûïos
 = 
	`ãŒ
 (
bô°ªam
);

358 i‡(4 !
	`ªad
 (
bô°ªam
, &
p
->
∑ckÀn
, 4))

362 i‡(4 !
	`ªad
 (
bô°ªam
, &
ötime
, 4))

364 
	`l£ek
 (
bô°ªam
, 
Fûïos
, 
SEEK_SET
);

365 
	`¥ötf
 ("RTPReadPacket: File corruption, couldÇotÑead Timestamp,Éxit\n");

366 
	`exô
 (-1);

369 
	`as£π
 (
p
->
∑ckÀn
 < 
MAXRTPPACKETSIZE
);

371 i‡(
p
->
∑ckÀn
 !(Ë
	`ªad
 (
bô°ªam
,Ö->
∑ckë
,Ö->packlen))

373 
	`¥ötf
 ("RTPRódPackë: Fûêc‹ru±i⁄, couldÇŸÑód %d byãs\n", (Ë
p
->
∑ckÀn
);

374 
	`exô
 (-1);

377 i‡(
	`Decompo£RTP∑ckë
 (
p
) < 0)

381 
	`¥ötf
 ("ErrorsÑeported by DecomposePacket(),Éxit\n");

382 
	`exô
 (-700);

384 
	`as£π
 (
p
->
±
 =
H264PAYLOADTYPE
);

385 
	`as£π
 (
p
->
s§c
 =
H264SSRC
);

386  
p
->
∑ckÀn
;

387 
	}
}

	@ldecod/src/sei.c

15 
	~"c⁄åibut‹s.h
"

17 
	~<m©h.h
>

18 
	~"globÆ.h
"

19 
	~"memÆloc.h
"

20 
	~"£i.h
"

21 
	~"vlc.h
"

22 
	~"hódî.h
"

23 
	~"mbuf„r.h
"

24 
	~"∑r£t.h
"

66 
	$I¡î¥ëSEIMesßge
(
byã
* 
msg
, 
size
, 
VideoP¨amëîs
 *
p_Vid
, 
Sli˚
 *
pSli˚
)

68 
∑ylﬂd_ty≥
 = 0;

69 
∑ylﬂd_size
 = 0;

70 
off£t
 = 1;

71 
byã
 
tmp_byã
;

76 
∑ylﬂd_ty≥
 = 0;

77 
tmp_byã
 = 
msg
[
off£t
++];

78 
tmp_byã
 == 0xFF)

80 
∑ylﬂd_ty≥
 += 255;

81 
tmp_byã
 = 
msg
[
off£t
++];

83 
∑ylﬂd_ty≥
 +
tmp_byã
;

85 
∑ylﬂd_size
 = 0;

86 
tmp_byã
 = 
msg
[
off£t
++];

87 
tmp_byã
 == 0xFF)

89 
∑ylﬂd_size
 += 255;

90 
tmp_byã
 = 
msg
[
off£t
++];

92 
∑ylﬂd_size
 +
tmp_byã
;

94  
∑ylﬂd_ty≥
 )

96 
SEI_BUFFERING_PERIOD
:

97 
	`öãΩªt_buf„rög_≥riod_öfo
–
msg
+
off£t
, 
∑ylﬂd_size
, 
p_Vid
 );

99 
SEI_PIC_TIMING
:

100 
	`öãΩªt_pi˘uª_timög_öfo
–
msg
+
off£t
, 
∑ylﬂd_size
, 
p_Vid
 );

102 
SEI_PAN_SCAN_RECT
:

103 
	`öãΩªt_∑n_sˇn_ª˘_öfo
–
msg
+
off£t
, 
∑ylﬂd_size
, 
p_Vid
 );

105 
SEI_FILLER_PAYLOAD
:

106 
	`öãΩªt_fûÀr_∑ylﬂd_öfo
–
msg
+
off£t
, 
∑ylﬂd_size
, 
p_Vid
 );

108 
SEI_USER_DATA_REGISTERED_ITU_T_T35
:

109 
	`öãΩªt_u£r_d©a_ªgi°îed_ôu_t_t35_öfo
–
msg
+
off£t
, 
∑ylﬂd_size
, 
p_Vid
 );

111 
SEI_USER_DATA_UNREGISTERED
:

112 
	`öãΩªt_u£r_d©a_uƒegi°îed_öfo
–
msg
+
off£t
, 
∑ylﬂd_size
, 
p_Vid
 );

114 
SEI_RECOVERY_POINT
:

115 
	`öãΩªt_ªcovîy_poöt_öfo
–
msg
+
off£t
, 
∑ylﬂd_size
, 
p_Vid
 );

117 
SEI_DEC_REF_PIC_MARKING_REPETITION
:

118 
	`öãΩªt_dec_ªf_pic_m¨kög_ª≥tôi⁄_öfo
–
msg
+
off£t
, 
∑ylﬂd_size
, 
p_Vid
, 
pSli˚
 );

120 
SEI_SPARE_PIC
:

121 
	`öãΩªt_•¨e_pic
–
msg
+
off£t
, 
∑ylﬂd_size
, 
p_Vid
 );

123 
SEI_SCENE_INFO
:

124 
	`öãΩªt_s˚√_öf‹m©i⁄
–
msg
+
off£t
, 
∑ylﬂd_size
, 
p_Vid
 );

126 
SEI_SUB_SEQ_INFO
:

127 
	`öãΩªt_sub£quí˚_öfo
–
msg
+
off£t
, 
∑ylﬂd_size
, 
p_Vid
 );

129 
SEI_SUB_SEQ_LAYER_CHARACTERISTICS
:

130 
	`öãΩªt_sub£quí˚_œyî_ch¨a˘îi°ics_öfo
–
msg
+
off£t
, 
∑ylﬂd_size
, 
p_Vid
 );

132 
SEI_SUB_SEQ_CHARACTERISTICS
:

133 
	`öãΩªt_sub£quí˚_ch¨a˘îi°ics_öfo
–
msg
+
off£t
, 
∑ylﬂd_size
, 
p_Vid
 );

135 
SEI_FULL_FRAME_FREEZE
:

136 
	`öãΩªt_fuŒ_‰ame_‰ìze_öfo
–
msg
+
off£t
, 
∑ylﬂd_size
, 
p_Vid
 );

138 
SEI_FULL_FRAME_FREEZE_RELEASE
:

139 
	`öãΩªt_fuŒ_‰ame_‰ìze_ªÀa£_öfo
–
msg
+
off£t
, 
∑ylﬂd_size
, 
p_Vid
 );

141 
SEI_FULL_FRAME_SNAPSHOT
:

142 
	`öãΩªt_fuŒ_‰ame_¢≠shŸ_öfo
–
msg
+
off£t
, 
∑ylﬂd_size
, 
p_Vid
 );

144 
SEI_PROGRESSIVE_REFINEMENT_SEGMENT_START
:

145 
	`öãΩªt_¥ogªssive_ªföemít_°¨t_öfo
–
msg
+
off£t
, 
∑ylﬂd_size
, 
p_Vid
 );

147 
SEI_PROGRESSIVE_REFINEMENT_SEGMENT_END
:

148 
	`öãΩªt_¥ogªssive_ªföemít_íd_öfo
–
msg
+
off£t
, 
∑ylﬂd_size
, 
p_Vid
 );

150 
SEI_MOTION_CONSTRAINED_SLICE_GROUP_SET
:

151 
	`öãΩªt_mŸi⁄_c⁄°øöed_¶i˚_group_£t_öfo
–
msg
+
off£t
, 
∑ylﬂd_size
, 
p_Vid
 );

152 
SEI_FILM_GRAIN_CHARACTERISTICS
:

153 
	`öãΩªt_fûm_gøö_ch¨a˘îi°ics_öfo
 ( 
msg
+
off£t
, 
∑ylﬂd_size
, 
p_Vid
 );

155 
SEI_DEBLOCKING_FILTER_DISPLAY_PREFERENCE
:

156 
	`öãΩªt_deblockög_fûãr_di•œy_¥e„ªn˚_öfo
 ( 
msg
+
off£t
, 
∑ylﬂd_size
, 
p_Vid
 );

158 
SEI_STEREO_VIDEO_INFO
:

159 
	`öãΩªt_°îeo_video_öfo_öfo
 ( 
msg
+
off£t
, 
∑ylﬂd_size
, 
p_Vid
 );

161 
SEI_TONE_MAPPING
:

162 
	`öãΩªt_t⁄e_m≠pög
–
msg
+
off£t
, 
∑ylﬂd_size
, 
p_Vid
 );

164 
SEI_POST_FILTER_HINTS
:

165 
	`öãΩªt_po°_fûãr_höts_öfo
 ( 
msg
+
off£t
, 
∑ylﬂd_size
, 
p_Vid
 );

167 
SEI_FRAME_PACKING_ARRANGEMENT
:

168 
	`öãΩªt_‰ame_∑ckög_¨øngemít_öfo
–
msg
+
off£t
, 
∑ylﬂd_size
, 
p_Vid
 );

171 
	`öãΩªt_ª£rved_öfo
–
msg
+
off£t
, 
∑ylﬂd_size
, 
p_Vid
 );

174 
off£t
 +
∑ylﬂd_size
;

176 }  
msg
[
off£t
] != 0x80 );

178 
	`as£π
(
msg
[
off£t
] == 0x80);

179 
	`as£π
–
off£t
+1 =
size
 );

180 
	}
}

196 
	$öãΩªt_•¨e_pic
–
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
 )

198 
i
,
x
,
y
;

199 
Bô°ªam
* 
buf
;

200 
bô0
, 
bô1
, 
bôc
, 
no_bô0
;

201 
èrgë_‰ame_num
 = 0;

202 
num_•¨e_pics
;

203 
dñè_•¨e_‰ame_num
, 
C™did©eS∑ªFømeNum
, 
S∑ªFømeNum
 = 0;

204 
ªf_¨ó_ödiˇt‹
;

206 
m
, 
n
, 
À·
, 
right
, 
t›
, 
bŸtom
,
dúe˘x
, 
dúe˘y
;

207 
byã
 ***
m≠
;

209 #ifde‡
WRITE_MAP_IMAGE


210 
symbﬁ_size_ö_byãs
 = 
p_Vid
->
pic_unô_bôsize_⁄_disk
/8;

211 
j
, 
k
, 
i0
, 
j0
, 
tmp
, 
kk
;

212 
fûíame
[20] = "map_dec.yuv";

213 
FILE
 *
Â
;

214 
img≥l
** 
Y
;

215 
ﬁd_≤
=-1;

216 
fú°
 = 1;

218 
	`¥ötf
("SpareÖicture SEI message\n");

221 
p_Dec
->
U£dBôs
 = 0;

223 
	`as£π
–
∑ylﬂd
!=
NULL
);

224 
	`as£π
–
p_Vid
!=
NULL
);

226 
buf
 = 
	`mÆloc
((
Bô°ªam
));

227 
buf
->
bô°ªam_Àngth
 = 
size
;

228 
buf
->
°ªamBuf„r
 = 
∑ylﬂd
;

229 
buf
->
‰ame_bôoff£t
 = 0;

231 
èrgë_‰ame_num
 = 
	`ªad_ue_v
("SEI:Å¨gë_‰ame_num", 
buf
, &
p_Dec
->
U£dBôs
);

233 #ifde‡
WRITE_MAP_IMAGE


234 
	`¥ötf
–"èrgë_‰ame_num i†%d\n", 
èrgë_‰ame_num
 );

237 
num_•¨e_pics
 = 1 + 
	`ªad_ue_v
("SEI:Çum_•¨e_pics_möus1", 
buf
, &
p_Dec
->
U£dBôs
);

239 #ifde‡
WRITE_MAP_IMAGE


240 
	`¥ötf
–"num_•¨e_pic†i†%d\n", 
num_•¨e_pics
 );

243 
	`gë_mem3D
(&
m≠
, 
num_•¨e_pics
, 
p_Vid
->
height
 >> 4,Ö_Vid->
width
 >> 4);

245 
i
=0; i<
num_•¨e_pics
; i++)

247 i‡(
i
==0)

249 
C™did©eS∑ªFømeNum
 = 
èrgë_‰ame_num
 - 1;

250 i‡–
C™did©eS∑ªFømeNum
 < 0 ) C™did©eS∑ªFømeNum = 
MAX_FN
 - 1;

253 
C™did©eS∑ªFømeNum
 = 
S∑ªFømeNum
;

255 
dñè_•¨e_‰ame_num
 = 
	`ªad_ue_v
("SEI: dñè_•¨e_‰ame_num", 
buf
, &
p_Dec
->
U£dBôs
);

257 
S∑ªFømeNum
 = 
C™did©eS∑ªFømeNum
 - 
dñè_•¨e_‰ame_num
;

258 if–
S∑ªFømeNum
 < 0 )

259 
S∑ªFømeNum
 = 
MAX_FN
 + SpareFrameNum;

261 
ªf_¨ó_ödiˇt‹
 = 
	`ªad_ue_v
("SEI:Ñef_¨ó_ödiˇt‹", 
buf
, &
p_Dec
->
U£dBôs
);

263  
ªf_¨ó_ödiˇt‹
 )

266 
y
=0; y<
p_Vid
->
height
 >> 4; y++)

267 
x
=0; x<
p_Vid
->
width
 >> 4; x++)

268 
m≠
[
i
][
y
][
x
] = 0;

271 
y
=0; y<
p_Vid
->
height
 >> 4; y++)

272 
x
=0; x<
p_Vid
->
width
 >> 4; x++)

274 
m≠
[
i
][
y
][
x
] = (
byã
Ë
	`ªad_u_1
("SEI:Ñef_mb_ödiˇt‹", 
buf
, &
p_Dec
->
U£dBôs
);

279 
bô0
 = 0;

280 
bô1
 = 1;

281 
bôc
 = 
bô0
;

282 
no_bô0
 = -1;

284 
x
 = ( (
p_Vid
->
width
 >> 4) - 1 ) / 2;

285 
y
 = ( (
p_Vid
->
height
 >> 4) - 1 ) / 2;

286 
À·
 = 
right
 = 
x
;

287 
t›
 = 
bŸtom
 = 
y
;

288 
dúe˘x
 = 0;

289 
dúe˘y
 = 1;

291 
m
=0; m<
p_Vid
->
height
 >> 4; m++)

292 
n
=0;Ç<
p_Vid
->
width
 >> 4;Ç++)

295 i‡(
no_bô0
<0)

297 
no_bô0
 = 
	`ªad_ue_v
("SEI: zîo_run_Àngth", 
buf
, &
p_Dec
->
U£dBôs
);

299 i‡(
no_bô0
>0)

300 
m≠
[
i
][
y
][
x
] = (
byã
Ë
bô0
;

302 
m≠
[
i
][
y
][
x
] = (
byã
Ë
bô1
;

303 
no_bô0
--;

306 i‡–
dúe˘x
 =-1 && 
dúe˘y
 == 0 )

308 i‡(
x
 > 
À·
) x--;

309 i‡(
x
 == 0)

311 
y
 = 
bŸtom
 + 1;

312 
bŸtom
++;

313 
dúe˘x
 = 1;

314 
dúe˘y
 = 0;

316 i‡(
x
 =
À·
)

318 
x
--;

319 
À·
--;

320 
dúe˘x
 = 0;

321 
dúe˘y
 = 1;

324 i‡–
dúe˘x
 =1 && 
dúe˘y
 == 0 )

326 i‡(
x
 < 
right
) x++;

327 i‡(
x
 =(
p_Vid
->
width
 >> 4) - 1)

329 
y
 = 
t›
 - 1;

330 
t›
--;

331 
dúe˘x
 = -1;

332 
dúe˘y
 = 0;

334 i‡(
x
 =
right
)

336 
x
++;

337 
right
++;

338 
dúe˘x
 = 0;

339 
dúe˘y
 = -1;

342 i‡–
dúe˘x
 =0 && 
dúe˘y
 == -1 )

344 i‡–
y
 > 
t›
) y--;

345 i‡(
y
 == 0)

347 
x
 = 
À·
 - 1;

348 
À·
--;

349 
dúe˘x
 = 0;

350 
dúe˘y
 = 1;

352 i‡(
y
 =
t›
)

354 
y
--;

355 
t›
--;

356 
dúe˘x
 = -1;

357 
dúe˘y
 = 0;

360 i‡–
dúe˘x
 =0 && 
dúe˘y
 == 1 )

362 i‡(
y
 < 
bŸtom
) y++;

363 i‡(
y
 =(
p_Vid
->
height
 >> 4) - 1)

365 
x
 = 
right
+1;

366 
right
++;

367 
dúe˘x
 = 0;

368 
dúe˘y
 = -1;

370 i‡(
y
 =
bŸtom
)

372 
y
++;

373 
bŸtom
++;

374 
dúe˘x
 = 1;

375 
dúe˘y
 = 0;

383 
	`¥ötf
–"Wr⁄gÑef_¨ó_ödiˇt‹ %d!\n", 
ªf_¨ó_ödiˇt‹
 );

384 
	`exô
(0);

390 #ifde‡
WRITE_MAP_IMAGE


392 i‡–
ﬁd_≤
 !
p_Vid
->
numbî
 )

394 
ﬁd_≤
 = 
p_Vid
->
numbî
;

395 
	`gë_mem2D≥l
(&
Y
, 
p_Vid
->
height
,Ö_Vid->
width
);

396 i‡(
fú°
)

398 
Â
 = 
	`f›í
–
fûíame
, "wb" );

399 
fú°
 = 0;

402 
Â
 = 
	`f›í
–
fûíame
, "ab" );

403 
	`as£π
–
Â
 !
NULL
 );

404 
kk
=0; kk<
num_•¨e_pics
; kk++)

406 
i
=0; i < 
p_Vid
->
height
 >> 4; i++)

407 
j
=0; j < 
p_Vid
->
width
 >> 4; j++)

409 
tmp
=
m≠
[
kk
][
i
][
j
]==0? 
p_Vid
->
max_≥l_vÆue_comp
[0] : 0;

410 
i0
=0; i0<16; i0++)

411 
j0
=0; j0<16; j0++)

412 
Y
[
i
*16+
i0
][
j
*16+
j0
]=
tmp
;

416 
i
=0; i < 
p_Vid
->
height
; i++)

417 
j
=0; j < 
p_Vid
->
width
; j++)

418 
	`fwrôe
(&(
Y
[
i
][
j
]), 
symbﬁ_size_ö_byãs
, 1, 
p_out
);

420 
k
=0; k < 2; k++)

421 
i
=0; i < 
p_Vid
->
height
>>1; i++)

422 
j
=0; j < 
p_Vid
->
width
>>1; j++)

423 
	`fwrôe
(&(
p_Vid
->
dc_¥ed_vÆue_comp
[1]), 
symbﬁ_size_ö_byãs
, 1, 
p_out
);

425 
	`f˛o£
–
Â
 );

426 
	`‰ì_mem2D≥l
–
Y
 );

429 #unde‡
WRITE_MAP_IMAGE


432 
	`‰ì_mem3D
–
m≠
 );

434 
	`‰ì
(
buf
);

435 
	}
}

451 
	$öãΩªt_sub£quí˚_öfo
–
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
 )

453 
Bô°ªam
* 
buf
;

454 
sub_£q_œyî_num
, 
sub_£q_id
, 
fú°_ªf_pic_Êag
, 
Àadög_n⁄_ªf_pic_Êag
, 
œ°_pic_Êag
,

455 
sub_£q_‰ame_num_Êag
, 
sub_£q_‰ame_num
;

457 
buf
 = 
	`mÆloc
((
Bô°ªam
));

458 
buf
->
bô°ªam_Àngth
 = 
size
;

459 
buf
->
°ªamBuf„r
 = 
∑ylﬂd
;

460 
buf
->
‰ame_bôoff£t
 = 0;

462 
p_Dec
->
U£dBôs
 = 0;

464 
sub_£q_œyî_num
 = 
	`ªad_ue_v
("SEI: sub_£q_œyî_num" , 
buf
, &
p_Dec
->
U£dBôs
);

465 
sub_£q_id
 = 
	`ªad_ue_v
("SEI: sub_£q_id" , 
buf
, &
p_Dec
->
U£dBôs
);

466 
fú°_ªf_pic_Êag
 = 
	`ªad_u_1
 ("SEI: fú°_ªf_pic_Êag" , 
buf
, &
p_Dec
->
U£dBôs
);

467 
Àadög_n⁄_ªf_pic_Êag
 = 
	`ªad_u_1
 ("SEI:Üódög_n⁄_ªf_pic_Êag", 
buf
, &
p_Dec
->
U£dBôs
);

468 
œ°_pic_Êag
 = 
	`ªad_u_1
 ("SEI:Üa°_pic_Êag" , 
buf
, &
p_Dec
->
U£dBôs
);

469 
sub_£q_‰ame_num_Êag
 = 
	`ªad_u_1
 ("SEI: sub_£q_‰ame_num_Êag" , 
buf
, &
p_Dec
->
U£dBôs
);

470 i‡(
sub_£q_‰ame_num_Êag
)

472 
sub_£q_‰ame_num
 = 
	`ªad_ue_v
("SEI: sub_£q_‰ame_num" , 
buf
, &
p_Dec
->
U£dBôs
);

475 #ifde‡
PRINT_SUBSEQUENCE_INFO


476 
	`¥ötf
("Sub-sequence information SEI message\n");

477 
	`¥ötf
("sub_£q_œyî_num = %d\n", 
sub_£q_œyî_num
 );

478 
	`¥ötf
("sub_£q_id = %d\n", 
sub_£q_id
);

479 
	`¥ötf
("fú°_ªf_pic_Êag = %d\n", 
fú°_ªf_pic_Êag
);

480 
	`¥ötf
("Àadög_n⁄_ªf_pic_Êag = %d\n", 
Àadög_n⁄_ªf_pic_Êag
);

481 
	`¥ötf
("œ°_pic_Êag = %d\n", 
œ°_pic_Êag
);

482 
	`¥ötf
("sub_£q_‰ame_num_Êag = %d\n", 
sub_£q_‰ame_num_Êag
);

483 i‡(
sub_£q_‰ame_num_Êag
)

485 
	`¥ötf
("sub_£q_‰ame_num = %d\n", 
sub_£q_‰ame_num
);

489 
	`‰ì
(
buf
);

490 #ifde‡
PRINT_SUBSEQUENCE_INFO


491 #unde‡
PRINT_SUBSEQUENCE_INFO


493 
	}
}

508 
	$öãΩªt_sub£quí˚_œyî_ch¨a˘îi°ics_öfo
–
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
 )

510 
Bô°ªam
* 
buf
;

511 
num_sub_œyîs
, 
accuøã_°©i°ics_Êag
, 
avîage_bô_øã
, 
avîage_‰ame_øã
;

512 
i
;

514 
buf
 = 
	`mÆloc
((
Bô°ªam
));

515 
buf
->
bô°ªam_Àngth
 = 
size
;

516 
buf
->
°ªamBuf„r
 = 
∑ylﬂd
;

517 
buf
->
‰ame_bôoff£t
 = 0;

519 
p_Dec
->
U£dBôs
 = 0;

521 
num_sub_œyîs
 = 1 + 
	`ªad_ue_v
("SEI:Çum_sub_œyîs_möus1", 
buf
, &
p_Dec
->
U£dBôs
);

523 #ifde‡
PRINT_SUBSEQUENCE_LAYER_CHAR


524 
	`¥ötf
("Sub-sequenceÜayer characteristics SEI message\n");

525 
	`¥ötf
("num_sub_œyîs_möus1 = %d\n", 
num_sub_œyîs
 - 1);

528 
i
=0; i<
num_sub_œyîs
; i++)

530 
accuøã_°©i°ics_Êag
 = 
	`ªad_u_1
–"SEI:áccuøã_°©i°ics_Êag", 
buf
, &
p_Dec
->
U£dBôs
);

531 
avîage_bô_øã
 = 
	`ªad_u_v
(16,"SEI:ávîage_bô_øã" , 
buf
, &
p_Dec
->
U£dBôs
);

532 
avîage_‰ame_øã
 = 
	`ªad_u_v
(16,"SEI:ávîage_‰ame_øã" , 
buf
, &
p_Dec
->
U£dBôs
);

534 #ifde‡
PRINT_SUBSEQUENCE_LAYER_CHAR


535 
	`¥ötf
("œyî %d:áccuøã_°©i°ics_Êag = %ld \n", 
i
, 
accuøã_°©i°ics_Êag
);

536 
	`¥ötf
("œyî %d:ávîage_bô_øã = %ld \n", 
i
, 
avîage_bô_øã
);

537 
	`¥ötf
("œyî %d:ávîage_‰ame_øã = %ld \n", 
i
, 
avîage_‰ame_øã
);

540 
	`‰ì
 (
buf
);

541 
	}
}

557 
	$öãΩªt_sub£quí˚_ch¨a˘îi°ics_öfo
–
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
 )

559 
Bô°ªam
* 
buf
;

560 
i
;

561 
sub_£q_œyî_num
, 
sub_£q_id
, 
duøti⁄_Êag
, 
avîage_øã_Êag
, 
accuøã_°©i°ics_Êag
;

562 
sub_£q_duøti⁄
, 
avîage_bô_øã
, 
avîage_‰ame_øã
;

563 
num_ª„ªn˚d_sub£qs
, 
ªf_sub_£q_œyî_num
, 
ªf_sub_£q_id
, 
ªf_sub_£q_dúe˘i⁄
;

565 
buf
 = 
	`mÆloc
((
Bô°ªam
));

566 
buf
->
bô°ªam_Àngth
 = 
size
;

567 
buf
->
°ªamBuf„r
 = 
∑ylﬂd
;

568 
buf
->
‰ame_bôoff£t
 = 0;

570 
p_Dec
->
U£dBôs
 = 0;

572 
sub_£q_œyî_num
 = 
	`ªad_ue_v
("SEI: sub_£q_œyî_num", 
buf
, &
p_Dec
->
U£dBôs
);

573 
sub_£q_id
 = 
	`ªad_ue_v
("SEI: sub_£q_id", 
buf
, &
p_Dec
->
U£dBôs
);

574 
duøti⁄_Êag
 = 
	`ªad_u_1
 ("SEI: duøti⁄_Êag", 
buf
, &
p_Dec
->
U£dBôs
);

576 #ifde‡
PRINT_SUBSEQUENCE_CHAR


577 
	`¥ötf
("Sub-sequence characteristics SEI message\n");

578 
	`¥ötf
("sub_£q_œyî_num = %d\n", 
sub_£q_œyî_num
 );

579 
	`¥ötf
("sub_£q_id = %d\n", 
sub_£q_id
);

580 
	`¥ötf
("duøti⁄_Êag = %d\n", 
duøti⁄_Êag
);

583 i‡–
duøti⁄_Êag
 )

585 
sub_£q_duøti⁄
 = 
	`ªad_u_v
 (32, "SEI: duøti⁄_Êag", 
buf
, &
p_Dec
->
U£dBôs
);

586 #ifde‡
PRINT_SUBSEQUENCE_CHAR


587 
	`¥ötf
("sub_£q_duøti⁄ = %ld\n", 
sub_£q_duøti⁄
);

591 
avîage_øã_Êag
 = 
	`ªad_u_1
 ("SEI:ávîage_øã_Êag", 
buf
, &
p_Dec
->
U£dBôs
);

593 #ifde‡
PRINT_SUBSEQUENCE_CHAR


594 
	`¥ötf
("avîage_øã_Êag = %d\n", 
avîage_øã_Êag
);

597 i‡–
avîage_øã_Êag
 )

599 
accuøã_°©i°ics_Êag
 = 
	`ªad_u_1
 ( "SEI:áccuøã_°©i°ics_Êag", 
buf
, &
p_Dec
->
U£dBôs
);

600 
avîage_bô_øã
 = 
	`ªad_u_v
 (16, "SEI:ávîage_bô_øã", 
buf
, &
p_Dec
->
U£dBôs
);

601 
avîage_‰ame_øã
 = 
	`ªad_u_v
 (16, "SEI:ávîage_‰ame_øã", 
buf
, &
p_Dec
->
U£dBôs
);

603 #ifde‡
PRINT_SUBSEQUENCE_CHAR


604 
	`¥ötf
("accuøã_°©i°ics_Êag = %d\n", 
accuøã_°©i°ics_Êag
);

605 
	`¥ötf
("avîage_bô_øã = %ld\n", 
avîage_bô_øã
);

606 
	`¥ötf
("avîage_‰ame_øã = %ld\n", 
avîage_‰ame_øã
);

610 
num_ª„ªn˚d_sub£qs
 = 
	`ªad_ue_v
("SEI:Çum_ª„ªn˚d_sub£qs", 
buf
, &
p_Dec
->
U£dBôs
);

612 #ifde‡
PRINT_SUBSEQUENCE_CHAR


613 
	`¥ötf
("num_ª„ªn˚d_sub£q†%d\n", 
num_ª„ªn˚d_sub£qs
);

616 
i
=0; i<
num_ª„ªn˚d_sub£qs
; i++)

618 
ªf_sub_£q_œyî_num
 = 
	`ªad_ue_v
("SEI:Ñef_sub_£q_œyî_num", 
buf
, &
p_Dec
->
U£dBôs
);

619 
ªf_sub_£q_id
 = 
	`ªad_ue_v
("SEI:Ñef_sub_£q_id", 
buf
, &
p_Dec
->
U£dBôs
);

620 
ªf_sub_£q_dúe˘i⁄
 = 
	`ªad_u_1
 ("SEI:Ñef_sub_£q_dúe˘i⁄", 
buf
, &
p_Dec
->
U£dBôs
);

622 #ifde‡
PRINT_SUBSEQUENCE_CHAR


623 
	`¥ötf
("ªf_sub_£q_œyî_num = %d\n", 
ªf_sub_£q_œyî_num
);

624 
	`¥ötf
("ªf_sub_£q_id = %d\n", 
ªf_sub_£q_id
);

625 
	`¥ötf
("ªf_sub_£q_dúe˘i⁄ = %d\n", 
ªf_sub_£q_dúe˘i⁄
);

629 
	`‰ì
–
buf
 );

630 #ifde‡
PRINT_SUBSEQUENCE_CHAR


631 #unde‡
PRINT_SUBSEQUENCE_CHAR


633 
	}
}

649 
	$öãΩªt_s˚√_öf‹m©i⁄
–
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
 )

651 
Bô°ªam
* 
buf
;

652 
s˚√_id
, 
s˚√_å™sôi⁄_ty≥
, 
£c⁄d_s˚√_id
;

654 
buf
 = 
	`mÆloc
((
Bô°ªam
));

655 
buf
->
bô°ªam_Àngth
 = 
size
;

656 
buf
->
°ªamBuf„r
 = 
∑ylﬂd
;

657 
buf
->
‰ame_bôoff£t
 = 0;

659 
p_Dec
->
U£dBôs
 = 0;

661 
s˚√_id
 = 
	`ªad_ue_v
("SEI: s˚√_id" , 
buf
, &
p_Dec
->
U£dBôs
);

662 
s˚√_å™sôi⁄_ty≥
 = 
	`ªad_ue_v
("SEI: s˚√_å™sôi⁄_ty≥", 
buf
, &
p_Dec
->
U£dBôs
);

663 i‡–
s˚√_å™sôi⁄_ty≥
 > 3 )

665 
£c⁄d_s˚√_id
 = 
	`ªad_ue_v
("SEI: s˚√_å™sôi⁄_ty≥", 
buf
, &
p_Dec
->
U£dBôs
);

668 #ifde‡
PRINT_SCENE_INFORMATION


669 
	`¥ötf
("Scene information SEI message\n");

670 
	`¥ötf
("s˚√_å™sôi⁄_ty≥ = %d\n", 
s˚√_å™sôi⁄_ty≥
);

671 
	`¥ötf
("s˚√_id = %d\n", 
s˚√_id
);

672 i‡–
s˚√_å™sôi⁄_ty≥
 > 3 )

674 
	`¥ötf
("£c⁄d_s˚√_id = %d\n", 
£c⁄d_s˚√_id
);

677 
	`‰ì
–
buf
 );

678 #ifde‡
PRINT_SCENE_INFORMATION


679 #unde‡
PRINT_SCENE_INFORMATION


681 
	}
}

697 
	$öãΩªt_fûÀr_∑ylﬂd_öfo
–
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
 )

699 
∑ylﬂd_˙t
 = 0;

701 
∑ylﬂd_˙t
<
size
)

703 i‡(
∑ylﬂd
[
∑ylﬂd_˙t
] == 0xFF)

705 
∑ylﬂd_˙t
++;

710 #ifde‡
PRINT_FILLER_PAYLOAD_INFO


711 
	`¥ötf
("FillerÖayload SEI message\n");

712 i‡(
∑ylﬂd_˙t
==
size
)

714 
	`¥ötf
("ªad %d byã†o‡fûÀ∏∑ylﬂd\n", 
∑ylﬂd_˙t
);

718 
	`¥ötf
("îr‹Ñódög fûÀ∏∑ylﬂd:ÇŸáŒ byã†¨ê0xFF (%d o‡%d)\n", 
∑ylﬂd_˙t
, 
size
);

722 #ifde‡
PRINT_FILLER_PAYLOAD_INFO


723 #unde‡
PRINT_FILLER_PAYLOAD_INFO


725 
	}
}

741 
	$öãΩªt_u£r_d©a_uƒegi°îed_öfo
–
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
 )

743 
off£t
 = 0;

744 
byã
 
∑ylﬂd_byã
;

746 #ifde‡
PRINT_USER_DATA_UNREGISTERED_INFO


747 
	`¥ötf
("User data unregistered SEI message\n");

748 
	`¥ötf
("uuid_iso_11578 = 0x");

750 
	`as£π
 (
size
>=16);

752 
off£t
 = 0; offset < 16; offset++)

754 #ifde‡
PRINT_USER_DATA_UNREGISTERED_INFO


755 
	`¥ötf
("%02x",
∑ylﬂd
[
off£t
]);

759 #ifde‡
PRINT_USER_DATA_UNREGISTERED_INFO


760 
	`¥ötf
("\n");

763 
off£t
 < 
size
)

765 
∑ylﬂd_byã
 = 
∑ylﬂd
[
off£t
];

766 
off£t
 ++;

767 #ifde‡
PRINT_USER_DATA_UNREGISTERED_INFO


768 
	`¥ötf
("Uƒeg d©®∑ylﬂd_byã = %d\n", 
∑ylﬂd_byã
);

771 #ifde‡
PRINT_USER_DATA_UNREGISTERED_INFO


772 #unde‡
PRINT_USER_DATA_UNREGISTERED_INFO


774 
	}
}

790 
	$öãΩªt_u£r_d©a_ªgi°îed_ôu_t_t35_öfo
–
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
 )

792 
off£t
 = 0;

793 
byã
 
ôu_t_t35_cou¡ry_code
, 
ôu_t_t35_cou¡ry_code_exãnsi⁄_byã
, 
∑ylﬂd_byã
;

795 
ôu_t_t35_cou¡ry_code
 = 
∑ylﬂd
[
off£t
];

796 
off£t
++;

797 #ifde‡
PRINT_USER_DATA_REGISTERED_ITU_T_T35_INFO


798 
	`¥ötf
("User dataÑegistered by ITU-T T.35 SEI message\n");

799 
	`¥ötf
(" itu_t_t35_cou¡ry_codê%d \n", 
ôu_t_t35_cou¡ry_code
);

801 if(
ôu_t_t35_cou¡ry_code
 == 0xFF)

803 
ôu_t_t35_cou¡ry_code_exãnsi⁄_byã
 = 
∑ylﬂd
[
off£t
];

804 
off£t
++;

805 #ifde‡
PRINT_USER_DATA_REGISTERED_ITU_T_T35_INFO


806 
	`¥ötf
(" ITU_T_T35_COUNTRY_CODE_EXTENSION_BYTE %d \n", 
ôu_t_t35_cou¡ry_code_exãnsi⁄_byã
);

809 
off£t
 < 
size
)

811 
∑ylﬂd_byã
 = 
∑ylﬂd
[
off£t
];

812 
off£t
 ++;

813 #ifde‡
PRINT_USER_DATA_REGISTERED_ITU_T_T35_INFO


814 
	`¥ötf
("ôu_t_t35Öaylﬂd_byã = %d\n", 
∑ylﬂd_byã
);

817 #ifde‡
PRINT_USER_DATA_REGISTERED_ITU_T_T35_INFO


818 #unde‡
PRINT_USER_DATA_REGISTERED_ITU_T_T35_INFO


820 
	}
}

836 
	$öãΩªt_∑n_sˇn_ª˘_öfo
–
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
 )

838 
∑n_sˇn_ª˘_ˇn˚l_Êag
;

839 
∑n_sˇn_˙t_möus1
, 
i
;

840 
∑n_sˇn_ª˘_ª≥tôi⁄_≥riod
;

841 
∑n_sˇn_ª˘_id
, 
∑n_sˇn_ª˘_À·_off£t
, 
∑n_sˇn_ª˘_right_off£t
;

842 
∑n_sˇn_ª˘_t›_off£t
, 
∑n_sˇn_ª˘_bŸtom_off£t
;

844 
Bô°ªam
* 
buf
;

846 
buf
 = 
	`mÆloc
((
Bô°ªam
));

847 
buf
->
bô°ªam_Àngth
 = 
size
;

848 
buf
->
°ªamBuf„r
 = 
∑ylﬂd
;

849 
buf
->
‰ame_bôoff£t
 = 0;

851 
p_Dec
->
U£dBôs
 = 0;

853 
∑n_sˇn_ª˘_id
 = 
	`ªad_ue_v
("SEI:Ö™_sˇn_ª˘_id", 
buf
, &
p_Dec
->
U£dBôs
);

855 
∑n_sˇn_ª˘_ˇn˚l_Êag
 = 
	`ªad_u_1
("SEI:Ö™_sˇn_ª˘_ˇn˚l_Êag", 
buf
, &
p_Dec
->
U£dBôs
);

856 i‡(!
∑n_sˇn_ª˘_ˇn˚l_Êag
)

858 
∑n_sˇn_˙t_möus1
 = 
	`ªad_ue_v
("SEI:Ö™_sˇn_˙t_möus1", 
buf
, &
p_Dec
->
U£dBôs
);

859 
i
 = 0; i <
∑n_sˇn_˙t_möus1
; i++)

861 
∑n_sˇn_ª˘_À·_off£t
 = 
	`ªad_£_v
("SEI:Ö™_sˇn_ª˘_À·_off£t" , 
buf
, &
p_Dec
->
U£dBôs
);

862 
∑n_sˇn_ª˘_right_off£t
 = 
	`ªad_£_v
("SEI:Ö™_sˇn_ª˘_right_off£t" , 
buf
, &
p_Dec
->
U£dBôs
);

863 
∑n_sˇn_ª˘_t›_off£t
 = 
	`ªad_£_v
("SEI:Ö™_sˇn_ª˘_t›_off£t" , 
buf
, &
p_Dec
->
U£dBôs
);

864 
∑n_sˇn_ª˘_bŸtom_off£t
 = 
	`ªad_£_v
("SEI:Ö™_sˇn_ª˘_bŸtom_off£t", 
buf
, &
p_Dec
->
U£dBôs
);

865 #ifde‡
PRINT_PAN_SCAN_RECT


866 
	`¥ötf
("P™ sˇ¿ª˘™gÀ SEI mesßgê%d/%d\n", 
i
, 
∑n_sˇn_˙t_möus1
);

867 
	`¥ötf
("∑n_sˇn_ª˘_id = %d\n", 
∑n_sˇn_ª˘_id
);

868 
	`¥ötf
("∑n_sˇn_ª˘_À·_off£à = %d\n", 
∑n_sˇn_ª˘_À·_off£t
);

869 
	`¥ötf
("∑n_sˇn_ª˘_right_off£à = %d\n", 
∑n_sˇn_ª˘_right_off£t
);

870 
	`¥ötf
("∑n_sˇn_ª˘_t›_off£à = %d\n", 
∑n_sˇn_ª˘_t›_off£t
);

871 
	`¥ötf
("∑n_sˇn_ª˘_bŸtom_off£à%d\n", 
∑n_sˇn_ª˘_bŸtom_off£t
);

874 
∑n_sˇn_ª˘_ª≥tôi⁄_≥riod
 = 
	`ªad_ue_v
("SEI:Ö™_sˇn_ª˘_ª≥tôi⁄_≥riod", 
buf
, &
p_Dec
->
U£dBôs
);

877 
	`‰ì
 (
buf
);

878 #ifde‡
PRINT_PAN_SCAN_RECT


879 #unde‡
PRINT_PAN_SCAN_RECT


881 
	}
}

897 
	$öãΩªt_ªcovîy_poöt_öfo
–
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
 )

899 
ªcovîy_‰ame_˙t
, 
exa˘_m©ch_Êag
, 
brokí_lök_Êag
, 
ch™gög_¶i˚_group_idc
;

902 
Bô°ªam
* 
buf
;

905 
buf
 = 
	`mÆloc
((
Bô°ªam
));

906 
buf
->
bô°ªam_Àngth
 = 
size
;

907 
buf
->
°ªamBuf„r
 = 
∑ylﬂd
;

908 
buf
->
‰ame_bôoff£t
 = 0;

910 
p_Dec
->
U£dBôs
 = 0;

912 
ªcovîy_‰ame_˙t
 = 
	`ªad_ue_v
–"SEI:Ñecovîy_‰ame_˙t" , 
buf
, &
p_Dec
->
U£dBôs
);

913 
exa˘_m©ch_Êag
 = 
	`ªad_u_1
 ( "SEI:Éxa˘_m©ch_Êag" , 
buf
, &
p_Dec
->
U£dBôs
);

914 
brokí_lök_Êag
 = 
	`ªad_u_1
 ( "SEI: brokí_lök_Êag" , 
buf
, &
p_Dec
->
U£dBôs
);

915 
ch™gög_¶i˚_group_idc
 = 
	`ªad_u_v
 ( 2, "SEI: ch™gög_¶i˚_group_idc", 
buf
, &
p_Dec
->
U£dBôs
);

917 
p_Vid
->
ªcovîy_poöt
 = 1;

918 
p_Vid
->
ªcovîy_‰ame_˙t
 =Ñecovery_frame_cnt;

920 #ifde‡
PRINT_RECOVERY_POINT


921 
	`¥ötf
("RecoveryÖoint SEI message\n");

922 
	`¥ötf
("ªcovîy_‰ame_˙à = %d\n", 
ªcovîy_‰ame_˙t
);

923 
	`¥ötf
("exa˘_m©ch_Êag = %d\n", 
exa˘_m©ch_Êag
);

924 
	`¥ötf
("brokí_lök_Êag = %d\n", 
brokí_lök_Êag
);

925 
	`¥ötf
("ch™gög_¶i˚_group_id¯%d\n", 
ch™gög_¶i˚_group_idc
);

927 
	`‰ì
 (
buf
);

928 #ifde‡
PRINT_RECOVERY_POINT


929 #unde‡
PRINT_RECOVERY_POINT


931 
	}
}

947 
	$öãΩªt_dec_ªf_pic_m¨kög_ª≥tôi⁄_öfo
–
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
, 
Sli˚
 *
pSli˚
 )

949 
‹igöÆ_idr_Êag
, 
‹igöÆ_‰ame_num
;

950 
‹igöÆ_fõld_pic_Êag
, 
‹igöÆ_bŸtom_fõld_Êag
;

952 
DecRefPicM¨kög_t
 *
tmp_dΩm
;

953 
DecRefPicM¨kög_t
 *
ﬁd_dΩm
;

954 
ﬁd_idr_Êag
, 
ﬁd_no_ouçut_of_¥i‹_pics_Êag
, 
ﬁd_l⁄g_ãrm_ª„ªn˚_Êag
 , 
ﬁd_ad≠tive_ªf_pic_buf„rög_Êag
;

956 
Bô°ªam
* 
buf
;

958 
buf
 = 
	`mÆloc
((
Bô°ªam
));

959 
buf
->
bô°ªam_Àngth
 = 
size
;

960 
buf
->
°ªamBuf„r
 = 
∑ylﬂd
;

961 
buf
->
‰ame_bôoff£t
 = 0;

963 
p_Dec
->
U£dBôs
 = 0;

965 
‹igöÆ_idr_Êag
 = 
	`ªad_u_1
 ( "SEI: origöÆ_idr_Êag" , 
buf
, &
p_Dec
->
U£dBôs
);

966 
‹igöÆ_‰ame_num
 = 
	`ªad_ue_v
–"SEI: origöÆ_‰ame_num" , 
buf
, &
p_Dec
->
U£dBôs
);

968 i‡–!
p_Vid
->
a˘ive_•s
->
‰ame_mbs_⁄ly_Êag
 )

970 
‹igöÆ_fõld_pic_Êag
 = 
	`ªad_u_1
 ( "SEI: origöÆ_fõld_pic_Êag", 
buf
, &
p_Dec
->
U£dBôs
);

971 i‡–
‹igöÆ_fõld_pic_Êag
 )

973 
‹igöÆ_bŸtom_fõld_Êag
 = 
	`ªad_u_1
 ( "SEI: origöÆ_bŸtom_fõld_Êag", 
buf
, &
p_Dec
->
U£dBôs
);

977 #ifde‡
PRINT_DEC_REF_PIC_MARKING


978 
	`¥ötf
("Decoded Picture Buffer Management Repetition SEI message\n");

979 
	`¥ötf
("‹igöÆ_idr_Êag = %d\n", 
‹igöÆ_idr_Êag
);

980 
	`¥ötf
("‹igöÆ_‰ame_num = %d\n", 
‹igöÆ_‰ame_num
);

981 i‡–
a˘ive_•s
->
‰ame_mbs_⁄ly_Êag
 )

983 
	`¥ötf
("‹igöÆ_fõld_pic_Êag = %d\n", 
‹igöÆ_fõld_pic_Êag
);

984 i‡–
‹igöÆ_fõld_pic_Êag
 )

986 
	`¥ötf
("‹igöÆ_bŸtom_fõld_Êag = %d\n", 
‹igöÆ_bŸtom_fõld_Êag
);

992 
ﬁd_dΩm
 = 
pSli˚
->
dec_ªf_pic_m¨kög_buf„r
;

993 
ﬁd_idr_Êag
 = 
pSli˚
->
idr_Êag
;

995 
ﬁd_no_ouçut_of_¥i‹_pics_Êag
 = 
pSli˚
->
no_ouçut_of_¥i‹_pics_Êag
;

996 
ﬁd_l⁄g_ãrm_ª„ªn˚_Êag
 = 
pSli˚
->
l⁄g_ãrm_ª„ªn˚_Êag
;

997 
ﬁd_ad≠tive_ªf_pic_buf„rög_Êag
 = 
pSli˚
->
ad≠tive_ªf_pic_buf„rög_Êag
;

1001 
pSli˚
->
idr_Êag
 = 
‹igöÆ_idr_Êag
;

1002 
pSli˚
->
dec_ªf_pic_m¨kög_buf„r
 = 
NULL
;

1004 
	`dec_ªf_pic_m¨kög
(
p_Vid
, 
buf
, 
pSli˚
);

1007 #ifde‡
PRINT_DEC_REF_PIC_MARKING


1008 i‡(
p_Vid
->
idr_Êag
)

1010 
	`¥ötf
("no_ouçut_of_¥i‹_pics_Êag = %d\n", 
p_Vid
->
no_ouçut_of_¥i‹_pics_Êag
);

1011 
	`¥ötf
("l⁄g_ãrm_ª„ªn˚_Êag = %d\n", 
p_Vid
->
l⁄g_ãrm_ª„ªn˚_Êag
);

1015 
	`¥ötf
("ad≠tive_ªf_pic_buf„rög_Êag = %d\n", 
p_Vid
->
ad≠tive_ªf_pic_buf„rög_Êag
);

1016 i‡(
p_Vid
->
ad≠tive_ªf_pic_buf„rög_Êag
)

1018 
tmp_dΩm
=
p_Vid
->
dec_ªf_pic_m¨kög_buf„r
;

1019 
tmp_dΩm
 !
NULL
)

1021 
	`¥ötf
("mem‹y_m™agemít_c⁄åﬁ_›î©i⁄ = %d\n", 
tmp_dΩm
->
mem‹y_m™agemít_c⁄åﬁ_›î©i⁄
);

1023 i‡((
tmp_dΩm
->
mem‹y_m™agemít_c⁄åﬁ_›î©i⁄
==1)||(tmp_drpm->memory_management_control_operation==3))

1025 
	`¥ötf
("dif„ªn˚_of_pic_nums_möus1 = %d\n", 
tmp_dΩm
->
dif„ªn˚_of_pic_nums_möus1
);

1027 i‡(
tmp_dΩm
->
mem‹y_m™agemít_c⁄åﬁ_›î©i⁄
==2)

1029 
	`¥ötf
("l⁄g_ãrm_pic_num = %d\n", 
tmp_dΩm
->
l⁄g_ãrm_pic_num
);

1031 i‡((
tmp_dΩm
->
mem‹y_m™agemít_c⁄åﬁ_›î©i⁄
==3)||(tmp_drpm->memory_management_control_operation==6))

1033 
	`¥ötf
("l⁄g_ãrm_‰ame_idx = %d\n", 
tmp_dΩm
->
l⁄g_ãrm_‰ame_idx
);

1035 i‡(
tmp_dΩm
->
mem‹y_m™agemít_c⁄åﬁ_›î©i⁄
==4)

1037 
	`¥ötf
("max_l⁄g_ãrm_pic_idx_∂us1 = %d\n", 
tmp_dΩm
->
max_l⁄g_ãrm_‰ame_idx_∂us1
);

1039 
tmp_dΩm
 =Åmp_dΩm->
Next
;

1045 
pSli˚
->
dec_ªf_pic_m¨kög_buf„r
)

1047 
tmp_dΩm
=
pSli˚
->
dec_ªf_pic_m¨kög_buf„r
;

1049 
pSli˚
->
dec_ªf_pic_m¨kög_buf„r
=
tmp_dΩm
->
Next
;

1050 
	`‰ì
 (
tmp_dΩm
);

1054 
pSli˚
->
dec_ªf_pic_m¨kög_buf„r
 = 
ﬁd_dΩm
;

1055 
pSli˚
->
idr_Êag
 = 
ﬁd_idr_Êag
;

1056 
pSli˚
->
no_ouçut_of_¥i‹_pics_Êag
 = 
ﬁd_no_ouçut_of_¥i‹_pics_Êag
;

1057 
p_Vid
->
no_ouçut_of_¥i‹_pics_Êag
 = 
pSli˚
->no_output_of_prior_pics_flag;

1058 
pSli˚
->
l⁄g_ãrm_ª„ªn˚_Êag
 = 
ﬁd_l⁄g_ãrm_ª„ªn˚_Êag
;

1059 
pSli˚
->
ad≠tive_ªf_pic_buf„rög_Êag
 = 
ﬁd_ad≠tive_ªf_pic_buf„rög_Êag
;

1061 
	`‰ì
 (
buf
);

1062 #ifde‡
PRINT_DEC_REF_PIC_MARKING


1063 #unde‡
PRINT_DEC_REF_PIC_MARKING


1065 
	}
}

1080 
	$öãΩªt_fuŒ_‰ame_‰ìze_öfo
–
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
 )

1082 
fuŒ_‰ame_‰ìze_ª≥tôi⁄_≥riod
;

1083 
Bô°ªam
* 
buf
;

1085 
buf
 = 
	`mÆloc
((
Bô°ªam
));

1086 
buf
->
bô°ªam_Àngth
 = 
size
;

1087 
buf
->
°ªamBuf„r
 = 
∑ylﬂd
;

1088 
buf
->
‰ame_bôoff£t
 = 0;

1090 
fuŒ_‰ame_‰ìze_ª≥tôi⁄_≥riod
 = 
	`ªad_ue_v
–"SEI: fuŒ_‰ame_‰ìze_ª≥tôi⁄_≥riod" , 
buf
, &
p_Dec
->
U£dBôs
);

1092 #ifde‡
PRINT_FULL_FRAME_FREEZE_INFO


1093 
	`¥ötf
("fuŒ_‰ame_‰ìze_ª≥tôi⁄_≥riod = %d\n", 
fuŒ_‰ame_‰ìze_ª≥tôi⁄_≥riod
);

1096 
	`‰ì
 (
buf
);

1097 #ifde‡
PRINT_FULL_FRAME_FREEZE_INFO


1098 #unde‡
PRINT_FULL_FRAME_FREEZE_INFO


1100 
	}
}

1116 
	$öãΩªt_fuŒ_‰ame_‰ìze_ªÀa£_öfo
–
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
 )

1118 #ifde‡
PRINT_FULL_FRAME_FREEZE_RELEASE_INFO


1119 
	`¥ötf
("Full-frame freezeÑelease SEI message\n");

1120 i‡(
size
)

1122 
	`¥ötf
("∑ylﬂd sizêo‡thi†mesßgêshould bêzîo, buài†%d byãs.\n", 
size
);

1126 #ifde‡
PRINT_FULL_FRAME_FREEZE_RELEASE_INFO


1127 #unde‡
PRINT_FULL_FRAME_FREEZE_RELEASE_INFO


1129 
	}
}

1144 
	$öãΩªt_fuŒ_‰ame_¢≠shŸ_öfo
–
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
 )

1146 
¢≠shŸ_id
;

1148 
Bô°ªam
* 
buf
;

1150 
buf
 = 
	`mÆloc
((
Bô°ªam
));

1151 
buf
->
bô°ªam_Àngth
 = 
size
;

1152 
buf
->
°ªamBuf„r
 = 
∑ylﬂd
;

1153 
buf
->
‰ame_bôoff£t
 = 0;

1155 
p_Dec
->
U£dBôs
 = 0;

1157 
¢≠shŸ_id
 = 
	`ªad_ue_v
("SEI: s«pshŸ_id", 
buf
, &
p_Dec
->
U£dBôs
);

1159 #ifde‡
PRINT_FULL_FRAME_SNAPSHOT_INFO


1160 
	`¥ötf
("Full-frame snapshot SEI message\n");

1161 
	`¥ötf
("¢≠shŸ_id = %d\n", 
¢≠shŸ_id
);

1163 
	`‰ì
 (
buf
);

1164 #ifde‡
PRINT_FULL_FRAME_SNAPSHOT_INFO


1165 #unde‡
PRINT_FULL_FRAME_SNAPSHOT_INFO


1167 
	}
}

1182 
	$öãΩªt_¥ogªssive_ªföemít_°¨t_öfo
–
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
 )

1184 
¥ogªssive_ªföemít_id
, 
num_ªföemít_°ïs_möus1
;

1186 
Bô°ªam
* 
buf
;

1188 
buf
 = 
	`mÆloc
((
Bô°ªam
));

1189 
buf
->
bô°ªam_Àngth
 = 
size
;

1190 
buf
->
°ªamBuf„r
 = 
∑ylﬂd
;

1191 
buf
->
‰ame_bôoff£t
 = 0;

1193 
p_Dec
->
U£dBôs
 = 0;

1195 
¥ogªssive_ªföemít_id
 = 
	`ªad_ue_v
("SEI:Örogªssive_ªföemít_id" , 
buf
, &
p_Dec
->
U£dBôs
);

1196 
num_ªföemít_°ïs_möus1
 = 
	`ªad_ue_v
("SEI:Çum_ªföemít_°ïs_möus1", 
buf
, &
p_Dec
->
U£dBôs
);

1198 #ifde‡
PRINT_PROGRESSIVE_REFINEMENT_START_INFO


1199 
	`¥ötf
("ProgressiveÑefinement segment start SEI message\n");

1200 
	`¥ötf
("¥ogªssive_ªföemít_id = %d\n", 
¥ogªssive_ªföemít_id
);

1201 
	`¥ötf
("num_ªföemít_°ïs_möus1 = %d\n", 
num_ªföemít_°ïs_möus1
);

1203 
	`‰ì
 (
buf
);

1204 #ifde‡
PRINT_PROGRESSIVE_REFINEMENT_START_INFO


1205 #unde‡
PRINT_PROGRESSIVE_REFINEMENT_START_INFO


1207 
	}
}

1223 
	$öãΩªt_¥ogªssive_ªföemít_íd_öfo
–
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
 )

1225 
¥ogªssive_ªföemít_id
;

1227 
Bô°ªam
* 
buf
;

1229 
buf
 = 
	`mÆloc
((
Bô°ªam
));

1230 
buf
->
bô°ªam_Àngth
 = 
size
;

1231 
buf
->
°ªamBuf„r
 = 
∑ylﬂd
;

1232 
buf
->
‰ame_bôoff£t
 = 0;

1234 
p_Dec
->
U£dBôs
 = 0;

1236 
¥ogªssive_ªföemít_id
 = 
	`ªad_ue_v
("SEI:Örogªssive_ªföemít_id" , 
buf
, &
p_Dec
->
U£dBôs
);

1238 #ifde‡
PRINT_PROGRESSIVE_REFINEMENT_END_INFO


1239 
	`¥ötf
("ProgressiveÑefinement segmentÉnd SEI message\n");

1240 
	`¥ötf
("¥ogªssive_ªföemít_id = %d\n", 
¥ogªssive_ªföemít_id
);

1242 
	`‰ì
 (
buf
);

1243 #ifde‡
PRINT_PROGRESSIVE_REFINEMENT_END_INFO


1244 #unde‡
PRINT_PROGRESSIVE_REFINEMENT_END_INFO


1246 
	}
}

1262 
	$öãΩªt_mŸi⁄_c⁄°øöed_¶i˚_group_£t_öfo
–
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
 )

1264 
num_¶i˚_groups_möus1
, 
¶i˚_group_id
, 
exa˘_m©ch_Êag
, 
∑n_sˇn_ª˘_Êag
, 
∑n_sˇn_ª˘_id
;

1265 
i
;

1266 
¶i˚GroupSize
;

1268 
Bô°ªam
* 
buf
;

1270 
buf
 = 
	`mÆloc
((
Bô°ªam
));

1271 
buf
->
bô°ªam_Àngth
 = 
size
;

1272 
buf
->
°ªamBuf„r
 = 
∑ylﬂd
;

1273 
buf
->
‰ame_bôoff£t
 = 0;

1275 
p_Dec
->
U£dBôs
 = 0;

1277 
num_¶i˚_groups_möus1
 = 
	`ªad_ue_v
("SEI:Çum_¶i˚_groups_möus1" , 
buf
, &
p_Dec
->
U£dBôs
);

1278 
¶i˚GroupSize
 = 
	`CeûLog2
–
num_¶i˚_groups_möus1
 + 1 );

1279 #ifde‡
PRINT_MOTION_CONST_SLICE_GROUP_SET_INFO


1280 
	`¥ötf
("Motion-constrained slice group set SEI message\n");

1281 
	`¥ötf
("num_¶i˚_groups_möus1 = %d\n", 
num_¶i˚_groups_möus1
);

1284 
i
=0; i<=
num_¶i˚_groups_möus1
;i++)

1287 
¶i˚_group_id
 = 
	`ªad_u_v
 (
¶i˚GroupSize
, "SEI: sli˚_group_id" , 
buf
, &
p_Dec
->
U£dBôs
);

1288 #ifde‡
PRINT_MOTION_CONST_SLICE_GROUP_SET_INFO


1289 
	`¥ötf
("¶i˚_group_id = %d\n", 
¶i˚_group_id
);

1293 
exa˘_m©ch_Êag
 = 
	`ªad_u_1
("SEI:Éxa˘_m©ch_Êag" , 
buf
, &
p_Dec
->
U£dBôs
);

1294 
∑n_sˇn_ª˘_Êag
 = 
	`ªad_u_1
("SEI:Ö™_sˇn_ª˘_Êag" , 
buf
, &
p_Dec
->
U£dBôs
);

1296 #ifde‡
PRINT_MOTION_CONST_SLICE_GROUP_SET_INFO


1297 
	`¥ötf
("exa˘_m©ch_Êag = %d\n", 
exa˘_m©ch_Êag
);

1298 
	`¥ötf
("∑n_sˇn_ª˘_Êag = %d\n", 
∑n_sˇn_ª˘_Êag
);

1301 i‡(
∑n_sˇn_ª˘_Êag
)

1303 
∑n_sˇn_ª˘_id
 = 
	`ªad_ue_v
("SEI:Ö™_sˇn_ª˘_id" , 
buf
, &
p_Dec
->
U£dBôs
);

1304 #ifde‡
PRINT_MOTION_CONST_SLICE_GROUP_SET_INFO


1305 
	`¥ötf
("∑n_sˇn_ª˘_id = %d\n", 
∑n_sˇn_ª˘_id
);

1309 
	`‰ì
 (
buf
);

1310 #ifde‡
PRINT_MOTION_CONST_SLICE_GROUP_SET_INFO


1311 #unde‡
PRINT_MOTION_CONST_SLICE_GROUP_SET_INFO


1313 
	}
}

1328 
	$öãΩªt_fûm_gøö_ch¨a˘îi°ics_öfo
–
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
 )

1330 
fûm_gøö_ch¨a˘îi°ics_ˇn˚l_Êag
;

1331 
modñ_id
, 
£∑øã_cﬁour_des¸ùti⁄_¥e£¡_Êag
;

1332 
fûm_gøö_bô_dïth_luma_möus8
, 
fûm_gøö_bô_dïth_chroma_möus8
, 
fûm_gøö_fuŒ_ønge_Êag
, 
fûm_gøö_cﬁour_¥im¨õs
, 
fûm_gøö_å™s„r_ch¨a˘îi°ics
, 
fûm_gøö_m©rix_c€fficõ¡s
;

1333 
bÀndög_mode_id
, 
log2_sˇÀ_Á˘‹
, 
comp_modñ_¥e£¡_Êag
[3];

1334 
num_öãnsôy_öãrvÆs_möus1
, 
num_modñ_vÆues_möus1
;

1335 
öãnsôy_öãrvÆ_lowî_bound
, 
öãnsôy_öãrvÆ_uµî_bound
;

1336 
comp_modñ_vÆue
;

1337 
fûm_gøö_ch¨a˘îi°ics_ª≥tôi⁄_≥riod
;

1339 
c
, 
i
, 
j
;

1341 
Bô°ªam
* 
buf
;

1343 
buf
 = 
	`mÆloc
((
Bô°ªam
));

1344 
buf
->
bô°ªam_Àngth
 = 
size
;

1345 
buf
->
°ªamBuf„r
 = 
∑ylﬂd
;

1346 
buf
->
‰ame_bôoff£t
 = 0;

1348 
fûm_gøö_ch¨a˘îi°ics_ˇn˚l_Êag
 = 
	`ªad_u_1
("SEI: fûm_gøö_ch¨a˘îi°ics_ˇn˚l_Êag", 
buf
, &
p_Dec
->
U£dBôs
);

1349 #ifde‡
PRINT_FILM_GRAIN_CHARACTERISTICS_INFO


1350 
	`¥ötf
("fûm_gøö_ch¨a˘îi°ics_ˇn˚l_Êag = %d\n", 
fûm_gøö_ch¨a˘îi°ics_ˇn˚l_Êag
);

1352 if(!
fûm_gøö_ch¨a˘îi°ics_ˇn˚l_Êag
)

1355 
modñ_id
 = 
	`ªad_u_v
(2, "SEI: modñ_id", 
buf
, &
p_Dec
->
U£dBôs
);

1356 
£∑øã_cﬁour_des¸ùti⁄_¥e£¡_Êag
 = 
	`ªad_u_1
("SEI: sï¨©e_cﬁour_des¸ùti⁄_¥e£¡_Êag", 
buf
, &
p_Dec
->
U£dBôs
);

1357 #ifde‡
PRINT_FILM_GRAIN_CHARACTERISTICS_INFO


1358 
	`¥ötf
("modñ_id = %d\n", 
modñ_id
);

1359 
	`¥ötf
("£∑øã_cﬁour_des¸ùti⁄_¥e£¡_Êag = %d\n", 
£∑øã_cﬁour_des¸ùti⁄_¥e£¡_Êag
);

1361 i‡(
£∑øã_cﬁour_des¸ùti⁄_¥e£¡_Êag
)

1363 
fûm_gøö_bô_dïth_luma_möus8
 = 
	`ªad_u_v
(3, "SEI: fûm_gøö_bô_dïth_luma_möus8", 
buf
, &
p_Dec
->
U£dBôs
);

1364 
fûm_gøö_bô_dïth_chroma_möus8
 = 
	`ªad_u_v
(3, "SEI: fûm_gøö_bô_dïth_chroma_möus8", 
buf
, &
p_Dec
->
U£dBôs
);

1365 
fûm_gøö_fuŒ_ønge_Êag
 = 
	`ªad_u_v
(1, "SEI: fûm_gøö_fuŒ_ønge_Êag", 
buf
, &
p_Dec
->
U£dBôs
);

1366 
fûm_gøö_cﬁour_¥im¨õs
 = 
	`ªad_u_v
(8, "SEI: fûm_gøö_cﬁour_¥im¨õs", 
buf
, &
p_Dec
->
U£dBôs
);

1367 
fûm_gøö_å™s„r_ch¨a˘îi°ics
 = 
	`ªad_u_v
(8, "SEI: fûm_gøö_å™s„r_ch¨a˘îi°ics", 
buf
, &
p_Dec
->
U£dBôs
);

1368 
fûm_gøö_m©rix_c€fficõ¡s
 = 
	`ªad_u_v
(8, "SEI: fûm_gøö_m©rix_c€fficõ¡s", 
buf
, &
p_Dec
->
U£dBôs
);

1369 #ifde‡
PRINT_FILM_GRAIN_CHARACTERISTICS_INFO


1370 
	`¥ötf
("fûm_gøö_bô_dïth_luma_möus8 = %d\n", 
fûm_gøö_bô_dïth_luma_möus8
);

1371 
	`¥ötf
("fûm_gøö_bô_dïth_chroma_möus8 = %d\n", 
fûm_gøö_bô_dïth_chroma_möus8
);

1372 
	`¥ötf
("fûm_gøö_fuŒ_ønge_Êag = %d\n", 
fûm_gøö_fuŒ_ønge_Êag
);

1373 
	`¥ötf
("fûm_gøö_cﬁour_¥im¨õ†%d\n", 
fûm_gøö_cﬁour_¥im¨õs
);

1374 
	`¥ötf
("fûm_gøö_å™s„r_ch¨a˘îi°ic†%d\n", 
fûm_gøö_å™s„r_ch¨a˘îi°ics
);

1375 
	`¥ötf
("fûm_gøö_m©rix_c€fficõ¡†%d\n", 
fûm_gøö_m©rix_c€fficõ¡s
);

1378 
bÀndög_mode_id
 = 
	`ªad_u_v
(2, "SEI: bÀndög_mode_id", 
buf
, &
p_Dec
->
U£dBôs
);

1379 
log2_sˇÀ_Á˘‹
 = 
	`ªad_u_v
(4, "SEI:Üog2_sˇÀ_Á˘‹", 
buf
, &
p_Dec
->
U£dBôs
);

1380 #ifde‡
PRINT_FILM_GRAIN_CHARACTERISTICS_INFO


1381 
	`¥ötf
("bÀndög_mode_id = %d\n", 
bÀndög_mode_id
);

1382 
	`¥ötf
("log2_sˇÀ_Á˘‹ = %d\n", 
log2_sˇÀ_Á˘‹
);

1384 
c
 = 0; c < 3; c ++)

1386 
comp_modñ_¥e£¡_Êag
[
c
] = 
	`ªad_u_1
("SEI: comp_modñ_¥e£¡_Êag", 
buf
, &
p_Dec
->
U£dBôs
);

1387 #ifde‡
PRINT_FILM_GRAIN_CHARACTERISTICS_INFO


1388 
	`¥ötf
("comp_modñ_¥e£¡_Êag = %d\n", 
comp_modñ_¥e£¡_Êag
[
c
]);

1391 
c
 = 0; c < 3; c ++)

1392 i‡(
comp_modñ_¥e£¡_Êag
[
c
])

1394 
num_öãnsôy_öãrvÆs_möus1
 = 
	`ªad_u_v
(8, "SEI:Çum_öãnsôy_öãrvÆs_möus1", 
buf
, &
p_Dec
->
U£dBôs
);

1395 
num_modñ_vÆues_möus1
 = 
	`ªad_u_v
(3, "SEI:Çum_modñ_vÆues_möus1", 
buf
, &
p_Dec
->
U£dBôs
);

1396 #ifde‡
PRINT_FILM_GRAIN_CHARACTERISTICS_INFO


1397 
	`¥ötf
("num_öãnsôy_öãrvÆs_möus1 = %d\n", 
num_öãnsôy_öãrvÆs_möus1
);

1398 
	`¥ötf
("num_modñ_vÆues_möus1 = %d\n", 
num_modñ_vÆues_möus1
);

1400 
i
 = 0; i <
num_öãnsôy_öãrvÆs_möus1
; i ++)

1402 
öãnsôy_öãrvÆ_lowî_bound
 = 
	`ªad_u_v
(8, "SEI: i¡ísôy_öãrvÆ_lowî_bound", 
buf
, &
p_Dec
->
U£dBôs
);

1403 
öãnsôy_öãrvÆ_uµî_bound
 = 
	`ªad_u_v
(8, "SEI: i¡ísôy_öãrvÆ_uµî_bound", 
buf
, &
p_Dec
->
U£dBôs
);

1404 #ifde‡
PRINT_FILM_GRAIN_CHARACTERISTICS_INFO


1405 
	`¥ötf
("öãnsôy_öãrvÆ_lowî_bound = %d\n", 
öãnsôy_öãrvÆ_lowî_bound
);

1406 
	`¥ötf
("öãnsôy_öãrvÆ_uµî_bound = %d\n", 
öãnsôy_öãrvÆ_uµî_bound
);

1408 
j
 = 0; j <
num_modñ_vÆues_möus1
; j++)

1410 
comp_modñ_vÆue
 = 
	`ªad_£_v
("SEI: comp_modñ_vÆue", 
buf
, &
p_Dec
->
U£dBôs
);

1411 #ifde‡
PRINT_FILM_GRAIN_CHARACTERISTICS_INFO


1412 
	`¥ötf
("comp_modñ_vÆuê%d\n", 
comp_modñ_vÆue
);

1417 
fûm_gøö_ch¨a˘îi°ics_ª≥tôi⁄_≥riod
 = 
	`ªad_ue_v
("SEI: fûm_gøö_ch¨a˘îi°ics_ª≥tôi⁄_≥riod", 
buf
, &
p_Dec
->
U£dBôs
);

1418 #ifde‡
PRINT_FILM_GRAIN_CHARACTERISTICS_INFO


1419 
	`¥ötf
("fûm_gøö_ch¨a˘îi°ics_ª≥tôi⁄_≥riod = %d\n", 
fûm_gøö_ch¨a˘îi°ics_ª≥tôi⁄_≥riod
);

1423 
	`‰ì
 (
buf
);

1424 #ifde‡
PRINT_FILM_GRAIN_CHARACTERISTICS_INFO


1425 #unde‡
PRINT_FILM_GRAIN_CHARACTERISTICS_INFO


1427 
	}
}

1442 
	$öãΩªt_deblockög_fûãr_di•œy_¥e„ªn˚_öfo
–
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
 )

1444 
deblockög_di•œy_¥e„ªn˚_ˇn˚l_Êag
;

1445 
di•œy_¥i‹_to_deblockög_¥e„ºed_Êag
, 
dec_‰ame_buf„rög_c⁄°øöt_Êag
, 
deblockög_di•œy_¥e„ªn˚_ª≥tôi⁄_≥riod
;

1447 
Bô°ªam
* 
buf
;

1449 
buf
 = 
	`mÆloc
((
Bô°ªam
));

1450 
buf
->
bô°ªam_Àngth
 = 
size
;

1451 
buf
->
°ªamBuf„r
 = 
∑ylﬂd
;

1452 
buf
->
‰ame_bôoff£t
 = 0;

1454 
deblockög_di•œy_¥e„ªn˚_ˇn˚l_Êag
 = 
	`ªad_u_1
("SEI: deblockög_di•œy_¥e„ªn˚_ˇn˚l_Êag", 
buf
, &
p_Dec
->
U£dBôs
);

1455 #ifde‡
PRINT_DEBLOCKING_FILTER_DISPLAY_PREFERENCE_INFO


1456 
	`¥ötf
("deblockög_di•œy_¥e„ªn˚_ˇn˚l_Êag = %d\n", 
deblockög_di•œy_¥e„ªn˚_ˇn˚l_Êag
);

1458 if(!
deblockög_di•œy_¥e„ªn˚_ˇn˚l_Êag
)

1460 
di•œy_¥i‹_to_deblockög_¥e„ºed_Êag
 = 
	`ªad_u_1
("SEI: di•œy_¥i‹_to_deblockög_¥e„ºed_Êag", 
buf
, &
p_Dec
->
U£dBôs
);

1461 
dec_‰ame_buf„rög_c⁄°øöt_Êag
 = 
	`ªad_u_1
("SEI: dec_‰ame_buf„rög_c⁄°øöt_Êag", 
buf
, &
p_Dec
->
U£dBôs
);

1462 
deblockög_di•œy_¥e„ªn˚_ª≥tôi⁄_≥riod
 = 
	`ªad_ue_v
("SEI: deblockög_di•œy_¥e„ªn˚_ª≥tôi⁄_≥riod", 
buf
, &
p_Dec
->
U£dBôs
);

1463 #ifde‡
PRINT_DEBLOCKING_FILTER_DISPLAY_PREFERENCE_INFO


1464 
	`¥ötf
("di•œy_¥i‹_to_deblockög_¥e„ºed_Êag = %d\n", 
di•œy_¥i‹_to_deblockög_¥e„ºed_Êag
);

1465 
	`¥ötf
("dec_‰ame_buf„rög_c⁄°øöt_Êag = %d\n", 
dec_‰ame_buf„rög_c⁄°øöt_Êag
);

1466 
	`¥ötf
("deblockög_di•œy_¥e„ªn˚_ª≥tôi⁄_≥riod = %d\n", 
deblockög_di•œy_¥e„ªn˚_ª≥tôi⁄_≥riod
);

1470 
	`‰ì
 (
buf
);

1471 #ifde‡
PRINT_DEBLOCKING_FILTER_DISPLAY_PREFERENCE_INFO


1472 #unde‡
PRINT_DEBLOCKING_FILTER_DISPLAY_PREFERENCE_INFO


1474 
	}
}

1489 
	$öãΩªt_°îeo_video_öfo_öfo
–
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
 )

1491 
fõld_võws_Êags
;

1492 
t›_fõld_is_À·_võw_Êag
, 
cuºít_‰ame_is_À·_võw_Êag
, 
√xt_‰ame_is_£c⁄d_võw_Êag
;

1493 
À·_võw_£lf_c⁄èöed_Êag
;

1494 
right_võw_£lf_c⁄èöed_Êag
;

1496 
Bô°ªam
* 
buf
;

1498 
buf
 = 
	`mÆloc
((
Bô°ªam
));

1499 
buf
->
bô°ªam_Àngth
 = 
size
;

1500 
buf
->
°ªamBuf„r
 = 
∑ylﬂd
;

1501 
buf
->
‰ame_bôoff£t
 = 0;

1503 
fõld_võws_Êags
 = 
	`ªad_u_1
("SEI: fõld_võws_Êags", 
buf
, &
p_Dec
->
U£dBôs
);

1504 #ifde‡
PRINT_STEREO_VIDEO_INFO_INFO


1505 
	`¥ötf
("fõld_võws_Êag†%d\n", 
fõld_võws_Êags
);

1507 i‡(
fõld_võws_Êags
)

1509 
t›_fõld_is_À·_võw_Êag
 = 
	`ªad_u_1
("SEI:Å›_fõld_is_À·_võw_Êag", 
buf
, &
p_Dec
->
U£dBôs
);

1510 #ifde‡
PRINT_STEREO_VIDEO_INFO_INFO


1511 
	`¥ötf
("t›_fõld_is_À·_võw_Êag = %d\n", 
t›_fõld_is_À·_võw_Êag
);

1516 
cuºít_‰ame_is_À·_võw_Êag
 = 
	`ªad_u_1
("SEI: cuºít_‰ame_is_À·_võw_Êag", 
buf
, &
p_Dec
->
U£dBôs
);

1517 
√xt_‰ame_is_£c⁄d_võw_Êag
 = 
	`ªad_u_1
("SEI:Çext_‰ame_is_£c⁄d_võw_Êag", 
buf
, &
p_Dec
->
U£dBôs
);

1518 #ifde‡
PRINT_STEREO_VIDEO_INFO_INFO


1519 
	`¥ötf
("cuºít_‰ame_is_À·_võw_Êag = %d\n", 
cuºít_‰ame_is_À·_võw_Êag
);

1520 
	`¥ötf
("√xt_‰ame_is_£c⁄d_võw_Êag = %d\n", 
√xt_‰ame_is_£c⁄d_võw_Êag
);

1524 
À·_võw_£lf_c⁄èöed_Êag
 = 
	`ªad_u_1
("SEI:Üe·_võw_£lf_c⁄èöed_Êag", 
buf
, &
p_Dec
->
U£dBôs
);

1525 
right_võw_£lf_c⁄èöed_Êag
 = 
	`ªad_u_1
("SEI:Ñight_võw_£lf_c⁄èöed_Êag", 
buf
, &
p_Dec
->
U£dBôs
);

1526 #ifde‡
PRINT_STEREO_VIDEO_INFO_INFO


1527 
	`¥ötf
("À·_võw_£lf_c⁄èöed_Êag = %d\n", 
À·_võw_£lf_c⁄èöed_Êag
);

1528 
	`¥ötf
("right_võw_£lf_c⁄èöed_Êag = %d\n", 
right_võw_£lf_c⁄èöed_Êag
);

1531 
	`‰ì
 (
buf
);

1532 #ifde‡
PRINT_STEREO_VIDEO_INFO_INFO


1533 #unde‡
PRINT_STEREO_VIDEO_INFO_INFO


1535 
	}
}

1550 
	$öãΩªt_ª£rved_öfo
–
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
 )

1552 
off£t
 = 0;

1553 
byã
 
∑ylﬂd_byã
;

1555 #ifde‡
PRINT_RESERVED_INFO


1556 
	`¥ötf
("Reserved SEI message\n");

1559 
off£t
 < 
size
)

1561 
∑ylﬂd_byã
 = 
∑ylﬂd
[
off£t
];

1562 
off£t
 ++;

1563 #ifde‡
PRINT_RESERVED_INFO


1564 
	`¥ötf
("ª£rved_£i_mesßge_∑ylﬂd_byã = %d\n", 
∑ylﬂd_byã
);

1567 #ifde‡
PRINT_RESERVED_INFO


1568 #unde‡
PRINT_RESERVED_INFO


1570 
	}
}

1586 
	$öãΩªt_buf„rög_≥riod_öfo
–
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
 )

1588 
£q_∑ømëî_£t_id
, 
öôül_˝b_ªmovÆ_dñay
, 
öôül_˝b_ªmovÆ_dñay_off£t
;

1589 
k
;

1591 
Bô°ªam
* 
buf
;

1592 
£q_∑ømëî_£t_rb•_t
 *
•s
;

1594 
buf
 = 
	`mÆloc
((
Bô°ªam
));

1595 
buf
->
bô°ªam_Àngth
 = 
size
;

1596 
buf
->
°ªamBuf„r
 = 
∑ylﬂd
;

1597 
buf
->
‰ame_bôoff£t
 = 0;

1599 
p_Dec
->
U£dBôs
 = 0;

1601 
£q_∑ømëî_£t_id
 = 
	`ªad_ue_v
("SEI: seq_∑ømëî_£t_id" , 
buf
, &
p_Dec
->
U£dBôs
);

1603 
•s
 = &
p_Vid
->
SeqP¨Së
[
£q_∑ømëî_£t_id
];

1605 
	`a˘iv©e_•s
(
p_Vid
, 
•s
);

1607 #ifde‡
PRINT_BUFFERING_PERIOD_INFO


1608 
	`¥ötf
("BufferingÖeriod SEI message\n");

1609 
	`¥ötf
("£q_∑ømëî_£t_id = %d\n", 
£q_∑ømëî_£t_id
);

1613 i‡(
•s
->
vui_∑ømëîs_¥e£¡_Êag
)

1616 i‡(
•s
->
vui_£q_∑ømëîs
.
«l_hrd_∑ømëîs_¥e£¡_Êag
)

1618 
k
=0; k<
•s
->
vui_£q_∑ømëîs
.
«l_hrd_∑ømëîs
.
˝b_˙t_möus1
+1; k++)

1620 
öôül_˝b_ªmovÆ_dñay
 = 
	`ªad_u_v
(
•s
->
vui_£q_∑ømëîs
.
«l_hrd_∑ømëîs
.
öôül_˝b_ªmovÆ_dñay_Àngth_möus1
+1, "SEI: inôül_˝b_ªmovÆ_dñay" , 
buf
, &
p_Dec
->
U£dBôs
);

1621 
öôül_˝b_ªmovÆ_dñay_off£t
 = 
	`ªad_u_v
(
•s
->
vui_£q_∑ømëîs
.
«l_hrd_∑ømëîs
.
öôül_˝b_ªmovÆ_dñay_Àngth_möus1
+1, "SEI: inôül_˝b_ªmovÆ_dñay_off£t" , 
buf
, &
p_Dec
->
U£dBôs
);

1623 #ifde‡
PRINT_BUFFERING_PERIOD_INFO


1624 
	`¥ötf
("«»öôül_˝b_ªmovÆ_dñay[%d] = %d\n", 
k
, 
öôül_˝b_ªmovÆ_dñay
);

1625 
	`¥ötf
("«»öôül_˝b_ªmovÆ_dñay_off£t[%d] = %d\n", 
k
, 
öôül_˝b_ªmovÆ_dñay_off£t
);

1630 i‡(
•s
->
vui_£q_∑ømëîs
.
v˛_hrd_∑ømëîs_¥e£¡_Êag
)

1632 
k
=0; k<
•s
->
vui_£q_∑ømëîs
.
v˛_hrd_∑ømëîs
.
˝b_˙t_möus1
+1; k++)

1634 
öôül_˝b_ªmovÆ_dñay
 = 
	`ªad_u_v
(
•s
->
vui_£q_∑ømëîs
.
v˛_hrd_∑ømëîs
.
öôül_˝b_ªmovÆ_dñay_Àngth_möus1
+1, "SEI: inôül_˝b_ªmovÆ_dñay" , 
buf
, &
p_Dec
->
U£dBôs
);

1635 
öôül_˝b_ªmovÆ_dñay_off£t
 = 
	`ªad_u_v
(
•s
->
vui_£q_∑ømëîs
.
v˛_hrd_∑ømëîs
.
öôül_˝b_ªmovÆ_dñay_Àngth_möus1
+1, "SEI: inôül_˝b_ªmovÆ_dñay_off£t" , 
buf
, &
p_Dec
->
U£dBôs
);

1637 #ifde‡
PRINT_BUFFERING_PERIOD_INFO


1638 
	`¥ötf
("v˛ inôül_˝b_ªmovÆ_dñay[%d] = %d\n", 
k
, 
öôül_˝b_ªmovÆ_dñay
);

1639 
	`¥ötf
("v˛ inôül_˝b_ªmovÆ_dñay_off£t[%d] = %d\n", 
k
, 
öôül_˝b_ªmovÆ_dñay_off£t
);

1645 
	`‰ì
 (
buf
);

1646 #ifde‡
PRINT_BUFFERING_PERIOD_INFO


1647 #unde‡
PRINT_BUFFERING_PERIOD_INFO


1649 
	}
}

1665 
	$öãΩªt_pi˘uª_timög_öfo
–
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
 )

1667 
£q_∑ømëî_£t_rb•_t
 *
a˘ive_•s
 = 
p_Vid
->active_sps;

1669 
˝b_ªmovÆ_dñay
, 
dpb_ouçut_dñay
, 
pic_°ru˘_¥e£¡_Êag
, 
pic_°ru˘
;

1670 
˛ock_time°amp_Êag
;

1671 
˘_ty≥
, 
nuô_fõld_ba£d_Êag
, 
cou¡ög_ty≥
, 
fuŒ_time°amp_Êag
, 
disc⁄töuôy_Êag
, 
˙t_dr›≥d_Êag
, 
n‰ames
;

1672 
£c⁄ds_vÆue
, 
möuãs_vÆue
, 
hours_vÆue
, 
£c⁄ds_Êag
, 
möuãs_Êag
, 
hours_Êag
, 
time_off£t
;

1673 
NumClockTs
 = 0;

1674 
i
;

1676 
˝b_ªmovÆ_Àn
 = 24;

1677 
dpb_ouçut_Àn
 = 24;

1679 
Boﬁón
 
CpbDpbDñaysPª£¡Fœg
;

1681 
Bô°ªam
* 
buf
;

1683 i‡(
NULL
==
a˘ive_•s
)

1685 
	`Ârötf
 (
°dîr
, "Warning:Çoáctive SPS,Åiming SEI cannot beÖarsed\n");

1689 
buf
 = 
	`mÆloc
((
Bô°ªam
));

1690 
buf
->
bô°ªam_Àngth
 = 
size
;

1691 
buf
->
°ªamBuf„r
 = 
∑ylﬂd
;

1692 
buf
->
‰ame_bôoff£t
 = 0;

1694 
p_Dec
->
U£dBôs
 = 0;

1697 #ifde‡
PRINT_PICTURE_TIMING_INFO


1698 
	`¥ötf
("PictureÅiming SEI message\n");

1702 
CpbDpbDñaysPª£¡Fœg
 = (
Boﬁón
Ë(
a˘ive_•s
->
vui_∑ømëîs_¥e£¡_Êag


1703 && ( (
a˘ive_•s
->
vui_£q_∑ømëîs
.
«l_hrd_∑ømëîs_¥e£¡_Êag
 != 0)

1704 ||(
a˘ive_•s
->
vui_£q_∑ømëîs
.
v˛_hrd_∑ømëîs_¥e£¡_Êag
 != 0)));

1706 i‡(
CpbDpbDñaysPª£¡Fœg
 )

1708 i‡(
a˘ive_•s
->
vui_∑ømëîs_¥e£¡_Êag
)

1710 i‡(
a˘ive_•s
->
vui_£q_∑ømëîs
.
«l_hrd_∑ømëîs_¥e£¡_Êag
)

1712 
˝b_ªmovÆ_Àn
 = 
a˘ive_•s
->
vui_£q_∑ømëîs
.
«l_hrd_∑ømëîs
.
˝b_ªmovÆ_dñay_Àngth_möus1
 + 1;

1713 
dpb_ouçut_Àn
 = 
a˘ive_•s
->
vui_£q_∑ømëîs
.
«l_hrd_∑ømëîs
.
dpb_ouçut_dñay_Àngth_möus1
 + 1;

1715 i‡(
a˘ive_•s
->
vui_£q_∑ømëîs
.
v˛_hrd_∑ømëîs_¥e£¡_Êag
)

1717 
˝b_ªmovÆ_Àn
 = 
a˘ive_•s
->
vui_£q_∑ømëîs
.
v˛_hrd_∑ømëîs
.
˝b_ªmovÆ_dñay_Àngth_möus1
 + 1;

1718 
dpb_ouçut_Àn
 = 
a˘ive_•s
->
vui_£q_∑ømëîs
.
v˛_hrd_∑ømëîs
.
dpb_ouçut_dñay_Àngth_möus1
 + 1;

1722 i‡((
a˘ive_•s
->
vui_£q_∑ømëîs
.
«l_hrd_∑ømëîs_¥e£¡_Êag
)||

1723 (
a˘ive_•s
->
vui_£q_∑ømëîs
.
v˛_hrd_∑ømëîs_¥e£¡_Êag
))

1725 
˝b_ªmovÆ_dñay
 = 
	`ªad_u_v
(
˝b_ªmovÆ_Àn
, "SEI: cpb_ªmovÆ_dñay" , 
buf
, &
p_Dec
->
U£dBôs
);

1726 
dpb_ouçut_dñay
 = 
	`ªad_u_v
(
dpb_ouçut_Àn
, "SEI: dpb_ouçut_dñay" , 
buf
, &
p_Dec
->
U£dBôs
);

1727 #ifde‡
PRINT_PICTURE_TIMING_INFO


1728 
	`¥ötf
("˝b_ªmovÆ_dñay = %d\n",
˝b_ªmovÆ_dñay
);

1729 
	`¥ötf
("dpb_ouçut_dñay = %d\n",
dpb_ouçut_dñay
);

1734 i‡(!
a˘ive_•s
->
vui_∑ømëîs_¥e£¡_Êag
)

1736 
pic_°ru˘_¥e£¡_Êag
 = 0;

1740 
pic_°ru˘_¥e£¡_Êag
 = 
a˘ive_•s
->
vui_£q_∑ømëîs
.pic_struct_present_flag;

1743 i‡(
pic_°ru˘_¥e£¡_Êag
)

1745 
pic_°ru˘
 = 
	`ªad_u_v
(4, "SEI:Öic_°ru˘" , 
buf
, &
p_Dec
->
U£dBôs
);

1746 #ifde‡
PRINT_PICTURE_TIMING_INFO


1747 
	`¥ötf
("pic_°ru˘ = %d\n",
pic_°ru˘
);

1749 
pic_°ru˘
)

1754 
NumClockTs
 = 1;

1759 
NumClockTs
 = 2;

1764 
NumClockTs
 = 3;

1767 
	`îr‹
("reservedÖic_struct used (can't determine NumClockTs)", 500);

1769 
i
=0; i<
NumClockTs
; i++)

1771 
˛ock_time°amp_Êag
 = 
	`ªad_u_1
("SEI: clock_time°amp_Êag" , 
buf
, &
p_Dec
->
U£dBôs
);

1772 #ifde‡
PRINT_PICTURE_TIMING_INFO


1773 
	`¥ötf
("˛ock_time°amp_Êag = %d\n",
˛ock_time°amp_Êag
);

1775 i‡(
˛ock_time°amp_Êag
)

1777 
˘_ty≥
 = 
	`ªad_u_v
(2, "SEI: ct_ty≥" , 
buf
, &
p_Dec
->
U£dBôs
);

1778 
nuô_fõld_ba£d_Êag
 = 
	`ªad_u_1
–"SEI:Çuô_fõld_ba£d_Êag" , 
buf
, &
p_Dec
->
U£dBôs
);

1779 
cou¡ög_ty≥
 = 
	`ªad_u_v
(5, "SEI: cou¡ög_ty≥" , 
buf
, &
p_Dec
->
U£dBôs
);

1780 
fuŒ_time°amp_Êag
 = 
	`ªad_u_1
–"SEI: fuŒ_time°amp_Êag" , 
buf
, &
p_Dec
->
U£dBôs
);

1781 
disc⁄töuôy_Êag
 = 
	`ªad_u_1
–"SEI: disc⁄töuôy_Êag" , 
buf
, &
p_Dec
->
U£dBôs
);

1782 
˙t_dr›≥d_Êag
 = 
	`ªad_u_1
–"SEI: c¡_dr›≥d_Êag" , 
buf
, &
p_Dec
->
U£dBôs
);

1783 
n‰ames
 = 
	`ªad_u_v
(8, "SEI:Ç‰ames" , 
buf
, &
p_Dec
->
U£dBôs
);

1785 #ifde‡
PRINT_PICTURE_TIMING_INFO


1786 
	`¥ötf
("˘_ty≥ = %d\n",
˘_ty≥
);

1787 
	`¥ötf
("nuô_fõld_ba£d_Êag = %d\n",
nuô_fõld_ba£d_Êag
);

1788 
	`¥ötf
("fuŒ_time°amp_Êag = %d\n",
fuŒ_time°amp_Êag
);

1789 
	`¥ötf
("disc⁄töuôy_Êag = %d\n",
disc⁄töuôy_Êag
);

1790 
	`¥ötf
("˙t_dr›≥d_Êag = %d\n",
˙t_dr›≥d_Êag
);

1791 
	`¥ötf
("n‰ame† = %d\n",
n‰ames
);

1793 i‡(
fuŒ_time°amp_Êag
)

1795 
£c⁄ds_vÆue
 = 
	`ªad_u_v
(6, "SEI: sec⁄ds_vÆue" , 
buf
, &
p_Dec
->
U£dBôs
);

1796 
möuãs_vÆue
 = 
	`ªad_u_v
(6, "SEI: möuãs_vÆue" , 
buf
, &
p_Dec
->
U£dBôs
);

1797 
hours_vÆue
 = 
	`ªad_u_v
(5, "SEI: hours_vÆue" , 
buf
, &
p_Dec
->
U£dBôs
);

1798 #ifde‡
PRINT_PICTURE_TIMING_INFO


1799 
	`¥ötf
("£c⁄ds_vÆuê%d\n",
£c⁄ds_vÆue
);

1800 
	`¥ötf
("möuãs_vÆuê%d\n",
möuãs_vÆue
);

1801 
	`¥ötf
("hours_vÆuê = %d\n",
hours_vÆue
);

1806 
£c⁄ds_Êag
 = 
	`ªad_u_1
–"SEI: sec⁄ds_Êag" , 
buf
, &
p_Dec
->
U£dBôs
);

1807 #ifde‡
PRINT_PICTURE_TIMING_INFO


1808 
	`¥ötf
("£c⁄ds_Êag = %d\n",
£c⁄ds_Êag
);

1810 i‡(
£c⁄ds_Êag
)

1812 
£c⁄ds_vÆue
 = 
	`ªad_u_v
(6, "SEI: sec⁄ds_vÆue" , 
buf
, &
p_Dec
->
U£dBôs
);

1813 
möuãs_Êag
 = 
	`ªad_u_1
–"SEI: möuãs_Êag" , 
buf
, &
p_Dec
->
U£dBôs
);

1814 #ifde‡
PRINT_PICTURE_TIMING_INFO


1815 
	`¥ötf
("£c⁄ds_vÆuê%d\n",
£c⁄ds_vÆue
);

1816 
	`¥ötf
("möuãs_Êag = %d\n",
möuãs_Êag
);

1818 if(
möuãs_Êag
)

1820 
möuãs_vÆue
 = 
	`ªad_u_v
(6, "SEI: möuãs_vÆue" , 
buf
, &
p_Dec
->
U£dBôs
);

1821 
hours_Êag
 = 
	`ªad_u_1
–"SEI: hours_Êag" , 
buf
, &
p_Dec
->
U£dBôs
);

1822 #ifde‡
PRINT_PICTURE_TIMING_INFO


1823 
	`¥ötf
("möuãs_vÆuê%d\n",
möuãs_vÆue
);

1824 
	`¥ötf
("hours_Êag = %d\n",
hours_Êag
);

1826 if(
hours_Êag
)

1828 
hours_vÆue
 = 
	`ªad_u_v
(5, "SEI: hours_vÆue" , 
buf
, &
p_Dec
->
U£dBôs
);

1829 #ifde‡
PRINT_PICTURE_TIMING_INFO


1830 
	`¥ötf
("hours_vÆuê = %d\n",
hours_vÆue
);

1837 
time_off£t_Àngth
;

1838 i‡(
a˘ive_•s
->
vui_£q_∑ømëîs
.
v˛_hrd_∑ømëîs_¥e£¡_Êag
)

1839 
time_off£t_Àngth
 = 
a˘ive_•s
->
vui_£q_∑ømëîs
.
v˛_hrd_∑ømëîs
.time_offset_length;

1840 i‡(
a˘ive_•s
->
vui_£q_∑ømëîs
.
«l_hrd_∑ømëîs_¥e£¡_Êag
)

1841 
time_off£t_Àngth
 = 
a˘ive_•s
->
vui_£q_∑ømëîs
.
«l_hrd_∑ømëîs
.time_offset_length;

1843 
time_off£t_Àngth
 = 24;

1844 i‡(
time_off£t_Àngth
)

1845 
time_off£t
 = 
	`ªad_i_v
(
time_off£t_Àngth
, "SEI:Åime_off£t" , 
buf
, &
p_Dec
->
U£dBôs
);

1847 
time_off£t
 = 0;

1848 #ifde‡
PRINT_PICTURE_TIMING_INFO


1849 
	`¥ötf
("time_off£à = %d\n",
time_off£t
);

1856 
	`‰ì
 (
buf
);

1857 #ifde‡
PRINT_PICTURE_TIMING_INFO


1858 #unde‡
PRINT_PICTURE_TIMING_INFO


1860 
	}
}

1874 
	$öãΩªt_‰ame_∑ckög_¨øngemít_öfo
–
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
 )

1876 
‰ame_∑ckög_¨øngemít_öf‹m©i⁄_°ru˘
 
£iFømePackögAº™gemít
;

1877 
Bô°ªam
* 
buf
;

1879 
buf
 = 
	`mÆloc
((
Bô°ªam
));

1880 
buf
->
bô°ªam_Àngth
 = 
size
;

1881 
buf
->
°ªamBuf„r
 = 
∑ylﬂd
;

1882 
buf
->
‰ame_bôoff£t
 = 0;

1884 
p_Dec
->
U£dBôs
 = 0;

1886 #ifde‡
PRINT_FRAME_PACKING_ARRANGEMENT_INFO


1887 
	`¥ötf
("FrameÖackingárrangement SEI message\n");

1890 
£iFømePackögAº™gemít
.
‰ame_∑ckög_¨øngemít_id
 = ()
	`ªad_ue_v
–"SEI: føme_∑ckög_¨øngemít_id", 
buf
, &
p_Dec
->
U£dBôs
 );

1891 
£iFømePackögAº™gemít
.
‰ame_∑ckög_¨øngemít_ˇn˚l_Êag
 = 
	`ªad_u_1
–"SEI: føme_∑ckög_¨øngemít_ˇn˚l_Êag", 
buf
, &
p_Dec
->
U£dBôs
 );

1892 #ifde‡
PRINT_FRAME_PACKING_ARRANGEMENT_INFO


1893 
	`¥ötf
("‰ame_∑ckög_¨øngemít_id = %d\n", 
£iFømePackögAº™gemít
.
‰ame_∑ckög_¨øngemít_id
);

1894 
	`¥ötf
("‰ame_∑ckög_¨øngemít_ˇn˚l_Êag = %d\n", 
£iFømePackögAº™gemít
.
‰ame_∑ckög_¨øngemít_ˇn˚l_Êag
);

1896 i‡–
£iFømePackögAº™gemít
.
‰ame_∑ckög_¨øngemít_ˇn˚l_Êag
 =
FALSE
 )

1898 
£iFømePackögAº™gemít
.
‰ame_∑ckög_¨øngemít_ty≥
 = ()
	`ªad_u_v
–7, "SEI: føme_∑ckög_¨øngemít_ty≥", 
buf
, &
p_Dec
->
U£dBôs
 );

1899 
£iFømePackögAº™gemít
.
quöcunx_ßm∂ög_Êag
 = 
	`ªad_u_1
–"SEI: quöcunx_ßm∂ög_Êag", 
buf
, &
p_Dec
->
U£dBôs
 );

1900 
£iFømePackögAº™gemít
.
c⁄ã¡_öãΩªèti⁄_ty≥
 = ()
	`ªad_u_v
–6, "SEI: c⁄ã¡_öãΩªèti⁄_ty≥", 
buf
, &
p_Dec
->
U£dBôs
 );

1901 
£iFømePackögAº™gemít
.
•©ül_Êùpög_Êag
 = 
	`ªad_u_1
–"SEI: s∑tül_Êùpög_Êag", 
buf
, &
p_Dec
->
U£dBôs
 );

1902 
£iFømePackögAº™gemít
.
‰ame0_Êù≥d_Êag
 = 
	`ªad_u_1
–"SEI: føme0_Êù≥d_Êag", 
buf
, &
p_Dec
->
U£dBôs
 );

1903 
£iFømePackögAº™gemít
.
fõld_võws_Êag
 = 
	`ªad_u_1
–"SEI: fõld_võws_Êag", 
buf
, &
p_Dec
->
U£dBôs
 );

1904 
£iFømePackögAº™gemít
.
cuºít_‰ame_is_‰ame0_Êag
 = 
	`ªad_u_1
–"SEI: cuºít_‰ame_is_‰ame0_Êag", 
buf
, &
p_Dec
->
U£dBôs
 );

1905 
£iFømePackögAº™gemít
.
‰ame0_£lf_c⁄èöed_Êag
 = 
	`ªad_u_1
–"SEI: føme0_£lf_c⁄èöed_Êag", 
buf
, &
p_Dec
->
U£dBôs
 );

1906 
£iFømePackögAº™gemít
.
‰ame1_£lf_c⁄èöed_Êag
 = 
	`ªad_u_1
–"SEI: føme1_£lf_c⁄èöed_Êag", 
buf
, &
p_Dec
->
U£dBôs
 );

1907 #ifde‡
PRINT_FRAME_PACKING_ARRANGEMENT_INFO


1908 
	`¥ötf
("‰ame_∑ckög_¨øngemít_ty≥ = %d\n", 
£iFømePackögAº™gemít
.
‰ame_∑ckög_¨øngemít_ty≥
);

1909 
	`¥ötf
("quöcunx_ßm∂ög_Êag = %d\n", 
£iFømePackögAº™gemít
.
quöcunx_ßm∂ög_Êag
);

1910 
	`¥ötf
("c⁄ã¡_öãΩªèti⁄_ty≥ = %d\n", 
£iFømePackögAº™gemít
.
c⁄ã¡_öãΩªèti⁄_ty≥
);

1911 
	`¥ötf
("•©ül_Êùpög_Êag = %d\n", 
£iFømePackögAº™gemít
.
•©ül_Êùpög_Êag
);

1912 
	`¥ötf
("‰ame0_Êù≥d_Êag = %d\n", 
£iFømePackögAº™gemít
.
‰ame0_Êù≥d_Êag
);

1913 
	`¥ötf
("fõld_võws_Êag = %d\n", 
£iFømePackögAº™gemít
.
fõld_võws_Êag
);

1914 
	`¥ötf
("cuºít_‰ame_is_‰ame0_Êag = %d\n", 
£iFømePackögAº™gemít
.
cuºít_‰ame_is_‰ame0_Êag
);

1915 
	`¥ötf
("‰ame0_£lf_c⁄èöed_Êag = %d\n", 
£iFømePackögAº™gemít
.
‰ame0_£lf_c⁄èöed_Êag
);

1916 
	`¥ötf
("‰ame1_£lf_c⁄èöed_Êag = %d\n", 
£iFømePackögAº™gemít
.
‰ame1_£lf_c⁄èöed_Êag
);

1918 i‡–
£iFømePackögAº™gemít
.
quöcunx_ßm∂ög_Êag
 =
FALSE
 && seiFømePackögAº™gemít.
‰ame_∑ckög_¨øngemít_ty≥
 != 5 )

1920 
£iFømePackögAº™gemít
.
‰ame0_grid_posôi⁄_x
 = ()
	`ªad_u_v
–4, "SEI: føme0_grid_posôi⁄_x", 
buf
, &
p_Dec
->
U£dBôs
 );

1921 
£iFømePackögAº™gemít
.
‰ame0_grid_posôi⁄_y
 = ()
	`ªad_u_v
–4, "SEI: føme0_grid_posôi⁄_y", 
buf
, &
p_Dec
->
U£dBôs
 );

1922 
£iFømePackögAº™gemít
.
‰ame1_grid_posôi⁄_x
 = ()
	`ªad_u_v
–4, "SEI: føme1_grid_posôi⁄_x", 
buf
, &
p_Dec
->
U£dBôs
 );

1923 
£iFømePackögAº™gemít
.
‰ame1_grid_posôi⁄_y
 = ()
	`ªad_u_v
–4, "SEI: føme1_grid_posôi⁄_y", 
buf
, &
p_Dec
->
U£dBôs
 );

1924 #ifde‡
PRINT_FRAME_PACKING_ARRANGEMENT_INFO


1925 
	`¥ötf
("‰ame0_grid_posôi⁄_x = %d\n", 
£iFømePackögAº™gemít
.
‰ame0_grid_posôi⁄_x
);

1926 
	`¥ötf
("‰ame0_grid_posôi⁄_y = %d\n", 
£iFømePackögAº™gemít
.
‰ame0_grid_posôi⁄_y
);

1927 
	`¥ötf
("‰ame1_grid_posôi⁄_x = %d\n", 
£iFømePackögAº™gemít
.
‰ame1_grid_posôi⁄_x
);

1928 
	`¥ötf
("‰ame1_grid_posôi⁄_y = %d\n", 
£iFømePackögAº™gemít
.
‰ame1_grid_posôi⁄_y
);

1931 
£iFømePackögAº™gemít
.
‰ame_∑ckög_¨øngemít_ª£rved_byã
 = ()
	`ªad_u_v
–8, "SEI: føme_∑ckög_¨øngemít_ª£rved_byã", 
buf
, &
p_Dec
->
U£dBôs
 );

1932 
£iFømePackögAº™gemít
.
‰ame_∑ckög_¨øngemít_ª≥tôi⁄_≥riod
 = ()
	`ªad_ue_v
–"SEI: føme_∑ckög_¨øngemít_ª≥tôi⁄_≥riod", 
buf
, &
p_Dec
->
U£dBôs
 );

1933 #ifde‡
PRINT_FRAME_PACKING_ARRANGEMENT_INFO


1934 
	`¥ötf
("‰ame_∑ckög_¨øngemít_ª£rved_byã = %d\n", 
£iFømePackögAº™gemít
.
‰ame_∑ckög_¨øngemít_ª£rved_byã
);

1935 
	`¥ötf
("‰ame_∑ckög_¨øngemít_ª≥tôi⁄_≥riod = %d\n", 
£iFømePackögAº™gemít
.
‰ame_∑ckög_¨øngemít_ª≥tôi⁄_≥riod
);

1938 
£iFømePackögAº™gemít
.
‰ame_∑ckög_¨øngemít_exãnsi⁄_Êag
 = 
	`ªad_u_1
–"SEI: føme_∑ckög_¨øngemít_exãnsi⁄_Êag", 
buf
, &
p_Dec
->
U£dBôs
 );

1939 #ifde‡
PRINT_FRAME_PACKING_ARRANGEMENT_INFO


1940 
	`¥ötf
("‰ame_∑ckög_¨øngemít_exãnsi⁄_Êag = %d\n", 
£iFømePackögAº™gemít
.
‰ame_∑ckög_¨øngemít_exãnsi⁄_Êag
);

1943 
	`‰ì
 (
buf
);

1944 #ifde‡
PRINT_FRAME_PACKING_ARRANGEMENT_INFO


1945 #unde‡
PRINT_FRAME_PACKING_ARRANGEMENT_INFO


1947 
	}
}

1964 
	mt⁄e_m≠_id
;

1965 
	mt⁄e_m≠_ˇn˚l_Êag
;

1966 
	mt⁄e_m≠_ª≥tôi⁄_≥riod
;

1967 
	mcoded_d©a_bô_dïth
;

1968 
	m£i_bô_dïth
;

1969 
	mmodñ_id
;

1971 
	mmö_vÆue
;

1972 
	mmax_vÆue
;

1974 
	msigmoid_midpoöt
;

1975 
	msigmoid_width
;

1977 
	m°¨t_of_coded_öãrvÆ
[1<<
MAX_SEI_BIT_DEPTH
];

1979 
	mnum_pivŸs
;

1980 
	mcoded_pivŸ_vÆue
[
MAX_NUM_PIVOTS
];

1981 
	m£i_pivŸ_vÆue
[
MAX_NUM_PIVOTS
];

1982 } 
	tt⁄e_m≠pög_°ru˘_tmp
;

1984 
	$öãΩªt_t⁄e_m≠pög
–
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
 )

1986 
t⁄e_m≠pög_°ru˘_tmp
 
£iT⁄eM≠pögTmp
;

1987 
Bô°ªam
* 
buf
;

1988 
i
 = 0, 
max_coded_num
, 
max_ouçut_num
;

1990 
	`mem£t
 (&
£iT⁄eM≠pögTmp
, 0,  (
t⁄e_m≠pög_°ru˘_tmp
));

1992 
buf
 = 
	`mÆloc
((
Bô°ªam
));

1993 
buf
->
bô°ªam_Àngth
 = 
size
;

1994 
buf
->
°ªamBuf„r
 = 
∑ylﬂd
;

1995 
buf
->
‰ame_bôoff£t
 = 0;

1997 
£iT⁄eM≠pögTmp
.
t⁄e_m≠_id
 = 
	`ªad_ue_v
("SEI:Å⁄e_m≠_id", 
buf
, &
p_Dec
->
U£dBôs
);

1998 
£iT⁄eM≠pögTmp
.
t⁄e_m≠_ˇn˚l_Êag
 = (Ë
	`ªad_u_1
("SEI:Å⁄e_m≠_ˇn˚l_Êag", 
buf
, &
p_Dec
->
U£dBôs
);

2000 #ifde‡
PRINT_TONE_MAPPING


2001 
	`¥ötf
("Tone-mapping SEI message\n");

2002 
	`¥ötf
("t⁄e_m≠_id = %d\n", 
£iT⁄eM≠pögTmp
.
t⁄e_m≠_id
);

2004 i‡(
£iT⁄eM≠pögTmp
.
t⁄e_m≠_id
 != 0)

2005 
	`¥ötf
("WARNING! Tone_map_id != 0,ÖrintÅhe SEI message info only. TheÅone mapping isáctuallyápplied only when Tone_map_id==0\n\n");

2006 
	`¥ötf
("t⁄e_m≠_ˇn˚l_Êag = %d\n", 
£iT⁄eM≠pögTmp
.
t⁄e_m≠_ˇn˚l_Êag
);

2009 i‡(!
£iT⁄eM≠pögTmp
.
t⁄e_m≠_ˇn˚l_Êag
)

2011 
£iT⁄eM≠pögTmp
.
t⁄e_m≠_ª≥tôi⁄_≥riod
 = 
	`ªad_ue_v
–"SEI:Å⁄e_m≠_ª≥tôi⁄_≥riod", 
buf
, &
p_Dec
->
U£dBôs
);

2012 
£iT⁄eM≠pögTmp
.
coded_d©a_bô_dïth
 = ()
	`ªad_u_v
 (8,"SEI: coded_d©a_bô_dïth" , 
buf
, &
p_Dec
->
U£dBôs
);

2013 
£iT⁄eM≠pögTmp
.
£i_bô_dïth
 = ()
	`ªad_u_v
 (8,"SEI: sei_bô_dïth" , 
buf
, &
p_Dec
->
U£dBôs
);

2014 
£iT⁄eM≠pögTmp
.
modñ_id
 = 
	`ªad_ue_v
–"SEI: modñ_id" , 
buf
, &
p_Dec
->
U£dBôs
);

2016 #ifde‡
PRINT_TONE_MAPPING


2017 
	`¥ötf
("t⁄e_m≠_ª≥tôi⁄_≥riod = %d\n", 
£iT⁄eM≠pögTmp
.
t⁄e_m≠_ª≥tôi⁄_≥riod
);

2018 
	`¥ötf
("coded_d©a_bô_dïth = %d\n", 
£iT⁄eM≠pögTmp
.
coded_d©a_bô_dïth
);

2019 
	`¥ötf
("£i_bô_dïth = %d\n", 
£iT⁄eM≠pögTmp
.
£i_bô_dïth
);

2020 
	`¥ötf
("modñ_id = %d\n", 
£iT⁄eM≠pögTmp
.
modñ_id
);

2023 
max_coded_num
 = 1<<
£iT⁄eM≠pögTmp
.
coded_d©a_bô_dïth
;

2024 
max_ouçut_num
 = 1<<
£iT⁄eM≠pögTmp
.
£i_bô_dïth
;

2026 i‡(
£iT⁄eM≠pögTmp
.
modñ_id
 == 0)

2028 
£iT⁄eM≠pögTmp
.
mö_vÆue
 = 
	`ªad_u_v
 (32,"SEI: mö_vÆue", 
buf
, &
p_Dec
->
U£dBôs
);

2029 
£iT⁄eM≠pögTmp
.
max_vÆue
 = 
	`ªad_u_v
 (32,"SEI: mö_vÆue", 
buf
, &
p_Dec
->
U£dBôs
);

2030 #ifde‡
PRINT_TONE_MAPPING


2031 
	`¥ötf
("mö_vÆuê%d, max_vÆuê%d\n", 
£iT⁄eM≠pögTmp
.
mö_vÆue
, seiT⁄eM≠pögTmp.
max_vÆue
);

2034 i‡(
£iT⁄eM≠pögTmp
.
modñ_id
 == 1)

2036 
£iT⁄eM≠pögTmp
.
sigmoid_midpoöt
 = 
	`ªad_u_v
 (32,"SEI: sigmoid_midpoöt", 
buf
, &
p_Dec
->
U£dBôs
);

2037 
£iT⁄eM≠pögTmp
.
sigmoid_width
 = 
	`ªad_u_v
 (32,"SEI: sigmoid_width", 
buf
, &
p_Dec
->
U£dBôs
);

2038 #ifde‡
PRINT_TONE_MAPPING


2039 
	`¥ötf
("sigmoid_midpoöà%d, sigmoid_width = %d\n", 
£iT⁄eM≠pögTmp
.
sigmoid_midpoöt
, seiT⁄eM≠pögTmp.
sigmoid_width
);

2042 i‡(
£iT⁄eM≠pögTmp
.
modñ_id
 == 2)

2044 
i
=0; i<
max_ouçut_num
; i++)

2046 
£iT⁄eM≠pögTmp
.
°¨t_of_coded_öãrvÆ
[
i
] = 
	`ªad_u_v
((((£iT⁄eM≠pögTmp.
coded_d©a_bô_dïth
+7)>>3)<<3), "SEI: sèπ_of_coded_öãrvÆ" , 
buf
, &
p_Dec
->
U£dBôs
);

2047 #ifde‡
PRINT_TONE_MAPPING


2052 i‡(
£iT⁄eM≠pögTmp
.
modñ_id
 == 3)

2054 
£iT⁄eM≠pögTmp
.
num_pivŸs
 = 
	`ªad_u_v
 (16,"SEI:Çum_pivŸs", 
buf
, &
p_Dec
->
U£dBôs
);

2055 #ifde‡
PRINT_TONE_MAPPING


2056 
	`¥ötf
("num_pivŸ†%d\n", 
£iT⁄eM≠pögTmp
.
num_pivŸs
);

2058 
£iT⁄eM≠pögTmp
.
coded_pivŸ_vÆue
[0] = 0;

2059 
£iT⁄eM≠pögTmp
.
£i_pivŸ_vÆue
[0] = 0;

2060 
£iT⁄eM≠pögTmp
.
coded_pivŸ_vÆue
[£iT⁄eM≠pögTmp.
num_pivŸs
+1] = 
max_coded_num
-1;

2061 
£iT⁄eM≠pögTmp
.
£i_pivŸ_vÆue
[£iT⁄eM≠pögTmp.
num_pivŸs
+1] = 
max_ouçut_num
-1;

2063 
i
=1; i < 
£iT⁄eM≠pögTmp
.
num_pivŸs
+1; i++)

2065 
£iT⁄eM≠pögTmp
.
coded_pivŸ_vÆue
[
i
] = 
	`ªad_u_v
–(((£iT⁄eM≠pögTmp.
coded_d©a_bô_dïth
+7)>>3)<<3), "SEI: coded_pivŸ_vÆue", 
buf
, &
p_Dec
->
U£dBôs
);

2066 
£iT⁄eM≠pögTmp
.
£i_pivŸ_vÆue
[
i
] = 
	`ªad_u_v
–(((£iT⁄eM≠pögTmp.
£i_bô_dïth
+7)>>3)<<3), "SEI: sei_pivŸ_vÆue", 
buf
, &
p_Dec
->
U£dBôs
);

2067 #ifde‡
PRINT_TONE_MAPPING


2068 
	`¥ötf
("coded_pivŸ_vÆue[%d] = %d, sei_pivŸ_vÆue[%d] = %d\n", 
i
, 
£iT⁄eM≠pögTmp
.
coded_pivŸ_vÆue
[i], i, seiT⁄eM≠pögTmp.
£i_pivŸ_vÆue
[i]);

2073 #i‡(
ENABLE_OUTPUT_TONEMAPPING
)

2075 i‡(
£iT⁄eM≠pögTmp
.
t⁄e_m≠_id
== 0)

2077 
j
;

2078 
p_Vid
->
£iT⁄eM≠pög
->
£iHasT⁄e_m≠pög
 = 
TRUE
;

2079 
p_Vid
->
£iT⁄eM≠pög
->
t⁄e_m≠_ª≥tôi⁄_≥riod
 = 
£iT⁄eM≠pögTmp
.tone_map_repetition_period;

2080 
p_Vid
->
£iT⁄eM≠pög
->
coded_d©a_bô_dïth
 = 
£iT⁄eM≠pögTmp
.coded_data_bit_depth;

2081 
p_Vid
->
£iT⁄eM≠pög
->
£i_bô_dïth
 = 
£iT⁄eM≠pögTmp
.sei_bit_depth;

2082 
p_Vid
->
£iT⁄eM≠pög
->
modñ_id
 = 
£iT⁄eM≠pögTmp
.model_id;

2083 
p_Vid
->
£iT⁄eM≠pög
->
cou¡
 = 0;

2086 
£iT⁄eM≠pögTmp
.
modñ_id
)

2089 
i
=0; i<=
£iT⁄eM≠pögTmp
.
mö_vÆue
; i++)

2090 
p_Vid
->
£iT⁄eM≠pög
->
lut
[
i
] = 0;

2092 
i
=
£iT⁄eM≠pögTmp
.
mö_vÆue
+1; i < seiT⁄eM≠pögTmp.
max_vÆue
; i++)

2093 
p_Vid
->
£iT⁄eM≠pög
->
lut
[
i
] = (
img≥l
Ë((i-
£iT⁄eM≠pögTmp
.
mö_vÆue
Ë* (
max_ouçut_num
-1)/(£iT⁄eM≠pögTmp.
max_vÆue
- seiToneMappingTmp.min_value));

2095 
i
=
£iT⁄eM≠pögTmp
.
max_vÆue
; i<
max_coded_num
; i++)

2096 
p_Vid
->
£iT⁄eM≠pög
->
lut
[
i
] = (
img≥l
Ë(
max_ouçut_num
 - 1);

2100 
i
=0; i < 
max_coded_num
; i++)

2102 
tmp
 = 1.0 + 
	`exp
–-6*()(
i
-
£iT⁄eM≠pögTmp
.
sigmoid_midpoöt
)/£iT⁄eM≠pögTmp.
sigmoid_width
);

2103 
p_Vid
->
£iT⁄eM≠pög
->
lut
[
i
] = (
img≥l
)–()(
max_ouçut_num
-1)/ 
tmp
 + 0.5);

2107 i‡(0 < 
max_ouçut_num
-1)

2109 
j
=0; j<
max_ouçut_num
-1; j++)

2111 
i
=
£iT⁄eM≠pögTmp
.
°¨t_of_coded_öãrvÆ
[
j
]; i<seiToneMappingTmp.start_of_coded_interval[j+1]; i++)

2113 
p_Vid
->
£iT⁄eM≠pög
->
lut
[
i
] = (
img≥l
Ë
j
;

2116 
p_Vid
->
£iT⁄eM≠pög
->
lut
[
i
] = (
img≥l
Ë(
max_ouçut_num
 - 1);

2120 
j
=0; j<
£iT⁄eM≠pögTmp
.
num_pivŸs
+1; j++)

2122 
¶›e
 = ()(
£iT⁄eM≠pögTmp
.
£i_pivŸ_vÆue
[
j
+1] - seiT⁄eM≠pögTmp.£i_pivŸ_vÆue[j])/(£iT⁄eM≠pögTmp.
coded_pivŸ_vÆue
[j+1]-seiToneMappingTmp.coded_pivot_value[j]);

2123 
i
=
£iT⁄eM≠pögTmp
.
coded_pivŸ_vÆue
[
j
]; i <= seiToneMappingTmp.coded_pivot_value[j+1]; i++)

2125 
p_Vid
->
£iT⁄eM≠pög
->
lut
[
i
] = (
img≥l
Ë(
£iT⁄eM≠pögTmp
.
£i_pivŸ_vÆue
[
j
] + ()(–(ò- seiT⁄eM≠pögTmp.
coded_pivŸ_vÆue
[j]Ë* 
¶›e
)));

2136 
	`‰ì
 (
buf
);

2137 
	}
}

2139 #i‡(
ENABLE_OUTPUT_TONEMAPPING
)

2141 
	$t⁄e_m≠
 (
img≥l
** 
imgX
, img≥l* 
lut
, 
size_x
, 
size_y
)

2143 
i
, 
j
;

2145 
i
=0;i<
size_y
;i++)

2147 
j
=0;j<
size_x
;j++)

2149 
imgX
[
i
][
j
] = (
img≥l
)
lut
[imgX[i][j]];

2152 
	}
}

2154 
	$öô_t⁄e_m≠pög_£i
(
T⁄eM≠pögSEI
 *
£iT⁄eM≠pög
)

2156 
£iT⁄eM≠pög
->
£iHasT⁄e_m≠pög
 = 
FALSE
;

2157 
£iT⁄eM≠pög
->
cou¡
 = 0;

2158 
	}
}

2160 
	$upd©e_t⁄e_m≠pög_£i
(
T⁄eM≠pögSEI
 *
£iT⁄eM≠pög
)

2163 if(
£iT⁄eM≠pög
->
t⁄e_m≠_ª≥tôi⁄_≥riod
 == 0)

2165 
£iT⁄eM≠pög
->
£iHasT⁄e_m≠pög
 = 
FALSE
;

2166 
£iT⁄eM≠pög
->
cou¡
 = 0;

2168 i‡(
£iT⁄eM≠pög
->
t⁄e_m≠_ª≥tôi⁄_≥riod
>1)

2170 
£iT⁄eM≠pög
->
cou¡
++;

2171 i‡(
£iT⁄eM≠pög
->
cou¡
>=£iT⁄eM≠pög->
t⁄e_m≠_ª≥tôi⁄_≥riod
)

2173 
£iT⁄eM≠pög
->
£iHasT⁄e_m≠pög
 = 
FALSE
;

2174 
£iT⁄eM≠pög
->
cou¡
 = 0;

2177 
	}
}

2193 
	$öãΩªt_po°_fûãr_höts_öfo
–
byã
* 
∑ylﬂd
, 
size
, 
VideoP¨amëîs
 *
p_Vid
 )

2195 
Bô°ªam
* 
buf
;

2196 
fûãr_höt_size_y
, 
fûãr_höt_size_x
, 
fûãr_höt_ty≥
, 
cﬁ‹_comp⁄ít
, 
cx
, 
cy
, 
addôi⁄Æ_exãnsi⁄_Êag
;

2197 ***
fûãr_höt
;

2199 
buf
 = 
	`mÆloc
((
Bô°ªam
));

2200 
buf
->
bô°ªam_Àngth
 = 
size
;

2201 
buf
->
°ªamBuf„r
 = 
∑ylﬂd
;

2202 
buf
->
‰ame_bôoff£t
 = 0;

2204 
p_Dec
->
U£dBôs
 = 0;

2206 
fûãr_höt_size_y
 = 
	`ªad_ue_v
("SEI: fûãr_höt_size_y", 
buf
, &
p_Dec
->
U£dBôs
);

2207 
fûãr_höt_size_x
 = 
	`ªad_ue_v
("SEI: fûãr_höt_size_x", 
buf
, &
p_Dec
->
U£dBôs
);

2208 
fûãr_höt_ty≥
 = 
	`ªad_u_v
(2, "SEI: fûãr_höt_ty≥", 
buf
, &
p_Dec
->
U£dBôs
);

2210 
	`gë_mem3Döt
 (&
fûãr_höt
, 3, 
fûãr_höt_size_y
, 
fûãr_höt_size_x
);

2212 
cﬁ‹_comp⁄ít
 = 0; color_component < 3; color_component ++)

2213 
cy
 = 0; cy < 
fûãr_höt_size_y
; cy ++)

2214 
cx
 = 0; cx < 
fûãr_höt_size_x
; cx ++)

2215 
fûãr_höt
[
cﬁ‹_comp⁄ít
][
cy
][
cx
] = 
	`ªad_£_v
("SEI: fûãr_höt", 
buf
, &
p_Dec
->
U£dBôs
);

2217 
addôi⁄Æ_exãnsi⁄_Êag
 = 
	`ªad_u_1
("SEI:áddôi⁄Æ_exãnsi⁄_Êag", 
buf
, &
p_Dec
->
U£dBôs
);

2219 #ifde‡
PRINT_POST_FILTER_HINT_INFO


2220 
	`¥ötf
(" Post-filter hint SEI message\n");

2221 
	`¥ötf
("Öo°_fûãr_höt_size_y %d \n", 
fûãr_höt_size_y
);

2222 
	`¥ötf
("Öo°_fûãr_höt_size_x %d \n", 
fûãr_höt_size_x
);

2223 
	`¥ötf
("Öo°_fûãr_höt_ty≥ %d \n", 
fûãr_höt_ty≥
);

2224 
cﬁ‹_comp⁄ít
 = 0; color_component < 3; color_component ++)

2225 
cy
 = 0; cy < 
fûãr_höt_size_y
; cy ++)

2226 
cx
 = 0; cx < 
fûãr_höt_size_x
; cx ++)

2227 
	`¥ötf
("Öo°_fûãr_höt[%d][%d][%d] %d \n", 
cﬁ‹_comp⁄ít
, 
cy
, 
cx
, 
fûãr_höt
[color_component][cy][cx]);

2229 
	`¥ötf
("áddôi⁄Æ_exãnsi⁄_Êag %d \n", 
addôi⁄Æ_exãnsi⁄_Êag
);

2231 #unde‡
PRINT_POST_FILTER_HINT_INFO


2234 
	`‰ì_mem3Döt
 (
fûãr_höt
);

2235 
	`‰ì
–
buf
 );

2236 
	}
}

	@ldecod/src/transform8x8.c

19 
	~"globÆ.h
"

21 
	~"image.h
"

22 
	~"mb_ac˚ss.h
"

23 
	~"ñemíts.h
"

24 
	~"å™sf‹m8x8.h
"

25 
	~"å™sf‹m.h
"

26 
	~"qu™t.h
"

28 
	$ªc⁄8x8
(**
m7
, 
img≥l
 **
mb_ªc
, img≥»**
m¥
, 
max_img≥l_vÆue
, 
ioff
)

30 
j
;

31 *
m_å
 = 
NULL
;

32 
img≥l
 *
m_ªc
 = 
NULL
;

33 
img≥l
 *
m_¥d
 = 
NULL
;

35  
j
 = 0; j < 8; j++)

37 
m_å
 = (*
m7
++Ë+ 
ioff
;

38 
m_ªc
 = (*
mb_ªc
++Ë+ 
ioff
;

39 
m_¥d
 = (*
m¥
++Ë+ 
ioff
;

41 *
m_ªc
++ = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, (*
m_¥d
++Ë+ 
	`rshi·_∫d_sf
(*
m_å
++, 
DQ_BITS_8
));

42 *
m_ªc
++ = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, (*
m_¥d
++Ë+ 
	`rshi·_∫d_sf
(*
m_å
++, 
DQ_BITS_8
));

43 *
m_ªc
++ = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, (*
m_¥d
++Ë+ 
	`rshi·_∫d_sf
(*
m_å
++, 
DQ_BITS_8
));

44 *
m_ªc
++ = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, (*
m_¥d
++Ë+ 
	`rshi·_∫d_sf
(*
m_å
++, 
DQ_BITS_8
));

45 *
m_ªc
++ = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, (*
m_¥d
++Ë+ 
	`rshi·_∫d_sf
(*
m_å
++, 
DQ_BITS_8
));

46 *
m_ªc
++ = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, (*
m_¥d
++Ë+ 
	`rshi·_∫d_sf
(*
m_å
++, 
DQ_BITS_8
));

47 *
m_ªc
++ = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, (*
m_¥d
++Ë+ 
	`rshi·_∫d_sf
(*
m_å
++, 
DQ_BITS_8
));

48 *
m_ªc
 = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, (*
m_¥d
 ) + 
	`rshi·_∫d_sf
(*
m_å
 , 
DQ_BITS_8
));

50 
	}
}

52 
	$c›y8x8
(
img≥l
 **
mb_ªc
, img≥»**
m¥
, 
ioff
)

54 
j
;

56  
j
 = 0; j < 8; j++)

58 
	`mem˝y
((*
mb_ªc
++Ë+ 
ioff
, (*
m¥
++Ë+ ioff, 8 * (
img≥l
));

60 
	}
}

62 
	$ªc⁄8x8_los¶ess
(**
m7
, 
img≥l
 **
mb_ªc
, img≥»**
m¥
, 
max_img≥l_vÆue
, 
ioff
)

64 
i
, 
j
;

65  
j
 = 0; j < 8; j++)

67  
i
 = 
ioff
; i < ioff + 8; i++)

68 (*
mb_ªc
)[
i
] = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((*
m7
)[i] + ()(*
m¥
)[i]));

69 
mb_ªc
++;

70 
m7
++;

71 
m¥
++;

73 
	}
}

81 
	$ôøns8x8
(
Ma¸oblock
 *
cuºMB
,

82 
Cﬁ‹Pœ√
 
∂
,

83 
ioff
,

84 
joff
)

86 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

88 **
m7
 = 
cuºSli˚
->
mb_ºes
[
∂
];

90 i‡(
cuºMB
->
is_los¶ess
 =
TRUE
)

92 
	`ªc⁄8x8_los¶ess
(&
m7
[
joff
], &
cuºSli˚
->
mb_ªc
[
∂
][joff], &cuºSli˚->
mb_¥ed
[∂][joff], 
cuºMB
->
p_Vid
->
max_≥l_vÆue_comp
[∂], 
ioff
);

96 
	`övî£8x8
(&
m7
[
joff
], &m7[joff], 
ioff
);

97 
	`ªc⁄8x8
 (&
m7
[
joff
], &
cuºSli˚
->
mb_ªc
[
∂
][joff], &cuºSli˚->
mb_¥ed
[∂][joff], 
cuºMB
->
p_Vid
->
max_≥l_vÆue_comp
[∂], 
ioff
);

99 
	}
}

107 
	$ic›y8x8
(
Ma¸oblock
 *
cuºMB
,

108 
Cﬁ‹Pœ√
 
∂
,

109 
ioff
,

110 
joff
)

112 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

114 
	`c›y8x8
 (&
cuºSli˚
->
mb_ªc
[
∂
][
joff
], &cuºSli˚->
mb_¥ed
[∂][joff], 
ioff
);

115 
	}
}

	@ldecod/src/vlc.c

15 
	~"c⁄åibut‹s.h
"

17 
	~"globÆ.h
"

18 
	~"vlc.h
"

19 
	~"ñemíts.h
"

23 #i‡
TRACE


24 
	#SYMTRACESTRING
(
s
Ë
	`°∫˝y
(
symbﬁ
.
åa˚°rög
,s,
TRACESTRING_SIZE
)

	)

26 
	#SYMTRACESTRING
(
s
)

28 

	)

48 
	$ªad_ue_v
 (*
åa˚°rög
, 
Bô°ªam
 *
bô°ªam
, *
u£d_bôs
)

50 
Sy¡axEÀmít
 
symbﬁ
;

53 
symbﬁ
.
ty≥
 = 
SE_HEADER
;

54 
symbﬁ
.
m≠pög
 = 
löfo_ue
;

55 
	`SYMTRACESTRING
(
åa˚°rög
);

56 
	`ªadSy¡axEÀmít_VLC
 (&
symbﬁ
, 
bô°ªam
);

57 *
u£d_bôs
+=
symbﬁ
.
Àn
;

58  
symbﬁ
.
vÆue1
;

59 
	}
}

79 
	$ªad_£_v
 (*
åa˚°rög
, 
Bô°ªam
 *
bô°ªam
, *
u£d_bôs
)

81 
Sy¡axEÀmít
 
symbﬁ
;

84 
symbﬁ
.
ty≥
 = 
SE_HEADER
;

85 
symbﬁ
.
m≠pög
 = 
löfo_£
;

86 
	`SYMTRACESTRING
(
åa˚°rög
);

87 
	`ªadSy¡axEÀmít_VLC
 (&
symbﬁ
, 
bô°ªam
);

88 *
u£d_bôs
+=
symbﬁ
.
Àn
;

89  
symbﬁ
.
vÆue1
;

90 
	}
}

113 
	$ªad_u_v
 (
LíInBôs
, *
åa˚°rög
, 
Bô°ªam
 *
bô°ªam
, *
u£d_bôs
)

115 
Sy¡axEÀmít
 
symbﬁ
;

116 
symbﬁ
.
öf
 = 0;

119 
symbﬁ
.
ty≥
 = 
SE_HEADER
;

120 
symbﬁ
.
m≠pög
 = 
löfo_ue
;

121 
symbﬁ
.
Àn
 = 
LíInBôs
;

122 
	`SYMTRACESTRING
(
åa˚°rög
);

123 
	`ªadSy¡axEÀmít_FLC
 (&
symbﬁ
, 
bô°ªam
);

124 *
u£d_bôs
+=
symbﬁ
.
Àn
;

126  
symbﬁ
.
öf
;

127 
	}
}

149 
	$ªad_i_v
 (
LíInBôs
, *
åa˚°rög
, 
Bô°ªam
 *
bô°ªam
, *
u£d_bôs
)

151 
Sy¡axEÀmít
 
symbﬁ
;

152 
symbﬁ
.
öf
 = 0;

155 
symbﬁ
.
ty≥
 = 
SE_HEADER
;

156 
symbﬁ
.
m≠pög
 = 
löfo_ue
;

157 
symbﬁ
.
Àn
 = 
LíInBôs
;

158 
	`SYMTRACESTRING
(
åa˚°rög
);

159 
	`ªadSy¡axEÀmít_FLC
 (&
symbﬁ
, 
bô°ªam
);

160 *
u£d_bôs
+=
symbﬁ
.
Àn
;

163 
symbﬁ
.
öf
 = -–symbﬁ.ö‡& (1 << (
LíInBôs
 - 1)) ) | symbol.inf;

165  
symbﬁ
.
öf
;

166 
	}
}

186 
Boﬁón
 
	$ªad_u_1
 (*
åa˚°rög
, 
Bô°ªam
 *
bô°ªam
, *
u£d_bôs
)

188  (
Boﬁón
Ë
	`ªad_u_v
 (1, 
åa˚°rög
, 
bô°ªam
, 
u£d_bôs
);

189 
	}
}

203 
	$löfo_ue
(
Àn
, 
öfo
, *
vÆue1
, *
dummy
)

206 *
vÆue1
 = (Ë(((Ë1 << (
Àn
 >> 1)Ë+ (Ë(
öfo
) - 1);

207 
	}
}

219 
	$löfo_£
(
Àn
, 
öfo
, *
vÆue1
, *
dummy
)

222 
n
 = ((Ë1 << (
Àn
 >> 1)Ë+ (Ë
öfo
 - 1;

223 *
vÆue1
 = (
n
 + 1) >> 1;

224 if((
n
 & 0x01) == 0)

225 *
vÆue1
 = -*value1;

226 
	}
}

237 
	$löfo_cbp_öåa_n‹mÆ
(
Àn
,
öfo
,*
cbp
, *
dummy
)

239 
cbp_idx
;

241 
	`löfo_ue
(
Àn
, 
öfo
, &
cbp_idx
, 
dummy
);

242 *
cbp
=
NCBP
[1][
cbp_idx
][0];

243 
	}
}

254 
	$löfo_cbp_öåa_Ÿhî
(
Àn
,
öfo
,*
cbp
, *
dummy
)

256 
cbp_idx
;

258 
	`löfo_ue
(
Àn
, 
öfo
, &
cbp_idx
, 
dummy
);

259 *
cbp
=
NCBP
[0][
cbp_idx
][0];

260 
	}
}

270 
	$löfo_cbp_öãr_n‹mÆ
(
Àn
,
öfo
,*
cbp
, *
dummy
)

272 
cbp_idx
;

274 
	`löfo_ue
(
Àn
, 
öfo
, &
cbp_idx
, 
dummy
);

275 *
cbp
=
NCBP
[1][
cbp_idx
][1];

276 
	}
}

286 
	$löfo_cbp_öãr_Ÿhî
(
Àn
,
öfo
,*
cbp
, *
dummy
)

288 
cbp_idx
;

290 
	`löfo_ue
(
Àn
, 
öfo
, &
cbp_idx
, 
dummy
);

291 *
cbp
=
NCBP
[0][
cbp_idx
][1];

292 
	}
}

302 
	$löfo_Àvrun_öãr
(
Àn
, 
öfo
, *
Àvñ
, *
úun
)

306 i‡(
Àn
 <= 9)

308 
l2
 = 
	`imax
(0,(
Àn
 >> 1)-1);

309 
öf
 = 
öfo
 >> 1;

311 *
Àvñ
 = 
NTAB1
[
l2
][
öf
][0];

312 *
úun
 = 
NTAB1
[
l2
][
öf
][1];

313 i‡((
öfo
 & 0x01) == 1)

314 *
Àvñ
 = -*level;

318 *
úun
 = (
öfo
 & 0x1e) >> 1;

319 *
Àvñ
 = 
LEVRUN1
[*
úun
] + (
öfo
 >> 5Ë+ ( 1 << ((
Àn
 >> 1) - 5));

320 i‡((
öfo
 & 0x01) == 1)

321 *
Àvñ
 = -*level;

324 i‡(
Àn
 == 1)

325 *
Àvñ
 = 0;

326 
	}
}

337 
	$löfo_Àvrun_c2x2
(
Àn
, 
öfo
, *
Àvñ
, *
úun
)

339 i‡(
Àn
<=5)

341 
l2
 = 
	`imax
(0, (
Àn
 >> 1) - 1);

342 
öf
 = 
öfo
 >> 1;

343 *
Àvñ
 = 
NTAB3
[
l2
][
öf
][0];

344 *
úun
 = 
NTAB3
[
l2
][
öf
][1];

345 i‡((
öfo
 & 0x01) == 1)

346 *
Àvñ
 = -*level;

350 *
úun
 = (
öfo
 & 0x06) >> 1;

351 *
Àvñ
 = 
LEVRUN3
[*
úun
] + (
öfo
 >> 3Ë+ (1 << ((
Àn
 >> 1) - 3));

352 i‡((
öfo
 & 0x01) == 1)

353 *
Àvñ
 = -*level;

356 i‡(
Àn
 == 1)

357 *
Àvñ
 = 0;

358 
	}
}

367 
	$ªadSy¡axEÀmít_VLC
(
Sy¡axEÀmít
 *
sym
, 
Bô°ªam
 *
cuºSåóm
)

370 
sym
->
Àn
 = 
	`GëVLCSymbﬁ
 (
cuºSåóm
->
°ªamBuf„r
, cuºSåóm->
‰ame_bôoff£t
, &(sym->
öf
), cuºSåóm->
bô°ªam_Àngth
);

371 i‡(
sym
->
Àn
 == -1)

374 
cuºSåóm
->
‰ame_bôoff£t
 +
sym
->
Àn
;

375 
sym
->
	`m≠pög
(sym->
Àn
, sym->
öf
, &(sym->
vÆue1
), &(sym->
vÆue2
));

377 #i‡
TRACE


378 
	`åa˚bôs
(
sym
->
åa˚°rög
, sym->
Àn
, sym->
öf
, sym->
vÆue1
);

382 
	}
}

392 
	$ªadSy¡axEÀmít_UVLC
(
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
sym
, 
d©≠¨tôi⁄_dec
 *
dP
)

394  (
	`ªadSy¡axEÀmít_VLC
(
sym
, 
dP
->
bô°ªam
));

395 
	}
}

404 
	$ªadSy¡axEÀmít_I¡ø4x4Pªdi˘i⁄Mode
(
Sy¡axEÀmít
 *
sym
, 
Bô°ªam
 *
cuºSåóm
)

406 
sym
->
Àn
 = 
	`GëVLCSymbﬁ_I¡øMode
 (
cuºSåóm
->
°ªamBuf„r
, cuºSåóm->
‰ame_bôoff£t
, &(sym->
öf
), cuºSåóm->
bô°ªam_Àngth
);

408 i‡(
sym
->
Àn
 == -1)

411 
cuºSåóm
->
‰ame_bôoff£t
 +
sym
->
Àn
;

412 
sym
->
vÆue1
 = (sym->
Àn
 =1Ë? -1 : sym->
öf
;

414 #i‡
TRACE


415 
	`åa˚bôs2
(
sym
->
åa˚°rög
, sym->
Àn
, sym->
vÆue1
);

419 
	}
}

421 
	$GëVLCSymbﬁ_I¡øMode
 (
byã
 
buf„r
[],
tŸbôoff£t
,*
öfo
, 
byãcou¡
)

423 
byãoff£t
 = (
tŸbôoff£t
 >> 3);

424 
bôoff£t
 = (7 - (
tŸbôoff£t
 & 0x07));

425 
byã
 *
cur_byã
 = &(
buf„r
[
byãoff£t
]);

426 
˘r_bô
 = (*
cur_byã
 & (0x01 << 
bôoff£t
));

429 i‡(
˘r_bô
)

431 *
öfo
 = 0;

435 i‡(
byãoff£t
 >
byãcou¡
)

441 
öf
 = (*(
cur_byã
) << 8) + *(cur_byte + 1);

442 
öf
 <<((
byã
Ë* 8Ë- 
bôoff£t
;

443 
öf
 = inf & 0xFFFF;

444 
öf
 >>((
byã
) * 8) * 2 - 3;

446 *
öfo
 = 
öf
;

449 
	}
}

467 
	$m‹e_rb•_d©a
 (
byã
 
buf„r
[],
tŸbôoff£t
,
byãcou¡
)

469 
byãoff£t
 = (
tŸbôoff£t
 >> 3);

471 i‡(
byãoff£t
 < (
byãcou¡
 - 1))

472  
TRUE
;

475 
bôoff£t
 = (7 - (
tŸbôoff£t
 & 0x07));

476 
byã
 *
cur_byã
 = &(
buf„r
[
byãoff£t
]);

478 
˘r_bô
 = cå_bô = ((*
cur_byã
)>> (
bôoff£t
--)) & 0x01;

483 i‡(
˘r_bô
==0)

484  
TRUE
;

487 
˙t
 = 0;

489 
bôoff£t
>=0 && !
˙t
)

491 
˙t
 |((*
cur_byã
)>> (
bôoff£t
--)) & 0x01;

494  (
˙t
);

497 
	}
}

506 
	$uvlc_°¨tcode_fﬁlows
(
Sli˚
 *
cuºSli˚
, 
dummy
)

508 
byã
 
dp_Nr
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
dp_mode
][
SE_MBTYPE
];

509 
D©aP¨tôi⁄
 *
dP
 = &(
cuºSli˚
->
∑πAº
[
dp_Nr
]);

510 
Bô°ªam
 *
cuºSåóm
 = 
dP
->
bô°ªam
;

511 
byã
 *
buf
 = 
cuºSåóm
->
°ªamBuf„r
;

513  (!(
	`m‹e_rb•_d©a
(
buf
, 
cuºSåóm
->
‰ame_bôoff£t
,cuºSåóm->
bô°ªam_Àngth
)));

514 
	}
}

535 
	$GëVLCSymbﬁ
 (
byã
 
buf„r
[],
tŸbôoff£t
,*
öfo
, 
byãcou¡
)

537 
byãoff£t
 = (
tŸbôoff£t
 >> 3);

538 
bôoff£t
 = (7 - (
tŸbôoff£t
 & 0x07));

539 
bôcou¡î
 = 1;

540 
Àn
 = 0;

541 
byã
 *
cur_byã
 = &(
buf„r
[
byãoff£t
]);

542 
˘r_bô
 = ((*
cur_byã
Ë>> (
bôoff£t
)) & 0x01;

544 
˘r_bô
 == 0)

546 
Àn
++;

547 
bôcou¡î
++;

548 
bôoff£t
--;

549 
bôoff£t
 &= 0x07;

550 
cur_byã
 +(
bôoff£t
 == 7);

551 
byãoff£t
+(
bôoff£t
 == 7);

552 
˘r_bô
 = ((*
cur_byã
Ë>> (
bôoff£t
)) & 0x01;

555 i‡(
byãoff£t
 + ((
Àn
 + 7Ë>> 3Ë> 
byãcou¡
)

560 
öf
 = 0;

562 
Àn
--)

564 
bôoff£t
 --;

565 
bôoff£t
 &= 0x07;

566 
cur_byã
 +(
bôoff£t
 == 7);

567 
bôcou¡î
++;

568 
öf
 <<= 1;

569 
öf
 |((*
cur_byã
Ë>> (
bôoff£t
)) & 0x01;

572 *
öfo
 = 
öf
;

573  
bôcou¡î
;

575 
	}
}

592 
ölöe
 
	$ShowBôsThªs
 (
öf
, 
numbôs
)

594  ((
öf
Ë>> (((
byã
Ë* 24Ë- (
numbôs
)));

608 
	}
}

618 
	$code_‰om_bô°ªam_2d
(
Sy¡axEÀmít
 *
sym
,

619 
Bô°ªam
 *
cuºSåóm
,

620 c⁄° 
byã
 *
À¡ab
,

621 c⁄° 
byã
 *
codèb
,

622 
èbwidth
,

623 
èbheight
,

624 *
code
)

626 
i
, 
j
;

627 c⁄° 
byã
 *
Àn
 = &
À¡ab
[0], *
cod
 = &
codèb
[0];

629 *
‰ame_bôoff£t
 = &
cuºSåóm
->frame_bitoffset;

630 
byã
 *
buf
 = &
cuºSåóm
->
°ªamBuf„r
[*
‰ame_bôoff£t
 >> 3];

633 
öf
 = ((*
buf
) << 16) + (*(buf + 1) << 8) + *(buf + 2);

634 
öf
 <<(*
‰ame_bôoff£t
 & 0x07);

635 
öf
 &= 0xFFFFFF;

638 
j
 = 0; j < 
èbheight
; j++)

640 
i
 = 0; i < 
èbwidth
; i++)

642 i‡((*
Àn
 =0Ë|| (
	`ShowBôsThªs
(
öf
, (Ë*ÀnË!*
cod
))

644 ++
Àn
;

645 ++
cod
;

649 
sym
->
Àn
 = *len;

650 *
‰ame_bôoff£t
 +*
Àn
;

651 *
code
 = *
cod
;

652 
sym
->
vÆue1
 = 
i
;

653 
sym
->
vÆue2
 = 
j
;

659 
	}
}

668 
	$ªadSy¡axEÀmít_FLC
(
Sy¡axEÀmít
 *
sym
, 
Bô°ªam
 *
cuºSåóm
)

670 
Bô°ªamLígthInBôs
 = (
cuºSåóm
->
bô°ªam_Àngth
 << 3) + 7;

672 i‡((
	`GëBôs
(
cuºSåóm
->
°ªamBuf„r
, cuºSåóm->
‰ame_bôoff£t
, &(
sym
->
öf
), 
Bô°ªamLígthInBôs
, sym->
Àn
)) < 0)

675 
sym
->
vÆue1
 = sym->
öf
;

676 
cuºSåóm
->
‰ame_bôoff£t
 +
sym
->
Àn
;

678 #i‡
TRACE


679 
	`åa˚bôs2
(
sym
->
åa˚°rög
, sym->
Àn
, sym->
öf
);

683 
	}
}

694 
	$ªadSy¡axEÀmít_NumC€ffTøûögO√s
(
Sy¡axEÀmít
 *
sym
,

695 
Bô°ªam
 *
cuºSåóm
,

696 *
ty≥
)

698 
‰ame_bôoff£t
 = 
cuºSåóm
->frame_bitoffset;

699 
Bô°ªamLígthInByãs
 = 
cuºSåóm
->
bô°ªam_Àngth
;

700 
Bô°ªamLígthInBôs
 = (
Bô°ªamLígthInByãs
 << 3) + 7;

701 
byã
 *
buf
 = 
cuºSåóm
->
°ªamBuf„r
;

703 c⁄° 
byã
 
À¡ab
[3][4][17] =

725 c⁄° 
byã
 
codèb
[3][4][17] =

747 
ªtvÆ
 = 0, 
code
;

748 
vl˙um
 = 
sym
->
vÆue1
;

752 i‡(
vl˙um
 == 3)

756 
code
 = 
	`ShowBôs
(
buf
, 
‰ame_bôoff£t
, 
Bô°ªamLígthInBôs
, 6);

757 
cuºSåóm
->
‰ame_bôoff£t
 += 6;

758 
sym
->
vÆue2
 = (
code
 & 3);

759 
sym
->
vÆue1
 = (
code
 >> 2);

761 i‡(!
sym
->
vÆue1
 && sym->
vÆue2
 == 3)

764 
sym
->
vÆue2
 = 0;

767 
sym
->
vÆue1
++;

769 
sym
->
Àn
 = 6;

774 
ªtvÆ
 = 
	`code_‰om_bô°ªam_2d
(
sym
, 
cuºSåóm
, 
À¡ab
[
vl˙um
][0], 
codèb
[vl˙um][0], 17, 4, &
code
);

775 i‡(
ªtvÆ
)

777 
	`¥ötf
("ERROR: failedÅo find NumCoeff/TrailingOnes\n");

778 
	`exô
(-1);

782 #i‡
TRACE


783 
	`¢¥ötf
(
sym
->
åa˚°rög
, 
TRACESTRING_SIZE
, "%s # c &År.1s vlc=%d #c=%d #t1=%d",

784 
ty≥
, 
vl˙um
, 
sym
->
vÆue1
, sym->
vÆue2
);

785 
	`åa˚bôs2
(
sym
->
åa˚°rög
, sym->
Àn
, 
code
);

788  
ªtvÆ
;

789 
	}
}

798 
	$ªadSy¡axEÀmít_NumC€ffTøûögO√sChromaDC
(
VideoP¨amëîs
 *
p_Vid
, 
Sy¡axEÀmít
 *
sym
, 
Bô°ªam
 *
cuºSåóm
)

800 c⁄° 
byã
 
À¡ab
[3][4][17] =

819 c⁄° 
byã
 
codèb
[3][4][17] =

839 
code
;

840 
yuv
 = 
p_Vid
->
a˘ive_•s
->
chroma_f‹m©_idc
 - 1;

841 
ªtvÆ
 = 
	`code_‰om_bô°ªam_2d
(
sym
, 
cuºSåóm
, &
À¡ab
[
yuv
][0][0], &
codèb
[yuv][0][0], 17, 4, &
code
);

843 i‡(
ªtvÆ
)

845 
	`¥ötf
("ERROR: failedÅo find NumCoeff/TrailingOnes ChromaDC\n");

846 
	`exô
(-1);

849 #i‡
TRACE


850 
	`¢¥ötf
(
sym
->
åa˚°rög
, 
TRACESTRING_SIZE
, "ChrDC # c &År.1s #c=%d #t1=%d",

851 
sym
->
vÆue1
, sym->
vÆue2
);

852 
	`åa˚bôs2
(
sym
->
åa˚°rög
, sym->
Àn
, 
code
);

856  
ªtvÆ
;

857 
	}
}

865 
	$ªadSy¡axEÀmít_Levñ_VLC0
(
Sy¡axEÀmít
 *
sym
, 
Bô°ªam
 *
cuºSåóm
)

867 
‰ame_bôoff£t
 = 
cuºSåóm
->frame_bitoffset;

868 
Bô°ªamLígthInByãs
 = 
cuºSåóm
->
bô°ªam_Àngth
;

869 
Bô°ªamLígthInBôs
 = (
Bô°ªamLígthInByãs
 << 3) + 7;

870 
byã
 *
buf
 = 
cuºSåóm
->
°ªamBuf„r
;

871 
Àn
 = 1, 
sign
 = 0, 
Àvñ
 = 0, 
code
 = 1;

873 !
	`ShowBôs
(
buf
, 
‰ame_bôoff£t
++, 
Bô°ªamLígthInBôs
, 1))

874 
Àn
++;

876 i‡(
Àn
 < 15)

878 
sign
 = (
Àn
 - 1) & 1;

879 
Àvñ
 = ((
Àn
 - 1) >> 1) + 1;

881 i‡(
Àn
 == 15)

884 
code
 <<= 4;

885 
code
 |
	`ShowBôs
(
buf
, 
‰ame_bôoff£t
, 
Bô°ªamLígthInBôs
, 4);

886 
Àn
 += 4;

887 
‰ame_bôoff£t
 += 4;

888 
sign
 = (
code
 & 0x01);

889 
Àvñ
 = ((
code
 >> 1) & 0x07) + 8;

891 i‡(
Àn
 >= 16)

894 
addbô
 = (
Àn
 - 16);

895 
off£t
 = (2048 << 
addbô
) - 2032;

896 
Àn
 -= 4;

897 
code
 = 
	`ShowBôs
(
buf
, 
‰ame_bôoff£t
, 
Bô°ªamLígthInBôs
, 
Àn
);

898 
sign
 = (
code
 & 0x01);

899 
‰ame_bôoff£t
 +
Àn
;

900 
Àvñ
 = (
code
 >> 1Ë+ 
off£t
;

902 
code
 |(1 << (
Àn
));

903 
Àn
 +
addbô
 + 16;

906 
sym
->
öf
 = (
sign
Ë? -
Àvñ
 :Üevel ;

907 
sym
->
Àn
 =Üen;

909 #i‡
TRACE


910 
	`åa˚bôs2
(
sym
->
åa˚°rög
, sym->
Àn
, 
code
);

913 
cuºSåóm
->
‰ame_bôoff£t
 = frame_bitoffset;

915 
	}
}

923 
	$ªadSy¡axEÀmít_Levñ_VLCN
(
Sy¡axEÀmít
 *
sym
, 
vlc
, 
Bô°ªam
 *
cuºSåóm
)

925 
‰ame_bôoff£t
 = 
cuºSåóm
->frame_bitoffset;

926 
Bô°ªamLígthInByãs
 = 
cuºSåóm
->
bô°ªam_Àngth
;

927 
Bô°ªamLígthInBôs
 = (
Bô°ªamLígthInByãs
 << 3) + 7;

928 
byã
 *
buf
 = 
cuºSåóm
->
°ªamBuf„r
;

930 
Àvabs
, 
sign
;

931 
Àn
 = 1;

932 
code
 = 1, 
sb
;

934 
shi·
 = 
vlc
 - 1;

937 !
	`ShowBôs
(
buf
, 
‰ame_bôoff£t
 ++, 
Bô°ªamLígthInBôs
, 1))

938 
Àn
++;

940 
‰ame_bôoff£t
 -
Àn
;

942 i‡(
Àn
 < 16)

944 
Àvabs
 = ((
Àn
 - 1Ë<< 
shi·
) + 1;

947 i‡(
shi·
)

949 
sb
 = 
	`ShowBôs
(
buf
, 
‰ame_bôoff£t
 + 
Àn
, 
Bô°ªamLígthInBôs
, 
shi·
);

950 
code
 = (codê<< (
shi·
Ë)| 
sb
;

951 
Àvabs
 +
sb
;

952 
Àn
 +(
shi·
);

956 
sign
 = 
	`ShowBôs
(
buf
, 
‰ame_bôoff£t
 + 
Àn
, 
Bô°ªamLígthInBôs
, 1);

957 
code
 = (codê<< 1)| 
sign
;

958 
Àn
 ++;

962 
addbô
 = 
Àn
 - 5;

963 
off£t
 = (1 << 
addbô
Ë+ (15 << 
shi·
) - 2047;

965 
sb
 = 
	`ShowBôs
(
buf
, 
‰ame_bôoff£t
 + 
Àn
, 
Bô°ªamLígthInBôs
, 
addbô
);

966 
code
 = (codê<< 
addbô
 ) | 
sb
;

967 
Àn
 +
addbô
;

969 
Àvabs
 = 
sb
 + 
off£t
;

972 
sign
 = 
	`ShowBôs
(
buf
, 
‰ame_bôoff£t
 + 
Àn
, 
Bô°ªamLígthInBôs
, 1);

974 
code
 = (codê<< 1)| 
sign
;

976 
Àn
++;

979 
sym
->
öf
 = (
sign
)? -
Àvabs
 :Üevabs;

980 
sym
->
Àn
 =Üen;

982 
cuºSåóm
->
‰ame_bôoff£t
 = føme_bôoff£à+ 
Àn
;

984 #i‡
TRACE


985 
	`åa˚bôs2
(
sym
->
åa˚°rög
, sym->
Àn
, 
code
);

989 
	}
}

997 
	$ªadSy¡axEÀmít_TŸÆZîos
(
Sy¡axEÀmít
 *
sym
, 
Bô°ªam
 *
cuºSåóm
)

999 c⁄° 
byã
 
À¡ab
[
TOTRUN_NUM
][16] =

1019 c⁄° 
byã
 
codèb
[
TOTRUN_NUM
][16] =

1038 
code
;

1039 
vl˙um
 = 
sym
->
vÆue1
;

1040 
ªtvÆ
 = 
	`code_‰om_bô°ªam_2d
(
sym
, 
cuºSåóm
, &
À¡ab
[
vl˙um
][0], &
codèb
[vl˙um][0], 16, 1, &
code
);

1042 i‡(
ªtvÆ
)

1044 
	`¥ötf
("ERROR: failedÅo find Total Zeros !cdc\n");

1045 
	`exô
(-1);

1048 #i‡
TRACE


1049 
	`åa˚bôs2
(
sym
->
åa˚°rög
, sym->
Àn
, 
code
);

1052  
ªtvÆ
;

1053 
	}
}

1061 
	$ªadSy¡axEÀmít_TŸÆZîosChromaDC
(
VideoP¨amëîs
 *
p_Vid
, 
Sy¡axEÀmít
 *
sym
, 
Bô°ªam
 *
cuºSåóm
)

1063 c⁄° 
byã
 
À¡ab
[3][
TOTRUN_NUM
][16] =

1095 c⁄° 
byã
 
codèb
[3][
TOTRUN_NUM
][16] =

1127 
code
;

1128 
yuv
 = 
p_Vid
->
a˘ive_•s
->
chroma_f‹m©_idc
 - 1;

1129 
vl˙um
 = 
sym
->
vÆue1
;

1130 
ªtvÆ
 = 
	`code_‰om_bô°ªam_2d
(
sym
, 
cuºSåóm
, &
À¡ab
[
yuv
][
vl˙um
][0], &
codèb
[yuv][vl˙um][0], 16, 1, &
code
);

1132 i‡(
ªtvÆ
)

1134 
	`¥ötf
("ERROR: failedÅo find Total Zeros\n");

1135 
	`exô
(-1);

1138 #i‡
TRACE


1139 
	`åa˚bôs2
(
sym
->
åa˚°rög
, sym->
Àn
, 
code
);

1142  
ªtvÆ
;

1143 
	}
}

1152 
	$ªadSy¡axEÀmít_Run
(
Sy¡axEÀmít
 *
sym
, 
Bô°ªam
 *
cuºSåóm
)

1154 c⁄° 
byã
 
À¡ab
[
TOTRUN_NUM
][16] =

1165 c⁄° 
byã
 
codèb
[
TOTRUN_NUM
][16] =

1175 
code
;

1176 
vl˙um
 = 
sym
->
vÆue1
;

1177 
ªtvÆ
 = 
	`code_‰om_bô°ªam_2d
(
sym
, 
cuºSåóm
, &
À¡ab
[
vl˙um
][0], &
codèb
[vl˙um][0], 16, 1, &
code
);

1179 i‡(
ªtvÆ
)

1181 
	`¥ötf
("ERROR: failedÅo find Run\n");

1182 
	`exô
(-1);

1185 #i‡
TRACE


1186 
	`åa˚bôs2
(
sym
->
åa˚°rög
, sym->
Àn
, 
code
);

1189  
ªtvÆ
;

1190 
	}
}

1211 
	$GëBôs
 (
byã
 
buf„r
[],
tŸbôoff£t
,*
öfo
, 
bôcou¡
,

1212 
numbôs
)

1214 i‡((
tŸbôoff£t
 + 
numbôs
 ) > 
bôcou¡
)

1220 
bôoff£t
 = 7 - (
tŸbôoff£t
 & 0x07);

1221 
byãoff£t
 = (
tŸbôoff£t
 >> 3);

1222 
bôcou¡î
 = 
numbôs
;

1223 
byã
 *
curbyã
 = &(
buf„r
[
byãoff£t
]);

1224 
öf
 = 0;

1226 
numbôs
--)

1228 
öf
 <<=1;

1229 
öf
 |((*
curbyã
)>> (
bôoff£t
--)) & 0x01;

1230 i‡(
bôoff£t
 == -1 )

1232 
curbyã
++;

1233 
bôoff£t
 = 7;

1239 *
öfo
 = 
öf
;

1241  
bôcou¡î
;

1243 
	}
}

1262 
	$ShowBôs
 (
byã
 
buf„r
[],
tŸbôoff£t
,
bôcou¡
, 
numbôs
)

1264 i‡((
tŸbôoff£t
 + 
numbôs
 ) > 
bôcou¡
)

1270 
bôoff£t
 = 7 - (
tŸbôoff£t
 & 0x07);

1271 
byãoff£t
 = (
tŸbôoff£t
 >> 3);

1272 
byã
 *
curbyã
 = &(
buf„r
[
byãoff£t
]);

1273 
öf
 = 0;

1275 
numbôs
--)

1277 
öf
 <<=1;

1278 
öf
 |((*
curbyã
)>> (
bôoff£t
--)) & 0x01;

1280 i‡(
bôoff£t
 == -1 )

1282 
curbyã
++;

1283 
bôoff£t
 = 7;

1286  
öf
;

1288 
	}
}

	@lencod/inc/annexb.h

15 #i‚de‡
_ANNEXB_H_


16 
	#_ANNEXB_H_


	)

18 
	~"«lucomm⁄.h
"

20 
WrôeA¬exbNALU
 (
VideoP¨amëîs
 *
p_Vid
, 
NALU_t
 *
n
, 
FILE
 **
f_™√xb
);

21 
O≥nA¬exbFûe
 (*
‚
, 
FILE
 **
f_™√xb
);

22 
Clo£A¬exbFûe
(
FILE
 *
f_™√xb
);

	@lencod/inc/biariencode.h

23 #i‚de‡
_BIARIENCOD_H_


24 
	#_BIARIENCOD_H_


	)

34 
	#B_BITS
 10

35 
	#BITS_TO_LOAD
 16

	)

36 
	#MAX_BITS
 26

37 
	#MASK_BITS
 18

38 
	#ONE
 0x04000000

39 
	#ONE_M1
 0x03FFFFFF

40 
	#HALF
 0x01FE

41 
	#QUARTER
 0x0100

42 
	#MIN_BITS_TO_GO
 0

	)

43 
	#B_LOAD_MASK
 0xFFFF

44 

	)

45 
gë_pic_bö_cou¡
(
VideoP¨amëîs
 *
p_Vid
);

46 
ª£t_pic_bö_cou¡
(
VideoP¨amëîs
 *
p_Vid
);

47 
£t_pic_bö_cou¡
 (
VideoP¨amëîs
 *
p_Vid
, 
EncodögEnvú⁄mítPå
 
ìp
);

49 
¨õnco_°¨t_ícodög
(
EncodögEnvú⁄mítPå
 
ìp
, *
code_buf„r
, *
code_Àn
);

50 
¨õnco_ª£t_EC
 (
EncodögEnvú⁄mítPå
 
ìp
);

51 
¨õnco_d⁄e_ícodög
 (
Ma¸oblock
 *
cuºMB
, 
EncodögEnvú⁄mítPå
 
ìp
);

52 
büri_öô_c⁄ãxt
 (
qp
, 
BiC⁄ãxtTy≥På
 
˘x
, c⁄° * 
öi
);

53 
büri_ícode_symbﬁ
 (
EncodögEnvú⁄mítPå
 
ìp
, 
symbﬁ
, 
BiC⁄ãxtTy≥På
 
bi_˘
 );

54 
büri_ícode_symbﬁ_eq_¥ob
(
EncodögEnvú⁄mítPå
 
ìp
, 
symbﬁ
);

55 
büri_ícode_symbﬁ_föÆ
(
EncodögEnvú⁄mítPå
 
ìp
, 
symbﬁ
);

63 
ölöe
 
	$¨õnco_bôs_wrôãn
(
EncodögEnvú⁄mítPå
 
ìp
)

65  (((*
ìp
->
Ecode°rm_Àn
Ë+Éï->
Epbuf
 + 1Ë<< 3Ë+ (ìp->
Echunks_out°™dög
 * 
BITS_TO_LOAD
Ë+ BITS_TO_LOAD -Éï->
Ebôs_to_go
;

66 
	}
}

	@lencod/inc/block.h

18 #i‚de‡
_BLOCK_H_


19 
	#_BLOCK_H_


	)

22 
	~"globÆ.h
"

24 
ªsiduÆ_å™sf‹m_qu™t_luma_4x4
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
block_x
,
block_y
, *
c€ff_co°
, 
öåa
);

26 c⁄° 
byã
 
	gQP_SCALE_CR
[52]=

33 c⁄° 
	gsubblk_off£t_x
[3][8][4] =

68 c⁄° 
	gsubblk_off£t_y
[3][8][4] =

	@lencod/inc/cabac.h

20 #i‚de‡
_CABAC_H_


21 
	#_CABAC_H_


	)

23 c⁄° 
byã
 
	gmaxpos
 [] = {15, 14, 63, 31, 31, 15, 3, 14, 7, 15, 15, 14, 63, 31, 31, 15, 15, 14, 63, 31, 31, 15};

24 c⁄° 
byã
 
	gc1isdc
 [] = { 1, 0, 1, 1, 1, 1, 1, 0, 1, 1, 1, 0, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1};

26 c⁄° 
byã
 
	gty≥2˘x_bcbp
[] = { 0, 1, 2, 3, 3, 4, 5, 6, 5, 5, 10, 11, 12, 13, 13, 14, 16, 17, 18, 19, 19, 20};

27 c⁄° 
byã
 
	gty≥2˘x_m≠
 [] = { 0, 1, 2, 3, 4, 5, 6, 7, 6, 6, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21};

28 c⁄° 
byã
 
	gty≥2˘x_œ°
[] = { 0, 1, 2, 3, 4, 5, 6, 7, 6, 6, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21};

29 c⁄° 
byã
 
	gty≥2˘x_⁄e
 [] = { 0, 1, 2, 3, 3, 4, 5, 6, 5, 5, 10, 11, 12, 13, 13, 14, 16, 17, 18, 19, 19, 20};

30 c⁄° 
byã
 
	gty≥2˘x_abs
 [] = { 0, 1, 2, 3, 3, 4, 5, 6, 5, 5, 10, 11, 12, 13, 13, 14, 16, 17, 18, 19, 19, 20};

31 c⁄° 
byã
 
	gmax_c2
 [] = { 4, 4, 4, 4, 4, 4, 3, 4, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4};

34 c⁄° 
byã
* 
pos2˘x_m≠
 [];

35 c⁄° 
byã
* 
pos2˘x_m≠_öt
 [];

36 c⁄° 
byã
* 
pos2˘x_œ°
 [];

39 
MŸi⁄InfoC⁄ãxts
* 
¸óã_c⁄ãxts_MŸi⁄Info
 ();

40 
TextuªInfoC⁄ãxts
* 
¸óã_c⁄ãxts_TextuªInfo
();

42 
dñëe_c⁄ãxts_MŸi⁄Info
 (
MŸi⁄InfoC⁄ãxts
 *
íco_˘x
);

43 
dñëe_c⁄ãxts_TextuªInfo
 (
TextuªInfoC⁄ãxts
 *
íco_˘x
);

44 
wrôeMB_I_ty≥Info_CABAC
 (
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
);

45 
wrôeMB_B_ty≥Info_CABAC
 (
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
);

46 
wrôeMB_P_ty≥Info_CABAC
 (
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
);

47 
wrôeI¡øPªdMode_CABAC
 (
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
);

48 
wrôeB8_ty≥Info_CABAC
 (
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
);

49 
wrôeB8_B_ty≥Info_CABAC
 (
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
);

51 
wrôeRefPic_B_CABAC
 (
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
);

52 
wrôeRefPic_P_CABAC
 (
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
);

54 
wrôeMVD_CABAC
 (
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
);

55 
wrôeCBP_CABAC
 (
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
);

56 
wrôeDqu™t_CABAC
 (
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
);

57 
wrôeRunLevñ_CABAC
 (
Ma¸oblock
* 
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
);

58 
wrôeCIPªdMode_CABAC
 (
Ma¸oblock
* 
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
);

59 
¥öt_˘x_TextuªInfo
 (
TextuªInfoC⁄ãxts
 *
íco_˘x
);

60 
wrôeMB_Pskù_ÊagInfo_CABAC
(
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
);

61 
wrôeMB_Bskù_ÊagInfo_CABAC
(
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
);

62 
wrôeFõldModeInfo_CABAC
 (
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
);

63 
wrôeCBP_BIT_CABAC
 (
Ma¸oblock
 *
cuºMB
, 
b8
, 
bô
, 
cbp
, 
EncodögEnvú⁄mítPå
 
ìp_dp
, 
TextuªInfoC⁄ãxts
 *
˘x
);

65 
CheckAvaûabûôyOfNeighb‹sCABAC
 (
Ma¸oblock
* 
cuºMB
);

66 
wrôeMB_å™sf‹m_size_CABAC
(
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
);

68 
wrôe_™d_°‹e_CBP_block_bô_444
 (
Ma¸oblock
* 
cuºMB
, 
EncodögEnvú⁄mítPå
 
ìp_dp
, 
ty≥
, 
cbp_bô
, 
TextuªInfoC⁄ãxts
* 
ãx_˘x
);

69 
wrôe_™d_°‹e_CBP_block_bô
 (
Ma¸oblock
* 
cuºMB
, 
EncodögEnvú⁄mítPå
 
ìp_dp
, 
ty≥
, 
cbp_bô
, 
TextuªInfoC⁄ãxts
* 
ãx_˘x
);

	@lencod/inc/cconv_yuv2rgb.h

17 #i‚de‡
_CCONV_YUV2RGB_H_


18 
	#_CCONV_YUV2RGB_H_


	)

20 
	~"img_di°‹ti⁄.h
"

22 
öô_YUVtoRGB
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
);

23 
YUVtoRGB
 (
VideoP¨amëîs
 *
p_Vid
, 
ImageSåu˘uª
 *
YUV
, ImageSåu˘uª *
RGB
);

24 
¸óã_RGB_mem‹y
(
VideoP¨amëîs
 *
p_Vid
);

25 
dñëe_RGB_mem‹y
(
VideoP¨amëîs
 *
p_Vid
);

	@lencod/inc/configfile.h

11 
	~"fmo.h
"

13 #i‚de‡
_CONFIGFILE_H_


14 
	#_CONFIGFILE_H_


	)

16 
	~"c⁄fig_comm⁄.h
"

18 
	#DEFAULTCONFIGFILENAME
 "ícodî.cfg"

	)

20 
	#PROFILE_IDC
 88

	)

21 
	#LEVEL_IDC
 21

	)

23 
I≈utP¨amëîs
 
	gcfg∑øms
;

26 #ifde‡
INCLUDED_BY_CONFIGFILE_C


32 
M≠pög
 
	gM≠
[] = {

33 {"ProfûeIDC", &
cfg∑øms
.
ProfûeIDC
, 0, (Ë
PROFILE_IDC
, 0, 0.0, 0.0, },

34 {"I¡øProfûe", &
cfg∑øms
.
I¡øProfûe
, 0, 0.0, 1, 0.0, 1.0, },

35 {"LevñIDC", &
cfg∑øms
.
LevñIDC
, 0, (Ë
LEVEL_IDC
, 0, 0.0, 0.0, },

36 {"FømeR©e", &
cfg∑øms
.
sour˚
.
‰ame_øã
, 2, (Ë
INIT_FRAME_RATE
, 1, 0.0, 480.0, },

37 {"E«bÀ32PuŒdown", &
cfg∑øms
.
íabÀ_32_puŒdown
, 0, 0.0, 1, 0.0, 2.0, },

38 {"Re£ndSPS", &
cfg∑øms
.
Re£ndSPS
, 0, 0.0, 1, 0.0, 3.0, },

39 {"SèπFøme", &
cfg∑øms
.
°¨t_‰ame
, 0, 0.0, 2, 0.0, 0.0, },

40 {"I¡øPîiod", &
cfg∑øms
.
öåa_≥riod
, 0, 0.0, 2, 0.0, 0.0, },

41 {"IDRPîiod", &
cfg∑øms
.
idr_≥riod
, 0, 0.0, 2, 0.0, 0.0, },

42 {"I¡øDñay", &
cfg∑øms
.
öåa_dñay
, 0, 0.0, 2, 0.0, 0.0, },

43 {"Ad≠tiveI¡øPîiod", &
cfg∑øms
.
ad≠tive_öåa_≥riod
, 0, 0.0, 1, 0.0, 1.0, },

44 {"Ad≠tiveIDRPîiod", &
cfg∑øms
.
ad≠tive_idr_≥riod
, 0, 0.0, 1, 0.0, 2.0, },

45 {"E«bÀO≥nGOP", &
cfg∑øms
.
E«bÀO≥nGOP
, 0, 0.0, 1, 0.0, 1.0, },

46 {"E«bÀIDRGOP", &
cfg∑øms
.
E«bÀIDRGOP
, 0, 0.0, 1, 0.0, 1.0, },

47 {"FømesToBeEncoded", &
cfg∑øms
.
no_‰ames
, 0, 1.0, 2, -1.0, 0.0, },

48 {"QPISli˚", &
cfg∑øms
.
qp
[
I_SLICE
], 0, 24.0, 3, (Ë
MIN_QP
, (Ë
MAX_QP
, },

49 {"QPPSli˚", &
cfg∑øms
.
qp
[
P_SLICE
], 0, 24.0, 3, (Ë
MIN_QP
, (Ë
MAX_QP
, },

50 {"QPBSli˚", &
cfg∑øms
.
qp
[
B_SLICE
], 0, 24.0, 3, (Ë
MIN_QP
, (Ë
MAX_QP
, },

51 {"QPSPSli˚", &
cfg∑øms
.
qp
[
SP_SLICE
], 0, 24.0, 3, (Ë
MIN_QP
, (Ë
MAX_QP
, },

52 {"QPSISli˚", &
cfg∑øms
.
qp
[
SI_SLICE
], 0, 24.0, 3, (Ë
MIN_QP
, (Ë
MAX_QP
, },

53 {"Ch™geQPFøme", &
cfg∑øms
.
qp2‰ame
, 0, 0.0, 2, 0.0, 0.0, },

54 {"Ch™geQPI", &
cfg∑øms
.
qp2off
[
I_SLICE
], 0, 0.0, 0, (Ë-
MAX_QP
, () MAX_QP, },

55 {"Ch™geQPP", &
cfg∑øms
.
qp2off
[
P_SLICE
], 0, 0.0, 0, (Ë-
MAX_QP
, () MAX_QP, },

56 {"Ch™geQPB", &
cfg∑øms
.
qp2off
[
B_SLICE
], 0, 0.0, 0, (Ë-
MAX_QP
, () MAX_QP, },

57 {"Ch™geQPSP", &
cfg∑øms
.
qp2off
[
SP_SLICE
], 0, 0.0, 0, (Ë-
MAX_QP
, () MAX_QP, },

58 {"Ch™geQPSI", &
cfg∑øms
.
qp2off
[
SI_SLICE
], 0, 0.0, 0, (Ë-
MAX_QP
, () MAX_QP, },

59 {"QPSP2Sli˚", &
cfg∑øms
.
qp•
, 0, 0.0, 3, (Ë
MIN_QP
, (Ë
MAX_QP
, },

60 {"FømeSkù", &
cfg∑øms
.
‰ame_skù
, 0, 0.0, 2, 0.0, 0.0, },

61 {"DißbÀSub≥lME", &
cfg∑øms
.
DißbÀSub≥lME
[0], 0, 0.0, 1, 0.0, 1.0, },

62 {"SórchR™ge", &
cfg∑øms
.
£¨ch_ønge
[0], 0, 16.0, 2, 0.0, 0.0, },

63 {"NumbîRe„ªn˚Fømes", &
cfg∑øms
.
num_ªf_‰ames
, 0, 1.0, 1, 0.0, 16.0, },

64 {"PLi°0Re„ªn˚s", &
cfg∑øms
.
P_Li°0_ªfs
[0], 0, 0.0, 1, 0.0, 16.0, },

65 {"BLi°0Re„ªn˚s", &
cfg∑øms
.
B_Li°0_ªfs
[0], 0, 0.0, 1, 0.0, 16.0, },

66 {"BLi°1Re„ªn˚s", &
cfg∑øms
.
B_Li°1_ªfs
[0], 0, 1.0, 1, 0.0, 16.0, },

67 {"NumbîOfVõws", &
cfg∑øms
.
num_of_võws
, 0, 1.0, 1, 1.0, 2.0, },

68 #i‡(
MVC_EXTENSION_ENABLE
)

69 {"Võw1C⁄figFûe", &
cfg∑øms
.
Võw1C⁄figName
, 1, 0.0, 0, 0.0, 0.0, 
FILE_NAME_SIZE
, },

71 {"Log2MaxFNumMöus4", &
cfg∑øms
.
Log2MaxFNumMöus4
, 0, 0.0, 1, -1.0, 12.0, },

72 {"Log2MaxPOCLsbMöus4", &
cfg∑øms
.
Log2MaxPOCLsbMöus4
, 0, 2.0, 1, -1.0, 12.0, },

73 {"Gíî©eMu…ùÀPPS", &
cfg∑øms
.
Gíî©eMu…ùÀPPS
, 0, 0.0, 1, 0.0, 1.0, },

74 {"Re£ndPPS", &
cfg∑øms
.
Re£ndPPS
, 0, 0.0, 1, 0.0, 1.0, },

75 {"SídAUD", &
cfg∑øms
.
SídAUD
, 0, 0.0, 1, 0.0, 3.0, },

76 {"Sour˚Width", &
cfg∑øms
.
sour˚
.
width
[0], 0, 176.0, 2, 0.0, 0.0, },

77 {"Sour˚Height", &
cfg∑øms
.
sour˚
.
height
[0], 0, 144.0, 2, 0.0, 0.0, },

78 {"Sour˚Resize", &
cfg∑øms
.
§c_ªsize
, 0, 0.0, 1, 0.0, 1.0, },

79 {"OuçutWidth", &
cfg∑øms
.
ouçut
.
width
[0], 0, 176.0, 2, 16.0, 0.0, },

80 {"OuçutHeight", &
cfg∑øms
.
ouçut
.
height
[0], 0, 144.0, 2, 16.0, 0.0, },

81 {"GøysˇÀ", &
cfg∑øms
.
gøysˇÀ
, 0, 0.0, 0, 0.0, 1.0, },

82 {"MbLöeI¡øUpd©e", &
cfg∑øms
.
öåa_upd
, 0, 0.0, 1, 0.0, 1.0, },

83 {"Sli˚Mode", &
cfg∑øms
.
¶i˚_mode
, 0, 0.0, 1, 0.0, 3.0, },

84 {"Sli˚Argumít", &
cfg∑øms
.
¶i˚_¨gumít
, 0, 1.0, 2, 1.0, 1.0, },

85 {"U£C⁄°øöedI¡øPªd", &
cfg∑øms
.
U£C⁄°øöedI¡øPªd
, 0, 0.0, 1, 0.0, 1.0, },

86 {"I≈utFûe", &
cfg∑øms
.
öput_fûe1
.
‚ame
, 1, 0.0, 0, 0.0, 0.0, 
FILE_NAME_SIZE
, },

87 {"I≈utHódîLígth", &
cfg∑øms
.
öfûe_hódî
, 0, 0.0, 2, 0.0, 1.0, },

88 {"OuçutFûe", &
cfg∑øms
.
outfûe
, 1, 0.0, 0, 0.0, 0.0, 
FILE_NAME_SIZE
, },

89 {"Rec⁄Fûe", &
cfg∑øms
.
Rec⁄Fûe
, 1, 0.0, 0, 0.0, 0.0, 
FILE_NAME_SIZE
, },

90 {"Tø˚Fûe", &
cfg∑øms
.
Tø˚Fûe
, 1, 0.0, 0, 0.0, 0.0, 
FILE_NAME_SIZE
, },

91 {"SètsFûe", &
cfg∑øms
.
SètsFûe
, 1, 0.0, 0, 0.0, 0.0, 
FILE_NAME_SIZE
, },

92 {"Di•oßbÀP", &
cfg∑øms
.
Di•oßbÀP
, 0, 0.0, 1, 0.0, 1.0, },

93 {"SëFú°AsL⁄gTîm", &
cfg∑øms
.
SëFú°AsL⁄gTîm
, 0, 0.0, 1, 0.0, 1.0, },

94 {"Mu…iSour˚D©a", &
cfg∑øms
.
Mu…iSour˚D©a
, 0, 0.0, 0, 0.0, 2.0, },

95 {"I≈utFûe3", &
cfg∑øms
.
öput_fûe3
.
‚ame
, 1, 0.0, 0, 0.0, 0.0, 
FILE_NAME_SIZE
, },

96 {"SEIVUI32PuŒdown", &
cfg∑øms
.
SEIVUI32PuŒdown
, 0, 0.0, 1, 0.0, 5.0, },

98 {"Pro˚ssI≈ut", &
cfg∑øms
.
Pro˚ssI≈ut
, 0, 0.0, 1, 0.0, 4.0, },

99 {"Di•PQPOff£t", &
cfg∑øms
.
Di•PQPOff£t
, 0, 0.0, 0,-51.0, 51.0, },

100 {"NumbîBFømes", &
cfg∑øms
.
NumbîBFømes
, 0, 0.0, 2, 0.0, 0.0, },

101 {"PRïœ˚BSli˚", &
cfg∑øms
.
PRïœ˚BSli˚
, 0, 0.0, 1, 0.0, 1.0, },

102 {"BRefPicQPOff£t", &
cfg∑øms
.
qpBRSOff£t
, 0, 0.0, 0,-51.0, 51.0, },

103 {"Dúe˘ModeTy≥", &
cfg∑øms
.
dúe˘_•©ül_mv_¥ed_Êag
, 0, 0.0, 1, 0.0, 1.0, },

104 {"Dúe˘In„ªn˚Fœg", &
cfg∑øms
.
dúe˘In„ªn˚Fœg
, 0, 1.0, 1, 0.0, 1.0, },

105 {"SPPi˘uªPîiodicôy", &
cfg∑øms
.
•_≥riodicôy
, 0, 0.0, 2, 0.0, 0.0, },

106 {"SI_FRAMES", &
cfg∑øms
.
si_‰ame_ödiˇt‹
, 0, 0.0, 1, 0.0, 1.0, },

107 {"SP_ouçut", &
cfg∑øms
.
•_ouçut_ödiˇt‹
, 0, 0.0, 1, 0.0, 1.0, },

108 {"SP_ouçut_«me", &
cfg∑øms
.
•_ouçut_fûíame
, 1, 0.0, 0, 0.0, 0.0, 
FILE_NAME_SIZE
, },

109 {"SPSwôchPîiod", &
cfg∑øms
.
•_swôch_≥riod
, 0, 0.0, 2, 0.0, 0.0, },

110 {"SP2_FRAMES", &
cfg∑øms
.
•2_‰ame_ödiˇt‹
, 0, 0.0, 1, 0.0, 1.0, },

111 {"SP2_öput_«me1", &
cfg∑øms
.
•2_öput_fûíame1
, 1, 0.0, 0, 0.0, 0.0, 
FILE_NAME_SIZE
, },

112 {"SP2_öput_«me2", &
cfg∑øms
.
•2_öput_fûíame2
, 1, 0.0, 0, 0.0, 0.0, 
FILE_NAME_SIZE
, },

113 {"SymbﬁMode", &
cfg∑øms
.
symbﬁ_mode
, 0, 0.0, 1, (Ë
CAVLC
, (Ë
CABAC
, },

114 {"OutFûeMode", &
cfg∑øms
.
of_mode
, 0, 0.0, 1, 0.0, 1.0, },

115 {"P¨tôi⁄Mode", &
cfg∑øms
.
∑πôi⁄_mode
, 0, 0.0, 1, 0.0, 1.0, },

116 {"PSli˚Skù", &
cfg∑øms
.
I¡îSórch
[0][0][0], 0, 1.0, 1, 0.0, 1.0, },

117 {"PSli˚Sórch16x16", &
cfg∑øms
.
I¡îSórch
[0][0][1], 0, 1.0, 1, 0.0, 1.0, },

118 {"PSli˚Sórch16x8", &
cfg∑øms
.
I¡îSórch
[0][0][2], 0, 1.0, 1, 0.0, 1.0, },

119 {"PSli˚Sórch8x16", &
cfg∑øms
.
I¡îSórch
[0][0][3], 0, 1.0, 1, 0.0, 1.0, },

120 {"PSli˚Sórch8x8", &
cfg∑øms
.
I¡îSórch
[0][0][4], 0, 1.0, 1, 0.0, 1.0, },

121 {"PSli˚Sórch8x4", &
cfg∑øms
.
I¡îSórch
[0][0][5], 0, 1.0, 1, 0.0, 1.0, },

122 {"PSli˚Sórch4x8", &
cfg∑øms
.
I¡îSórch
[0][0][6], 0, 1.0, 1, 0.0, 1.0, },

123 {"PSli˚Sórch4x4", &
cfg∑øms
.
I¡îSórch
[0][0][7], 0, 1.0, 1, 0.0, 1.0, },

125 {"BSli˚Dúe˘", &
cfg∑øms
.
I¡îSórch
[0][1][0], 0, 1.0, 1, 0.0, 1.0, },

126 {"BSli˚Sórch16x16", &
cfg∑øms
.
I¡îSórch
[0][1][1], 0, 1.0, 1, 0.0, 1.0, },

127 {"BSli˚Sórch16x8", &
cfg∑øms
.
I¡îSórch
[0][1][2], 0, 1.0, 1, 0.0, 1.0, },

128 {"BSli˚Sórch8x16", &
cfg∑øms
.
I¡îSórch
[0][1][3], 0, 1.0, 1, 0.0, 1.0, },

129 {"BSli˚Sórch8x8", &
cfg∑øms
.
I¡îSórch
[0][1][4], 0, 1.0, 1, 0.0, 1.0, },

130 {"BSli˚Sórch8x4", &
cfg∑øms
.
I¡îSórch
[0][1][5], 0, 1.0, 1, 0.0, 1.0, },

131 {"BSli˚Sórch4x8", &
cfg∑øms
.
I¡îSórch
[0][1][6], 0, 1.0, 1, 0.0, 1.0, },

132 {"BSli˚Sórch4x4", &
cfg∑øms
.
I¡îSórch
[0][1][7], 0, 1.0, 1, 0.0, 1.0, },

134 {"BiPªdMŸi⁄E°im©i⁄", &
cfg∑øms
.
BiPªdMŸi⁄E°im©i⁄
, 0, 0.0, 1, 0.0, 1.0, },

135 {"BiPªdSórch16x16", &
cfg∑øms
.
BiPªdSórch
[0], 0, 1.0, 1, 0.0, 1.0, },

136 {"BiPªdSórch16x8", &
cfg∑øms
.
BiPªdSórch
[1], 0, 0.0, 1, 0.0, 1.0, },

137 {"BiPªdSórch8x16", &
cfg∑øms
.
BiPªdSórch
[2], 0, 0.0, 1, 0.0, 1.0, },

138 {"BiPªdSórch8x8", &
cfg∑øms
.
BiPªdSórch
[3], 0, 0.0, 1, 0.0, 1.0, },

139 {"BiPªdMEReföemíts", &
cfg∑øms
.
BiPªdMEReföemíts
, 0, 0.0, 1, 0.0, 5.0, },

140 {"BiPªdMESórchR™ge", &
cfg∑øms
.
BiPªdMESórchR™ge
[0], 0, 8.0, 2, 0.0, 0.0, },

141 {"BiPªdMESubPñ", &
cfg∑øms
.
BiPªdMESubPñ
, 0, 1.0, 1, 0.0, 2.0, },

142 {"DißbÀI¡øInI¡î", &
cfg∑øms
.
DißbÀI¡øInI¡î
[0], 0, 0.0, 1, 0.0, 1.0, },

143 {"I¡øDißbÀI¡îO∆y", &
cfg∑øms
.
I¡øDißbÀI¡îO∆y
, 0, 0.0, 1, 0.0, 1.0, },

144 {"DißbÀI¡ø4x4", &
cfg∑øms
.
DißbÀI¡ø4x4
, 0, 0.0, 1, 0.0, 1.0, },

145 {"DißbÀI¡ø16x16", &
cfg∑øms
.
DißbÀI¡ø16x16
, 0, 0.0, 1, 0.0, 1.0, },

146 {"I¡ø4x4P¨DißbÀ", &
cfg∑øms
.
I¡ø4x4P¨DißbÀ
, 0, 0.0, 1, 0.0, 1.0, },

147 {"I¡ø4x4DügDißbÀ", &
cfg∑øms
.
I¡ø4x4DügDißbÀ
, 0, 0.0, 1, 0.0, 1.0, },

148 {"I¡ø4x4DúDißbÀ", &
cfg∑øms
.
I¡ø4x4DúDißbÀ
, 0, 0.0, 1, 0.0, 1.0, },

149 {"I¡ø16x16P¨DißbÀ", &
cfg∑øms
.
I¡ø16x16P¨DißbÀ
, 0, 0.0, 1, 0.0, 1.0, },

150 {"I¡ø16x16Pœ√DißbÀ", &
cfg∑øms
.
I¡ø16x16Pœ√DißbÀ
, 0, 0.0, 1, 0.0, 1.0, },

151 {"E«bÀIPCM", &
cfg∑øms
.
E«bÀIPCM
, 0, 0.0, 1, 0.0, 2.0, },

152 {"ChromaI¡øDißbÀ", &
cfg∑øms
.
ChromaI¡øDißbÀ
, 0, 0.0, 1, 0.0, 1.0, },

153 {"RDO±imiz©i⁄", &
cfg∑øms
.
rd›t
, 0, 0.0, 1, 0.0, 3.0, },

155 {"Di°‹ti⁄E°im©i⁄", &
cfg∑øms
.
de
, 0, 1.0, 2, 0.0, 8.0, },

156 {"SubMBCodögSèã", &
cfg∑øms
.
subMBCodögSèã
, 0, 2.0, 1, 0.0, 2.0, },

157 {"I16RDO±", &
cfg∑øms
.
I16rdo
, 0, 0.0, 1, 0.0, 1.0, },

158 {"MDRe„ªn˚", &
cfg∑øms
.
MDRe„ªn˚
[0], 0, 0.0, 1, 0.0, 1.0, },

159 {"EnhLayîMDRe„ªn˚", &
cfg∑øms
.
MDRe„ªn˚
[1], 0, 0.0, 1, 0.0, 1.0, },

160 {"Di°‹ti⁄SSIM", &
cfg∑øms
.
Di°‹ti⁄
[
SSIM
], 0, 0.0, 1, 0.0, 1.0, },

161 {"Di°‹ti⁄MS_SSIM", &
cfg∑øms
.
Di°‹ti⁄
[
MS_SSIM
], 0, 0.0, 1, 0.0, 1.0, },

162 {"SSIMOvîœpSize", &
cfg∑øms
.
SSIMOvîœpSize
, 0, 1.0, 2, 1.0, 1.0, },

163 {"Di°‹ti⁄YUVtoRGB", &
cfg∑øms
.
Di°‹ti⁄YUVtoRGB
, 0, 0.0, 1, 0.0, 1.0, },

164 {"CtxAd±LagøngeMu…", &
cfg∑øms
.
CtxAd±LagøngeMu…
, 0, 0.0, 1, 0.0, 1.0, },

165 {"Fa°CrI¡øDecisi⁄", &
cfg∑øms
.
Fa°CrI¡øDecisi⁄
, 0, 0.0, 1, 0.0, 1.0, },

166 {"DißbÀThªshﬁdög", &
cfg∑øms
.
di°hªs
, 0, 0.0, 1, 0.0, 1.0, },

167 {"DißbÀBSkùRDO", &
cfg∑øms
.
nobskù
, 0, 0.0, 1, 0.0, 1.0, },

168 {"BüsSkùRDO", &
cfg∑øms
.
BüsSkùRDO
, 0, 0.0, 1, 0.0, 1.0, },

169 {"F‹˚TrueR©eRDO", &
cfg∑øms
.
F‹˚TrueR©eRDO
, 0, 0.0, 1, 0.0, 2.0, },

170 {"LossR©eA", &
cfg∑øms
.
LossR©eA
, 2, 0.0, 2, 0.0, 0.0, },

171 {"LossR©eB", &
cfg∑øms
.
LossR©eB
, 2, 0.0, 2, 0.0, 0.0, },

172 {"LossR©eC", &
cfg∑øms
.
LossR©eC
, 2, 0.0, 2, 0.0, 0.0, },

173 {"Fú°FømeC‹ª˘", &
cfg∑øms
.
Fú°FømeC‹ª˘
, 0, 0.0, 2, 0.0, 0.0, },

174 {"NumbîOfDecodîs", &
cfg∑øms
.
NoOfDecodîs
, 0, 0.0, 2, 0.0, 0.0, },

175 {"Eº‹C⁄˚Æmít", &
cfg∑øms
.
Eº‹C⁄˚Æmít
, 0, 0.0, 2, 0.0, 0.0, },

176 {"Re°ri˘RefFømes", &
cfg∑øms
.
Re°ri˘Ref
 , 0, 0.0, 1, 0.0, 1.0, },

177 #ifde‡
_LEAKYBUCKET_


178 {"NumbîofLókyBuckës", &
cfg∑øms
.
NumbîLókyBuckës
, 0, 2.0, 1, 2.0, 255.0, },

179 {"LókyBuckëR©eFûe", &
cfg∑øms
.
LókyBuckëR©eFûe
, 1, 0.0, 0, 0.0, 0.0, 
FILE_NAME_SIZE
, },

180 {"LókyBuckëP¨amFûe", &
cfg∑øms
.
LókyBuckëP¨amFûe
, 1, 0.0, 0, 0.0, 0.0, 
FILE_NAME_SIZE
, },

182 {"PicI¡îœ˚", &
cfg∑øms
.
PicI¡îœ˚
, 0, 0.0, 1, 0.0, 3.0, },

183 {"MbI¡îœ˚", &
cfg∑øms
.
MbI¡îœ˚
, 0, 0.0, 1, 0.0, 3.0, },

185 {"I¡øBŸtom", &
cfg∑øms
.
I¡øBŸtom
, 0, 0.0, 1, 0.0, 1.0, },

187 {"NumFømesInELayîSubSeq", &
cfg∑øms
.
NumFømesInELSubSeq
, 0, 0.0, 2, 0.0, 0.0, },

188 {"R™domI¡øMBRe‰esh", &
cfg∑øms
.
R™domI¡øMBRe‰esh
, 0, 0.0, 2, 0.0, 0.0, },

189 {"WeighãdPªdi˘i⁄", &
cfg∑øms
.
WeighãdPªdi˘i⁄
, 0, 0.0, 1, 0.0, 1.0, },

190 {"WeighãdBùªdi˘i⁄", &
cfg∑øms
.
WeighãdBùªdi˘i⁄
, 0, 0.0, 1, 0.0, 2.0, },

191 {"WPMëhod", &
cfg∑øms
.
WPMëhod
, 0, 0.0, 1, 0.0, 3.0, },

192 {"WPIãrMC", &
cfg∑øms
.
WPIãrMC
, 0, 0.0, 1, 0.0, 1.0, },

193 {"ChromaWeightSuµ‹t", &
cfg∑øms
.
ChromaWeightSuµ‹t
, 0, 0.0, 1, 0.0, 1.0, },

194 {"Enh™˚dBWeightSuµ‹t", &
cfg∑øms
.
Enh™˚dBWeightSuµ‹t
, 0, 0.0, 1, 0.0, 2.0, },

195 {"U£WeighãdRe„ªn˚ME", &
cfg∑øms
.
U£WeighãdRe„ªn˚ME
, 0, 0.0, 1, 0.0, 1.0, },

196 {"RDPi˘uªDecisi⁄", &
cfg∑øms
.
RDPi˘uªDecisi⁄
, 0, 0.0, 1, 0.0, 1.0, },

197 {"RDPSli˚BTe°", &
cfg∑øms
.
RDPSli˚BTe°
, 0, 0.0, 1, 0.0, 1.0, },

198 {"RDPSli˚ITe°", &
cfg∑øms
.
RDPSli˚ITe°
, 0, 1.0, 1, 0.0, 1.0, },

199 {"RDPi˘uªMaxPassISli˚", &
cfg∑øms
.
RDPi˘uªMaxPassISli˚
, 0, 1.0, 1, 1.0, 3.0, },

200 {"RDPi˘uªMaxPassPSli˚", &
cfg∑øms
.
RDPi˘uªMaxPassPSli˚
, 0, 2.0, 1, 1.0, 6.0, },

201 {"RDPi˘uªMaxPassBSli˚", &
cfg∑øms
.
RDPi˘uªMaxPassBSli˚
, 0, 3.0, 1, 1.0, 6.0, },

202 {"RDPi˘uªDeblockög", &
cfg∑øms
.
RDPi˘uªDeblockög
, 0, 0.0, 1, 0.0, 1.0, },

203 {"RDPi˘uªDúe˘Mode", &
cfg∑øms
.
RDPi˘uªDúe˘Mode
, 0, 0.0, 1, 0.0, 1.0, },

204 {"RDPi˘uªFømeQPPSli˚", &
cfg∑øms
.
RDPi˘uªFømeQPPSli˚
, 0, 0.0, 1, 0.0, 1.0, },

205 {"RDPi˘uªFømeQPBSli˚", &
cfg∑øms
.
RDPi˘uªFømeQPBSli˚
, 0, 0.0, 1, 0.0, 1.0, },

206 {"SkùI¡øInI¡îSli˚s", &
cfg∑øms
.
SkùI¡øInI¡îSli˚s
, 0, 0.0, 1, 0.0, 1.0, },

207 {"BRe„ªn˚Pi˘uªs", &
cfg∑øms
.
BRefPi˘uªs
, 0, 0.0, 1, 0.0, 2.0, },

208 {"HõørchiˇlCodög", &
cfg∑øms
.
HõørchiˇlCodög
, 0, 0.0, 1, 0.0, 3.0, },

209 {"HõørchyLevñQPE«bÀ", &
cfg∑øms
.
HõørchyLevñQPE«bÀ
, 0, 0.0, 1, 0.0, 1.0, },

210 {"Ex∂icôHõørchyF‹m©", &
cfg∑øms
.
Ex∂icôHõørchyF‹m©
, 1, 0.0, 0, 0.0, 0.0, 
INPUT_TEXT_SIZE
,},

211 {"Ex∂icôSeqCodög", &
cfg∑øms
.
Ex∂icôSeqCodög
, 0, 0.0, 1, 0.0, 3.0, },

212 {"Ex∂icôSeqFûe", &
cfg∑øms
.
Ex∂icôSeqFûe
, 1, 0.0, 0, 0.0, 0.0, 
FILE_NAME_SIZE
, },

213 {"LowDñay", &
cfg∑øms
.
LowDñay
, 0, 0.0, 1, 0.0, 1.0, },

214 {"Re„ªn˚Re‹dî", &
cfg∑øms
.
Re„ªn˚Re‹dî
, 0, 0.0, 1, 0.0, 2.0, },

215 {"PocMem‹yM™agemít", &
cfg∑øms
.
PocMem‹yM™agemít
, 0, 0.0, 1, 0.0, 2.0, },

218 {"DFP¨amëîsFœg", &
cfg∑øms
.
DFSídP¨amëîs
, 0, 0.0, 1, 0.0, 1.0, },

219 {"DFDißbÀRefISli˚", &
cfg∑øms
.
DFDißbÀIdc
[1][
I_SLICE
], 0, 0.0, 1, 0.0, 2.0, },

220 {"DFDißbÀNRefISli˚", &
cfg∑øms
.
DFDißbÀIdc
[0][
I_SLICE
], 0, 0.0, 1, 0.0, 2.0, },

221 {"DFDißbÀRefPSli˚", &
cfg∑øms
.
DFDißbÀIdc
[1][
P_SLICE
], 0, 0.0, 1, 0.0, 2.0, },

222 {"DFDißbÀNRefPSli˚", &
cfg∑øms
.
DFDißbÀIdc
[0][
P_SLICE
], 0, 0.0, 1, 0.0, 2.0, },

223 {"DFDißbÀRefBSli˚", &
cfg∑øms
.
DFDißbÀIdc
[1][
B_SLICE
], 0, 0.0, 1, 0.0, 2.0, },

224 {"DFDißbÀNRefBSli˚", &
cfg∑øms
.
DFDißbÀIdc
[0][
B_SLICE
], 0, 0.0, 1, 0.0, 2.0, },

225 {"DFDißbÀRefSPSli˚", &
cfg∑øms
.
DFDißbÀIdc
[1][
SP_SLICE
], 0, 0.0, 1, 0.0, 2.0, },

226 {"DFDißbÀNRefSPSli˚", &
cfg∑øms
.
DFDißbÀIdc
[0][
SP_SLICE
], 0, 0.0, 1, 0.0, 2.0, },

227 {"DFDißbÀRefSISli˚", &
cfg∑øms
.
DFDißbÀIdc
[1][
SI_SLICE
], 0, 0.0, 1, 0.0, 2.0, },

228 {"DFDißbÀNRefSISli˚", &
cfg∑øms
.
DFDißbÀIdc
[0][
SI_SLICE
], 0, 0.0, 1, 0.0, 2.0, },

229 {"DFAÕhaRefISli˚", &
cfg∑øms
.
DFAÕha
[1][
I_SLICE
], 0, 0.0, 1, -6.0, 6.0, },

230 {"DFAÕhaNRefISli˚", &
cfg∑øms
.
DFAÕha
[0][
I_SLICE
], 0, 0.0, 1, -6.0, 6.0, },

231 {"DFAÕhaRefPSli˚", &
cfg∑øms
.
DFAÕha
[1][
P_SLICE
], 0, 0.0, 1, -6.0, 6.0, },

232 {"DFAÕhaNRefPSli˚", &
cfg∑øms
.
DFAÕha
[0][
P_SLICE
], 0, 0.0, 1, -6.0, 6.0, },

233 {"DFAÕhaRefBSli˚", &
cfg∑øms
.
DFAÕha
[1][
B_SLICE
], 0, 0.0, 1, -6.0, 6.0, },

234 {"DFAÕhaNRefBSli˚", &
cfg∑øms
.
DFAÕha
[0][
B_SLICE
], 0, 0.0, 1, -6.0, 6.0, },

235 {"DFAÕhaRefSPSli˚", &
cfg∑øms
.
DFAÕha
[1][
SP_SLICE
], 0, 0.0, 1, -6.0, 6.0, },

236 {"DFAÕhaNRefSPSli˚", &
cfg∑øms
.
DFAÕha
[0][
SP_SLICE
], 0, 0.0, 1, -6.0, 6.0, },

237 {"DFAÕhaRefSISli˚", &
cfg∑øms
.
DFAÕha
[1][
SI_SLICE
], 0, 0.0, 1, -6.0, 6.0, },

238 {"DFAÕhaNRefSISli˚", &
cfg∑øms
.
DFAÕha
[0][
SI_SLICE
], 0, 0.0, 1, -6.0, 6.0, },

239 {"DFBëaRefISli˚", &
cfg∑øms
.
DFBëa
[1][
I_SLICE
], 0, 0.0, 1, -6.0, 6.0, },

240 {"DFBëaNRefISli˚", &
cfg∑øms
.
DFBëa
[0][
I_SLICE
], 0, 0.0, 1, -6.0, 6.0, },

241 {"DFBëaRefPSli˚", &
cfg∑øms
.
DFBëa
[1][
P_SLICE
], 0, 0.0, 1, -6.0, 6.0, },

242 {"DFBëaNRefPSli˚", &
cfg∑øms
.
DFBëa
[0][
P_SLICE
], 0, 0.0, 1, -6.0, 6.0, },

243 {"DFBëaRefBSli˚", &
cfg∑øms
.
DFBëa
[1][
B_SLICE
], 0, 0.0, 1, -6.0, 6.0, },

244 {"DFBëaNRefBSli˚", &
cfg∑øms
.
DFBëa
[0][
B_SLICE
], 0, 0.0, 1, -6.0, 6.0, },

245 {"DFBëaRefSPSli˚", &
cfg∑øms
.
DFBëa
[1][
SP_SLICE
], 0, 0.0, 1, -6.0, 6.0, },

246 {"DFBëaNRefSPSli˚", &
cfg∑øms
.
DFBëa
[0][
SP_SLICE
], 0, 0.0, 1, -6.0, 6.0, },

247 {"DFBëaRefSISli˚", &
cfg∑øms
.
DFBëa
[1][
SI_SLICE
], 0, 0.0, 1, -6.0, 6.0, },

248 {"DFBëaNRefSISli˚", &
cfg∑øms
.
DFBëa
[0][
SI_SLICE
], 0, 0.0, 1, -6.0, 6.0, },

249 {"S∑ªPi˘uªO±i⁄", &
cfg∑øms
.
S∑ªPi˘uªO±i⁄
, 0, 0.0, 1, 0.0, 1.0, },

250 {"S∑ªPi˘uªDëe˘i⁄Thr", &
cfg∑øms
.
SPDëe˘i⁄Thªshﬁd
, 0, 0.0, 2, 0.0, 0.0, },

251 {"S∑ªPi˘uªPî˚¡ageThr",&
cfg∑øms
.
SPPî˚¡ageThªshﬁd
, 0, 0.0, 2, 0.0, 100.0, },

253 {"num_¶i˚_groups_möus1", &
cfg∑øms
.
num_¶i˚_groups_möus1
, 0, 0.0, 1, 0.0, ()
MAXSLICEGROUPIDS
 - 1 },

254 {"¶i˚_group_m≠_ty≥", &
cfg∑øms
.
¶i˚_group_m≠_ty≥
, 0, 0.0, 1, 0.0, 6.0, },

255 {"¶i˚_group_ch™ge_dúe˘i⁄_Êag", &
cfg∑øms
.
¶i˚_group_ch™ge_dúe˘i⁄_Êag
, 0, 0.0, 1, 0.0, 2.0, },

256 {"¶i˚_group_ch™ge_øã_möus1", &
cfg∑øms
.
¶i˚_group_ch™ge_øã_möus1
, 0, 0.0, 2, 0.0, 1.0, },

257 {"Sli˚GroupC⁄figFûeName", &
cfg∑øms
.
Sli˚GroupC⁄figFûeName
, 1, 0.0, 0, 0.0, 0.0, 
FILE_NAME_SIZE
, },

259 {"U£Redund™tPi˘uª", &
cfg∑øms
.
ªdund™t_pic_Êag
, 0, 0.0, 1, 0.0, 1.0, },

260 {"NumRedund™tHõørchy", &
cfg∑øms
.
NumRedund™tHõørchy
, 0, 0.0, 1, 0.0, 4.0, },

261 {"Prim¨yGOPLígth", &
cfg∑øms
.
Prim¨yGOPLígth
, 0, 1.0, 1, 1.0, 16.0, },

262 {"NumRefPrim¨y", &
cfg∑øms
.
NumRefPrim¨y
, 0, 1.0, 1, 1.0, 16.0, },

264 {"PicOrdîC¡Ty≥", &
cfg∑øms
.
pic_‹dî_˙t_ty≥
, 0, 0.0, 1, 0.0, 2.0, },

266 {"C⁄ãxtInôMëhod", &
cfg∑øms
.
c⁄ãxt_öô_mëhod
, 0, 0.0, 1, 0.0, 1.0, },

267 {"FixedModñNumbî", &
cfg∑øms
.
modñ_numbî
, 0, 0.0, 1, 0.0, 2.0, },

269 {"Rï‹tFømeSèts", &
cfg∑øms
.
Rï‹tFømeSèts
, 0, 0.0, 1, 0.0, 1.0, },

270 {"Di•œyEncP¨ams", &
cfg∑øms
.
Di•œyEncP¨ams
, 0, 0.0, 1, 0.0, 1.0, },

271 {"Vîbo£", &
cfg∑øms
.
Vîbo£
, 0, 1.0, 1, 0.0, 4.0, },

272 {"SkùGlobÆSèts", &
cfg∑øms
.
skù_gl_°©s
, 0, 0.0, 1, 0.0, 1.0, },

273 {"OnTheFlyFø˘MCP", &
cfg∑øms
.
OnTheFlyFø˘MCP
, 0, 0.0, 1, 0.0, 3.0, },

274 {"ChromaMCBuf„r", &
cfg∑øms
.
ChromaMCBuf„r
, 0, 0.0, 1, 0.0, 1.0, },

275 {"ChromaMEE«bÀ", &
cfg∑øms
.
ChromaMEE«bÀ
, 0, 0.0, 1, 0.0, 2.0, },

276 {"ChromaMEWeight", &
cfg∑øms
.
ChromaMEWeight
, 0, 1.0, 2, 0.0, 1.0, },

277 {"MESo·íSSEMëric", &
cfg∑øms
.
MESo·íSSEMëric
, 0, 0.0, 1, 0.0, 1.0, },

278 {"MEDi°‹ti⁄FPñ", &
cfg∑øms
.
MEEº‹Mëric
[
F_PEL
], 0, 0.0, 1, 0.0, 3.0, },

279 {"MEDi°‹ti⁄HPñ", &
cfg∑øms
.
MEEº‹Mëric
[
H_PEL
], 0, 0.0, 1, 0.0, 3.0, },

280 {"MEDi°‹ti⁄QPñ", &
cfg∑øms
.
MEEº‹Mëric
[
Q_PEL
], 0, 2.0, 1, 0.0, 3.0, },

281 {"MDDi°‹ti⁄", &
cfg∑øms
.
ModeDecisi⁄Mëric
, 0, 2.0, 1, 0.0, 2.0, },

282 {"SkùDeBlockN⁄Ref", &
cfg∑øms
.
SkùDeBlockN⁄Ref
, 0, 0.0, 1, 0.0, 1.0, },

285 {"R©eC⁄åﬁE«bÀ", &
cfg∑øms
.
RCE«bÀ
, 0, 0.0, 1, 0.0, 1.0, },

286 {"Bôøã", &
cfg∑øms
.
bô_øã
, 0, 0.0, 2, 0.0, 0.0, },

287 {"InôülQP", &
cfg∑øms
.
SeöôülQP
, 0, 0.0, 3, (Ë
MIN_QP
, (Ë
MAX_QP
, },

288 {"BasicUnô", &
cfg∑øms
.
basicunô
, 0, 0.0, 2, 0.0, 0.0, },

289 {"Ch™√lTy≥", &
cfg∑øms
.
ch™√l_ty≥
, 0, 0.0, 1, 0.0, 1.0, },

290 {"RCUpd©eMode", &
cfg∑øms
.
RCUpd©eMode
, 0, 0.0, 1, 0.0, 4.0, },

291 {"RCISli˚BôR©io", &
cfg∑øms
.
RCISli˚BôR©io
, 2, 1.0, 1, 0.0, 20.0, },

292 {"RCBSli˚BôR©io0", &
cfg∑øms
.
RCBSli˚BôR©io
[0], 2, 0.5, 1, 0.0, 20.0, },

293 {"RCBSli˚BôR©io1", &
cfg∑øms
.
RCBSli˚BôR©io
[1], 2, 0.25, 1, 0.0, 20.0, },

294 {"RCBSli˚BôR©io2", &
cfg∑øms
.
RCBSli˚BôR©io
[2], 2, 0.25, 1, 0.0, 20.0, },

295 {"RCBSli˚BôR©io3", &
cfg∑øms
.
RCBSli˚BôR©io
[3], 2, 0.25, 1, 0.0, 20.0, },

296 {"RCBSli˚BôR©io4", &
cfg∑øms
.
RCBSli˚BôR©io
[4], 2, 0.25, 1, 0.0, 20.0, },

297 {"RCBovîPR©io", &
cfg∑øms
.
RCBovîPR©io
, 2, 0.45, 1, 0.0, 1000.0, },

298 {"RCIovîPR©io", &
cfg∑øms
.
RCIovîPR©io
, 2, 3.80, 1, 0.0, 1000.0, },

299 {"RCMöQPPSli˚", &
cfg∑øms
.
RCMöQP
[
P_SLICE
], 0, (Ë
MIN_QP
, 3, (ËMIN_QP, (Ë
MAX_QP
, },

300 {"RCMaxQPPSli˚", &
cfg∑øms
.
RCMaxQP
[
P_SLICE
], 0, (Ë
MAX_QP
, 3, (Ë
MIN_QP
, () MAX_QP, },

301 {"RCMöQPBSli˚", &
cfg∑øms
.
RCMöQP
[
B_SLICE
], 0, (Ë
MIN_QP
, 3, (ËMIN_QP, (Ë
MAX_QP
, },

302 {"RCMaxQPBSli˚", &
cfg∑øms
.
RCMaxQP
[
B_SLICE
], 0, (Ë
MAX_QP
, 3, (Ë
MIN_QP
, () MAX_QP, },

303 {"RCMöQPISli˚", &
cfg∑øms
.
RCMöQP
[
I_SLICE
], 0, (Ë
MIN_QP
, 3, (ËMIN_QP, (Ë
MAX_QP
, },

304 {"RCMaxQPISli˚", &
cfg∑øms
.
RCMaxQP
[
I_SLICE
], 0, (Ë
MAX_QP
, 3, (Ë
MIN_QP
, () MAX_QP, },

305 {"RCMöQPSPSli˚", &
cfg∑øms
.
RCMöQP
[
SP_SLICE
], 0, (Ë
MIN_QP
, 3, (ËMIN_QP, (Ë
MAX_QP
, },

306 {"RCMaxQPSPSli˚", &
cfg∑øms
.
RCMaxQP
[
SP_SLICE
], 0, (Ë
MAX_QP
, 3, (Ë
MIN_QP
, () MAX_QP, },

307 {"RCMöQPSISli˚", &
cfg∑øms
.
RCMöQP
[
SI_SLICE
], 0, (Ë
MIN_QP
, 3, (ËMIN_QP, (Ë
MAX_QP
, },

308 {"RCMaxQPSISli˚", &
cfg∑øms
.
RCMaxQP
[
SI_SLICE
], 0, (Ë
MAX_QP
, 3, (Ë
MIN_QP
, () MAX_QP, },

309 {"RCMaxQPCh™ge", &
cfg∑øms
.
RCMaxQPCh™ge
, 0, 4.0, 1, 0.0, 51.0, },

312 {"Qm©rixFûe", &
cfg∑øms
.
Qm©rixFûe
, 1, 0.0, 0, 0.0, 0.0, 
FILE_NAME_SIZE
, },

313 {"SˇlögM©rixPª£¡Fœg", &
cfg∑øms
.
SˇlögM©rixPª£¡Fœg
, 0, 0.0, 1, 0.0, 3.0, },

314 {"SˇlögLi°Pª£¡Fœg0", &
cfg∑øms
.
SˇlögLi°Pª£¡Fœg
[0], 0, 0.0, 1, 0.0, 3.0, },

315 {"SˇlögLi°Pª£¡Fœg1", &
cfg∑øms
.
SˇlögLi°Pª£¡Fœg
[1], 0, 0.0, 1, 0.0, 3.0, },

316 {"SˇlögLi°Pª£¡Fœg2", &
cfg∑øms
.
SˇlögLi°Pª£¡Fœg
[2], 0, 0.0, 1, 0.0, 3.0, },

317 {"SˇlögLi°Pª£¡Fœg3", &
cfg∑øms
.
SˇlögLi°Pª£¡Fœg
[3], 0, 0.0, 1, 0.0, 3.0, },

318 {"SˇlögLi°Pª£¡Fœg4", &
cfg∑øms
.
SˇlögLi°Pª£¡Fœg
[4], 0, 0.0, 1, 0.0, 3.0, },

319 {"SˇlögLi°Pª£¡Fœg5", &
cfg∑øms
.
SˇlögLi°Pª£¡Fœg
[5], 0, 0.0, 1, 0.0, 3.0, },

320 {"SˇlögLi°Pª£¡Fœg6", &
cfg∑øms
.
SˇlögLi°Pª£¡Fœg
[6], 0, 0.0, 1, 0.0, 3.0, },

321 {"SˇlögLi°Pª£¡Fœg7", &
cfg∑øms
.
SˇlögLi°Pª£¡Fœg
[7], 0, 0.0, 1, 0.0, 3.0, },

322 {"SˇlögLi°Pª£¡Fœg8", &
cfg∑øms
.
SˇlögLi°Pª£¡Fœg
[8], 0, 0.0, 1, 0.0, 3.0, },

323 {"SˇlögLi°Pª£¡Fœg9", &
cfg∑øms
.
SˇlögLi°Pª£¡Fœg
[9], 0, 0.0, 1, 0.0, 3.0, },

324 {"SˇlögLi°Pª£¡Fœg10", &
cfg∑øms
.
SˇlögLi°Pª£¡Fœg
[10], 0, 0.0, 1, 0.0, 3.0, },

325 {"SˇlögLi°Pª£¡Fœg11", &
cfg∑øms
.
SˇlögLi°Pª£¡Fœg
[11], 0, 0.0, 1, 0.0, 3.0, },

328 {"ChromaQPOff£t", &
cfg∑øms
.
chroma_qp_ödex_off£t
, 0, 0.0, 1,-51.0, 51.0, },

332 {"Sour˚BôDïthLuma", &
cfg∑øms
.
sour˚
.
bô_dïth
[0], 0, 8.0, 1, 8.0, 14.0, },

333 {"Sour˚BôDïthChroma", &
cfg∑øms
.
sour˚
.
bô_dïth
[1], 0, 8.0, 1, 8.0, 14.0, },

334 {"Sour˚BôDïthResˇÀ", &
cfg∑øms
.
§c_BôDïthResˇÀ
, 0, 0.0, 1, 0.0, 1.0, },

336 {"OuçutBôDïthLuma", &
cfg∑øms
.
ouçut
.
bô_dïth
[0], 0, 8.0, 1, 8.0, 14.0, },

337 {"OuçutBôDïthChroma", &
cfg∑øms
.
ouçut
.
bô_dïth
[1], 0, 8.0, 1, 8.0, 14.0, },

339 {"YUVF‹m©", &
cfg∑øms
.
yuv_f‹m©
, 0, 1.0, 1, 0.0, 3.0, },

340 {"RGBI≈ut", &
cfg∑øms
.
sour˚
.
cﬁ‹_modñ
, 0, 0.0, 1, 0.0, 1.0, },

341 {"PixñF‹m©", &
cfg∑øms
.
sour˚
.
pixñ_f‹m©
, 0, 0.0, 1, 0.0, 4.0, },

342 {"I¡îÀaved", &
cfg∑øms
.
öput_fûe1
.
is_öãæóved
 , 0, 0.0, 1, 0.0, 1.0, },

343 {"Sènd¨dR™ge", &
cfg∑øms
.
°dR™ge
, 0, 0.0, 1, 0.0, 1.0, },

344 {"VideoCode", &
cfg∑øms
.
videoCode
, 0, 1.0, 1, 0.0, 8.0, },

345 {"CbQPOff£t", &
cfg∑øms
.
cb_qp_ödex_off£t
, 0, 0.0, 1,-51.0, 51.0, },

346 {"CrQPOff£t", &
cfg∑øms
.
¸_qp_ödex_off£t
, 0, 0.0, 1,-51.0, 51.0, },

347 {"Tønsf‹m8x8Mode", &
cfg∑øms
.
Tønsf‹m8x8Mode
, 0, 0.0, 1, 0.0, 2.0, },

349 {"Los¶essCodög", &
cfg∑øms
.
Los¶essCodög
, 0, 0.0, 1, 0.0, 1.0, },

352 {"U£Ex∂icôLambdaP¨ams", &
cfg∑øms
.
U£Ex∂icôLambdaP¨ams
, 0, 0.0, 1, 0.0, 3.0, },

353 {"Upd©eLambdaChromaME", &
cfg∑øms
.
Upd©eLambdaChromaME
, 0, 0.0, 1, 0.0, 3.0, },

354 {"FixedLambdaPSli˚", &
cfg∑øms
.
FixedLambda
[
P_SLICE
], 2, 0.1, 2, 0.0, 0.0, },

355 {"FixedLambdaBSli˚", &
cfg∑øms
.
FixedLambda
[
B_SLICE
], 2, 0.1, 2, 0.0, 0.0, },

356 {"FixedLambdaISli˚", &
cfg∑øms
.
FixedLambda
[
I_SLICE
], 2, 0.1, 2, 0.0, 0.0, },

357 {"FixedLambdaSPSli˚", &
cfg∑øms
.
FixedLambda
[
SP_SLICE
], 2, 0.1, 2, 0.0, 0.0, },

358 {"FixedLambdaSISli˚", &
cfg∑øms
.
FixedLambda
[
SI_SLICE
], 2, 0.1, 2, 0.0, 0.0, },

359 {"FixedLambdaRefBSli˚", &
cfg∑øms
.
FixedLambda
[5], 2, 0.1, 2, 0.0, 0.0, },

360 {"LambdaWeightPSli˚", &
cfg∑øms
.
LambdaWeight
[
P_SLICE
], 2, 0.68, 2, 0.0, 0.0, },

361 {"LambdaWeightBSli˚", &
cfg∑øms
.
LambdaWeight
[
B_SLICE
], 2, 2.00, 2, 0.0, 0.0, },

362 {"LambdaWeightISli˚", &
cfg∑øms
.
LambdaWeight
[
I_SLICE
], 2, 0.65, 2, 0.0, 0.0, },

363 {"LambdaWeightSPSli˚", &
cfg∑øms
.
LambdaWeight
[
SP_SLICE
], 2, 1.50, 2, 0.0, 0.0, },

364 {"LambdaWeightSISli˚", &
cfg∑øms
.
LambdaWeight
[
SI_SLICE
], 2, 0.65, 2, 0.0, 0.0, },

365 {"LambdaWeightRefBSli˚", &
cfg∑øms
.
LambdaWeight
[5], 2, 1.50, 2, 0.0, 0.0, },

367 {"QOff£tM©rixFûe", &
cfg∑øms
.
QOff£tM©rixFûe
, 1, 0.0, 0, 0.0, 0.0, 
FILE_NAME_SIZE
, },

368 {"Off£tM©rixPª£¡Fœg", &
cfg∑øms
.
Off£tM©rixPª£¡Fœg
, 0, 0.0, 1, 0.0, 1.0, },

371 {"Ad≠tiveRoundög", &
cfg∑øms
.
Ad≠tiveRoundög
, 0, 0.0, 1, 0.0, 1.0, },

372 {"Ad≠tRoundögFixed", &
cfg∑øms
.
Ad≠tRoundögFixed
, 0, 1.0, 1, 0.0, 1.0, },

373 {"Ad≠tRndPîiod", &
cfg∑øms
.
Ad≠tRndPîiod
, 0, 16.0, 2, 1.0, 0.0, },

374 {"Ad≠tRndChroma", &
cfg∑øms
.
Ad≠tRndChroma
, 0, 0.0, 1, 0.0, 1.0, },

375 {"Ad≠tRndWFa˘‹IRef", &
cfg∑øms
.
Ad≠tRndWFa˘‹
[1][
I_SLICE
], 0, 4.0, 1, 0.0, 4096.0, },

376 {"Ad≠tRndWFa˘‹PRef", &
cfg∑øms
.
Ad≠tRndWFa˘‹
[1][
P_SLICE
], 0, 4.0, 1, 0.0, 4096.0, },

377 {"Ad≠tRndWFa˘‹BRef", &
cfg∑øms
.
Ad≠tRndWFa˘‹
[1][
B_SLICE
], 0, 4.0, 1, 0.0, 4096.0, },

378 {"Ad≠tRndWFa˘‹INRef", &
cfg∑øms
.
Ad≠tRndWFa˘‹
[0][
I_SLICE
], 0, 4.0, 1, 0.0, 4096.0, },

379 {"Ad≠tRndWFa˘‹PNRef", &
cfg∑øms
.
Ad≠tRndWFa˘‹
[0][
P_SLICE
], 0, 4.0, 1, 0.0, 4096.0, },

380 {"Ad≠tRndWFa˘‹BNRef", &
cfg∑øms
.
Ad≠tRndWFa˘‹
[0][
B_SLICE
], 0, 4.0, 1, 0.0, 4096.0, },

382 {"Ad≠tRndCrWFa˘‹IRef", &
cfg∑øms
.
Ad≠tRndCrWFa˘‹
[1][
I_SLICE
],0, 4.0, 1, 0.0, 4096.0, },

383 {"Ad≠tRndCrWFa˘‹PRef", &
cfg∑øms
.
Ad≠tRndCrWFa˘‹
[1][
P_SLICE
],0, 4.0, 1, 0.0, 4096.0, },

384 {"Ad≠tRndCrWFa˘‹BRef", &
cfg∑øms
.
Ad≠tRndCrWFa˘‹
[1][
B_SLICE
],0, 4.0, 1, 0.0, 4096.0, },

385 {"Ad≠tRndCrWFa˘‹INRef", &
cfg∑øms
.
Ad≠tRndCrWFa˘‹
[0][
I_SLICE
],0, 4.0, 1, 0.0, 4096.0, },

386 {"Ad≠tRndCrWFa˘‹PNRef", &
cfg∑øms
.
Ad≠tRndCrWFa˘‹
[0][
P_SLICE
],0, 4.0, 1, 0.0, 4096.0, },

387 {"Ad≠tRndCrWFa˘‹BNRef", &
cfg∑øms
.
Ad≠tRndCrWFa˘‹
[0][
B_SLICE
],0, 4.0, 1, 0.0, 4096.0, },

390 {"Pª„rDi•Ordî", &
cfg∑øms
.
Pª„rDi•Ordî
, 0, 1.0, 1, 0.0, 1.0, },

391 {"Pª„rPowîOfTwo", &
cfg∑øms
.
Pª„rPowîOfTwo
, 0, 0.0, 1, 0.0, 1.0, },

392 {"FrmSåu˘Buf„rLígth", &
cfg∑øms
.
FrmSåu˘Buf„rLígth
, 0, 16.0, 1, 1.0, 128.0, },

395 {"E¨lySkùE«bÀ", &
cfg∑øms
.
E¨lySkùE«bÀ
, 0, 0.0, 1, 0.0, 1.0, },

396 {"Sñe˘iveI¡øE«bÀ", &
cfg∑øms
.
Sñe˘iveI¡øE«bÀ
, 0, 0.0, 1, 0.0, 1.0, },

401 {"Re°ri˘SórchR™ge", &
cfg∑øms
.
fuŒ_£¨ch
, 0, 2.0, 1, 0.0, 2.0, },

403 {"U£MVLimôs", &
cfg∑øms
.
U£MVLimôs
, 0, 0.0, 1, 0.0, 1.0, },

404 {"SëMVXLimô", &
cfg∑øms
.
SëMVXLimô
, 0, 0.0, 1, 0.0, 2048.0, },

405 {"SëMVYLimô", &
cfg∑øms
.
SëMVYLimô
, 0, 0.0, 1, 0.0, 512.0, },

407 {"SórchMode", &
cfg∑øms
.
SórchMode
[0], 0, 0.0, 1, -1.0, 3.0, },

409 {"UMHexDSR", &
cfg∑øms
.
UMHexDSR
, 0, 1.0, 1, 0.0, 1.0, },

410 {"UMHexSˇÀ", &
cfg∑øms
.
UMHexSˇÀ
, 0, 1.0, 0, 0.0, 0.0, },

412 {"EPZSP©ã∫", &
cfg∑øms
.
EPZSP©ã∫
, 0, 2.0, 1, 0.0, 5.0, },

413 {"EPZSDuÆReföemít", &
cfg∑øms
.
EPZSDuÆ
, 0, 3.0, 1, 0.0, 6.0, },

414 {"EPZSFixedPªdi˘‹s", &
cfg∑øms
.
EPZSFixed
, 0, 3.0, 1, 0.0, 3.0, },

415 #i‡(
MVC_EXTENSION_ENABLE
)

416 {"EPZSTemp‹Æ", &
cfg∑øms
.
EPZSTemp‹Æ
[0], 0, 1.0, 1, 0.0, 1.0, },

418 {"EPZSTemp‹Æ", &
cfg∑øms
.
EPZSTemp‹Æ
, 0, 1.0, 1, 0.0, 1.0, },

420 {"EPZSS∑tülMem", &
cfg∑øms
.
EPZSS∑tülMem
, 0, 1.0, 1, 0.0, 1.0, },

421 {"EPZSBlockTy≥", &
cfg∑øms
.
EPZSBlockTy≥
, 0, 1.0, 1, 0.0, 1.0, },

422 #i‡(
MVC_EXTENSION_ENABLE
)

423 {"EPZSMöThªsSˇÀ", &
cfg∑øms
.
EPZSMöThªsSˇÀ
[0], 0, 0.0, 0, 0.0, 0.0, },

424 {"EPZSMaxThªsSˇÀ", &
cfg∑øms
.
EPZSMaxThªsSˇÀ
[0], 0, 2.0, 0, 0.0, 0.0, },

425 {"EPZSMedThªsSˇÀ", &
cfg∑øms
.
EPZSMedThªsSˇÀ
[0], 0, 1.0, 0, 0.0, 0.0, },

426 {"EPZSSubPñThªsSˇÀ", &
cfg∑øms
.
EPZSSubPñThªsSˇÀ
[0], 0, 1.0, 0, 0.0, 0.0, },

428 {"EPZSMöThªsSˇÀ", &
cfg∑øms
.
EPZSMöThªsSˇÀ
, 0, 0.0, 0, 0.0, 0.0, },

429 {"EPZSMaxThªsSˇÀ", &
cfg∑øms
.
EPZSMaxThªsSˇÀ
, 0, 2.0, 0, 0.0, 0.0, },

430 {"EPZSMedThªsSˇÀ", &
cfg∑øms
.
EPZSMedThªsSˇÀ
, 0, 1.0, 0, 0.0, 0.0, },

431 {"EPZSSubPñThªsSˇÀ", &
cfg∑øms
.
EPZSSubPñThªsSˇÀ
, 0, 2.0, 0, 0.0, 0.0, },

433 {"EPZSSubPñME", &
cfg∑øms
.
EPZSSubPñME
, 0, 1.0, 1, 0.0, 2.0, },

434 {"EPZSSubPñMEBiPªd", &
cfg∑øms
.
EPZSSubPñMEBiPªd
, 0, 1.0, 1, 0.0, 2.0, },

435 {"EPZSSubPñGrid", &
cfg∑øms
.
EPZSSubPñGrid
, 0, 0.0, 1, 0.0, 1.0, },

436 {"EPZSSubPñThªsSˇÀ", &
cfg∑øms
.
EPZSSubPñThªsSˇÀ
, 0, 1.0, 0, 0.0, 0.0, },

437 {"DißbÀMEPªdi˘i⁄", &
cfg∑øms
.
DißbÀMEPªdi˘i⁄
, 0, 0.0, 1, 0.0, 1.0, },

439 {"T⁄eM≠pögSEIPª£¡Fœg",&
cfg∑øms
.
T⁄eM≠pögSEIPª£¡Fœg
, 0, 0.0, 1, 0.0, 1.0, },

440 {"T⁄eM≠pögFûe", &
cfg∑øms
.
T⁄eM≠pögFûe
, 1, 0.0, 0, 0.0, 0.0, 
FILE_NAME_SIZE
, },

442 {"Sï¨©eCﬁourPœ√", &
cfg∑øms
.
£∑øã_cﬁour_∂™e_Êag
, 0, 0.0, 1, 0.0, 1.0, },

443 {"WeightY", &
cfg∑øms
.
WeightY
, 2, 1.00, 1, 0.0, 4.0, },

444 {"WeightCb", &
cfg∑øms
.
WeightCb
, 2, 1.00, 1, 0.0, 4.0, },

445 {"WeightCr", &
cfg∑øms
.
WeightCr
, 2, 1.00, 1, 0.0, 4.0, },

446 {"WPMCPªcisi⁄", &
cfg∑øms
.
WPMCPªcisi⁄
, 0, 0.0, 1, 0.0, 2.0, },

447 {"WPMCPªcFuŒRef", &
cfg∑øms
.
WPMCPªcFuŒRef
, 0, 0.0, 1, 0.0, 1.0, },

448 {"WPMCPªcBSli˚", &
cfg∑øms
.
WPMCPªcBSli˚
, 0, 1.0, 1, 0.0, 2.0, },

449 {"RCCpbSize", &
cfg∑øms
.
rc_˝b_size
, 0,1024.0, 2, 0.0, 0.0, },

450 {"MöIDRDi°™˚", &
cfg∑øms
.
MöIDRDi°™˚
, 0, 10.0, 1, 0.0, 128.0, },

452 {"U£RDOQu™t", &
cfg∑øms
.
U£RDOQu™t
, 0, 0.0, 1, 0.0, 1.0, },

453 {"RDOQ_DC", &
cfg∑øms
.
RDOQ_DC
, 0, 1.0, 1, 0.0, 1.0, },

454 {"RDOQ_CR", &
cfg∑øms
.
RDOQ_CR
, 0, 1.0, 1, 0.0, 1.0, },

455 {"RDOQ_DC_CR", &
cfg∑øms
.
RDOQ_DC_CR
, 0, 1.0, 1, 0.0, 1.0, },

456 {"RDOQ_QP_Num", &
cfg∑øms
.
RDOQ_QP_Num
, 0, 1.0, 1, 1.0, 9.0, },

457 {"RDOQ_CP_Mode", &
cfg∑øms
.
RDOQ_CP_Mode
, 0, 0.0, 1, 0.0, 1.0, },

458 {"RDOQ_CP_MV", &
cfg∑øms
.
RDOQ_CP_MV
, 0, 0.0, 1, 0.0, 1.0, },

459 {"RDOQ_Fa°", &
cfg∑øms
.
RDOQ_Fa°
, 0, 0.0, 1, 0.0, 1.0, },

461 {"Gíî©eSEIMesßge", &
cfg∑øms
.
Gíî©eSEIMesßge
, 0, 0.0, 1, 0.0, 1.0, },

462 {"E«bÀVUISuµ‹t", &
cfg∑øms
.
E«bÀVUISuµ‹t
, 0, 0.0, 1, 0.0, 1.0, },

463 {"VUI_a•e˘_øtio_öfo_¥e£¡_Êag", &
cfg∑øms
.
VUI
.
a•e˘_øtio_öfo_¥e£¡_Êag
, 0, 0.0, 1, 0.0, 1.0, },

464 {"VUI_a•e˘_øtio_idc", &
cfg∑øms
.
VUI
.
a•e˘_øtio_idc
, 0, 0.0, 1, 0.0, 255.0, },

465 {"VUI_ßr_width", &
cfg∑øms
.
VUI
.
ßr_width
, 0, 0.0, 2, 0.0, 0.0, },

466 {"VUI_ßr_height", &
cfg∑øms
.
VUI
.
ßr_height
, 0, 0.0, 2, 0.0, 0.0, },

467 {"VUI_ovîsˇn_öfo_¥e£¡_Êag", &
cfg∑øms
.
VUI
.
ovîsˇn_öfo_¥e£¡_Êag
, 0, 0.0, 1, 0.0, 1.0, },

468 {"VUI_ovîsˇn_≠¥›rüã_Êag", &
cfg∑øms
.
VUI
.
ovîsˇn_≠¥›rüã_Êag
, 0, 0.0, 1, 0.0, 1.0, },

469 {"VUI_video_sig«l_ty≥_¥e£¡_Êag", &
cfg∑øms
.
VUI
.
video_sig«l_ty≥_¥e£¡_Êag
, 0, 0.0, 1, 0.0, 1.0, },

470 {"VUI_video_f‹m©", &
cfg∑øms
.
VUI
.
video_f‹m©
, 0, 5.0, 1, 0.0, 7.0, },

471 {"VUI_video_fuŒ_ønge_Êag", &
cfg∑øms
.
VUI
.
video_fuŒ_ønge_Êag
, 0, 0.0, 1, 0.0, 1.0, },

472 {"VUI_cﬁour_des¸ùti⁄_¥e£¡_Êag", &
cfg∑øms
.
VUI
.
cﬁour_des¸ùti⁄_¥e£¡_Êag
, 0, 0.0, 1, 0.0, 1.0, },

473 {"VUI_cﬁour_¥im¨õs", &
cfg∑øms
.
VUI
.
cﬁour_¥im¨õs
, 0, 2.0, 1, 0.0, 255.0, },

474 {"VUI_å™s„r_ch¨a˘îi°ics", &
cfg∑øms
.
VUI
.
å™s„r_ch¨a˘îi°ics
, 0, 2.0, 1, 0.0, 255.0, },

475 {"VUI_m©rix_c€fficõ¡s", &
cfg∑øms
.
VUI
.
m©rix_c€fficõ¡s
, 0, 2.0, 1, 0.0, 255.0, },

476 {"VUI_chroma_loˇti⁄_öfo_¥e£¡_Êag", &
cfg∑øms
.
VUI
.
chroma_loˇti⁄_öfo_¥e£¡_Êag
, 0, 0.0, 1, 0.0, 1.0, },

477 {"VUI_chroma_ßm∂e_loc_ty≥_t›_fõld", &
cfg∑øms
.
VUI
.
chroma_ßm∂e_loc_ty≥_t›_fõld
, 0, 0.0, 1, 0.0, 5.0, },

478 {"VUI_chroma_ßm∂e_loc_ty≥_bŸtom_fõld",&
cfg∑øms
.
VUI
.
chroma_ßm∂e_loc_ty≥_bŸtom_fõld
,0, 0.0, 1, 0.0, 5.0, },

479 {"VUI_timög_öfo_¥e£¡_Êag", &
cfg∑øms
.
VUI
.
timög_öfo_¥e£¡_Êag
, 0, 0.0, 1, 0.0, 1.0, },

480 {"VUI_num_unôs_ö_tick", &
cfg∑øms
.
VUI
.
num_unôs_ö_tick
, 0,1000.0, 2, 0.0, 0.0, },

481 {"VUI_time_sˇÀ", &
cfg∑øms
.
VUI
.
time_sˇÀ
, 0,60000.0, 2, 0.0, 0.0, },

482 {"VUI_fixed_‰ame_øã_Êag", &
cfg∑øms
.
VUI
.
fixed_‰ame_øã_Êag
, 0, 0.0, 1, 0.0, 1.0, },

483 {"VUI_«l_hrd_∑ømëîs_¥e£¡_Êag", &
cfg∑øms
.
VUI
.
«l_hrd_∑ømëîs_¥e£¡_Êag
, 0, 0.0, 1, 0.0, 1.0, },

484 {"VUI_«l_˝b_˙t_möus1", &
cfg∑øms
.
VUI
.
«l_˝b_˙t_möus1
, 0, 0.0, 1, 0.0, 31.0, },

485 {"VUI_«l_bô_øã_sˇÀ", &
cfg∑øms
.
VUI
.
«l_bô_øã_sˇÀ
, 0, 0.0, 2, 0.0, 0.0, },

486 {"VUI_«l_˝b_size_sˇÀ", &
cfg∑øms
.
VUI
.
«l_˝b_size_sˇÀ
, 0, 0.0, 2, 0.0, 0.0, },

487 {"VUI_«l_bô_øã_vÆue_möus1", &
cfg∑øms
.
VUI
.
«l_bô_øã_vÆue_möus1
, 0, 0.0, 2, 0.0, 0.0, },

488 {"VUI_«l_˝b_size_vÆue_möus1", &
cfg∑øms
.
VUI
.
«l_˝b_size_vÆue_möus1
, 0, 0.0, 2, 0.0, 0.0, },

489 {"VUI_«l_vbr_cbr_Êag", &
cfg∑øms
.
VUI
.
«l_vbr_cbr_Êag
, 0, 1.0, 1, 0.0, 1.0, },

490 {"VUI_«l_öôül_˝b_ªmovÆ_dñay_Àngth_möus1", &
cfg∑øms
.
VUI
.
«l_öôül_˝b_ªmovÆ_dñay_Àngth_möus1
, 0, 23.0, 2, 0.0, 0.0, },

491 {"VUI_«l_˝b_ªmovÆ_dñay_Àngth_möus1",&
cfg∑øms
.
VUI
.
«l_˝b_ªmovÆ_dñay_Àngth_möus1
,0, 23.0, 2, 0.0, 0.0, },

492 {"VUI_«l_dpb_ouçut_dñay_Àngth_möus1", &
cfg∑øms
.
VUI
.
«l_dpb_ouçut_dñay_Àngth_möus1
, 0, 23.0, 2, 0.0, 0.0, },

493 {"VUI_«l_time_off£t_Àngth", &
cfg∑øms
.
VUI
.
«l_time_off£t_Àngth
, 0, 24.0, 2, 0.0, 0.0, },

494 {"VUI_v˛_hrd_∑ømëîs_¥e£¡_Êag", &
cfg∑øms
.
VUI
.
v˛_hrd_∑ømëîs_¥e£¡_Êag
, 0, 0.0, 1, 0.0, 1.0, },

495 {"VUI_v˛_˝b_˙t_möus1", &
cfg∑øms
.
VUI
.
v˛_˝b_˙t_möus1
, 0, 0.0, 1, 0.0, 31.0, },

496 {"VUI_v˛_bô_øã_sˇÀ", &
cfg∑øms
.
VUI
.
v˛_bô_øã_sˇÀ
, 0, 0.0, 2, 0.0, 0.0, },

497 {"VUI_v˛_˝b_size_sˇÀ", &
cfg∑øms
.
VUI
.
v˛_˝b_size_sˇÀ
, 0, 0.0, 2, 0.0, 0.0, },

498 {"VUI_v˛_bô_øã_vÆue_möus1", &
cfg∑øms
.
VUI
.
v˛_bô_øã_vÆue_möus1
, 0, 0.0, 2, 0.0, 0.0, },

499 {"VUI_v˛_˝b_size_vÆue_möus1", &
cfg∑øms
.
VUI
.
v˛_˝b_size_vÆue_möus1
, 0, 0.0, 2, 0.0, 0.0, },

500 {"VUI_v˛_vbr_cbr_Êag", &
cfg∑øms
.
VUI
.
v˛_vbr_cbr_Êag
, 0, 0.0, 1, 0.0, 1.0, },

501 {"VUI_v˛_öôül_˝b_ªmovÆ_dñay_Àngth_möus1", &
cfg∑øms
.
VUI
.
v˛_öôül_˝b_ªmovÆ_dñay_Àngth_möus1
, 0, 23.0, 2, 0.0, 0.0, },

502 {"VUI_v˛_˝b_ªmovÆ_dñay_Àngth_möus1",&
cfg∑øms
.
VUI
.
v˛_˝b_ªmovÆ_dñay_Àngth_möus1
,0, 23.0, 2, 0.0, 0.0, },

503 {"VUI_v˛_dpb_ouçut_dñay_Àngth_möus1", &
cfg∑øms
.
VUI
.
v˛_dpb_ouçut_dñay_Àngth_möus1
, 0, 23.0, 2, 0.0, 0.0, },

504 {"VUI_v˛_time_off£t_Àngth", &
cfg∑øms
.
VUI
.
v˛_time_off£t_Àngth
, 0, 24.0, 2, 0.0, 0.0, },

505 {"VUI_low_dñay_hrd_Êag", &
cfg∑øms
.
VUI
.
low_dñay_hrd_Êag
, 0, 0.0, 1, 0.0, 1.0, },

506 {"VUI_pic_°ru˘_¥e£¡_Êag", &
cfg∑øms
.
VUI
.
pic_°ru˘_¥e£¡_Êag
, 0, 0.0, 1, 0.0, 1.0, },

507 {"VUI_bô°ªam_ª°ri˘i⁄_Êag", &
cfg∑øms
.
VUI
.
bô°ªam_ª°ri˘i⁄_Êag
, 0, 0.0, 1, 0.0, 1.0, },

508 {"VUI_mŸi⁄_ve˘‹s_ovî_pic_bound¨õs_Êag", &
cfg∑øms
.
VUI
.
mŸi⁄_ve˘‹s_ovî_pic_bound¨õs_Êag
, 0, 1.0, 1, 0.0, 1.0, },

509 {"VUI_max_byãs_≥r_pic_díom", &
cfg∑øms
.
VUI
.
max_byãs_≥r_pic_díom
, 0, 2.0, 1, 0.0, 16.0, },

510 {"VUI_max_bôs_≥r_mb_díom", &
cfg∑øms
.
VUI
.
max_bôs_≥r_mb_díom
, 0, 1.0, 1, 0.0, 16.0, },

511 {"VUI_log2_max_mv_Àngth_vîtiˇl", &
cfg∑øms
.
VUI
.
log2_max_mv_Àngth_vîtiˇl
, 0, 16.0, 1, 0.0, 16.0, },

512 {"VUI_log2_max_mv_Àngth_h‹iz⁄èl", &
cfg∑øms
.
VUI
.
log2_max_mv_Àngth_h‹iz⁄èl
, 0, 16.0, 1, 0.0, 16.0, },

513 {"VUI_num_ª‹dî_‰ames", &
cfg∑øms
.
VUI
.
num_ª‹dî_‰ames
, 0, 16.0, 1, 0.0, 16.0, },

514 {"VUI_max_dec_‰ame_buf„rög", &
cfg∑øms
.
VUI
.
max_dec_‰ame_buf„rög
, 0, 16.0, 1, 0.0, 16.0, },

515 {"SEIMesßgeText", &
cfg∑øms
.
SEIMesßgeText
, 1, 0.0, 0, 0.0, 0.0, 
INPUT_TEXT_SIZE
,},

516 #i‡
B0_MORE_REF


517 {"BLevñ0M‹eRef", &
cfg∑øms
.
BLevñ0M‹eRef
, 0, 0.0, 1, 0.0, 1.0, },

519 #i‡
KEEP_B_SAME_LIST


520 {"BIdítiˇlLi°", &
cfg∑øms
.
BIdítiˇlLi°
, 0, 0.0, 1, 0.0, 2.0, },

522 #i‡
CRA


523 {"CRA", &
cfg∑øms
.
u£CRA
, 0, 0.0, 1, 0.0, 1.0, },

525 #i‡
HM50_LIKE_MMCO


526 {"HM50RefSåu˘uª", &
cfg∑øms
.
HM50RefSåu˘uª
, 0, 0.0, 1, 0.0, 1.0, },

528 #i‡
LD_REF_SETTING


529 {"LDRefSëtög", &
cfg∑øms
.
LDRefSëtög
, 0, 0.0, 1, 0.0, 1.0, },

531 {
NULL
, NULL, -1, 0.0, 0, 0.0, 0.0, },

535 #i‡(
MVC_EXTENSION_ENABLE
)

536 
M≠pög
 
	gM≠Võw1
[] = {

537 {"I≈utFûe", &
cfg∑øms
.
öput_fûe2
.
‚ame
, 1, 0.0, 0, 0.0, 0.0, 
FILE_NAME_SIZE
, },

538 {"Rec⁄Fûe", &
cfg∑øms
.
Rec⁄Fûe2
, 1, 0.0, 0, 0.0, 0.0, 
FILE_NAME_SIZE
, },

539 {"SórchR™ge", &
cfg∑øms
.
£¨ch_ønge
[1], 0, 16.0, 2, 0.0, 0.0, },

540 {"DißbÀSub≥lME", &
cfg∑øms
.
DißbÀSub≥lME
[1], 0, 0.0, 1, 0.0, 1.0, },

541 {"DißbÀI¡øInI¡î", &
cfg∑øms
.
DißbÀI¡øInI¡î
[1], 0, 0.0, 1, 0.0, 1.0, },

542 {"MVCI¡îVõwRe‹dî", &
cfg∑øms
.
MVCI¡îVõwRe‹dî
, 0, 0.0, 1, 0.0, 2.0, },

543 {"MVCFlùVõws", &
cfg∑øms
.
MVCFlùVõws
, 0, 0.0, 1, 0.0, 1.0, },

544 {"QPOff£t", &
cfg∑øms
.
Võw1QPOff£t
, 0, 0.0, 0, (Ë-
MAX_QP
, () MAX_QP, },

545 {"MVCI¡îVõwF‹˚B", &
cfg∑øms
.
MVCI¡îVõwF‹˚B
, 0, 0.0, 1, 0.0, 1.0, },

546 {"MVCE«bÀI¡îVõwFœg", &
cfg∑øms
.
íabÀ_öãr_võw_Êag
, 0, 1.0, 1, 0.0, 1.0, },

547 {"SïVõwI¡îSórch", &
cfg∑øms
.
SïVõwI¡îSórch
, 0, 0.0, 1, 0.0, 1.0, },

548 {"NoResidueRDO", &
cfg∑øms
.
Võw1NoResidueRDO
, 0, 1.0, 1, 0.0, 1.0, },

549 {"PLi°0Re„ªn˚s", &
cfg∑øms
.
P_Li°0_ªfs
[1], 0, 0.0, 1, 0.0, 16.0, },

550 {"BLi°0Re„ªn˚s", &
cfg∑øms
.
B_Li°0_ªfs
[1], 0, 0.0, 1, 0.0, 16.0, },

551 {"BLi°1Re„ªn˚s", &
cfg∑øms
.
B_Li°1_ªfs
[1], 0, 1.0, 1, 0.0, 16.0, },

552 {"LambdaMu…ùlõr", &
cfg∑øms
.
íh_œyî_œmbda_mu…ùlõr
, 2, 1.0, 2, 0.0, 0.0, },

553 {"MELambdaMu…ùlõr", &
cfg∑øms
.
íh_œyî_me_œmbda_mu…ùlõr
, 2, 1.0, 2, 0.0, 0.0, },

554 {"PSli˚Skù", &
cfg∑øms
.
I¡îSórch
[1][0][0], 0, 1.0, 1, 0.0, 1.0, },

555 {"PSli˚Sórch16x16", &
cfg∑øms
.
I¡îSórch
[1][0][1], 0, 1.0, 1, 0.0, 1.0, },

556 {"PSli˚Sórch16x8", &
cfg∑øms
.
I¡îSórch
[1][0][2], 0, 1.0, 1, 0.0, 1.0, },

557 {"PSli˚Sórch8x16", &
cfg∑øms
.
I¡îSórch
[1][0][3], 0, 1.0, 1, 0.0, 1.0, },

558 {"PSli˚Sórch8x8", &
cfg∑øms
.
I¡îSórch
[1][0][4], 0, 1.0, 1, 0.0, 1.0, },

559 {"PSli˚Sórch8x4", &
cfg∑øms
.
I¡îSórch
[1][0][5], 0, 1.0, 1, 0.0, 1.0, },

560 {"PSli˚Sórch4x8", &
cfg∑øms
.
I¡îSórch
[1][0][6], 0, 1.0, 1, 0.0, 1.0, },

561 {"PSli˚Sórch4x4", &
cfg∑øms
.
I¡îSórch
[1][0][7], 0, 1.0, 1, 0.0, 1.0, },

563 {"BSli˚Dúe˘", &
cfg∑øms
.
I¡îSórch
[1][1][0], 0, 1.0, 1, 0.0, 1.0, },

564 {"BSli˚Sórch16x16", &
cfg∑øms
.
I¡îSórch
[1][1][1], 0, 1.0, 1, 0.0, 1.0, },

565 {"BSli˚Sórch16x8", &
cfg∑øms
.
I¡îSórch
[1][1][2], 0, 1.0, 1, 0.0, 1.0, },

566 {"BSli˚Sórch8x16", &
cfg∑øms
.
I¡îSórch
[1][1][3], 0, 1.0, 1, 0.0, 1.0, },

567 {"BSli˚Sórch8x8", &
cfg∑øms
.
I¡îSórch
[1][1][4], 0, 1.0, 1, 0.0, 1.0, },

568 {"BSli˚Sórch8x4", &
cfg∑øms
.
I¡îSórch
[1][1][5], 0, 1.0, 1, 0.0, 1.0, },

569 {"BSli˚Sórch4x8", &
cfg∑øms
.
I¡îSórch
[1][1][6], 0, 1.0, 1, 0.0, 1.0, },

570 {"BSli˚Sórch4x4", &
cfg∑øms
.
I¡îSórch
[1][1][7], 0, 1.0, 1, 0.0, 1.0, },

571 {"BiPªdMESórchR™ge", &
cfg∑øms
.
BiPªdMESórchR™ge
[1], 0, 8.0, 2, 0.0, 0.0, },

572 {"MDRe„ªn˚", &
cfg∑øms
.
MDRe„ªn˚
[1], 0, 0.0, 1, 0.0, 1.0, },

573 {"DFDißbÀRefISli˚", &
cfg∑øms
.
EnhLayîDFDißbÀIdc
[1][
I_SLICE
], 0, 0.0, 1, 0.0, 2.0, },

574 {"DFDißbÀNRefISli˚", &
cfg∑øms
.
EnhLayîDFDißbÀIdc
[0][
I_SLICE
], 0, 0.0, 1, 0.0, 2.0, },

575 {"DFDißbÀRefPSli˚", &
cfg∑øms
.
EnhLayîDFDißbÀIdc
[1][
P_SLICE
], 0, 0.0, 1, 0.0, 2.0, },

576 {"DFDißbÀNRefPSli˚", &
cfg∑øms
.
EnhLayîDFDißbÀIdc
[0][
P_SLICE
], 0, 0.0, 1, 0.0, 2.0, },

577 {"DFDißbÀRefBSli˚", &
cfg∑øms
.
EnhLayîDFDißbÀIdc
[1][
B_SLICE
], 0, 0.0, 1, 0.0, 2.0, },

578 {"DFDißbÀNRefBSli˚", &
cfg∑øms
.
EnhLayîDFDißbÀIdc
[0][
B_SLICE
], 0, 0.0, 1, 0.0, 2.0, },

579 {"DFDißbÀRefSPSli˚", &
cfg∑øms
.
EnhLayîDFDißbÀIdc
[1][
SP_SLICE
], 0, 0.0, 1, 0.0, 2.0, },

580 {"DFDißbÀNRefSPSli˚", &
cfg∑øms
.
EnhLayîDFDißbÀIdc
[0][
SP_SLICE
], 0, 0.0, 1, 0.0, 2.0, },

581 {"DFDißbÀRefSISli˚", &
cfg∑øms
.
EnhLayîDFDißbÀIdc
[1][
SI_SLICE
], 0, 0.0, 1, 0.0, 2.0, },

582 {"DFDißbÀNRefSISli˚", &
cfg∑øms
.
EnhLayîDFDißbÀIdc
[0][
SI_SLICE
], 0, 0.0, 1, 0.0, 2.0, },

583 {"DFAÕhaRefISli˚", &
cfg∑øms
.
EnhLayîDFAÕha
[1][
I_SLICE
], 0, 0.0, 1, -6.0, 6.0, },

584 {"DFAÕhaNRefISli˚", &
cfg∑øms
.
EnhLayîDFAÕha
[0][
I_SLICE
], 0, 0.0, 1, -6.0, 6.0, },

585 {"DFAÕhaRefPSli˚", &
cfg∑øms
.
EnhLayîDFAÕha
[1][
P_SLICE
], 0, 0.0, 1, -6.0, 6.0, },

586 {"DFAÕhaNRefPSli˚", &
cfg∑øms
.
EnhLayîDFAÕha
[0][
P_SLICE
], 0, 0.0, 1, -6.0, 6.0, },

587 {"DFAÕhaRefBSli˚", &
cfg∑øms
.
EnhLayîDFAÕha
[1][
B_SLICE
], 0, 0.0, 1, -6.0, 6.0, },

588 {"DFAÕhaNRefBSli˚", &
cfg∑øms
.
EnhLayîDFAÕha
[0][
B_SLICE
], 0, 0.0, 1, -6.0, 6.0, },

589 {"DFAÕhaRefSPSli˚", &
cfg∑øms
.
EnhLayîDFAÕha
[1][
SP_SLICE
], 0, 0.0, 1, -6.0, 6.0, },

590 {"DFAÕhaNRefSPSli˚", &
cfg∑øms
.
EnhLayîDFAÕha
[0][
SP_SLICE
], 0, 0.0, 1, -6.0, 6.0, },

591 {"DFAÕhaRefSISli˚", &
cfg∑øms
.
EnhLayîDFAÕha
[1][
SI_SLICE
], 0, 0.0, 1, -6.0, 6.0, },

592 {"DFAÕhaNRefSISli˚", &
cfg∑øms
.
EnhLayîDFAÕha
[0][
SI_SLICE
], 0, 0.0, 1, -6.0, 6.0, },

593 {"DFBëaRefISli˚", &
cfg∑øms
.
EnhLayîDFBëa
[1][
I_SLICE
], 0, 0.0, 1, -6.0, 6.0, },

594 {"DFBëaNRefISli˚", &
cfg∑øms
.
EnhLayîDFBëa
[0][
I_SLICE
], 0, 0.0, 1, -6.0, 6.0, },

595 {"DFBëaRefPSli˚", &
cfg∑øms
.
EnhLayîDFBëa
[1][
P_SLICE
], 0, 0.0, 1, -6.0, 6.0, },

596 {"DFBëaNRefPSli˚", &
cfg∑øms
.
EnhLayîDFBëa
[0][
P_SLICE
], 0, 0.0, 1, -6.0, 6.0, },

597 {"DFBëaRefBSli˚", &
cfg∑øms
.
EnhLayîDFBëa
[1][
B_SLICE
], 0, 0.0, 1, -6.0, 6.0, },

598 {"DFBëaNRefBSli˚", &
cfg∑øms
.
EnhLayîDFBëa
[0][
B_SLICE
], 0, 0.0, 1, -6.0, 6.0, },

599 {"DFBëaRefSPSli˚", &
cfg∑øms
.
EnhLayîDFBëa
[1][
SP_SLICE
], 0, 0.0, 1, -6.0, 6.0, },

600 {"DFBëaNRefSPSli˚", &
cfg∑øms
.
EnhLayîDFBëa
[0][
SP_SLICE
], 0, 0.0, 1, -6.0, 6.0, },

601 {"DFBëaRefSISli˚", &
cfg∑øms
.
EnhLayîDFBëa
[1][
SI_SLICE
], 0, 0.0, 1, -6.0, 6.0, },

602 {"DFBëaNRefSISli˚", &
cfg∑øms
.
EnhLayîDFBëa
[0][
SI_SLICE
], 0, 0.0, 1, -6.0, 6.0, },

603 {"SórchMode", &
cfg∑øms
.
SórchMode
[1], 0, 0.0, 1, -1.0, 3.0, },

604 {"EPZSTemp‹Æ", &
cfg∑øms
.
EPZSTemp‹Æ
[1], 0, 0.0, 1, 0.0, 1.0, },

605 {"E«bÀEPZSSˇÀrs", &
cfg∑øms
.
E«bÀEnhLayîEPZSSˇÀrs
, 0, 0.0, 1, 0.0, 1.0, },

606 {"EPZSMöThªsSˇÀ", &
cfg∑øms
.
EPZSMöThªsSˇÀ
[1], 0, 0.0, 0, 0.0, 0.0, },

607 {"EPZSMaxThªsSˇÀ", &
cfg∑øms
.
EPZSMaxThªsSˇÀ
[1], 0, 2.0, 0, 0.0, 0.0, },

608 {"EPZSMedThªsSˇÀ", &
cfg∑øms
.
EPZSMedThªsSˇÀ
[1], 0, 1.0, 0, 0.0, 0.0, },

609 {"EPZSSubPñThªsSˇÀ", &
cfg∑øms
.
EPZSSubPñThªsSˇÀ
[1], 0, 1.0, 0, 0.0, 0.0, },

610 {
NULL
, NULL, -1, 0.0, 0, 0.0, 0.0, },

616 #i‚de‡
INCLUDED_BY_CONFIGFILE_C


617 
M≠pög
 
M≠
[];

618 
M≠pög
 
M≠Võw1
[];

621 
C⁄figuª
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
ac
, *
av
[]);

622 
gë_numbî_of_‰ames
 (
I≈utP¨amëîs
 *
p_I≈
, 
VideoD©aFûe
 *
öput_fûe
);

623 
ªad_¶i˚_group_öfo
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
);

	@lencod/inc/conformance.h

15 #i‚de‡
_CONFORMANCE_H_


16 
	#_CONFORMANCE_H_


	)

18 
¥ofûe_check
 (
I≈utP¨amëîs
 *
p_I≈
);

19 
Àvñ_check
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
);

20 
upd©e_mv_limôs
 (
VideoP¨amëîs
 *
p_Vid
, 
byã
 
is_fõld
);

21 
˛ù_mv_ønge
 (
VideoP¨amëîs
 *
p_Vid
, 
£¨ch_ønge
, 
MŸi⁄Ve˘‹
 *
mv
, 
ªs
);

22 
out_of_bounds_mvs
 (
VideoP¨amëîs
 *
p_Vid
, c⁄° 
MŸi⁄Ve˘‹
 *
mv
);

23 
ã°_˛ù_mvs
 (
VideoP¨amëîs
 *
p_Vid
, 
MŸi⁄Ve˘‹
 *
mv
, 
Boﬁón
 
wrôe_mb
);

24 
Boﬁón
 
CheckPªdi˘i⁄P¨ams
(
Ma¸oblock
 *
cuºMB
, 
Block8x8Info
 *
b8x8öfo
, 
mode
);

26 
gëMaxMBPS
(
ÀvñIdc
);

27 
gëMöCR
 (
ÀvñIdc
);

28 
gëMaxBR
 (
ÀvñIdc
);

29 
gëMaxCPB
 (
ÀvñIdc
);

	@lencod/inc/context_ini.h

16 #i‚de‡
_CONTEXT_INI_


17 
	#_CONTEXT_INI_


	)

19 
¸óã_c⁄ãxt_mem‹y
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
);

20 
‰ì_c⁄ãxt_mem‹y
 (
VideoP¨amëîs
 *
p_Vid
);

21 
upd©e_fõld_‰ame_c⁄ãxts
 (
VideoP¨amëîs
 *
p_Vid
, );

22 
SëCtxModñNumbî
 (
Sli˚
 *
cuºSli˚
);

23 
öô_c⁄ãxts
 (
Sli˚
 *
cuºSli˚
);

24 
°‹e_c⁄ãxts
 (
Sli˚
 *
cuºSli˚
);

	@lencod/inc/contributors.h

	@lencod/inc/defines.h

21 #i‚de‡
_DEFINES_H_


22 
	#_DEFINES_H_


	)

24 #i‡
deföed
 
_DEBUG


25 
	#TRACE
 0

26 #ñ£

	)

27 
	#TRACE
 0

29 

	)

30 
	#JM
 "18 (FRExt)"

	)

31 
	#VERSION
 "18.4"

	)

32 
	#EXT_VERSION
 "(FRExt)"

	)

34 
	#GET_METIME
 1

35 
	#DUMP_DPB
 0

36 
	#PRINTREFLIST
 0

37 
	#IMGTYPE
 1

38 
	#ENABLE_FIELD_CTX
 1

39 
	#ENABLE_HIGH444_CTX
 1

40 
	#DEBUG_BITDEPTH
 0

41 
	#ALLOW_GRAYSCALE
 1

42 
	#ZEROSNR
 1

43 
	#USE_RND_COST
 0

44 
	#JM_INT_DIVIDE
 1

	)

45 
	#JM_MEM_DISTORTION
 0

	)

46 
	#JCOST_CALC_SCALEUP
 1

47 
	#INTRA_RDCOSTCALC_ET
 1

48 
	#INTRA_RDCOSTCALC_NNZ
 1

49 
	#JCOST_OVERFLOWCHECK
 0

50 
	#JM_PARALLEL_DEBLOCK
 0

51 
	#SIMULCAST_ENABLE
 0

	)

53 
	#MVC_EXTENSION_ENABLE
 1

54 
	#EOS_OUTPUT
 0

	)

56 
	#EPZSREF
 1

	)

58 
	#MAX_RC_MODE
 3

	)

59 
	#RC_MAX_TEMPORAL_LEVELS
 5

	)

61 
	#SSE_MEMORY_ALIGNMENT
 16

	)

62 
	#MAX_NUM_DPB_LAYERS
 2

	)

66 
	#OUTPUT_REF_LIST
 0

67 

	)

68 
	#B0_MORE_REF
 1

69 
	#KEEP_B_SAME_LIST
 1

70 
	#CRA
 1

75 
	#HM50_LIKE_MMCO
 1

76 
	#LD_REF_SETTING
 1

77 

	)

81 
	mFREXT_CAVLC444
 = 44,

82 
	mBASELINE
 = 66,

83 
	mMAIN
 = 77,

84 
	mEXTENDED
 = 88,

85 
	mFREXT_HP
 = 100,

86 
	mFREXT_Hi10P
 = 110,

87 
	mFREXT_Hi422
 = 122,

88 
	mFREXT_Hi444
 = 244,

89 
	mMULTIVIEW_HIGH
 = 118,

90 
	mSTEREO_HIGH
 = 128

91 } 
	gProfûeIDC
;

94 
	~"ty≥s.h
"

96 
	#FILE_NAME_SIZE
 255

	)

97 
	#INPUT_TEXT_SIZE
 1024

	)

99 
	#CAVLC_LEVEL_LIMIT
 2063

	)

101 #i‡(
ENABLE_HIGH444_CTX
 == 1)

102 
	#NUM_BLOCK_TYPES
 22

	)

104 
	#NUM_BLOCK_TYPES
 10

	)

107 
	#_LEAKYBUCKET_


	)

113 
	#_LUMA_COEFF_COST_
 4

114 
	#_CHROMA_COEFF_COST_
 4

115 
	#_LUMA_MB_COEFF_COST_
 5

116 
	#_LUMA_8x8_COEFF_COST_
 5

117 

	)

120 
	#IMG_PAD_SIZE_X
 32

121 
	#IMG_PAD_SIZE_Y
 20

122 

	)

123 
	#MAX_VALUE
 999999

124 
	#INVALIDINDEX
 (-135792468)

	)

126 
	#DUMMY
 14

	)

127 
	#ET_SIZE
 300

128 

	)

129 
	#LAMBDA_ACCURACY_BITS
 5

	)

130 
	#LAMBDA_FACTOR
(
œmbda
Ë(()(()(1 << 
LAMBDA_ACCURACY_BITS
Ë*Üambd®+ 0.5))

	)

132 #i‡(
IMGTYPE
 == 0)

133 
	#DISTBLK_MAX
 
INT_MAX


	)

135 
	#DISTBLK_MAX
 ((
di°blk
Ë
INT_MAX
 << 
LAMBDA_ACCURACY_BITS
)

	)

138 
	#MAXSLICEPERPICTURE
 100

	)

139 
	#MAX_REFERENCE_PICTURES
 32

	)

141 
	#BLOCK_SHIFT
 2

	)

142 
	#BLOCK_SIZE
 4

	)

143 
	#BLOCK_SIZE_8x8
 8

	)

144 
	#SMB_BLOCK_SIZE
 8

	)

145 
	#BLOCK_PIXELS
 16

	)

146 
	#MB_BLOCK_SIZE
 16

	)

147 
	#MB_PIXELS
 256

148 
	#MB_PIXELS_SHIFT
 8

149 
	#MB_BLOCK_SHIFT
 4

	)

150 
	#BLOCK_MULTIPLE
 4

151 
	#MB_BLOCK_PARTITIONS
 16

152 
	#BLOCK_CONTEXT
 64

154 
	#BLOCK_SIZE_SP
 16

155 
	#BLOCK_SIZE_8x8_SP
 32

156 

	)

158 
	#NUM_WAVELET_LEVEL
 4

	)

161 
	#MAX_PREC_COEFF
 25

	)

167 
	mPSKIP
 = 0,

168 
	mBSKIP_DIRECT
 = 0,

169 
	mP16x16
 = 1,

170 
	mP16x8
 = 2,

171 
	mP8x16
 = 3,

172 
	mSMB8x8
 = 4,

173 
	mSMB8x4
 = 5,

174 
	mSMB4x8
 = 6,

175 
	mSMB4x4
 = 7,

176 
	mP8x8
 = 8,

177 
	mI4MB
 = 9,

178 
	mI16MB
 = 10,

179 
	mIBLOCK
 = 11,

180 
	mSI4MB
 = 12,

181 
	mI8MB
 = 13,

182 
	mIPCM
 = 14,

183 
	mMAXMODE
 = 15

184 } 
	gMBModeTy≥s
;

187 
	#NO_INTRA_PMODE
 9

	)

191 
	mDIR_TEMPORAL
 = 0,

192 
	mDIR_SPATIAL
 = 1

193 } 
	gDúe˘Modes
;

197 
	mLUMA
 = 0,

198 
	mLUMA_INTRA16x16DC
 = 1,

199 
	mLUMA_INTRA16x16AC
 = 2,

200 
	mCB
 = 3,

201 
	mCB_INTRA16x16DC
 = 4,

202 
	mCB_INTRA16x16AC
 = 5,

203 
	mCR
 = 8,

204 
	mCR_INTRA16x16DC
 = 9,

205 
	mCR_INTRA16x16AC
 = 10

206 } 
	gCAVLCBlockTy≥s
;

210 
	mLUMA_16DC
 = 0,

211 
	mLUMA_16AC
 = 1,

212 
	mLUMA_8x8
 = 2,

213 
	mLUMA_8x4
 = 3,

214 
	mLUMA_4x8
 = 4,

215 
	mLUMA_4x4
 = 5,

216 
	mCHROMA_DC
 = 6,

217 
	mCHROMA_AC
 = 7,

218 
	mCHROMA_DC_2x4
 = 8,

219 
	mCHROMA_DC_4x4
 = 9,

220 
	mCB_16DC
 = 10,

221 
	mCB_16AC
 = 11,

222 
	mCB_8x8
 = 12,

223 
	mCB_8x4
 = 13,

224 
	mCB_4x8
 = 14,

225 
	mCB_4x4
 = 15,

226 
	mCR_16DC
 = 16,

227 
	mCR_16AC
 = 17,

228 
	mCR_8x8
 = 18,

229 
	mCR_8x4
 = 19,

230 
	mCR_4x8
 = 20,

231 
	mCR_4x4
 = 21

232 } 
	gCABACBlockTy≥s
;

236 
	mY_COMP
 = 0,

237 
	mU_COMP
 = 1,

238 
	mV_COMP
 = 2,

239 
	mR_COMP
 = 3,

240 
	mG_COMP
 = 4,

241 
	mB_COMP
 = 5,

242 
	mT_COMP
 = 6

243 } 
	gCﬁ‹Comp⁄ít
;

246 
	#LEVEL_NUM
 6

	)

247 
	#TOTRUN_NUM
 15

	)

248 
	#RUNBEFORE_NUM
 7

	)

249 
	#RUNBEFORE_NUM_M1
 6

	)

252 
	#MIN_QP
 0

	)

253 
	#MAX_QP
 51

	)

254 
	#SHIFT_QP
 12

	)

258 
	mVERT_PRED
 = 0,

259 
	mHOR_PRED
 = 1,

260 
	mDC_PRED
 = 2,

261 
	mDIAG_DOWN_LEFT_PRED
 = 3,

262 
	mDIAG_DOWN_RIGHT_PRED
 = 4,

263 
	mVERT_RIGHT_PRED
 = 5,

264 
	mHOR_DOWN_PRED
 = 6,

265 
	mVERT_LEFT_PRED
 = 7,

266 
	mHOR_UP_PRED
 = 8

267 } 
	gI4x4PªdModes
;

271 
	mVERT_PRED_16
 = 0,

272 
	mHOR_PRED_16
 = 1,

273 
	mDC_PRED_16
 = 2,

274 
	mPLANE_16
 = 3

275 } 
	gI16x16PªdModes
;

279 
	mDC_PRED_8
 = 0,

280 
	mHOR_PRED_8
 = 1,

281 
	mVERT_PRED_8
 = 2,

282 
	mPLANE_8
 = 3

283 } 
	gI8x8PªdModes
;

285 
	#INIT_FRAME_RATE
 30

	)

287 
	mEOS
 = 1,

288 
	mSOP
 = 2,

289 
	mSOS
 = 3

294 
	mMVPRED_MEDIAN
 = 0,

295 
	mMVPRED_L
 = 1,

296 
	mMVPRED_U
 = 2,

297 
	mMVPRED_UR
 = 3

298 } 
	gMVPªdTy≥s
;

300 
	#MAX_SYMBOLS_PER_MB
 1200

302 

	)

304 
	#MAX_PART_NR
 3

	)

309 
	#ZEROBYTES_SHORTSTARTCODE
 2

310 

	)

311 
	#Q_BITS
 15

	)

312 
	#DQ_BITS
 6

	)

314 
	#Q_BITS_8
 16

	)

315 
	#DQ_BITS_8
 6

	)

318 
	#CALM_MF_FACTOR_THRESHOLD
 512.0

	)

320 
	#MAX_PLANE
 3

	)

322 
	#MAXSLICEGROUPIDS
 8

	)

325 
	#NUM_MB_TYPE_CTX
 11

	)

326 
	#NUM_B8_TYPE_CTX
 9

	)

327 
	#NUM_MV_RES_CTX
 10

	)

328 
	#NUM_REF_NO_CTX
 6

	)

329 
	#NUM_DELTA_QP_CTX
 4

	)

330 
	#NUM_MB_AFF_CTX
 4

	)

332 
	#NUM_TRANSFORM_SIZE_CTX
 3

	)

334 
	#NUM_IPR_CTX
 2

	)

335 
	#NUM_CIPR_CTX
 4

	)

336 
	#NUM_CBP_CTX
 4

	)

337 
	#NUM_BCBP_CTX
 4

	)

338 
	#NUM_MAP_CTX
 15

	)

339 
	#NUM_LAST_CTX
 15

	)

340 
	#NUM_ONE_CTX
 5

	)

341 
	#NUM_ABS_CTX
 5

	)

345 
	mOTF_L0
 = 0,

346 
	mOTF_L1
 = 1,

347 
	mOTF_L2
 = 2

348 } 
	gOTFMode
;

352 
	mOTF_ME
 = 0,

353 
	mOTF_MC
 = 1

354 } 
	gOTFFun˘i⁄
;

356 #i‡
IMGTYPE


357 #i‡
JM_MEM_DISTORTION


358 #¥agm®
mesßge
("JM_MEM_DISTORTION must be zero!")

	@lencod/inc/elements.h

22 #i‚de‡
_ELEMENTS_H_


23 
	#_ELEMENTS_H_


	)

30 
	#MAXPARTITIONMODES
 2

31 

	)

84 c⁄° * 
assignSE2∑πôi⁄
[2];

85 c⁄° 
assignSE2∑πôi⁄_NoDP
[
SE_MAX_ELEMENTS
];

86 c⁄° 
assignSE2∑πôi⁄_DP
[
SE_MAX_ELEMENTS
];

	@lencod/inc/errdo.h

15 #i‚de‡
_ERRDO_H_


16 
	#_ERRDO_H_


	)

21 
	mLLN
 = 0,

22 
	mROPE
 = 1,

23 
	mRMPC
 = 2,

24 } 
	tDE_Ty≥
;

26 
	sdi°‹ti⁄_e°im©i⁄


29 ** 
	mªs_c⁄_diff_Y
;

30 *** 
	mªs_c⁄_diff_UV
;

31 ** 
	mp_ªs_c⁄_diff
[
MAX_PLANE
];

32 ** 
	mMV_c⁄_diff_Y
;

33 *** 
	mMV_c⁄_diff_UV
;

34 ** 
	mp_MV_c⁄_diff
[
MAX_PLANE
];

35 
byã
 ** 
	mîr‹_sign_Êag_Y
;

36 
byã
 ***
	mîr‹_sign_Êag_UV
;

37 
byã
 ** 
	mp_îr‹_sign_Êag
[
MAX_PLANE
];

38 ** 
	må™smissi⁄_di°_Y
;

39 *** 
	må™smissi⁄_di°_UV
;

40 ** 
	mp_å™smissi⁄_di°
[
MAX_PLANE
];

41 ** 
	må™smissi⁄_îr_Y
;

42 *** 
	må™smissi⁄_îr_UV
;

43 ** 
	mp_å™smissi⁄_îr
[
MAX_PLANE
];

46 
img≥l
 *** 
	mdec_imgY
;

47 
img≥l
 **** 
	mdec_imgUV
;

48 
img≥l
 *** 
	mp_dec_img
[
MAX_PLANE
];

49 
byã
 *** 
	mmb_îr‹_m≠
;

52 
img≥l
 ** 
	mfú°_momít_Y
;

53 
img≥l
 *** 
	mfú°_momít_UV
;

54 
img≥l
 ** 
	mp_fú°_momít
[
MAX_PLANE
];

55 
uöt16
 ** 
	m£c⁄d_momít_Y
;

56 
uöt16
 *** 
	m£c⁄d_momít_UV
;

57 
uöt16
 ** 
	mp_£c⁄d_momít
[
MAX_PLANE
];

62 
	sdecodîs


64 ***
	mªs_img
;

65 ***
	mªs_mb_be°8x8
;

68 **
	mRCD_be°Y_mb
;

69 ***
	mRCD_be°Y_b8x8
;

70 **
	mMVCD_be°Y_mb
;

71 ***
	mMVCD_be°Y_b8x8
;

72 
byã
 **
	mÊag_be°Y_mb
;

73 
byã
 ***
	mÊag_be°Y_b8x8
;

74 
byã
 **
	mÊag_wo_ªs
;

75 
byã
 ***
	mÊag_wo_ªs_be°Y_b8x8
;

76 **
	må™s_di°_be°Y_mb
;

77 ***
	må™s_di°_be°Y_b8x8
;

78 **
	må™s_di°_wo_ªs
;

79 ***
	må™s_di°_wo_ªs_be°Y_b8x8
;

80 **
	må™s_îr_be°Y_mb
;

81 ***
	må™s_îr_be°Y_b8x8
;

82 **
	må™s_îr_wo_ªs
;

83 ***
	må™s_îr_wo_ªs_be°Y_b8x8
;

86 
img≥l
 ***
	mdec_mbY_be°
;

87 
img≥l
 ****
	mdec_mbY_be°8x8
;

88 
img≥l
 ****
	mdec_mb_¥ed_be°8x8
;

89 
img≥l
 ***
	mdec_mb_¥ed
;

90 
	mªc_ty≥
;

93 
img≥l
 **
	mfú°_momít_be°Y_mb
;

94 
img≥l
 ***
	mfú°_momít_be°Y_b8x8
;

95 
img≥l
 ***
	mfú°_momít_¥ed_be°Y_b8x8
;

96 
img≥l
 **
	mfú°_momít_¥ed
;

97 
uöt16
 **
	m£c⁄d_momít_be°Y_mb
;

98 
uöt16
 ***
	m£c⁄d_momít_be°Y_b8x8
;

99 
uöt16
 ***
	m£c⁄d_momít_¥ed_be°Y_b8x8
;

100 
uöt16
 **
	m£c⁄d_momít_¥ed
;

103 
decodîs
 
	tDecodîs
;

107 
öô_îr‹_c⁄˚Æ
 (
VideoP¨amëîs
 *
p_Vid
, 
c⁄˚Æmít_ty≥
);

108 
îrdo_compuã_ªsidue
 (
Ma¸oblock
 *
cuºMB
, 
img≥l
 **
imgY
, **
ªs_img
, img≥»**
mb_¥ed
, 
b8block
, 
block_size
);

109 
Æloˇã_îrdo_mem
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
);

110 
‰ì_îrdo_mem
 (
VideoP¨amëîs
 *
p_Vid
);

112 
öô_di°‹ti⁄_e°im©i⁄
 (
VideoP¨amëîs
 *
p_Vid
, 
de_Æg‹ôhm
);

113 
îrdo_°‹e_be°_b8x8
(
Ma¸oblock
 *
cuºMB
, 
å™sf‹m8x8
, 
block
);

114 
îrdo_gë_be°_b8x8
(
Ma¸oblock
 *
cuºMB
, 
å™sf‹m8x8
, 
block
);

115 
îrdo_°‹e_be°_MB
(
Ma¸oblock
 *
cuºMB
);

116 
îrdo_gë_be°_MB
(
Ma¸oblock
 *
cuºMB
);

117 
îrdo_gë_be°_P8x8
(
Ma¸oblock
 *
cuºMB
, 
å™sf‹m8x8
);

118 
îrdo_Æloc_°‹abÀ_pi˘uª
(
St‹abÀPi˘uª
 *
s
, 
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
size_x
, 
size_y
, 
size_x_¸
, 
size_y_¸
);

119 
îrdo_‰ì_°‹abÀ_pi˘uª
(
St‹abÀPi˘uª
* 
p
);

120 
St‹abÀPi˘uª
* 
föd_√¨e°_ªf_pi˘uª
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
poc
);

	@lencod/inc/errdo_dist_mhyp.h

14 #i‚de‡
_ERRDO_DIST_MHYP_H_


15 
	#_ERRDO_DIST_MHYP_H_


	)

17 
îrdo_°‹e_be°_block_mu…ihyp
 (
I≈utP¨amëîs
 *
p_I≈
, 
img≥l
*** 
mbY
, img≥l*** 
dec_img
, 
block
, 
img_i
, 
img_j
, 
block_size
);

18 
îrdo_gë_be°_block_mu…ihyp
 (
Ma¸oblock
 *
cuºMB
, 
img≥l
*** 
dec_img
, img≥l*** 
mbY
, 
block
, 
block_size
);

19 
di°blk
 
îrdo_di°‹ti⁄_e°im©i⁄_mu…ihyp
(
Ma¸oblock
 *
cuºMB
, 
block
, 
block_size
, 
mode
, 
pdú
, di°blk 
mö_rdco°
);

20 
c›y_c⁄˚Æ_pi˘uª
 (
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
íc_pic
, 
decodî
);

	@lencod/inc/explicit_gop.h

15 #i‚de‡
_EXPLICIT_GOP_H_


16 
	#_EXPLICIT_GOP_H_


	)

19 
öô_g›_°ru˘uª
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
);

20 
öãΩªt_g›_°ru˘uª
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
);

21 
˛ór_g›_°ru˘uª
 (
VideoP¨amëîs
 *
p_Vid
);

	@lencod/inc/explicit_seq.h

15 #i‚de‡
_EXPLICIT_SEQ_H_


16 
	#_EXPLICIT_SEQ_H_


	)

21 
	m£q_numbî
;

22 
	m¶i˚_ty≥
;

23 
	mis_idr
;

24 
	mª„ªn˚_idc
;

25 
	m‰ame_qp
;

26 
	mdeblockög
;

27 
	mis_fõld
;

28 } 
	tExpFømeInfo
;

30 
	sexp_£q_öfo


32 
	mno_‰ames
;

33 
ExpFømeInfo
 *
	möfo
;

34 } 
	tExpSeqInfo
;

36 
RódEx∂icôSeqFûe
 (
ExpSeqInfo
 *
£q_öfo
, 
FILE
 *
exp_fûe
, 
codög_ödex
);

37 
O≥nEx∂icôSeqFûe
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
);

38 
Clo£Ex∂icôSeqFûe
 (
VideoP¨amëîs
 *
p_Vid
);

	@lencod/inc/filehandle.h

16 #i‚de‡
_FILEHANDLE_H_


17 
	#_FILEHANDLE_H_


	)

19 
ªwrôe_∑øm£ts
 (
VideoP¨amëîs
 *
p_Vid
);

20 
°¨t_£quí˚
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
);

21 
ãrmö©e_£quí˚
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
);

22 
wrôe_PPS
 (
VideoP¨amëîs
 *
p_Vid
, 
Àn
, 
PPS_id
);

23 
íd_of_°ªam
 (
VideoP¨amëîs
 *
p_Vid
);

	@lencod/inc/fmo.h

17 #i‚de‡
_FMO_H_


18 
	#_FMO_H_


	)

20 
FmoInô
 (
VideoP¨amëîs
 * 
p_Vid
, 
pic_∑ømëî_£t_rb•_t
 * 
µs
, 
£q_∑ømëî_£t_rb•_t
 * 
•s
);

21 
FmoUnöô
 (
VideoP¨amëîs
 *
p_Vid
);

22 
FmoFöô
 (
£q_∑ømëî_£t_rb•_t
 * 
•s
);

23 
FmoMB2Sli˚Group
 (
VideoP¨amëîs
 *
p_Vid
, 
mb
);

24 
FmoGëFú°MBOfSli˚Group
 (
VideoP¨amëîs
 *
p_Vid
, 
Sli˚GroupID
);

25 
FmoGëFú°Ma¸oblockInSli˚
 (
VideoP¨amëîs
 *
p_Vid
, 
Sli˚Group
);

26 
FmoGëNextMBNr
 (
VideoP¨amëîs
 *
p_Vid
, 
CuºítMbNr
);

27 
FmoGëPªviousMBNr
 (
VideoP¨amëîs
 *
p_Vid
, 
CuºítMbNr
);

28 
FmoGëLa°CodedMBOfSli˚Group
 (
VideoP¨amëîs
 *
p_Vid
, 
Sli˚GroupID
);

29 
FmoSèπPi˘uª
 (
VideoP¨amëîs
 *
p_Vid
);

30 
FmoEndPi˘uª
 ();

31 
FmoSli˚GroupCom∂ëñyCoded
 (
VideoP¨amëîs
 *
p_Vid
, 
Sli˚GroupID
);

32 
FmoSëLa°Ma¸oblockInSli˚
 (
VideoP¨amëîs
 *
p_Vid
, 
mb
);

	@lencod/inc/get_block_otf.h

13 #i‚de‡
_GET_BLOCK_OTF_H_


14 
	#_GET_BLOCK_OTF_H_


	)

16 
gë_block_luma_Ÿf_L2
–
VideoP¨amëîs
 *
p_Vid
,

17 
img≥l
* 
m¥ed
,

18 * 
tmp_¥ed
,

19 
pic_pix_x
,

20 
pic_pix_y
,

21 
block_size_x
,

22 
block_size_y
,

23 
St‹abÀPi˘uª
 *
ªf
,

24 
∂


27 
gë_block_luma_Ÿf_L1
–
VideoP¨amëîs
 *
p_Vid
,

28 
img≥l
* 
m¥ed
,

29 * 
tmp_¥ed
,

30 
pic_pix_x
,

31 
pic_pix_y
,

32 
block_size_x
,

33 
block_size_y
,

34 
St‹abÀPi˘uª
 *
ªf
,

35 
∂


39 
gë_block_chroma_Ÿf_L2
 ( 
VideoP¨amëîs
 *
p_Vid
,

40 
img≥l
* 
m¥ed
,

41 * 
tmp_¥ed
,

42 
pic_pix_x
,

43 
pic_pix_y
,

44 
block_size_x
,

45 
block_size_y
,

46 
St‹abÀPi˘uª
 *
ªf
,

47 
uv


50 
me_gë_block_chroma_Ÿf_L1
 ( 
VideoP¨amëîs
 *
p_Vid
,

51 
img≥l
* 
m¥ed
,

52 * 
tmp_¥ed
,

53 
pic_pix_x
,

54 
pic_pix_y
,

55 
block_size_x
,

56 
block_size_y
,

57 
St‹abÀPi˘uª
 *
ªf
,

58 
uv


61 
mc_gë_block_chroma_Ÿf_L1
 ( 
VideoP¨amëîs
 *
p_Vid
,

62 
img≥l
* 
m¥ed
,

63 * 
tmp_¥ed
,

64 
pic_pix_x
,

65 
pic_pix_y
,

66 
block_size_x
,

67 
block_size_y
,

68 
St‹abÀPi˘uª
 *
ªf
,

69 
uv


90 
ölöe
 
	$is_q≥l
–
x
, 
y
, 
bx
, 
by
 )

92  ( ((
x
&
bx
)%2Ë|| ((
y
&
by
)%2) ) ? (1):(0) ;

93 
	}
}

	@lencod/inc/global.h

14 #i‚de‡
_GLOBAL_H_


15 
	#_GLOBAL_H_


	)

17 
	~"deföes.h
"

18 
	~"wö32.h
"

19 
	~"ty≥defs.h
"

20 
	~"∑r£tcomm⁄.h
"

21 
	~"ifun˘i⁄s.h
"

22 
	~"‰ame.h
"

23 
	~"io_video.h
"

24 
	~"io_image.h
"

25 
	~"«lucomm⁄.h
"

26 
	~"∑øms.h
"

27 
	~"di°‹ti⁄.h
"

28 
	~"œgøngün.h
"

29 
	~"qu™t_∑øms.h
"

30 
	~"rc_ty≥s.h
"

32 
bô_°ªam_íc
 
	tBô°ªam
;

34 
	~"¥ed_°ru˘_ty≥s.h
"

41 
öp_∑r_íc
 
	tI≈utP¨amëîs
;

44 
	g°‹abÀ_pi˘uª
;

45 
	gcodög_°©e
;

46 
	gpic_mŸi⁄_∑øms_ﬁd
;

47 
	gpic_mŸi⁄_∑øms
;

49 
image_°ru˘uª
 
	tImageSåu˘uª
;

50 
öfo_8x8
 
	tInfo8x8
;

51 
£¨ch_wödow
 
	tSórchWödow
;

52 
block_pos
 
	tBlockPos
;

53 
bô_cou¡î
 
	tBôCou¡î
;

54 
ícodög_ívú⁄mít
 
	tEncodögEnvú⁄mít
;

55 
EncodögEnvú⁄mít
 *
	tEncodögEnvú⁄mítPå
;

56 
bi_c⁄ãxt_ty≥
 
	tBiC⁄ãxtTy≥
;

57 
BiC⁄ãxtTy≥
 *
	tBiC⁄ãxtTy≥På
;

59 
	simage_°ru˘uª


61 
FømeF‹m©
 
	mf‹m©
;

62 
img≥l
 **
	md©a
[3];

66 
	söfo_8x8


68 
	mmode
;

69 
	mpdú
;

70 
	mªf
[2];

71 
	mbùªd
;

74 
	s£¨ch_wödow
 {

75 
	mmö_x
;

76 
	mmax_x
;

77 
	mmö_y
;

78 
	mmax_y
;

81 
	sblock_pos


83 
	mx
;

84 
	my
;

88 
	sbô_cou¡î


90 
	mmb_tŸÆ
;

91 
	mmb_mode
;

92 
	mmb_öãr
;

93 
	mmb_cbp
;

94 
	mmb_dñè_qu™t
;

95 
	mmb_y_c€ff
;

96 
	mmb_uv_c€ff
;

97 
	mmb_cb_c€ff
;

98 
	mmb_¸_c€ff
;

99 
	mmb_°uffög
;

103 
	sícodög_ívú⁄mít


105 
video_∑r
 *
	mp_Vid
;

106 
	mElow
, 
	mEønge
;

107 
	mEbuf„r
;

108 
	mEbôs_to_go
;

109 
	mEchunks_out°™dög
;

110 
	mEpbuf
;

111 
byã
 *
	mEcode°rm
;

112 *
	mEcode°rm_Àn
;

113 
	mC
;

114 
	mE
;

118 
	sbi_c⁄ãxt_ty≥


120 
	mcou¡
;

121 
byã
 
	m°©e
;

122 
	mMPS
;

134 
BiC⁄ãxtTy≥
 
	mmb_ty≥_c⁄ãxts
 [3][
NUM_MB_TYPE_CTX
];

135 
BiC⁄ãxtTy≥
 
	mb8_ty≥_c⁄ãxts
 [2][
NUM_B8_TYPE_CTX
];

136 
BiC⁄ãxtTy≥
 
	mmv_ªs_c⁄ãxts
 [2][
NUM_MV_RES_CTX
];

137 
BiC⁄ãxtTy≥
 
	mªf_no_c⁄ãxts
 [2][
NUM_REF_NO_CTX
];

138 } 
	tMŸi⁄InfoC⁄ãxts
;

142 
BiC⁄ãxtTy≥
 
	må™sf‹m_size_c⁄ãxts
 [
NUM_TRANSFORM_SIZE_CTX
];

143 
BiC⁄ãxtTy≥
 
	mùr_c⁄ãxts
 [
NUM_IPR_CTX
];

144 
BiC⁄ãxtTy≥
 
	mcùr_c⁄ãxts
[
NUM_CIPR_CTX
];

145 
BiC⁄ãxtTy≥
 
	mcbp_c⁄ãxts
 [3][
NUM_CBP_CTX
];

146 
BiC⁄ãxtTy≥
 
	mbcbp_c⁄ãxts
[
NUM_BLOCK_TYPES
][
NUM_BCBP_CTX
];

147 
BiC⁄ãxtTy≥
 
	mdñè_qp_c⁄ãxts
 [
NUM_DELTA_QP_CTX
];

148 
BiC⁄ãxtTy≥
 
	m⁄e_c⁄ãxts
 [
NUM_BLOCK_TYPES
][
NUM_ONE_CTX
];

149 
BiC⁄ãxtTy≥
 
	mabs_c⁄ãxts
 [
NUM_BLOCK_TYPES
][
NUM_ABS_CTX
];

150 #i‡
ENABLE_FIELD_CTX


151 
BiC⁄ãxtTy≥
 
	mmb_aff_c⁄ãxts
 [
NUM_MB_AFF_CTX
];

152 
BiC⁄ãxtTy≥
 
	mm≠_c⁄ãxts
 [2][
NUM_BLOCK_TYPES
][
NUM_MAP_CTX
];

153 
BiC⁄ãxtTy≥
 
	mœ°_c⁄ãxts
[2][
NUM_BLOCK_TYPES
][
NUM_LAST_CTX
];

155 
BiC⁄ãxtTy≥
 
	mm≠_c⁄ãxts
 [1][
NUM_BLOCK_TYPES
][
NUM_MAP_CTX
];

156 
BiC⁄ãxtTy≥
 
	mœ°_c⁄ãxts
[1][
NUM_BLOCK_TYPES
][
NUM_LAST_CTX
];

158 } 
	tTextuªInfoC⁄ãxts
;

163 
	spix_pos


165 
	mavaûabÀ
;

166 
	mmb_addr
;

167 
	mx
;

168 
	my
;

169 
	mpos_x
;

170 
	mpos_y
;

171 } 
	tPixñPos
;

176 
	mmv_x
;

177 
	mmv_y
;

178 } 
	tMŸi⁄Ve˘‹
;

183 
	mªfIdx
[2];

184 
MŸi⁄Ve˘‹
 
	mmv
[2];

185 
di°blk
 
	mdi°
;

186 
di°blk
 
	mßd
;

187 } 
	tBiPªdMVInfo
;

189 c⁄° 
MŸi⁄Ve˘‹
 
	gzîo_mv
 = {0, 0};

191 
	srd_8x8_d©a


193 
di°blk
 
	mmb_p8x8_co°
;

194 
di°blk
 
	msmb_p8x8_co°
[4];

195 
di°blk
 
	msmb_p8x8_rdco°
[4];

196 
Info8x8
 
	m∑π
[4];

198 
	mcbp8x8
;

199 
	mcbp_blk8x8
;

200 
	m˙t_n⁄z_8x8
;

202 **
	mÃec
;

203 
img≥l
 **
	mm¥8x8
;

204 
img≥l
 ***
	mm¥8x8CbCr
;

205 
img≥l
 **
	mªc_mbY8x8
;

206 
img≥l
 ***
	mªc_mb8x8_¸
;

207 } 
	tRD_8x8DATA
;

209 
	srd_∑øms


211 
	mœmbda_md
;

213 
	mœmbda_mdÂ
;

215 
	mœmbda_me
[3];

216 
	mœmbda_mf
[3];

217 
	mbe°_mco°
[2];

219 
	mvÆid
[
MAXMODE
];

220 
	mcuº_mb_fõld
;

221 } 
	tRD_PARAMS
;

228 
	m¶i˚_ty≥
;

229 
	mdi•œy_no
;

230 
	mª„ªn˚_idc
;

231 
	m¶i˚_qp_off
;

232 
	mhõørchy_œyî
;

233 
	mhõørchyPocDñè
;

234 
	mãmp‹Æ_œyî
;

241 } 
	tGOP_DATA
;

244 
	sDecRefPicM¨kög_s


246 
	mmem‹y_m™agemít_c⁄åﬁ_›î©i⁄
;

247 
	mdif„ªn˚_of_pic_nums_möus1
;

248 
	ml⁄g_ãrm_pic_num
;

249 
	ml⁄g_ãrm_‰ame_idx
;

250 
	mmax_l⁄g_ãrm_‰ame_idx_∂us1
;

251 
DecRefPicM¨kög_s
 *
	mNext
;

252 } 
	tDecRefPicM¨kög_t
;

254 
	sme_block


256 
video_∑r
 *
	mp_Vid
;

258 
	mpos_x_∑dded
;

259 
	mpos_y_∑dded
;

261 
	mblockty≥
;

262 
	mblocksize_x
;

263 
	mblocksize_y
;

264 
	mblocksize_¸_x
;

265 
	mblocksize_¸_y
;

267 
	mblock_x
;

268 
	mblock_y
;

270 
	mpos_x
;

271 
	mpos_y
;

272 
	mpos_x2
;

273 
	mpos_y2
;

275 
	mpos_¸_x
;

276 
	mpos_¸_y
;

278 
	mhme_Àvñ
;

279 
	mhme_ªf_size_y_∑d
;

280 
	mhme_ªf_size_x_∑d
;

281 
	mhme_ªf_size_y_max
;

282 
	mhme_ªf_size_x_max
;

283 
	mli°
;

284 
	mªf_idx
;

285 
MŸi⁄Ve˘‹
 
	mmv
[2];

286 
PixñPos
 
	mblock
[4];

287 
¶i˚
 *
	mp_Sli˚
;

288 
£¨ch_wödow
 
	m£¨chR™ge
;

289 
	mco°
;

290 
img≥l
 **
	m‹ig_pic
;

291 
	mChromaMEE«bÀ
;

292 
	mChromaMEWeight
;

294 
	m≠∂y_weights
;

295 
	m≠∂y_bi_weights
;

297 
	mã°8x8
;

299 
	mweight_luma
;

300 
	mweight_¸
[2];

301 
	moff£t_luma
;

302 
	moff£t_¸
[2];

305 
	mweight1
;

306 
	mweight2
;

307 
	moff£tBi
;

308 
	mweight1_¸
[2];

309 
	mweight2_¸
[2];

310 
	moff£tBi_¸
[2];

311 
	m£¨ch_pos2
;

312 
	m£¨ch_pos4
;

313 
	môî©i⁄_no
;

316 
di°blk
 (*
compuãPªdFPñ
Ë(
	m°‹abÀ_pi˘uª
 *, 
	mme_block
 *, 
	mdi°blk
 , 
	mMŸi⁄Ve˘‹
 * );

317 
di°blk
 (*
compuãPªdHPñ
Ë(
	m°‹abÀ_pi˘uª
 *, 
	mme_block
 *, 
	mdi°blk
 , 
	mMŸi⁄Ve˘‹
 * );

318 
di°blk
 (*
compuãPªdQPñ
Ë(
	m°‹abÀ_pi˘uª
 *, 
	mme_block
 *, 
	mdi°blk
 , 
	mMŸi⁄Ve˘‹
 * );

319 
di°blk
 (*
compuãBiPªdFPñ
Ë(
	m°‹abÀ_pi˘uª
 *, °‹abÀ_pi˘uª *, 
	mme_block
 *, 
	mdi°blk
 , 
	mMŸi⁄Ve˘‹
 *, MotionVector *);

320 
di°blk
 (*
compuãBiPªdHPñ
Ë(
	m°‹abÀ_pi˘uª
 *, °‹abÀ_pi˘uª *, 
	mme_block
 *, 
	mdi°blk
 , 
	mMŸi⁄Ve˘‹
 *, MotionVector *);

321 
di°blk
 (*
compuãBiPªdQPñ
Ë(
	m°‹abÀ_pi˘uª
 *, °‹abÀ_pi˘uª *, 
	mme_block
 *, 
	mdi°blk
 , 
	mMŸi⁄Ve˘‹
 *, MotionVector *);

322 } 
	tMEBlock
;

325 
	ssy¡axñemít_íc


327 
	mty≥
;

328 
	mvÆue1
;

329 
	mvÆue2
;

330 
	mÀn
;

331 
	möf
;

332 
	mbô∑âîn
;

333 
	mc⁄ãxt
;

335 #i‡
TRACE


336 
	#TRACESTRING_SIZE
 100

337 
åa˚°rög
[
TRACESTRING_SIZE
];

339 

	)

341 (*
	mm≠pög
)(
	mvÆue1
, 
	mvÆue2
, * 
	mÀn_±r
, * 
	möfo_±r
);

343 } 
	tSy¡axEÀmít
;

345 
	swp_∑øms


347 
	mweight
[3];

348 
	moff£t
[3];

349 } 
	tWPP¨ams
;

352 
	sma¸oblock_íc


354 
¶i˚
 *
	mp_Sli˚
;

355 
video_∑r
 *
	mp_Vid
;

356 
I≈utP¨amëîs
 *
	mp_I≈
;

357 
	mmbAddrX
;

358 
	mmb_ty≥
;

359 
	m¶i˚_ƒ
;

360 
	mmb_x
;

361 
	mmb_y
;

362 
	mblock_x
;

363 
	mblock_y
;

365 
	mpix_x
;

366 
	mpix_y
;

367 
	mpix_c_x
;

368 
	mpix_c_y
;

370 
	m›ix_y
;

371 
	m›ix_c_y
;

373 
	msubblock_x
;

374 
	msubblock_y
;

376 
	mli°_off£t
;

377 
Boﬁón
 
	m¥ev_ªcode_mb
;

378 
Boﬁón
 
	mDeblockCÆl
;

380 
	mmbAddrA
, 
	mmbAddrB
, 
	mmbAddrC
, 
	mmbAddrD
;

381 
byã
 
	mmbAvaûA
, 
	mmbAvaûB
, 
	mmbAvaûC
, 
	mmbAvaûD
;

383 
	mqp
;

384 
	mqpc
[2];

385 
	mqp_sˇÀd
[
MAX_PLANE
];

386 
	mqp•
;

387 
	mcbp
;

388 
	m¥ev_qp
;

389 
	m¥ev_dqp
;

390 
	m¥ev_cbp
;

391 
	m¸_cbp
[3];

392 
	mc_nzCbCr
[3];

394 
	mi16off£t
;

396 
BôCou¡î
 
	mbôs
;

398 
	m¨_mode
;

399 
	mmvd
[2][
BLOCK_MULTIPLE
][BLOCK_MULTIPLE][2];

400 
	mc_ùªd_mode
;

401 
	mi16mode
;

403 
Info8x8
 
	mb8x8
[4];

405 
img≥l
 **
	möåa4x4_¥ed
;

406 
img≥l
 **
	möåa4x4_¥ed_buf
[2];

407 
img≥l
 **
	möåa8x8_¥ed
;

408 
img≥l
 **
	möåa8x8_¥ed_buf
[2];

409 
img≥l
 **
	möåa16x16_¥ed
;

410 
img≥l
 **
	möåa16x16_¥ed_buf
[2];

412 
	mI¡øChromaPªdModeFœg
;

413 
byã
 
	mmb_fõld
;

414 
byã
 
	mis_fõld_mode
;

415 
byã
 
	mluma_å™sf‹m_size_8x8_Êag
;

416 
byã
 
	mãmp_å™sf‹m_size_8x8_Êag
;

417 
byã
 
	mNoMbP¨tLessTh™8x8Fœg
;

418 
byã
 
	mvÆid_8x8
;

419 
byã
 
	mvÆid_4x4
;

420 
byã
 
	mwrôe_mb
;

421 
byã
 
	mis_öåa_block
;

423 
	mDFDißbÀIdc
;

424 
	mDFAÕhaC0Off£t
;

425 
	mDFBëaOff£t
;

427 
	mskù_Êag
;

429 
	möåa_¥ed_modes
 [
MB_BLOCK_PARTITIONS
];

430 
	möåa_¥ed_modes8x8
[
MB_BLOCK_PARTITIONS
];

432 
öt64
 
	mcbp_blk
 ;

433 
öt64
 
	mcbp_bôs
[3];

434 
öt64
 
	mcbp_bôs_8x8
[3];

436 
di°blk
 
	mmö_rdco°
;

437 
di°blk
 
	mmö_dco°
;

438 
di°blk
 
	mmö_øã
;

439 
	mmö_bôs
;

441 
	mbe°_mode
;

442 
	mbe°_i16off£t
;

443 
	mbe°_i16mode
;

444 
	mbe°_c_imode
;

445 
	mbe°_cbp
;

448 
	mùmode_DPCM
;

451 
	misCíãrBü£d
;

453 
ma¸oblock_íc
 *
	mmb_up
;

454 
ma¸oblock_íc
 *
	mmb_À·
;

455 
ma¸oblock_íc
 *
	mPªvMB
;

458 (*
	mGëMVPªdi˘‹
Ë(
ma¸oblock_íc
 *
	mcuºMB
, 
PixñPos
 *
	mblock
, 
MŸi⁄Ve˘‹
 *
	mpmv
, 
	mªf_‰ame
,

459 
pic_mŸi⁄_∑øms
 **
	mmv_öfo
, 
	mli°
, 
	mmb_x
, 
	mmb_y
, 
	mblocksh≠e_x
, 
	mblocksh≠e_y
);

460 
di°blk
 (*
I¡PñME
Ë(
ma¸oblock_íc
 *
	mcuºMB
, 
	mMŸi⁄Ve˘‹
 *, 
me_block
 *
	mmv_block
, 
	mdi°blk
, );

461 
di°blk
 (*
SubPñBiPªdME
Ë(
ma¸oblock_íc
 *
	mcuºMB
, 
	mme_block
 *, 
	mli°
,

462 
MŸi⁄Ve˘‹
 *
	m¥ed_mv1
, MŸi⁄Ve˘‹ *
	m¥ed_mv2
, MŸi⁄Ve˘‹ *
	mmv1
, MŸi⁄Ve˘‹ *
	mmv2
, 
di°blk
 
	mmö_mco°
, * 
	mœmbda_Á˘‹
);

463 
di°blk
 (*
SubPñME
Ë(
ma¸oblock_íc
 *
	mcuºMB
,

464 
MŸi⁄Ve˘‹
 *
	m¥ed_mv
, 
me_block
 *
	mmv_block
, 
di°blk
 
	mmö_mco°
, * 
	mœmbda_Á˘‹
);

465 
di°blk
 (*
BiPªdME
Ë(
ma¸oblock_íc
 *
	mcuºMB
, , 
	mMŸi⁄Ve˘‹
 *, MŸi⁄Ve˘‹ *, MŸi⁄Ve˘‹ *, MŸi⁄Ve˘‹ *, 
	mme_block
 *, , 
	mdi°blk
, );

466 (*
	mªsiduÆ_å™sf‹m_qu™t_luma_4x4
Ë(
ma¸oblock_íc
 *
	mcuºMB
, 
Cﬁ‹Pœ√
 
	m∂
, 
	mblock_x
, 
	mblock_y
, *
	mc€ff_co°
, 
	möåa
);

467 (*
	mªsiduÆ_å™sf‹m_qu™t_luma_16x16
Ë(
ma¸oblock_íc
 *
	mcuºMB
, 
Cﬁ‹Pœ√
 
	m∂
);

468 (*
	mªsiduÆ_å™sf‹m_qu™t_luma_8x8
Ë(
ma¸oblock_íc
 *
	mcuºMB
, 
Cﬁ‹Pœ√
 
	m∂
, 
	mb8
, *
	mc€ff_co°
, 
	möåa
);

469 (*
	mªsiduÆ_å™sf‹m_qu™t_chroma_4x4
[2])(
ma¸oblock_íc
 *
	mcuºMB
, 
	muv
,
	mi11
);

470 (*
	mp_SëupFa°FuŒPñSórch
Ë(
	mma¸oblock_íc
 *, 
	mMEBlock
 *, ) ;

472 (*
	mcbp_löfo_öåa
)(
	mcbp
, 
	mdummy
, *
	mÀn
,*
	möfo
);

473 (*
	mcbp_löfo_öãr
)(
	mcbp
, 
	mdummy
, *
	mÀn
,*
	möfo
);

474 } 
	tMa¸oblock
;

477 
	sbô_°ªam_íc


479 
	mbuf„r_size
;

480 
	mbyã_pos
;

481 
	mbôs_to_go
;

483 
	m°‹ed_byã_pos
;

484 
	m°‹ed_bôs_to_go
;

485 
	mbyã_pos_skù
;

486 
	mbôs_to_go_skù
;

487 
	mwrôe_Êag
;

489 
byã
 
	mbyã_buf
;

490 
byã
 
	m°‹ed_byã_buf
;

491 
byã
 
	mbyã_buf_skù
;

492 
byã
 *
	m°ªamBuf„r
;

494 #i‡
TRACE


495 
Boﬁón
 
	måa˚_íabÀd
;

501 
	sd©≠¨tôi⁄_íc


503 
¶i˚
 *
	mp_Sli˚
;

504 
video_∑r
 *
	mp_Vid
;

505 
I≈utP¨amëîs
 *
	mp_I≈
;

506 
Bô°ªam
 *
	mbô°ªam
;

507 
NALU_t
 *
	m«l_unô
;

508 
EncodögEnvú⁄mít
 
	mì_ˇbac
;

509 
EncodögEnvú⁄mít
 
	mì_ªcode
;

510 } 
	tD©aP¨tôi⁄
;

514 
	srd_d©a


516 
	mmö_rdco°
;

517 
	mmö_dco°
;

518 
	mmö_øã
;

520 
img≥l
 ***
	mªc_mb
;

521 ****
	mcofAC
;

522 ***
	mcofDC
;

523 *****
	mcofAC_√w
;

524 
	mmb_ty≥
;

525 
öt64
 
	mcbp_blk
;

526 
	mcbp
;

527 
	m¥ev_cbp
;

528 
	mmode
;

529 
	mi16off£t
;

530 
	mi16mode
;

531 
Boﬁón
 
	mNoMbP¨tLessTh™8x8Fœg
;

533 
	mc_ùªd_mode
;

534 
	mqp
;

535 
	m¥ev_qp
;

536 
	m¥ev_dqp
;

537 
byã
 
	mluma_å™sf‹m_size_8x8_Êag
;

538 
Info8x8
 
	mblock
;

539 
Info8x8
 
	mb8x8
[4];

541 
MŸi⁄Ve˘‹
 *****
	mÆl_mv
;

542 
MŸi⁄Ve˘‹
 ******
	mbùªd_mv
;

544 
	möåa_¥ed_modes
[16];

545 
	möåa_¥ed_modes8x8
[16];

546 **
	mùªdmode
;

547 ***
	mªÁr
;

548 } 
	tRD_DATA
;

551 
	s¶i˚


553 
video_∑r
 *
	mp_Vid
;

554 
I≈utP¨amëîs
 *
	mp_I≈
;

555 
pic_∑ømëî_£t_rb•_t
 *
	ma˘ive_µs
;

556 
£q_∑ømëî_£t_rb•_t
 *
	ma˘ive_•s
;

558 
decoded_pi˘uª_buf„r
 *
	mp_Dpb
;

560 
	mœyî_id
;

561 
	mpi˘uª_id
;

562 
	mqp
;

563 
	mqs
;

564 
	m¶i˚_ty≥
;

565 
	m‰ame_num
;

566 
	mmax_‰ame_num
;

567 sig√d 
	m‰amïoc
;

568 sig√d 
	mThisPOC
;

569 
	m¶i˚_ƒ
;

570 
	mmodñ_numbî
;

571 
	mcﬁour_∂™e_id
;

572 
	mlos¶ess_qµrime_Êag
;

573 
	mP444_joöed
;

574 
	mdi°hªs
;

575 
	mTønsf‹m8x8Mode
;

576 
	mrdoq_mŸi⁄_c›y
;

579 
	mU£RDOQu™t
;

580 
	mRDOQ_QP_Num
;

582 
	mnum_ªf_idx_a˘ive
[2];

583 
	mªf_pic_li°_ª‹dîög_Êag
[2];

584 *
	mmodifiˇti⁄_of_pic_nums_idc
[2];

585 *
	mabs_diff_pic_num_möus1
[2];

586 *
	ml⁄g_ãrm_pic_idx
[2];

587 #i‡(
MVC_EXTENSION_ENABLE
)

588 *
	mabs_diff_võw_idx_möus1
[2];

590 
	mvõw_id
;

591 
	mwidth_blk
;

592 
	mheight_blk
;

594 
Pi˘uªSåu˘uª
 
	m°ru˘uª
;

595 
Boﬁón
 
	mmb_aff_‰ame_Êag
;

597 
	m°¨t_mb_ƒ
;

598 
	mmax_∑π_ƒ
;

599 
	mnum_mb
;

601 
	mcmp_cbp
[3];

602 
	mcuº_cbp
[2];

603 
	msymbﬁ_mode
;

604 
	mNoResidueDúe˘
;

605 
	m∑πôi⁄_mode
;

606 
	midr_Êag
;

607 
	m‰ame_no
;

608 
	mPicSizeInMbs
;

609 
	mnum_blk8x8_uv
;

610 
	m«l_ª„ªn˚_idc
;

613 
	mbôdïth_luma
;

614 
	mbôdïth_chroma
;

615 
	mbôdïth_sˇÀ
[2];

616 
	mbôdïth_luma_qp_sˇÀ
;

617 
	mbôdïth_chroma_qp_sˇÀ
;

618 
	mbôdïth_œmbda_sˇÀ
;

620 
D©aP¨tôi⁄
 *
	m∑πAº
;

621 
MŸi⁄InfoC⁄ãxts
 *
	mmŸ_˘x
;

622 
TextuªInfoC⁄ãxts
 *
	mãx_˘x
;

624 
	mmvsˇÀ
[6][
MAX_REFERENCE_PICTURES
];

625 
	mdúe˘_•©ül_mv_¥ed_Êag
;

627 
	mDFDißbÀIdc
;

628 
	mDFAÕhaC0Off£t
;

629 
	mDFBëaOff£t
;

631 
byã
 
	mweighãd_¥edi˘i⁄
;

632 
byã
 
	mweighãd_bùªd_idc
;

634 
	mluma_log_weight_díom
;

635 
	mchroma_log_weight_díom
;

636 
	mwp_luma_round
;

637 
	mwp_chroma_round
;

639 
	mmax_num_ª„ªn˚s
;

642 
MŸi⁄Ve˘‹
 *****
	mÆl_mv
;

643 
MŸi⁄Ve˘‹
 ******
	mbùªd_mv
;

645 ***
	mwp_weight
;

646 ***
	mwp_off£t
;

647 ****
	mwbp_weight
;

649 *****
	mcofAC_√w
;

651 ****
	mcofAC
;

652 *** 
	mcofDC
;

655 
	mdiffy
[16][16];

657 
öt64
 
	mcur_cbp_blk
[
MAX_PLANE
];

658 
	mc€ff_co°_¸
[
MAX_PLANE
];

661 **
	mtblk16x16
;

662 **
	mtblk4x4
;

663 ****
	mi16blk4x4
;

665 
RD_DATA
 *
	mrdd©a
;

668 
RD_DATA
 
	mrdd©a_åñlis_be°
;

669 
RD_DATA
 
	mrdd©a_åñlis_cuº
;

671 
RD_DATA
 
	mrdd©a_t›_‰ame_mb
;

672 
RD_DATA
 
	mrdd©a_bŸ_‰ame_mb
;

673 
RD_DATA
 
	mrdd©a_t›_fõld_mb
;

674 
RD_DATA
 
	mrdd©a_bŸ_fõld_mb
;

676 
Boﬁón
 
	msi_‰ame_ödiˇt‹
;

677 
Boﬁón
 
	m•2_‰ame_ödiˇt‹
;

679 ***
	mdúe˘_ªf_idx
;

680 **
	mdúe˘_pdú
;

682 
MŸi⁄Ve˘‹
 ****
	mtmp_mv8
;

683 
MŸi⁄Ve˘‹
 ****
	mtmp_mv4
;

685 
di°blk
 ***
	mmŸi⁄_co°8
;

686 
di°blk
 ***
	mmŸi⁄_co°4
;

687 
	mdñèQPTabÀ
[9];

690 
e°_bôs_ˇbac
 *
	me°BôsCabac
;

691 
	mn‹m_Á˘‹_4x4
;

692 
	mn‹m_Á˘‹_8x8
;

693 
	mn‹m_shi·_4x4
;

694 
	mn‹m_shi·_8x8
;

696 
img≥l
 ****
	mm¥_4x4
;

697 
img≥l
 ****
	mm¥_8x8
;

698 
img≥l
 ****
	mm¥_16x16
;

699 
img≥l
 ***
	mmb_¥ed
;

700 ***
	mmb_ºes
;

701 ***
	mmb_‹es
;

704 
	mb8_ùªdmode8x8
[4][4];

705 
	mb8_öåa_¥ed_modes8x8
[16];

706 
	mb4_ùªdmode
[16];

707 
	mb4_öåa_¥ed_modes
[16];

709 
rdo_°ru˘uª
 *
	mp_RDO
;

710 
ïzs_∑øms
 *
	mp_EPZS
;

713 
°‹abÀ_pi˘uª
 **
	mli°X
[6];

714 
	mli°Xsize
[6];

717 
	mc€ff
[64];

718 
	mc€ff_˘r
;

719 
	mpos
;

721 
	mdeÁu…_pic_num
[2][
MAX_REFERENCE_PICTURES
];

722 
	mdeÁu…_võw_id
[2][
MAX_REFERENCE_PICTURES
];

725 (*
	mmode_decisi⁄_f‹_I16x16_MB
Ë(
Ma¸oblock
 *
	mcuºMB
, 
	mœmbda
);

726 (*
	mmode_decisi⁄_f‹_I4x4_blocks
Ë(
Ma¸oblock
 *
	mcuºMB
, 
	mb8
, 
	mb4
, 
	mœmbda
, 
di°blk
* 
	mmö_co°
);

727 (*
	mmode_decisi⁄_f‹_I8x8_blocks
Ë(
Ma¸oblock
 *
	mcuºMB
, 
	mb8
, 
	mœmbda
, 
di°blk
 *
	mmö_co°
);

728 
di°blk
 (*
rdco°_f‹_4x4_öåa_blocks
Ë(
Ma¸oblock
 *
	mcuºMB
, *
	mc_nz
, 
	mb8
, 
	mb4
, 
	mùmode
, 
	mœmbda
, 
	mmo°ProbabÀMode
, di°blk 
	mmö_rdco°
);

729 
di°blk
 (*
rdco°_f‹_8x8_öåa_blocks
Ë(
Ma¸oblock
 *
	mcuºMB
, *
	mc_nz
, 
	mb8
, 
	mùmode
, 
	mœmbda
, di°blk 
	mmö_rdco°
, 
	mmo°ProbabÀMode
);

730 (*
	msubma¸oblock_mode_decisi⁄
Ë(
Ma¸oblock
 *
	mcuºMB
, 
	mRD_PARAMS
 *, 
	mRD_8x8DATA
 *, ****, , 
	mdi°blk
 *);

731 (*
	möåa_chroma_RD_decisi⁄
Ë(
Ma¸oblock
 *
	mcuºMB
, 
	mRD_PARAMS
 *);

733 (*
	m£t_öå≠ªd_4x4
Ë(
Ma¸oblock
 *
	mcuºMB
, 
Cﬁ‹Pœ√
 
	m∂
, 
	mimg_x
,
	mimg_y
, *
	mÀ·_avaûabÀ
, *
	mup_avaûabÀ
, *
	mÆl_avaûabÀ
);

734 (*
	m£t_öå≠ªd_8x8
Ë(
Ma¸oblock
 *
	mcuºMB
, 
Cﬁ‹Pœ√
 
	m∂
, 
	mimg_x
,
	mimg_y
, *
	mÀ·_avaûabÀ
, *
	mup_avaûabÀ
, *
	mÆl_avaûabÀ
);

735 (*
	m£t_öå≠ªd_16x16
Ë(
Ma¸oblock
 *
	mcuºMB
, 
Cﬁ‹Pœ√
 
	m∂
, *
	mÀ·_avaûabÀ
, *
	mup_avaûabÀ
, *
	mÆl_avaûabÀ
);

736 (*
	möåa_chroma_¥edi˘i⁄
Ë(
Ma¸oblock
 *
	mcuºMB
, *, *, *);

737 (*
	mrdo_low_öåa_chroma_decisi⁄
Ë(
Ma¸oblock
 *
	mcuºMB
, 
	mmb_avaûabÀ_up
, 
	mmb_avaûabÀ_À·
[2], 
	mmb_avaûabÀ_up_À·
);

739 (*
	mGë_Dúe˘_MŸi⁄_Ve˘‹s
Ë(
Ma¸oblock
 *
	mcuºMB
);

740 
Boﬁón
 (*
¶i˚_too_big
Ë(
	mbôs_¶i˚
);

741 (*
	m£t_mŸi⁄_ve˘‹s_mb
Ë(
Ma¸oblock
 *
	mcuºMB
);

742 (*
	mícode_⁄e_ma¸oblock
Ë(
Ma¸oblock
 *
	mcuºMB
);

743 (*
	m£t_°‹ed_mb_∑ømëîs
Ë(
Ma¸oblock
 *
	mcuºMB
);

744 (*
	m£t_ªf_™d_mŸi⁄_ve˘‹s
Ë(
Ma¸oblock
 *
	mcuºMB
, 
pic_mŸi⁄_∑øms
 **
	mmŸi⁄
, 
Info8x8
 *
	m∑π
, 
	mblock
);

746 (*
	mluma_ªsiduÆ_codög
Ë(
Ma¸oblock
 *
	mcuºMB
);

747 (*
	mluma_ªsiduÆ_codög_8x8
Ë(
Ma¸oblock
* 
	mcuºMB
, *, 
	möt64
*, , , [2], *);

748 (*
	mchroma_ªsiduÆ_codög
Ë(
Ma¸oblock
 *
	mcuºMB
);

750 
di°blk
 (*
compuã_co°8x8
Ë(
video_∑r
 *
	mp_Vid
, 
img≥l
 **
	mcur_img
, img≥»**
	m¥d_img
, 
	mpic_›ix_x
, di°blk 
	mmö_co°
);

751 
di°blk
 (*
compuã_co°4x4
Ë(
video_∑r
 *
	mp_Vid
, 
img≥l
 **
	mcur_img
, img≥»**
	m¥d_img
, 
	mpic_›ix_x
, di°blk 
	mmö_co°
);

752 
di°blk
 (*
föd_ßd_16x16
Ë(
Ma¸oblock
 *
	mcuºMB
);

753 
di°blk
 (*
di°I16x16
Ë(
Ma¸oblock
 *
	mcuºMB
, 
img≥l
 **
	mimg_‹g
, img≥»**
	m¥ed_img
, di°blk 
	mmö_co°
);

755 (*
	m£t_œgøngün_mu…ùlõrs
Ë(
¶i˚
 *
	mcuºSli˚
);

757 (*
	m£t_modes_™d_ªfs_f‹_blocks
Ë(
Ma¸oblock
 *
	mcuºMB
, 
	mmode
);

758 (*
	m£t_c€ff_™d_ªc⁄_8x8
 ) (
Ma¸oblock
 *
	mcuºMB
);

760 (*
	mwrôeMB_ty≥Info
Ë(
Ma¸oblock
 *
	mcuºMB
, 
Sy¡axEÀmít
 *
	m£
, 
D©aP¨tôi⁄
 *
	mdP
);

761 (*
	mwrôeMB_Skù
Ë(
Ma¸oblock
 *
	mcuºMB
, 
Sy¡axEÀmít
 *
	m£
, 
D©aP¨tôi⁄
 *
	mdP
);

762 (*
	mwrôeI¡øPªdMode
Ë(
Sy¡axEÀmít
 *
	m£
, 
D©aP¨tôi⁄
 *
	mdP
);

763 (*
	mwrôeB8_ty≥Info
Ë(
Sy¡axEÀmít
 *
	m£
, 
D©aP¨tôi⁄
 *
	mdP
);

764 (*
	mwrôeRefFøme
[6]Ë(
Ma¸oblock
* 
	mcuºMB
, 
Sy¡axEÀmít
 *
	m£
, 
D©aP¨tôi⁄
 *
	mdP
);

765 (*
	mwrôeMŸi⁄Info2NAL
Ë(
Ma¸oblock
* 
	mcuºMB
);

766 (*
	mwrôe_MB_œyî
Ë(
Ma¸oblock
 *
	mcuºMB
, 
	mrd›t
, *
	mc€ff_øã
);

767 (*
	mwrôeMVD
Ë(
Ma¸oblock
 *
	mcuºMB
, 
Sy¡axEÀmít
 *
	m£
, 
D©aP¨tôi⁄
 *
	mdP
);

768 (*
	mwrôeCBP
Ë(
Ma¸oblock
* 
	mcuºMB
, 
Sy¡axEÀmít
 *
	m£
, 
D©aP¨tôi⁄
 *
	mdP
);

769 (*
	mwrôeDqu™t
Ë(
Ma¸oblock
* 
	mcuºMB
, 
Sy¡axEÀmít
 *
	m£
, 
D©aP¨tôi⁄
 *
	mdP
);

770 (*
	mwrôeCIPªdMode
Ë(
Ma¸oblock
 *
	mcuºMB
, 
Sy¡axEÀmít
 *
	m£
, 
D©aP¨tôi⁄
 *
	mdP
);

771 (*
	mwrôeFõldModeInfo
Ë(
Ma¸oblock
 *
	mcuºMB
, 
Sy¡axEÀmít
 *
	m£
, 
D©aP¨tôi⁄
 *
	mdP
);

772 (*
	mwrôeMB_å™sf‹m_size
)(
Ma¸oblock
 *
	mcuºMB
, 
Sy¡axEÀmít
 *
	m£
, 
D©aP¨tôi⁄
 *
	mdP
);

773 (*
	mwrôeC€ff16x16
Ë(
Ma¸oblock
* 
	mcuºMB
, 
	mCﬁ‹Pœ√
);

774 (*
	mwrôeC€ff4x4_CAVLC
Ë(
Ma¸oblock
* 
	mcuºMB
, 
	mblock_ty≥
, 
	mb8
, 
	mb4
, 
	m∑øm
);

775 (*
	mwrôe_™d_°‹e_CBP_block_bô
Ë(
Ma¸oblock
* 
	mcuºMB
, 
EncodögEnvú⁄mítPå
 
	mìp_dp
, 
	mty≥
, 
	mcbp_bô
, 
TextuªInfoC⁄ãxts
* 
	mãx_˘x
);

778 (*
	mª£t_codög_°©e
Ë(
Ma¸oblock
 *
	mcuºMB
, 
	mcodög_°©e
 *);

779 (*
	m°‹e_codög_°©e
Ë(
Ma¸oblock
 *
	mcuºMB
, 
	mcodög_°©e
 *);

782 (*
	möô_li°s
 ) (
¶i˚
 *
	mcuºSli˚
);

783 (*
	mª‹dî_li°s
 ) (
¶i˚
 *
	mcuºSli˚
);

784 (*
	mpoc_ªf_pic_ª‹dî_‰ame
Ë(
¶i˚
 *
	mcuºSli˚
, 
	mnum_ªf_idx_lX_a˘ive
, 
	mli°_no
 );

788 (*
	mqu™t_4x4
Ë(
Ma¸oblock
 *
	mcuºMB
, **
	mtblock
, 
qu™t_mëhods
 *
	mq_mëhod
);

789 (*
	mqu™t_ac4x4¸
Ë(
Ma¸oblock
 *
	mcuºMB
, **
	mtblock
, 
qu™t_mëhods
 *
	mq_mëhod
);

790 (*
	mqu™t_dc4x4
Ë(
Ma¸oblock
 *
	mcuºMB
, **
	mtblock
, 
	mqp
, * 
	mDCLevñ
, * 
	mDCRun
, 
LevñQu™tP¨ams
 *
	mq_∑øms_4x4
, c⁄° 
byã
 (*
pos_sˇn
)[2]);

791 (*
	mqu™t_ac4x4
Ë(
Ma¸oblock
 *
	mcuºMB
, **
	mtblock
, 
qu™t_mëhods
 *
	mq_mëhod
);

792 (*
	mqu™t_8x8
Ë(
Ma¸oblock
 *
	mcuºMB
, **
	mtblock
, 
qu™t_mëhods
 *
	mq_mëhod
);

793 (*
	mqu™t_8x8ˇvlc
)(
Ma¸oblock
 *
	mcuºMB
, **
	mtblock
, 
qu™t_mëhods
 *
	mq_mëhod
, *** 
	mcofAC
);

795 (*
	mqu™t_dc_¸
Ë(
Ma¸oblock
 *
	mcuºMB
, **
	mtblock
, 
	mqp
, * 
	mDCLevñ
, * 
	mDCRun
,

796 
LevñQu™tP¨ams
 *
	mq_∑øms_4x4
, **
	mÁdju°
, c⁄° 
byã
 (*
pos_sˇn
)[2]);

797 (*
	mrdoq_4x4
Ë(
Ma¸oblock
 *
	mcuºMB
, **
	mtblock
, 
qu™t_mëhods
 *
	mq_mëhod
, 
	mÀvñTªŒis
[16]);

799 (*
	mrdoq_dc
Ë(
Ma¸oblock
 *
	mcuºMB
, **
	mtblock
, 
	mqp_≥r
, 
	mqp_ªm
, 
LevñQu™tP¨ams
 *
	mq_∑øms_4x4
,

800 c⁄° 
byã
 (*
pos_sˇn
)[2], 
	mÀvñTªŒis
[16], 
	mty≥
);

802 (*
	mrdoq_ac4x4
Ë(
Ma¸oblock
 *
	mcuºMB
, **
	mtblock
 , 
qu™t_mëhods
 *
	mq_mëhod
, 
	mÀvñTªŒis
[16]);

804 (*
	mrdoq_dc_¸
Ë(
Ma¸oblock
 *
	mcuºMB
, **
	mtblock
, 
	mqp_≥r
, 
	mqp_ªm
, 
LevñQu™tP¨ams
 *
	mq_∑øms_4x4
,

805 c⁄° 
byã
 (*
pos_sˇn
)[2], 
	mÀvñTªŒis
[16], 
	mty≥
);

807 (*
	m£t_modes_™d_ª‰ame
Ë(
Ma¸oblock
 *
	mcuºMB
, 
	mb8
, * 
	mp_dú
, 
	mli°_mode
[2], *
	mli°_ªf_idx
);

808 (*
	m°‹e_8x8_mŸi⁄_ve˘‹s
Ë(
¶i˚
 *
	mcuºSli˚
, 
	mdú
, 
	mblock8x8
, 
Info8x8
 *
	mB8x8Info
);

809 
di°blk
 (*
gëDi°‹ti⁄
Ë–
Ma¸oblock
 *
	mcuºMB
 );

811 } 
	tSli˚
;

813 #i‡(
MVC_EXTENSION_ENABLE
)

814 
	s¥ev_codög_°©s


816 
	m‰m_no_ö_fûe
;

817 
	mpic_ty≥
[256];

818 
	mvõw_id
;

819 
	mcur_bôs
;

820 
	mwp_mëhod
;

821 
	mAvîageFømeQP
;

822 
	mœmbda
;

823 
	mp¢r_vÆue
[3];

824 
	mssim_vÆue
[3];

825 
	mtmp_time
;

826 
	mme_time
;

827 
	mÊd_Êag
;

828 
	möåas
;

829 
	mdúe˘_mode
;

830 
	mnum_ªf_idx_l0_a˘ive
;

831 
	mnum_ªf_idx_l1_a˘ive
;

832 
	mrd_∑ss
;

833 
	m«l_ª„ªn˚_idc
;

835 } 
	tPªvCodögSèts
;

839 
	sdi°‹ti⁄_mëric


841 
	mvÆue
[3];

842 
	mavîage
[3];

843 
	mav¶i˚
[
NUM_SLICE_TYPES
][3];

844 } 
	tDi°Mëric
;

846 
	sdi°‹ti⁄_∑øms


848 
	m‰ame_˘r
;

849 
Di°Mëric
 
	mmëric
[
TOTAL_DIST_TYPES
];

850 #i‡(
MVC_EXTENSION_ENABLE
)

851 
	m‰ame_˘r_v
[2];

852 
Di°Mëric
 
	mmëric_v
[2][
TOTAL_DIST_TYPES
];

854 } 
	tDi°‹ti⁄P¨ams
;

856 
	spi˘uª


858 
	mno_¶i˚s
;

859 
	mbôs_≥r_pi˘uª
;

860 
¶i˚
 *
	m¶i˚s
[
MAXSLICEPERPICTURE
];

862 
Di°Mëric
 
	mdi°‹ti⁄
;

863 
byã
 
	midr_Êag
;

864 } 
	tPi˘uª
;

867 
	sblock_8x8_öfo


869 
Info8x8
 
	mbe°
[
MAXMODE
][4];

870 } 
	tBlock8x8Info
;

872 
	scodög_∑r


874 
	mœyî_id
;

875 
Cﬁ‹F‹m©
 
	myuv_f‹m©
;

876 
	mP444_joöed
;

878 
	mbôdïth_luma
;

879 
	mbôdïth_chroma
;

880 
	mbôdïth_sˇÀ
[2];

881 
	mbôdïth_luma_qp_sˇÀ
;

882 
	mbôdïth_chroma_qp_sˇÀ
;

883 
	mbôdïth_œmbda_sˇÀ
;

885 
uöt32
 
	mdc_¥ed_vÆue_comp
[
MAX_PLANE
];

886 
	mmax_≥l_vÆue_comp
 [
MAX_PLANE
];

887 
	mmax_img≥l_vÆue_comp_sq
 [
MAX_PLANE
];

889 
	mnum_blk8x8_uv
;

890 
	mnum_cdc_c€ff
;

892 
	mmb_¸_size_x
;

893 
	mmb_¸_size_y
;

894 
	mmb_size
[
MAX_PLANE
][2];

896 
	mmax_bôCou¡
;

897 
	mwidth
;

898 
	mwidth_∑dded
;

899 
	mwidth_blk
;

900 
	mwidth_¸
;

901 
	mheight
;

902 
	mheight_∑dded
;

903 
	mheight_blk
;

904 
	mheight_¸
;

905 
	mheight_¸_‰ame
;

906 
	msize
;

907 
	msize_¸
;

909 
	m∑dded_size_x
;

910 
	m∑dded_size_x_m8x8
;

911 
	m∑dded_size_x_m4x4
;

912 
	m¸_∑dded_size_x
;

913 
	m¸_∑dded_size_x_m8
;

914 
	m¸_∑dded_size_x2
;

915 
	m¸_∑dded_size_x4
;

917 
	m∑d_size_uv_x
;

918 
	m∑d_size_uv_y
;

919 
	mchroma_mask_mv_y
;

920 
	mchroma_mask_mv_x
;

921 
	mchroma_shi·_x
;

922 
	mchroma_shi·_y
;

923 
	mshi·_¸_x
;

924 
	mshi·_¸_y
;

926 
	mPicWidthInMbs
;

927 
	mPicHeightInM≠Unôs
;

928 
	mFømeHeightInMbs
;

929 
	mFømeSizeInMbs
;

931 
	m‰ame_num
;

932 
	m¥evFømeNum
;

933 
	mFømeNumOff£t
;

934 
	m¥evFømeNumOff£t
;

935 
	mœ°_ªf_idc
;

939 
	mmd5Såög
[2][33];

940 }
	tCodögP¨amëîs
;

943 
	svideo_∑r


945 
I≈utP¨amëîs
 *
	mp_I≈
;

946 
pic_∑ømëî_£t_rb•_t
 *
	ma˘ive_µs
;

947 
£q_∑ømëî_£t_rb•_t
 *
	ma˘ive_•s
;

948 
£i_∑øms
 *
	mp_SEI
;

949 
decodîs
 *
	mp_decs
;

950 
CodögP¨amëîs
 *
	mp_CuºEncodeP¨
;

951 
CodögP¨amëîs
 *
	mp_EncodeP¨
[
MAX_NUM_DPB_LAYERS
];

953 
	mnumbî
;

954 
	mLevñIndex
;

955 
	mMaxVmvR
[6];

956 
	mMaxHmvR
[6];

957 
	mcuºít_mb_ƒ
;

958 
	mcuºít_¶i˚_ƒ
;

959 
	mty≥
;

960 
Pi˘uªSåu˘uª
 
	m°ru˘uª
;

961 
	mba£_di°
;

962 
	mnum_ªf_‰ames
;

963 
	mmax_num_ª„ªn˚s
;

964 
	mma°îQP
;

965 
	mqp
;

966 
	mqp•
;

968 
	m¥ev_‰ame_no
;

969 
	mc⁄£cutive_n⁄_ª„ªn˚_pi˘uªs
;

972 
	m‰m_°ru˘_buf„r
;

973 
	mœ°_idr_code_‹dî
;

974 
	mœ°_idr_di•_‹dî
;

975 
	mœ°_mmco_5_code_‹dî
;

976 
	mœ°_mmco_5_di•_‹dî
;

977 
	mcuº_‰m_idx
;

978 
	mFømeNumOff£t
;

979 
	m¥evFømeNumOff£t
;

980 
	m¥evFømeNum
;

981 
SeqSåu˘uª
 *
	mp_¥ed
;

982 
FømeUnôSåu˘
 *
	mp_cuº_‰m_°ru˘
;

983 
PicSåu˘uª
 *
	mp_cuº_pic
;

984 
Sli˚Såu˘uª
 *
	mp_cuº_¶i˚
;

985 
	mpic_°ru˘
;

986 
£¨ch_wödow
 
	m£¨chR™ge
;

987 
ImageD©a
 
	mimgD©a
;

988 
ImageD©a
 
	mimgD©a0
;

989 
ImageD©a
 
	mimgD©a1
;

990 
ImageD©a
 
	mimgD©a2
;

991 
ImageD©a
 
	mimgD©a3
;

993 
ImageD©a
 
	mimgD©a32
;

994 
ImageD©a
 
	mimgD©a4
;

995 
ImageD©a
 
	mimgD©a5
;

996 
ImageD©a
 
	mimgD©a6
;

997 
ImageD©a
 
	mimgRefD©a
;

998 
ImageD©a
 
	m‹igD©a0
;

999 
ImageD©a
 
	m‹igD©a1
;

1001 
ImageD©a
 
	mimgD©aO±1
;

1002 
ImageD©a
 
	mimgD©aO±2
;

1005 
	mnum_¶i˚s_wp
;

1006 
	mwp_∑ømëîs_£t
;

1007 ****
	mwp_weights
;

1008 ****
	mwp_off£ts
;

1009 *****
	mwbp_weight
;

1011 
image_°ru˘uª
 
	mimgSRC
;

1012 
image_°ru˘uª
 
	mimgREF
;

1013 
image_°ru˘uª
 
	mimgREF0
;

1014 
image_°ru˘uª
 
	mimgREF1
;

1015 
image_°ru˘uª
 
	mimgRGB_§c
;

1016 
image_°ru˘uª
 
	mimgRGB_ªf
;

1017 **
	mimgY_sub_tmp
;

1018 
img≥l
 **
	mimgY_com
;

1019 
img≥l
 **
	mimgUV_com
[2];

1021 
img≥l
 **
	mimgY_com_buf
[2];

1022 
img≥l
 **
	mimgUV_com_buf
[2][2];

1024 
img≥l
 **
	mpCurImg
;

1026 
img≥l
 **
	mpImgOrg
[
MAX_PLANE
];

1028 
img≥l
 **
	mpCurImgRef
;

1029 
img≥l
 **
	mpImgOrgRef
[
MAX_PLANE
];

1031 
Pi˘uª
 *
	mp_‰ame_pic
;

1032 
Pi˘uª
 **
	m‰ame_pic
;

1033 #i‡(
MVC_EXTENSION_ENABLE
)

1034 
Pi˘uª
 **
	mfõld_pic_±r
;

1035 
Pi˘uª
 **
	mfõld_pic1
;

1036 
Pi˘uª
 **
	mfõld_pic2
;

1038 
Pi˘uª
 **
	mfõld_pic
;

1041 
Pi˘uª
 *
	m‰ame_pic_si
;

1043 
byã
 *
	mM≠UnôToSli˚GroupM≠
;

1045 
byã
 *
	mbuf
;

1046 
byã
 *
	mibuf
;

1048 #ifde‡
_LEAKYBUCKET_


1049 *
	mBô_Buf„r
;

1050 
	mtŸÆ_‰ame_buf„r
;

1053 
	mlog2_max_‰ame_num_möus4
;

1054 
	mlog2_max_pic_‹dî_˙t_lsb_möus4
;

1055 
	mmax_‰ame_num
;

1056 
	mmax_pic_‹dî_˙t_lsb
;

1058 
öt64
 
	mme_tŸ_time
;

1059 
öt64
 
	mtŸ_time
;

1060 
öt64
 
	mme_time
;

1062 
byã
 
	mmixedModeEdgeFœg
;

1064 *
	mRe‰eshP©ã∫
;

1065 *
	mI¡øMBs
;

1066 
	mWÆkAround
;

1067 
	mNumbîOfMBs
;

1068 
	mNumbîI¡øPîPi˘uª
;

1070 
	m°¨t_me_ªföemít_hp
;

1071 
	m°¨t_me_ªföemít_qp
;

1074 
umhex_°ru˘
 *
	mp_UMHex
;

1075 
umhex_smp_°ru˘
 *
	mp_UMHexSMP
;

1076 
me_fuŒ_Á°
 *
	mp_fÁ°_me
;

1078 
£¨ch_wödow
 *
	mp_£¨ch_wödow
;

1081 
ïzs_°ru˘
 *
	msdüm⁄d
;

1082 
ïzs_°ru˘
 *
	msqu¨e
;

1083 
ïzs_°ru˘
 *
	medüm⁄d
;

1084 
ïzs_°ru˘
 *
	mldüm⁄d
;

1085 
ïzs_°ru˘
 *
	msbdüm⁄d
;

1086 
ïzs_°ru˘
 *
	mpmvÁ°
;

1087 
ïzs_°ru˘
 *
	m£¨ch_Ωu_squ¨e
;

1088 
ïzs_°ru˘
 *
	mSP_M2DRPU
;

1089 
ïzs_°ru˘
 *
	mSP_M2DRPU4MM
;

1092 
	m¥eˇlcU«ryLevñTab
[128][
MAX_PREC_COEFF
];

1093 
	mAd≠tRndWeight
;

1094 
	mAd≠tRndCrWeight
;

1100 
byã
 
	mMBPaúIsFõld
;

1103 
byã
 **
	mpixñ_m≠
;

1104 
byã
 **
	mª‰esh_m≠
;

1105 
	möåas
;

1106 
	miI¡îVõwMBs
;

1107 
	mRCMöQP
;

1108 
	mRCMaxQP
;

1110 
	m‰amî©e
;

1112 
	mis_v_block
;

1113 
	mmb_y_upd
;

1114 
	mmb_y_öåa
;

1115 **
	mùªdmode
;

1116 **
	mùªdmode8x8
;

1118 **
	mùªdmode4x4_löe
;

1119 **
	mùªdmode8x8_löe
;

1121 
	mcod_cou¡î
;

1122 ***
	mnz_c€ff
;

1123 ***
	mnz_c€ff_buf
[2];

1124 
	mpix_x
;

1125 
	mpix_y
;

1128 
img≥l
 
	mmö_IPCM_vÆue
;

1130 
	mpic_bö_cou¡
;

1133 ****
	mARCofAdj4x4
;

1134 ****
	mARCofAdj8x8
;

1136 
ImageD©a
 
	mãmpD©a1
, 
	mãmpD©a2
, 
	mãmpD©a3
, 
	mãmpD©a4
;

1137 
img≥l
 **
	mãmpImg
;

1139 
Pi˘uª
 *
	mcuºítPi˘uª
;

1140 
¶i˚
 *
	mcuºítSli˚
;

1141 
Ma¸oblock
 *
	mmb_d©a
;

1142 
Block8x8Info
 *
	mb8x8öfo
;

1145 
	mmb_ªÂic_u£d
;

1146 
	m∑ª¡_∑π_ªÂic_u£d
;

1147 
	msubmb_∑ª¡_∑π_ªÂic_u£d
;

1149 *
	möåa_block
;

1151 
	m‰ame_no
;

1152 
	mÊd_ty≥
;

1153 
byã
 
	mÊd_Êag
;

1154 
	mrd_∑ss
;

1156 
	mªdund™t_codög
;

1157 
	mkey_‰ame
;

1158 
	mªdund™t_ªf_idx
;

1159 
	m‰m_no_ö_fûe
;

1161 
	mDFDißbÀIdc
;

1162 
	mDFAÕhaC0Off£t
;

1163 
	mDFBëaOff£t
;

1165 
	mdúe˘_•©ül_mv_¥ed_Êag
;

1167 
	mshi·_¸_x2
;

1169 
	mnum_ªf_idx_l0_a˘ive
;

1170 
	mnum_ªf_idx_l1_a˘ive
;

1172 
Boﬁón
 
	mfõld_mode
;

1173 
Boﬁón
 
	mt›_fõld
;

1175 
	mœyî
;

1177 
	mAd≠tiveRoundög
;

1179 
	mªdund™t_pic_˙t
;

1181 
Boﬁón
 
	mmb_aff_‰ame_Êag
;

1184 
	mpic_‹dî_˙t_ty≥
;

1187 
Boﬁón
 
	mdñè_pic_‹dî_Æways_zîo_Êag
;

1188 
	moff£t_f‹_n⁄_ªf_pic
;

1189 
	moff£t_f‹_t›_to_bŸtom_fõld
;

1190 
	mnum_ªf_‰ames_ö_pic_‹dî_˙t_cy˛e
;

1191 
	moff£t_f‹_ªf_‰ame
[1];

1195 
	mpic_‹dî_˙t_lsb
;

1196 
	mdñè_pic_‹dî_˙t_bŸtom
;

1198 
	mdñè_pic_‹dî_˙t
[2];

1200 
	m‰m_ôî
;

1202 
	mfõld_pi˘uª
;

1203 sig√d 
	mt›poc
;

1204 sig√d 
	mbŸtompoc
;

1205 sig√d 
	m‰amïoc
;

1206 sig√d 
	mThisPOC
;

1207 
	m‰ame_num
;

1209 
	mPicSizeInMbs
;

1212 
Boﬁón
 
	mbŸtom_fõld_pic_‹dî_ö_‰ame_¥e£¡_Êag
;

1216 
	m«l_ª„ªn˚_idc
;

1218 
	mad≠tive_ªf_pic_buf„rög_Êag
;

1219 
	mno_ouçut_of_¥i‹_pics_Êag
;

1220 
Boﬁón
 
	ml⁄g_ãrm_ª„ªn˚_Êag
;

1222 
DecRefPicM¨kög_t
 *
	mdec_ªf_pic_m¨kög_buf„r
;

1223 * 
	mmvbôs
;

1225 
	mmax_mvd
;

1226 * 
	mªfbôs
;

1229 
	mNumbîofCodedMa¸oBlocks
;

1230 
	mBasicUnôQP
;

1231 
	mNumbîofMBTextuªBôs
;

1232 
	mNumbîofMBHódîBôs
;

1233 
	mBasicUnô
;

1234 
byã
 
	mwrôe_ma¸oblock
;

1235 
byã
 
	mbŸ_MB
;

1236 
	mwrôe_mbaff_‰ame
;

1238 
	mœ°_pic_bŸtom_fõld
;

1239 
	mœ°_has_mmco_5
;

1240 
	m¥e_‰ame_num
;

1242 
	m¶i˚_group_ch™ge_cy˛e
;

1244 
	mmax_qp_dñè
;

1245 
	mmö_qp_dñè
;

1248 
LambdaP¨ams
 **
	mœmbda
;

1249 **
	mœmbda_md
;

1250 ***
	mœmbda_me
;

1251 ***
	mœmbda_mf
;

1252 **
	mœmbda_rdoq
;

1253 **
	mœmbda_mf_Á˘‹
;

1255 
LambdaP¨ams
 **
	mœmbda_buf
[2];

1256 **
	mœmbda_md_buf
[2];

1257 ***
	mœmbda_me_buf
[2];

1258 ***
	mœmbda_mf_buf
[2];

1259 **
	mœmbda_rdoq_buf
[2];

1260 **
	mœmbda_mf_Á˘‹_buf
[2];

1262 
uöt32
 
	mdc_¥ed_vÆue
;

1263 
	mmax_img≥l_vÆue
;

1265 
edge_öfo
 *
	mp_edge
;

1267 
	mchroma_qp_off£t
[2];

1269 
	mauto_¸›_right
;

1270 
	mauto_¸›_bŸtom
;

1272 
	mcheckªf
;

1273 
	mœ°_vÆid_ª„ªn˚
;

1274 
	mbyãs_ö_pi˘uª
;

1276 
öt64
 
	mœ°_bô_˘r_n
;

1278 
	mAvîageFømeQP
;

1279 
	mSumFømeQP
;

1281 
	mChromaAºayTy≥
;

1282 
Ma¸oblock
 *
	mmb_d©a_JV
[
MAX_PLANE
];

1283 
	mcﬁour_∂™e_id
;

1285 
	mœ°I¡øNumbî
;

1286 
	mœ°INTRA
;

1287 
	mœ°_ªf_idc
;

1288 
	midr_ª‰esh
;

1290 
	mp_dec
;

1291 #i‡(
MVC_EXTENSION_ENABLE
)

1292 
	mp_dec2
;

1294 
	m‰ame_°©i°ic_°¨t
;

1295 
	möôül_B‰ames
;

1296 
	mˇbac_ícodög
;

1298 
	m¥im¨y_pic_ty≥
;

1300 
	m‰ameOff£tTŸÆ
[2][
MAX_REFERENCE_PICTURES
];

1301 
	m‰ameOff£tCou¡
[2][
MAX_REFERENCE_PICTURES
];

1302 
	m‰ameOff£t
[2][
MAX_REFERENCE_PICTURES
];

1303 
	m‰ameOff£tAvaû
;

1304 
	mvõw_id
;

1305 #i‡(
MVC_EXTENSION_ENABLE
)

1306 
	m£c_võw_f‹˚_Êd
;

1307 
	m¥ev_võw_is_™ch‹
;

1309 
	mãmp0_«l_ª„ªn˚_idc
;

1310 
	mãmp0_n⁄_idr_Êag
[2];

1311 
	mãmp0_¥i‹ôy_id
;

1312 
	mãmp0_võw_id
;

1313 
	mãmp0_ãmp‹Æ_id
;

1314 
	mãmp0_™ch‹_pic_Êag
[2];

1315 
	mãmp0_öãr_võw_Êag
[2];

1317 
	mn⁄_idr_Êag
[2];

1318 
	m¥i‹ôy_id
;

1319 
	mãmp‹Æ_id
;

1320 
	m™ch‹_pic_Êag
[2];

1321 
	möãr_võw_Êag
[2];

1323 
PªvCodögSèts
 
	m¥ev_cs
;

1324 
	mMVCI¡îVõwRe‹dî
;

1325 
°‹abÀ_pi˘uª
 *
	m¥oc_pi˘uª
;

1328 *
	mmb16x16_co°_‰ame
;

1329 
	mmb16x16_co°
;

1331 **
	mÃec
;

1332 ***
	mÃec_uv
;

1333 
Boﬁón
 
	m•2_‰ame_ödiˇt‹
;

1334 
	mnumbî_•2_‰ames
;

1336 
Boﬁón
 
	mgiRDO±_B8O∆yFœg
;

1338 
	m‰ameNumöGOP
;

1340 
img≥l
 **
	mimgY_tmp
;

1341 
img≥l
 **
	mimgUV_tmp
[2];

1342 
img≥l
 **
	mimgY_tmp_buf
[2];

1343 
img≥l
 **
	mimgUV_tmp_buf
[2][2];

1348 
	mCbCr_¥edmode_8x8
[4];

1349 
di°blk
 ****
	mmŸi⁄_co°
;

1350 *** 
	möôülized
;

1351 *** 
	mmodñNumbî
;

1352 
	mbùªd_íabÀd
[
MAXMODE
];

1355 
	mnum_mb_≥r_¶i˚
;

1356 
	mnumbî_of_¶i˚s
;

1358 
	mimg≥l_abs_ønge
;

1359 #i‡(
JM_MEM_DISTORTION
)

1360 * 
	mimg≥l_abs
;

1361 * 
	mimg≥l_quad
;

1364 
GOP_DATA
 *
	mg›_°ru˘uª
;

1365 
byã
 *
	mMBAm≠
;

1366 
	mPicSizeInM≠Unôs
;

1367 
	mFú°MBInSli˚
[
MAXSLICEGROUPIDS
];

1369 
MŸi⁄Ve˘‹
* 
	m•úÆ_£¨ch
;

1370 
MŸi⁄Ve˘‹
* 
	m•úÆ_h≥l_£¨ch
;

1371 
MŸi⁄Ve˘‹
* 
	m•úÆ_q≥l_£¨ch
;

1374 
FILE
 *
	mp_log
;

1377 
FILE
 **
	mf_out
;

1379 
FILE
 *
	mf_™√xb
;

1381 
FILE
 *
	mf_πp
;

1382 
	mCuºítRTPTime°amp
;

1384 
uöt16
 
	mCuºítRTPSequí˚Numbî
;

1391 
Di°‹ti⁄P¨ams
 *
	mp_Di°
;

1392 
°©_∑ømëîs
 *
	mp_Sèts
;

1393 
pic_∑ømëî_£t_rb•_t
 *
	mPicP¨Së
[
MAXPPS
];

1395 
decoded_pi˘uª_buf„r
 *
	mp_Dpb_œyî
[
MAX_NUM_DPB_LAYERS
];

1396 
‰ame_°‹e
 *
	mout_buf„r
;

1397 
°‹abÀ_pi˘uª
 *
	míc_pi˘uª
;

1398 
°‹abÀ_pi˘uª
 **
	míc_‰ame_pi˘uª
;

1399 
°‹abÀ_pi˘uª
 **
	míc_fõld_pi˘uª
;

1400 
°‹abÀ_pi˘uª
 *
	míc_‰ame_pi˘uª_JV
[
MAX_PLANE
];

1401 
qu™t_∑øms
 *
	mp_Qu™t
;

1402 
sˇlög_li°
 *
	mp_QSˇÀ
;

1405 
RCGíîic
 *
	mp_rc_gí
;

1406 
RCGíîic
 *
	mp_rc_gí_öô
, *
	mp_rc_gí_be°
;

1407 
RCQuadøtic
 *
	mp_rc_quad
;

1408 
RCQuadøtic
 *
	mp_rc_quad_öô
, *
	mp_rc_quad_be°
;

1410 
	míå›y
[128];

1411 
	mí‹m
 [128];

1412 
	m¥obabûôy
[128];

1415 
FILE
 *
	mexpSFûe
;

1416 
exp_£q_öfo
 *
	mexpSeq
;

1418 
wpx_obje˘
 *
	mpWPX
;

1421 ***
	mwavREF
[
NUM_WAVELET_LEVEL
+1];

1422 ***
	mwavSRC
[
NUM_WAVELET_LEVEL
+1];

1423 
	mJND
[
NUM_WAVELET_LEVEL
][4];

1424 *
	mãmp_low
, *
	mãmp_high
;

1426 #ifde‡
BEST_NZ_COEFF


1427 
	mgØiMBAFF_NZC€ff
[4][12];

1431 
	moff£t_y
, 
	moff£t_¸
;

1432 
	mwka0
, 
	mwka1
, 
	mwka2
, 
	mwka3
, 
	mwka4
;

1433 
	mEvÆu©eDBOff
;

1434 
	mTu∫DBOff
;

1438 (*
	mupd©eQP
Ë(
video_∑r
 *
	mp_Vid
, 
I≈utP¨amëîs
 *
	mp_I≈
, 
RCQuadøtic
 *
	mp_quad
, 
RCGíîic
 *
	mp_gí
, 
	mt›fõld
);

1439 (*
	mrc_upd©e_pi˘_‰ame_±r
)(
video_∑r
 *
	mp_Vid
, 
I≈utP¨amëîs
 *
	mp_I≈
, 
RCQuadøtic
 *
	mp_quad
, 
RCGíîic
 *
	mp_gí
, 
	mnbôs
);

1440 (*
	mrc_upd©e_pi˘uª_±r
Ë(
video_∑r
 *
	mp_Vid
, 
I≈utP¨amëîs
 *
	mp_I≈
, 
	mbôs
);

1441 (*
	mrc_öô_pi˘_±r
Ë(
video_∑r
 *
	mp_Vid
, 
I≈utP¨amëîs
 *
	mp_I≈
, 
RCQuadøtic
 *
	mp_quad
, 
RCGíîic
 *
	mp_gí
, 
	mfõldpic
, 
	mt›fõld
, 
	mèrgëcompuèti⁄
, 
	mmu…
);

1444 (*
	mbuf2img
Ë(
img≥l
** 
	mimgX
, * 
	mbuf
, 
	msize_x
, 
	msize_y
, 
	mo_size_x
, 
	mo_size_y
, 
	msymbﬁ_size_ö_byãs
, 
	mbôshi·
);

1445 (*
	mgëNeighbour
Ë(
Ma¸oblock
 *
	mcuºMB
, 
	mxN
, 
	myN
, 
	mmb_size
[2], 
PixñPos
 *
	mpix
);

1446 (*
	mgë_mb_block_pos
Ë(
BlockPos
 *
	mPicPos
, 
	mmb_addr
, *
	mx
, *
	my
);

1447 (*
	mWrôeNALU
Ë(
video_∑r
 *
	mp_Vid
, 
NALU_t
 *
	mn
, 
FILE
 **
	mf_out
);

1448 (*
	mîr‹_c⁄˚Æ_pi˘uª
)(
video_∑r
 *
	mp_Vid
, 
°‹abÀ_pi˘uª
 *
	míc_pic
, 
	mdecodî
);

1449 
di°blk
 (*
e°im©e_di°‹ti⁄
)(
Ma¸oblock
 *
	mcuºMB
, 
	mblock
, 
	mblock_size
, 
	mmode
, 
	mpdú
, di°blk 
	mmö_rdco°
);

1451 (*
	mO√Comp⁄ítChromaPªdi˘i⁄4x4
Ë(
Ma¸oblock
 *
	mcuºMB
, 
	mimg≥l
* , , , 
	mMŸi⁄Ve˘‹
 ** , 
°‹abÀ_pi˘uª
 *
	mli°X
, );

1454 (*
	mGëSåígthVî
Ë(
byã
 
	mSåígth
[16], 
Ma¸oblock
 *
	mMbQ
, 
	medge
, 
	mmvlimô
);

1455 (*
	mGëSåígthH‹
Ë(
byã
 
	mSåígth
[16], 
Ma¸oblock
 *
	mMbQ
, 
	medge
, 
	mmvlimô
);

1456 (*
	mEdgeLo›LumaH‹
Ë(
Cﬁ‹Pœ√
 
	m∂
, 
img≥l
** 
	mImg
, 
byã
 
	mSåígth
[16], 
Ma¸oblock
 *
	mMbQ
, 
	medge
, 
	mwidth
);

1457 (*
	mEdgeLo›LumaVî
Ë(
Cﬁ‹Pœ√
 
	m∂
, 
img≥l
** 
	mImg
, 
byã
 
	mSåígth
[16], 
Ma¸oblock
 *
	mMbQ
, 
	medge
);

1458 (*
	mEdgeLo›ChromaVî
)(
img≥l
** 
	mImg
, 
byã
 
	mSåígth
[16], 
Ma¸oblock
 *
	mMbQ
, 
	medge
, 
	muv
);

1459 (*
	mEdgeLo›ChromaH‹
)(
img≥l
** 
	mImg
, 
byã
 
	mSåígth
[16], 
Ma¸oblock
 *
	mMbQ
, 
	medge
, 
	mwidth
, 
	muv
);

1462 (*
	mE°im©eWPBSli˚
Ë(
¶i˚
 *
	mcuºSli˚
);

1463 (*
	mE°im©eWPPSli˚
Ë(
¶i˚
 *
	mcuºSli˚
, 
	moff£t
);

1464 (*
	mTe°WPPSli˚
Ë(
¶i˚
 *
	mcuºSli˚
, 
	moff£t
);

1465 (*
	mTe°WPBSli˚
Ë(
¶i˚
 *
	mcuºSli˚
, 
	mmëhod
);

1466 
di°blk
 (*
di°‹ti⁄4x4
)(*, 
	mdi°blk
);

1467 
di°blk
 (*
di°‹ti⁄8x8
)(*, 
	mdi°blk
);

1470 
di°blk
 (*
compuãUniPªd
[6]Ë(
°‹abÀ_pi˘uª
 *
	mªf1
, 
	mme_block
 *, 
	mdi°blk
 , 
	mMŸi⁄Ve˘‹
 * );

1471 
di°blk
 (*
compuãBiPªd1
[3]Ë(
°‹abÀ_pi˘uª
 *
	mªf1
, °‹abÀ_pi˘uª *
	mªf2
, 
	mme_block
*, 
	mdi°blk
 , 
	mMŸi⁄Ve˘‹
 *, MotionVector *);

1472 
di°blk
 (*
compuãBiPªd2
[3]Ë(
°‹abÀ_pi˘uª
 *
	mªf1
, °‹abÀ_pi˘uª *
	mªf2
, 
	mme_block
*, 
	mdi°blk
 , 
	mMŸi⁄Ve˘‹
 *, MotionVector *);

1474 
£q_∑ømëî_£t_rb•_t
 *
	m•s
[
MAX_NUM_DPB_LAYERS
];

1475 
FømeF‹m©
 
	mouçut_f‹m©
[
MAX_NUM_DPB_LAYERS
];

1476 
	mnum_of_œyîs
;

1477 
	mdpb_œyî_id
;

1479 
BlockPos
 *
	mPicPos
;

1482 
Cﬁ‹F‹m©
 
	myuv_f‹m©
;

1483 
	mP444_joöed
;

1484 
	mbôdïth_luma
;

1485 
	mbôdïth_chroma
;

1486 
	mbôdïth_sˇÀ
[2];

1487 
	mbôdïth_luma_qp_sˇÀ
;

1488 
	mbôdïth_chroma_qp_sˇÀ
;

1489 
	mbôdïth_œmbda_sˇÀ
;

1490 
uöt32
 
	mdc_¥ed_vÆue_comp
[
MAX_PLANE
];

1491 
	mmax_≥l_vÆue_comp
 [
MAX_PLANE
];

1492 
	mmax_img≥l_vÆue_comp_sq
 [
MAX_PLANE
];

1493 
	mnum_blk8x8_uv
;

1494 
	mnum_cdc_c€ff
;

1495 
	mmb_¸_size_x
;

1496 
	mmb_¸_size_y
;

1497 
	mmb_size
[
MAX_PLANE
][2];

1498 
	mmax_bôCou¡
;

1499 
	mwidth
;

1500 
	mwidth_∑dded
;

1501 
	mwidth_blk
;

1502 
	mwidth_¸
;

1503 
	mheight
;

1504 
	mheight_∑dded
;

1505 
	mheight_blk
;

1506 
	mheight_¸
;

1507 
	mheight_¸_‰ame
;

1508 
	msize
;

1509 
	msize_¸
;

1510 
	m∑dded_size_x
;

1511 
	m∑dded_size_x_m8x8
;

1512 
	m∑dded_size_x_m4x4
;

1513 
	m¸_∑dded_size_x
;

1514 
	m¸_∑dded_size_x_m8
;

1515 
	m¸_∑dded_size_x2
;

1516 
	m¸_∑dded_size_x4
;

1517 
	m∑d_size_uv_x
;

1518 
	m∑d_size_uv_y
;

1519 
	mchroma_mask_mv_y
;

1520 
	mchroma_mask_mv_x
;

1521 
	mchroma_shi·_y
, 
	mchroma_shi·_x
;

1522 
	mshi·_¸_x
, 
	mshi·_¸_y
;

1524 
	mPicWidthInMbs
;

1525 
	mPicHeightInM≠Unôs
;

1526 
	mFømeHeightInMbs
;

1527 
	mFømeSizeInMbs
;

1529 } 
	tVideoP¨amëîs
;

1532 
sˇlög_li°
 
	tSˇÀP¨amëîs
;

1533 
rdo_°ru˘uª
 
	tRDOPTSåu˘uª
;

1535 
	sícodî_∑øms


1537 
I≈utP¨amëîs
 *
	mp_I≈
;

1538 
VideoP¨amëîs
 *
	mp_Vid
;

1539 
FILE
 *
	mp_åa˚
;

1540 
öt64
 
	mbuf„rSize
;

1541 } 
	tEncodîP¨ams
;

1543 
EncodîP¨ams
 *
p_Enc
;

1551 
c›yblock_•
 (
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
pos_mb1
,
pos_mb2
);

1552 
ªsiduÆ_å™sf‹m_qu™t_chroma_4x4
 (
Ma¸oblock
 *
cuºMB
, 
uv
, 
¸_cbp
);

1553 
ªsiduÆ_å™sf‹m_qu™t_chroma_4x4_•
 (
Ma¸oblock
 *
cuºMB
, 
uv
,
i11
);

1554 
ªsiduÆ_å™sf‹m_qu™t_chroma_4x4_•2
 (
Ma¸oblock
 *
cuºMB
, 
uv
,
i11
);

1557 
di°blk
 
GëDúe˘Co°MB
 (
Ma¸oblock
 *
cuºMB
);

1558 
di°blk
 
GëDúe˘Co°8x8
 (
Ma¸oblock
 *
cuºMB
, , distblk*);

1560 
pi˘uª_codög_decisi⁄
 (
VideoP¨amëîs
 *
p_Vid
, 
Pi˘uª
 *
pi˘uª1
, Pi˘uª *
pi˘uª2
, 
qp
);

1562 
no_mem_exô
 (*
whîe
);

1563 
gë_mem_ACc€ff_√w
 (****** 
cofAC
, 
chroma
);

1564 
gë_mem_ACc€ff
 (
VideoP¨amëîs
 *
p_Vid
, *****);

1565 
gë_mem_DCc€ff
 (****);

1566 
‰ì_mem_ACc€ff
 (****);

1567 
‰ì_mem_ACc€ff_√w
 (***** 
cofAC
);

1568 
‰ì_mem_DCc€ff
 (***);

1570 #i‡
TRACE


1571 
åa˚2out
(
Sy¡axEÀmít
 *
£
);

1572 
åa˚2out_ˇbac
(
Sy¡axEÀmít
 *
£
);

1575 
îr‹
(*
ãxt
, 
code
);

1576 
£t_mbaff_∑ømëîs
(
Ma¸oblock
 *
cuºMB
);

1579 
is_bùªd_íabÀd
 (
VideoP¨amëîs
 *
p_Vid
, 
mode
);

1580 
upd©e_qp
 (
Ma¸oblock
 *
cuºMB
);

1581 
£À˘_∂™e
 (
VideoP¨amëîs
 *
p_Vid
, 
Cﬁ‹Pœ√
 
cﬁ‹_∂™e
);

1582 
£À˘_å™sf‹m
 (
Ma¸oblock
 *
cuºMB
);

1583 
£t_¶i˚_ty≥
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
¶i˚_ty≥
);

1584 
‰ì_ícodî_mem‹y
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
);

1585 
ouçut_SP_c€fficõ¡s
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
);

1586 
ªad_SP_c€fficõ¡s
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
);

1587 
öô_ªdund™t_‰ame
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
);

1588 
£t_ªdund™t_‰ame
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
);

1589 
ícode_⁄e_ªdund™t_‰ame
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
);

1595 
img≥l
 ****
	mluma
;

1596 
img≥l
 ****
	m¸cb
[2];

1597 } 
	tSubImageC⁄èöî
;

1600 
ch™ge_∂™e_JV
 ( 
VideoP¨amëîs
 *
p_Vid
, 
≈œ√
 );

1601 
make_‰ame_pi˘uª_JV
–
VideoP¨amëîs
 *
p_Vid
 );

1605 
	gîr‹ãxt
[
ET_SIZE
];

1606 
£tup_codög_œyî
(
VideoP¨amëîs
 *
p_Vid
);

1608 
ölöe
 
	$is_FREXT_¥ofûe
(
¥ofûe_idc
)

1610  ( 
¥ofûe_idc
>=
FREXT_HP
 ||Örofûe_id¯=
FREXT_CAVLC444
 );

1611 
	}
}

1614 
ölöe
 
	$is_MVC_¥ofûe
(
¥ofûe_idc
)

1617 #i‡(
MVC_EXTENSION_ENABLE
)

1618 || (
¥ofûe_idc
 =
MULTIVIEW_HIGH
Ë|| (¥ofûe_id¯=
STEREO_HIGH
)

1621 
	}
}

1623 
ölöe
 
	$is_öåa
(
Ma¸oblock
 *
cuº_MB
)

1625  ((
cuº_MB
)->
mb_ty≥
==
SI4MB
 || (cuº_MB)->mb_ty≥==
I4MB
 || (cuº_MB)->mb_ty≥==
I16MB
 || (cuº_MB)->mb_ty≥==
I8MB
 || (cuº_MB)->mb_ty≥==
IPCM
);

1626 
	}
}

	@lencod/inc/header.h

11 #i‚de‡
_HEADER_H_


12 
	#_HEADER_H_


	)

14 
Sli˚Hódî
 (
Sli˚
* 
cuºSli˚
);

15 
P¨tôi⁄_BC_Hódî
(
Sli˚
 *
cuºSli˚
, 
P¨tNo
);

16 
wrôeERPS
 (
Sy¡axEÀmít
 *
sym
, 
D©aP¨tôi⁄
 *
∑πôi⁄
);

17 
dec_ªf_pic_m¨kög
(
Bô°ªam
 *
bô°ªam
, 
DecRefPicM¨kög_t
 *
p_dΩm
, 
idr_Êag
, 
no_ouçut_of_¥i‹_pics_Êag
, 
l⁄g_ãrm_ª„ªn˚_Êag
 );

	@lencod/inc/image.h

17 #i‚de‡
_IMAGE_H_


18 
	#_IMAGE_H_


	)

20 
	~"mbuf„r.h
"

22 
	scodög_öfo
 {

23 
	mty≥
;

24 
	möåas
;

25 
	msumFømeQP
;

26 
	mnum_ªf_idx_l0
;

27 
	mnum_ªf_idx_l1
;

28 
pic_∑ømëî_£t_rb•_t
 *
	ma˘ive_µs
;

29 } 
	tCodögInfo
;

31 
ícode_⁄e_‰ame
 ( 
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
);

32 
Boﬁón
 
dummy_¶i˚_too_big
 ( 
bôs_¶i˚
);

33 
c›y_rd›t_d©a
 ( 
Ma¸oblock
 *
cuºMB
);

34 
UnifõdO√F‹thPix
 ( 
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
s
);

36 
UnifõdO√F‹thPix_JV
 ( 
VideoP¨amëîs
 *
p_Vid
, 
≈œ√
, 
St‹abÀPi˘uª
 *
s
);

37 
‰ame_pi˘uª
 ( 
VideoP¨amëîs
 *
p_Vid
, 
Pi˘uª
 *
‰ame
, 
ImageD©a
 *
imgD©a
, 
rd_∑ss
);

38 
byã
 
gë_idr_Êag
 ( 
VideoP¨amëîs
 *
p_Vid
 );

39 
byã
 
gë_øndom_ac˚ss_Êag
–
VideoP¨amëîs
 *
p_Vid
 );

40 
wrôe_n⁄_v˛_«lu
 ( 
VideoP¨amëîs
 *
p_Vid
);

41 
wrôe_n⁄_v˛_«lu_bŸ_Êd
–
VideoP¨amëîs
 *
p_Vid
 );

42 #i‡(
MVC_EXTENSION_ENABLE
)

43 
wrôe_n⁄_v˛_«lu_mvc
–
VideoP¨amëîs
 *
p_Vid
);

46 
‰ame_pi˘uª_mp
 ( 
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
 );

47 
ª°‹e_codög_öfo
 ( 
VideoP¨amëîs
 *
p_Vid
, 
CodögInfo
 *
codög_öfo
 );

48 
°‹e_codög_öfo
 ( 
VideoP¨amëîs
 *
p_Vid
, 
CodögInfo
 *
codög_öfo
 );

49 
°‹e_codög_™d_rc_öfo
–
VideoP¨amëîs
 *
p_Vid
, 
CodögInfo
 *
codög_öfo
 );

50 
sw≠_‰ame_buf„r
 ( 
VideoP¨amëîs
 *
p_Vid
, 
a
, 
b
 );

51 
‰ame_pi˘uª_mp_exô
 ( 
VideoP¨amëîs
 *
p_Vid
, 
CodögInfo
 *
codög_öfo
 );

53 
Gíî©eImagePyømid
(
VideoP¨amëîs
 *
p_Vid
, 
size_x
, 
size_y
, 
img≥l
 ***
p_hme_öt_img
, 
off£t_x
, 
off£t_y
);

54 
OuçutImage
(*
pcPªfix
, 
iFømeNo
, 
iLevñ
, 
img≥l
 **
pImg
, 
iWidth
, 
iHeight
, 
iXOff£t
, 
iYOff£t
);

55 
c›y_∑øms
(
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
íc_pi˘uª
, 
£q_∑ømëî_£t_rb•_t
 *
a˘ive_•s
);

56 
OtfCom∑tibûôy_c›yWôhPaddög
 ( 
img≥l
 **
d°Img
, img≥»**
§cImg
, 
size_x
, 
size_y
, 
∑ddög_x
, 
∑ddög_y
 );

	@lencod/inc/img_chroma.h

18 #i‚de‡
_IMG_CHROMA_H_


19 
	#_IMG_CHROMA_H_


	)

21 
gëSubImagesChroma
–
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
s
 );

	@lencod/inc/img_dist_ms_ssim.h

19 #i‚de‡
_IMG_DIST_MS_SSIM_H_


20 
	#_IMG_DIST_MS_SSIM_H_


	)

21 
	~"img_di°‹ti⁄.h
"

23 
föd_ms_ssim
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
ImageSåu˘uª
 *
imgREF
, ImageSåu˘uª *
imgSRC
, 
Di°Mëric
 
mëricMS_SSIM
[3]);

	@lencod/inc/img_dist_snr.h

17 #i‚de‡
_IMG_DIST_SNR_H_


18 
	#_IMG_DIST_SNR_H_


	)

19 
	~"img_di°‹ti⁄.h
"

21 
föd_¢r
(
VideoP¨amëîs
 *
p_Vid
, 
ImageSåu˘uª
 *
imgREF
, ImageSåu˘uª *
imgSRC
, 
Di°Mëric
 
mëricSSE
[3], Di°Mëri¯
mëricPSNR
[3]);

	@lencod/inc/img_dist_ssim.h

19 #i‚de‡
_IMG_DIST_SSIM_H_


20 
	#_IMG_DIST_SSIM_H_


	)

21 
	~"img_di°‹ti⁄.h
"

23 
föd_ssim
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
ImageSåu˘uª
 *
imgREF
, ImageSåu˘uª *
imgSRC
, 
Di°Mëric
 
mëricSSIM
[3]);

	@lencod/inc/img_distortion.h

17 #i‚de‡
_IMG_DISTORTION_H_


18 
	#_IMG_DISTORTION_H_


	)

20 
accumuœã_av¶i˚
(
Di°Mëric
 
mëric
[3], 
¶i˚_ty≥
, 
‰ames
);

21 
accumuœã_avîage
(
Di°Mëric
 
mëric
[3], 
‰ames
);

22 
föd_di°‹ti⁄
 (
VideoP¨amëîs
 *
p_Vid
, 
ImageD©a
 *
imgD©a
);

23 
£À˘_img
 (
VideoP¨amëîs
 *
p_Vid
, 
ImageSåu˘uª
 *
imgSRC
, ImageSåu˘uª *
imgREF
, 
ImageD©a
 *
imgD©a
);

24 
compuã_di°‹ti⁄
(
VideoP¨amëîs
 *
p_Vid
, 
ImageD©a
 *
imgD©a
);

	@lencod/inc/img_luma.h

18 #i‚de‡
_IMG_LUMA_H_


19 
	#_IMG_LUMA_H_


	)

21 c⁄° 
	gONE_FOURTH_TAP
[2][3] =

27 
gëSubImagesLuma
 ( 
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
s
 );

	@lencod/inc/intra16x16.h

17 #i‚de‡
_INTRA16X16_H_


18 
	#_INTRA16X16_H_


	)

20 
di°blk
 
di°I16x16_ßd
 (
Ma¸oblock
 *
cuºMB
, 
img≥l
 **
img_‹g
, img≥»**
¥ed_img
, di°blk 
mö_co°
);

21 
di°blk
 
di°I16x16_s£
 (
Ma¸oblock
 *
cuºMB
, 
img≥l
 **
img_‹g
, img≥»**
¥ed_img
, di°blk 
mö_co°
);

22 
di°blk
 
di°I16x16_ßtd
 (
Ma¸oblock
 *
cuºMB
, 
img≥l
 **
img_‹g
, img≥»**
¥ed_img
, di°blk 
mö_co°
);

24 
di°blk
 
föd_ßd_16x16_JM
 (
Ma¸oblock
 *
cuºMB
);

26 
£t_öå≠ªd_16x16_mbaff
 (
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, *
À·_avaûabÀ
, *
up_avaûabÀ
, *
Æl_avaûabÀ
);

27 
£t_öå≠ªd_16x16
 (
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, *
À·_avaûabÀ
, *
up_avaûabÀ
, *
Æl_avaûabÀ
);

28 
gë_öå≠ªd_16x16
 (
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
i16x16_mode
, 
À·_avaûabÀ
, 
up_avaûabÀ
);

	@lencod/inc/intra4x4.h

15 #i‚de‡
_INTRA4x4_H_


16 
	#_INTRA4x4_H_


	)

19 
£t_öå≠ªd_4x4_mbaff
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
img_x
, 
img_y
, *
À·_avaûabÀ
, *
up_avaûabÀ
, *
Æl_avaûabÀ
);

20 
£t_öå≠ªd_4x4
 (
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
img_x
, 
img_y
, *
À·_avaûabÀ
, *
up_avaûabÀ
, *
Æl_avaûabÀ
);

21 
gë_öå≠ªd_4x4
 (
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
i4x4_mode
, 
img_x
, 
img_y
, 
À·_avaûabÀ
, 
up_avaûabÀ
);

24 
gíî©e_¥ed_îr‹_4x4
(
img≥l
 **
cur_img
, img≥»**
¥d_img
, img≥»**
cur_¥d
, **
mb_ºes
, 
pic_›ix_x
, 
block_x
);

	@lencod/inc/intra8x8.h

17 #i‚de‡
_INTRA8X8_H_


18 
	#_INTRA8X8_H_


	)

20 
£t_öå≠ªd_8x8_mbaff
 (
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
img_x
,
img_y
, *
À·_avaûabÀ
, *
up_avaûabÀ
, *
up_À·_avaûabÀ
);

21 
£t_öå≠ªd_8x8
 (
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
img_x
,
img_y
, *
À·_avaûabÀ
, *
up_avaûabÀ
, *
up_À·_avaûabÀ
);

22 
gë_öå≠ªd_8x8
 (
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
i8x8_mode
, 
À·_avaûabÀ
, 
up_avaûabÀ
);

23 
LowPassF‹I¡ø8x8Pªd
 (
img≥l
 *
PªdPñ
, 
block_up_À·
, 
block_up
, 
block_À·
);

25 
gíî©e_¥ed_îr‹_8x8
 (
img≥l
 **
cur_img
, img≥»**
¥d_img
, img≥»**
cur_¥d
, **
mb_ºes
, 
pic_›ix_x
, 
block_x
);

	@lencod/inc/intrarefresh.h

17 #i‚de‡
_INTRAREFRESH_H_


18 
	#_INTRAREFRESH_H_


	)

20 
R™domI¡øInô
(
VideoP¨amëîs
 *
p_Vid
, 
xsize
, 
ysize
, 
ª‰esh
);

21 
R™domI¡øUnöô
(
VideoP¨amëîs
 *
p_Vid
);

22 
R™domI¡ø
 (
VideoP¨amëîs
 *
p_Vid
, 
mb
);

23 
R™domI¡øNewPi˘uª
 (
VideoP¨amëîs
 *
p_Vid
);

	@lencod/inc/lambda.h

18 #i‚de‡
_LAMBDA_H_


19 
	#_LAMBDA_H_


	)

21 
	~"globÆ.h
"

23 
gë_im∂icô_œmbda_p_¶i˚
 (
Sli˚
 *
cuºSli˚
);

24 
gë_im∂icô_œmbda_b_¶i˚
 (
Sli˚
 *
cuºSli˚
);

25 
gë_im∂icô_œmbda_i_¶i˚
 (
Sli˚
 *
cuºSli˚
);

26 
gë_im∂icô_œmbda_•_¶i˚
(
Sli˚
 *
cuºSli˚
);

27 
gë_ex∂icô_œmbda
 (
Sli˚
 *
cuºSli˚
);

28 
gë_fixed_œmbda
 (
Sli˚
 *
cuºSli˚
);

29 
£t_rdoq_œmbda
 (
Sli˚
 *
cuºSli˚
);

	@lencod/inc/leaky_bucket.h

15 #i‚de‡
_LEAKY_BUCKET_H_


16 
	#_LEAKY_BUCKET_H_


	)

20 #ifde‡
_LEAKYBUCKET_


21 
gë_LókyBuckëR©e
(
I≈utP¨amëîs
 *
p_I≈
, 
NumbîLókyBuckës
, *
Rmö
);

22 
PutBigDoubÀW‹d
 (
dw
, 
FILE
 *
Â
);

23 
wrôe_buf„r
 (
I≈utP¨amëîs
 *
p_I≈
, 
NumbîLókyBuckës
, 
Rmö
[], 
Bmö
[], 
Fmö
[]);

24 
S‹t
 (
NumbîLókyBuckës
, *
Rmö
);

25 
ˇlc_buf„r
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
);

	@lencod/inc/list_reorder.h

19 #i‚de‡
_LIST_REORDER_H_


20 
	#_LIST_REORDER_H_


	)

22 
	~"globÆ.h
"

23 
	~"mbuf„r.h
"

25 
öô_ªf_pic_li°_ª‹dîög
–
Sli˚
 *
cuºSli˚
, 
ªfRe‹dîMëhod
 );

26 
ª‹dî_li°s
 ( 
Sli˚
 *
cuºSli˚
 );

27 
wp_m˝ªc_ª‹dî_li°s
 ( 
Sli˚
 *
cuºSli˚
 );

30 
poc_ªf_pic_ª‹dî_‰ame_deÁu…
–
Sli˚
 *
cuºSli˚
, 
num_ªf_idx_lX_a˘ive
, 
li°_no
 );

31 
poc_ªf_pic_ª‹dî_fõld
 ( 
Sli˚
 *
cuºSli˚
, 
num_ªf_idx_lX_a˘ive
, 
li°_no
 );

32 
poc_ªf_pic_ª‹dî_fõld_íh
 ( 
Sli˚
 *
cuºSli˚
, 
num_ªf_idx_lX_a˘ive
, 
li°_no
 );

34 
éyr_ªf_pic_ª‹dî_‰ame_deÁu…
–
Sli˚
 *
cuºSli˚
, 
num_ªf_idx_lX_a˘ive
, 
li°_no
 );

35 
ª‹dî_agaö°_deÁu…_ªf_pic_li°s
–
Sli˚
 *
cuºSli˚
, 
cur_li°
 );

36 
poc_ªf_pic_ª‹dî_‰ame_íh
–
Sli˚
 *
cuºSli˚
, 
num_ªf_idx_lX_a˘ive
, 
li°_no
 );

37 
£t_deÁu…_ªf_pic_li°s
–
Sli˚
 *
cuºSli˚
 );

	@lencod/inc/lln_mc_prediction.h

18 #i‚de‡
_LLN_MC_PREDICTION_H_


19 
	#_LLN_MC_PREDICTION_H_


	)

21 
	~"globÆ.h
"

22 
	~"mbuf„r.h
"

25 
gë_block_luma
 (
Ma¸oblock
 *
cuºMB
, 
decodî
, 
Cﬁ‹Pœ√
 
∂
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
, St‹abÀPi˘uª *
li°
, 
x_pos
, 
y_pos
, 
block_size_y
, 
block_size_x
, 
img≥l
 
block
[
MB_BLOCK_SIZE
][MB_BLOCK_SIZE]);

26 
gë_block_chroma
(
Ma¸oblock
 *
cuºMb
, 
decodî
, 
uv
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
, St‹abÀPi˘uª *
li°
, 
x_pos
, 
y_pos
, 
block_size_x
, 
block_size_y
, 
img≥l
 
block
[
MB_BLOCK_SIZE
][MB_BLOCK_SIZE]);

31 
≥rf‹m_mc
 (
Ma¸oblock
* 
cuºMB
, 
decodî
, 
Cﬁ‹Pœ√
 
∂
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
, 
¥ed_dú
, 
l0_mode
, 
l1_mode
, 
PicMŸi⁄P¨ams
 **
mv_öfo
, 
i
, 
j
, 
block_size_x
, 
block_size_y
, 
bùªd_me
);

32 
≥rf‹m_mc_c⁄˚Æmít
(
Ma¸oblock
* 
cuºMB
, 
decodî
, 
Cﬁ‹Pœ√
 
∂
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
, 
¥ed_dú
, 
l0_mode
, 
l1_mode
, 
PicMŸi⁄P¨ams
 **
mv_öfo
, 
i
, 
j
, 
block_size_x
, 
block_size_y
);

	@lencod/inc/loop_filter.h

18 #i‚de‡
_LOOP_FILTER_H_


19 
	#_LOOP_FILTER_H_


	)

21 
	~"globÆ.h
"

23 
	#GROUP_SIZE
 1

	)

35 c⁄° 
byã
 
	gALPHA_TABLE
[52] = {0,0,0,0,0,0,0,0,0,0,0,0, 0,0,0,0,4,4,5,6, 7,8,9,10,12,13,15,17, 20,22,25,28,32,36,40,45, 50,56,63,71,80,90,101,113, 127,144,162,182,203,226,255,255} ;

36 c⁄° 
byã
 
	gBETA_TABLE
[52] = {0,0,0,0,0,0,0,0,0,0,0,0, 0,0,0,0,2,2,2,3, 3,3,3, 4, 4, 4, 6, 6, 7, 7, 8, 8, 9, 9,10,10, 11,11,12,12,13,13, 14, 14, 15, 15, 16, 16, 17, 17, 18, 18} ;

37 c⁄° 
byã
 
	gCLIP_TAB
[52][5] =

48 c⁄° 
	gchroma_edge
[2][4][4] =

59 c⁄° 
	g≥ um_¸
[2][4] = {{0,8,16,16}, {0,8, 8,16}};

62 
ölöe
 
	$com∑ª_mvs
(c⁄° 
MŸi⁄Ve˘‹
 *
mv0
, c⁄° MŸi⁄Ve˘‹ *
mv1
, 
mvlimô
)

64  ((
	`übs
–
mv0
->
mv_x
 - 
mv1
->mv_xË>4Ë| (übs–mv0->
mv_y
 - mv1->mv_yË>
mvlimô
));

65 
	}
}

	@lencod/inc/macroblock.h

18 #i‚de‡
_MACROBLOCK_H_


19 
	#_MACROBLOCK_H_


	)

21 
	~"block.h
"

22 
	~"ma¸oblock_p444.h
"

24 c⁄° 
	gblock8x8_idx
[3][4][4] =

46 c⁄° 
	g∑π_size
[8][2] =

58 c⁄° 
	gblock_size
[8][2] =

70 
√xt_ma¸oblock
 (
Ma¸oblock
* 
cuºMB
);

71 
°¨t_ma¸oblock
 (
Sli˚
 *
cuºSli˚
, 
Ma¸oblock
** 
cuºMB
, 
mb_addr
, 
Boﬁón
 
mb_fõld
);

72 
ª£t_ma¸oblock
 (
Ma¸oblock
 *
cuºMB
);

73 
íd_ma¸oblock
 (
Ma¸oblock
* 
cuºMB
, 
Boﬁón
 *
íd_of_¶i˚
, Boﬁó¿*
ªcode_ma¸oblock
);

74 
wrôe_ma¸oblock
 (
Ma¸oblock
* 
cuºMB
, 
eos_bô
);

77 
ª£t_block
(
Ma¸oblock
* 
cuºMB
, *
cbp
, 
öt64
 *
cbp_blk
, 
block8x8
);

79 
luma_ªsiduÆ_codög_16x16
 (
Ma¸oblock
 *, , [2]);

80 
luma_ªsiduÆ_codög_8x8
 (
Ma¸oblock
 *, *, 
öt64
*, , , [2], *);

81 
luma_ªsiduÆ_codög
 (
Ma¸oblock
 *);

82 
luma_ªsiduÆ_codög_•
 (
Ma¸oblock
 *);

83 
chroma_ªsiduÆ_codög
 (
Ma¸oblock
 *);

84 
chroma_ªsiduÆ_codög_•
 (
Ma¸oblock
 *);

85 
chroma_ªsiduÆ_codög_si
 (
Ma¸oblock
 *);

86 
öåa_chroma_RD_decisi⁄
 (
Ma¸oblock
 *, 
RD_PARAMS
 *);

87 
öåa_chroma_RD_decisi⁄_mbaff
 (
Ma¸oblock
 *, 
RD_PARAMS
 *);

89 
byã
 
å™sf‹m_decisi⁄
 (
Ma¸oblock
 *, , 
di°blk
*);

90 
B8Mode2VÆue
 (
Sli˚
 *, , );

92 
wrôe_p_¶i˚_MB_œyî
 (
Ma¸oblock
 *, , *);

93 
wrôe_b_¶i˚_MB_œyî
 (
Ma¸oblock
 *, , *);

94 
wrôe_i_¶i˚_MB_œyî
 (
Ma¸oblock
 *, , *);

96 
wrôe_ãrmö©ög_bô
 (
Sli˚
* 
cuºSli˚
, 
bô
);

98 
wrôeMŸi⁄Info2NAL
 (
Ma¸oblock
* 
cuºMB
);

99 
wrôe_p_¶i˚_mŸi⁄_öfo_to_NAL
 (
Ma¸oblock
* 
cuºMB
);

100 
wrôe_b_¶i˚_mŸi⁄_öfo_to_NAL
 (
Ma¸oblock
* 
cuºMB
);

101 
wrôe_p_¶i˚_mŸi⁄_öfo_to_NAL
 (
Ma¸oblock
* 
cuºMB
);

102 
wrôeRe„ªn˚Føme
 (
Ma¸oblock
 *
cuºMB
, 
i
, 
j
, 
li°_idx
, 
ªf
);

103 
wrôeMŸi⁄Ve˘‹8x8
 (
Ma¸oblock
 *
cuºMB
, 
i0
, 
j0
, 
i1
, 
j1
, 
ªf‰ame
, 
li°_idx
, 
mv_mode
, 
bùªd_me
);

105 
wrôeC€ff4x4_CABAC
 (
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
, , , );

106 
wrôeC€ff8x8_CABAC
 (
Ma¸oblock
* 
cuºMB
, 
Cﬁ‹Pœ√
, , );

107 
wrôeC€ff8x8
 (
Ma¸oblock
* 
cuºMB
, 
Cﬁ‹Pœ√
, , , );

108 
wrôeC€ff16x16_CABAC
 (
Ma¸oblock
* 
cuºMB
, 
Cﬁ‹Pœ√
);

109 
wrôeC€ff16x16_CAVLC
 (
Ma¸oblock
* 
cuºMB
, 
Cﬁ‹Pœ√
);

111 
wrôeC€ff4x4_CAVLC_n‹mÆ
 (
Ma¸oblock
* 
cuºMB
, 
block_ty≥
, 
b8
, 
b4
, 
∑øm
);

112 
wrôeC€ff4x4_CAVLC_444
 (
Ma¸oblock
* 
cuºMB
, 
block_ty≥
, 
b8
, 
b4
, 
∑øm
);

114 
¥edi˘_¬z
 (
Ma¸oblock
 *
cuºMB
, 
block_ty≥
, 
i
,
j
);

115 
¥edi˘_¬z_chroma
(
Ma¸oblock
 *
cuºMB
, 
i
,
j
);

117 
£t_modes_™d_ª‰ame
 (
Ma¸oblock
* 
cuºMB
, 
b8
, * 
p_dú
, 
li°_mode
[2], *
li°_ªf_idx
);

118 
£t_modes_™d_ª‰ame_i_¶i˚
 (
Ma¸oblock
* 
cuºMB
, 
b8
, * 
p_dú
, 
li°_mode
[2], *
li°_ªf_idx
);

119 
£t_modes_™d_ª‰ame_b_¶i˚
 (
Ma¸oblock
* 
cuºMB
, 
b8
, * 
p_dú
, 
li°_mode
[2], *
li°_ªf_idx
);

120 
£t_modes_™d_ª‰ame_p_¶i˚
 (
Ma¸oblock
* 
cuºMB
, 
b8
, * 
p_dú
, 
li°_mode
[2], *
li°_ªf_idx
);

121 
Ma¸oblock
 *
Æloc_mbs
(
VideoP¨amëîs
 *
p_Vid
, 
mb_num
, 
œyîs
);

122 
‰ì_mbs
(
Ma¸oblock
 *
pMBs
, 
mb_num
);

123 
£tup_mbs
(
Ma¸oblock
 *
pMBs
, 
mb_num
, 
œyî_id
);

	@lencod/inc/macroblock_p444.h

14 #i‚de‡
_MACROBLOCK_P444_H_


15 
	#_MACROBLOCK_P444_H_


	)

17 
	~"block.h
"

19 
luma_ªsiduÆ_codög_p444_16x16
 (
Ma¸oblock
* 
cuºMB
, , , [2], *);

20 
luma_ªsiduÆ_codög_p444_8x8
 (
Ma¸oblock
* 
cuºMB
, *, 
öt64
*, , , [2], *);

21 
luma_ªsiduÆ_codög_p444
 (
Ma¸oblock
 *
cuºMB
);

	@lencod/inc/mbuffer.h

17 #i‚de‡
_MBUFFERENC_H_


18 
	#_MBUFFERENC_H_


	)

20 
	~"globÆ.h
"

21 
	~"íc_°©i°ics.h
"

23 
	#MAX_LIST_SIZE
 33

	)

25 
‰ame_°‹e
 
	tFømeSt‹e
;

26 
di°‹ti⁄_e°im©i⁄
 
	tDi°_E°m
;

27 
pi˘uª_°©s
 
	tPi˘uªSèts
;

28 
pic_mŸi⁄_∑øms_ﬁd
 
	tPicMŸi⁄P¨amsOld
;

30 
	spi˘uª_°©s


32 
	mdsum
[3];

33 
	mdv¨
[3];

38 
	spic_mŸi⁄_∑øms_ﬁd


40 
byã
 * 
	mmb_fõld
;

45 
	spic_mŸi⁄_∑øms


47 
°‹abÀ_pi˘uª
 *
	mªf_pic
[2];

48 
	mªf_idx
[2];

49 
MŸi⁄Ve˘‹
 
	mmv
[2];

50 
byã
 
	mfõld_‰ame
;

51 } 
	tPicMŸi⁄P¨ams
;

55 
	s°‹abÀ_pi˘uª


57 
Pi˘uªSåu˘uª
 
	m°ru˘uª
;

59 
	mpoc
;

60 
	mt›_poc
;

61 
	mbŸtom_poc
;

62 
	m‰ame_poc
;

63 
	m‹dî_num
;

64 
	m‰ame_num
;

65 
	mpic_num
;

66 
	ml⁄g_ãrm_pic_num
;

67 
	ml⁄g_ãrm_‰ame_idx
;

68 
	mãmp‹Æ_œyî
;

70 
byã
 
	mis_l⁄g_ãrm
;

71 
	mu£d_f‹_ª„ªn˚
;

72 
	mis_ouçut
;

73 
	mn⁄_exi°ög
;

75 
	msize_x
, 
	msize_y
, 
	msize_x_¸
, 
	msize_y_¸
;

76 
	msize_x_∑dded
, 
	msize_y_∑dded
;

77 
	msize_x_∑d
, 
	msize_y_∑d
;

78 
	msize_x_¸_∑d
, 
	msize_y_¸_∑d
;

79 
	m∑d_size_uv_y
, 
	m∑d_size_uv_x
;

80 
	mchroma_ve˘‹_adju°mít
;

81 
	mcoded_‰ame
;

82 
	mmb_aff_‰ame_Êag
;

84 
img≥l
 ** 
	mimgY
;

85 
img≥l
 **** 
	mimgY_sub
;

86 
img≥l
 *** 
	mimgUV
;

87 
img≥l
 *****
	mimgUV_sub
;

89 
img≥l
 *** 
	mp_dec_img
[
MAX_PLANE
];

91 
img≥l
 ** 
	mp_img
[
MAX_PLANE
];

92 
img≥l
 **** 
	mp_img_sub
[
MAX_PLANE
];

93 
img≥l
 ** 
	mp_cuº_img
;

94 
img≥l
 **** 
	mp_cuº_img_sub
;

96 
img≥l
 *** 
	mp_hme_öt_img
;

97 
img≥l
 ***** 
	mp_hme_sub_img
;

99 
Di°_E°m
 * 
	mde_mem
;

101 
PicMŸi⁄P¨ams
 **
	mmv_öfo
;

102 
PicMŸi⁄P¨ams
 **
	mJVmv_öfo
[
MAX_PLANE
];

103 
PicMŸi⁄P¨amsOld
 
	mmŸi⁄
;

104 
PicMŸi⁄P¨amsOld
 
	mJVmŸi⁄
[
MAX_PLANE
];

106 
	mcﬁour_∂™e_id
;

108 
°‹abÀ_pi˘uª
 *
	mt›_fõld
;

109 
°‹abÀ_pi˘uª
 *
	mbŸtom_fõld
;

110 
°‹abÀ_pi˘uª
 *
	m‰ame
;

112 
	mchroma_f‹m©_idc
;

113 
	mchroma_mask_mv_x
;

114 
	mchroma_mask_mv_y
;

115 
	mchroma_shi·_y
;

116 
	mchroma_shi·_x
;

117 
	m‰ame_mbs_⁄ly_Êag
;

118 
	m‰ame_¸›pög_Êag
;

119 
	m‰ame_¸›_À·_off£t
;

120 
	m‰ame_¸›_right_off£t
;

121 
	m‰ame_¸›_t›_off£t
;

122 
	m‰ame_¸›_bŸtom_off£t
;

124 
Pi˘uªSèts
 
	mp_°©s
;

125 
SètP¨amëîs
 
	m°©s
;

127 
	mty≥
;

129 #i‡(
MVC_EXTENSION_ENABLE
)

130 
	mvõw_id
;

131 
	möãr_võw_Êag
[2];

132 
	m™ch‹_pic_Êag
[2];

135 
	mbI¡îpﬁ©ed
;

136 
	mªf_pic_«
[6];

137 
	mŸf_Êag
;

139 } 
	tSt‹abÀPi˘uª
;

141 
St‹abÀPi˘uª
 *
	tSt‹abÀPi˘uªPå
;

144 
	s‰ame_°‹e


146 
	mis_u£d
;

147 
	mis_ª„ªn˚
;

148 
	mis_l⁄g_ãrm
;

149 
	mis_‹ig_ª„ªn˚
;

151 
	mis_n⁄_exi°ít
;

153 
	m‰ame_num
;

154 
	m‰ame_num_wøp
;

155 
	ml⁄g_ãrm_‰ame_idx
;

156 
	mis_ouçut
;

157 
	mpoc
;

159 
St‹abÀPi˘uª
 *
	m‰ame
;

160 
St‹abÀPi˘uª
 *
	mt›_fõld
;

161 
St‹abÀPi˘uª
 *
	mbŸtom_fõld
;

163 
Boﬁón
 
	mis_öãr_œyî
;

165 #i‡(
MVC_EXTENSION_ENABLE
)

166 
	mvõw_id
;

167 
	möãr_võw_Êag
[2];

168 
	m™ch‹_pic_Êag
[2];

175 
	sdecoded_pi˘uª_buf„r


177 
VideoP¨amëîs
 *
	mp_Vid
;

178 
I≈utP¨amëîs
 *
	mp_I≈
;

179 
FømeSt‹e
 **
	mfs
;

180 
FømeSt‹e
 **
	mfs_ªf
;

181 
FømeSt‹e
 **
	mfs_…ªf
;

182 
FømeSt‹e
 **
	mfs_ûªf
;

183 
	mnum_ªf_‰ames
;

184 
	msize
;

185 
	mu£d_size
;

186 
	mªf_‰ames_ö_buf„r
;

187 
	m…ªf_‰ames_ö_buf„r
;

188 
	mœ°_ouçut_poc
;

189 #i‡(
MVC_EXTENSION_ENABLE
)

190 
	mœ°_ouçut_võw_id
;

192 
	mmax_l⁄g_ãrm_pic_idx
;

194 
	möô_d⁄e
;

196 
FømeSt‹e
 *
	mœ°_pi˘uª
;

197 
	mœyî_id
;

198 
	mu£d_size_û
;

200 
FømeF‹m©
 
	m°‹age_f‹m©
;

202 (*
	mpf_luma_¥edi˘i⁄
Ë–
Ma¸oblock
* 
	mcuºMB
, , , , , , [2], *, );

203 (*
	mpf_luma_¥edi˘i⁄_bi
Ë–
Ma¸oblock
* 
	mcuºMB
, , , , , , , , , );

204 (*
	mpf_chroma_¥edi˘i⁄
Ë–
Ma¸oblock
* 
	mcuºMB
, , , , , , , , , , , );

205 (*
	mpf_gë_block_luma
Ë–
	mvideo_∑r
 *, 
	mimg≥l
*, *, , , , , 
	m°‹abÀ_pi˘uª
*, );

206 (*
	mpf_gë_block_chroma
[2]Ë–
	mvideo_∑r
 *, 
	mimg≥l
*, *, , , , , 
	m°‹abÀ_pi˘uª
*, );

207 (*
	mpf_O√Comp⁄ítChromaPªdi˘i⁄4x4_ªgíî©e
)(
Ma¸oblock
 *
	mcuºMB
, 
	mimg≥l
* , , , 
	mMŸi⁄Ve˘‹
 ** , 
St‹abÀPi˘uª
 *
	mli°X
, );

208 (*
	mpf_O√Comp⁄ítChromaPªdi˘i⁄4x4_ªåõve
Ë(
Ma¸oblock
 *
	mcuºMB
, 
	mimg≥l
* , , , 
	mMŸi⁄Ve˘‹
 ** , 
St‹abÀPi˘uª
 *
	mli°X
, );

209 
di°blk
 (*
pf_compuãSAD
Ë(
St‹abÀPi˘uª
 *
	mªf1
, 
	mMEBlock
*, 
	mdi°blk
, 
	mMŸi⁄Ve˘‹
 *);

210 
di°blk
 (*
pf_compuãSADWP
Ë(
St‹abÀPi˘uª
 *
	mªf1
, 
	mMEBlock
*, 
	mdi°blk
, 
	mMŸi⁄Ve˘‹
 *);

211 
di°blk
 (*
pf_compuãSATD
Ë(
St‹abÀPi˘uª
 *
	mªf1
, 
	mMEBlock
*, 
	mdi°blk
, 
	mMŸi⁄Ve˘‹
 *);

212 
di°blk
 (*
pf_compuãSATDWP
Ë(
St‹abÀPi˘uª
 *
	mªf1
, 
	mMEBlock
*, 
	mdi°blk
, 
	mMŸi⁄Ve˘‹
 *);

213 
di°blk
 (*
pf_compuãBiPªdSAD1
)(
St‹abÀPi˘uª
 *
	mªf1
, St‹abÀPi˘uª *
	mªf2
, 
	mMEBlock
*, 
	mdi°blk
, 
	mMŸi⁄Ve˘‹
 *, MotionVector *);

214 
di°blk
 (*
pf_compuãBiPªdSAD2
)(
St‹abÀPi˘uª
 *
	mªf1
, St‹abÀPi˘uª *
	mªf2
, 
	mMEBlock
*, 
	mdi°blk
, 
	mMŸi⁄Ve˘‹
 *, MotionVector *);

215 
di°blk
 (*
pf_compuãBiPªdSATD1
Ë(
St‹abÀPi˘uª
 *
	mªf1
, St‹abÀPi˘uª *
	mªf2
, 
	mMEBlock
*, 
	mdi°blk
, 
	mMŸi⁄Ve˘‹
 *, MotionVector *);

216 
di°blk
 (*
pf_compuãBiPªdSATD2
Ë(
St‹abÀPi˘uª
 *
	mªf1
, St‹abÀPi˘uª *
	mªf2
, 
	mMEBlock
*, 
	mdi°blk
, 
	mMŸi⁄Ve˘‹
 *, MotionVector *);

217 
di°blk
 (*
pf_compuãSSE
Ë(
St‹abÀPi˘uª
 *
	mªf1
, 
	mMEBlock
*, 
	mdi°blk
, 
	mMŸi⁄Ve˘‹
 *);

218 
di°blk
 (*
pf_compuãSSEWP
Ë(
St‹abÀPi˘uª
 *
	mªf1
, 
	mMEBlock
*, 
	mdi°blk
, 
	mMŸi⁄Ve˘‹
 *);

219 
di°blk
 (*
pf_compuãBiPªdSSE1
Ë(
St‹abÀPi˘uª
 *
	mªf1
, St‹abÀPi˘uª *
	mªf2
, 
	mMEBlock
*, 
	mdi°blk
, 
	mMŸi⁄Ve˘‹
 *, MotionVector *);

220 
di°blk
 (*
pf_compuãBiPªdSSE2
Ë(
St‹abÀPi˘uª
 *
	mªf1
, St‹abÀPi˘uª *
	mªf2
, 
	mMEBlock
*, 
	mdi°blk
, 
	mMŸi⁄Ve˘‹
 *, MotionVector *);

221 }
	tDecodedPi˘uªBuf„r
;

223 
öô_dpb
 (
VideoP¨amëîs
 *
p_Vid
, 
DecodedPi˘uªBuf„r
 *
dpb
);

224 
‰ì_dpb
 (
DecodedPi˘uªBuf„r
 *
p_Dpb
);

225 
FømeSt‹e
* 
Æloc_‰ame_°‹e
();

226 
‰ì_‰ame_°‹e
 (
VideoP¨amëîs
 *
p_Vid
, 
FømeSt‹e
* 
f
);

227 
St‹abÀPi˘uª
* 
Æloc_°‹abÀ_pi˘uª
 (
VideoP¨amëîs
 *
p_Vid
, 
Pi˘uªSåu˘uª
 
ty≥
, 
size_x
, 
size_y
, 
size_x_¸
, 
size_y_¸
);

228 
‰ì_°‹abÀ_pi˘uª
 (
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
* 
p
);

229 
°‹e_pi˘uª_ö_dpb
 (
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
St‹abÀPi˘uª
* 
p
, 
FømeF‹m©
 *
ouçut
);

230 
ª∂a˚_t›_pic_wôh_‰ame
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
St‹abÀPi˘uª
* 
p
, 
FømeF‹m©
 *
ouçut
);

231 
Êush_dpb
 (
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
FømeF‹m©
 *
ouçut
);

232 
dpb_•lô_fõld
 (
VideoP¨amëîs
 *
p_Vid
, 
FømeSt‹e
 *
fs
);

233 
dpb_comböe_fõld
 (
VideoP¨amëîs
 *
p_Vid
, 
FømeSt‹e
 *
fs
);

234 
dpb_comböe_fõld_yuv
 (
VideoP¨amëîs
 *
p_Vid
, 
FømeSt‹e
 *
fs
);

235 
öô_li°s_p_¶i˚
 (
Sli˚
 *
cuºSli˚
);

236 
öô_li°s_b_¶i˚
 (
Sli˚
 *
cuºSli˚
);

237 
öô_li°s_i_¶i˚
 (
Sli˚
 *
cuºSli˚
);

238 
upd©e_pic_num
 (
Sli˚
 *
cuºSli˚
);

239 
ª‹dî_ªf_pic_li°
 (
Sli˚
 *
cuºSli˚
, 
cur_li°
);

240 
öô_mbaff_li°s
 (
Sli˚
 *
cuºSli˚
);

241 
Æloc_ªf_pic_li°_ª‹dîög_buf„r
 (
Sli˚
 *
cuºSli˚
);

242 
‰ì_ªf_pic_li°_ª‹dîög_buf„r
 (
Sli˚
 *
cuºSli˚
);

243 
fûl_‰ame_num_g≠
 (
VideoP¨amëîs
 *
p_Vid
, 
FømeF‹m©
 *
ouçut
);

244 
compuã_cﬁoˇãd
 (
Sli˚
 *
cuºSli˚
, 
St‹abÀPi˘uª
 **
li°X
[6]);

245 
ª‹dî_sh‹t_ãrm
(
Sli˚
 *
cuºSli˚
, 
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
cur_li°
, 
picNumLX
, *
ªfIdxLX
);

247 
unm¨k_f‹_ª„ªn˚
(
FømeSt‹e
* 
fs
);

248 
unm¨k_f‹_l⁄g_ãrm_ª„ªn˚
(
FømeSt‹e
* 
fs
);

249 
ªmove_‰ame_‰om_dpb
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
pos
);

251 #i‡(
MVC_EXTENSION_ENABLE
)

252 
check_num_ªf
(
DecodedPi˘uªBuf„r
 *
p_Dpb
);

253 
ª∂a˚_t›_¥oc_pic_wôh_‰ame
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
St‹abÀPi˘uª
* 
p
);

254 
°‹e_¥oc_pi˘uª_ö_dpb
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
St‹abÀPi˘uª
* 
p
, 
FømeF‹m©
 *
ouçut
);

	@lencod/inc/mc_prediction.h

18 #i‚de‡
_MC_PREDICTION_H_


19 
	#_MC_PREDICTION_H_


	)

20 
	~"mbuf„r.h
"

22 
luma_¥edi˘i⁄
 ( 
Ma¸oblock
* 
cuºMB
, , , , , , [2], *, );

23 
luma_¥edi˘i⁄_bi
 ( 
Ma¸oblock
* 
cuºMB
, , , , , , , , , );

24 
chroma_¥edi˘i⁄
 ( 
Ma¸oblock
* 
cuºMB
, , , , , , , , , , , );

25 
chroma_¥edi˘i⁄_4x4
 ( 
Ma¸oblock
* 
cuºMB
, , , , , , , , , );

27 
rdo_low_öåa_chroma_decisi⁄
 (
Ma¸oblock
 *
cuºMB
, 
mb_avaûabÀ_up
, 
mb_avaûabÀ_À·
[2], 
mb_avaûabÀ_up_À·
);

28 
rdo_low_öåa_chroma_decisi⁄_mbaff
 (
Ma¸oblock
 *
cuºMB
, 
mb_avaûabÀ_up
, 
mb_avaûabÀ_À·
[2], 
mb_avaûabÀ_up_À·
);

29 
O√Comp⁄ítChromaPªdi˘i⁄4x4_ªgíî©e
 (
Ma¸oblock
 *
cuºMB
, 
img≥l
* , , , 
MŸi⁄Ve˘‹
 ** , 
St‹abÀPi˘uª
 *
li°X
, );

30 
O√Comp⁄ítChromaPªdi˘i⁄4x4_ªåõve
 (
Ma¸oblock
 *
cuºMB
, 
img≥l
* , , , 
MŸi⁄Ve˘‹
 ** , 
St‹abÀPi˘uª
 *
li°X
, );

32 
öåa_chroma_¥edi˘i⁄_mbaff
(
Ma¸oblock
 *
cuºMB
, *, *, *);

33 
öåa_chroma_¥edi˘i⁄
 (
Ma¸oblock
 *
cuºMB
, *, *, *);

34 
I¡øChromaPªdi˘i⁄4x4
 (
Ma¸oblock
* 
cuºMB
, 
uv
, 
block_x
, 
block_y
);

35 
gë_dif„ªn˚_4x4
(
img≥l
 **
§c
, img≥»**
¥d
, *
diff
, 
pos_x
, 
block_x
);

	@lencod/inc/mc_prediction_otf.h

1 #i‚de‡
_MC_PREDICTION_OTF_H_


2 
	#_MC_PREDICTION_OTF_H_


	)

4 
	~"globÆ.h
"

6 
luma_¥edi˘i⁄_Ÿf
 ( 
Ma¸oblock
* 
cuºMB
,

7 
block_x
,

8 
block_y
,

9 
block_size_x
,

10 
block_size_y
,

11 
p_dú
,

12 
li°_mode
[2],

13 *
ªf_idx
,

14 
bùªd_me


17 
luma_¥edi˘i⁄_bi_Ÿf
 ( 
Ma¸oblock
* 
cuºMB
,

18 
block_x
,

19 
block_y
,

20 
block_size_x
,

21 
block_size_y
,

22 
l0_mode
,

23 
l1_mode
,

24 
l0_ªf_idx
,

25 
l1_ªf_idx
,

26 
li°


29 
chroma_¥edi˘i⁄_Ÿf
 ( 
Ma¸oblock
* 
cuºMB
,

30 
uv
,

31 
block_x
,

32 
block_y
,

33 
block_size_x
,

34 
block_size_y
,

35 
p_dú
,

36 
l0_mode
,

37 
l1_mode
,

38 
l0_ªf_idx
,

39 
l1_ªf_idx
,

40 
bùªd_me


	@lencod/inc/md_common.h

18 #i‚de‡
_MD_COMMON_H_


19 
	#_MD_COMMON_H_


	)

20 
	~"mv_£¨ch.h
"

21 
	~"me_di°‹ti⁄.h
"

23 
SëMŸi⁄Ve˘‹sMBPSli˚
 (
Ma¸oblock
* 
cuºMB
);

24 
SëMŸi⁄Ve˘‹sMBBSli˚
 (
Ma¸oblock
* 
cuºMB
);

25 
SëMŸi⁄Ve˘‹sMBISli˚
 (
Ma¸oblock
* 
cuºMB
);

26 
c›y_image_d©a
 (
img≥l
 **
imgBuf1
, img≥»**
imgBuf2
, 
off1
, 
off2
, 
width
, 
height
);

27 
c›y_image_d©a_16x16
 (
img≥l
 **
imgBuf1
, img≥»**
imgBuf2
, 
off1
, 
off2
);

28 
c›y_image_d©a_8x8
 (
img≥l
 **
imgBuf1
, img≥»**
imgBuf2
, 
off1
, 
off2
);

29 
c›y_image_d©a_4x4
 (
img≥l
 **
imgBuf1
, img≥»**
imgBuf2
, 
off1
, 
off2
);

30 
Re£tRD8x8D©a
 (
VideoP¨amëîs
 *
p_Vid
, 
RD_8x8DATA
 *
rd_d©a
);

31 
£t_chroma_¥ed_mode
 (
Ma¸oblock
 *
cuºMB
, 
RD_PARAMS
 
íc_mb
, *
mb_avaûabÀ
, 
chroma_¥ed_mode_ønge
[2]);

	@lencod/inc/md_distortion.h

17 #i‚de‡
_MD_DISTORTION_H_


18 
	#_MD_DISTORTION_H_


	)

20 
	~"globÆ.h
"

23 
£tupDi°‹ti⁄
 (
Sli˚
 *
cuºSli˚
);

24 
öt64
 
compuã_SSE
 (
img≥l
 **
imgRef
, img≥»**
imgSrc
, 
xRef
, 
xSrc
, 
ySize
, 
xSize
);

25 
di°blk
 
compuã_SSE_¸
 (
img≥l
 **
imgRef
, img≥»**
imgSrc
, 
xRef
, 
xSrc
, 
ySize
, 
xSize
);

26 
di°blk
 
compuã_SSE16x16
(
img≥l
 **
imgRef
, img≥»**
imgSrc
, 
xRef
, 
xSrc
);

27 
di°blk
 
compuã_SSE8x8
 (
img≥l
 **
imgRef
, img≥»**
imgSrc
, 
xRef
, 
xSrc
);

28 
di°blk
 
compuã_SSE4x4
 (
img≥l
 **
imgRef
, img≥»**
imgSrc
, 
xRef
, 
xSrc
);

29 
di°blk
 
compuã_SSE16x16_thªs
(
img≥l
 **
imgRef
, img≥»**
imgSrc
, 
xRef
, 
xSrc
, di°blk 
mö_co°
);

	@lencod/inc/me_distortion.h

18 #i‚de‡
_ME_DISTORTION_H_


19 
	#_ME_DISTORTION_H_


	)

21 
di°blk
 
di°‹ti⁄4x4SAD
(* 
diff
, di°blk 
mö_mco°
);

22 
di°blk
 
di°‹ti⁄4x4SSE
(* 
diff
, di°blk 
mö_mco°
);

23 
di°blk
 
di°‹ti⁄4x4SATD
(* 
diff
, di°blk 
mö_co°
);

24 
di°blk
 
di°‹ti⁄8x8SAD
(* 
diff
, di°blk 
mö_mco°
);

25 
di°blk
 
di°‹ti⁄8x8SSE
(* 
diff
, di°blk 
mö_mco°
);

26 
di°blk
 
di°‹ti⁄8x8SATD
(* 
diff
, di°blk 
mö_co°
);

28 
Hadam¨dSAD4x4
(* 
diff
);

29 
Hadam¨dSAD8x8
(* 
diff
);

31 
di°blk
 
compuãSAD
 (
St‹abÀPi˘uª
 *
ªf1
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *);

32 
di°blk
 
compuãSAD16x16
 (
St‹abÀPi˘uª
 *
ªf1
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *);

33 
di°blk
 
compuãSAD16x8
 (
St‹abÀPi˘uª
 *
ªf1
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *);

34 
di°blk
 
compuãSAD8x16
 (
St‹abÀPi˘uª
 *
ªf1
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *);

35 
di°blk
 
compuãSAD8x8
 (
St‹abÀPi˘uª
 *
ªf1
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *);

36 
di°blk
 
compuãSAD8x4
 (
St‹abÀPi˘uª
 *
ªf1
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *);

37 
di°blk
 
compuãSAD4x8
 (
St‹abÀPi˘uª
 *
ªf1
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *);

38 
di°blk
 
compuãSAD4x4
 (
St‹abÀPi˘uª
 *
ªf1
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *);

41 
di°blk
 
compuãSADWP
 (
St‹abÀPi˘uª
 *
ªf1
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *);

42 
di°blk
 
compuãSADWP16x16
 (
St‹abÀPi˘uª
 *
ªf1
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *);

43 
di°blk
 
compuãSADWP16x8
 (
St‹abÀPi˘uª
 *
ªf1
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *);

44 
di°blk
 
compuãSADWP8x16
 (
St‹abÀPi˘uª
 *
ªf1
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *);

45 
di°blk
 
compuãSADWP8x8
 (
St‹abÀPi˘uª
 *
ªf1
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *);

46 
di°blk
 
compuãSADWP8x4
 (
St‹abÀPi˘uª
 *
ªf1
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *);

47 
di°blk
 
compuãSADWP4x8
 (
St‹abÀPi˘uª
 *
ªf1
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *);

48 
di°blk
 
compuãSADWP4x4
 (
St‹abÀPi˘uª
 *
ªf1
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *);

51 
di°blk
 
compuãSATD
 (
St‹abÀPi˘uª
 *
ªf1
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *);

52 
di°blk
 
compuãSATDWP
 (
St‹abÀPi˘uª
 *
ªf1
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *);

53 
di°blk
 
compuãSAT8x8D16x16
(
St‹abÀPi˘uª
 *
ªf1
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *);

54 
di°blk
 
compuãSAT4x4D16x16
(
St‹abÀPi˘uª
 *
ªf1
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *);

55 
di°blk
 
compuãSAT8x8D16x8
 (
St‹abÀPi˘uª
 *
ªf1
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *);

56 
di°blk
 
compuãSAT4x4D16x8
 (
St‹abÀPi˘uª
 *
ªf1
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *);

57 
di°blk
 
compuãSAT8x8D8x16
 (
St‹abÀPi˘uª
 *
ªf1
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *);

58 
di°blk
 
compuãSAT4x4D8x16
 (
St‹abÀPi˘uª
 *
ªf1
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *);

59 
di°blk
 
compuãSAT8x8D
 (
St‹abÀPi˘uª
 *
ªf1
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *);

60 
di°blk
 
compuãSAT4x4D
 (
St‹abÀPi˘uª
 *
ªf1
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *);

63 
di°blk
 
compuãSSE
 (
St‹abÀPi˘uª
 *
ªf1
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *);

64 
di°blk
 
compuãSSEWP
 (
St‹abÀPi˘uª
 *
ªf1
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *);

67 
di°blk
 
compuãBiPªdSAD1
 (
St‹abÀPi˘uª
 *
ªf1
, St‹abÀPi˘uª *
ªf2
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *, MotionVector *);

68 
di°blk
 
compuãBiPªd16x16SAD1
 (
St‹abÀPi˘uª
 *
ªf1
, St‹abÀPi˘uª *
ªf2
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *, MotionVector *);

69 
di°blk
 
compuãBiPªd16x8SAD1
 (
St‹abÀPi˘uª
 *
ªf1
, St‹abÀPi˘uª *
ªf2
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *, MotionVector *);

70 
di°blk
 
compuãBiPªd8x16SAD1
 (
St‹abÀPi˘uª
 *
ªf1
, St‹abÀPi˘uª *
ªf2
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *, MotionVector *);

71 
di°blk
 
compuãBiPªd8x8SAD1
 (
St‹abÀPi˘uª
 *
ªf1
, St‹abÀPi˘uª *
ªf2
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *, MotionVector *);

72 
di°blk
 
compuãBiPªd8x4SAD1
 (
St‹abÀPi˘uª
 *
ªf1
, St‹abÀPi˘uª *
ªf2
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *, MotionVector *);

73 
di°blk
 
compuãBiPªd4x8SAD1
 (
St‹abÀPi˘uª
 *
ªf1
, St‹abÀPi˘uª *
ªf2
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *, MotionVector *);

74 
di°blk
 
compuãBiPªd4x4SAD1
 (
St‹abÀPi˘uª
 *
ªf1
, St‹abÀPi˘uª *
ªf2
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *, MotionVector *);

75 
di°blk
 
compuãBiPªdSAD2
 (
St‹abÀPi˘uª
 *
ªf1
, St‹abÀPi˘uª *
ªf2
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *, MotionVector *);

78 
di°blk
 
compuãBiPªdSATD1
 (
St‹abÀPi˘uª
 *
ªf1
, St‹abÀPi˘uª *
ªf2
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *, MotionVector *);

79 
di°blk
 
compuãBiPªdSATD2
 (
St‹abÀPi˘uª
 *
ªf1
, St‹abÀPi˘uª *
ªf2
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *, MotionVector *);

80 
di°blk
 
compuãBiPªd16x16SATD1
(
St‹abÀPi˘uª
 *
ªf1
, St‹abÀPi˘uª *
ªf2
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *, MotionVector *);

81 
di°blk
 
compuãBiPªd16x8SATD1
 (
St‹abÀPi˘uª
 *
ªf1
, St‹abÀPi˘uª *
ªf2
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *, MotionVector *);

82 
di°blk
 
compuãBiPªd8x8SATD1
 (
St‹abÀPi˘uª
 *
ªf1
, St‹abÀPi˘uª *
ªf2
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *, MotionVector *);

83 
di°blk
 
compuãBiPªd8x16SATD1
 (
St‹abÀPi˘uª
 *
ªf1
, St‹abÀPi˘uª *
ªf2
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *, MotionVector *);

86 
di°blk
 
compuãBiPªdSSE1
 (
St‹abÀPi˘uª
 *
ªf1
, St‹abÀPi˘uª *
ªf2
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *, MotionVector *);

87 
di°blk
 
compuãBiPªdSSE2
 (
St‹abÀPi˘uª
 *
ªf1
, St‹abÀPi˘uª *
ªf2
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *, MotionVector *);

89 
£À˘_di°‹ti⁄
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
);

91 
ˇlcDif„ªn˚
(
img≥l
 **
‹igImg
, 
ox
, 
oy
, img≥»**
¥edImg
, 
px
, 
py
, 
width
, 
height
, *
diff
);

	@lencod/inc/me_distortion_otf.h

11 #i‚de‡
_ME_DISTORTION_OTF_H_


12 
	#_ME_DISTORTION_OTF_H_


	)

15 
di°blk
 
compuãSAD_Ÿf
 (
St‹abÀPi˘uª
 *
ªf1
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *);

18 
di°blk
 
compuãSADWP_Ÿf
 (
St‹abÀPi˘uª
 *
ªf1
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *);

21 
di°blk
 
compuãSATD_Ÿf
 (
St‹abÀPi˘uª
 *
ªf1
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *);

22 
di°blk
 
compuãSATDWP_Ÿf
 (
St‹abÀPi˘uª
 *
ªf1
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *);

25 
di°blk
 
compuãSSE_Ÿf
 (
St‹abÀPi˘uª
 *
ªf1
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *);

26 
di°blk
 
compuãSSEWP_Ÿf
 (
St‹abÀPi˘uª
 *
ªf1
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *);

29 
di°blk
 
compuãBiPªdSAD1_Ÿf
 (
St‹abÀPi˘uª
 *
ªf1
, St‹abÀPi˘uª *
ªf2
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *, MotionVector *);

30 
di°blk
 
compuãBiPªdSAD2_Ÿf
 (
St‹abÀPi˘uª
 *
ªf1
, St‹abÀPi˘uª *
ªf2
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *, MotionVector *);

33 
di°blk
 
compuãBiPªdSATD1_Ÿf
 (
St‹abÀPi˘uª
 *
ªf1
, St‹abÀPi˘uª *
ªf2
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *, MotionVector *);

34 
di°blk
 
compuãBiPªdSATD2_Ÿf
 (
St‹abÀPi˘uª
 *
ªf1
, St‹abÀPi˘uª *
ªf2
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *, MotionVector *);

37 
di°blk
 
compuãBiPªdSSE1_Ÿf
 (
St‹abÀPi˘uª
 *
ªf1
, St‹abÀPi˘uª *
ªf2
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *, MotionVector *);

38 
di°blk
 
compuãBiPªdSSE2_Ÿf
 (
St‹abÀPi˘uª
 *
ªf1
, St‹abÀPi˘uª *
ªf2
, 
MEBlock
*, di°blk, 
MŸi⁄Ve˘‹
 *, MotionVector *);

	@lencod/inc/me_epzs.h

19 #i‚de‡
_ME_EPZS_H_


20 
	#_ME_EPZS_H_


	)

21 
	~"me_ïzs_comm⁄.h
"

23 c⁄° 
	g√xt_°¨t_pos
[5][5] =

32 c⁄° 
	g√xt_íd_pos
[5][5] =

41 c⁄° 
MŸi⁄Ve˘‹
 
	g£¨ch_poöt_hp
[10] = {{0,0},{-2,0}, {0,2}, {2,0}, {0,-2}, {-2,2}, {2,2}, {2,-2}, {-2,-2}, {-2,2}};

42 c⁄° 
MŸi⁄Ve˘‹
 
	g£¨ch_poöt_qp
[10] = {{0,0},{-1,0}, {0,1}, {1,0}, {0,-1}, {-1,1}, {1,1}, {1,-1}, {-1,-1}, {-1,1}};

45 
di°blk
 
EPZS_mŸi⁄_e°im©i⁄
 (
Ma¸oblock
 *, 
MŸi⁄Ve˘‹
 *, 
MEBlock
 *, distblk, );

46 
di°blk
 
EPZS_subMB_mŸi⁄_e°im©i⁄
 (
Ma¸oblock
 *, 
MŸi⁄Ve˘‹
 *, 
MEBlock
 *, distblk, );

47 
di°blk
 
EPZS_sub_≥l_mŸi⁄_e°im©i⁄
 (
Ma¸oblock
 *, 
MŸi⁄Ve˘‹
 *, 
MEBlock
 *, distblk, *);

48 
di°blk
 
EPZS_sub_≥l_bùªd_mŸi⁄_e°im©i⁄
 (
Ma¸oblock
 *, 
MEBlock
 *, 
li°
, 
MŸi⁄Ve˘‹
 *, MotionVector *, MotionVector *, MotionVector *, distblk, *);

49 
di°blk
 
EPZS_bùªd_mŸi⁄_e°im©i⁄
 (
Ma¸oblock
 *, , 
MŸi⁄Ve˘‹
 *, MŸi⁄Ve˘‹ *, MŸi⁄Ve˘‹ *, MŸi⁄Ve˘‹ *, 
MEBlock
 *, , distblk, );

	@lencod/inc/me_epzs_common.h

19 #i‚de‡
_ME_EPZS_COMMON_H_


20 
	#_ME_EPZS_COMMON_H_


	)

26 
	mmb_ad≠tive_‰ame_fõld_Êag
;

27 
	msize_x
, 
	msize_y
;

30 
MŸi⁄Ve˘‹
 ***
	m‰ame
;

32 
MŸi⁄Ve˘‹
 ***
	mt›
;

34 
MŸi⁄Ve˘‹
 ***
	mbŸ
;

35 } 
	tEPZSCﬁocP¨ams
;

39 
MŸi⁄Ve˘‹
 
	mmŸi⁄
;

40 
	m°¨t_nmbr
;

41 
	m√xt_poöts
;

43 
	tSPoöt
;

45 
	sïzs_°ru˘


47 
	m£¨chPoöts
;

48 
SPoöt
 *
	mpoöt
;

49 
	m°›Sórch
;

50 
	m√xtLa°
;

51 
ïzs_°ru˘
 *
	m√xç©ã∫
;

54 
ïzs_°ru˘
 
	tEPZSSåu˘uª
;

58 
	mSDIAMOND
 = 0,

59 
	mSQUARE
 = 1,

60 
	mEDIAMOND
 = 2,

61 
	mLDIAMOND
 = 3,

62 
	mSBDIAMOND
 = 4

63 } 
	tEPZSP©ã∫s
;

65 
	sïzs_∑øms
 {

66 
VideoP¨amëîs
 *
	mp_Vid
;

67 
uöt16
 
	mBlkCou¡
;

68 
	m£¨ch¨øy
;

70 
di°blk
 
	mmedthªs
[8];

71 
di°blk
 
	mmaxthªs
[8];

72 
di°blk
 
	mmöthªs
[8];

73 
di°blk
 
	msubthªs
[8];

75 
	mmv_sˇÀ
 [6][
MAX_REFERENCE_PICTURES
][MAX_REFERENCE_PICTURES];

76 
	mmv_sˇÀ_upd©e
[6][
MAX_REFERENCE_PICTURES
][MAX_REFERENCE_PICTURES];

78 
uöt16
 **
	mEPZSM≠
;

80 #i‡
EPZSREF


81 
MŸi⁄Ve˘‹
 *****
	mp_mŸi⁄
;

83 
MŸi⁄Ve˘‹
 ****
	mp_mŸi⁄
;

85 
di°blk
 ***
	mdi°‹ti⁄
;

86 
di°blk
 ***
	mbi_di°‹ti⁄
;

87 
di°blk
 ***
	mdi°‹ti⁄_h≥l
;

90 
EPZSSåu˘uª
 *
	m£¨chP©ã∫
;

91 
EPZSSåu˘uª
 *
	m£¨chP©ã∫D
;

92 
EPZSSåu˘uª
 *
	m¥edi˘‹
;

94 
EPZSSåu˘uª
 *
	mwödow_¥edi˘‹
;

95 
EPZSSåu˘uª
 *
	mwödow_¥edi˘‹_ext
;

97 
EPZSCﬁocP¨ams
 *
	mp_cﬁoˇãd
;

98 } 
	tEPZSP¨amëîs
;

101 
EPZSBlockTy≥Pªdi˘‹sMB
 (
Sli˚
 *
cuºSli˚
, 
MEBlock
 *
mv_block
, 
SPoöt
 *
poöt
, *
¥ednum
);

102 
EPZS_•©ül_¥edi˘‹s
 (
EPZSP¨amëîs
 *
p_EPZS
, 
MEBlock
 *
mv_block
, 
li°
, 
li°_off£t
, 
ªf
, 
pic_mŸi⁄_∑øms
 **
mv_öfo
);

103 
EPZS_ãmp‹Æ_¥edi˘‹s
 (
Ma¸oblock
 *
cuºMB
, 
St‹abÀPi˘uª
 *
ªf_pi˘uª
, 
EPZSP¨amëîs
 *
p_EPZS
, 
MEBlock
 *
mv_block
, *
¥ednum
, 
di°blk
 
°›Crôîi⁄
, di°blk 
mö_mco°
);

104 
di°blk
 
EPZSDëîmöeSt›Crôîi⁄
(
EPZSP¨amëîs
 *
p_EPZS
, di°blk* 
¥evSad
, 
MEBlock
 *
mv_block
 ,di°blk 
œmbda_di°
);

105 
EPZSBlockTy≥Pªdi˘‹s
 (
Sli˚
 *
cuºSli˚
, 
MEBlock
 *
mv_block
, 
SPoöt
 *
poöt
, *
¥ednum
);

106 
EPZSWödowPªdi˘‹s
 (
MŸi⁄Ve˘‹
 *
mv
, 
EPZSSåu˘uª
 *
¥edi˘‹
, *
¥ednum
, EPZSSåu˘uª *
wödowPªd
);

107 
EPZS_•©ül_mem‹y_¥edi˘‹s
 (
EPZSP¨amëîs
 *
p_EPZS
, 
MEBlock
 *
mv_block
, 
li°
, *
¥ednum
, 
img_width
);

109 
EPZSDñëe
 (
VideoP¨amëîs
 *
p_Vid
);

110 
EPZSSåu˘Dñëe
 (
Sli˚
 *
cuºSli˚
);

111 
EPZSSli˚Inô
 (
Sli˚
 *
cuºSli˚
);

112 
EPZSInô
 (
VideoP¨amëîs
 *
p_Vid
);

113 
EPZSSåu˘Inô
 (
Sli˚
 *
cuºSli˚
);

114 
EPZSOuçutSèts
 (
I≈utP¨amëîs
 *
p_I≈
, 
FILE
 * 
°©
, 
°©s_fûe
);

115 
EPZS_£tup_ígöe
 (
Ma¸oblock
 *, 
I≈utP¨amëîs
 *);

125 
ölöe
 
	$add_¥edi˘‹
(
MŸi⁄Ve˘‹
 *
cur_mv
, MŸi⁄Ve˘‹ 
¥d_mv
, 
mvSˇÀ
, 
shi·_mv
)

127 *
cur_mv
 = 
¥d_mv
;

128 
cur_mv
->
mv_x
 = (Ë
	`rshi·_∫d_sf
((
mvSˇÀ
 * cur_mv->mv_x), 
shi·_mv
);

129 
cur_mv
->
mv_y
 = (Ë
	`rshi·_∫d_sf
((
mvSˇÀ
 * cur_mv->mv_y), 
shi·_mv
);

130  (*((*Ë
cur_mv
) != 0);

131 
	}
}

133 
ölöe
 
	$sˇÀ_mv
(
MŸi⁄Ve˘‹
 *
out_mv
, 
sˇÀ
, c⁄° MŸi⁄Ve˘‹ *
mv
, 
shi·_mv
)

135 
out_mv
->
mv_x
 = (Ë
	`rshi·_∫d_sf
((
sˇÀ
 * 
mv
->mv_x), 
shi·_mv
);

136 
out_mv
->
mv_y
 = (Ë
	`rshi·_∫d_sf
((
sˇÀ
 * 
mv
->mv_y), 
shi·_mv
);

137 
	}
}

139 
ölöe
 
	$sˇÀ_mv_xy
(
MŸi⁄Ve˘‹
 *
out_mv
, *
sˇÀ
, c⁄° MŸi⁄Ve˘‹ *
mv
, 
shi·_mv
)

141 
out_mv
->
mv_x
 = (Ë
	`rshi·_∫d_sf
((
sˇÀ
[0] * 
mv
->mv_x), 
shi·_mv
);

142 
out_mv
->
mv_y
 = (Ë
	`rshi·_∫d_sf
((
sˇÀ
[1] * 
mv
->mv_y), 
shi·_mv
);

143 
	}
}

145 
ölöe
 
	$compuã_sˇÀd
(
MŸi⁄Ve˘‹
 *
MŸi⁄Ve˘‹0
, MŸi⁄Ve˘‹ *
MŸi⁄Ve˘‹1
, 
ãmpmv_sˇÀ
[2], c⁄° MŸi⁄Ve˘‹ *
mv
, 
övmv_¥ecisi⁄
)

147 
MŸi⁄Ve˘‹0
->
mv_x
 = (Ë
	`iClù3
 (-32768, 32767, 
	`rshi·_∫d_sf
((
ãmpmv_sˇÀ
[
LIST_0
] * 
mv
->mv_x), 
övmv_¥ecisi⁄
));

148 
MŸi⁄Ve˘‹0
->
mv_y
 = (Ë
	`iClù3
 (-32768, 32767, 
	`rshi·_∫d_sf
((
ãmpmv_sˇÀ
[
LIST_0
] * 
mv
->mv_y), 
övmv_¥ecisi⁄
));

149 
MŸi⁄Ve˘‹1
->
mv_x
 = (Ë
	`iClù3
 (-32768, 32767, 
	`rshi·_∫d_sf
((
ãmpmv_sˇÀ
[
LIST_1
] * 
mv
->mv_x), 
övmv_¥ecisi⁄
));

150 
MŸi⁄Ve˘‹1
->
mv_y
 = (Ë
	`iClù3
 (-32768, 32767, 
	`rshi·_∫d_sf
((
ãmpmv_sˇÀ
[
LIST_1
] * 
mv
->mv_y), 
övmv_¥ecisi⁄
));

151 
	}
}

	@lencod/inc/me_epzs_int.h

19 #i‚de‡
_ME_EPZS_INT_H_


20 
	#_ME_EPZS_INT_H_


	)

22 
	~"me_ïzs.h
"

25 
di°blk
 
EPZS_öãgî_mŸi⁄_e°im©i⁄
 (
Ma¸oblock
 *, 
MŸi⁄Ve˘‹
 *, 
MEBlock
 *, distblk, );

26 
di°blk
 
EPZS_öãgî_subMB_mŸi⁄_e°im©i⁄
 (
Ma¸oblock
 *, 
MŸi⁄Ve˘‹
 *, 
MEBlock
 *, distblk, );

27 
di°blk
 
EPZS_öãgî_bùªd_mŸi⁄_e°im©i⁄
 (
Ma¸oblock
 *, , 
MŸi⁄Ve˘‹
 *, MŸi⁄Ve˘‹ *, MŸi⁄Ve˘‹ *, MŸi⁄Ve˘‹ *, 
MEBlock
 *, , distblk, );

	@lencod/inc/me_fullfast.h

19 #i‚de‡
_ME_FULLFAST_H_


20 
	#_ME_FULLFAST_H_


	)

21 
	sme_fuŒ_Á°


23 **
	m£¨ch_£tup_d⁄e
;

24 
MŸi⁄Ve˘‹
 **
	m£¨ch_˚¡î
;

25 
MŸi⁄Ve˘‹
 **
	m£¨ch_˚¡î_∑dded
;

26 **
	mpos_00
;

27 
di°≥l
 *****
	mBlockSAD
;

28 **
	mmax_£¨ch_ønge
;

29 } 
	tMEFuŒFa°
;

31 
di°blk
 
Á°_fuŒ_£¨ch_mŸi⁄_e°im©i⁄
 ( 
Ma¸oblock
 *, 
MŸi⁄Ve˘‹
 *, 
MEBlock
 *, distblk, );

32 
öôülize_Á°_fuŒ_£¨ch
 ( 
VideoP¨amëîs
 *, 
I≈utP¨amëîs
 * );

33 
ª£t_Á°_fuŒ_£¨ch
 ( 
VideoP¨amëîs
 * );

34 
˛ór_Á°_fuŒ_£¨ch
 ( 
VideoP¨amëîs
 * );

35 
£tup_Á°_fuŒ_£¨ch
 ( 
Ma¸oblock
 *, 
MEBlock
 *, );

36 
upd©e_fuŒ_£¨ch_œrge_blocks
 ( 
MEFuŒFa°
 *, , , );

	@lencod/inc/me_fullfast_otf.h

12 #i‚de‡
_ME_FULLFAST_OTF_H_


13 
	#_ME_FULLFAST_OTF_H_


	)

15 
SëupFa°FuŒPñSórch_Ÿf
 (
Ma¸oblock
 *, 
MEBlock
 *, ) ;

	@lencod/inc/me_fullsearch.h

19 #i‚de‡
_ME_FULLSEARCH_H_


20 
	#_ME_FULLSEARCH_H_


	)

21 
di°blk
 
fuŒ_£¨ch_mŸi⁄_e°im©i⁄
 (
Ma¸oblock
 *, 
MŸi⁄Ve˘‹
 *, 
MEBlock
 *, distblk, );

22 
di°blk
 
fuŒ_£¨ch_bùªd_mŸi⁄_e°im©i⁄
 (
Ma¸oblock
 *, , 
MŸi⁄Ve˘‹
 *, MŸi⁄Ve˘‹ *, MŸi⁄Ve˘‹ *, MŸi⁄Ve˘‹ *, 
MEBlock
 *, , distblk, );

23 
di°blk
 
sub_≥l_mŸi⁄_e°im©i⁄
 (
Ma¸oblock
 *, 
MŸi⁄Ve˘‹
 *, 
MEBlock
 *, distblk, *);

24 
di°blk
 
sub_≥l_bùªd_mŸi⁄_e°im©i⁄
 (
Ma¸oblock
 *, 
MEBlock
 *, , 
MŸi⁄Ve˘‹
 *, MotionVector *, MotionVector *, MotionVector *, distblk, *);

25 
di°blk
 
fuŒ_sub_≥l_mŸi⁄_e°im©i⁄
 (
Ma¸oblock
 *, 
MŸi⁄Ve˘‹
 *, 
MEBlock
 *, distblk, *);

26 
di°blk
 
fuŒ_sub_≥l_bùªd_mŸi⁄_e°im©i⁄
 (
Ma¸oblock
 *, 
MEBlock
 *, , 
MŸi⁄Ve˘‹
 *, MotionVector *, MotionVector *, MotionVector *, distblk, *);

	@lencod/inc/me_umhex.h

23 #i‚de‡
_ME_UMHEX_H_


24 
	#_ME_UMHEX_H_


	)

26 
	~"mbuf„r.h
"

28 
	sumhex_°ru˘
 {

29 
	mAÕhaFouπh_1
[8];

30 
	mAÕhaFouπh_2
[8];

32 
	m¥ed_MV_ªf_Êag
;

33 
	mBlockTy≥_LUT
[4][4];

34 
di°blk
 
	mMedün_Pªd_Thd_MB
[8];

35 
di°blk
 
	mBig_Hexag⁄_Thd_MB
[8];

36 
di°blk
 
	mMu…i_Ref_Thd_MB
[8];

37 
di°blk
 
	mThªshﬁd_DSR_MB
[8];

38 
byã
 **
	mMco°Sèã
;

39 
byã
 **
	mSórchSèã
;

40 
di°blk
 ****
	mÁ°me_ªf_co°
;

41 
di°blk
 ***
	mÁ°me_l0_co°
;

42 
di°blk
 ***
	mÁ°me_l1_co°
;

43 
di°blk
 **
	mÁ°me_be°_co°
;

44 
di°blk
 ***
	mÁ°me_l0_co°_bùªd
;

45 
di°blk
 ***
	mÁ°me_l1_co°_bùªd
;

46 
di°blk
 
	m¥ed_SAD
;

47 
di°blk
 
	mSAD_a
,
	mSAD_b
,
	mSAD_c
,
	mSAD_d
;

48 
	mbùªd_Êag
;

49 
	m¥ed_MV_ªf
[2], 
	m¥ed_MV_u∂ayî
[2];

51 
	mUMHEX_blockty≥
;

52 
	m¥edi˘_poöt
[5][2];

54 
	mBsize
[8];

56 
byã
 *
	mÊag_öåa
;

57 
	mÊag_öåa_SAD
;

60 
umhex_°ru˘
 
	tUMHexSåu˘
;

62 
	#EARLY_TERMINATION
 \

	)

63 i‡((
	gmö_mco°
 - 
	gp_UMHex
->
	g¥ed_SAD
)<p_UMHex->
¥ed_SAD
 * 
	gbëaFouπh_2
) \

64 
	gfouπh_2_°ï
; \

65 if((
	gmö_mco°
 - 
	gp_UMHex
->
	g¥ed_SAD
Ë<Ö_UMHex->
¥ed_SAD
 * 
	gbëaFouπh_1
) \

66 
	gfouπh_1_°ï
;

68 
	#SEARCH_ONE_PIXEL
 \

	)

69 if((
übs
(
ˇnd
.
mv_x
 - 
˚¡î
.mv_x)>>2Ë< 
	g£¨ch_ønge
 && (übs(ˇnd.
mv_y
 - center.mv_y)>>2)< search_range)\

71 if(!
	gp_UMHex
->
	gMco°Sèã
[((
ˇnd
.
mv_y
 - 
˚¡î
.mv_yË>> 2)+ 
£¨ch_ønge
][((ˇnd.
mv_x
-center.mv_x)>>2)+search_range]) \

73 
	gmco°
 = 
mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd
, &
¥ed
); \

74 if(
	gmco°
<
	gmö_mco°
) \

76 
	gmco°
 +
mv_block
->
compuãPªdFPñ
(
ªf_pi˘uª
, mv_block, \

77 
mö_mco°
 - 
mco°
, &
ˇnd
); \

78 
	gp_UMHex
->
	gMco°Sèã
[((
ˇnd
.
mv_y
 - 
˚¡î
.mv_yË>> 2Ë+ 
£¨ch_ønge
][((ˇnd.
mv_x
 - center.mv_x) >> 2) + search_range] = 1; \

79 i‡(
	gmco°
 < 
	gmö_mco°
) \

81 
	gbe°
 = 
ˇnd
; \

82 
	gmö_mco°
 = 
mco°
; \

88 
	#SEARCH_ONE_PIXEL_BIPRED
 \

	)

89 if((
übs
(
ˇnd
.
mv_x
 - 
˚¡î2
.mv_xË>> 2Ë< 
	g£¨ch_ønge
 && (übs(ˇnd.
mv_y
 - center2.mv_y) >> 2) < search_range) \

91 if(!
	gp_UMHex
->
	gMco°Sèã
[((
ˇnd
.
mv_y
 - 
˚¡î2
.mv_yË>> 2Ë+ 
£¨ch_ønge
][((ˇnd.
mv_x
-center2.mv_x) >> 2)+search_range]) \

93 
	gmco°
 = 
mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
˚¡î1
, &
¥ed1
); \

94 
	gmco°
 +
mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd
, &
¥ed2
); \

95 if(
	gmco°
<
	gmö_mco°
) \

97 
	gmco°
 +
mv_block
->
compuãBiPªdFPñ
(
ªf_pi˘uª1
, 
ªf_pi˘uª2
, \

98 
mv_block
, 
mö_mco°
 - 
mco°
, &
˚¡î1
, &
ˇnd
); \

99 
	gp_UMHex
->
	gMco°Sèã
[((
ˇnd
.
mv_y
 - 
˚¡î2
.mv_yË>> 2Ë+ 
£¨ch_ønge
][((ˇnd.
mv_x
 - center2.mv_x) >> 2) + search_range] = 1; \

100 i‡(
	gmco°
 < 
	gmö_mco°
) \

102 
	gbe°
 = 
ˇnd
; \

103 
	gmö_mco°
 = 
mco°
; \

110 
UMHEX_DeföeThªshﬁd
 (
VideoP¨amëîs
 *
p_Vid
);

111 
UMHEX_DeföeThªshﬁdMB
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
);

112 
UMHEX_gë_mem
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
);

113 
UMHEX_‰ì_mem
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
);

115 
UMHEX_decide_öåabk_SAD
(
Ma¸oblock
 *
cuºMB
);

116 
UMHEX_skù_öåabk_SAD
 (
Ma¸oblock
 *
cuºMB
, 
ªf_max
);

117 
UMHEX_£tup
 (
Ma¸oblock
 *
cuºMB
, 
ªf
, 
li°
, 
block_y
, 
block_x
, 
blockty≥
, 
MŸi⁄Ve˘‹
 *****
Æl_mv
);

119 
di°blk


120 
UMHEXI¡egîPñBlockMŸi⁄Sórch
 (
Ma¸oblock
 *
cuºMB
,

121 
MŸi⁄Ve˘‹
 *
¥ed
,

122 
MEBlock
 *
mv_block
,

123 
di°blk
 
mö_mco°
,

124 
œmbda_Á˘‹


126 
di°blk
 
UMHEXSubPñBlockME
 (

127 
Ma¸oblock
 *
cuºMB
,

128 
MŸi⁄Ve˘‹
 *
¥ed
,

129 
MEBlock
 *
mv_block
,

130 
di°blk
 
mö_mco°
,

131 * 
œmbda


133 
di°blk
 
UMHEXSubPñBlockMŸi⁄Sórch
 (

134 
Ma¸oblock
 *
cuºMB
,

135 
MŸi⁄Ve˘‹
 *
¥ed_mv
,

136 
MEBlock
 *
mv_block
,

137 
di°blk
 
mö_mco°
,

138 
œmbda_Á˘‹


140 
di°blk
 
UMHEXBùªdI¡egîPñBlockMŸi⁄Sórch
 (
Ma¸oblock
 *, ,

141 
MŸi⁄Ve˘‹
 *, MotionVector *, MotionVector *, MotionVector *,

142 
MEBlock
 *, , 
di°blk
, );

144 
UMHEXSëMŸi⁄Ve˘‹Pªdi˘‹
 (
Ma¸oblock
 *
cuºMB
, 
MŸi⁄Ve˘‹
 *
pmv
, 
pic_mŸi⁄_∑øms
 **
mv_öfo
,

145 
ªf_‰ame
, 
li°
, 
mb_x
, 
mb_y
, 
bl_x
, 
bl_y
, 
MEBlock
 *
mv_block
);

148 
di°blk


149 
ModifõdUMHEXI¡egîPñBlockMŸi⁄Sórch
 (
Ma¸oblock
 *
cuºMB
,

150 
MŸi⁄Ve˘‹
 *
¥ed
,

151 
MEBlock
 *
mv_block
,

152 
di°blk
 
mö_mco°
,

153 
œmbda_Á˘‹


	@lencod/inc/me_umhexsmp.h

26 #i‚de‡
_ME_UMHEXSMP_H_


27 
	#_ME_UMHEXSMP_H_


	)

29 
	~"mbuf„r.h
"

31 
	sumhex_smp_°ru˘
 {

32 
di°blk
 
	mSymmëriˇlCrossSórchThªshﬁd1
;

33 
di°blk
 
	mSymmëriˇlCrossSórchThªshﬁd2
;

34 
di°blk
 
	mC⁄vîgeThªshﬁd
;

35 
di°blk
 
	mSubPñThªshﬁd1
;

36 
di°blk
 
	mSubPñThªshﬁd3
;

37 
byã
 **
	mSórchSèã
;

38 
di°blk
 ***
	ml0_co°
;

39 
di°blk
 ***
	ml1_co°
;

40 
di°blk
 
	m¥ed_SAD_u∂ayî
;

41 
byã
 *
	mÊag_öåa
;

42 
	mÊag_öåa_SAD
;

44 
	m¥ed_MV_u∂ayî_X
;

45 
	m¥ed_MV_u∂ayî_Y
;

48 
umhex_smp_°ru˘
 
	tUMHexSMPSåu˘
;

50 
smpUMHEX_öô
 (
VideoP¨amëîs
 *
p_Vid
);

51 
smpUMHEX_gë_mem
 (
VideoP¨amëîs
 *
p_Vid
);

52 
smpUMHEX_‰ì_mem
 (
VideoP¨amëîs
 *
p_Vid
);

53 
smpUMHEX_decide_öåabk_SAD
(
Ma¸oblock
 *
cuºMB
);

54 
smpUMHEX_skù_öåabk_SAD
 (
Ma¸oblock
 *
cuºMB
);

55 
smpUMHEX_£tup
 (
Ma¸oblock
 *
cuºMB
, , , , , , 
MŸi⁄Ve˘‹
 *****);

56 
di°blk
 
smpUMHEXBùªdI¡egîPñBlockMŸi⁄Sórch
 (
Ma¸oblock
 *, , 
MŸi⁄Ve˘‹
 *, MŸi⁄Ve˘‹ *, MŸi⁄Ve˘‹ *, MŸi⁄Ve˘‹ *, 
MEBlock
 *, , distblk, );

57 
di°blk
 
smpUMHEXI¡egîPñBlockMŸi⁄Sórch
 (
Ma¸oblock
 *
cuºMB
, 
MŸi⁄Ve˘‹
 *
¥ed_mv
, 
MEBlock
 *
mv_block
, di°blk 
mö_mco°
, 
œmbda_Á˘‹
);

58 
di°blk
 
smpUMHEXSubPñBlockMŸi⁄Sórch
 (
Ma¸oblock
 *
cuºMB
, 
MŸi⁄Ve˘‹
 *
¥ed_mv
, 
MEBlock
 *
mv_block
, di°blk 
mö_mco°
, 
œmbda_Á˘‹
);

59 
di°blk
 
smpUMHEXFuŒSubPñBlockMŸi⁄Sórch
 (
Ma¸oblock
 *
cuºMB
, 
MŸi⁄Ve˘‹
 *
¥ed_mv
, 
MEBlock
 *
mv_block
, di°blk 
mö_mco°
, 
œmbda_Á˘‹
);

60 
di°blk
 
smpUMHEXSubPñBlockME
 (
Ma¸oblock
 *
cuºMB
, 
MŸi⁄Ve˘‹
 *
¥ed_mv
, 
MEBlock
 *
mv_block
, di°blk 
mö_mco°
, *
œmbda
);

	@lencod/inc/mmco.h

15 #i‚de‡
_MMCO_H_


16 
	#_MMCO_H_


	)

18 
mmco_l⁄g_ãrm
(
VideoP¨amëîs
 *
p_Vid
, 
cuºít_pic_num
);

19 
poc_ba£d_ªf_m™agemít_‰ame_pic
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
cuºít_pic_num
);

20 #i‡
CRA


21 
¸a_ªf_m™agemít_‰ame_pic
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
cuºít_pic_num
);

23 #i‡
HM50_LIKE_MMCO


24 
hm50_ªf_m™agemít_‰ame_pic
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
cuºít_pic_num
);

26 #i‡
LD_REF_SETTING


27 
low_dñay_ªf_m™agemít_‰ame_pic
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
cuºít_pic_num
);

29 
poc_ba£d_ªf_m™agemít_fõld_pic
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
cuºít_pic_num
);

30 
éyr_ba£d_ªf_m™agemít_‰ame_pic
(
VideoP¨amëîs
 *
p_Vid
, 
cuºít_pic_num
);

	@lencod/inc/mode_decision.h

18 #i‚de‡
_MODE_DECISION_H_


19 
	#_MODE_DECISION_H_


	)

22 c⁄° 
	gb8_mode_èbÀ
[6] = {0, 4, 5, 6, 7};

23 c⁄° 
	gmb_mode_èbÀ
[10] = {0, 1, 2, 3, 
P8x8
, 
I16MB
, 
I4MB
, 
I8MB
, 
IPCM
, 
SI4MB
};

24 
di°blk
 
BIDP¨tôi⁄Co°
 (
Ma¸oblock
 *
cuºMB
, , , [2], );

25 
di°blk
 
BPªdP¨tôi⁄Co°
 (
Ma¸oblock
 *
cuºMB
, , , , , , );

26 
St‹eMV8x8
 (
Sli˚
 *
cuºSli˚
, 
dú
);

27 
Re°‹eMV8x8
 (
Sli˚
 *
cuºSli˚
, 
dú
);

28 
°‹e_ma¸oblock_∑ømëîs
 (
Ma¸oblock
 *
cuºMB
, );

29 
St‹eNewMŸi⁄Ve˘‹sBlock8x8
 (
Sli˚
 *
cuºSli˚
, , , 
Info8x8
 *);

30 
assign_íc_pi˘uª_∑øms
 (
Ma¸oblock
 *
cuºMB
, 
mode
, 
Info8x8
 *
be°
, 
block
);

31 
£t_subblock8x8_öfo
 (
Block8x8Info
*, , , 
RD_8x8DATA
*);

32 
£t_block8x8_öfo
 (
Block8x8Info
*, , , 
Info8x8
 *
be°
);

33 
upd©e_ª‰esh_m≠
 (
Ma¸oblock
 *
cuºMB
, 
öåa
, 
öåa1
);

34 
gë_bùªd_co°
 (
Ma¸oblock
 *
cuºMB
, 
mode
, 
block
, 
i
, 
j
, 
Info8x8
 *
be°
, 
RD_PARAMS
 *
íc_mb
, 
di°blk
 
bmco°
[5]);

35 
I16Off£t
 (, );

36 
CheckRñübûôyOfRef
 (
Ma¸oblock
 *
cuºMB
, 
block
, 
li°_idx
, 
ªf
, 
mode
);

37 
RDCo°_f‹_ma¸oblocks
 (
Ma¸oblock
 *
cuºMB
, , );

38 
mode_decisi⁄_f‹_I4x4_MB
 (
Ma¸oblock
 *
cuºMB
, , 
di°blk
*);

39 
di°blk
 
rdco°_f‹_8x8blocks
 (
Ma¸oblock
 *
cuºMB
, 
RD_8x8DATA
 *
d©aTr
, *, 
öt64
*, , , , 
Info8x8
 *, distblk);

41 
rc_°‹e_diff
 (
diff
[16][16], 
img≥l
 **
p_curImg
, 
˝ix_x
,img≥»**
¥edi˘i⁄
);

43 
öô_íc_mb_∑øms
 (
Ma¸oblock
* 
cuºMB
, 
RD_PARAMS
 *
íc_mb
, 
öåa
);

44 
li°_¥edi˘i⁄_co°
 (
Ma¸oblock
 *
cuºMB
, 
li°
, 
block
, 
mode
, 
RD_PARAMS
 *
íc_mb
, 
di°blk
 
bmco°
[5], 
be°_ªf
[2]);

45 
dëîmöe_¥edi˘i⁄_li°
 (
di°blk
 [5], 
Info8x8
 *, distblk *);

46 
compuã_mode_RD_co°
 (
Ma¸oblock
 *
cuºMB
, 
RD_PARAMS
 *
íc_mb
, 
mode
, *
öãr_skù
);

48 
å™sf‹m_ãrmö©i⁄_c⁄åﬁ
 (
Ma¸oblock
* 
cuºMB
, 
mode
);

49 
b¶i˚_16x16_ãrmö©i⁄_c⁄åﬁ
(
I≈utP¨amëîs
 *
p_I≈
, 
Block8x8Info
 *
b8x8öfo
, *
˘r16x16
, 
mode
, 
b¶i˚
);

51 
di°blk
 
di°blkmö¨øy
 ( di°blk 
¨r
[], 
size
, *
mööd
 );

52 
imö¨øy
 ( 
¨r
[], 
size
, *
mööd
 );

54 
upd©e_œmbda_co°s
(
Ma¸oblock
 *
cuºMB
, 
RD_PARAMS
 *
íc_mb
, 
œmbda_mf
[3]);

56 
gë_öôül_mb16x16_co°
(
Ma¸oblock
 *
cuºMB
);

57 
adju°_mb16x16_co°
 (
Ma¸oblock
 *
cuºMB
, 
di°blk
 
co°
);

58 
ª£t_ad≠tive_roundög
(
VideoP¨amëîs
 *
p_Vid
);

60 
di°blk
 
di°‹ti⁄SSE
 ( 
Ma¸oblock
 *
cuºMB
 );

	@lencod/inc/mode_decision_p8x8.h

18 #i‚de‡
_MODE_DECISION_P8x8_H_


19 
	#_MODE_DECISION_P8x8_H_


	)

25 
subma¸oblock_mode_decisi⁄_p_¶i˚
 (
Ma¸oblock
 *
cuºMB
, 
RD_PARAMS
 *, 
RD_8x8DATA
 *, ****, , 
di°blk
 *);

26 
subma¸oblock_mode_decisi⁄_b_¶i˚
 (
Ma¸oblock
 *
cuºMB
, 
RD_PARAMS
 *, 
RD_8x8DATA
 *, ****, , 
di°blk
 *);

27 
subma¸oblock_mode_decisi⁄_low
(
Ma¸oblock
 *
cuºMB
, 
RD_PARAMS
 *, 
RD_8x8DATA
 *, ****, *, , 
di°blk
 *, distblk *, distblk *, );

28 
c›y_∑π_öfo
(
Info8x8
 *
b8x8
, Info8x8 *
∑π
);

	@lencod/inc/mv_search.h

16 #i‚de‡
_MV_SEARCH_H_


17 
	#_MV_SEARCH_H_


	)

20 
	#di°_sˇÀ_f
(
x
Ë(
mö_mco°
)

	)

22 
	#di°_sˇÀ_f
(
x
Ë
	`di°_sˇÀ
(x)

	)

26 
gë_√ighb‹s
(
Ma¸oblock
 *
cuºMB
, 
PixñPos
 *
block
, 
mb_x
, 
mb_y
, 
blocksh≠e_x
);

27 
£t_ac˚ss_mëhod
(*
ac˚ss_mëhod
, 
MŸi⁄Ve˘‹
 *
blk
, 
mö_x
, 
mö_y
, 
max_x
, 
max_y
);

29 
Pª∑ªMEP¨ams
 (
Sli˚
 *
cuºSli˚
, 
MEBlock
 *
mv_block
, 
ChromaMEE«bÀ
, 
li°
, 
ªf
);

30 
Pª∑ªBiPªdMEP¨ams
(
Sli˚
 *
cuºSli˚
, 
MEBlock
 *
mv_block
, 
ChromaMEE«bÀ
, 
li°
, 
li°_off£t
, 
ªf
);

32 
öô_mŸi⁄_£¨ch_moduÀ
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
);

33 
˛ór_mŸi⁄_£¨ch_moduÀ
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
);

35 
P¨tôi⁄MŸi⁄Sórch
 (
Ma¸oblock
 *
cuºMB
, , , *);

36 
SubP¨tôi⁄MŸi⁄Sórch
 (
Ma¸oblock
 *
cuºMB
, , , *);

38 
Gë_Dúe˘_MV_S∑tül_MBAFF
 (
Ma¸oblock
 *
cuºMB
);

39 
Gë_Dúe˘_MV_S∑tül_N‹mÆ
 (
Ma¸oblock
 *
cuºMB
);

40 
Gë_Dúe˘_MV_Temp‹Æ
 (
Ma¸oblock
 *
cuºMB
);

42 
FödSkùModeMŸi⁄Ve˘‹
 (
Ma¸oblock
 *
cuºMB
);

44 
öô_ME_ígöe
 (
Ma¸oblock
 *
cuºMB
);

45 
di°blk
 
BlockMŸi⁄Sórch
 (
Ma¸oblock
 *
cuºMB
, 
MEBlock
 *
mv_block
, ,, *);

46 
öô_mv_block
 (
Ma¸oblock
 *
cuºMB
, 
MEBlock
 *
mv_block
, 
blockty≥
, 
li°
, 
ªf_idx
, 
mb_x
, 
mb_y
);

47 
gë_‹igöÆ_block
(
VideoP¨amëîs
 *
p_Vid
, 
MEBlock
 *
mv_block
);

48 
‰ì_mv_block
 (
MEBlock
 *
mv_block
);

49 
upd©e_mv_block
 (
Ma¸oblock
 *
cuºMB
, 
MEBlock
 *
mv_block
, 
h
, 
v
);

50 
gë_£¨ch_ønge
(
MEBlock
 *
mv_block
, 
I≈utP¨amëîs
 *
p_I≈
, 
ªf
, 
blockty≥
);

52 
ölöe
 
	$add_mvs
(
MŸi⁄Ve˘‹
 *
mv0
, c⁄° MŸi⁄Ve˘‹ *
mv1
)

54 
mv0
->
mv_x
 = (Ë(mv0->mv_x + 
mv1
->mv_x);

55 
mv0
->
mv_y
 = (Ë(mv0->mv_y + 
mv1
->mv_y);

56 
	}
}

58 
ölöe
 
MŸi⁄Ve˘‹
 
	$add_MVs
(
MŸi⁄Ve˘‹
 
mv0
, c⁄° MŸi⁄Ve˘‹ *
mv1
)

60 
mv0
.
mv_x
 = (Ë(mv0.mv_x + 
mv1
->mv_x);

61 
mv0
.
mv_y
 = (Ë(mv0.mv_y + 
mv1
->mv_y);

63  (
mv0
);

64 
	}
}

66 
ölöe
 
MŸi⁄Ve˘‹
 
	$∑d_MVs
(
MŸi⁄Ve˘‹
 
mv0
, 
MEBlock
 *
mv_block
)

68 
mv0
.
mv_x
 = (Ë(mv0.mv_x + 
mv_block
->
pos_x_∑dded
);

69 
mv0
.
mv_y
 = (Ë(mv0.mv_y + 
mv_block
->
pos_y_∑dded
);

71  (
mv0
);

72 
	}
}

74 
ölöe
 
öt64
 
	$ovîÊow_weight_co°
(
œmbda
, 
bôs
)

76 #i‡
JCOST_CALC_SCALEUP


77  ( ((
öt64
)
œmbda
Ë* ((öt64)(
bôs
)) );

79 #i‡(
USE_RND_COST
)

80  (
	`i64_rshi·_∫d_sf
(((
öt64
)
œmbda
Ë* ((öt64)(
bôs
)Ë, 
LAMBDA_ACCURACY_BITS
));

82  (((
öt64
)
œmbda
Ë* ((öt64)(
bôs
)Ë>> 
LAMBDA_ACCURACY_BITS
);

85 
	}
}

87 
ölöe
 
di°blk
 
	$weight_co°
(
œmbda
, 
bôs
)

89 #i‡
JCOST_CALC_SCALEUP


90  ( ((
di°blk
)
œmbda
Ë* ((di°blk)(
bôs
)) );

92 #i‡(
USE_RND_COST
)

93  (
	`rshi·_∫d_sf
((
œmbda
Ë* (
bôs
), 
LAMBDA_ACCURACY_BITS
));

95  (((
œmbda
Ë* (
bôs
)Ë>> 
LAMBDA_ACCURACY_BITS
);

98 
	}
}

100 
ölöe
 
di°blk
 
	$mv_co°
(c⁄° 
VideoP¨amëîs
 *
p_Vid
, 
œmbda
, c⁄° 
MŸi⁄Ve˘‹
 *
mv
, c⁄° MŸi⁄Ve˘‹ *
pmv
)

102 #i‡
JCOST_CALC_SCALEUP


103 *
mvbôs
 = 
p_Vid
->mvbits;

104  ( ((
di°blk
)
œmbda
Ë*((di°blk)(
mvbôs
[
mv
->
mv_x
 - 
pmv
->mv_x] + mvbôs[mv->
mv_y
 -Ömv->mv_y])) );

106 #i‡(
USE_RND_COST
)

107  (
	`rshi·_∫d_sf
((
œmbda
 *(
p_Vid
->
mvbôs
[
mv
->
mv_x
 - 
pmv
->mv_x] +Ö_Vid->mvbôs[mv->
mv_y
 -Ömv->mv_y])), 
LAMBDA_ACCURACY_BITS
));

109  ((
œmbda
 *(
p_Vid
->
mvbôs
[
mv
->
mv_x
 - 
pmv
->mv_x] +Ö_Vid->mvbôs[mv->
mv_y
 -Ömv->mv_y]))>> 
LAMBDA_ACCURACY_BITS
);

112 
	}
}

114 
ölöe
 
di°blk
 
	$ªf_co°
(c⁄° 
Sli˚
 *
cuºSli˚
, 
œmbda
, 
ªf
, 
li°_off£t
)

116 i‡(
cuºSli˚
->
li°Xsize
[
li°_off£t
] <= 1)

120 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

121 #i‡
JCOST_CALC_SCALEUP


122  ( ((
di°blk
)
œmbda
Ë*((di°blk)(
p_Vid
->
ªfbôs
[(
ªf
)])) );

124 #i‡(
USE_RND_COST
)

125  (
	`rshi·_∫d_sf
((
œmbda
Ë* (
p_Vid
->
ªfbôs
[(
ªf
)]), 
LAMBDA_ACCURACY_BITS
));

127  ((
œmbda
 *(
p_Vid
->
ªfbôs
[(
ªf
)]))>> 
LAMBDA_ACCURACY_BITS
);

131 
	}
}

133 
ölöe
 
	$GëMaxMVD
(
MŸi⁄Ve˘‹
 *
pMV
, MŸi⁄Ve˘‹ *
pRefMV
)

135 
i32MVx
 = 
	`übs
(
pMV
->
mv_x
 - 
pRefMV
->mv_x);

136 
i32MVy
 = 
	`übs
(
pMV
->
mv_y
 - 
pRefMV
->mv_y);

137  
	`imax
(
i32MVx
, 
i32MVy
);

138 
	}
}

	@lencod/inc/nal.h

18 #i‚de‡
_NAL_H_


19 
	#_NAL_H_


	)

21 
	~"«lucomm⁄.h
"

22 
	~"íc_°©i°ics.h
"

24 
addCabacZîoW‹ds
(
VideoP¨amëîs
 *
p_Vid
, 
NALU_t
 *
«lu
, 
SètP¨amëîs
 *
cur_°©s
);

25 
SODBtoRBSP
 (
Bô°ªam
 *
cuºSåóm
);

26 
RBSPtoEBSP
(
byã
 *
NÆuBuf„r
, *
rb•
, 
rb•_size
);

	@lencod/inc/nalu.h

17 #i‚de‡
_NALU_H_


18 
	#_NALU_H_


	)

20 
	~"«lucomm⁄.h
"

22 
RBSPtoNALU
 (*
rb•
, 
NALU_t
 *
«lu
, 
rb•_size
, 
«l_unô_ty≥
, 
«l_ª„ªn˚_idc
, 
U£A¬exbL⁄gSèπcode
);

23 
Wrôe_AUD_NALU
–
VideoP¨amëîs
 *
p_Vid
 );

24 
Wrôe_FûÀr_D©a_NALU
–
VideoP¨amëîs
 *
p_Vid
, 
num_byãs
 );

	@lencod/inc/output.h

14 #i‚de‡
_OUTPUT_H_


15 
	#_OUTPUT_H_


	)

17 
Êush_dúe˘_ouçut
(
VideoP¨amëîs
 *
p_Vid
, 
FømeF‹m©
 *
ouçut
, 
p_out
);

18 
wrôe_out_pi˘uª
 ( 
St‹abÀPi˘uª
 *
p
, 
FømeF‹m©
 *
ouçut
, 
p_out
);

19 
wrôe_°‹ed_‰ame
 (
VideoP¨amëîs
 *
p_Vid
, 
FømeSt‹e
 *
fs
, 
FømeF‹m©
 *
ouçut
, 
p_out
);

20 
dúe˘_ouçut
 (
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
p
, 
FømeF‹m©
 *
ouçut
, 
p_out
);

21 
dúe˘_ouçut_∑ff
 (
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
p
, 
FømeF‹m©
 *
ouçut
, 
p_out
);

22 
öô_out_buf„r
 (
VideoP¨amëîs
 *
p_Vid
);

23 
unöô_out_buf„r
 (
VideoP¨amëîs
 *
p_Vid
);

	@lencod/inc/params.h

13 #i‚de‡
_PARAMS_H_


14 
	#_PARAMS_H_


	)

16 
	~"deföes.h
"

17 
	~"ty≥s.h
"

18 
	~"vui_∑øms.h
"

19 
	~"‰ame.h
"

20 
	~"io_video.h
"

23 
	söp_∑r_íc


25 
	mProfûeIDC
;

26 
	mLevñIDC
;

27 
	mI¡øProfûe
;

29 
	mno_‰ames
;

30 
	mqp
[
NUM_SLICE_TYPES
];

31 
	mqp2‰ame
;

32 
	mqp2off
[
NUM_SLICE_TYPES
];

33 
	mqp•
;

34 
	m‰ame_skù
;

35 
	mjumpd
;

37 
	mDißbÀSub≥lME
[2];

38 
	m£¨ch_ønge
[2];

40 
	mnum_ªf_‰ames
;

41 
	mP_Li°0_ªfs
[2];

42 
	mB_Li°0_ªfs
[2];

43 
	mB_Li°1_ªfs
[2];

44 
	mnum_ªf_‰ames_‹g
;

45 
	mP_Li°0_ªfs_‹g
[2];

46 
	mB_Li°0_ªfs_‹g
[2];

47 
	mB_Li°1_ªfs_‹g
[2];

48 
	mLog2MaxFNumMöus4
;

49 
	mLog2MaxPOCLsbMöus4
;

52 
FømeF‹m©
 
	msour˚
;

53 
FømeF‹m©
 
	mouçut
;

54 
	mis_öãæóved
;

55 
	m§c_ªsize
;

56 
	m§c_BôDïthResˇÀ
;

57 
	myuv_f‹m©
;

58 
	möåa_upd
;

63 
	m¶i˚_mode
;

64 
	m¶i˚_¨gumít
;

65 
	mU£C⁄°øöedI¡øPªd
;

66 
	mSëFú°AsL⁄gTîm
;

67 
	möfûe_hódî
;

68 
	mMu…iSour˚D©a
;

69 
VideoD©aFûe
 
	möput_fûe2
;

70 
VideoD©aFûe
 
	möput_fûe3
;

71 
	mnum_of_võws
;

72 #i‡(
MVC_EXTENSION_ENABLE
)

73 
	mVõw1C⁄figName
[
FILE_NAME_SIZE
];

74 
	mEnhLayîDFDißbÀIdc
[2][
NUM_SLICE_TYPES
];

75 
	mEnhLayîDFAÕha
 [2][
NUM_SLICE_TYPES
];

76 
	mEnhLayîDFBëa
 [2][
NUM_SLICE_TYPES
];

77 
	mMVCI¡îVõwRe‹dî
;

78 
	mMVCFlùVõws
;

79 
	mMVCI¡îVõwF‹˚B
;

80 
	mVõw1QPOff£t
;

81 
	míabÀ_öãr_võw_Êag
;

82 
	míh_œyî_œmbda_mu…ùlõr
;

83 
	míh_œyî_me_œmbda_mu…ùlõr
;

86 
VideoD©aFûe
 
	möput_fûe1
;

87 
	moutfûe
 [
FILE_NAME_SIZE
];

88 
	mRec⁄Fûe
 [
FILE_NAME_SIZE
];

89 
	mRec⁄Fûe2
 [
FILE_NAME_SIZE
];

90 
	mTø˚Fûe
 [
FILE_NAME_SIZE
];

91 
	mSètsFûe
 [
FILE_NAME_SIZE
];

92 
	mQm©rixFûe
 [
FILE_NAME_SIZE
];

93 
	mPro˚ssI≈ut
;

94 
	mE«bÀO≥nGOP
;

95 
	mE«bÀIDRGOP
;

96 
	mgøysˇÀ
;

98 
	midr_≥riod
;

99 
	möåa_≥riod
;

100 
	möåa_dñay
;

101 
	mad≠tive_idr_≥riod
;

102 
	mad≠tive_öåa_≥riod
;

104 
	m°¨t_‰ame
;

106 
	míabÀ_32_puŒdown
;

108 
	mGíî©eMu…ùÀPPS
;

109 
	mGíî©eSEIMesßge
;

110 
	mSEIMesßgeText
[
INPUT_TEXT_SIZE
];

112 
	mRe£ndSPS
;

113 
	mRe£ndPPS
;

115 
	mSídAUD
;

116 
	mskù_gl_°©s
;

119 
	mNumbîBFømes
;

120 
	mPRïœ˚BSli˚
;

121 
	mqpBRSOff£t
;

122 
	mdúe˘_•©ül_mv_¥ed_Êag
;

123 
	mdúe˘In„ªn˚Fœg
;

125 
	mBiPªdMŸi⁄E°im©i⁄
;

126 
	mBiPªdSórch
[4];

127 
	mBiPªdMEReföemíts
;

128 
	mBiPªdMESórchR™ge
[2];

129 
	mBiPªdMESubPñ
;

132 
	m•_≥riodicôy
;

133 
	m•_swôch_≥riod
;

134 
	msi_‰ame_ödiˇt‹
;

135 
	m•2_‰ame_ödiˇt‹
;

136 
	m•_ouçut_ödiˇt‹
;

137 
	m•_ouçut_fûíame
[
FILE_NAME_SIZE
];

138 
	m•2_öput_fûíame1
[
FILE_NAME_SIZE
];

139 
	m•2_öput_fûíame2
[
FILE_NAME_SIZE
];

142 
	mWeighãdPªdi˘i⁄
;

143 
	mWeighãdBùªdi˘i⁄
;

144 
	mWPMëhod
;

145 
	mWPIãrMC
;

146 
	mWPMCPªcisi⁄
;

147 
	mWPMCPªcFuŒRef
;

148 
	mWPMCPªcBSli˚
;

149 
	mEnh™˚dBWeightSuµ‹t
;

150 
	mChromaWeightSuµ‹t
;

151 
	mU£WeighãdRe„ªn˚ME
;

152 
	mRDPi˘uªDecisi⁄
;

153 
	mRDPSli˚BTe°
;

154 
	mRDPSli˚ITe°
;

155 
	mRDPi˘uªMaxPassISli˚
;

156 
	mRDPi˘uªMaxPassPSli˚
;

157 
	mRDPi˘uªMaxPassBSli˚
;

158 
	mRDPi˘uªDeblockög
;

159 
	mRDPi˘uªDúe˘Mode
;

160 
	mRDPi˘uªFømeQPPSli˚
;

161 
	mRDPi˘uªFømeQPBSli˚
;

163 
	mSkùI¡øInI¡îSli˚s
;

164 
	mBRefPi˘uªs
;

165 
	mHõørchiˇlCodög
;

166 
	mHõørchyLevñQPE«bÀ
;

167 
	mEx∂icôHõørchyF‹m©
[
INPUT_TEXT_SIZE
];

169 
	mEx∂icôSeqCodög
;

170 
	mEx∂icôSeqFûe
[
FILE_NAME_SIZE
];

171 
	mLowDñay
;

173 
	mRe„ªn˚Re‹dî
;

174 
	mPocMem‹yM™agemít
;

176 
	msymbﬁ_mode
;

177 
	mof_mode
;

178 
	m∑πôi⁄_mode
;

181 
	mSïVõwI¡îSórch
;

182 
	mVõw1NoResidueRDO
;

184 
	mI¡îSórch
[2][2][8];

186 
	mDißbÀI¡ø4x4
;

187 
	mDißbÀI¡ø16x16
;

188 
	mFa°MDE«bÀ
;

189 
	mFa°I¡øMD
;

190 
	mFa°I¡ø4x4
;

191 
	mFa°I¡ø16x16
;

192 
	mFa°I¡ø8x8
;

193 
	mFa°I¡øChroma
;

195 
	mDißbÀI¡øInI¡î
[2];

196 
	mI¡øDißbÀI¡îO∆y
;

197 
	mI¡ø4x4P¨DißbÀ
;

198 
	mI¡ø4x4DügDißbÀ
;

199 
	mI¡ø4x4DúDißbÀ
;

200 
	mI¡ø16x16P¨DißbÀ
;

201 
	mI¡ø16x16Pœ√DißbÀ
;

202 
	mChromaI¡øDißbÀ
;

204 
	mE«bÀIPCM
;

206 
	mFømeR©e
;

208 
	mchroma_qp_ödex_off£t
;

209 
	mfuŒ_£¨ch
;

211 
	mrd›t
;

212 
	mde
;

213 
	mI16rdo
;

214 
	mMDRe„ªn˚
[2];

215 
	msubMBCodögSèã
;

216 
	mDi°‹ti⁄
[
TOTAL_DIST_TYPES
];

217 
	mVisuÆResWavPSNR
;

218 
	mSSIMOvîœpSize
;

219 
	mDi°‹ti⁄YUVtoRGB
;

220 
	mCtxAd±LagøngeMu…
;

221 
	mFa°CrI¡øDecisi⁄
;

222 
	mdi°hªs
;

223 
	mnobskù
;

224 
	mBüsSkùRDO
;

225 
	mF‹˚TrueR©eRDO
;

227 #ifde‡
_LEAKYBUCKET_


228 
	mNumbîLókyBuckës
;

229 
	mLókyBuckëR©eFûe
[
FILE_NAME_SIZE
];

230 
	mLókyBuckëP¨amFûe
[
FILE_NAME_SIZE
];

233 
	mPicI¡îœ˚
;

234 
	mMbI¡îœ˚
;

235 
	mI¡øBŸtom
;

238 
	mLossR©eA
;

239 
	mLossR©eB
;

240 
	mLossR©eC
;

241 
	mFú°FømeC‹ª˘
;

242 
	mNoOfDecodîs
;

243 
	mEº‹C⁄˚Æmít
;

244 
	mRe°ri˘Ref
;

245 
	mNumFømesInELSubSeq
;

247 
	mR™domI¡øMBRe‰esh
;

249 
	mOnTheFlyFø˘MCP
;

252 
	mChromaMCBuf„r
;

253 
	mChromaMEE«bÀ
;

254 
	mChromaMEWeight
;

255 
	mMESo·íSSEMëric
;

256 
	mMEEº‹Mëric
[3];

257 
	mModeDecisi⁄Mëric
;

258 
	mSkùDeBlockN⁄Ref
;

261 
	mDFSídP¨amëîs
;

262 
	mDFDißbÀIdc
[2][
NUM_SLICE_TYPES
];

263 
	mDFAÕha
 [2][
NUM_SLICE_TYPES
];

264 
	mDFBëa
 [2][
NUM_SLICE_TYPES
];

266 
	mS∑ªPi˘uªO±i⁄
;

267 
	mSPDëe˘i⁄Thªshﬁd
;

268 
	mSPPî˚¡ageThªshﬁd
;

271 
	mSli˚GroupC⁄figFûeName
[
FILE_NAME_SIZE
];

272 
	mnum_¶i˚_groups_möus1
;

273 
	m¶i˚_group_m≠_ty≥
;

275 *
	mt›_À·
;

276 *
	mbŸtom_right
;

277 
byã
 *
	m¶i˚_group_id
;

278 *
	mrun_Àngth_möus1
;

280 
	m¶i˚_group_ch™ge_dúe˘i⁄_Êag
;

281 
	m¶i˚_group_ch™ge_øã_möus1
;

282 
	m¶i˚_group_ch™ge_cy˛e
;

284 
	mªdund™t_pic_Êag
;

285 
	mpic_‹dî_˙t_ty≥
;

287 
	mc⁄ãxt_öô_mëhod
;

288 
	mmodñ_numbî
;

289 
	mTønsf‹m8x8Mode
;

290 
	mRï‹tFømeSèts
;

291 
	mDi•œyEncP¨ams
;

292 
	mVîbo£
;

295 
	mRCE«bÀ
;

296 
	mbô_øã
;

297 
	mSeöôülQP
;

298 
	mbasicunô
;

299 
	mch™√l_ty≥
;

300 
	mRCUpd©eMode
;

301 
	mRCIovîPR©io
;

302 
	mRCBovîPR©io
;

303 
	mRCISli˚BôR©io
;

304 
	mRCBSli˚BôR©io
[
RC_MAX_TEMPORAL_LEVELS
];

305 
	mRCMöQP
[
NUM_SLICE_TYPES
];

306 
	mRCMaxQP
[
NUM_SLICE_TYPES
];

307 
	mRCMaxQPCh™ge
;

310 
	mU£MVLimôs
;

311 
	mSëMVXLimô
;

312 
	mSëMVYLimô
;

315 
SórchTy≥
 
	mSórchMode
[2];

318 
	mUMHexDSR
;

319 
	mUMHexSˇÀ
;

322 
	mEPZSP©ã∫
;

323 
	mEPZSDuÆ
;

324 
	mEPZSFixed
;

325 #i‡(
MVC_EXTENSION_ENABLE
)

326 
	mEPZSTemp‹Æ
[2];

328 
	mEPZSTemp‹Æ
;

330 
	mEPZSS∑tülMem
;

331 
	mEPZSBlockTy≥
;

332 #i‡(
MVC_EXTENSION_ENABLE
)

333 
	mE«bÀEnhLayîEPZSSˇÀrs
;

334 
	mEPZSMöThªsSˇÀ
[2];

335 
	mEPZSMaxThªsSˇÀ
[2];

336 
	mEPZSMedThªsSˇÀ
[2];

337 
	mEPZSSubPñThªsSˇÀ
[2];

339 
	mEPZSMöThªsSˇÀ
;

340 
	mEPZSMaxThªsSˇÀ
;

341 
	mEPZSMedThªsSˇÀ
;

342 
	mEPZSSubPñThªsSˇÀ
;

344 
	mDißbÀMEPªdi˘i⁄
;

345 
	mEPZSSubPñGrid
;

346 
	mEPZSSubPñME
;

347 
	mEPZSSubPñMEBiPªd
;

349 
	mMöIDRDi°™˚
;

351 
	mU£Ex∂icôLambdaP¨ams
;

352 
	mUpd©eLambdaChromaME
;

353 
	mLambdaWeight
[6];

354 
	mFixedLambda
[6];

356 
	mQOff£tM©rixFûe
[
FILE_NAME_SIZE
];

357 
	mOff£tM©rixPª£¡Fœg
;

359 
	mAd≠tiveRoundög
;

360 
	mAd≠tRoundögFixed
;

361 
	mAd≠tRndPîiod
;

362 
	mAd≠tRndChroma
;

363 
	mAd≠tRndWFa˘‹
 [2][
NUM_SLICE_TYPES
];

364 
	mAd≠tRndCrWFa˘‹
[2][
NUM_SLICE_TYPES
];

368 
	mSˇlögM©rixPª£¡Fœg
;

369 
	mSˇlögLi°Pª£¡Fœg
[12];

371 
	mcb_qp_ödex_off£t
;

372 
	m¸_qp_ödex_off£t
;

374 
	mLos¶essCodög
;

377 
	mE¨lySkùE«bÀ
;

378 
	mSñe˘iveI¡øE«bÀ
;

379 
	mDi•oßbÀP
;

380 
	mDi•PQPOff£t
;

383 
	mNumRedund™tHõørchy
;

384 
	mPrim¨yGOPLígth
;

385 
	mNumRefPrim¨y
;

388 
	mT⁄eM≠pögSEIPª£¡Fœg
;

389 
	mT⁄eM≠pögFûe
[
FILE_NAME_SIZE
];

392 
	mPª„rDi•Ordî
;

393 
	mPª„rPowîOfTwo
;

394 
	mFrmSåu˘Buf„rLígth
;

396 
	mrc_˝b_size
;

397 
	mSEIVUI32PuŒdown
;

399 
	m£∑øã_cﬁour_∂™e_Êag
;

400 
	mWeightY
;

401 
	mWeightCb
;

402 
	mWeightCr
;

403 
	mU£RDOQu™t
;

404 
	mRDOQ_DC
;

405 
	mRDOQ_CR
;

406 
	mRDOQ_DC_CR
;

407 
	mRDOQ_QP_Num
;

408 
	mRDOQ_CP_Mode
;

409 
	mRDOQ_CP_MV
;

410 
	mRDOQ_Fa°
;

412 
	mE«bÀVUISuµ‹t
;

414 
VUIP¨amëîs
 
	mVUI
;

418 
	m°dR™ge
;

419 
	mvideoCode
;

421 #i‡
B0_MORE_REF


422 
	mBLevñ0M‹eRef
;

424 #i‡
KEEP_B_SAME_LIST


425 
	mBIdítiˇlLi°
;

427 #i‡
CRA


428 
	mu£CRA
;

430 #i‡
HM50_LIKE_MMCO


431 
	mHM50RefSåu˘uª
;

433 #i‡
LD_REF_SETTING


434 
	mLDRefSëtög
;

	@lencod/inc/parset.h

17 #i‚de‡
_PARSET_H_


18 
	#_PARSET_H_


	)

20 
	~"∑r£tcomm⁄.h
"

21 
	~"«lu.h
"

22 
	~"£i.h
"

24 
gíî©e_∑ømëî_£ts
 (
VideoP¨amëîs
 *
p_Vid
);

25 
FªeP¨amëîSës
 (
VideoP¨amëîs
 *
p_Vid
);

27 
NALU_t
 *
Gíî©eSeq_∑ømëî_£t_NALU
 (
VideoP¨amëîs
 *
p_Vid
);

28 
NALU_t
 *
Gíî©ePic_∑ømëî_£t_NALU
 (
VideoP¨amëîs
 *
p_Vid
, );

29 
NALU_t
 *
Gíî©eSEImesßge_NALU
(
I≈utP¨amëîs
 *
p_I≈
);

30 #i‡(
MVC_EXTENSION_ENABLE
)

31 
NALU_t
 *
Gíî©eSub£tSeq_∑ømëî_£t_NALU
 (
VideoP¨amëîs
 *
p_Vid
);

35 
Gíî©eSequí˚P¨amëîSë
(
£q_∑ømëî_£t_rb•_t
 *
•s
, 
VideoP¨amëîs
 *
p_Vid
, 
SPS_id
);

36 
Gíî©ePi˘uªP¨amëîSë
–
pic_∑ømëî_£t_rb•_t
 *
µs
, 
£q_∑ømëî_£t_rb•_t
 *
•s
,

37 
VideoP¨amëîs
 *
p_Vid
,

38 
I≈utP¨amëîs
 *
p_I≈
, 
PPS_id
,

39 
WeighãdPªdi˘i⁄
, 
WeighãdBùªdi˘i⁄
,

40 
cb_qp_ödex_off£t
, 
¸_qp_ödex_off£t
);

42 
Sˇlög_Li°
(*
sˇlögLi°öput
, *
sˇlögLi°
, 
sizeOfSˇlögLi°
, *
U£DeÁu…SˇlögM©rix
, 
Bô°ªam
 *
bô°ªam
);

43 #i‡(
MVC_EXTENSION_ENABLE
)

44 
Gíî©eSeq_∑ømëî_£t_rb•
 (
VideoP¨amëîs
 *
p_Vid
, 
£q_∑ømëî_£t_rb•_t
 *
•s
, 
byã
 *
buf
, 
Is_Sub£t
);

46 
Gíî©eSeq_∑ømëî_£t_rb•
 (
VideoP¨amëîs
 *
p_Vid
, 
£q_∑ømëî_£t_rb•_t
 *
•s
, 
byã
 *
buf
);

48 
Gíî©ePic_∑ømëî_£t_rb•
 (
VideoP¨amëîs
 *
p_Vid
, 
pic_∑ømëî_£t_rb•_t
 *
µs
, 
byã
 *
buf
);

49 
Gíî©eSEImesßge_rb•
 (
I≈utP¨amëîs
 *
p_I≈
, 
id
, 
byã
 *
buf
);

50 
FªeSPS
 (
£q_∑ømëî_£t_rb•_t
 *
•s
);

51 
FªePPS
 (
pic_∑ømëî_£t_rb•_t
 *
µs
);

53 
WrôeHRDP¨amëîs
(
£q_∑ømëî_£t_rb•_t
 *
•s
, 
Bô°ªam
 *
bô°ªam
);

54 
Gíî©eVUIP¨amëîs
(
£q_∑ømëî_£t_rb•_t
 *
•s
, 
I≈utP¨amëîs
 *
p_I≈
);

56 
pic_∑ømëî_£t_rb•_t
 *
AŒocPPS
 ();

57 
£q_∑ømëî_£t_rb•_t
 *
AŒocSPS
 ();

	@lencod/inc/pred_struct.h

17 #i‚de‡
_PRED_STRUCT_H_


18 
	#_PRED_STRUCT_H_


	)

20 
	~"globÆ.h
"

21 
	~"¥ed_°ru˘_ty≥s.h
"

22 
	~"ex∂icô_£q.h
"

24 
gë_poc_ty≥_zîo
–
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
FømeUnôSåu˘
 *
p_‰m_°ru˘
 );

25 
gë_poc_ty≥_⁄e
–
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
FømeUnôSåu˘
 *
p_‰m_°ru˘
 );

26 
öô_poc
(
VideoP¨amëîs
 *
p_Vid
);

27 
SeqSåu˘uª
 * 
öô_£q_°ru˘uª
–
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, *
mem‹y_size
 );

28 
‰ì_£q_°ru˘uª
–
SeqSåu˘uª
 *
p_£q_°ru˘
 );

29 
p›uœã_‰m_°ru˘
–
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
SeqSåu˘uª
 *
p_£q_°ru˘
, 
num_to_p›uœã
, 
öô_‰ames_to_code
 );

30 
p›uœã_‰ame_ex∂icô
–
ExpFømeInfo
 *
öfo
, 
I≈utP¨amëîs
 *
p_I≈
, 
FømeUnôSåu˘
 *
p_‰m_°ru˘
, 
num_¶i˚s
 );

31 
p›uœã_‰ame_¶i˚_ty≥
–
I≈utP¨amëîs
 *
p_I≈
, 
FømeUnôSåu˘
 *
p_‰m_°ru˘
, 
¶i˚_ty≥
, 
num_¶i˚s
 );

32 
p›uœã_ªg_pic
–
I≈utP¨amëîs
 *
p_I≈
, 
PicSåu˘uª
 *
p_pic
, 
FømeUnôSåu˘
 *
p_‰m_°ru˘
, 
num_¶i˚s
, 
is_bŸ_Êd
 );

33 
p›uœã_‰m_°ru˘_mvc
–
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
SeqSåu˘uª
 *
p_£q_°ru˘
, 
°¨t
, 
íd
 );

	@lencod/inc/pred_struct_adapt.h

17 #i‚de‡
_PRED_STRUCT_ADAPT_H_


18 
	#_PRED_STRUCT_ADAPT_H_


	)

20 
	~"globÆ.h
"

	@lencod/inc/pred_struct_adapt_types.h

17 #i‚de‡
_PRED_STRUCT_ADAPT_TYPES_H_


18 
	#_PRED_STRUCT_ADAPT_TYPES_H_


	)

	@lencod/inc/pred_struct_types.h

17 #i‚de‡
_PRED_STRUCT_TYPES_H_


18 
	#_PRED_STRUCT_TYPES_H_


	)

35 
	mPOP_IDR
 = 1,

36 
	mPOP_INTRA
 = 2,

37 
	mPOP_SP
 = 3

38 } 
	tSli˚Ty≥ToP›
;

41 
	s¥ed_°ru˘_‰m


43 
	mdi•_off£t
;

44 
	m¶i˚_ty≥
;

45 
	m«l_ªf_idc
;

46 
	mœyî
;

47 
	m¶i˚_qp_off
;

48 
	møndom_ac˚ss
;

49 
	mãmp‹Æ_œyî
;

50 } 
	tPªdSåu˘Frm
;

53 
	s¥ed_°ru˘_©om


55 
	mÀngth
;

56 
	mg›_Àvñs
;

57 
PªdSåu˘Frm
 *
	mp_‰m
;

58 } 
	tPªdSåu˘Atom
;

61 
	s¶i˚_°ru˘


63 
	mty≥
;

64 
	mqp
;

65 
	mdeblock
;

66 
	mweighãd_¥ed
;

67 
	mnum_ªfs
;

68 } 
	tSli˚Såu˘uª
;

71 
	spic_°ru˘


73 
	midr_Êag
;

74 
	m«l_ªf_idc
;

75 
	møndom_ac˚ss
;

76 
	mnum_¶i˚s
;

77 
Sli˚Såu˘uª
 *
	mp_Sli˚
;

78 } 
	tPicSåu˘uª
;

81 
	s‰ame_°ru˘


83 
	mty≥
;

84 
	midr_Êag
;

85 
	m«l_ªf_idc
;

86 
	m‰ame_no
;

87 
	mfõld_pic_Êag
;

88 
	mmod_qp
;

89 
	mqp
;

90 
	mœyî
;

91 
	mnum_ªfs
;

92 
	møndom_ac˚ss
;

93 
	m©om_idx
;

94 
	mãmp‹Æ_œyî
;

95 #i‡(
MVC_EXTENSION_ENABLE
)

96 
	mvõw_id
;

98 
PicSåu˘uª
 *
	mp_‰ame_pic
;

99 
PicSåu˘uª
 *
	mp_t›_Êd_pic
;

100 
PicSåu˘uª
 *
	mp_bŸ_Êd_pic
;

101 
PªdSåu˘Atom
 *
	mp_©om
;

102 } 
	tFømeUnôSåu˘
;

105 
	s£q_°ru˘


107 
	mnum_‰ames
;

108 
	mnum_¥ds
;

109 
	mnum_g›s
;

110 
	mnum_öåa_g›s
;

113 
	mœ°_øndom_ac˚ss_‰ame
;

114 
	mœ°_idr_‰ame
;

115 
	mœ°_öåa_‰ame
;

116 
	mœ°_mmco_5_‰ame
;

117 
	mœ°_•_‰ame
;

119 
	mœ°_ønd_ac˚ss_di•
;

120 
	mœ°_idr_di•
;

121 
	mœ°_öåa_di•
;

122 
	mœ°_•_di•
;

123 
	mœ°_bl_‰m_di•oßbÀ
;

125 
	mcuº_num_to_p›uœã
;

126 
	mp›_°¨t_‰ame
;

128 
	mmax_num_¶i˚s
;

129 
	mp›_Êag
;

131 #i‡(
MVC_EXTENSION_ENABLE
)

132 
	mnum_‰ames_mvc
;

133 
FømeUnôSåu˘
 *
	mp_‰m_mvc
;

136 
FømeUnôSåu˘
 *
	mp_‰m
;

138 
PªdSåu˘Atom
 *
	mp_¥d
;

139 
PªdSåu˘Atom
 *
	mp_g›
;

140 
PªdSåu˘Atom
 *
	mp_öåa_g›
;

141 } 
	tSeqSåu˘uª
;

	@lencod/inc/q_around.h

14 #i‚de‡
_Q_AROUND_H_


15 
	#_Q_AROUND_H_


	)

17 
upd©e_ad≠tive_roundög_8x8
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
RD_8x8DATA
* 
d©aTr
, **** 
ARCofAdj
);

18 
°‹e_ad≠tive_roundög_4x4
 (
VideoP¨amëîs
 *
p_Vid
, ****
ARCofAdj
, 
mode
, 
block_y
, 
block_x
);

19 
upd©e_ad≠tive_roundög_4x4
 (
VideoP¨amëîs
 *
p_Vid
, ****
ARCofAdj
 , 
mode
, 
block_y
, 
block_x
);

20 
upd©e_ad≠tive_roundög_16x16
(
VideoP¨amëîs
 *
p_Vid
, ****
ARCofAdj
 , 
mode
);

21 
°‹e_ad≠tive_roundög_16x16
 (
VideoP¨amëîs
 *
p_Vid
, ****
ARCofAdj
, 
mode
);

22 
ª£t_ad≠tive_roundög_dúe˘
(
VideoP¨amëîs
 *
p_Vid
);

23 
upd©e_off£t_∑øms
 (
Ma¸oblock
 *
cuºMB
, 
mode
, 
byã
 
luma_å™sf‹m_size_8x8_Êag
);

	@lencod/inc/q_matrix.h

15 #i‚de‡
_Q_MATRIX_H_


16 
	#_Q_MATRIX_H_


	)

18 
	ssˇlög_li°
 {

19 
	mSˇlögLi°4x4öput
[6][16];

20 
	mSˇlögLi°8x8öput
[6][64];

21 
	mSˇlögLi°4x4
[6][16];

22 
	mSˇlögLi°8x8
[6][64];

24 
	mU£DeÁu…SˇlögM©rix4x4Fœg
[6];

25 
	mU£DeÁu…SˇlögM©rix8x8Fœg
[6];

28 
öô_qm©rix
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
);

29 
CÆcuœãQu™t4x4P¨am
 (
VideoP¨amëîs
 *
p_Vid
);

30 
CÆcuœãQu™t8x8P¨am
 (
VideoP¨amëîs
 *
p_Vid
);

31 
‰ì_QM©rix
(
Qu™tP¨amëîs
 *
p_Qu™t
);

	@lencod/inc/q_offsets.h

15 #i‚de‡
_Q_OFFSETS_H_


16 
	#_Q_OFFSETS_H_


	)

18 c⁄° 
	gOff£tBôs
 = 11;

20 
öô_qoff£t
 (
VideoP¨amëîs
 *
p_Vid
);

21 
CÆcuœãOff£t4x4P¨am
 (
VideoP¨amëîs
 *
p_Vid
);

22 
CÆcuœãOff£t8x8P¨am
 (
VideoP¨amëîs
 *
p_Vid
);

23 
‰ì_QOff£ts
 (
Qu™tP¨amëîs
 *
p_Qu™t
, 
I≈utP¨amëîs
 *
p_I≈
);

24 
InôOff£tP¨am
 (
Qu™tP¨amëîs
 *
p_Qu™t
, 
I≈utP¨amëîs
 *
p_I≈
);

	@lencod/inc/quant4x4.h

16 #i‚de‡
_QUANT4x4_H_


17 
	#_QUANT4x4_H_


	)

19 
öô_qu™t_4x4
 (
Sli˚
 *
cuºSli˚
);

21 
qu™t_4x4_n‹mÆ
 (
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qu™t_mëhods
 *
q_mëhod
);

22 
qu™t_4x4_¨ound
 (
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qu™t_mëhods
 *
q_mëhod
);

23 
qu™t_4x4_åñlis
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qu™t_mëhods
 *
q_mëhod
);

24 
qu™t_dc4x4_n‹mÆ
 (
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qp
, * 
DCLevñ
, * 
DCRun
,

25 
LevñQu™tP¨ams
 *
q_∑øms_4x4
, c⁄° 
byã
 (*
pos_sˇn
)[2]);

27 
qu™t_dc4x4_¨ound
 (
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qp
, * 
DCLevñ
, * 
DCRun
,

28 
LevñQu™tP¨ams
 *
q_∑øms_4x4
, c⁄° 
byã
 (*
pos_sˇn
)[2]);

30 
qu™t_dc4x4_åñlis
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qp
, * 
DCLevñ
, * 
DCRun
,

31 
LevñQu™tP¨ams
 *
q_∑øms_4x4
, c⁄° 
byã
 (*
pos_sˇn
)[2]);

33 
qu™t_ac4x4_n‹mÆ
 (
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qu™t_mëhods
 *
q_mëhod
);

34 
qu™t_ac4x4_¨ound
 (
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qu™t_mëhods
 *
q_mëhod
);

35 
qu™t_ac4x4_åñlis
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qu™t_mëhods
 *
q_mëhod
);

37 
rdoq_4x4_CAVLC
 (
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qu™t_mëhods
 *
q_mëhod
, 
ÀvñTªŒis
[16]);

39 
rdoq_4x4_CABAC
 (
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qu™t_mëhods
 *
q_mëhod
, 
ÀvñTªŒis
[16]);

41 
rdoq_dc_CAVLC
 (
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qp_≥r
, 
qp_ªm
, 
LevñQu™tP¨ams
 *
q_∑øms_4x4
,

42 c⁄° 
byã
 (*
pos_sˇn
)[2], 
ÀvñTªŒis
[16], 
ty≥
);

44 
rdoq_dc_CABAC
 (
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qp_≥r
, 
qp_ªm
, 
LevñQu™tP¨ams
 *
q_∑øms_4x4
,

45 c⁄° 
byã
 (*
pos_sˇn
)[2], 
ÀvñTªŒis
[16], 
ty≥
);

47 
rdoq_ac4x4_CAVLC
 (
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qu™t_mëhods
 *
q_mëhod
, 
ÀvñTªŒis
[16]);

49 
rdoq_ac4x4_CABAC
 (
Ma¸oblock
 *
cuºMB
, **
tblock
 , 
qu™t_mëhods
 *
q_mëhod
, 
ÀvñTªŒis
[16]);

	@lencod/inc/quant8x8.h

15 #i‚de‡
_QUANT8x8_H_


16 
	#_QUANT8x8_H_


	)

18 
öô_qu™t_8x8
 (
Sli˚
 *
cuºSli˚
);

20 
qu™t_8x8_n‹mÆ
 (
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qu™t_mëhods
 *
q_mëhod
);

21 
qu™t_8x8_¨ound
 (
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qu™t_mëhods
 *
q_mëhod
);

22 
qu™t_8x8_åñlis
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qu™t_mëhods
 *
q_mëhod
);

24 
qu™t_8x8ˇvlc_¨ound
 (
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qu™t_mëhods
 *
q_mëhod
, *** 
cofAC
);

25 
qu™t_8x8ˇvlc_n‹mÆ
 (
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qu™t_mëhods
 *
q_mëhod
, *** 
cofAC
);

26 
qu™t_8x8ˇvlc_åñlis
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qu™t_mëhods
 *
q_mëhod
, *** 
cofAC
);

	@lencod/inc/quantChroma.h

16 #i‚de‡
_QUANT_CR_H_


17 
	#_QUANT_CR_H_


	)

19 
öô_qu™t_Chroma
(
Sli˚
 *
cuºSli˚
);

21 
qu™t_dc2x2_n‹mÆ
 (
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qp
, * 
DCLevñ
, * 
DCRun
,

22 
LevñQu™tP¨ams
 *
q_∑øms_4x4
, **
Ádju°2x2
, c⁄° 
byã
 (*
pos_sˇn
)[2]);

24 
qu™t_dc2x2_¨ound
 (
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qp
, * 
DCLevñ
, * 
DCRun
,

25 
LevñQu™tP¨ams
 *
q_∑øms_4x4
, **
Ádju°2x2
, c⁄° 
byã
 (*
pos_sˇn
)[2]);

27 
qu™t_dc2x2_åñlis
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qp
, * 
DCLevñ
, * 
DCRun
,

28 
LevñQu™tP¨ams
 *
q_∑øms_4x4
, **
Ádju°
, c⁄° 
byã
 (*
pos_sˇn
)[2]);

30 
qu™t_dc4x2_n‹mÆ
 (
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qp
, * 
DCLevñ
, * 
DCRun
,

31 
LevñQu™tP¨ams
 *
q_∑øms_4x4
, **
Ádju°
, c⁄° 
byã
 (*
pos_sˇn
)[2]);

33 
qu™t_dc4x2_¨ound
 (
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qp
, * 
DCLevñ
, * 
DCRun
,

34 
LevñQu™tP¨ams
 *
q_∑øms_4x4
, **
Ádju°
, c⁄° 
byã
 (*
pos_sˇn
)[2]);

36 
qu™t_dc4x2_åñlis
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qp
, * 
DCLevñ
, * 
DCRun
,

37 
LevñQu™tP¨ams
 *
q_∑øms_4x4
, **
Ádju°
, c⁄° 
byã
 (*
pos_sˇn
)[2]);

39 
rdoq_dc_¸_CAVLC
 (
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qp_≥r
, 
qp_ªm
,

40 
LevñQu™tP¨ams
 *
q_∑øms_4x4
,

41 c⁄° 
byã
 (*
pos_sˇn
)[2], 
ÀvñTªŒis
[16], 
ty≥
);

43 
rdoq_dc_¸_CABAC
 (
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qp_≥r
, 
qp_ªm
,

44 
LevñQu™tP¨ams
 *
q_∑øms_4x4
, c⁄° 
byã
 (*
pos_sˇn
)[2], 
ÀvñTªŒis
[16], 
ty≥
);

	@lencod/inc/ratectl.h

19 #i‚de‡
_RATE_CTL_H_


20 
	#_RATE_CTL_H_


	)

22 
	~"globÆ.h
"

23 
	~"rc_quadøtic.h
"

27 
Q°ï2QP
 ( 
Q°ï
, 
qp_off£t
 );

28 
QP2Q°ï
 ( 
QP
 );

29 
CompuãMBMAD
 ( 
diff
[16][16] );

30 
CompuãFømeMAD
 ( 
VideoP¨amëîs
 *
p_Vid
 );

31 
rc_°‹e_mad
 ( 
Ma¸oblock
 *
cuºMB
 );

35 
rc_Æloc_gíîic
 ( 
VideoP¨amëîs
 *
p_Vid
, 
RCGíîic
 **
p_quad
 );

36 
rc_‰ì_gíîic
 ( 
RCGíîic
 **
p_quad
 );

37 
rc_c›y_gíîic
 ( 
VideoP¨amëîs
 *
p_Vid
, 
RCGíîic
 *
d°
, RCGíîi¯*
§c
 );

38 
rc_öô_g›_∑øms
 ( 
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
 );

39 
rc_öô_‰ame
 ( 
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
);

40 
rc_öô_£quí˚
 ( 
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
);

41 
rc_°‹e_¶i˚_hódî_bôs
 ( 
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
Àn
);

	@lencod/inc/rc_quadratic.h

19 #i‚de‡
_RC_QUADRATIC_H_


20 
	#_RC_QUADRATIC_H_


	)

22 
	~"rc_ty≥s.h
"

26 
rc_Æloc_quadøtic
–
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
RCQuadøtic
 **
p_quad
 );

27 
rc_‰ì_quadøtic
 ( 
RCQuadøtic
 **
p_quad
 );

28 
rc_c›y_quadøtic
 ( 
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
RCQuadøtic
 *
d°
, RCQuadøti¯*
§c
 );

31 
rc_öô_£q
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
RCQuadøtic
 *
p_quad
, 
RCGíîic
 *
p_gí
);

32 
rc_öô_GOP
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
RCQuadøtic
 *
p_quad
, 
RCGíîic
 *
p_gí
, 
≈
, 
nb
);

33 
rc_upd©e_pi˘_‰ame
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
RCQuadøtic
 *
p_quad
, 
RCGíîic
 *
p_gí
, 
nbôs
);

34 
rc_öô_pi˘
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
,

35 
RCQuadøtic
 *
p_quad
, 
RCGíîic
 *
p_gí
, 
fõldpic
, 
t›fõld
, 
èrgëcompuèti⁄
, 
mu…
);

36 
rc_upd©e_pi˘
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
RCQuadøtic
 *
p_quad
, 
RCGíîic
 *
p_gí
, 
nbôs
);

37 
rc_upd©e_pi˘uª
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
bôs
);

39 
upd©eQPRC0
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
RCQuadøtic
 *
p_quad
, 
RCGíîic
 *
p_gí
, 
t›fõld
);

40 
upd©eQPRC1
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
RCQuadøtic
 *
p_quad
, 
RCGíîic
 *
p_gí
, 
t›fõld
);

41 
upd©eQPRC2
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
RCQuadøtic
 *
p_quad
, 
RCGíîic
 *
p_gí
, 
t›fõld
);

42 
upd©eQPRC3
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
RCQuadøtic
 *
p_quad
, 
RCGíîic
 *
p_gí
, 
t›fõld
);

45 
upd©eQPI¡îœ˚
 ( 
RCQuadøtic
 *
p_quad
, 
RCGíîic
 *
p_gí
 );

46 
upd©eQPN⁄PicAFF
 ( 
£q_∑ømëî_£t_rb•_t
 *
a˘ive_•s
, 
RCQuadøtic
 *
p_quad
 );

47 
upd©eBŸtomFõld
 ( 
I≈utP¨amëîs
 *
p_I≈
, 
RCQuadøtic
 *
p_quad
 );

48 
upd©eFú°P
 ( 
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
RCQuadøtic
 *
p_quad
, 
RCGíîic
 *
p_gí
, 
t›fõld
 );

49 
upd©eNeg©iveT¨gë
–
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
RCQuadøtic
 *
p_quad
, 
RCGíîic
 *
p_gí
, 
t›fõld
, 
m_Qp
 );

50 
upd©eFú°BU
 ( 
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
RCQuadøtic
 *
p_quad
, 
RCGíîic
 *
p_gí
, 
t›fõld
 );

51 
upd©eLa°BU
 ( 
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
RCQuadøtic
 *
p_quad
, 
RCGíîic
 *
p_gí
, 
t›fõld
 );

52 
¥edi˘CuºPicMAD
 ( 
I≈utP¨amëîs
 *
p_I≈
, 
RCQuadøtic
 *
p_quad
, 
RCGíîic
 *
p_gí
 );

53 
upd©eModñQPBU
 ( 
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
RCQuadøtic
 *
p_quad
, 
m_Qp
 );

54 
upd©eQPI¡îœ˚BU
 ( 
RCQuadøtic
 *
p_quad
, 
RCGíîic
 *
p_gí
 );

55 
upd©eModñQPFøme
 ( 
RCQuadøtic
 *
p_quad
, 
m_Bôs
 );

57 
upd©eRCModñ
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
RCQuadøtic
 *
p_quad
, 
RCGíîic
 *
p_gí
);

58 
upd©eMADModñ
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
RCQuadøtic
 *
p_quad
, 
RCGíîic
 *
p_gí
);

59 
RCModñE°im©‹
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
RCQuadøtic
 *
p_quad
, 
n_wödowSize
, 
Boﬁón
 *
m_rgReje˘ed
);

60 
MADModñE°im©‹
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
RCQuadøtic
 *
p_quad
, 
n_wödowSize
, 
Boﬁón
 *
Pi˘uªReje˘ed
);

61 
upd©eCom∂exôy
 (
VideoP¨amëîs
 *
p_Vid
, 
RCQuadøtic
 *
p_quad
, 
RCGíîic
 *
p_gí
, 
Boﬁón
 
is_upd©ed
, 
nbôs
 );

62 
upd©eP∑øms
 (
RCQuadøtic
 *
p_quad
, 
RCGíîic
 *
p_gí
, 
com∂exôy
 );

63 
upd©eB∑øms
 (
RCQuadøtic
 *
p_quad
, 
RCGíîic
 *
p_gí
, 
com∂exôy
 );

66 
rc_h™dÀ_mb
 ( 
Ma¸oblock
 *
cuºMB
, 
¥ev_mb
);

67 
rc_öô_t›_fõld
 ( 
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
 );

68 
rc_öô_bŸtom_fõld
 ( 
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
T›FõldBôs
 );

69 
rc_öô_‰ame_rdpic
 ( 
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
øãR©io
 );

70 
rc_Æloˇã_mem‹y
 ( 
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
 );

71 
rc_‰ì_mem‹y
 ( 
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
 );

72 
rc_upd©e_mb_°©s
 ( 
Ma¸oblock
 *
cuºMB
);

73 
rc_ßve_°©e
 ( 
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
 );

74 
rc_ª°‹e_°©e
 ( 
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
 );

	@lencod/inc/rc_types.h

20 #i‚de‡
_RC_TYPES_H_


21 
	#_RC_TYPES_H_


	)

23 
	#RC_MODEL_HISTORY
 21

	)

26 
	src_gíîic


29 
	mT›FõldFœg
;

30 
	mFõldC⁄åﬁ
;

31 
	mFõldFøme
;

32 
	mNoGønuœrFõldRC
;

34 
	mNumbîofHódîBôs
;

35 
	mNumbîofTextuªBôs
;

36 
	mNumbîofBasicUnôHódîBôs
;

37 
	mNumbîofBasicUnôTextuªBôs
;

39 
	mNumbîofGOP
;

40 
	mNumbîofCodedBFøme
;

42 
öt64
 
	mTŸÆMADBasicUnô
;

43 *
	mMADofMB
;

45 
öt64
 
	mCuºítBuf„rFuŒ√ss
;

46 
öt64
 
	mRemaöögBôs
;

48 
	mRCPSli˚Bôs
;

49 
	mRCISli˚Bôs
;

50 
	mRCBSli˚Bôs
[
RC_MAX_TEMPORAL_LEVELS
];

51 
	mãmp‹Æ_Àvñs
;

52 
	mhõrNb
[
RC_MAX_TEMPORAL_LEVELS
];

53 
	mNPSli˚
;

54 
	mNISli˚
;

55 } 
	tRCGíîic
;

57 
	src_quadøtic


59 
	mbô_øã
;

60 
	m‰ame_øã
;

61 
	mPªvBôR©e
;

62 
	mGAMMAP
;

63 
	mBETAP
;

64 
	mGOPT¨gëBuf„rLevñ
;

65 
	mT¨gëBuf„rLevñ
;

66 
	mAveWp
;

67 
	mAveWb
;

68 
	mMyInôülQp
;

69 
	mPAvîageQp
;

70 
	mPªviousPi˘uªMAD
;

71 
	mMADPi˘uªC1
;

72 
	mMADPi˘uªC2
;

73 
	mPMADPi˘uªC1
;

74 
	mPMADPi˘uªC2
;

75 
	mPPi˘uªMAD
 [
RC_MODEL_HISTORY
];

76 
	mPi˘uªMAD
 [
RC_MODEL_HISTORY
];

77 
	mRe„ªn˚MAD
[
RC_MODEL_HISTORY
];

78 
	mm_rgQp
 [
RC_MODEL_HISTORY
];

79 
	mm_rgRp
 [
RC_MODEL_HISTORY
];

80 
	mPm_rgQp
 [
RC_MODEL_HISTORY
];

81 
	mPm_rgRp
 [
RC_MODEL_HISTORY
];

83 
	mm_X1
;

84 
	mm_X2
;

85 
	mPm_X1
;

86 
	mPm_X2
;

87 
	mPm_Qp
;

88 
	mPm_Hp
;

90 
	mMADm_wödowSize
;

91 
	mm_wödowSize
;

92 
	mm_Qc
;

94 
	mPPªHódî
;

95 
	mPªvLa°QP
;

96 
	mCuºLa°QP
;

97 
	mNumbîofBFømes
;

99 
	mTŸÆFømeQP
;

100 
	mNumbîofBasicUnô
;

101 
	mPAveHódîBôs1
;

102 
	mPAveHódîBôs2
;

103 
	mPAveHódîBôs3
;

104 
	mPAveFømeQP
;

105 
	mTŸÆNumbîofBasicUnô
;

106 
	mCodedBasicUnô
;

108 
	mNumbîofCodedPFøme
;

109 
	mTŸÆQpf‹PPi˘uª
;

110 
	mNumbîofPPi˘uª
;

112 
	mCuºítFømeMAD
;

113 
	mCuºítBUMAD
;

114 
	mTŸÆBUMAD
;

115 
	mPªviousFømeMAD
;

116 
	mPªviousWhﬁeFømeMAD
;

118 
	mDDqu™t
;

119 
	mMBPîRow
;

120 
	mQPLa°PFøme
;

121 
	mQPLa°GOP
;

124 
	mFõldQPBuf„r
;

125 
	mFømeQPBuf„r
;

126 
	mFømeAveHódîBôs
;

127 
	mFõldAveHódîBôs
;

128 *
	mBUPFMAD
;

129 *
	mBUCFMAD
;

130 *
	mFCBUCFMAD
;

131 *
	mFCBUPFMAD
;

133 
Boﬁón
 
	mGOPOvîdue
;

134 
öt64
 
	mP¥ev_bôs
;

137 
	mXp
, 
	mXb
;

138 
	mT¨gë
;

139 
	mT¨gëFõld
;

140 
	mNp
, 
	mNb
, 
	mbôs_t›fõld
;

142 
	mUµîBound1
, 
	mUµîBound2
, 
	mLowîBound
;

143 
	mWp
, 
	mWb
;

144 
	mDñèP
;

145 
	mTŸÆPFøme
;

146 
	mPMaxQpCh™ge
;

148 
	mbôdïth_qp_sˇÀ
;

151 
	míc_buf_cuº
;

153 } 
	tRCQuadøtic
;

	@lencod/inc/rd_intra_jm.h

17 #i‚de‡
_RD_INTRA_JM_H_


18 
	#_RD_INTRA_JM_H_


	)

20 
mode_decisi⁄_f‹_I16x16_MB_RDO
 (
Ma¸oblock
 *
cuºMB
, 
œmbda
);

21 
mode_decisi⁄_f‹_I16x16_MB
 (
Ma¸oblock
 *
cuºMB
, 
œmbda
);

22 
mode_decisi⁄_f‹_I4x4_blocks_JM_High
 (
Ma¸oblock
 *
cuºMB
, 
b8
, 
b4
, 
œmbda
, 
di°blk
* 
mö_co°
);

23 
mode_decisi⁄_f‹_I4x4_blocks_JM_Low
 (
Ma¸oblock
 *
cuºMB
, 
b8
, 
b4
, 
œmbda
, 
di°blk
* 
mö_co°
);

24 
föd_be°_mode_I16x16_MB
 (
Ma¸oblock
 *
cuºMB
, 
œmbda
, 
di°blk
 
mö_co°
);

	@lencod/inc/rd_intra_jm444.h

17 #i‚de‡
_RD_INTRA_JM444_H_


18 
	#_RD_INTRA_JM444_H_


	)

20 
mode_decisi⁄_f‹_I16x16_MB_444
 (
Ma¸oblock
 *
cuºMB
, 
œmbda
);

21 
mode_decisi⁄_f‹_I4x4_blocks_JM_High444
 (
Ma¸oblock
 *
cuºMB
, 
b8
, 
b4
, 
œmbda
, 
di°blk
* 
mö_co°
);

22 
mode_decisi⁄_f‹_I4x4_blocks_JM_Low444
 (
Ma¸oblock
 *
cuºMB
, 
b8
, 
b4
, 
œmbda
, 
di°blk
* 
mö_co°
);

	@lencod/inc/rdopt.h

17 #i‚de‡
_RDO_H_


18 
	#_RDO_H_


	)

20 
	~"globÆ.h
"

21 
	~"rd›t_codög_°©e.h
"

26 
	mrdco°
;

27 
	mdco°
;

28 
	møã
;

29 
	mcbp
;

30 
di°blk
 
	mco°
;

31 
	mc_imode
;

32 
	mi16off£t
;

33 
byã
 
	mmode
;

34 } 
	tBe°Mode
;

36 
	srdo_°ru˘uª


38 
RD_8x8DATA
 *
	må4x4
;

39 
RD_8x8DATA
 *
	må8x8
;

40 
img≥l
 ***
	mªc8x8
;

41 
img≥l
 ***
	mªc4x4
;

42 
img≥l
 **
	m¥ed
;

43 
img≥l
 ***
	mªc_mb
;

44 **
	mÃec_ªc
;

45 ***
	mÃec_ªc_uv
;

47 ****
	mcofAC
;

48 ***
	mcofDC
;

49 **
	mcofAC4x4
;

50 ****
	mcofAC4x4öã∫
;

52 
MŸi⁄Ve˘‹
 ****
	mÆl_mv8x8
;

54 *****
	mcofAC4x4CbCröã∫
;

55 *****
	mcofAC8x8ts
;

56 *****
	mc€fAC8x8
;

57 *****
	mc€fAC8x8öåa
;

58 **
	mcofAC4x4CbCr
[2];

61 
	mcbp
;

62 **
	ml0_ªf‰ame
;

63 **
	ml1_ªf‰ame
;

65 
Info8x8
 
	mbe°8x8
[4];

67 
CSobj
 *
	mcs_mb
;

68 
CSobj
 *
	mcs_b8
;

69 
CSobj
 *
	mcs_cm
;

70 
CSobj
 *
	mcs_tmp
;

72 
Be°Mode
 
	mmode_be°
;

75 
	mœmbda_mf_Á˘‹
;

79 
byã
 
fõld_Êag_ö„ªn˚
 (
Ma¸oblock
 *
cuºMB
);

80 
vÆid_öåa_mode
(
Sli˚
 *
cuºSli˚
, 
ùmode
);

82 
öô_md_be°
(
Be°Mode
 *
be°
);

85 
˛ór_rd›t
 (
Sli˚
 *
cuºSli˚
);

86 
öô_rd›t
 (
Sli˚
 *
cuºSli˚
);

88 
Upd©ePixñM≠
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
);

90 
upd©e_qp_cbp
 (
Ma¸oblock
 *
cuºMB
);

91 
upd©e_qp_cbp_tmp
 (
Ma¸oblock
 *
cuºMB
, 
cbp
);

93 
Æloc_rd8x8d©a
 (
RD_8x8DATA
 *
rd_d©a
);

94 
‰ì_rd8x8d©a
 (
RD_8x8DATA
 *
rd_d©a
);

96 
ª°‹e_nz_c€ff
(
Ma¸oblock
 *
cuºMB
);

98 
íd_ícode_⁄e_ma¸oblock
(
Ma¸oblock
 *
cuºMB
);

100 
ícode_⁄e_ma¸oblock_low
 (
Ma¸oblock
 *
cuºMB
);

101 
ícode_⁄e_ma¸oblock_high
 (
Ma¸oblock
 *
cuºMB
);

102 
ícode_⁄e_ma¸oblock_highÁ°
 (
Ma¸oblock
 *
cuºMB
);

103 
ícode_⁄e_ma¸oblock_highloss
 (
Ma¸oblock
 *
cuºMB
);

105 
°‹e_8x8_mŸi⁄_ve˘‹s_p_¶i˚
 (
Sli˚
 *
cuºSli˚
, 
dú
, 
block8x8
, 
Info8x8
 *
B8x8Info
);

106 
°‹e_8x8_mŸi⁄_ve˘‹s_b_¶i˚
 (
Sli˚
 *
cuºSli˚
, 
dú
, 
block8x8
, 
Info8x8
 *
B8x8Info
);

108 
£t_modes_™d_ªfs_f‹_blocks_p_¶i˚
(
Ma¸oblock
 *
cuºMB
, 
mode
);

109 
£t_modes_™d_ªfs_f‹_blocks_b_¶i˚
(
Ma¸oblock
 *
cuºMB
, 
mode
);

110 
£t_modes_™d_ªfs_f‹_blocks_i_¶i˚
(
Ma¸oblock
 *
cuºMB
, 
mode
);

112 
£t_c€ff_™d_ªc⁄_8x8_p_¶i˚
 (
Ma¸oblock
* 
cuºMB
);

113 
£t_c€ff_™d_ªc⁄_8x8_b_¶i˚
 (
Ma¸oblock
* 
cuºMB
);

115 
Info8x8
 
öô_öfo_8x8_°ru˘
();

123 
ölöe
 
	$c›y_4x4block
(
img≥l
 **
oblock
, img≥»**
iblock
, 
o_xoff£t
, 
i_xoff£t
)

125 
y
;

126 
y
 = 0; y < 
BLOCK_SIZE
; y++)

128 
	`mem˝y
(&
oblock
[
y
][
o_xoff£t
],&
iblock
[y][
i_xoff£t
], 
BLOCK_SIZE
 * (
img≥l
));

130 
	}
}

	@lencod/inc/rdopt_coding_state.h

19 #i‚de‡
_RD_OPT_CS_H_


20 
	#_RD_OPT_CS_H_


	)

22 
	scodög_°©e
 {

25 
	mno_∑π
;

26 
Bô°ªam
 *
	mbô°ªam
;

27 
EncodögEnvú⁄mít
 *
	mí˚nv
;

30 
MŸi⁄InfoC⁄ãxts
 *
	mmŸ_˘x
;

31 
TextuªInfoC⁄ãxts
 *
	mãx_˘x
;

34 
BôCou¡î
 
	mbôs
;

37 
	mmvd
[2][
BLOCK_MULTIPLE
][BLOCK_MULTIPLE][2];

38 
öt64
 
	mcbp_bôs
[3];

39 
öt64
 *
	mcbp_bôs_8x8
;

42 
codög_°©e
 
	tCSobj
;

44 
dñëe_codög_°©e
 (
CSobj
 *);

45 
CSobj
 *
¸óã_codög_°©e
 (
I≈utP¨amëîs
 *
p_I≈
);

47 
öô_codög_°©e_mëhods
(
Sli˚
 *
cuºSli˚
);

49 
°‹e_codög_°©e_ˇvlc
 (
Ma¸oblock
 *
cuºMB
, 
CSobj
 *
cs
);

50 
ª£t_codög_°©e_ˇvlc
 (
Ma¸oblock
 *
cuºMB
, 
CSobj
 *
cs
);

	@lencod/inc/rdoq.h

17 #i‚de‡
_RDOQ_H_


18 
	#_RDOQ_H_


	)

20 
	~<m©h.h
>

23 
	#SIGN_BITS
 1

	)

25 c⁄° 
	ge°Eº4x4
[6][4][4] =

65 c⁄° 
	ge°Eº8x8
[6][8][8]={

129 
	se°_bôs_ˇbac


131 
	msignifiˇ¡Bôs
[16][2];

132 
	mœ°Bôs
[16][2];

133 
	mgª©îO√Bôs
[2][5][2];

134 
	mgª©îO√Sèã
[5];

135 
	mblockCbpBôs
[4][2];

137 
e°_bôs_ˇbac
 
	te°BôsCabacSåu˘
;

139 
	sÀvñ_d©a_°ru˘


141 
	mÀvñ
[3];

142 
	mÀvñDoubÀ
;

143 
	mîrLevñ
[3];

144 
	mnoLevñs
;

145 
	mc€ff_˘r
;

146 
	m¥e_Àvñ
;

147 
	msign
;

148 } 
	tÀvñD©aSåu˘
;

151 
öô_rdoq_¶i˚
(
Sli˚
 *
cuºSli˚
);

154 
e°_RunLevñ_CAVLC
(
Ma¸oblock
 *
cuºMB
, 
ÀvñD©aSåu˘
 *
ÀvñD©a
, *
ÀvñTªŒis
, 
block_ty≥
,

155 
b8
, 
b4
, 
c€ff_num
, 
œmbda
);

156 
e°_CAVLC_bôs
 (
VideoP¨amëîs
 *
p_Vid
, 
Àvñ_to_íc
[16], 
sign_to_íc
[16], 
¬z
, 
block_ty≥
);

159 
¥eˇlcuœã_u«ry_exp_gﬁomb_Àvñ
(
VideoP¨amëîs
 *
p_Vid
);

160 
e°_u«ry_exp_gﬁomb_Àvñ_bôs
(
symbﬁ
, 
bôs0
, 
bôs1
);

161 
e°_exp_gﬁomb_ícode_eq_¥ob
 (
symbﬁ
);

163 
e°RunLevñ_CABAC
 (
Ma¸oblock
* 
cuºMB
, 
c⁄ãxt
);

167 
e°_wrôe_™d_°‹e_CBP_block_bô
(
Ma¸oblock
* 
cuºMB
, 
ty≥
);

168 
e°_wrôeRunLevñ_CABAC
(
Ma¸oblock
 *
cuºMB
, 
ÀvñD©aSåu˘
 
ÀvñD©a
[], 
ÀvñTabMö
[], 
ty≥
, 
œmbda
, 
kSèπ
,

169 
kSt›
, 
noC€ff
, 
e°CBP
);

170 
öô_åñlis_d©a_4x4_CAVLC
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
block_x
, 
qp_≥r
, 
qp_ªm
,

171 
LevñQu™tP¨ams
 **
q_∑øms_4x4
, c⁄° 
byã
 *
p_sˇn
,

172 
ÀvñD©aSåu˘
 *
d©aLevñ
, 
ty≥
);

173 
öô_åñlis_d©a_4x4_CABAC
(
Ma¸oblock
 *
cuºMB
, **
tblock
,

174 
qu™t_mëhods
 *
q_mëhod
, c⁄° 
byã
 *
p_sˇn
,

175 
ÀvñD©aSåu˘
 *
d©aLevñ
, * 
kSèπ
, * 
kSt›
, 
ty≥
);

176 
öô_åñlis_d©a_8x8_CAVLC
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
block_x
, 
qp_≥r
, 
qp_ªm
,

177 
LevñQu™tP¨ams
 **
q_∑øms_8x8
, c⁄° 
byã
 *
p_sˇn
,

178 
ÀvñD©aSåu˘
 
ÀvñD©a
[4][16]);

179 
öô_åñlis_d©a_8x8_CABAC
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
block_x
, 
qp_≥r
, 
qp_ªm
,

180 
LevñQu™tP¨ams
 **
q_∑øms_8x8
, c⁄° 
byã
 *
p_sˇn
,

181 
ÀvñD©aSåu˘
 *
d©aLevñ
, * 
kSèπ
, * 
kSt›
);

182 
öô_åñlis_d©a_DC_CAVLC
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qp_≥r
, 
qp_ªm
,

183 
LevñQu™tP¨ams
 *
q_∑øms_4x4
, c⁄° 
byã
 *
p_sˇn
,

184 
ÀvñD©aSåu˘
 *
d©aLevñ
);

185 
öô_åñlis_d©a_DC_CABAC
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qp_≥r
, 
qp_ªm
,

186 
LevñQu™tP¨ams
 *
q_∑øms_4x4
, c⁄° 
byã
 *
p_sˇn
,

187 
ÀvñD©aSåu˘
 *
d©aLevñ
, * 
kSèπ
, * 
kSt›
);

188 
öô_åñlis_d©a_DC_¸_CAVLC
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qp_≥r
, 
qp_ªm
,

189 
LevñQu™tP¨ams
 *
q_∑øms_4x4
, c⁄° 
byã
 *
p_sˇn
,

190 
ÀvñD©aSåu˘
 *
d©aLevñ
);

191 
öô_åñlis_d©a_DC_¸_CABAC
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qp_≥r
, 
qp_ªm
,

192 
LevñQu™tP¨ams
 *
q_∑øms_4x4
, c⁄° 
byã
 *
p_sˇn
,

193 
ÀvñD©aSåu˘
 *
d©aLevñ
, * 
kSèπ
, * 
kSt›
);

195 
RDOQ_upd©e_mode
 (
Sli˚
 *
cuºSli˚
, 
RD_PARAMS
 *
íc_mb
);

196 
c›y_rdd©a_åñlis
 (
Ma¸oblock
 *
cuºMB
, 
RD_DATA
 *
de°
, RD_DATA *
§c
);

197 
upd©eMV_mp
 (
Ma¸oblock
 *
cuºMB
, 
di°blk
 *
m_co°
, 
ªf
, 
li°
, 
h
, 
v
, 
blockty≥
, 
block8x8
);

198 
åñlis_codög
 (
Ma¸oblock
 *
cuºMB
);

199 
gë_dQP_èbÀ
 (
Sli˚
 *
cuºSli˚
);

	@lencod/inc/refbuf.h

10 #i‚de‡
_REBUF_H_


11 
	#_REBUF_H_


	)

13 
	~"mbuf„r.h
"

22 
ölöe
 
img≥l
 *
	$UMVLöe4X
 (
St‹abÀPi˘uª
 *
ªf
, 
y
, 
x
)

25  &(
ªf
->
p_cuº_img_sub
[(
y
 & 0x03)][(
x
 & 0x03)][
	`iClù3
–-
IMG_PAD_SIZE_Y
,Ñef->
size_y_∑d
, y >> 2)][iClù3(-
IMG_PAD_SIZE_X
,Ñef->
size_x_∑d
, x >> 2)]);

26 
	}
}

35 
ölöe
 
img≥l
 *
	$UMVLöe4X¸
 (
St‹abÀPi˘uª
 *
ªf
, 
cmp
, 
y
, 
x
)

38  &(
ªf
->
p_img_sub
[
cmp
][(
y
 & 0x03)][(
x
 & 0x03)][
	`iClù3
(-ªf->
∑d_size_uv_y
,Ñef->
size_y_¸_∑d
, y >> 2)][iClù3(-ªf->
∑d_size_uv_x
,Ñef->
size_x_¸_∑d
, x >> 2)]);

39 
	}
}

48 
ölöe
 
img≥l
 *
	$Fa°Löe4X
 (
St‹abÀPi˘uª
 *
ªf
, 
y
, 
x
)

50  &(
ªf
->
p_cuº_img_sub
[(
y
 & 0x03)][(
x
 & 0x03)][y >> 2][x >> 2]);

51 
	}
}

61 
ölöe
 
img≥l
 *
	$UMVLöe8X_chroma
 (
St‹abÀPi˘uª
 *
ªf
, 
cmp
, 
y
, 
x
)

64  &(
ªf
->
p_img_sub
[
cmp
][
y
 &Ñef->
chroma_mask_mv_y
][
x
 &Ñef->
chroma_mask_mv_x
][
	`iClù3
 (-ªf->
∑d_size_uv_y
,Ñef->
size_y_¸_∑d
, y >>Ñef->
chroma_shi·_y
)][iClù3 (-ªf->
∑d_size_uv_x
,Ñef->
size_x_¸_∑d
, x >>Ñef->
chroma_shi·_x
)]);

65 
	}
}

75 
ölöe
 
img≥l
 *
	$Fa°Löe8X_chroma
 (
St‹abÀPi˘uª
 *
ªf
, 
cmp
, 
y
, 
x
)

77  &(
ªf
->
p_img_sub
[
cmp
][
y
 &Ñef->
chroma_mask_mv_y
][
x
 &Ñef->
chroma_mask_mv_x
][y >>Ñef->
chroma_shi·_y
][x >>Ñef->
chroma_shi·_x
]);

78 
	}
}

	@lencod/inc/refbuf_otf.h

10 #i‚de‡
_REBUF_OTF_H_


11 
	#_REBUF_OTF_H_


	)

13 
	~"mbuf„r.h
"

15 
ölöe
 
img≥l
 *
	$UMVLöe4X_Ÿf
 (
St‹abÀPi˘uª
 *
ªf
, 
y
, 
x
 )

17  &(
ªf
->
p_cuº_img_sub
[(
y
 & 0x03)>>1][(
x
 & 0x03)>>1][
	`iClù3
–-
IMG_PAD_SIZE_Y
,Ñef->
size_y_∑d
, y >> 2)][iClù3(-
IMG_PAD_SIZE_X
,Ñef->
size_x_∑d
, x >> 2)]);

18 
	}
}

20 
ölöe
 
img≥l
 *
	$UMVLöe4X¸_Ÿf
 (
St‹abÀPi˘uª
 *
ªf
, 
cmp
, 
y
, 
x
)

22  &(
ªf
->
p_img_sub
[
cmp
][(
y
 & 0x03)>>1][(
x
 & 0x03)>>1][
	`iClù3
(-ªf->
∑d_size_uv_y
,Ñef->
size_y_¸_∑d
, y >> 2)][iClù3(-ªf->
∑d_size_uv_x
,Ñef->
size_x_¸_∑d
, x >> 2)]);

23 
	}
}

25 
ölöe
 
img≥l
 *
	$UMVLöe8X_chroma_Ÿf
 (
St‹abÀPi˘uª
 *
ªf
, 
cmp
, 
y
, 
x
)

27  &(
ªf
->
p_img_sub
[
cmp
][(
y
 &Ñef->
chroma_mask_mv_y
)>>1][(
x
 &Ñef->
chroma_mask_mv_x
)>>1][
	`iClù3
 (-ªf->
∑d_size_uv_y
,Ñef->
size_y_¸_∑d
, y >>Ñef->
chroma_shi·_y
)][iClù3 (-ªf->
∑d_size_uv_x
,Ñef->
size_x_¸_∑d
, x >>Ñef->
chroma_shi·_x
)]);

28 
	}
}

	@lencod/inc/rtp.h

18 #i‚de‡
_RTP_H_


19 
	#_RTP_H_


	)

21 
	~"«lu.h
"

23 
	#MAXRTPPAYLOADLEN
 (65536 - 40)

24 
	#MAXRTPPACKETSIZE
 (65536 - 28)

25 
	#H264PAYLOADTYPE
 105

26 
	#H264SSRC
 0x12345678

27 
	#RTP_TR_TIMESTAMP_MULT
 1000

28 

	)

31 
	mv
;

32 
	mp
;

33 
	mx
;

34 
	mcc
;

36 
	mm
;

37 
	m±
;

38 
	m£q
;

40 
	mtime°amp
;

41 
	ms§c
;

42 
byã
 * 
	m∑ylﬂd
;

43 
	m∑yÀn
;

44 
byã
 * 
	m∑ckë
;

45 
	m∑ckÀn
;

46 } 
	tRTP∑ckë_t
;

48 
RTPUpd©eTime°amp
 (
VideoP¨amëîs
 *
p_Vid
, 
å
);

49 
O≥nRTPFûe
 (*
Fûíame
, 
FILE
 **
f_πp
);

50 
Clo£RTPFûe
 (
FILE
 *
f_πp
);

51 
WrôeRTPNALU
 (
VideoP¨amëîs
 *
p_Vid
, 
NALU_t
 *
n
, 
FILE
 **
f_πp
);

	@lencod/inc/sei.h

15 #i‚de‡
SEI_H


16 
	#SEI_H


	)

18 
	#MAX_LAYER_NUMBER
 2

	)

19 
	#MAX_DEPENDENT_SUBSEQ
 5

	)

21 
	#MAX_CODED_BIT_DEPTH
 12

	)

22 
	#MAX_SEI_BIT_DEPTH
 12

	)

23 
	#MAX_NUM_PIVOTS
 (1<<
MAX_CODED_BIT_DEPTH
)

	)

26 
	#MAX_CPB_CNT_MINUS1
 31

	)

27 
	#MAX_PIC_STRUCT_VALUE
 16

	)

28 
	#MAX_FN
 256

	)

30 
	#AGGREGATION_PACKET_TYPE
 4

	)

31 
	#SEI_PACKET_TYPE
 5

32 

	)

33 
	#NORMAL_SEI
 0

	)

34 
	#AGGREGATION_SEI
 1

	)

39 
	mSEI_BUFFERING_PERIOD
 = 0,

40 
	mSEI_PIC_TIMING
,

41 
	mSEI_PAN_SCAN_RECT
,

42 
	mSEI_FILLER_PAYLOAD
,

43 
	mSEI_USER_DATA_REGISTERED_ITU_T_T35
,

44 
	mSEI_USER_DATA_UNREGISTERED
,

45 
	mSEI_RECOVERY_POINT
,

46 
	mSEI_DEC_REF_PIC_MARKING_REPETITION
,

47 
	mSEI_SPARE_PIC
,

48 
	mSEI_SCENE_INFO
,

49 
	mSEI_SUB_SEQ_INFO
,

50 
	mSEI_SUB_SEQ_LAYER_CHARACTERISTICS
,

51 
	mSEI_SUB_SEQ_CHARACTERISTICS
,

52 
	mSEI_FULL_FRAME_FREEZE
,

53 
	mSEI_FULL_FRAME_FREEZE_RELEASE
,

54 
	mSEI_FULL_FRAME_SNAPSHOT
,

55 
	mSEI_PROGRESSIVE_REFINEMENT_SEGMENT_START
,

56 
	mSEI_PROGRESSIVE_REFINEMENT_SEGMENT_END
,

57 
	mSEI_MOTION_CONSTRAINED_SLICE_GROUP_SET
,

58 
	mSEI_FILM_GRAIN_CHARACTERISTICS
,

59 
	mSEI_DEBLOCKING_FILTER_DISPLAY_PREFERENCE
,

60 
	mSEI_STEREO_VIDEO_INFO
,

61 
	mSEI_POST_FILTER_HINTS
,

62 
	mSEI_TONE_MAPPING
,

63 
	mSEI_SCALABILITY_INFO
,

64 
	mSEI_SUB_PIC_SCALABLE_LAYER
,

65 
	mSEI_NON_REQUIRED_LAYER_REP
,

66 
	mSEI_PRIORITY_LAYER_INFO
,

67 
	mSEI_LAYERS_NOT_PRESENT
,

68 
	mSEI_LAYER_DEPENDENCY_CHANGE
,

69 
	mSEI_SCALABLE_NESTING
,

70 
	mSEI_BASE_LAYER_TEMPORAL_HRD
,

71 
	mSEI_QUALITY_LAYER_INTEGRITY_CHECK
,

72 
	mSEI_REDUNDANT_PIC_PROPERTY
,

73 
	mSEI_TL0_DEP_REP_INDEX
,

74 
	mSEI_TL_SWITCHING_POINT
,

75 
	mSEI_PARALLEL_DECODING_INFO
,

76 
	mSEI_MVC_SCALABLE_NESTING
,

77 
	mSEI_VIEW_SCALABILITY_INFO
,

78 
	mSEI_MULTIVIEW_SCENE_INFO
,

79 
	mSEI_MULTIVIEW_ACQUISITION_INFO
,

80 
	mSEI_NON_REQUIRED_VIEW_COMPONENT
,

81 
	mSEI_VIEW_DEPENDENCY_CHANGE
,

82 
	mSEI_OPERATION_POINTS_NOT_PRESENT
,

83 
	mSEI_BASE_VIEW_TEMPORAL_HRD
,

84 
	mSEI_FRAME_PACKING_ARRANGEMENT
,

86 
	mSEI_MAX_ELEMENTS


87 } 
	tSEI_ty≥
;

91 
	m£q_∑ømëî_£t_id
;

92 
	m«l_öôül_˝b_ªmovÆ_dñay
[
MAX_CPB_CNT_MINUS1
+1];

93 
	m«l_öôül_˝b_ªmovÆ_dñay_off£t
[
MAX_CPB_CNT_MINUS1
+1];

94 
	mv˛_öôül_˝b_ªmovÆ_dñay
[
MAX_CPB_CNT_MINUS1
+1];

95 
	mv˛_öôül_˝b_ªmovÆ_dñay_off£t
[
MAX_CPB_CNT_MINUS1
+1];

97 
Bô°ªam
 *
	md©a
;

98 
	m∑ylﬂdSize
;

99 } 
	tbuf„rög≥riod_öf‹m©i⁄_°ru˘
;

104 
Boﬁón
 
	mavaûabÀ
;

105 
	m∑ylﬂdSize
;

106 
	msubPackëTy≥
;

107 
byã
* 
	md©a
;

108 } 
	t£i_°ru˘
;

113 
	mèrgë_‰ame_num
;

114 
	mnum_•¨e_pics
;

115 
	m∑ylﬂdSize
;

116 
Bô°ªam
* 
	md©a
;

117 } 
	t•¨e_pi˘uª_°ru˘
;

122 
	msub£q_œyî_num
;

123 
	msub£q_id
;

124 
	mœ°_pi˘uª_Êag
;

125 
	m°‹ed_‰ame_˙t
;

127 
	m∑ylﬂdSize
;

128 
Bô°ªam
* 
	md©a
;

129 } 
	tsub£q_öf‹m©i⁄_°ru˘
;

134 
uöt16
 
	mbô_øã
[
MAX_LAYER_NUMBER
];

135 
uöt16
 
	m‰ame_øã
[
MAX_LAYER_NUMBER
];

136 
byã
 
	md©a
[4*
MAX_LAYER_NUMBER
];

137 
	mœyî_numbî
;

138 
	m∑ylﬂdSize
;

139 } 
	tsub£q_œyî_öf‹m©i⁄_°ru˘
;

144 
	msub£q_œyî_num
;

145 
	msub£q_id
;

146 
	mduøti⁄_Êag
;

147 
	msub£q_duøti⁄
;

148 
	mavîage_øã_Êag
;

149 
	mavîage_bô_øã
;

150 
	mavîage_‰ame_øã
;

151 
	mnum_ª„ªn˚d_sub£qs
;

152 
	mªf_sub£q_œyî_num
[
MAX_DEPENDENT_SUBSEQ
];

153 
	mªf_sub£q_id
[
MAX_DEPENDENT_SUBSEQ
];

155 
Bô°ªam
* 
	md©a
;

156 
	m∑ylﬂdSize
;

157 } 
	tsub£q_ch¨_öf‹m©i⁄_°ru˘
;

161 
	ms˚√_id
;

162 
	ms˚√_å™sôi⁄_ty≥
;

163 
	m£c⁄d_s˚√_id
;

165 
Bô°ªam
* 
	md©a
;

166 
	m∑ylﬂdSize
;

167 } 
	ts˚√_öf‹m©i⁄_°ru˘
;

172 
	m∑n_sˇn_ª˘_id
;

173 
	m∑n_sˇn_ª˘_ˇn˚l_Êag
;

174 
	m∑n_sˇn_˙t_möus1
;

175 
	m∑n_sˇn_ª˘_À·_off£t
[3];

176 
	m∑n_sˇn_ª˘_right_off£t
[3];

177 
	m∑n_sˇn_ª˘_t›_off£t
[3];

178 
	m∑n_sˇn_ª˘_bŸtom_off£t
[3];

179 
	m∑c_sˇn_ª˘_ª≥tôi⁄_≥riod
;

181 
Bô°ªam
 *
	md©a
;

182 
	m∑ylﬂdSize
;

183 } 
	t∑nsˇƒe˘_öf‹m©i⁄_°ru˘
;

187 *
	mbyã
;

188 
	mtŸÆ_byã
;

189 
Bô°ªam
 *
	md©a
;

190 
	m∑ylﬂdSize
;

191 } 
	tu£r_d©a_uƒegi°îed_öf‹m©i⁄_°ru˘
;

196 *
	mbyã
;

197 
	mtŸÆ_byã
;

198 
	môu_t_t35_cou¡ry_code
;

199 
	môu_t_t35_cou¡ry_code_exãnsi⁄_byã
;

200 
Bô°ªam
 *
	md©a
;

201 
	m∑ylﬂdSize
;

202 } 
	tu£r_d©a_ªgi°îed_ôu_t_t35_öf‹m©i⁄_°ru˘
;

207 
	mªcovîy_‰ame_˙t
;

208 
	mexa˘_m©ch_Êag
;

209 
	mbrokí_lök_Êag
;

210 
	mch™gög_¶i˚_group_idc
;

212 
Bô°ªam
 *
	md©a
;

213 
	m∑ylﬂdSize
;

214 } 
	tªcovîy_poöt_öf‹m©i⁄_°ru˘
;

219 
	m˝b_ªmovÆ_dñay
;

220 
	mdpb_ouçut_dñay
;

221 
	mpic_°ru˘
;

222 
Boﬁón
 
	m˛ock_time°amp_Êag
[
MAX_PIC_STRUCT_VALUE
];

223 
	m˘_ty≥
;

224 
Boﬁón
 
	mnuô_fõld_ba£d_Êag
;

225 
	mcou¡ög_ty≥
;

226 
Boﬁón
 
	mfuŒ_time°amp_Êag
;

227 
Boﬁón
 
	mdisc⁄töuôy_Êag
;

228 
Boﬁón
 
	m˙t_dr›≥d_Êag
;

229 
	mn_‰ames
;

230 
	m£c⁄ds_vÆue
;

231 
	mmöuãs_vÆue
;

232 
	mhours_vÆue
;

233 
Boﬁón
 
	m£c⁄ds_Êag
;

234 
Boﬁón
 
	mmöuãs_Êag
;

235 
Boﬁón
 
	mhours_Êag
;

236 
	mtime_off£t
;

238 
Bô°ªam
 *
	md©a
;

239 
	m∑ylﬂdSize
;

240 } 
	tpi˘imög_öf‹m©i⁄_°ru˘
;

246 
Boﬁón
 
	m‹igöÆ_idr_Êag
;

247 
	m‹igöÆ_‰ame_num
;

248 
Boﬁón
 
	m‹igöÆ_fõld_pic_Êag
;

249 
Boﬁón
 
	m‹igöÆ_bŸtom_fõld_Êag
;

250 
DecRefPicM¨kög_t
 *
	mdec_ªf_pic_m¨kög_buf„r_ßved
;

252 
Bô°ªam
 *
	md©a
;

253 
	m∑ylﬂdSize
;

254 } 
	tdΩm_ª≥tôi⁄_öf‹m©i⁄_°ru˘
;

260 
	m‰ame_∑ckög_¨øngemít_id
;

261 
Boﬁón
 
	m‰ame_∑ckög_¨øngemít_ˇn˚l_Êag
;

262 
	m‰ame_∑ckög_¨øngemít_ty≥
;

263 
Boﬁón
 
	mquöcunx_ßm∂ög_Êag
;

264 
	mc⁄ã¡_öãΩªèti⁄_ty≥
;

265 
Boﬁón
 
	m•©ül_Êùpög_Êag
;

266 
Boﬁón
 
	m‰ame0_Êù≥d_Êag
;

267 
Boﬁón
 
	mfõld_võws_Êag
;

268 
Boﬁón
 
	mcuºít_‰ame_is_‰ame0_Êag
;

269 
Boﬁón
 
	m‰ame0_£lf_c⁄èöed_Êag
;

270 
Boﬁón
 
	m‰ame1_£lf_c⁄èöed_Êag
;

271 
	m‰ame0_grid_posôi⁄_x
;

272 
	m‰ame0_grid_posôi⁄_y
;

273 
	m‰ame1_grid_posôi⁄_x
;

274 
	m‰ame1_grid_posôi⁄_y
;

275 
	m‰ame_∑ckög_¨øngemít_ª£rved_byã
;

276 
	m‰ame_∑ckög_¨øngemít_ª≥tôi⁄_≥riod
;

277 
Boﬁón
 
	m‰ame_∑ckög_¨øngemít_exãnsi⁄_Êag
;

279 
Bô°ªam
 *
	md©a
;

280 
	m∑ylﬂdSize
;

281 } 
	t‰ame_∑ckög_¨øngemít_öf‹m©i⁄_°ru˘
;

287 
	mfûãr_höt_size_y
;

288 
	mfûãr_höt_size_x
;

289 
	mfûãr_höt_ty≥
;

290 ***
	mfûãr_höt
;

291 
	maddôi⁄Æ_exãnsi⁄_Êag
;

293 
Bô°ªam
 *
	md©a
;

294 
	m∑ylﬂdSize
;

295 } 
	tpo°_fûãr_öf‹m©i⁄_°ru˘
;

299 
	mt⁄e_m≠_id
;

300 
	mt⁄e_m≠_ˇn˚l_Êag
;

301 
	mt⁄e_m≠_ª≥tôi⁄_≥riod
;

302 
	mcoded_d©a_bô_dïth
;

303 
	m£i_bô_dïth
;

304 
	mmodñ_id
;

306 
	mmö_vÆue
;

307 
	mmax_vÆue
;

309 
	msigmoid_midpoöt
;

310 
	msigmoid_width
;

312 
	m°¨t_of_coded_öãrvÆ
[1<<
MAX_SEI_BIT_DEPTH
];

314 
	mnum_pivŸs
;

315 
	mcoded_pivŸ_vÆue
[
MAX_NUM_PIVOTS
];

316 
	m£i_pivŸ_vÆue
[
MAX_NUM_PIVOTS
];

318 
Bô°ªam
 *
	md©a
;

319 
	m∑ylﬂdSize
;

320 } 
	tT⁄eM≠pögSEI
;

323 
	s£i_∑øms
 {

324 
Boﬁón
 
	m£iHasDRPMRïëôi⁄_öfo
;

325 
dΩm_ª≥tôi⁄_öf‹m©i⁄_°ru˘
 
	m£iDRPMRïëôi⁄
;

329 
£i_°ru˘
 
	m£i_mesßge
[2];

330 
Boﬁón
 
	m£iHasS∑ªPi˘uª
;

332 
•¨e_pi˘uª_°ru˘
 
	m£iS∑ªPi˘uªPaylﬂd
;

333 
Boﬁón
 
	m£iHasSub£qInfo
;

334 
sub£q_öf‹m©i⁄_°ru˘
 
	m£iSub£qInfo
[
MAX_LAYER_NUMBER
];

335 
Boﬁón
 
	m£iHasSub£qLayîInfo
;

336 
sub£q_œyî_öf‹m©i⁄_°ru˘
 
	m£iSub£qLayîInfo
;

337 
Boﬁón
 
	m£iHasSub£qCh¨
;

338 
sub£q_ch¨_öf‹m©i⁄_°ru˘
 
	m£iSub£qCh¨
;

339 
Boﬁón
 
	m£iHasS˚√Inf‹m©i⁄
;

340 
s˚√_öf‹m©i⁄_°ru˘
 
	m£iS˚√Inf‹m©i⁄
;

341 
Boﬁón
 
	m£iHasP™SˇnRe˘Info
;

342 
∑nsˇƒe˘_öf‹m©i⁄_°ru˘
 
	m£iP™SˇnRe˘Info
;

343 
Boﬁón
 
	m£iHasU£r_d©a_uƒegi°îed_öfo
;

344 
u£r_d©a_uƒegi°îed_öf‹m©i⁄_°ru˘
 
	m£iU£r_d©a_uƒegi°îed
;

345 
Boﬁón
 
	m£iHasU£r_d©a_ªgi°îed_ôu_t_t35_öfo
;

346 
u£r_d©a_ªgi°îed_ôu_t_t35_öf‹m©i⁄_°ru˘
 
	m£iU£r_d©a_ªgi°îed_ôu_t_t35
;

347 
Boﬁón
 
	m£iHasRecovîyPoöt_öfo
;

348 
ªcovîy_poöt_öf‹m©i⁄_°ru˘
 
	m£iRecovîyPoöt
;

349 
Boﬁón
 
	m£iHasBuf„rögPîiod_öfo
;

350 
buf„rög≥riod_öf‹m©i⁄_°ru˘
 
	m£iBuf„rögPîiod
;

351 
Boﬁón
 
	m£iHasPicTimög_öfo
;

352 
pi˘imög_öf‹m©i⁄_°ru˘
 
	m£iPicTimög
;

353 
Boﬁón
 
	m£iHasFømePackögAº™gemít_öfo
;

354 
‰ame_∑ckög_¨øngemít_öf‹m©i⁄_°ru˘
 
	m£iFømePackögAº™gemít
;

356 
Boﬁón
 
	m£iHasT⁄e_m≠pög
;

357 
T⁄eM≠pögSEI
 
	m£iT⁄eM≠pög
;

358 
Boﬁón
 
	m£iHasPo°FûãrHöts_öfo
;

359 
po°_fûãr_öf‹m©i⁄_°ru˘
 
	m£iPo°FûãrHöts
;

361 
Boﬁón
 
	m£iHasTemp‹Æ_ª„ªn˚
;

362 
Boﬁón
 
	m£iHasClock_time°amp
;

363 
Boﬁón
 
	m£iHasP™sˇn_ª˘
;

364 
Boﬁón
 
	m£iHasHrd_pi˘uª
;

365 
Boﬁón
 
	m£iHasFûÀr_∑ylﬂd
;

366 
Boﬁón
 
	m£iHasU£r_d©a_ªgi°îed_ôu_t_t35
;

367 
Boﬁón
 
	m£iHasU£r_d©a_uƒegi°îed
;

368 
Boﬁón
 
	m£iHasRef_pic_buf„r_m™agemít_ª≥tôi⁄
;

369 
Boﬁón
 
	m£iHasS∑ª_pi˘uª
;

370 
Boﬁón
 
	m£iHasSub£q_öf‹m©i⁄
;

371 
Boﬁón
 
	m£iHasSub£q_œyî_ch¨a˘îi°ics
;

372 
Boﬁón
 
	m£iHasSub£q_ch¨a˘îi°ics
;

376 
£i_∑øms
 
	tSEIP¨amëîs
;

379 
InôSEIMesßges
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
);

380 
Clo£SEIMesßges
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
);

381 
Boﬁón
 
HaveAggªg©i⁄SEI
(
VideoP¨amëîs
 *
p_Vid
);

383 
˛ór_£i_mesßge
 (
SEIP¨amëîs
 *
p_SEI
, 
id
);

384 
AµídTmpbôs2Buf
 ( 
Bô°ªam
* 
de°
, Bô°ªam* 
sour˚
 );

385 
Pª∑ªAggªg©i⁄SEIMesßge
(
VideoP¨amëîs
 *
p_Vid
);

386 
CÆcuœãS∑ªPi˘uª
();

387 
Boﬁón
 
Com¥essS∑ªMBM≠
(
VideoP¨amëîs
 *
p_Vid
, **
m≠_•
, 
Bô°ªam
 *
bô°ªam
);

389 
InôSub£qInfo
(
SEIP¨amëîs
 *
p_SEI
, 
cuºLayî
);

390 
Upd©eSub£qInfo
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
cuºLayî
);

391 
Clo£Sub£qInfo
 (
SEIP¨amëîs
 *
p_SEI
, 
cuºLayî
);

392 
Clo£Sub£qLayîInfo
();

393 
Upd©eSub£qCh¨
(
VideoP¨amëîs
 *
p_Vid
);

395 
InôS˚√Inf‹m©i⁄
 (
SEIP¨amëîs
 *
p_SEI
);

396 
Clo£S˚√Inf‹m©i⁄
 (
SEIP¨amëîs
 *
p_SEI
);

397 
Upd©eS˚√Inf‹m©i⁄
 (
SEIP¨amëîs
 *
p_SEI
, 
Boﬁón
 
HasS˚√Inf‹m©i⁄
, 
s˚√ID
, 
s˚√TønsTy≥
, 
£c⁄dS˚√ID
);

398 
FöÆizeS˚√Inf‹m©i⁄
 (
SEIP¨amëîs
 *
p_SEI
);

399 
Upd©eP™SˇnRe˘Info
 (
VideoP¨amëîs
 *
p_Vid
);

400 
CÀ¨P™SˇnRe˘InfoPaylﬂd
 (
SEIP¨amëîs
 *
p_SEI
);

402 
Upd©eU£r_d©a_uƒegi°îed
(
SEIP¨amëîs
 *
p_SEI
);

403 
Upd©eU£r_d©a_ªgi°îed_ôu_t_t35
(
SEIP¨amëîs
 *
p_SEI
);

405 
CÀ¨R™domAc˚ss
(
SEIP¨amëîs
 *
p_SEI
);

406 
Upd©eR™domAc˚ss
(
VideoP¨amëîs
 *
p_Vid
);

408 
Upd©eT⁄eM≠pög
(
SEIP¨amëîs
 *
p_SEI
);

410 
öô_£i
(
SEIP¨amëîs
 *
p_SEI
);

411 
Wrôe_SEI_NALU
(
VideoP¨amëîs
 *
p_Vid
, 
Àn
);

413 
InôBuf„rögPîiod
 (
VideoP¨amëîs
 *
p_Vid
);

414 
CÀ¨Buf„rögPîiod
 (
SEIP¨amëîs
 *
p_SEI
, 
£q_∑ømëî_£t_rb•_t
 *
a˘ive_•s
);

415 
Upd©eBuf„rögPîiod
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
);

417 
CÀ¨PicTimög
(
SEIP¨amëîs
 *
p_SEI
);

418 
Upd©ePicTimög
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
);

420 
CÀ¨DRPMRïëôi⁄
(
SEIP¨amëîs
 *
p_SEI
);

421 
Upd©eDRPMRïëôi⁄
(
SEIP¨amëîs
 *
p_SEI
);

422 
‰ì_dΩm_buf„r
–
DecRefPicM¨kög_t
 *
pDRPM
 );

424 
Upd©ePo°FûãrHöts
(
SEIP¨amëîs
 *
p_SEI
);

426 
Compo£S∑ªPi˘uªMesßge
 (
SEIP¨amëîs
 *
p_SEI
, 
dñè_•¨e_‰ame_num
, 
ªf_¨ó_ödiˇt‹
, 
Bô°ªam
 *
tmpBô°ªam
);

428 
CÀ¨FømePackögAº™gemít
(
SEIP¨amëîs
 *
p_SEI
);

429 
Upd©eFømePackögAº™gemít
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
);

	@lencod/inc/slice.h

20 #i‚de‡
_SLICE_H_


21 
	#_SLICE_H_


	)

23 
	~"globÆ.h
"

24 
	~"mbuf„r.h
"

25 
	~"rd›t_codög_°©e.h
"

27 c⁄° 
	gQP2QUANT
[40]=

37 
ícode_⁄e_¶i˚
 ( 
VideoP¨amëîs
 *
p_Vid
, 
Sli˚GroupId
, 
TŸÆCodedMBs
 );

38 
ícode_⁄e_¶i˚_MBAFF
 ( 
VideoP¨amëîs
 *
p_Vid
, 
Sli˚GroupId
, 
TŸÆCodedMBs
 );

39 
öô_¶i˚
 ( 
VideoP¨amëîs
 *
p_Vid
, 
Sli˚
 **
cuºSli˚
, 
°¨t_mb_addr
 );

40 
öô_¶i˚_lôe
 ( 
VideoP¨amëîs
 *
p_Vid
, 
Sli˚
 **
cuºSli˚
, 
°¨t_mb_addr
 );

41 
‰ì_¶i˚_li°
 ( 
Pi˘uª
 *
cuºPic
 );

43 
SëLagøngünMu…ùlõrsOn
 (
Sli˚
 *
cuºSli˚
);

44 
SëLagøngünMu…ùlõrsOff
(
Sli˚
 *
cuºSli˚
);

45 
‰ì_¶i˚
 (
Sli˚
 *
cuºSli˚
);

	@lencod/inc/symbol.h

16 
	swrôeMB
 {

17 (*
	mwrôeMB_ty≥Info
Ë(
Ma¸oblock
 *
	mcuºMB
, 
Sy¡axEÀmít
 *
	m£
, 
D©aP¨tôi⁄
 *
	mdP
);

18 (*
	mwrôeI¡øPªdMode
Ë(
Sy¡axEÀmít
 *
	m£
, 
D©aP¨tôi⁄
 *
	mdP
);

19 (*
	mwrôeB8_ty≥Info
Ë(
Sy¡axEÀmít
 *
	m£
, 
D©aP¨tôi⁄
 *
	mdP
);

20 (*
	mwrôeRefFøme
[6]Ë(
Ma¸oblock
 *
	mcuºMB
, 
Sy¡axEÀmít
 *
	m£
, 
D©aP¨tôi⁄
 *
	mdP
);

21 (*
	mwrôeMVD
Ë(
Ma¸oblock
 *
	mcuºMB
, 
Sy¡axEÀmít
 *
	m£
, 
D©aP¨tôi⁄
 *
	mdP
);

22 (*
	mwrôeCBP
Ë(
Ma¸oblock
* 
	mcuºMB
, 
Sy¡axEÀmít
 *
	m£
, 
D©aP¨tôi⁄
 *
	mdP
);

23 (*
	mwrôeDqu™t
Ë(
Ma¸oblock
* 
	mcuºMB
, 
Sy¡axEÀmít
 *
	m£
, 
D©aP¨tôi⁄
 *
	mdP
);

24 (*
	mwrôeCIPªdMode
Ë(
Ma¸oblock
* 
	mcuºMB
, 
Sy¡axEÀmít
 *
	m£
, 
D©aP¨tôi⁄
 *
	mdP
);

25 (*
	mwrôeFõldModeInfo
Ë(
Ma¸oblock
 *
	mcuºMB
, 
Sy¡axEÀmít
 *
	m£
, 
D©aP¨tôi⁄
 *
	mdP
);

26 (*
	mwrôeMB_å™sf‹m_size
)(
Ma¸oblock
 *
	mcuºMB
, 
Sy¡axEÀmít
 *
	m£
, 
D©aP¨tôi⁄
 *
	mdP
);

	@lencod/inc/transform8x8.h

18 #i‚de‡
_TRANSFORM8X8_H_


19 
	#_TRANSFORM8X8_H_


	)

20 
mode_decisi⁄_f‹_I8x8_MB
 (
Ma¸oblock
 *
cuºMB
, 
œmbda
, 
di°blk
 *
mö_co°
);

21 
mode_decisi⁄_f‹_I8x8_blocks_JM_Low
 (
Ma¸oblock
 *
cuºMB
, 
b8
, 
œmbda
, 
di°blk
 *
mö_co°
);

22 
mode_decisi⁄_f‹_I8x8_blocks_JM_High
 (
Ma¸oblock
 *
cuºMB
, 
b8
, 
œmbda
, 
di°blk
 *
mö_co°
);

23 
mode_decisi⁄_f‹_I8x8_blocks_JM_Low444
 (
Ma¸oblock
 *
cuºMB
, 
b8
, 
œmbda
, 
di°blk
 *
mö_co°
);

24 
mode_decisi⁄_f‹_I8x8_blocks_JM_High444
(
Ma¸oblock
 *
cuºMB
, 
b8
, 
œmbda
, 
di°blk
 *
mö_co°
);

26 
di°blk
 
rdco°_f‹_8x8_öåa_blocks
 (
Ma¸oblock
 *
cuºMB
, *
c_nz
, 
b8
, 
ùmode
, 
œmbda
, di°blk 
mö_rdco°
, 
mo°ProbabÀMode
);

27 
di°blk
 
rdco°_f‹_8x8_öåa_blocks_444
 (
Ma¸oblock
 *
cuºMB
, *
c_nz
, 
b8
, 
ùmode
, 
œmbda
, di°blk 
mö_rdco°
, 
mo°ProbabÀMode
);

28 
di°blk
 
compuã_ßtd8x8_co°
 (
VideoP¨amëîs
 *
p_Vid
, 
img≥l
 **
cur_img
, img≥»**
m¥8x8
, 
pic_›ix_x
, di°blk 
mö_co°
);

29 
di°blk
 
compuã_s£8x8_co°
 (
VideoP¨amëîs
 *
p_Vid
, 
img≥l
 **
cur_img
, img≥»**
m¥8x8
, 
pic_›ix_x
, di°blk 
mö_co°
);

30 
di°blk
 
compuã_ßd8x8_co°
 (
VideoP¨amëîs
 *
p_Vid
, 
img≥l
 **
cur_img
, img≥»**
m¥8x8
, 
pic_›ix_x
, di°blk 
mö_co°
);

31 
di°blk
 
compuã_comp8x8_co°
 (
VideoP¨amëîs
 *
p_Vid
, 
img≥l
 **
cur_img
, img≥»**
m¥8x8
, 
pic_›ix_x
, di°blk 
mö_co°
);

33 
ªsiduÆ_å™sf‹m_qu™t_luma_8x8
 (
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
b8
, *
c€ff_co°
, 
öåa
);

34 
ªsiduÆ_å™sf‹m_qu™t_luma_8x8_ˇvlc
 (
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
b8
, *
c€ff_co°
, 
öåa
);

35 
ªsiduÆ_å™sf‹m_qu™t_luma_8x8_ls
 (
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
b8
, *
c€ff_co°
, 
öåa
);

	@lencod/inc/vlc.h

13 #i‚de‡
_VLC_H_


14 
	#_VLC_H_


	)

16 
	~"íc_°©i°ics.h
"

18 
Boﬁón
 
wrôe_u_1
 (*
åa˚°rög
, 
vÆue
, 
Bô°ªam
 *
bô°ªam
);

19 
wrôe_£_v
 (*
åa˚°rög
, 
vÆue
, 
Bô°ªam
 *
bô°ªam
);

20 
wrôe_ue_v
 (*
åa˚°rög
, 
vÆue
, 
Bô°ªam
 *
bô°ªam
);

21 
wrôe_u_v
 (
n
, *
åa˚°rög
, 
vÆue
, 
Bô°ªam
 *
bô°ªam
);

23 
Àvrun_löfo_c2x2
(
Àvñ
,
run
,*
Àn
,*
öfo
);

24 
Àvrun_löfo_öãr
(
Àvñ
,
run
,*
Àn
,*
öfo
);

26 
wrôeSE_Fix
 (
Sy¡axEÀmít
 *
£
, 
Bô°ªam
 *
bô°ªam
);

27 
wrôeSE_UVLC
 (
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
);

28 
wrôeSE_SVLC
 (
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
);

29 
wrôeSE_Fœg
 (
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
);

30 
wrôeSE_övFœg
 (
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
);

31 
wrôeSE_Dummy
 (
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
);

33 
wrôeRefPic_NRef_CAVLC
 (
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
);

34 
wrôeRefPic_2Ref_CAVLC
 (
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
);

35 
wrôeRefPic_Dummy
 (
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
);

37 
wrôeCBP_VLC
 (
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
);

38 
wrôeI¡øPªdMode_CAVLC
 (
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
);

39 
wrôeSy¡axEÀmít2Buf_UVLC
 (
Sy¡axEÀmít
 *
£
, 
Bô°ªam
* 
this_°ªamBuf„r
 );

40 
wrôeUVLC2buf„r
 (
Sy¡axEÀmít
 *
£
, 
Bô°ªam
 *
cuºSåóm
);

41 
wrôeVlcByãAlign
 (
VideoP¨amëîs
 *
p_Vid
, 
Bô°ªam
* 
cuºSåóm
, 
SètP¨amëîs
 *
cur_°©s
);

42 
wrôeSy¡axEÀmít2Buf_Fixed
(
Sy¡axEÀmít
 *
£
, 
Bô°ªam
* 
this_°ªamBuf„r
 );

43 
symbﬁ2uvlc
 (
Sy¡axEÀmít
 *
£
);

44 
ue_löfo
 (
n
, 
dummy
, *
Àn
,*
öfo
);

45 
£_löfo
 (
mvd
, 
dummy
, *
Àn
,*
öfo
);

46 
cbp_löfo_öåa_n‹mÆ
(
cbp
, 
dummy
, *
Àn
,*
öfo
);

47 
cbp_löfo_öåa_Ÿhî
 (
cbp
, 
dummy
, *
Àn
,*
öfo
);

48 
cbp_löfo_öãr_n‹mÆ
(
cbp
, 
dummy
, *
Àn
,*
öfo
);

49 
cbp_löfo_öãr_Ÿhî
 (
cbp
, 
dummy
, *
Àn
,*
öfo
);

51 
wrôeSy¡axEÀmít_VLC
(
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
this_d©aP¨t
);

52 
wrôeSy¡axEÀmít_TŸÆZîos
(
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
this_d©aP¨t
);

53 
wrôeSy¡axEÀmít_TŸÆZîosChromaDC
(
VideoP¨amëîs
 *
p_Vid
, 
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
this_d©aP¨t
);

54 
wrôeSy¡axEÀmít_Run
(
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
this_d©aP¨t
);

55 
wrôeSy¡axEÀmít_NumC€ffTøûögO√s
(
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
this_d©aP¨t
);

56 
wrôeSy¡axEÀmít_NumC€ffTøûögO√sChromaDC
(
VideoP¨amëîs
 *
p_Vid
, 
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
this_d©aP¨t
);

57 
wrôeSy¡axEÀmít_Levñ_VLC1
(
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
this_d©aP¨t
, 
¥ofûe_idc
);

58 
wrôeSy¡axEÀmít_Levñ_VLCN
(
Sy¡axEÀmít
 *
£
, 
vlc
, 
D©aP¨tôi⁄
 *
this_d©aP¨t
, 
¥ofûe_idc
);

60 
wrôeUVLC_CAVLC
 (
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
);

61 
wrôeSVLC_CAVLC
 (
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
);

62 
wrôeFœg_CAVLC
 (
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
);

64 
ª£t_mb_nz_c€ff
(
VideoP¨amëîs
 *
p_Vid
, 
mb_numbî
);

65 
bs_bôÀngth
(
Bô°ªam
 *
bô°ªam
);

66 
GëBôs
(
byã
 *
buf„r
,

67 
tŸbôoff£t
,

68 *
öfo
,

69 
bôcou¡
,

70 
numbôs
);

	@lencod/inc/wp.h

17 #i‚de‡
_WP_H_


18 
	#_WP_H_


	)

20 
	~"wp_lms.h
"

21 
	~"wp_m˝ªc.h
"

22 
	~"wp_mcôî.h
"

23 
	~"wp_øndom.h
"

24 
	~"wp_≥riodic.h
"

26 
	#DEBUG_WP
 0

	)

28 
InôWP
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
f‹˚_wp_mëhod
);

29 
Re£tWP
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
);

31 
E°im©eWPBSli˚Alg0
 (
Sli˚
 *
cuºSli˚
);

32 
E°im©eWPPSli˚Alg0
 (
Sli˚
 *
cuºSli˚
, 
off£t
);

33 
Te°WPPSli˚Alg0
 (
Sli˚
 *
cuºSli˚
, 
off£t
);

34 
Te°WPBSli˚Alg0
 (
Sli˚
 *
cuºSli˚
, 
mëhod
);

35 
CompuãImgSum
 (
img≥l
 **
CuºítImage
, 
height
, 
width
);

36 
CompuãImgSumBlockBa£d
(
img≥l
 **
CuºítImage
, 
height_ö_blk
, 
width_ö_blk
, 
blk_size_y
, 
blk_size_x
, 
°¨t_blk
, 
íd_blk
, *
dc
);

37 
öt64
 
CompuãSumBlockBa£d
 (
img≥l
 **
CuºítImage
, 
height_ö_blk
, 
width_ö_blk
, 
blk_size_y
, 
blk_size_x
, 
°¨t_blk
, 
íd_blk
);

39 
CompuãIm∂icôWeights
 (
Sli˚
 *
cuºSli˚
,

40 
deÁu…_weight
[3],

41 
im_weight
[6][
MAX_REFERENCE_PICTURES
][MAX_REFERENCE_PICTURES][3]);

	@lencod/inc/wp_lms.h

17 #i‚de‡
_WP_LMS_H_


18 
	#_WP_LMS_H_


	)

20 
E°im©eWPPSli˚Alg1
(
Sli˚
 *
cuºSli˚
, 
off£t
);

21 
E°im©eWPBSli˚Alg1
(
Sli˚
 *
cuºSli˚
);

22 
Te°WPPSli˚Alg1
 (
Sli˚
 *
cuºSli˚
, 
off£t
);

23 
Te°WPBSli˚Alg1
 (
Sli˚
 *
cuºSli˚
, 
mëhod
);

24 
CompuãEx∂icôWPP¨amsLMS
(
Sli˚
 *
cuºSli˚
,

25 
£À˘_off£t
,

26 
°¨t_mb
,

27 
íd_mb
,

28 
deÁu…_weight
[3],

29 
weight
[6][
MAX_REFERENCE_PICTURES
][3],

30 
off£t
[6][
MAX_REFERENCE_PICTURES
][3]);

31 
CompuãEx∂icôWPP¨amsJNT
(
Sli˚
 *
cuºSli˚
,

32 
°¨t_mb
,

33 
íd_mb
,

34 
deÁu…_weight
[3],

35 
weight
[6][
MAX_REFERENCE_PICTURES
][3],

36 
off£t
[6][
MAX_REFERENCE_PICTURES
][3]);

	@lencod/inc/wp_mciter.h

17 #i‚de‡
_WP_MCITERM_H_


18 
	#_WP_MCITERM_H_


	)

21 
E°im©eWPBSli˚Alg2
(
Sli˚
 *
cuºSli˚
);

22 
E°im©eWPPSli˚Alg2
(
Sli˚
 *
cuºSli˚
, 
off£t
);

23 
Te°WPPSli˚Alg2
 (
Sli˚
 *
cuºSli˚
, 
off£t
);

24 
Te°WPBSli˚Alg2
 (
Sli˚
 *
cuºSli˚
, 
mëhod
);

26 
compuã_off£t
 (
Sli˚
 *
cuºSli˚
);

	@lencod/inc/wp_mcprec.h

18 #i‚de‡
_WP_MCPREC_H_


19 
	#_WP_MCPREC_H_


	)

23 
	mPicNum
;

24 
	mPOCNum
;

26 
	tWeighãdPªdRefX
;

30 
	mÆg‹ôhm
;

32 
	tWPXPass
;

34 
	swpx_obje˘


36 
	mnum_wp_ªf_li°
[2];

37 
WeighãdPªdRefX
 *
	mwp_ªf_li°
[2];

38 
WPXPass
 *
	mcuº_wp_rd_∑ss
;

39 
WPXPass
 
	mwp_rd_∑s£s
[3];

41 
	tWPXObje˘
;

43 
wpxInôWPXObje˘
–
VideoP¨amëîs
 *
p_Vid
 );

44 
wpxFªeWPXObje˘
–
VideoP¨amëîs
 *
p_Vid
 );

45 
wpxInôWPXPas£s
–
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
 );

46 
wpxModifyRefPicLi°
–
Sli˚
 *
cuºSli˚
 );

49 
wpxDëîmöeWP
–
Sli˚
 *
cuºSli˚
, 
˛i°
, 
n
 );

50 
wpxAd≠tRefNum
–
Sli˚
 *
cuºSli˚
 );

	@lencod/inc/wp_periodic.h

17 #i‚de‡
_WP_PERIODIC_H_


18 
	#_WP_PERIODIC_H_


	)

20 
E°im©eWPPSli˚Pîiodic
(
Sli˚
 *
cuºSli˚
, 
off£t
);

21 
E°im©eWPBSli˚Pîiodic
(
Sli˚
 *
cuºSli˚
);

22 
Te°WPPSli˚Pîiodic
 (
Sli˚
 *
cuºSli˚
, 
off£t
);

23 
Te°WPBSli˚Pîiodic
 (
Sli˚
 *
cuºSli˚
, 
mëhod
);

	@lencod/inc/wp_random.h

17 #i‚de‡
_WP_RANDOM_H_


18 
	#_WP_RANDOM_H_


	)

20 
E°im©eWPPSli˚R™dom
(
Sli˚
 *
cuºSli˚
, 
off£t
);

21 
E°im©eWPBSli˚R™dom
(
Sli˚
 *
cuºSli˚
);

22 
Te°WPPSli˚R™dom
 (
Sli˚
 *
cuºSli˚
, 
off£t
);

23 
Te°WPBSli˚R™dom
 (
Sli˚
 *
cuºSli˚
, 
mëhod
);

	@lencod/src/annexb.c

15 
	~"globÆ.h
"

16 
	~"«lucomm⁄.h
"

28 
	$WrôeA¬exbNALU
 (
VideoP¨amëîs
 *
p_Vid
, 
NALU_t
 *
n
, 
FILE
 **
f_™√xb
)

30 
BôsWrôãn
 = 0;

31 
off£t
 = 0;

32 
Àngth
 = 4;

33 c⁄° 
byã
 
°¨tcode
[] = {0,0,0,1};

34 
byã
 
fú°_byã
;

36 
	`as£π
 (
n
 !
NULL
);

37 
	`as£π
 (
n
->
f‹biddí_bô
 == 0);

38 
	`as£π
 ((*
f_™√xb
Ë!
NULL
);

39 
	`as£π
 (
n
->
°¨tcodïªfix_Àn
 == 3 ||Ç->startcodeprefix_len == 4);

42 i‡(
n
->
°¨tcodïªfix_Àn
 < 4)

44 
off£t
 = 1;

45 
Àngth
 = 3;

48 i‡–
Àngth
 !(Ë
	`fwrôe
 (
°¨tcode
+
off£t
, 1,Üígth, *
f_™√xb
))

50 
	`¥ötf
 ("F©Æ: c™nŸ wrôê%d byã†tÿbô°ªam fûe,Éxô (-1)\n", 
Àngth
);

51 
	`exô
 (-1);

54 
BôsWrôãn
 = (
Àngth
) << 3;

56 
fú°_byã
 = (Ë((
n
->
f‹biddí_bô
 << 7Ë| (n->
«l_ª„ªn˚_idc
 << 5Ë|Ç->
«l_unô_ty≥
);

58 i‡–1 !
	`fwrôe
 (&
fú°_byã
, 1, 1, *
f_™√xb
))

60 
	`¥ötf
 ("Fatal: cannot write %d bytesÅo bitstream file,Éxit (-1)\n", 1);

61 
	`exô
 (-1);

64 
BôsWrôãn
 += 8;

67 #i‡(
MVC_EXTENSION_ENABLE
)

68 if(
n
->
«l_unô_ty≥
==
NALU_TYPE_PREFIX
 ||Ç->«l_unô_ty≥==
NALU_TYPE_SLC_EXT
)

70 
võw_id
 = 
p_Vid
->
p_I≈
->
MVCFlùVõws
 ? !(
n
->view_id) :Ç->view_id;

72 
fú°_byã
 = (Ë((
n
->
svc_exãnsi⁄_Êag
 << 7Ë| (n->
n⁄_idr_Êag
 << 6Ë|Ç->
¥i‹ôy_id
);

73 i‡–1 !
	`fwrôe
 (&
fú°_byã
, 1, 1, *
f_™√xb
))

75 
	`¥ötf
 ("Fatal: cannot write %d bytesÅo bitstream file,Éxit (-1)\n", 1);

76 
	`exô
 (-1);

78 
BôsWrôãn
 += 8;

80 
fú°_byã
 = (Ë(
võw_id
 >> 2);

81 i‡–1 !
	`fwrôe
 (&
fú°_byã
, 1, 1, *
f_™√xb
))

83 
	`¥ötf
 ("Fatal: cannot write %d bytesÅo bitstream file,Éxit (-1)\n", 1);

84 
	`exô
 (-1);

86 
BôsWrôãn
 += 8;

88 
fú°_byã
 = (Ë(((
võw_id
&3Ë<< 6Ë| (
n
->
ãmp‹Æ_id
 << 3Ë| (n->
™ch‹_pic_Êag
 << 2Ë| (n->
öãr_võw_Êag
 << 1Ë|Ç->
ª£rved_⁄e_bô
);

89 i‡–1 !
	`fwrôe
 (&
fú°_byã
, 1, 1, *
f_™√xb
))

91 
	`¥ötf
 ("Fatal: cannot write %d bytesÅo bitstream file,Éxit (-1)\n", 1);

92 
	`exô
 (-1);

94 
BôsWrôãn
 += 8;

98 i‡(
n
->
Àn
 !
	`fwrôe
 (n->
buf
, 1,Ç->Àn, *
f_™√xb
))

100 
	`¥ötf
 ("F©Æ: c™nŸ wrôê%d byã†tÿbô°ªam fûe,Éxô (-1)\n", 
n
->
Àn
);

101 
	`exô
 (-1);

103 
BôsWrôãn
 +
n
->
Àn
 * 8;

105 
	`fÊush
 (*
f_™√xb
);

106 #i‡
TRACE


109 
	`Ârötf
 (
p_Enc
->
p_åa˚
, "\nA¬ex B NALU w/ %†°¨tcode,Üí %d,", 
n
->
°¨tcodïªfix_Àn
 =4?"l⁄g":"sh‹t",Ç->
Àn
 + 1);

110 
	`Ârötf
 (
p_Enc
->
p_åa˚
, "\¿ f‹biddí_bô %d,", 
n
->
f‹biddí_bô
);

111 
	`Ârötf
 (
p_Enc
->
p_åa˚
, "\¿ÇÆ_ª„ªn˚_id¯ %d,", 
n
->
«l_ª„ªn˚_idc
);

112 
	`Ârötf
 (
p_Enc
->
p_åa˚
, "\¿ÇÆ_unô_ty≥ %d ", 
n
->
«l_unô_ty≥
);

113 #i‡(
MVC_EXTENSION_ENABLE
)

114 if(
n
->
«l_unô_ty≥
==
NALU_TYPE_PREFIX
 ||Ç->«l_unô_ty≥==
NALU_TYPE_SLC_EXT
)

116 
	`Ârötf
 (
p_Enc
->
p_åa˚
, "\¿ svc_exãnsi⁄_Êag %d ", 
n
->
svc_exãnsi⁄_Êag
);

117 
	`Ârötf
 (
p_Enc
->
p_åa˚
, "\¿Ç⁄_idr_Êag %d ", 
n
->
n⁄_idr_Êag
);

118 
	`Ârötf
 (
p_Enc
->
p_åa˚
, "\¿Öri‹ôy_id %d ", 
n
->
¥i‹ôy_id
);

120 
	`Ârötf
 (
p_Enc
->
p_åa˚
, "\¿ võw_id %d ", 
p_Vid
->
p_I≈
->
MVCFlùVõws
 ? !(
n
->
võw_id
) :Ç->view_id);

121 
	`Ârötf
 (
p_Enc
->
p_åa˚
, "\¿Åemp‹Æ_id %d ", 
n
->
ãmp‹Æ_id
);

122 
	`Ârötf
 (
p_Enc
->
p_åa˚
, "\¿ánch‹_pic_Êag %d ", 
n
->
™ch‹_pic_Êag
);

123 
	`Ârötf
 (
p_Enc
->
p_åa˚
, "\¿ i¡î_võw_Êag %d ", 
n
->
öãr_võw_Êag
);

124 
	`Ârötf
 (
p_Enc
->
p_åa˚
, "\¿Ñe£rved_⁄e_bô %d ", 
n
->
ª£rved_⁄e_bô
);

127 
	`Ârötf
 (
p_Enc
->
p_åa˚
, "\n----------------------------------------------------------------------------\n\n\n");

128 
	`fÊush
 (
p_Enc
->
p_åa˚
);

130  
BôsWrôãn
;

131 
	}
}

149 
	$O≥nA¬exbFûe
 (*
Fûíame
, 
FILE
 **
f_™√xb
)

151 i‡(((*
f_™√xb
Ë
	`f›í
 (
Fûíame
, "wb")Ë=
NULL
)

153 
	`¥ötf
 ("F©Æ: c™nŸ o≥¿A¬ex B byã°ªam fûê'%s',Éxô (-1)\n", 
Fûíame
);

154 
	`exô
 (-1);

156 
	}
}

168 
	$Clo£A¬exbFûe
(
FILE
 *
f_™√xb
)

170 i‡(
	`f˛o£
 (
f_™√xb
))

172 
	`¥ötf
 ("Fatal: cannot close Annex B bytestream file,Éxit (-1)\n");

173 
	`exô
 (-1);

175 
	}
}

	@lencod/src/biariencode.c

20 
	~"globÆ.h
"

21 
	~"bürõncode.h
"

24 c⁄° 
byã
 
	gªn‹m_èbÀ_32
[32]={6,5,4,4,3,3,3,3,2,2,2,2,2,2,2,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1};

27 
	$ª£t_pic_bö_cou¡
(
VideoP¨amëîs
 *
p_Vid
)

29 
p_Vid
->
pic_bö_cou¡
 = 0;

30 
	}
}

32 
	$gë_pic_bö_cou¡
(
VideoP¨amëîs
 *
p_Vid
)

34  
p_Vid
->
pic_bö_cou¡
;

35 
	}
}

43 
EncodögEnvú⁄mítPå
 
	$¨õnco_¸óã_ícodög_ívú⁄mít
()

45 
EncodögEnvú⁄mítPå
 
ìp
;

47 i‡–(
ìp
 = (
EncodögEnvú⁄mítPå
Ë
	`ˇŒoc
(1,(
EncodögEnvú⁄mít
))Ë=
NULL
)

48 
	`no_mem_exô
("arienco_create_encoding_environment:Éep");

50  
ìp
;

51 
	}
}

59 
	$¨õnco_dñëe_ícodög_ívú⁄mít
(
EncodögEnvú⁄mítPå
 
ìp
)

61 
	`‰ì_poöãr
(
ìp
);

62 
	}
}

70 
ölöe
 
	$put_⁄e_byã_föÆ
(
EncodögEnvú⁄mítPå
 
ìp
, 
b
)

72 
ìp
->
Ecode°rm
[(*ìp->
Ecode°rm_Àn
)++] = (
byã
Ë
b
;

73 
	}
}

75 
f‹˚ölöe
 
	$put_buf„r
(
EncodögEnvú⁄mítPå
 
ìp
)

77 
ìp
->
Epbuf
>=0)

79 
ìp
->
Ecode°rm
[(*ìp->
Ecode°rm_Àn
)++] = (
byã
Ë(”ï->
Ebuf„r
>>(”ï->
Epbuf
--)<<3))&0xFF);

81 
ìp
->
C
 > 7)

83 
ìp
->
C
-=8;

84 ++(
ìp
->
E
);

86 
ìp
->
Ebuf„r
 = 0;

87 
	}
}

89 
ölöe
 
	$put_⁄e_byã
(
EncodögEnvú⁄mítPå
 
ìp
, 
b
)

91 if(
ìp
->
Epbuf
 == 3)

93 
	`put_buf„r
(
ìp
);

95 
ìp
->
Ebuf„r
 <<= 8;

96 
ìp
->
Ebuf„r
 +(
b
);

98 ++(
ìp
->
Epbuf
);

99 
	}
}

101 
ölöe
 
	$put_⁄e_w‹d
(
EncodögEnvú⁄mítPå
 
ìp
, 
b
)

103 i‡(
ìp
->
Epbuf
 >= 3)

105 
	`put_buf„r
(
ìp
);

107 
ìp
->
Ebuf„r
 <<= 16;

108 
ìp
->
Ebuf„r
 +(
b
);

110 
ìp
->
Epbuf
 += 2;

111 
	}
}

113 
f‹˚ölöe
 
	$¥›ag©e_ˇºy
(
EncodögEnvú⁄mítPå
 
ìp
)

115 ++(
ìp
->
Ebuf„r
);

116 
ìp
->
Echunks_out°™dög
 > 0)

118 
	`put_⁄e_w‹d
(
ìp
, 0);

119 --(
ìp
->
Echunks_out°™dög
);

121 
	}
}

123 
ölöe
 
	$put_œ°_chunk_∂us_out°™dög
(
EncodögEnvú⁄mítPå
 
ìp
, 
l
)

125 
ìp
->
Echunks_out°™dög
 > 0)

127 
	`put_⁄e_w‹d
(
ìp
, 0xFFFF);

128 --(
ìp
->
Echunks_out°™dög
);

130 
	`put_⁄e_w‹d
(
ìp
, 
l
);

131 
	}
}

133 
ölöe
 
	$put_œ°_chunk_∂us_out°™dög_föÆ
(
EncodögEnvú⁄mítPå
 
ìp
, 
l
)

135 
ìp
->
Echunks_out°™dög
 > 0)

137 
	`put_⁄e_w‹d
(
ìp
, 0xFFFF);

138 --(
ìp
->
Echunks_out°™dög
);

140 
	`put_⁄e_byã
(
ìp
, 
l
);

141 
	}
}

149 
	$¨õnco_ª£t_EC
(
EncodögEnvú⁄mítPå
 
ìp
)

151 
ìp
->
E
 = 0;

152 
ìp
->
C
 = 0;

153 
	}
}

161 
	$¨õnco_°¨t_ícodög
(
EncodögEnvú⁄mítPå
 
ìp
,

162 *
code_buf„r
,

163 *
code_Àn
 )

165 
ìp
->
Elow
 = 0;

166 
ìp
->
Echunks_out°™dög
 = 0;

167 
ìp
->
Ebuf„r
 = 0;

168 
ìp
->
Epbuf
 = -1;

169 
ìp
->
Ebôs_to_go
 = 
BITS_TO_LOAD
 + 1;

171 
ìp
->
Ecode°rm
 = 
code_buf„r
;

172 
ìp
->
Ecode°rm_Àn
 = 
code_Àn
;

174 
ìp
->
Eønge
 = 
HALF
;

175 
	}
}

184 
	$£t_pic_bö_cou¡
(
VideoP¨amëîs
 *
p_Vid
, 
EncodögEnvú⁄mítPå
 
ìp
)

186 
p_Vid
->
pic_bö_cou¡
 +(
ìp
->
E
 << 3Ë+Éï->
C
;

187 
	}
}

195 
	$¨õnco_d⁄e_ícodög
(
Ma¸oblock
 *
cuºMB
, 
EncodögEnvú⁄mítPå
 
ìp
)

197 
low
 = 
ìp
->
Elow
;

198 
ªmaöög_bôs
 = 
BITS_TO_LOAD
 - 
ìp
->
Ebôs_to_go
;

199 
mask
;

200 
BôCou¡î
 *
mbBôs
 = &
cuºMB
->
bôs
;

204 i‡(
ªmaöög_bôs
 <= 5)

206 
mbBôs
->
mb_°uffög
 +(5 - 
ªmaöög_bôs
);

207 
mask
 = (Ë(255 - ((1 << (6 - 
ªmaöög_bôs
)) - 1));

208 
low
 = (low >> (
MASK_BITS
)Ë& 
mask
;

209 
low
 +(32 >> 
ªmaöög_bôs
);

211 
	`put_œ°_chunk_∂us_out°™dög_föÆ
(
ìp
, 
low
);

212 
	`put_buf„r
(
ìp
);

214 if(
ªmaöög_bôs
 <= 13)

216 
mbBôs
->
mb_°uffög
 +(13 - 
ªmaöög_bôs
);

217 
	`put_œ°_chunk_∂us_out°™dög_föÆ
(
ìp
, ((
low
 >> (
MASK_BITS
)) & 0xFF));

219 
	`put_buf„r
(
ìp
);

220 i‡(
ªmaöög_bôs
 > 6)

222 
mask
 = (Ë(255 - ((1 << (14 - 
ªmaöög_bôs
)) - 1));

223 
low
 = (low >> (
B_BITS
)Ë& 
mask
;

224 
low
 +(0x2000 >> 
ªmaöög_bôs
);

225 
	`put_⁄e_byã_föÆ
(
ìp
, 
low
);

229 
	`put_⁄e_byã_föÆ
(
ìp
, 128);

234 
	`put_œ°_chunk_∂us_out°™dög
(
ìp
, ((
low
 >> 
B_BITS
Ë& 
B_LOAD_MASK
));

235 
	`put_buf„r
(
ìp
);

236 
mbBôs
->
mb_°uffög
 +(21 - 
ªmaöög_bôs
);

238 i‡(
ªmaöög_bôs
 > 14)

240 
mask
 = (Ë(255 - ((1 << (22 - 
ªmaöög_bôs
)) - 1));

241 
low
 = (low >> (
MAX_BITS
 - 24)Ë& 
mask
;

242 
low
 +(0x200000 >> 
ªmaöög_bôs
);

243 
	`put_⁄e_byã_föÆ
(
ìp
, 
low
);

247 
	`put_⁄e_byã_föÆ
(
ìp
, 128);

250 
ìp
->
Ebôs_to_go
 = 8;

251 
	}
}

261 
	$büri_ícode_symbﬁ
(
EncodögEnvú⁄mítPå
 
ìp
, 
symbﬁ
, 
BiC⁄ãxtTy≥På
 
bi_˘
 )

263 c⁄° 
byã
 
rLPS_èbÀ_64x4
[64][4]=

330 c⁄° 
byã
 
AC_√xt_°©e_MPS_64
[64] =

341 c⁄° 
byã
 
AC_√xt_°©e_LPS_64
[64] =

352 
low
 = 
ìp
->
Elow
;

353 
ønge
 = 
ìp
->
Eønge
;

354 
bl
 = 
ìp
->
Ebôs_to_go
;

355 
rLPS
 = 
rLPS_èbÀ_64x4
[
bi_˘
->
°©e
][(
ønge
>>6) & 3];

357 
ønge
 -
rLPS
;

359 ++(
ìp
->
C
);

360 
bi_˘
->
cou¡
 +
ìp
->
p_Vid
->
ˇbac_ícodög
;

367 i‡((
symbﬁ
 !0Ë=
bi_˘
->
MPS
)

369 
bi_˘
->
°©e
 = 
AC_√xt_°©e_MPS_64
[bi_ct->state];

371 if–
ønge
 >
QUARTER
 )

373 
ìp
->
Eønge
 = 
ønge
;

378 
ønge
<<=1;

379 if–--
bl
 > 
MIN_BITS_TO_GO
 )

381 
ìp
->
Eønge
 = 
ønge
;

382 
ìp
->
Ebôs_to_go
 = 
bl
;

389 
ªn‹m
 = 
ªn‹m_èbÀ_32
[(
rLPS
 >> 3) & 0x1F];

391 
low
 +
ønge
 << 
bl
;

392 
ønge
 = (
rLPS
 << 
ªn‹m
);

393 
bl
 -
ªn‹m
;

395 i‡(!
bi_˘
->
°©e
)

396 
bi_˘
->
MPS
 ^= 0x01;

398 
bi_˘
->
°©e
 = 
AC_√xt_°©e_LPS_64
[bi_ct->state];

400 i‡(
low
 >
ONE
)

402 
low
 -
ONE
;

403 
	`¥›ag©e_ˇºy
(
ìp
);

406 if–
bl
 > 
MIN_BITS_TO_GO
 )

408 
ìp
->
Elow
 = 
low
;

409 
ìp
->
Eønge
 = 
ønge
;

410 
ìp
->
Ebôs_to_go
 = 
bl
;

416 
ìp
->
Elow
 = (
low
 << 
BITS_TO_LOAD
 )& (
ONE_M1
);

417 
low
 = (low >> 
B_BITS
Ë& 
B_LOAD_MASK
;

419 i‡(
low
 < 
B_LOAD_MASK
)

421 
	`put_œ°_chunk_∂us_out°™dög
(
ìp
, 
low
);

425 ++(
ìp
->
Echunks_out°™dög
);

427 
ìp
->
Eønge
 = 
ønge
;

428 
ìp
->
Ebôs_to_go
 = 
bl
 + 
BITS_TO_LOAD
;

429 
	}
}

438 
	$büri_ícode_symbﬁ_eq_¥ob
(
EncodögEnvú⁄mítPå
 
ìp
, 
symbﬁ
)

440 
low
 = 
ìp
->
Elow
;

441 --(
ìp
->
Ebôs_to_go
);

442 ++(
ìp
->
C
);

444 i‡(
symbﬁ
 != 0)

446 
low
 +
ìp
->
Eønge
 <<Éï->
Ebôs_to_go
;

447 i‡(
low
 >
ONE
)

449 
low
 -
ONE
;

450 
	`¥›ag©e_ˇºy
(
ìp
);

453 if(
ìp
->
Ebôs_to_go
 =
MIN_BITS_TO_GO
)

455 
ìp
->
Elow
 = (
low
 << 
BITS_TO_LOAD
 )& (
ONE_M1
);

456 
low
 = (low >> 
B_BITS
Ë& 
B_LOAD_MASK
;

457 i‡(
low
 < 
B_LOAD_MASK
)

459 
	`put_œ°_chunk_∂us_out°™dög
(
ìp
, 
low
);}

462 ++(
ìp
->
Echunks_out°™dög
);

465 
ìp
->
Ebôs_to_go
 = 
BITS_TO_LOAD
;

470 
ìp
->
Elow
 = 
low
;

473 
	}
}

481 
	$büri_ícode_symbﬁ_föÆ
(
EncodögEnvú⁄mítPå
 
ìp
, 
symbﬁ
)

483 
ønge
 = 
ìp
->
Eønge
 - 2;

484 
low
 = 
ìp
->
Elow
;

485 
bl
 = 
ìp
->
Ebôs_to_go
;

487 ++(
ìp
->
C
);

489 i‡(
symbﬁ
 == 0)

491 if–
ønge
 >
QUARTER
 )

493 
ìp
->
Eønge
 = 
ønge
;

498 
ønge
<<=1;

499 if–--
bl
 > 
MIN_BITS_TO_GO
 )

501 
ìp
->
Eønge
 = 
ønge
;

502 
ìp
->
Ebôs_to_go
 = 
bl
;

509 
low
 +(
ønge
 << 
bl
);

510 
ønge
 = 2;

512 i‡(
low
 >
ONE
)

514 
low
 -
ONE
;

515 
	`¥›ag©e_ˇºy
(
ìp
);

517 
bl
 -= 7;

519 
ønge
 <<= 7;

520 if–
bl
 > 
MIN_BITS_TO_GO
 )

522 
ìp
->
Eønge
 = 
ønge
;

523 
ìp
->
Elow
 = 
low
;

524 
ìp
->
Ebôs_to_go
 = 
bl
;

531 
ìp
->
Elow
 = (
low
 << 
BITS_TO_LOAD
 ) & (
ONE_M1
);

532 
low
 = (low >> 
B_BITS
Ë& 
B_LOAD_MASK
;

533 i‡(
low
 < 
B_LOAD_MASK
)

535 
	`put_œ°_chunk_∂us_out°™dög
(
ìp
, 
low
);

539 ++(
ìp
->
Echunks_out°™dög
);

542 
ìp
->
Eønge
 = 
ønge
;

543 
bl
 +
BITS_TO_LOAD
;

544 
ìp
->
Ebôs_to_go
 = 
bl
;

545 
	}
}

553 
	$büri_öô_c⁄ãxt
 (
qp
, 
BiC⁄ãxtTy≥På
 
˘x
, c⁄° * 
öi
)

555 
p°©e
 = ((
öi
[0]* 
qp
) >> 4) + ini[1];

557 i‡–
p°©e
 >= 64 )

559 
p°©e
 = 
	`imö
(126,Östate);

560 
˘x
->
°©e
 = (
uöt8
Ë(
p°©e
 - 64);

561 
˘x
->
MPS
 = 1;

565 
p°©e
 = 
	`imax
(1,Östate);

566 
˘x
->
°©e
 = (
uöt8
Ë(63 - 
p°©e
);

567 
˘x
->
MPS
 = 0;

570 
˘x
->
cou¡
 = 0;

571 
	}
}

	@lencod/src/block.c

23 
	~"c⁄åibut‹s.h
"

25 
	~<m©h.h
>

27 
	~"globÆ.h
"

28 
	~"blk_¥edi˘i⁄.h
"

29 
	~"íc_°©i°ics.h
"

30 
	~"memÆloc.h
"

31 
	~"image.h
"

32 
	~"mb_ac˚ss.h
"

33 
	~"block.h
"

34 
	~"vlc.h
"

35 
	~"å™sf‹m.h
"

36 
	~"mc_¥edi˘i⁄.h
"

37 
	~"q_off£ts.h
"

38 
	~"q_m©rix.h
"

39 
	~"qu™t4x4.h
"

40 
	~"qu™tChroma.h
"

41 
	~"md_comm⁄.h
"

42 
	~"å™sf‹m8x8.h
"

57 
	#P_X
 (
PªdPñ
[0])

	)

58 
	#P_A
 (
PªdPñ
[1])

	)

59 
	#P_B
 (
PªdPñ
[2])

	)

60 
	#P_C
 (
PªdPñ
[3])

	)

61 
	#P_D
 (
PªdPñ
[4])

	)

62 
	#P_E
 (
PªdPñ
[5])

	)

63 
	#P_F
 (
PªdPñ
[6])

	)

64 
	#P_G
 (
PªdPñ
[7])

	)

65 
	#P_H
 (
PªdPñ
[8])

	)

66 
	#P_I
 (
PªdPñ
[9])

	)

67 
	#P_J
 (
PªdPñ
[10])

	)

68 
	#P_K
 (
PªdPñ
[11])

	)

69 
	#P_L
 (
PªdPñ
[12])

	)

72 c⁄° 
byã
 
	gCOEFF_COST4x4
[2][16] =

78 c⁄° 
byã
 
	gSCAN_YUV420
 [4][2] =

87 c⁄° 
byã
 
	gSCAN_YUV422
 [8][2] =

96 c⁄° 
	gh‹_off£t
[4][4][4] = {

123 c⁄° 
	gvî_off£t
[4][4][4] = {

150 c⁄° 
	gA
[4][4] = {

157 c⁄° 
	gcbp_blk_chroma
[8][4] = {

169 c⁄° 
byã
 
	gSNGL_SCAN
[16][2] =

178 c⁄° 
byã
 
	gFIELD_SCAN
[16][2] =

188 
ResiduÆ_DPCM_16x16
(**
mb_‹es
, 
ùmode
);

189 
Inv_ResiduÆ_DPCM_16x16
(**
mb_‹es
, 
ùmode
);

190 
ResiduÆ_DPCM_4x4
(
ùmode
, **
mb_‹es
, **
mb_ºes
, 
block_y
, 
block_x
);

191 
Inv_ResiduÆ_DPCM_4x4
 (
Ma¸oblock
 *
cuºMB
, **
m7
, 
block_y
, 
block_x
);

192 
ResiduÆ_DPCM_Chroma
(
ùmode
, **
‹es
, **
ºes
, 
width
, 
height
);

193 
Inv_ResiduÆ_DPCM_Chroma
(
ùmode
, **
m7
, 
width
, 
height
);

207 
	$ªsiduÆ_å™sf‹m_qu™t_luma_16x16
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
)

209 
i
,
j
;

210 
ii
,
jj
;

212 
ac_c€f
 = 0;

213 
img≥l
 *
img_Y
, *
¥edY
;

214 
n⁄zîo
 = 
FALSE
;

216 
jpos
, 
ùos
;

217 
b8
, 
b4
;

220 
∂_off
 = 
∂
<<2;

221 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

222 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

223 
Qu™tP¨amëîs
 *
p_Qu™t
 = 
p_Vid
->p_Quant;

225 * 
DCLevñ
 = 
cuºSli˚
->
cofDC
[
∂
][0];

226 * 
DCRun
 = 
cuºSli˚
->
cofDC
[
∂
][1];

227 ****
cofAC
 = &
cuºSli˚
->cofAC[
∂_off
];

228 
c€ff_co°
;

229 
√w_öåa_mode
 = 
cuºMB
->
i16mode
;

230 
img≥l
 **
img_íc
 = 
p_Vid
->
íc_pi˘uª
->
p_cuº_img
;

231 
max_img≥l_vÆue
 = 
p_Vid
->max_imgpel_value;

232 
qp
 = (
p_Vid
->
yuv_f‹m©
==
YUV444
 && !
cuºSli˚
->
P444_joöed
)? 
cuºMB
->
qp_sˇÀd
[()’_Vid->
cﬁour_∂™e_id
)]: cuºMB->qp_sˇÀd[
∂
];

233 c⁄° 
	`byã
 (*
pos_sˇn
)[2] = 
cuºMB
->
is_fõld_mode
 ? 
FIELD_SCAN
 : 
SNGL_SCAN
;

234 
img≥l
 ***
cuº_m¥_16x16
 = 
cuºSli˚
->
m¥_16x16
[
∂
];

236 
qp_≥r
 = 
p_Qu™t
->
qp_≥r_m©rix
[
qp
];

241 
Qu™tMëhods
 
qu™t_mëhods
;

244 
qu™t_mëhods
.
qp
 = qp;

245 
qu™t_mëhods
.
q_∑øms
 = 
p_Qu™t
->
q_∑øms_4x4
[
∂
][1][
qp
];

246 
qu™t_mëhods
.
Ádju°
 = 
p_Vid
->
Ad≠tiveRoundög
 ? (&p_Vid->
ARCofAdj4x4
[
∂
][
I16MB
][0]): 
NULL
;

247 
qu™t_mëhods
.
pos_sˇn
 = 
cuºMB
->
is_fõld_mode
 ? 
FIELD_SCAN
 : 
SNGL_SCAN
;

248 
qu™t_mëhods
.
c_co°
 = 
COEFF_COST4x4
[
cuºSli˚
->
di°hªs
];

249 
qu™t_mëhods
.
c€ff_co°
 = &coeff_cost;

250 
qu™t_mëhods
.
ty≥
 = 
LUMA_16AC
;

253 
j
 = 0; j < 16; ++j)

255 
¥edY
 = 
cuº_m¥_16x16
[
√w_öåa_mode
][
j
];

256 
img_Y
 = &
p_Vid
->
pCurImg
[
cuºMB
->
›ix_y
 + 
j
][cuºMB->
pix_x
];

257 
i
 = 0; i < 16; ++i)

259 
cuºSli˚
->
tblk16x16
[
j
][
i
] = 
img_Y
[i] - 
¥edY
[i];

264 
j
 = 0; j < 16; j+=4)

266 
i
 = 0;i < 16; i+=4)

268 
	`f‹w¨d4x4
(
cuºSli˚
->
tblk16x16
, cuºSli˚->tblk16x16, 
j
, 
i
);

273 
j
 = 0; j < 4; ++j)

274 
i
 = 0; i < 4; ++i)

275 
cuºSli˚
->
tblk4x4
[
j
][
i
]cuºSli˚->
tblk16x16
[j << 2][i << 2];

278 
	`hadam¨d4x4
(
cuºSli˚
->
tblk4x4
, currSlice->tblk4x4);

280 
n⁄zîo
 = 
cuºSli˚
->
	`qu™t_dc4x4
(
cuºMB
, &cuºSli˚->
tblk4x4
[0], 
qp
, 
DCLevñ
, 
DCRun
, &
qu™t_mëhods
.
q_∑øms
[0][0], 
pos_sˇn
);

284 i‡(
n⁄zîo
)

286 
	`ihadam¨d4x4
(
cuºSli˚
->
tblk4x4
, currSlice->tblk4x4);

289 
j
 = 0; j < 
MB_BLOCK_SIZE
; j +
BLOCK_SIZE
)

291 
i
 = 0; i < 
MB_BLOCK_SIZE
;ò+
BLOCK_SIZE
)

293 
cuºSli˚
->
tblk16x16
[
j
][
i
] = 
	`rshi·_∫d_sf
(((cuºSli˚->
tblk4x4
[j>>2][i>>2]Ë* 
qu™t_mëhods
.
q_∑øms
[0][0].
InvSˇÀComp
Ë<< 
qp_≥r
, 6);

299 
j
 = 0; j < 
MB_BLOCK_SIZE
; j +
BLOCK_SIZE
)

301 
i
 = 0; i < 
MB_BLOCK_SIZE
; i +
BLOCK_SIZE
)

303 
cuºSli˚
->
tblk16x16
[
j
][
i
] = 0;

309 
jj
=0;jj<4;++jj)

311 
jpos
 = (
jj
 << 2);

312 
cuºMB
->
subblock_y
 = (Ë
jpos
;

313 
ii
=0;ii<4;++ii)

315 
ùos
 = (
ii
 << 2);

316 
cuºMB
->
subblock_x
 = (Ë
ùos
;

318 
b8
 = 2*(
jj
 >> 1Ë+ (
ii
 >> 1);

319 
b4
 = 2*(
jj
 & 0x01Ë+ (
ii
 & 0x01);

320 
qu™t_mëhods
.
block_x
 = 
ùos
;

321 
qu™t_mëhods
.
block_y
 = 
jpos
;

323 
qu™t_mëhods
.
ACLevñ
 = 
cofAC
[
b8
][
b4
][0];

324 
qu™t_mëhods
.
ACRun
 = 
cofAC
[
b8
][
b4
][1];

327 
n⁄zîo
 = 
cuºSli˚
->
	`qu™t_ac4x4
(
cuºMB
, &cuºSli˚->
tblk16x16
[
jpos
], &
qu™t_mëhods
);

329 i‡(
n⁄zîo
)

330 
ac_c€f
 = 15;

333 i‡(
cuºSli˚
->
tblk16x16
[
jpos
][
ùos
]!0 || 
n⁄zîo
)

334 
	`övî£4x4
(
cuºSli˚
->
tblk16x16
, cuºSli˚->tblk16x16, 
jpos
, 
ùos
);

340 
	`ßm∂e_ªc⁄°ru˘
 (&
img_íc
[
cuºMB
->
pix_y
], 
cuº_m¥_16x16
[
√w_öåa_mode
], 
cuºSli˚
->
tblk16x16
, 0, cuºMB->
pix_x
, 16, 16, 
max_img≥l_vÆue
, 
DQ_BITS
);

342 if(
cuºSli˚
->
¶i˚_ty≥
 =
SP_SLICE
 || cuºSli˚->¶i˚_ty≥ =
SI_SLICE
)

344 
j
 = 
cuºMB
->
pix_y
; j < currMB->pix_y + 16;++j)

345 
i
 = 
cuºMB
->
pix_x
; i < currMB->pix_x + 16;++i)

346 
p_Vid
->
Ãec
[
j
][
i
]=-16;

349  
ac_c€f
;

350 
	}
}

352 
	$ResiduÆ_DPCM_16x16
(**
m7
, 
ùmode
)

354 
i
,
j
;

355 
ãmp
[16][16];

357 if(
ùmode
==
VERT_PRED_16
)

359 
i
=1; i<16; ++i)

360 
j
=0; j<16; ++j)

361 
ãmp
[
i
][
j
] = 
m7
[i][j] - m7[i-1][j];

363 
i
=1; i<16; ++i)

364 
j
=0; j<16; ++j)

365 
m7
[
i
][
j
] = 
ãmp
[i][j];

369 
i
=0; i<16; ++i)

370 
j
=1; j<16; ++j)

371 
ãmp
[
i
][
j
] = 
m7
[i][j] - m7[i][j-1];

373 
i
=0; i<16; ++i)

374 
j
=1; j<16; ++j)

375 
m7
[
i
][
j
] = 
ãmp
[i][j];

378 
	}
}

380 
	$Inv_ResiduÆ_DPCM_16x16
(**
m7
, 
ùmode
)

382 
i
;

383 
ãmp
[16][16];

385 if(
ùmode
==
VERT_PRED_16
)

387 
i
=0; i<16; ++i)

389 
ãmp
[0][
i
] = 
m7
[0][i];

390 
ãmp
[1][
i
] = 
m7
[1][i] +Åemp[0][i];

391 
ãmp
[2][
i
] = 
m7
[2][i] +Åemp[1][i];

392 
ãmp
[3][
i
] = 
m7
[3][i] +Åemp[2][i];

393 
ãmp
[4][
i
] = 
m7
[4][i] +Åemp[3][i];

394 
ãmp
[5][
i
] = 
m7
[5][i] +Åemp[4][i];

395 
ãmp
[6][
i
] = 
m7
[6][i] +Åemp[5][i];

396 
ãmp
[7][
i
] = 
m7
[7][i] +Åemp[6][i];

397 
ãmp
[8][
i
] = 
m7
[8][i] +Åemp[7][i];

398 
ãmp
[9][
i
] = 
m7
[9][i] +Åemp[8][i];

399 
ãmp
[10][
i
] = 
m7
[10][i] +Åemp[9][i];

400 
ãmp
[11][
i
] = 
m7
[11][i] +Åemp[10][i];

401 
ãmp
[12][
i
] = 
m7
[12][i] +Åemp[11][i];

402 
ãmp
[13][
i
] = 
m7
[13][i] +Åemp[12][i];

403 
ãmp
[14][
i
] = 
m7
[14][i] +Åemp[13][i];

404 
ãmp
[15][
i
] = 
m7
[15][i] +Åemp[14][i];

407 
i
=0; i<16; ++i)

409 
m7
[1][
i
] = 
ãmp
[1][i];

410 
m7
[2][
i
] = 
ãmp
[2][i];

411 
m7
[3][
i
] = 
ãmp
[3][i];

412 
m7
[4][
i
] = 
ãmp
[4][i];

413 
m7
[5][
i
] = 
ãmp
[5][i];

414 
m7
[6][
i
] = 
ãmp
[6][i];

415 
m7
[7][
i
] = 
ãmp
[7][i];

416 
m7
[8][
i
] = 
ãmp
[8][i];

417 
m7
[9][
i
] = 
ãmp
[9][i];

418 
m7
[10][
i
] = 
ãmp
[10][i];

419 
m7
[11][
i
] = 
ãmp
[11][i];

420 
m7
[12][
i
] = 
ãmp
[12][i];

421 
m7
[13][
i
] = 
ãmp
[13][i];

422 
m7
[14][
i
] = 
ãmp
[14][i];

423 
m7
[15][
i
] = 
ãmp
[15][i];

428 
i
=0; i<16; ++i)

430 
ãmp
[
i
][0] = 
m7
[i][0];

431 
ãmp
[
i
][1] = 
m7
[i][1] +Åemp[i][0];

432 
ãmp
[
i
][2] = 
m7
[i][2] +Åemp[i][1];

433 
ãmp
[
i
][3] = 
m7
[i][3] +Åemp[i][2];

434 
ãmp
[
i
][4] = 
m7
[i][4] +Åemp[i][3];

435 
ãmp
[
i
][5] = 
m7
[i][5] +Åemp[i][4];

436 
ãmp
[
i
][6] = 
m7
[i][6] +Åemp[i][5];

437 
ãmp
[
i
][7] = 
m7
[i][7] +Åemp[i][6];

438 
ãmp
[
i
][8] = 
m7
[i][8] +Åemp[i][7];

439 
ãmp
[
i
][9] = 
m7
[i][9] +Åemp[i][8];

440 
ãmp
[
i
][10] = 
m7
[i][10] +Åemp[i][9];

441 
ãmp
[
i
][11] = 
m7
[i][11] +Åemp[i][10];

442 
ãmp
[
i
][12] = 
m7
[i][12] +Åemp[i][11];

443 
ãmp
[
i
][13] = 
m7
[i][13] +Åemp[i][12];

444 
ãmp
[
i
][14] = 
m7
[i][14] +Åemp[i][13];

445 
ãmp
[
i
][15] = 
m7
[i][15] +Åemp[i][14];

447 
i
=0; i<16; ++i)

449 
m7
[
i
][1] = 
ãmp
[i][1];

450 
m7
[
i
][2] = 
ãmp
[i][2];

451 
m7
[
i
][3] = 
ãmp
[i][3];

452 
m7
[
i
][4] = 
ãmp
[i][4];

453 
m7
[
i
][5] = 
ãmp
[i][5];

454 
m7
[
i
][6] = 
ãmp
[i][6];

455 
m7
[
i
][7] = 
ãmp
[i][7];

456 
m7
[
i
][8] = 
ãmp
[i][8];

457 
m7
[
i
][9] = 
ãmp
[i][9];

458 
m7
[
i
][10] = 
ãmp
[i][10];

459 
m7
[
i
][11] = 
ãmp
[i][11];

460 
m7
[
i
][12] = 
ãmp
[i][12];

461 
m7
[
i
][13] = 
ãmp
[i][13];

462 
m7
[
i
][14] = 
ãmp
[i][14];

463 
m7
[
i
][15] = 
ãmp
[i][15];

467 
	}
}

482 
	$ªsiduÆ_å™sf‹m_qu™t_luma_16x16_ls
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
)

484 
i
,
j
;

485 
ii
,
jj
;

487 
run
,
sˇn_pos
,
c€ff_˘r
;

488 
ac_c€f
 = 0;

489 
img≥l
 *
img_Y
, *
¥edY
;

491 
b8
, 
b4
;

494 
∂_off
 = 
∂
<<2;

495 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

496 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

497 
Boﬁón
 
is_ˇvlc
 = (BoﬁónË(
cuºSli˚
->
symbﬁ_mode
 =
CAVLC
);

498 * 
DCLevñ
 = 
cuºSli˚
->
cofDC
[
∂
][0];

499 * 
DCRun
 = 
cuºSli˚
->
cofDC
[
∂
][1];

500 * 
ACLevñ
;

501 * 
ACRun
;

502 
img≥l
 **
img_íc
 = 
p_Vid
->
íc_pi˘uª
->
p_cuº_img
;

503 *
m7
;

504 
√w_öåa_mode
 = 
cuºMB
->
i16mode
;

506 c⁄° 
	`byã
 (*
pos_sˇn
)[2] = 
cuºMB
->
is_fõld_mode
 ? 
FIELD_SCAN
 : 
SNGL_SCAN
;

507 
img≥l
 ***
cuº_m¥_16x16
 = 
cuºSli˚
->
m¥_16x16
[
∂
];

509 
j
 = 0; j < 16; ++j)

511 
¥edY
 = 
cuº_m¥_16x16
[
√w_öåa_mode
][
j
];

512 
img_Y
 = &
p_Vid
->
pCurImg
[
cuºMB
->
›ix_y
 + 
j
][cuºMB->
pix_x
];

513 
i
 = 0; i < 16; ++i)

515 
cuºSli˚
->
tblk16x16
[
j
][
i
] = 
img_Y
[i] - 
¥edY
[i];

519 i‡(
√w_öåa_mode
 < 2)

521 
	`ResiduÆ_DPCM_16x16
(
cuºSli˚
->
tblk16x16
, 
√w_öåa_mode
);

525 
j
 = 0; j < 4;++j)

526 
i
 = 0; i < 4;++i)

527 
cuºSli˚
->
tblk4x4
[
j
][
i
]cuºSli˚->
tblk16x16
[j << 2][i << 2];

529 
run
=-1;

530 
sˇn_pos
=0;

532 
c€ff_˘r
=0;coeff_ctr<16;++coeff_ctr)

534 
i
=
pos_sˇn
[
c€ff_˘r
][0];

535 
j
=
pos_sˇn
[
c€ff_˘r
][1];

537 ++
run
;

539 
m7
 = &
cuºSli˚
->
tblk4x4
[
j
][
i
];

541 i‡(*
m7
 != 0)

543 i‡(
is_ˇvlc
)

544 *
m7
 = 
	`iClù3
(-
CAVLC_LEVEL_LIMIT
, CAVLC_LEVEL_LIMIT, *m7);

546 
DCLevñ
[
sˇn_pos
 ] = *
m7
;

547 
DCRun
 [
sˇn_pos
++] = 
run
;

548 
run
=-1;

551 
DCLevñ
[
sˇn_pos
]=0;

554 
j
 = 0; j < 4;++j)

555 
i
 = 0; i < 4;++i)

556 
cuºSli˚
->
tblk16x16
[
j
 << 2][
i
 << 2] = cuºSli˚->
tblk4x4
[j][i];

559 
jj
 = 0; jj < 4; ++jj)

561 
ii
 = 0; ii < 4; ++ii)

563 
j
=0;j<4;++j)

565 
	`mem˝y
(
cuºSli˚
->
tblk4x4
[
j
],&cuºSli˚->
tblk16x16
[(
jj
<<2)+j][(
ii
<<2)], 
BLOCK_SIZE
 * ());

568 
run
 = -1;

569 
sˇn_pos
 = 0;

570 
b8
 = 2*(
jj
 >> 1Ë+ (
ii
 >> 1);

571 
b4
 = 2*(
jj
 & 0x01Ë+ (
ii
 & 0x01);

572 
ACLevñ
 = 
cuºSli˚
->
cofAC
 [
b8
+
∂_off
][
b4
][0];

573 
ACRun
 = 
cuºSli˚
->
cofAC
 [
b8
+
∂_off
][
b4
][1];

575 
c€ff_˘r
=1;coeff_ctr<16;coeff_ctr++)

577 
i
=
pos_sˇn
[
c€ff_˘r
][0];

578 
j
=
pos_sˇn
[
c€ff_˘r
][1];

580 
run
++;

581 
m7
 = &
cuºSli˚
->
tblk4x4
[
j
][
i
];

583 i‡(*
m7
 != 0)

585 i‡(
is_ˇvlc
)

586 *
m7
 = 
	`iClù3
(-
CAVLC_LEVEL_LIMIT
, CAVLC_LEVEL_LIMIT, *m7);

588 
ac_c€f
 = 15;

589 
ACLevñ
[
sˇn_pos
 ] = *
m7
;

590 
ACRun
 [
sˇn_pos
++] = 
run
;

591 
run
=-1;

595 
ACLevñ
[
sˇn_pos
] = 0;

597 
j
=0;j<4;++j)

598 
	`mem˝y
(&
cuºSli˚
->
tblk16x16
[(
jj
<<2)+
j
][(
ii
<<2)],cuºSli˚->
tblk4x4
[j], 
BLOCK_SIZE
 * ());

602 i‡(
√w_öåa_mode
 < 2)

604 
	`Inv_ResiduÆ_DPCM_16x16
(
cuºSli˚
->
tblk16x16
, 
√w_öåa_mode
);

608 
j
 = 0; j < 16; ++j)

610 
img_Y
 = &
img_íc
[
cuºMB
->
pix_y
 + 
j
][cuºMB->
pix_x
];

611 
¥edY
 = 
cuº_m¥_16x16
[
√w_öåa_mode
][
j
];

612 
i
 = 0; i < 16; ++i)

613 
img_Y
[
i
]=(
img≥l
)(
cuºSli˚
->
tblk16x16
[
j
][i] + 
¥edY
[i]);

616 if(
cuºSli˚
->
¶i˚_ty≥
 =
SP_SLICE
 || cuºSli˚->¶i˚_ty≥ =
SI_SLICE
)

618 
j
 = 
cuºMB
->
pix_y
; j < currMB->pix_y + 16;++j)

619 
i
 = 
cuºMB
->
pix_x
; i < currMB->pix_x + 16;++i)

620 
p_Vid
->
Ãec
[
j
][
i
]=-16;

623  
ac_c€f
;

624 
	}
}

626 
ölöe
 
	$check_zîo
(**
mb_‹es
, 
block_x
)

628 
i
, 
j
, 
k
 = 0;

630 
j
 = 0; (j < 
BLOCK_SIZE
Ë&& (
k
 == 0); ++j)

632 
i
 = 
block_x
; (i< block_x + 
BLOCK_SIZE
Ë&& (
k
 == 0); ++i)

635 
k
 |
mb_‹es
[
j
][
i
];

638  
k
;

639 
	}
}

660 
	$ªsiduÆ_å™sf‹m_qu™t_luma_4x4
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
block_x
,
block_y
, *
c€ff_co°
, 
öåa
)

662 
n⁄zîo
 = 
FALSE
;

664 
pos_x
 = 
block_x
 >> 
BLOCK_SHIFT
;

665 
pos_y
 = 
block_y
 >> 
BLOCK_SHIFT
;

666 
b8
 = 2*(
pos_y
 >> 1Ë+ (
pos_x
 >> 1Ë+ (
∂
<<2);

667 
b4
 = 2*(
pos_y
 & 0x01Ë+ (
pos_x
 & 0x01);

668 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

669 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

671 
img≥l
 **
img_íc
 = 
p_Vid
->
íc_pi˘uª
->
p_cuº_img
;

672 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_¥ed[
∂
];

673 **
mb_‹es
 = 
cuºSli˚
->mb_‹es[
∂
];

675 i‡(
	`check_zîo
(&
mb_‹es
[
block_y
], 
block_x
) != 0)

677 **
mb_ºes
 = 
cuºSli˚
->mb_ºes[
∂
];

678 
max_img≥l_vÆue
 = 
p_Vid
->max_imgpel_value;

679 
qp
 = (
p_Vid
->
yuv_f‹m©
==
YUV444
 && !
cuºSli˚
->
P444_joöed
)? 
cuºMB
->
qp_sˇÀd
[()’_Vid->
cﬁour_∂™e_id
)]: cuºMB->qp_sˇÀd[
∂
];

680 
Qu™tP¨amëîs
 *
p_Qu™t
 = 
p_Vid
->p_Quant;

681 
Qu™tMëhods
 
qu™t_mëhods
;

682 
qu™t_mëhods
.
ACLevñ
 = 
cuºSli˚
->
cofAC
[
b8
][
b4
][0];

683 
qu™t_mëhods
.
ACRun
 = 
cuºSli˚
->
cofAC
[
b8
][
b4
][1];

685 
qu™t_mëhods
.
block_x
 = block_x;

686 
qu™t_mëhods
.
block_y
 = block_y;

687 
qu™t_mëhods
.
qp
 = qp;

688 
qu™t_mëhods
.
q_∑øms
 = 
p_Qu™t
->
q_∑øms_4x4
[
∂
][
öåa
][
qp
];

689 
qu™t_mëhods
.
Ádju°
 = 
p_Vid
->
Ad≠tiveRoundög
 ? (&p_Vid->
ARCofAdj4x4
[
∂
][
cuºMB
->
¨_mode
][
block_y
]Ë: 
NULL
;

690 
qu™t_mëhods
.
c€ff_co°
 = coeff_cost;

691 
qu™t_mëhods
.
pos_sˇn
 = 
cuºMB
->
is_fõld_mode
 ? 
FIELD_SCAN
 : 
SNGL_SCAN
;

692 
qu™t_mëhods
.
c_co°
 = 
COEFF_COST4x4
[
cuºSli˚
->
di°hªs
];

694 
cuºMB
->
subblock_x
 = ((
b8
&0x1)==0Ë? (((
b4
&0x1)==0)? 0: 4) : (((b4&0x1)==0)? 8: 12);

695 
cuºMB
->
subblock_y
 = (
b8
<2Ë? ((
b4
<2) ? 0: 4) : ((b4<2) ? 8: 12);

698 
	`f‹w¨d4x4
(
mb_‹es
, 
cuºSli˚
->
tblk16x16
, 
block_y
, 
block_x
);

701 
n⁄zîo
 = 
cuºSli˚
->
	`qu™t_4x4
(
cuºMB
, &cuºSli˚->
tblk16x16
[
block_y
], &
qu™t_mëhods
);

704 i‡(
n⁄zîo
)

707 
	`övî£4x4
(
cuºSli˚
->
tblk16x16
, 
mb_ºes
, 
block_y
, 
block_x
);

710 
	`ßm∂e_ªc⁄°ru˘
 (&
img_íc
[
cuºMB
->
pix_y
 + 
block_y
], &
mb_¥ed
[block_y], &
mb_ºes
[block_y], 
block_x
, cuºMB->
pix_x
 + block_x, 
BLOCK_SIZE
, BLOCK_SIZE, 
max_img≥l_vÆue
, 
DQ_BITS
);

714 
	`c›y_image_d©a_4x4
(&
img_íc
[
cuºMB
->
pix_y
 + 
block_y
], &
mb_¥ed
[block_y], cuºMB->
pix_x
 + 
block_x
, block_x);

719 
cuºSli˚
->
cofAC
[
b8
][
b4
][0][0] = 0;

720 
	`c›y_image_d©a_4x4
(&
img_íc
[
cuºMB
->
pix_y
 + 
block_y
], &
mb_¥ed
[block_y], cuºMB->
pix_x
 + 
block_x
, block_x);

723  
n⁄zîo
;

724 
	}
}

748 
	$ªsiduÆ_å™sf‹m_qu™t_luma_4x4_ls
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
block_x
,
block_y
,*
c€ff_co°
, 
öåa
)

750 
i
,
j
, 
c€ff_˘r
;

751 
run
 = -1;

752 
n⁄zîo
 = 
FALSE
;

754 
pos_x
 = 
block_x
 >> 
BLOCK_SHIFT
;

755 
pos_y
 = 
block_y
 >> 
BLOCK_SHIFT
;

756 
b8
 = 2*(
pos_y
 >> 1Ë+ (
pos_x
 >> 1Ë+ (
∂
<<2);

757 
b4
 = 2*(
pos_y
 & 0x01Ë+ (
pos_x
 & 0x01);

759 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

760 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

761 
Boﬁón
 
is_ˇvlc
 = (BoﬁónË(
cuºSli˚
->
symbﬁ_mode
 =
CAVLC
);

762 * 
ACL
 = &
cuºSli˚
->
cofAC
[
b8
][
b4
][0][0];

763 * 
ACR
 = &
cuºSli˚
->
cofAC
[
b8
][
b4
][1][0];

765 
pix_y
, 
pix_x
;

766 
img≥l
 **
img_íc
 = 
p_Vid
->
íc_pi˘uª
->
p_cuº_img
;

767 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_¥ed[
∂
];

768 **
mb_‹es
 = 
cuºSli˚
->mb_‹es[
∂
];

769 **
mb_ºes
 = 
cuºSli˚
->mb_ºes[
∂
];

770 *
m7
;

772 c⁄° 
byã
 *
p_sˇn
 = 
cuºMB
->
is_fõld_mode
 ? &
FIELD_SCAN
[0][0] : &
SNGL_SCAN
[0][0];

775 **
Ádju°4x4
 = 
p_Vid
->
Ad≠tiveRoundög
 ? (&p_Vid->
ARCofAdj4x4
[
∂
][
cuºMB
->
¨_mode
][
block_y
]Ë: 
NULL
;

777 if–(
cuºMB
->
ùmode_DPCM
 < 2Ë&& (
öåa
))

779 
	`ResiduÆ_DPCM_4x4
(
cuºMB
->
ùmode_DPCM
, 
mb_‹es
, 
mb_ºes
, 
block_y
, 
block_x
);

783 
j
=
block_y
; j < block_y + 
BLOCK_SIZE
; ++j)

784 
i
=
block_x
; i < block_x + 
BLOCK_SIZE
; ++i)

785 
mb_ºes
[
j
][
i
] = 
mb_‹es
[j][i];

788 
c€ff_˘r
=0;coeff_ctr < 16;coeff_ctr++)

790 
i
 = *
p_sˇn
++;

791 
j
 = *
p_sˇn
++;

793 
run
++;

795 
m7
 = &
mb_ºes
[
block_y
 + 
j
][
block_x
 + 
i
];

797 i‡(
p_Vid
->
Ad≠tiveRoundög
)

798 
Ádju°4x4
[
j
][
block_x
+
i
] = 0;

800 i‡(*
m7
 != 0)

802 i‡(
is_ˇvlc
)

803 *
m7
 = 
	`iClù3
(-
CAVLC_LEVEL_LIMIT
, CAVLC_LEVEL_LIMIT, *m7);

805 
n⁄zîo
=
TRUE
;

806 *
c€ff_co°
 +
MAX_VALUE
;

807 *
ACL
++ = *
m7
;

808 *
ACR
++ = 
run
;

809 
run
=-1;

812 *
ACL
 = 0;

814 if–(
cuºMB
->
ùmode_DPCM
 < 2Ë&& (
öåa
))

816 
	`Inv_ResiduÆ_DPCM_4x4
(
cuºMB
, 
mb_ºes
, 
block_y
, 
block_x
);

819 
j
=0; j < 
BLOCK_SIZE
; ++j)

821 
pix_y
 = 
cuºMB
->pix_y + 
block_y
 + 
j
;

822 
pix_x
 = 
cuºMB
->pix_x+
block_x
;

823 
i
=0; i < 
BLOCK_SIZE
; ++i)

825 
img_íc
[
pix_y
][
pix_x
+
i
] = (
img≥l
Ë(
mb_ºes
[
j
+
block_y
][i+
block_x
] + 
mb_¥ed
[j+block_y][i+block_x]);

829  
n⁄zîo
;

830 
	}
}

841 
	$ResiduÆ_DPCM_4x4
(
ùmode
, **
mb_‹es
, **
mb_ºes
, 
block_y
, 
block_x
)

843 
i
;

844 
ãmp
[4][4];

846 if(
ùmode
==
VERT_PRED
)

848 
i
=0; i<4; ++i)

850 
ãmp
[0][
i
] = 
mb_‹es
[
block_y
 + 0][
block_x
 + i];

851 
ãmp
[1][
i
] = 
mb_‹es
[
block_y
 + 1][
block_x
 + i] - mb_ores[block_y ][block_x + i];

852 
ãmp
[2][
i
] = 
mb_‹es
[
block_y
 + 2][
block_x
 + i] - mb_ores[block_y + 1][block_x + i];

853 
ãmp
[3][
i
] = 
mb_‹es
[
block_y
 + 3][
block_x
 + i] - mb_ores[block_y + 2][block_x + i];

856 
i
 = 0; i < 4; ++i)

858 
mb_ºes
[
block_y
 + 0][
block_x
 + 
i
] = 
ãmp
[0][i];

859 
mb_ºes
[
block_y
 + 1][
block_x
 + 
i
] = 
ãmp
[1][i];

860 
mb_ºes
[
block_y
 + 2][
block_x
 + 
i
] = 
ãmp
[2][i];

861 
mb_ºes
[
block_y
 + 3][
block_x
 + 
i
] = 
ãmp
[3][i];

866 
i
=0; i<4; ++i)

868 
ãmp
[
i
][0] = 
mb_‹es
[
block_y
 + i][
block_x
];

869 
ãmp
[
i
][1] = 
mb_‹es
[
block_y
 + i][
block_x
 + 1] - mb_ores[block_y + i][block_x ];

870 
ãmp
[
i
][2] = 
mb_‹es
[
block_y
 + i][
block_x
 + 2] - mb_ores[block_y + i][block_x + 1];

871 
ãmp
[
i
][3] = 
mb_‹es
[
block_y
 + i][
block_x
 + 3] - mb_ores[block_y + i][block_x + 2];

874 
i
=0; i<4; ++i)

876 
mb_ºes
[
block_y
 + 
i
][
block_x
 + 0] = 
ãmp
[i][0];

877 
mb_ºes
[
block_y
 + 
i
][
block_x
 + 1] = 
ãmp
[i][1];

878 
mb_ºes
[
block_y
 + 
i
][
block_x
 + 2] = 
ãmp
[i][2];

879 
mb_ºes
[
block_y
 + 
i
][
block_x
 + 3] = 
ãmp
[i][3];

883 
	}
}

895 
	$Inv_ResiduÆ_DPCM_4x4
(
Ma¸oblock
 *
cuºMB
, **
m7
, 
block_y
, 
block_x
)

897 
i
;

898 
ãmp
[4][4];

900 if(
cuºMB
->
ùmode_DPCM
 =
VERT_PRED
)

902 
i
=0; i<4; ++i)

904 
ãmp
[0][
i
] = 
m7
[
block_y
 + 0][
block_x
 + i];

905 
ãmp
[1][
i
] = 
m7
[
block_y
 + 1][
block_x
 + i] +Åemp[0][i];

906 
ãmp
[2][
i
] = 
m7
[
block_y
 + 2][
block_x
 + i] +Åemp[1][i];

907 
ãmp
[3][
i
] = 
m7
[
block_y
 + 3][
block_x
 + i] +Åemp[2][i];

909 
i
=0; i<4; ++i)

911 
m7
[
block_y
 + 0][
block_x
 + 
i
] = 
ãmp
[0][i];

912 
m7
[
block_y
 + 1][
block_x
 + 
i
] = 
ãmp
[1][i];

913 
m7
[
block_y
 + 2][
block_x
 + 
i
] = 
ãmp
[2][i];

914 
m7
[
block_y
 + 3][
block_x
 + 
i
] = 
ãmp
[3][i];

919 
i
=0; i<4; ++i)

921 
ãmp
[
i
][0] = 
m7
[
block_y
 + i][
block_x
 + 0];

922 
ãmp
[
i
][1] = 
m7
[
block_y
 + i][
block_x
 + 1] +Åemp[i][0];

923 
ãmp
[
i
][2] = 
m7
[
block_y
 + i][
block_x
 + 2] +Åemp[i][1];

924 
ãmp
[
i
][3] = 
m7
[
block_y
 + i][
block_x
 + 3] +Åemp[i][2];

926 
i
=0; i<4; ++i)

928 
m7
[
block_y
+
i
][
block_x
 ] = 
ãmp
[i][0];

929 
m7
[
block_y
+
i
][
block_x
+1] = 
ãmp
[i][1];

930 
m7
[
block_y
+
i
][
block_x
+2] = 
ãmp
[i][2];

931 
m7
[
block_y
+
i
][
block_x
+3] = 
ãmp
[i][3];

935 
	}
}

953 
	$ªsiduÆ_å™sf‹m_qu™t_chroma_4x4
(
Ma¸oblock
 *
cuºMB
, 
uv
, 
¸_cbp
)

955 
i
, 
j
, 
n2
, 
n1
, 
c€ff_˘r
;

956 *
m1
;

957 
c€ff_co°
 = 0;

958 
¸_cbp_tmp
 = 0;

959 
DCzîo
 = 
FALSE
;

960 
n⁄zîo
[4][4] = {{
FALSE
}};

961 
n⁄ezîo
 = 
FALSE
;

963 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

964 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

965 
Qu™tP¨amëîs
 *
p_Qu™t
 = 
p_Vid
->p_Quant;

967 
b4
;

968 * 
DCLevñ
 = 
cuºSli˚
->
cofDC
[
uv
+1][0];

969 * 
DCRun
 = 
cuºSli˚
->
cofDC
[
uv
+1][1];

970 
öåa
 = 
	`is_öåa
 (
cuºMB
);

971 
uv_sˇÀ
 = 
uv
 * (
p_Vid
->
num_blk8x8_uv
 >> 1);

974 c⁄° 
öt64
 
cbpblk_∑âîn
[4]={0, 0xf0000, 0xff0000, 0xffff0000};

975 
yuv
 = 
p_Vid
->
yuv_f‹m©
;

976 
b8
;

978 c⁄° 
	`byã
 (*
pos_sˇn
)[2] = 
cuºMB
->
is_fõld_mode
 ? 
FIELD_SCAN
 : 
SNGL_SCAN
;

979 
cur_qp
 = 
cuºMB
->
qpc
[
uv
] + 
cuºSli˚
->
bôdïth_chroma_qp_sˇÀ
;

981 
max_img≥l_vÆue_uv
 = 
p_Vid
->
max_≥l_vÆue_comp
[
uv
 + 1];

983 **
mb_ºes
 = 
cuºSli˚
->mb_ºes[
uv
 + 1];

984 **
mb_‹es
 = 
cuºSli˚
->mb_‹es[
uv
 + 1];

985 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_¥ed[
uv
 + 1];

987 
Qu™tMëhods
 
qu™t_mëhods
;

989 
qu™t_mëhods
.
qp
 = 
cur_qp
;

990 
qu™t_mëhods
.
q_∑øms
 = 
p_Qu™t
->
q_∑øms_4x4
[
uv
 + 1][
öåa
][
cur_qp
];

991 
qu™t_mëhods
.
ty≥
 = 
CHROMA_AC
;

992 i‡(
cuºMB
->
mb_ty≥
 =
P8x8
 && cuºMB->
luma_å™sf‹m_size_8x8_Êag
)

995 
qu™t_mëhods
.
Ádju°
 = 
p_Vid
->
Ad≠tiveRoundög
 ?Ö_Vid->
ARCofAdj4x4
[
uv
 + 1][4] : 
NULL
;

999 
qu™t_mëhods
.
Ádju°
 = 
p_Vid
->
Ad≠tiveRoundög
 ?Ö_Vid->
ARCofAdj4x4
[
uv
 + 1][
cuºMB
->
¨_mode
] : 
NULL
;

1002 
qu™t_mëhods
.
pos_sˇn
 = 
cuºMB
->
is_fõld_mode
 ? 
FIELD_SCAN
 : 
SNGL_SCAN
;

1003 
qu™t_mëhods
.
c_co°
 = 
COEFF_COST4x4
[
cuºSli˚
->
di°hªs
];

1004 
qu™t_mëhods
.
c€ff_co°
 = &coeff_cost;

1007 
p_Vid
->
is_v_block
 = 
uv
;

1010 
n2
=0;Ç2 < 
p_Vid
->
mb_¸_size_y
;Ç2 +
BLOCK_SIZE
)

1012 
n1
=0;Ç1 < 
p_Vid
->
mb_¸_size_x
;Ç1 +
BLOCK_SIZE
)

1014 i‡(
	`check_zîo
(&
mb_‹es
[
n2
], 
n1
) == 0)

1016 
j
 = 
n2
; j <Ç2 + 
BLOCK_SIZE
; j++)

1017 
i
 = 
n1
; i <Ç1 + 
BLOCK_SIZE
; i++)

1018 
mb_ºes
[
j
][
i
] = 0;

1022 
	`f‹w¨d4x4
(
mb_‹es
, 
mb_ºes
, 
n2
, 
n1
);

1028 i‡(
yuv
 =
YUV420
)

1030 **
Ádju°2x2
 = 
NULL
;

1032 
m1
 = 
cuºSli˚
->
tblk4x4
[0];

1036 
	`hadam¨d2x2
(
mb_ºes
, 
m1
);

1039 
DCzîo
 = 
cuºSli˚
->
	`qu™t_dc_¸
(
cuºMB
, &
m1
, 
cur_qp
, 
DCLevñ
, 
DCRun
, &
qu™t_mëhods
.
q_∑øms
[0][0], 
Ádju°2x2
, 
SCAN_YUV420
);

1041 i‡(
DCzîo
)

1043 
cuºMB
->
cbp_blk
 |0xf0000 << (
uv
 << 2) ;

1044 
¸_cbp
=
	`imax
(1,cr_cbp);

1048 
	`ihadam¨d2x2
(
m1
, m1);

1050 
mb_ºes
[0][0] = 
m1
[0] >> 5;

1051 
mb_ºes
[0][4] = 
m1
[1] >> 5;

1052 
mb_ºes
[4][0] = 
m1
[2] >> 5;

1053 
mb_ºes
[4][4] = 
m1
[3] >> 5;

1055 i‡(
yuv
 =
YUV422
)

1057 **
Ádju°4x2
 = 
NULL
;

1059 
cur_qp_dc
 = 
cuºMB
->
qpc
[
uv
] + 3 + 
cuºSli˚
->
bôdïth_chroma_qp_sˇÀ
;

1061 
LevñQu™tP¨ams
 **
qu™t_∑ømsDC
 = 
p_Qu™t
->
q_∑øms_4x4
[
uv
 + 1][
öåa
][
cur_qp_dc
];

1065 
j
=0; j < 
p_Vid
->
mb_¸_size_y
; j+=
BLOCK_SIZE
)

1067 
i
=0; i < 
p_Vid
->
mb_¸_size_x
; i+=
BLOCK_SIZE
)

1068 
cuºSli˚
->
tblk4x4
[
i
>>2][
j
>>2]
mb_ºes
[j][i];

1072 
	`hadam¨d4x2
(
cuºSli˚
->
tblk4x4
, currSlice->tblk4x4);

1075 
DCzîo
 = 
cuºSli˚
->
	`qu™t_dc_¸
(
cuºMB
, cuºSli˚->
tblk4x4
, 
cur_qp_dc
, 
DCLevñ
, 
DCRun
, &
qu™t_∑ømsDC
[0][0], 
Ádju°4x2
, 
SCAN_YUV422
);

1077 i‡(
DCzîo
)

1079 
cuºMB
->
cbp_blk
 |0xff0000 << (
uv
 << 3) ;

1080 
¸_cbp
=
	`imax
(1,cr_cbp);

1084 
	`ihadam¨d4x2
(
cuºSli˚
->
tblk4x4
, currSlice->tblk4x4);

1087 
j
 = 0; j < 4; ++j)

1089 
mb_ºes
[
j
 << 2 ][0] = 
	`rshi·_∫d_sf
(
cuºSli˚
->
tblk4x4
[j][0], 6);

1090 
mb_ºes
[
j
 << 2 ][4] = 
	`rshi·_∫d_sf
(
cuºSli˚
->
tblk4x4
[j][1], 6);

1095 
b8
=0; b8 < (
p_Vid
->
num_blk8x8_uv
 >> 1); b8++)

1097 
b4
=0; b4 < 4; b4++)

1099 
öt64
 
uv_cbpblk
 = ((öt64)1Ë<< 
cbp_blk_chroma
[
b8
 + 
uv_sˇÀ
][
b4
];

1100 
n1
 = 
h‹_off£t
[
yuv
][
b8
][
b4
];

1101 
n2
 = 
vî_off£t
[
yuv
][
b8
][
b4
];

1102 
qu™t_mëhods
.
ACLevñ
 = 
cuºSli˚
->
cofAC
[4 + 
b8
 + 
uv_sˇÀ
][
b4
][0];

1103 
qu™t_mëhods
.
ACRun
 = 
cuºSli˚
->
cofAC
[4 + 
b8
 + 
uv_sˇÀ
][
b4
][1];

1104 
qu™t_mëhods
.
block_x
 = 
n1
;

1105 
qu™t_mëhods
.
block_y
 = 
n2
;

1107 
cuºMB
->
subblock_y
 = 
subblk_off£t_y
[
p_Vid
->
yuv_f‹m©
 - 1][
b8
][
b4
];

1108 
cuºMB
->
subblock_x
 = 
subblk_off£t_x
[
p_Vid
->
yuv_f‹m©
 - 1][
b8
][
b4
];

1109 i‡(
p_Vid
->
Ad≠tiveRoundög
)

1111 i‡(
cuºMB
->
mb_ty≥
 =
P8x8
 && cuºMB->
luma_å™sf‹m_size_8x8_Êag
)

1114 
qu™t_mëhods
.
Ádju°
 = &
p_Vid
->
ARCofAdj4x4
[
uv
 + 1][4][
n2
];

1118 
qu™t_mëhods
.
Ádju°
 = &
p_Vid
->
ARCofAdj4x4
[
uv
 + 1][
cuºMB
->
¨_mode
][
n2
];

1123 
qu™t_mëhods
.
Ádju°
 = 
NULL
;

1127 
n⁄zîo
[
n2
>>2][
n1
>>2] = 
cuºSli˚
->
	`qu™t_ac4x4¸
(
cuºMB
, &
mb_ºes
[n2], &
qu™t_mëhods
);

1129 i‡(
n⁄zîo
[
n2
>>2][
n1
>>2])

1131 
cuºMB
->
cbp_blk
 |
uv_cbpblk
;

1132 
¸_cbp_tmp
 = 2;

1133 
n⁄ezîo
 = 
TRUE
;

1140 if(
n⁄ezîo
 && 
c€ff_co°
 < 
_CHROMA_COEFF_COST_
)

1142 
öt64
 
uv_cbpblk
 = ((öt64)
cbpblk_∑âîn
[
yuv
] << (
uv
 << (1+yuv)));

1143 
¸_cbp_tmp
 = 0;

1145 
b8
 = 0; b8 < (
p_Vid
->
num_blk8x8_uv
 >> 1); b8++)

1147 
b4
 = 0; b4 < 4; b4++)

1149 
n1
 = 
h‹_off£t
[
yuv
][
b8
][
b4
];

1150 
n2
 = 
vî_off£t
[
yuv
][
b8
][
b4
];

1151 i‡(
n⁄zîo
[
n2
>>2][
n1
>>2] =
TRUE
)

1153 
n⁄zîo
[
n2
>>2][
n1
>>2] = 
FALSE
;

1154 
qu™t_mëhods
.
ACLevñ
 = 
cuºSli˚
->
cofAC
[4 + 
b8
 + 
uv_sˇÀ
][
b4
][0];

1155 
qu™t_mëhods
.
ACRun
 = 
cuºSli˚
->
cofAC
[4 + 
b8
 + 
uv_sˇÀ
][
b4
][1];

1157 i‡(
DCzîo
 == 0)

1158 
cuºMB
->
cbp_blk
 &~(
uv_cbpblk
);

1160 
qu™t_mëhods
.
ACLevñ
[0] = 0;

1162 
c€ff_˘r
=1; coeff_ctr < 16; coeff_ctr++)

1164 
mb_ºes
[
n2
 + 
pos_sˇn
[
c€ff_˘r
][1]][
n1
 +Öos_scan[coeff_ctr][0]] = 0;

1165 
qu™t_mëhods
.
ACLevñ
[
c€ff_˘r
] = 0;

1174 if(
¸_cbp_tmp
 == 2)

1175 
¸_cbp
 = 2;

1177 
n⁄ezîo
 = 
FALSE
;

1178 
n2
=0;Ç2 < 
p_Vid
->
mb_¸_size_y
;Ç2 +
BLOCK_SIZE
)

1180 
n1
=0;Ç1 < 
p_Vid
->
mb_¸_size_x
;Ç1 +
BLOCK_SIZE
)

1182 i‡(
mb_ºes
[
n2
][
n1
] !0 || 
n⁄zîo
[n2>>2][n1>>2] =
TRUE
)

1184 
	`övî£4x4
(
mb_ºes
, mb_ºes, 
n2
, 
n1
);

1185 
n⁄ezîo
 = 
TRUE
;

1191 i‡(
n⁄ezîo
 =
TRUE
)

1193 
	`ßm∂e_ªc⁄°ru˘
 (&
p_Vid
->
íc_pi˘uª
->
imgUV
[
uv
][
cuºMB
->
pix_c_y
], 
mb_¥ed
, 
mb_ºes
, 0, cuºMB->
pix_c_x
,Ö_Vid->
mb_¸_size_x
,Ö_Vid->
mb_¸_size_y
, 
max_img≥l_vÆue_uv
, 
DQ_BITS
);

1197 
	`c›y_image_d©a
(&
p_Vid
->
íc_pi˘uª
->
imgUV
[
uv
][
cuºMB
->
pix_c_y
], 
mb_¥ed
, cuºMB->
pix_c_x
, 0,Ö_Vid->
mb_¸_size_x
,Ö_Vid->
mb_¸_size_y
);

1200  
¸_cbp
;

1201 
	}
}

1203 
	$ResiduÆ_DPCM_Chroma
(
ùmode
, **
‹es
, **
ºes
, 
width
, 
height
)

1205 
i
,
j
;

1206 
ãmp
[16][16];

1208 if(
ùmode
==
VERT_PRED_8
)

1210 
j
=0; j<
width
; j++)

1211 
ãmp
[0][
j
] = 
‹es
[0][j];

1213 
j
=0; j<
width
; j++)

1214 
i
=1; i<
height
; i++)

1215 
ãmp
[
i
][
j
] = 
‹es
[i][j] - ores[i-1][j];

1217 
i
 = 0; i < 
height
; i++)

1218 
j
 = 0; j < 
width
; j++)

1219 
ºes
[
i
][
j
] = 
ãmp
[i][j];

1223 
i
=0; i<
height
; i++)

1224 
ãmp
[
i
][0] = 
‹es
[i][0];

1226 
i
=0; i<
height
; i++)

1227 
j
=1; j<
width
; j++)

1228 
ãmp
[
i
][
j
] = 
‹es
[i][j] - ores[i][j-1];

1230 
i
=0; i<
height
; i++)

1231 
j
=0; j<
width
; j++)

1232 
ºes
[
i
][
j
] = 
ãmp
[i][j];

1236 
	}
}

1238 
	$Inv_ResiduÆ_DPCM_Chroma
(
ùmode
, **
m7
, 
width
, 
height
)

1240 
i
, 
j
;

1241 
ãmp
[16][16];

1243 if(
ùmode
 =
VERT_PRED_8
)

1245 
i
=0; i<
width
; i++)

1247 
ãmp
[0][
i
] = 
m7
[0][i];

1248 
j
=1; j<
height
; j++)

1250 
ãmp
[
j
][
i
] =Åemp[j-1][i] + 
m7
[j][i];

1253 
i
=0; i<
height
; i++)

1255 
j
 = 0; j < 
width
; j++)

1257 
m7
[
i
][
j
] = 
ãmp
[i][j];

1263 
i
=0; i<
height
; i++)

1265 
ãmp
[
i
][0] = 
m7
[i][0];

1266 
j
 = 1; j < 
width
; j++)

1268 
ãmp
[
i
][
j
] =Åemp[i][j-1] + 
m7
[i][j];

1271 
i
=0; i<
height
; i++)

1273 
j
 = 0; j < 
width
; j++)

1275 
m7
[
i
][
j
] = 
ãmp
[i][j];

1280 
	}
}

1298 
	$ªsiduÆ_å™sf‹m_qu™t_chroma_4x4_ls
(
Ma¸oblock
 *
cuºMB
, 
uv
, 
¸_cbp
)

1300 
i
,
j
,
n2
,
n1
,
c€ff_˘r
,
Àvñ
 ,
sˇn_pos
,
run
;

1301 
m1
[
BLOCK_SIZE
];

1302 
c€ff_co°
;

1303 
img≥l
 *
‹ig_img
, *
¥ed_img
;

1305 
b4
;

1306 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1307 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

1308 
Boﬁón
 
is_ˇvlc
 = (BoﬁónË(
cuºSli˚
->
symbﬁ_mode
 =
CAVLC
);

1309 * 
DCLevñ
 = 
cuºSli˚
->
cofDC
[
uv
+1][0];

1310 * 
DCRun
 = 
cuºSli˚
->
cofDC
[
uv
+1][1];

1311 * 
ACLevñ
;

1312 * 
ACRun
;

1313 
uv_sˇÀ
 = 
uv
 * (
p_Vid
->
num_blk8x8_uv
 >> 1);

1316 
yuv
 = 
p_Vid
->
yuv_f‹m©
;

1317 
b8
;

1318 *
m7
;

1319 
m3
[4][4];

1321 c⁄° 
	`byã
 (*
pos_sˇn
)[2] = 
cuºMB
->
is_fõld_mode
 ? 
FIELD_SCAN
 : 
SNGL_SCAN
;

1322 **
mb_ºes
 = 
cuºSli˚
->mb_ºes[
uv
 + 1];

1323 **
mb_‹es
 = 
cuºSli˚
->mb_‹es[
uv
 + 1];

1324 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_¥ed[
uv
 + 1];

1325 **
Ádju°4x4
;

1327 
öåa
 = ((
cuºMB
->
mb_ty≥
 =
I4MB
Ë|| (cuºMB->mb_ty≥ =
I8MB
Ë|| (cuºMB->mb_ty≥ =
I16MB
));

1330 i‡(
cuºMB
->
mb_ty≥
 =
P8x8
 && cuºMB->
luma_å™sf‹m_size_8x8_Êag
)

1333 
Ádju°4x4
 = 
p_Vid
->
Ad≠tiveRoundög
 ?Ö_Vid->
ARCofAdj4x4
[
uv
 + 1][4] : 
NULL
;

1337 
Ádju°4x4
 = 
p_Vid
->
Ad≠tiveRoundög
 ?Ö_Vid->
ARCofAdj4x4
[
uv
 + 1][
cuºMB
->
¨_mode
] : 
NULL
;

1340 if((
cuºMB
->
c_ùªd_mode
 =
HOR_PRED_8
 || cuºMB->c_ùªd_modê=
VERT_PRED_8
Ë&& (
öåa
))

1342 
	`ResiduÆ_DPCM_Chroma
(
cuºMB
->
c_ùªd_mode
, 
mb_‹es
, 
mb_ºes
, 
p_Vid
->
mb_¸_size_x
,Ö_Vid->
mb_¸_size_y
);

1346 
j
=0; j < 
p_Vid
->
mb_¸_size_y
; j++)

1348 
i
=0; i < 
p_Vid
->
mb_¸_size_x
; i++)

1350 
mb_ºes
[
j
][
i
] = 
mb_‹es
[j][i];

1355 i‡(
yuv
 =
YUV420
)

1359 
run
=-1;

1360 
sˇn_pos
=0;

1361 
m1
[0] = 
mb_ºes
[0][0] ;

1362 
m1
[1] = 
mb_ºes
[0][4] ;

1363 
m1
[2] = 
mb_ºes
[4][0] ;

1364 
m1
[3] = 
mb_ºes
[4][4] ;

1366 
c€ff_˘r
=0; coeff_ctr < 4; coeff_ctr++)

1368 
run
++;

1370 
Àvñ
 =
	`übs
(
m1
[
c€ff_˘r
]);

1372 i‡(
Àvñ
 != 0)

1374 i‡(
is_ˇvlc
)

1375 
Àvñ
 = 
	`imö
÷evñ, 
CAVLC_LEVEL_LIMIT
);

1377 
cuºMB
->
cbp_blk
 |0xf0000 << (
uv
 << 2) ;

1378 
¸_cbp
=
	`imax
(1, cr_cbp);

1379 
Àvñ
 = 
	`isig«b
÷evñ, 
m1
[
c€ff_˘r
]);

1380 
DCLevñ
[
sˇn_pos
 ] = 
Àvñ
;

1381 
DCRun
 [
sˇn_pos
++] = 
run
;

1382 
run
=-1;

1385 
DCLevñ
[
sˇn_pos
] = 0;

1387 if(
yuv
 =
YUV422
)

1394 
j
=0; j < 
p_Vid
->
mb_¸_size_y
; j+=
BLOCK_SIZE
)

1396 
i
=0; i < 
p_Vid
->
mb_¸_size_x
; i+=
BLOCK_SIZE
)

1398 
m3
[
i
>>2][
j
>>2] = 
mb_ºes
[j][i];

1403 
run
=-1;

1404 
sˇn_pos
=0;

1407 
c€ff_˘r
=0;coeff_ctr<8;coeff_ctr++)

1409 
i
=
SCAN_YUV422
[
c€ff_˘r
][0];

1410 
j
=
SCAN_YUV422
[
c€ff_˘r
][1];

1412 
run
++;

1414 
Àvñ
 = 
	`übs
(
m3
[
i
][
j
]);

1415 
cuºSli˚
->
tblk4x4
[
i
][
j
]=
m3
[i][j];

1417 i‡(
Àvñ
 != 0)

1420 
cuºMB
->
cbp_blk
 |0xff0000 << (
uv
 << 3) ;

1421 
¸_cbp
=
	`imax
(1,cr_cbp);

1423 
DCLevñ
[
sˇn_pos
 ] = 
	`isig«b
(
Àvñ
,
cuºSli˚
->
tblk4x4
[
i
][
j
]);

1424 
DCRun
 [
sˇn_pos
++] = 
run
;

1425 
run
=-1;

1428 
DCLevñ
[
sˇn_pos
]=0;

1435 
c€ff_co°
=0;

1437 
b8
=0; b8 < (
p_Vid
->
num_blk8x8_uv
 >> 1); b8++)

1439 
b4
=0; b4 < 4; b4++)

1441 
öt64
 
uv_cbpblk
 = ((öt64)1Ë<< 
cbp_blk_chroma
[
b8
 + 
uv_sˇÀ
][
b4
];

1442 
n1
 = 
h‹_off£t
[
yuv
][
b8
][
b4
];

1443 
n2
 = 
vî_off£t
[
yuv
][
b8
][
b4
];

1444 
ACLevñ
 = 
cuºSli˚
->
cofAC
[4 + 
b8
 + 
uv_sˇÀ
][
b4
][0];

1445 
ACRun
 = 
cuºSli˚
->
cofAC
[4 + 
b8
 + 
uv_sˇÀ
][
b4
][1];

1446 
run
=-1;

1447 
sˇn_pos
=0;

1449 
c€ff_˘r
=1; coeff_ctr < 16; coeff_ctr++)

1451 
i
=
pos_sˇn
[
c€ff_˘r
][0];

1452 
j
=
pos_sˇn
[
c€ff_˘r
][1];

1454 ++
run
;

1456 
Àvñ
 = 
	`übs
(
mb_ºes
[
n2
+
j
][
n1
+
i
]);

1458 i‡(
p_Vid
->
Ad≠tiveRoundög
)

1460 
Ádju°4x4
[
n2
+
j
][
n1
+
i
] = 0;

1463 i‡(
Àvñ
 != 0)

1465 
¸_cbp
=
	`imax
(2, cr_cbp);

1467 
cuºMB
->
cbp_blk
 |
uv_cbpblk
;

1468 
c€ff_co°
 +
MAX_VALUE
;

1470 
ACLevñ
[
sˇn_pos
 ] = 
	`isig«b
(
Àvñ
, 
mb_ºes
[
n2
+
j
][
n1
+
i
]);

1471 
ACRun
 [
sˇn_pos
++] = 
run
;

1472 
run
=-1;

1474 
Àvñ
 = 
	`isig«b
÷evñ, 
mb_ºes
[
n2
+
j
][
n1
+
i
]);

1477 
ACLevñ
[
sˇn_pos
] = 0;

1481 if((
cuºMB
->
c_ùªd_mode
 =
HOR_PRED_8
 || cuºMB->c_ùªd_modê=
VERT_PRED_8
Ë&& 
öåa
)

1483 
	`Inv_ResiduÆ_DPCM_Chroma
(
cuºMB
->
c_ùªd_mode
, 
mb_ºes
, 
p_Vid
->
mb_¸_size_x
,Ö_Vid->
mb_¸_size_y
) ;

1486 
j
=0; j < 
p_Vid
->
mb_¸_size_y
; ++j)

1488 
‹ig_img
 = &
p_Vid
->
íc_pi˘uª
->
imgUV
[
uv
][
cuºMB
->
pix_c_y
 + 
j
][cuºMB->
pix_c_x
];

1489 
m7
 = 
mb_ºes
[
j
];

1490 
¥ed_img
 = 
mb_¥ed
[
j
];

1491 
i
=0; i < 
p_Vid
->
mb_¸_size_x
; ++i)

1493 
‹ig_img
[
i
] = (
img≥l
Ë
m7
[i] + 
¥ed_img
[i];

1497  
¸_cbp
;

1498 
	}
}

1517 
	$ªsiduÆ_å™sf‹m_qu™t_luma_4x4_•
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
block_x
,
block_y
,*
c€ff_co°
, 
öåa
)

1519 
i
,
j
,
c€ff_˘r
;

1520 
qp_c⁄°
,
ûev
, 
Àvñ
,
sˇn_pos
 = 0,
run
 = -1;

1521 
n⁄zîo
 = 
FALSE
;

1522 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1523 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

1524 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1526 
img≥l
 **
img_íc
 = 
p_Vid
->
íc_pi˘uª
->
p_cuº_img
;

1527 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_¥ed[
∂
];

1528 **
mb_ºes
 = 
cuºSli˚
->mb_ºes[
∂
];

1529 **
mb_‹es
 = 
cuºSli˚
->mb_‹es[
∂
];

1530 
c_îr
,
qp_c⁄°2
;

1532 
qp
 = 
cuºMB
->
qp_sˇÀd
[
∂
];

1533 
qp_•
 = (
cuºMB
->
qp•
);

1535 c⁄° 
byã
 *
c_co°
 = 
COEFF_COST4x4
[
p_I≈
->
di°hªs
];

1536 c⁄° 
	`byã
 (*
pos_sˇn
)[2] = 
cuºMB
->
is_fõld_mode
 ? 
FIELD_SCAN
 : 
SNGL_SCAN
;

1538 
pos_x
 = 
block_x
 >> 
BLOCK_SHIFT
;

1539 
pos_y
 = 
block_y
 >> 
BLOCK_SHIFT
;

1540 
b8
 = 2*(
pos_y
 >> 1Ë+ (
pos_x
 >> 1);

1541 
b4
 = 2*(
pos_y
 & 0x01Ë+ (
pos_x
 & 0x01);

1542 * 
ACLevñ
 = 
cuºSli˚
->
cofAC
[
b8
][
b4
][0];

1543 * 
ACRun
 = 
cuºSli˚
->
cofAC
[
b8
][
b4
][1];

1546 
c_îr1
, 
c_îr2
, 
Àvñ1
, 
Àvñ2
;

1547 
D_dis1
, 
D_dis2
;

1548 
Àn
, 
öfo
;

1549 
œmbda_mode
 = 0.85 * 
	`pow
 (2, (
qp
 - 
SHIFT_QP
)/3.0) * 4;

1551 
Qu™tP¨amëîs
 *
p_Qu™t
 = 
p_Vid
->p_Quant;

1553 
qp_≥r
 = 
p_Qu™t
->
qp_≥r_m©rix
[
qp
];

1554 
q_bôs
 = 
Q_BITS
 + 
qp_≥r
;

1555 
qp_≥r_•
 = 
p_Qu™t
->
qp_≥r_m©rix
[
qp_•
];

1556 
q_bôs_•
 = 
Q_BITS
 + 
qp_≥r_•
;

1558 
LevñQu™tP¨ams
 **
q_∑øms_4x4
 = 
p_Qu™t
->q_∑øms_4x4[
∂
][
öåa
][
qp
];

1559 
LevñQu™tP¨ams
 **
qu™t_∑øms_•
 = 
p_Qu™t
->
q_∑øms_4x4
[
∂
][
öåa
][
qp_•
];

1575 
qp_c⁄°
 = (1<<
q_bôs
)/6;

1576 
qp_c⁄°2
 = (1<<
q_bôs_•
)>>1;

1579 
j
=
block_y
; j< block_y + 
BLOCK_SIZE
; ++j)

1581 
i
=
block_x
; i< block_x + 
BLOCK_SIZE
; ++i)

1583 
mb_ºes
[
j
][
i
] = 
mb_‹es
[j][i];

1584 
mb_ºes
[
j
][
i
]+=
mb_¥ed
[j][i];

1585 
cuºSli˚
->
tblk16x16
[
j
][
i
] = 
mb_¥ed
[j][i];

1590 
	`f‹w¨d4x4
(
mb_ºes
, mb_ºes, 
block_y
, 
block_x
);

1591 
	`f‹w¨d4x4
(
cuºSli˚
->
tblk16x16
, cuºSli˚->tblk16x16, 
block_y
, 
block_x
);

1593 
c€ff_˘r
 = 0;coeff_ctr < 16;coeff_ctr++)

1595 
i
 = 
pos_sˇn
[
c€ff_˘r
][0];

1596 
j
 = 
pos_sˇn
[
c€ff_˘r
][1];

1598 
run
++;

1599 
ûev
=0;

1604 
Àvñ1
 = (
	`übs
 (
cuºSli˚
->
tblk16x16
[
j
+
block_y
][
i
+
block_x
]Ë* 
qu™t_∑øms_•
[j][i].
SˇÀComp
 + 
qp_c⁄°2
Ë>> 
q_bôs_•
;

1605 
Àvñ1
 = (Àvñ1 << 
q_bôs_•
Ë/ 
qu™t_∑øms_•
[
j
][
i
].
SˇÀComp
;

1606 
c_îr1
 = 
mb_ºes
[
j
+
block_y
][
i
+
block_x
] - 
	`isig«b
(
Àvñ1
, 
cuºSli˚
->
tblk16x16
[j+block_y][i+block_x]);

1607 
Àvñ1
 = (
	`übs
 (
c_îr1
Ë* 
q_∑øms_4x4
[
j
][
i
].
SˇÀComp
 + 
qp_c⁄°
Ë>> 
q_bôs
;

1610 
c_îr2
 = 
mb_ºes
[
j
+
block_y
][
i
+
block_x
] - 
cuºSli˚
->
tblk16x16
[j+block_y][i+block_x];

1611 
Àvñ2
 = (
	`übs
 (
c_îr2
Ë* 
q_∑øms_4x4
[
j
][
i
].
SˇÀComp
 + 
qp_c⁄°
Ë>> 
q_bôs
;

1614 i‡((
Àvñ1
 !
Àvñ2
) && (level1 != 0) && (level2 != 0))

1616 
D_dis1
 = 
mb_ºes
[
j
+
block_y
][
i
+
block_x
] -

1617 ((
	`isig«b
(
Àvñ1
,
c_îr1
Ë* (
q_∑øms_4x4
[
j
][
i
].
InvSˇÀComp
 >> 4Ë* 
A
[j][i]<< 
qp_≥r
) >>6)

1618 - 
cuºSli˚
->
tblk16x16
[
j
+
block_y
][
i
+
block_x
];

1619 
	`Àvrun_löfo_öãr
(
Àvñ1
, 
run
, &
Àn
, &
öfo
);

1620 
D_dis1
 = D_dis1 * D_dis1 + 
œmbda_mode
 * 
Àn
;

1622 
D_dis2
 = 
mb_ºes
[
j
+
block_y
][
i
+
block_x
] -

1623 ((
	`isig«b
(
Àvñ2
,
c_îr2
)* (
q_∑øms_4x4
[
j
][
i
].
InvSˇÀComp
 >> 4)* 
A
[j][i]<< 
qp_≥r
) >>6)

1624 - 
cuºSli˚
->
tblk16x16
[
j
+
block_y
][
i
+
block_x
];

1625 
	`Àvrun_löfo_öãr
(
Àvñ2
, 
run
, &
Àn
, &
öfo
);

1626 
D_dis2
 = D_dis2 * D_dis2 + 
œmbda_mode
 * 
Àn
;

1628 i‡(
D_dis1
 =
D_dis2
)

1629 
Àvñ
 = (
	`übs
(
Àvñ1
Ë< iabs(
Àvñ2
)) ?Üevel1 :Üevel2;

1630 i‡(
D_dis1
 < 
D_dis2
)

1631 
Àvñ
 = 
Àvñ1
;

1633 
Àvñ
 = 
Àvñ2
;

1635 
c_îr
 = (
Àvñ
 =
Àvñ1
Ë? 
c_îr1
 : 
c_îr2
;

1637 i‡(
Àvñ1
 =
Àvñ2
)

1639 
Àvñ
 = 
Àvñ1
;

1640 
c_îr
 = 
c_îr1
;

1644 
Àvñ
 = (
Àvñ1
 =0Ë?Üevñ1 : 
Àvñ2
;

1645 
c_îr
 = (
Àvñ1
 =0Ë? 
c_îr1
 : 
c_îr2
;

1648 i‡(
Àvñ
 != 0)

1650 
n⁄zîo
 = 
TRUE
;

1652 *
c€ff_co°
 +(
Àvñ
 > 1Ë? 
MAX_VALUE
 : 
c_co°
[
run
];

1654 
Àvñ
 = 
	`isig«b
÷evñ,
c_îr
);

1655 
ACLevñ
[
sˇn_pos
] = 
Àvñ
;

1656 
ACRun
 [
sˇn_pos
] = 
run
;

1657 ++
sˇn_pos
;

1658 
run
=-1;

1659 
ûev
=((
Àvñ
 * (
q_∑øms_4x4
[
j
][
i
].
InvSˇÀComp
 >> 4)* 
A
[j][i] << 
qp_≥r
) >>6);

1662 
ûev
 +
cuºSli˚
->
tblk16x16
[
j
+
block_y
][
i
+
block_x
];

1664 if(
cuºSli˚
->
¶i˚_ty≥
 !
SI_SLICE
 && !
p_Vid
->
•2_‰ame_ödiˇt‹
)

1666 
p_Vid
->
Ãec
[
cuºMB
->
pix_y
+
block_y
+
j
][cuºMB->
pix_x
+
block_x
+
i
]=

1667 
	`isig«b
((
	`übs
(
ûev
Ë* 
qu™t_∑øms_•
[
j
][
i
].
SˇÀComp
 + 
qp_c⁄°2
Ë>> 
q_bôs_•
, ilev);

1671 
mb_ºes
[
j
+
block_y
][
i
+
block_x
] = 
	`isig«b
((
	`übs
(
ûev
Ë* 
qu™t_∑øms_•
[j][i].
SˇÀComp
 + 
qp_c⁄°2
)>> 
q_bôs_•
, iÀvË* (qu™t_∑øms_•[j][i].
InvSˇÀComp
 >> 4Ë<< 
qp_≥r_•
;

1673 
ACLevñ
[
sˇn_pos
] = 0;

1676 
	`övî£4x4
(
mb_ºes
, mb_ºes, 
block_y
, 
block_x
);

1680 
j
=
block_y
; j < block_y+
BLOCK_SIZE
; ++j)

1682 
i
=
block_x
; i < block_x+
BLOCK_SIZE
; ++i)

1685 
mb_ºes
[
j
][
i
] = 
	`iClù1
 (
p_Vid
->
max_img≥l_vÆue
, 
	`rshi·_∫d_sf
(mb_ºes[j][i], 
DQ_BITS
));

1691 
j
=0; j < 
BLOCK_SIZE
; ++j)

1693 
i
=0; i < 
BLOCK_SIZE
; ++i)

1695 
img_íc
[
cuºMB
->
pix_y
+
block_y
+
j
][cuºMB->
pix_x
+
block_x
+
i
](
img≥l
Ë
mb_ºes
[block_y+j][block_x+i];

1701  
n⁄zîo
;

1702 
	}
}

1720 
	$ªsiduÆ_å™sf‹m_qu™t_chroma_4x4_•
(
Ma¸oblock
 *
cuºMB
, 
uv
,
¸_cbp
)

1722 
i
,
j
,
ûev
,
n2
,
n1
,
c€ff_˘r
,
c_îr
,
Àvñ
 ,
sˇn_pos
,
run
;

1723 
m1
[
BLOCK_SIZE
];

1724 
c€ff_co°
;

1725 
¸_cbp_tmp
;

1726 
mp1
[
BLOCK_SIZE
];

1727 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1728 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

1729 
Boﬁón
 
is_ˇvlc
 = (BoﬁónË(
cuºSli˚
->
symbﬁ_mode
 =
CAVLC
);

1730 c⁄° 
byã
 *
c_co°
 = 
COEFF_COST4x4
[
cuºSli˚
->
di°hªs
];

1731 c⁄° 
	`byã
 (*
pos_sˇn
)[2] = 
cuºMB
->
is_fõld_mode
 ? 
FIELD_SCAN
 : 
SNGL_SCAN
;

1733 
öåa
 = 
	`is_öåa
 (
cuºMB
);

1735 
b4
;

1736 * 
DCLevñ
 = 
cuºSli˚
->
cofDC
[
uv
+1][0];

1737 * 
DCRun
 = 
cuºSli˚
->
cofDC
[
uv
+1][1];

1739 
c_îr1
, 
c_îr2
, 
Àvñ1
, 
Àvñ2
;

1740 
Àn
, 
öfo
;

1741 
D_dis1
, 
D_dis2
;

1742 
œmbda_mode
 = 0.85 * 
	`pow
 (2, (
cuºMB
->
qp
 -
SHIFT_QP
)/3.0) * 4;

1743 
max_img≥l_vÆue_uv
 = 
p_Vid
->
max_≥l_vÆue_comp
[1];

1745 
qpChroma
 = 
cuºMB
->
qpc
[
uv
] + 
cuºSli˚
->
bôdïth_chroma_qp_sˇÀ
;

1746 
qpc_•
 = 
	`iClù3
(-
cuºSli˚
->
bôdïth_chroma_qp_sˇÀ
, 51, 
cuºMB
->
qp•
 + 
p_Vid
->
a˘ive_µs
->
chroma_qp_ödex_off£t
);

1747 
qpChromaSP
 = 
qpc_•
 < 0 ? qpc_• : 
QP_SCALE_CR
[qpc_sp];

1749 **
mb_ºes
 = 
cuºSli˚
->mb_ºes[
uv
 + 1];

1750 **
mb_‹es
 = 
cuºSli˚
->mb_‹es[
uv
 + 1];

1751 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_¥ed[
uv
 + 1];

1753 
Qu™tMëhods
 
qu™t_mëhods
;

1754 
Qu™tP¨amëîs
 *
p_Qu™t
 = 
p_Vid
->p_Quant;

1756 
qp_≥r
 = 
p_Qu™t
->
qp_≥r_m©rix
[
qpChroma
];

1757 
q_bôs
 = 
Q_BITS
 + 
qp_≥r
;

1758 
qp_c⁄°
 = (1<<
q_bôs
)/6;

1759 
qp_≥r_•
 = 
p_Qu™t
->
qp_≥r_m©rix
[
qpChromaSP
];

1760 
q_bôs_•
 = 
Q_BITS
 + 
qp_≥r_•
;

1761 
qp_c⁄°2
 = (1<<
q_bôs_•
)>>1;

1763 
LevñQu™tP¨ams
 **
q_∑øms_4x4
 = 
p_Qu™t
->q_∑øms_4x4[
uv
 + 1][
öåa
][
qpChroma
];

1765 
LevñQu™tP¨ams
 **
qu™t_∑øms_•
 = 
p_Qu™t
->
q_∑øms_4x4
[
uv
 + 1][
öåa
][
qpChromaSP
];

1767 
qu™t_mëhods
.
ty≥
 = 
CHROMA_AC
;

1769 
j
=0; j < 
p_Vid
->
mb_¸_size_y
; ++j)

1771 
i
=0; i < 
p_Vid
->
mb_¸_size_x
; ++i)

1773 
mb_ºes
[
j
][
i
] = 
mb_‹es
[j][i];

1774 
mb_ºes
[
j
][
i
] +
mb_¥ed
[j][i];

1775 
cuºSli˚
->
tblk16x16
[
j
][
i
] = 
mb_¥ed
[j][i];

1779 
n2
=0;Ç2 < 
p_Vid
->
mb_¸_size_y
;Ç2 +
BLOCK_SIZE
)

1781 
n1
=0;Ç1 < 
p_Vid
->
mb_¸_size_x
;Ç1 +
BLOCK_SIZE
)

1783 
	`f‹w¨d4x4
(
mb_ºes
, mb_ºes, 
n2
, 
n1
);

1784 
	`f‹w¨d4x4
(
cuºSli˚
->
tblk16x16
, cuºSli˚->tblk16x16, 
n2
, 
n1
);

1789 
	`hadam¨d2x2
(
mb_ºes
, 
m1
);

1790 
	`hadam¨d2x2
(
cuºSli˚
->
tblk16x16
, 
mp1
);

1792 
run
=-1;

1793 
sˇn_pos
=0;

1795 
c€ff_˘r
 = 0; coeff_ctr < 4; coeff_ctr++)

1797 
run
++;

1798 
ûev
=0;

1801 
c_îr1
 = (
	`übs
 (
mp1
[
c€ff_˘r
]Ë* 
qu™t_∑øms_•
[0][0].
SˇÀComp
 + 2 * 
qp_c⁄°2
Ë>> (
q_bôs_•
 + 1);

1802 
c_îr1
 = (c_îr1 << (
q_bôs_•
 + 1)Ë/ 
qu™t_∑øms_•
[0][0].
SˇÀComp
;

1803 
c_îr1
 = 
m1
[
c€ff_˘r
] - 
	`isig«b
(c_îr1, 
mp1
[coeff_ctr]);

1804 
Àvñ1
 = (
	`übs
(
c_îr1
Ë* 
q_∑øms_4x4
[0][0].
SˇÀComp
 + 2 * 
qp_c⁄°
Ë>> (
q_bôs
+1);

1807 
c_îr2
 = 
m1
[
c€ff_˘r
] - 
mp1
[coeff_ctr];

1808 
Àvñ2
 = (
	`übs
(
c_îr2
Ë* 
q_∑øms_4x4
[0][0].
SˇÀComp
 + 2 * 
qp_c⁄°
Ë>> (
q_bôs
+1);

1810 i‡(
Àvñ1
 !
Àvñ2
 &&Üevel1 != 0 &&Üevel2 != 0)

1812 
D_dis1
 = 
m1
[
c€ff_˘r
] - ((
	`isig«b
(
Àvñ1
,
c_îr1
)* (
q_∑øms_4x4
[0][0].
InvSˇÀComp
 >> 4Ë* 
A
[0][0]<< 
qp_≥r
Ë>>5)- 
mp1
[coeff_ctr];

1813 
	`Àvrun_löfo_c2x2
(
Àvñ1
, 
run
, &
Àn
, &
öfo
);

1814 
D_dis1
 = D_dis1 * D_dis1 + 
œmbda_mode
 * 
Àn
;

1816 
D_dis2
 = 
m1
[
c€ff_˘r
] - ((
	`isig«b
(
Àvñ2
,
c_îr2
)* (
q_∑øms_4x4
[0][0].
InvSˇÀComp
 >> 4Ë* 
A
[0][0]<< 
qp_≥r
Ë>>5)- 
mp1
[coeff_ctr];

1817 
	`Àvrun_löfo_c2x2
(
Àvñ2
, 
run
, &
Àn
, &
öfo
);

1818 
D_dis2
 = D_dis2 * D_dis2 + 
œmbda_mode
 * 
Àn
;

1820 i‡(
D_dis1
 =
D_dis2
)

1821 
Àvñ
 = (
	`übs
(
Àvñ1
Ë< iabs(
Àvñ2
)) ?Üevel1 :Üevel2;

1822 i‡(
D_dis1
 < 
D_dis2
)

1823 
Àvñ
 = 
Àvñ1
;

1825 
Àvñ
 = 
Àvñ2
;

1827 
c_îr
 = (
Àvñ
 =
Àvñ1
Ë? 
c_îr1
 : 
c_îr2
;

1829 i‡(
Àvñ1
 =
Àvñ2
)

1831 
Àvñ
 = 
Àvñ1
;

1832 
c_îr
 = 
c_îr1
;

1836 
Àvñ
 = (
Àvñ1
 =0Ë?Üevñ1 : 
Àvñ2
;

1837 
c_îr
 = (
Àvñ1
 =0Ë? 
c_îr1
 : 
c_îr2
;

1840 i‡(
Àvñ
 != 0)

1842 i‡(
is_ˇvlc
)

1843 
Àvñ
 = 
	`imö
÷evñ, 
CAVLC_LEVEL_LIMIT
);

1845 
cuºMB
->
cbp_blk
 |0xf0000 << (
uv
 << 2) ;

1846 
¸_cbp
 = 
	`imax
(1, cr_cbp);

1847 
DCLevñ
[
sˇn_pos
 ] = 
	`isig«b
(
Àvñ
 ,
c_îr
);

1848 
DCRun
 [
sˇn_pos
++] = 
run
;

1849 
run
=-1;

1850 
ûev
=((
	`isig«b
(
Àvñ
,
c_îr
)* (
q_∑øms_4x4
[0][0].
InvSˇÀComp
*
A
[0][0] >> 4Ë<< 
qp_≥r
) >>5);

1853 
ûev
+
mp1
[
c€ff_˘r
];

1854 
m1
[
c€ff_˘r
]=
	`isig«b
((
	`übs
(
ûev
Ë* 
qu™t_∑øms_•
[0][0].
SˇÀComp
 + 2 * 
qp_c⁄°2
Ë>> (
q_bôs_•
+1), iÀvË* (qu™t_∑øms_•[0][0].
InvSˇÀComp
 >> 4Ë<< 
qp_≥r_•
;

1855 if(
cuºSli˚
->
¶i˚_ty≥
 !
SI_SLICE
 && !
p_Vid
->
•2_‰ame_ödiˇt‹
)

1856 
p_Vid
->
Ãec_uv
[
uv
][
cuºMB
->
pix_c_y
 + 4*(
c€ff_˘r
 & 0x01)][cuºMB->
pix_c_x
 + 4*(c€ff_˘r>>1)]=
	`isig«b
((
	`übs
(
ûev
Ë* 
qu™t_∑øms_•
[0][0].
SˇÀComp
 + 2 * 
qp_c⁄°2
Ë>> (
q_bôs_•
+1), ilev);

1858 
DCLevñ
[
sˇn_pos
] = 0;

1861 
	`ihadam¨d2x2
(
m1
, m1);

1863 
mb_ºes
[0][0]=(
m1
[0])>>1;

1864 
mb_ºes
[0][4]=(
m1
[1])>>1;

1865 
mb_ºes
[4][0]=(
m1
[2])>>1;

1866 
mb_ºes
[4][4]=(
m1
[3])>>1;

1869 
c€ff_co°
=0;

1870 
¸_cbp_tmp
=0;

1872 
n2
=0;Ç2 <
BLOCK_SIZE
;Ç2 += BLOCK_SIZE)

1874 
n1
=0;Ç1 <
BLOCK_SIZE
;Ç1 += BLOCK_SIZE)

1876 
b4
 = 2*(
n2
 >> 2Ë+ (
n1
 >> 2);

1877 
qu™t_mëhods
.
ACLevñ
 = 
cuºSli˚
->
cofAC
[
uv
+4][
b4
][0];

1878 
qu™t_mëhods
.
ACRun
 = 
cuºSli˚
->
cofAC
[
uv
+4][
b4
][1];

1880 
run
 = -1;

1881 
sˇn_pos
 = 0;

1883 
c€ff_˘r
=1; coeff_ctr < 16; coeff_ctr++)

1885 
i
=
pos_sˇn
[
c€ff_˘r
][0];

1886 
j
=
pos_sˇn
[
c€ff_˘r
][1];

1888 ++
run
;

1889 
ûev
=0;

1892 
c_îr1
 = (
	`übs
(
cuºSli˚
->
tblk16x16
[
n2
+
j
][
n1
+
i
]Ë* 
qu™t_∑øms_•
[j][i].
SˇÀComp
 + 
qp_c⁄°2
Ë>> 
q_bôs_•
;

1893 
c_îr1
 = (c_îr1 << 
q_bôs_•
Ë/ 
qu™t_∑øms_•
[
j
][
i
].
SˇÀComp
;

1894 
c_îr1
 = 
mb_ºes
[
n2
+
j
][
n1
+
i
] - 
	`isig«b
(c_îr1, 
cuºSli˚
->
tblk16x16
[n2+j][n1+i]);

1895 
Àvñ1
 = (
	`übs
(
c_îr1
Ë* 
q_∑øms_4x4
[
j
][
i
].
SˇÀComp
 + 
qp_c⁄°
Ë>> 
q_bôs
;

1898 
c_îr2
 = 
mb_ºes
[
n2
+
j
][
n1
+
i
] - 
cuºSli˚
->
tblk16x16
[n2+j][n1+i];

1899 
Àvñ2
 = (
	`übs
(
c_îr2
Ë* 
q_∑øms_4x4
[
j
][
i
].
SˇÀComp
 + 
qp_c⁄°
Ë>> 
q_bôs
;

1901 i‡(
Àvñ1
 !
Àvñ2
 &&Üevel1 != 0 &&Üevel2 != 0)

1903 
D_dis1
 = 
mb_ºes
[
n2
+
j
][
n1
+
i
] - ((
	`isig«b
(
Àvñ1
,
c_îr1
Ë* (
q_∑øms_4x4
[j][i].
InvSˇÀComp
 >> 4Ë* 
A
[j][i]<< 
qp_≥r
Ë>>6Ë- 
cuºSli˚
->
tblk16x16
[n2+j][n1+i];

1905 
	`Àvrun_löfo_öãr
(
Àvñ1
, 
run
, &
Àn
, &
öfo
);

1906 
D_dis1
 = D_dis1 * D_dis1 + 
œmbda_mode
 * 
Àn
;

1908 
D_dis2
 = 
mb_ºes
[
n2
+
j
][
n1
+
i
] - ((
	`isig«b
(
Àvñ2
,
c_îr2
)* (
q_∑øms_4x4
[j][i].
InvSˇÀComp
*
A
[j][i] >> 4Ë<< 
qp_≥r
Ë>>6Ë- 
cuºSli˚
->
tblk16x16
[n2+j][n1+i];

1909 
	`Àvrun_löfo_öãr
(
Àvñ2
, 
run
, &
Àn
, &
öfo
);

1910 
D_dis2
 = D_dis2 * D_dis2 + 
œmbda_mode
 * 
Àn
;

1912 i‡(
D_dis1
 =
D_dis2
)

1913 
Àvñ
 = (
	`übs
(
Àvñ1
Ë< iabs(
Àvñ2
)) ?Üevel1 :Üevel2;

1916 i‡(
D_dis1
 < 
D_dis2
)

1917 
Àvñ
 = 
Àvñ1
;

1919 
Àvñ
 = 
Àvñ2
;

1921 
c_îr
 = (
Àvñ
 =
Àvñ1
Ë? 
c_îr1
 : 
c_îr2
;

1923 i‡(
Àvñ1
 =
Àvñ2
)

1925 
Àvñ
 = 
Àvñ1
;

1926 
c_îr
 = 
c_îr1
;

1930 
Àvñ
 = (
Àvñ1
 =0Ë?Üevñ1 : 
Àvñ2
;

1931 
c_îr
 = (
Àvñ1
 =0Ë? 
c_îr1
 : 
c_îr2
;

1934 i‡(
Àvñ
 != 0)

1936 
cuºMB
->
cbp_blk
 |(
öt64
)1 << (16 + (
uv
 << 2Ë+ ((
n2
 >> 1Ë+ (
n1
 >> 2))) ;

1938 
c€ff_co°
 +(
Àvñ
 > 1Ë? 
MAX_VALUE
 : 
c_co°
[
run
];

1940 
¸_cbp_tmp
=2;

1941 
Àvñ
 = 
	`isig«b
÷evñ,
c_îr
);

1942 
qu™t_mëhods
.
ACLevñ
[
sˇn_pos
] = 
Àvñ
;

1943 
qu™t_mëhods
.
ACRun
 [
sˇn_pos
] = 
run
;

1944 ++
sˇn_pos
;

1945 
run
=-1;

1946 
ûev
=((
Àvñ
 * (
q_∑øms_4x4
[
j
][
i
].
InvSˇÀComp
*
A
[j][i] >> 4Ë<< 
qp_≥r
) >>6);

1948 
ûev
+=
cuºSli˚
->
tblk16x16
[
n2
+
j
][
n1
+
i
];

1949 if(
cuºSli˚
->
¶i˚_ty≥
 !
SI_SLICE
 && !
p_Vid
->
•2_‰ame_ödiˇt‹
)

1950 if(!–((
n2
+
j
Ë& 0x03)==0 && ((
n1
+
i
) & 0x03) ==0 ))

1951 
p_Vid
->
Ãec_uv
[
uv
][
cuºMB
->
pix_c_y
 + 
n2
+
j
][cuºMB->
pix_c_x
 + 
n1
 + 
i
]=
	`isig«b
((
	`übs
(
ûev
Ë* 
qu™t_∑øms_•
[j][i].
SˇÀComp
 + 
qp_c⁄°2
Ë>> 
q_bôs_•
,ilev);

1952 
mb_ºes
[
n2
+
j
][
n1
+
i
] = 
	`isig«b
((
	`übs
(
ûev
Ë* 
qu™t_∑øms_•
[j][i].
SˇÀComp
 + 
qp_c⁄°2
Ë>> 
q_bôs_•
,ûevË* (qu™t_∑øms_•[j][i].
InvSˇÀComp
 >> 4Ë<< 
qp_≥r_•
;

1954 
qu™t_mëhods
.
ACLevñ
[
sˇn_pos
] = 0;

1960 if(
¸_cbp_tmp
==2)

1961 
¸_cbp
=2;

1965 
n2
=0;Ç2 <
BLOCK_SIZE
;Ç2 += BLOCK_SIZE)

1967 
n1
=0;Ç1 <
BLOCK_SIZE
;Ç1 += BLOCK_SIZE)

1969 
	`övî£4x4
(
mb_ºes
, mb_ºes, 
n2
, 
n1
);

1971 
j
=0; j < 
BLOCK_SIZE
; ++j)

1972 
i
=0; i < 
BLOCK_SIZE
; ++i)

1974 
mb_ºes
[
n2
+
j
][
n1
+
i
] = 
	`iClù1
 (
max_img≥l_vÆue_uv
,
	`rshi·_∫d_sf
(mb_ºes[n2+j][n1+i], 
DQ_BITS
));

1980 
j
=0; j < 
BLOCK_SIZE
*2; ++j)

1981 
i
=0; i < 
BLOCK_SIZE
*2; ++i)

1983 
p_Vid
->
íc_pi˘uª
->
imgUV
[
uv
][
cuºMB
->
pix_c_y
 + 
j
][cuºMB->
pix_c_x
 + 
i
](
img≥l
Ë
mb_ºes
[j][i];

1986  
¸_cbp
;

1987 
	}
}

2005 
	$c›yblock_•
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
block_x
,
block_y
)

2007 
i
, 
j
;

2009 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

2010 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

2011 
Qu™tP¨amëîs
 *
p_Qu™t
 = 
p_Vid
->p_Quant;

2012 
cur_qp
 = 
cuºMB
->
qp•
 + 
p_Vid
->
bôdïth_luma_qp_sˇÀ
;

2013 
qp_≥r
 = 
p_Qu™t
->
qp_≥r_m©rix
[
cur_qp
];

2014 
q_bôs
 = 
Q_BITS
 + 
qp_≥r
;

2015 
qp_c⁄°2
 = (1 << 
q_bôs
) >> 1;

2016 
img≥l
 **
img_íc
 = 
p_Vid
->
íc_pi˘uª
->
p_cuº_img
;

2017 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_¥ed[
∂
];

2018 **
mb_‹es
 = 
cuºSli˚
->mb_‹es[
∂
];

2019 **
mb_ºes
 = 
cuºSli˚
->mb_ºes[
∂
];

2021 
LevñQu™tP¨ams
 **
q_∑øms_4x4
 = 
p_Qu™t
->q_∑øms_4x4[
∂
][0][
cur_qp
];

2024 
j
=0; j< 
BLOCK_SIZE
; ++j)

2026 
i
=0; i< 
BLOCK_SIZE
; ++i)

2028 
mb_ºes
[
j
][
i
] = 
mb_‹es
[j+
block_y
][i+
block_x
];

2029 
cuºSli˚
->
tblk16x16
[
j
][
i
]=
mb_¥ed
[j+
block_y
][i+
block_x
];

2033 
	`f‹w¨d4x4
(
cuºSli˚
->
tblk16x16
, currSlice->tblk16x16, 0, 0);

2036 
j
=0;j < 
BLOCK_SIZE
; ++j)

2038 
i
=0; i < 
BLOCK_SIZE
; ++i)

2040 
mb_ºes
[
j
][
i
]=
	`isig«b
((
	`übs
(
cuºSli˚
->
tblk16x16
[j][i])* 
q_∑øms_4x4
[j][i].
SˇÀComp
+
qp_c⁄°2
)>> 
q_bôs
,

2041 
cuºSli˚
->
tblk16x16
[
j
][
i
]Ë* (
q_∑øms_4x4
[j][i].
InvSˇÀComp
 >> 4Ë<<
qp_≥r
;

2042 if(
cuºSli˚
->
¶i˚_ty≥
 !
SI_SLICE
 && !
p_Vid
->
•2_‰ame_ödiˇt‹
)

2044 
p_Vid
->
Ãec
[
cuºMB
->
pix_y
+
block_y
+
j
][cuºMB->
pix_x
+
block_x
+
i
] =

2045 
	`isig«b
((
	`übs
(
cuºSli˚
->
tblk16x16
[
j
][
i
]Ë* 
q_∑øms_4x4
[j][i].
SˇÀComp
 + 
qp_c⁄°2
Ë>> 
q_bôs
, currSlice->tblk16x16[j][i]);

2052 
	`övî£4x4
(
mb_ºes
, mb_rres, 0, 0);

2055 
j
=0; j < 
BLOCK_SIZE
; ++j)

2057 
i
=0; i < 
BLOCK_SIZE
; ++i)

2059 
mb_ºes
[
j
][
i
] = 
	`iClù1
 (
p_Vid
->
max_img≥l_vÆue
, 
	`rshi·_∫d_sf
(mb_ºes[j][i], 
DQ_BITS
));

2060 
img_íc
[
cuºMB
->
pix_y
+
block_y
+
j
][cuºMB->
pix_x
+
block_x
+
i
]=(
img≥l
Ë
mb_ºes
[j][i];

2064 
	}
}

2088 
	$ªsiduÆ_å™sf‹m_qu™t_luma_4x4_•2
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
block_x
,
block_y
,*
c€ff_co°
, 
öåa
)

2090 
i
,
j
,
ûev
,
c€ff_˘r
;

2091 
Àvñ
,
sˇn_pos
 = 0,
run
 = -1;

2092 
n⁄zîo
 = 
FALSE
;

2094 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

2095 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

2096 
Qu™tP¨amëîs
 *
p_Qu™t
 = 
p_Vid
->p_Quant;

2097 
img≥l
 **
img_íc
 = 
p_Vid
->
íc_pi˘uª
->
p_cuº_img
;

2098 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_¥ed[
∂
];

2100 **
mb_ºes
 = 
cuºSli˚
->mb_ºes[
∂
];

2101 
c_îr
,
qp_c⁄°2
;

2103 
pos_x
 = 
block_x
 >> 
BLOCK_SHIFT
;

2104 
pos_y
 = 
block_y
 >> 
BLOCK_SHIFT
;

2105 
b8
 = 2*(
pos_y
 >> 1Ë+ (
pos_x
 >> 1);

2106 
b4
 = 2*(
pos_y
 & 0x01Ë+ (
pos_x
 & 0x01);

2107 c⁄° 
byã
 *
c_co°
 = 
COEFF_COST4x4
[
cuºSli˚
->
di°hªs
];

2108 c⁄° 
	`byã
 (*
pos_sˇn
)[2] = 
cuºMB
->
is_fõld_mode
 ? 
FIELD_SCAN
 : 
SNGL_SCAN
;

2110 
Àvñ1
;

2113 
qp_•
 = (
cuºMB
->
qp•
);

2117 
qp_≥r_•
 = 
p_Qu™t
->
qp_≥r_m©rix
[
qp_•
];

2118 
q_bôs_•
 = 
Q_BITS
 + 
qp_≥r_•
;

2121 
LevñQu™tP¨ams
 **
qu™t_∑øms_•
 = 
p_Qu™t
->
q_∑øms_4x4
[
∂
][
öåa
][
qp_•
];

2122 
Qu™tMëhods
 
qu™t_mëhods
;

2124 
qu™t_mëhods
.
ACLevñ
 = 
cuºSli˚
->
cofAC
[
b8
][
b4
][0];

2125 
qu™t_mëhods
.
ACRun
 = 
cuºSli˚
->
cofAC
[
b8
][
b4
][1];

2128 
qp_c⁄°2
=(1<<
q_bôs_•
)>>1;

2130 
j
=0; j< 
BLOCK_SIZE
; ++j)

2132 
i
=0; i< 
BLOCK_SIZE
; ++i)

2135 
mb_ºes
[
j
][
i
] = 
p_Vid
->
Ãec
[
cuºMB
->
pix_y
+
block_y
+j][cuºMB->
pix_x
+
block_x
+i];

2137 
cuºSli˚
->
tblk16x16
[
j
][
i
]=
mb_¥ed
[j+
block_y
][i+
block_x
];

2141 
	`f‹w¨d4x4
(
cuºSli˚
->
tblk16x16
, currSlice->tblk16x16, 0, 0);

2143 
c€ff_˘r
=0;coeff_ctr < 16;coeff_ctr++)

2146 
i
=
pos_sˇn
[
c€ff_˘r
][0];

2147 
j
=
pos_sˇn
[
c€ff_˘r
][1];

2149 
run
++;

2150 
ûev
=0;

2153 
Àvñ1
 = (
	`übs
 (
cuºSli˚
->
tblk16x16
[
j
][
i
]Ë* 
qu™t_∑øms_•
[j][i].
SˇÀComp
 + 
qp_c⁄°2
Ë>> 
q_bôs_•
;

2155 
c_îr
 = 
mb_ºes
[
j
][
i
]-
	`isig«b
(
Àvñ1
, 
cuºSli˚
->
tblk16x16
[j][i]);

2157 
Àvñ
 = 
	`übs
(
c_îr
);

2158 i‡(
Àvñ
 != 0)

2160 
n⁄zîo
=
TRUE
;

2162 *
c€ff_co°
 +(
Àvñ
 > 1Ë? 
MAX_VALUE
 : 
c_co°
[
run
];

2164 
qu™t_mëhods
.
ACLevñ
[
sˇn_pos
] = 
	`isig«b
(
Àvñ
,
c_îr
);

2165 
qu™t_mëhods
.
ACRun
 [
sˇn_pos
] = 
run
;

2166 ++
sˇn_pos
;

2167 
run
=-1;

2170 
ûev
=
c_îr
 + 
	`isig«b
(
Àvñ1
,
cuºSli˚
->
tblk16x16
[
j
][
i
]) ;

2171 
mb_ºes
[
j
][
i
] = 
ûev
 * (
qu™t_∑øms_•
[j][i].
InvSˇÀComp
 >> 4Ë<< 
qp_≥r_•
;

2173 
qu™t_mëhods
.
ACLevñ
[
sˇn_pos
] = 0;

2176 
	`övî£4x4
(
mb_ºes
, mb_rres, 0, 0);

2178 
j
=0; j < 
BLOCK_SIZE
; ++j)

2180 
i
=0; i < 
BLOCK_SIZE
; ++i)

2182 
img_íc
[
cuºMB
->
pix_y
+
block_y
+
j
][cuºMB->
pix_x
+
block_x
+
i
] = (
img≥l
Ë
	`iClù3
 (0, 
p_Vid
->
max_img≥l_vÆue
,
	`rshi·_∫d_sf
(
mb_ºes
[j][i], 
DQ_BITS
));

2186  
n⁄zîo
;

2187 
	}
}

2209 
	$ªsiduÆ_å™sf‹m_qu™t_chroma_4x4_•2
(
Ma¸oblock
 *
cuºMB
, 
uv
,
¸_cbp
)

2211 
i
,
j
,
ûev
,
n2
,
n1
,
c€ff_˘r
,
c_îr
,
Àvñ
 ,
sˇn_pos
 = 0,
run
 = -1;

2212 
m1
[
BLOCK_SIZE
];

2213 
c€ff_co°
;

2214 
¸_cbp_tmp
;

2215 
mp1
[
BLOCK_SIZE
];

2216 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

2217 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

2218 
Qu™tP¨amëîs
 *
p_Qu™t
 = 
p_Vid
->p_Quant;

2219 
Qu™tMëhods
 
qu™t_mëhods
;

2220 c⁄° 
byã
 *
c_co°
 = 
COEFF_COST4x4
[
cuºSli˚
->
di°hªs
];

2221 c⁄° 
	`byã
 (*
pos_sˇn
)[2] = 
cuºMB
->
is_fõld_mode
 ? 
FIELD_SCAN
 : 
SNGL_SCAN
;

2223 
b4
;

2224 * 
DCLevñ
 = 
cuºSli˚
->
cofDC
[
uv
+1][0];

2225 * 
DCRun
 = 
cuºSli˚
->
cofDC
[
uv
+1][1];

2226 
Àvñ1
;

2227 **
mb_ºes
 = 
cuºSli˚
->mb_ºes[
uv
 + 1];

2229 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_¥ed[
uv
 + 1];

2230 
öåa
 = 
	`is_öåa
 (
cuºMB
);

2232 
qpChroma
 = 
cuºMB
->
qpc
[
uv
] + 
cuºSli˚
->
bôdïth_chroma_qp_sˇÀ
;

2234 
qpc_•
 = 
	`iClù3
(-
cuºSli˚
->
bôdïth_chroma_qp_sˇÀ
, 51, 
cuºMB
->
qp•
 + 
p_Vid
->
a˘ive_µs
->
chroma_qp_ödex_off£t
);

2236 
qpChromaSP
 = 
qpc_•
 < 0 ? qpc_• : 
QP_SCALE_CR
[qpc_sp];

2238 
qp_≥r
 = 
p_Qu™t
->
qp_≥r_m©rix
[
qpChroma
];

2241 
qp_≥r_•
 = 
p_Qu™t
->
qp_≥r_m©rix
[
qpChromaSP
];

2242 
q_bôs_•
 = 
Q_BITS
 + 
qp_≥r
;

2243 
qp_c⁄°2
 = (1 << 
q_bôs_•
)>>1;

2246 
LevñQu™tP¨ams
 **
qu™t_∑øms_•
 = 
p_Qu™t
->
q_∑øms_4x4
[
uv
 + 1][
öåa
][
qpChromaSP
];

2248 
j
=0; j < 
MB_BLOCK_SIZE
>>1; ++j)

2250 
i
=0; i < 
MB_BLOCK_SIZE
>>1; ++i)

2252 
cuºSli˚
->
tblk16x16
[
j
][
i
]=
mb_¥ed
[j][i];

2253 
mb_ºes
[
j
][
i
]=
p_Vid
->
Ãec_uv
[
uv
][
cuºMB
->
pix_c_y
 + j][cuºMB->
pix_c_x
 + i];

2258 
n2
=0;Ç2 <
BLOCK_SIZE
;Ç2 += BLOCK_SIZE)

2260 
n1
=0;Ç1 <
BLOCK_SIZE
;Ç1 += BLOCK_SIZE)

2262 
	`f‹w¨d4x4
(
cuºSli˚
->
tblk16x16
, cuºSli˚->tblk16x16, 
n2
, 
n1
);

2267 
m1
[0]
mb_ºes
[0][0];

2268 
m1
[1]
mb_ºes
[0][4];

2269 
m1
[2]
mb_ºes
[4][0];

2270 
m1
[3]
mb_ºes
[4][4];

2273 
	`hadam¨d2x2
(
cuºSli˚
->
tblk16x16
, 
mp1
);

2275 
c€ff_˘r
=0; coeff_ctr < 4; coeff_ctr++)

2277 
run
++;

2278 
ûev
=0;

2281 
Àvñ1
 = (
	`übs
 (
mp1
[
c€ff_˘r
]Ë* 
qu™t_∑øms_•
[0][0].
SˇÀComp
 + 2 * 
qp_c⁄°2
Ë>> (
q_bôs_•
 + 1);

2283 
c_îr
 = 
m1
[
c€ff_˘r
] - 
	`isig«b
(
Àvñ1
, 
mp1
[coeff_ctr]);

2284 
Àvñ
 = 
	`übs
(
c_îr
);

2286 i‡(
Àvñ
 != 0)

2288 
cuºMB
->
cbp_blk
 |0xf0000 << (
uv
 << 2) ;

2289 
¸_cbp
=
	`imax
(1,cr_cbp);

2290 
DCLevñ
[
sˇn_pos
] = 
	`isig«b
(
Àvñ
 ,
c_îr
);

2291 
DCRun
 [
sˇn_pos
] = 
run
;

2292 
sˇn_pos
++;

2293 
run
=-1;

2297 
ûev
 = 
c_îr
 + 
	`isig«b
(
Àvñ1
,
mp1
[
c€ff_˘r
]) ;

2299 
m1
[
c€ff_˘r
]
ûev
 * (
qu™t_∑øms_•
[0][0].
InvSˇÀComp
 >> 4Ë<< 
qp_≥r_•
;

2302 
DCLevñ
[
sˇn_pos
] = 0;

2305 
	`ihadam¨d2x2
(
m1
, m1);

2307 
mb_ºes
[0][0]=
m1
[0]>>1;

2308 
mb_ºes
[0][4]=
m1
[1]>>1;

2309 
mb_ºes
[4][0]=
m1
[2]>>1;

2310 
mb_ºes
[4][4]=
m1
[3]>>1;

2313 
c€ff_co°
=0;

2314 
¸_cbp_tmp
=0;

2316 
n2
=0;Ç2 <
BLOCK_SIZE
;Ç2 += BLOCK_SIZE)

2318 
n1
=0;Ç1 <
BLOCK_SIZE
;Ç1 += BLOCK_SIZE)

2320 
b4
 = 2*(
n2
 >> 2Ë+ (
n1
 >> 2);

2321 
qu™t_mëhods
.
ACLevñ
 = 
cuºSli˚
->
cofAC
[
uv
+4][
b4
][0];

2322 
qu™t_mëhods
.
ACRun
 = 
cuºSli˚
->
cofAC
[
uv
+4][
b4
][1];

2324 
run
 = -1;

2325 
sˇn_pos
 = 0;

2327 
c€ff_˘r
=1; coeff_ctr < 16; coeff_ctr++)

2330 
i
=
pos_sˇn
[
c€ff_˘r
][0];

2331 
j
=
pos_sˇn
[
c€ff_˘r
][1];

2333 ++
run
;

2334 
ûev
=0;

2336 
Àvñ1
 = (
	`übs
(
cuºSli˚
->
tblk16x16
[
n2
+
j
][
n1
+
i
]Ë* 
qu™t_∑øms_•
[j][i].
SˇÀComp
 + 
qp_c⁄°2
Ë>> 
q_bôs_•
;

2338 
c_îr
 = 
mb_ºes
[
n2
+
j
][
n1
+
i
] - 
	`isig«b
(
Àvñ1
, 
cuºSli˚
->
tblk16x16
[n2+j][n1+i]);

2339 
Àvñ
 = 
	`übs
(
c_îr
) ;

2341 i‡(
Àvñ
 != 0)

2343 
cuºMB
->
cbp_blk
 |(
öt64
)1 << (16 + (
uv
 << 2Ë+ ((
n2
 >> 1Ë+ (
n1
 >> 2))) ;

2345 
c€ff_co°
 +(
Àvñ
 > 1Ë? 
MAX_VALUE
 : 
c_co°
[
run
];

2347 
¸_cbp_tmp
=2;

2348 
qu™t_mëhods
.
ACLevñ
[
sˇn_pos
] = 
	`isig«b
(
Àvñ
,
c_îr
);

2349 
qu™t_mëhods
.
ACRun
 [
sˇn_pos
] = 
run
;

2350 ++
sˇn_pos
;

2351 
run
=-1;

2355 
ûev
=
c_îr
 + 
	`isig«b
(
Àvñ1
,
cuºSli˚
->
tblk16x16
[
n2
+
j
][
n1
+
i
]);

2356 
mb_ºes
[
n2
+
j
][
n1
+
i
] = 
ûev
 * (
qu™t_∑øms_•
[j][i].
InvSˇÀComp
 >> 4Ë<< 
qp_≥r_•
;

2358 
qu™t_mëhods
.
ACLevñ
[
sˇn_pos
] = 0;

2363 if(
¸_cbp_tmp
==2)

2364 
¸_cbp
=2;

2368 
n2
=0;Ç2 <
BLOCK_SIZE
;Ç2 += BLOCK_SIZE)

2370 
n1
=0;Ç1 <
BLOCK_SIZE
;Ç1 += BLOCK_SIZE)

2372 
	`övî£4x4
(
mb_ºes
, mb_ºes, 
n2
, 
n1
);

2375 
j
=0; j < 
BLOCK_SIZE
; ++j)

2377 
i
=0; i < 
BLOCK_SIZE
; ++i)

2379 
p_Vid
->
íc_pi˘uª
->
imgUV
[
uv
][
cuºMB
->
pix_c_y
 + 
j
 + 
n2
][cuºMB->
pix_c_x
 + 
i
 + 
n1
 ] =

2380 (
img≥l
Ë
	`iClù3
 (0, 
p_Vid
->
max_img≥l_vÆue
,
	`rshi·_∫d_sf
(
mb_ºes
[
n2
+
j
][
n1
+
i
], 
DQ_BITS
));

2386  
¸_cbp
;

2387 
	}
}

2390 
	$£À˘_å™sf‹m
(
Ma¸oblock
 *
cuºMB
)

2392 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

2394 i‡(
cuºSli˚
->
¶i˚_ty≥
 !
SP_SLICE
 && cuºSli˚->¶i˚_ty≥ !
SI_SLICE
)

2396 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

2397 i‡(
p_Vid
->
a˘ive_•s
->
los¶ess_qµrime_Êag
 == 1)

2399 i‡(
cuºMB
->
qp_sˇÀd
[(Ë
p_Vid
->
cﬁour_∂™e_id
] == 0)

2401 
cuºMB
->
ªsiduÆ_å™sf‹m_qu™t_luma_4x4
 = 
ªsiduÆ_å™sf‹m_qu™t_luma_4x4_ls
;

2402 
cuºMB
->
ªsiduÆ_å™sf‹m_qu™t_luma_16x16
 = 
ªsiduÆ_å™sf‹m_qu™t_luma_16x16_ls
;

2403 
cuºMB
->
ªsiduÆ_å™sf‹m_qu™t_luma_8x8
 = 
ªsiduÆ_å™sf‹m_qu™t_luma_8x8_ls
;

2407 
cuºMB
->
ªsiduÆ_å™sf‹m_qu™t_luma_4x4
 =Ñesidual_transform_quant_luma_4x4;

2408 
cuºMB
->
ªsiduÆ_å™sf‹m_qu™t_luma_16x16
 =Ñesidual_transform_quant_luma_16x16;

2409 i‡(
cuºSli˚
->
symbﬁ_mode
 =
CAVLC
)

2410 
cuºMB
->
ªsiduÆ_å™sf‹m_qu™t_luma_8x8
 = 
ªsiduÆ_å™sf‹m_qu™t_luma_8x8_ˇvlc
;

2412 
cuºMB
->
ªsiduÆ_å™sf‹m_qu™t_luma_8x8
 =Ñesidual_transform_quant_luma_8x8;

2413 
cuºMB
->
ªsiduÆ_å™sf‹m_qu™t_chroma_4x4
[0] =Ñesidual_transform_quant_chroma_4x4;

2414 
cuºMB
->
ªsiduÆ_å™sf‹m_qu™t_chroma_4x4
[1] =Ñesidual_transform_quant_chroma_4x4;

2417 i‡(
cuºMB
->
qp_sˇÀd
[
PLANE_U
] == 0)

2419 
cuºMB
->
ªsiduÆ_å™sf‹m_qu™t_chroma_4x4
[0] = 
ªsiduÆ_å™sf‹m_qu™t_chroma_4x4_ls
;

2421 i‡(
cuºMB
->
qp_sˇÀd
[
PLANE_V
] == 0)

2423 
cuºMB
->
ªsiduÆ_å™sf‹m_qu™t_chroma_4x4
[1] = 
ªsiduÆ_å™sf‹m_qu™t_chroma_4x4_ls
;

2428 
cuºMB
->
ªsiduÆ_å™sf‹m_qu™t_luma_4x4
 =Ñesidual_transform_quant_luma_4x4;

2429 
cuºMB
->
ªsiduÆ_å™sf‹m_qu™t_luma_16x16
 =Ñesidual_transform_quant_luma_16x16;

2430 i‡(
cuºSli˚
->
symbﬁ_mode
 =
CAVLC
)

2431 
cuºMB
->
ªsiduÆ_å™sf‹m_qu™t_luma_8x8
 = 
ªsiduÆ_å™sf‹m_qu™t_luma_8x8_ˇvlc
;

2433 
cuºMB
->
ªsiduÆ_å™sf‹m_qu™t_luma_8x8
 =Ñesidual_transform_quant_luma_8x8;

2435 
cuºMB
->
ªsiduÆ_å™sf‹m_qu™t_chroma_4x4
[0] =Ñesidual_transform_quant_chroma_4x4;

2436 
cuºMB
->
ªsiduÆ_å™sf‹m_qu™t_chroma_4x4
[1] =Ñesidual_transform_quant_chroma_4x4;

2439 if(
cuºSli˚
->
¶i˚_ty≥
 !
SI_SLICE
 && !cuºSli˚->
•2_‰ame_ödiˇt‹
)

2441 
cuºMB
->
ªsiduÆ_å™sf‹m_qu™t_luma_4x4
 = 
ªsiduÆ_å™sf‹m_qu™t_luma_4x4_•
;

2442 
cuºMB
->
ªsiduÆ_å™sf‹m_qu™t_luma_16x16
 =Ñesidual_transform_quant_luma_16x16;

2443 i‡(
cuºSli˚
->
symbﬁ_mode
 =
CAVLC
)

2444 
cuºMB
->
ªsiduÆ_å™sf‹m_qu™t_luma_8x8
 = 
ªsiduÆ_å™sf‹m_qu™t_luma_8x8_ˇvlc
;

2446 
cuºMB
->
ªsiduÆ_å™sf‹m_qu™t_luma_8x8
 =Ñesidual_transform_quant_luma_8x8;

2448 
cuºMB
->
ªsiduÆ_å™sf‹m_qu™t_chroma_4x4
[0] = 
ªsiduÆ_å™sf‹m_qu™t_chroma_4x4_•
;

2449 
cuºMB
->
ªsiduÆ_å™sf‹m_qu™t_chroma_4x4
[1] = 
ªsiduÆ_å™sf‹m_qu™t_chroma_4x4_•
;

2453 
cuºMB
->
ªsiduÆ_å™sf‹m_qu™t_luma_4x4
 = 
ªsiduÆ_å™sf‹m_qu™t_luma_4x4_•2
;

2454 
cuºMB
->
ªsiduÆ_å™sf‹m_qu™t_luma_16x16
 =Ñesidual_transform_quant_luma_16x16;

2455 i‡(
cuºSli˚
->
symbﬁ_mode
 =
CAVLC
)

2456 
cuºMB
->
ªsiduÆ_å™sf‹m_qu™t_luma_8x8
 = 
ªsiduÆ_å™sf‹m_qu™t_luma_8x8_ˇvlc
;

2458 
cuºMB
->
ªsiduÆ_å™sf‹m_qu™t_luma_8x8
 =Ñesidual_transform_quant_luma_8x8;

2460 
cuºMB
->
ªsiduÆ_å™sf‹m_qu™t_chroma_4x4
[0] = 
ªsiduÆ_å™sf‹m_qu™t_chroma_4x4_•2
;

2461 
cuºMB
->
ªsiduÆ_å™sf‹m_qu™t_chroma_4x4
[1] = 
ªsiduÆ_å™sf‹m_qu™t_chroma_4x4_•2
;

2463 
	}
}

	@lencod/src/cabac.c

14 
	~"globÆ.h
"

16 
	~"ˇbac.h
"

17 
	~"bürõncode.h
"

18 
	~"image.h
"

19 
	~"mb_ac˚ss.h
"

21 #i‡
TRACE


22 
	#CABAC_TRACE
 i‡(
dp
->
bô°ªam
->
åa˚_íabÀd
Ë
	`åa˚2out_ˇbac
 (
£
)

	)

24 
	#CABAC_TRACE


	)

36 c⁄° 
byã
 
	gpos2˘x_m≠8x8
 [] = {

43 c⁄° 
byã
 
	gpos2˘x_m≠8x4
 [] = {

48 c⁄° 
byã
 
	gpos2˘x_m≠4x4
 [] = {

52 c⁄° 
byã
 
	gpos2˘x_m≠2x4c
[] = {

56 c⁄° 
byã
 
	gpos2˘x_m≠4x4c
[] = {

60 c⁄° 
byã
* 
	gpos2˘x_m≠
 [] = {

61 
pos2˘x_m≠4x4
,Öos2˘x_m≠4x4, 
pos2˘x_m≠8x8
, 
pos2˘x_m≠8x4
,

62 
pos2˘x_m≠8x4
, 
pos2˘x_m≠4x4
,Öos2ctx_map4x4,Öos2ctx_map4x4,

63 
pos2˘x_m≠2x4c
, 
pos2˘x_m≠4x4c
,

64 
pos2˘x_m≠4x4
,Öos2˘x_m≠4x4, 
pos2˘x_m≠8x8
,
pos2˘x_m≠8x4
,

65 
pos2˘x_m≠8x4
, 
pos2˘x_m≠4x4
,

66 
pos2˘x_m≠4x4
,Öos2˘x_m≠4x4, 
pos2˘x_m≠8x8
,
pos2˘x_m≠8x4
,

67 
pos2˘x_m≠8x4
,
pos2˘x_m≠4x4


72 c⁄° 
byã
 
	gpos2˘x_m≠8x8i
[] = {

79 c⁄° 
byã
 
	gpos2˘x_m≠8x4i
[] = {

84 c⁄° 
byã
 
	gpos2˘x_m≠4x8i
[] = {

89 c⁄° 
byã
* 
	gpos2˘x_m≠_öt
[] = {

90 
pos2˘x_m≠4x4
,Öos2˘x_m≠4x4, 
pos2˘x_m≠8x8i
,
pos2˘x_m≠8x4i
,

91 
pos2˘x_m≠4x8i
,
pos2˘x_m≠4x4
,Öos2ctx_map4x4,Öos2ctx_map4x4,

92 
pos2˘x_m≠2x4c
, 
pos2˘x_m≠4x4c
,

94 
pos2˘x_m≠4x4
,Öos2˘x_m≠4x4, 
pos2˘x_m≠8x8i
,
pos2˘x_m≠8x4i
,

95 
pos2˘x_m≠8x4i
,
pos2˘x_m≠4x4
,

96 
pos2˘x_m≠4x4
,Öos2˘x_m≠4x4, 
pos2˘x_m≠8x8i
,
pos2˘x_m≠8x4i
,

97 
pos2˘x_m≠8x4i
,
pos2˘x_m≠4x4


102 c⁄° 
byã
 
	gpos2˘x_œ°8x8
 [] = {

109 c⁄° 
byã
 
	gpos2˘x_œ°8x4
 [] = {

114 c⁄° 
byã
 
	gpos2˘x_œ°4x4
 [] = {

118 c⁄° 
byã
 
	gpos2˘x_œ°2x4c
[] = {

122 c⁄° 
byã
 
	gpos2˘x_œ°4x4c
[] = {

126 c⁄° 
byã
* 
	gpos2˘x_œ°
 [] = {

127 
pos2˘x_œ°4x4
,Öos2˘x_œ°4x4, 
pos2˘x_œ°8x8
, 
pos2˘x_œ°8x4
,

128 
pos2˘x_œ°8x4
, 
pos2˘x_œ°4x4
,Öos2ctx_last4x4,Öos2ctx_last4x4,

129 
pos2˘x_œ°2x4c
, 
pos2˘x_œ°4x4c
,

130 
pos2˘x_œ°4x4
,Öos2˘x_œ°4x4, 
pos2˘x_œ°8x8
,
pos2˘x_œ°8x4
,

131 
pos2˘x_œ°8x4
, 
pos2˘x_œ°4x4
,

132 
pos2˘x_œ°4x4
,Öos2˘x_œ°4x4, 
pos2˘x_œ°8x8
,
pos2˘x_œ°8x4
,

133 
pos2˘x_œ°8x4
, 
pos2˘x_œ°4x4


148 
	$exp_gﬁomb_ícode_eq_¥ob
–
EncodögEnvú⁄mítPå
 
ìp_dp
,

149 
symbﬁ
,

150 
k
)

154 i‡(
symbﬁ
 >()(1<<
k
))

156 
	`büri_ícode_symbﬁ_eq_¥ob
(
ìp_dp
, 1);

157 
symbﬁ
 = symbﬁ - (1<<
k
);

158 
k
++;

162 
	`büri_ícode_symbﬁ_eq_¥ob
(
ìp_dp
, 0);

163 
k
--)

164 
	`büri_ícode_symbﬁ_eq_¥ob
(
ìp_dp
, ((
symbﬁ
>>
k
)&1));

168 
	}
}

178 
	$u«ry_bö_ícode
(
EncodögEnvú⁄mítPå
 
ìp_dp
,

179 
symbﬁ
,

180 
BiC⁄ãxtTy≥På
 
˘x
,

181 
˘x_off£t
)

183 i‡(
symbﬁ
==0)

185 
	`büri_ícode_symbﬁ
(
ìp_dp
, 0, 
˘x
 );

190 
	`büri_ícode_symbﬁ
(
ìp_dp
, 1, 
˘x
 );

191 
˘x
 +
˘x_off£t
;

192 (--
symbﬁ
) > 0)

193 
	`büri_ícode_symbﬁ
(
ìp_dp
, 1, 
˘x
);

194 
	`büri_ícode_symbﬁ
(
ìp_dp
, 0, 
˘x
);

196 
	}
}

207 
	$u«ry_bö_max_ícode
(
EncodögEnvú⁄mítPå
 
ìp_dp
,

208 
symbﬁ
,

209 
BiC⁄ãxtTy≥På
 
˘x
,

210 
˘x_off£t
,

211 
max_symbﬁ
)

213 i‡(
symbﬁ
==0)

215 
	`büri_ícode_symbﬁ
(
ìp_dp
, 0, 
˘x
 );

220 
l
 = 
symbﬁ
;

221 
	`büri_ícode_symbﬁ
(
ìp_dp
, 1, 
˘x
 );

223 
˘x
 +
˘x_off£t
;

224 (--
l
)>0)

225 
	`büri_ícode_symbﬁ
(
ìp_dp
, 1, 
˘x
);

226 i‡(
symbﬁ
 < 
max_symbﬁ
)

227 
	`büri_ícode_symbﬁ
(
ìp_dp
, 0, 
˘x
);

229 
	}
}

237 
	$u«ry_exp_gﬁomb_Àvñ_ícode
–
EncodögEnvú⁄mítPå
 
ìp_dp
,

238 
symbﬁ
,

239 
BiC⁄ãxtTy≥På
 
˘x
)

241 i‡(
symbﬁ
==0)

243 
	`büri_ícode_symbﬁ
(
ìp_dp
, 0, 
˘x
 );

248 
l
=
symbﬁ
;

249 
k
 = 1;

251 
	`büri_ícode_symbﬁ
(
ìp_dp
, 1, 
˘x
 );

252 ((--
l
)>0Ë&& (++
k
 <= 13))

253 
	`büri_ícode_symbﬁ
(
ìp_dp
, 1, 
˘x
);

254 i‡(
symbﬁ
 < 13)

255 
	`büri_ícode_symbﬁ
(
ìp_dp
, 0, 
˘x
);

257 
	`exp_gﬁomb_ícode_eq_¥ob
(
ìp_dp
,
symbﬁ
 - 13, 0);

259 
	}
}

268 
	$u«ry_exp_gﬁomb_mv_ícode
(
EncodögEnvú⁄mítPå
 
ìp_dp
,

269 
symbﬁ
,

270 
BiC⁄ãxtTy≥På
 
˘x
,

271 
max_bö
)

273 i‡(
symbﬁ
==0)

275 
	`büri_ícode_symbﬁ
(
ìp_dp
, 0, 
˘x
 );

280 
bö
 = 1;

281 
l
 = 
symbﬁ
, 
k
 = 1;

282 
	`büri_ícode_symbﬁ
(
ìp_dp
, 1, 
˘x
++ );

284 ((--
l
)>0Ë&& (++
k
 <= 8))

286 
	`büri_ícode_symbﬁ
(
ìp_dp
, 1, 
˘x
 );

287 i‡((++
bö
) == 2)

288 ++
˘x
;

289 i‡(
bö
 =
max_bö
)

290 ++
˘x
;

292 i‡(
symbﬁ
 < 8)

293 
	`büri_ícode_symbﬁ
(
ìp_dp
, 0, 
˘x
);

295 
	`exp_gﬁomb_ícode_eq_¥ob
(
ìp_dp
, 
symbﬁ
 - 8, 3);

297 
	}
}

306 
	$CheckAvaûabûôyOfNeighb‹sCABAC
(
Ma¸oblock
 *
cuºMB
)

308 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

309 
PixñPos
 
up
, 
À·
;

310 *
mb_size
 = 
p_Vid
->mb_size[
IS_LUMA
];

312 
p_Vid
->
	`gëNeighbour
(
cuºMB
, -1, 0, 
mb_size
, &
À·
);

313 
p_Vid
->
	`gëNeighbour
(
cuºMB
, 0, -1, 
mb_size
, &
up
);

315 i‡(
up
.
avaûabÀ
)

316 
cuºMB
->
mb_up
 = &
p_Vid
->
mb_d©a
[
up
.
mb_addr
];

318 
cuºMB
->
mb_up
 = 
NULL
;

320 i‡(
À·
.
avaûabÀ
)

321 
cuºMB
->
mb_À·
 = &
p_Vid
->
mb_d©a
[
À·
.
mb_addr
];

323 
cuºMB
->
mb_À·
 = 
NULL
;

324 
	}
}

333 
MŸi⁄InfoC⁄ãxts
* 
	$¸óã_c⁄ãxts_MŸi⁄Info
()

335 
MŸi⁄InfoC⁄ãxts
* 
íco_˘x
;

337 
íco_˘x
 = (
MŸi⁄InfoC⁄ãxts
*Ë
	`ˇŒoc
(1, (MotionInfoContexts) );

338 if–
íco_˘x
 =
NULL
 )

339 
	`no_mem_exô
("create_contexts_MotionInfo:Énco_ctx");

341  
íco_˘x
;

342 
	}
}

352 
TextuªInfoC⁄ãxts
* 
	$¸óã_c⁄ãxts_TextuªInfo
()

354 
TextuªInfoC⁄ãxts
* 
íco_˘x
 = (TextuªInfoC⁄ãxts*Ë
	`ˇŒoc
(1, (TextureInfoContexts) );

355 if–
íco_˘x
 =
NULL
 )

356 
	`no_mem_exô
("create_contexts_TextureInfo:Énco_ctx");

358  
íco_˘x
;

359 
	}
}

368 
	$dñëe_c⁄ãxts_MŸi⁄Info
(
MŸi⁄InfoC⁄ãxts
 *
íco_˘x
)

370 
	`‰ì_poöãr
–
íco_˘x
 );

371 
	}
}

380 
	$dñëe_c⁄ãxts_TextuªInfo
(
TextuªInfoC⁄ãxts
 *
íco_˘x
)

382 
	`‰ì_poöãr
–
íco_˘x
 );

383 
	}
}

393 
	$wrôeFõldModeInfo_CABAC
(
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
)

395 
EncodögEnvú⁄mítPå
 
ìp_dp
 = &(
dp
->
ì_ˇbac
);

396 
cuº_Àn
 = 
	`¨õnco_bôs_wrôãn
(
ìp_dp
);

397 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

398 
Ma¸oblock
 *
mb_d©a
 = 
p_Vid
->mb_data;

400 
a
 = 
cuºMB
->
mbAvaûA
 ? 
mb_d©a
[cuºMB->
mbAddrA
].
mb_fõld
 : 0;

401 
b
 = 
cuºMB
->
mbAvaûB
 ? 
mb_d©a
[cuºMB->
mbAddrB
].
mb_fõld
 : 0;

403 
a˘_˘x
 = 
a
 + 
b
;

405 #i‡
ENABLE_FIELD_CTX


406 
TextuªInfoC⁄ãxts
 *
˘x
 = 
dp
->
p_Sli˚
->
ãx_˘x
;

408 
	`büri_ícode_symbﬁ
(
ìp_dp
, (
£
->
vÆue1
 !0), &
˘x
->
mb_aff_c⁄ãxts
[
a˘_˘x
]);

411 
£
->
c⁄ãxt
 = 
a˘_˘x
;

413 
dp
->
bô°ªam
->
wrôe_Êag
 = 1;

414 
£
->
Àn
 = (
	`¨õnco_bôs_wrôãn
(
ìp_dp
Ë- 
cuº_Àn
);

415 
CABAC_TRACE
;

416 
	}
}

424 
	$wrôeMB_Pskù_ÊagInfo_CABAC
(
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
)

426 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

427 
EncodögEnvú⁄mítPå
 
ìp_dp
 = &(
dp
->
ì_ˇbac
);

428 
cuº_Àn
 = 
	`¨õnco_bôs_wrôãn
(
ìp_dp
);

429 
MŸi⁄InfoC⁄ãxts
 *
˘x
 = 
cuºSli˚
->
mŸ_˘x
;

430 
cuº_mb_ty≥
 = 
£
->
vÆue1
;

431 
a
 = (
cuºMB
->
mb_À·
 !
NULL
 && (cuºMB->mb_À·->
skù_Êag
 == 0)) ? 1 : 0;

432 
b
 = (
cuºMB
->
mb_up
 !
NULL
 && (cuºMB->mb_u∞->
skù_Êag
 == 0)) ? 1 : 0;

433 
a˘_˘x
 = 
a
 + 
b
;

435 i‡(
cuº_mb_ty≥
==0)

436 
	`büri_ícode_symbﬁ
(
ìp_dp
, 1, &
˘x
->
mb_ty≥_c⁄ãxts
[1][
a˘_˘x
]);

438 
	`büri_ícode_symbﬁ
(
ìp_dp
, 0, &
˘x
->
mb_ty≥_c⁄ãxts
[1][
a˘_˘x
]);

440 
cuºMB
->
skù_Êag
 = (
cuº_mb_ty≥
==0) ? 1 : 0;

442 
£
->
c⁄ãxt
 = 
a˘_˘x
;

443 
£
->
vÆue1
 = 1 - 
cuºMB
->
skù_Êag
;

445 
dp
->
bô°ªam
->
wrôe_Êag
 = 1;

446 
£
->
Àn
 = (
	`¨õnco_bôs_wrôãn
(
ìp_dp
Ë- 
cuº_Àn
);

447 
CABAC_TRACE
;

448 
	}
}

456 
	$wrôeMB_Bskù_ÊagInfo_CABAC
(
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
)

458 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

459 
EncodögEnvú⁄mítPå
 
ìp_dp
 = &(
dp
->
ì_ˇbac
);

460 
cuº_Àn
 = 
	`¨õnco_bôs_wrôãn
(
ìp_dp
);

461 
MŸi⁄InfoC⁄ãxts
 *
˘x
 = 
cuºSli˚
->
mŸ_˘x
;

462 
a
 = (
cuºMB
->
mb_À·
 !
NULL
 && (cuºMB->mb_À·->
skù_Êag
 == 0)) ? 1 : 0;

463 
b
 = (
cuºMB
->
mb_up
 !
NULL
 && (cuºMB->mb_u∞->
skù_Êag
 == 0)) ? 1 : 0;

464 
a˘_˘x
 = 
a
 + 
b
;

466 
a˘_˘x
 += 7;

468 i‡(
£
->
vÆue1
==0 && se->
vÆue2
==0)

469 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 1, &
˘x
->
mb_ty≥_c⁄ãxts
[2][
a˘_˘x
]);

471 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 0, &
˘x
->
mb_ty≥_c⁄ãxts
[2][
a˘_˘x
]);

473 
cuºMB
->
skù_Êag
 = (
£
->
vÆue1
==0 && se->
vÆue2
==0) ? 1 : 0;

475 
£
->
c⁄ãxt
 = 
a˘_˘x
;

476 
£
->
vÆue1
 = 1 - 
cuºMB
->
skù_Êag
;

478 
dp
->
bô°ªam
->
wrôe_Êag
 = 1;

479 
£
->
Àn
 = (
	`¨õnco_bôs_wrôãn
(
ìp_dp
Ë- 
cuº_Àn
);

480 
CABAC_TRACE
;

481 
	}
}

491 
	$wrôeMB_å™sf‹m_size_CABAC
(
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
)

493 
EncodögEnvú⁄mítPå
 
ìp_dp
 = &(
dp
->
ì_ˇbac
);

494 
TextuªInfoC⁄ãxts
 *
˘x
 = (
dp
->
p_Sli˚
)->
ãx_˘x
;

496 
cuº_Àn
 = 
	`¨õnco_bôs_wrôãn
(
ìp_dp
);

497 
a˘_sym
 = 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
;

500 
b
 = (
cuºMB
->
mb_up
 =
NULL
Ë? 0 : cuºMB->mb_up->
luma_å™sf‹m_size_8x8_Êag
;

501 
a
 = (
cuºMB
->
mb_À·
 =
NULL
Ë? 0 :cuºMB->mb_À·->
luma_å™sf‹m_size_8x8_Êag
;

502 
a˘_˘x
 = 
a
 + 
b
;

504 
£
->
c⁄ãxt
 = 
a˘_˘x
;

505 
	`büri_ícode_symbﬁ
(
ìp_dp
, (
a˘_sym
 !0), 
˘x
->
å™sf‹m_size_c⁄ãxts
 + 
a˘_˘x
 );

507 
dp
->
bô°ªam
->
wrôe_Êag
 = 1;

508 
£
->
Àn
 = (
	`¨õnco_bôs_wrôãn
(
ìp_dp
Ë- 
cuº_Àn
);

509 
CABAC_TRACE
;

510 
	}
}

520 
	$wrôeMB_P_ty≥Info_CABAC
(
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
)

522 
EncodögEnvú⁄mítPå
 
ìp_dp
 = &(
dp
->
ì_ˇbac
);

523 
cuº_Àn
 = 
	`¨õnco_bôs_wrôãn
(
ìp_dp
);

525 
BiC⁄ãxtTy≥
 *
mb_ty≥_c⁄ãxts
 = 
dp
->
p_Sli˚
->
mŸ_˘x
->mb_type_contexts[1];

527 
a˘_˘x
 = 0;

528 
mode_sym
 = 0;

529 
a˘_sym
 = 
£
->
vÆue1
;

530 
mode16x16
 = 7;

532 i‡(
a˘_sym
 >
mode16x16
)

534 
mode_sym
 = 
a˘_sym
 - 
mode16x16
;

535 
a˘_sym
 = 
mode16x16
;

538 
a˘_sym
)

543 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 0, &
mb_ty≥_c⁄ãxts
[4]);

544 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 0, &
mb_ty≥_c⁄ãxts
[5]);

545 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 0, &
mb_ty≥_c⁄ãxts
[6]);

548 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 0, &
mb_ty≥_c⁄ãxts
[4]);

549 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 1, &
mb_ty≥_c⁄ãxts
[5]);

550 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 1, &
mb_ty≥_c⁄ãxts
[7]);

553 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 0, &
mb_ty≥_c⁄ãxts
[4]);

554 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 1, &
mb_ty≥_c⁄ãxts
[5]);

555 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 0, &
mb_ty≥_c⁄ãxts
[7]);

559 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 0, &
mb_ty≥_c⁄ãxts
[4]);

560 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 0, &
mb_ty≥_c⁄ãxts
[5]);

561 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 1, &
mb_ty≥_c⁄ãxts
[6]);

564 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 1, &
mb_ty≥_c⁄ãxts
[4]);

565 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 0, &
mb_ty≥_c⁄ãxts
[7]);

568 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 1, &
mb_ty≥_c⁄ãxts
[4]);

569 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 1, &
mb_ty≥_c⁄ãxts
[7]);

572 
	`¥ötf
 ("Unsupported MB-MODE in writeMB_I_typeInfo_CABAC!\n");

573 
	`exô
 (1);

576 if(
a˘_sym
 =
mode16x16
)

578 if–
mode_sym
 == 24 )

580 
	`büri_ícode_symbﬁ_föÆ
(
ìp_dp
, 1 );

581 
dp
->
bô°ªam
->
wrôe_Êag
 = 1;

582 
£
->
Àn
 = (
	`¨õnco_bôs_wrôãn
(
ìp_dp
Ë- 
cuº_Àn
);

583 
CABAC_TRACE
;

586 
	`büri_ícode_symbﬁ_föÆ
(
ìp_dp
, 0 );

588 
a˘_˘x
 = 8;

589 
a˘_sym
 = 
mode_sym
/12;

590 
	`büri_ícode_symbﬁ
(
ìp_dp
, 
a˘_sym
, 
mb_ty≥_c⁄ãxts
 + 
a˘_˘x
 );

591 
mode_sym
 = mode_sym % 12;

593 
a˘_sym
 = 
mode_sym
 >> 2;

594 
a˘_˘x
 = 9;

595 i‡(
a˘_sym
==0)

597 
	`büri_ícode_symbﬁ
(
ìp_dp
, 0, 
mb_ty≥_c⁄ãxts
 + 
a˘_˘x
 );

601 
	`büri_ícode_symbﬁ
(
ìp_dp
, 1, 
mb_ty≥_c⁄ãxts
 + 
a˘_˘x
 );

602 
	`büri_ícode_symbﬁ
(
ìp_dp
, (
a˘_sym
!=1), 
mb_ty≥_c⁄ãxts
 + 
a˘_˘x
 );

605 
mode_sym
 = mode_sym & 0x03;

606 
a˘_˘x
 = 10;

607 
a˘_sym
 = 
mode_sym
 >> 1;

608 
	`büri_ícode_symbﬁ
(
ìp_dp
, 
a˘_sym
, 
mb_ty≥_c⁄ãxts
 + 
a˘_˘x
 );

609 
a˘_sym
 = (
mode_sym
 & 0x01);

610 
	`büri_ícode_symbﬁ
(
ìp_dp
, 
a˘_sym
, 
mb_ty≥_c⁄ãxts
 + 
a˘_˘x
 );

613 
dp
->
bô°ªam
->
wrôe_Êag
 = 1;

614 
£
->
Àn
 = (
	`¨õnco_bôs_wrôãn
(
ìp_dp
Ë- 
cuº_Àn
);

615 
CABAC_TRACE
;

616 
	}
}

626 
	$wrôeMB_B_ty≥Info_CABAC
(
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
)

628 
EncodögEnvú⁄mítPå
 
ìp_dp
 = &(
dp
->
ì_ˇbac
);

629 
cuº_Àn
 = 
	`¨õnco_bôs_wrôãn
(
ìp_dp
);

631 
csym
;

632 
a˘_sym
 = 
£
->
vÆue1
;

634 
mode_sym
 = 0;

635 
mode16x16
 = 24;

637 
MŸi⁄InfoC⁄ãxts
 *
˘x
 = 
dp
->
p_Sli˚
->
mŸ_˘x
;

638 
BiC⁄ãxtTy≥
 *
mb_ty≥_c⁄ãxts
 = 
˘x
->mb_type_contexts[2];

640 
a
 = (
cuºMB
->
mb_À·
 =
NULL
Ë? 0 : ((cuºMB->mb_À·->
mb_ty≥
 != 0) ? 1 : 0 );

641 
b
 = (
cuºMB
->
mb_up
 =
NULL
Ë? 0 : ((cuºMB->mb_up->
mb_ty≥
 != 0) ? 1 : 0 );

642 
a˘_˘x
 = 
a
 + 
b
;

643 
£
->
c⁄ãxt
 = 
a˘_˘x
;

645 i‡(
a˘_sym
 >
mode16x16
)

647 
mode_sym
 = 
a˘_sym
 - 
mode16x16
;

648 
a˘_sym
 = 
mode16x16
;

651 i‡(
a˘_sym
==0)

653 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 0, &
mb_ty≥_c⁄ãxts
[
a˘_˘x
]);

655 i‡(
a˘_sym
<=2)

657 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 1, &
mb_ty≥_c⁄ãxts
[
a˘_˘x
]);

658 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 0, &
mb_ty≥_c⁄ãxts
[4]);

659 
csym
 = (
a˘_sym
-1 != 0);

660 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 
csym
, &
mb_ty≥_c⁄ãxts
[6]);

662 i‡(
a˘_sym
<=10)

664 
ãmp_sym
 = 
a˘_sym
 - 3;

665 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 1, &
mb_ty≥_c⁄ãxts
[
a˘_˘x
]);

666 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 1, &
mb_ty≥_c⁄ãxts
[4]);

667 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 0, &
mb_ty≥_c⁄ãxts
[5]);

668 
csym
 = ((
ãmp_sym
 >> 2)&0x01) != 0;

669 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 
csym
, &
mb_ty≥_c⁄ãxts
[6]);

670 
csym
 = ((
ãmp_sym
 >> 1)&0x01) != 0;

671 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 
csym
, &
mb_ty≥_c⁄ãxts
[6]);

672 
csym
 = (
ãmp_sym
 & 0x01) != 0;

673 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 
csym
, &
mb_ty≥_c⁄ãxts
[6]);

675 i‡(
a˘_sym
==11 ||áct_sym==22)

677 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 1, &
mb_ty≥_c⁄ãxts
[
a˘_˘x
]);

678 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 1, &
mb_ty≥_c⁄ãxts
[4]);

679 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 1, &
mb_ty≥_c⁄ãxts
[5]);

680 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 1, &
mb_ty≥_c⁄ãxts
[6]);

681 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 1, &
mb_ty≥_c⁄ãxts
[6]);

682 
csym
 = (
a˘_sym
 != 11);

683 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 
csym
, &
mb_ty≥_c⁄ãxts
[6]);

687 
ãmp_sym
 = (
a˘_sym
 > 22) ?áct_sym - 13 :áct_sym - 12;

688 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 1, &
mb_ty≥_c⁄ãxts
[
a˘_˘x
]);

689 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 1, &
mb_ty≥_c⁄ãxts
[4]);

690 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 1, &
mb_ty≥_c⁄ãxts
[5]);

691 
csym
 = ((
ãmp_sym
 >> 3)&0x01) != 0;

692 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 
csym
, &
mb_ty≥_c⁄ãxts
[6]);

693 
csym
 = ((
ãmp_sym
 >> 2)&0x01) != 0;

694 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 
csym
, &
mb_ty≥_c⁄ãxts
[6]);

695 
csym
 = ((
ãmp_sym
 >> 1)&0x01) != 0;

696 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 
csym
, &
mb_ty≥_c⁄ãxts
[6]);

697 
csym
 = (
ãmp_sym
 & 0x01) != 0;

698 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 
csym
, &
mb_ty≥_c⁄ãxts
[6]);

702 if(
a˘_sym
 =
mode16x16
)

704 
mb_ty≥_c⁄ãxts
 = 
˘x
->mb_type_contexts[1];

705 if–
mode_sym
 == 24 )

707 
	`büri_ícode_symbﬁ_föÆ
(
ìp_dp
, 1 );

708 
dp
->
bô°ªam
->
wrôe_Êag
 = 1;

709 
£
->
Àn
 = (
	`¨õnco_bôs_wrôãn
(
ìp_dp
Ë- 
cuº_Àn
);

710 
CABAC_TRACE
;

713 
	`büri_ícode_symbﬁ_föÆ
(
ìp_dp
, 0 );

715 
a˘_˘x
 = 8;

716 
a˘_sym
 = 
mode_sym
/12;

717 
	`büri_ícode_symbﬁ
(
ìp_dp
, 
a˘_sym
, 
mb_ty≥_c⁄ãxts
 + 
a˘_˘x
 );

718 
mode_sym
 = mode_sym % 12;

720 
a˘_sym
 = 
mode_sym
 >> 2;

721 
a˘_˘x
 = 9;

722 i‡(
a˘_sym
==0)

724 
	`büri_ícode_symbﬁ
(
ìp_dp
, 0, 
mb_ty≥_c⁄ãxts
 + 
a˘_˘x
 );

728 
	`büri_ícode_symbﬁ
(
ìp_dp
, 1, 
mb_ty≥_c⁄ãxts
 + 
a˘_˘x
 );

729 
	`büri_ícode_symbﬁ
(
ìp_dp
, (
a˘_sym
!=1), 
mb_ty≥_c⁄ãxts
 + 
a˘_˘x
 );

732 
mode_sym
 = mode_sym & 0x03;

733 
a˘_˘x
 = 10;

734 
a˘_sym
 = 
mode_sym
 >> 1;

735 
	`büri_ícode_symbﬁ
(
ìp_dp
, 
a˘_sym
, 
mb_ty≥_c⁄ãxts
 + 
a˘_˘x
 );

736 
a˘_sym
 = (
mode_sym
 & 0x01);

737 
	`büri_ícode_symbﬁ
(
ìp_dp
, 
a˘_sym
, 
mb_ty≥_c⁄ãxts
 + 
a˘_˘x
 );

740 
dp
->
bô°ªam
->
wrôe_Êag
 = 1;

741 
£
->
Àn
 = (
	`¨õnco_bôs_wrôãn
(
ìp_dp
Ë- 
cuº_Àn
);

742 
CABAC_TRACE
;

743 
	}
}

752 
	$wrôeMB_I_ty≥Info_CABAC
(
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
)

754 
EncodögEnvú⁄mítPå
 
ìp_dp
 = &(
dp
->
ì_ˇbac
);

755 
cuº_Àn
 = 
	`¨õnco_bôs_wrôãn
(
ìp_dp
);

756 
a
, 
b
;

757 
a˘_˘x
 = 0;

758 
a˘_sym
;

759 
Sli˚
 *
cuºSli˚
 = 
dp
->
p_Sli˚
;

760 
mode_sym
 = 0;

762 
MŸi⁄InfoC⁄ãxts
 *
˘x
 = 
cuºSli˚
->
mŸ_˘x
;

764 i‡(
cuºMB
->
mb_up
 =
NULL
)

765 
b
 = 0;

767 
b
 = ((
cuºMB
->
mb_up
->
mb_ty≥
 !
I4MB
 && cuºMB->mb_up->mb_ty≥ !
I8MB
) ? 1 : 0 );

769 i‡(
cuºMB
->
mb_À·
 =
NULL
)

770 
a
 = 0;

772 
a
 = ((
cuºMB
->
mb_À·
->
mb_ty≥
 !
I4MB
 && cuºMB->mb_À·->mb_ty≥ !
I8MB
) ? 1 : 0 );

774 
a˘_˘x
 = 
a
 + 
b
;

775 
a˘_sym
 = 
£
->
vÆue1
;

776 
£
->
c⁄ãxt
 = 
a˘_˘x
;

778 i‡(
a˘_sym
==0)

780 
	`büri_ícode_symbﬁ
(
ìp_dp
, 0, 
˘x
->
mb_ty≥_c⁄ãxts
[0] + 
a˘_˘x
 );

782 if–
a˘_sym
 == 25 )

784 
	`büri_ícode_symbﬁ
(
ìp_dp
, 1, 
˘x
->
mb_ty≥_c⁄ãxts
[0] + 
a˘_˘x
 );

785 
	`büri_ícode_symbﬁ_föÆ
(
ìp_dp
, 1);

789 
	`büri_ícode_symbﬁ
(
ìp_dp
, 1, 
˘x
->
mb_ty≥_c⁄ãxts
[0] + 
a˘_˘x
 );

791 
	`büri_ícode_symbﬁ_föÆ
(
ìp_dp
, 0);

793 
mode_sym
 = 
a˘_sym
-1;

794 
a˘_˘x
 = 4;

795 
a˘_sym
 = 
mode_sym
/12;

796 
	`büri_ícode_symbﬁ
(
ìp_dp
, 
a˘_sym
, 
˘x
->
mb_ty≥_c⁄ãxts
[0] + 
a˘_˘x
 );

797 
mode_sym
 = mode_sym % 12;

798 
a˘_sym
 = 
mode_sym
 / 4;

799 
a˘_˘x
 = 5;

800 i‡(
a˘_sym
==0)

802 
	`büri_ícode_symbﬁ
(
ìp_dp
, 0, 
˘x
->
mb_ty≥_c⁄ãxts
[0] + 
a˘_˘x
 );

806 
	`büri_ícode_symbﬁ
(
ìp_dp
, 1, 
˘x
->
mb_ty≥_c⁄ãxts
[0] + 
a˘_˘x
 );

807 
a˘_˘x
=6;

808 
	`büri_ícode_symbﬁ
(
ìp_dp
, (
a˘_sym
!=1), 
˘x
->
mb_ty≥_c⁄ãxts
[0] + 
a˘_˘x
 );

810 
mode_sym
 = mode_sym & 0x03;

811 
a˘_sym
 = 
mode_sym
 >> 1;

812 
a˘_˘x
 = 7;

813 
	`büri_ícode_symbﬁ
(
ìp_dp
, 
a˘_sym
, 
˘x
->
mb_ty≥_c⁄ãxts
[0] + 
a˘_˘x
 );

814 
a˘_˘x
 = 8;

815 
a˘_sym
 = 
mode_sym
 & 0x01;

816 
	`büri_ícode_symbﬁ
(
ìp_dp
, 
a˘_sym
, 
˘x
->
mb_ty≥_c⁄ãxts
[0] + 
a˘_˘x
 );

819 
dp
->
bô°ªam
->
wrôe_Êag
 = 1;

820 
£
->
Àn
 = (
	`¨õnco_bôs_wrôãn
(
ìp_dp
Ë- 
cuº_Àn
);

821 
CABAC_TRACE
;

822 
	}
}

831 
	$wrôeB8_B_ty≥Info_CABAC
(
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
)

833 
EncodögEnvú⁄mítPå
 
ìp_dp
 = &(
dp
->
ì_ˇbac
);

834 
BiC⁄ãxtTy≥
 *
b8_ty≥_c⁄ãxts
 = 
dp
->
p_Sli˚
->
mŸ_˘x
->b8_type_contexts[1];

835 
cuº_Àn
 = 
	`¨õnco_bôs_wrôãn
(
ìp_dp
);

836 
a˘_sym
 = 
£
->
vÆue1
;

837 sig√d 
csym
;

839 i‡(
a˘_sym
==0)

841 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 0, &
b8_ty≥_c⁄ãxts
[0]);

842 
dp
->
bô°ªam
->
wrôe_Êag
 = 1;

843 
£
->
Àn
 = (
	`¨õnco_bôs_wrôãn
(
ìp_dp
Ë- 
cuº_Àn
);

844 
CABAC_TRACE
;

849 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 1, &
b8_ty≥_c⁄ãxts
[0]);

850 
a˘_sym
--;

853 i‡(
a˘_sym
 < 2)

855 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 0, &
b8_ty≥_c⁄ãxts
[1]);

856 
	`büri_ícode_symbﬁ
 (
ìp_dp
, (
a˘_sym
!=0), &
b8_ty≥_c⁄ãxts
[3]);

858 i‡(
a˘_sym
 < 6)

860 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 1, &
b8_ty≥_c⁄ãxts
[1]);

861 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 0, &
b8_ty≥_c⁄ãxts
[2]);

862 
csym
 = (Ë(((
a˘_sym
 - 2) >> 1) & 0x01) != 0;

863 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 
csym
, &
b8_ty≥_c⁄ãxts
[3]);

864 
csym
 = (Ë((
a˘_sym
 - 2) & 0x01) != 0;

865 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 
csym
, &
b8_ty≥_c⁄ãxts
[3]);

869 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 1, &
b8_ty≥_c⁄ãxts
[1]);

870 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 1, &
b8_ty≥_c⁄ãxts
[2]);

871 
csym
 = (Ë(((
a˘_sym
 - 6)>> 2) & 0x01);

872 i‡(
csym
)

874 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 1, &
b8_ty≥_c⁄ãxts
[3]);

875 
csym
 = (Ë((
a˘_sym
 - 6) & 0x01) != 0;

876 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 
csym
, &
b8_ty≥_c⁄ãxts
[3]);

880 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 0, &
b8_ty≥_c⁄ãxts
[3]);

881 
csym
 = (Ë(((
a˘_sym
 - 6) >> 1) & 0x01) != 0;

882 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 
csym
, &
b8_ty≥_c⁄ãxts
[3]);

883 
csym
 = (Ë((
a˘_sym
 - 6) & 0x01) != 0;

884 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 
csym
, &
b8_ty≥_c⁄ãxts
[3]);

888 
dp
->
bô°ªam
->
wrôe_Êag
 = 1;

889 
£
->
Àn
 = (
	`¨õnco_bôs_wrôãn
(
ìp_dp
Ë- 
cuº_Àn
);

890 
CABAC_TRACE
;

891 
	}
}

900 
	$wrôeB8_ty≥Info_CABAC
(
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
)

902 
EncodögEnvú⁄mítPå
 
ìp_dp
 = &(
dp
->
ì_ˇbac
);

903 
	`BiC⁄ãxtTy≥
 (*
b8_ty≥_c⁄ãxts
Ë
dp
->
p_Sli˚
->
mŸ_˘x
->b8_type_contexts[0];

904 
cuº_Àn
 = 
	`¨õnco_bôs_wrôãn
(
ìp_dp
);

906 
£
->
vÆue1
)

909 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 1, &
b8_ty≥_c⁄ãxts
[1]);

912 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 0, &
b8_ty≥_c⁄ãxts
[1]);

913 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 0, &
b8_ty≥_c⁄ãxts
[3]);

916 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 0, &
b8_ty≥_c⁄ãxts
[1]);

917 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 1, &
b8_ty≥_c⁄ãxts
[3]);

918 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 1, &
b8_ty≥_c⁄ãxts
[4]);

921 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 0, &
b8_ty≥_c⁄ãxts
[1]);

922 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 1, &
b8_ty≥_c⁄ãxts
[3]);

923 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 0, &
b8_ty≥_c⁄ãxts
[4]);

927 
dp
->
bô°ªam
->
wrôe_Êag
 = 1;

928 
£
->
Àn
 = (
	`¨õnco_bôs_wrôãn
(
ìp_dp
Ë- 
cuº_Àn
);

929 
CABAC_TRACE
;

930 
	}
}

939 
	$wrôeI¡øPªdMode_CABAC
(
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
)

941 
EncodögEnvú⁄mítPå
 
ìp_dp
 = &(
dp
->
ì_ˇbac
);

942 
cuº_Àn
 = 
	`¨õnco_bôs_wrôãn
(
ìp_dp
);

943 
BiC⁄ãxtTy≥
 *
ùr_c⁄ãxts
 = (
dp
->
p_Sli˚
)->
ãx_˘x
->ipr_contexts;

946 i‡(
£
->
vÆue1
 == -1)

947 
	`büri_ícode_symbﬁ
(
ìp_dp
, 1, 
ùr_c⁄ãxts
);

950 
	`büri_ícode_symbﬁ
(
ìp_dp
, 0, 
ùr_c⁄ãxts
);

953 
	`büri_ícode_symbﬁ
(
ìp_dp
, ( 
£
->
vÆue1
 & 0x1 ), 
ùr_c⁄ãxts
+1);

954 
	`büri_ícode_symbﬁ
(
ìp_dp
, ((
£
->
vÆue1
 & 0x2)>>1), 
ùr_c⁄ãxts
+1);

955 
	`büri_ícode_symbﬁ
(
ìp_dp
, ((
£
->
vÆue1
 & 0x4)>>2), 
ùr_c⁄ãxts
+1);

958 
dp
->
bô°ªam
->
wrôe_Êag
 = 1;

959 
£
->
Àn
 = (
	`¨õnco_bôs_wrôãn
(
ìp_dp
Ë- 
cuº_Àn
);

960 
CABAC_TRACE
;

961 
	}
}

970 
	$wrôeRefPic_P_CABAC
(
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
)

972 
EncodögEnvú⁄mítPå
 
ìp_dp
 = &(
dp
->
ì_ˇbac
);

973 
cuº_Àn
 = 
	`¨õnco_bôs_wrôãn
(
ìp_dp
);

974 
Sli˚
 *
cuºSli˚
 = 
dp
->
p_Sli˚
;

975 
VideoP¨amëîs
 *
p_Vid
 = 
dp
->p_Vid;

976 
PicMŸi⁄P¨ams
 **
mŸi⁄
 = 
p_Vid
->
íc_pi˘uª
->
mv_öfo
;

977 
MŸi⁄InfoC⁄ãxts
 *
˘x
 = 
cuºSli˚
->
mŸ_˘x
;

979 
add˘x
 = 0;

981 
a
 = 0, 
b
 = 0;

982 
a˘_˘x
;

983 
a˘_sym
;

984 
li°
 = 
£
->
vÆue2
;

986 
PixñPos
 
block_a
, 
block_b
;

987 *
mb_size
 = 
p_Vid
->mb_size[
IS_LUMA
];

989 
	`gë4x4Neighbour
(
cuºMB
, cuºMB->
subblock_x
 - 1, cuºMB->
subblock_y
 , 
mb_size
, &
block_a
);

990 
	`gë4x4Neighbour
(
cuºMB
, cuºMB->
subblock_x
, cuºMB->
subblock_y
 - 1, 
mb_size
, &
block_b
);

992 i‡(
block_b
.
avaûabÀ
)

994 i‡(
p_Vid
->
mb_aff_‰ame_Êag
 && (
cuºMB
->
mb_fõld
 =
FALSE
Ë&& (p_Vid->
mb_d©a
[
block_b
.
mb_addr
].mb_fõld =
TRUE
))

995 
b
 = (
mŸi⁄
[
block_b
.
pos_y
][block_b.
pos_x
].
ªf_idx
[
li°
] > 1 ? 2 : 0);

997 
b
 = (
mŸi⁄
[
block_b
.
pos_y
][block_b.
pos_x
].
ªf_idx
[
li°
] > 0 ? 2 : 0);

1000 i‡(
block_a
.
avaûabÀ
)

1002 i‡(
p_Vid
->
mb_aff_‰ame_Êag
 && (
cuºMB
->
mb_fõld
 =
FALSE
Ë&& (p_Vid->
mb_d©a
[
block_a
.
mb_addr
].mb_fõld =
TRUE
))

1003 
a
 = (
mŸi⁄
[
block_a
.
pos_y
][block_a.
pos_x
].
ªf_idx
[
li°
] > 1 ? 1 : 0);

1005 
a
 = (
mŸi⁄
[
block_a
.
pos_y
][block_a.
pos_x
].
ªf_idx
[
li°
] > 0 ? 1 : 0);

1008 
a˘_˘x
 = 
a
 + 
b
;

1009 
£
->
c⁄ãxt
 = 
a˘_˘x
;

1010 
a˘_sym
 = 
£
->
vÆue1
;

1012 i‡(
a˘_sym
==0)

1014 
	`büri_ícode_symbﬁ
(
ìp_dp
, 0, 
˘x
->
ªf_no_c⁄ãxts
[
add˘x
] + 
a˘_˘x
 );

1018 
	`büri_ícode_symbﬁ
(
ìp_dp
, 1, 
˘x
->
ªf_no_c⁄ãxts
[
add˘x
] + 
a˘_˘x
);

1019 
a˘_sym
--;

1020 
a˘_˘x
=4;

1021 
	`u«ry_bö_ícode
(
ìp_dp
, 
a˘_sym
, 
˘x
->
ªf_no_c⁄ãxts
[
add˘x
] + 
a˘_˘x
, 1);

1024 
dp
->
bô°ªam
->
wrôe_Êag
 = 1;

1025 
£
->
Àn
 = (
	`¨õnco_bôs_wrôãn
(
ìp_dp
Ë- 
cuº_Àn
);

1026 
CABAC_TRACE
;

1027 
	}
}

1036 
	$wrôeRefPic_B_CABAC
(
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
)

1038 
EncodögEnvú⁄mítPå
 
ìp_dp
 = &(
dp
->
ì_ˇbac
);

1039 
cuº_Àn
 = 
	`¨õnco_bôs_wrôãn
(
ìp_dp
);

1040 
Sli˚
 *
cuºSli˚
 = 
dp
->
p_Sli˚
;

1041 
VideoP¨amëîs
 *
p_Vid
 = 
dp
->p_Vid;

1042 
PicMŸi⁄P¨ams
 **
mŸi⁄
 = 
p_Vid
->
íc_pi˘uª
->
mv_öfo
;

1043 
MŸi⁄InfoC⁄ãxts
 *
˘x
 = 
cuºSli˚
->
mŸ_˘x
;

1044 
add˘x
 = 0;

1046 
a
 = 0, 
b
 = 0;

1047 
a˘_˘x
;

1048 
a˘_sym
;

1049 
li°
 = 
£
->
vÆue2
;

1051 
b8a
, 
b8b
;

1053 
PixñPos
 
block_a
, 
block_b
;

1054 *
mb_size
 = 
p_Vid
->mb_size[
IS_LUMA
];

1056 
	`gë4x4Neighbour
(
cuºMB
, cuºMB->
subblock_x
 - 1, cuºMB->
subblock_y
 , 
mb_size
, &
block_a
);

1057 
	`gë4x4Neighbour
(
cuºMB
, cuºMB->
subblock_x
, cuºMB->
subblock_y
 - 1, 
mb_size
, &
block_b
);

1059 i‡(
block_b
.
avaûabÀ
)

1061 
b8b
=((
block_b
.
x
 >> 1Ë& 0x01)+2*((block_b.
y
 >> 1) & 0x01);

1063 i‡(((
p_Vid
->
mb_d©a
[
block_b
.
mb_addr
].
mb_ty≥
 =0Ë&& !p_Vid->
giRDO±_B8O∆yFœg
Ë|| (p_Vid->mb_d©a[block_b.mb_addr].
b8x8
[
b8b
].
mode
==0))

1064 
b
=0;

1067 i‡(
p_Vid
->
mb_aff_‰ame_Êag
 && (
cuºMB
->
mb_fõld
 =
FALSE
Ë&& (p_Vid->
mb_d©a
[
block_b
.
mb_addr
].mb_fõld =
TRUE
))

1068 
b
 = (
mŸi⁄
[
block_b
.
pos_y
][block_b.
pos_x
].
ªf_idx
[
li°
] > 1 ? 1 : 0);

1070 
b
 = (
mŸi⁄
[
block_b
.
pos_y
][block_b.
pos_x
].
ªf_idx
[
li°
] > 0 ? 1 : 0);

1074 i‡(
block_a
.
avaûabÀ
)

1076 
b8a
=((
block_a
.
x
 >> 1Ë& 0x01)+2*((block_a.
y
 >> 1) & 0x01);

1077 i‡(((
p_Vid
->
mb_d©a
[
block_a
.
mb_addr
].
mb_ty≥
 =0Ë&& !p_Vid->
giRDO±_B8O∆yFœg
Ë|| (p_Vid->mb_d©a[block_a.mb_addr].
b8x8
[
b8a
].
mode
 ==0))

1078 
a
=0;

1081 i‡(
p_Vid
->
mb_aff_‰ame_Êag
 && (
cuºMB
->
mb_fõld
 =
FALSE
Ë&& (p_Vid->
mb_d©a
[
block_a
.
mb_addr
].mb_fõld =
TRUE
))

1082 
a
 = (
mŸi⁄
[
block_a
.
pos_y
][block_a.
pos_x
].
ªf_idx
[
li°
] > 1 ? 1 : 0);

1084 
a
 = (
mŸi⁄
[
block_a
.
pos_y
][block_a.
pos_x
].
ªf_idx
[
li°
] > 0 ? 1 : 0);

1088 
a˘_˘x
 = 
a
 + 2*
b
;

1089 
£
->
c⁄ãxt
 = 
a˘_˘x
;

1090 
a˘_sym
 = 
£
->
vÆue1
;

1092 i‡(
a˘_sym
==0)

1094 
	`büri_ícode_symbﬁ
(
ìp_dp
, 0, 
˘x
->
ªf_no_c⁄ãxts
[
add˘x
] + 
a˘_˘x
 );

1098 
	`büri_ícode_symbﬁ
(
ìp_dp
, 1, 
˘x
->
ªf_no_c⁄ãxts
[
add˘x
] + 
a˘_˘x
);

1099 
a˘_sym
--;

1100 
a˘_˘x
=4;

1101 
	`u«ry_bö_ícode
(
ìp_dp
, 
a˘_sym
, 
˘x
->
ªf_no_c⁄ãxts
[
add˘x
] + 
a˘_˘x
, 1);

1104 
dp
->
bô°ªam
->
wrôe_Êag
 = 1;

1105 
£
->
Àn
 = (
	`¨õnco_bôs_wrôãn
(
ìp_dp
Ë- 
cuº_Àn
);

1106 
CABAC_TRACE
;

1107 
	}
}

1116 
	$wrôeDqu™t_CABAC
(
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
)

1118 
EncodögEnvú⁄mítPå
 
ìp_dp
 = &(
dp
->
ì_ˇbac
);

1119 
cuº_Àn
 = 
	`¨õnco_bôs_wrôãn
(
ìp_dp
);

1121 
TextuªInfoC⁄ãxts
 *
˘x
 = 
dp
->
p_Sli˚
->
ãx_˘x
;

1123 
dqu™t
 = 
£
->
vÆue1
;

1124 
sign
 = (
dqu™t
 <= 0) ? 0 : -1;

1125 
a˘_sym
 = (
	`übs
(
dqu™t
Ë<< 1Ë+ 
sign
;

1126 
a˘_˘x
 = ((
cuºMB
->
¥ev_dqp
 != 0) ? 1 : 0);

1128 i‡(
a˘_sym
 == 0)

1130 
	`büri_ícode_symbﬁ
(
ìp_dp
, 0, 
˘x
->
dñè_qp_c⁄ãxts
 + 
a˘_˘x
 );

1134 
	`büri_ícode_symbﬁ
(
ìp_dp
, 1, 
˘x
->
dñè_qp_c⁄ãxts
 + 
a˘_˘x
);

1135 
a˘_˘x
=2;

1136 
a˘_sym
--;

1137 
	`u«ry_bö_ícode
(
ìp_dp
, 
a˘_sym
,
˘x
->
dñè_qp_c⁄ãxts
+
a˘_˘x
,1);

1140 
dp
->
bô°ªam
->
wrôe_Êag
 = 1;

1141 
£
->
Àn
 = (
	`¨õnco_bôs_wrôãn
(
ìp_dp
Ë- 
cuº_Àn
);

1142 
CABAC_TRACE
;

1143 
	}
}

1152 
	$wrôeMVD_CABAC
(
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
)

1154 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1155 
EncodögEnvú⁄mítPå
 
ìp_dp
 = &(
dp
->
ì_ˇbac
);

1157 
cuº_Àn
 = 
	`¨õnco_bôs_wrôãn
(
ìp_dp
);

1158 
MŸi⁄InfoC⁄ãxts
 *
˘x
 = 
dp
->
p_Sli˚
->
mŸ_˘x
;

1160 
i
 = 
cuºMB
->
subblock_x
;

1161 
j
 = 
cuºMB
->
subblock_y
;

1162 
a
, 
b
;

1163 
a˘_˘x
;

1164 
a˘_sym
;

1165 
mv_¥ed_ªs
;

1166 
mv_loˇl_îr
;

1167 
mv_sign
;

1168 
li°_idx
 = 
£
->
vÆue2
 & 0x01;

1169 
k
 = (
£
->
vÆue2
>>1);

1171 
PixñPos
 
block_a
, 
block_b
;

1173 *
mb_size
 = 
p_Vid
->mb_size[
IS_LUMA
];

1175 
	`gë4x4Neighbour
(
cuºMB
, 
i
 - 1, 
j
 , 
mb_size
, &
block_a
);

1176 
	`gë4x4Neighbour
(
cuºMB
, 
i
 , 
j
 - 1, 
mb_size
, &
block_b
);

1178 i‡(
block_b
.
avaûabÀ
)

1180 
b
 = 
	`übs
(
p_Vid
->
mb_d©a
[
block_b
.
mb_addr
].
mvd
[
li°_idx
][block_b.
y
][block_b.
x
][
k
]);

1181 i‡(
p_Vid
->
mb_aff_‰ame_Êag
 && (
k
==1))

1183 i‡((
cuºMB
->
mb_fõld
==0Ë&& (
p_Vid
->
mb_d©a
[
block_b
.
mb_addr
].mb_field==1))

1184 
b
 *= 2;

1185 i‡((
cuºMB
->
mb_fõld
==1Ë&& (
p_Vid
->
mb_d©a
[
block_b
.
mb_addr
].mb_field==0))

1186 
b
 /= 2;

1190 
b
=0;

1192 i‡(
block_a
.
avaûabÀ
)

1194 
a
 = 
	`übs
(
p_Vid
->
mb_d©a
[
block_a
.
mb_addr
].
mvd
[
li°_idx
][block_a.
y
][block_a.
x
][
k
]);

1195 i‡(
p_Vid
->
mb_aff_‰ame_Êag
 && (
k
==1))

1197 i‡((
cuºMB
->
mb_fõld
==0Ë&& (
p_Vid
->
mb_d©a
[
block_a
.
mb_addr
].mb_field==1))

1198 
a
 *= 2;

1199 i‡((
cuºMB
->
mb_fõld
==1Ë&& (
p_Vid
->
mb_d©a
[
block_a
.
mb_addr
].mb_field==0))

1200 
a
 /= 2;

1204 
a
 = 0;

1206 i‡((
mv_loˇl_îr
 = 
a
 + 
b
)<3)

1207 
a˘_˘x
 = 5 * 
k
;

1210 i‡(
mv_loˇl_îr
>32)

1211 
a˘_˘x
 = 5 * 
k
 + 3;

1213 
a˘_˘x
 = 5 * 
k
 + 2;

1216 
mv_¥ed_ªs
 = 
£
->
vÆue1
;

1217 
£
->
c⁄ãxt
 = 
a˘_˘x
;

1219 
a˘_sym
 = 
	`übs
(
mv_¥ed_ªs
);

1221 i‡(
a˘_sym
 == 0)

1222 
	`büri_ícode_symbﬁ
(
ìp_dp
, 0, &
˘x
->
mv_ªs_c⁄ãxts
[0][
a˘_˘x
] );

1225 
	`büri_ícode_symbﬁ
(
ìp_dp
, 1, &
˘x
->
mv_ªs_c⁄ãxts
[0][
a˘_˘x
] );

1226 
a˘_sym
--;

1227 
a˘_˘x
=5*
k
;

1228 
	`u«ry_exp_gﬁomb_mv_ícode
(
ìp_dp
,
a˘_sym
,
˘x
->
mv_ªs_c⁄ãxts
[1]+
a˘_˘x
,3);

1229 
mv_sign
 = (
mv_¥ed_ªs
<0) ? 1: 0;

1230 
	`büri_ícode_symbﬁ_eq_¥ob
(
ìp_dp
, 
mv_sign
);

1233 
dp
->
bô°ªam
->
wrôe_Êag
 = 1;

1234 
£
->
Àn
 = (
	`¨õnco_bôs_wrôãn
(
ìp_dp
Ë- 
cuº_Àn
);

1235 
CABAC_TRACE
;

1236 
	}
}

1246 
	$wrôeCIPªdMode_CABAC
(
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
)

1248 
EncodögEnvú⁄mítPå
 
ìp_dp
 = &(
dp
->
ì_ˇbac
);

1249 
cuº_Àn
 = 
	`¨õnco_bôs_wrôãn
(
ìp_dp
);

1250 
TextuªInfoC⁄ãxts
 *
˘x
 = 
dp
->
p_Sli˚
->
ãx_˘x
;

1252 
a˘_sym
 = 
£
->
vÆue1
;

1254 
Ma¸oblock
 *
MbUp
 = 
cuºMB
->
mb_up
;

1255 
Ma¸oblock
 *
MbLe·
 = 
cuºMB
->
mb_À·
;

1257 
b
 = (
MbUp
 !
NULL
Ë? (((MbUp->
c_ùªd_mode
 !0Ë&& (MbUp->
mb_ty≥
 !
IPCM
)) ? 1 : 0) : 0;

1258 
a
 = (
MbLe·
 !
NULL
Ë? (((MbLe·->
c_ùªd_mode
 !0Ë&& (MbLe·->
mb_ty≥
 !
IPCM
)) ? 1 : 0) : 0;

1260 
a˘_˘x
 = 
a
 + 
b
;

1262 i‡(
a˘_sym
==0)

1263 
	`büri_ícode_symbﬁ
(
ìp_dp
, 0, 
˘x
->
cùr_c⁄ãxts
 + 
a˘_˘x
 );

1266 
	`büri_ícode_symbﬁ
(
ìp_dp
, 1, 
˘x
->
cùr_c⁄ãxts
 + 
a˘_˘x
 );

1267 
	`u«ry_bö_max_ícode
(
ìp_dp
,(Ë(
a˘_sym
-1),
˘x
->
cùr_c⁄ãxts
 + 3,0,2);

1270 
dp
->
bô°ªam
->
wrôe_Êag
 = 1;

1271 
£
->
Àn
 = (
	`¨õnco_bôs_wrôãn
(
ìp_dp
Ë- 
cuº_Àn
);

1272 
CABAC_TRACE
;

1273 
	}
}

1283 
	$wrôeCBP_BIT_CABAC
 (
Ma¸oblock
* 
cuºMB
, 
b8
, 
bô
, 
cbp
, 
EncodögEnvú⁄mítPå
 
ìp_dp
, 
TextuªInfoC⁄ãxts
 *
˘x
)

1285 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1286 
PixñPos
 
block_a
;

1287 
a
 = 0, 
b
 = 0;

1289 
mb_x
=(
b8
 & 0x01)<<1;

1290 
mb_y
=(
b8
 >> 1)<<1;

1292 i‡(
mb_y
 == 0)

1294 i‡(!((
cuºMB
->
mb_up
 =
NULL
Ë|| ((cuºMB->mb_up)->
mb_ty≥
==
IPCM
)))

1296 
b
 = (–((
cuºMB
->
mb_up
)->
cbp
 & (1<<(2+(
mb_x
>>1)))) == 0) ? 1 : 0);

1301 
b
 = ( ((
cbp
 & (1<<(
mb_x
 >> 1))) == 0) ? 1: 0);

1303 i‡(
mb_x
 == 0)

1305 
	`gë4x4Neighbour
(
cuºMB
, (
mb_x
 << 2Ë- 1, (
mb_y
 << 2), 
p_Vid
->
mb_size
[
IS_LUMA
], &
block_a
);

1307 i‡(
block_a
.
avaûabÀ
 && (!(
p_Vid
->
mb_d©a
[block_a.
mb_addr
].
mb_ty≥
==
IPCM
)))

1309 
a
 = (–(
p_Vid
->
mb_d©a
[
block_a
.
mb_addr
].
cbp
 & (1<<(2*(block_a.
y
>>1)+1))) == 0) ? 1 : 0);

1313 
a
 = ( ((
cbp
 & (1<<
mb_y
)) == 0) ? 1: 0);

1316 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 
bô
, 
˘x
->
cbp_c⁄ãxts
[0] + 
a
+2*
b
);

1317 
	}
}

1326 
	$wrôeCBP_CABAC
(
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
)

1328 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1329 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

1330 
EncodögEnvú⁄mítPå
 
ìp_dp
 = &(
dp
->
ì_ˇbac
);

1331 
cuº_Àn
 = 
	`¨õnco_bôs_wrôãn
(
ìp_dp
);

1332 
TextuªInfoC⁄ãxts
 *
˘x
 = 
cuºSli˚
->
ãx_˘x
;

1334 
a0
 = 0, 
a1
 = 0, 
b0
 = 0, 
b1
 = 0;

1335 
cuº_cbp_˘x
;

1336 
cbp
 = 
£
->
vÆue1
;

1337 
cbp_bô
;

1338 
b8
;

1340 
b8
=0; b8<4; ++b8)

1342 
	`wrôeCBP_BIT_CABAC
 (
cuºMB
, 
b8
, 
cbp
&(1<<b8), cbp, 
ìp_dp
, 
˘x
);

1345 i‡((
p_Vid
->
yuv_f‹m©
 !
YUV400
Ë&& (p_Vid->yuv_f‹m© !
YUV444
) )

1348 i‡(
cuºMB
->
mb_up
 !
NULL
)

1350 if((
cuºMB
->
mb_up
)->
mb_ty≥
 =
IPCM
 || ((cuºMB->mb_up)->
cbp
 > 15))

1351 
b0
 = 2;

1354 i‡(
cuºMB
->
mb_À·
 !
NULL
)

1356 if((
cuºMB
->
mb_À·
)->
mb_ty≥
==
IPCM
 || ((cuºMB->mb_À·)->
cbp
 > 15))

1357 
a0
 = 1;

1360 
cuº_cbp_˘x
 = 
a0
 + 
b0
;

1361 
cbp_bô
 = (
cbp
 > 15 ) ? 1 : 0;

1362 
	`büri_ícode_symbﬁ
(
ìp_dp
, 
cbp_bô
, 
˘x
->
cbp_c⁄ãxts
[1] + 
cuº_cbp_˘x
 );

1364 i‡(
cbp
 > 15)

1366 i‡(
cuºMB
->
mb_up
 !
NULL
)

1368 if((
cuºMB
->
mb_up
)->
mb_ty≥
 =
IPCM
 ||

1369 (((
cuºMB
->
mb_up
)->
cbp
 > 15) && ( ((currMB->mb_up)->cbp >> 4) == 2)))

1370 
b1
 = 2;

1373 i‡(
cuºMB
->
mb_À·
 !
NULL
)

1375 if((
cuºMB
->
mb_À·
)->
mb_ty≥
==
IPCM
 ||

1376 (((
cuºMB
->
mb_À·
)->
cbp
 > 15) && ( ((currMB->mb_left)->cbp >> 4) == 2)))

1377 
a1
 = 1;

1380 
cuº_cbp_˘x
 = 
a1
 + 
b1
;

1381 
cbp_bô
 = ((
cbp
>>4) == 2) ? 1 : 0;

1382 
	`büri_ícode_symbﬁ
(
ìp_dp
, 
cbp_bô
, 
˘x
->
cbp_c⁄ãxts
[2] + 
cuº_cbp_˘x
 );

1386 
dp
->
bô°ªam
->
wrôe_Êag
 = 1;

1387 
£
->
Àn
 = (
	`¨õnco_bôs_wrôãn
(
ìp_dp
Ë- 
cuº_Àn
);

1388 
CABAC_TRACE
;

1389 
	}
}

1397 
	$wrôe_™d_°‹e_CBP_block_bô_444
 (
Ma¸oblock
* 
cuºMB
, 
EncodögEnvú⁄mítPå
 
ìp_dp
, 
ty≥
, 
cbp_bô
, 
TextuªInfoC⁄ãxts
* 
ãx_˘x
)

1399 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1400 
Ma¸oblock
 *
mb_d©a
 = 
p_Vid
->mb_data;

1402 
y_ac
 = (
ty≥
==
LUMA_16AC
 ||Åy≥==
LUMA_8x8
 ||Åy≥==
LUMA_8x4
 ||Åy≥==
LUMA_4x8
 ||Åy≥==
LUMA_4x4


1403 || 
ty≥
==
CB_16AC
 ||Åy≥==
CB_8x8
 ||Åy≥==
CB_8x4
 ||Åy≥==
CB_4x8
 ||Åy≥==
CB_4x4


1404 || 
ty≥
==
CR_16AC
 ||Åy≥==
CR_8x8
 ||Åy≥==
CR_8x4
 ||Åy≥==
CR_4x8
 ||Åy≥==
CR_4x4
);

1405 
y_dc
 = (
ty≥
==
LUMA_16DC
 ||Åy≥==
CB_16DC
 ||Åy≥==
CR_16DC
);

1406 
u_ac
 = (
ty≥
==
CHROMA_AC
 && !
p_Vid
->
is_v_block
);

1407 
v_ac
 = (
ty≥
==
CHROMA_AC
 && 
p_Vid
->
is_v_block
);

1408 
chroma_dc
 = (
ty≥
==
CHROMA_DC
 ||Åy≥==
CHROMA_DC_2x4
 ||Åy≥==
CHROMA_DC_4x4
);

1409 
u_dc
 = (
chroma_dc
 && !
p_Vid
->
is_v_block
);

1410 
v_dc
 = (
chroma_dc
 && 
p_Vid
->
is_v_block
);

1411 
j
 = (
y_ac
 || 
u_ac
 || 
v_ac
 ? 
cuºMB
->
subblock_y
 : 0);

1412 
i
 = (
y_ac
 || 
u_ac
 || 
v_ac
 ? 
cuºMB
->
subblock_x
 : 0);

1413 
bô
 = (
y_dc
 ? 0 : 
y_ac
 ? 1 : 
u_dc
 ? 17 : 
v_dc
 ? 18 : 
u_ac
 ? 19 : 23);

1414 
deÁu…_bô
 = (
cuºMB
->
is_öåa_block
 ? 1 : 0);

1415 
uµî_bô
 = 
deÁu…_bô
;

1416 
À·_bô
 = 
deÁu…_bô
;

1417 
˘x
;

1419 
bô_pos_a
 = 0;

1420 
bô_pos_b
 = 0;

1422 
PixñPos
 
block_a
, 
block_b
;

1424 i‡(
y_ac
 || 
y_dc
)

1426 
	`gë4x4Neighbour
(
cuºMB
, 
i
 - 1, 
j
 , 
p_Vid
->
mb_size
[
IS_LUMA
], &
block_a
);

1427 
	`gë4x4Neighbour
(
cuºMB
, 
i
, 
j
 -1, 
p_Vid
->
mb_size
[
IS_LUMA
], &
block_b
);

1428 i‡(
y_ac
)

1430 i‡(
block_a
.
avaûabÀ
)

1431 
bô_pos_a
 = (
block_a
.
y
 << 2Ë+ block_a.
x
;

1432 i‡(
block_b
.
avaûabÀ
)

1433 
bô_pos_b
 = (
block_b
.
y
 << 2Ë+ block_b.
x
;

1438 
	`gë4x4Neighbour
(
cuºMB
, 
i
 - 1, 
j
 , 
p_Vid
->
mb_size
[
IS_CHROMA
], &
block_a
);

1439 
	`gë4x4Neighbour
(
cuºMB
, 
i
, 
j
 - 1, 
p_Vid
->
mb_size
[
IS_CHROMA
], &
block_b
);

1440 i‡(
u_ac
||
v_ac
)

1442 i‡(
block_a
.
avaûabÀ
)

1443 
bô_pos_a
 = (
block_a
.
y
 << 2Ë+ block_a.
x
;

1444 i‡(
block_b
.
avaûabÀ
)

1445 
bô_pos_b
 = (
block_b
.
y
 << 2Ë+ block_b.
x
;

1449 
bô
 = (
y_dc
 ? 0 : 
y_ac
 ? 1 + 
j
 + (
i
 >> 2Ë: 
u_dc
 ? 17 : 
v_dc
 ? 18 : 
u_ac
 ? 19 + j + (i >> 2): 35 + j + (i >> 2));

1451 i‡(
cbp_bô
)

1453 i‡(
ty≥
==
LUMA_8x8
)

1455 
cuºMB
->
cbp_bôs
[0] |((
öt64
Ë0x33 << 
bô
);

1457 i‡(
p_Vid
->
íc_pi˘uª
->
chroma_f‹m©_idc
 =
YUV444
)

1459 
cuºMB
->
cbp_bôs_8x8
[0] |((
öt64
Ë0x33 << 
bô
);

1462 i‡(
ty≥
==
CB_8x8
)

1464 
cuºMB
->
cbp_bôs_8x8
[1] |((
öt64
Ë0x33 << 
bô
);

1465 
cuºMB
->
cbp_bôs
[1] |((
öt64
Ë0x33 << 
bô
);

1467 i‡(
ty≥
==
CR_8x8
)

1469 
cuºMB
->
cbp_bôs_8x8
[2] |((
öt64
Ë0x33 << 
bô
);

1470 
cuºMB
->
cbp_bôs
[2] |((
öt64
Ë0x33 << 
bô
);

1472 i‡(
ty≥
==
LUMA_8x4
)

1474 
cuºMB
->
cbp_bôs
[0] |((
öt64
Ë0x03 << 
bô
);

1476 i‡(
ty≥
==
LUMA_4x8
)

1478 
cuºMB
->
cbp_bôs
[0] |((
öt64
Ë0x11 << 
bô
);

1480 i‡(
ty≥
==
CB_8x4
)

1482 
cuºMB
->
cbp_bôs
[1] |((
öt64
Ë0x03 << 
bô
);

1484 i‡(
ty≥
==
CR_8x4
)

1486 
cuºMB
->
cbp_bôs
[2] |((
öt64
Ë0x03 << 
bô
);

1488 i‡(
ty≥
==
CB_4x8
)

1490 
cuºMB
->
cbp_bôs
[1] |((
öt64
Ë0x11 << 
bô
);

1492 i‡(
ty≥
==
CR_4x8
)

1494 
cuºMB
->
cbp_bôs
[2] |((
öt64
Ë0x11 << 
bô
);

1496 i‡((
ty≥
==
CB_4x4
)||—y≥==
CB_16AC
)||—y≥==
CB_16DC
))

1498 
cuºMB
->
cbp_bôs
[1] |((
öt64
Ë0x01 << 
bô
);

1500 i‡((
ty≥
 =
CR_4x4
)||—y≥ =
CR_16AC
)||—y≥ =
CR_16DC
))

1502 
cuºMB
->
cbp_bôs
[2] |((
öt64
Ë0x01 << 
bô
);

1506 
cuºMB
->
cbp_bôs
[0] |((
öt64
Ë0x01 << 
bô
);

1510 
bô
 = (
y_dc
 ? 0 : 
y_ac
 ? 1 : 
u_dc
 ? 17 : 
v_dc
 ? 18 : 
u_ac
 ? 19 : 35);

1512 i‡(
p_Vid
->
íc_pi˘uª
->
chroma_f‹m©_idc
!=
YUV444
)

1514 i‡(
ty≥
!=
LUMA_8x8
)

1516 i‡(
block_b
.
avaûabÀ
)

1518 if(
mb_d©a
[
block_b
.
mb_addr
].
mb_ty≥
==
IPCM
)

1519 
uµî_bô
 = 1;

1521 
uµî_bô
 = 
	`gë_bô
(
mb_d©a
[
block_b
.
mb_addr
].
cbp_bôs
[0],
bô
+
bô_pos_b
);

1525 i‡(
block_a
.
avaûabÀ
)

1527 if(
mb_d©a
[
block_a
.
mb_addr
].
mb_ty≥
 =
IPCM
)

1528 
À·_bô
 = 1;

1530 
À·_bô
 = 
	`gë_bô
(
mb_d©a
[
block_a
.
mb_addr
].
cbp_bôs
[0], 
bô
 + 
bô_pos_a
);

1533 
˘x
 = (
uµî_bô
 << 1Ë+ 
À·_bô
;

1536 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 
cbp_bô
, 
ãx_˘x
->
bcbp_c⁄ãxts
[
ty≥2˘x_bcbp
[
ty≥
]] + 
˘x
);

1539 if–(
cuºMB
->
p_I≈
->
£∑øã_cﬁour_∂™e_Êag
 != 0) )

1541 i‡(
ty≥
!=
LUMA_8x8
)

1543 i‡(
block_b
.
avaûabÀ
)

1545 if(
mb_d©a
[
block_b
.
mb_addr
].
mb_ty≥
==
IPCM
)

1546 
uµî_bô
 = 1;

1548 
uµî_bô
 = 
	`gë_bô
(
mb_d©a
[
block_b
.
mb_addr
].
cbp_bôs
[0],
bô
+
bô_pos_b
);

1552 i‡(
block_a
.
avaûabÀ
)

1554 if(
mb_d©a
[
block_a
.
mb_addr
].
mb_ty≥
 =
IPCM
)

1555 
À·_bô
 = 1;

1557 
À·_bô
 = 
	`gë_bô
(
mb_d©a
[
block_a
.
mb_addr
].
cbp_bôs
[0], 
bô
 + 
bô_pos_a
);

1560 
˘x
 = (
uµî_bô
 << 1Ë+ 
À·_bô
;

1563 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 
cbp_bô
, 
ãx_˘x
->
bcbp_c⁄ãxts
[
ty≥2˘x_bcbp
[
ty≥
]] + 
˘x
);

1568 i‡(
block_b
.
avaûabÀ
)

1570 if((
ty≥
==
LUMA_8x8
 ||Åy≥==
CB_8x8
 ||Åy≥==
CR_8x8
) &&

1571 !
mb_d©a
[
block_b
.
mb_addr
].
luma_å™sf‹m_size_8x8_Êag
)

1573 if(
mb_d©a
[
block_b
.
mb_addr
].
mb_ty≥
 =
IPCM
)

1574 
uµî_bô
=1;

1577 if(
ty≥
==
LUMA_8x8
)

1578 
uµî_bô
 = 
	`gë_bô
(
mb_d©a
[
block_b
.
mb_addr
].
cbp_bôs_8x8
[0], 
bô
 + 
bô_pos_b
);

1579 i‡(
ty≥
==
CB_8x8
)

1580 
uµî_bô
 = 
	`gë_bô
(
mb_d©a
[
block_b
.
mb_addr
].
cbp_bôs_8x8
[1], 
bô
 + 
bô_pos_b
);

1581 i‡(
ty≥
==
CR_8x8
)

1582 
uµî_bô
 = 
	`gë_bô
(
mb_d©a
[
block_b
.
mb_addr
].
cbp_bôs_8x8
[2], 
bô
 + 
bô_pos_b
);

1583 i‡((
ty≥
==
CB_4x4
)||—y≥==
CB_4x8
)||—y≥==
CB_8x4
)||—y≥==
CB_16AC
)||—y≥==
CB_16DC
))

1584 
uµî_bô
 = 
	`gë_bô
(
mb_d©a
[
block_b
.
mb_addr
].
cbp_bôs
[1], 
bô
 + 
bô_pos_b
);

1585 i‡((
ty≥
==
CR_4x4
)||—y≥==
CR_4x8
)||—y≥==
CR_8x4
)||—y≥==
CR_16AC
)||—y≥==
CR_16DC
))

1586 
uµî_bô
 = 
	`gë_bô
(
mb_d©a
[
block_b
.
mb_addr
].
cbp_bôs
[2], 
bô
 + 
bô_pos_b
);

1588 
uµî_bô
 = 
	`gë_bô
(
mb_d©a
[
block_b
.
mb_addr
].
cbp_bôs
[0], 
bô
 + 
bô_pos_b
);

1592 i‡(
block_a
.
avaûabÀ
)

1594 if((
ty≥
==
LUMA_8x8
 ||Åy≥==
CB_8x8
 ||Åy≥==
CR_8x8
) &&

1595 !
mb_d©a
[
block_a
.
mb_addr
].
luma_å™sf‹m_size_8x8_Êag
)

1597 if(
mb_d©a
[
block_a
.
mb_addr
].
mb_ty≥
==
IPCM
)

1598 
À·_bô
 = 1;

1601 if(
ty≥
==
LUMA_8x8
)

1602 
À·_bô
 = 
	`gë_bô
(
mb_d©a
[
block_a
.
mb_addr
].
cbp_bôs_8x8
[0],
bô
 + 
bô_pos_a
);

1603 i‡(
ty≥
==
CB_8x8
)

1604 
À·_bô
 = 
	`gë_bô
(
mb_d©a
[
block_a
.
mb_addr
].
cbp_bôs_8x8
[1],
bô
 + 
bô_pos_a
);

1605 i‡(
ty≥
==
CR_8x8
)

1606 
À·_bô
 = 
	`gë_bô
(
mb_d©a
[
block_a
.
mb_addr
].
cbp_bôs_8x8
[2],
bô
 + 
bô_pos_a
);

1607 i‡((
ty≥
==
CB_4x4
)||—y≥==
CB_4x8
)||—y≥==
CB_8x4
)||—y≥==
CB_16AC
)||—y≥==
CB_16DC
))

1608 
À·_bô
 = 
	`gë_bô
(
mb_d©a
[
block_a
.
mb_addr
].
cbp_bôs
[1],
bô
 + 
bô_pos_a
);

1609 i‡((
ty≥
==
CR_4x4
)||—y≥==
CR_4x8
)||—y≥==
CR_8x4
)||—y≥==
CR_16AC
)||—y≥==
CR_16DC
))

1610 
À·_bô
 = 
	`gë_bô
(
mb_d©a
[
block_a
.
mb_addr
].
cbp_bôs
[2],
bô
 + 
bô_pos_a
);

1612 
À·_bô
 = 
	`gë_bô
(
mb_d©a
[
block_a
.
mb_addr
].
cbp_bôs
[0],
bô
 + 
bô_pos_a
);

1616 
˘x
 = 2*
uµî_bô
+
À·_bô
;

1619 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 
cbp_bô
, 
ãx_˘x
->
bcbp_c⁄ãxts
[
ty≥2˘x_bcbp
[
ty≥
]]+
˘x
);

1621 
	}
}

1630 
	$wrôe_™d_°‹e_CBP_block_bô
 (
Ma¸oblock
* 
cuºMB
, 
EncodögEnvú⁄mítPå
 
ìp_dp
, 
ty≥
, 
cbp_bô
, 
TextuªInfoC⁄ãxts
* 
ãx_˘x
)

1632 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1633 
Ma¸oblock
 *
mb_d©a
 = 
p_Vid
->mb_data;

1634 
y_ac
 = (
ty≥
==
LUMA_16AC
 ||Åy≥==
LUMA_8x8
 ||Åy≥==
LUMA_8x4
 ||Åy≥==
LUMA_4x8
 ||Åy≥==
LUMA_4x4
);

1635 
y_dc
 = (
ty≥
==
LUMA_16DC
);

1636 
u_ac
 = (
ty≥
==
CHROMA_AC
 && !
p_Vid
->
is_v_block
);

1637 
v_ac
 = (
ty≥
==
CHROMA_AC
 && 
p_Vid
->
is_v_block
);

1638 
chroma_dc
 = (
ty≥
==
CHROMA_DC
 ||Åy≥==
CHROMA_DC_2x4
 ||Åy≥==
CHROMA_DC_4x4
);

1639 
u_dc
 = (
chroma_dc
 && !
p_Vid
->
is_v_block
);

1640 
v_dc
 = (
chroma_dc
 && 
p_Vid
->
is_v_block
);

1641 
j
 = (
y_ac
 || 
u_ac
 || 
v_ac
 ? 
cuºMB
->
subblock_y
 : 0);

1642 
i
 = (
y_ac
 || 
u_ac
 || 
v_ac
 ? 
cuºMB
->
subblock_x
 : 0);

1643 
bô
 = (
y_dc
 ? 0 : 
y_ac
 ? 1 : 
u_dc
 ? 17 : 
v_dc
 ? 18 : 
u_ac
 ? 19 : 23);

1644 
deÁu…_bô
 = (
cuºMB
->
is_öåa_block
 ? 1 : 0);

1645 
uµî_bô
 = 
deÁu…_bô
;

1646 
À·_bô
 = 
deÁu…_bô
;

1647 
˘x
;

1649 
bô_pos_a
 = 0;

1650 
bô_pos_b
 = 0;

1652 
PixñPos
 
block_a
, 
block_b
;

1654 i‡(
y_ac
 || 
y_dc
)

1656 
	`gë4x4Neighbour
(
cuºMB
, 
i
 - 1, 
j
 , 
p_Vid
->
mb_size
[
IS_LUMA
], &
block_a
);

1657 
	`gë4x4Neighbour
(
cuºMB
, 
i
, 
j
 -1, 
p_Vid
->
mb_size
[
IS_LUMA
], &
block_b
);

1658 i‡(
y_ac
)

1660 i‡(
block_a
.
avaûabÀ
)

1661 
bô_pos_a
 = 4*
block_a
.
y
 + block_a.
x
;

1662 i‡(
block_b
.
avaûabÀ
)

1663 
bô_pos_b
 = 4*
block_b
.
y
 + block_b.
x
;

1668 
	`gë4x4Neighbour
(
cuºMB
, 
i
 - 1, 
j
 , 
p_Vid
->
mb_size
[
IS_CHROMA
], &
block_a
);

1669 
	`gë4x4Neighbour
(
cuºMB
, 
i
, 
j
 - 1, 
p_Vid
->
mb_size
[
IS_CHROMA
], &
block_b
);

1670 i‡(
u_ac
||
v_ac
)

1672 i‡(
block_a
.
avaûabÀ
)

1673 
bô_pos_a
 = (
block_a
.
y
 << 2Ë+ block_a.
x
;

1674 i‡(
block_b
.
avaûabÀ
)

1675 
bô_pos_b
 = (
block_b
.
y
 << 2Ë+ block_b.
x
;

1679 
bô
 = (
y_dc
 ? 0 : 
y_ac
 ? 1 + 
j
 + (
i
 >> 2): 
u_dc
 ? 17 : 
v_dc
 ? 18 : 
u_ac
 ? 19 + j + (i >> 2): 35 + j + (i >> 2));

1681 i‡(
cbp_bô
)

1683 i‡(
ty≥
==
LUMA_8x8
)

1685 
cuºMB
->
cbp_bôs
[0] |((
öt64
Ë0x33 << 
bô
);

1687 i‡(
ty≥
==
LUMA_8x4
)

1689 
cuºMB
->
cbp_bôs
[0] |((
öt64
Ë0x03 << 
bô
);

1691 i‡(
ty≥
==
LUMA_4x8
)

1693 
cuºMB
->
cbp_bôs
[0] |((
öt64
Ë0x11 << 
bô
);

1697 
cuºMB
->
cbp_bôs
[0] |((
öt64
Ë0x01 << 
bô
);

1701 
bô
 = (
y_dc
 ? 0 : 
y_ac
 ? 1 : 
u_dc
 ? 17 : 
v_dc
 ? 18 : 
u_ac
 ? 19 : 35);

1703 i‡(
ty≥
!=
LUMA_8x8
)

1705 i‡(
block_b
.
avaûabÀ
)

1707 if(
mb_d©a
[
block_b
.
mb_addr
].
mb_ty≥
==
IPCM
)

1708 
uµî_bô
 = 1;

1710 
uµî_bô
 = 
	`gë_bô
(
mb_d©a
[
block_b
.
mb_addr
].
cbp_bôs
[0],
bô
+
bô_pos_b
);

1714 i‡(
block_a
.
avaûabÀ
)

1716 if(
mb_d©a
[
block_a
.
mb_addr
].
mb_ty≥
 =
IPCM
)

1717 
À·_bô
 = 1;

1719 
À·_bô
 = 
	`gë_bô
(
mb_d©a
[
block_a
.
mb_addr
].
cbp_bôs
[0], 
bô
 + 
bô_pos_a
);

1722 
˘x
 = (
uµî_bô
 << 1Ë+ 
À·_bô
;

1725 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 
cbp_bô
, 
ãx_˘x
->
bcbp_c⁄ãxts
[
ty≥2˘x_bcbp
[
ty≥
]] + 
˘x
);

1727 
	}
}

1735 
	$wrôe_signifiˇn˚_m≠
 (
Ma¸oblock
* 
cuºMB
, 
EncodögEnvú⁄mítPå
 
ìp_dp
, 
ty≥
, 
c€ff
[], 
c€ff_˘r
, 
TextuªInfoC⁄ãxts
* 
ãx_˘x
)

1737 
k
;

1738 
sig
, 
œ°
;

1739 
k0
 = 0;

1740 
k1
 = 
maxpos
[
ty≥
];

1742 #i‡
ENABLE_FIELD_CTX


1743 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1744 
Êd
 = ( 
p_Vid
->
°ru˘uª
!=
FRAME
 || 
cuºMB
->
mb_fõld
 );

1746 
Êd
 = 0;

1748 
BiC⁄ãxtTy≥På
 
m≠_˘x
 = 
ãx_˘x
->
m≠_c⁄ãxts
 [
Êd
][
ty≥2˘x_m≠
 [
ty≥
]];

1749 
BiC⁄ãxtTy≥På
 
œ°_˘x
 = 
ãx_˘x
->
œ°_c⁄ãxts
[
Êd
][
ty≥2˘x_œ°
[
ty≥
]];

1750 c⁄° 
byã
 *
pos2˘xm≠
 = 
Êd
 ? 
pos2˘x_m≠_öt
 [
ty≥
] : 
pos2˘x_m≠
 [type];

1751 c⁄° 
byã
 *
pos2˘xœ°
 = 
pos2˘x_œ°
[
ty≥
];

1753 i‡(!
c1isdc
[
ty≥
])

1755 ++
k0
;

1756 ++
k1
;

1757 --
c€ff
;

1760 
k
=
k0
; k<
k1
; ++k)

1762 
sig
 = (
c€ff
[
k
] != 0);

1763 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 
sig
, 
m≠_˘x
 + 
pos2˘xm≠
[
k
]);

1764 i‡(
sig
)

1766 
œ°
 = (--
c€ff_˘r
 == 0);

1768 
	`büri_ícode_symbﬁ
(
ìp_dp
, 
œ°
, 
œ°_˘x
 + 
pos2˘xœ°
[
k
]);

1769 i‡(
œ°
)

1773 
	}
}

1782 
	$wrôe_signifiˇ¡_c€fficõ¡s
 (
EncodögEnvú⁄mítPå
 
ìp_dp
, 
ty≥
, 
c€ff
[], 
TextuªInfoC⁄ãxts
* 
ãx_˘x
, 
c€ff_˙t
)

1784 
BiC⁄ãxtTy≥
 *
⁄e_c⁄ãxts
 = 
ãx_˘x
->⁄e_c⁄ãxts[
ty≥2˘x_⁄e
[
ty≥
]];

1785 
BiC⁄ãxtTy≥
 *
abs_c⁄ãxts
 = 
ãx_˘x
->abs_c⁄ãxts[
ty≥2˘x_abs
[
ty≥
]];

1786 
absLevñ
;

1787 
˘x
;

1788 
sign
;

1789 
gª©î_⁄e
;

1790 
c1
 = 1;

1791 
c2
 = 0;

1792 
i
;

1794 
i
=
maxpos
[
ty≥
]; (i>=0Ë&& (
c€ff_˙t
); i--)

1796 i‡(
c€ff
[
i
]!=0)

1798 
c€ff_˙t
--;

1800 i‡(
c€ff
[
i
] > 0)

1802 
absLevñ
 = 
c€ff
[
i
];

1803 
sign
 = 0;

1807 
absLevñ
 = -
c€ff
[
i
];

1808 
sign
 = 1;

1811 
gª©î_⁄e
 = (
absLevñ
 > 1);

1814 
˘x
 = 
	`imö
(
c1
, 4);

1815 
	`büri_ícode_symbﬁ
 (
ìp_dp
, 
gª©î_⁄e
, 
⁄e_c⁄ãxts
 + 
˘x
);

1817 i‡(
gª©î_⁄e
)

1819 
˘x
 = 
	`imö
(
c2
++, 
max_c2
[
ty≥
]);

1820 
	`u«ry_exp_gﬁomb_Àvñ_ícode
(
ìp_dp
, 
absLevñ
 - 2, 
abs_c⁄ãxts
 + 
˘x
);

1821 
c1
 = 0;

1823 i‡(
c1
)

1825 
c1
++;

1827 
	`büri_ícode_symbﬁ_eq_¥ob
 (
ìp_dp
, 
sign
);

1830 
	}
}

1840 
	$wrôeRunLevñ_CABAC
 (
Ma¸oblock
* 
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
)

1842 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1843 
EncodögEnvú⁄mítPå
 
ìp_dp
 = &(
dp
->
ì_ˇbac
);

1844 
cuº_Àn
 = 
	`¨õnco_bôs_wrôãn
(
ìp_dp
);

1847 i‡(
£
->
vÆue1
 != 0)

1849 
cuºSli˚
->
pos
 +
£
->
vÆue2
;

1850 
cuºSli˚
->
c€ff
[cuºSli˚->
pos
++] = 
£
->
vÆue1
;

1851 ++
cuºSli˚
->
c€ff_˘r
;

1855 
TextuªInfoC⁄ãxts
 *
ãx_˘x
 = 
cuºSli˚
->tex_ctx;

1857 i‡(
cuºSli˚
->
c€ff_˘r
 > 0)

1859 
cuºSli˚
->
	`wrôe_™d_°‹e_CBP_block_bô
 (
cuºMB
, 
ìp_dp
, 
£
->
c⁄ãxt
, 1, 
ãx_˘x
);

1861 
	`wrôe_signifiˇn˚_m≠
 (
cuºMB
, 
ìp_dp
, 
£
->
c⁄ãxt
, 
cuºSli˚
->
c€ff
, cuºSli˚->
c€ff_˘r
, 
ãx_˘x
);

1863 
	`wrôe_signifiˇ¡_c€fficõ¡s
 (
ìp_dp
, 
£
->
c⁄ãxt
, 
cuºSli˚
->
c€ff
, 
ãx_˘x
, cuºSli˚->
c€ff_˘r
);

1865 
	`mem£t
(
cuºSli˚
->
c€ff
, 0 , 64 * ());

1868 
cuºSli˚
->
	`wrôe_™d_°‹e_CBP_block_bô
 (
cuºMB
, 
ìp_dp
, 
£
->
c⁄ãxt
, 0, 
ãx_˘x
);

1871 
cuºSli˚
->
pos
 = cuºSli˚->
c€ff_˘r
 = 0;

1874 
dp
->
bô°ªam
->
wrôe_Êag
 = 1;

1875 
£
->
Àn
 = (
	`¨õnco_bôs_wrôãn
(
ìp_dp
Ë- 
cuº_Àn
);

1876 
CABAC_TRACE
;

1877 
	}
}

	@lencod/src/cconv_yuv2rgb.c

14 
	~"c⁄åibut‹s.h
"

15 
	~"globÆ.h
"

16 
	~"memÆloc.h
"

17 
	~"img_di°‹ti⁄.h
"

19 
	#YUV2RGB_YOFFSET


	)

22 #ifde‡
YUV2RGB_YOFFSET


23 
	#OFFSET_Y
 16

	)

24 c⁄° 
	gK0
 = 1.164f;

25 c⁄° 
	gK1
 = 1.596f;

26 c⁄° 
	gK2
 = 0.391f;

27 c⁄° 
	gK3
 = 0.813f;

28 c⁄° 
	gK4
 = 2.018f;

30 c⁄° 
	gK0
 = 1.000f;

31 c⁄° 
	gK1
 = 1.402f;

32 c⁄° 
	gK2
 = 0.34414f;

33 c⁄° 
	gK3
 = 0.71414f;

34 c⁄° 
	gK4
 = 1.772f;

37 
	$¸óã_RGB_mem‹y
(
VideoP¨amëîs
 *
p_Vid
)

39 
mem‹y_size
 = 0;

40 
j
;

41  
j
 = 0; j < 3; j++ )

43 
mem‹y_size
 +
	`gë_mem2D≥l
 (&
p_Vid
->
imgRGB_§c
.
d©a
[
j
],Ö_Vid->
height
,Ö_Vid->
width
);

45  
j
 = 0; j < 3; j++ )

47 
mem‹y_size
 +
	`gë_mem2D≥l
 (&
p_Vid
->
imgRGB_ªf
.
d©a
[
j
],Ö_Vid->
height
,Ö_Vid->
width
);

50  
mem‹y_size
;

51 
	}
}

53 
	$dñëe_RGB_mem‹y
(
VideoP¨amëîs
 *
p_Vid
)

55 
i
;

56  
i
 = 0; i < 3; i++ )

58 
	`‰ì_mem2D≥l
(
p_Vid
->
imgRGB_§c
.
d©a
[
i
]);

60  
i
 = 0; i < 3; i++ )

62 
	`‰ì_mem2D≥l
(
p_Vid
->
imgRGB_ªf
.
d©a
[
i
]);

64 
	}
}

66 
	$öô_YUVtoRGB
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

68 
c⁄v_sˇÀ
 = () (65536.0f);

70 
p_Vid
->
wka0
 = 
	`Êﬂt2öt
–
c⁄v_sˇÀ
 * 
K0
);

71 
p_Vid
->
wka1
 = 
	`Êﬂt2öt
–
c⁄v_sˇÀ
 * 
K1
);

72 
p_Vid
->
wka2
 = 
	`Êﬂt2öt
–-
c⁄v_sˇÀ
 * 
K2
);

73 
p_Vid
->
wka3
 = 
	`Êﬂt2öt
–-
c⁄v_sˇÀ
 * 
K3
);

74 
p_Vid
->
wka4
 = 
	`Êﬂt2öt
–
c⁄v_sˇÀ
 * 
K4
);

76 #ifde‡
YUV2RGB_YOFFSET


77 
p_Vid
->
off£t_y
 = 
OFFSET_Y
 << (
p_I≈
->
ouçut
.
bô_dïth
[0] - 8);

78 
p_Vid
->
off£t_¸
 = 1 << (
p_I≈
->
ouçut
.
bô_dïth
[0] - 1);

80 
	}
}

91 
	$YUVtoRGB
(
VideoP¨amëîs
 *
p_Vid
, 
ImageSåu˘uª
 *
YUV
, ImageSåu˘uª *
RGB
)

93 
i
, 
j
, 
j_¸
, 
i_¸
;

94 
sy
, 
su
, 
sv
;

95 
wbuv
, 
wguv
, 
wruv
;

96 
img≥l
 *
Y
, *
U
, *
V
, *
R
, *
G
, *
B
;

97 
FømeF‹m©
 
f‹m©
 = 
YUV
->format;

98 
width
 = 
f‹m©
.width[0];

99 
height
 = 
f‹m©
.height[0];

100 
max_vÆue
 = 
f‹m©
.max_value[0];

103 
j
 = 0; j < 
height
; j++)

105 
j_¸
 = 
j
 >> 
p_Vid
->
shi·_¸_y
;

106 
Y
 = 
YUV
->
d©a
[0][
j
];

107 
U
 = 
YUV
->
d©a
[1][
j_¸
];

108 
V
 = 
YUV
->
d©a
[2][
j_¸
];

109 
R
 = 
RGB
->
d©a
[0][
j
];

110 
G
 = 
RGB
->
d©a
[1][
j
];

111 
B
 = 
RGB
->
d©a
[2][
j
];

113 
i
 = 0; i < 
width
; i++)

115 
i_¸
 = 
i
 >> 
p_Vid
->
shi·_¸_x
;

117 
su
 = 
U
[
i_¸
] - 
p_Vid
->
off£t_¸
;

118 
sv
 = 
V
[
i_¸
] - 
p_Vid
->
off£t_¸
;

120 
wruv
 = 
p_Vid
->
wka1
 * 
sv
;

121 
wguv
 = 
p_Vid
->
wka2
 * 
su
 +Ö_Vid->
wka3
 * 
sv
;

122 
wbuv
 = 
p_Vid
->
wka4
 * 
su
;

124 #ifde‡
YUV2RGB_YOFFSET


125 
sy
 = 
p_Vid
->
wka0
 * (
Y
[
i
] -Ö_Vid->
off£t_y
);

127 
sy
 = 
p_Vid
->
wka0
 * 
Y
[
i
];

130 
R
[
i
] = (
img≥l
Ë
	`iClù1
–
max_vÆue
, 
	`rshi·_∫d
(
sy
 + 
wruv
, 16));

131 
G
[
i
] = (
img≥l
Ë
	`iClù1
–
max_vÆue
, 
	`rshi·_∫d
(
sy
 + 
wguv
, 16));

132 
B
[
i
] = (
img≥l
Ë
	`iClù1
–
max_vÆue
, 
	`rshi·_∫d
(
sy
 + 
wbuv
, 16));

136 
RGB
->
f‹m©
 = format;

137 
RGB
->
f‹m©
.
yuv_f‹m©
 = 
YUV444
;

138 
RGB
->
f‹m©
.
cﬁ‹_modñ
 = 
CM_RGB
;

139 
RGB
->
f‹m©
.
pixñ_f‹m©
 = 
BGR
;

140 
RGB
->
f‹m©
.
height
[1] = format.height[0];

141 
RGB
->
f‹m©
.
width
[1] = format.width[0];

142 
i
 = 1; i < 3; i++)

144 
RGB
->
f‹m©
.
size_cmp
[
i
] = format.size_cmp[0];

145 
RGB
->
f‹m©
.
bô_dïth
[
i
] = format.bit_depth[0];

146 
RGB
->
f‹m©
.
max_vÆue
[
i
] = max_value;

147 
RGB
->
f‹m©
.
max_vÆue_sq
[
i
] = format.max_value_sq[0];

149 
	}
}

	@lencod/src/configfile.c

59 
	#INCLUDED_BY_CONFIGFILE_C


	)

61 
	~<sys/°©.h
>

63 
	~"globÆ.h
"

64 
	~"c⁄fig_comm⁄.h
"

65 
	~"c⁄figfûe.h
"

66 
	~"fmo.h
"

67 
	~"c⁄f‹m™˚.h
"

68 
	~"mc_¥edi˘i⁄.h
"

69 
	~"mv_£¨ch.h
"

70 
	~"img_io.h
"

71 
	~"øã˘l.h
"

73 
P©chI≈
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
);

74 
Te°EncodîP¨ams
 (
M≠pög
 *
M≠
, 
bôdïth_qp_sˇÀ
[3]);

75 
Di•œyEncodîP¨ams
 (
M≠pög
 *
M≠
);

77 c⁄° 
	gmb_width_¸
[4] = {0,8, 8,16};

78 c⁄° 
	gmb_height_¸
[4]= {0,8,16,16};

80 
	#MAX_ITEMS_TO_PARSE
 10000

	)

82 
	~"£i.h
"

83 
SëVUISˇÀAndTicks
(
I≈utP¨amëîs
 *
p_I≈
, 
‰ame_øã
);

92 
	$£t_jm_vui_∑øms
–
I≈utP¨amëîs
 *
p_I≈
 )

94 
	`SëVUISˇÀAndTicks
(
p_I≈
, 1.25 *Ö_I≈->
ouçut
.
‰ame_øã
);

96 
p_I≈
->
E«bÀVUISuµ‹t
 = 1;

98 
p_I≈
->
VUI
.
«l_hrd_∑ømëîs_¥e£¡_Êag
 = 0;

99 
p_I≈
->
VUI
.
v˛_hrd_∑ømëîs_¥e£¡_Êag
 = 0;

100 
p_I≈
->
VUI
.
timög_öfo_¥e£¡_Êag
 = 1;

101 
p_I≈
->
VUI
.
pic_°ru˘_¥e£¡_Êag
 = 1;

102 
p_I≈
->
VUI
.
fixed_‰ame_øã_Êag
 = 1;

103 
	}
}

111 
	$JMHñpExô
 ()

113 
	`Ârötf
–
°dîr
, "\nÜencod [-h] [-d defenc.cfg] {[-f curenc1.cfg]...[-f curencN.cfg]}"

148 
	`exô
(-1);

149 
	}
}

158 
öt64
 
	$gëVideoFûeSize
(
video_fûe
)

160 
öt64
 
fsize
;

162 
	`l£ek
(
video_fûe
, 0, 
SEEK_END
);

163 
fsize
 = 
	`ãŒ
((Ë
video_fûe
);

164 
	`l£ek
(
video_fûe
, 0, 
SEEK_SET
);

166  
fsize
;

167 
	}
}

176 
	$gë_numbî_of_‰ames
 (
I≈utP¨amëîs
 *
p_I≈
, 
VideoD©aFûe
 *
öput_fûe
)

178 
öt64
 
fsize
 = 
	`gëVideoFûeSize
(
öput_fûe
->
f_num
);

180 
öt64
 
isize
 = (öt64Ë
p_I≈
->
sour˚
.
size
;

181 
maxBôDïth
 = 
	`imax
(
p_I≈
->
sour˚
.
bô_dïth
[0],Ö_Inp->source.bit_depth[1]);

183 
isize
 <<(
maxBôDïth
 > 8)? 1: 0;

184 
p_I≈
->
no_‰ames
 = (Ë(((
fsize
 -Ö_I≈->
öfûe_hódî
)/ 
isize
Ë-Ö_I≈->
°¨t_‰ame
);

185 
	}
}

194 
	$upd©eMaxVÆue
(
FømeF‹m©
 *
f‹m©
)

196 
f‹m©
->
max_vÆue
[0] = (1 << f‹m©->
bô_dïth
[0]) - 1;

197 
f‹m©
->
max_vÆue_sq
[0] = f‹m©->
max_vÆue
[0] * format->max_value[0];

198 
f‹m©
->
max_vÆue
[1] = (1 << f‹m©->
bô_dïth
[1]) - 1;

199 
f‹m©
->
max_vÆue_sq
[1] = f‹m©->
max_vÆue
[1] * format->max_value[1];

200 
f‹m©
->
max_vÆue
[2] = (1 << f‹m©->
bô_dïth
[2]) - 1;

201 
f‹m©
->
max_vÆue_sq
[2] = f‹m©->
max_vÆue
[2] * format->max_value[2];

202 
	}
}

211 
	$upd©eOutF‹m©
(
I≈utP¨amëîs
 *
p_I≈
)

213 
FømeF‹m©
 *
ouçut
 = &
p_I≈
->output;

214 
FømeF‹m©
 *
sour˚
 = &
p_I≈
->source;

215 
ouçut
->
yuv_f‹m©
 = (
Cﬁ‹F‹m©
Ë
p_I≈
->yuv_format;

216 
sour˚
->
yuv_f‹m©
 = (
Cﬁ‹F‹m©
Ë
p_I≈
->yuv_format;

218 i‡(
p_I≈
->
§c_ªsize
 == 0)

220 
ouçut
->
width
[0] = 
sour˚
->width[0];

221 
ouçut
->
height
[0] = 
sour˚
->height[0];

224 i‡(
p_I≈
->
yuv_f‹m©
 =
YUV400
)

226 
sour˚
->
bô_dïth
[1] = 8;

227 
ouçut
->
bô_dïth
[1] = 8;

228 
sour˚
->
width
[1] = 0;

229 
sour˚
->
width
[2] = 0;

230 
sour˚
->
height
[1] = 0;

231 
sour˚
->
height
[2] = 0;

232 
ouçut
->
width
[1] = 0;

233 
ouçut
->
width
[2] = 0;

234 
ouçut
->
height
[1] = 0;

235 
ouçut
->
height
[2] = 0;

239 
sour˚
->
width
[1] = (sour˚->width[0] * 
mb_width_¸
 [
ouçut
->
yuv_f‹m©
]) >> 4;

240 
sour˚
->
width
[2] = source->width[1];

241 
sour˚
->
height
[1] = (sour˚->height[0] * 
mb_height_¸
[
ouçut
->
yuv_f‹m©
]) >> 4;

242 
sour˚
->
height
[2] = source->height[1];

243 
ouçut
->
width
[1] = (ouçut->width[0] * 
mb_width_¸
 [ouçut->
yuv_f‹m©
]) >> 4;

244 
ouçut
->
width
[2] = output->width[1];

245 
ouçut
->
height
[1] = (ouçut->height[0] * 
mb_height_¸
[ouçut->
yuv_f‹m©
]) >> 4;

246 
ouçut
->
height
[2] = output->height[1];

250 
sour˚
->
size_cmp
[0] = sour˚->
width
[0] * sour˚->
height
[0];

251 
sour˚
->
size_cmp
[1] = sour˚->
width
[1] * sour˚->
height
[1];

252 
sour˚
->
size_cmp
[2] = source->size_cmp[1];

253 
sour˚
->
size
 = sour˚->
size_cmp
[0] + source->size_cmp[1] + source->size_cmp[2];

254 
sour˚
->
mb_width
 = sour˚->
width
[0] / 
MB_BLOCK_SIZE
;

255 
sour˚
->
mb_height
 = sour˚->
height
[0] / 
MB_BLOCK_SIZE
;

256 
sour˚
->
pic_unô_size_⁄_disk
 = (
	`imax
(sour˚->
bô_dïth
[0], source->bit_depth[1]) > 8) ? 16 : 8;

257 
sour˚
->
pic_unô_size_shi·3
 = sour˚->
pic_unô_size_⁄_disk
 >> 3;

261 
ouçut
->
size_cmp
[0] = ouçut->
width
[0] * ouçut->
height
[0];

262 
ouçut
->
size_cmp
[1] = ouçut->
width
[1] * ouçut->
height
[1];

263 
ouçut
->
size_cmp
[2] = output->size_cmp[1];

264 
ouçut
->
size
 = ouçut->
size_cmp
[0] + output->size_cmp[1] + output->size_cmp[2];

265 
ouçut
->
mb_width
 = ouçut->
width
[0] / 
MB_BLOCK_SIZE
;

266 
ouçut
->
mb_height
 = ouçut->
height
[0] / 
MB_BLOCK_SIZE
;

270 
sour˚
->
bô_dïth
[2] = source->bit_depth[1];

271 
ouçut
->
bô_dïth
[2] = output->bit_depth[1];

274 i‡(
p_I≈
->
§c_BôDïthResˇÀ
 == 0)

276 
ouçut
->
bô_dïth
[0] = 
sour˚
->bit_depth[0];

277 
ouçut
->
bô_dïth
[1] = 
sour˚
->bit_depth[1];

278 
ouçut
->
bô_dïth
[2] = 
sour˚
->bit_depth[2];

280 
ouçut
->
pic_unô_size_⁄_disk
 = (
	`imax
(ouçut->
bô_dïth
[0], output->bit_depth[1]) > 8) ? 16 : 8;

281 
ouçut
->
pic_unô_size_shi·3
 = ouçut->
pic_unô_size_⁄_disk
 >> 3;

283 i‡(
p_I≈
->
íabÀ_32_puŒdown
)

285 
sour˚
->
‰ame_øã
 = source->frame_rate * 5 / 4;

286 
p_I≈
->
idr_≥riod
 =Ö_Inp->idr_period * 5 / 4;

287 
p_I≈
->
öåa_≥riod
 =Ö_Inp->intra_period * 5 / 4;

288 
p_I≈
->
no_‰ames
 =Ö_Inp->no_frames * 5 / 4;

291 
ouçut
->
‰ame_øã
 = 
sour˚
->‰ame_øã / (
p_I≈
->
‰ame_skù
 + 1);

292 
ouçut
->
cﬁ‹_modñ
 = 
sour˚
->color_model;

293 
ouçut
->
pixñ_f‹m©
 = 
sour˚
->pixel_format;

295 
	`upd©eMaxVÆue
(
sour˚
);

296 
	`upd©eMaxVÆue
(
ouçut
);

297 
	}
}

314 
	$C⁄figuª
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
ac
, *
av
[])

316 *
c⁄ã¡
 = 
NULL
;

317 
CLcou¡
, 
C⁄ã¡Lí
, 
NumbîP¨ams
;

318 *
fûíame
=
DEFAULTCONFIGFILENAME
;

320 i‡(
ac
==2)

322 i‡(0 =
	`°∫cmp
 (
av
[1], "-v", 2))

324 
	`¥ötf
("JM-" 
VERSION
 "\n");

325 
	`exô
(0);

327 i‡(0 =
	`°∫cmp
 (
av
[1], "-V", 2))

329 
	`¥ötf
("JM " 
JM
 ": compûed " 
__DATE__
 " " 
__TIME__
 "\n");

330 #i‡–
IMGTYPE
 == 0 )

331 
	`¥ötf
("support for moreÅhan 8 bits/pel disabled\n");

333 #i‡–
ENABLE_FIELD_CTX
 == 0 )

334 
	`¥ötf
("CABAC field coding disabled\n");

336 #i‡–
ENABLE_HIGH444_CTX
 == 0 )

337 
	`¥ötf
("CABAC High 4:4:4Örofile coding disabled\n");

339 
	`exô
(0);

342 i‡(0 =
	`°∫cmp
 (
av
[1], "-h", 2))

344 
	`JMHñpExô
();

348 
	`mem£t
 (&
cfg∑øms
, 0,  (
I≈utP¨amëîs
));

350 
	`¥ötf
 ("Setting Default Parameters...\n");

351 
	`InôP¨ams
(
M≠
);

354 
CLcou¡
 = 1;

356 i‡(
ac
>=3)

358 i‡(0 =
	`°∫cmp
 (
av
[1], "-d", 2))

360 
fûíame
=
av
[2];

361 
CLcou¡
 = 3;

363 i‡(0 =
	`°∫cmp
 (
av
[1], "-h", 2))

365 
	`JMHñpExô
();

368 
	`¥ötf
 ("P¨sög C⁄figfûê%s", 
fûíame
);

369 
c⁄ã¡
 = 
	`GëC⁄figFûeC⁄ã¡
 (
fûíame
);

370 i‡(
NULL
==
c⁄ã¡
)

371 
	`îr‹
 (
îr‹ãxt
, 300);

372 
	`P¨£C⁄ã¡
 (
p_I≈
, 
M≠
, 
c⁄ã¡
, (Ë
	`°æí
(content));

373 
	`¥ötf
 ("\n");

374 
	`‰ì
 (
c⁄ã¡
);

378 
CLcou¡
 < 
ac
)

380 i‡(0 =
	`°∫cmp
 (
av
[
CLcou¡
], "-h", 2))

382 
	`JMHñpExô
();

385 i‡(0 =
	`°∫ˇ£cmp
 (
av
[
CLcou¡
], "-f", 2))

387 
c⁄ã¡
 = 
	`GëC⁄figFûeC⁄ã¡
 (
av
[
CLcou¡
+1]);

388 i‡(
NULL
==
c⁄ã¡
)

389 
	`îr‹
 (
îr‹ãxt
, 300);

390 
	`¥ötf
 ("P¨sög C⁄figfûê%s", 
av
[
CLcou¡
+1]);

391 
	`P¨£C⁄ã¡
 (
p_I≈
, 
M≠
, 
c⁄ã¡
, (Ë
	`°æí
 (content));

392 
	`¥ötf
 ("\n");

393 
	`‰ì
 (
c⁄ã¡
);

394 
CLcou¡
 += 2;

398 i‡(0 =
	`°∫ˇ£cmp
 (
av
[
CLcou¡
], "-p", 2))

403 ++
CLcou¡
;

404 
C⁄ã¡Lí
 = 0;

405 
NumbîP¨ams
 = 
CLcou¡
;

408 
NumbîP¨ams
 < 
ac
 && 
av
[NumberParams][0] != '-')

409 
C⁄ã¡Lí
 +(Ë
	`°æí
 (
av
[
NumbîP¨ams
++]);

410 
C⁄ã¡Lí
 += 1000;

413 i‡((
c⁄ã¡
 = 
	`mÆloc
 (
C⁄ã¡Lí
))==
NULL
Ë
	`no_mem_exô
("Configure: content");;

414 
c⁄ã¡
[0] = '\0';

418 
CLcou¡
 < 
NumbîP¨ams
)

420 *
sour˚
 = &
av
[
CLcou¡
][0];

421 *
de°ö
 = &
c⁄ã¡
[(Ë
	`°æí
 (content)];

423 *
sour˚
 != '\0')

425 i‡(*
sour˚
 == '=')

427 *
de°ö
++=' '; *destin++='='; *destin++=' ';

430 *
de°ö
++=*
sour˚
;

431 
sour˚
++;

433 *
de°ö
 = '\0';

434 
CLcou¡
++;

436 
	`¥ötf
 ("P¨sög comm™dÜöê°rög '%s'", 
c⁄ã¡
);

437 
	`P¨£C⁄ã¡
 (
p_I≈
, 
M≠
, 
c⁄ã¡
, (Ë
	`°æí
(content));

438 
	`‰ì
 (
c⁄ã¡
);

439 
	`¥ötf
 ("\n");

443 
	`¢¥ötf
 (
îr‹ãxt
, 
ET_SIZE
, "Eº‹ i¿comm™dÜöe,á¯%d,áround såög '%s', missög -‡‹ -∞∑ømëîs?", 
CLcou¡
, 
av
[CLcount]);

444 
	`îr‹
 (
îr‹ãxt
, 300);

448 
	`¥ötf
 ("\n");

450 #i‡(
MVC_EXTENSION_ENABLE
)

451 i‡(
p_I≈
->
num_of_võws
 > 1)

453 
	`¥ötf
 ("P¨sög Sec⁄d Võw C⁄figfûê%s", 
p_I≈
->
Võw1C⁄figName
 );

454 
c⁄ã¡
 = 
	`GëC⁄figFûeC⁄ã¡
 ( 
p_I≈
->
Võw1C⁄figName
 );

455 i‡(
NULL
==
c⁄ã¡
)

456 
	`îr‹
 (
îr‹ãxt
, 300);

457 
	`P¨£C⁄ã¡
 (
p_I≈
, 
M≠Võw1
, 
c⁄ã¡
, (Ë
	`°æí
(content));

458 
	`¥ötf
 ("\n");

459 
	`‰ì
 (
c⁄ã¡
);

463 
	`P©chI≈
(
p_Vid
, 
p_I≈
);

465 
cfg∑øms
 = *
p_I≈
;

467 i‡(
p_I≈
->
Di•œyEncP¨ams
)

468 
	`Di•œyEncodîP¨ams
(
M≠
);

469 
	}
}

482 
	$Te°EncodîP¨ams
(
M≠pög
 *
M≠
, 
bôdïth_qp_sˇÀ
[3])

484 
i
 = 0;

486 
M≠
[
i
].
TokíName
 !
NULL
)

488 i‡(
M≠
[
i
].
∑øm_limôs
 == 1)

490 i‡(
M≠
[
i
].
Ty≥
 == 0)

492 i‡–* (*Ë(
M≠
[
i
].
Pœ˚
Ë< (ËM≠[i].
mö_limô
 || * (*Ë(M≠[i].Pœ˚Ë> (ËM≠[i].
max_limô
 )

494 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Eº‹ i¿öpuà∑ømëî %s. Check c⁄figuøti⁄ fûe. VÆuêshould bêö [%d, %d]Ñ™ge.", 
M≠
[
i
].
TokíName
, (ËM≠[i].
mö_limô
,()M≠[i].
max_limô
 );

495 
	`îr‹
 (
îr‹ãxt
, 400);

499 i‡(
M≠
[
i
].
Ty≥
 == 2)

501 i‡–* (*Ë(
M≠
[
i
].
Pœ˚
Ë< M≠[i].
mö_limô
 || * (*Ë(M≠[i].Pœ˚Ë> M≠[i].
max_limô
 )

503 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Eº‹ i¿öpuà∑ømëî %s. Check c⁄figuøti⁄ fûe. VÆuêshould bêö [%.2f, %.2f]Ñ™ge.", 
M≠
[
i
].
TokíName
,M≠[i].
mö_limô
 ,M≠[i].
max_limô
 );

504 
	`îr‹
 (
îr‹ãxt
, 400);

508 i‡(
M≠
[
i
].
∑øm_limôs
 == 2)

510 i‡(
M≠
[
i
].
Ty≥
 == 0)

512 i‡–* (*Ë(
M≠
[
i
].
Pœ˚
Ë< (ËM≠[i].
mö_limô
 )

514 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Eº‹ i¿öpuà∑ømëî %s. Check c⁄figuøti⁄ fûe. VÆuêshouldÇŸ bêsmÆÀ∏th™ %d.", 
M≠
[
i
].
TokíName
, (ËM≠[i].
mö_limô
);

515 
	`îr‹
 (
îr‹ãxt
, 400);

518 i‡(
M≠
[
i
].
Ty≥
 == 2)

520 i‡–* (*Ë(
M≠
[
i
].
Pœ˚
Ë< M≠[i].
mö_limô
 )

522 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Eº‹ i¿öpuà∑ømëî %s. Check c⁄figuøti⁄ fûe. VÆuêshouldÇŸ bêsmÆÀ∏th™ %2.f.", 
M≠
[
i
].
TokíName
,M≠[i].
mö_limô
);

523 
	`îr‹
 (
îr‹ãxt
, 400);

527 i‡(
M≠
[
i
].
∑øm_limôs
 == 3)

530 i‡(
M≠
[
i
].
Ty≥
 == 0)

532 
cur_qp
 = * (*Ë(
M≠
[
i
].
Pœ˚
);

533 
mö_qp
 = (Ë(
M≠
[
i
].
mö_limô
 - 
bôdïth_qp_sˇÀ
[0]);

534 
max_qp
 = (Ë
M≠
[
i
].
max_limô
;

536 i‡(–
cur_qp
 < 
mö_qp
 ) || ( cur_q∞> 
max_qp
 ))

538 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Eº‹ i¿öpuà∑ømëî %s. Check c⁄figuøti⁄ fûe. VÆuêshould bêö [%d, %d]Ñ™ge.", 
M≠
[
i
].
TokíName
, 
mö_qp
, 
max_qp
 );

539 
	`îr‹
 (
îr‹ãxt
, 400);

544 
i
++;

547 
	}
}

559 
	$Di•œyEncodîP¨ams
(
M≠pög
 *
M≠
)

561 
i
 = 0;

563 
	`¥ötf
("******************************************************\n");

564 
	`¥ötf
("* Encoder Parameters *\n");

565 
	`¥ötf
("******************************************************\n");

566 
M≠
[
i
].
TokíName
 !
NULL
)

568 i‡(
M≠
[
i
].
Ty≥
 == 0)

569 
	`¥ötf
("P¨amëî %†%d\n",
M≠
[
i
].
TokíName
,* (*Ë(M≠[i].
Pœ˚
));

570 i‡(
M≠
[
i
].
Ty≥
 == 1)

571 
	`¥ötf
("P¨amëî %†""%s""\n",
M≠
[
i
].
TokíName
,(*Ë(M≠[i].
Pœ˚
));

572 i‡(
M≠
[
i
].
Ty≥
 == 2)

573 
	`¥ötf
("P¨amëî %†%.2f\n",
M≠
[
i
].
TokíName
,* (*Ë(M≠[i].
Pœ˚
));

574 
i
++;

576 
	`¥ötf
("******************************************************\n");

578 
	}
}

587 
	$ªad_¶i˚_group_öfo
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

589 
FILE
 * 
sgfûe
=
NULL
;

590 
i
;

591 
ªt
;

592 
PicSizeInM≠Unôs
;

594 i‡((
p_I≈
->
¶i˚_group_m≠_ty≥
 != 0) && (p_Inp->slice_group_map_type != 2) && (p_Inp->slice_group_map_type != 6))

601 i‡((Ë
	`°æí
 (
p_I≈
->
Sli˚GroupC⁄figFûeName
) <= 1)

602 
	`îr‹
 ("No slice group config fileÇame specified", 500);

605 
sgfûe
 = 
	`f›í
(
p_I≈
->
Sli˚GroupC⁄figFûeName
,"r");

607 i‡–
NULL
==
sgfûe
 )

609 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Eº‹ o≥nög sli˚ grou∞fûê%s", 
p_I≈
->
Sli˚GroupC⁄figFûeName
);

610 
	`îr‹
 (
îr‹ãxt
, 500);

613 
p_I≈
->
¶i˚_group_m≠_ty≥
)

616 
p_I≈
->
run_Àngth_möus1
=(*)
	`mÆloc
(()*’_I≈->
num_¶i˚_groups_möus1
+1));

617 i‡–
NULL
==
p_I≈
->
run_Àngth_möus1
 )

619 
	`f˛o£
(
sgfûe
);

620 
	`no_mem_exô
("read_slice_group_info:Ö_Inp->run_length_minus1");

624 
i
=0; i <
p_I≈
->
num_¶i˚_groups_möus1
;i++)

626 
ªt
 = 
	`fsˇnf
(
sgfûe
,"%d",(
p_I≈
->
run_Àngth_möus1
+
i
));

627 i‡–1!=
ªt
 )

629 
	`f˛o£
(
sgfûe
);

630 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Eº‹ whûêªadög sli˚ grou∞c⁄fig fûê÷öê%d)", 
i
+1);

631 
	`îr‹
 (
îr‹ãxt
, 500);

634 
ªt
 = 
	`fsˇnf
(
sgfûe
,"%*[^\n]");

640 
PicSizeInM≠Unôs
 = (
p_I≈
->
ouçut
.
width
[0] >> 4Ë* (p_I≈->ouçut.
height
[0] >> 4);

641 i‡(
p_I≈
->
MbI¡îœ˚
||p_I≈->
PicI¡îœ˚
)

642 
PicSizeInM≠Unôs
 >>= 1;

644 
p_I≈
->
t›_À·
 = (*)
	`mÆloc
(()*p_I≈->
num_¶i˚_groups_möus1
);

645 
p_I≈
->
bŸtom_right
 = (*)
	`mÆloc
(()*p_I≈->
num_¶i˚_groups_möus1
);

647 i‡(
NULL
==
p_I≈
->
t›_À·
)

649 
	`f˛o£
(
sgfûe
);

650 
	`no_mem_exô
("PatchInp:Ö_Inp->top_left");

653 i‡(
NULL
==
p_I≈
->
bŸtom_right
)

655 
	`f˛o£
(
sgfûe
);

656 
	`no_mem_exô
("PatchInp:Ö_Inp->bottom_right");

660 
i
=0;i<
p_I≈
->
num_¶i˚_groups_möus1
;i++)

662 
ªt
 = 
	`fsˇnf
(
sgfûe
,"%ud",(
p_I≈
->
t›_À·
+
i
));

663 i‡–1!=
ªt
 )

665 
	`f˛o£
(
sgfûe
);

666 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Eº‹ whûêªadög sli˚ grou∞c⁄fig fûê÷öê%d)", 2*
i
 +1);

667 
	`îr‹
 (
îr‹ãxt
, 500);

669 i‡(
p_I≈
->
t›_À·
[
i
] > 
PicSizeInM≠Unôs
)

671 
	`Ârötf
(
°dîr
, "W¨nög: sli˚ grou∞# %dÅ›_À·Éx˚ed†pi˘uª sizê(wû»bê˛ù≥d)\n", 
i
);

674 
ªt
 = 
	`fsˇnf
(
sgfûe
,"%*[^\n]");

675 
ªt
 = 
	`fsˇnf
(
sgfûe
,"%ud",(
p_I≈
->
bŸtom_right
+
i
));

676 i‡–1!=
ªt
 )

678 
	`f˛o£
(
sgfûe
);

679 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Eº‹ whûêªadög sli˚ grou∞c⁄fig fûê÷öê%d)", 2*
i
 + 2);

680 
	`îr‹
 (
îr‹ãxt
, 500);

682 i‡(
p_I≈
->
bŸtom_right
[
i
] > 
PicSizeInM≠Unôs
)

684 
	`Ârötf
(
°dîr
, "W¨nög: sli˚ grou∞# %d bŸtom_righàex˚ed†pi˘uª sizê(wû»bê˛ù≥d)\n", 
i
);

687 
ªt
 = 
	`fsˇnf
(
sgfûe
,"%*[^\n]");

692 
tmp
;

693 
‰ame_mb_⁄ly
;

694 
mb_width
, 
mb_height
, 
m≠unô_height
;

696 
‰ame_mb_⁄ly
 = !(
p_I≈
->
PicI¡îœ˚
 ||Ö_I≈->
MbI¡îœ˚
);

697 
mb_width
 = (
p_I≈
->
ouçut
.
width
[0] + 
p_Vid
->
auto_¸›_right
)>>4;

698 
mb_height
 = (
p_I≈
->
ouçut
.
height
[0] + 
p_Vid
->
auto_¸›_bŸtom
)>>4;

699 
m≠unô_height
 = 
mb_height
 / (2-
‰ame_mb_⁄ly
);

701 
p_I≈
->
¶i˚_group_id
=(
byã
 * ) 
	`mÆloc
((byã)*
m≠unô_height
*
mb_width
);

702 i‡(
NULL
==
p_I≈
->
¶i˚_group_id
)

704 
	`f˛o£
(
sgfûe
);

705 
	`no_mem_exô
("PatchInp:Ö_Inp->slice_group_id");

709 
i
=0;i<
m≠unô_height
*
mb_width
;i++)

711 
ªt
 = 
	`fsˇnf
(
sgfûe
,"%d", &
tmp
);

712 
p_I≈
->
¶i˚_group_id
[
i
](
byã
Ë
tmp
;

713 i‡–1!=
ªt
 )

715 
	`f˛o£
(
sgfûe
);

716 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Eº‹ whûêªadög sli˚ grou∞c⁄fig fûê÷öê%d)", 
i
 + 1);

717 
	`îr‹
 (
îr‹ãxt
, 500);

719 i‡–*(
p_I≈
->
¶i˚_group_id
+
i
Ë>Ö_I≈->
num_¶i˚_groups_möus1
 )

721 
	`f˛o£
(
sgfûe
);

722 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Eº‹ whûêªadög sli˚ grou∞c⁄fig fûe: sli˚_group_idÇŸáŒowed (löê%d)", 
i
 + 1);

723 
	`îr‹
 (
îr‹ãxt
, 500);

726 
ªt
 = 
	`fsˇnf
(
sgfûe
,"%*[^\n]");

732 
	`îr‹
 ("Wrong slice groupÅype whileÑeading config file", 500);

737 
	`f˛o£
(
sgfûe
);

738 
	}
}

746 
	$P©chI≈
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

748 
i
;

749 
bôdïth_qp_sˇÀ
[3];

751 i‡(
p_I≈
->
§c_BôDïthResˇÀ
)

753 
bôdïth_qp_sˇÀ
 [0] = 6*(
p_I≈
->
ouçut
.
bô_dïth
[0] - 8);

754 
bôdïth_qp_sˇÀ
 [1] = 6*(
p_I≈
->
ouçut
.
bô_dïth
[1] - 8);

755 
bôdïth_qp_sˇÀ
 [2] = 6*(
p_I≈
->
ouçut
.
bô_dïth
[2] - 8);

759 
bôdïth_qp_sˇÀ
 [0] = 6*(
p_I≈
->
sour˚
.
bô_dïth
[0] - 8);

760 
bôdïth_qp_sˇÀ
 [1] = 6*(
p_I≈
->
sour˚
.
bô_dïth
[1] - 8);

761 
bôdïth_qp_sˇÀ
 [2] = 6*(
p_I≈
->
sour˚
.
bô_dïth
[2] - 8);

764 
	`Te°EncodîP¨ams
(
M≠
, 
bôdïth_qp_sˇÀ
);

766 i‡(
p_I≈
->
sour˚
.
‰ame_øã
 == 0.0)

767 
p_I≈
->
sour˚
.
‰ame_øã
 = (Ë
INIT_FRAME_RATE
;

769 
	`P¨£VideoTy≥
(&
p_I≈
->
öput_fûe1
);

770 
	`P¨£FømeNoF‹m©FromSåög
 (&
p_I≈
->
öput_fûe1
);

772 #i‡(
MVC_EXTENSION_ENABLE
)

773 i‡–
p_I≈
->
num_of_võws
 == 2 )

775 
	`P¨£VideoTy≥
(&
p_I≈
->
öput_fûe2
);

776 
	`P¨£FømeNoF‹m©FromSåög
 (&
p_I≈
->
öput_fûe2
);

780 if(
p_I≈
->
sour˚
.
bô_dïth
[0] >8)

782 if(!
IMGTYPE
)

784 
	`îr‹
("IMGTYPE should be 1 when bitdepth is greaterÅhan 8", 600);

788 i‡(
p_I≈
->
sour˚
.
width
[0] =0 ||Ö_I≈->sour˚.
height
[0] == 0)

790 i‡(
	`P¨£SizeFromSåög
 (&
p_I≈
->
öput_fûe1
, &’_I≈->
sour˚
.
width
[0]), &’_I≈->sour˚.
height
[0]), &’_I≈->sour˚.
‰ame_øã
)) == 0)

792 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "FileÇame doesÇot containÑesolution information.");

793 
	`îr‹
 (
îr‹ãxt
, 500);

797 #i‡(!
ENABLE_FIELD_CTX
)

798 i‡–(
p_I≈
->
PicI¡îœ˚
 ||Ö_I≈->
MbI¡îœ˚
Ë&&Ö_I≈->
symbﬁ_mode
 )

800 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Recompile with ENABLE_FIELD_CTX setÅo oneÅoÉnable interlaced coding with CABAC.");

801 
	`îr‹
 (
îr‹ãxt
, 500);

805 #i‡(!
ENABLE_HIGH444_CTX
)

806 i‡–
p_I≈
->
ProfûeIDC
 =244 &&Ö_I≈->
symbﬁ_mode
 )

808 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Recompile with ENABLE_HIGH444_CTX setÅo oneÅoÉnableÅhe High 4:4:4 Profile with CABAC.");

809 
	`îr‹
 (
îr‹ãxt
, 500);

814 
p_I≈
->
öput_fûe1
.
f‹m©
 =Ö_I≈->
sour˚
;

817 i‡(
p_I≈
->
idr_≥riod
 &&Ö_I≈->
öåa_dñay
 &&Ö_Inp->idr_period <=Ö_Inp->intra_delay)

819 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, " IntraDelay cannot beÜargerÅhan orÉqualÅo IDRPeriod.");

820 
	`îr‹
 (
îr‹ãxt
, 500);

824 i‡–
p_I≈
->
idr_≥riod
 > 0 && (p_I≈->
NumbîBFømes
 + 1 +Ö_I≈->
öåa_dñay
) >Ö_Inp->idr_period )

826 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, " Setting NumberBFrames = IDRPeriod - 1 - IntraDelay.");

827 
p_I≈
->
NumbîBFømes
 =Ö_I≈->
idr_≥riod
 - 1 -Ö_I≈->
öåa_dñay
;

828 i‡–
p_I≈
->
NumbîBFømes
 < 0 )

830 
p_I≈
->
NumbîBFømes
 =Ö_I≈->
idr_≥riod
 - 1;

831 
p_I≈
->
öåa_dñay
 = 0;

833 i‡–
p_I≈
->
HõørchiˇlCodög
 )

835 
p_I≈
->
HõørchiˇlCodög
 = 2;

838 i‡–
p_I≈
->
öåa_≥riod
 > 0 && (p_I≈->
NumbîBFømes
 + 1 +Ö_I≈->
öåa_dñay
) >Ö_Inp->intra_period )

840 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, " Setting NumberBFrames = IntraPeriod - 1 - IntraDelay.");

841 
p_I≈
->
NumbîBFømes
 =Ö_I≈->
öåa_≥riod
 - 1 -Ö_I≈->
öåa_dñay
;

842 i‡–
p_I≈
->
NumbîBFømes
 < 0 )

844 
p_I≈
->
NumbîBFømes
 =Ö_I≈->
öåa_≥riod
 - 1;

845 
p_I≈
->
öåa_dñay
 = 0;

847 i‡–
p_I≈
->
HõørchiˇlCodög
 )

849 
p_I≈
->
HõørchiˇlCodög
 = 2;

853 i‡(
p_I≈
->
öåa_dñay
 &&Ö_I≈->
NumbîBFømes
 > 0 &&Ö_I≈->
E«bÀO≥nGOP
)

854 
p_I≈
->
PocMem‹yM™agemít
 = 1;

857 
p_I≈
->
jumpd
 = (p_I≈->
NumbîBFømes
 + 1Ë* (p_I≈->
‰ame_skù
 + 1) - 1;

860 
	`upd©eOutF‹m©
(
p_I≈
);

862 i‡–
p_I≈
->
SEIVUI32PuŒdown
 &&Ö_I≈->
íabÀ_32_puŒdown
 )

864 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "SEIVUI32Pulldownánd Enable32Pulldown cannot be setátÅhe sameÅime.");

865 
	`îr‹
 (
îr‹ãxt
, 500);

867 i‡–
p_I≈
->
SEIVUI32PuŒdown
 )

869 
	`£t_jm_vui_∑øms
–
p_I≈
 );

872 i‡(
p_I≈
->
no_‰ames
 == -1)

874 
	`O≥nFûes
(&
p_I≈
->
öput_fûe1
);

875 
	`gë_numbî_of_‰ames
 (
p_I≈
, &p_I≈->
öput_fûe1
);

876 
	`Clo£Fûes
(&
p_I≈
->
öput_fûe1
);

879 i‡(
p_I≈
->
no_‰ames
 < 1)

881 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "NŸÉnough føme†tÿícodê(%d)", 
p_I≈
->
no_‰ames
);

882 
	`îr‹
 (
îr‹ãxt
, 500);

886 i‡(
p_I≈
->
I¡øProfûe
)

888 if(
p_I≈
->
NumbîBFømes
)

890 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Use of B slicesÇot supported with Intra Profiles. Set NumberBFramesÅo 0.");

891 
	`îr‹
 (
îr‹ãxt
, 400);

894 i‡(
p_I≈
->
PocMem‹yM™agemít
)

896 
	`¥ötf
("Warning: PocMemoryManagementÇot supported for Intra Profiles. Process Disabled.\n");

897 
p_I≈
->
PocMem‹yM™agemít
 = 0;

899 i‡(
p_I≈
->
Re„ªn˚Re‹dî
)

901 
	`¥ötf
("Warning: ReferenceReorderÇot supported for Intra Profiles. Process Disabled.\n");

902 
p_I≈
->
Re„ªn˚Re‹dî
 = 0;

907 if(
p_I≈
->
NumbîBFømes
 &&Ö_I≈->
dúe˘_•©ül_mv_¥ed_Êag
 !
DIR_SPATIAL
 &&Ö_I≈->dúe˘_•©ül_mv_¥ed_Êag !
DIR_TEMPORAL
)

909 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Unsuµ‹ãd dúe˘ mode=%d, u£ TEMPORAL=0 o∏SPATIAL=1", 
p_I≈
->
dúe˘_•©ül_mv_¥ed_Êag
);

910 
	`îr‹
 (
îr‹ãxt
, 400);

913 i‡(
p_I≈
->
PicI¡îœ˚
>0 ||Ö_I≈->
MbI¡îœ˚
>0)

915 i‡(
p_I≈
->
dúe˘In„ªn˚Fœg
==0)

916 
	`¥ötf
("\nWarning: DirectInferenceFlag setÅo 1 dueÅo interlace coding.");

917 
p_I≈
->
dúe˘In„ªn˚Fœg
 = 1;

920 if(
p_I≈
->
PicI¡îœ˚
 > 0 ||Ö_I≈->
MbI¡îœ˚
 > 0)

922 
	`¥ötf
("\nWarning: WPMCPredicions is setÅo 0 dueÅo interlace coding.\n");

923 
p_I≈
->
WPMCPªcisi⁄
 = 0;

925 #i‡
TRACE


926 i‡((Ë
	`°æí
 (
p_I≈
->
Tø˚Fûe
Ë> 0 && (
p_Enc
->
p_åa˚
 = 
	`f›í
’_I≈->Tø˚Fûe,"w"))==
NULL
)

928 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Eº‹ o≥¿fûê%s", 
p_I≈
->
Tø˚Fûe
);

929 
	`îr‹
 (
îr‹ãxt
, 500);

935 i‡((
p_I≈
->
¶i˚_mode
 =1)&&’_I≈->
MbI¡îœ˚
 != 0))

937 i‡((
p_I≈
->
¶i˚_¨gumít
 & 0x01)!=0)

939 
	`Ârötf
 ( 
°dîr
, "Warning: slice border within macroblockÖair. ");

940 i‡(
p_I≈
->
¶i˚_¨gumít
 > 1)

942 
p_I≈
->
¶i˚_¨gumít
--;

946 
p_I≈
->
¶i˚_¨gumít
++;

948 
	`Ârötf
 ( 
°dîr
, "Usög %d MB†≥∏¶i˚.\n", 
p_I≈
->
¶i˚_¨gumít
);

952 i‡(
p_I≈
->
WPMCPªcisi⁄
 && (p_I≈->
RDPi˘uªDecisi⁄
 !1 ||Ö_I≈->
Gíî©eMu…ùÀPPS
 != 1) )

954 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "WPMCPrecisionÑequires both RDPictureDecision=1ánd GenerateMultiplePPS=1.\n");

955 
	`îr‹
 (
îr‹ãxt
, 400);

957 
p_I≈
->
num_ªf_‰ames_‹g
 =Ö_I≈->
num_ªf_‰ames
;

958 
p_I≈
->
P_Li°0_ªfs_‹g
[0] =Ö_I≈->
P_Li°0_ªfs
[0];

959 
p_I≈
->
B_Li°0_ªfs_‹g
[0] =Ö_I≈->
B_Li°0_ªfs
[0];

960 
p_I≈
->
B_Li°1_ªfs_‹g
[0] =Ö_I≈->
B_Li°1_ªfs
[0];

961 
p_I≈
->
P_Li°0_ªfs_‹g
[1] =Ö_I≈->
P_Li°0_ªfs
[1];

962 
p_I≈
->
B_Li°0_ªfs_‹g
[1] =Ö_I≈->
B_Li°0_ªfs
[1];

963 
p_I≈
->
B_Li°1_ªfs_‹g
[1] =Ö_I≈->
B_Li°1_ªfs
[1];

965 i‡(
p_I≈
->
WPMCPªcisi⁄
 &&Ö_I≈->
WPMCPªcFuŒRef
 &&Ö_I≈->
num_ªf_‰ames
 < 16 )

967 
p_I≈
->
num_ªf_‰ames
++;

968 i‡–
p_I≈
->
P_Li°0_ªfs
[0] )

970 
p_I≈
->
P_Li°0_ªfs
[0]++;

974 
p_I≈
->
P_Li°0_ªfs
[0] =Ö_I≈->
num_ªf_‰ames
;

976 i‡–
p_I≈
->
B_Li°0_ªfs
[0] )

978 
p_I≈
->
B_Li°0_ªfs
[0]++;

982 
p_I≈
->
B_Li°0_ªfs
[0] =Ö_I≈->
num_ªf_‰ames
;

984 i‡–
p_I≈
->
B_Li°1_ªfs
[0] )

986 
p_I≈
->
B_Li°1_ªfs
[0]++;

990 
p_I≈
->
B_Li°1_ªfs
[0] =Ö_I≈->
num_ªf_‰ames
;

992 i‡–
p_I≈
->
SïVõwI¡îSórch
 )

994 i‡–
p_I≈
->
P_Li°0_ªfs
[1] )

996 
p_I≈
->
P_Li°0_ªfs
[1]++;

1000 
p_I≈
->
P_Li°0_ªfs
[1] =Ö_I≈->
num_ªf_‰ames
;

1002 i‡–
p_I≈
->
B_Li°0_ªfs
[1] )

1004 
p_I≈
->
B_Li°0_ªfs
[1]++;

1008 
p_I≈
->
B_Li°0_ªfs
[1] =Ö_I≈->
num_ªf_‰ames
;

1010 i‡–
p_I≈
->
B_Li°1_ªfs
[1] )

1012 
p_I≈
->
B_Li°1_ªfs
[1]++;

1016 
p_I≈
->
B_Li°1_ªfs
[1] =Ö_I≈->
num_ªf_‰ames
;

1020 i‡–
p_I≈
->
WPMCPªcisi⁄
 &&Ö_I≈->
WPMCPªcFuŒRef
 )

1022 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "WPMCPrecFullRefÑequires NumberReferenceFrames < 16.\n");

1023 
	`îr‹
 (
îr‹ãxt
, 400);

1026 i‡(
p_I≈
->
PicI¡îœ˚
)

1028 i‡(
p_I≈
->
Re„ªn˚Re‹dî
 == 2)

1030 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "ReferenceReorder = 2 isÇot supported with fieldÉncoding\n");

1031 
	`îr‹
 (
îr‹ãxt
, 400);

1033 i‡(
p_I≈
->
Re„ªn˚Re‹dî
 == 2)

1035 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "PocMemoryManagement = 2 isÇot supported with fieldÉncoding\n");

1036 
	`îr‹
 (
îr‹ãxt
, 400);

1040 i‡(
p_I≈
->
Re„ªn˚Re‹dî
 &&Ö_I≈->
MbI¡îœ˚
 )

1042 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "ReferenceReorder isÇot supported with MBAFF\n");

1043 
	`îr‹
 (
îr‹ãxt
, 400);

1046 i‡(
p_I≈
->
SëFú°AsL⁄gTîm
 && (p_I≈->
Re„ªn˚Re‹dî
 == 1 ||Ö_Inp->ReferenceReorder == 2))

1048 
	`¥ötf
("SetFirstAsLongTerm is set. ReferenceReorder isÇot supportedándÅherefore disabled. \n");

1049 
p_I≈
->
Re„ªn˚Re‹dî
 = 0;

1052 i‡–
	`is_MVC_¥ofûe
(
p_I≈
->
ProfûeIDC
) )

1054 i‡(
p_I≈
->
Re„ªn˚Re‹dî
 > 1)

1056 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "ReferenceReorder > 1 isÇot supported withÅhe Multiview (118) or Stereo High (128)Örofilesánd isÅherefore disabled. \n");

1057 
p_I≈
->
Re„ªn˚Re‹dî
 = 0;

1059 i‡–(
p_I≈
->
PocMem‹yM™agemít
Ë&& (p_I≈->
PicI¡îœ˚
 > 0) )

1061 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "PocMemoryManagement>0 isÇot supported withÅhe Multiview (118) or Stereo High (128)Örofilesánd isÅherefore disabled. \n");

1062 
p_I≈
->
PocMem‹yM™agemít
 = 0;

1067 i‡(
p_I≈
->
PocMem‹yM™agemít
 &&Ö_I≈->
MbI¡îœ˚
 )

1069 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "PocMemoryManagement isÇot supported with MBAFF\n");

1070 
	`îr‹
 (
îr‹ãxt
, 400);

1073 if(
p_I≈
->
MbI¡îœ˚
 &&Ö_I≈->
RDPi˘uªDecisi⁄
 &&Ö_I≈->
Gíî©eMu…ùÀPPS
)

1075 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "RDPictureDecision+GenerateMultiplePPSÇot supported with MBAFF. RDPictureDecisionÅherefore disabled\n");

1076 
p_I≈
->
RDPi˘uªDecisi⁄
 = 0;

1079 i‡((!
p_I≈
->
rd›t
)&&’_I≈->
MbI¡îœ˚
==2))

1081 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "MB AFF isÇot compatible withÇon-rd-optimized coding.");

1082 
	`îr‹
 (
îr‹ãxt
, 500);

1086 i‡(
p_I≈
->
rd›t
==2 && (Ö_I≈->
ProfûeIDC
>=
FREXT_HP
 ||Ö_I≈->ProfûeIDC==
FREXT_CAVLC444
 ))

1088 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Fast Mode Decision methodsÇot supported in FREX Profiles");

1089 
	`îr‹
 (
îr‹ãxt
, 500);

1095 i‡–
p_I≈
->
NumFømesInELSubSeq
 >Ö_I≈->
num_ªf_‰ames
 ||Ö_Inp->NumFramesInELSubSeq < 0 )

1097 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "NumFømesInELSubSeq (%dËi†ouào‡øngê[0,%d).", 
p_I≈
->
NumFømesInELSubSeq
,Ö_I≈->
num_ªf_‰ames
);

1098 
	`îr‹
 (
îr‹ãxt
, 500);

1101 i‡–
p_I≈
->
NumFømesInELSubSeq
 > 0 )

1103 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Enhanced GOP isÇotÖroperly supported yet.");

1104 
	`îr‹
 (
îr‹ãxt
, 500);

1108 i‡((
p_I≈
->
PicI¡îœ˚
 ||Ö_I≈->
MbI¡îœ˚
Ë&&Ö_I≈->
S∑ªPi˘uªO±i⁄
 =
TRUE
)

1110 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "AFF isÇot compatible with spareÖicture.");

1111 
	`îr‹
 (
îr‹ãxt
, 500);

1115 i‡(
p_I≈
->
of_mode
 !
PAR_OF_RTP
 &&Ö_I≈->
S∑ªPi˘uªO±i⁄
 =
TRUE
)

1117 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Only RTP output mode is compatible with spareÖicture features.");

1118 
	`îr‹
 (
îr‹ãxt
, 500);

1122 i‡(
p_I≈
->
of_mode
 =
PAR_OF_RTP
 && (–p_I≈->
ProfûeIDC
 =
STEREO_HIGH
 ) || (p_I≈->ProfûeIDC =
MULTIVIEW_HIGH
) ))

1124 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "RTP output mode isÇot compatible with MVCÖrofiles.");

1125 
	`îr‹
 (
îr‹ãxt
, 500);

1128 if–(
p_I≈
->
WeighãdPªdi˘i⁄
 > 0 ||Ö_I≈->
WeighãdBùªdi˘i⁄
 > 0Ë&& (p_I≈->
MbI¡îœ˚
))

1130 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "WeightedÖrediction coding isÇot supported for MB AFF currently.");

1131 
	`îr‹
 (
îr‹ãxt
, 500);

1133 if–(
p_I≈
->
WeighãdPªdi˘i⁄
 > 0 ||Ö_I≈->
WeighãdBùªdi˘i⁄
 > 0Ë&& (p_I≈->
yuv_f‹m©
==3))

1135 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "WeightedÖrediction coding isÇot supported for 4:4:4Éncoding.");

1136 
	`îr‹
 (
îr‹ãxt
, 500);

1138 i‡–
p_I≈
->
NumFømesInELSubSeq
 > 0 &&Ö_I≈->
WeighãdPªdi˘i⁄
 > 0)

1140 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Enhanced GOP isÇot supported in weightedÖrediction coding mode yet.");

1141 
	`îr‹
 (
îr‹ãxt
, 500);

1145 if(
p_I≈
->
RCE«bÀ
)

1147 i‡–
p_I≈
->
RCUpd©eMode
 =
RC_MODE_1
 &&

1148 !–(
p_I≈
->
öåa_≥riod
 =1 ||Ö_I≈->
idr_≥riod
 =1 ||Ö_I≈->
BRefPi˘uªs
 =2 ) && !p_I≈->
NumbîBFømes
 ) )

1150 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Use RCUpdateMode = 1 only foráll intra oráll B-slice coding.");

1151 
	`îr‹
 (
îr‹ãxt
, 500);

1153 i‡–(
p_I≈
->
RCUpd©eMode
 =
RC_MODE_0
 ||Ö_I≈->RCUpd©eModê=
RC_MODE_2
 ||Ö_I≈->RCUpd©eModê=
RC_MODE_3
) &&

1154 (
p_I≈
->
PRïœ˚BSli˚
 &&Ö_I≈->
NumbîBFømes
 ) )

1156 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "PReplaceBSlice isÇot supported with RCUpdateMode=0,2,3.");

1157 
	`îr‹
 (
îr‹ãxt
, 500);

1160 i‡–
p_I≈
->
BRefPi˘uªs
 =2 &&Ö_I≈->
öåa_≥riod
 =0 &&Ö_I≈->
RCUpd©eMode
 !
RC_MODE_1
 )

1162 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Use RCUpdateMode = 1 foráll B-slice coding.");

1163 
	`îr‹
 (
îr‹ãxt
, 500);

1166 i‡–
p_I≈
->
HõørchiˇlCodög
 &&Ö_I≈->
RCUpd©eMode
 !
RC_MODE_2
 &&Ö_I≈->RCUpd©eModê!
RC_MODE_3
 )

1168 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Use RCUpdateMode = 2 or 3 for hierarchical B-picture coding.");

1169 
	`îr‹
 (
îr‹ãxt
, 500);

1171 i‡–(
p_I≈
->
RCUpd©eMode
 !
RC_MODE_1
Ë&& (p_I≈->
öåa_≥riod
 == 1) )

1173 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Use RCUpdateMode = 1 foráll intra coding.");

1174 
	`îr‹
 (
îr‹ãxt
, 500);

1178 i‡((
p_I≈
->
NumbîBFømes
)&&’_I≈->
BRefPi˘uªs
)&&’_I≈->
idr_≥riod
)&&’_I≈->
pic_‹dî_˙t_ty≥
!=0))

1180 
	`îr‹
("Stored BÖictures combined with IDRÖictures only supported in Picture Order CountÅype 0\n",-1000);

1183 if–!
p_I≈
->
dúe˘_•©ül_mv_¥ed_Êag
 &&Ö_I≈->
num_ªf_‰ames
<2 &&Ö_I≈->
NumbîBFømes
 >0)

1184 
	`îr‹
("temporal directÇeedsátÜeast 2Ñef frames\n",-1000);

1186 #i‡(
MVC_EXTENSION_ENABLE
)

1187 i‡(
p_I≈
->
SïVõwI¡îSórch
 &&Ö_I≈->
SórchMode
[1] =
FAST_FULL_SEARCH
 &&Ö_I≈->
MEEº‹Mëric
[
F_PEL
] > 
ERROR_SSE
)

1189 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "\nOnly SADánd SSE distortion computation supported with Fast Full Search.");

1190 
	`îr‹
 (
îr‹ãxt
, 500);

1194 i‡(
p_I≈
->
SórchMode
[0] =
FAST_FULL_SEARCH
 &&Ö_I≈->
MEEº‹Mëric
[
F_PEL
] > 
ERROR_SSE
)

1196 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "\nOnly SADánd SSE distortion computation supported with Fast Full Search.");

1197 
	`îr‹
 (
îr‹ãxt
, 500);

1200 i‡(
p_I≈
->
rd›t
 == 0)

1202 i‡(
p_I≈
->
DißbÀSub≥lME
[0] ||Ö_Inp->DisableSubpelME[1])

1204 i‡(
p_I≈
->
MEEº‹Mëric
[
F_PEL
] !p_I≈->
ModeDecisi⁄Mëric
)

1206 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "\nLa°ÑeföemíàÀvñ (FPñËdi°‹ti⁄ÇŸÅhêßmêa†Modêdecisi⁄ di°‹ti⁄.\nPÀa£ upd©êMEDi°‹ti⁄FPñ (%dË™d/‹ MDDi°‹ti⁄(%d).", 
p_I≈
->
MEEº‹Mëric
[
F_PEL
],Ö_I≈->
ModeDecisi⁄Mëric
);

1207 
	`îr‹
 (
îr‹ãxt
, 500);

1210 i‡(
p_I≈
->
MEEº‹Mëric
[
Q_PEL
] !p_I≈->
ModeDecisi⁄Mëric
)

1212 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "\nLa°ÑeföemíàÀvñ (QPñËdi°‹ti⁄ÇŸÅhêßmêa†Modêdecisi⁄ di°‹ti⁄.\nPÀa£ upd©êMEDi°‹ti⁄QPñ (%dË™d/‹ MDDi°‹ti⁄(%d).", 
p_I≈
->
MEEº‹Mëric
[
Q_PEL
],Ö_I≈->
ModeDecisi⁄Mëric
);

1213 
	`îr‹
 (
îr‹ãxt
, 500);

1217 if(
p_I≈
->
Tønsf‹m8x8Mode
 &&Ö_I≈->
•_≥riodicôy
 )

1219 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "\nTheÇew 8x8 mode isÇot implemented for sp-frames.");

1220 
	`îr‹
 (
îr‹ãxt
, 500);

1223 if(
p_I≈
->
Tønsf‹m8x8Mode
 && (Ö_I≈->
ProfûeIDC
<
FREXT_HP
 &&Ö_I≈->ProfûeIDC!=
FREXT_CAVLC444
 ))

1225 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "\nTønsf‹m8x8Modêmay bêu£d o∆y wôh ProfûeIDC %dÅÿ%d.", 
FREXT_HP
, 
FREXT_Hi444
);

1226 
	`îr‹
 (
îr‹ãxt
, 500);

1229 i‡(
p_I≈
->
DißbÀI¡ø4x4
 =1 &&Ö_I≈->
DißbÀI¡ø16x16
 =1 &&Ö_I≈->
E«bÀIPCM
 =0 &&Ö_I≈->
Tønsf‹m8x8Mode
 == 0)

1231 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "\nAtÜeast one intraÖrediction modeÇeedsÅo beÉnabled.");

1232 
	`îr‹
 (
îr‹ãxt
, 500);

1235 if(
p_I≈
->
SˇlögM©rixPª£¡Fœg
 && (Ö_I≈->
ProfûeIDC
<
FREXT_HP
 &&Ö_I≈->ProfûeIDC!=
FREXT_CAVLC444
 ))

1237 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "\nSˇlögM©rixPª£¡Fœg may bêu£d o∆y wôh ProfûeIDC %dÅÿ%d.", 
FREXT_HP
, 
FREXT_Hi444
);

1238 
	`îr‹
 (
îr‹ãxt
, 500);

1241 if(
p_I≈
->
yuv_f‹m©
==
YUV422
 && (Ö_I≈->
ProfûeIDC
 < 
FREXT_Hi422
 &&Ö_I≈->ProfûeIDC!=
FREXT_CAVLC444
 ))

1243 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "\nFRExàProfûe(YUV F‹m©ËEº‹!\nYUV422 c™ bêu£d o∆y wôh ProfûeIDC %d o∏%d\n",
FREXT_Hi422
, 
FREXT_Hi444
);

1244 
	`îr‹
 (
îr‹ãxt
, 500);

1246 if(
p_I≈
->
yuv_f‹m©
==
YUV444
 && (Ö_I≈->
ProfûeIDC
 < 
FREXT_Hi444
 &&Ö_I≈->ProfûeIDC!=
FREXT_CAVLC444
 ))

1248 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "\nFRExàProfûe(YUV F‹m©ËEº‹!\nYUV444 c™ bêu£d o∆y wôh ProfûeIDC %d.\n",
FREXT_Hi444
);

1249 
	`îr‹
 (
îr‹ãxt
, 500);

1252 i‡(
p_I≈
->
NumbîBFømes
 && (’_I≈->
BiPªdMŸi⁄E°im©i⁄
Ë&& (p_I≈->
£¨ch_ønge
[0] <Ö_I≈->
BiPªdMESórchR™ge
[0])))

1254 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "\nBiPredMESearchRange must be smaller orÉqual SearchRange.");

1255 
	`îr‹
 (
îr‹ãxt
, 500);

1257 #i‡(
MVC_EXTENSION_ENABLE
)

1258 i‡–
p_I≈
->
SïVõwI¡îSórch
 )

1260 i‡(
p_I≈
->
NumbîBFømes
 && (’_I≈->
BiPªdMŸi⁄E°im©i⁄
Ë&& (p_I≈->
£¨ch_ønge
[1] <Ö_I≈->
BiPªdMESórchR™ge
[1])))

1262 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "\nView1BiPredMESearchRange must be smaller orÉqual View1SearchRange.");

1263 
	`îr‹
 (
îr‹ãxt
, 500);

1268 i‡(
p_I≈
->
BiPªdMŸi⁄E°im©i⁄
)

1270 
p_I≈
->
BiPªdMŸi⁄E°im©i⁄
 = 0;

1271 
i
 = 0 ; i < 4; i++)

1272 
p_I≈
->
BiPªdMŸi⁄E°im©i⁄
 |p_I≈->
BiPªdSórch
[
i
];

1276 
i
 = 0 ; i < 4; i++)

1277 
p_I≈
->
BiPªdSórch
[
i
] = 0;

1281 i‡–
p_I≈
->
ChromaMEE«bÀ
 && !’_I≈->
ChromaMCBuf„r
) )

1283 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "\nChromaMCBuffer must be setÅo 1 if ChromaMEEnable is set.");

1284 
	`îr‹
 (
îr‹ãxt
, 500);

1287 i‡–
p_I≈
->
ChromaMEE«bÀ
 &&Ö_I≈->
yuv_f‹m©
 =
YUV400
)

1289 
	`Ârötf
(
°dîr
, "Warning: ChromaMEEnable cannot be used with monochrome color format, disabling ChromaMEEnable.\n");

1290 
p_I≈
->
ChromaMEE«bÀ
 = 
FALSE
;

1293 i‡–(
p_I≈
->
ChromaMCBuf„r
 =0Ë&& (–p_I≈->
yuv_f‹m©
 =
YUV444
Ë&& (!p_I≈->
£∑øã_cﬁour_∂™e_Êag
)) )

1295 
	`Ârötf
(
°dîr
, "Warning: Enabling ChromaMCBuffer for 4:4:4 combined color coding.\n");

1296 
p_I≈
->
ChromaMCBuf„r
 = 1;

1299 i‡(
p_I≈
->
E«bÀO≥nGOP
 &&Ö_I≈->
Re„ªn˚Re‹dî
 == 2)

1301 
	`¥ötf
("If OpenGOP isÉnabledÅhan ReferenceReorder is setÅo 1. \n");

1304 i‡(
p_I≈
->
E«bÀO≥nGOP
)

1305 
p_I≈
->
Re„ªn˚Re‹dî
 = 1;

1307 #i‡(
MVC_EXTENSION_ENABLE
)

1308 if((
p_I≈
->
ProfûeIDC
==
MULTIVIEW_HIGH
 ||Ö_I≈->ProfûeIDC==
STEREO_HIGH
Ë&&Ö_I≈->
num_of_võws
 != 2)

1310 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "NumberOfViews must beÅwo if ProfileIDC is setÅo 118 (Multiview High Profile). Otherwise (forá single view)Ölease selectáÇon-multiviewÖrofile suchás 100.");

1311 
	`îr‹
 (
îr‹ãxt
, 500);

1320 if(
p_I≈
->
MVCI¡îVõwRe‹dî
)

1322 i‡–!
	`is_MVC_¥ofûe
(
p_I≈
->
ProfûeIDC
) )

1324 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "ProfileIDC must be 118, 128, 134, or 135Åo use MVCInterViewReorder=1.");

1325 
	`îr‹
 (
îr‹ãxt
, 500);

1330 i‡(
p_I≈
->
SórchMode
[0] !
EPZS


1331 #i‡(
MVC_EXTENSION_ENABLE
)

1332 && (!
p_I≈
->
SïVõwI¡îSórch
 ||Ö_I≈->
SórchMode
[1] !
EPZS
 )

1335 
p_I≈
->
EPZSSubPñGrid
 = 0;

1337 i‡(
p_I≈
->
ªdund™t_pic_Êag
)

1339 i‡(
p_I≈
->
PicI¡îœ˚
 ||Ö_I≈->
MbI¡îœ˚
)

1341 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "RedundantÖictures cannot be used with interlacedÅools.");

1342 
	`îr‹
 (
îr‹ãxt
, 500);

1344 i‡(
p_I≈
->
RDPi˘uªDecisi⁄
)

1346 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "RedundantÖictures cannot be used with RDPictureDecision.");

1347 
	`îr‹
 (
îr‹ãxt
, 500);

1349 i‡(
p_I≈
->
NumbîBFømes
)

1351 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "RedundantÖictures cannot be used with B frames.");

1352 
	`îr‹
 (
îr‹ãxt
, 500);

1354 i‡(
p_I≈
->
Prim¨yGOPLígth
 < (1 <<Ö_I≈->
NumRedund™tHõørchy
))

1356 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "PrimaryGOPLength must beÉqual or greaterÅhan 2^NumRedundantHierarchy.");

1357 
	`îr‹
 (
îr‹ãxt
, 500);

1359 i‡(
p_I≈
->
num_ªf_‰ames
 <Ö_I≈->
Prim¨yGOPLígth
)

1361 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "NumberReferenceFrames must be greaterÅhan orÉqualÅo PrimaryGOPLength.");

1362 
	`îr‹
 (
îr‹ãxt
, 500);

1366 i‡(
p_I≈
->
num_ªf_‰ames
 =1 &&Ö_I≈->
NumbîBFømes
)

1368 
	`Ârötf
–
°dîr
, "\nWarning: B slices used but only oneÑeferenceállocated withinÑeference buffer.\n");

1369 
	`Ârötf
–
°dîr
, " Performance may be considerably compromised! \n");

1370 
	`Ârötf
–
°dîr
, " 2 or moreÑeferencesÑecommended for use with B slices.\n");

1372 i‡((
p_I≈
->
HõørchiˇlCodög
 ||Ö_I≈->
BRefPi˘uªs
Ë&&Ö_I≈->
NumbîBFømes
)

1374 
	`Ârötf
–
°dîr
, "\nWarning: Hierarchical coding or Referenced B slices used.\n");

1375 
	`Ârötf
–
°dîr
, " Make sureÅhat you haveállocatedÉnoughÑeferences\n");

1376 
	`Ârötf
–
°dîr
, " inÑeference bufferÅoáchieve bestÖerformance.\n");

1379 i‡(
p_I≈
->
Fa°MDE«bÀ
 == 0)

1381 
p_I≈
->
Fa°I¡øMD
 = 0;

1382 
p_I≈
->
Fa°I¡ø16x16
 = 0;

1383 
p_I≈
->
Fa°I¡ø4x4
 = 0;

1384 
p_I≈
->
Fa°I¡ø8x8
 = 0;

1385 
p_I≈
->
Fa°I¡øChroma
 = 0;

1389 i‡(
p_I≈
->
U£RDOQu™t
 == 1)

1391 i‡(
p_I≈
->
rd›t
 == 0)

1393 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "RDO QuantizationÇot supported withÜow complexity RDO.");

1394 
	`îr‹
 (
îr‹ãxt
, 500);

1397 i‡(
p_I≈
->
MbI¡îœ˚
 != 0)

1399 
	`¥ötf
("RDO Quantization currentlyÇot supported with MBAFF. Option disabled.\n");

1400 
p_I≈
->
U£RDOQu™t
 = 0;

1401 
p_I≈
->
RDOQ_QP_Num
 = 1;

1402 
p_I≈
->
RDOQ_CP_MV
 = 0;

1403 
p_I≈
->
RDOQ_CP_Mode
 = 0;

1407 
p_I≈
->
Ad≠tiveRoundög
 = 0;

1408 
	`¥ötf
("AdaptiveRounding is disabled when RDO Quantization is used\n");

1409 i‡(
p_I≈
->
RDOQ_QP_Num
 < 2)

1411 
p_I≈
->
RDOQ_CP_MV
 = 0;

1412 
p_I≈
->
RDOQ_CP_Mode
 = 0;

1418 
p_I≈
->
RDOQ_QP_Num
 = 1;

1419 
p_I≈
->
RDOQ_CP_MV
 = 0;

1420 
p_I≈
->
RDOQ_CP_Mode
 = 0;

1423 if(
p_I≈
->
num_¶i˚_groups_möus1
 > 0 && (p_I≈->
Gíî©eMu…ùÀPPS
 ==1 &&Ö_I≈->
RDPi˘uªDecisi⁄
 == 1))

1425 
	`¥ötf
("Warning: Weighted Prediction mayÇot function correctly for multiple slices\n");

1428 #i‡
KEEP_B_SAME_LIST


1429 i‡–
p_I≈
->
BIdítiˇlLi°
 > 0 &&Ö_I≈->
Re„ªn˚Re‹dî
 != 1 )

1431 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "SetÅwoÜists of BÖicture identical can only be used when ReferenceReorder is 1");

1432 
	`îr‹
 (
îr‹ãxt
, 500);

1436 #i‡
CRA


1437 i‡–
p_I≈
->
u£CRA
 =1 &&Ö_I≈->
öåa_≥riod
 == 0 )

1439 
	`¥ötf
("Warning: CRA can only be used for IntraPeriod > 0, set CRAÅo 0\n");

1440 
p_I≈
->
u£CRA
 = 0;

1442 i‡–
p_I≈
->
u£CRA
 =1 &&Ö_I≈->
LowDñay
 == 1 )

1444 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "CRA cannot be used when LowDelay is 1");

1445 
	`îr‹
 (
îr‹ãxt
, 500);

1447 i‡–(
p_I≈
->
u£CRA
 =1Ë&& (p_I≈->
PicI¡îœ˚
 > 0) )

1449 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "HM5Üike configuration options (CRA) cannot be usedÅogether with PicInterlace");

1450 
	`îr‹
 (
îr‹ãxt
, 500);

1454 #i‡
HM50_LIKE_MMCO


1455 i‡–
p_I≈
->
HM50RefSåu˘uª
 == 1 )

1457 
	`¥ötf
("Warning: HM50RefStructure can only be used forÑandomáccess case with GOP sizeÉqualÅo 8ánd HM-5.0 coding order\n");

1458 
	`¥ötf
(" If it used for other coding structure,ÅheÖerformance mayÜoss\n");

1460 i‡–
p_I≈
->
HM50RefSåu˘uª
 =1 &&Ö_I≈->
NumbîBFømes
 != 7 )

1462 
	`¥ötf
("Warning: HM50RefStructure can only be used forÑandomáccess case with NumberBFramesÉqualÅo 7,Åurn it off\n");

1463 
p_I≈
->
HM50RefSåu˘uª
 = 0;

1465 i‡–
p_I≈
->
HM50RefSåu˘uª
 =1 &&Ö_I≈->
LowDñay
 == 1 )

1467 
	`¥ötf
("Warning: HM50RefStructure cannot be used forÜow delay,Åurn it off\n");

1468 
p_I≈
->
HM50RefSåu˘uª
 = 0;

1470 i‡–(
p_I≈
->
HM50RefSåu˘uª
 =1Ë&& (p_I≈->
PicI¡îœ˚
 > 0) )

1472 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "HM5Üike configuration options (HM50RefStructure) cannot be usedÅogether with PicInterlace");

1473 
	`îr‹
 (
îr‹ãxt
, 500);

1477 #i‡
LD_REF_SETTING


1478 i‡–
p_I≈
->
LDRefSëtög
 == 1 )

1480 
	`¥ötf
("Warning: LDRefSetting can only be used forÜow delay case with GOP sizeÉqualÅo 4ánd 4Ñeference framesás HM-5.0Üow delay\n");

1481 
	`¥ötf
(" If other GOP size orÇumber ofÑeference framesáre used,ÅheÖerformance may beÜoss with LDRefSetting\n");

1483 i‡–
p_I≈
->
LDRefSëtög
 =1 &&Ö_I≈->
LowDñay
 == 0 )

1485 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "LDRefSetting can only be used when LowDelay is 1");

1486 
	`îr‹
 (
îr‹ãxt
, 500);

1488 i‡–(
p_I≈
->
LDRefSëtög
 =1Ë&& (p_I≈->
PicI¡îœ˚
 > 0) )

1490 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "HM5Üike configuration options (LDRefSetting) cannot be usedÅogether with PicInterlace");

1491 
	`îr‹
 (
îr‹ãxt
, 500);

1494 #i‡
B0_MORE_REF


1495 i‡–(
p_I≈
->
BLevñ0M‹eRef
 =1Ë&& (p_I≈->
PicI¡îœ˚
 > 0) )

1497 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "HM5Üike configuration options (BLevel0MoreRef) cannot be usedÅogether with PicInterlace");

1498 
	`îr‹
 (
îr‹ãxt
, 500);

1501 #i‡
KEEP_B_SAME_LIST


1502 i‡–(
p_I≈
->
BIdítiˇlLi°
 =1Ë&& (p_I≈->
PicI¡îœ˚
 > 0) )

1504 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "HM5Üike configuration options (BIdenticalList) cannot be usedÅogether with PicInterlace");

1505 
	`îr‹
 (
îr‹ãxt
, 500);

1509 
	`¥ofûe_check
(
p_I≈
);

1511 if(!
p_I≈
->
RDPi˘uªDecisi⁄
)

1513 
p_I≈
->
RDPi˘uªMaxPassISli˚
 = 1;

1514 
p_I≈
->
RDPi˘uªMaxPassPSli˚
 = 1;

1515 
p_I≈
->
RDPi˘uªMaxPassBSli˚
 = 1;

1516 
p_I≈
->
RDPi˘uªDeblockög
 = 0;

1517 
p_I≈
->
RDPi˘uªDúe˘Mode
 = 0;

1518 
p_I≈
->
RDPi˘uªFømeQPPSli˚
 = 0;

1519 
p_I≈
->
RDPi˘uªFømeQPBSli˚
 = 0;

1521 
	}
}

1530 
	$SëVUISˇÀAndTicks
(
I≈utP¨amëîs
 *
p_I≈
, 
‰ame_øã
)

1532 
‰ame_øã_öãgî
 = ()
	`˚û
–
‰ame_øã
 );

1534 i‡–
‰ame_øã_öãgî
 !
‰ame_øã
 )

1538 
√w_‰ame_øã
 = 1.001 * 
‰ame_øã
;

1540 i‡–
	`dabs
–
√w_‰ame_øã
 - 
‰ame_øã_öãgî
 ) < dabs–
‰ame_øã
 - frame_rate_integer ) )

1542 
p_I≈
->
VUI
.
num_unôs_ö_tick
 = 1001;

1543 
p_I≈
->
VUI
.
time_sˇÀ
 = ()
	`Êo‹
–
‰ame_øã_öãgî
 * (1000 << 1) );

1547 
p_I≈
->
VUI
.
num_unôs_ö_tick
 = 1000;

1548 
p_I≈
->
VUI
.
time_sˇÀ
 = ()
	`Êo‹
–
‰ame_øã
 * (p_I≈->VUI.
num_unôs_ö_tick
 << 1) + 0.5 );

1554 
p_I≈
->
VUI
.
num_unôs_ö_tick
 = 1000;

1555 
p_I≈
->
VUI
.
time_sˇÀ
 = ()
	`Êo‹
–
‰ame_øã
 * (p_I≈->VUI.
num_unôs_ö_tick
 << 1) );

1557 
	}
}

	@lencod/src/conformance.c

16 
	~"globÆ.h
"

17 
	~"c⁄f‹m™˚.h
"

21 c⁄° 
	gMaxFs
 [] = { 0, 0, 0, 0, 0, 0, 0, 0, 0, 99, 99, 396, 396, 396, 0, 0, 0, 0, 0, 0, 396, 792, 1620, 0, 0, 0, 0, 0, 0, 0,

24 c⁄° 
	gMöCR
 [] = { 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0,

26 c⁄° 
	gMaxBR
 [] = { 0, 0, 0, 0, 0, 0, 0, 0, 0, 64,128, 192, 384, 768, 0, 0, 0, 0, 0, 0,2000,4000,4000, 0, 0, 0, 0, 0, 0, 0,

28 c⁄° 
	gMaxCPB
[] = { 0, 0, 0, 0, 0, 0, 0, 0, 0,175,350, 500,1000,2000, 0, 0, 0, 0, 0, 0,2000,4000,4000, 0, 0, 0, 0, 0, 0, 0,

31 c⁄° 
	gMaxMBPS
[] = { 0, 0, 0, 0, 0, 0, 0, 0, 0, 1485, 1485, 3000, 6000, 11880, 0, 0, 0, 0, 0, 0, 11880, 19800, 20250, 0, 0, 0, 0, 0, 0, 0,

38 c⁄° 
	gLEVELVMVLIMIT
[17][6] =

59 c⁄° 
	gLEVELHMVLIMIT
[6] = { -2047, 2047, -4096, 4095, -8192, 8191};

67 
	$gëMaxFs
 (
ÀvñIdc
)

69 
ªt
;

71 i‡–(
ÀvñIdc
 < 9) || (levelIdc > 52))

72 
	`îr‹
 ("getMaxFs: Unknown LevelIdc", 500);

76 
ªt
 = 
MaxFs
[
ÀvñIdc
];

78 i‡–0 =
ªt
 )

79 
	`îr‹
 ("getMaxFs: Unknown LevelIdc", 500);

81  
ªt
;

82 
	}
}

90 
	$gëMaxMBPS
 (
ÀvñIdc
)

92 
ªt
;

94 i‡–(
ÀvñIdc
 < 9) || (levelIdc > 52))

95 
	`îr‹
 ("getMaxMBPS: Unknown LevelIdc", 500);

99 
ªt
 = 
MaxMBPS
[
ÀvñIdc
];

101 i‡–0 =
ªt
 )

102 
	`îr‹
 ("getMaxMBPS: Unknown LevelIdc", 500);

104  
ªt
;

105 
	}
}

113 
	$gëMöCR
 (
ÀvñIdc
)

115 
ªt
;

117 i‡–(
ÀvñIdc
 < 9) || (levelIdc > 52))

118 
	`îr‹
 ("getMinCR: Unknown LevelIdc", 500);

122 
ªt
 = 
MöCR
[
ÀvñIdc
];

124 i‡–0 =
ªt
 )

125 
	`îr‹
 ("getMinCR: Unknown LevelIdc", 500);

127  
ªt
;

128 
	}
}

136 
	$gëMaxBR
 (
ÀvñIdc
)

138 
ªt
;

140 i‡–(
ÀvñIdc
 < 9) || (levelIdc > 52))

141 
	`îr‹
 ("getMaxBR: Unknown LevelIdc", 500);

145 
ªt
 = 
MaxBR
[
ÀvñIdc
];

147 i‡–0 =
ªt
 )

148 
	`îr‹
 ("getMaxBR: Unknown LevelIdc", 500);

150  
ªt
;

151 
	}
}

159 
	$gëMaxCPB
 (
ÀvñIdc
)

161 
ªt
;

163 i‡–(
ÀvñIdc
 < 9) || (levelIdc > 52))

164 
	`îr‹
 ("getMaxCPB: Unknown LevelIdc", 500);

168 
ªt
 = 
MaxCPB
[
ÀvñIdc
];

170 i‡–0 =
ªt
 )

171 
	`îr‹
 ("getMaxCPB: Unknown LevelIdc", 500);

173  
ªt
;

174 
	}
}

182 
	$¥ofûe_check
(
I≈utP¨amëîs
 *
p_I≈
)

184 if((
p_I≈
->
ProfûeIDC
 !
BASELINE
 ) &&

185 (
p_I≈
->
ProfûeIDC
 !
MAIN
 ) &&

186 (
p_I≈
->
ProfûeIDC
 !
EXTENDED
 ) &&

187 (
p_I≈
->
ProfûeIDC
 !
FREXT_HP
 ) &&

188 (
p_I≈
->
ProfûeIDC
 !
FREXT_Hi10P
 ) &&

189 #i‡(
MVC_EXTENSION_ENABLE
)

190 (
p_I≈
->
ProfûeIDC
 !
MULTIVIEW_HIGH
 ) &&

191 (
p_I≈
->
ProfûeIDC
 !
STEREO_HIGH
 ) &&

193 (
p_I≈
->
ProfûeIDC
 !
FREXT_Hi422
 ) &&

194 (
p_I≈
->
ProfûeIDC
 !
FREXT_Hi444
 ) &&

195 (
p_I≈
->
ProfûeIDC
 !
FREXT_CAVLC444
 ))

197 #i‡(
MVC_EXTENSION_ENABLE
)

198 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Profile must be in\n\n 66 (Baseline),\n 77 (Main),\n 88 (Extended),\n 100 (High),\n 110 (High 10 or High 10 Intra)\n"

201 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Profile must be in\n\n 66 (Baseline),\n 77 (Main),\n 88 (Extended),\n 100 (High),\n 110 (High 10 or High 10 Intra)\n"

204 
	`îr‹
 (
îr‹ãxt
, 500);

207 i‡((
p_I≈
->
∑πôi⁄_mode
Ë&& (p_I≈->
symbﬁ_mode
==
CABAC
))

209 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "DataÖartitioningánd CABAC isÇot supported inányÖrofile.");

210 
	`îr‹
 (
îr‹ãxt
, 500);

213 i‡(
p_I≈
->
ªdund™t_pic_Êag
)

215 i‡(
p_I≈
->
ProfûeIDC
 !
BASELINE
)

217 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "RedundantÖicturesáre onlyállowed in BaselineÖrofile (ProfileIDC = 66).");

218 
	`îr‹
 (
îr‹ãxt
, 500);

222 i‡((
p_I≈
->
∑πôi⁄_mode
Ë&& (p_I≈->
ProfûeIDC
!=
EXTENDED
))

224 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "DataÖartitioning is onlyállowed in ExtendedÖrofile (ProfileIDC = 88).");

225 
	`îr‹
 (
îr‹ãxt
, 500);

228 i‡(
p_I≈
->
ChromaI¡øDißbÀ
 &&Ö_I≈->
Fa°CrI¡øDecisi⁄
)

230 
	`Ârötf
–
°dîr
, "\n Warning: ChromaIntraDisableánd FastCrIntraDecision cannot be combinedÅogether.\n Using only Chroma Intra DC mode.\n");

231 
p_I≈
->
Fa°CrI¡øDecisi⁄
=0;

234 i‡((
p_I≈
->
•_≥riodicôy
Ë&& (p_I≈->
ProfûeIDC
 !
EXTENDED
 ))

236 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "SPÖicturesáre onlyállowed in ExtendedÖrofile (ProfileIDC = 88).");

237 
	`îr‹
 (
îr‹ãxt
, 500);

241 i‡(
p_I≈
->
ProfûeIDC
 =
BASELINE
 )

243 i‡((
p_I≈
->
NumbîBFømes
 ||Ö_I≈->
BRefPi˘uªs
==2Ë&&Ö_I≈->
PRïœ˚BSli˚
 == 0)

245 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "B slicesáreÇotállowed in BaselineÖrofile (ProfileIDC = 66).");

246 
	`îr‹
 (
îr‹ãxt
, 500);

248 i‡(
p_I≈
->
WeighãdPªdi˘i⁄
)

250 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "WeightedÖrediction isÇotállowed in BaselineÖrofile (ProfileIDC = 66).");

251 
	`îr‹
 (
îr‹ãxt
, 500);

253 i‡(
p_I≈
->
WeighãdBùªdi˘i⁄
)

255 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "WeightedÖrediction isÇotállowed in BaselineÖrofile (ProfileIDC = 66).");

256 
	`îr‹
 (
îr‹ãxt
, 500);

258 i‡(
p_I≈
->
symbﬁ_mode
 =
CABAC
)

260 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "CABAC isÇotállowed in BaselineÖrofile (ProfileIDC = 66).");

261 
	`îr‹
 (
îr‹ãxt
, 500);

263 i‡((
p_I≈
->
PicI¡îœ˚
Ë||’_I≈->
MbI¡îœ˚
))

265 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "InterlaceÅoolsáreÇotállowed in BaselineÖrofile (ProfileIDC = 66).");

266 
	`îr‹
 (
îr‹ãxt
, 500);

268 i‡(
p_I≈
->
Gíî©eMu…ùÀPPS
 != 0)

270 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "GenerateMultiplePPS isÇot supported for BaselineÖrofile because itÑequiresÉnabling WeightedÖrediction.\n");

271 
	`îr‹
 (
îr‹ãxt
, 400);

276 i‡(
p_I≈
->
ProfûeIDC
 =
MAIN
 )

278 i‡(
p_I≈
->
num_¶i˚_groups_möus1
)

280 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "num_slice_groups_minus1>0 (FMO) isÇotállowed in MainÖrofile (ProfileIDC = 77).");

281 
	`îr‹
 (
îr‹ãxt
, 500);

286 i‡(
p_I≈
->
ProfûeIDC
 =
EXTENDED
 )

288 i‡(!
p_I≈
->
dúe˘In„ªn˚Fœg
)

290 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "direct_8x8_inference flag must beÉqualÅo 1 in ExtendedÖrofile (ProfileIDC = 88).");

291 
	`îr‹
 (
îr‹ãxt
, 500);

294 i‡(
p_I≈
->
symbﬁ_mode
 =
CABAC
)

296 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "CABAC isÇotállowed in ExtendedÖrofile (ProfileIDC = 88).");

297 
	`îr‹
 (
îr‹ãxt
, 500);

302 i‡–
p_I≈
->
£∑øã_cﬁour_∂™e_Êag
 )

304 if–
p_I≈
->
yuv_f‹m©
!=3 )

306 
	`Ârötf
–
°dîr
, "\nWarning: SeparateColourPlane has onlyÉffect in 4:4:4 chroma mode (YUVFormat=3),\n disabling SeparateColourPlane.");

307 
p_I≈
->
£∑øã_cﬁour_∂™e_Êag
 = 0;

310 i‡–
p_I≈
->
ChromaMEE«bÀ
 )

312 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "\nChromaMEEnable isÇotállowed when SeparateColourPlane isÉnabled.");

313 
	`îr‹
 (
îr‹ãxt
, 500);

318 i‡–
p_I≈
->
ProfûeIDC
 =
FREXT_CAVLC444
 )

320 i‡–
p_I≈
->
symbﬁ_mode
 !
CAVLC
 )

322 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "\nCABAC isÇotállowed in CAVLC 4:4:4 IntraÖrofile (ProfileIDC = 44).");

323 
	`îr‹
 (
îr‹ãxt
, 500);

325 i‡–!
p_I≈
->
I¡øProfûe
 )

327 
	`Ârötf
 (
°dîr
, "\nWarning: ProfileIDCÉqualÅo 44 impliesán Intra onlyÖrofile, setting IntraProfile = 1.");

328 
p_I≈
->
I¡øProfûe
 = 1;

333 i‡(
p_I≈
->
I¡øProfûe
 && (Ö_I≈->
ProfûeIDC
<
FREXT_HP
 &&Ö_I≈->ProfûeIDC!=
FREXT_CAVLC444
 ))

335 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "\nI¡øProfûêi†Ælowed o∆y wôh ProfûeIDC %dÅÿ%d.", 
FREXT_HP
, 
FREXT_Hi444
);

336 
	`îr‹
 (
îr‹ãxt
, 500);

339 i‡(
p_I≈
->
I¡øProfûe
 && !p_I≈->
idr_≥riod
)

341 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "\nIntraProfileÑequires IDRPeriod >= 1.");

342 
	`îr‹
 (
îr‹ãxt
, 500);

345 i‡(
p_I≈
->
I¡øProfûe
 &&Ö_I≈->
öåa_≥riod
 != 1)

347 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "\nIntraProfileÑequires IntraPeriodÉqual 1.");

348 
	`îr‹
 (
îr‹ãxt
, 500);

351 i‡(
p_I≈
->
I¡øProfûe
 &&Ö_I≈->
num_ªf_‰ames
)

353 
	`Ârötf
–
°dîr
, "\nWarning: Setting NumberReferenceFramesÅo 0 in IntraProfile.");

354 
p_I≈
->
num_ªf_‰ames
 = 0;

357 i‡(
p_I≈
->
I¡øProfûe
 =0 &&Ö_I≈->
num_ªf_‰ames
 == 0)

359 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "\nProfiles otherÅhan IntraProfileÑequire NumberReferenceFrames > 0.");

360 
	`îr‹
 (
îr‹ãxt
, 500);

362 
	}
}

370 
	$Àvñ_check
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

372 
PicSizeInMbs
 = ( (
p_I≈
->
ouçut
.
width
[0] + 
p_Vid
->
auto_¸›_right
Ë* (p_I≈->ouçut.
height
[0] +Ö_Vid->
auto_¸›_bŸtom
) ) >> 8;

373 
MBPro˚ssögR©e
 = (Ë(
PicSizeInMbs
 * 
p_I≈
->
ouçut
.
‰ame_øã
 + 0.5);

374 
˝bBrFa˘‹
 = ( 
p_I≈
->
ProfûeIDC
 >
FREXT_HP
 ) ? 1500 : 1200;

376 i‡–(
p_I≈
->
LevñIDC
>=30Ë&& (p_I≈->
dúe˘In„ªn˚Fœg
==0))

378 
	`Ârötf
–
°dîr
, "\nWarning: LevelIDC 3.0ándáboveÑequire direct_8x8_inferenceÅo be setÅo 1. Please check your settings.\n");

379 
p_I≈
->
dúe˘In„ªn˚Fœg
=1;

381 i‡–((
p_I≈
->
LevñIDC
<21Ë|| (p_I≈->LevñIDC>41)Ë&& (p_I≈->
PicI¡îœ˚
 > 0 ||Ö_I≈->
MbI¡îœ˚
 > 0) )

383 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "\nInterlace modes only supported for LevelIDC inÅheÑange of 21ánd 41. Please check your settings.\n");

384 
	`îr‹
 (
îr‹ãxt
, 500);

387 i‡–
PicSizeInMbs
 > 
	`gëMaxFs
(
p_I≈
->
LevñIDC
) )

389 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "\nPicSizeInMb†ex˚ed†maximumáŒowed sizê© s≥cifõd LevñId¯%.1f\n", (Ë
p_I≈
->
LevñIDC
 / 10.0);

390 
	`îr‹
 (
îr‹ãxt
, 500);

393 i‡(
p_I≈
->
I¡øProfûe
 && (
PicSizeInMbs
 > 1620Ë&&Ö_I≈->
¶i˚_mode
 != 1)

395 
	`îr‹
 ("\nIntraProfile with PicSizeInMbs > 1620Ñequires SliceModeÉqual 1.", 500);

398 i‡(
p_I≈
->
I¡øProfûe
 && (
PicSizeInMbs
 > 1620Ë&& ((Ì_I≈->
¶i˚_¨gumít
 > ( 
	`gëMaxFs
’_I≈->
LevñIDC
) >> 2 ) ) )

401 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "\nI¡øProfûêªquúe†Sli˚ArgumíàsmÆÀ∏‹ÉquÆÅÿ1/4 MaxF†© s≥cifõd LevñId¯%d.", 
p_I≈
->
LevñIDC
);

402 
	`îr‹
 (
îr‹ãxt
, 500);

405 i‡–
MBPro˚ssögR©e
 > 
	`gëMaxMBPS
(
p_I≈
->
LevñIDC
) )

407 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "\nMB Processing Rate (%d)Éxceeds maximumállowedÖrocessingÑate (%d)át specified LevelIdc %.1f\n",

408 
MBPro˚ssögR©e
, 
	`gëMaxMBPS
(
p_I≈
->
LevñIDC
), ()Ö_Inp->LevelIDC / 10.0);

409 
	`îr‹
 (
îr‹ãxt
, 500);

412 i‡–
p_I≈
->
bô_øã
 > ()(
˝bBrFa˘‹
 * 
	`gëMaxBR
’_I≈->
LevñIDC
)) )

414 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "\nBit Rate (%d)Éxceeds maximumállowed bitÑate (%d)át specified LevelIdc %.1f for NAL HRD\n",

415 
p_I≈
->
bô_øã
, 
˝bBrFa˘‹
 * 
	`gëMaxBR
’_I≈->
LevñIDC
), ()Ö_Inp->LevelIDC / 10.0);

416 
	`îr‹
 (
îr‹ãxt
, 500);

418 
	}
}

426 
	$upd©e_mv_limôs
(
VideoP¨amëîs
 *
p_Vid
, 
byã
 
is_fõld
)

428 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

429 
	`mem˝y
(
p_Vid
->
MaxVmvR
, 
LEVELVMVLIMIT
[p_Vid->
LevñIndex
], 6 * ());

430 
	`mem˝y
(
p_Vid
->
MaxHmvR
, 
LEVELHMVLIMIT
, 6 * ());

431 i‡(
is_fõld
)

433 
i
;

434 
i
 = 0; i < 6; i++)

435 
p_Vid
->
MaxVmvR
[
i
] = 
	`rshi·_∫d
(p_Vid->MaxVmvR[i], 1);

437 i‡(
p_I≈
->
U£MVLimôs
)

439 
p_Vid
->
MaxVmvR
[0] = 
	`imax
’_Vid->MaxVmvR[0], -(
p_I≈
->
SëMVYLimô
));

440 
p_Vid
->
MaxVmvR
[1] = 
	`imö
’_Vid->MaxVmvR[1], (
p_I≈
->
SëMVYLimô
));

441 
p_Vid
->
MaxVmvR
[2] = 
	`imax
’_Vid->MaxVmvR[2], -(
p_I≈
->
SëMVYLimô
 << 1));

442 
p_Vid
->
MaxVmvR
[3] = 
	`imö
’_Vid->MaxVmvR[3], (
p_I≈
->
SëMVYLimô
 << 1));

443 
p_Vid
->
MaxVmvR
[4] = 
	`imax
’_Vid->MaxVmvR[4], -(
p_I≈
->
SëMVYLimô
 << 2));

444 
p_Vid
->
MaxVmvR
[5] = 
	`imö
’_Vid->MaxVmvR[5], (
p_I≈
->
SëMVYLimô
 << 2));

446 
p_Vid
->
MaxHmvR
[0] = 
	`imax
’_Vid->MaxHmvR[0], -(
p_I≈
->
SëMVXLimô
));

447 
p_Vid
->
MaxHmvR
[1] = 
	`imö
’_Vid->MaxHmvR[1], (
p_I≈
->
SëMVXLimô
));

448 
p_Vid
->
MaxHmvR
[2] = 
	`imax
’_Vid->MaxHmvR[2], -(
p_I≈
->
SëMVXLimô
 << 1));

449 
p_Vid
->
MaxHmvR
[3] = 
	`imö
’_Vid->MaxHmvR[3], (
p_I≈
->
SëMVXLimô
 << 1));

450 
p_Vid
->
MaxHmvR
[4] = 
	`imax
’_Vid->MaxHmvR[4], -(
p_I≈
->
SëMVXLimô
 << 2));

451 
p_Vid
->
MaxHmvR
[5] = 
	`imö
’_Vid->MaxHmvR[5], (
p_I≈
->
SëMVXLimô
 << 2));

453 
	}
}

462 
	$˛ù_mv_ønge
(
VideoP¨amëîs
 *
p_Vid
, 
£¨ch_ønge
, 
MŸi⁄Ve˘‹
 *
mv
, 
ªs
)

464 
ªs
 <<= 1;

466 
mv
->
mv_x
 = (Ë
	`iClù3
–
p_Vid
->
MaxHmvR
[0 + 
ªs
] + 
£¨ch_ønge
,Ö_Vid->MaxHmvR[1 +Ñes] - search_range, mv->mv_x);

467 
mv
->
mv_y
 = (Ë
	`iClù3
–
p_Vid
->
MaxVmvR
[0 + 
ªs
] + 
£¨ch_ønge
,Ö_Vid->MaxVmvR[1 +Ñes] - search_range, mv->mv_y);

468 
	}
}

476 
	$ã°_˛ù_mvs
(
VideoP¨amëîs
 *
p_Vid
, 
MŸi⁄Ve˘‹
 *
mv
, 
Boﬁón
 
wrôe_mb
)

478 i‡((
mv
->
mv_x
 < 
p_Vid
->
MaxHmvR
[4]Ë|| (mv->mv_x >Ö_Vid->MaxHmvR[5]Ë|| (mv->
mv_y
 <Ö_Vid->
MaxVmvR
[4]) || (mv->mv_y >Ö_Vid->MaxVmvR[5]))

480 i‡(
wrôe_mb
 =
TRUE
)

481 
	`¥ötf
("W¨nög MV†(%d %dËwîêouào‡øngêx(%d %dËy(%d %d). Clùpög mv†bef‹êwrôög\n", 
mv
->
mv_x
, mv->
mv_y
, 
p_Vid
->
MaxHmvR
[4],Ö_Vid->MaxHmvR[5],Ö_Vid->
MaxVmvR
[4],Ö_Vid->MaxVmvR[5]);

482 
mv
->
mv_x
 = (Ë
	`iClù3
–
p_Vid
->
MaxHmvR
[4],Ö_Vid->MaxHmvR[5], mv->mv_x);

483 
mv
->
mv_y
 = (Ë
	`iClù3
–
p_Vid
->
MaxVmvR
[4],Ö_Vid->MaxVmvR[5], mv->mv_y);

485 
	}
}

493 
	$out_of_bounds_mvs
(
VideoP¨amëîs
 *
p_Vid
, c⁄° 
MŸi⁄Ve˘‹
 *
mv
)

495  ((
mv
->
mv_x
 < 
p_Vid
->
MaxHmvR
[4]Ë|| (mv->mv_x >Ö_Vid->MaxHmvR[5]Ë|| (mv->
mv_y
 <Ö_Vid->
MaxVmvR
[4]) || (mv->mv_y >Ö_Vid->MaxVmvR[5]));

496 
	}
}

498 
	$InvÆidWeightsF‹BiPªdi˘i⁄
(
Sli˚
 *
cuºSli˚
, 
Block8x8Info
* 
b8x8öfo
, 
mode
)

500 
£q_∑ømëî_£t_rb•_t
 *
a˘ive_•s
 = 
cuºSli˚
->active_sps;

501 
cur_blk
, 
cur_comp
;

502 
be°8x8l0ªf
, 
be°8x8l1ªf
;

503 
weight_sum
 = 0;

504 
övÆid_mode
 = 0;

505 *
wbp0
, *
wbp1
;

506 
cur_blk
 = 0; cur_blk < 4; cur_blk ++)

508 i‡(
b8x8öfo
->
be°
[
mode
][
cur_blk
].
pdú
 == 2)

510 
be°8x8l0ªf
 = (Ë
b8x8öfo
->
be°
[
mode
][
cur_blk
].
ªf
[
LIST_0
];

511 
be°8x8l1ªf
 = (Ë
b8x8öfo
->
be°
[
mode
][
cur_blk
].
ªf
[
LIST_1
];

512 
wbp0
 = &
cuºSli˚
->
wbp_weight
[
LIST_0
][
be°8x8l0ªf
][
be°8x8l1ªf
][0];

513 
wbp1
 = &
cuºSli˚
->
wbp_weight
[
LIST_1
][
be°8x8l0ªf
][
be°8x8l1ªf
][0];

515 
cur_comp
 = 0; cur_com∞< (
a˘ive_•s
->
chroma_f‹m©_idc
 =
YUV400
 ? 1 : 3) ; cur_comp ++)

517 
weight_sum
 = *
wbp0
++ + *
wbp1
++;

519 i‡(
weight_sum
 < -128 || weight_sum > 127)

521 
övÆid_mode
 = 1;

525 i‡(
övÆid_mode
 == 1)

529  
övÆid_mode
;

530 
	}
}

532 
	$InvÆidMŸi⁄Ve˘‹s
(
VideoP¨amëîs
 *
p_Vid
, 
Sli˚
 *
cuºSli˚
, 
Block8x8Info
* 
b8x8öfo
, 
mode
)

534 
cur_blk
;

535 
l0ªf
, 
l1ªf
;

536 
övÆid_mode
 = 0;

537 
i
, 
j
;

539 i‡(
mode
 > 
P8x8
)

540  
övÆid_mode
;

543 
cur_blk
 = 0; cur_blk < 4; cur_blk ++)

545 
i
 = (
cur_blk
 & 0x01) << 1;

546 
j
 = (
cur_blk
 >> 1) << 1;

547 
b8x8öfo
->
be°
[
mode
][
cur_blk
].
pdú
)

550 
l0ªf
 = (Ë
b8x8öfo
->
be°
[
mode
][
cur_blk
].
ªf
[
LIST_0
];

551 i‡(
	`out_of_bounds_mvs
(
p_Vid
, &
cuºSli˚
->
Æl_mv
 [
LIST_0
][
l0ªf
][
mode
][
j
][
i
]))

553 
övÆid_mode
 = 1;

554  
övÆid_mode
;

558 
l1ªf
 = (Ë
b8x8öfo
->
be°
[
mode
][
cur_blk
].
ªf
[
LIST_1
];

559 i‡(
	`out_of_bounds_mvs
(
p_Vid
, &
cuºSli˚
->
Æl_mv
 [
LIST_1
][
l1ªf
][
mode
][
j
][
i
]))

561 
övÆid_mode
 = 1;

562  
övÆid_mode
;

566 
l0ªf
 = (Ë
b8x8öfo
->
be°
[
mode
][
cur_blk
].
ªf
[
LIST_0
];

567 
l1ªf
 = (Ë
b8x8öfo
->
be°
[
mode
][
cur_blk
].
ªf
[
LIST_1
];

568 i‡(
	`out_of_bounds_mvs
(
p_Vid
, &
cuºSli˚
->
Æl_mv
 [
LIST_0
][
l0ªf
][
mode
][
j
][
i
]))

570 
övÆid_mode
 = 1;

571  
övÆid_mode
;

573 i‡(
	`out_of_bounds_mvs
(
p_Vid
, &
cuºSli˚
->
Æl_mv
 [
LIST_1
][
l1ªf
][
mode
][
j
][
i
]))

575 
övÆid_mode
 = 1;

576  
övÆid_mode
;

584  
övÆid_mode
;

585 
	}
}

587 
Boﬁón
 
	$CheckPªdi˘i⁄P¨ams
(
Ma¸oblock
 *
cuºMB
, 
Block8x8Info
 *
b8x8öfo
, 
mode
)

589 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

591 i‡(
mode
 =
P8x8
 && 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 =
TRUE
)

593 
i
;

595 
i
 = 0; i < 4; i++)

597 i‡(
b8x8öfo
->
be°
[
P8x8
][
i
].
mode
 != 4 && b8x8info->best[P8x8][i].mode != 0)

599  
FALSE
;

604 i‡(
	`InvÆidMŸi⁄Ve˘‹s
(
cuºSli˚
->
p_Vid
, cuºSli˚, 
b8x8öfo
, 
mode
))

605  
FALSE
;

607 i‡(
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
)

610 i‡(
cuºSli˚
->
weighãd_¥edi˘i⁄
 =1 && 
mode
 < 
P8x8
)

612 i‡(
	`InvÆidWeightsF‹BiPªdi˘i⁄
(
cuºSli˚
, 
b8x8öfo
, 
mode
))

613  
FALSE
;

617 i‡(
mode
==0)

619 
i
, 
j
;

620 
j
 = 
cuºMB
->
block_y
; j < currMB->block_y + 4;j++)

622 
i
 = 
cuºMB
->
block_x
; i < currMB->block_x + 4;i++)

624 i‡(
cuºSli˚
->
dúe˘_pdú
[
j
][
i
] < 0)

625  
FALSE
;

632  
TRUE
;

633 
	}
}

	@lencod/src/context_ini.c

16 
	#CONTEXT_INI_C


	)

18 
	~<m©h.h
>

20 
	~"globÆ.h
"

22 
	~"˘x_èbÀs.h
"

23 
	~"bürõncode.h
"

24 
	~"memÆloc.h
"

26 
	#DEFAULT_CTX_MODEL
 0

	)

27 
	#RELIABLE_COUNT
 32.0

	)

28 
	#FRAME_TYPES
 4

	)

29 
	#FIXED
 0

	)

32 c⁄° 
	g¥obabûôõs
[64] =

44 
	$¸óã_c⁄ãxt_mem‹y
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

46 
k
;

47 
num_mb
 = 
p_Vid
->
FømeSizeInMbs
;

48 
log2
 = 
	`log
(2.0);

50 
p_Vid
->
num_mb_≥r_¶i˚
 = (
p_I≈
->
¶i˚_mode
 =1 ?Ö_I≈->
¶i˚_¨gumít
 : 
num_mb
);

51 
p_Vid
->
numbî_of_¶i˚s
 = (
num_mb
 +Ö_Vid->
num_mb_≥r_¶i˚
 - 1) /Ö_Vid->num_mb_per_slice;

52 
	`gë_mem3Döt
(&
p_Vid
->
öôülized
, 3, 
FRAME_TYPES
,Ö_Vid->
numbî_of_¶i˚s
);

54 
	`mem£t
(&
p_Vid
->
öôülized
[0][0][0], 0, 3 * 
FRAME_TYPES
 *Ö_Vid->
numbî_of_¶i˚s
 * ());

55 
	`gë_mem3Döt
(&
p_Vid
->
modñNumbî
, 3, 
FRAME_TYPES
,Ö_Vid->
numbî_of_¶i˚s
);

58  
k
=0; k<64; k++ )

60 
p_Vid
->
¥obabûôy
[
k
 + 64] = 
¥obabûôõs
[k];

61 
p_Vid
->
¥obabûôy
[
k
] = 1.0 - 
¥obabûôõs
[63 - k];

62 
p_Vid
->
íå›y
 [
k
] = 
	`log
–p_Vid->
¥obabûôy
[ k] ) / 
log2
;

63 
p_Vid
->
íå›y
[127-
k
] = 
	`log
–
¥obabûôõs
[63 - k] ) / 
log2
;

64 
p_Vid
->
í‹m
 [
k
] =Ö_Vid->
íå›y
[k] -Ö_Vid->entropy[127-k];

65 
p_Vid
->
í‹m
[127 - 
k
] = -p_Vid->enorm[k];

67 
	}
}

69 
	$‰ì_c⁄ãxt_mem‹y
 (
VideoP¨amëîs
 *
p_Vid
)

71 
	`‰ì_mem3Döt
(
p_Vid
->
öôülized
);

72 
	`‰ì_mem3Döt
(
p_Vid
->
modñNumbî
);

73 
	}
}

75 
	#BIARI_CTX_INIT2
(
qp
, 
ii
,
jj
,
˘x
,
èb
Ë\

	)

77 
	gi
=0; i<
	gii
; i++) \

78 
	gj
=0; j<
	gjj
; j++) \

80 
büri_öô_c⁄ãxt
 (
qp
, &(
˘x
[
i
][
j
]), &(
èb
[i][j][0])); \

85 
ölöe
 
	$bö¨y_c⁄ãxt_öô1
(
qp
, 
jj
, 
BiC⁄ãxtTy≥
 *
˘x
, c⁄° 
èbÀ
[][2])

87 
j
;

88 
j
=0; j<
jj
; j++)

90 
	`büri_öô_c⁄ãxt
 (
qp
, &(
˘x
[
j
]), &(
èbÀ
[j][0]));

92 
	}
}

94 
ölöe
 
	$bö¨y_c⁄ãxt_öô2
(
qp
, 
ii
, 
jj
, 
BiC⁄ãxtTy≥
 
˘x
[][11], c⁄° 
èbÀ
[][11][2])

96 
i
, 
j
;

97 
i
 = 0; i < 
ii
; i++)

99 
j
 = 0; j < 
jj
; j++)

101 
	`büri_öô_c⁄ãxt
 (
qp
, &(
˘x
[
i
][
j
]), &(
èbÀ
[i][j][0]));

104 
	}
}

106 
	$SëCtxModñNumbî
 (
Sli˚
 *
cuºSli˚
)

108 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

109 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºSli˚
->p_Inp;

111 
‰ame_fõld
 = 
p_Vid
->
fõld_pi˘uª
;

112 
img_ty≥
 = 
cuºSli˚
->
¶i˚_ty≥
;

113 
˘x_numbî
 = 
cuºSli˚
->
°¨t_mb_ƒ
 / 
p_Vid
->
num_mb_≥r_¶i˚
;

115 if(
img_ty≥
 =
I_SLICE
)

117 
cuºSli˚
->
modñ_numbî
=
DEFAULT_CTX_MODEL
;

121 if(
p_I≈
->
c⁄ãxt_öô_mëhod
==
FIXED
)

123 
cuºSli˚
->
modñ_numbî
 = 
p_I≈
->model_number;

127 i‡(
p_Vid
->
öôülized
 [
‰ame_fõld
][
img_ty≥
][
˘x_numbî
])

129 
cuºSli˚
->
modñ_numbî
 = 
p_Vid
->
modñNumbî
[
‰ame_fõld
][
img_ty≥
][
˘x_numbî
];

131 i‡(
˘x_numbî
 && 
p_Vid
->
öôülized
[
‰ame_fõld
][
img_ty≥
][ctx_number-1])

133 
cuºSli˚
->
modñ_numbî
 = 
p_Vid
->
modñNumbî
[
‰ame_fõld
][
img_ty≥
][
˘x_numbî
-1];

137 
cuºSli˚
->
modñ_numbî
 = 
DEFAULT_CTX_MODEL
;

139 
	}
}

141 
	$öô_c⁄ãxts
 (
Sli˚
 *
cuºSli˚
)

143 
MŸi⁄InfoC⁄ãxts
* 
mc
 = 
cuºSli˚
->
mŸ_˘x
;

144 
TextuªInfoC⁄ãxts
* 
tc
 = 
cuºSli˚
->
ãx_˘x
;

145 
modñ_numbî
 = 
cuºSli˚
->model_number;

146 
qp
 = 
	`imax
(0, 
cuºSli˚
->qp);

147 
i
, 
j
;

149 i‡((
cuºSli˚
->
¶i˚_ty≥
 =
I_SLICE
Ë|| (cuºSli˚->¶i˚_ty≥ =
SI_SLICE
))

152 
	`BIARI_CTX_INIT2
 (
qp
, 3, 
NUM_MB_TYPE_CTX
, 
mc
->
mb_ty≥_c⁄ãxts
, 
INIT_MB_TYPE_I
[
modñ_numbî
]);

155 
	`bö¨y_c⁄ãxt_öô1
 (
qp
, 
NUM_TRANSFORM_SIZE_CTX
, 
tc
->
å™sf‹m_size_c⁄ãxts
, 
INIT_TRANSFORM_SIZE_I
[
modñ_numbî
][0]);

156 
	`bö¨y_c⁄ãxt_öô1
 (
qp
, 
NUM_IPR_CTX
, 
tc
->
ùr_c⁄ãxts
, 
INIT_IPR_I
[
modñ_numbî
][0]);

157 
	`bö¨y_c⁄ãxt_öô1
 (
qp
, 
NUM_CIPR_CTX
, 
tc
->
cùr_c⁄ãxts
, 
INIT_CIPR_I
[
modñ_numbî
][0]);

158 
	`BIARI_CTX_INIT2
 (
qp
, 3, 
NUM_CBP_CTX
, 
tc
->
cbp_c⁄ãxts
, 
INIT_CBP_I
[
modñ_numbî
]);

159 
	`BIARI_CTX_INIT2
 (
qp
, 
NUM_BLOCK_TYPES
, 
NUM_BCBP_CTX
, 
tc
->
bcbp_c⁄ãxts
, 
INIT_BCBP_I
[
modñ_numbî
]);

160 
	`bö¨y_c⁄ãxt_öô1
 (
qp
, 
NUM_DELTA_QP_CTX
, 
tc
->
dñè_qp_c⁄ãxts
,
INIT_DELTA_QP_I
[
modñ_numbî
][0]);

161 
	`BIARI_CTX_INIT2
 (
qp
, 
NUM_BLOCK_TYPES
, 
NUM_MAP_CTX
, 
tc
->
m≠_c⁄ãxts
[0], 
INIT_MAP_I
[
modñ_numbî
]);

162 
	`BIARI_CTX_INIT2
 (
qp
, 
NUM_BLOCK_TYPES
, 
NUM_LAST_CTX
, 
tc
->
œ°_c⁄ãxts
[0], 
INIT_LAST_I
[
modñ_numbî
]);

163 
	`BIARI_CTX_INIT2
 (
qp
, 
NUM_BLOCK_TYPES
, 
NUM_ONE_CTX
, 
tc
->
⁄e_c⁄ãxts
, 
INIT_ONE_I
[
modñ_numbî
]);

164 
	`BIARI_CTX_INIT2
 (
qp
, 
NUM_BLOCK_TYPES
, 
NUM_ABS_CTX
, 
tc
->
abs_c⁄ãxts
, 
INIT_ABS_I
[
modñ_numbî
]);

165 #i‡
ENABLE_FIELD_CTX


166 
	`bö¨y_c⁄ãxt_öô1
 (
qp
, 
NUM_MB_AFF_CTX
, 
tc
->
mb_aff_c⁄ãxts
, 
INIT_MB_AFF_I
[
modñ_numbî
][0]);

167 
	`BIARI_CTX_INIT2
 (
qp
, 
NUM_BLOCK_TYPES
, 
NUM_MAP_CTX
, 
tc
->
m≠_c⁄ãxts
[1], 
INIT_FLD_MAP_I
[
modñ_numbî
]);

168 
	`BIARI_CTX_INIT2
 (
qp
, 
NUM_BLOCK_TYPES
, 
NUM_LAST_CTX
, 
tc
->
œ°_c⁄ãxts
[1], 
INIT_FLD_LAST_I
[
modñ_numbî
]);

174 
	`BIARI_CTX_INIT2
 (
qp
, 3, 
NUM_MB_TYPE_CTX
, 
mc
->
mb_ty≥_c⁄ãxts
, 
INIT_MB_TYPE_P
[
modñ_numbî
]);

175 
	`BIARI_CTX_INIT2
 (
qp
, 2, 
NUM_B8_TYPE_CTX
, 
mc
->
b8_ty≥_c⁄ãxts
, 
INIT_B8_TYPE_P
[
modñ_numbî
]);

176 
	`BIARI_CTX_INIT2
 (
qp
, 2, 
NUM_MV_RES_CTX
, 
mc
->
mv_ªs_c⁄ãxts
, 
INIT_MV_RES_P
[
modñ_numbî
]);

177 
	`BIARI_CTX_INIT2
 (
qp
, 2, 
NUM_REF_NO_CTX
, 
mc
->
ªf_no_c⁄ãxts
, 
INIT_REF_NO_P
[
modñ_numbî
]);

180 
	`bö¨y_c⁄ãxt_öô1
(
qp
, 
NUM_TRANSFORM_SIZE_CTX
, 
tc
->
å™sf‹m_size_c⁄ãxts
, 
INIT_TRANSFORM_SIZE_P
[
modñ_numbî
][0]);

181 
	`bö¨y_c⁄ãxt_öô1
(
qp
, 
NUM_IPR_CTX
, 
tc
->
ùr_c⁄ãxts
, 
INIT_IPR_P
[
modñ_numbî
][0]);

182 
	`bö¨y_c⁄ãxt_öô1
(
qp
, 
NUM_CIPR_CTX
, 
tc
->
cùr_c⁄ãxts
, 
INIT_CIPR_P
[
modñ_numbî
][0]);

183 
	`BIARI_CTX_INIT2
 (
qp
, 3, 
NUM_CBP_CTX
, 
tc
->
cbp_c⁄ãxts
, 
INIT_CBP_P
[
modñ_numbî
]);

184 
	`BIARI_CTX_INIT2
 (
qp
, 
NUM_BLOCK_TYPES
, 
NUM_BCBP_CTX
, 
tc
->
bcbp_c⁄ãxts
, 
INIT_BCBP_P
[
modñ_numbî
]);

185 
	`bö¨y_c⁄ãxt_öô1
 (
qp
, 
NUM_DELTA_QP_CTX
, 
tc
->
dñè_qp_c⁄ãxts
,
INIT_DELTA_QP_P
[
modñ_numbî
][0]);

186 
	`BIARI_CTX_INIT2
 (
qp
, 
NUM_BLOCK_TYPES
, 
NUM_MAP_CTX
, 
tc
->
m≠_c⁄ãxts
[0], 
INIT_MAP_P
[
modñ_numbî
]);

187 
	`BIARI_CTX_INIT2
 (
qp
, 
NUM_BLOCK_TYPES
, 
NUM_LAST_CTX
, 
tc
->
œ°_c⁄ãxts
[0], 
INIT_LAST_P
[
modñ_numbî
]);

188 
	`BIARI_CTX_INIT2
 (
qp
, 
NUM_BLOCK_TYPES
, 
NUM_ONE_CTX
, 
tc
->
⁄e_c⁄ãxts
, 
INIT_ONE_P
[
modñ_numbî
]);

189 
	`BIARI_CTX_INIT2
 (
qp
, 
NUM_BLOCK_TYPES
, 
NUM_ABS_CTX
, 
tc
->
abs_c⁄ãxts
, 
INIT_ABS_P
[
modñ_numbî
]);

190 #i‡
ENABLE_FIELD_CTX


191 
	`bö¨y_c⁄ãxt_öô1
 (
qp
, 
NUM_MB_AFF_CTX
, 
tc
->
mb_aff_c⁄ãxts
, 
INIT_MB_AFF_P
[
modñ_numbî
][0]);

192 
	`BIARI_CTX_INIT2
 (
qp
, 
NUM_BLOCK_TYPES
, 
NUM_MAP_CTX
, 
tc
->
m≠_c⁄ãxts
[1], 
INIT_FLD_MAP_P
[
modñ_numbî
]);

193 
	`BIARI_CTX_INIT2
 (
qp
, 
NUM_BLOCK_TYPES
, 
NUM_LAST_CTX
, 
tc
->
œ°_c⁄ãxts
[1], 
INIT_FLD_LAST_P
[
modñ_numbî
]);

196 
	}
}

199 
	$XR©e
 (
VideoP¨amëîs
 *
p_Vid
, 
BiC⁄ãxtTy≥På
 
˘x
, c⁄° * 
modñ
)

201 
˘x_°©e
, 
mod_°©e
;

202 
weight
, 
xr
 = 0.0;

203 
qp
 = 
	`imax
(0, 
p_Vid
->qp);

205 
weight
 = 
	`dmö
 (1.0, ()
˘x
->
cou¡
/()
RELIABLE_COUNT
);

207 
mod_°©e
 = ((
modñ
[0]*
qp
)>>4)+model[1];

208 
mod_°©e
 = 
	`iClù3
(0, 127, mod_state);

209 
˘x_°©e
 = (
˘x
->
MPS
 ? 64 + ctx->
°©e
 : 63 - ctx->state);

211 
xr
 -
weight
 * (
p_Vid
->
¥obabûôy
[
˘x_°©e
] *Ö_Vid->
í‹m
[
mod_°©e
] +Ö_Vid->
íå›y
[127 - mod_state]);

213  
xr
;

214 
	}
}

228 
	#ADD_XRATE2
(
p_Vid
, 
ii
,
jj
,
˘x
,
èb
Ë\

	)

230 
	gi
=0; i<
	gii
; i++) \

231 
	gj
=0; j<
	gjj
; j++) \

233 
	gxr
 +
XR©e
 (
p_Vid
, &(
˘x
[
i
][
j
]), &(
èb
[i][j][0])); \

237 
	#ADD_XRATE1
(
p_Vid
, 
jj
,
˘x
,
èb
Ë\

	)

239 
	gj
=0; j<
	gjj
; j++) \

241 
	gxr
 +
XR©e
 (
p_Vid
, &(
˘x
[
j
]), &(
èb
[j][0])); \

245 
	$GëCtxModñNumbî
 (
Sli˚
 *
cuºSli˚
, * 
mnumbî
, 
MŸi⁄InfoC⁄ãxts
* 
mc
, 
TextuªInfoC⁄ãxts
* 
tc
)

247 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

248 
modñ
, 
j
, 
i
;

249 
xr
, 
mö_xr
 = 1e30;

251 i‡(
cuºSli˚
->
¶i˚_ty≥
 =
I_SLICE
)

253 
modñ
 = 0; modñ < 
NUM_CTX_MODELS_I
; model++)

255 
xr
 = 0.0;

257 
	`ADD_XRATE2
 (
p_Vid
, 3, 
NUM_MB_TYPE_CTX
, 
mc
->
mb_ty≥_c⁄ãxts
, 
INIT_MB_TYPE_I
 [
modñ
]);

260 
	`ADD_XRATE1
 (
p_Vid
, 
NUM_TRANSFORM_SIZE_CTX
, 
tc
->
å™sf‹m_size_c⁄ãxts
, 
INIT_TRANSFORM_SIZE_I
[
modñ
][0]);

261 
	`ADD_XRATE1
 (
p_Vid
, 
NUM_IPR_CTX
, 
tc
->
ùr_c⁄ãxts
, 
INIT_IPR_I
 [
modñ
][0]);

262 
	`ADD_XRATE1
 (
p_Vid
, 
NUM_CIPR_CTX
, 
tc
->
cùr_c⁄ãxts
, 
INIT_CIPR_I
[
modñ
][0]);

263 
	`ADD_XRATE2
 (
p_Vid
, 3, 
NUM_CBP_CTX
, 
tc
->
cbp_c⁄ãxts
, 
INIT_CBP_I
 [
modñ
]);

264 
	`ADD_XRATE2
 (
p_Vid
, 
NUM_BLOCK_TYPES
, 
NUM_BCBP_CTX
, 
tc
->
bcbp_c⁄ãxts
, 
INIT_BCBP_I
[
modñ
]);

265 
	`ADD_XRATE1
 (
p_Vid
, 
NUM_DELTA_QP_CTX
, 
tc
->
dñè_qp_c⁄ãxts
, 
INIT_DELTA_QP_I
[
modñ
][0]);

266 
	`ADD_XRATE2
 (
p_Vid
, 
NUM_BLOCK_TYPES
, 
NUM_MAP_CTX
, 
tc
->
m≠_c⁄ãxts
[0], 
INIT_MAP_I
 [
modñ
]);

267 
	`ADD_XRATE2
 (
p_Vid
, 
NUM_BLOCK_TYPES
, 
NUM_LAST_CTX
, 
tc
->
œ°_c⁄ãxts
[0], 
INIT_LAST_I
[
modñ
]);

268 
	`ADD_XRATE2
 (
p_Vid
, 
NUM_BLOCK_TYPES
, 
NUM_ONE_CTX
, 
tc
->
⁄e_c⁄ãxts
, 
INIT_ONE_I
 [
modñ
]);

269 
	`ADD_XRATE2
 (
p_Vid
, 
NUM_BLOCK_TYPES
, 
NUM_ABS_CTX
, 
tc
->
abs_c⁄ãxts
, 
INIT_ABS_I
 [
modñ
]);

270 #i‡
ENABLE_FIELD_CTX


271 
	`ADD_XRATE1
 (
p_Vid
, 
NUM_MB_AFF_CTX
, 
tc
->
mb_aff_c⁄ãxts
, 
INIT_MB_AFF_I
 [
modñ
][0]);

272 
	`ADD_XRATE2
 (
p_Vid
, 
NUM_BLOCK_TYPES
, 
NUM_MAP_CTX
, 
tc
->
m≠_c⁄ãxts
[1], 
INIT_FLD_MAP_I
 [
modñ
]);

273 
	`ADD_XRATE2
 (
p_Vid
, 
NUM_BLOCK_TYPES
, 
NUM_LAST_CTX
, 
tc
->
œ°_c⁄ãxts
[1], 
INIT_FLD_LAST_I
[
modñ
]);

276 i‡(
xr
 < 
mö_xr
)

278 
mö_xr
 = 
xr
;

279 *
mnumbî
 = 
modñ
;

285 
modñ
=0; modñ<
NUM_CTX_MODELS_P
; model++)

287 
xr
 = 0.0;

289 
	`ADD_XRATE2
 (
p_Vid
, 3, 
NUM_MB_TYPE_CTX
, 
mc
->
mb_ty≥_c⁄ãxts
, 
INIT_MB_TYPE_P
 [
modñ
]);

290 
	`ADD_XRATE2
 (
p_Vid
, 2, 
NUM_B8_TYPE_CTX
, 
mc
->
b8_ty≥_c⁄ãxts
, 
INIT_B8_TYPE_P
 [
modñ
]);

291 
	`ADD_XRATE2
 (
p_Vid
, 2, 
NUM_MV_RES_CTX
, 
mc
->
mv_ªs_c⁄ãxts
, 
INIT_MV_RES_P
 [
modñ
]);

292 
	`ADD_XRATE2
 (
p_Vid
, 2, 
NUM_REF_NO_CTX
, 
mc
->
ªf_no_c⁄ãxts
, 
INIT_REF_NO_P
 [
modñ
]);

295 
	`ADD_XRATE1
 (
p_Vid
, 
NUM_TRANSFORM_SIZE_CTX
, 
tc
->
å™sf‹m_size_c⁄ãxts
, 
INIT_TRANSFORM_SIZE_P
[
modñ
][0]);

296 
	`ADD_XRATE1
 (
p_Vid
, 
NUM_IPR_CTX
, 
tc
->
ùr_c⁄ãxts
, 
INIT_IPR_P
 [
modñ
][0]);

297 
	`ADD_XRATE1
 (
p_Vid
, 
NUM_CIPR_CTX
, 
tc
->
cùr_c⁄ãxts
, 
INIT_CIPR_P
 [
modñ
][0]);

298 
	`ADD_XRATE2
 (
p_Vid
, 3, 
NUM_CBP_CTX
, 
tc
->
cbp_c⁄ãxts
, 
INIT_CBP_P
 [
modñ
]);

299 
	`ADD_XRATE2
 (
p_Vid
, 
NUM_BLOCK_TYPES
, 
NUM_BCBP_CTX
, 
tc
->
bcbp_c⁄ãxts
, 
INIT_BCBP_P
 [
modñ
]);

300 
	`ADD_XRATE1
 (
p_Vid
, 
NUM_DELTA_QP_CTX
, 
tc
->
dñè_qp_c⁄ãxts
, 
INIT_DELTA_QP_P
[
modñ
][0]);

301 
	`ADD_XRATE2
 (
p_Vid
, 
NUM_BLOCK_TYPES
, 
NUM_MAP_CTX
, 
tc
->
m≠_c⁄ãxts
[0], 
INIT_MAP_P
 [
modñ
]);

302 
	`ADD_XRATE2
 (
p_Vid
, 
NUM_BLOCK_TYPES
, 
NUM_LAST_CTX
, 
tc
->
œ°_c⁄ãxts
[0], 
INIT_LAST_P
 [
modñ
]);

303 
	`ADD_XRATE2
 (
p_Vid
, 
NUM_BLOCK_TYPES
, 
NUM_ONE_CTX
, 
tc
->
⁄e_c⁄ãxts
, 
INIT_ONE_P
 [
modñ
]);

304 
	`ADD_XRATE2
 (
p_Vid
, 
NUM_BLOCK_TYPES
, 
NUM_ABS_CTX
, 
tc
->
abs_c⁄ãxts
, 
INIT_ABS_P
 [
modñ
]);

305 #i‡
ENABLE_FIELD_CTX


306 
	`ADD_XRATE1
 (
p_Vid
, 
NUM_MB_AFF_CTX
, 
tc
->
mb_aff_c⁄ãxts
, 
INIT_MB_AFF_P
 [
modñ
][0]);

307 
	`ADD_XRATE2
 (
p_Vid
, 
NUM_BLOCK_TYPES
, 
NUM_MAP_CTX
, 
tc
->
m≠_c⁄ãxts
[1], 
INIT_FLD_MAP_P
 [
modñ
]);

308 
	`ADD_XRATE2
 (
p_Vid
, 
NUM_BLOCK_TYPES
, 
NUM_LAST_CTX
, 
tc
->
œ°_c⁄ãxts
[1], 
INIT_FLD_LAST_P
 [
modñ
]);

311 i‡(
xr
 < 
mö_xr
)

313 
mö_xr
 = 
xr
;

314 *
mnumbî
 = 
modñ
;

318 
	}
}

320 #unde‡
ADD_XRATE2


321 #unde‡
ADD_XRATE1


324 
	$°‹e_c⁄ãxts
 (
Sli˚
 *
cuºSli˚
)

326 if–
cuºSli˚
->
p_I≈
->
c⁄ãxt_öô_mëhod
 )

328 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

329 
‰ame_fõld
 = 
p_Vid
->
fõld_pi˘uª
;

330 
img_ty≥
 = 
cuºSli˚
->
¶i˚_ty≥
;

331 
˘x_numbî
 = 
cuºSli˚
->
°¨t_mb_ƒ
 / 
p_Vid
->
num_mb_≥r_¶i˚
;

333 
p_Vid
->
öôülized
 [
‰ame_fõld
][
img_ty≥
][
˘x_numbî
] = 1;

334 
	`GëCtxModñNumbî
 (
cuºSli˚
, 
p_Vid
->
modñNumbî
[
‰ame_fõld
][
img_ty≥
] + 
˘x_numbî
, cuºSli˚->
mŸ_˘x
, cuºSli˚->
ãx_˘x
);

340 
	}
}

343 
	$upd©e_fõld_‰ame_c⁄ãxts
 (
VideoP¨amëîs
 *
p_Vid
, 
fõld
)

345 
i
, 
j
;

347 i‡(
fõld
)

350 
j
=0; j<
FRAME_TYPES
; j++)

352 
i
=0; i<
p_Vid
->
numbî_of_¶i˚s
; i++)

354 
p_Vid
->
öôülized
 [0][
j
][
i
] =Ö_Vid->initialized [1][j][i>>1];

355 
p_Vid
->
modñNumbî
[0][
j
][
i
] =Ö_Vid->modelNumber[1][j][i>>1];

362 
j
=0; j<
FRAME_TYPES
; j++)

364 
i
=0; i<((
p_Vid
->
numbî_of_¶i˚s
+1)>>1); i++)

366 
p_Vid
->
öôülized
 [1][
j
][
i
] =Ö_Vid->initialized [0][j][i<<1];

367 
p_Vid
->
modñNumbî
[1][
j
][
i
] =Ö_Vid->modelNumber[0][j][i<<1];

371 
	}
}

	@lencod/src/errdo.c

24 
	~"globÆ.h
"

25 
	~"memÆloc.h
"

26 
	~"ªfbuf.h
"

27 
	~"image.h
"

28 
	~"md_comm⁄.h
"

29 
	~"îrdo.h
"

30 
	~"îrdo_di°_mhyp.h
"

38 
	$Æloˇã_îrdo_mem
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

40 
mem‹y_size
 = 0;

43 
p_Vid
->
p_decs
 = (
Decodîs
 *Ë
	`mÆloc
((Decoders));

44 
mem‹y_size
 +
	`gë_mem3Döt
(&
p_Vid
->
p_decs
->
ªs_img
, 
MAX_PLANE
, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE);

45 
mem‹y_size
 +
	`gë_mem3Döt
(&
p_Vid
->
p_decs
->
ªs_mb_be°8x8
, 
MAX_PLANE
, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE);

47 
p_Vid
->
p_decs
->
RCD_be°Y_mb
 = 
NULL
;

48 
p_Vid
->
p_decs
->
RCD_be°Y_b8x8
 = 
NULL
;

49 
p_Vid
->
p_decs
->
MVCD_be°Y_mb
 = 
NULL
;

50 
p_Vid
->
p_decs
->
MVCD_be°Y_b8x8
 = 
NULL
;

51 
p_Vid
->
p_decs
->
Êag_be°Y_mb
 = 
NULL
;

52 
p_Vid
->
p_decs
->
Êag_be°Y_b8x8
 = 
NULL
;

53 
p_Vid
->
p_decs
->
Êag_wo_ªs
 = 
NULL
;

54 
p_Vid
->
p_decs
->
Êag_wo_ªs_be°Y_b8x8
 = 
NULL
;

55 
p_Vid
->
p_decs
->
å™s_di°_be°Y_mb
 = 
NULL
;

56 
p_Vid
->
p_decs
->
å™s_di°_be°Y_b8x8
 = 
NULL
;

57 
p_Vid
->
p_decs
->
å™s_di°_wo_ªs
 = 
NULL
;

58 
p_Vid
->
p_decs
->
å™s_di°_wo_ªs_be°Y_b8x8
 = 
NULL
;

59 
p_Vid
->
p_decs
->
å™s_îr_be°Y_mb
 = 
NULL
;

60 
p_Vid
->
p_decs
->
å™s_îr_be°Y_b8x8
 = 
NULL
;

61 
p_Vid
->
p_decs
->
å™s_îr_wo_ªs
 = 
NULL
;

62 
p_Vid
->
p_decs
->
å™s_îr_wo_ªs_be°Y_b8x8
 = 
NULL
;

63 
p_Vid
->
p_decs
->
dec_mb_¥ed
 = 
NULL
;

64 
p_Vid
->
p_decs
->
dec_mbY_be°
 = 
NULL
;

65 
p_Vid
->
p_decs
->
dec_mb_¥ed_be°8x8
 = 
NULL
;

66 
p_Vid
->
p_decs
->
dec_mbY_be°8x8
 = 
NULL
;

67 
p_Vid
->
p_decs
->
fú°_momít_be°Y_mb
 = 
NULL
;

68 
p_Vid
->
p_decs
->
fú°_momít_be°Y_b8x8
 = 
NULL
;

69 
p_Vid
->
p_decs
->
fú°_momít_¥ed_be°Y_b8x8
 = 
NULL
;

70 
p_Vid
->
p_decs
->
fú°_momít_¥ed
 = 
NULL
;

71 
p_Vid
->
p_decs
->
£c⁄d_momít_be°Y_mb
 = 
NULL
;

72 
p_Vid
->
p_decs
->
£c⁄d_momít_be°Y_b8x8
 = 
NULL
;

73 
p_Vid
->
p_decs
->
£c⁄d_momít_¥ed_be°Y_b8x8
 = 
NULL
;

74 
p_Vid
->
p_decs
->
£c⁄d_momít_¥ed
 = 
NULL
;

77 
p_I≈
->
de
)

79 
LLN
:

81 
mem‹y_size
 +
	`gë_mem3D≥l
(&
p_Vid
->
p_decs
->
dec_mb_¥ed
, 
p_I≈
->
NoOfDecodîs
, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE);

82 
mem‹y_size
 +
	`gë_mem3D≥l
(&
p_Vid
->
p_decs
->
dec_mbY_be°
, 
p_I≈
->
NoOfDecodîs
, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE);

83 
mem‹y_size
 +
	`gë_mem4D≥l
(&
p_Vid
->
p_decs
->
dec_mbY_be°8x8
, 2, 
p_I≈
->
NoOfDecodîs
, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE);

84 
mem‹y_size
 +
	`gë_mem4D≥l
(&
p_Vid
->
p_decs
->
dec_mb_¥ed_be°8x8
, 2, 
p_I≈
->
NoOfDecodîs
, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE);

89  
mem‹y_size
;

90 
	}
}

98 
	$‰ì_îrdo_mem
(
VideoP¨amëîs
 *
p_Vid
)

101 i‡(
p_Vid
->
p_decs
->
ªs_img
)

103 
	`‰ì_mem3Döt
(
p_Vid
->
p_decs
->
ªs_img
);

104 
p_Vid
->
p_decs
->
ªs_img
 = 
NULL
;

106 i‡(
p_Vid
->
p_decs
->
ªs_mb_be°8x8
)

108 
	`‰ì_mem3Döt
(
p_Vid
->
p_decs
->
ªs_mb_be°8x8
);

109 
p_Vid
->
p_decs
->
ªs_mb_be°8x8
 = 
NULL
;

113 i‡(
p_Vid
->
p_decs
->
RCD_be°Y_mb
)

115 
	`‰ì_mem2Döt
(
p_Vid
->
p_decs
->
RCD_be°Y_mb
);

116 
p_Vid
->
p_decs
->
RCD_be°Y_mb
 = 
NULL
;

118 i‡(
p_Vid
->
p_decs
->
RCD_be°Y_b8x8
)

120 
	`‰ì_mem3Döt
(
p_Vid
->
p_decs
->
RCD_be°Y_b8x8
);

121 
p_Vid
->
p_decs
->
RCD_be°Y_b8x8
 = 
NULL
;

123 i‡(
p_Vid
->
p_decs
->
MVCD_be°Y_mb
)

125 
	`‰ì_mem2Döt
(
p_Vid
->
p_decs
->
MVCD_be°Y_mb
);

126 
p_Vid
->
p_decs
->
MVCD_be°Y_mb
 = 
NULL
;

128 i‡(
p_Vid
->
p_decs
->
MVCD_be°Y_b8x8
)

130 
	`‰ì_mem3Döt
(
p_Vid
->
p_decs
->
MVCD_be°Y_b8x8
);

131 
p_Vid
->
p_decs
->
MVCD_be°Y_b8x8
 = 
NULL
;

133 i‡(
p_Vid
->
p_decs
->
Êag_be°Y_mb
)

135 
	`‰ì_mem2D
(
p_Vid
->
p_decs
->
Êag_be°Y_mb
);

136 
p_Vid
->
p_decs
->
Êag_be°Y_mb
 = 
NULL
;

138 i‡(
p_Vid
->
p_decs
->
Êag_be°Y_b8x8
)

140 
	`‰ì_mem3D
(
p_Vid
->
p_decs
->
Êag_be°Y_b8x8
);

141 
p_Vid
->
p_decs
->
Êag_be°Y_b8x8
 = 
NULL
;

143 i‡(
p_Vid
->
p_decs
->
Êag_wo_ªs
)

145 
	`‰ì_mem2D
(
p_Vid
->
p_decs
->
Êag_wo_ªs
);

146 
p_Vid
->
p_decs
->
Êag_wo_ªs
 = 
NULL
;

148 i‡(
p_Vid
->
p_decs
->
Êag_wo_ªs_be°Y_b8x8
)

150 
	`‰ì_mem3D
(
p_Vid
->
p_decs
->
Êag_wo_ªs_be°Y_b8x8
);

151 
p_Vid
->
p_decs
->
Êag_wo_ªs_be°Y_b8x8
 = 
NULL
;

153 i‡(
p_Vid
->
p_decs
->
å™s_di°_be°Y_mb
)

155 
	`‰ì_mem2Döt
(
p_Vid
->
p_decs
->
å™s_di°_be°Y_mb
);

156 
p_Vid
->
p_decs
->
å™s_di°_be°Y_mb
 = 
NULL
;

158 i‡(
p_Vid
->
p_decs
->
å™s_di°_be°Y_b8x8
)

160 
	`‰ì_mem3Döt
(
p_Vid
->
p_decs
->
å™s_di°_be°Y_b8x8
);

161 
p_Vid
->
p_decs
->
å™s_di°_be°Y_b8x8
 = 
NULL
;

163 i‡(
p_Vid
->
p_decs
->
å™s_di°_wo_ªs
)

165 
	`‰ì_mem2Döt
(
p_Vid
->
p_decs
->
å™s_di°_wo_ªs
);

166 
p_Vid
->
p_decs
->
å™s_di°_wo_ªs
 = 
NULL
;

168 i‡(
p_Vid
->
p_decs
->
å™s_di°_wo_ªs_be°Y_b8x8
)

170 
	`‰ì_mem3Döt
(
p_Vid
->
p_decs
->
å™s_di°_wo_ªs_be°Y_b8x8
);

171 
p_Vid
->
p_decs
->
å™s_di°_wo_ªs_be°Y_b8x8
 = 
NULL
;

173 i‡(
p_Vid
->
p_decs
->
å™s_îr_be°Y_mb
)

175 
	`‰ì_mem2Döt
(
p_Vid
->
p_decs
->
å™s_îr_be°Y_mb
);

176 
p_Vid
->
p_decs
->
å™s_îr_be°Y_mb
 = 
NULL
;

178 i‡(
p_Vid
->
p_decs
->
å™s_îr_be°Y_b8x8
)

180 
	`‰ì_mem3Döt
(
p_Vid
->
p_decs
->
å™s_îr_be°Y_b8x8
);

181 
p_Vid
->
p_decs
->
å™s_îr_be°Y_b8x8
 = 
NULL
;

183 i‡(
p_Vid
->
p_decs
->
å™s_îr_wo_ªs
)

185 
	`‰ì_mem2Döt
(
p_Vid
->
p_decs
->
å™s_îr_wo_ªs
);

186 
p_Vid
->
p_decs
->
å™s_îr_wo_ªs
 = 
NULL
;

188 i‡(
p_Vid
->
p_decs
->
å™s_îr_wo_ªs_be°Y_b8x8
)

190 
	`‰ì_mem3Döt
(
p_Vid
->
p_decs
->
å™s_îr_wo_ªs_be°Y_b8x8
);

191 
p_Vid
->
p_decs
->
å™s_îr_wo_ªs_be°Y_b8x8
 = 
NULL
;

195 i‡(
p_Vid
->
p_decs
->
dec_mb_¥ed
)

197 
	`‰ì_mem3D≥l
(
p_Vid
->
p_decs
->
dec_mb_¥ed
);

198 
p_Vid
->
p_decs
->
dec_mb_¥ed
 = 
NULL
;

200 i‡(
p_Vid
->
p_decs
->
dec_mbY_be°
)

202 
	`‰ì_mem3D≥l
(
p_Vid
->
p_decs
->
dec_mbY_be°
);

203 
p_Vid
->
p_decs
->
dec_mbY_be°
 = 
NULL
;

205 i‡(
p_Vid
->
p_decs
->
dec_mbY_be°8x8
)

207 
	`‰ì_mem4D≥l
(
p_Vid
->
p_decs
->
dec_mbY_be°8x8
);

208 
p_Vid
->
p_decs
->
dec_mb_¥ed_be°8x8
 = 
NULL
;

210 i‡(
p_Vid
->
p_decs
->
dec_mb_¥ed_be°8x8
)

212 
	`‰ì_mem4D≥l
(
p_Vid
->
p_decs
->
dec_mb_¥ed_be°8x8
);

213 
p_Vid
->
p_decs
->
dec_mbY_be°8x8
 = 
NULL
;

217 i‡(
p_Vid
->
p_decs
->
fú°_momít_be°Y_mb
)

219 
	`‰ì_mem2D≥l
(
p_Vid
->
p_decs
->
fú°_momít_be°Y_mb
);

220 
p_Vid
->
p_decs
->
fú°_momít_be°Y_mb
 = 
NULL
;

222 i‡(
p_Vid
->
p_decs
->
fú°_momít_be°Y_b8x8
)

224 
	`‰ì_mem3D≥l
(
p_Vid
->
p_decs
->
fú°_momít_be°Y_b8x8
);

225 
p_Vid
->
p_decs
->
fú°_momít_be°Y_b8x8
 = 
NULL
;

227 i‡(
p_Vid
->
p_decs
->
fú°_momít_¥ed_be°Y_b8x8
)

229 
	`‰ì_mem3D≥l
(
p_Vid
->
p_decs
->
fú°_momít_¥ed_be°Y_b8x8
);

230 
p_Vid
->
p_decs
->
fú°_momít_¥ed_be°Y_b8x8
 = 
NULL
;

232 i‡(
p_Vid
->
p_decs
->
fú°_momít_¥ed
)

234 
	`‰ì_mem2D≥l
(
p_Vid
->
p_decs
->
fú°_momít_¥ed
);

235 
p_Vid
->
p_decs
->
fú°_momít_¥ed
 = 
NULL
;

237 i‡(
p_Vid
->
p_decs
->
£c⁄d_momít_be°Y_mb
)

239 
	`‰ì_mem2Duöt16
(
p_Vid
->
p_decs
->
£c⁄d_momít_be°Y_mb
);

240 
p_Vid
->
p_decs
->
£c⁄d_momít_be°Y_mb
 = 
NULL
;

242 i‡(
p_Vid
->
p_decs
->
£c⁄d_momít_be°Y_b8x8
)

244 
	`‰ì_mem3Duöt16
(
p_Vid
->
p_decs
->
£c⁄d_momít_be°Y_b8x8
);

245 
p_Vid
->
p_decs
->
£c⁄d_momít_be°Y_b8x8
 = 
NULL
;

247 i‡(
p_Vid
->
p_decs
->
£c⁄d_momít_¥ed_be°Y_b8x8
)

249 
	`‰ì_mem3Duöt16
(
p_Vid
->
p_decs
->
£c⁄d_momít_¥ed_be°Y_b8x8
);

250 
p_Vid
->
p_decs
->
£c⁄d_momít_¥ed_be°Y_b8x8
 = 
NULL
;

252 i‡(
p_Vid
->
p_decs
->
£c⁄d_momít_¥ed
)

254 
	`‰ì_mem2Duöt16
(
p_Vid
->
p_decs
->
£c⁄d_momít_¥ed
);

255 
p_Vid
->
p_decs
->
£c⁄d_momít_¥ed
 = 
NULL
;

258 
	`‰ì_poöãr
–
p_Vid
->
p_decs
 );

259 
	}
}

270 
	$öô_îr‹_c⁄˚Æ
(
VideoP¨amëîs
 *
p_Vid
, 
c⁄˚Æmít_ty≥
)

272 
p_Vid
->
îr‹_c⁄˚Æ_pi˘uª
 = 
c›y_c⁄˚Æ_pi˘uª
;

273 
	}
}

282 
St‹abÀPi˘uª
* 
	$föd_√¨e°_ªf_pi˘uª
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
poc
)

284 
i
;

285 
mö_poc_diff
 = 1000;

286 
poc_diff
;

287 
St‹abÀPi˘uª
* 
ªfPic
 = 
NULL
;

289 
i
 = 0; i < 
p_Dpb
->
ªf_‰ames_ö_buf„r
; i++)

291 i‡(
p_Dpb
->
fs_ªf
[
i
]->
is_u£d
==3)

293 i‡((
p_Dpb
->
fs_ªf
[
i
]->
‰ame
->
u£d_f‹_ª„ªn˚
)&&(!p_Dpb->fs_ªf[i]->‰ame->
is_l⁄g_ãrm
))

295 
poc_diff
 = 
	`übs
(
p_Dpb
->
fs_ªf
[
i
]->
‰ame
->
poc
 -Öoc);

296 i‡(
poc_diff
 < 
mö_poc_diff
)

298 
ªfPic
 = 
p_Dpb
->
fs_ªf
[
i
]->
‰ame
;

299 
mö_poc_diff
 = 
poc_diff
;

304  
ªfPic
;

305 
	}
}

313 
	$îrdo_compuã_ªsidue
 (
Ma¸oblock
 *
cuºMB
, 
img≥l
 **
imgY
, **
ªs_img
, img≥»**
mb_¥ed
, 
b8block
, 
block_size
)

315 
i
,
j
;

316 
i0
 = (
b8block
 & 0x01)<<3, 
i1
 = i0+
block_size
;

317 
j0
 = (
b8block
 >> 1)<<3, 
j1
 = j0+
block_size
;

319 
i
 = 
i0
; i < 
i1
; i++)

321 
j
 = 
j0
; j < 
j1
; j++)

323 
ªs_img
[
j
][
i
] = ()
imgY
[j][
cuºMB
->
pix_x
 + i] - 
mb_¥ed
[j][i];

326 
	}
}

341 
	$îrdo_°‹e_be°_b8x8
(
Ma¸oblock
 *
cuºMB
, 
å™sf‹m8x8
, 
block
)

343 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

344 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

346 
p_I≈
->
de
)

348 
LLN
:

349 
	`îrdo_°‹e_be°_block_mu…ihyp
(
p_I≈
, 
p_Vid
->
p_decs
->
dec_mbY_be°8x8
[
å™sf‹m8x8
],Ö_Vid->
íc_pi˘uª
->
de_mem
->
p_dec_img
[0], 
block
, 
cuºMB
->
pix_x
, cuºMB->
pix_y
, 
BLOCK_SIZE_8x8
);

350 
	`îrdo_°‹e_be°_block_mu…ihyp
(
p_I≈
, 
p_Vid
->
p_decs
->
dec_mb_¥ed_be°8x8
[
å™sf‹m8x8
],Ö_Vid->p_decs->
dec_mb_¥ed
, 
block
, 0, 0, 
BLOCK_SIZE_8x8
);

355 
	}
}

371 
	$îrdo_gë_be°_b8x8
(
Ma¸oblock
 *
cuºMB
, 
å™sf‹m8x8
, 
block
)

373 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

374 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

376 
p_I≈
->
de
)

378 
LLN
:

379 
	`îrdo_gë_be°_block_mu…ihyp
(
cuºMB
, 
p_Vid
->
íc_pi˘uª
->
de_mem
->
p_dec_img
[0],Ö_Vid->
p_decs
->
dec_mbY_be°8x8
[
å™sf‹m8x8
], 
block
, 
BLOCK_SIZE_8x8
);

385 
	}
}

398 
	$îrdo_°‹e_be°_MB
(
Ma¸oblock
 *
cuºMB
)

400 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

401 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

403 
p_I≈
->
de
)

405 
LLN
:

406 
	`îrdo_°‹e_be°_block_mu…ihyp
(
p_I≈
, 
p_Vid
->
p_decs
->
dec_mbY_be°
,Ö_Vid->
íc_pi˘uª
->
de_mem
->
p_dec_img
[0], 0, 
cuºMB
->
pix_x
, cuºMB->
pix_y
, 
MB_BLOCK_SIZE
);

411 
	}
}

424 
	$îrdo_gë_be°_MB
(
Ma¸oblock
 *
cuºMB
)

426 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

427 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

429 
p_I≈
->
de
)

431 
LLN
:

432 
	`îrdo_gë_be°_block_mu…ihyp
(
cuºMB
, 
p_Vid
->
íc_pi˘uª
->
de_mem
->
p_dec_img
[0],Ö_Vid->
p_decs
->
dec_mbY_be°
, 0, 
MB_BLOCK_SIZE
);

438 
	}
}

451 
	$îrdo_gë_be°_P8x8
(
Ma¸oblock
 *
cuºMB
, 
å™sf‹m8x8
)

453 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

454 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

456 
p_I≈
->
de
)

458 
LLN
:

459 i‡(
p_Vid
->
p_decs
->
ªc_ty≥
 == 0)

461 
	`îrdo_gë_be°_block_mu…ihyp
(
cuºMB
, 
p_Vid
->
íc_pi˘uª
->
de_mem
->
p_dec_img
[0],Ö_Vid->
p_decs
->
dec_mb_¥ed_be°8x8
[
å™sf‹m8x8
], 0, 
MB_BLOCK_SIZE
);

465 
	`îrdo_gë_be°_block_mu…ihyp
(
cuºMB
, 
p_Vid
->
íc_pi˘uª
->
de_mem
->
p_dec_img
[0],Ö_Vid->
p_decs
->
dec_mbY_be°8x8
[
å™sf‹m8x8
], 0, 
MB_BLOCK_SIZE
);

471 
	}
}

481 
	$öô_di°‹ti⁄_e°im©i⁄
(
VideoP¨amëîs
 *
p_Vid
, 
de_Æg‹ôhm
)

483 
de_Æg‹ôhm
)

485 
LLN
:

486 
p_Vid
->
e°im©e_di°‹ti⁄
 = 
îrdo_di°‹ti⁄_e°im©i⁄_mu…ihyp
;

491 
	}
}

501 
	$îrdo_Æloc_°‹abÀ_pi˘uª
(
St‹abÀPi˘uª
 *
p
, 
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
size_x
, 
size_y
, 
size_x_¸
, 
size_y_¸
)

503 
Di°_E°m
 *
s
;

504 
dec
, 
ndec
, 
≈œ√
;

506 
p
->
de_mem
 = (
Di°_E°m
 *)
	`mÆloc
( (Dist_Estm) );

507 
s
 = 
p
->
de_mem
;

509 
s
->
ªs_c⁄_diff_Y
 = 
NULL
;

510 
s
->
ªs_c⁄_diff_UV
 = 
NULL
;

511 
s
->
MV_c⁄_diff_Y
 = 
NULL
;

512 
s
->
MV_c⁄_diff_UV
 = 
NULL
;

513 
s
->
îr‹_sign_Êag_Y
 = 
NULL
;

514 
s
->
îr‹_sign_Êag_UV
 = 
NULL
;

515 
s
->
å™smissi⁄_di°_Y
 = 
NULL
;

516 
s
->
å™smissi⁄_di°_UV
 = 
NULL
;

517 
s
->
å™smissi⁄_îr_Y
 = 
NULL
;

518 
s
->
å™smissi⁄_îr_UV
 = 
NULL
;

519 
s
->
dec_imgY
 = 
NULL
;

520 
s
->
dec_imgUV
 = 
NULL
;

521 
s
->
mb_îr‹_m≠
 = 
NULL
;

522 
s
->
fú°_momít_Y
 = 
NULL
;

523 
s
->
fú°_momít_UV
 = 
NULL
;

524 
s
->
£c⁄d_momít_Y
 = 
NULL
;

525 
s
->
£c⁄d_momít_UV
 = 
NULL
;

526 
≈œ√
 = 0;Çplane < 3;Çplane++)

528 
s
->
p_ªs_c⁄_diff
[
≈œ√
] = 
NULL
;

529 
s
->
p_MV_c⁄_diff
[
≈œ√
] = 
NULL
;

530 
s
->
p_îr‹_sign_Êag
[
≈œ√
] = 
NULL
;

531 
s
->
p_å™smissi⁄_di°
[
≈œ√
] = 
NULL
;

532 
s
->
p_å™smissi⁄_îr
[
≈œ√
] = 
NULL
;

533 
s
->
p_dec_img
[
≈œ√
] = 
NULL
;

534 
s
->
p_fú°_momít
[
≈œ√
] = 
NULL
;

535 
s
->
p_£c⁄d_momít
[
≈œ√
] = 
NULL
;

538 
p_I≈
->
de
)

540 
LLN
:

541 
ndec
 = 
p_I≈
->
NoOfDecodîs
;

543 i‡(
ndec
 == 0)

545 
	`¥ötf
("Number of decoders cannot be zero for LLNánd fast LLNálgorithms,ÑesettingÅo 30");

546 
ndec
 = 30;

548 
	`gë_mem3D
(&(
s
->
mb_îr‹_m≠
), 
ndec
, 
size_y
/
MB_BLOCK_SIZE
, 
size_x
/MB_BLOCK_SIZE);

549 
	`gë_mem3D≥l
(&(
s
->
dec_imgY
), 
ndec
, 
size_y
, 
size_x
);

552 i‡((
s
->
p_dec_img
[0] = (
img≥l
***)
	`ˇŒoc
(
ndec
,(img≥l**))Ë=
NULL
)

554 
	`no_mem_exô
("errdo.c:Ö_dec_img[0]");

557 i‡(
p_Vid
->
yuv_f‹m©
 !
YUV400
)

559 
	`gë_mem4D≥l
(&(
s
->
dec_imgUV
), 
ndec
, 2, 
size_y_¸
, 
size_x_¸
);

560 i‡((
s
->
p_dec_img
[1] = (
img≥l
***)
	`ˇŒoc
(
ndec
,(img≥l**))Ë=
NULL
)

562 
	`no_mem_exô
("errdo.c:Ö_dec_img[1]");

564 i‡((
s
->
p_dec_img
[2] = (
img≥l
***)
	`ˇŒoc
(
ndec
,(img≥l**))Ë=
NULL
)

566 
	`no_mem_exô
("errdo.c:Ö_dec_img[2]");

570 
dec
 = 0; de¯< 
ndec
; dec++)

572 
s
->
p_dec_img
[0][
dec
] = s->
dec_imgY
[dec];

575 i‡(
p_Vid
->
yuv_f‹m©
 !
YUV400
)

577 
dec
 = 0; de¯< 
ndec
; dec++)

579 
s
->
p_dec_img
[1][
dec
] = s->
dec_imgUV
[dec][0];

580 
s
->
p_dec_img
[2][
dec
] = s->
dec_imgUV
[dec][1];

588 
	}
}

598 
	$îrdo_‰ì_°‹abÀ_pi˘uª
(
St‹abÀPi˘uª
* 
s
)

600 
≈œ√
;

601 
Di°_E°m
 *
p
 = 
s
->
de_mem
;

603 i‡(
p
->
ªs_c⁄_diff_Y
)

605 
	`‰ì_mem2Döt
(
p
->
ªs_c⁄_diff_Y
);

606 
p
->
ªs_c⁄_diff_Y
 = 
NULL
;

608 i‡(
p
->
ªs_c⁄_diff_UV
)

610 
	`‰ì_mem3Döt
(
p
->
ªs_c⁄_diff_UV
);

611 
p
->
ªs_c⁄_diff_UV
 = 
NULL
;

613 
≈œ√
 = 0;Çplane < 3;Çplane++)

615 
p
->
p_ªs_c⁄_diff
[
≈œ√
] = 
NULL
;

618 i‡(
p
->
MV_c⁄_diff_Y
)

620 
	`‰ì_mem2Döt
(
p
->
MV_c⁄_diff_Y
);

621 
p
->
MV_c⁄_diff_Y
 = 
NULL
;

623 i‡(
p
->
MV_c⁄_diff_UV
)

625 
	`‰ì_mem3Döt
(
p
->
MV_c⁄_diff_UV
);

626 
p
->
MV_c⁄_diff_UV
 = 
NULL
;

628 
≈œ√
 = 0;Çplane < 3;Çplane++)

630 
p
->
p_MV_c⁄_diff
[
≈œ√
] = 
NULL
;

633 i‡(
p
->
îr‹_sign_Êag_Y
)

635 
	`‰ì_mem2D
(
p
->
îr‹_sign_Êag_Y
);

636 
p
->
îr‹_sign_Êag_Y
 = 
NULL
;

638 i‡(
p
->
îr‹_sign_Êag_UV
)

640 
	`‰ì_mem3D
(
p
->
îr‹_sign_Êag_UV
);

641 
p
->
îr‹_sign_Êag_UV
 = 
NULL
;

643 
≈œ√
 = 0;Çplane < 3;Çplane++)

645 
p
->
p_îr‹_sign_Êag
[
≈œ√
] = 
NULL
;

648 i‡(
p
->
å™smissi⁄_di°_Y
)

650 
	`‰ì_mem2Döt
(
p
->
å™smissi⁄_di°_Y
);

651 
p
->
å™smissi⁄_di°_Y
 = 
NULL
;

653 i‡(
p
->
å™smissi⁄_di°_UV
)

655 
	`‰ì_mem3Döt
(
p
->
å™smissi⁄_di°_UV
);

656 
p
->
å™smissi⁄_di°_UV
 = 
NULL
;

658 
≈œ√
 = 0;Çplane < 3;Çplane++)

660 
p
->
p_å™smissi⁄_di°
[
≈œ√
] = 
NULL
;

663 i‡(
p
->
å™smissi⁄_îr_Y
)

665 
	`‰ì_mem2Döt
(
p
->
å™smissi⁄_îr_Y
);

666 
p
->
å™smissi⁄_îr_Y
 = 
NULL
;

668 i‡(
p
->
å™smissi⁄_îr_UV
)

670 
	`‰ì_mem3Döt
(
p
->
å™smissi⁄_îr_UV
);

671 
p
->
å™smissi⁄_îr_UV
 = 
NULL
;

673 
≈œ√
 = 0;Çplane < 3;Çplane++)

675 
p
->
p_å™smissi⁄_îr
[
≈œ√
] = 
NULL
;

679 i‡(
p
->
dec_imgY
)

681 
	`‰ì_mem3D≥l
(
p
->
dec_imgY
);

682 
p
->
dec_imgY
 = 
NULL
;

684 i‡(
p
->
dec_imgUV
)

686 
	`‰ì_mem4D≥l
(
p
->
dec_imgUV
);

687 
p
->
dec_imgUV
 = 
NULL
;

689 
≈œ√
 = 0;Çplane < 3;Çplane++)

691 
	`‰ì_poöãr
(
p
->
p_dec_img
[
≈œ√
]);

693 i‡(
p
->
mb_îr‹_m≠
)

695 
	`‰ì_mem3D
(
p
->
mb_îr‹_m≠
);

696 
p
->
mb_îr‹_m≠
 = 
NULL
;

701 i‡(
p
->
fú°_momít_Y
)

703 
	`‰ì_mem2D≥l
(
p
->
fú°_momít_Y
);

704 
p
->
fú°_momít_Y
 = 
NULL
;

706 i‡(
p
->
fú°_momít_UV
)

708 
	`‰ì_mem3D≥l
(
p
->
fú°_momít_UV
);

709 
p
->
fú°_momít_UV
 = 
NULL
;

711 
≈œ√
 = 0;Çplane < 3;Çplane++)

713 
p
->
p_fú°_momít
[
≈œ√
] = 
NULL
;

715 i‡(
p
->
£c⁄d_momít_Y
)

717 
	`‰ì_mem2Duöt16
(
p
->
£c⁄d_momít_Y
);

718 
p
->
£c⁄d_momít_Y
 = 
NULL
;

720 i‡(
p
->
£c⁄d_momít_UV
)

722 
	`‰ì_mem3Duöt16
(
p
->
£c⁄d_momít_UV
);

723 
p
->
£c⁄d_momít_UV
 = 
NULL
;

725 
≈œ√
 = 0;Çplane < 3;Çplane++)

727 
p
->
p_£c⁄d_momít
[
≈œ√
] = 
NULL
;

730 
	`‰ì_poöãr
(
s
->
de_mem
);

731 
	}
}

	@lencod/src/errdo_dist_mhyp.c

24 
	~"globÆ.h
"

25 
	~"mbuf„r.h
"

26 
	~"îrdo.h
"

27 
	~"md_di°‹ti⁄.h
"

28 
	~"md_comm⁄.h
"

29 
	~"Œn_mc_¥edi˘i⁄.h
"

31 
add_ªsidue
 (
Ma¸oblock
 *
cuºMB
, 
St‹abÀPi˘uª
 *
íc_pic
, 
decodî
, 
∂
, 
block8x8
, 
x_size
, 
y_size
);

32 
Buûd_Sètus_M≠
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
byã
 **
s_m≠
);

33 
gë_¥edi˘ed_mb
(
Ma¸oblock
 *
cuºMB
, 
St‹abÀPi˘uª
 *
íc_pic
, 
decodî
);

34 
c›y_c⁄˚Æ_mb
 (
Ma¸oblock
 *
cuºMB
, 
St‹abÀPi˘uª
 *
íc_pic
, 
decodî
, 
mb_îr‹
, St‹abÀPi˘uª* 
ªfPic
);

35 
decode_⁄e_b8block
 (
Ma¸oblock
* 
cuºMB
, 
St‹abÀPi˘uª
 *
íc_pic
, 
decodî
, 
block8x8
, 
mv_mode
, 
¥ed_dú
);

36 
decode_⁄e_mb
 (
Ma¸oblock
* 
cuºMB
, 
St‹abÀPi˘uª
 *
íc
, 
decodî
);

38 
Upd©eDecodîs
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
St‹abÀPi˘uª
 *
íc_pic
);

39 
DeblockFøme
(
VideoP¨amëîs
 *
p_Vid
, 
img≥l
 **, imgpel ***);

48 
di°blk
 
	$îrdo_di°‹ti⁄_e°im©i⁄_mu…ihyp
(
Ma¸oblock
 *
cuºMB
, 
block
, 
block_size
, 
mode
, 
pdú
, 
di°blk
 
mö_rdco°
)

50 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

51 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

52 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

53 
£q_∑ømëî_£t_rb•_t
 *
a˘ive_•s
 = 
p_Vid
->active_sps;

55 
∑x
 = 8*(
block
 & 0x01);

56 
∑y
 = 8*(
block
 >> 1);

57 
di°blk
 
di°‹ti⁄
=0;

58 
di°blk
 
ãmp_di°
, 
ddi°‹ti⁄
 = 0;

59 
k
;

65 i‡(
mode
 >= 4 && mode <= 7)

70 
	`îrdo_compuã_ªsidue
 (
cuºMB
, &
p_Vid
->
íc_pi˘uª
->
p_img
[0][cuºMB->
pix_y
],Ö_Vid->
p_decs
->
ªs_img
[0], 
cuºSli˚
->
mb_¥ed
[0], 
block
, 8);

83 
k
 = 0; k < 
p_I≈
->
NoOfDecodîs
; k++)

85 
	`decode_⁄e_b8block
 (
cuºMB
, 
p_Vid
->
íc_pi˘uª
, 
k
, 
block
, 
mode
, 
pdú
);

86 
ddi°‹ti⁄
 +
	`compuã_SSE8x8
(&
p_Vid
->
pCurImg
[
cuºMB
->
›ix_y
 + 
∑y
], &p_Vid->
íc_pi˘uª
->
de_mem
->
p_dec_img
[0][
k
][cuºMB->›ix_y +Öay], cuºMB->
pix_x
 + 
∑x
, currMB->pix_x +Öax);

89 
ãmp_di°
 = 
mö_rdco°
 * 
p_I≈
->
NoOfDecodîs
;

91 i‡(
ddi°‹ti⁄
 > 
ãmp_di°
)

94  
DISTBLK_MAX
;

98 
di°‹ti⁄
 = (
di°blk
Ë(
ddi°‹ti⁄
 / 
p_I≈
->
NoOfDecodîs
);

100 i‡(
mode
 !
P8x8
)

102 
	`îrdo_compuã_ªsidue
 (
cuºMB
, &
p_Vid
->
íc_pi˘uª
->
p_cuº_img
[cuºMB->
pix_y
],Ö_Vid->
p_decs
->
ªs_img
[0], 
mode
 =
I16MB
 ? 
cuºSli˚
->
m¥_16x16
[0][ (ËcuºMB->
i16mode
] : cuºSli˚->
mb_¥ed
[0], 0, 16);

103 
k
 = 0; k<
p_I≈
->
NoOfDecodîs
 ;k++)

105 
	`decode_⁄e_mb
 (
cuºMB
, 
p_Vid
->
íc_pi˘uª
, 
k
);

106 
ddi°‹ti⁄
 +
	`compuã_SSE16x16
(&
p_Vid
->
pImgOrg
[0][
cuºMB
->
›ix_y
], &p_Vid->
íc_pi˘uª
->
de_mem
->
p_dec_img
[0][
k
][cuºMB->
pix_y
], cuºMB->
pix_x
, currMB->pix_x);

109 i‡(
mö_rdco°
 < 
DISTBLK_MAX
)

112 
ãmp_di°
 = 
mö_rdco°
 * 
p_I≈
->
NoOfDecodîs
;

116 
ãmp_di°
 = 
DISTBLK_MAX
;

118 i‡(
ddi°‹ti⁄
 > 
ãmp_di°
)

121  
DISTBLK_MAX
;

125 
di°‹ti⁄
 = (
di°blk
Ë(
ddi°‹ti⁄
 / 
p_I≈
->
NoOfDecodîs
);

127 i‡((
p_Vid
->
yuv_f‹m©
 !
YUV400
Ë&& (
a˘ive_•s
->
chroma_f‹m©_idc
 !
YUV444
))

130 
di°‹ti⁄
 +
	`compuã_SSE_¸
(&
p_Vid
->
pImgOrg
[1][
cuºMB
->
›ix_c_y
], &p_Vid->
íc_pi˘uª
->
imgUV
[0][cuºMB->
pix_c_y
], cuºMB->
pix_c_x
, cuºMB->pix_c_x,Ö_Vid->
mb_¸_size_y
,Ö_Vid->
mb_¸_size_x
);

131 
di°‹ti⁄
 +
	`compuã_SSE_¸
(&
p_Vid
->
pImgOrg
[2][
cuºMB
->
›ix_c_y
], &p_Vid->
íc_pi˘uª
->
imgUV
[1][cuºMB->
pix_c_y
], cuºMB->
pix_c_x
, cuºMB->pix_c_x,Ö_Vid->
mb_¸_size_y
,Ö_Vid->
mb_¸_size_x
);

136 
k
 = 0; k<
p_I≈
->
NoOfDecodîs
 ;k++)

138 
ddi°‹ti⁄
 +
	`compuã_SSE16x16
(&
p_Vid
->
pImgOrg
[0][
cuºMB
->
›ix_y
], &p_Vid->
íc_pi˘uª
->
de_mem
->
p_dec_img
[0][
k
][cuºMB->
pix_y
], cuºMB->
pix_x
, currMB->pix_x);

141 i‡(
mö_rdco°
 < 
DISTBLK_MAX
)

144 
ãmp_di°
 = 
mö_rdco°
 * 
p_I≈
->
NoOfDecodîs
;

148 
ãmp_di°
 = 
DISTBLK_MAX
;

150 i‡(
ddi°‹ti⁄
 > 
ãmp_di°
)

153  
DISTBLK_MAX
;

156 
di°‹ti⁄
 = (
di°blk
Ë(
ddi°‹ti⁄
 / 
p_I≈
->
NoOfDecodîs
);

158 i‡((
p_Vid
->
yuv_f‹m©
 !
YUV400
Ë&& (
a˘ive_•s
->
chroma_f‹m©_idc
 !
YUV444
))

161 
di°‹ti⁄
 +
	`compuã_SSE_¸
(&
p_Vid
->
pImgOrg
[1][
cuºMB
->
›ix_c_y
], &p_Vid->
íc_pi˘uª
->
imgUV
[0][cuºMB->
pix_c_y
], cuºMB->
pix_c_x
, cuºMB->pix_c_x,Ö_Vid->
mb_¸_size_y
,Ö_Vid->
mb_¸_size_x
);

162 
di°‹ti⁄
 +
	`compuã_SSE_¸
(&
p_Vid
->
pImgOrg
[2][
cuºMB
->
›ix_c_y
], &p_Vid->
íc_pi˘uª
->
imgUV
[1][cuºMB->
pix_c_y
], cuºMB->
pix_c_x
, cuºMB->pix_c_x,Ö_Vid->
mb_¸_size_y
,Ö_Vid->
mb_¸_size_x
);

166  
di°‹ti⁄
;

167 
	}
}

177 
	$Upd©eDecodîs
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
St‹abÀPi˘uª
 *
íc_pic
)

179 
k
;

180 
k
 = 0; k < 
p_I≈
->
NoOfDecodîs
; k++)

182 
	`Buûd_Sètus_M≠
(
p_Vid
, 
p_I≈
, 
íc_pic
->
de_mem
->
mb_îr‹_m≠
[
k
]);

183 
p_Vid
->
	`îr‹_c⁄˚Æ_pi˘uª
’_Vid, 
íc_pic
, 
k
);

184 
	`DeblockFøme
 (
p_Vid
, 
íc_pic
->
de_mem
->
p_dec_img
[0][
k
], 
NULL
);

186 
	}
}

200 
	$Buûd_Sètus_M≠
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
byã
 **
s_m≠
)

202 
i
,
j
,
¶i˚
=-1,
mb
=0,
jj
,
ii
;

203 
byã
 
∑ckë_lo°
=0;

205 
jj
 = 
p_Vid
->
height
/
MB_BLOCK_SIZE
;

206 
ii
 = 
p_Vid
->
width
/
MB_BLOCK_SIZE
;

208 
j
 = 0; j < 
jj
; j++)

210 
i
 = 0; i < 
ii
; i++)

212 i‡(!
p_I≈
->
¶i˚_mode
 || 
p_Vid
->
mb_d©a
[
mb
].
¶i˚_ƒ
 !
¶i˚
)

214 
∑ckë_lo°
=0;

215 i‡(()
	`ønd
()/()
RAND_MAX
*100 < 
p_I≈
->
LossR©eC
Ë
∑ckë_lo°
 += 3;

216 i‡(()
	`ønd
()/()
RAND_MAX
*100 < 
p_I≈
->
LossR©eB
Ë
∑ckë_lo°
 += 2;

217 i‡(()
	`ønd
()/()
RAND_MAX
*100 < 
p_I≈
->
LossR©eA
Ë
∑ckë_lo°
 = 1;

218 
¶i˚
++;

220 i‡(!
∑ckë_lo°
)

222 
s_m≠
[
j
][
i
]=0;

226 
s_m≠
[
j
][
i
] = 
∑ckë_lo°
;

227 if(
p_I≈
->
∑πôi⁄_mode
 =0Ë
s_m≠
[
j
][
i
]=1;

229 
mb
++;

232 
	}
}

241 
	$îrdo_°‹e_be°_block_mu…ihyp
(
I≈utP¨amëîs
 *
p_I≈
, 
img≥l
*** 
mbY
, img≥l*** 
dec_img
, 
block
, 
img_i
, 
img_j
, 
block_size
)

243 
i0
 = ((
block
&0x01)<<3);

244 
j0
 = ((
block
>>1)<<3);

245 
j
, 
k
;

246 
j1
 = 
j0
 + 
block_size
;

248 
k
 = 0; k < 
p_I≈
->
NoOfDecodîs
; k++)

250 
j
 = 
j0
; j < 
j1
; j++)

252 
	`mem˝y
(&
mbY
[
k
][
j
][
i0
], &
dec_img
[k][
img_j
+j][
img_i
+i0], 
block_size
 * (
img≥l
));

255 
	}
}

263 
	$îrdo_gë_be°_block_mu…ihyp
(
Ma¸oblock
 *
cuºMB
, 
img≥l
*** 
dec_img
, img≥l*** 
mbY
, 
block
, 
block_size
)

265 
i0
 = ((
block
&0x01)<<3);

266 
j0
 = ((
block
>>1)<<3);

267 
j
, 
k
;

268 
j1
 = 
j0
 + 
block_size
;

270 
k
 = 0; k < 
cuºMB
->
p_I≈
->
NoOfDecodîs
; k++)

272 
j
 = 
j0
; j < 
j1
; j++)

274 
	`mem˝y
(&
dec_img
[
k
][
cuºMB
->
pix_y
 + 
j
][cuºMB->
pix_x
+
i0
], &
mbY
[k][j][i0], 
block_size
 * (
img≥l
));

277 
	}
}

290 
	$decode_⁄e_mb
 (
Ma¸oblock
* 
cuºMB
, 
St‹abÀPi˘uª
 *
íc_pic
, 
decodî
)

292 
i0
, 
j
;

293 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

294 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

295 
img≥l
** 
curComp
;

296 
img≥l
** 
ﬁdComp
;

299 i‡(
cuºMB
->
mb_ty≥
 > 
P8x8
)

301 
curComp
 = &
íc_pic
->
de_mem
->
p_dec_img
[0][
decodî
][
cuºMB
->
pix_y
];

302 
ﬁdComp
 = &
íc_pic
->
p_cuº_img
[
cuºMB
->
pix_y
];

303 
i0
 = 
cuºMB
->
pix_x
;

304 
	`c›y_image_d©a_16x16
(
curComp
, 
ﬁdComp
, 
i0
, i0);

306 i‡((
cuºMB
->
mb_ty≥
 =0Ë&& (
cuºSli˚
->
¶i˚_ty≥
 !
B_SLICE
))

308 
	`gë_¥edi˘ed_mb
(
cuºMB
, 
íc_pic
, 
decodî
);

309 
curComp
 = &
íc_pic
->
de_mem
->
p_dec_img
[0][
decodî
][
cuºMB
->
pix_y
];

310 
j
 = 0; j < 
p_Vid
->
mb_size
[0][1]; j++)

312 
	`mem˝y
(&(
curComp
[
j
][
cuºMB
->
pix_x
]), &(
p_Vid
->
p_decs
->
dec_mb_¥ed
[
decodî
][j][0]),Ö_Vid->
mb_size
[0][0] * (
img≥l
));

317 
	`gë_¥edi˘ed_mb
(
cuºMB
, 
íc_pic
, 
decodî
);

318 
	`add_ªsidue
(
cuºMB
, 
íc_pic
, 
decodî
, 
PLANE_Y
, 0, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE);

320 
	}
}

329 
	$gë_¥edi˘ed_mb
(
Ma¸oblock
 *
cuºMB
, 
St‹abÀPi˘uª
 *
íc_pic
, 
decodî
)

331 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

332 
i
,
j
,
k
;

333 
block_size_x
, 
block_size_y
;

334 
mv_mode
, 
¥ed_dú
;

335 c⁄° 
byã
 
decode_block_sˇn
[16] = {0,1,4,5,2,3,6,7,8,9,12,13,10,11,14,15};

336 
block8x8
;

337 
k_°¨t
, 
k_íd
, 
k_öc
;

339 i‡(
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
 && !
cuºMB
->
mb_ty≥
)

341 
block_size_x
 = 
MB_BLOCK_SIZE
;

342 
block_size_y
 = 
MB_BLOCK_SIZE
;

343 
	`≥rf‹m_mc
(
cuºMB
, 
decodî
, 
PLANE_Y
, 
íc_pic
, 
LIST_0
, 0, 0,Énc_pic->
mv_öfo
, 0, 0, 
block_size_x
, 
block_size_y
, 0);

345 i‡(
cuºMB
->
mb_ty≥
 == 1)

347 
block_size_x
 = 
MB_BLOCK_SIZE
;

348 
block_size_y
 = 
MB_BLOCK_SIZE
;

349 
¥ed_dú
 = 
cuºMB
->
b8x8
[0].
pdú
;

350 
	`≥rf‹m_mc
(
cuºMB
, 
decodî
, 
PLANE_Y
, 
íc_pic
, 
¥ed_dú
, 1, 1,Énc_pic->
mv_öfo
, 0, 0, 
block_size_x
, 
block_size_y
, cuºMB->
b8x8
[0].
bùªd
);

352 i‡(
cuºMB
->
mb_ty≥
 == 2)

354 
block_size_x
 = 
MB_BLOCK_SIZE
;

355 
block_size_y
 = 8;

357 
block8x8
 = 0; block8x8 < 4; block8x8 += 2)

359 
¥ed_dú
 = 
cuºMB
->
b8x8
[
block8x8
].
pdú
;

360 
	`≥rf‹m_mc
(
cuºMB
, 
decodî
, 
PLANE_Y
, 
íc_pic
, 
¥ed_dú
, 2, 2,Énc_pic->
mv_öfo
, 0, 
block8x8
, 
block_size_x
, 
block_size_y
, cuºMB->
b8x8
[block8x8].
bùªd
);

363 i‡(
cuºMB
->
mb_ty≥
 == 3)

365 
block_size_x
 = 8;

366 
block_size_y
 = 16;

368 
block8x8
 = 0; block8x8 < 2; block8x8++)

370 
i
 = 
block8x8
<<1;

371 
j
 = 0;

372 
¥ed_dú
 = 
cuºMB
->
b8x8
[
block8x8
].
pdú
;

373 
	`≥rf‹m_mc
(
cuºMB
, 
decodî
, 
PLANE_Y
, 
íc_pic
, 
¥ed_dú
, 3, 3,Énc_pic->
mv_öfo
, 
i
, 
j
, 
block_size_x
, 
block_size_y
, cuºMB->
b8x8
[
block8x8
].
bùªd
);

378 
block8x8
 = 0; block8x8 < 4; block8x8++)

380 
mv_mode
 = 
cuºMB
->
b8x8
[
block8x8
].
mode
;

381 
¥ed_dú
 = 
cuºMB
->
b8x8
[
block8x8
].
pdú
;

383 
k_°¨t
 = (
block8x8
 << 2);

384 
k_öc
 = (
mv_mode
 == 5) ? 2 : 1;

386 i‡(
mv_mode
 == 0)

388 
k_íd
 = 
k_°¨t
 + 1;

389 
block_size_x
 = 8;

390 
block_size_y
 = 8;

394 
k_íd
 = (
mv_mode
 =4Ë? 
k_°¨t
 + 1 : ((mv_modê=7Ë? k_°¨à+ 4 : k_°¨à+ 
k_öc
 + 1);

395 
block_size_x
 = ( 
mv_mode
 == 5 || mv_mode == 4 ) ? 8 : 4;

396 
block_size_y
 = ( 
mv_mode
 == 6 || mv_mode == 4 ) ? 8 : 4;

399 
k
 = 
k_°¨t
; k < 
k_íd
; k +
k_öc
)

401 
i
 = (
decode_block_sˇn
[
k
] & 3);

402 
j
 = ((
decode_block_sˇn
[
k
] >> 2) & 3);

403 
	`≥rf‹m_mc
(
cuºMB
, 
decodî
, 
PLANE_Y
, 
íc_pic
, 
¥ed_dú
, 
mv_mode
, mv_mode,Énc_pic->
mv_öfo
, 
i
, 
j
, 
block_size_x
, 
block_size_y
, cuºMB->
b8x8
[
block8x8
].
bùªd
);

407 
	}
}

421 
	$decode_⁄e_b8block
 (
Ma¸oblock
* 
cuºMB
, 
St‹abÀPi˘uª
 *
íc_pic
, 
decodî
, 
block8x8
, 
mv_mode
, 
¥ed_dú
)

423 
i
,
j
,
k
;

424 
block_size_x
, 
block_size_y
;

425 
i0
 = (
block8x8
 & 0x01)<<3;

426 
j0
 = (
block8x8
 >> 1)<<3, 
j1
 = j0+8;

428 
img≥l
 **
curComp
;

429 
img≥l
 **
ﬁdComp
;

430 
k_°¨t
, 
k_íd
, 
k_öc
;

431 c⁄° 
byã
 
decode_block_sˇn
[16] = {0,1,4,5,2,3,6,7,8,9,12,13,10,11,14,15};

433 i‡(
mv_mode
 > 8)

435 
j
 = 
j0
; j < 
j1
; j++)

437 
curComp
 = &
íc_pic
->
de_mem
->
p_dec_img
[0][
decodî
][
cuºMB
->
pix_y
];

438 
ﬁdComp
 = &
íc_pic
->
p_cuº_img
[
cuºMB
->
pix_y
];

439 
	`mem˝y
(&(
curComp
[
j
][
i0
]), &(
ﬁdComp
[j][i0]), (
img≥l
)*8);

444 
k_°¨t
 = (
block8x8
 << 2);

446 i‡(
mv_mode
 == 0)

448 
k_öc
 = 1;

449 
k_íd
 = 
k_°¨t
+1;

450 
block_size_x
 = 8;

451 
block_size_y
 = 8;

456 
k_öc
 = (
mv_mode
 == 5) ? 2 : 1;

457 
k_íd
 = (
mv_mode
 =4Ë? 
k_°¨t
 + 1 : ((mv_modê=7Ë? k_°¨à+ 4 : k_°¨à+ 
k_öc
 + 1);

459 
block_size_x
 = ( 
mv_mode
 == 5 || mv_mode == 4 ) ? 8 : 4;

460 
block_size_y
 = ( 
mv_mode
 == 6 || mv_mode == 4 ) ? 8 : 4;

463 
k
 = 
k_°¨t
; k < 
k_íd
; k +
k_öc
)

465 
i
 = (
decode_block_sˇn
[
k
] & 3);

466 
j
 = ((
decode_block_sˇn
[
k
] >> 2) & 3);

467 
	`≥rf‹m_mc
(
cuºMB
, 
decodî
, 
PLANE_Y
, 
íc_pic
, 
¥ed_dú
, 
mv_mode
, mv_mode,Énc_pic->
mv_öfo
, 
i
, 
j
, 
block_size_x
, 
block_size_y
, cuºMB->
b8x8
[
block8x8
].
bùªd
);

470 
	`add_ªsidue
(
cuºMB
, 
íc_pic
, 
decodî
, 
PLANE_Y
, 
block8x8
, 8, 8);

472 
	}
}

480 
	$add_ªsidue
 (
Ma¸oblock
 *
cuºMB
, 
St‹abÀPi˘uª
 *
íc_pic
, 
decodî
, 
∂
, 
block8x8
, 
x_size
, 
y_size
)

482 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

483 
max_≥l_vÆue
 = 
cuºMB
->
p_Vid
->
max_≥l_vÆue_comp
[
∂
];

484 
i
,
j
;

485 
i0
 = (
block8x8
 & 0x01)<<3, 
i1
 = i0 + 
x_size
;

486 
j0
 = (
block8x8
 >> 1)<<3, 
j1
 = j0 + 
y_size
;

488 
img≥l
 **
p_dec_img
 = &
íc_pic
->
de_mem
->p_dec_img[
∂
][
decodî
][
cuºMB
->
pix_y
];

489 **
ªs_img
 = 
p_Vid
->
p_decs
->res_img[0];

490 
img≥l
** 
m¥
 = 
p_Vid
->
p_decs
->
dec_mb_¥ed
[
decodî
];

492 
j
 = 
j0
; j < 
j1
; j++)

494 
i
 = 
i0
; i < 
i1
; i++)

496 
p_dec_img
[
j
][
cuºMB
->
pix_x
 + 
i
] = (
img≥l
Ë
	`iClù3
(0, 
max_≥l_vÆue
, (
m¥
[j][i] + 
ªs_img
[j][i]));

499 
	}
}

511 
	$gë_¥edi˘ed_c⁄˚Æmít_mb
(
Ma¸oblock
* 
cuºMB
, 
St‹abÀPi˘uª
* 
íc_pic
, 
decodî
)

513 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

514 
i
,
j
,
k
;

515 
block_size_x
, 
block_size_y
;

516 
mv_mode
, 
¥ed_dú
;

517 c⁄° 
byã
 
decode_block_sˇn
[16] = {0,1,4,5,2,3,6,7,8,9,12,13,10,11,14,15};

518 
block8x8
;

519 
k_°¨t
, 
k_íd
, 
k_öc
;

521 i‡(
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
 && !
cuºMB
->
mb_ty≥
)

523 
block_size_x
 = 
MB_BLOCK_SIZE
;

524 
block_size_y
 = 
MB_BLOCK_SIZE
;

525 
	`≥rf‹m_mc_c⁄˚Æmít
(
cuºMB
, 
decodî
, 
PLANE_Y
, 
íc_pic
, 
LIST_0
, 0, 0,Énc_pic->
mv_öfo
, 0, 0, 
block_size_x
, 
block_size_y
);

527 i‡(
cuºMB
->
mb_ty≥
 == 1)

529 
block_size_x
 = 
MB_BLOCK_SIZE
;

530 
block_size_y
 = 
MB_BLOCK_SIZE
;

531 
¥ed_dú
 = 
cuºMB
->
b8x8
[0].
pdú
;

532 
	`≥rf‹m_mc_c⁄˚Æmít
(
cuºMB
, 
decodî
, 
PLANE_Y
, 
íc_pic
, 
¥ed_dú
, 1, 1,Énc_pic->
mv_öfo
, 0, 0, 
block_size_x
, 
block_size_y
);

534 i‡(
cuºMB
->
mb_ty≥
 == 2)

536 
block_size_x
 = 
MB_BLOCK_SIZE
;

537 
block_size_y
 = 8;

539 
block8x8
 = 0; block8x8 < 4; block8x8 += 2)

541 
¥ed_dú
 = 
cuºMB
->
b8x8
[
block8x8
].
pdú
;

542 
	`≥rf‹m_mc_c⁄˚Æmít
(
cuºMB
, 
decodî
, 
PLANE_Y
, 
íc_pic
, 
¥ed_dú
, 2, 2,Énc_pic->
mv_öfo
, 0, 
block8x8
, 
block_size_x
, 
block_size_y
);

545 i‡(
cuºMB
->
mb_ty≥
 == 3)

547 
block_size_x
 = 8;

548 
block_size_y
 = 16;

550 
block8x8
 = 0; block8x8 < 2; block8x8++)

552 
i
 = 
block8x8
<<1;

553 
j
 = 0;

554 
¥ed_dú
 = 
cuºMB
->
b8x8
[
block8x8
].
pdú
;

555 
	`≥rf‹m_mc_c⁄˚Æmít
(
cuºMB
, 
decodî
, 
PLANE_Y
, 
íc_pic
, 
¥ed_dú
, 3, 3,Énc_pic->
mv_öfo
, 
i
, 
j
, 
block_size_x
, 
block_size_y
);

560 
block8x8
 = 0; block8x8 < 4; block8x8++)

562 
mv_mode
 = 
cuºMB
->
b8x8
[
block8x8
].
mode
;

563 
¥ed_dú
 = 
cuºMB
->
b8x8
[
block8x8
].
pdú
;

565 
k_°¨t
 = (
block8x8
 << 2);

566 
k_öc
 = (
mv_mode
 == 5) ? 2 : 1;

568 i‡(
mv_mode
 == 0)

570 
k_íd
 = 
k_°¨t
 + 1;

571 
block_size_x
 = 8;

572 
block_size_y
 = 8;

576 
k_íd
 = (
mv_mode
 =4Ë? 
k_°¨t
 + 1 : ((mv_modê=7Ë? k_°¨à+ 4 : k_°¨à+ 
k_öc
 + 1);

577 
block_size_x
 = ( 
mv_mode
 == 5 || mv_mode == 4 ) ? 8 : 4;

578 
block_size_y
 = ( 
mv_mode
 == 6 || mv_mode == 4 ) ? 8 : 4;

581 
k
 = 
k_°¨t
; k < 
k_íd
; k +
k_öc
)

583 
i
 = (
decode_block_sˇn
[
k
] & 3);

584 
j
 = ((
decode_block_sˇn
[
k
] >> 2) & 3);

585 
	`≥rf‹m_mc_c⁄˚Æmít
(
cuºMB
, 
decodî
, 
PLANE_Y
, 
íc_pic
, 
¥ed_dú
, 
mv_mode
, mv_mode,Énc_pic->
mv_öfo
, 
i
, 
j
, 
block_size_x
, 
block_size_y
);

589 
	}
}

601 
	$c›y_c⁄˚Æ_pi˘uª
(
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
íc_pic
, 
decodî
)

603 
mb
;

604 
Ma¸oblock
* 
cuºMB
;

605 
mb_îr‹
;

606 
byã
** 
mb_îr‹_m≠
 = 
íc_pic
->
de_mem
->mb_îr‹_m≠[
decodî
];

607 
St‹abÀPi˘uª
* 
ªfPic
;

608 
BlockPos
 *
PicPos
 = 
p_Vid
->PicPos;

610 
ªfPic
 = 
	`föd_√¨e°_ªf_pi˘uª
(
p_Vid
->
p_Dpb_œyî
[0], 
íc_pic
->
poc
);

611 
mb
 = 0; mb < 
p_Vid
->
PicSizeInMbs
; mb++)

613 
cuºMB
 = &
p_Vid
->
mb_d©a
[
mb
];

614 
cuºMB
->
mb_x
 = 
PicPos
[
mb
].
x
;

615 
cuºMB
->
mb_y
 = 
PicPos
[
mb
].
y
;

616 
mb_îr‹
 = 
mb_îr‹_m≠
[
cuºMB
->
mb_y
][cuºMB->
mb_x
];

617 i‡(
mb_îr‹
)

619 
cuºMB
->
block_x
 = cuºMB ->
mb_x
 << 2;

620 
cuºMB
->
block_y
 = cuºMB->
mb_y
 << 2;

621 
cuºMB
->
pix_x
 = cuºMB->
block_x
 << 2;

622 
cuºMB
->
pix_y
 = cuºMB->
block_y
 << 2;

623 
	`c›y_c⁄˚Æ_mb
(
cuºMB
, 
íc_pic
, 
decodî
, 
mb_îr‹
, 
ªfPic
);

626 
	}
}

634 
	$c›y_c⁄˚Æ_mb
(
Ma¸oblock
* 
cuºMB
, 
St‹abÀPi˘uª
 *
íc_pic
, 
decodî
, 
mb_îr‹
, St‹abÀPi˘uª* 
ªfPic
)

636 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

637 
j
, 
i
, 
i0
 = 
cuºMB
->
pix_x
;

638 
img≥l
** 
c⁄˚Æed_img
 = &(
íc_pic
->
de_mem
->
p_dec_img
[0][
decodî
][
cuºMB
->
pix_y
]);

639 
img≥l
** 
ªf_img
;

641 i‡(
mb_îr‹
 =1 || (mb_îr‹ !3 && 
cuºMB
->
mb_ty≥
 > 
P8x8
))

643 i‡(
ªfPic
 !
NULL
)

645 
ªf_img
 = &(
ªfPic
->
de_mem
->
p_dec_img
[0][
decodî
][
cuºMB
->
pix_y
]);

646 
j
 = 0; j < 
MB_BLOCK_SIZE
; j++)

648 
	`mem˝y
(&(
c⁄˚Æed_img
[
j
][
i0
]), &(
ªf_img
[j][i0]), (
img≥l
)*
MB_BLOCK_SIZE
);

653 
j
=0; j<
MB_BLOCK_SIZE
; j++)

655 
i
=
i0
; i<i0+
MB_BLOCK_SIZE
; i++)

657 
c⁄˚Æed_img
[
j
][
i
] = 128;

662 i‡(
mb_îr‹
 !2 && 
cuºSli˚
->
¶i˚_ty≥
 !
I_SLICE
 && 
cuºMB
->
mb_ty≥
 < 
P8x8
)

664 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

665 
	`gë_¥edi˘ed_c⁄˚Æmít_mb
(
cuºMB
, 
íc_pic
, 
decodî
);

666 
j
 = 0; j < 
MB_BLOCK_SIZE
; j++)

668 
	`mem˝y
(&(
c⁄˚Æed_img
[
j
][
i0
]), &(
p_Vid
->
p_decs
->
dec_mb_¥ed
[
decodî
][j][0]), 
MB_BLOCK_SIZE
 * (
img≥l
));

671 
	}
}

	@lencod/src/explicit_gop.c

14 
	~"c⁄åibut‹s.h
"

16 
	~<˘y≥.h
>

17 
	~<limôs.h
>

18 
	~"globÆ.h
"

20 
	~"ex∂icô_g›.h
"

21 
	~"image.h
"

22 
	~"«lucomm⁄.h
"

23 
	~"ªp‹t.h
"

32 
	$öô_g›_°ru˘uª
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

34 
max_g›size
 = 
p_I≈
->
NumbîBFømes
;

36 
p_Vid
->
g›_°ru˘uª
 = 
	`ˇŒoc
(
	`imax
(10,
max_g›size
),  (
GOP_DATA
));

37 i‡(
NULL
==
p_Vid
->
g›_°ru˘uª
)

38 
	`no_mem_exô
("init_gop_structure: gop_structure");

39 
	}
}

48 
	$˛ór_g›_°ru˘uª
(
VideoP¨amëîs
 *
p_Vid
)

50 i‡(
p_Vid
->
g›_°ru˘uª
)

51 
	`‰ì
(
p_Vid
->
g›_°ru˘uª
);

52 
	}
}

61 
	$öãΩªt_g›_°ru˘uª
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

63 
nLígth
 = (Ë
	`°æí
(
p_I≈
->
Ex∂icôHõørchyF‹m©
);

64 
i
 =0, 
k
, 
dqp
, 
di•œy_no
;

65 
¶i˚_ªad
 =0, 
‹dî_ªad
 = 0, 
°‹ed_ªad
 = 0, 
qp_ªad
 =0;

66 
coded_‰ame
 = 0;

67 
éyr
, 
ãmp‹Æ_œyî_ªad
 = 0;

69 i‡(
nLígth
 > 0)

72 
i
 = 0; i < 
nLígth
 ; i++)

75 i‡(
¶i˚_ªad
 == 0)

77 
p_I≈
->
Ex∂icôHõørchyF‹m©
[
i
])

81 
p_Vid
->
g›_°ru˘uª
[
coded_‰ame
].
¶i˚_ty≥
 = 
P_SLICE
;

85 
p_Vid
->
g›_°ru˘uª
[
coded_‰ame
].
¶i˚_ty≥
 = 
B_SLICE
;

89 
p_Vid
->
g›_°ru˘uª
[
coded_‰ame
].
¶i˚_ty≥
 = 
I_SLICE
;

92 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Slice Type invalid in ExplicitHierarchyFormatÖaram. Please check configuration file.");

93 
	`îr‹
 (
îr‹ãxt
, 400);

96 
¶i˚_ªad
 = 1;

101 i‡(
‹dî_ªad
 == 0)

103 i‡(
	`isdigô
(()(*(
p_I≈
->
Ex∂icôHõørchyF‹m©
+
i
))))

105 
	`ssˇnf
(
p_I≈
->
Ex∂icôHõørchyF‹m©
+
i
,"%d",&
di•œy_no
);

106 
p_Vid
->
g›_°ru˘uª
[
coded_‰ame
].
di•œy_no
 = display_no;

107 
‹dî_ªad
 = 1;

108 i‡(
di•œy_no
 < 0 || di•œy_nÿ>
p_I≈
->
NumbîBFømes
)

110 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "InvÆid FømêOrdî vÆue. Fømêposôi⁄Çìd†tÿbêö [0,%d]Ñ™ge.",
p_I≈
->
NumbîBFømes
 - 1);

111 
	`îr‹
 (
îr‹ãxt
, 400);

113 
k
=0;k<
coded_‰ame
;k++)

115 i‡(
p_Vid
->
g›_°ru˘uª
[
k
].
di•œy_no
 == display_no)

117 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "FømêOrdî vÆuê%d i¿‰amê%dáÃódy u£d f‹Énh™˚míà‰amê%d.",
di•œy_no
,
coded_‰ame
,
k
);

118 
	`îr‹
 (
îr‹ãxt
, 400);

124 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Slice TypeÇeedsÅo be followed by Display Order. Please check configuration file.");

125 
	`îr‹
 (
îr‹ãxt
, 400);

128 i‡(
‹dî_ªad
 == 1)

130 i‡(
°‹ed_ªad
 =0 && !(
	`isdigô
(()(*(
p_I≈
->
Ex∂icôHõørchyF‹m©
+
i
)))))

132 
p_I≈
->
Ex∂icôHõørchyF‹m©
[
i
])

136 
p_Vid
->
g›_°ru˘uª
[
coded_‰ame
].
ª„ªn˚_idc
 = 
NALU_PRIORITY_DISPOSABLE
;

137 
p_Vid
->
g›_°ru˘uª
[
coded_‰ame
].
hõørchy_œyî
 = 0;

141 
p_Vid
->
g›_°ru˘uª
[
coded_‰ame
].
ª„ªn˚_idc

NALU_PRIORITY_LOW
;

142 
p_Vid
->
g›_°ru˘uª
[
coded_‰ame
].
hõørchy_œyî
 = 1;

145 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Reference_IDC invalid in ExplicitHierarchyFormatÖaram. Please check configuration file.");

146 
	`îr‹
 (
îr‹ãxt
, 400);

149 
°‹ed_ªad
 = 1;

151 i‡(
°‹ed_ªad
 =1 && 
qp_ªad
 == 0)

153 i‡(
	`isdigô
(()(*(
p_I≈
->
Ex∂icôHõørchyF‹m©
+
i
))))

155 
	`ssˇnf
(
p_I≈
->
Ex∂icôHõørchyF‹m©
+
i
,"%d",&
dqp
);

157 
p_Vid
->
g›_°ru˘uª
[
coded_‰ame
].
¶i˚_qp_off
 = 
	`iClù3
(-p_Vid->
bôdïth_luma_qp_sˇÀ
, 51, 
dqp
);

158 
qp_ªad
 = 1;

162 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Reference_IDCÇeedsÅo be followed by QP. Please check configuration file.");

163 
	`îr‹
 (
îr‹ãxt
, 400);

166 i‡(
°‹ed_ªad
 =1 && 
qp_ªad
 =1 && 
ãmp‹Æ_œyî_ªad
 == 0)

168 i‡(!(
	`isdigô
(()(*(
p_I≈
->
Ex∂icôHõørchyF‹m©
+
i
)))))

170 i‡(
p_I≈
->
Ex∂icôHõørchyF‹m©
[
i
] == 't' ||Ö_Inp->ExplicitHierarchyFormat[i] == 'T')

172 
p_Vid
->
g›_°ru˘uª
[
coded_‰ame
].
ãmp‹Æ_œyî
 = 0;

173 i‡(
	`isdigô
(()(*(
p_I≈
->
Ex∂icôHõørchyF‹m©
+
i
+1))))

175 
	`ssˇnf
(
p_I≈
->
Ex∂icôHõørchyF‹m©
+
i
+1,"%d",&
éyr
);

177 
p_Vid
->
g›_°ru˘uª
[
coded_‰ame
].
ãmp‹Æ_œyî
 = 
éyr
;

178 
i
++;

183 
i
--;

186 
ãmp‹Æ_œyî_ªad
 = 1;

188 i‡(
°‹ed_ªad
 =1 && 
qp_ªad
 =1 && 
ãmp‹Æ_œyî_ªad
 =1 && !(
	`isdigô
(()(*(
p_I≈
->
Ex∂icôHõørchyF‹m©
+
i
)))Ë&& (ò< 
nLígth
 - 3))

191 
°‹ed_ªad
 =0;

192 
qp_ªad
=0;

193 
‹dî_ªad
=0;

194 
¶i˚_ªad
=0;

195 
ãmp‹Æ_œyî_ªad
=0;

196 
i
--;

197 
coded_‰ame
 ++;

198 i‡(
coded_‰ame
 >
p_I≈
->
NumbîBFømes
 )

200 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "TotalÇumber of frames in Enhancement GOPÇeedÅo be fewer orÉqualÅo NumberBFramesÖarameter.");

201 
	`îr‹
 (
îr‹ãxt
, 400);

210 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "ExplicitHierarchyFormat isÉmpty. Please check configuration file.");

211 
	`îr‹
 (
îr‹ãxt
, 400);

214 
p_I≈
->
NumbîBFømes
 = 
coded_‰ame
 + 1;

215 
	}
}

	@lencod/src/explicit_seq.c

14 
	~"c⁄åibut‹s.h
"

15 
	~"globÆ.h
"

16 
	~"ªp‹t.h
"

17 
	~"ex∂icô_£q.h
"

25 
	$RódTextFõld
(
FILE
 *
expSeqFûe
, * 
keyw‹d
)

27 
ªadlöe
 [100];

28 
w‹d
[64];

29 
îr
 = -1;

30 
ªad_löe
 = 0;

33 
ªad_löe
++;

35 i‡(
NULL
 =
	`fgës
(
ªadlöe
, 100, 
expSeqFûe
))

36 
	`îr‹
 ("errorÖarsingÉxplicit sequence file", 500);

37 
îr
 = 
	`ssˇnf
(
ªadlöe
,"%s",
w‹d
);

38 i‡(
îr
 == -1)

40 i‡(
	`°rˇ£cmp
(
w‹d
, 
keyw‹d
) != 0)

41 
îr
 = - 1;

43 i‡(
	`„of
(
expSeqFûe
))

46 
îr
 =- 1 && 
ªad_löe
 < 6);

56  
îr
;

57 
	}
}

65 
	$RódI¡Fõld
(
FILE
 *
expSeqFûe
, * 
f‹m©
, * 
keyw‹d
, * 
vÆue
)

67 
ªadlöe
 [100];

68 
w‹d
[64];

69 
îr
 = -1;

70 
ªad_löe
 = 0;

74 
ªad_löe
++;

75 i‡(
NULL
 =
	`fgës
(
ªadlöe
, 100, 
expSeqFûe
))

76 
	`îr‹
 ("errorÖarsingÉxplicit sequence file", 500);

77 
îr
 = 
	`ssˇnf
(
ªadlöe
, 
f‹m©
, 
w‹d
, 
vÆue
);

78 i‡(
	`„of
(
expSeqFûe
))

81 
	`°rˇ£cmp
(
w‹d
, 
keyw‹d
Ë!0 && 
ªad_löe
 < 6);

83 i‡(
îr
 !2 || 
	`°rˇ£cmp
(
w‹d
, 
keyw‹d
) != 0)

85 
	`¥ötf
("Eº‹ whûêªadög %s.\n", 
keyw‹d
);

86 
	`ªp‹t_°©s_⁄_îr‹
();

88 
	}
}

96 
	$RódCh¨Fõld
(
FILE
 *
expSeqFûe
, * 
f‹m©
, * 
keyw‹d
, * 
vÆue
)

98 
ªadlöe
 [100];

99 
w‹d
[64];

100 
îr
 = -1;

101 
ªad_löe
 = 0;

105 
ªad_löe
++;

106 i‡(
NULL
 =
	`fgës
(
ªadlöe
, 100, 
expSeqFûe
))

107 
	`îr‹
 ("errorÖarsingÉxplicit sequence file", 500);

108 
îr
 = 
	`ssˇnf
(
ªadlöe
, 
f‹m©
, 
w‹d
, 
vÆue
);

110 !
	`„of
(
expSeqFûe
))

113 
	`°rˇ£cmp
(
w‹d
, 
keyw‹d
Ë!0 && 
ªad_löe
 < 6);

115 i‡(
îr
 !2 || 
	`°rˇ£cmp
(
w‹d
, 
keyw‹d
) != 0)

117 
	`¥ötf
("Eº‹ whûêªadög %s.\n", 
keyw‹d
);

118 
	`ªp‹t_°©s_⁄_îr‹
();

120 
	}
}

123 
	$P¨£Sli˚Ty≥
(*
¶i˚_ty≥
, 
ExpFømeInfo
 *
öfo
, 
codög_ödex
)

125 i‡–
	`°rˇ£cmp
(
¶i˚_ty≥
, "P") == 0 )

127 
öfo
->
¶i˚_ty≥
 = 
P_SLICE
;

129 i‡–
	`°rˇ£cmp
(
¶i˚_ty≥
, "B") == 0 )

131 
öfo
->
¶i˚_ty≥
 = 
B_SLICE
;

133 i‡–
	`°rˇ£cmp
(
¶i˚_ty≥
, "I") == 0 )

135 
öfo
->
¶i˚_ty≥
 = 
I_SLICE
;

137 i‡–
	`°rˇ£cmp
(
¶i˚_ty≥
, "SP") == 0 )

139 
öfo
->
¶i˚_ty≥
 = 
SP_SLICE
;

141 i‡–
	`°rˇ£cmp
(
¶i˚_ty≥
, "SI") == 0 )

143 
öfo
->
¶i˚_ty≥
 = 
SI_SLICE
;

147 
	`¥ötf
("ReadExplicitSeqFile : invalid sliceÅype\n");

148 
	`ªp‹t_°©s_⁄_îr‹
();

151 i‡(
codög_ödex
 =0 && 
öfo
->
¶i˚_ty≥
 !
I_SLICE
)

153 
	`¥ötf
("ReadExplicitSeqFile : First codedÖictureÇeedsÅo be Intra.\n");

154 
	`ªp‹t_°©s_⁄_îr‹
();

156 
	}
}

158 
	$P¨£Re„ªn˚IDC
(
ª„ªn˚_idc
, 
codög_ödex
)

160 i‡–
ª„ªn˚_idc
 < 
NALU_PRIORITY_DISPOSABLE
 ||Ñe„ªn˚_id¯> 
NALU_PRIORITY_HIGHEST
)

162 
	`¥ötf
("ReadExplicitSeqFile : InvalidÑeference indicator \n");

163 
	`ªp‹t_°©s_⁄_îr‹
();

166 i‡(
codög_ödex
 =0 && 
ª„ªn˚_idc
 =
NALU_PRIORITY_DISPOSABLE
)

168 
	`¥ötf
("ReadExplicitSeqFile : First codedÖictureÇeedsÅo beáÑeferenceÖicture.\n");

169 
	`ªp‹t_°©s_⁄_îr‹
();

171 
	}
}

174 
	$P¨£SeqNumbî
(
£q_numbî
, 
ExpSeqInfo
 *
£q_öfo
, 
codög_ödex
)

176 
i
;

177 
i
 = 0; i < 
	`imö
(
codög_ödex
, 
£q_öfo
->
no_‰ames
); i++)

179 i‡(
£q_öfo
->
öfo
[
i
].
£q_numbî
 == seq_number)

181 
	`¥ötf
("ReadExplicitSeqFile : SeqNumber used for current frameálready used. Terminating\n");

182 
	`ªp‹t_°©s_⁄_îr‹
();

185 
	}
}

193 
	$RódFømeD©a
(
FILE
 *
expSeqFûe
, 
ExpSeqInfo
 *
£q_öfo
, 
codög_ödex
)

195 
Boﬁón
 
¶i˚_ty≥_¥e£¡
 = 
FALSE
;

196 
Boﬁón
 
£q_numbî_¥e£¡
 = 
FALSE
;

197 
ªadlöe
 [100];

198 
w‹d
[64], 
vÆue
[64];

199 
îr
 = -1;

200 
ExpFømeInfo
 *
öfo
 = &
£q_öfo
->öfo[
codög_ödex
 % seq_öfo->
no_‰ames
];

202 
öfo
->
ª„ªn˚_idc
 = 
NALU_PRIORITY_HIGHEST
;

204 
	`RódTextFõld
 (
expSeqFûe
, "{");

208 i‡(
NULL
 =
	`fgës
(
ªadlöe
, 100, 
expSeqFûe
))

209 
	`îr‹
 ("errorÖarsingÉxplicit sequence file", 500);

211 
îr
 = 
	`ssˇnf
(
ªadlöe
, "%†: %s", 
w‹d
, 
vÆue
);

212 i‡(
îr
 == 1)

214 i‡(
	`°rˇ£cmp
(
w‹d
, "}") == 0)

216 i‡(
	`°rˇ£cmp
(
w‹d
, "{") == 0)

218 
	`¥ötf
("Invalid \"{\" character found. Terminating\n");

219 
	`ªp‹t_°©s_⁄_îr‹
();

222 i‡(
îr
 == 2)

224 i‡(
	`°rˇ£cmp
(
w‹d
, "SeqNumber") == 0)

226 
öfo
->
£q_numbî
 = 
	`©oi
(
vÆue
);

227 
	`P¨£SeqNumbî
(
öfo
->
£q_numbî
, 
£q_öfo
, 
codög_ödex
);

228 
£q_numbî_¥e£¡
 = 
TRUE
;

230 i‡(
	`°rˇ£cmp
(
w‹d
, "SliceType") == 0)

232 
	`P¨£Sli˚Ty≥
(
vÆue
, 
öfo
, 
codög_ödex
);

233 
¶i˚_ty≥_¥e£¡
 = 
TRUE
;

235 i‡(
	`°rˇ£cmp
(
w‹d
, "IDRPicture") == 0)

236 
öfo
->
is_idr
 = 
	`©oi
(
vÆue
);

237 i‡(
	`°rˇ£cmp
(
w‹d
, "Reference") == 0)

239 
öfo
->
ª„ªn˚_idc
 = 
	`©oi
(
vÆue
);

240 
	`P¨£Re„ªn˚IDC
(
öfo
->
ª„ªn˚_idc
, 
codög_ödex
);

244 !
	`„of
(
expSeqFûe
));

246 i‡(
¶i˚_ty≥_¥e£¡
 =
FALSE
 || 
£q_numbî_¥e£¡
 == FALSE)

248 
	`¥ötf
("Sequence info file doesÇot containáll mandatory info (SeqNumber or SliceType). Terminating.\n");

249 
	`ªp‹t_°©s_⁄_îr‹
();

251 
	}
}

259 
	$RódEx∂icôSeqFûe
(
ExpSeqInfo
 *
£q_öfo
, 
FILE
 *
expSFûe
, 
codög_ödex
)

261 
‰m_hódî
 = 
	`RódTextFõld
(
expSFûe
, "Frame");

263 i‡(
‰m_hódî
 != -1)

265 
	`RódFømeD©a
 (
expSFûe
, 
£q_öfo
, 
codög_ödex
);

269 
	`¥ötf
("ReadExplicitSeqFile : No more data. \n");

270 
	`ªp‹t_°©s_⁄_îr‹
();

272 
	}
}

280 
	$O≥nEx∂icôSeqFûe
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

282 
‰m_cou¡
 = 0;

283 
p_Vid
->
expSFûe
 = 
	`f›í
(
p_I≈
->
Ex∂icôSeqFûe
, "r");

284 i‡(
p_Vid
->
expSFûe
 =
NULL
)

286 
	`¥ötf
("ERROR while openingÅheÉxplicit sequence information file.\n");

287 
	`ªp‹t_°©s_⁄_îr‹
();

290 i‡(
	`RódTextFõld
(
p_Vid
->
expSFûe
, "Sequence") == -1)

292 
	`¥ötf
("Sequence info file is of invalid format. Terminating\n");

293 
	`ªp‹t_°©s_⁄_îr‹
();

297 
	`RódI¡Fõld
 (
p_Vid
->
expSFûe
, "%†: %d", "FømeCou¡", &
‰m_cou¡
);

298 i‡(
‰m_cou¡
 > 0)

300 
p_Vid
->
expSeq
 = (
ExpSeqInfo
 *Ë
	`mÆloc
((ExpSeqInfo));

301 
p_Vid
->
expSeq
->
no_‰ames
 = 
‰m_cou¡
;

302 
p_Vid
->
expSeq
->
öfo
 = (
ExpFømeInfo
 *Ë
	`ˇŒoc
(
‰m_cou¡
, (ExpFrameInfo));

306 
	`¥ötf
("Invalid FrameCount in Sequence info file. Terminating\n");

307 
	`ªp‹t_°©s_⁄_îr‹
();

310 
	}
}

318 
	$Clo£Ex∂icôSeqFûe
(
VideoP¨amëîs
 *
p_Vid
)

320 i‡(
p_Vid
->
expSFûe
 !
NULL
)

321 
	`f˛o£
(
p_Vid
->
expSFûe
);

322 i‡(
p_Vid
->
expSeq
 !
NULL
)

324 
	`‰ì
(
p_Vid
->
expSeq
->
öfo
);

325 
	`‰ì
(
p_Vid
->
expSeq
);

327 
	}
}

	@lencod/src/filehandle.c

15 
	~"c⁄åibut‹s.h
"

17 
	~"globÆ.h
"

18 
	~"íc_°©i°ics.h
"

20 
	~"πp.h
"

21 
	~"™√xb.h
"

22 
	~"∑r£t.h
"

23 
	~"mbuf„r.h
"

37 
	$îr‹
(*
ãxt
, 
code
)

39 
	`Ârötf
(
°dîr
, "%s\n", 
ãxt
);

40 
	`Êush_dpb
(
p_Enc
->
p_Vid
->
p_Dpb_œyî
[0], &p_Enc->
p_I≈
->
ouçut
);

41 
	`Êush_dpb
(
p_Enc
->
p_Vid
->
p_Dpb_œyî
[1], &p_Enc->
p_I≈
->
ouçut
);

42 
	`exô
(
code
);

43 
	}
}

52 
	$wrôe_PPS
(
VideoP¨amëîs
 *
p_Vid
, 
Àn
, 
PPS_id
)

54 
NALU_t
 *
«lu
;

55 
«lu
 = 
NULL
;

56 
«lu
 = 
	`Gíî©ePic_∑ømëî_£t_NALU
 (
p_Vid
, 
PPS_id
);

57 
Àn
 +
p_Vid
->
	`WrôeNALU
 (p_Vid, 
«lu
,Ö_Vid->
f_out
);

58 
	`FªeNALU
 (
«lu
);

60  
Àn
;

61 
	}
}

70 
	$°¨t_£quí˚
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

72 
i
,
Àn
=0, 
tŸÆ_µs
 = (
p_I≈
->
Gíî©eMu…ùÀPPS
) ? 3 : 1;

73 
NALU_t
 *
«lu
;

75 
p_I≈
->
of_mode
)

77 
PAR_OF_ANNEXB
:

78 
p_Vid
->
WrôeNALU
 = 
WrôeA¬exbNALU
;

79 
p_Vid
->
f_out
 = &p_Vid->
f_™√xb
;

80 
	`O≥nA¬exbFûe
 (
p_I≈
->
outfûe
, 
p_Vid
->
f_out
);

82 
PAR_OF_RTP
:

83 
p_Vid
->
WrôeNALU
 = 
WrôeRTPNALU
;

84 
p_Vid
->
f_out
 = &p_Vid->
f_πp
;

85 
	`O≥nRTPFûe
 (
p_I≈
->
outfûe
, 
p_Vid
->
f_out
);

88 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "OuçuàFûêModê%dÇŸ suµ‹ãd", 
p_I≈
->
of_mode
);

89 
	`îr‹
(
îr‹ãxt
,1);

93 i‡–
p_I≈
->
SídAUD
 )

95 
Àn
 +
	`Wrôe_AUD_NALU
(
p_Vid
);

103 
«lu
 = 
NULL
;

104 
«lu
 = 
	`Gíî©eSeq_∑ømëî_£t_NALU
 (
p_Vid
);

105 
Àn
 +
p_Vid
->
	`WrôeNALU
 (p_Vid, 
«lu
,Ö_Vid->
f_out
);

106 
	`FªeNALU
 (
«lu
);

108 #i‡(
MVC_EXTENSION_ENABLE
)

109 if(
p_Vid
->
num_of_œyîs
==2)

111 
bôs
;

112 
«lu
 = 
NULL
;

113 
«lu
 = 
	`Gíî©eSub£tSeq_∑ømëî_£t_NALU
 (
p_Vid
);

114 
bôs
 = 
p_Vid
->
	`WrôeNALU
 (p_Vid, 
«lu
,Ö_Vid->
f_out
);

115 
Àn
 +
bôs
;

116 
p_Vid
->
p_Sèts
->
bô_˘r_∑ømëî£ts_n_v
[1] = 
bôs
;

117 
	`FªeNALU
 (
«lu
);

121 
p_Vid
->
p_Sèts
->
bô_˘r_∑ømëî£ts_n_v
[1] = 0;

126 
i
=0;i<
tŸÆ_µs
;i++)

128 
Àn
 = 
	`wrôe_PPS
(
p_Vid
,Üí, 
i
);

131 i‡(
p_I≈
->
Gíî©eSEIMesßge
)

133 
«lu
 = 
NULL
;

134 
«lu
 = 
	`Gíî©eSEImesßge_NALU
(
p_I≈
);

135 
Àn
 +
p_Vid
->
	`WrôeNALU
 (p_Vid, 
«lu
,Ö_Vid->
f_out
);

136 
	`FªeNALU
 (
«lu
);

139 
p_Vid
->
p_Sèts
->
bô_˘r_∑ømëî£ts_n
 = 
Àn
;

140 #i‡(
MVC_EXTENSION_ENABLE
)

141 if(
p_I≈
->
num_of_võws
==2)

143 
p_Vid
->
p_Sèts
->
bô_˘r_∑ømëî£ts_n_v
[0] = 
Àn
 -Ö_Vid->p_Stats->bit_ctr_parametersets_n_v[1];

147 
	}
}

149 
	$íd_of_°ªam
(
VideoP¨amëîs
 *
p_Vid
)

151 
bôs
;

152 
NALU_t
 *
«lu
;

154 
«lu
 = 
	`AŒocNALU
(
MAXNALUSIZE
);

155 
«lu
->
°¨tcodïªfix_Àn
 = 4;

156 
«lu
->
f‹biddí_bô
 = 0;

157 
«lu
->
«l_ª„ªn˚_idc
 = 0;

158 
«lu
->
«l_unô_ty≥
 = 
NALU_TYPE_EOSTREAM
;

159 
«lu
->
Àn
 = 0;

160 
bôs
 = 
p_Vid
->
	`WrôeNALU
 (p_Vid, 
«lu
,Ö_Vid->
f_out
);

162 
p_Vid
->
p_Sèts
->
bô_˘r_∑ømëî£ts
 +
bôs
;

163 
	`FªeNALU
 (
«lu
);

164  
bôs
;

165 
	}
}

174 
	$ªwrôe_∑øm£ts
(
VideoP¨amëîs
 *
p_Vid
)

176 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

177 
i
,
Àn
=0, 
tŸÆ_µs
 = (
p_I≈
->
Gíî©eMu…ùÀPPS
) ? 3 : 1;

178 
NALU_t
 *
«lu
;

181 i‡–
p_I≈
->
SídAUD
 )

183 
Àn
 +
	`Wrôe_AUD_NALU
(
p_Vid
);

191 
«lu
 = 
NULL
;

192 
«lu
 = 
	`Gíî©eSeq_∑ømëî_£t_NALU
 (
p_Vid
);

193 
Àn
 +
p_Vid
->
	`WrôeNALU
 (p_Vid, 
«lu
,Ö_Vid->
f_out
);

194 
	`FªeNALU
 (
«lu
);

196 #i‡(
MVC_EXTENSION_ENABLE
)

197 if(
p_Vid
->
num_of_œyîs
==2)

199 
bôs
;

200 
«lu
 = 
	`Gíî©eSub£tSeq_∑ømëî_£t_NALU
 (
p_Vid
);

201 
bôs
 = 
p_Vid
->
	`WrôeNALU
 (p_Vid, 
«lu
,Ö_Vid->
f_out
);

202 
Àn
 +
bôs
;

203 
p_Vid
->
p_Sèts
->
bô_˘r_∑ømëî£ts_n_v
[1] = 
bôs
;

204 
	`FªeNALU
 (
«lu
);

209 
i
=0;i<
tŸÆ_µs
;i++)

211 
Àn
 = 
	`wrôe_PPS
(
p_Vid
,Üí, 
i
);

214 i‡(
p_I≈
->
Gíî©eSEIMesßge
)

216 
«lu
 = 
NULL
;

217 
«lu
 = 
	`Gíî©eSEImesßge_NALU
(
p_I≈
);

218 
Àn
 +
p_Vid
->
	`WrôeNALU
 (p_Vid, 
«lu
,Ö_Vid->
f_out
);

219 
	`FªeNALU
 (
«lu
);

222 
p_Vid
->
p_Sèts
->
bô_˘r_∑ømëî£ts_n
 = 
Àn
;

223 #i‡(
MVC_EXTENSION_ENABLE
)

224 if(
p_I≈
->
num_of_võws
==2)

226 
p_Vid
->
p_Sèts
->
bô_˘r_∑ømëî£ts_n_v
[0] = 
Àn
 -Ö_Vid->p_Stats->bit_ctr_parametersets_n_v[1];

230 
	}
}

239 
	$ãrmö©e_£quí˚
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

246 
p_I≈
->
of_mode
)

248 
PAR_OF_ANNEXB
:

249 
	`Clo£A¬exbFûe
(*
p_Vid
->
f_out
);

251 
PAR_OF_RTP
:

252 
	`Clo£RTPFûe
(*
p_Vid
->
f_out
);

255 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "OuçuàFûêModê%dÇŸ suµ‹ãd", 
p_I≈
->
of_mode
);

256 
	`îr‹
(
îr‹ãxt
,1);

259 
	}
}

	@lencod/src/fmo.c

53 
	~"globÆ.h
"

55 
	~"fmo.h
"

58 
FmoGíî©eTy≥0M≠UnôM≠
 (
VideoP¨amëîs
 * 
p_Vid
, 
pic_∑ømëî_£t_rb•_t
 * 
µs
);

59 
FmoGíî©eTy≥1M≠UnôM≠
 (
VideoP¨amëîs
 * 
p_Vid
, 
pic_∑ømëî_£t_rb•_t
 * 
µs
);

60 
FmoGíî©eTy≥2M≠UnôM≠
 (
VideoP¨amëîs
 * 
p_Vid
, 
pic_∑ømëî_£t_rb•_t
 * 
µs
);

61 
FmoGíî©eTy≥3M≠UnôM≠
 (
VideoP¨amëîs
 * 
p_Vid
, 
pic_∑ømëî_£t_rb•_t
 * 
µs
);

62 
FmoGíî©eTy≥4M≠UnôM≠
 (
VideoP¨amëîs
 * 
p_Vid
, 
pic_∑ømëî_£t_rb•_t
 * 
µs
);

63 
FmoGíî©eTy≥5M≠UnôM≠
 (
VideoP¨amëîs
 * 
p_Vid
, 
pic_∑ømëî_£t_rb•_t
 * 
µs
);

64 
FmoGíî©eTy≥6M≠UnôM≠
 (
VideoP¨amëîs
 * 
p_Vid
, 
pic_∑ømëî_£t_rb•_t
 * 
µs
);

67 
FmoGíî©eM≠UnôToSli˚GroupM≠
 (
VideoP¨amëîs
 * 
p_Vid
, 
pic_∑ømëî_£t_rb•_t
 * 
µs
);

68 
FmoGíî©eMBAm≠
 (
VideoP¨amëîs
 * 
p_Vid
, 
£q_∑ømëî_£t_rb•_t
* 
•s
);

83 
	$FmoGíî©eM≠UnôToSli˚GroupM≠
 (
VideoP¨amëîs
 * 
p_Vid
, 
pic_∑ømëî_£t_rb•_t
 * 
µs
)

85 
p_Vid
->
PicSizeInM≠Unôs
 =Ö_Vid->
PicHeightInM≠Unôs
 *Ö_Vid->
PicWidthInMbs
;

88 i‡(
µs
->
¶i˚_group_m≠_ty≥
 == 6)

90 i‡((
µs
->
pic_size_ö_m≠_unôs_möus1
+1Ë!
p_Vid
->
PicSizeInM≠Unôs
)

92 
	`îr‹
 ("wrongÖps->pic_size_in_map_units_minus1 for used SPSánd FMOÅype 6", 500);

97 i‡(
p_Vid
->
M≠UnôToSli˚GroupM≠
)

98 
	`‰ì
 (
p_Vid
->
M≠UnôToSli˚GroupM≠
);

100 i‡((
p_Vid
->
M≠UnôToSli˚GroupM≠
 = 
	`mÆloc
 (’_Vid->
PicSizeInM≠Unôs
Ë*  (
byã
))Ë=
NULL
)

102 
	`¥ötf
 ("ˇ¬ŸáŒoˇãd %d byã†f‹Ö_Vid->M≠UnôToSli˚GroupM≠ ,Éxô\n", (Ë–
p_Vid
->
PicSizeInM≠Unôs
 *  (
byã
)));

103 
	`exô
 (-1);

106 i‡(
µs
->
num_¶i˚_groups_möus1
 == 0)

108 
	`mem£t
 (
p_Vid
->
M≠UnôToSli˚GroupM≠
, 0,Ö_Vid->
PicSizeInM≠Unôs
 *  (
byã
));

112 
µs
->
¶i˚_group_m≠_ty≥
)

115 
	`FmoGíî©eTy≥0M≠UnôM≠
 (
p_Vid
, 
µs
);

118 
	`FmoGíî©eTy≥1M≠UnôM≠
 (
p_Vid
, 
µs
);

121 
	`FmoGíî©eTy≥2M≠UnôM≠
 (
p_Vid
, 
µs
);

124 
	`FmoGíî©eTy≥3M≠UnôM≠
 (
p_Vid
, 
µs
);

127 
	`FmoGíî©eTy≥4M≠UnôM≠
 (
p_Vid
, 
µs
);

130 
	`FmoGíî©eTy≥5M≠UnôM≠
 (
p_Vid
, 
µs
);

133 
	`FmoGíî©eTy≥6M≠UnôM≠
 (
p_Vid
, 
µs
);

136 
	`¥ötf
 ("IŒegÆ sli˚_group_m≠_ty≥ %d ,Éxô \n", 
µs
->
¶i˚_group_m≠_ty≥
);

137 
	`exô
 (-1);

140 
	}
}

155 
	$FmoGíî©eMBAm≠
 (
VideoP¨amëîs
 * 
p_Vid
, 
£q_∑ømëî_£t_rb•_t
* 
•s
)

157 
i
;

160 i‡(
p_Vid
->
MBAm≠
)

161 
	`‰ì
 (
p_Vid
->
MBAm≠
);

164 i‡((
p_Vid
->
MBAm≠
 = 
	`mÆloc
 (’_Vid->
PicSizeInMbs
Ë*  (
byã
))Ë=
NULL
)

166 
	`¥ötf
 ("ˇ¬ŸáŒoˇãd %d byã†f‹Ö_Vid->MBAm≠,Éxô\n", (Ë((
p_Vid
->
PicSizeInMbs
Ë*  (
byã
)));

167 
	`exô
 (-1);

170 i‡((
•s
->
‰ame_mbs_⁄ly_Êag
Ë|| 
p_Vid
->
fõld_pi˘uª
)

172 
i
=0; i<
p_Vid
->
PicSizeInMbs
; i++)

174 
p_Vid
->
MBAm≠
[
i
] =Ö_Vid->
M≠UnôToSli˚GroupM≠
 [i];

178 i‡(
•s
->
mb_ad≠tive_‰ame_fõld_Êag
 && (! 
p_Vid
->
fõld_pi˘uª
))

180 
i
=0; i<
p_Vid
->
PicSizeInMbs
; i++)

182 
p_Vid
->
MBAm≠
[
i
] =Ö_Vid->
M≠UnôToSli˚GroupM≠
 [i >> 1];

187 
i
=0; i<
p_Vid
->
PicSizeInMbs
; i++)

189 
p_Vid
->
MBAm≠
[
i
] =Ö_Vid->
M≠UnôToSli˚GroupM≠
 [(i/(2*p_Vid->
PicWidthInMbs
))*p_Vid->PicWidthInMbs+(i%p_Vid->PicWidthInMbs)];

193 
	}
}

209 
	$FmoInô
(
VideoP¨amëîs
 * 
p_Vid
, 
pic_∑ømëî_£t_rb•_t
 * 
µs
, 
£q_∑ømëî_£t_rb•_t
 * 
•s
)

212 #ifde‡
PRINT_FMO_MAPS


213 
i
,
j
;

214 
bŸtom
;

217 
k
;

218 
k
 = 0; k < 
MAXSLICEGROUPIDS
; k++)

219 
p_Vid
->
Fú°MBInSli˚
[
k
] = -1;

221 
	`FmoGíî©eM≠UnôToSli˚GroupM≠
(
p_Vid
, 
µs
);

222 
	`FmoGíî©eMBAm≠
(
p_Vid
, 
•s
);

224 #ifde‡
PRINT_FMO_MAPS


225 
	`¥ötf
("\n");

226 
	`¥ötf
("FMO Map (Units):\n");

228 
j
=0; j<
p_Vid
->
PicHeightInM≠Unôs
; j++)

230 
i
=0; i<
p_Vid
->
PicWidthInMbs
; i++)

232 
	`¥ötf
("%d ",
p_Vid
->
M≠UnôToSli˚GroupM≠
 [
i
+
j
*p_Vid->
PicWidthInMbs
]);

234 
	`¥ötf
("\n");

236 
	`¥ötf
("\n");

238 if(
•s
->
mb_ad≠tive_‰ame_fõld_Êag
==0)

240 
	`¥ötf
("FMO Map (Mb):\n");

241 
j
=0; j<(
p_Vid
->
PicSizeInMbs
/p_Vid->
PicWidthInMbs
); j++)

243 
i
=0; i<
p_Vid
->
PicWidthInMbs
; i++)

245 
	`¥ötf
("%d ",
p_Vid
->
MBAm≠
[
i
+
j
*p_Vid->
PicWidthInMbs
]);

247 
	`¥ötf
("\n");

249 
	`¥ötf
("\n");

253 
	`¥ötf
("FMO Map (Mb in scan order for MBAFF):\n");

254 
j
=0; j<(
p_Vid
->
PicSizeInMbs
/p_Vid->
PicWidthInMbs
); j++)

256 
i
=0; i<
p_Vid
->
PicWidthInMbs
; i++)

258 
bŸtom
=(
j
 & 0x01);

259 
	`¥ötf
("%d ",
p_Vid
->
MBAm≠
[(
j
-
bŸtom
)*p_Vid->
PicWidthInMbs
+
i
*2+bottom]);

261 
	`¥ötf
("\n");

264 
	`¥ötf
("\n");

271 
	}
}

280 
	$FmoUnöô
(
VideoP¨amëîs
 *
p_Vid
)

282 i‡(
p_Vid
->
MBAm≠
)

284 
	`‰ì
 (
p_Vid
->
MBAm≠
);

285 
p_Vid
->
MBAm≠
 = 
NULL
;

287 i‡(
p_Vid
->
M≠UnôToSli˚GroupM≠
 )

289 
	`‰ì
 (
p_Vid
->
M≠UnôToSli˚GroupM≠
 );

290 
p_Vid
->
M≠UnôToSli˚GroupM≠
 = 
NULL
;

293 
	}
}

307 
	$FmoGíî©eTy≥0M≠UnôM≠
 (
VideoP¨amëîs
 * 
p_Vid
, 
pic_∑ømëî_£t_rb•_t
 * 
µs
 )

309 
iGroup
, 
j
;

310 
i
 = 0;

314  
iGroup
 = 0;

315 (
iGroup
 <
µs
->
num_¶i˚_groups_möus1
Ë&& (
i
 < 
p_Vid
->
PicSizeInM≠Unôs
);

316 
i
 +
µs
->
run_Àngth_möus1
[
iGroup
++] + 1)

318  
j
 = 0; j <
µs
->
run_Àngth_möus1
[ 
iGroup
 ] && 
i
 + j < 
p_Vid
->
PicSizeInM≠Unôs
; j++ )

319 
p_Vid
->
M≠UnôToSli˚GroupM≠
 [
i
+
j
] = (
byã
Ë
iGroup
;

322  
i
 < 
p_Vid
->
PicSizeInM≠Unôs
 );

323 
	}
}

337 
	$FmoGíî©eTy≥1M≠UnôM≠
 (
VideoP¨amëîs
 * 
p_Vid
, 
pic_∑ømëî_£t_rb•_t
 * 
µs
 )

339 
i
;

340  
i
 = 0; i < 
p_Vid
->
PicSizeInM≠Unôs
; i++ )

342 
p_Vid
->
M≠UnôToSli˚GroupM≠
 [
i
] = (
byã
Ë(((i%p_Vid->
PicWidthInMbs
)+(((i/p_Vid->PicWidthInMbs)*(
µs
->
num_¶i˚_groups_möus1
+1))>>1))

343 %(
µs
->
num_¶i˚_groups_möus1
+1));

345 
	}
}

358 
	$FmoGíî©eTy≥2M≠UnôM≠
 (
VideoP¨amëîs
 * 
p_Vid
, 
pic_∑ømëî_£t_rb•_t
 * 
µs
 )

360 
iGroup
;

361 
i
, 
x
, 
y
;

362 
yT›Le·
, 
xT›Le·
, 
yBŸtomRight
, 
xBŸtomRight
;

364  
i
 = 0; i < 
p_Vid
->
PicSizeInM≠Unôs
; i++ )

365 
p_Vid
->
M≠UnôToSli˚GroupM≠
 [ 
i
 ] = (
byã
Ë
µs
->
num_¶i˚_groups_möus1
;

367  
iGroup
 = 
µs
->
num_¶i˚_groups_möus1
 - 1 ; iGroup >= 0; iGroup-- )

369 
yT›Le·
 = 
µs
->
t›_À·
[ 
iGroup
 ] / 
p_Vid
->
PicWidthInMbs
;

370 
xT›Le·
 = 
µs
->
t›_À·
[ 
iGroup
 ] % 
p_Vid
->
PicWidthInMbs
;

371 
yBŸtomRight
 = 
µs
->
bŸtom_right
[ 
iGroup
 ] / 
p_Vid
->
PicWidthInMbs
;

372 
xBŸtomRight
 = 
µs
->
bŸtom_right
[ 
iGroup
 ] % 
p_Vid
->
PicWidthInMbs
;

373  
y
 = 
yT›Le·
; y <
yBŸtomRight
; y++ )

374  
x
 = 
xT›Le·
; x <
xBŸtomRight
; x++ )

375 
p_Vid
->
M≠UnôToSli˚GroupM≠
 [ 
y
 *Ö_Vid->
PicWidthInMbs
 + 
x
 ] = (
byã
Ë
iGroup
;

377 
	}
}

391 
	$FmoGíî©eTy≥3M≠UnôM≠
 (
VideoP¨amëîs
 * 
p_Vid
, 
pic_∑ømëî_£t_rb•_t
 * 
µs
 )

393 
i
, 
k
;

394 
À·Bound
, 
t›Bound
, 
rightBound
, 
bŸtomBound
;

395 
x
, 
y
, 
xDú
, 
yDú
;

396 
m≠UnôVaˇ¡
;

398 
m≠UnôsInSli˚Group0
 = 
	`imö
((
µs
->
¶i˚_group_ch™ge_øã_möus1
 + 1Ë* 
p_Vid
->
¶i˚_group_ch™ge_cy˛e
,Ö_Vid->
PicSizeInM≠Unôs
);

400  
i
 = 0; i < 
p_Vid
->
PicSizeInM≠Unôs
; i++ )

401 
p_Vid
->
M≠UnôToSli˚GroupM≠
 [ 
i
 ] = 2;

403 
x
 = ( 
p_Vid
->
PicWidthInMbs
 - 
µs
->
¶i˚_group_ch™ge_dúe˘i⁄_Êag
 ) / 2;

404 
y
 = ( 
p_Vid
->
PicHeightInM≠Unôs
 - 
µs
->
¶i˚_group_ch™ge_dúe˘i⁄_Êag
 ) / 2;

406 
À·Bound
 = 
x
;

407 
t›Bound
 = 
y
;

408 
rightBound
 = 
x
;

409 
bŸtomBound
 = 
y
;

411 
xDú
 = 
µs
->
¶i˚_group_ch™ge_dúe˘i⁄_Êag
 - 1;

412 
yDú
 = 
µs
->
¶i˚_group_ch™ge_dúe˘i⁄_Êag
;

414  
k
 = 0; k < 
p_Vid
->
PicSizeInM≠Unôs
; k +
m≠UnôVaˇ¡
 )

416 
m≠UnôVaˇ¡
 = ( 
p_Vid
->
M≠UnôToSli˚GroupM≠
 [ 
y
 *Ö_Vid->
PicWidthInMbs
 + 
x
 ] == 2 );

417 if–
m≠UnôVaˇ¡
 )

418 
p_Vid
->
M≠UnôToSli˚GroupM≠
 [ 
y
 *Ö_Vid->
PicWidthInMbs
 + 
x
 ] = (
byã
Ë–
k
 >
m≠UnôsInSli˚Group0
 );

420 if–
xDú
 =-1 && 
x
 =
À·Bound
 )

422 
À·Bound
 = 
	`imax
(ÜeftBound - 1, 0 );

423 
x
 = 
À·Bound
;

424 
xDú
 = 0;

425 
yDú
 = 2 * 
µs
->
¶i˚_group_ch™ge_dúe˘i⁄_Êag
 - 1;

428 if–
xDú
 =1 && 
x
 =
rightBound
 )

430 
rightBound
 = 
	`imö
–rightBound + 1, ()
p_Vid
->
PicWidthInMbs
 - 1 );

431 
x
 = 
rightBound
;

432 
xDú
 = 0;

433 
yDú
 = 1 - 2 * 
µs
->
¶i˚_group_ch™ge_dúe˘i⁄_Êag
;

436 if–
yDú
 =-1 && 
y
 =
t›Bound
 )

438 
t›Bound
 = 
	`imax
(ÅopBound - 1, 0 );

439 
y
 = 
t›Bound
;

440 
xDú
 = 1 - 2 * 
µs
->
¶i˚_group_ch™ge_dúe˘i⁄_Êag
;

441 
yDú
 = 0;

444 if–
yDú
 =1 && 
y
 =
bŸtomBound
 )

446 
bŸtomBound
 = 
	`imö
–bŸtomBound + 1, ()
p_Vid
->
PicHeightInM≠Unôs
 - 1 );

447 
y
 = 
bŸtomBound
;

448 
xDú
 = 2 * 
µs
->
¶i˚_group_ch™ge_dúe˘i⁄_Êag
 - 1;

449 
yDú
 = 0;

453 
x
 = x + 
xDú
;

454 
y
 = y + 
yDú
;

458 
	}
}

471 
	$FmoGíî©eTy≥4M≠UnôM≠
 (
VideoP¨amëîs
 * 
p_Vid
, 
pic_∑ømëî_£t_rb•_t
 * 
µs
 )

474 
m≠UnôsInSli˚Group0
 = 
	`imö
((
µs
->
¶i˚_group_ch™ge_øã_möus1
 + 1Ë* 
p_Vid
->
¶i˚_group_ch™ge_cy˛e
,Ö_Vid->
PicSizeInM≠Unôs
);

475 
sizeOfUµîLe·Group
 = 
µs
->
¶i˚_group_ch™ge_dúe˘i⁄_Êag
 ? ( 
p_Vid
->
PicSizeInM≠Unôs
 - 
m≠UnôsInSli˚Group0
 ) : mapUnitsInSliceGroup0;

477 
i
;

479  
i
 = 0; i < 
p_Vid
->
PicSizeInM≠Unôs
; i++ )

480 if–
i
 < 
sizeOfUµîLe·Group
 )

481 
p_Vid
->
M≠UnôToSli˚GroupM≠
 [ 
i
 ] = (
byã
Ë
µs
->
¶i˚_group_ch™ge_dúe˘i⁄_Êag
;

483 
p_Vid
->
M≠UnôToSli˚GroupM≠
 [ 
i
 ] = (
byã
Ë(1 - 
µs
->
¶i˚_group_ch™ge_dúe˘i⁄_Êag
);

485 
	}
}

498 
	$FmoGíî©eTy≥5M≠UnôM≠
 (
VideoP¨amëîs
 * 
p_Vid
, 
pic_∑ømëî_£t_rb•_t
 * 
µs
 )

501 
m≠UnôsInSli˚Group0
 = 
	`imö
((
µs
->
¶i˚_group_ch™ge_øã_möus1
 + 1Ë* 
p_Vid
->
¶i˚_group_ch™ge_cy˛e
,Ö_Vid->
PicSizeInM≠Unôs
);

502 
sizeOfUµîLe·Group
 = 
µs
->
¶i˚_group_ch™ge_dúe˘i⁄_Êag
 ? ( 
p_Vid
->
PicSizeInM≠Unôs
 - 
m≠UnôsInSli˚Group0
 ) : mapUnitsInSliceGroup0;

504 
i
,
j
, 
k
 = 0;

506  
j
 = 0; j < 
p_Vid
->
PicWidthInMbs
; j++ )

507  
i
 = 0; i < 
p_Vid
->
PicHeightInM≠Unôs
; i++ )

508 if–
k
++ < 
sizeOfUµîLe·Group
 )

509 
p_Vid
->
M≠UnôToSli˚GroupM≠
 [ 
i
 *Ö_Vid->
PicWidthInMbs
 + 
j
 ] = (
byã
Ë
µs
->
¶i˚_group_ch™ge_dúe˘i⁄_Êag
;

511 
p_Vid
->
M≠UnôToSli˚GroupM≠
 [ 
i
 *Ö_Vid->
PicWidthInMbs
 + 
j
 ] = (
byã
Ë(1 - 
µs
->
¶i˚_group_ch™ge_dúe˘i⁄_Êag
);

513 
	}
}

526 
	$FmoGíî©eTy≥6M≠UnôM≠
 (
VideoP¨amëîs
 * 
p_Vid
, 
pic_∑ømëî_£t_rb•_t
 * 
µs
 )

528 
i
;

529 
i
=0; i<
p_Vid
->
PicSizeInM≠Unôs
; i++)

531 
p_Vid
->
M≠UnôToSli˚GroupM≠
 [
i
] = (
byã
Ë
µs
->
¶i˚_group_id
[i];

533 
	}
}

544 
	$FmoSèπPi˘uª
 (
VideoP¨amëîs
 *
p_Vid
)

546 
i
;

548 
	`as£π
 (
p_Vid
->
MBAm≠
 !
NULL
);

550 
i
=0; i<
MAXSLICEGROUPIDS
; i++)

551 
p_Vid
->
Fú°MBInSli˚
[
i
] = 
	`FmoGëFú°MBOfSli˚Group
 (p_Vid, i);

553 
	}
}

567 
	$FmoEndPi˘uª
 ()

571 
	}
}

583 
	$FmoMB2Sli˚Group
 (
VideoP¨amëîs
 *
p_Vid
, 
mb
)

585 
	`as£π
 (
mb
 < ()
p_Vid
->
PicSizeInMbs
);

586 
	`as£π
 (
p_Vid
->
MBAm≠
 !
NULL
);

587  
p_Vid
->
MBAm≠
[
mb
];

588 
	}
}

600 
	$FmoGëNextMBNr
 (
VideoP¨amëîs
 *
p_Vid
, 
CuºítMbNr
)

603 
Sli˚GroupID
 = 
	`FmoMB2Sli˚Group
 (
p_Vid
, 
CuºítMbNr
);

605 ++
CuºítMbNr
<()
p_Vid
->
PicSizeInMbs
 &&Ö_Vid->
MBAm≠
[CuºítMbNr] !
Sli˚GroupID
)

608 i‡(
CuºítMbNr
 >()
p_Vid
->
PicSizeInMbs
)

611  
CuºítMbNr
;

612 
	}
}

625 
	$FmoGëPªviousMBNr
 (
VideoP¨amëîs
 *
p_Vid
, 
CuºítMbNr
)

628 
Sli˚GroupID
 = 
	`FmoMB2Sli˚Group
 (
p_Vid
, 
CuºítMbNr
);

629 
CuºítMbNr
--;

630 
CuºítMbNr
>=0 && 
p_Vid
->
MBAm≠
[CuºítMbNr] !
Sli˚GroupID
)

631 
CuºítMbNr
--;

633 i‡(
CuºítMbNr
 < 0)

636  
CuºítMbNr
;

637 
	}
}

650 
	$FmoGëFú°MBOfSli˚Group
 (
VideoP¨amëîs
 *
p_Vid
, 
Sli˚GroupID
)

652 
i
 = 0;

653 (
i
<()
p_Vid
->
PicSizeInMbs
Ë&& (
	`FmoMB2Sli˚Group
 (p_Vid, iË!
Sli˚GroupID
))

654 
i
++;

656 i‡(
i
 < ()
p_Vid
->
PicSizeInMbs
)

657  
i
;

660 
	}
}

676 
	$FmoGëLa°CodedMBOfSli˚Group
 (
VideoP¨amëîs
 *
p_Vid
, 
Sli˚GroupID
)

678 
i
;

679 
La°MB
 = -1;

681 
i
=0; i<()
p_Vid
->
PicSizeInMbs
; i++)

682 i‡(
	`FmoMB2Sli˚Group
 (
p_Vid
, 
i
Ë=
Sli˚GroupID
)

683 
La°MB
 = 
i
;

684  
La°MB
;

685 
	}
}

688 
	$FmoSëLa°Ma¸oblockInSli˚
 ( 
VideoP¨amëîs
 *
p_Vid
, 
mb
)

694 
cuºSli˚Group
 = 
	`FmoMB2Sli˚Group
 (
p_Vid
, 
mb
);

695 
	`as£π
 (
mb
 >= 0);

696 
mb
 = 
	`FmoGëNextMBNr
 (
p_Vid
, mb);

697 
p_Vid
->
Fú°MBInSli˚
[
cuºSli˚Group
] = 
mb
;

698 
	}
}

700 
	$FmoGëFú°Ma¸oblockInSli˚
 ( 
VideoP¨amëîs
 *
p_Vid
, 
Sli˚Group
)

702  
p_Vid
->
Fú°MBInSli˚
[
Sli˚Group
];

705 
	}
}

708 
	$FmoSli˚GroupCom∂ëñyCoded
–
VideoP¨amëîs
 *
p_Vid
, 
Sli˚GroupID
)

710 i‡(
	`FmoGëFú°Ma¸oblockInSli˚
 (
p_Vid
, 
Sli˚GroupID
) < 0)

711  
TRUE
;

713  
FALSE
;

714 
	}
}

	@lencod/src/get_block_otf.c

12 
	~"globÆ.h
"

13 
	~"block.h
"

15 
	~"ma¸oblock.h
"

16 
	~"image.h
"

17 
	~"mb_ac˚ss.h
"

18 
	~"gë_block_Ÿf.h
"

19 
	~"ªfbuf_Ÿf.h
"

29 
	$gë_block_00
(
img≥l
 *
block
, img≥»*
cur_img
, 
block_size_y
, 
block_size_x
, 
shi·_x
)

31 
j
;

33 
j
 = 0; j < 
block_size_y
; j += 1)

35 
	`mem˝y
(
block
, 
cur_img
, 
block_size_x
 * (
img≥l
));

36 
block
 +
block_size_x
 ;

37 
cur_img
 +
shi·_x
;

39 
	}
}

47 
	$gë_luma_10
(
img≥l
 *
block
, img≥»**
cur_imgY
, 
block_size_y
, 
block_size_x
, 
x_pos
 , 
max_img≥l_vÆue
)

49 
img≥l
 *
p0
, *
p1
, *
p2
, *
p3
, *
p4
, *
p5
;

50 
img≥l
 *
‹ig_löe
, *
cur_löe
;

51 
i
, 
j
;

52 
ªsu…
;

54 
j
 = 0; j < 
block_size_y
; j++)

56 
cur_löe
 = &(
cur_imgY
[
j
][
x_pos
]);

57 
p0
 = &
cur_imgY
[
j
][
x_pos
 - 2];

58 
p1
 = 
p0
 + 1;

59 
p2
 = 
p1
 + 1;

60 
p3
 = 
p2
 + 1;

61 
p4
 = 
p3
 + 1;

62 
p5
 = 
p4
 + 1;

63 
‹ig_löe
 = 
block
+
j
*
block_size_x
;

65 
i
 = 0; i < 
block_size_x
; i++)

67 
ªsu…
 = (*(
p0
++Ë+ *(
p5
++)Ë- 5 * (*(
p1
++Ë+ *(
p4
++)Ë+ 20 * (*(
p2
++Ë+ *(
p3
++));

69 *
‹ig_löe
 = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((
ªsu…
 + 16)>>5));

70 *
‹ig_löe
 = (
img≥l
Ë((*‹ig_löê+ *(
cur_löe
++) + 1 ) >> 1);

71 
‹ig_löe
++;

74 
	}
}

82 
	$gë_luma_20
(
img≥l
 *
block
, img≥»**
cur_imgY
, 
block_size_y
, 
block_size_x
, 
x_pos
 , 
max_img≥l_vÆue
)

84 
img≥l
 *
p0
, *
p1
, *
p2
, *
p3
, *
p4
, *
p5
;

85 
img≥l
 *
‹ig_löe
;

86 
i
, 
j
;

87 
ªsu…
;

89 
j
 = 0; j < 
block_size_y
; j++)

91 
p0
 = &
cur_imgY
[
j
][
x_pos
 - 2];

92 
p1
 = 
p0
 + 1;

93 
p2
 = 
p1
 + 1;

94 
p3
 = 
p2
 + 1;

95 
p4
 = 
p3
 + 1;

96 
p5
 = 
p4
 + 1;

97 
‹ig_löe
 = 
block
 + 
j
*
block_size_x
;

99 
i
 = 0; i < 
block_size_x
; i++)

101 
ªsu…
 = (*(
p0
++Ë+ *(
p5
++)Ë- 5 * (*(
p1
++Ë+ *(
p4
++)Ë+ 20 * (*(
p2
++Ë+ *(
p3
++));

103 *
‹ig_löe
++ = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((
ªsu…
 + 16)>>5));

106 
	}
}

114 
	$gë_luma_30
(
img≥l
 *
block
, img≥»**
cur_imgY
, 
block_size_y
, 
block_size_x
, 
x_pos
 , 
max_img≥l_vÆue
)

116 
img≥l
 *
p0
, *
p1
, *
p2
, *
p3
, *
p4
, *
p5
;

117 
img≥l
 *
‹ig_löe
, *
cur_löe
;

118 
i
, 
j
;

119 
ªsu…
;

121 
j
 = 0; j < 
block_size_y
; j++)

123 
cur_löe
 = &(
cur_imgY
[
j
][
x_pos
 + 1]);

124 
p0
 = &
cur_imgY
[
j
][
x_pos
 - 2];

125 
p1
 = 
p0
 + 1;

126 
p2
 = 
p1
 + 1;

127 
p3
 = 
p2
 + 1;

128 
p4
 = 
p3
 + 1;

129 
p5
 = 
p4
 + 1;

130 
‹ig_löe
 = 
block
 + 
j
*
block_size_x
 ;

132 
i
 = 0; i < 
block_size_x
; i++)

134 
ªsu…
 = (*(
p0
++Ë+ *(
p5
++)Ë- 5 * (*(
p1
++Ë+ *(
p4
++)Ë+ 20 * (*(
p2
++Ë+ *(
p3
++));

136 *
‹ig_löe
 = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((
ªsu…
 + 16)>>5));

137 *
‹ig_löe
 = (
img≥l
Ë((*‹ig_löê+ *(
cur_löe
++) + 1 ) >> 1);

138 
‹ig_löe
++;

141 
	}
}

150 
	$gë_luma_01
(
img≥l
 *
block
, img≥»**
cur_imgY
, 
block_size_y
, 
block_size_x
, 
x_pos
, 
shi·_x
, 
max_img≥l_vÆue
)

152 
img≥l
 *
p0
, *
p1
, *
p2
, *
p3
, *
p4
, *
p5
;

153 
img≥l
 *
‹ig_löe
, *
cur_löe
;

154 
i
, 
j
;

155 
ªsu…
;

156 
jj
 = 0;

157 
p0
 = &(
cur_imgY
[ - 2][
x_pos
]);

158 
j
 = 0; j < 
block_size_y
; j++)

160 
p1
 = 
p0
 + 
shi·_x
;

161 
p2
 = 
p1
 + 
shi·_x
;

162 
p3
 = 
p2
 + 
shi·_x
;

163 
p4
 = 
p3
 + 
shi·_x
;

164 
p5
 = 
p4
 + 
shi·_x
;

165 
‹ig_löe
 = 
block
 + 
j
*
block_size_x
 ;

166 
cur_löe
 = &(
cur_imgY
[
jj
++][
x_pos
]);

168 
i
 = 0; i < 
block_size_x
; i++)

170 
ªsu…
 = (*(
p0
++Ë+ *(
p5
++)Ë- 5 * (*(
p1
++Ë+ *(
p4
++)Ë+ 20 * (*(
p2
++Ë+ *(
p3
++));

172 *
‹ig_löe
 = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((
ªsu…
 + 16)>>5));

173 *
‹ig_löe
 = (
img≥l
Ë((*‹ig_löê+ *(
cur_löe
++) + 1 ) >> 1);

174 
‹ig_löe
++;

176 
p0
 = 
p1
 - 
block_size_x
;

178 
	}
}

186 
	$gë_luma_02
(
img≥l
 *
block
, img≥»**
cur_imgY
, 
block_size_y
, 
block_size_x
, 
x_pos
, 
shi·_x
, 
max_img≥l_vÆue
)

188 
img≥l
 *
p0
, *
p1
, *
p2
, *
p3
, *
p4
, *
p5
;

189 
img≥l
 *
‹ig_löe
;

190 
i
, 
j
;

191 
ªsu…
;

192 
p0
 = &(
cur_imgY
[ - 2][
x_pos
]);

193 
j
 = 0; j < 
block_size_y
; j++)

195 
p1
 = 
p0
 + 
shi·_x
;

196 
p2
 = 
p1
 + 
shi·_x
;

197 
p3
 = 
p2
 + 
shi·_x
;

198 
p4
 = 
p3
 + 
shi·_x
;

199 
p5
 = 
p4
 + 
shi·_x
;

200 
‹ig_löe
 = 
block
 + 
j
*
block_size_x
 ;

202 
i
 = 0; i < 
block_size_x
; i++)

204 
ªsu…
 = (*(
p0
++Ë+ *(
p5
++)Ë- 5 * (*(
p1
++Ë+ *(
p4
++)Ë+ 20 * (*(
p2
++Ë+ *(
p3
++));

206 *
‹ig_löe
++ = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((
ªsu…
 + 16)>>5));

208 
p0
 = 
p1
 - 
block_size_x
;

210 
	}
}

219 
	$gë_luma_03
(
img≥l
 *
block
, img≥»**
cur_imgY
, 
block_size_y
, 
block_size_x
, 
x_pos
, 
shi·_x
, 
max_img≥l_vÆue
)

221 
img≥l
 *
p0
, *
p1
, *
p2
, *
p3
, *
p4
, *
p5
;

222 
img≥l
 *
‹ig_löe
, *
cur_löe
;

223 
i
, 
j
;

224 
ªsu…
;

225 
jj
 = 1;

227 
p0
 = &(
cur_imgY
[ -2][
x_pos
]);

228 
j
 = 0; j < 
block_size_y
; j++)

230 
p1
 = 
p0
 + 
shi·_x
;

231 
p2
 = 
p1
 + 
shi·_x
;

232 
p3
 = 
p2
 + 
shi·_x
;

233 
p4
 = 
p3
 + 
shi·_x
;

234 
p5
 = 
p4
 + 
shi·_x
;

235 
‹ig_löe
 = 
block
 + 
j
*
block_size_x
 ;

236 
cur_löe
 = &(
cur_imgY
[
jj
++][
x_pos
]);

238 
i
 = 0; i < 
block_size_x
; i++)

240 
ªsu…
 = (*(
p0
++Ë+ *(
p5
++)Ë- 5 * (*(
p1
++Ë+ *(
p4
++)Ë+ 20 * (*(
p2
++Ë+ *(
p3
++));

242 *
‹ig_löe
 = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((
ªsu…
 + 16)>>5));

243 *
‹ig_löe
 = (
img≥l
Ë((*‹ig_löê+ *(
cur_löe
++) + 1 ) >> 1);

244 
‹ig_löe
++;

246 
p0
 = 
p1
 - 
block_size_x
;

248 
	}
}

256 
	$gë_luma_21
(
img≥l
 *
block
, img≥»**
cur_imgY
, *
tmp_ªs
, 
block_size_y
, 
block_size_x
, 
x_pos
, 
max_img≥l_vÆue
)

258 
i
, 
j
;

260 *
tmp_löe
;

261 
img≥l
 *
p0
, *
p1
, *
p2
, *
p3
, *
p4
, *
p5
;

262 *
x0
, *
x1
, *
x2
, *
x3
, *
x4
, *
x5
;

263 
img≥l
 *
‹ig_löe
;

264 
ªsu…
;

266 
jj
 = -2;

268 
j
 = 0; j < 
block_size_y
 + 5; j++)

270 
p0
 = &
cur_imgY
[
jj
++][
x_pos
 - 2];

271 
p1
 = 
p0
 + 1;

272 
p2
 = 
p1
 + 1;

273 
p3
 = 
p2
 + 1;

274 
p4
 = 
p3
 + 1;

275 
p5
 = 
p4
 + 1;

276 
tmp_löe
 = 
tmp_ªs
 + 
j
*
block_size_x
 ;

278 
i
 = 0; i < 
block_size_x
; i++)

280 *(
tmp_löe
++Ë(*(
p0
++Ë+ *(
p5
++)Ë- 5 * (*(
p1
++Ë+ *(
p4
++)Ë+ 20 * (*(
p2
++Ë+ *(
p3
++));

284 
jj
 = 2;

285 
j
 = 0; j < 
block_size_y
; j++)

287 
tmp_löe
 = 
tmp_ªs
+ 
jj
*
block_size_x
; jj++;

288 
x0
 = 
tmp_ªs
 + 
j
*
block_size_x
 ;

289 
x1
 = 
tmp_ªs
 + (
j
 + 1)*
block_size_x
;

290 
x2
 = 
tmp_ªs
 + (
j
 + 2)*
block_size_x
;

291 
x3
 = 
tmp_ªs
 + (
j
 + 3)*
block_size_x
;

292 
x4
 = 
tmp_ªs
 + (
j
 + 4)*
block_size_x
;

293 
x5
 = 
tmp_ªs
 + (
j
 + 5)*
block_size_x
;

294 
‹ig_löe
 = 
block
 + 
j
*
block_size_x
 ;

296 
i
 = 0; i < 
block_size_x
; i++)

298 
ªsu…
 = (*
x0
++ + *
x5
++Ë- 5 * (*
x1
++ + *
x4
++Ë+ 20 * (*
x2
++ + *
x3
++);

300 *
‹ig_löe
 = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((
ªsu…
 + 512)>>10));

301 *
‹ig_löe
 = (
img≥l
Ë((*‹ig_löê+ 
	`iClù1
(
max_img≥l_vÆue
, ((*(
tmp_löe
++) + 16) >> 5)) + 1 )>> 1);

302 
‹ig_löe
++;

305 
	}
}

313 
	$gë_luma_22
(
img≥l
 *
block
, img≥»**
cur_imgY
, *
tmp_ªs
, 
block_size_y
, 
block_size_x
, 
x_pos
, 
max_img≥l_vÆue
)

315 
i
, 
j
;

317 *
tmp_löe
;

318 
img≥l
 *
p0
, *
p1
, *
p2
, *
p3
, *
p4
, *
p5
;

319 *
x0
, *
x1
, *
x2
, *
x3
, *
x4
, *
x5
;

320 
img≥l
 *
‹ig_löe
;

321 
ªsu…
;

323 
jj
 = - 2;

325 
j
 = 0; j < 
block_size_y
 + 5; j++)

327 
p0
 = &
cur_imgY
[
jj
++][
x_pos
 - 2];

328 
p1
 = 
p0
 + 1;

329 
p2
 = 
p1
 + 1;

330 
p3
 = 
p2
 + 1;

331 
p4
 = 
p3
 + 1;

332 
p5
 = 
p4
 + 1;

333 
tmp_löe
 = 
tmp_ªs
 + 
j
*
block_size_x
;

335 
i
 = 0; i < 
block_size_x
; i++)

337 *(
tmp_löe
++Ë(*(
p0
++Ë+ *(
p5
++)Ë- 5 * (*(
p1
++Ë+ *(
p4
++)Ë+ 20 * (*(
p2
++Ë+ *(
p3
++));

341 
j
 = 0; j < 
block_size_y
; j++)

343 
x0
 = 
tmp_ªs
 + 
j
*
block_size_x
 ;

344 
x1
 = 
tmp_ªs
 + (
j
 + 1)*
block_size_x
;

345 
x2
 = 
tmp_ªs
 + (
j
 + 2)*
block_size_x
;

346 
x3
 = 
tmp_ªs
 + (
j
 + 3)*
block_size_x
;

347 
x4
 = 
tmp_ªs
 + (
j
 + 4)*
block_size_x
;

348 
x5
 = 
tmp_ªs
 + (
j
 + 5)*
block_size_x
;

349 
‹ig_löe
 = 
block
 + 
j
*
block_size_x
;

351 
i
 = 0; i < 
block_size_x
; i++)

353 
ªsu…
 = (*
x0
++ + *
x5
++Ë- 5 * (*
x1
++ + *
x4
++Ë+ 20 * (*
x2
++ + *
x3
++);

355 *(
‹ig_löe
++Ë(
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((
ªsu…
 + 512)>>10));

358 
	}
}

366 
	$gë_luma_23
(
img≥l
 *
block
, img≥»**
cur_imgY
, *
tmp_ªs
, 
block_size_y
, 
block_size_x
, 
x_pos
, 
max_img≥l_vÆue
)

368 
i
, 
j
;

370 *
tmp_löe
;

371 
img≥l
 *
p0
, *
p1
, *
p2
, *
p3
, *
p4
, *
p5
;

372 *
x0
, *
x1
, *
x2
, *
x3
, *
x4
, *
x5
;

373 
img≥l
 *
‹ig_löe
;

374 
ªsu…
;

376 
jj
 = -2;

378 
j
 = 0; j < 
block_size_y
 + 5; j++)

380 
p0
 = &
cur_imgY
[
jj
++][
x_pos
 - 2];

381 
p1
 = 
p0
 + 1;

382 
p2
 = 
p1
 + 1;

383 
p3
 = 
p2
 + 1;

384 
p4
 = 
p3
 + 1;

385 
p5
 = 
p4
 + 1;

386 
tmp_löe
 = 
tmp_ªs
 + 
j
*
block_size_x
;

388 
i
 = 0; i < 
block_size_x
; i++)

390 *(
tmp_löe
++Ë(*(
p0
++Ë+ *(
p5
++)Ë- 5 * (*(
p1
++Ë+ *(
p4
++)Ë+ 20 * (*(
p2
++Ë+ *(
p3
++));

394 
jj
 = 3;

395 
j
 = 0; j < 
block_size_y
; j++)

397 
tmp_löe
 = 
tmp_ªs
+ 
jj
*
block_size_x
; jj++;

398 
x0
 = 
tmp_ªs
 + 
j
*
block_size_x
 ;

399 
x1
 = 
tmp_ªs
 + (
j
 + 1)*
block_size_x
;

400 
x2
 = 
tmp_ªs
 + (
j
 + 2)*
block_size_x
;

401 
x3
 = 
tmp_ªs
 + (
j
 + 3)*
block_size_x
;

402 
x4
 = 
tmp_ªs
 + (
j
 + 4)*
block_size_x
;

403 
x5
 = 
tmp_ªs
 + (
j
 + 5)*
block_size_x
;

404 
‹ig_löe
 = 
block
 + 
j
*
block_size_x
;

406 
i
 = 0; i < 
block_size_x
; i++)

408 
ªsu…
 = (*
x0
++ + *
x5
++Ë- 5 * (*
x1
++ + *
x4
++Ë+ 20 * (*
x2
++ + *
x3
++);

410 *
‹ig_löe
 = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((
ªsu…
 + 512)>>10));

411 *
‹ig_löe
 = (
img≥l
Ë((*‹ig_löê+ 
	`iClù1
(
max_img≥l_vÆue
, ((*(
tmp_löe
++) + 16) >> 5)) + 1 )>> 1);

412 
‹ig_löe
++;

415 
	}
}

423 
	$gë_luma_12
(
img≥l
 *
block
, img≥»**
cur_imgY
, *
tmp_ªs
, 
block_size_y
, 
block_size_x
, 
x_pos
, 
shi·_x
, 
max_img≥l_vÆue
)

425 
i
, 
j
;

426 *
tmp_löe
;

427 
img≥l
 *
p0
, *
p1
, *
p2
, *
p3
, *
p4
, *
p5
;

428 *
x0
, *
x1
, *
x2
, *
x3
, *
x4
, *
x5
;

429 
img≥l
 *
‹ig_löe
;

430 
ªsu…
;

432 
p0
 = &(
cur_imgY
[ -2][
x_pos
 - 2]);

433 
j
 = 0; j < 
block_size_y
; j++)

435 
p1
 = 
p0
 + 
shi·_x
;

436 
p2
 = 
p1
 + 
shi·_x
;

437 
p3
 = 
p2
 + 
shi·_x
;

438 
p4
 = 
p3
 + 
shi·_x
;

439 
p5
 = 
p4
 + 
shi·_x
;

440 
tmp_löe
 = 
tmp_ªs
 + 
j
*(
block_size_x
+5);

442 
i
 = 0; i < 
block_size_x
 + 5; i++)

444 *(
tmp_löe
++Ë(*(
p0
++Ë+ *(
p5
++)Ë- 5 * (*(
p1
++Ë+ *(
p4
++)Ë+ 20 * (*(
p2
++Ë+ *(
p3
++));

446 
p0
 = 
p1
 - (
block_size_x
 + 5);

449 
j
 = 0; j < 
block_size_y
; j++)

451 
tmp_löe
 = 
tmp_ªs
 + 
j
*(
block_size_x
+5) + 2 ;

452 
‹ig_löe
 = 
block
 + 
j
*
block_size_x
 ;

453 
x0
 = 
tmp_ªs
 + 
j
*(
block_size_x
+5) ;

454 
x1
 = 
x0
 + 1;

455 
x2
 = 
x1
 + 1;

456 
x3
 = 
x2
 + 1;

457 
x4
 = 
x3
 + 1;

458 
x5
 = 
x4
 + 1;

460 
i
 = 0; i < 
block_size_x
; i++)

462 
ªsu…
 = (*(
x0
++Ë+ *(
x5
++)Ë- 5 * (*(
x1
++Ë+ *(
x4
++)Ë+ 20 * (*(
x2
++Ë+ *(
x3
++));

464 *
‹ig_löe
 = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((
ªsu…
 + 512)>>10));

465 *
‹ig_löe
 = (
img≥l
Ë((*‹ig_löê+ 
	`iClù1
(
max_img≥l_vÆue
, ((*(
tmp_löe
++) + 16)>>5))+1)>>1);

466 
‹ig_löe
 ++;

469 
	}
}

477 
	$gë_luma_32
(
img≥l
 *
block
, img≥»**
cur_imgY
, *
tmp_ªs
, 
block_size_y
, 
block_size_x
, 
x_pos
, 
shi·_x
, 
max_img≥l_vÆue
)

479 
i
, 
j
;

480 *
tmp_löe
;

481 
img≥l
 *
p0
, *
p1
, *
p2
, *
p3
, *
p4
, *
p5
;

482 *
x0
, *
x1
, *
x2
, *
x3
, *
x4
, *
x5
;

483 
img≥l
 *
‹ig_löe
;

484 
ªsu…
;

486 
p0
 = &(
cur_imgY
[ -2][
x_pos
 - 2]);

487 
j
 = 0; j < 
block_size_y
; j++)

489 
p1
 = 
p0
 + 
shi·_x
;

490 
p2
 = 
p1
 + 
shi·_x
;

491 
p3
 = 
p2
 + 
shi·_x
;

492 
p4
 = 
p3
 + 
shi·_x
;

493 
p5
 = 
p4
 + 
shi·_x
;

494 
tmp_löe
 = 
tmp_ªs
 + 
j
*(
block_size_x
+5);

496 
i
 = 0; i < 
block_size_x
 + 5; i++)

498 *(
tmp_löe
++Ë(*(
p0
++Ë+ *(
p5
++)Ë- 5 * (*(
p1
++Ë+ *(
p4
++)Ë+ 20 * (*(
p2
++Ë+ *(
p3
++));

500 
p0
 = 
p1
 - (
block_size_x
 + 5);

503 
j
 = 0; j < 
block_size_y
; j++)

505 
tmp_löe
 = 
tmp_ªs
 + 
j
*(
block_size_x
+5) + 3;

506 
‹ig_löe
 = 
block
 + 
j
*
block_size_x
;

507 
x0
 = 
tmp_ªs
 + 
j
*(
block_size_x
+5);

508 
x1
 = 
x0
 + 1;

509 
x2
 = 
x1
 + 1;

510 
x3
 = 
x2
 + 1;

511 
x4
 = 
x3
 + 1;

512 
x5
 = 
x4
 + 1;

514 
i
 = 0; i < 
block_size_x
; i++)

516 
ªsu…
 = (*(
x0
++Ë+ *(
x5
++)Ë- 5 * (*(
x1
++Ë+ *(
x4
++)Ë+ 20 * (*(
x2
++Ë+ *(
x3
++));

518 *
‹ig_löe
 = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((
ªsu…
 + 512)>>10));

519 *
‹ig_löe
 = (
img≥l
Ë((*‹ig_löê+ 
	`iClù1
(
max_img≥l_vÆue
, ((*(
tmp_löe
++) + 16)>>5))+1)>>1);

520 
‹ig_löe
 ++;

523 
	}
}

531 
	$gë_luma_33
(
img≥l
 *
block
, img≥»**
cur_imgY
, 
block_size_y
, 
block_size_x
, 
x_pos
, 
shi·_x
, 
max_img≥l_vÆue
)

533 
i
, 
j
;

534 
img≥l
 *
p0
, *
p1
, *
p2
, *
p3
, *
p4
, *
p5
;

535 
img≥l
 *
‹ig_löe
;

536 
ªsu…
;

538 
jj
 = 1;

540 
j
 = 0; j < 
block_size_y
; j++)

542 
p0
 = &
cur_imgY
[
jj
++][
x_pos
 - 2];

543 
p1
 = 
p0
 + 1;

544 
p2
 = 
p1
 + 1;

545 
p3
 = 
p2
 + 1;

546 
p4
 = 
p3
 + 1;

547 
p5
 = 
p4
 + 1;

549 
‹ig_löe
 = 
block
 + 
j
*
block_size_x
;

551 
i
 = 0; i < 
block_size_x
; i++)

553 
ªsu…
 = (*(
p0
++Ë+ *(
p5
++)Ë- 5 * (*(
p1
++Ë+ *(
p4
++)Ë+ 20 * (*(
p2
++Ë+ *(
p3
++));

555 *(
‹ig_löe
++Ë(
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((
ªsu…
 + 16)>>5));

559 
p0
 = &(
cur_imgY
[-2][
x_pos
 + 1]);

560 
j
 = 0; j < 
block_size_y
; j++)

562 
p1
 = 
p0
 + 
shi·_x
;

563 
p2
 = 
p1
 + 
shi·_x
;

564 
p3
 = 
p2
 + 
shi·_x
;

565 
p4
 = 
p3
 + 
shi·_x
;

566 
p5
 = 
p4
 + 
shi·_x
;

567 
‹ig_löe
 = 
block
 + 
j
*
block_size_x
;

569 
i
 = 0; i < 
block_size_x
; i++)

571 
ªsu…
 = (*(
p0
++Ë+ *(
p5
++)Ë- 5 * (*(
p1
++Ë+ *(
p4
++)Ë+ 20 * (*(
p2
++Ë+ *(
p3
++));

573 *
‹ig_löe
 = (
img≥l
Ë((*‹ig_löê+ 
	`iClù1
(
max_img≥l_vÆue
, ((
ªsu…
 + 16) >> 5)) + 1) >> 1);

574 
‹ig_löe
++;

576 
p0
 = 
p1
 - 
block_size_x
 ;

578 
	}
}

587 
	$gë_luma_11
(
img≥l
 *
block
, img≥»**
cur_imgY
, 
block_size_y
, 
block_size_x
, 
x_pos
, 
shi·_x
, 
max_img≥l_vÆue
)

589 
i
, 
j
;

590 
img≥l
 *
p0
, *
p1
, *
p2
, *
p3
, *
p4
, *
p5
;

591 
img≥l
 *
‹ig_löe
;

592 
ªsu…
;

594 
jj
 = 0;

596 
j
 = 0; j < 
block_size_y
; j++)

598 
p0
 = &
cur_imgY
[
jj
++][
x_pos
 - 2];

599 
p1
 = 
p0
 + 1;

600 
p2
 = 
p1
 + 1;

601 
p3
 = 
p2
 + 1;

602 
p4
 = 
p3
 + 1;

603 
p5
 = 
p4
 + 1;

605 
‹ig_löe
 = 
block
 + 
j
*
block_size_x
;

607 
i
 = 0; i < 
block_size_x
; i++)

609 
ªsu…
 = (*(
p0
++Ë+ *(
p5
++)Ë- 5 * (*(
p1
++Ë+ *(
p4
++)Ë+ 20 * (*(
p2
++Ë+ *(
p3
++));

611 *(
‹ig_löe
++Ë(
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((
ªsu…
 + 16)>>5));

615 
p0
 = &(
cur_imgY
[-2][
x_pos
]);

616 
j
 = 0; j < 
block_size_y
; j++)

618 
p1
 = 
p0
 + 
shi·_x
;

619 
p2
 = 
p1
 + 
shi·_x
;

620 
p3
 = 
p2
 + 
shi·_x
;

621 
p4
 = 
p3
 + 
shi·_x
;

622 
p5
 = 
p4
 + 
shi·_x
;

623 
‹ig_löe
 = 
block
 + 
j
*
block_size_x
;

625 
i
 = 0; i < 
block_size_x
; i++)

627 
ªsu…
 = (*(
p0
++Ë+ *(
p5
++)Ë- 5 * (*(
p1
++Ë+ *(
p4
++)Ë+ 20 * (*(
p2
++Ë+ *(
p3
++));

629 *
‹ig_löe
 = (
img≥l
Ë((*‹ig_löê+ 
	`iClù1
(
max_img≥l_vÆue
, ((
ªsu…
 + 16) >> 5)) + 1) >> 1);

630 
‹ig_löe
++;

632 
p0
 = 
p1
 - 
block_size_x
 ;

634 
	}
}

642 
	$gë_luma_13
(
img≥l
 *
block
, img≥»**
cur_imgY
, 
block_size_y
, 
block_size_x
, 
x_pos
, 
shi·_x
, 
max_img≥l_vÆue
)

645 
i
, 
j
;

646 
img≥l
 *
p0
, *
p1
, *
p2
, *
p3
, *
p4
, *
p5
;

647 
img≥l
 *
‹ig_löe
;

648 
ªsu…
;

650 
jj
 = 1;

652 
j
 = 0; j < 
block_size_y
; j++)

654 
p0
 = &
cur_imgY
[
jj
++][
x_pos
 - 2];

655 
p1
 = 
p0
 + 1;

656 
p2
 = 
p1
 + 1;

657 
p3
 = 
p2
 + 1;

658 
p4
 = 
p3
 + 1;

659 
p5
 = 
p4
 + 1;

661 
‹ig_löe
 = 
block
 + 
j
*
block_size_x
;

663 
i
 = 0; i < 
block_size_x
; i++)

665 
ªsu…
 = (*(
p0
++Ë+ *(
p5
++)Ë- 5 * (*(
p1
++Ë+ *(
p4
++)Ë+ 20 * (*(
p2
++Ë+ *(
p3
++));

667 *(
‹ig_löe
++Ë(
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((
ªsu…
 + 16)>>5));

671 
p0
 = &(
cur_imgY
[-2][
x_pos
]);

672 
j
 = 0; j < 
block_size_y
; j++)

674 
p1
 = 
p0
 + 
shi·_x
;

675 
p2
 = 
p1
 + 
shi·_x
;

676 
p3
 = 
p2
 + 
shi·_x
;

677 
p4
 = 
p3
 + 
shi·_x
;

678 
p5
 = 
p4
 + 
shi·_x
;

679 
‹ig_löe
 = 
block
 + 
j
*
block_size_x
;

681 
i
 = 0; i < 
block_size_x
; i++)

683 
ªsu…
 = (*(
p0
++Ë+ *(
p5
++)Ë- 5 * (*(
p1
++Ë+ *(
p4
++)Ë+ 20 * (*(
p2
++Ë+ *(
p3
++));

685 *
‹ig_löe
 = (
img≥l
Ë((*‹ig_löê+ 
	`iClù1
(
max_img≥l_vÆue
, ((
ªsu…
 + 16) >> 5)) + 1) >> 1);

686 
‹ig_löe
++;

688 
p0
 = 
p1
 - 
block_size_x
 ;

690 
	}
}

698 
	$gë_luma_31
(
img≥l
 *
block
, img≥»**
cur_imgY
, 
block_size_y
, 
block_size_x
, 
x_pos
, 
shi·_x
, 
max_img≥l_vÆue
)

701 
i
, 
j
;

702 
img≥l
 *
p0
, *
p1
, *
p2
, *
p3
, *
p4
, *
p5
;

703 
img≥l
 *
‹ig_löe
;

704 
ªsu…
;

706 
jj
 = 0;

708 
j
 = 0; j < 
block_size_y
; j++)

710 
p0
 = &
cur_imgY
[
jj
++][
x_pos
 - 2];

711 
p1
 = 
p0
 + 1;

712 
p2
 = 
p1
 + 1;

713 
p3
 = 
p2
 + 1;

714 
p4
 = 
p3
 + 1;

715 
p5
 = 
p4
 + 1;

717 
‹ig_löe
 = 
block
 + 
j
*
block_size_x
;

719 
i
 = 0; i < 
block_size_x
; i++)

721 
ªsu…
 = (*(
p0
++Ë+ *(
p5
++)Ë- 5 * (*(
p1
++Ë+ *(
p4
++)Ë+ 20 * (*(
p2
++Ë+ *(
p3
++));

723 *(
‹ig_löe
++Ë(
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((
ªsu…
 + 16)>>5));

727 
p0
 = &(
cur_imgY
[-2][
x_pos
 + 1]);

728 
j
 = 0; j < 
block_size_y
; j++)

730 
p1
 = 
p0
 + 
shi·_x
;

731 
p2
 = 
p1
 + 
shi·_x
;

732 
p3
 = 
p2
 + 
shi·_x
;

733 
p4
 = 
p3
 + 
shi·_x
;

734 
p5
 = 
p4
 + 
shi·_x
;

735 
‹ig_löe
 = 
block
 + 
j
*
block_size_x
;

737 
i
 = 0; i < 
block_size_x
; i++)

739 
ªsu…
 = (*(
p0
++Ë+ *(
p5
++)Ë- 5 * (*(
p1
++Ë+ *(
p4
++)Ë+ 20 * (*(
p2
++Ë+ *(
p3
++));

741 *
‹ig_löe
 = (
img≥l
Ë((*‹ig_löê+ 
	`iClù1
(
max_img≥l_vÆue
, ((
ªsu…
 + 16) >> 5)) + 1) >> 1);

742 
‹ig_löe
++;

744 
p0
 = 
p1
 - 
block_size_x
 ;

746 
	}
}

755 
ölöe
 
	$gë_block_luma_Ÿf
–
VideoP¨amëîs
 *
p_Vid
,

756 
img≥l
* 
m¥ed
,

757 * 
tmp_¥ed
,

758 
pic_pix_x
,

759 
pic_pix_y
,

760 
block_size_x
,

761 
block_size_y
,

762 
St‹abÀPi˘uª
 *
ªf
,

763 
∂


766 
img≥l
 **
ªf_block
 = (
p_Vid
->
P444_joöed
 && 
∂
>
PLANE_Y
)? 
ªf
->
imgUV
[∂-1] :Ñef->
imgY
;

767 
dx
 = (
pic_pix_x
 & 0x03);

768 
dy
 = (
pic_pix_y
 & 0x03);

769 
x_pos
 = 
	`iClù3
(-
IMG_PAD_SIZE_X
+2, 
ªf
->
size_x_∑d
-2, 
pic_pix_x
>>2);

770 
y_pos
 = 
	`iClù3
(-
IMG_PAD_SIZE_Y
+2, 
ªf
->
size_y_∑d
-2, 
pic_pix_y
>>2);

772 i‡(
dx
 =0 && 
dy
 == 0)

773 
	`gë_block_00
(
m¥ed
, &(
ªf_block
[
y_pos
][
x_pos
]), 
block_size_y
, 
block_size_x
, 
p_Vid
->
∑dded_size_x
);

776 i‡(
dy
 == 0)

778 i‡(
dx
 == 1)

779 
	`gë_luma_10
(
m¥ed
, &
ªf_block
[
y_pos
], 
block_size_y
, 
block_size_x
, 
x_pos
, 
p_Vid
->
max_img≥l_vÆue
);

780 i‡(
dx
 == 2)

781 
	`gë_luma_20
(
m¥ed
, &
ªf_block
[
y_pos
], 
block_size_y
, 
block_size_x
, 
x_pos
, 
p_Vid
->
max_img≥l_vÆue
);

783 
	`gë_luma_30
(
m¥ed
, &
ªf_block
[
y_pos
], 
block_size_y
, 
block_size_x
, 
x_pos
, 
p_Vid
->
max_img≥l_vÆue
);

785 i‡(
dx
 == 0)

787 i‡(
dy
 == 1)

788 
	`gë_luma_01
(
m¥ed
, &
ªf_block
[
y_pos
], 
block_size_y
, 
block_size_x
, 
x_pos
, 
p_Vid
->
∑dded_size_x
,Ö_Vid->
max_img≥l_vÆue
);

789 i‡(
dy
 == 2)

790 
	`gë_luma_02
(
m¥ed
, &
ªf_block
[
y_pos
], 
block_size_y
, 
block_size_x
, 
x_pos
, 
p_Vid
->
∑dded_size_x
,Ö_Vid->
max_img≥l_vÆue
);

792 
	`gë_luma_03
(
m¥ed
, &
ªf_block
[
y_pos
], 
block_size_y
, 
block_size_x
, 
x_pos
, 
p_Vid
->
∑dded_size_x
,Ö_Vid->
max_img≥l_vÆue
);

794 i‡(
dx
 == 2)

796 i‡(
dy
 == 1)

797 
	`gë_luma_21
(
m¥ed
, &
ªf_block
[
y_pos
], 
tmp_¥ed
, 
block_size_y
, 
block_size_x
, 
x_pos
, 
p_Vid
->
max_img≥l_vÆue
);

798 i‡(
dy
 == 2)

799 
	`gë_luma_22
(
m¥ed
, &
ªf_block
[
y_pos
], 
tmp_¥ed
, 
block_size_y
, 
block_size_x
, 
x_pos
, 
p_Vid
->
max_img≥l_vÆue
);

801 
	`gë_luma_23
(
m¥ed
, &
ªf_block
[
y_pos
], 
tmp_¥ed
, 
block_size_y
, 
block_size_x
, 
x_pos
, 
p_Vid
->
max_img≥l_vÆue
);

803 i‡(
dy
 == 2)

805 i‡(
dx
 == 1)

806 
	`gë_luma_12
(
m¥ed
, &
ªf_block
[
y_pos
], 
tmp_¥ed
, 
block_size_y
, 
block_size_x
, 
x_pos
, 
p_Vid
->
∑dded_size_x
,Ö_Vid->
max_img≥l_vÆue
);

808 
	`gë_luma_32
(
m¥ed
, &
ªf_block
[
y_pos
], 
tmp_¥ed
, 
block_size_y
, 
block_size_x
, 
x_pos
, 
p_Vid
->
∑dded_size_x
,Ö_Vid->
max_img≥l_vÆue
);

812 i‡(
dx
 == 1)

814 i‡(
dy
 == 1)

815 
	`gë_luma_11
(
m¥ed
, &
ªf_block
[
y_pos
], 
block_size_y
, 
block_size_x
, 
x_pos
, 
p_Vid
->
∑dded_size_x
,Ö_Vid->
max_img≥l_vÆue
);

817 
	`gë_luma_13
(
m¥ed
, &
ªf_block
[
y_pos
], 
block_size_y
, 
block_size_x
, 
x_pos
, 
p_Vid
->
∑dded_size_x
,Ö_Vid->
max_img≥l_vÆue
);

821 i‡(
dy
 == 1)

822 
	`gë_luma_31
(
m¥ed
, &
ªf_block
[
y_pos
], 
block_size_y
, 
block_size_x
, 
x_pos
, 
p_Vid
->
∑dded_size_x
,Ö_Vid->
max_img≥l_vÆue
);

824 
	`gë_luma_33
(
m¥ed
, &
ªf_block
[
y_pos
], 
block_size_y
, 
block_size_x
, 
x_pos
, 
p_Vid
->
∑dded_size_x
,Ö_Vid->
max_img≥l_vÆue
);

828 
	}
}

830 
	$gë_block_luma_Ÿf_L2
–
VideoP¨amëîs
 *
p_Vid
,

831 
img≥l
* 
m¥ed
,

832 * 
tmp_¥ed
,

833 
pic_pix_x
,

834 
pic_pix_y
,

835 
block_size_x
,

836 
block_size_y
,

837 
St‹abÀPi˘uª
 *
ªf
,

838 
∂


841 
	`gë_block_luma_Ÿf
–
p_Vid
, 
m¥ed
, 
tmp_¥ed
, 
pic_pix_x
, 
pic_pix_y
, 
block_size_x
, 
block_size_y
, 
ªf
, 
∂
 ) ;

842 
	}
}

844 
	$gë_block_luma_Ÿf_L1
–
VideoP¨amëîs
 *
p_Vid
,

845 
img≥l
* 
m¥ed
,

846 * 
tmp_¥ed
,

847 
pic_pix_x
,

848 
pic_pix_y
,

849 
block_size_x
,

850 
block_size_y
,

851 
St‹abÀPi˘uª
 *
ªf
,

852 
∂


855 if–
	`is_q≥l
–
pic_pix_x
, 
pic_pix_y
, 0x03, 0x03 ) )

857 
	`gë_block_luma_Ÿf
–
p_Vid
, 
m¥ed
, 
tmp_¥ed
, 
pic_pix_x
, 
pic_pix_y
, 
block_size_x
, 
block_size_y
, 
ªf
, 
∂
 ) ;

861 
j
;

862 
img≥l
 *
ªf_löe
 ;

863 
ªf
->
p_cuº_img_sub
 = (
p_Vid
->
P444_joöed
 && 
∂
>
PLANE_Y
Ë? (ªf->
imgUV_sub
[∂-1]):‘ef->
imgY_sub
);

864 
ªf_löe
 = 
	`UMVLöe4X_Ÿf
 ( 
ªf
, 
pic_pix_y
, 
pic_pix_x
 ) ;

865 
j
 = 0; j < 
block_size_y
; j++)

867 
	`mem˝y
(
m¥ed
, 
ªf_löe
, 
block_size_x
 * (
img≥l
));

868 
ªf_löe
 +
p_Vid
->
∑dded_size_x
;

869 
m¥ed
 +
block_size_x
;

872 
	}
}

880 
	$gë_chroma_0X
(
img≥l
 *
block
, img≥»*
cur_img
, 
•™
, 
block_size_y
, 
block_size_x
, 
w00
, 
w01
, 
tŸÆ_sˇÀ
)

882 
img≥l
 *
cur_row
 = 
cur_img
;

883 
img≥l
 *
nxt_row
 = 
cur_img
 + 
•™
;

886 
img≥l
 *
cur_löe
, *
cur_löe_p1
;

887 
img≥l
 *
blk_löe
;

888 
ªsu…
;

889 
i
, 
j
;

890 
j
 = 0; j < 
block_size_y
; j++)

892 
cur_löe
 = 
cur_row
;

893 
cur_löe_p1
 = 
nxt_row
;

894 
blk_löe
 = 
block
;

895 
block
 +
block_size_x
 ;

896 
cur_row
 = 
nxt_row
;

897 
nxt_row
 +
•™
;

898 
i
 = 0; i < 
block_size_x
; i++)

900 
ªsu…
 = (
w00
 * *
cur_löe
++ + 
w01
 * *
cur_löe_p1
++);

901 *(
blk_löe
++Ë(
img≥l
Ë
	`rshi·_∫d_sf
(
ªsu…
, 
tŸÆ_sˇÀ
);

904 
	}
}

912 
	$gë_chroma_X0
(
img≥l
 *
block
, img≥»*
cur_img
, 
•™
, 
block_size_y
, 
block_size_x
, 
w00
, 
w10
, 
tŸÆ_sˇÀ
)

914 
img≥l
 *
cur_row
 = 
cur_img
;

915 
img≥l
 *
cur_löe
, *
cur_löe_p1
;

916 
img≥l
 *
blk_löe
;

917 
ªsu…
;

918 
i
, 
j
;

919 
j
 = 0; j < 
block_size_y
; j++)

921 
cur_löe
 = 
cur_row
;

922 
cur_löe_p1
 = 
cur_löe
 + 1;

923 
blk_löe
 = 
block
;

924 
block
 +
block_size_x
 ;

925 
cur_row
 +
•™
;

926 
i
 = 0; i < 
block_size_x
; i++)

928 
ªsu…
 = (
w00
 * *
cur_löe
++ + 
w10
 * *
cur_löe_p1
++);

930 *(
blk_löe
++Ë(
img≥l
Ë
	`rshi·_∫d_sf
(
ªsu…
, 
tŸÆ_sˇÀ
);

933 
	}
}

942 
	$gë_chroma_XX
(
img≥l
 *
block
, img≥»*
cur_img
, 
•™
, 
block_size_y
, 
block_size_x
, 
w00
, 
w01
, 
w10
, 
w11
, 
tŸÆ_sˇÀ
)

944 
img≥l
 *
cur_row
 = 
cur_img
;

945 
img≥l
 *
nxt_row
 = 
cur_img
 + 
•™
;

946 
img≥l
 *
cur_löe
, *
cur_löe_p1
;

947 
img≥l
 *
blk_löe
;

948 
ªsu…
;

949 
i
, 
j
;

950 
j
 = 0; j < 
block_size_y
; j++)

952 
cur_löe
 = 
cur_row
;

953 
cur_löe_p1
 = 
nxt_row
;

954 
blk_löe
 = 
block
;

955 
block
 +
block_size_x
 ;

956 
cur_row
 = 
nxt_row
;

957 
nxt_row
 +
•™
;

958 
i
 = 0; i < 
block_size_x
; i++)

960 
ªsu…
 = (
w00
 * *(
cur_löe
++Ë+ 
w01
 * *(
cur_löe_p1
++));

961 
ªsu…
 +(
w10
 * *(
cur_löe
 ) + 
w11
 * *(
cur_löe_p1
 ));

962 *(
blk_löe
++Ë(
img≥l
Ë
	`rshi·_∫d_sf
(
ªsu…
, 
tŸÆ_sˇÀ
);

966 
	}
}

968 
ölöe
 
	$gë_block_chroma_Ÿf
 ( 
VideoP¨amëîs
 *
p_Vid
,

969 
img≥l
* 
m¥ed
,

970 * 
tmp_¥ed
,

971 
pic_pix_x
,

972 
pic_pix_y
,

973 
block_size_x
,

974 
block_size_y
,

975 
St‹abÀPi˘uª
 *
ªf
,

976 
uv
 )

978 
dx
 = (
pic_pix_x
 & 
p_Vid
->
chroma_mask_mv_x
) ;

979 
dy
 = (
pic_pix_y
 & 
p_Vid
->
chroma_mask_mv_y
) ;

980 
x_pos
 = 
	`iClù3
(-
ªf
->
∑d_size_uv_x
+1,Ñef->
size_x_¸_∑d
-1, 
pic_pix_x
 >> 
p_Vid
->
chroma_shi·_x
) ;

981 
y_pos
 = 
	`iClù3
(-
ªf
->
∑d_size_uv_y
+1,Ñef->
size_y_¸_∑d
-1, 
pic_pix_y
 >> 
p_Vid
->
chroma_shi·_y
) ;

982 
tŸÆ_sˇÀ
 = 
p_Vid
->
chroma_shi·_x
 +Ö_Vid->
chroma_shi·_y
 ;

985 
img≥l
 *
ªf_löe
 = &(
ªf
->
imgUV
[ 
uv
-1 ][
y_pos
][
x_pos
]) ;

987 i‡(
dx
 =0 && 
dy
 == 0)

989 
	`gë_block_00
(
m¥ed
, 
ªf_löe
, 
block_size_y
, 
block_size_x
, 
p_Vid
->
¸_∑dded_size_x
);

993 
dxcur
 = (Ë(
p_Vid
->
chroma_mask_mv_x
 + 1 - 
dx
);

994 
dycur
 = (Ë(
p_Vid
->
chroma_mask_mv_y
 + 1 - 
dy
);

995 
w00
 = 
dxcur
 * 
dycur
;

996 i‡(
dx
 == 0)

998 
w01
 = 
dxcur
 * 
dy
;

999 
	`gë_chroma_0X
(
m¥ed
, 
ªf_löe
, 
p_Vid
->
¸_∑dded_size_x
, 
block_size_y
, 
block_size_x
, 
w00
, 
w01
, 
tŸÆ_sˇÀ
);

1001 i‡(
dy
 == 0)

1003 
w10
 = 
dx
 * 
dycur
;

1004 
	`gë_chroma_X0
(
m¥ed
, 
ªf_löe
, 
p_Vid
->
¸_∑dded_size_x
, 
block_size_y
, 
block_size_x
, 
w00
, 
w10
, 
tŸÆ_sˇÀ
);

1008 
w01
 = 
dxcur
 * 
dy
;

1009 
w10
 = 
dx
 * 
dycur
;

1010 
w11
 = 
dx
 * 
dy
;

1011 
	`gë_chroma_XX
(
m¥ed
, 
ªf_löe
, 
p_Vid
->
¸_∑dded_size_x
, 
block_size_y
, 
block_size_x
, 
w00
, 
w01
, 
w10
, 
w11
, 
tŸÆ_sˇÀ
);

1014 
	}
}

1017 
	$gë_block_chroma_Ÿf_L2
 ( 
VideoP¨amëîs
 *
p_Vid
,

1018 
img≥l
* 
m¥ed
,

1019 * 
tmp_¥ed
,

1020 
pic_pix_x
,

1021 
pic_pix_y
,

1022 
block_size_x
,

1023 
block_size_y
,

1024 
St‹abÀPi˘uª
 *
ªf
,

1025 
uv
 )

1027 
	`gë_block_chroma_Ÿf
 ( 
p_Vid
, 
m¥ed
, 
tmp_¥ed
, 
pic_pix_x
, 
pic_pix_y
, 
block_size_x
, 
block_size_y
, 
ªf
, 
uv
 );

1028 
	}
}

1031 
	$me_gë_block_chroma_Ÿf_L1
 ( 
VideoP¨amëîs
 *
p_Vid
,

1032 
img≥l
* 
m¥ed
,

1033 * 
tmp_¥ed
,

1034 
pic_pix_x
,

1035 
pic_pix_y
,

1036 
block_size_x
,

1037 
block_size_y
,

1038 
St‹abÀPi˘uª
 *
ªf
,

1039 
uv
 )

1041 if–
	`is_q≥l
–
pic_pix_x
, 
pic_pix_y
, 
ªf
->
chroma_mask_mv_x
,Ñef->
chroma_mask_mv_y
) )

1043 
	`gë_block_chroma_Ÿf
 ( 
p_Vid
, 
m¥ed
, 
tmp_¥ed
, 
pic_pix_x
, 
pic_pix_y
, 
block_size_x
, 
block_size_y
, 
ªf
, 
uv
 );

1047 
j
;

1048 
img≥l
 *
ªf_löe
 = 
	`UMVLöe8X_chroma_Ÿf
 (
ªf
, 
uv
, 
pic_pix_y
, 
pic_pix_x
);

1049 
j
 = 0; j < 
block_size_y
; j++)

1051 
	`mem˝y
(
m¥ed
, 
ªf_löe
, 
block_size_x
 * (
img≥l
));

1052 
ªf_löe
 +
p_Vid
->
¸_∑dded_size_x
;

1053 
m¥ed
 +
block_size_x
;

1056 
	}
}

1058 
	$mc_gë_block_chroma_Ÿf_L1
 ( 
VideoP¨amëîs
 *
p_Vid
,

1059 
img≥l
* 
m¥ed
,

1060 * 
tmp_¥ed
,

1061 
pic_pix_x
,

1062 
pic_pix_y
,

1063 
block_size_x
,

1064 
block_size_y
,

1065 
St‹abÀPi˘uª
 *
ªf
,

1066 
uv
 )

1068 if–
	`is_q≥l
–
pic_pix_x
, 
pic_pix_y
, 
ªf
->
chroma_mask_mv_x
,Ñef->
chroma_mask_mv_y
 ) )

1070 
	`gë_block_chroma_Ÿf
 ( 
p_Vid
, 
m¥ed
, 
tmp_¥ed
, 
pic_pix_x
, 
pic_pix_y
, 
block_size_x
, 
block_size_y
, 
ªf
, 
uv
 );

1074 
j
;

1075 
img≥l
 *
ªf_löe
 = 
	`UMVLöe4X¸_Ÿf
 (
ªf
, 
uv
, 
pic_pix_y
, 
pic_pix_x
);

1076 
j
 = 0; j < 
block_size_y
; j++)

1078 
	`mem˝y
(
m¥ed
, 
ªf_löe
, 
block_size_x
 * (
img≥l
));

1079 
ªf_löe
 +
p_Vid
->
¸_∑dded_size_x
;

1080 
m¥ed
 +
block_size_x
;

1083 
	}
}

	@lencod/src/header.c

15 
	~<m©h.h
>

17 
	~"globÆ.h
"

19 
	~"ñemíts.h
"

20 
	~"hódî.h
"

21 
	~"πp.h
"

22 
	~"mbuf„r.h
"

23 
	~"vlc.h
"

24 
	~"∑r£t.h
"

25 
	~"li°_ª‹dî.h
"

28 #i‡
TRACE


29 
	#SYMTRACESTRING
(
s
Ë
	`°∫˝y
(
sym
.
åa˚°rög
,s,
TRACESTRING_SIZE
)

	)

31 
	#SYMTRACESTRING
(
s
)

33 

	)

34 c⁄° * 
	gassignSE2∑πôi⁄
[2] ;

35 c⁄° 
	gassignSE2∑πôi⁄_NoDP
[
SE_MAX_ELEMENTS
] =

37 c⁄° 
	gassignSE2∑πôi⁄_DP
[
SE_MAX_ELEMENTS
] =

41 #i‡(
MVC_EXTENSION_ENABLE
)

42 
mvc_ªf_pic_li°_ª‹dîög
(
Sli˚
 *
cuºSli˚
, 
Bô°ªam
 *
bô°ªam
);

44 
ªf_pic_li°_ª‹dîög
(
Sli˚
 *
cuºSli˚
, 
Bô°ªam
 *
bô°ªam
);

45 
¥ed_weight_èbÀ
 (
Sli˚
 *
cuºSli˚
, 
Bô°ªam
 *
bô°ªam
);

46 
gë_pi˘uª_ty≥
 (
Sli˚
 *
cuºSli˚
);

56 
	$Sli˚Hódî
(
Sli˚
* 
cuºSli˚
)

58 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

59 
£q_∑ømëî_£t_rb•_t
 *
a˘ive_•s
 = 
cuºSli˚
->active_sps;

60 
pic_∑ømëî_£t_rb•_t
 *
a˘ive_µs
 = 
cuºSli˚
->active_pps;

62 
dP_ƒ
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
∑πôi⁄_mode
][
SE_HEADER
];

63 
Bô°ªam
 *
bô°ªam
 = 
cuºSli˚
->
∑πAº
[
dP_ƒ
].bitstream;

64 
Àn
 = 0;

65 
fõld_pic_Êag
 = 0;

66 
byã
 
bŸtom_fõld_Êag
 = 0;

68 
num_bôs_¶i˚_group_ch™ge_cy˛e
;

69 
numtmp
;

71 i‡(
cuºSli˚
->
mb_aff_‰ame_Êag
)

72 
Àn
 = 
	`wrôe_ue_v
("SH: fú°_mb_ö_¶i˚", 
p_Vid
->
cuºít_mb_ƒ
 >> 1, 
bô°ªam
);

74 
Àn
 = 
	`wrôe_ue_v
("SH: fú°_mb_ö_¶i˚", 
p_Vid
->
cuºít_mb_ƒ
, 
bô°ªam
);

76 
Àn
 +
	`wrôe_ue_v
("SH: sli˚_ty≥", 
	`gë_pi˘uª_ty≥
 (
cuºSli˚
), 
bô°ªam
);

78 
Àn
 +
	`wrôe_ue_v
("SH:Öic_∑ømëî_£t_id" , 
a˘ive_µs
->
pic_∑ømëî_£t_id
 ,
bô°ªam
);

80 if–
a˘ive_•s
->
£∑øã_cﬁour_∂™e_Êag
 == 1 )

81 
Àn
 +
	`wrôe_u_v
–2, "SH: cﬁour_∂™e_id", 
p_Vid
->
cﬁour_∂™e_id
, 
bô°ªam
 );

83 #i‡(
MVC_EXTENSION_ENABLE
)

87 
Àn
 +
	`wrôe_u_v
 (
p_Vid
->
log2_max_‰ame_num_möus4
 + 4,"SH: føme_num",Ö_Vid->
‰ame_num
, 
bô°ªam
);

89 
Àn
 +
	`wrôe_u_v
 (
p_Vid
->
log2_max_‰ame_num_möus4
 + 4,"SH: føme_num",Ö_Vid->
‰ame_num
, 
bô°ªam
);

92 i‡(!
cuºSli˚
->
a˘ive_•s
->
‰ame_mbs_⁄ly_Êag
)

95 
fõld_pic_Êag
 = (
cuºSli˚
->
°ru˘uª
 =
TOP_FIELD
 || cuºSli˚->°ru˘uª ==
BOTTOM_FIELD
)?1:0;

96 
	`as£π
–
fõld_pic_Êag
 =
p_Vid
->
Êd_Êag
 );

97 
Àn
 +
	`wrôe_u_1
("SH: fõld_pic_Êag", 
fõld_pic_Êag
, 
bô°ªam
);

99 i‡(
fõld_pic_Êag
)

102 
bŸtom_fõld_Êag
 = (
byã
Ë(
cuºSli˚
->
°ru˘uª
 =
BOTTOM_FIELD
);

103 
Àn
 +
	`wrôe_u_1
("SH: bŸtom_fõld_Êag" , 
bŸtom_fõld_Êag
 ,
bô°ªam
);

107 #i‡(
MVC_EXTENSION_ENABLE
)

108 i‡(
cuºSli˚
->
idr_Êag
 || (
p_Vid
->
võw_id
 && !p_Vid->
n⁄_idr_Êag
[cuºSli˚->
°ru˘uª
 =
BOTTOM_FIELD
 ? 1 : 0]) )

110 i‡(
cuºSli˚
->
idr_Êag
)

114 
Àn
 +
	`wrôe_ue_v
 ("SH: idr_pic_id", (
p_Vid
->
numbî
 & 0x01), 
bô°ªam
);

117 i‡(
p_Vid
->
pic_‹dî_˙t_ty≥
 == 0)

119 i‡(
a˘ive_•s
->
‰ame_mbs_⁄ly_Êag
)

121 
p_Vid
->
pic_‹dî_˙t_lsb
 = (p_Vid->
t›poc
 & ~(((()(-1)Ë<< (p_Vid->
log2_max_pic_‹dî_˙t_lsb_möus4
+4))) );

125 i‡(!
fõld_pic_Êag
 || 
cuºSli˚
->
°ru˘uª
 =
TOP_FIELD
)

126 
p_Vid
->
pic_‹dî_˙t_lsb
 = (p_Vid->
t›poc
 & ~(((()(-1)Ë<< (p_Vid->
log2_max_pic_‹dî_˙t_lsb_möus4
+4))) );

127 i‡–
cuºSli˚
->
°ru˘uª
 =
BOTTOM_FIELD
 )

128 
p_Vid
->
pic_‹dî_˙t_lsb
 = (p_Vid->
bŸtompoc
 & ~(((()(-1)Ë<< (p_Vid->
log2_max_pic_‹dî_˙t_lsb_möus4
+4))) );

131 
Àn
 +
	`wrôe_u_v
 (
p_Vid
->
log2_max_pic_‹dî_˙t_lsb_möus4
+4, "SH:Öic_‹dî_˙t_lsb",Ö_Vid->
pic_‹dî_˙t_lsb
, 
bô°ªam
);

133 i‡(
p_Vid
->
bŸtom_fõld_pic_‹dî_ö_‰ame_¥e£¡_Êag
 && !
fõld_pic_Êag
)

135 
Àn
 +
	`wrôe_£_v
 ("SH: dñè_pic_‹dî_˙t_bŸtom", 
p_Vid
->
dñè_pic_‹dî_˙t_bŸtom
, 
bô°ªam
);

138 i‡(
p_Vid
->
pic_‹dî_˙t_ty≥
 =1 && !p_Vid->
dñè_pic_‹dî_Æways_zîo_Êag
)

140 
Àn
 +
	`wrôe_£_v
 ("SH: dñè_pic_‹dî_˙t[0]", 
p_Vid
->
dñè_pic_‹dî_˙t
[0], 
bô°ªam
);

142 i‡(
p_Vid
->
bŸtom_fõld_pic_‹dî_ö_‰ame_¥e£¡_Êag
 && !
fõld_pic_Êag
)

144 
Àn
 +
	`wrôe_£_v
 ("SH: dñè_pic_‹dî_˙t[1]", 
p_Vid
->
dñè_pic_‹dî_˙t
[1], 
bô°ªam
);

148 i‡(
a˘ive_µs
->
ªdund™t_pic_˙t_¥e£¡_Êag
)

150 
Àn
 +
	`wrôe_ue_v
 ("SH:Ñedund™t_pic_˙t", 
p_Vid
->
ªdund™t_pic_˙t
, 
bô°ªam
);

154 i‡(
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
)

156 
Àn
 +
	`wrôe_u_1
 ("SH: dúe˘_•©ül_mv_¥ed_Êag", 
p_Vid
->
dúe˘_•©ül_mv_¥ed_Êag
, 
bô°ªam
);

159 i‡((
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
Ë|| (cuºSli˚->¶i˚_ty≥ =
B_SLICE
Ë|| cuºSli˚->¶i˚_ty≥==
SP_SLICE
)

161 
ovîride_Êag
;

162 i‡((
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
Ë|| (cuºSli˚->¶i˚_ty≥ =
SP_SLICE
))

164 
ovîride_Êag
 = (
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
] !(
a˘ive_µs
->
num_ªf_idx_l0_deÁu…_a˘ive_möus1
 +1)) ? 1 : 0;

168 
ovîride_Êag
 = ((
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
] !(
a˘ive_µs
->
num_ªf_idx_l0_deÁu…_a˘ive_möus1
 +1))

169 || (
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_1
] !(
a˘ive_µs
->
num_ªf_idx_l1_deÁu…_a˘ive_möus1
 +1))) ? 1 : 0;

172 
Àn
 +
	`wrôe_u_1
 ("SH:Çum_ªf_idx_a˘ive_ovîride_Êag", 
ovîride_Êag
, 
bô°ªam
);

174 i‡(
ovîride_Êag
)

176 
Àn
 +
	`wrôe_ue_v
 ("SH:Çum_ªf_idx_l0_a˘ive_möus1", 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
]-1, 
bô°ªam
);

177 i‡(
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
)

179 
Àn
 +
	`wrôe_ue_v
 ("SH:Çum_ªf_idx_l1_a˘ive_möus1", 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_1
]-1, 
bô°ªam
);

186 #i‡(
MVC_EXTENSION_ENABLE
)

187 if(
cuºSli˚
->
œyî_id
 > 0)

188 
Àn
 +
	`mvc_ªf_pic_li°_ª‹dîög
(
cuºSli˚
, 
bô°ªam
);

191 
Àn
 +
	`ªf_pic_li°_ª‹dîög
(
cuºSli˚
, 
bô°ªam
);

193 i‡(((
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
 || cuºSli˚->¶i˚_ty≥ =
SP_SLICE
Ë&& 
a˘ive_µs
->
weighãd_¥ed_Êag
) ||

194 ((
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
Ë&& cuºSli˚->
weighãd_¥edi˘i⁄
 == 1))

196 
Àn
 +
	`¥ed_weight_èbÀ
(
cuºSli˚
, 
bô°ªam
);

199 i‡(
p_Vid
->
«l_ª„ªn˚_idc
)

201 
p_Vid
->
ad≠tive_ªf_pic_buf„rög_Êag
 = (p_Vid->
dec_ªf_pic_m¨kög_buf„r
 !
NULL
);

202 
Àn
 +
	`dec_ªf_pic_m¨kög
(
bô°ªam
,

203 
p_Vid
->
dec_ªf_pic_m¨kög_buf„r
,

204 #i‡(
MVC_EXTENSION_ENABLE
)

205 (
cuºSli˚
->
idr_Êag
 || (
p_Vid
->
võw_id
 && !p_Vid->
n⁄_idr_Êag
[cuºSli˚->
°ru˘uª
 =
BOTTOM_FIELD
 ? 1 : 0]) ) ? 1 : 0,

207 
cuºSli˚
->
idr_Êag
,

209 
p_Vid
->
no_ouçut_of_¥i‹_pics_Êag
,

210 
p_Vid
->
l⁄g_ãrm_ª„ªn˚_Êag
 );

213 if(
cuºSli˚
->
symbﬁ_mode
==
CABAC
 && cuºSli˚->
¶i˚_ty≥
!=
I_SLICE
 )

215 
Àn
 +
	`wrôe_ue_v
("SH: cabac_öô_idc", 
cuºSli˚
->
modñ_numbî
, 
bô°ªam
);

218 
Àn
 +
	`wrôe_£_v
("SH: sli˚_qp_dñè", (
cuºSli˚
->
qp
 - 26 - 
a˘ive_µs
->
pic_öô_qp_möus26
), 
bô°ªam
);

220 i‡(
cuºSli˚
->
¶i˚_ty≥
 =
SP_SLICE
 || cuºSli˚->¶i˚_ty≥ =
SI_SLICE
)

222 i‡(
cuºSli˚
->
¶i˚_ty≥
 =
SP_SLICE
)

224 
Àn
 +
	`wrôe_u_1
 ("SH: sp_f‹_swôch_Êag", 
cuºSli˚
->
•2_‰ame_ödiˇt‹
, 
bô°ªam
);

226 
Àn
 +
	`wrôe_£_v
 ("SH: sli˚_qs_dñè", (
p_Vid
->
qp•
 - 26), 
bô°ªam
 );

229 i‡(
a˘ive_µs
->
deblockög_fûãr_c⁄åﬁ_¥e£¡_Êag
)

231 
Àn
 +
	`wrôe_ue_v
("SH: dißbÀ_deblockög_fûãr_idc",
cuºSli˚
->
DFDißbÀIdc
, 
bô°ªam
);

233 i‡(
cuºSli˚
->
DFDißbÀIdc
!=1)

235 
Àn
 +
	`wrôe_£_v
 ("SH: sli˚_Æpha_c0_off£t_div2", 
cuºSli˚
->
DFAÕhaC0Off£t
 / 2, 
bô°ªam
);

236 
Àn
 +
	`wrôe_£_v
 ("SH: sli˚_bëa_off£t_div2 ", 
cuºSli˚
->
DFBëaOff£t
 / 2, 
bô°ªam
);

240 i‡–
a˘ive_µs
->
num_¶i˚_groups_möus1
 > 0 &&

241 
a˘ive_µs
->
¶i˚_group_m≠_ty≥
 >= 3 &&áctive_pps->slice_group_map_type <= 5)

243 
numtmp
=
p_Vid
->
PicHeightInM≠Unôs
*p_Vid->
PicWidthInMbs
/()(
a˘ive_µs
->
¶i˚_group_ch™ge_øã_möus1
+1)+1;

244 
num_bôs_¶i˚_group_ch™ge_cy˛e
 = ()
	`˚û
(
	`log
(
numtmp
)/log(2));

247 
Àn
 +
	`wrôe_u_v
 (
num_bôs_¶i˚_group_ch™ge_cy˛e
, "SH: sli˚_group_ch™ge_cy˛e", 
p_Vid
->
¶i˚_group_ch™ge_cy˛e
, 
bô°ªam
);

253 if(
cuºSli˚
->
∑πôi⁄_mode
 && !cuºSli˚->
idr_Êag
)

255 
Àn
 +
	`wrôe_ue_v
("DPA: sli˚_id", 
cuºSli˚
->
¶i˚_ƒ
, 
bô°ªam
);

258  
Àn
;

259 
	}
}

271 
	$ªf_pic_li°_ª‹dîög
(
Sli˚
 *
cuºSli˚
, 
Bô°ªam
 *
bô°ªam
)

273 
li°
;

274 
i
, 
Àn
=0;

276 
li°
 = 
LIST_0
;Üi° <
LIST_1
;Üist++)

278 if(
cuºSli˚
->
num_ªf_idx_a˘ive
[
li°
]==0)

281 
	`ª‹dî_agaö°_deÁu…_ªf_pic_li°s
(
cuºSli˚
, 
li°
);

283 i‡(
cuºSli˚
->
¶i˚_ty≥
!=
I_SLICE
 && cuºSli˚->¶i˚_ty≥!=
SI_SLICE
)

285 
Àn
 +
	`wrôe_u_1
 ("SH:Ñef_pic_li°_ª‹dîög_Êag", 
cuºSli˚
->
ªf_pic_li°_ª‹dîög_Êag
[
li°
], 
bô°ªam
);

286 i‡(
cuºSli˚
->
ªf_pic_li°_ª‹dîög_Êag
[
li°
])

288 
i
=-1;

291 
i
++;

292 
Àn
 +
	`wrôe_ue_v
 ("SH: modifiˇti⁄_of_pic_nums_idc", 
cuºSli˚
->
modifiˇti⁄_of_pic_nums_idc
[
li°
][
i
], 
bô°ªam
);

293 i‡(
cuºSli˚
->
modifiˇti⁄_of_pic_nums_idc
[
li°
][
i
] == 0 || currSlice->modification_of_pic_nums_idc[list][i] == 1)

295 
Àn
 +
	`wrôe_ue_v
 ("SH:ábs_diff_pic_num_möus1", 
cuºSli˚
->
abs_diff_pic_num_möus1
[
li°
][
i
], 
bô°ªam
);

297 i‡(
cuºSli˚
->
modifiˇti⁄_of_pic_nums_idc
[
li°
][
i
] == 2)

299 
Àn
 +
	`wrôe_ue_v
 ("SH:Ü⁄g_ãrm_pic_idx", 
cuºSli˚
->
l⁄g_ãrm_pic_idx
[
li°
][
i
], 
bô°ªam
);

301 } 
cuºSli˚
->
modifiˇti⁄_of_pic_nums_idc
[
li°
][
i
] != 3);

306  
Àn
;

307 
	}
}

309 #i‡(
MVC_EXTENSION_ENABLE
)

321 
	$mvc_ªf_pic_li°_ª‹dîög
(
Sli˚
 *
cuºSli˚
, 
Bô°ªam
 *
bô°ªam
)

323 
li°
;

324 
i
, 
Àn
=0;

326 
li°
 = 
LIST_0
;Üi° <
LIST_1
;Üist++)

328 if(
cuºSli˚
->
num_ªf_idx_a˘ive
[
li°
]==0)

331 
	`ª‹dî_agaö°_deÁu…_ªf_pic_li°s
(
cuºSli˚
, 
li°
);

333 i‡(
cuºSli˚
->
¶i˚_ty≥
!=
I_SLICE
 && cuºSli˚->¶i˚_ty≥!=
SI_SLICE
)

335 
Àn
 +
	`wrôe_u_1
 ("SH:Ñef_pic_li°_ª‹dîög_Êag", 
cuºSli˚
->
ªf_pic_li°_ª‹dîög_Êag
[
li°
], 
bô°ªam
);

336 i‡(
cuºSli˚
->
ªf_pic_li°_ª‹dîög_Êag
[
li°
])

338 
i
=-1;

341 
i
++;

342 
Àn
 +
	`wrôe_ue_v
 ("SH: modifiˇti⁄_of_pic_nums_idc", 
cuºSli˚
->
modifiˇti⁄_of_pic_nums_idc
[
li°
][
i
], 
bô°ªam
);

343 i‡(
cuºSli˚
->
modifiˇti⁄_of_pic_nums_idc
[
li°
][
i
] == 0 || currSlice->modification_of_pic_nums_idc[list][i] == 1)

345 
Àn
 +
	`wrôe_ue_v
 ("SH:ábs_diff_pic_num_möus1", 
cuºSli˚
->
abs_diff_pic_num_möus1
[
li°
][
i
], 
bô°ªam
);

347 i‡(
cuºSli˚
->
modifiˇti⁄_of_pic_nums_idc
[
li°
][
i
] == 2)

349 
Àn
 +
	`wrôe_ue_v
 ("SH:Ü⁄g_ãrm_pic_idx", 
cuºSli˚
->
l⁄g_ãrm_pic_idx
[
li°
][
i
], 
bô°ªam
);

351 i‡(
cuºSli˚
->
modifiˇti⁄_of_pic_nums_idc
[
li°
][
i
] == 4 || currSlice->modification_of_pic_nums_idc[list][i] == 5)

353 
Àn
 +
	`wrôe_ue_v
 ("SH:ábs_diff_võw_idx_möus1", 
cuºSli˚
->
abs_diff_võw_idx_möus1
[
li°
][
i
], 
bô°ªam
);

355 } 
cuºSli˚
->
modifiˇti⁄_of_pic_nums_idc
[
li°
][
i
] != 3);

360  
Àn
;

361 
	}
}

373 
	$dec_ªf_pic_m¨kög
(
Bô°ªam
 *
bô°ªam
, 
DecRefPicM¨kög_t
 *
p_dΩm
, 
idr_Êag
, 
no_ouçut_of_¥i‹_pics_Êag
, 
l⁄g_ãrm_ª„ªn˚_Êag
 )

375 
DecRefPicM¨kög_t
 *
tmp_dΩm
;

377 
vÆ
, 
Àn
=0;

378 
ad≠tive_ªf_pic_buf„rög_Êag
;

380 i‡(
idr_Êag
)

382 
Àn
 +
	`wrôe_u_1
("SH:Ço_ouçut_of_¥i‹_pics_Êag", 
no_ouçut_of_¥i‹_pics_Êag
, 
bô°ªam
);

383 
Àn
 +
	`wrôe_u_1
("SH:Ü⁄g_ãrm_ª„ªn˚_Êag", 
l⁄g_ãrm_ª„ªn˚_Êag
, 
bô°ªam
);

387 
ad≠tive_ªf_pic_buf„rög_Êag
 = (
p_dΩm
 !
NULL
);

389 
Àn
 +
	`wrôe_u_1
("SH:ád≠tive_ªf_pic_buf„rög_Êag", 
ad≠tive_ªf_pic_buf„rög_Êag
, 
bô°ªam
);

391 i‡(
ad≠tive_ªf_pic_buf„rög_Êag
)

393 
tmp_dΩm
 = 
p_dΩm
;

397 i‡(
tmp_dΩm
==
NULL
Ë
	`îr‹
 ("ErrorÉncoding MMCO commands", 500);

399 
vÆ
 = 
tmp_dΩm
->
mem‹y_m™agemít_c⁄åﬁ_›î©i⁄
;

400 
Àn
 +
	`wrôe_ue_v
("SH: mem‹y_m™agemít_c⁄åﬁ_›î©i⁄", 
vÆ
, 
bô°ªam
);

402 i‡((
vÆ
==1)||(val==3))

404 
Àn
 +1 + 
	`wrôe_ue_v
("SH: dif„ªn˚_of_pic_nums_möus1", 
tmp_dΩm
->
dif„ªn˚_of_pic_nums_möus1
, 
bô°ªam
);

406 i‡(
vÆ
==2)

408 
Àn
+
	`wrôe_ue_v
("SH:Ü⁄g_ãrm_pic_num", 
tmp_dΩm
->
l⁄g_ãrm_pic_num
, 
bô°ªam
);

410 i‡((
vÆ
==3)||(val==6))

412 
Àn
+
	`wrôe_ue_v
("SH:Ü⁄g_ãrm_‰ame_idx", 
tmp_dΩm
->
l⁄g_ãrm_‰ame_idx
, 
bô°ªam
);

414 i‡(
vÆ
==4)

416 
Àn
 +
	`wrôe_ue_v
("SH: max_l⁄g_ãrm_pic_idx_∂us1", 
tmp_dΩm
->
max_l⁄g_ãrm_‰ame_idx_∂us1
, 
bô°ªam
);

419 
tmp_dΩm
Òmp_dΩm->
Next
;

421 } 
vÆ
 != 0);

425  
Àn
;

426 
	}
}

438 
	$¥ed_weight_èbÀ
(
Sli˚
 *
cuºSli˚
, 
Bô°ªam
 *
bô°ªam
)

440 
Àn
 = 0;

441 
i
,
j
;

443 
Àn
 +
	`wrôe_ue_v
("SH:Üuma_log_weight_díom", 
cuºSli˚
->
luma_log_weight_díom
, 
bô°ªam
);

445 i‡–0 !
cuºSli˚
->
a˘ive_•s
->
chroma_f‹m©_idc
)

447 
Àn
 +
	`wrôe_ue_v
("SH: chroma_log_weight_díom", 
cuºSli˚
->
chroma_log_weight_díom
, 
bô°ªam
);

450 
i
=0; i< 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
]; i++)

452 i‡–(
cuºSli˚
->
wp_weight
[0][
i
][0] !1<<cuºSli˚->
luma_log_weight_díom
Ë|| (cuºSli˚->
wp_off£t
[0][i][0] != 0) )

454 
Àn
 +
	`wrôe_u_1
 ("SH:Üuma_weight_Êag_l0", 1, 
bô°ªam
);

455 
Àn
 +
	`wrôe_£_v
 ("SH:Üuma_weight_l0", 
cuºSli˚
->
wp_weight
[0][
i
][0], 
bô°ªam
);

456 
Àn
 +
	`wrôe_£_v
 ("SH:Üuma_off£t_l0", (
cuºSli˚
->
wp_off£t
[0][
i
][0]>>(cuºSli˚->
bôdïth_luma
 - 8)), 
bô°ªam
);

460 
Àn
 +
	`wrôe_u_1
 ("SH:Üuma_weight_Êag_l0", 0, 
bô°ªam
);

463 i‡(
cuºSli˚
->
a˘ive_•s
->
chroma_f‹m©_idc
!=0)

465 i‡–(
cuºSli˚
->
wp_weight
[0][
i
][1] !1<<cuºSli˚->
chroma_log_weight_díom
Ë|| (cuºSli˚->
wp_off£t
[0][i][1] != 0) ||

466 (
cuºSli˚
->
wp_weight
[0][
i
][2] !1<<cuºSli˚->
chroma_log_weight_díom
Ë|| (cuºSli˚->
wp_off£t
[0][i][2] != 0) )

468 
Àn
 +
	`wrôe_u_1
 ("chroma_weight_Êag_l0", 1, 
bô°ªam
);

469 
j
=1; j<3; j++)

471 
Àn
 +
	`wrôe_£_v
 ("chroma_weight_l0", 
cuºSli˚
->
wp_weight
[0][
i
][
j
] ,
bô°ªam
);

472 
Àn
 +
	`wrôe_£_v
 ("chroma_off£t_l0", (
cuºSli˚
->
wp_off£t
[0][
i
][
j
]>>(cuºSli˚->
bôdïth_chroma
-8)Ë,
bô°ªam
);

477 
Àn
 +
	`wrôe_u_1
 ("chroma_weight_Êag_l0", 0, 
bô°ªam
);

482 i‡(
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
)

484 
i
=0; i< 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_1
]; i++)

486 i‡–(
cuºSli˚
->
wp_weight
[1][
i
][0] !1<<cuºSli˚->
luma_log_weight_díom
Ë|| (cuºSli˚->
wp_off£t
[1][i][0] != 0) )

488 
Àn
 +
	`wrôe_u_1
 ("SH:Üuma_weight_Êag_l1", 1, 
bô°ªam
);

489 
Àn
 +
	`wrôe_£_v
 ("SH:Üuma_weight_l1", 
cuºSli˚
->
wp_weight
[1][
i
][0], 
bô°ªam
);

490 
Àn
 +
	`wrôe_£_v
 ("SH:Üuma_off£t_l1", (
cuºSli˚
->
wp_off£t
[1][
i
][0]>>(cuºSli˚->
bôdïth_luma
-8)), 
bô°ªam
);

494 
Àn
 +
	`wrôe_u_1
 ("SH:Üuma_weight_Êag_l1", 0, 
bô°ªam
);

497 i‡(
cuºSli˚
->
a˘ive_•s
->
chroma_f‹m©_idc
!=0)

499 i‡–(
cuºSli˚
->
wp_weight
[1][
i
][1] !1<<cuºSli˚->
chroma_log_weight_díom
Ë|| (cuºSli˚->
wp_off£t
[1][i][1] != 0) ||

500 (
cuºSli˚
->
wp_weight
[1][
i
][2] !1<<cuºSli˚->
chroma_log_weight_díom
Ë|| (cuºSli˚->
wp_off£t
[1][i][2] != 0) )

502 
Àn
 +
	`wrôe_u_1
 ("chroma_weight_Êag_l1", 1, 
bô°ªam
);

503 
j
=1; j<3; j++)

505 
Àn
 +
	`wrôe_£_v
 ("chroma_weight_l1", 
cuºSli˚
->
wp_weight
[1][
i
][
j
] ,
bô°ªam
);

506 
Àn
 +
	`wrôe_£_v
 ("chroma_off£t_l1", (
cuºSli˚
->
wp_off£t
[1][
i
][
j
]>>(cuºSli˚->
bôdïth_chroma
-8)Ë,
bô°ªam
);

511 
Àn
 +
	`wrôe_u_1
 ("chroma_weight_Êag_l1", 0, 
bô°ªam
);

516  
Àn
;

517 
	}
}

529 
	$gë_pi˘uª_ty≥
(
Sli˚
 *
cuºSli˚
)

533 
ßme_¶i˚ty≥_f‹_whﬁe_‰ame
 = 5;

535 #i‡(
MVC_EXTENSION_ENABLE
)

536 if(
cuºSli˚
->
p_I≈
->
num_of_võws
==2)

538 
ßme_¶i˚ty≥_f‹_whﬁe_‰ame
 = 0;

542 
cuºSli˚
->
¶i˚_ty≥
)

544 
I_SLICE
:

545  2 + 
ßme_¶i˚ty≥_f‹_whﬁe_‰ame
;

547 
P_SLICE
:

548  0 + 
ßme_¶i˚ty≥_f‹_whﬁe_‰ame
;

550 
B_SLICE
:

551  1 + 
ßme_¶i˚ty≥_f‹_whﬁe_‰ame
;

553 
SP_SLICE
:

554  3 + 
ßme_¶i˚ty≥_f‹_whﬁe_‰ame
;

556 
SI_SLICE
:

557  4 + 
ßme_¶i˚ty≥_f‹_whﬁe_‰ame
;

560 
	`îr‹
("Picture TypeÇot supported!",1);

565 
	}
}

596 
	$P¨tôi⁄_BC_Hódî
(
Sli˚
 *
cuºSli˚
, 
P¨tNo
)

598 
D©aP¨tôi⁄
 *
∑πôi⁄
 = &((
cuºSli˚
)->
∑πAº
[
P¨tNo
]);

599 
Sy¡axEÀmít
 
sym
;

601 
	`as£π
 (
P¨tNo
 > 0 && P¨tNÿ< 
cuºSli˚
->
max_∑π_ƒ
);

603 
sym
.
ty≥
 = 
SE_HEADER
;

604 
sym
.
vÆue2
 = 0;

606 
	`SYMTRACESTRING
("RTP-PH: Slice ID");

607 
sym
.
vÆue1
 = 
cuºSli˚
->
¶i˚_ƒ
;

608 
	`wrôeSE_UVLC
 (&
sym
, 
∑πôi⁄
);

610  
sym
.
Àn
;

611 
	}
}

	@lencod/src/image.c

28 
	~"c⁄åibut‹s.h
"

30 
	~<m©h.h
>

31 
	~<time.h
>

33 
	~"globÆ.h
"

35 
	~"fûeh™dÀ.h
"

36 
	~"mbuf„r.h
"

37 
	~"img_luma.h
"

38 
	~"img_chroma.h
"

39 
	~"img_di°‹ti⁄.h
"

40 
	~"öå¨e‰esh.h
"

41 
	~"¶i˚.h
"

42 
	~"fmo.h
"

43 
	~"£i.h
"

44 
	~"memÆloc.h
"

45 
	~"Á°_mem‹y.h
"

46 
	~"«lu.h
"

47 
	~"øã˘l.h
"

48 
	~"mb_ac˚ss.h
"

49 
	~"c⁄ãxt_öi.h
"

50 
	~"bürõncode.h
"

51 
	~"íc_°©i°ics.h
"

52 
	~"c⁄f‹m™˚.h
"

53 
	~"ªp‹t.h
"

55 
	~"q_m©rix.h
"

56 
	~"q_off£ts.h
"

57 
	~"wp.h
"

58 
	~"öput.h
"

59 
	~"image.h
"

60 
	~"îrdo.h
"

61 
	~"img_¥o˚ss.h
"

62 
	~"rd›t.h
"

63 
	~"£i.h
"

64 
	~"c⁄figfûe.h
"

65 
	~"mbuf„r.h
"

68 
	~"md_comm⁄.h
"

69 
	~"me_ïzs_comm⁄.h
"

71 
Upd©eDecodîs
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
St‹abÀPi˘uª
 *
íc_pic
);

73 
DeblockFøme
 (
VideoP¨amëîs
 *
p_Vid
, 
img≥l
 **, imgpel ***);

75 
code_a_pi˘uª
 (
VideoP¨amëîs
 *
p_Vid
, 
Pi˘uª
 *
pic
);

76 
fõld_pi˘uª
 (
VideoP¨amëîs
 *
p_Vid
, 
Pi˘uª
 *
t›
, Pi˘uª *
bŸtom
);

77 
¥ï¨e_íc_‰ame_pi˘uª
 (
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 **
°‹ed_pic
);

78 #i‡(
MVC_EXTENSION_ENABLE
)

79 
wrôeout_pi˘uª
 (
VideoP¨amëîs
 *
p_Vid
, 
Pi˘uª
 *
pic
, 
is_bŸtom
);

81 
wrôeout_pi˘uª
 (
VideoP¨amëîs
 *
p_Vid
, 
Pi˘uª
 *
pic
);

83 
byã
 
pi˘uª_°ru˘uª_decisi⁄
(
VideoP¨amëîs
 *
p_Vid
, 
Pi˘uª
 *
‰ame
, Pi˘uª *
t›
, Pi˘uª *
bŸ
);

84 
di°‹ti⁄_Êd
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
Pi˘uª
 *
fõld_pic
, 
ImageD©a
 *
imgD©a
);

86 
fõld_mode_buf„r
 (
VideoP¨amëîs
 *
p_Vid
);

87 
‰ame_mode_buf„r
 (
VideoP¨amëîs
 *
p_Vid
);

88 
öô_‰ame
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
);

89 
öô_fõld
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
);

90 
put_buf„r_‰ame
 (
VideoP¨amëîs
 *
p_Vid
);

91 
put_buf„r_t›
 (
VideoP¨amëîs
 *
p_Vid
);

92 
put_buf„r_bŸ
 (
VideoP¨amëîs
 *
p_Vid
);

94 
Rï‹tFú°‰ame
 (
VideoP¨amëîs
 *
p_Vid
, 
öt64
 
tmp_time
);

95 
Rï‹tI
 (
VideoP¨amëîs
 *
p_Vid
, 
öt64
 
tmp_time
);

96 
Rï‹tP
 (
VideoP¨amëîs
 *
p_Vid
, 
öt64
 
tmp_time
);

97 
Rï‹tB
 (
VideoP¨amëîs
 *
p_Vid
, 
öt64
 
tmp_time
);

98 
Rï‹tNALN⁄VLCBôs
(
VideoP¨amëîs
 *
p_Vid
, 
öt64
 
tmp_time
);

100 
rd_pi˘uª_codög
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
);

102 
	$MbAffPo°Proc
(
VideoP¨amëîs
 *
p_Vid
)

104 
img≥l
 
ãmp
[32][16];

106 
St‹abÀPi˘uª
 *
p_Enc_Pic
 = 
p_Vid
->
íc_pi˘uª
;

107 
img≥l
 ** 
imgY
 = 
p_Enc_Pic
->imgY;

108 
img≥l
 ***
imgUV
 = 
p_Enc_Pic
->imgUV;

109 
i
, 
y
, 
x0
, 
y0
, 
uv
;

111 i‡(
p_Vid
->
yuv_f‹m©
 !
YUV400
)

113 
i
=0; i<()
p_Vid
->
PicSizeInMbs
; i+=2)

115 i‡(
p_Enc_Pic
->
mŸi⁄
.
mb_fõld
[
i
])

117 
	`gë_mb_pos
(
p_Vid
, 
i
,Ö_Vid->
mb_size
[
IS_LUMA
], &
x0
, &
y0
);

118 
y
=0; y<(2*
MB_BLOCK_SIZE
);y++)

119 
	`mem˝y
(&
ãmp
[
y
],&
imgY
[
y0
+y][
x0
], 
MB_BLOCK_SIZE
 * (
img≥l
));

121 
y
=0; y<
MB_BLOCK_SIZE
;y++)

123 
	`mem˝y
(&
imgY
[
y0
+(2*
y
)][
x0
],
ãmp
[y], 
MB_BLOCK_SIZE
 * (
img≥l
));

124 
	`mem˝y
(&
imgY
[
y0
+(2*
y
 + 1)][
x0
],
ãmp
[y+ 
MB_BLOCK_SIZE
], MB_BLOCK_SIZE * (
img≥l
));

127 
x0
 = x0 / (16/
p_Vid
->
mb_¸_size_x
);

128 
y0
 = y0 / (16/
p_Vid
->
mb_¸_size_y
);

130 
uv
=0; uv<2; uv++)

132 
y
=0; y < (2 * 
p_Vid
->
mb_¸_size_y
); y++)

133 
	`mem˝y
(&
ãmp
[
y
],&
imgUV
[
uv
][
y0
+y][
x0
], 
p_Vid
->
mb_¸_size_x
 * (
img≥l
));

135 
y
=0; y<
p_Vid
->
mb_¸_size_y
;y++)

137 
	`mem˝y
(&
imgUV
[
uv
][
y0
+(2*
y
)][
x0
],
ãmp
[y], 
p_Vid
->
mb_¸_size_x
 * (
img≥l
));

138 
	`mem˝y
(&
imgUV
[
uv
][
y0
+(2*
y
 + 1)][
x0
],
ãmp
[y+ 
p_Vid
->
mb_¸_size_y
],Ö_Vid->
mb_¸_size_x
 * (
img≥l
));

146 
i
=0; i<()
p_Vid
->
PicSizeInMbs
; i+=2)

148 i‡(
p_Enc_Pic
->
mŸi⁄
.
mb_fõld
[
i
])

150 
	`gë_mb_pos
(
p_Vid
, 
i
,Ö_Vid->
mb_size
[
IS_LUMA
], &
x0
, &
y0
);

151 
y
=0; y<(2*
MB_BLOCK_SIZE
);y++)

152 
	`mem˝y
(&
ãmp
[
y
],&
imgY
[
y0
+y][
x0
], 
MB_BLOCK_SIZE
 * (
img≥l
));

154 
y
=0; y<
MB_BLOCK_SIZE
;y++)

156 
	`mem˝y
(&
imgY
[
y0
+(2*
y
)][
x0
],
ãmp
[y], 
MB_BLOCK_SIZE
 * (
img≥l
));

157 
	`mem˝y
(&
imgY
[
y0
+(2*
y
 + 1)][
x0
],
ãmp
[y+ 
MB_BLOCK_SIZE
], MB_BLOCK_SIZE * (
img≥l
));

162 
	}
}

171 
	$£t_¶i˚_ty≥
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
¶i˚_ty≥
)

173 
p_Vid
->
ty≥
 = (Ë
¶i˚_ty≥
;

174 
p_Vid
->
RCMöQP
 = 
p_I≈
->RCMöQP[p_Vid->
ty≥
];

175 
p_Vid
->
RCMaxQP
 = 
p_I≈
->RCMaxQP[p_Vid->
ty≥
];

176 
	}
}

178 
	$code_a_∂™e
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

180 
NumbîOfCodedMBs
 = 0;

181 
Sli˚Group
 = 0;

182 
Di°Mëric
 
di°‹ti⁄
;

186 
p_Vid
->
¶i˚_group_ch™ge_cy˛e
=1;

187 
	`FmoInô
(
p_Vid
,Ö_Vid->
a˘ive_µs
,Ö_Vid->
a˘ive_•s
);

188 
	`FmoSèπPi˘uª
 (
p_Vid
);

190 
	`CÆcuœãQu™t4x4P¨am
 (
p_Vid
);

191 
	`CÆcuœãOff£t4x4P¨am
(
p_Vid
);

193 if(
p_I≈
->
Tønsf‹m8x8Mode
)

195 
	`CÆcuœãQu™t8x8P¨am
 (
p_Vid
);

196 
	`CÆcuœãOff£t8x8P¨am
(
p_Vid
);

199 
	`ª£t_pic_bö_cou¡
(
p_Vid
);

200 
p_Vid
->
byãs_ö_pi˘uª
 = 0;

202 
NumbîOfCodedMBs
 < 
p_Vid
->
PicSizeInMbs
)

205 !
	`FmoSli˚GroupCom∂ëñyCoded
 (
p_Vid
, 
Sli˚Group
))

208 i‡(!
p_Vid
->
mb_aff_‰ame_Êag
)

209 
NumbîOfCodedMBs
 +
	`ícode_⁄e_¶i˚
 (
p_Vid
, 
Sli˚Group
, NumberOfCodedMBs);

211 
NumbîOfCodedMBs
 +
	`ícode_⁄e_¶i˚_MBAFF
 (
p_Vid
, 
Sli˚Group
, NumberOfCodedMBs);

213 
	`FmoSëLa°Ma¸oblockInSli˚
 (
p_Vid
,Ö_Vid->
cuºít_mb_ƒ
);

215 
p_Vid
->
cuºít_¶i˚_ƒ
++;

216 
p_Vid
->
p_Sèts
->
bô_¶i˚
 = 0;

219 
Sli˚Group
++;

221 
	`FmoEndPi˘uª
 ();

223 i‡((
p_I≈
->
SkùDeBlockN⁄Ref
 =0Ë|| (
p_Vid
->
«l_ª„ªn˚_idc
 != 0))

225 if(
p_I≈
->
RDPi˘uªDeblockög
 && !
p_Vid
->
Tu∫DBOff
)

227 
	`föd_di°‹ti⁄
(
p_Vid
, &p_Vid->
imgD©a
);

228 
di°‹ti⁄
.
vÆue
[0] = 
p_Vid
->
p_Di°
->
mëric
[
SSE
].value[0];

229 
di°‹ti⁄
.
vÆue
[1] = 
p_Vid
->
p_Di°
->
mëric
[
SSE
].value[1];

230 
di°‹ti⁄
.
vÆue
[2] = 
p_Vid
->
p_Di°
->
mëric
[
SSE
].value[2];

233 
di°‹ti⁄
.
vÆue
[0] = distortion.value[1] = distortion.value[2] = 0;

235 
	`DeblockFøme
 (
p_Vid
,Ö_Vid->
íc_pi˘uª
->
imgY
,Ö_Vid->íc_pi˘uª->
imgUV
);

237 if(
p_I≈
->
RDPi˘uªDeblockög
 && !
p_Vid
->
Tu∫DBOff
)

239 
	`föd_di°‹ti⁄
(
p_Vid
, &p_Vid->
imgD©a
);

240 if(
di°‹ti⁄
.
vÆue
[0]+distortion.value[1]+distortion.value[2] <

241 
p_Vid
->
p_Di°
->
mëric
[
SSE
].
vÆue
[0]+

242 
p_Vid
->
p_Di°
->
mëric
[
SSE
].
vÆue
[1]+

243 
p_Vid
->
p_Di°
->
mëric
[
SSE
].
vÆue
[2])

245 
p_Vid
->
EvÆu©eDBOff
 = 1;

250 
	}
}

262 
	$code_a_pi˘uª
(
VideoP¨amëîs
 *
p_Vid
, 
Pi˘uª
 *
pic
)

264 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

265 
∂
;

267 
p_Vid
->
cuºítPi˘uª
 = 
pic
;

268 
p_Vid
->
cuºítPi˘uª
->
idr_Êag
 = 
	`gë_idr_Êag
(p_Vid);

270 
pic
->
no_¶i˚s
 = 0;

272 
	`R™domI¡øNewPi˘uª
 (
p_Vid
);

273 if–(
p_I≈
->
£∑øã_cﬁour_∂™e_Êag
 != 0) )

275  
∂
=0;Öl<
MAX_PLANE
;Öl++ )

277 
p_Vid
->
cuºít_mb_ƒ
 = 0;

278 
p_Vid
->
cuºít_¶i˚_ƒ
 = 0;

279 
p_Vid
->
SumFømeQP
 = 0;

280 
p_Vid
->
num_ªf_idx_l0_a˘ive
 = 0;

281 
p_Vid
->
num_ªf_idx_l1_a˘ive
 = 0;

283 
p_Vid
->
cﬁour_∂™e_id
 = (Ë
∂
;

285 
	`code_a_∂™e
(
p_Vid
, 
p_I≈
);

290 
	`code_a_∂™e
(
p_Vid
, 
p_I≈
);

293 i‡(
p_Vid
->
mb_aff_‰ame_Êag
)

294 
	`MbAffPo°Proc
(
p_Vid
);

296 
	}
}

304 
byã
 
	$gë_idr_Êag
–
VideoP¨amëîs
 *
p_Vid
 )

306 
idr_Êag
;

307 
FømeUnôSåu˘
 *
p_cur_‰m
 = 
p_Vid
->
p_cuº_‰m_°ru˘
;

309  
p_Vid
->
°ru˘uª
 )

312 
FRAME
:

313 
idr_Êag
 = 
p_cur_‰m
->
p_‰ame_pic
->idr_flag;

315 
TOP_FIELD
:

316 
idr_Êag
 = 
p_cur_‰m
->
p_t›_Êd_pic
->idr_flag;

318 
BOTTOM_FIELD
:

319 
idr_Êag
 = 
p_cur_‰m
->
p_bŸ_Êd_pic
->idr_flag;

323  (
byã
Ë
idr_Êag
;

324 
	}
}

332 
byã
 
	$gë_øndom_ac˚ss_Êag
–
VideoP¨amëîs
 *
p_Vid
 )

334 
øndom_ac˚ss
;

335 
FømeUnôSåu˘
 *
p_cur_‰m
 = 
p_Vid
->
p_cuº_‰m_°ru˘
;

337  
p_Vid
->
°ru˘uª
 )

340 
FRAME
:

341 
øndom_ac˚ss
 = 
p_cur_‰m
->
p_‰ame_pic
->random_access;

343 
TOP_FIELD
:

344 
øndom_ac˚ss
 = 
p_cur_‰m
->
p_t›_Êd_pic
->random_access;

346 
BOTTOM_FIELD
:

347 
øndom_ac˚ss
 = 
p_cur_‰m
->
p_bŸ_Êd_pic
->random_access;

351  (
byã
Ë
øndom_ac˚ss
;

352 
	}
}

360 
	$upd©e_globÆ_°©s
(
I≈utP¨amëîs
 *
p_I≈
, 
SètP¨amëîs
 *
gl_°©s
, SètP¨amëî†*
cur_°©s
)

362 
i
, 
j
, 
k
;

364 i‡(
p_I≈
->
skù_gl_°©s
 == 0)

366 
i
 = 0; i < 4; i++)

368 
gl_°©s
->
öåa_chroma_mode
[
i
] +
cur_°©s
->intra_chroma_mode[i];

371 
i
 = 0; i < 5; i++)

373 
gl_°©s
->
qu™t
[
i
] +
cur_°©s
->quant[i];

374 
gl_°©s
->
num_ma¸oblocks
[
i
] +
cur_°©s
->num_macroblocks[i];

375 
gl_°©s
->
bô_u£_mb_ty≥
 [
i
] +
cur_°©s
->bit_use_mb_type[i];

376 
gl_°©s
->
bô_u£_hódî
 [
i
] +
cur_°©s
->bit_use_header[i];

377 
gl_°©s
->
tmp_bô_u£_cbp
 [
i
] +
cur_°©s
->tmp_bit_use_cbp[i];

378 
gl_°©s
->
bô_u£_c€ffC
 [
i
] +
cur_°©s
->bit_use_coeffC[i];

379 
gl_°©s
->
bô_u£_c€ff
[0][
i
] +
cur_°©s
->bit_use_coeff[0][i];

380 
gl_°©s
->
bô_u£_c€ff
[1][
i
] +
cur_°©s
->bit_use_coeff[1][i];

381 
gl_°©s
->
bô_u£_c€ff
[2][
i
] +
cur_°©s
->bit_use_coeff[2][i];

382 
gl_°©s
->
bô_u£_dñè_qu™t
[
i
] +
cur_°©s
->bit_use_delta_quant[i];

383 
gl_°©s
->
bô_u£_°uffög_bôs
[
i
] +
cur_°©s
->bit_use_stuffing_bits[i];

385 
k
 = 0; k < 2; k++)

386 
gl_°©s
->
b8_mode_0_u£
[
i
][
k
] +
cur_°©s
->b8_mode_0_use[i][k];

388 
j
 = 0; j < 15; j++)

390 
gl_°©s
->
mode_u£
[
i
][
j
] +
cur_°©s
->mode_use[i][j];

391 
gl_°©s
->
bô_u£_mode
[
i
][
j
] +
cur_°©s
->bit_use_mode[i][j];

392 
k
 = 0; k < 2; k++)

393 
gl_°©s
->
mode_u£_å™sf‹m
[
i
][
j
][
k
] +
cur_°©s
->mode_use_transform[i][j][k];

397 
	}
}

399 
	$°‹eRedund™tFøme
(
VideoP¨amëîs
 *
p_Vid
)

401 
j
, 
k
;

402 if(
p_Vid
->
key_‰ame
)

404 
j
=0; j<
p_Vid
->
height
; j++)

406 
	`mem˝y
(
p_Vid
->
imgY_tmp
[
j
],Ö_Vid->
íc_‰ame_pi˘uª
[0]->
imgY
[j],Ö_Vid->
width
 * (
img≥l
));

409 
k
 = 0; k < 2; k++)

411 
j
=0; j<
p_Vid
->
height_¸
; j++)

413 
	`mem˝y
(
p_Vid
->
imgUV_tmp
[
k
][
j
],Ö_Vid->
íc_‰ame_pi˘uª
[0]->
imgUV
[k][j],Ö_Vid->
width_¸
 * (
img≥l
));

418 if(
p_Vid
->
ªdund™t_codög
)

420 
j
=0; j<
p_Vid
->
height
; j++)

422 
	`mem˝y
(
p_Vid
->
íc_‰ame_pi˘uª
[0]->
imgY
[
j
],Ö_Vid->
imgY_tmp
[j],Ö_Vid->
width
 * (
img≥l
));

424 
k
 = 0; k < 2; k++)

426 
j
=0; j<
p_Vid
->
height_¸
; j++)

428 
	`mem˝y
(
p_Vid
->
íc_‰ame_pi˘uª
[0]->
imgUV
[
k
][
j
],Ö_Vid->
imgUV_tmp
[k][j],Ö_Vid->
width_¸
 * (
img≥l
));

432 
	}
}

439 
	$‰ì_pi˘uªs
(
VideoP¨amëîs
 *
p_Vid
, 
dummy
)

441 
i
;

442 
i
 = 0; i < 6; i++)

444 if(
p_Vid
->
íc_pi˘uª
 !p_Vid->
íc_‰ame_pi˘uª
[
i
])

445 
	`‰ì_°‹abÀ_pi˘uª
(
p_Vid
,Ö_Vid->
íc_‰ame_pi˘uª
[
i
]);

447 
	}
}

449 #i‡(
MVC_EXTENSION_ENABLE
)

456 
	$wrôe_ñ_fõld_v˛_«lu
(
VideoP¨amëîs
 *
p_Vid
)

458 
ãmp1_«l_ª„ªn˚_idc
;

459 
ãmp1_n⁄_idr_Êag
[2];

460 
ãmp1_¥i‹ôy_id
;

461 
ãmp1_võw_id
;

462 
ãmp1_ãmp‹Æ_id
;

463 
ãmp1_™ch‹_pic_Êag
[2];

464 
ãmp1_öãr_võw_Êag
[2];

466 if(
p_Vid
->
võw_id
 == 1)

468 
ãmp_võw_id
 = 
p_Vid
->
võw_id
;

470 
p_Vid
->
võw_id
 = 0;

471 
p_Vid
->
°ru˘uª
 = 
TOP_FIELD
;

472 
	`wrôe_n⁄_v˛_«lu_mvc
(
p_Vid
);

475 
ãmp1_«l_ª„ªn˚_idc
 = 
p_Vid
->
«l_ª„ªn˚_idc
;

476 
ãmp1_n⁄_idr_Êag
[0] = 
p_Vid
->
n⁄_idr_Êag
[0];

477 
ãmp1_n⁄_idr_Êag
[1] = 
p_Vid
->
n⁄_idr_Êag
[1];

478 
ãmp1_¥i‹ôy_id
 = 
p_Vid
->
¥i‹ôy_id
;

479 
ãmp1_võw_id
 = 
ãmp_võw_id
;

480 
ãmp1_ãmp‹Æ_id
 = 
p_Vid
->
ãmp‹Æ_id
;

481 
ãmp1_™ch‹_pic_Êag
[0] = 
p_Vid
->
™ch‹_pic_Êag
[0];

482 
ãmp1_™ch‹_pic_Êag
[1] = 
p_Vid
->
™ch‹_pic_Êag
[1];

483 
ãmp1_öãr_võw_Êag
[0] = 
p_Vid
->
öãr_võw_Êag
[0];

484 
ãmp1_öãr_võw_Êag
[1] = 
p_Vid
->
öãr_võw_Êag
[1];

487 
p_Vid
->
«l_ª„ªn˚_idc
 =Ö_Vid->
ãmp0_«l_ª„ªn˚_idc
;

488 
p_Vid
->
n⁄_idr_Êag
[0] =Ö_Vid->
ãmp0_n⁄_idr_Êag
[0];

489 
p_Vid
->
n⁄_idr_Êag
[1] =Ö_Vid->
ãmp0_n⁄_idr_Êag
[1];

490 
p_Vid
->
¥i‹ôy_id
 =Ö_Vid->
ãmp0_¥i‹ôy_id
;

491 
p_Vid
->
võw_id
 =Ö_Vid->
ãmp0_võw_id
;

492 
p_Vid
->
ãmp‹Æ_id
 =Ö_Vid->
ãmp0_ãmp‹Æ_id
;

493 
p_Vid
->
™ch‹_pic_Êag
[0] =Ö_Vid->
ãmp0_™ch‹_pic_Êag
[0];

494 
p_Vid
->
™ch‹_pic_Êag
[1] =Ö_Vid->
ãmp0_™ch‹_pic_Êag
[1];

495 
p_Vid
->
öãr_võw_Êag
[0] =Ö_Vid->
ãmp0_öãr_võw_Êag
[0];

496 
p_Vid
->
öãr_võw_Êag
[1] =Ö_Vid->
ãmp0_öãr_võw_Êag
[1];

497 
	`wrôeout_pi˘uª
 (
p_Vid
,Ö_Vid->
fõld_pic1
[0], 0);

500 
p_Vid
->
«l_ª„ªn˚_idc
 = 
ãmp1_«l_ª„ªn˚_idc
;

501 
p_Vid
->
n⁄_idr_Êag
[0] = 
ãmp1_n⁄_idr_Êag
[0];

502 
p_Vid
->
n⁄_idr_Êag
[1] = 
ãmp1_n⁄_idr_Êag
[1];

503 
p_Vid
->
¥i‹ôy_id
 = 
ãmp1_¥i‹ôy_id
;

504 
p_Vid
->
võw_id
 = 
ãmp1_võw_id
;

505 
p_Vid
->
ãmp‹Æ_id
 = 
ãmp1_ãmp‹Æ_id
;

506 
p_Vid
->
™ch‹_pic_Êag
[0] = 
ãmp1_™ch‹_pic_Êag
[0];

507 
p_Vid
->
™ch‹_pic_Êag
[1] = 
ãmp1_™ch‹_pic_Êag
[1];

508 
p_Vid
->
öãr_võw_Êag
[0] = 
ãmp1_öãr_võw_Êag
[0];

509 
p_Vid
->
öãr_võw_Êag
[1] = 
ãmp1_öãr_võw_Êag
[1];

510 
	`wrôe_n⁄_v˛_«lu_mvc
–
p_Vid
 );

511 
	`wrôeout_pi˘uª
 (
p_Vid
,Ö_Vid->
fõld_pic2
[0], 0);

514 
p_Vid
->
«l_ª„ªn˚_idc
 =Ö_Vid->
ãmp0_«l_ª„ªn˚_idc
;

515 
p_Vid
->
n⁄_idr_Êag
[0] =Ö_Vid->
ãmp0_n⁄_idr_Êag
[0];

516 
p_Vid
->
n⁄_idr_Êag
[1] =Ö_Vid->
ãmp0_n⁄_idr_Êag
[1];

517 
p_Vid
->
¥i‹ôy_id
 =Ö_Vid->
ãmp0_¥i‹ôy_id
;

518 
p_Vid
->
võw_id
 =Ö_Vid->
ãmp0_võw_id
;

519 
p_Vid
->
ãmp‹Æ_id
 =Ö_Vid->
ãmp0_ãmp‹Æ_id
;

520 
p_Vid
->
™ch‹_pic_Êag
[0] =Ö_Vid->
ãmp0_™ch‹_pic_Êag
[0];

521 
p_Vid
->
™ch‹_pic_Êag
[1] =Ö_Vid->
ãmp0_™ch‹_pic_Êag
[1];

522 
p_Vid
->
öãr_võw_Êag
[0] =Ö_Vid->
ãmp0_öãr_võw_Êag
[0];

523 
p_Vid
->
öãr_võw_Êag
[1] =Ö_Vid->
ãmp0_öãr_võw_Êag
[1];

524 
p_Vid
->
°ru˘uª
 = 
BOTTOM_FIELD
;

525 
	`wrôe_n⁄_v˛_«lu_mvc
–
p_Vid
 );

526 
	`wrôeout_pi˘uª
 (
p_Vid
,Ö_Vid->
fõld_pic1
[1], 1);

529 
p_Vid
->
«l_ª„ªn˚_idc
 = 
ãmp1_«l_ª„ªn˚_idc
;

530 
p_Vid
->
n⁄_idr_Êag
[0] = 
ãmp1_n⁄_idr_Êag
[0];

531 
p_Vid
->
n⁄_idr_Êag
[1] = 
ãmp1_n⁄_idr_Êag
[1];

532 
p_Vid
->
¥i‹ôy_id
 = 
ãmp1_¥i‹ôy_id
;

533 
p_Vid
->
võw_id
 = 
ãmp1_võw_id
;

534 
p_Vid
->
ãmp‹Æ_id
 = 
ãmp1_ãmp‹Æ_id
;

535 
p_Vid
->
™ch‹_pic_Êag
[0] = 
ãmp1_™ch‹_pic_Êag
[0];

536 
p_Vid
->
™ch‹_pic_Êag
[1] = 
ãmp1_™ch‹_pic_Êag
[1];

537 
p_Vid
->
öãr_võw_Êag
[0] = 
ãmp1_öãr_võw_Êag
[0];

538 
p_Vid
->
öãr_võw_Êag
[1] = 
ãmp1_öãr_võw_Êag
[1];

539 
	`wrôe_n⁄_v˛_«lu_mvc
–
p_Vid
 );

540 
	`wrôeout_pi˘uª
 (
p_Vid
,Ö_Vid->
fõld_pic2
[1], 1);

544 
p_Vid
->
ãmp0_«l_ª„ªn˚_idc
 =Ö_Vid->
«l_ª„ªn˚_idc
;

545 
p_Vid
->
ãmp0_n⁄_idr_Êag
[0] =Ö_Vid->
n⁄_idr_Êag
[0];

546 
p_Vid
->
ãmp0_n⁄_idr_Êag
[1] =Ö_Vid->
n⁄_idr_Êag
[1];

547 
p_Vid
->
ãmp0_¥i‹ôy_id
 =Ö_Vid->
¥i‹ôy_id
;

548 
p_Vid
->
ãmp0_võw_id
 =Ö_Vid->
võw_id
;

549 
p_Vid
->
ãmp0_ãmp‹Æ_id
 =Ö_Vid->
ãmp‹Æ_id
;

550 
p_Vid
->
ãmp0_™ch‹_pic_Êag
[0] =Ö_Vid->
™ch‹_pic_Êag
[0];

551 
p_Vid
->
ãmp0_™ch‹_pic_Êag
[1] =Ö_Vid->
™ch‹_pic_Êag
[1];

552 
p_Vid
->
ãmp0_öãr_võw_Êag
[0] =Ö_Vid->
öãr_võw_Êag
[0];

553 
p_Vid
->
ãmp0_öãr_võw_Êag
[1] =Ö_Vid->
öãr_võw_Êag
[1];

555 
	}
}

563 
	$wrôe_‰ame_pi˘uª
(
VideoP¨amëîs
 *
p_Vid
)

565 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

567 i‡(
p_Vid
->
Êd_Êag
)

569 
	`fõld_mode_buf„r
 (
p_Vid
);

571 if(
p_I≈
->
num_of_võws
==1)

573 
p_Vid
->
°ru˘uª
 = 
TOP_FIELD
;

574 
	`wrôe_n⁄_v˛_«lu
(
p_Vid
);

575 
	`wrôeout_pi˘uª
 (
p_Vid
,Ö_Vid->
fõld_pic1
[0], 0);

576 
p_Vid
->
°ru˘uª
 = 
BOTTOM_FIELD
;

577 
	`wrôe_n⁄_v˛_«lu_bŸ_Êd
(
p_Vid
);

578 
	`wrôeout_pi˘uª
 (
p_Vid
,Ö_Vid->
fõld_pic1
[1], 1);

582 
	`wrôe_ñ_fõld_v˛_«lu
(
p_Vid
);

587 
	`‰ame_mode_buf„r
 (
p_Vid
);

588 
p_Vid
->
°ru˘uª
 = 
FRAME
;

590 #i‡(
MVC_EXTENSION_ENABLE
)

591 i‡–
p_I≈
->
num_of_võws
 == 2 )

593 
	`wrôe_n⁄_v˛_«lu_mvc
(
p_Vid
);

597 
	`wrôe_n⁄_v˛_«lu
(
p_Vid
);

598 i‡(
p_Vid
->
ty≥
==
SI_SLICE
)

600 
	`wrôeout_pi˘uª
 (
p_Vid
,Ö_Vid->
‰ame_pic_si
, 0);

604 
	`wrôeout_pi˘uª
 (
p_Vid
,Ö_Vid->
p_‰ame_pic
, 0);

607 
	}
}

609 
	$wrôe_‰ame_pi˘uª
(
VideoP¨amëîs
 *
p_Vid
)

611 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

612 i‡(
p_Vid
->
Êd_Êag
)

614 
p_Vid
->
°ru˘uª
 = 
TOP_FIELD
;

615 
	`fõld_mode_buf„r
 (
p_Vid
);

616 
	`wrôe_n⁄_v˛_«lu
(
p_Vid
);

617 
	`wrôeout_pi˘uª
 (
p_Vid
,Ö_Vid->
fõld_pic
[0]);

618 
p_Vid
->
°ru˘uª
 = 
BOTTOM_FIELD
;

619 
	`wrôe_n⁄_v˛_«lu_bŸ_Êd
(
p_Vid
);

620 
	`wrôeout_pi˘uª
 (
p_Vid
,Ö_Vid->
fõld_pic
[1]);

624 
	`‰ame_mode_buf„r
 (
p_Vid
);

626 
	`wrôe_n⁄_v˛_«lu
(
p_Vid
);

627 i‡(
p_Vid
->
ty≥
==
SI_SLICE
)

629 
	`wrôeout_pi˘uª
 (
p_Vid
,Ö_Vid->
‰ame_pic_si
);

633 
	`wrôeout_pi˘uª
 (
p_Vid
,Ö_Vid->
p_‰ame_pic
);

636 
	}
}

646 
	$ªad_öput_d©a_32puŒdown
(
VideoP¨amëîs
 *
p_Vid
)

648 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

649 
fûe_ªad
 = 0;

650 
‰m_no_ö_fûe_fú°
 = 0;

651 
‰m_no_ö_fûe_£c⁄d
 = 0;

652 
puŒ_down_off£t
 = 
p_I≈
->
íabÀ_32_puŒdown
 == 1 ? 1 : 2;

654 #i‡(
MVC_EXTENSION_ENABLE
)

655 if(
p_I≈
->
num_of_võws
==2 && 
p_Vid
->
võw_id
 == 1)

657 
‰m_no_ö_fûe_fú°
 = ((
p_Vid
->
‰m_no_ö_fûe
 * 4 + 
puŒ_down_off£t
)/ 5);

658 
‰m_no_ö_fûe_£c⁄d
 = ((
p_Vid
->
‰m_no_ö_fûe
 * 4 + 3)/ 5);

661 
fûe_ªad
 = 
	`ªad_⁄e_‰ame
 (
p_Vid
, &
p_I≈
->
öput_fûe2
, 
‰m_no_ö_fûe_fú°
,Ö_I≈->
öfûe_hódî
, &p_I≈->
sour˚
, &p_I≈->
ouçut
,Ö_Vid->
imgD©a0
.
‰m_d©a
);

662 i‡–!
fûe_ªad
 )

665 
	`gë_numbî_of_‰ames
 (
p_I≈
, &p_I≈->
öput_fûe2
);

666 
	`Ârötf
(
°dout
, "\nInc‹ª˘ FømesToBeEncoded:á˘uÆÇumbî i†%6d fømes!\n", 
p_I≈
->
no_‰ames
 );

669 
	`∑d_b‹dîs
 (
p_I≈
->
ouçut
, 
p_Vid
->
width
,Ö_Vid->
height
,Ö_Vid->
width_¸
,Ö_Vid->
height_¸
,Ö_Vid->
imgD©a0
.
‰m_d©a
);

672 
fûe_ªad
 = 
	`ªad_⁄e_‰ame
 (
p_Vid
, &
p_I≈
->
öput_fûe2
, 
‰m_no_ö_fûe_£c⁄d
,Ö_I≈->
öfûe_hódî
, &p_I≈->
sour˚
, &p_I≈->
ouçut
,Ö_Vid->
imgD©a4
.
‰m_d©a
);

673 i‡–!
fûe_ªad
 )

676 
	`gë_numbî_of_‰ames
 (
p_I≈
, &p_I≈->
öput_fûe2
);

677 
	`Ârötf
(
°dout
, "\nInc‹ª˘ FømesToBeEncoded:á˘uÆÇumbî i†%6d fømes!\n", 
p_I≈
->
no_‰ames
 );

680 
	`∑d_b‹dîs
 (
p_I≈
->
ouçut
, 
p_Vid
->
width
,Ö_Vid->
height
,Ö_Vid->
width_¸
,Ö_Vid->
height_¸
,Ö_Vid->
imgD©a4
.
‰m_d©a
);

685 
‰m_no_ö_fûe_fú°
 = ((
p_Vid
->
‰m_no_ö_fûe
 * 4 + 
puŒ_down_off£t
)/ 5);

686 
‰m_no_ö_fûe_£c⁄d
 = ((
p_Vid
->
‰m_no_ö_fûe
 * 4 + 3)/ 5);

689 
fûe_ªad
 = 
	`ªad_⁄e_‰ame
 (
p_Vid
, &
p_I≈
->
öput_fûe1
, 
‰m_no_ö_fûe_fú°
,Ö_I≈->
öfûe_hódî
, &p_I≈->
sour˚
, &p_I≈->
ouçut
,Ö_Vid->
imgD©a0
.
‰m_d©a
);

690 i‡–!
fûe_ªad
 )

693 
	`gë_numbî_of_‰ames
 (
p_I≈
, &p_I≈->
öput_fûe1
);

694 
	`Ârötf
(
°dout
, "\nInc‹ª˘ FømesToBeEncoded:á˘uÆÇumbî i†%6d fømes!\n", 
p_I≈
->
no_‰ames
 );

697 
	`∑d_b‹dîs
 (
p_I≈
->
ouçut
, 
p_Vid
->
width
,Ö_Vid->
height
,Ö_Vid->
width_¸
,Ö_Vid->
height_¸
,Ö_Vid->
imgD©a0
.
‰m_d©a
);

700 
fûe_ªad
 = 
	`ªad_⁄e_‰ame
 (
p_Vid
, &
p_I≈
->
öput_fûe1
, 
‰m_no_ö_fûe_£c⁄d
,Ö_I≈->
öfûe_hódî
, &p_I≈->
sour˚
, &p_I≈->
ouçut
,Ö_Vid->
imgD©a4
.
‰m_d©a
);

701 i‡–!
fûe_ªad
 )

704 
	`gë_numbî_of_‰ames
 (
p_I≈
, &p_I≈->
öput_fûe1
);

705 
	`Ârötf
(
°dout
, "\nInc‹ª˘ FømesToBeEncoded:á˘uÆÇumbî i†%6d fømes!\n", 
p_I≈
->
no_‰ames
 );

708 
	`∑d_b‹dîs
 (
p_I≈
->
ouçut
, 
p_Vid
->
width
,Ö_Vid->
height
,Ö_Vid->
width_¸
,Ö_Vid->
height_¸
,Ö_Vid->
imgD©a4
.
‰m_d©a
);

713 
	}
}

715 
	$ªad_öput_d©a
(
VideoP¨amëîs
 *
p_Vid
)

717 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

718 
fûe_ªad
 = 0;

720 #i‡(
MVC_EXTENSION_ENABLE
)

721 if(
p_I≈
->
num_of_võws
==2 && 
p_Vid
->
võw_id
 == 1)

723 
fûe_ªad
 = 
	`ªad_⁄e_‰ame
 (
p_Vid
, &
p_I≈
->
öput_fûe2
,Ö_Vid->
‰m_no_ö_fûe
,Ö_I≈->
öfûe_hódî
, &p_I≈->
sour˚
, &p_I≈->
ouçut
,Ö_Vid->
imgD©a0
.
‰m_d©a
);

724 i‡–!
fûe_ªad
 )

727 
	`gë_numbî_of_‰ames
 (
p_I≈
, &p_I≈->
öput_fûe2
);

728 
	`Ârötf
(
°dout
, "\nInc‹ª˘ FømesToBeEncoded:á˘uÆÇumbî i†%6d fømes!\n", 
p_I≈
->
no_‰ames
 );

731 
	`∑d_b‹dîs
 (
p_I≈
->
ouçut
, 
p_Vid
->
width
,Ö_Vid->
height
,Ö_Vid->
width_¸
,Ö_Vid->
height_¸
,Ö_Vid->
imgD©a0
.
‰m_d©a
);

736 
fûe_ªad
 = 
	`ªad_⁄e_‰ame
 (
p_Vid
, &
p_I≈
->
öput_fûe1
,Ö_Vid->
‰m_no_ö_fûe
,Ö_I≈->
öfûe_hódî
, &p_I≈->
sour˚
, &p_I≈->
ouçut
,Ö_Vid->
imgD©a0
.
‰m_d©a
);

737 i‡–!
fûe_ªad
 )

740 
	`gë_numbî_of_‰ames
 (
p_I≈
, &p_I≈->
öput_fûe1
);

741 
	`Ârötf
(
°dout
, "\nInc‹ª˘ FømesToBeEncoded:á˘uÆÇumbî i†%6d fømes!\n", 
p_I≈
->
no_‰ames
 );

744 
	`∑d_b‹dîs
 (
p_I≈
->
ouçut
, 
p_Vid
->
width
,Ö_Vid->
height
,Ö_Vid->
width_¸
,Ö_Vid->
height_¸
,Ö_Vid->
imgD©a0
.
‰m_d©a
);

748 
	}
}

750 
	$≥rf‹m_ícode_fõld
(
VideoP¨amëîs
 *
p_Vid
)

752 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

755 i‡–
p_I≈
->
RCE«bÀ
 &&Ö_I≈->
RCUpd©eMode
 <
MAX_RC_MODE
 )

756 
p_Vid
->
p_rc_gí
->
FõldC⁄åﬁ
 = 1;

758 
p_Vid
->
fõld_pi˘uª
 = 1;

760 #i‡(
MVC_EXTENSION_ENABLE
)

761 
	`fõld_pi˘uª
 (
p_Vid
,Ö_Vid->
fõld_pic_±r
[0],Ö_Vid->field_pic_ptr[1]);

763 
	`fõld_pi˘uª
 (
p_Vid
,Ö_Vid->
fõld_pic
[0],Ö_Vid->field_pic[1]);

765 
p_Vid
->
Êd_Êag
 = 
TRUE
;

766 
	}
}

768 
	$≥rf‹m_ícode_‰ame
(
VideoP¨amëîs
 *
p_Vid
)

770 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

771 
tmpFømeQP
 = 0;

772 
num_ªf_idx_l0
 = 0;

773 
num_ªf_idx_l1
 = 0;

775 
‰ame_ty≥
;

778 i‡–
p_I≈
->
RCE«bÀ
 &&Ö_I≈->
RCUpd©eMode
 <
MAX_RC_MODE
 )

779 
p_Vid
->
p_rc_gí
->
FõldC⁄åﬁ
 = 0;

781 
p_Vid
->
fõld_pi˘uª
 = 0;

784 if(
p_I≈
->
RCE«bÀ
)

785 
	`rc_öô_‰ame
(
p_Vid
, 
p_I≈
);

787 
p_Vid
->
p_cuº_‰m_°ru˘
->
qp
 =Ö_Vid->qp;

789 
p_Vid
->
a˘ive_µs
 =Ö_Vid->
PicP¨Së
[0];

791 #i‡(
MVC_EXTENSION_ENABLE
)

792 if(
p_Vid
->
võw_id
!=1 || !p_Vid->
£c_võw_f‹˚_Êd
)

795 i‡((
p_Vid
->
ty≥
 =
B_SLICE
 ||Ö_Vid->ty≥ =
P_SLICE
 ||Ö_Vid->ty≥==
I_SLICE
Ë&& 
p_I≈
->
RDPi˘uªDecisi⁄
)

797 
	`‰ame_pi˘uª_mp
 (
p_Vid
, 
p_I≈
);

801 
	`‰ame_pi˘uª
 (
p_Vid
,Ö_Vid->
‰ame_pic
[0], &p_Vid->
imgD©a
, 0);

802 
p_Vid
->
p_‰ame_pic
 =Ö_Vid->
‰ame_pic
[0];

805 
tmpFømeQP
 = 
p_Vid
->
SumFømeQP
;

806 
num_ªf_idx_l0
 = 
p_Vid
->
num_ªf_idx_l0_a˘ive
;

807 
num_ªf_idx_l1
 = 
p_Vid
->
num_ªf_idx_l1_a˘ive
;

809 i‡(
p_Vid
->
p_cuº_‰m_°ru˘
->
ty≥
 =
SI_SLICE
)

812 
	`£t_¶i˚_ty≥
–
p_Vid
, 
p_I≈
, 
SI_SLICE
 );

813 
	`‰ame_pi˘uª
 (
p_Vid
,Ö_Vid->
‰ame_pic_si
, &p_Vid->
imgD©a
, 0);

816 i‡((
p_Vid
->
ty≥
 =
SP_SLICE
Ë&& (
p_I≈
->
•_ouçut_ödiˇt‹
))

819 
	`ouçut_SP_c€fficõ¡s
(
p_Vid
, 
p_I≈
);

821 #i‡(
MVC_EXTENSION_ENABLE
)

825 #i‡(
MVC_EXTENSION_ENABLE
)

826 i‡((
p_I≈
->
PicI¡îœ˚
 =
ADAPTIVE_CODING
Ë&& (!
	`is_MVC_¥ofûe
(
p_Vid
->
a˘ive_•s
->
¥ofûe_idc
) ||

827 –((
p_Vid
->
võw_id
 =0Ë|| (p_Vid->võw_id =1 &&Ö_Vid->
£c_võw_f‹˚_Êd
)))))

829 i‡(
p_I≈
->
PicI¡îœ˚
 =
ADAPTIVE_CODING
)

832 
DecRefPicM¨kög_t
 *
tmp_dΩm
;

834 i‡–
p_I≈
->
RCE«bÀ
 &&Ö_I≈->
RCUpd©eMode
 <
MAX_RC_MODE
 )

835 
p_Vid
->
p_rc_gí
->
FõldC⁄åﬁ
=1;

836 
p_Vid
->
wrôe_ma¸oblock
 = 
FALSE
;

837 
p_Vid
->
bŸ_MB
 = 
FALSE
;

839 
‰ame_ty≥
 = 
p_Vid
->
ty≥
;

841 
p_Vid
->
fõld_pi˘uª
 = 1;

844 
p_Vid
->
dec_ªf_pic_m¨kög_buf„r
)

846 
tmp_dΩm
 = 
p_Vid
->
dec_ªf_pic_m¨kög_buf„r
;

847 
p_Vid
->
dec_ªf_pic_m¨kög_buf„r
 = 
tmp_dΩm
->
Next
;

848 
	`‰ì
(
tmp_dΩm
);

851 #i‡(
MVC_EXTENSION_ENABLE
)

852 
	`fõld_pi˘uª
 (
p_Vid
,Ö_Vid->
fõld_pic_±r
[0],Ö_Vid->field_pic_ptr[1]);

854 if(
p_I≈
->
num_of_võws
==1 || 
p_Vid
->
võw_id
==0)

856 if(
p_Vid
->
rd_∑ss
 == 0)

857 
p_Vid
->
Êd_Êag
 = 
	`pi˘uª_°ru˘uª_decisi⁄
 (p_Vid,Ö_Vid->
‰ame_pic
[0],Ö_Vid->
fõld_pic_±r
[0],Ö_Vid->field_pic_ptr[1]);

858 if(
p_Vid
->
rd_∑ss
 == 1)

859 
p_Vid
->
Êd_Êag
 = 
	`pi˘uª_°ru˘uª_decisi⁄
 (p_Vid,Ö_Vid->
‰ame_pic
[1],Ö_Vid->
fõld_pic_±r
[0],Ö_Vid->field_pic_ptr[1]);

861 
p_Vid
->
Êd_Êag
 = 
	`pi˘uª_°ru˘uª_decisi⁄
 (p_Vid,Ö_Vid->
‰ame_pic
[2],Ö_Vid->
fõld_pic_±r
[0],Ö_Vid->field_pic_ptr[1]);

863 
p_Vid
->
£c_võw_f‹˚_Êd
 =Ö_Vid->
Êd_Êag
;

867 
p_Vid
->
Êd_Êag
 = (
byã
Ëp_Vid->
£c_võw_f‹˚_Êd
;

870 
	`fõld_pi˘uª
 (
p_Vid
,Ö_Vid->
fõld_pic
[0],Ö_Vid->field_pic[1]);

872 if(
p_Vid
->
rd_∑ss
 == 0)

873 
p_Vid
->
Êd_Êag
 = 
	`pi˘uª_°ru˘uª_decisi⁄
 (p_Vid,Ö_Vid->
‰ame_pic
[0],Ö_Vid->
fõld_pic
[0],Ö_Vid->field_pic[1]);

874 if(
p_Vid
->
rd_∑ss
 == 1)

875 
p_Vid
->
Êd_Êag
 = 
	`pi˘uª_°ru˘uª_decisi⁄
 (p_Vid,Ö_Vid->
‰ame_pic
[1],Ö_Vid->
fõld_pic
[0],Ö_Vid->field_pic[1]);

877 
p_Vid
->
Êd_Êag
 = 
	`pi˘uª_°ru˘uª_decisi⁄
 (p_Vid,Ö_Vid->
‰ame_pic
[2],Ö_Vid->
fõld_pic
[0],Ö_Vid->field_pic[1]);

880 i‡–
p_Vid
->
Êd_Êag
 )

882 
tmpFømeQP
 = 
p_Vid
->
SumFømeQP
;

883 
num_ªf_idx_l0
 = 
p_Vid
->
num_ªf_idx_l0_a˘ive
;

884 
num_ªf_idx_l1
 = 
p_Vid
->
num_ªf_idx_l1_a˘ive
;

887 i‡–
p_Vid
->
Êd_Êag
==0 )

889 
p_Vid
->
ty≥
 = (Ë
‰ame_ty≥
;

892 
	`upd©e_fõld_‰ame_c⁄ãxts
 (
p_Vid
,Ö_Vid->
Êd_Êag
);

895 i‡–
p_I≈
->
RCE«bÀ
 &&Ö_I≈->
RCUpd©eMode
 <
MAX_RC_MODE
 )

896 
p_Vid
->
p_rc_gí
->
FõldFøme
 = !’_Vid->
Êd_Êag
) ? 1 : 0;

899 
p_Vid
->
Êd_Êag
 = 
FALSE
;

901 
p_Vid
->
SumFømeQP
 = 
tmpFømeQP
;

902 
p_Vid
->
num_ªf_idx_l0_a˘ive
 = 
num_ªf_idx_l0
;

903 
p_Vid
->
num_ªf_idx_l1_a˘ive
 = 
num_ªf_idx_l1
;

906 
	`‰ì_¶i˚_d©a
(
VideoP¨amëîs
 *
p_Vid
)

908 
i
;

910 i‡(
p_Vid
->
‰ame_pic_si
)

912 
	`‰ì_¶i˚_li°
(
p_Vid
->
‰ame_pic_si
);

915 
i
 = 0; i < 
p_Vid
->
‰m_ôî
; i++)

917 i‡(
p_Vid
->
‰ame_pic
[
i
])

919 
	`‰ì_¶i˚_li°
(
p_Vid
->
‰ame_pic
[
i
]);

923 #i‡(
MVC_EXTENSION_ENABLE
)

924 i‡–
p_Vid
->
fõld_pic_±r
 && (p_Vid->
p_I≈
->
num_of_võws
==1 ||Ö_Vid->
võw_id
==1) )

926 
i
 = 0; i < 2; i++)

928 i‡(
p_Vid
->
fõld_pic1
[
i
])

929 
	`‰ì_¶i˚_li°
(
p_Vid
->
fõld_pic1
[
i
]);

930 i‡(
p_Vid
->
p_I≈
->
num_of_võws
==2 &&Ö_Vid->
fõld_pic2
)

932 i‡(
p_Vid
->
fõld_pic2
[
i
])

933 
	`‰ì_¶i˚_li°
(
p_Vid
->
fõld_pic2
[
i
]);

938 i‡(
p_Vid
->
fõld_pic
)

940 
i
 = 0; i < 2; i++)

942 i‡(
p_Vid
->
fõld_pic
[
i
])

943 
	`‰ì_¶i˚_li°
(
p_Vid
->
fõld_pic
[
i
]);

949 
	`°‹e_coded_pi˘uª
(
DecodedPi˘uªBuf„r
 *
p_Dpb
)

951 
VideoP¨amëîs
 *
p_Vid
 = 
p_Dpb
->p_Vid;

952 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

953 
¥ofûe_idc
 = 
p_Vid
->
a˘ive_•s
->profile_idc;

955 #i‡(
MVC_EXTENSION_ENABLE
)

956 i‡–(
p_I≈
->
PicI¡îœ˚
 =
ADAPTIVE_CODING
Ë&& ((
p_Dpb
->
œyî_id
 =0 ) || !
	`is_MVC_¥ofûe
(
¥ofûe_idc
)))

958 i‡–
p_I≈
->
PicI¡îœ˚
 =
ADAPTIVE_CODING
 )

961 i‡(
p_Vid
->
Êd_Êag
)

963 
	`upd©e_globÆ_°©s
(
p_I≈
, 
p_Vid
->
p_Sèts
, &p_Vid->
íc_fõld_pi˘uª
[0]->
°©s
);

964 
	`upd©e_globÆ_°©s
(
p_I≈
, 
p_Vid
->
p_Sèts
, &p_Vid->
íc_fõld_pi˘uª
[1]->
°©s
);

966 
	`°‹e_pi˘uª_ö_dpb
 (
p_Dpb
, 
p_Vid
->
íc_fõld_pi˘uª
[1], &
p_I≈
->
ouçut
);

967 #i‡(
MVC_EXTENSION_ENABLE
)

968 i‡–
p_Vid
->
¥oc_pi˘uª
 && 
	`is_MVC_¥ofûe
(
¥ofûe_idc
) )

970 
	`°‹e_¥oc_pi˘uª_ö_dpb
 (
p_Vid
->
p_Dpb_œyî
[1],Ö_Vid->
¥oc_pi˘uª
, &
p_I≈
->
ouçut
);

971 
p_Vid
->
¥oc_pi˘uª
 = 
NULL
;

974 
	`‰ì_°‹abÀ_pi˘uª
(
p_Vid
,Ö_Vid->
íc_‰ame_pi˘uª
[0]);

975 
	`‰ì_°‹abÀ_pi˘uª
(
p_Vid
,Ö_Vid->
íc_‰ame_pi˘uª
[1]);

976 
	`‰ì_°‹abÀ_pi˘uª
(
p_Vid
,Ö_Vid->
íc_‰ame_pi˘uª
[2]);

980 
	`upd©e_globÆ_°©s
(
p_I≈
, 
p_Vid
->
p_Sèts
, &p_Vid->
íc_‰ame_pi˘uª
[p_Vid->
rd_∑ss
]->
°©s
);

982 i‡(
p_Vid
->
rd_∑ss
==2)

984 
	`ª∂a˚_t›_pic_wôh_‰ame
(
p_Dpb
, 
p_Vid
->
íc_‰ame_pi˘uª
[2], &
p_I≈
->
ouçut
);

985 
	`‰ì_°‹abÀ_pi˘uª
 (
p_Vid
,Ö_Vid->
íc_‰ame_pi˘uª
[0]);

986 
	`‰ì_°‹abÀ_pi˘uª
 (
p_Vid
,Ö_Vid->
íc_‰ame_pi˘uª
[1]);

988 i‡(
p_Vid
->
rd_∑ss
==1)

990 
	`ª∂a˚_t›_pic_wôh_‰ame
(
p_Dpb
, 
p_Vid
->
íc_‰ame_pi˘uª
[1], &
p_I≈
->
ouçut
);

991 
	`‰ì_°‹abÀ_pi˘uª
 (
p_Vid
,Ö_Vid->
íc_‰ame_pi˘uª
[0]);

992 
	`‰ì_°‹abÀ_pi˘uª
 (
p_Vid
,Ö_Vid->
íc_‰ame_pi˘uª
[2]);

996 if(
p_I≈
->
ªdund™t_pic_Êag
==0 || (
p_Vid
->
key_‰ame
==0))

998 
	`ª∂a˚_t›_pic_wôh_‰ame
(
p_Dpb
, 
p_Vid
->
íc_‰ame_pi˘uª
[0], &
p_I≈
->
ouçut
);

999 
	`‰ì_°‹abÀ_pi˘uª
 (
p_Vid
,Ö_Vid->
íc_‰ame_pi˘uª
[1]);

1000 
	`‰ì_°‹abÀ_pi˘uª
 (
p_Vid
,Ö_Vid->
íc_‰ame_pi˘uª
[2]);

1003 
	`‰ì_°‹abÀ_pi˘uª
(
p_Vid
,Ö_Vid->
íc_fõld_pi˘uª
[1]);

1008 i‡(
p_Vid
->
Êd_Êag
)

1010 
	`upd©e_globÆ_°©s
(
p_I≈
, 
p_Vid
->
p_Sèts
, &p_Vid->
íc_fõld_pi˘uª
[0]->
°©s
);

1011 
	`upd©e_globÆ_°©s
(
p_I≈
, 
p_Vid
->
p_Sèts
, &p_Vid->
íc_fõld_pi˘uª
[1]->
°©s
);

1012 
	`°‹e_pi˘uª_ö_dpb
(
p_Dpb
, 
p_Vid
->
íc_fõld_pi˘uª
[1], &
p_I≈
->
ouçut
);

1013 #i‡(
MVC_EXTENSION_ENABLE
)

1014 i‡–
	`is_MVC_¥ofûe
(
¥ofûe_idc
Ë&& 
p_Vid
->
¥oc_pi˘uª
)

1016 
	`°‹e_¥oc_pi˘uª_ö_dpb
 (
p_Vid
->
p_Dpb_œyî
[1],Ö_Vid->
¥oc_pi˘uª
, &
p_I≈
->
ouçut
);

1017 
p_Vid
->
¥oc_pi˘uª
 = 
NULL
;

1023 i‡((
p_I≈
->
ªdund™t_pic_Êag
 !1Ë|| (
p_Vid
->
key_‰ame
 == 0))

1025 
	`upd©e_globÆ_°©s
(
p_I≈
, 
p_Vid
->
p_Sèts
, &p_Vid->
íc_pi˘uª
->
°©s
);

1026 
	`°‹e_pi˘uª_ö_dpb
 (
p_Dpb
, 
p_Vid
->
íc_pi˘uª
, &
p_I≈
->
ouçut
);

1028 #i‡(
MVC_EXTENSION_ENABLE
)

1029 i‡–
	`is_MVC_¥ofûe
(
¥ofûe_idc
Ë&& 
p_Vid
->
¥oc_pi˘uª
)

1031 
	`°‹e_¥oc_pi˘uª_ö_dpb
 (
p_Vid
->
p_Dpb_œyî
[1],Ö_Vid->
¥oc_pi˘uª
, &
p_I≈
->
ouçut
);

1032 
p_Vid
->
¥oc_pi˘uª
 = 
NULL
;

1035 
	`‰ì_pi˘uªs
(
p_Vid
, -1);

1041 
	`upd©e_bôcou¡î_°©s
(
VideoP¨amëîs
 *
p_Vid
)

1043 
p_Vid
->
p_Sèts
->
bô_˘r_n
 =Ö_Vid->p_Sèts->
bô_˘r
;

1044 
p_Vid
->
p_Sèts
->
bô_˘r_∑ømëî£ts_n
 = 0;

1045 
p_Vid
->
p_Sèts
->
bô_˘r_fûÀr_d©a_n
 =Ö_Vid->p_Sèts->
bô_˘r_fûÀr_d©a
;

1047 #i‡(
MVC_EXTENSION_ENABLE
)

1048 i‡–
p_Vid
->
p_I≈
->
num_of_võws
 == 2 )

1050 i‡–
p_Vid
->
Êd_Êag
 )

1052 i‡–
p_Vid
->
võw_id
 == 1 )

1054 
p_Vid
->
p_Sèts
->
bô_˘r_∑ømëî£ts_v
[0] +p_Vid->p_Sèts->
bô_˘r_∑ømëî£ts_n_v
[0];

1055 
p_Vid
->
p_Sèts
->
bô_˘r_∑ømëî£ts_v
[1] +p_Vid->p_Sèts->
bô_˘r_∑ømëî£ts_n_v
[1];

1056 
p_Vid
->
p_Sèts
->
bô_˘r_n_v
[0] =Ö_Vid->p_Sèts->
bô_˘r_v
[0];

1057 
p_Vid
->
p_Sèts
->
bô_˘r_n_v
[1] =Ö_Vid->p_Sèts->
bô_˘r_v
[1];

1058 
p_Vid
->
p_Sèts
->
bô_˘r_∑ømëî£ts_n_v
[0] = 0;

1059 
p_Vid
->
p_Sèts
->
bô_˘r_∑ømëî£ts_n_v
[1] = 0;

1060 
p_Vid
->
p_Sèts
->
bô_˘r_fûÀr_d©a_n_v
[0] =Ö_Vid->p_Sèts->
bô_˘r_fûÀr_d©a_v
[0];

1061 
p_Vid
->
p_Sèts
->
bô_˘r_fûÀr_d©a_n_v
[1] =Ö_Vid->p_Sèts->
bô_˘r_fûÀr_d©a_v
[1];

1066 
p_Vid
->
p_Sèts
->
bô_˘r_∑ømëî£ts_v
[p_Vid->
võw_id
] +p_Vid->p_Sèts->
bô_˘r_∑ømëî£ts_n_v
[p_Vid->view_id];

1067 
p_Vid
->
p_Sèts
->
bô_˘r_n_v
[p_Vid->
võw_id
] =Ö_Vid->p_Sèts->
bô_˘r_v
[p_Vid->view_id];

1068 
p_Vid
->
p_Sèts
->
bô_˘r_∑ømëî£ts_n_v
[p_Vid->
võw_id
] = 0;

1069 
p_Vid
->
p_Sèts
->
bô_˘r_fûÀr_d©a_n_v
[p_Vid->
võw_id
] =Ö_Vid->p_Sèts->
bô_˘r_fûÀr_d©a_v
[p_Vid->view_id];

1075 
	`upd©e_idr_‹dî_°©s
(
VideoP¨amëîs
 *
p_Vid
)

1077 i‡–
p_Vid
->
Êd_Êag
 )

1080 i‡–
p_Vid
->
p_cuº_‰m_°ru˘
->
p_t›_Êd_pic
->
p_Sli˚
[0].
ty≥
 =
I_SLICE
 &&Ö_Vid->p_cuº_‰m_°ru˘->p_t›_Êd_pic->
«l_ªf_idc
)

1082 
p_Vid
->
œ°INTRA
 = 
	`imax
’_Vid->œ°INTRA,Ö_Vid->
‰ame_no
);

1083 
p_Vid
->
œ°I¡øNumbî
 =Ö_Vid->
cuº_‰m_idx
;

1084 i‡–
p_Vid
->
p_cuº_‰m_°ru˘
->
p_t›_Êd_pic
->
idr_Êag
 )

1086 
p_Vid
->
œ°_idr_di•_‹dî
 = 
	`imax
–p_Vid->
‰ame_no
,Ö_Vid->last_idr_disp_order );

1087 
p_Vid
->
œ°_idr_code_‹dî
 =Ö_Vid->
cuº_‰m_idx
;

1091 i‡–
p_Vid
->
p_cuº_‰m_°ru˘
->
p_bŸ_Êd_pic
->
p_Sli˚
[0].
ty≥
 =
I_SLICE
 &&Ö_Vid->p_cuº_‰m_°ru˘->p_bŸ_Êd_pic->
«l_ªf_idc
)

1093 
p_Vid
->
œ°INTRA
 = 
	`imax
’_Vid->œ°INTRA,Ö_Vid->
‰ame_no
);

1094 
p_Vid
->
œ°I¡øNumbî
 =Ö_Vid->
cuº_‰m_idx
;

1095 i‡–
p_Vid
->
p_cuº_‰m_°ru˘
->
p_bŸ_Êd_pic
->
idr_Êag
 )

1097 
p_Vid
->
œ°_idr_di•_‹dî
 = 
	`imax
–p_Vid->
‰ame_no
,Ö_Vid->last_idr_disp_order );

1098 
p_Vid
->
œ°_idr_code_‹dî
 =Ö_Vid->
cuº_‰m_idx
;

1105 i‡–
p_Vid
->
p_cuº_‰m_°ru˘
->
p_‰ame_pic
->
p_Sli˚
[0].
ty≥
 =
I_SLICE
 &&Ö_Vid->p_cuº_‰m_°ru˘->p_‰ame_pic->
«l_ªf_idc
)

1107 
p_Vid
->
œ°INTRA
 = 
	`imax
’_Vid->œ°INTRA,Ö_Vid->
‰ame_no
);

1108 
p_Vid
->
œ°I¡øNumbî
 =Ö_Vid->
cuº_‰m_idx
;

1109 i‡–
p_Vid
->
p_cuº_‰m_°ru˘
->
p_‰ame_pic
->
idr_Êag
 )

1111 
p_Vid
->
œ°_idr_di•_‹dî
 = 
	`imax
–p_Vid->
‰ame_no
,Ö_Vid->last_idr_disp_order );

1112 
p_Vid
->
œ°_idr_code_‹dî
 =Ö_Vid->
cuº_‰m_idx
;

1118 
	`upd©e_video_°©s
(
VideoP¨amëîs
 *
p_Vid
)

1120 
bôs
 = 0;

1121 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

1124 if(
p_I≈
->
RCE«bÀ
)

1126 i‡((!
p_I≈
->
PicI¡îœ˚
Ë&& (!p_I≈->
MbI¡îœ˚
))

1128 
bôs
 = (Ë(
p_Vid
->
p_Sèts
->
bô_˘r
 -Ö_Vid->p_Sèts->
bô_˘r_n
)

1129 + ()–
p_Vid
->
p_Sèts
->
bô_˘r_fûÀr_d©a
 -Ö_Vid->p_Sèts->
bô_˘r_fûÀr_d©a_n
 );

1131 i‡–
p_I≈
->
RCUpd©eMode
 <
MAX_RC_MODE
 )

1133 
bôs
 = ()(
p_Vid
->
p_Sèts
->
bô_˘r
 - (p_Vid->
p_rc_quad
->
P¥ev_bôs
))

1134 + ()–
p_Vid
->
p_Sèts
->
bô_˘r_fûÀr_d©a
 -Ö_Vid->p_Sèts->
bô_˘r_fûÀr_d©a_n
 );

1135 
p_Vid
->
p_rc_quad
->
P¥ev_bôs
 =Ö_Vid->
p_Sèts
->
bô_˘r
 +Ö_Vid->p_Sèts->
bô_˘r_fûÀr_d©a
;

1139 
bôs
 = (Ë(
p_Vid
->
p_Sèts
->
bô_˘r
 -Ö_Vid->p_Sèts->
bô_˘r_n
)

1140 + ()–
p_Vid
->
p_Sèts
->
bô_˘r_fûÀr_d©a
 -Ö_Vid->p_Sèts->
bô_˘r_fûÀr_d©a_n
 );

1144 
p_Vid
->
p_Sèts
->
bô_cou¡î
[p_Vid->
ty≥
] +p_Vid->p_Sèts->
bô_˘r
 -Ö_Vid->p_Sèts->
bô_˘r_n
;

1146 #i‡(
MVC_EXTENSION_ENABLE
)

1147 i‡–
p_I≈
->
num_of_võws
 == 2 )

1149 i‡–
p_Vid
->
Êd_Êag
 )

1151 i‡–
p_Vid
->
võw_id
 == 1 )

1153 
¥ev_ty≥
 = (
p_Vid
->
p_¥ed
->
p_‰m_mvc
 + ( (p_Vid->
cuº_‰m_idx
 << 1Ë%Ö_Vid->p_¥ed->
num_‰ames_mvc
 ))->
ty≥
;

1155 
p_Vid
->
p_Sèts
->
bô_cou¡î_v
[0][
¥ev_ty≥
] +p_Vid->p_Sèts->
bô_˘r_v
[0] -Ö_Vid->p_Sèts->
bô_˘r_n_v
[0];

1156 
p_Vid
->
p_Sèts
->
bô_cou¡î_v
[1][p_Vid->
ty≥
] +p_Vid->p_Sèts->
bô_˘r_v
[1] -Ö_Vid->p_Sèts->
bô_˘r_n_v
[1];

1161 
p_Vid
->
p_Sèts
->
bô_cou¡î_v
[p_Vid->
võw_id
][p_Vid->
ty≥
] +p_Vid->p_Sèts->
bô_˘r_v
[p_Vid->võw_id] -Ö_Vid->p_Sèts->
bô_˘r_n_v
[p_Vid->view_id];

1166  
bôs
;

1175 
	`ícode_⁄e_‰ame
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

1177 
i
;

1178 
≈œ√
;

1181 
bôs
 = 0;

1183 
TIME_T
 
°¨t_time
;

1184 
TIME_T
 
íd_time
;

1185 
öt64
 
tmp_time
;

1187 
p_Vid
->
me_time
 = 0;

1188 
p_Vid
->
rd_∑ss
 = 0;

1190 if–(
p_I≈
->
£∑øã_cﬁour_∂™e_Êag
 != 0) )

1192  
≈œ√
=0;Ç∂™e<
MAX_PLANE
;Çplane++ ){

1193 
p_Vid
->
íc_‰ame_pi˘uª_JV
[
≈œ√
] = 
NULL
;

1197 
i
 = 0; i < 6; i++)

1198 
p_Vid
->
íc_‰ame_pi˘uª
[
i
] = 
NULL
;

1200 
	`gëtime
(&
°¨t_time
);

1203 
p_Vid
->
wrôe_ma¸oblock
 = 
FALSE
;

1216 
	`put_buf„r_‰ame
 (
p_Vid
);

1218 
	`öô_‰ame
 (
p_Vid
, 
p_I≈
);

1220 i‡(
p_I≈
->
íabÀ_32_puŒdown
)

1222 i‡–!
	`ªad_öput_d©a_32puŒdown
 (
p_Vid
) )

1229 i‡–!
	`ªad_öput_d©a
 (
p_Vid
) )

1235 
	`¥o˚ss_image
(
p_Vid
, 
p_I≈
);

1236 
	`∑d_b‹dîs
 (
p_I≈
->
ouçut
, 
p_Vid
->
width
,Ö_Vid->
height
,Ö_Vid->
width_¸
,Ö_Vid->
height_¸
,Ö_Vid->
imgD©a
.
‰m_d©a
);

1238 #i‡(
MVC_EXTENSION_ENABLE
)

1239 if(
p_I≈
->
num_of_võws
==1 || 
p_Vid
->
võw_id
==0)

1241 
p_Vid
->
fõld_pic_±r
 =Ö_Vid->
fõld_pic1
;

1245 
p_Vid
->
fõld_pic_±r
 =Ö_Vid->
fõld_pic2
;

1252 
p_Vid
->
p_Di°
->
‰ame_˘r
++;

1253 #i‡(
MVC_EXTENSION_ENABLE
)

1254 i‡(
p_I≈
->
num_of_võws
 == 2)

1256 
p_Vid
->
p_Di°
->
‰ame_˘r_v
[p_Vid->
võw_id
]++;

1260 if(
p_Vid
->
ty≥
 =
SP_SLICE
)

1262 if(
p_I≈
->
•2_‰ame_ödiˇt‹
)

1264 
p_Vid
->
•2_‰ame_ödiˇt‹
 = 
TRUE
;

1265 
	`ªad_SP_c€fficõ¡s
(
p_Vid
, 
p_I≈
);

1270 
p_Vid
->
•2_‰ame_ödiˇt‹
 = 
FALSE
;

1273 i‡–
p_I≈
->
WPMCPªcisi⁄
 )

1275 
	`wpxInôWPXPas£s
(
p_Vid
, 
p_I≈
);

1276 
p_Vid
->
pWPX
->
cuº_wp_rd_∑ss
 =Ö_Vid->pWPX->
wp_rd_∑s£s
;

1277 
p_Vid
->
pWPX
->
cuº_wp_rd_∑ss
->
Æg‹ôhm
 = 
WP_REGULAR
;

1280 i‡(
p_I≈
->
PicI¡îœ˚
 =
FIELD_CODING
)

1281 
	`≥rf‹m_ícode_fõld
(
p_Vid
);

1283 
	`≥rf‹m_ícode_‰ame
(
p_Vid
);

1285 
p_Vid
->
p_Sèts
->
‰ame_cou¡î
++;

1286 
p_Vid
->
p_Sèts
->
‰ame_˘r
[p_Vid->
ty≥
]++;

1290 
	`wrôe_‰ame_pi˘uª
(
p_Vid
);

1292 #i‡(
MVC_EXTENSION_ENABLE
)

1293 if(
p_I≈
->
num_of_võws
==2)

1296 if((
p_Vid
->
™ch‹_pic_Êag
[0]==1Ë&& (p_Vid->
võw_id
&1)==0)

1298 
p_Vid
->
¥ev_võw_is_™ch‹
 = 1;

1302 
p_Vid
->
¥ev_võw_is_™ch‹
 = 0;

1308 i‡(
p_I≈
->
PicI¡îœ˚
 =
FRAME_CODING
)

1310 i‡((
p_I≈
->
rd›t
 =3Ë&& (p_I≈->
de
 =
LLN
Ë&& (
p_Vid
->
«l_ª„ªn˚_idc
 != 0))

1312 
	`Upd©eDecodîs
 (
p_Vid
, 
p_I≈
,Ö_Vid->
íc_pi˘uª
);

1315 i‡(
p_I≈
->
Re°ri˘Ref
)

1316 
	`Upd©ePixñM≠
 (
p_Vid
, 
p_I≈
);

1319 #i‡
OUTPUT_REF_LIST


1321 
i
;

1322 
	`¥ötf
( " [L0]: " );

1323  
i
 = 0; i<
p_Vid
->
cuºítSli˚
->
li°Xsize
[0]; i++ )

1325 
	`¥ötf
–"%d ", 
p_Vid
->
cuºítSli˚
->
li°X
[0][
i
]->
poc
 / 2 );

1327 
	`¥ötf
( " [L1]: " );

1328  
i
 = 0; i<
p_Vid
->
cuºítSli˚
->
li°Xsize
[1]; i++ )

1330 
	`¥ötf
–"%d ", 
p_Vid
->
cuºítSli˚
->
li°X
[1][
i
]->
poc
 / 2 );

1332 
	`¥ötf
("\n");

1336 
	`‰ì_¶i˚_d©a
(
p_Vid
);

1339 i‡–
p_I≈
->
RCE«bÀ
 )

1342 
bôs
 = ()–
p_Vid
->
p_Sèts
->
bô_˘r
 -Ö_Vid->p_Sèts->
bô_˘r_n
 )

1343 + ()–
p_Vid
->
p_Sèts
->
bô_˘r_fûÀr_d©a
 -Ö_Vid->p_Sèts->
bô_˘r_fûÀr_d©a_n
 );

1345 i‡–
p_I≈
->
RCUpd©eMode
 <
MAX_RC_MODE
 )

1346 
p_Vid
->
	`rc_upd©e_pi˘_‰ame_±r
’_Vid, 
p_I≈
,Ö_Vid->
p_rc_quad
,Ö_Vid->
p_rc_gí
, 
bôs
);

1350 
	`compuã_di°‹ti⁄
(
p_Vid
, &p_Vid->
imgD©a
);

1353 if(
p_I≈
->
ªdund™t_pic_Êag
)

1355 
	`°‹eRedund™tFøme
(
p_Vid
);

1359 
	`°‹e_coded_pi˘uª
(
p_Vid
->
p_Dpb_œyî
[p_Vid->
võw_id
]);

1362 
p_Vid
->
AvîageFømeQP
 = 
	`isign
’_Vid->
SumFømeQP
Ë* ((
	`übs
’_Vid->SumFømeQPË+ (Ë’_Vid->
FømeSizeInMbs
 >> 1))/ ()Ö_Vid->FrameSizeInMbs);

1364 i‡–
p_I≈
->
RCE«bÀ
 &&Ö_I≈->
RCUpd©eMode
 <
MAX_RC_MODE
 && 
p_Vid
->
ty≥
 !
B_SLICE
 &&Ö_I≈->
basicunô
 <Ö_Vid->
FømeSizeInMbs
 )

1365 
p_Vid
->
p_rc_quad
->
CuºLa°QP
 =Ö_Vid->
AvîageFømeQP
 +Ö_Vid->p_rc_quad->
bôdïth_qp_sˇÀ
;

1367 #ifde‡
_LEAKYBUCKET_


1369 i‡(!
p_Vid
->
ªdund™t_codög
)

1371 
p_Vid
->
Bô_Buf„r
[p_Vid->
tŸÆ_‰ame_buf„r
++] = (Ë’_Vid->
p_Sèts
->
bô_˘r
 -Ö_Vid->p_Sèts->
bô_˘r_n
)

1372 + ()–
p_Vid
->
p_Sèts
->
bô_˘r_fûÀr_d©a
 -Ö_Vid->p_Sèts->
bô_˘r_fûÀr_d©a_n
 );

1378 i‡(
p_Vid
->
pic_‹dî_˙t_ty≥
 == 2)

1380 i‡(!
p_Vid
->
«l_ª„ªn˚_idc
)

1381 
p_Vid
->
c⁄£cutive_n⁄_ª„ªn˚_pi˘uªs
++;

1383 
p_Vid
->
c⁄£cutive_n⁄_ª„ªn˚_pi˘uªs
 = 0;

1385 i‡(
p_Vid
->
‰ame_no
 <Ö_Vid->
¥ev_‰ame_no
 ||Ö_Vid->
c⁄£cutive_n⁄_ª„ªn˚_pi˘uªs
>1)

1386 
	`îr‹
("POCÅype 2 cannot beápplied forÅhe codingÖattern whereÅheÉncoding /decoding order ofÖicturesáre different fromÅhe output order.\n", -1);

1387 
p_Vid
->
¥ev_‰ame_no
 =Ö_Vid->
‰ame_no
;

1390 
	`gëtime
(&
íd_time
);

1391 
tmp_time
 = 
	`timediff
(&
°¨t_time
, &
íd_time
);

1392 
p_Vid
->
tŸ_time
 +
tmp_time
;

1393 
tmp_time
 = 
	`timí‹m
(tmp_time);

1394 
p_Vid
->
me_time
 = 
	`timí‹m
(p_Vid->me_time);

1395 i‡(
p_Vid
->
p_Sèts
->
bô_˘r_∑ømëî£ts_n
!=0 && 
p_I≈
->
Vîbo£
 != 3)

1396 
	`Rï‹tNALN⁄VLCBôs
(
p_Vid
, 
tmp_time
);

1398 #i‡(
MVC_EXTENSION_ENABLE
)

1399 i‡(
p_Vid
->
cuº_‰m_idx
 =0 && !p_Vid->
võw_id
)

1401 i‡(
p_Vid
->
cuº_‰m_idx
 == 0)

1403 
	`Rï‹tFú°‰ame
(
p_Vid
, 
tmp_time
);

1406 
bôs
 = 
	`upd©e_video_°©s
(
p_Vid
);

1408 
p_Vid
->
ty≥
)

1410 
I_SLICE
:

1411 
SI_SLICE
:

1412 
	`Rï‹tI
(
p_Vid
, 
tmp_time
);

1414 
B_SLICE
:

1415 
	`Rï‹tB
(
p_Vid
, 
tmp_time
);

1417 
SP_SLICE
:

1418 
	`Rï‹tP
(
p_Vid
, 
tmp_time
);

1420 
P_SLICE
:

1422 
	`Rï‹tP
(
p_Vid
, 
tmp_time
);

1426 i‡(
p_I≈
->
Vîbo£
 == 0)

1431 
	`¥ötf
("Com∂ëed Encodög Fømê%05d.\r", 
p_Vid
->
‰ame_no
);

1434 
	`fÊush
(
°dout
);

1437 if(
p_I≈
->
RCE«bÀ
)

1438 
p_Vid
->
	`rc_upd©e_pi˘uª_±r
–p_Vid, 
p_I≈
, 
bôs
 );

1441 
	`upd©e_bôcou¡î_°©s
(
p_Vid
);

1443 
	`upd©e_idr_‹dî_°©s
(
p_Vid
);

1459 #i‡(
MVC_EXTENSION_ENABLE
)

1460 
	`wrôeout_pi˘uª
(
VideoP¨amëîs
 *
p_Vid
, 
Pi˘uª
 *
pic
, 
is_bŸtom
)

1462 
∑πôi⁄
, 
¶i˚
, 
bôs
;

1463 
Sli˚
 *
cuºSli˚
;

1464 
NALU_t
 *
«lu
 = 
NULL
;

1466 
p_Vid
->
cuºítPi˘uª
 = 
pic
;

1469 
¶i˚
=0; sli˚ < 
pic
->
no_¶i˚s
; slice++)

1471 
cuºSli˚
 = 
pic
->
¶i˚s
[
¶i˚
];

1474 
∑πôi⁄
=0;Ö¨tôi⁄ < 
cuºSli˚
->
max_∑π_ƒ
;Öartition++)

1477 i‡–
cuºSli˚
->
∑πAº
[
∑πôi⁄
].
bô°ªam
->
wrôe_Êag
 )

1479 if(
p_Vid
->
p_I≈
->
num_of_võws
==2 &&Ö_Vid->
võw_id
==0)

1481 
«lu
 = 
	`AŒocNALU
(
MAXNALUSIZE
);

1482 
«lu
->
°¨tcodïªfix_Àn
 = 4;

1483 
«lu
->
«l_unô_ty≥
 = 
NALU_TYPE_PREFIX
;

1484 
«lu
->
«l_ª„ªn˚_idc
 = 
NALU_PRIORITY_HIGHEST
;

1485 
«lu
->
svc_exãnsi⁄_Êag
 = 0;

1486 
«lu
->
n⁄_idr_Êag
 = 
p_Vid
->n⁄_idr_Êag[
is_bŸtom
];

1487 
«lu
->
¥i‹ôy_id
 = 
p_Vid
->priority_id;

1488 
«lu
->
võw_id
 = 
p_Vid
->view_id;

1489 
«lu
->
ãmp‹Æ_id
 = 
p_Vid
->temporal_id;

1490 
«lu
->
™ch‹_pic_Êag
 = 
p_Vid
->™ch‹_pic_Êag[
is_bŸtom
];

1491 
«lu
->
öãr_võw_Êag
 = 
p_Vid
->öãr_võw_Êag[
is_bŸtom
];

1492 
«lu
->
ª£rved_⁄e_bô
 = 1;

1494 
bôs
 = 
p_Vid
->
	`WrôeNALU
 (p_Vid, 
«lu
,Ö_Vid->
f_out
);

1495 
p_Vid
->
p_Sèts
->
bô_˘r
 +
bôs
;

1496 
p_Vid
->
p_Sèts
->
bô_˘r_v
[0] +
bôs
;

1497 
	`FªeNALU
(
«lu
);

1500 
bôs
 = 
p_Vid
->
	`WrôeNALU
 (p_Vid, 
cuºSli˚
->
∑πAº
[
∑πôi⁄
].
«l_unô
,Ö_Vid->
f_out
);

1501 
p_Vid
->
p_Sèts
->
bô_˘r
 +
bôs
;

1502 i‡–
p_Vid
->
p_I≈
->
num_of_võws
 == 2 )

1504 
p_Vid
->
p_Sèts
->
bô_˘r_v
[p_Vid->
võw_id
] +
bôs
;

1511 
	`wrôeout_pi˘uª
(
VideoP¨amëîs
 *
p_Vid
, 
Pi˘uª
 *
pic
)

1513 
∑πôi⁄
, 
¶i˚
, 
bôs
;

1514 
Sli˚
 *
cuºSli˚
;

1516 
p_Vid
->
cuºítPi˘uª
 = 
pic
;

1519 
¶i˚
=0; sli˚ < 
pic
->
no_¶i˚s
; slice++)

1521 
cuºSli˚
 = 
pic
->
¶i˚s
[
¶i˚
];

1524 
∑πôi⁄
=0;Ö¨tôi⁄ < 
cuºSli˚
->
max_∑π_ƒ
;Öartition++)

1527 i‡(
cuºSli˚
->
∑πAº
[
∑πôi⁄
].
bô°ªam
->
wrôe_Êag
 )

1529 
bôs
 = 
p_Vid
->
	`WrôeNALU
 (p_Vid, 
cuºSli˚
->
∑πAº
[
∑πôi⁄
].
«l_unô
,Ö_Vid->
f_out
);

1530 
p_Vid
->
p_Sèts
->
bô_˘r
 +
bôs
;

1538 
	`c›y_∑øms
(
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
íc_pi˘uª
, 
£q_∑ømëî_£t_rb•_t
 *
a˘ive_•s
)

1540 
íc_pi˘uª
->
‰ame_mbs_⁄ly_Êag
 = 
a˘ive_•s
->frame_mbs_only_flag;

1541 
íc_pi˘uª
->
‰ame_¸›pög_Êag
 = 
a˘ive_•s
->frame_cropping_flag;

1542 
íc_pi˘uª
->
chroma_f‹m©_idc
 = 
a˘ive_•s
->chroma_format_idc;

1543 
íc_pi˘uª
->
chroma_mask_mv_x
 = 
p_Vid
->chroma_mask_mv_x;

1544 
íc_pi˘uª
->
chroma_mask_mv_y
 = 
p_Vid
->chroma_mask_mv_y;

1545 
íc_pi˘uª
->
chroma_shi·_y
 = 
p_Vid
->chroma_shift_y;

1546 
íc_pi˘uª
->
chroma_shi·_x
 = 
p_Vid
->chroma_shift_x;

1547 
íc_pi˘uª
->
Ÿf_Êag
 = 
p_Vid
->
p_I≈
->
OnTheFlyFø˘MCP
;

1549 i‡(
a˘ive_•s
->
‰ame_¸›pög_Êag
)

1551 
íc_pi˘uª
->
‰ame_¸›_À·_off£t
 = 
a˘ive_•s
->frame_crop_left_offset;

1552 
íc_pi˘uª
->
‰ame_¸›_right_off£t
 = 
a˘ive_•s
->frame_crop_right_offset;

1553 
íc_pi˘uª
->
‰ame_¸›_t›_off£t
 = 
a˘ive_•s
->frame_crop_top_offset;

1554 
íc_pi˘uª
->
‰ame_¸›_bŸtom_off£t
 = 
a˘ive_•s
->frame_crop_bottom_offset;

1558 
íc_pi˘uª
->
‰ame_¸›_À·_off£t
 = 0;

1559 
íc_pi˘uª
->
‰ame_¸›_right_off£t
 = 0;

1560 
íc_pi˘uª
->
‰ame_¸›_t›_off£t
 = 0;

1561 
íc_pi˘uª
->
‰ame_¸›_bŸtom_off£t
 = 0;

1571 
	`¥ï¨e_íc_‰ame_pi˘uª
 (
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 **
°‹ed_pic
)

1573 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

1574 (*
°‹ed_pic
Ë
	`Æloc_°‹abÀ_pi˘uª
 (
p_Vid
, (
Pi˘uªSåu˘uª
Ëp_Vid->
°ru˘uª
,Ö_Vid->
width
,Ö_Vid->
height
,Ö_Vid->
width_¸
,Ö_Vid->
height_¸
);

1576 
p_Vid
->
ThisPOC
 =Ö_Vid->
‰amïoc
;

1577 (*
°‹ed_pic
)->
poc
 = 
p_Vid
->
‰amïoc
;

1578 (*
°‹ed_pic
)->
t›_poc
 = 
p_Vid
->
t›poc
;

1579 (*
°‹ed_pic
)->
bŸtom_poc
 = 
p_Vid
->
bŸtompoc
;

1580 (*
°‹ed_pic
)->
‰ame_poc
 = 
p_Vid
->
‰amïoc
;

1581 (*
°‹ed_pic
)->
pic_num
 = 
p_Vid
->
‰ame_num
;

1582 (*
°‹ed_pic
)->
‰ame_num
 = 
p_Vid
->frame_num;

1583 (*
°‹ed_pic
)->
coded_‰ame
 = 1;

1584 (*
°‹ed_pic
)->
mb_aff_‰ame_Êag
 = 
p_Vid
->mb_aff_‰ame_Êag = (
Boﬁón
Ë(
p_I≈
->
MbI¡îœ˚
 !
FRAME_CODING
);

1586 
p_Vid
->
gë_mb_block_pos
 =Ö_Vid->
mb_aff_‰ame_Êag
 ? 
gë_mb_block_pos_mbaff
 : 
gë_mb_block_pos_n‹mÆ
;

1587 
p_Vid
->
gëNeighbour
 =Ö_Vid->
mb_aff_‰ame_Êag
 ? 
gëAffNeighbour
 : 
gëN⁄AffNeighbour
;

1588 
p_Vid
->
íc_pi˘uª
 = *
°‹ed_pic
;

1590 
	`c›y_∑øms
(
p_Vid
,Ö_Vid->
íc_pi˘uª
,Ö_Vid->
a˘ive_•s
);

1593 
	`ˇlc_pi˘uª_bôs
(
Pi˘uª
 *
‰ame
)

1595 
i
, 
j
;

1596 
Sli˚
 *
thisSli˚
 = 
NULL
;

1598 
‰ame
->
bôs_≥r_pi˘uª
 = 0;

1600  
i
 = 0; i < 
‰ame
->
no_¶i˚s
; i++ )

1602 
thisSli˚
 = 
‰ame
->
¶i˚s
[
i
];

1604  
j
 = 0; j < 
thisSli˚
->
max_∑π_ƒ
; j++ )

1605 
‰ame
->
bôs_≥r_pi˘uª
 +8 * ((
thisSli˚
->
∑πAº
[
j
]).
bô°ªam
)->
byã_pos
;

1615 
	`‰ame_pi˘uª
 (
VideoP¨amëîs
 *
p_Vid
, 
Pi˘uª
 *
‰ame
, 
ImageD©a
 *
imgD©a
, 
rd_∑ss
)

1617 
≈œ√
;

1618 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

1619 
p_Vid
->
rd_∑ss
 =Ñd_pass;

1620 
p_Vid
->
SumFømeQP
 = 0;

1621 
p_Vid
->
num_ªf_idx_l0_a˘ive
 = 0;

1622 
p_Vid
->
num_ªf_idx_l1_a˘ive
 = 0;

1623 
p_Vid
->
p_cuº_pic
 =Ö_Vid->
p_cuº_‰m_°ru˘
->
p_‰ame_pic
;

1624 
p_Vid
->
°ru˘uª
 = 
FRAME
;

1625 
p_Vid
->
PicSizeInMbs
 =Ö_Vid->
FømeSizeInMbs
;

1627 
	`upd©e_mv_limôs
(
p_Vid
, 
FALSE
);

1629 
	`InôWP
(
p_Vid
, 
p_I≈
, 0);

1630 if(
rd_∑ss
 =0 && 
p_Vid
->
wp_∑ømëîs_£t
 == 0)

1631 
	`Re£tWP
(
p_Vid
, 
p_I≈
);

1633 if–(
p_I≈
->
£∑øã_cﬁour_∂™e_Êag
 != 0) )

1635  
≈œ√
=0;Ç∂™e<
MAX_PLANE
;Çplane++ )

1637 
	`¥ï¨e_íc_‰ame_pi˘uª
–
p_Vid
, &p_Vid->
íc_‰ame_pi˘uª_JV
[
≈œ√
] );

1642 
	`¥ï¨e_íc_‰ame_pi˘uª
–
p_Vid
, &p_Vid->
íc_‰ame_pi˘uª
[
rd_∑ss
] );

1645 
p_Vid
->
Êd_Êag
 = 
FALSE
;

1646 
	`code_a_pi˘uª
(
p_Vid
, 
‰ame
);

1648 if–(
p_I≈
->
£∑øã_cﬁour_∂™e_Êag
 != 0) )

1650 
	`make_‰ame_pi˘uª_JV
(
p_Vid
);

1653 
	`ˇlc_pi˘uª_bôs
(
‰ame
);

1655 i‡(
p_Vid
->
°ru˘uª
==
FRAME
)

1657 
	`föd_di°‹ti⁄
 (
p_Vid
, 
imgD©a
);

1658 
‰ame
->
di°‹ti⁄
 = 
p_Vid
->
p_Di°
->
mëric
[
SSE
];

1669 
	`fõld_pi˘uª
 (
VideoP¨amëîs
 *
p_Vid
, 
Pi˘uª
 *
t›
, Pi˘uª *
bŸtom
)

1671 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

1673 
T›FõldBôs
;

1675 
p_Vid
->
SumFømeQP
 = 0;

1676 
p_Vid
->
num_ªf_idx_l0_a˘ive
 = 0;

1677 
p_Vid
->
num_ªf_idx_l1_a˘ive
 = 0;

1680 
	`upd©e_mv_limôs
(
p_Vid
, 
TRUE
);

1682 
p_Vid
->
height
 = (
p_I≈
->
ouçut
.height[0] +Ö_Vid->
auto_¸›_bŸtom
) >> 1;

1683 
p_Vid
->
height_¸
 =Ö_Vid->
height_¸_‰ame
 >> 1;

1684 
p_Vid
->
Êd_Êag
 = 
TRUE
;

1685 
p_Vid
->
PicSizeInMbs
 =Ö_Vid->
FømeSizeInMbs
 >> 1;

1688 
p_Vid
->
íc_fõld_pi˘uª
[0] = 
	`Æloc_°‹abÀ_pi˘uª
 (p_Vid, (
Pi˘uªSåu˘uª
Ëp_Vid->
°ru˘uª
,Ö_Vid->
width
,Ö_Vid->
height
,Ö_Vid->
width_¸
,Ö_Vid->
height_¸
);

1689 
p_Vid
->
íc_fõld_pi˘uª
[0]->
poc
 =Ö_Vid->
t›poc
;

1690 
p_Vid
->
íc_fõld_pi˘uª
[0]->
‰ame_poc
 =Ö_Vid->
t›poc
;

1692 
p_Vid
->
íc_fõld_pi˘uª
[0]->
pic_num
 =Ö_Vid->
‰ame_num
;

1693 
p_Vid
->
íc_fõld_pi˘uª
[0]->
‰ame_num
 =Ö_Vid->frame_num;

1694 
p_Vid
->
íc_fõld_pi˘uª
[0]->
coded_‰ame
 = 0;

1695 
p_Vid
->
íc_fõld_pi˘uª
[0]->
mb_aff_‰ame_Êag
 =Ö_Vid->mb_aff_‰ame_Êag = 
FALSE
;

1696 
p_Vid
->
gë_mb_block_pos
 = 
gë_mb_block_pos_n‹mÆ
;

1697 
p_Vid
->
gëNeighbour
 = 
gëN⁄AffNeighbour
;

1698 
p_Vid
->
ThisPOC
 =Ö_Vid->
t›poc
;

1700 
p_Vid
->
p_cuº_pic
 =Ö_Vid->
p_cuº_‰m_°ru˘
->
p_t›_Êd_pic
;

1701 
p_Vid
->
°ru˘uª
 = 
TOP_FIELD
;

1702 
p_Vid
->
íc_pi˘uª
 =Ö_Vid->
íc_fõld_pi˘uª
[0];

1703 
	`c›y_∑øms
(
p_Vid
,Ö_Vid->
íc_pi˘uª
,Ö_Vid->
a˘ive_•s
);

1705 
	`put_buf„r_t›
 (
p_Vid
);

1706 
	`öô_fõld
 (
p_Vid
, 
p_I≈
);

1707 
	`£t_¶i˚_ty≥
(
p_Vid
, 
p_I≈
,Ö_Vid->
p_cuº_pic
->
p_Sli˚
[0].
ty≥
);

1709 
p_Vid
->
Êd_Êag
 = 
TRUE
;

1712 if(
p_I≈
->
RCE«bÀ
 &&Ö_I≈->
RCUpd©eMode
 <
MAX_RC_MODE
)

1713 
	`rc_öô_t›_fõld
(
p_Vid
, 
p_I≈
);

1715 
	`code_a_pi˘uª
(
p_Vid
, 
t›
);

1716 
p_Vid
->
íc_pi˘uª
->
°ru˘uª
 = 
TOP_FIELD
;

1717 
	`°‹e_pi˘uª_ö_dpb
(
p_Vid
->
p_Dpb_œyî
[p_Vid->
võw_id
],Ö_Vid->
íc_fõld_pi˘uª
[0], &
p_I≈
->
ouçut
);

1719 #i‡(
MVC_EXTENSION_ENABLE
)

1720 i‡–
	`is_MVC_¥ofûe
(
p_Vid
->
a˘ive_•s
->
¥ofûe_idc
Ë&&Ö_Vid->
¥oc_pi˘uª
)

1722 
	`°‹e_¥oc_pi˘uª_ö_dpb
 (
p_Vid
->
p_Dpb_œyî
[1],Ö_Vid->
¥oc_pi˘uª
, &
p_I≈
->
ouçut
);

1723 
p_Vid
->
¥oc_pi˘uª
 = 
NULL
;

1726 
	`ˇlc_pi˘uª_bôs
(
t›
);

1729 
T›FõldBôs
=
t›
->
bôs_≥r_pi˘uª
;

1732 
p_Vid
->
íc_fõld_pi˘uª
[1] = 
	`Æloc_°‹abÀ_pi˘uª
 (p_Vid, (
Pi˘uªSåu˘uª
Ëp_Vid->
°ru˘uª
,Ö_Vid->
width
,Ö_Vid->
height
,Ö_Vid->
width_¸
,Ö_Vid->
height_¸
);

1733 
p_Vid
->
íc_fõld_pi˘uª
[1]->
poc
ı_Vid->
bŸtompoc
;

1734 
p_Vid
->
íc_fõld_pi˘uª
[1]->
‰ame_poc
 =Ö_Vid->
bŸtompoc
;

1735 
p_Vid
->
íc_fõld_pi˘uª
[1]->
pic_num
 =Ö_Vid->
‰ame_num
;

1736 
p_Vid
->
íc_fõld_pi˘uª
[1]->
‰ame_num
 =Ö_Vid->frame_num;

1737 
p_Vid
->
íc_fõld_pi˘uª
[1]->
coded_‰ame
 = 0;

1738 
p_Vid
->
íc_fõld_pi˘uª
[1]->
mb_aff_‰ame_Êag
 =Ö_Vid->mb_aff_‰ame_Êag = 
FALSE
;

1739 
p_Vid
->
gë_mb_block_pos
 = 
gë_mb_block_pos_n‹mÆ
;

1740 
p_Vid
->
gëNeighbour
 = 
gëN⁄AffNeighbour
;

1742 
p_Vid
->
ThisPOC
 =Ö_Vid->
bŸtompoc
;

1743 
p_Vid
->
p_cuº_pic
 =Ö_Vid->
p_cuº_‰m_°ru˘
->
p_bŸ_Êd_pic
;

1744 
p_Vid
->
°ru˘uª
 = 
BOTTOM_FIELD
;

1745 
p_Vid
->
íc_pi˘uª
 =Ö_Vid->
íc_fõld_pi˘uª
[1];

1746 
	`c›y_∑øms
(
p_Vid
,Ö_Vid->
íc_pi˘uª
,Ö_Vid->
a˘ive_•s
);

1747 
	`put_buf„r_bŸ
 (
p_Vid
);

1749 
	`öô_fõld
 (
p_Vid
, 
p_I≈
);

1750 
	`£t_¶i˚_ty≥
(
p_Vid
, 
p_I≈
,Ö_Vid->
p_cuº_pic
->
p_Sli˚
[0].
ty≥
);

1752 
p_Vid
->
Êd_Êag
 = 
TRUE
;

1755 if(
p_I≈
->
RCE«bÀ
 &&Ö_I≈->
RCUpd©eMode
 <
MAX_RC_MODE
)

1756 
	`rc_öô_bŸtom_fõld
–
p_Vid
, 
p_I≈
, 
T›FõldBôs
 );

1758 
p_Vid
->
íc_pi˘uª
->
°ru˘uª
 = 
BOTTOM_FIELD
;

1759 
	`code_a_pi˘uª
(
p_Vid
, 
bŸtom
);

1761 
	`ˇlc_pi˘uª_bôs
(
bŸtom
);

1765 
	`di°‹ti⁄_Êd
 (
p_Vid
, 
p_I≈
, 
t›
, &p_Vid->
imgD©a
);

1774 
	`comböe_fõld
(
VideoP¨amëîs
 *
p_Vid
)

1776 
i
, 
k
;

1778 
i
 = 0; i < (
p_Vid
->
height
 >> 1); i++)

1780 
	`mem˝y
(
p_Vid
->
imgY_com
[
i
*2],Ö_Vid->
íc_fõld_pi˘uª
[0]->
imgY
[i],Ö_Vid->
width
*(
img≥l
));

1781 
	`mem˝y
(
p_Vid
->
imgY_com
[
i
*2 + 1],Ö_Vid->
íc_fõld_pi˘uª
[1]->
imgY
[i],Ö_Vid->
width
*(
img≥l
));

1784 i‡(
p_Vid
->
yuv_f‹m©
 !
YUV400
)

1786 
k
 = 0; k < 2; k++)

1788 
i
 = 0; i < (
p_Vid
->
height_¸
 >> 1); i++)

1790 
	`mem˝y
(
p_Vid
->
imgUV_com
[
k
][
i
 * 2],Ö_Vid->
íc_fõld_pi˘uª
[0]->
imgUV
[k][i],Ö_Vid->
width_¸
*(
img≥l
));

1791 
	`mem˝y
(
p_Vid
->
imgUV_com
[
k
][
i
 * 2 + 1],Ö_Vid->
íc_fõld_pi˘uª
[1]->
imgUV
[k][i],Ö_Vid->
width_¸
*(
img≥l
));

1803 
	`di°‹ti⁄_Êd
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
Pi˘uª
 *
fõld_pic
, 
ImageD©a
 *
imgD©a
)

1805 
p_Vid
->
height
 = (
p_I≈
->
ouçut
.height[0] +Ö_Vid->
auto_¸›_bŸtom
);

1806 
p_Vid
->
height_¸
 =Ö_Vid->
height_¸_‰ame
;

1808 
	`comböe_fõld
 (
p_Vid
);

1810 
p_Vid
->
pCurImg
 = 
imgD©a
->
‰m_d©a
[0];

1811 
p_Vid
->
pImgOrg
[0] = 
imgD©a
->
‰m_d©a
[0];

1813 i‡(
p_I≈
->
ouçut
.
yuv_f‹m©
 !
YUV400
)

1815 
p_Vid
->
pImgOrg
[1] = 
imgD©a
->
‰m_d©a
[1];

1816 
p_Vid
->
pImgOrg
[2] = 
imgD©a
->
‰m_d©a
[2];

1819 
	`föd_di°‹ti⁄
 (
p_Vid
, 
imgD©a
);

1820 
fõld_pic
->
di°‹ti⁄
 = 
p_Vid
->
p_Di°
->
mëric
[
SSE
];

1830 
byã
 
	`decide_Êd_‰ame
(
¢r_‰ame_Y
, 
¢r_fõld_Y
, 
bô_fõld
, 
bô_‰ame
, 
œmbda_pi˘uª
)

1832 
co°_‰ame
, 
co°_fõld
;

1834 
co°_‰ame
 = 
bô_‰ame
 * 
œmbda_pi˘uª
 + 
¢r_‰ame_Y
;

1835 
co°_fõld
 = 
bô_fõld
 * 
œmbda_pi˘uª
 + 
¢r_fõld_Y
;

1837 i‡(
co°_fõld
 > 
co°_‰ame
)

1838  
FALSE
;

1840  
TRUE
;

1849 
byã
 
	`pi˘uª_°ru˘uª_decisi⁄
 (
VideoP¨amëîs
 *
p_Vid
, 
Pi˘uª
 *
‰ame
, Pi˘uª *
t›
, Pi˘uª *
bŸ
)

1851 
œmbda_pi˘uª
;

1852 
s£_‰ame
, 
s£_fõld
;

1853 
bô_‰ame
, 
bô_fõld
;

1855 
œmbda_pi˘uª
 = 0.68 * 
	`pow
 (2, 
p_Vid
->
bôdïth_œmbda_sˇÀ
 + (’_Vid->
qp
 - 
SHIFT_QP
Ë/ 3.0)Ë* (’_Vid->
ty≥
 =
B_SLICE
) ? 1 : 1);

1857 
s£_‰ame
 = 
‰ame
->
di°‹ti⁄
.
vÆue
[0] + frame->distortion.value[1] + frame->distortion.value[2];

1859 
s£_fõld
 = 
t›
->
di°‹ti⁄
.
vÆue
[0] +Åop->distortion.value[1] +Åop->distortion.value[2];

1861 
bô_fõld
 = 
t›
->
bôs_≥r_pi˘uª
 + 
bŸ
->bits_per_picture;

1862 
bô_‰ame
 = 
‰ame
->
bôs_≥r_pi˘uª
;

1863  
	`decide_Êd_‰ame
 (
s£_‰ame
, 
s£_fõld
, 
bô_fõld
, 
bô_‰ame
, 
œmbda_pi˘uª
);

1873 
	`fõld_mode_buf„r
 (
VideoP¨amëîs
 *
p_Vid
)

1875 
	`put_buf„r_‰ame
 (
p_Vid
);

1885 
	`‰ame_mode_buf„r
 (
VideoP¨amëîs
 *
p_Vid
)

1887 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

1888 
	`put_buf„r_‰ame
 (
p_Vid
);

1890 i‡((
p_I≈
->
PicI¡îœ˚
 !
FRAME_CODING
)||’_I≈->
MbI¡îœ˚
 != FRAME_CODING))

1892 
p_Vid
->
height
 =Ö_Vid->height / 2;

1893 
p_Vid
->
height_¸
 =Ö_Vid->height_cr / 2;

1895 
	`put_buf„r_t›
 (
p_Vid
);

1897 
	`put_buf„r_bŸ
 (
p_Vid
);

1899 
p_Vid
->
height
 = (
p_I≈
->
ouçut
.height[0] +Ö_Vid->
auto_¸›_bŸtom
);

1900 
p_Vid
->
height_¸
 =Ö_Vid->
height_¸_‰ame
;

1902 
	`put_buf„r_‰ame
 (
p_Vid
);

1913 
	`öô_dec_ªf_pic_m¨kög_buf„r
(
VideoP¨amëîs
 *
p_Vid
)

1915 
p_Vid
->
dec_ªf_pic_m¨kög_buf„r
=
NULL
;

1925 
ölöe
 
	`öô_fixed_qp_i_¶i˚
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
FømeUnôSåu˘
 *
p_cur_‰m
 )

1928 
p_Vid
->
qp
 = 
p_cur_‰m
->qp;

1930 i‡(
p_Vid
->
ªdund™t_codög
)

1933 
p_Vid
->
qp
 = 
	`imö
(p_Vid->qp + 5, 51);

1944 
ölöe
 
	`öô_fixed_qp_pb_¶i˚
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
FømeUnôSåu˘
 *
p_cur_‰m
, 
ty≥
 )

1947 
p_Vid
->
qp
 = 
p_cur_‰m
->qp;

1958 
ölöe
 
	`öô_fixed_qp_•_¶i˚
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
FømeUnôSåu˘
 *
p_cur_‰m
 )

1960 
p_Vid
->
qp
 = 
p_cur_‰m
->qp;

1961 
p_Vid
->
qp•
 = 
p_I≈
->qpsp;

1972 
	`öô_fixed_qp
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

1974 
FømeUnôSåu˘
 *
p_cur_‰m
 = 
p_Vid
->
p_cuº_‰m_°ru˘
;

1976 i‡(
p_cur_‰m
->
œyî
 == 0)

1978  
p_cur_‰m
->
ty≥
 )

1981 
I_SLICE
:

1982 
	`öô_fixed_qp_i_¶i˚
–
p_Vid
, 
p_I≈
, 
p_cur_‰m
 );

1984 
P_SLICE
:

1985 
B_SLICE
:

1986 
	`öô_fixed_qp_pb_¶i˚
–
p_Vid
, 
p_I≈
, 
p_cur_‰m
,Ö_cur_‰m->
ty≥
 );

1988 
SP_SLICE
:

1989 
SI_SLICE
:

1990 
	`öô_fixed_qp_•_¶i˚
–
p_Vid
, 
p_I≈
, 
p_cur_‰m
 );

1994 
p_Vid
->
mb_y_öåa
 =Ö_Vid->
mb_y_upd
;

1996 i‡(
p_I≈
->
öåa_upd
 > 0)

1998 
p_Vid
->
mb_y_upd
 = (p_Vid->
cuº_‰m_idx
 / 
p_I≈
->
öåa_upd
Ë% (p_Vid->
height
 / 
MB_BLOCK_SIZE
);

2003 
p_Vid
->
qp
 = 
p_cur_‰m
->qp;

2007 i‡–
p_I≈
->
qp2‰ame
 &&Ö_I≈->qp2‰amê< 
p_Vid
->
‰ame_no
 )

2009 
p_Vid
->
p_cuº_‰m_°ru˘
->
qp
 =Ö_Vid->q∞
	`iClù3
–-p_Vid->
bôdïth_luma_qp_sˇÀ
, 
MAX_QP
,Ö_Vid->q∞+ 
p_I≈
->
qp2off
[
p_cur_‰m
->
ty≥
] );

2020 
	`öô_mb_löe_öåa_up
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

2022 
FømeUnôSåu˘
 *
p_cur_‰m
 = 
p_Vid
->
p_cuº_‰m_°ru˘
;

2024 i‡(
p_cur_‰m
->
œyî
 == 0)

2026 
p_Vid
->
mb_y_öåa
 =Ö_Vid->
mb_y_upd
;

2028 i‡(
p_I≈
->
öåa_upd
 > 0)

2030 
p_Vid
->
mb_y_upd
 = (p_Vid->
cuº_‰m_idx
 / 
p_I≈
->
öåa_upd
Ë% (p_Vid->
width
 / 
MB_BLOCK_SIZE
);

2041 
	`öô_‰ame
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

2043 
i
, 
j
;

2045 
p_Vid
->
cuºít_mb_ƒ
 = 0;

2046 
p_Vid
->
cuºít_¶i˚_ƒ
 = 0;

2047 
p_Vid
->
p_Sèts
->
bô_¶i˚
 = 0;

2052 if–(
p_I≈
->
£∑øã_cﬁour_∂™e_Êag
 != 0) )

2054  
j
 = 0; j < 
MAX_PLANE
; j++ ){

2055 
i
 = 0; i < ((Ë(
p_Vid
->
FømeSizeInMbs
));i++)

2056 
p_Vid
->
mb_d©a_JV
[
j
][
i
].
¶i˚_ƒ
 = -1;

2061 
i
 = 0; i < ((Ë(
p_Vid
->
FømeSizeInMbs
)); i++)

2062 
p_Vid
->
mb_d©a
[
i
].
¶i˚_ƒ
 = -1;

2065 i‡–!(
p_I≈
->
RCE«bÀ
) )

2067 
	`öô_fixed_qp
(
p_Vid
, 
p_I≈
);

2069 
	`öô_mb_löe_öåa_up
(
p_Vid
, 
p_I≈
);

2071 
p_Vid
->
no_ouçut_of_¥i‹_pics_Êag
 = 0;

2072 
p_Vid
->
l⁄g_ãrm_ª„ªn˚_Êag
 = 
FALSE
;

2074 
	`öô_dec_ªf_pic_m¨kög_buf„r
(
p_Vid
);

2076 if(
p_I≈
->
WPIãrMC
)

2077 
p_Vid
->
‰ameOff£tAvaû
 = 0;

2081 
p_Vid
->
dúe˘_•©ül_mv_¥ed_Êag
 = (Ë
p_I≈
->direct_spatial_mv_pred_flag;

2082 #i‡(
MVC_EXTENSION_ENABLE
)

2083 i‡–(
p_I≈
->
num_of_võws
 =1Ë|| (
p_Vid
->
võw_id
 == 0) )

2086 
p_Vid
->
DFDißbÀIdc
 = (Ë
p_I≈
->DFDißbÀIdc[p_Vid->
«l_ª„ªn˚_idc
 > 0][p_Vid->
ty≥
];

2087 
p_Vid
->
DFAÕhaC0Off£t
 = (Ë
p_I≈
->
DFAÕha
 [p_Vid->
«l_ª„ªn˚_idc
 > 0][p_Vid->
ty≥
];

2088 
p_Vid
->
DFBëaOff£t
 = (Ë
p_I≈
->
DFBëa
 [p_Vid->
«l_ª„ªn˚_idc
 > 0][p_Vid->
ty≥
];

2090 #i‡(
MVC_EXTENSION_ENABLE
)

2093 
p_Vid
->
DFDißbÀIdc
 = (Ë
p_I≈
->
EnhLayîDFDißbÀIdc
[p_Vid->
«l_ª„ªn˚_idc
 > 0][p_Vid->
ty≥
];

2094 
p_Vid
->
DFAÕhaC0Off£t
 = (Ë
p_I≈
->
EnhLayîDFAÕha
 [p_Vid->
«l_ª„ªn˚_idc
 > 0][p_Vid->
ty≥
];

2095 
p_Vid
->
DFBëaOff£t
 = (Ë
p_I≈
->
EnhLayîDFBëa
 [p_Vid->
«l_ª„ªn˚_idc
 > 0][p_Vid->
ty≥
];

2098 
p_Vid
->
Ad≠tiveRoundög
 = 
p_I≈
->AdaptiveRounding;

2107 
	`öô_fõld
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

2109 
FømeUnôSåu˘
 *
p_cur_‰m
 = 
p_Vid
->
p_cuº_‰m_°ru˘
;

2111 
p_Vid
->
cuºít_mb_ƒ
 = 0;

2112 
p_Vid
->
cuºít_¶i˚_ƒ
 = 0;

2113 
p_Vid
->
p_Sèts
->
bô_¶i˚
 = 0;

2115 i‡(!
p_cur_‰m
->
œyî
)

2117 if(!
p_I≈
->
RCE«bÀ
)

2119 
p_Vid
->
qp
 = 
p_cur_‰m
->qp;

2120 i‡(
p_Vid
->
ty≥
 =
SP_SLICE
 ||Ö_Vid->ty≥ =
SI_SLICE
)

2122 
p_Vid
->
qp•
 = 
p_I≈
->qpsp;

2125 
	`öô_mb_löe_öåa_up
–
p_Vid
, 
p_I≈
 );

2129 if(!
p_I≈
->
RCE«bÀ
)

2131 
p_Vid
->
qp
 = 
p_cur_‰m
->qp;

2148 
	`UnifõdO√F‹thPix
 ( 
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
s
)

2150 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

2151 if(
s
->
bI¡îpﬁ©ed
)

2153 
s
->
bI¡îpﬁ©ed
 = 1;

2155 
s
->
p_img_sub
[0] = s->
imgY_sub
;

2156 
s
->
p_cuº_img_sub
 = s->
imgY_sub
;

2157 
s
->
p_cuº_img
 = s->
imgY
;

2162 i‡–(!
p_I≈
->
OnTheFlyFø˘MCP
Ë|| (p_I≈->OnTheFlyFø˘MCP==
OTF_L1
) )

2164 
	`gëSubImagesLuma
 ( 
p_Vid
, 
s
 );

2166 i‡–((
p_Vid
->
yuv_f‹m©
 !
YUV400
Ë&& (
p_I≈
->
ChromaMCBuf„r
)Ë||Ö_Vid->
P444_joöed
 )

2168 i‡(
p_Vid
->
P444_joöed
)

2170 
img≥l
 **** 
p_cuº_img_sub
 = 
s
->p_curr_img_sub;

2171 
img≥l
 ** 
p_cuº_img
 = 
s
->p_curr_img;

2173 
	`£À˘_∂™e
(
p_Vid
, 
PLANE_U
);

2174 
s
->
p_cuº_img_sub
 = s->
imgUV_sub
[0];

2175 
s
->
p_cuº_img
 = s->
imgUV
[0];

2176 
	`gëSubImagesLuma
 (
p_Vid
, 
s
);

2178 
	`£À˘_∂™e
(
p_Vid
, 
PLANE_V
);

2179 
s
->
p_cuº_img_sub
 = s->
imgUV_sub
[1];

2180 
s
->
p_cuº_img
 = s->
imgUV
[1];

2181 
	`gëSubImagesLuma
 (
p_Vid
, 
s
);

2183 
	`£À˘_∂™e
(
p_Vid
, 
PLANE_Y
);

2184 
s
->
p_cuº_img_sub
 =Ö_curr_img_sub;

2185 
s
->
p_cuº_img
 =Ö_curr_img;

2189 
	`gëSubImagesChroma
–
p_Vid
, 
s
 );

2196 
	`OtfCom∑tibûôy_c›yWôhPaddög
–
s
->
imgY
, s->imgY, s->
size_x
, s->
size_y
, 
IMG_PAD_SIZE_X
, 
IMG_PAD_SIZE_Y
 ) ;

2197 
	`OtfCom∑tibûôy_c›yWôhPaddög
–
s
->
imgUV
[0], s->imgUV[0], s->
size_x_¸
, s->
size_y_¸
, 
p_Vid
->
∑d_size_uv_x
,p_Vid->
∑d_size_uv_y
 ) ;

2198 
	`OtfCom∑tibûôy_c›yWôhPaddög
–
s
->
imgUV
[1], s->imgUV[1], s->
size_x_¸
, s->
size_y_¸
, 
p_Vid
->
∑d_size_uv_x
,Ö_Vid->
∑d_size_uv_y
 ) ;

2212 
	`UnifõdO√F‹thPix_JV
 (
VideoP¨amëîs
 *
p_Vid
, 
≈œ√
, 
St‹abÀPi˘uª
 *
s
)

2214 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

2216 if–
≈œ√
 == 0 )

2218 if(
s
->
bI¡îpﬁ©ed
)

2220 
s
->
bI¡îpﬁ©ed
 = 1;

2221 
s
->
p_img
[0] = s->
imgY
;

2222 
s
->
p_img
[1] = s->
imgUV
[0];

2223 
s
->
p_img
[2] = s->
imgUV
[1];

2225 i‡–(!
p_I≈
->
OnTheFlyFø˘MCP
Ë|| (p_I≈->OnTheFlyFø˘MCP==
OTF_L1
) )

2227 
s
->
p_img_sub
[0] = s->
imgY_sub
;

2228 
s
->
p_img_sub
[1] = s->
imgUV_sub
[0];

2229 
s
->
p_img_sub
[2] = s->
imgUV_sub
[1];

2234 
s
->
cﬁour_∂™e_id
 = 
≈œ√
;

2235 
s
->
p_cuº_img
 = s->
p_img
[
≈œ√
];

2236 
s
->
p_cuº_img_sub
 = s->
p_img_sub
[
≈œ√
];

2238 if–(!
p_I≈
->
OnTheFlyFø˘MCP
Ë|| (p_I≈->OnTheFlyFø˘MCP==
OTF_L1
) )

2240 
	`gëSubImagesLuma
 ( 
p_Vid
, 
s
 );

2245 
	`OtfCom∑tibûôy_c›yWôhPaddög
–
s
->
p_img
[
≈œ√
], s->p_img[≈œ√], s->
size_x
, s->
size_y
, 
IMG_PAD_SIZE_X
, 
IMG_PAD_SIZE_Y
 ) ;

2255 
Boﬁón
 
	`dummy_¶i˚_too_big
 (
bôs_¶i˚
)

2257  
FALSE
;

2260 
	`Rï‹tSim∂e
(
VideoP¨amëîs
 *
p_Vid
, *
pic_ty≥
, 
cur_bôs
, 
Di°Mëric
 *
mëric
, 
tmp_time
)

2262 #i‡(
MVC_EXTENSION_ENABLE
)

2263 i‡–
p_Vid
->
p_I≈
->
num_of_võws
 == 2 )

2265 i‡–
p_Vid
->
Êd_Êag
 &&Ö_Vid->
võw_id
 == 0 )

2267 
p_Vid
->
¥ev_cs
.
‰m_no_ö_fûe
 =Ö_Vid->frm_no_in_file;

2268 
p_Vid
->
¥ev_cs
.
võw_id
 =Ö_Vid->view_id;

2269 
p_Vid
->
¥ev_cs
.
cur_bôs
 = cur_bits;

2270 
	`°r˝y
–
p_Vid
->
¥ev_cs
.
pic_ty≥
,Öic_type );

2271 
p_Vid
->
¥ev_cs
.
AvîageFømeQP
 =Ö_Vid->AverageFrameQP;

2272 
p_Vid
->
¥ev_cs
.
œmbda
 = 0;

2273 
p_Vid
->
¥ev_cs
.
p¢r_vÆue
[0] = 
mëric
->
vÆue
[0];

2274 
p_Vid
->
¥ev_cs
.
p¢r_vÆue
[1] = 
mëric
->
vÆue
[1];

2275 
p_Vid
->
¥ev_cs
.
p¢r_vÆue
[2] = 
mëric
->
vÆue
[2];

2276 
p_Vid
->
¥ev_cs
.
ssim_vÆue
[0] = 0;

2277 
p_Vid
->
¥ev_cs
.
ssim_vÆue
[1] = 0;

2278 
p_Vid
->
¥ev_cs
.
ssim_vÆue
[2] = 0;

2279 
p_Vid
->
¥ev_cs
.
tmp_time
 =Åmp_time;

2280 
p_Vid
->
¥ev_cs
.
me_time
 = ()p_Vid->me_time;

2281 
p_Vid
->
¥ev_cs
.
Êd_Êag
 =Ö_Vid->fld_flag;

2282 
p_Vid
->
¥ev_cs
.
öåas
 =Ö_Vid->intras;

2283 
p_Vid
->
¥ev_cs
.
dúe˘_mode
 = 0;

2284 
p_Vid
->
¥ev_cs
.
num_ªf_idx_l0_a˘ive
 =Ö_Vid->num_ref_idx_l0_active;

2285 
p_Vid
->
¥ev_cs
.
num_ªf_idx_l1_a˘ive
 =Ö_Vid->num_ref_idx_l1_active;

2286 
p_Vid
->
¥ev_cs
.
rd_∑ss
 =Ö_Vid->rd_pass;

2287 
p_Vid
->
¥ev_cs
.
«l_ª„ªn˚_idc
 =Ö_Vid->nal_reference_idc;

2289 i‡–
p_Vid
->
Êd_Êag
 &&Ö_Vid->
võw_id
 == 1 )

2291 
	`¥ötf
 ("%05d(%3s) %1d %8d %2d %7.3f %7.3f %7.3f %9d %7d %3s %d\n",

2292 
p_Vid
->
¥ev_cs
.
‰m_no_ö_fûe
,Ö_Vid->¥ev_cs.
pic_ty≥
,Ö_Vid->¥ev_cs.
võw_id
,

2293 ()(
p_Vid
->
p_Sèts
->
bô_˘r_v
[0] -Ö_Vid->p_Sèts->
bô_˘r_n_v
[0]Ë+ ()’_Vid->p_Sèts->
bô_˘r_fûÀr_d©a_v
[0] -Ö_Vid->p_Sèts->
bô_˘r_fûÀr_d©a_n_v
[0]),

2294 
p_Vid
->
¥ev_cs
.
AvîageFømeQP
,

2295 
p_Vid
->
¥ev_cs
.
p¢r_vÆue
[0],Ö_Vid->prev_cs.psnr_value[1],Ö_Vid->prev_cs.psnr_value[2],

2296 
p_Vid
->
¥ev_cs
.
tmp_time
, (Ëp_Vid->¥ev_cs.
me_time
,

2297 
p_Vid
->
¥ev_cs
.
Êd_Êag
 ? "FLD" : "FRM",

2298 
p_Vid
->
¥ev_cs
.
«l_ª„ªn˚_idc
);

2299 
	`¥ötf
 ("%05d(%3s) %1d %8d %2d %7.3f %7.3f %7.3f %9d %7d %3s %d\n",

2300 
p_Vid
->
‰m_no_ö_fûe
, 
pic_ty≥
,Ö_Vid->
võw_id
,

2301 ()(
p_Vid
->
p_Sèts
->
bô_˘r_v
[1] -Ö_Vid->p_Sèts->
bô_˘r_n_v
[1]Ë+ ()’_Vid->p_Sèts->
bô_˘r_fûÀr_d©a_v
[1] -Ö_Vid->p_Sèts->
bô_˘r_fûÀr_d©a_n_v
[1]),

2302 
p_Vid
->
AvîageFømeQP
,

2303 
mëric
->
vÆue
[0], metric->value[1], metric->value[2],

2304 
tmp_time
, (Ë
p_Vid
->
me_time
,

2305 
p_Vid
->
Êd_Êag
 ? "FLD" : "FRM",

2306 
p_Vid
->
«l_ª„ªn˚_idc
);

2310 
	`¥ötf
 ("%05d(%3s) %1d %8d %2d %7.3f %7.3f %7.3f %9d %7d %3s %d\n",

2311 
p_Vid
->
‰m_no_ö_fûe
, 
pic_ty≥
,Ö_Vid->
võw_id
, 
cur_bôs
,

2312 
p_Vid
->
AvîageFømeQP
,

2313 
mëric
->
vÆue
[0], metric->value[1], metric->value[2],

2314 
tmp_time
, (Ë
p_Vid
->
me_time
,

2315 
p_Vid
->
Êd_Êag
 ? "FLD" : "FRM",

2316 
p_Vid
->
«l_ª„ªn˚_idc
);

2321 
	`¥ötf
 ("%05d(%3s)%8d %2d %7.3f %7.3f %7.3f %9d %7d %3s %d\n",

2322 
p_Vid
->
‰m_no_ö_fûe
, 
pic_ty≥
, 
cur_bôs
,

2323 
p_Vid
->
AvîageFømeQP
,

2324 
mëric
->
vÆue
[0], metric->value[1], metric->value[2],

2325 
tmp_time
, (Ë
p_Vid
->
me_time
,

2326 
p_Vid
->
Êd_Êag
 ? "FLD" : "FRM",

2327 
p_Vid
->
«l_ª„ªn˚_idc
);

2330 
	`Rï‹tVîbo£
(
VideoP¨amëîs
 *
p_Vid
, *
pic_ty≥
, 
cur_bôs
, 
wp_mëhod
, 
œmbda
, 
Di°Mëric
 *
mPSNR
, 
tmp_time
, 
dúe˘_mode
)

2332 #i‡(
MVC_EXTENSION_ENABLE
)

2333 i‡–
p_Vid
->
p_I≈
->
num_of_võws
 == 2 )

2335 i‡–
p_Vid
->
Êd_Êag
 &&Ö_Vid->
võw_id
 == 0 )

2337 
p_Vid
->
¥ev_cs
.
‰m_no_ö_fûe
 =Ö_Vid->frm_no_in_file;

2338 
p_Vid
->
¥ev_cs
.
võw_id
 =Ö_Vid->view_id;

2339 
p_Vid
->
¥ev_cs
.
cur_bôs
 = cur_bits;

2340 
	`°r˝y
–
p_Vid
->
¥ev_cs
.
pic_ty≥
,Öic_type );

2341 
p_Vid
->
¥ev_cs
.
AvîageFømeQP
 =Ö_Vid->AverageFrameQP;

2342 
p_Vid
->
¥ev_cs
.
œmbda
 = 0;

2343 
p_Vid
->
¥ev_cs
.
p¢r_vÆue
[0] = 
mPSNR
->
vÆue
[0];

2344 
p_Vid
->
¥ev_cs
.
p¢r_vÆue
[1] = 
mPSNR
->
vÆue
[1];

2345 
p_Vid
->
¥ev_cs
.
p¢r_vÆue
[2] = 
mPSNR
->
vÆue
[2];

2346 
p_Vid
->
¥ev_cs
.
ssim_vÆue
[0] = 0;

2347 
p_Vid
->
¥ev_cs
.
ssim_vÆue
[1] = 0;

2348 
p_Vid
->
¥ev_cs
.
ssim_vÆue
[2] = 0;

2349 
p_Vid
->
¥ev_cs
.
tmp_time
 =Åmp_time;

2350 
p_Vid
->
¥ev_cs
.
me_time
 = ()p_Vid->me_time;

2351 
p_Vid
->
¥ev_cs
.
Êd_Êag
 =Ö_Vid->fld_flag;

2352 
p_Vid
->
¥ev_cs
.
öåas
 =Ö_Vid->intras;

2353 
p_Vid
->
¥ev_cs
.
dúe˘_mode
 = direct_mode;

2354 
p_Vid
->
¥ev_cs
.
num_ªf_idx_l0_a˘ive
 =Ö_Vid->num_ref_idx_l0_active;

2355 
p_Vid
->
¥ev_cs
.
num_ªf_idx_l1_a˘ive
 =Ö_Vid->num_ref_idx_l1_active;

2356 
p_Vid
->
¥ev_cs
.
rd_∑ss
 =Ö_Vid->rd_pass;

2357 
p_Vid
->
¥ev_cs
.
«l_ª„ªn˚_idc
 =Ö_Vid->nal_reference_idc;

2359 i‡–
p_Vid
->
Êd_Êag
 &&Ö_Vid->
võw_id
 == 1 )

2361 
	`¥ötf
 ("%05d(%3s) %1d %8d %1d %2d %4d %7.3f %7.3f %7.3f %9d %7d %3s %5d %1d %2d %2d %d %d\n",

2362 
p_Vid
->
¥ev_cs
.
‰m_no_ö_fûe
,Ö_Vid->¥ev_cs.
pic_ty≥
,Ö_Vid->¥ev_cs.
võw_id
,

2363 ()(
p_Vid
->
p_Sèts
->
bô_˘r_v
[0] -Ö_Vid->p_Sèts->
bô_˘r_n_v
[0]Ë+ ()’_Vid->p_Sèts->
bô_˘r_fûÀr_d©a_v
[0] -Ö_Vid->p_Sèts->
bô_˘r_fûÀr_d©a_n_v
[0]),

2364 
p_Vid
->
¥ev_cs
.
wp_mëhod
,Ö_Vid->¥ev_cs.
AvîageFømeQP
,Ö_Vid->¥ev_cs.
œmbda
,

2365 
p_Vid
->
¥ev_cs
.
p¢r_vÆue
[0],Ö_Vid->prev_cs.psnr_value[1],Ö_Vid->prev_cs.psnr_value[2],

2366 
p_Vid
->
¥ev_cs
.
tmp_time
, (Ëp_Vid->¥ev_cs.
me_time
,

2367 
p_Vid
->
¥ev_cs
.
Êd_Êag
 ? "FLD" : "FRM",Ö_Vid->¥ev_cs.
öåas
,Ö_Vid->¥ev_cs.
dúe˘_mode
,

2368 
p_Vid
->
¥ev_cs
.
num_ªf_idx_l0_a˘ive
,Ö_Vid->¥ev_cs.
num_ªf_idx_l1_a˘ive
,Ö_Vid->¥ev_cs.
rd_∑ss
,Ö_Vid->¥ev_cs.
«l_ª„ªn˚_idc
);

2369 
	`¥ötf
 ("%05d(%3s) %1d %8d %1d %2d %4d %7.3f %7.3f %7.3f %9d %7d %3s %5d %1d %2d %2d %d %d\n",

2370 
p_Vid
->
‰m_no_ö_fûe
, 
pic_ty≥
,Ö_Vid->
võw_id
,

2371 ()(
p_Vid
->
p_Sèts
->
bô_˘r_v
[1] -Ö_Vid->p_Sèts->
bô_˘r_n_v
[1]Ë+ ()’_Vid->p_Sèts->
bô_˘r_fûÀr_d©a_v
[1] -Ö_Vid->p_Sèts->
bô_˘r_fûÀr_d©a_n_v
[1]), 
wp_mëhod
,

2372 
p_Vid
->
AvîageFømeQP
, 
œmbda
,

2373 
mPSNR
->
vÆue
[0], mPSNR->value[1], mPSNR->value[2],

2374 
tmp_time
, (Ë
p_Vid
->
me_time
,

2375 
p_Vid
->
Êd_Êag
 ? "FLD" : "FRM",Ö_Vid->
öåas
, 
dúe˘_mode
,

2376 
p_Vid
->
num_ªf_idx_l0_a˘ive
,Ö_Vid->
num_ªf_idx_l1_a˘ive
,Ö_Vid->
rd_∑ss
,Ö_Vid->
«l_ª„ªn˚_idc
);

2380 
	`¥ötf
 ("%05d(%3s) %1d %8d %1d %2d %4d %7.3f %7.3f %7.3f %9d %7d %3s %5d %1d %2d %2d %d %d\n",

2381 
p_Vid
->
‰m_no_ö_fûe
, 
pic_ty≥
,Ö_Vid->
võw_id
, 
cur_bôs
, 
wp_mëhod
,

2382 
p_Vid
->
AvîageFømeQP
, 
œmbda
,

2383 
mPSNR
->
vÆue
[0], mPSNR->value[1], mPSNR->value[2],

2384 
tmp_time
, (Ë
p_Vid
->
me_time
,

2385 
p_Vid
->
Êd_Êag
 ? "FLD" : "FRM",Ö_Vid->
öåas
, 
dúe˘_mode
,

2386 
p_Vid
->
num_ªf_idx_l0_a˘ive
,Ö_Vid->
num_ªf_idx_l1_a˘ive
,Ö_Vid->
rd_∑ss
,Ö_Vid->
«l_ª„ªn˚_idc
);

2392 
	`¥ötf
 ("%05d(%3s)%8d %1d %2d %4d %7.3f %7.3f %7.3f %9d %7d %3s %5d %1d %2d %2d %d %d\n",

2393 
p_Vid
->
‰m_no_ö_fûe
, 
pic_ty≥
, 
cur_bôs
, 
wp_mëhod
,

2394 
p_Vid
->
AvîageFømeQP
, 
œmbda
,

2395 
mPSNR
->
vÆue
[0], mPSNR->value[1], mPSNR->value[2],

2396 
tmp_time
, (Ë
p_Vid
->
me_time
,

2397 
p_Vid
->
Êd_Êag
 ? "FLD" : "FRM",Ö_Vid->
öåas
, 
dúe˘_mode
,

2398 
p_Vid
->
num_ªf_idx_l0_a˘ive
,Ö_Vid->
num_ªf_idx_l1_a˘ive
,Ö_Vid->
rd_∑ss
,Ö_Vid->
«l_ª„ªn˚_idc
);

2402 
	`Rï‹tVîbo£NVB
(
VideoP¨amëîs
 *
p_Vid
, *
pic_ty≥
, 
cur_bôs
, 
nvb_bôs
, 
wp_mëhod
, 
œmbda
, 
Di°Mëric
 *
mPSNR
, 
tmp_time
, 
dúe˘_mode
)

2404 #i‡(
MVC_EXTENSION_ENABLE
)

2405 i‡–
p_Vid
->
num_of_œyîs
 == 2 )

2407 i‡–
p_Vid
->
Êd_Êag
 &&Ö_Vid->
võw_id
 == 0 )

2409 
p_Vid
->
¥ev_cs
.
‰m_no_ö_fûe
 =Ö_Vid->frm_no_in_file;

2410 
p_Vid
->
¥ev_cs
.
võw_id
 =Ö_Vid->view_id;

2411 
p_Vid
->
¥ev_cs
.
cur_bôs
 = cur_bits;

2412 
	`°r˝y
–
p_Vid
->
¥ev_cs
.
pic_ty≥
,Öic_type );

2413 
p_Vid
->
¥ev_cs
.
AvîageFømeQP
 =Ö_Vid->AverageFrameQP;

2414 
p_Vid
->
¥ev_cs
.
œmbda
 = 0;

2415 
p_Vid
->
¥ev_cs
.
p¢r_vÆue
[0] = 
mPSNR
->
vÆue
[0];

2416 
p_Vid
->
¥ev_cs
.
p¢r_vÆue
[1] = 
mPSNR
->
vÆue
[1];

2417 
p_Vid
->
¥ev_cs
.
p¢r_vÆue
[2] = 
mPSNR
->
vÆue
[2];

2418 
p_Vid
->
¥ev_cs
.
ssim_vÆue
[0] = 0;

2419 
p_Vid
->
¥ev_cs
.
ssim_vÆue
[1] = 0;

2420 
p_Vid
->
¥ev_cs
.
ssim_vÆue
[2] = 0;

2421 
p_Vid
->
¥ev_cs
.
tmp_time
 =Åmp_time;

2422 
p_Vid
->
¥ev_cs
.
me_time
 = ()p_Vid->me_time;

2423 
p_Vid
->
¥ev_cs
.
Êd_Êag
 =Ö_Vid->fld_flag;

2424 
p_Vid
->
¥ev_cs
.
öåas
 =Ö_Vid->intras;

2425 
p_Vid
->
¥ev_cs
.
dúe˘_mode
 = direct_mode;

2426 
p_Vid
->
¥ev_cs
.
num_ªf_idx_l0_a˘ive
 =Ö_Vid->num_ref_idx_l0_active;

2427 
p_Vid
->
¥ev_cs
.
num_ªf_idx_l1_a˘ive
 =Ö_Vid->num_ref_idx_l1_active;

2428 
p_Vid
->
¥ev_cs
.
rd_∑ss
 =Ö_Vid->rd_pass;

2429 
p_Vid
->
¥ev_cs
.
«l_ª„ªn˚_idc
 =Ö_Vid->nal_reference_idc;

2431 i‡–
p_Vid
->
Êd_Êag
 &&Ö_Vid->
võw_id
 == 1 )

2433 
	`¥ötf
 ("%05d(%3s) %1d %8d %3d %1d %2d %4d %7.3f %7.3f %7.3f %9d %7d %3s %5d %1d %2d %2d %d %d\n",

2434 
p_Vid
->
¥ev_cs
.
‰m_no_ö_fûe
,Ö_Vid->¥ev_cs.
pic_ty≥
,Ö_Vid->¥ev_cs.
võw_id
,

2435 ()(
p_Vid
->
p_Sèts
->
bô_˘r_v
[0] -Ö_Vid->p_Sèts->
bô_˘r_n_v
[0])

2436 + ()(
p_Vid
->
p_Sèts
->
bô_˘r_fûÀr_d©a_v
[0] -Ö_Vid->p_Sèts->
bô_˘r_fûÀr_d©a_n_v
[0]Ë+Ö_Vid->p_Sèts->
bô_˘r_∑ømëî£ts_n_v
[0],

2437 
p_Vid
->
p_Sèts
->
bô_˘r_∑ømëî£ts_n_v
[0],Ö_Vid->
¥ev_cs
.
wp_mëhod
,Ö_Vid->¥ev_cs.
AvîageFømeQP
,Ö_Vid->¥ev_cs.
œmbda
,

2438 
p_Vid
->
¥ev_cs
.
p¢r_vÆue
[0],Ö_Vid->prev_cs.psnr_value[1],Ö_Vid->prev_cs.psnr_value[2],

2439 
p_Vid
->
¥ev_cs
.
tmp_time
, (Ëp_Vid->¥ev_cs.
me_time
,

2440 
p_Vid
->
¥ev_cs
.
Êd_Êag
 ? "FLD" : "FRM",Ö_Vid->¥ev_cs.
öåas
,Ö_Vid->¥ev_cs.
dúe˘_mode
,

2441 
p_Vid
->
¥ev_cs
.
num_ªf_idx_l0_a˘ive
,Ö_Vid->¥ev_cs.
num_ªf_idx_l1_a˘ive
,Ö_Vid->¥ev_cs.
rd_∑ss
,Ö_Vid->¥ev_cs.
«l_ª„ªn˚_idc
);

2442 
	`¥ötf
 ("%05d(%3s) %1d %8d %3d %1d %2d %4d %7.3f %7.3f %7.3f %9d %7d %3s %5d %1d %2d %2d %d %d\n",

2443 
p_Vid
->
‰m_no_ö_fûe
, 
pic_ty≥
,Ö_Vid->
võw_id
,

2444 ()(
p_Vid
->
p_Sèts
->
bô_˘r_v
[1] -Ö_Vid->p_Sèts->
bô_˘r_n_v
[1])

2445 + ()(
p_Vid
->
p_Sèts
->
bô_˘r_fûÀr_d©a_v
[1] -Ö_Vid->p_Sèts->
bô_˘r_fûÀr_d©a_n_v
[1]Ë+Ö_Vid->p_Sèts->
bô_˘r_∑ømëî£ts_n_v
[1],

2446 
p_Vid
->
p_Sèts
->
bô_˘r_∑ømëî£ts_n_v
[1], 
wp_mëhod
,

2447 
p_Vid
->
AvîageFømeQP
, 
œmbda
,

2448 
mPSNR
->
vÆue
[0], mPSNR->value[1], mPSNR->value[2],

2449 
tmp_time
, (Ë
p_Vid
->
me_time
,

2450 
p_Vid
->
Êd_Êag
 ? "FLD" : "FRM",Ö_Vid->
öåas
, 
dúe˘_mode
,

2451 
p_Vid
->
num_ªf_idx_l0_a˘ive
,Ö_Vid->
num_ªf_idx_l1_a˘ive
,Ö_Vid->
rd_∑ss
,Ö_Vid->
«l_ª„ªn˚_idc
);

2455 
	`¥ötf
 ("%05d(%3s) %1d %8d %3d %1d %2d %4d %7.3f %7.3f %7.3f %9d %7d %3s %5d %1d %2d %2d %d %d %d\n",

2456 
p_Vid
->
‰m_no_ö_fûe
, 
pic_ty≥
,Ö_Vid->
võw_id
, 
cur_bôs
, 
nvb_bôs
, 
wp_mëhod
,

2457 
p_Vid
->
AvîageFømeQP
, 
œmbda
,

2458 
mPSNR
->
vÆue
[0], mPSNR->value[1], mPSNR->value[2],

2459 
tmp_time
, (Ë
p_Vid
->
me_time
,

2460 
p_Vid
->
Êd_Êag
 ? "FLD" : "FRM",Ö_Vid->
öåas
, 
dúe˘_mode
,

2461 
p_Vid
->
num_ªf_idx_l0_a˘ive
,Ö_Vid->
num_ªf_idx_l1_a˘ive
,Ö_Vid->
rd_∑ss
,Ö_Vid->
«l_ª„ªn˚_idc
,Ö_Vid->
iI¡îVõwMBs
);

2467 
	`¥ötf
 ("%05d(%3s)%8d %3d %1d %2d %4d %7.3f %7.3f %7.3f %9d %7d %3s %5d %1d %2d %2d %d %d\n",

2468 
p_Vid
->
‰m_no_ö_fûe
, 
pic_ty≥
, 
cur_bôs
, 
nvb_bôs
, 
wp_mëhod
,

2469 
p_Vid
->
AvîageFømeQP
, 
œmbda
,

2470 
mPSNR
->
vÆue
[0], mPSNR->value[1], mPSNR->value[2],

2471 
tmp_time
, (Ë
p_Vid
->
me_time
,

2472 
p_Vid
->
Êd_Êag
 ? "FLD" : "FRM",Ö_Vid->
öåas
, 
dúe˘_mode
,

2473 
p_Vid
->
num_ªf_idx_l0_a˘ive
,Ö_Vid->
num_ªf_idx_l1_a˘ive
,Ö_Vid->
rd_∑ss
,Ö_Vid->
«l_ª„ªn˚_idc
);

2478 
	`Rï‹tVîbo£FDN
(
VideoP¨amëîs
 *
p_Vid
, *
pic_ty≥
, 
cur_bôs
, 
fdn_bôs
, 
nvb_bôs
, 
wp_mëhod
, 
œmbda
, 
Di°Mëric
 *
mPSNR
, 
tmp_time
, 
dúe˘_mode
)

2480 #i‡(
MVC_EXTENSION_ENABLE
)

2481 i‡–
p_Vid
->
p_I≈
->
num_of_võws
 == 2 )

2483 i‡–
p_Vid
->
Êd_Êag
 &&Ö_Vid->
võw_id
 == 0 )

2485 
p_Vid
->
¥ev_cs
.
‰m_no_ö_fûe
 =Ö_Vid->frm_no_in_file;

2486 
p_Vid
->
¥ev_cs
.
võw_id
 =Ö_Vid->view_id;

2487 
p_Vid
->
¥ev_cs
.
cur_bôs
 = cur_bits;

2488 
	`°r˝y
–
p_Vid
->
¥ev_cs
.
pic_ty≥
,Öic_type );

2489 
p_Vid
->
¥ev_cs
.
AvîageFømeQP
 =Ö_Vid->AverageFrameQP;

2490 
p_Vid
->
¥ev_cs
.
œmbda
 = 0;

2491 
p_Vid
->
¥ev_cs
.
p¢r_vÆue
[0] = 
mPSNR
->
vÆue
[0];

2492 
p_Vid
->
¥ev_cs
.
p¢r_vÆue
[1] = 
mPSNR
->
vÆue
[1];

2493 
p_Vid
->
¥ev_cs
.
p¢r_vÆue
[2] = 
mPSNR
->
vÆue
[2];

2494 
p_Vid
->
¥ev_cs
.
ssim_vÆue
[0] = 0;

2495 
p_Vid
->
¥ev_cs
.
ssim_vÆue
[1] = 0;

2496 
p_Vid
->
¥ev_cs
.
ssim_vÆue
[2] = 0;

2497 
p_Vid
->
¥ev_cs
.
tmp_time
 =Åmp_time;

2498 
p_Vid
->
¥ev_cs
.
me_time
 = ()p_Vid->me_time;

2499 
p_Vid
->
¥ev_cs
.
Êd_Êag
 =Ö_Vid->fld_flag;

2500 
p_Vid
->
¥ev_cs
.
öåas
 =Ö_Vid->intras;

2501 
p_Vid
->
¥ev_cs
.
dúe˘_mode
 = direct_mode;

2502 
p_Vid
->
¥ev_cs
.
num_ªf_idx_l0_a˘ive
 =Ö_Vid->num_ref_idx_l0_active;

2503 
p_Vid
->
¥ev_cs
.
num_ªf_idx_l1_a˘ive
 =Ö_Vid->num_ref_idx_l1_active;

2504 
p_Vid
->
¥ev_cs
.
rd_∑ss
 =Ö_Vid->rd_pass;

2505 
p_Vid
->
¥ev_cs
.
«l_ª„ªn˚_idc
 =Ö_Vid->nal_reference_idc;

2507 i‡–
p_Vid
->
Êd_Êag
 &&Ö_Vid->
võw_id
 == 1 )

2509 
	`¥ötf
 ("%05d(%3s) %1d %8d %8d %3d %1d %2d %4d %7.3f %7.3f %7.3f %9d %7d %3s %5d %1d %2d %2d %d %d\n",

2510 
p_Vid
->
¥ev_cs
.
‰m_no_ö_fûe
,Ö_Vid->¥ev_cs.
pic_ty≥
,Ö_Vid->¥ev_cs.
võw_id
,

2511 ()(
p_Vid
->
p_Sèts
->
bô_˘r_v
[0] -Ö_Vid->p_Sèts->
bô_˘r_n_v
[0])

2512 + ()(
p_Vid
->
p_Sèts
->
bô_˘r_fûÀr_d©a_v
[0] -Ö_Vid->p_Sèts->
bô_˘r_fûÀr_d©a_n_v
[0]Ë+Ö_Vid->p_Sèts->
bô_˘r_∑ømëî£ts_n_v
[0],

2513 ()(
p_Vid
->
p_Sèts
->
bô_˘r_fûÀr_d©a_v
[0] -Ö_Vid->p_Sèts->
bô_˘r_fûÀr_d©a_n_v
[0]),

2514 
p_Vid
->
p_Sèts
->
bô_˘r_∑ømëî£ts_n_v
[0],

2515 
p_Vid
->
¥ev_cs
.
wp_mëhod
,Ö_Vid->¥ev_cs.
AvîageFømeQP
,Ö_Vid->¥ev_cs.
œmbda
,

2516 
p_Vid
->
¥ev_cs
.
p¢r_vÆue
[0],Ö_Vid->prev_cs.psnr_value[1],Ö_Vid->prev_cs.psnr_value[2],

2517 
p_Vid
->
¥ev_cs
.
tmp_time
, (Ëp_Vid->¥ev_cs.
me_time
,

2518 
p_Vid
->
¥ev_cs
.
Êd_Êag
 ? "FLD" : "FRM",Ö_Vid->¥ev_cs.
öåas
,Ö_Vid->¥ev_cs.
dúe˘_mode
,

2519 
p_Vid
->
¥ev_cs
.
num_ªf_idx_l0_a˘ive
,Ö_Vid->¥ev_cs.
num_ªf_idx_l1_a˘ive
,Ö_Vid->¥ev_cs.
rd_∑ss
,Ö_Vid->¥ev_cs.
«l_ª„ªn˚_idc
);

2520 
	`¥ötf
 ("%05d(%3s) %1d %8d %8d %3d %1d %2d %4d %7.3f %7.3f %7.3f %9d %7d %3s %5d %1d %2d %2d %d %d\n",

2521 
p_Vid
->
‰m_no_ö_fûe
, 
pic_ty≥
,Ö_Vid->
võw_id
,

2522 ()(
p_Vid
->
p_Sèts
->
bô_˘r_v
[1] -Ö_Vid->p_Sèts->
bô_˘r_n_v
[1])

2523 + ()(
p_Vid
->
p_Sèts
->
bô_˘r_fûÀr_d©a_v
[1] -Ö_Vid->p_Sèts->
bô_˘r_fûÀr_d©a_n_v
[1]Ë+Ö_Vid->p_Sèts->
bô_˘r_∑ømëî£ts_n_v
[1],

2524 ()(
p_Vid
->
p_Sèts
->
bô_˘r_fûÀr_d©a_v
[1] -Ö_Vid->p_Sèts->
bô_˘r_fûÀr_d©a_n_v
[1]),

2525 
p_Vid
->
p_Sèts
->
bô_˘r_∑ømëî£ts_n_v
[1],

2526 
wp_mëhod
,

2527 
p_Vid
->
AvîageFømeQP
, 
œmbda
,

2528 
mPSNR
->
vÆue
[0], mPSNR->value[1], mPSNR->value[2],

2529 
tmp_time
, (Ë
p_Vid
->
me_time
,

2530 
p_Vid
->
Êd_Êag
 ? "FLD" : "FRM",Ö_Vid->
öåas
, 
dúe˘_mode
,

2531 
p_Vid
->
num_ªf_idx_l0_a˘ive
,Ö_Vid->
num_ªf_idx_l1_a˘ive
,Ö_Vid->
rd_∑ss
,Ö_Vid->
«l_ª„ªn˚_idc
);

2535 
	`¥ötf
 ("%05d(%3s) %1d %8d %8d %3d %1d %2d %4d %7.3f %7.3f %7.3f %9d %7d %3s %5d %1d %2d %2d %d %d\n",

2536 
p_Vid
->
‰m_no_ö_fûe
, 
pic_ty≥
,Ö_Vid->
võw_id
, 
cur_bôs
, 
fdn_bôs
, 
nvb_bôs
, 
wp_mëhod
,

2537 
p_Vid
->
AvîageFømeQP
, 
œmbda
,

2538 
mPSNR
->
vÆue
[0], mPSNR->value[1], mPSNR->value[2],

2539 
tmp_time
, (Ë
p_Vid
->
me_time
,

2540 
p_Vid
->
Êd_Êag
 ? "FLD" : "FRM",Ö_Vid->
öåas
, 
dúe˘_mode
,

2541 
p_Vid
->
num_ªf_idx_l0_a˘ive
,Ö_Vid->
num_ªf_idx_l1_a˘ive
,Ö_Vid->
rd_∑ss
,Ö_Vid->
«l_ª„ªn˚_idc
);

2547 
	`¥ötf
 ("%05d(%3s)%8d %8d %3d %1d %2d %4d %7.3f %7.3f %7.3f %9d %7d %3s %5d %1d %2d %2d %d %d\n",

2548 
p_Vid
->
‰m_no_ö_fûe
, 
pic_ty≥
, 
cur_bôs
, 
fdn_bôs
, 
nvb_bôs
, 
wp_mëhod
,

2549 
p_Vid
->
AvîageFømeQP
, 
œmbda
,

2550 
mPSNR
->
vÆue
[0], mPSNR->value[1], mPSNR->value[2],

2551 
tmp_time
, (Ë
p_Vid
->
me_time
,

2552 
p_Vid
->
Êd_Êag
 ? "FLD" : "FRM",Ö_Vid->
öåas
, 
dúe˘_mode
,

2553 
p_Vid
->
num_ªf_idx_l0_a˘ive
,Ö_Vid->
num_ªf_idx_l1_a˘ive
,Ö_Vid->
rd_∑ss
,Ö_Vid->
«l_ª„ªn˚_idc
);

2557 
	`Rï‹tVîbo£SSIM
(
VideoP¨amëîs
 *
p_Vid
, *
pic_ty≥
, 
cur_bôs
, 
wp_mëhod
, 
œmbda
, 
Di°Mëric
 *
mPSNR
, Di°Mëri¯*
mSSIM
,
tmp_time
, 
dúe˘_mode
)

2559 #i‡(
MVC_EXTENSION_ENABLE
)

2560 i‡–
p_Vid
->
p_I≈
->
num_of_võws
 == 2 )

2562 
	`¥ötf
 ("%05d(%3s) %1d %8d %1d %2d %4d %7.3f %7.3f %7.3f %7.4f %7.4f %7.4f %9d %7d %3s %5d %1d %2d %2d %d %d\n",

2563 
p_Vid
->
‰m_no_ö_fûe
, 
pic_ty≥
,Ö_Vid->
võw_id
, 
cur_bôs
, 
wp_mëhod
,

2564 
p_Vid
->
AvîageFømeQP
, 
œmbda
,

2565 
mPSNR
->
vÆue
[0], mPSNR->value[1], mPSNR->value[2],

2566 
mSSIM
->
vÆue
[0], mSSIM->value[1], mSSIM->value[2],

2567 
tmp_time
, (Ë
p_Vid
->
me_time
,

2568 
p_Vid
->
Êd_Êag
 ? "FLD" : "FRM",Ö_Vid->
öåas
, 
dúe˘_mode
,

2569 
p_Vid
->
num_ªf_idx_l0_a˘ive
,Ö_Vid->
num_ªf_idx_l1_a˘ive
,p_Vid->
rd_∑ss
,Ö_Vid->
«l_ª„ªn˚_idc
);

2574 
	`¥ötf
 ("%05d(%3s)%8d %1d %2d %4d %7.3f %7.3f %7.3f %7.4f %7.4f %7.4f %9d %7d %3s %5d %1d %2d %2d %d %d\n",

2575 
p_Vid
->
‰m_no_ö_fûe
, 
pic_ty≥
, 
cur_bôs
, 
wp_mëhod
,

2576 
p_Vid
->
AvîageFømeQP
, 
œmbda
,

2577 
mPSNR
->
vÆue
[0], mPSNR->value[1], mPSNR->value[2],

2578 
mSSIM
->
vÆue
[0], mSSIM->value[1], mSSIM->value[2],

2579 
tmp_time
, (Ë
p_Vid
->
me_time
,

2580 
p_Vid
->
Êd_Êag
 ? "FLD" : "FRM",Ö_Vid->
öåas
, 
dúe˘_mode
,

2581 
p_Vid
->
num_ªf_idx_l0_a˘ive
,Ö_Vid->
num_ªf_idx_l1_a˘ive
,p_Vid->
rd_∑ss
,Ö_Vid->
«l_ª„ªn˚_idc
);

2585 
	`Rï‹tVîbo£NVBSSIM
(
VideoP¨amëîs
 *
p_Vid
, *
pic_ty≥
, 
cur_bôs
, 
nvb_bôs
, 
wp_mëhod
, 
œmbda
, 
Di°Mëric
 *
mPSNR
, Di°Mëri¯*
mSSIM
,
tmp_time
, 
dúe˘_mode
)

2587 #i‡(
MVC_EXTENSION_ENABLE
)

2588 i‡–
p_Vid
->
p_I≈
->
num_of_võws
 == 2 )

2590 
	`¥ötf
 ("%05d(%3s) %1d %8d %3d %1d %2d %4d %7.3f %7.3f %7.3f %7.4f %7.4f %7.4f %9d %7d %3s %5d %1d %2d %2d %d %d\n",

2591 
p_Vid
->
‰m_no_ö_fûe
, 
pic_ty≥
,Ö_Vid->
võw_id
, 
cur_bôs
, 
nvb_bôs
, 
wp_mëhod
,

2592 
p_Vid
->
AvîageFømeQP
, 
œmbda
,

2593 
mPSNR
->
vÆue
[0], mPSNR->value[1], mPSNR->value[2],

2594 
mSSIM
->
vÆue
[0], mSSIM->value[1], mSSIM->value[2],

2595 
tmp_time
, (Ë
p_Vid
->
me_time
,

2596 
p_Vid
->
Êd_Êag
 ? "FLD" : "FRM",Ö_Vid->
öåas
, 
dúe˘_mode
,

2597 
p_Vid
->
num_ªf_idx_l0_a˘ive
,Ö_Vid->
num_ªf_idx_l1_a˘ive
,Ö_Vid->
rd_∑ss
,Ö_Vid->
«l_ª„ªn˚_idc
);

2602 
	`¥ötf
 ("%05d(%3s)%8d %3d %1d %2d %4d %7.3f %7.3f %7.3f %7.4f %7.4f %7.4f %9d %7d %3s %5d %1d %2d %2d %d %d\n",

2603 
p_Vid
->
‰m_no_ö_fûe
, 
pic_ty≥
, 
cur_bôs
, 
nvb_bôs
, 
wp_mëhod
,

2604 
p_Vid
->
AvîageFømeQP
, 
œmbda
,

2605 
mPSNR
->
vÆue
[0], mPSNR->value[1], mPSNR->value[2],

2606 
mSSIM
->
vÆue
[0], mSSIM->value[1], mSSIM->value[2],

2607 
tmp_time
, (Ë
p_Vid
->
me_time
,

2608 
p_Vid
->
Êd_Êag
 ? "FLD" : "FRM",Ö_Vid->
öåas
, 
dúe˘_mode
,

2609 
p_Vid
->
num_ªf_idx_l0_a˘ive
,Ö_Vid->
num_ªf_idx_l1_a˘ive
,Ö_Vid->
rd_∑ss
,Ö_Vid->
«l_ª„ªn˚_idc
);

2613 
	`Rï‹tVîbo£FDNSSIM
(
VideoP¨amëîs
 *
p_Vid
, *
pic_ty≥
, 
cur_bôs
, 
fdn_bôs
, 
nvb_bôs
, 
wp_mëhod
, 
œmbda
, 
Di°Mëric
 *
mPSNR
, Di°Mëri¯*
mSSIM
,
tmp_time
, 
dúe˘_mode
)

2615 #i‡(
MVC_EXTENSION_ENABLE
)

2616 i‡–
p_Vid
->
p_I≈
->
num_of_võws
 == 2 )

2618 
	`¥ötf
 ("%05d(%3s) %1d %8d %8d %3d %1d %2d %4d %7.3f %7.3f %7.3f %7.4f %7.4f %7.4f %9d %7d %3s %5d %1d %2d %2d %d %d\n",

2619 
p_Vid
->
‰m_no_ö_fûe
, 
pic_ty≥
,Ö_Vid->
võw_id
, 
cur_bôs
, 
fdn_bôs
, 
nvb_bôs
, 
wp_mëhod
,

2620 
p_Vid
->
AvîageFømeQP
, 
œmbda
,

2621 
mPSNR
->
vÆue
[0], mPSNR->value[1], mPSNR->value[2],

2622 
mSSIM
->
vÆue
[0], mSSIM->value[1], mSSIM->value[2],

2623 
tmp_time
, (Ë
p_Vid
->
me_time
,

2624 
p_Vid
->
Êd_Êag
 ? "FLD" : "FRM",Ö_Vid->
öåas
, 
dúe˘_mode
,

2625 
p_Vid
->
num_ªf_idx_l0_a˘ive
,Ö_Vid->
num_ªf_idx_l1_a˘ive
,Ö_Vid->
rd_∑ss
,Ö_Vid->
«l_ª„ªn˚_idc
);

2630 
	`¥ötf
 ("%05d(%3s)%8d %8d %3d %1d %2d %4d %7.3f %7.3f %7.3f %7.4f %7.4f %7.4f %9d %7d %3s %5d %1d %2d %2d %d %d\n",

2631 
p_Vid
->
‰m_no_ö_fûe
, 
pic_ty≥
, 
cur_bôs
, 
fdn_bôs
, 
nvb_bôs
, 
wp_mëhod
,

2632 
p_Vid
->
AvîageFømeQP
, 
œmbda
,

2633 
mPSNR
->
vÆue
[0], mPSNR->value[1], mPSNR->value[2],

2634 
mSSIM
->
vÆue
[0], mSSIM->value[1], mSSIM->value[2],

2635 
tmp_time
, (Ë
p_Vid
->
me_time
,

2636 
p_Vid
->
Êd_Êag
 ? "FLD" : "FRM",Ö_Vid->
öåas
, 
dúe˘_mode
,

2637 
p_Vid
->
num_ªf_idx_l0_a˘ive
,Ö_Vid->
num_ªf_idx_l1_a˘ive
,Ö_Vid->
rd_∑ss
,Ö_Vid->
«l_ª„ªn˚_idc
);

2642 
	`Rï‹tNALN⁄VLCBôs
(
VideoP¨amëîs
 *
p_Vid
, 
öt64
 
tmp_time
)

2644 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

2645 
SètP¨amëîs
 *
p_Sèts
 = 
p_Vid
->p_Stats;

2648 #i‡(
MVC_EXTENSION_ENABLE
)

2649 i‡(
p_I≈
->
num_of_võws
 == 2)

2651 i‡(
p_I≈
->
Vîbo£
 != 0)

2652 
	`¥ötf
 ("%05d(NVBË %8d \n", 
p_Vid
->
‰ame_no
, 
p_Sèts
->
bô_˘r_∑ømëî£ts_n
);

2657 i‡(
p_I≈
->
Vîbo£
 != 0)

2658 
	`¥ötf
 ("%05d(NVB)%8d \n", 
p_Vid
->
‰ame_no
, 
p_Sèts
->
bô_˘r_∑ømëî£ts_n
);

2662 
	`Rï‹tFú°‰ame
(
VideoP¨amëîs
 *
p_Vid
, 
öt64
 
tmp_time
)

2664 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

2665 
SètP¨amëîs
 *
°©s
 = 
p_Vid
->
p_Sèts
;

2667 
cur_bôs
 = ()(
°©s
->
bô_˘r
 - sèts->
bô_˘r_n
)

2668 + ()(
°©s
->
bô_˘r_fûÀr_d©a
 - sèts->
bô_˘r_fûÀr_d©a_n
);

2670 i‡(
p_I≈
->
Vîbo£
 == 1)

2672 
	`Rï‹tSim∂e
(
p_Vid
, "IDR", 
cur_bôs
, &p_Vid->
p_Di°
->
mëric
[
PSNR
], (Ë
tmp_time
);

2674 i‡(
p_I≈
->
Vîbo£
 == 2)

2676 
œmbda
 = (Ë
p_Vid
->
œmbda_me
[
I_SLICE
][p_Vid->
ma°îQP
][
F_PEL
];

2677 i‡(
p_I≈
->
Di°‹ti⁄
[
SSIM
] == 1)

2678 
	`Rï‹tVîbo£SSIM
(
p_Vid
, "IDR", 
cur_bôs
, 0, 
œmbda
, &p_Vid->
p_Di°
->
mëric
[
PSNR
], &p_Vid->p_Di°->mëric[
SSIM
], (Ë
tmp_time
, 0);

2680 
	`Rï‹tVîbo£
(
p_Vid
, "IDR", 
cur_bôs
, 0, 
œmbda
, &p_Vid->
p_Di°
->
mëric
[
PSNR
], (Ë
tmp_time
, 0);

2682 i‡(
p_I≈
->
Vîbo£
 == 3)

2684 
œmbda
 = (Ë
p_Vid
->
œmbda_me
[
I_SLICE
][p_Vid->
ma°îQP
][
F_PEL
];

2685 i‡(
p_I≈
->
Di°‹ti⁄
[
SSIM
] == 1)

2686 
	`Rï‹tVîbo£NVBSSIM
(
p_Vid
, "IDR", 
cur_bôs
 + 
°©s
->
bô_˘r_∑ømëî£ts_n
, sèts->bô_˘r_∑ømëî£ts_n, 0, 
œmbda
, &p_Vid->
p_Di°
->
mëric
[
PSNR
], &p_Vid->p_Di°->mëric[
SSIM
], (Ë
tmp_time
, 0);

2688 
	`Rï‹tVîbo£NVB
(
p_Vid
, "IDR", 
cur_bôs
 + 
°©s
->
bô_˘r_∑ømëî£ts_n
, sèts->bô_˘r_∑ømëî£ts_n, 0, 
œmbda
, &p_Vid->
p_Di°
->
mëric
[
PSNR
], (Ë
tmp_time
, 0);

2690 i‡(
p_I≈
->
Vîbo£
 == 4)

2692 
œmbda
 = (Ë
p_Vid
->
œmbda_me
[
I_SLICE
][p_Vid->
ma°îQP
][
F_PEL
];

2693 i‡(
p_I≈
->
Di°‹ti⁄
[
SSIM
] == 1)

2694 
	`Rï‹tVîbo£FDNSSIM
(
p_Vid
, "IDR", 
cur_bôs
 + 
°©s
->
bô_˘r_∑ømëî£ts_n
, ()(°©s->
bô_˘r_fûÀr_d©a
 - sèts->
bô_˘r_fûÀr_d©a_n
), sèts->bô_˘r_∑ømëî£ts_n, 0, 
œmbda
, &p_Vid->
p_Di°
->
mëric
[
PSNR
], &p_Vid->p_Di°->mëric[
SSIM
], (Ë
tmp_time
, 0);

2696 
	`Rï‹tVîbo£FDN
(
p_Vid
, "IDR", 
cur_bôs
 + 
°©s
->
bô_˘r_∑ømëî£ts_n
, ()(°©s->
bô_˘r_fûÀr_d©a
 - sèts->
bô_˘r_fûÀr_d©a_n
), sèts->bô_˘r_∑ømëî£ts_n, 0, 
œmbda
, &p_Vid->
p_Di°
->
mëric
[
PSNR
], (Ë
tmp_time
, 0);

2699 
°©s
->
bô_cou¡î
[
I_SLICE
] = sèts->
bô_˘r
;

2700 #i‡(
MVC_EXTENSION_ENABLE
)

2701 i‡–
p_I≈
->
num_of_võws
 == 2 )

2703 i‡–!
p_Vid
->
Êd_Êag
 )

2705 
°©s
->
bô_cou¡î_v
[
p_Vid
->
võw_id
][
I_SLICE
] = sèts->
bô_˘r
;

2707 
°©s
->
bô_˘r_v
[0] = 0;

2708 
°©s
->
bô_˘r_v
[1] = 0;

2711 
°©s
->
bô_˘r
 = 0;

2714 
	`Rï‹tI
(
VideoP¨amëîs
 *
p_Vid
, 
öt64
 
tmp_time
)

2716 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

2717 
SètP¨amëîs
 *
°©s
 = 
p_Vid
->
p_Sèts
;

2718 
pic_ty≥
[4];

2719 
cur_bôs
 = ()(
°©s
->
bô_˘r
 - sèts->
bô_˘r_n
)

2720 + ()(
°©s
->
bô_˘r_fûÀr_d©a
 - sèts->
bô_˘r_fûÀr_d©a_n
);

2722 i‡((
p_I≈
->
ªdund™t_pic_Êag
 =0Ë|| !
p_Vid
->
ªdund™t_codög
 )

2724 i‡(
p_Vid
->
cuºítPi˘uª
->
idr_Êag
 =
TRUE
)

2725 
	`°r˝y
(
pic_ty≥
,"IDR");

2726 i‡–
p_Vid
->
ty≥
 =
SI_SLICE
 )

2727 
	`°r˝y
(
pic_ty≥
,"SI ");

2729 
	`°r˝y
(
pic_ty≥
," I ");

2732 
	`°r˝y
(
pic_ty≥
,"R");

2734 i‡(
p_I≈
->
Vîbo£
 == 1)

2736 
	`Rï‹tSim∂e
(
p_Vid
, 
pic_ty≥
, 
cur_bôs
, &p_Vid->
p_Di°
->
mëric
[
PSNR
], (Ë
tmp_time
);

2738 i‡(
p_I≈
->
Vîbo£
 == 2)

2740 
œmbda
 = (Ë
p_Vid
->
œmbda_me
[
I_SLICE
][p_Vid->
ma°îQP
][
F_PEL
];

2741 i‡(
p_I≈
->
Di°‹ti⁄
[
SSIM
] == 1)

2743 
	`Rï‹tVîbo£SSIM
(
p_Vid
, 
pic_ty≥
, 
cur_bôs
, 0, 
œmbda
, &p_Vid->
p_Di°
->
mëric
[
PSNR
], &p_Vid->p_Di°->mëric[
SSIM
], (Ë
tmp_time
, 0);

2747 
	`Rï‹tVîbo£
(
p_Vid
, 
pic_ty≥
, 
cur_bôs
, 0, 
œmbda
, &p_Vid->
p_Di°
->
mëric
[
PSNR
], (Ë
tmp_time
, 0);

2750 i‡(
p_I≈
->
Vîbo£
 == 3)

2752 
œmbda
 = (Ë
p_Vid
->
œmbda_me
[
I_SLICE
][p_Vid->
ma°îQP
][
F_PEL
];

2753 i‡(
p_I≈
->
Di°‹ti⁄
[
SSIM
] == 1)

2755 
	`Rï‹tVîbo£NVBSSIM
(
p_Vid
, 
pic_ty≥
, 
cur_bôs
 + 
°©s
->
bô_˘r_∑ømëî£ts_n
, sèts->bô_˘r_∑ømëî£ts_n, 0, 
œmbda
, &p_Vid->
p_Di°
->
mëric
[
PSNR
], &p_Vid->p_Di°->mëric[
SSIM
], (Ë
tmp_time
, 0);

2759 
	`Rï‹tVîbo£NVB
(
p_Vid
, 
pic_ty≥
, 
cur_bôs
 + 
°©s
->
bô_˘r_∑ømëî£ts_n
, sèts->bô_˘r_∑ømëî£ts_n, 0, 
œmbda
, &p_Vid->
p_Di°
->
mëric
[
PSNR
], (Ë
tmp_time
, 0);

2762 i‡(
p_I≈
->
Vîbo£
 == 4)

2764 
œmbda
 = (Ë
p_Vid
->
œmbda_me
[
I_SLICE
][p_Vid->
ma°îQP
][
F_PEL
];

2765 i‡(
p_I≈
->
Di°‹ti⁄
[
SSIM
] == 1)

2767 
	`Rï‹tVîbo£FDNSSIM
(
p_Vid
, 
pic_ty≥
, 
cur_bôs
 + 
°©s
->
bô_˘r_∑ømëî£ts_n
, ()(°©s->
bô_˘r_fûÀr_d©a
 - sèts->
bô_˘r_fûÀr_d©a_n
), sèts->bô_˘r_∑ømëî£ts_n, 0, 
œmbda
, &p_Vid->
p_Di°
->
mëric
[
PSNR
], &p_Vid->p_Di°->mëric[
SSIM
], (Ë
tmp_time
, 0);

2771 
	`Rï‹tVîbo£FDN
(
p_Vid
, 
pic_ty≥
, 
cur_bôs
 + 
°©s
->
bô_˘r_∑ømëî£ts_n
, ()(°©s->
bô_˘r_fûÀr_d©a
 - sèts->
bô_˘r_fûÀr_d©a_n
), sèts->bô_˘r_∑ømëî£ts_n, 0, 
œmbda
, &p_Vid->
p_Di°
->
mëric
[
PSNR
], (Ë
tmp_time
, 0);

2776 
	`Rï‹tB
(
VideoP¨amëîs
 *
p_Vid
, 
öt64
 
tmp_time
)

2778 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

2779 
SètP¨amëîs
 *
°©s
 = 
p_Vid
->
p_Sèts
;

2781 
cur_bôs
 = ()(
°©s
->
bô_˘r
 - sèts->
bô_˘r_n
)

2782 + ()(
°©s
->
bô_˘r_fûÀr_d©a
 - sèts->
bô_˘r_fûÀr_d©a_n
);

2784 i‡(
p_I≈
->
Vîbo£
 == 1)

2786 
	`Rï‹tSim∂e
(
p_Vid
, " B ", 
cur_bôs
, &p_Vid->
p_Di°
->
mëric
[
PSNR
], (Ë
tmp_time
);

2788 i‡(
p_I≈
->
Vîbo£
 == 2)

2790 
œmbda
 = (Ë
p_Vid
->
œmbda_me
[
B_SLICE
][p_Vid->
ma°îQP
][
F_PEL
];

2791 i‡(
p_I≈
->
Di°‹ti⁄
[
SSIM
] == 1)

2792 
	`Rï‹tVîbo£SSIM
(
p_Vid
, " B ", 
cur_bôs
,Ö_Vid->
a˘ive_µs
->
weighãd_bùªd_idc
, 
œmbda
, &p_Vid->
p_Di°
->
mëric
[
PSNR
], &p_Vid->p_Di°->mëric[
SSIM
], (Ë
tmp_time
,Ö_Vid->
dúe˘_•©ül_mv_¥ed_Êag
);

2794 
	`Rï‹tVîbo£
(
p_Vid
, " B ", 
cur_bôs
,Ö_Vid->
a˘ive_µs
->
weighãd_bùªd_idc
, 
œmbda
, &p_Vid->
p_Di°
->
mëric
[
PSNR
], (Ë
tmp_time
,Ö_Vid->
dúe˘_•©ül_mv_¥ed_Êag
);

2796 i‡(
p_I≈
->
Vîbo£
 == 3)

2798 
œmbda
 = (Ë
p_Vid
->
œmbda_me
[
B_SLICE
][p_Vid->
ma°îQP
][
F_PEL
];

2799 i‡(
p_I≈
->
Di°‹ti⁄
[
SSIM
] == 1)

2800 
	`Rï‹tVîbo£NVBSSIM
(
p_Vid
, " B ", 
cur_bôs
 + 
°©s
->
bô_˘r_∑ømëî£ts_n
, sèts->bô_˘r_∑ømëî£ts_n,Ö_Vid->
a˘ive_µs
->
weighãd_bùªd_idc
, 
œmbda
, &p_Vid->
p_Di°
->
mëric
[
PSNR
], &p_Vid->p_Di°->mëric[
SSIM
], (Ë
tmp_time
,Ö_Vid->
dúe˘_•©ül_mv_¥ed_Êag
);

2802 
	`Rï‹tVîbo£NVB
(
p_Vid
, " B ", 
cur_bôs
 + 
°©s
->
bô_˘r_∑ømëî£ts_n
, sèts->bô_˘r_∑ømëî£ts_n,Ö_Vid->
a˘ive_µs
->
weighãd_bùªd_idc
, 
œmbda
, &p_Vid->
p_Di°
->
mëric
[
PSNR
], (Ë
tmp_time
,Ö_Vid->
dúe˘_•©ül_mv_¥ed_Êag
);

2804 i‡(
p_I≈
->
Vîbo£
 == 4)

2806 
œmbda
 = (Ë
p_Vid
->
œmbda_me
[
B_SLICE
][p_Vid->
ma°îQP
][
F_PEL
];

2807 i‡(
p_I≈
->
Di°‹ti⁄
[
SSIM
] == 1)

2808 
	`Rï‹tVîbo£FDNSSIM
(
p_Vid
, " B ", 
cur_bôs
 + 
°©s
->
bô_˘r_∑ømëî£ts_n
, ()(°©s->
bô_˘r_fûÀr_d©a
 - sèts->
bô_˘r_fûÀr_d©a_n
), sèts->bô_˘r_∑ømëî£ts_n,Ö_Vid->
a˘ive_µs
->
weighãd_bùªd_idc
, 
œmbda
, &p_Vid->
p_Di°
->
mëric
[
PSNR
], &p_Vid->p_Di°->mëric[
SSIM
], (Ë
tmp_time
,Ö_Vid->
dúe˘_•©ül_mv_¥ed_Êag
);

2810 
	`Rï‹tVîbo£FDN
(
p_Vid
, " B ", 
cur_bôs
 + 
°©s
->
bô_˘r_∑ømëî£ts_n
, ()(°©s->
bô_˘r_fûÀr_d©a
 - sèts->
bô_˘r_fûÀr_d©a_n
), sèts->bô_˘r_∑ømëî£ts_n,Ö_Vid->
a˘ive_µs
->
weighãd_bùªd_idc
, 
œmbda
, &p_Vid->
p_Di°
->
mëric
[
PSNR
], (Ë
tmp_time
,Ö_Vid->
dúe˘_•©ül_mv_¥ed_Êag
);

2814 
	`Rï‹tP
(
VideoP¨amëîs
 *
p_Vid
, 
öt64
 
tmp_time
)

2816 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

2817 
SètP¨amëîs
 *
°©s
 = 
p_Vid
->
p_Sèts
;

2819 
pic_ty≥
[4];

2820 
cur_bôs
 = ()(
°©s
->
bô_˘r
 - sèts->
bô_˘r_n
)

2821 + ()(
°©s
->
bô_˘r_fûÀr_d©a
 - sèts->
bô_˘r_fûÀr_d©a_n
);

2823 i‡(
p_Vid
->
ty≥
 =
SP_SLICE
)

2824 
	`°r˝y
(
pic_ty≥
,"SP ");

2825 i‡((
p_I≈
->
ªdund™t_pic_Êag
 =0Ë|| !
p_Vid
->
ªdund™t_codög
 )

2826 
	`°r˝y
(
pic_ty≥
," P ");

2828 
	`°r˝y
(
pic_ty≥
," R ");

2830 i‡(
p_I≈
->
Vîbo£
 == 1)

2832 
	`Rï‹tSim∂e
(
p_Vid
, 
pic_ty≥
, 
cur_bôs
, &p_Vid->
p_Di°
->
mëric
[
PSNR
], (Ë
tmp_time
);

2834 i‡(
p_I≈
->
Vîbo£
 == 2)

2836 
œmbda
 = (Ë
p_Vid
->
œmbda_me
[
P_SLICE
][p_Vid->
ma°îQP
][
F_PEL
];

2837 i‡(
p_I≈
->
Di°‹ti⁄
[
SSIM
] == 1)

2838 
	`Rï‹tVîbo£SSIM
(
p_Vid
, 
pic_ty≥
, 
cur_bôs
,Ö_Vid->
a˘ive_µs
->
weighãd_¥ed_Êag
, 
œmbda
, &p_Vid->
p_Di°
->
mëric
[
PSNR
], &p_Vid->p_Di°->mëric[
SSIM
], (Ë
tmp_time
, 0);

2840 
	`Rï‹tVîbo£
(
p_Vid
, 
pic_ty≥
, 
cur_bôs
,Ö_Vid->
a˘ive_µs
->
weighãd_¥ed_Êag
, 
œmbda
, &p_Vid->
p_Di°
->
mëric
[
PSNR
], (Ë
tmp_time
, 0);

2842 i‡(
p_I≈
->
Vîbo£
 == 3)

2844 
œmbda
 = (Ë
p_Vid
->
œmbda_me
[
P_SLICE
][p_Vid->
ma°îQP
][
F_PEL
];

2845 i‡(
p_I≈
->
Di°‹ti⁄
[
SSIM
] == 1)

2846 
	`Rï‹tVîbo£NVBSSIM
(
p_Vid
, 
pic_ty≥
, 
cur_bôs
 + 
°©s
->
bô_˘r_∑ømëî£ts_n
, sèts->bô_˘r_∑ømëî£ts_n,Ö_Vid->
a˘ive_µs
->
weighãd_¥ed_Êag
, 
œmbda
, &p_Vid->
p_Di°
->
mëric
[
PSNR
], &p_Vid->p_Di°->mëric[
SSIM
], (Ë
tmp_time
, 0);

2848 
	`Rï‹tVîbo£NVB
(
p_Vid
, 
pic_ty≥
, 
cur_bôs
 + 
°©s
->
bô_˘r_∑ømëî£ts_n
, sèts->bô_˘r_∑ømëî£ts_n,Ö_Vid->
a˘ive_µs
->
weighãd_¥ed_Êag
, 
œmbda
, &p_Vid->
p_Di°
->
mëric
[
PSNR
], (Ë
tmp_time
, 0);

2850 i‡(
p_I≈
->
Vîbo£
 == 4)

2852 
œmbda
 = (Ë
p_Vid
->
œmbda_me
[
P_SLICE
][p_Vid->
ma°îQP
][
F_PEL
];

2853 i‡(
p_I≈
->
Di°‹ti⁄
[
SSIM
] == 1)

2854 
	`Rï‹tVîbo£FDNSSIM
(
p_Vid
, 
pic_ty≥
, 
cur_bôs
 + 
°©s
->
bô_˘r_∑ømëî£ts_n
, ()(°©s->
bô_˘r_fûÀr_d©a
 - sèts->
bô_˘r_fûÀr_d©a_n
), sèts->bô_˘r_∑ømëî£ts_n,Ö_Vid->
a˘ive_µs
->
weighãd_¥ed_Êag
, 
œmbda
, &p_Vid->
p_Di°
->
mëric
[
PSNR
], &p_Vid->p_Di°->mëric[
SSIM
], (Ë
tmp_time
, 0);

2856 
	`Rï‹tVîbo£FDN
(
p_Vid
, 
pic_ty≥
, 
cur_bôs
 + 
°©s
->
bô_˘r_∑ømëî£ts_n
, ()(°©s->
bô_˘r_fûÀr_d©a
 - sèts->
bô_˘r_fûÀr_d©a_n
), sèts->bô_˘r_∑ømëî£ts_n,Ö_Vid->
a˘ive_µs
->
weighãd_¥ed_Êag
, 
œmbda
, &p_Vid->
p_Di°
->
mëric
[
PSNR
], (Ë
tmp_time
, 0);

2866 
	`put_buf„r_‰ame
(
VideoP¨amëîs
 *
p_Vid
)

2868 
p_Vid
->
pCurImg
 =Ö_Vid->
imgD©a
.
‰m_d©a
[0];

2869 
p_Vid
->
pImgOrg
[0] =Ö_Vid->
imgD©a
.
‰m_d©a
[0];

2871 i‡(
p_Vid
->
yuv_f‹m©
 !
YUV400
)

2873 
p_Vid
->
pImgOrg
[1] =Ö_Vid->
imgD©a
.
‰m_d©a
[1];

2874 
p_Vid
->
pImgOrg
[2] =Ö_Vid->
imgD©a
.
‰m_d©a
[2];

2877 i‡(
p_Vid
->
p_I≈
->
MDRe„ªn˚
[0] ||Ö_Vid->p_Inp->MDReference[1])

2879 
p_Vid
->
pCurImgRef
 =Ö_Vid->
imgRefD©a
.
‰m_d©a
[0];

2880 
p_Vid
->
pImgOrgRef
[0] =Ö_Vid->
imgRefD©a
.
‰m_d©a
[0];

2882 i‡(
p_Vid
->
yuv_f‹m©
 !
YUV400
)

2884 
p_Vid
->
pImgOrgRef
[1] =Ö_Vid->
imgRefD©a
.
‰m_d©a
[1];

2885 
p_Vid
->
pImgOrgRef
[2] =Ö_Vid->
imgRefD©a
.
‰m_d©a
[2];

2896 
	`put_buf„r_t›
(
VideoP¨amëîs
 *
p_Vid
)

2898 
p_Vid
->
Êd_ty≥
 = 0;

2900 
p_Vid
->
pCurImg
 =Ö_Vid->
imgD©a
.
t›_d©a
[0];

2901 
p_Vid
->
pImgOrg
[0] =Ö_Vid->
imgD©a
.
t›_d©a
[0];

2903 i‡(
p_Vid
->
yuv_f‹m©
 !
YUV400
)

2905 
p_Vid
->
pImgOrg
[1] =Ö_Vid->
imgD©a
.
t›_d©a
[1];

2906 
p_Vid
->
pImgOrg
[2] =Ö_Vid->
imgD©a
.
t›_d©a
[2];

2909 i‡–
p_Vid
->
p_I≈
->
MDRe„ªn˚
[0] ||Ö_Vid->p_Inp->MDReference[1] )

2911 
p_Vid
->
pCurImgRef
 =Ö_Vid->
imgRefD©a
.
t›_d©a
[0];

2912 
p_Vid
->
pImgOrgRef
[0] =Ö_Vid->
imgRefD©a
.
t›_d©a
[0];

2914 i‡(
p_Vid
->
yuv_f‹m©
 !
YUV400
)

2916 
p_Vid
->
pImgOrgRef
[1] =Ö_Vid->
imgRefD©a
.
t›_d©a
[1];

2917 
p_Vid
->
pImgOrgRef
[2] =Ö_Vid->
imgRefD©a
.
t›_d©a
[2];

2928 
	`put_buf„r_bŸ
(
VideoP¨amëîs
 *
p_Vid
)

2930 
p_Vid
->
Êd_ty≥
 = 1;

2932 
p_Vid
->
pCurImg
 =Ö_Vid->
imgD©a
.
bŸ_d©a
[0];

2933 
p_Vid
->
pImgOrg
[0] =Ö_Vid->
imgD©a
.
bŸ_d©a
[0];

2935 i‡(
p_Vid
->
yuv_f‹m©
 !
YUV400
)

2937 
p_Vid
->
pImgOrg
[1] =Ö_Vid->
imgD©a
.
bŸ_d©a
[1];

2938 
p_Vid
->
pImgOrg
[2] =Ö_Vid->
imgD©a
.
bŸ_d©a
[2];

2941 i‡–
p_Vid
->
p_I≈
->
MDRe„ªn˚
[0] ||Ö_Vid->p_Inp->MDReference[1] )

2943 
p_Vid
->
pCurImgRef
 =Ö_Vid->
imgRefD©a
.
bŸ_d©a
[0];

2944 
p_Vid
->
pImgOrgRef
[0] =Ö_Vid->
imgRefD©a
.
bŸ_d©a
[0];

2946 i‡(
p_Vid
->
yuv_f‹m©
 !
YUV400
)

2948 
p_Vid
->
pImgOrgRef
[1] =Ö_Vid->
imgRefD©a
.
bŸ_d©a
[1];

2949 
p_Vid
->
pImgOrgRef
[2] =Ö_Vid->
imgRefD©a
.
bŸ_d©a
[2];

2960 
	`ouçut_SP_c€fficõ¡s
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

2962 
i
,
k
;

2963 
FILE
 *
SP_c€ff_fûe
;

2964 
ªt
;

2965 if(
p_Vid
->
numbî_•2_‰ames
==0)

2967 i‡((
SP_c€ff_fûe
 = 
	`f›í
(
p_I≈
->
•_ouçut_fûíame
,"wb")Ë=
NULL
)

2969 
	`¥ötf
 ("F©Æ: c™nŸ o≥¿SP ouçuàfûê'%s',Éxô (-1)\n", 
p_I≈
->
•_ouçut_fûíame
);

2970 
	`exô
 (-1);

2972 
p_Vid
->
numbî_•2_‰ames
++;

2976 i‡((
SP_c€ff_fûe
 = 
	`f›í
(
p_I≈
->
•_ouçut_fûíame
,"ab")Ë=
NULL
)

2978 
	`¥ötf
 ("F©Æ: c™nŸ o≥¿SP ouçuàfûê'%s',Éxô (-1)\n", 
p_I≈
->
•_ouçut_fûíame
);

2979 
	`exô
 (-1);

2983 
i
=0;i<
p_Vid
->
height
;i++)

2985 
ªt
 = (Ë
	`fwrôe
(
p_Vid
->
Ãec
[
i
], (),Ö_Vid->
width
, 
SP_c€ff_fûe
);

2986 i‡(
ªt
 !
p_Vid
->
width
)

2988 
	`îr‹
 ("cannot writeÅo SP output file", -1);

2992 
k
=0;k<2;k++)

2994 
i
=0;i<
p_Vid
->
height_¸
;i++)

2996 
ªt
 = (Ë
	`fwrôe
(
p_Vid
->
Ãec_uv
[
k
][
i
], (),Ö_Vid->
width_¸
, 
SP_c€ff_fûe
);

2997 i‡(
ªt
 !
p_Vid
->
width_¸
)

2999 
	`îr‹
 ("cannot writeÅo SP output file", -1);

3003 
	`f˛o£
(
SP_c€ff_fûe
);

3012 
	`ªad_SP_c€fficõ¡s
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

3014 
i
,
k
;

3015 
FILE
 *
SP_c€ff_fûe
;

3017 i‡–
p_I≈
->
•_swôch_≥riod
 > 0 && ( 
p_Vid
->
numbî_•2_‰ames
 % (p_Inp->sp_switch_period << 1) ) >=Ö_Inp->sp_switch_period )

3019 i‡((
SP_c€ff_fûe
 = 
	`f›í
(
p_I≈
->
•2_öput_fûíame1
,"rb")Ë=
NULL
)

3021 
	`¥ötf
 ("F©Æ: c™nŸ o≥¿SP i≈uàfûê'%s',Éxô (-1)\n", 
p_I≈
->
•2_öput_fûíame2
);

3022 
	`exô
 (-1);

3027 i‡((
SP_c€ff_fûe
 = 
	`f›í
(
p_I≈
->
•2_öput_fûíame2
,"rb")Ë=
NULL
)

3029 
	`¥ötf
 ("F©Æ: c™nŸ o≥¿SP i≈uàfûê'%s',Éxô (-1)\n", 
p_I≈
->
•2_öput_fûíame1
);

3030 
	`exô
 (-1);

3034 i‡(0 !
	`f£ek
 (
SP_c€ff_fûe
, 
p_Vid
->
size
 * 3/2*p_Vid->
numbî_•2_‰ames
*(), 
SEEK_SET
))

3036 
	`¥ötf
 ("Fatal: cannot seek in SP input file,Éxit (-1)\n");

3037 
	`exô
 (-1);

3039 
p_Vid
->
numbî_•2_‰ames
++;

3041 
i
=0;i<
p_Vid
->
height
;i++)

3043 if(
p_Vid
->
width
!=()
	`‰ód
’_Vid->
Ãec
[
i
],(),p_Vid->width,
SP_c€ff_fûe
))

3045 
	`¥ötf
 ("Fatal: cannotÑead in SP input file,Éxit (-1)\n");

3046 
	`exô
 (-1);

3050 
k
=0;k<2;k++)

3052 
i
=0;i<
p_Vid
->
height_¸
;i++)

3054 if(
p_Vid
->
width_¸
!=()
	`‰ód
’_Vid->
Ãec_uv
[
k
][
i
],(),p_Vid->width_¸,
SP_c€ff_fûe
))

3056 
	`¥ötf
 ("Fatal: cannotÑead in SP input file,Éxit (-1)\n");

3057 
	`exô
 (-1);

3061 
	`f˛o£
(
SP_c€ff_fûe
);

3071 
	`£À˘_∂™e
(
VideoP¨amëîs
 *
p_Vid
, 
Cﬁ‹Pœ√
 
cﬁ‹_∂™e
)

3073 
p_Vid
->
pCurImg
 =Ö_Vid->
pImgOrg
[
cﬁ‹_∂™e
];

3074 
p_Vid
->
íc_pi˘uª
->
p_cuº_img
 =Ö_Vid->íc_pi˘uª->
p_img
[
cﬁ‹_∂™e
];

3075 
p_Vid
->
íc_pi˘uª
->
p_cuº_img_sub
 =Ö_Vid->íc_pi˘uª->
p_img_sub
[
cﬁ‹_∂™e
];

3076 
p_Vid
->
max_img≥l_vÆue
 = (Ëp_Vid->
max_≥l_vÆue_comp
[
cﬁ‹_∂™e
];

3077 
p_Vid
->
dc_¥ed_vÆue
 =Ö_Vid->
dc_¥ed_vÆue_comp
[
cﬁ‹_∂™e
];

3086 
	`is_g›_fú°_unô
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

3088  ( 
	`gë_idr_Êag
(
p_Vid
Ë|| (Ö_Vid->
ty≥
 =
I_SLICE
 && 
p_I≈
->
E«bÀO≥nGOP
 && 
	`gë_øndom_ac˚ss_Êag
(p_Vid) ) );

3097 
	`wrôe_n⁄_v˛_«lu
–
VideoP¨amëîs
 *
p_Vid
 )

3099 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

3102 i‡(
p_I≈
->
Re£ndSPS
 =3 && 
	`is_g›_fú°_unô
(
p_Vid
,Ö_I≈Ë&&Ö_Vid->
numbî
)

3104 
p_Vid
->
p_Sèts
->
bô_¶i˚
 = 
	`ªwrôe_∑øm£ts
(p_Vid);

3106 i‡(
p_I≈
->
Re£ndSPS
 =2 && 
	`gë_idr_Êag
(
p_Vid
Ë&&Ö_Vid->
numbî
)

3108 
p_Vid
->
p_Sèts
->
bô_¶i˚
 = 
	`ªwrôe_∑øm£ts
(p_Vid);

3110 i‡(
p_I≈
->
Re£ndSPS
 =1 && 
p_Vid
->
ty≥
 =
I_SLICE
 &&Ö_Vid->
cuº_‰m_idx
 != 0)

3112 
p_Vid
->
p_Sèts
->
bô_¶i˚
 = 
	`ªwrôe_∑øm£ts
(p_Vid);

3115 i‡–
p_I≈
->
Re£ndPPS
 && 
p_Vid
->
cuº_‰m_idx
 != 0 )

3117 
i
, 
tŸÆ_µs
 = 
p_I≈
->
Gíî©eMu…ùÀPPS
 ? 3 : 1;

3119 
p_Vid
->
p_Sèts
->
bô_˘r_∑ømëî£ts_n
 = 0;

3121 i‡–
p_I≈
->
SídAUD
 )

3123 
p_Vid
->
p_Sèts
->
bô_˘r_∑ømëî£ts_n
 = 
	`Wrôe_AUD_NALU
(p_Vid);

3125  
i
 = 0; i < 
tŸÆ_µs
; i++ )

3127 
p_Vid
->
p_Sèts
->
bô_˘r_∑ømëî£ts_n
 +
	`wrôe_PPS
’_Vid, 0, 
i
);

3131 i‡–
p_I≈
->
SídAUD
 && 
p_Vid
->
cuº_‰m_idx
 != 0 )

3133 
p_Vid
->
p_Sèts
->
bô_˘r_∑ømëî£ts_n
 +
	`Wrôe_AUD_NALU
(p_Vid);

3136 
	`Upd©eSub£qInfo
 (
p_Vid
, 
p_I≈
,Ö_Vid->
œyî
);

3137 
	`Upd©eS˚√Inf‹m©i⁄
 (
p_Vid
->
p_SEI
, 
FALSE
, 0, 0, -1);

3143 i‡(
p_I≈
->
T⁄eM≠pögSEIPª£¡Fœg
)

3145 
	`Upd©eT⁄eM≠pög
(
p_Vid
->
p_SEI
);

3149 
	`CÀ¨PicTimög
(
p_Vid
->
p_SEI
);

3150 i‡–
p_I≈
->
SEIVUI32PuŒdown
 )

3152 
	`Upd©ePicTimög
(
p_Vid
, 
p_I≈
);

3153 
	`Pª∑ªAggªg©i⁄SEIMesßge
(
p_Vid
);

3154 
p_Vid
->
p_Sèts
->
bô_˘r_∑ømëî£ts_n
 +
	`Wrôe_SEI_NALU
(p_Vid, 0);

3155 
	`CÀ¨PicTimög
(
p_Vid
->
p_SEI
);

3157 
	`˛ór_£i_mesßge
(
p_Vid
->
p_SEI
, 
AGGREGATION_SEI
);

3161 
	`Pª∑ªAggªg©i⁄SEIMesßge
(
p_Vid
);

3164 
p_Vid
->
p_Sèts
->
bô_˘r_∑ømëî£ts_n
 +
	`Wrôe_SEI_NALU
(p_Vid, 0);

3167 
p_Vid
->
p_Sèts
->
bô_˘r_∑ømëî£ts
 +p_Vid->p_Sèts->
bô_˘r_∑ømëî£ts_n
;

3176 
	`wrôe_n⁄_v˛_«lu_bŸ_Êd
–
VideoP¨amëîs
 *
p_Vid
 )

3178 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

3179 
öô_∑øm_£t_bôs
 = 
p_Vid
->
p_Sèts
->
bô_˘r_∑ømëî£ts_n
;

3182 i‡(
p_I≈
->
Re£ndSPS
 =1 && 
p_Vid
->
ty≥
 =
I_SLICE
)

3184 
p_Vid
->
p_Sèts
->
bô_¶i˚
 = 
	`ªwrôe_∑øm£ts
(p_Vid);

3187 i‡–
p_I≈
->
Re£ndPPS
 )

3189 
i
, 
tŸÆ_µs
 = 
p_I≈
->
Gíî©eMu…ùÀPPS
 ? 3 : 1;

3191 
p_Vid
->
p_Sèts
->
bô_˘r_∑ømëî£ts_n
 = 0;

3193 i‡–
p_I≈
->
SídAUD
 )

3195 
p_Vid
->
p_Sèts
->
bô_˘r_∑ømëî£ts_n
 = 
	`Wrôe_AUD_NALU
(p_Vid);

3197  
i
 = 0; i < 
tŸÆ_µs
; i++ )

3199 
p_Vid
->
p_Sèts
->
bô_˘r_∑ømëî£ts_n
 +
	`wrôe_PPS
’_Vid, 0, 
i
);

3203 i‡–
p_I≈
->
SídAUD
 )

3205 
p_Vid
->
p_Sèts
->
bô_˘r_∑ømëî£ts_n
 +
	`Wrôe_AUD_NALU
(p_Vid);

3208 
	`Upd©eSub£qInfo
 (
p_Vid
, 
p_I≈
,Ö_Vid->
œyî
);

3209 
	`Upd©eS˚√Inf‹m©i⁄
 (
p_Vid
->
p_SEI
, 
FALSE
, 0, 0, -1);

3215 i‡(
p_I≈
->
T⁄eM≠pögSEIPª£¡Fœg
)

3217 
	`Upd©eT⁄eM≠pög
(
p_Vid
->
p_SEI
);

3220 
	`Pª∑ªAggªg©i⁄SEIMesßge
(
p_Vid
);

3222 
p_Vid
->
p_Sèts
->
bô_˘r_∑ømëî£ts_n
 +
	`Wrôe_SEI_NALU
(p_Vid, 0);

3225 
p_Vid
->
p_Sèts
->
bô_˘r_∑ømëî£ts
 +’_Vid->p_Sèts->
bô_˘r_∑ømëî£ts_n
 - 
öô_∑øm_£t_bôs
);

3228 
	`OtfCom∑tibûôy_c›yWôhPaddög
 ( 
img≥l
 **
d°Img
, img≥»**
§cImg
, 
size_x
, 
size_y
, 
∑ddög_x
, 
∑ddög_y
 )

3230 
i
, 
j
;

3231 
size_x_möus1
 = 
size_x
 - 1;

3233 
img≥l
 *
wBufSrc
, *
wBufD°
;

3236 
wBufD°
 = &–
d°Img
[-
∑ddög_y
][-
∑ddög_x
] );

3237 
wBufSrc
 = 
§cImg
[0];

3239 
i
 = 0; i < 
∑ddög_x
; ++i)

3240 *(
wBufD°
++Ë
wBufSrc
[0];

3242 
	`mem˝y
(
wBufD°
, 
wBufSrc
, 
size_x
 * (
img≥l
));

3243 
wBufD°
 +
size_x
;

3245 
i
 = 0; i < 
∑ddög_x
; ++i)

3246 *(
wBufD°
++Ë
wBufSrc
[
size_x_möus1
];

3249 
j
 = -
∑ddög_y
+1; j < 0; ++j)

3251 
	`mem˝y
(
d°Img
[
j
]-
∑ddög_x
, d°Img[j - 1]-∑ddög_x, (
size_x
+2*∑ddög_xË* (
img≥l
));

3254 
j
 = 0; j < 
size_y
; ++j)

3256 
wBufD°
 = &–
d°Img
[
j
][-
∑ddög_x
] );

3257 
wBufSrc
 = 
§cImg
[
j
];

3259 
i
 = 0; i < 
∑ddög_x
; ++i)

3260 *(
wBufD°
++Ë
wBufSrc
[0];

3263 
wBufD°
 +
size_x
;

3265 
i
 = 0; i < 
∑ddög_x
; ++i)

3266 *(
wBufD°
++Ë
wBufSrc
[
size_x_möus1
];

3270 
j
 = 
size_y
; j < size_y+
∑ddög_y
; ++j)

3272 
	`mem˝y
(
d°Img
[
j
]-
∑ddög_x
, d°Img[j - 1]-∑ddög_x, (
size_x
+2*∑ddög_xË* (
img≥l
));

3277 #i‡(
MVC_EXTENSION_ENABLE
)

3284 
	`wrôe_n⁄_v˛_«lu_mvc
–
VideoP¨amëîs
 *
p_Vid
 )

3286 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

3287 
bôs
;

3289 i‡–
p_Vid
->
võw_id
 )

3291 i‡–
p_I≈
->
SídAUD
 == 2 )

3293 
p_Vid
->
p_Sèts
->
bô_˘r_∑ømëî£ts_n
 +
bôs
 = 
	`Wrôe_AUD_NALU
(p_Vid);

3294 
p_Vid
->
p_Sèts
->
bô_˘r_∑ømëî£ts_n_v
[p_Vid->
võw_id
] +
bôs
;

3300 i‡(
p_I≈
->
Re£ndSPS
 =3 && 
	`is_g›_fú°_unô
(
p_Vid
,Ö_I≈Ë&&Ö_Vid->
numbî
 &&Ö_Vid->
°ru˘uª
 !
BOTTOM_FIELD
)

3302 
p_Vid
->
p_Sèts
->
bô_¶i˚
 = 
	`ªwrôe_∑øm£ts
(p_Vid);

3304 i‡(
p_I≈
->
Re£ndSPS
 =2 && 
	`gë_idr_Êag
(
p_Vid
Ë&&Ö_Vid->
numbî
 &&Ö_Vid->
°ru˘uª
 !
BOTTOM_FIELD
)

3306 
p_Vid
->
p_Sèts
->
bô_¶i˚
 = 
	`ªwrôe_∑øm£ts
(p_Vid);

3308 i‡(
p_I≈
->
Re£ndSPS
 =1 && 
p_Vid
->
ty≥
 =
I_SLICE
 &&Ö_Vid->
cuº_‰m_idx
 !0 &&Ö_Vid->
°ru˘uª
 !
BOTTOM_FIELD
)

3310 
p_Vid
->
p_Sèts
->
bô_¶i˚
 = 
	`ªwrôe_∑øm£ts
(p_Vid);

3313 i‡–
p_I≈
->
Re£ndPPS
 && 
p_Vid
->
cuº_‰m_idx
 != 0 )

3315 
i
, 
tŸÆ_µs
 = 
p_I≈
->
Gíî©eMu…ùÀPPS
 ? 3 : 1;

3317 
p_Vid
->
p_Sèts
->
bô_˘r_∑ømëî£ts_n
 = 0;

3319 i‡–
p_I≈
->
SídAUD
 )

3321 
p_Vid
->
p_Sèts
->
bô_˘r_∑ømëî£ts_n
 = 
bôs
 = 
	`Wrôe_AUD_NALU
(p_Vid);

3322 
p_Vid
->
p_Sèts
->
bô_˘r_∑ømëî£ts_n_v
[p_Vid->
võw_id
] +
bôs
;

3323  
i
 = 0; i < 
tŸÆ_µs
; i++ )

3325 
p_Vid
->
p_Sèts
->
bô_˘r_∑ømëî£ts_n
 +
bôs
 = 
	`wrôe_PPS
’_Vid, 0, 
i
);

3326 
p_Vid
->
p_Sèts
->
bô_˘r_∑ømëî£ts_n_v
[p_Vid->
võw_id
] +
bôs
;

3331  
i
 = 0; i < 
tŸÆ_µs
; i++ )

3333 
p_Vid
->
p_Sèts
->
bô_˘r_∑ømëî£ts_n
 +
bôs
 = 
	`wrôe_PPS
’_Vid, 0, 
i
);

3334 
p_Vid
->
p_Sèts
->
bô_˘r_∑ømëî£ts_n_v
[p_Vid->
võw_id
] +
bôs
;

3339 i‡–
p_I≈
->
SídAUD
 && (
p_Vid
->
cuº_‰m_idx
 !0 ||Ö_Vid->
°ru˘uª
 =
BOTTOM_FIELD
) )

3341 
p_Vid
->
p_Sèts
->
bô_˘r_∑ømëî£ts_n
 +
bôs
 = 
	`Wrôe_AUD_NALU
(p_Vid);

3342 
p_Vid
->
p_Sèts
->
bô_˘r_∑ømëî£ts_n_v
[p_Vid->
võw_id
] +
bôs
;

3346 
	`Upd©eSub£qInfo
 (
p_Vid
, 
p_I≈
,Ö_Vid->
œyî
);

3347 
	`Upd©eS˚√Inf‹m©i⁄
 (
p_Vid
->
p_SEI
, 
FALSE
, 0, 0, -1);

3353 i‡(
p_I≈
->
T⁄eM≠pögSEIPª£¡Fœg
)

3355 
	`Upd©eT⁄eM≠pög
(
p_Vid
->
p_SEI
);

3358 
	`Pª∑ªAggªg©i⁄SEIMesßge
(
p_Vid
);

3360 
p_Vid
->
p_Sèts
->
bô_˘r_∑ømëî£ts_n
 +
bôs
 = 
	`Wrôe_SEI_NALU
(p_Vid, 0);

3361 
p_Vid
->
p_Sèts
->
bô_˘r_∑ømëî£ts_n_v
[p_Vid->
võw_id
] +
bôs
;

3364 
p_Vid
->
p_Sèts
->
bô_˘r_∑ømëî£ts
 +p_Vid->p_Sèts->
bô_˘r_∑ømëî£ts_n
;

	@lencod/src/image_mp.c

14 
	~"c⁄åibut‹s.h
"

16 
	~"globÆ.h
"

17 
	~"image.h
"

18 
	~"rc_quadøtic.h
"

19 
	~"wp.h
"

20 
	~"¥ed_°ru˘.h
"

21 
	~"¶i˚.h
"

23 
	#DBG_IMAGE_MP
 0

	)

27 
	mREGULAR
 = 0,

28 
	mEXP_WP
 = 1,

29 
	mIMP_WP
 = 2,

30 
	mFRAME_TYPE
 = 2,

31 
	mFRAME_QP
 = 3,

32 
	mALT_DIRECT
 = 4,

33 
	mALT_ENTROPY
 = 5,

34 
	mDB_OFF
 = 6,

35 } 
	tFømeCodögMëhod
;

37 
‰ame_pi˘uª_mp_i_¶i˚
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
);

38 
‰ame_pi˘uª_mp_p_¶i˚
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
);

39 
‰ame_pi˘uª_mp_b_¶i˚
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
);

41 
	$°‹e_codög_öfo
(
VideoP¨amëîs
 *
p_Vid
, 
CodögInfo
 *
codög_öfo
)

43 
codög_öfo
->
ty≥
 = 
p_Vid
->type;

44 
codög_öfo
->
öåas
 = 
p_Vid
->intras;

45 
codög_öfo
->
sumFømeQP
 = 
p_Vid
->
SumFømeQP
;

46 
codög_öfo
->
num_ªf_idx_l0
 = 
p_Vid
->
num_ªf_idx_l0_a˘ive
;

47 
codög_öfo
->
num_ªf_idx_l1
 = 
p_Vid
->
num_ªf_idx_l1_a˘ive
;

48 
codög_öfo
->
a˘ive_µs
 = 
p_Vid
->active_pps;

49 
	}
}

51 
	$°‹e_codög_™d_rc_öfo
(
VideoP¨amëîs
 *
p_Vid
, 
CodögInfo
 *
codög_öfo
)

53 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

55 
	`°‹e_codög_öfo
–
p_Vid
, 
codög_öfo
 );

57 i‡–
p_I≈
->
RCE«bÀ
 )

59 
	`rc_ßve_°©e
–
p_Vid
, 
p_I≈
 );

61 
	}
}

63 
	$ª°‹e_codög_öfo
(
VideoP¨amëîs
 *
p_Vid
, 
CodögInfo
 *
codög_öfo
)

65 
p_Vid
->
ty≥
 = 
codög_öfo
->type;

66 
p_Vid
->
öåas
 = 
codög_öfo
->intras;

67 
p_Vid
->
SumFømeQP
 = 
codög_öfo
->
sumFømeQP
;

68 
p_Vid
->
num_ªf_idx_l0_a˘ive
 = 
codög_öfo
->
num_ªf_idx_l0
;

69 
p_Vid
->
num_ªf_idx_l1_a˘ive
 = 
codög_öfo
->
num_ªf_idx_l1
;

70 
p_Vid
->
a˘ive_µs
 = 
codög_öfo
->active_pps;

71 
	}
}

73 
	$sw≠_‰ame_buf„r
(
VideoP¨amëîs
 *
p_Vid
, 
a
, 
b
)

75 
St‹abÀPi˘uª
 *
s
;

76 
Pi˘uª
 *
p
;

78 
p
 = 
p_Vid
->
‰ame_pic
[
a
];

79 
p_Vid
->
‰ame_pic
[
a
] =Ö_Vid->‰ame_pic[
b
];

80 
p_Vid
->
‰ame_pic
[
b
] = 
p
;

82 
s
 = 
p_Vid
->
íc_‰ame_pi˘uª
[
a
];

83 
p_Vid
->
íc_‰ame_pi˘uª
[
a
] =Ö_Vid->íc_‰ame_pi˘uª[
b
];

84 
p_Vid
->
íc_‰ame_pi˘uª
[
b
] = 
s
;

85 
	}
}

88 
	$‰ame_pi˘uª_mp_exô
(
VideoP¨amëîs
 *
p_Vid
, 
CodögInfo
 *
codög_öfo
)

90 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

92 
p_Vid
->
p_cuº_‰m_°ru˘
->
qp
 =Ö_Vid->qp;

93 
p_Vid
->
íc_pi˘uª
ı_Vid->
íc_‰ame_pi˘uª
[0];

94 
p_Vid
->
p_‰ame_pic
 =Ö_Vid->
‰ame_pic
[0];

95 
	`ª°‹e_codög_öfo
(
p_Vid
, 
codög_öfo
);

97 i‡–
p_I≈
->
RCE«bÀ
 )

99 
	`rc_ª°‹e_°©e
(
p_Vid
, 
p_I≈
);

101 
	}
}

104 
	$‰ame_pi˘uª_mp_p_¶i˚
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

106 
rd_∑ss
 = 0;

107 
rd_qp
 = 
p_Vid
->
p_cuº_‰m_°ru˘
->
qp
;

108 
øãR©io
 = 1.0F;

109 
wp_∑ss
=0;

110 
‰ame_ty≥_∑ss
 = 0;

111 
CodögInfo
 
codög_öfo
;

112 
FømeCodögMëhod
 
be°_mëhod
 = 
REGULAR
;

113 
‰ame_ty≥
 = 
P_SLICE
;

114 
≠∂y_wp
 = 0;

115 
£À˘i⁄
;

117 
	`‰ame_pi˘uª
 (
p_Vid
,Ö_Vid->
‰ame_pic
[
rd_∑ss
], &p_Vid->
imgD©a
,Ñd_pass);

118 
	`°‹e_codög_™d_rc_öfo
(
p_Vid
, &
codög_öfo
);

120 if(
p_I≈
->
WPIãrMC
)

121 
p_Vid
->
‰ameOff£tAvaû
 = 1;

123 #i‡(
DBG_IMAGE_MP
)

124 
	`¥ötf
("rd_∑s†%d: %d (%.0f, %.0f, %.0f)\n", 
rd_∑ss
,

125 
p_Vid
->
‰ame_pic
[0]->
bôs_≥r_pi˘uª
,

126 
p_Vid
->
‰ame_pic
[0]->
di°‹ti⁄
.
vÆue
[0],Ö_Vid->frame_pic[0]->distortion.value[1],Ö_Vid->frame_pic[0]->distortion.value[2]);

129 
rd_∑ss
++;

130 if(
rd_∑ss
 >
p_I≈
->
RDPi˘uªMaxPassPSli˚
)

132 
	`‰ame_pi˘uª_mp_exô
(
p_Vid
, &
codög_öfo
);

137 
wp_∑ss
 = 0;

138 i‡(
p_I≈
->
Gíî©eMu…ùÀPPS
)

140 
Sli˚
 *
dummy_¶i˚
 = 
NULL
;

142 
	`InôWP
(
p_Vid
, 
p_I≈
, 0);

143 i‡–
p_I≈
->
WPMCPªcisi⁄
 )

144 
p_Vid
->
pWPX
->
cuº_wp_rd_∑ss
 =Ö_Vid->pWPX->
wp_rd_∑s£s
 + 1;

145 
	`öô_¶i˚_lôe
(
p_Vid
, &
dummy_¶i˚
, 0);

147 i‡(
p_Vid
->
	`Te°WPPSli˚
(
dummy_¶i˚
, 0) == 1)

150 
p_Vid
->
a˘ive_µs
 =Ö_Vid->
PicP¨Së
[1];

151 i‡–
p_I≈
->
WPMCPªcisi⁄
 )

152 
p_Vid
->
pWPX
->
cuº_wp_rd_∑ss
->
Æg‹ôhm
 = 
WP_REGULAR
;

153 
wp_∑ss
 = 1;

155 i‡–
p_I≈
->
WPMCPªcisi⁄
 )

158 
p_Vid
->
a˘ive_µs
 =Ö_Vid->
PicP¨Së
[1];

159 
wp_∑ss
 = 1;

164 if(
wp_∑ss
)

166 
p_Vid
->
wrôe_ma¸oblock
 = 
FALSE
;

167 
p_Vid
->
p_cuº_‰m_°ru˘
->
qp
 =Ö_Vid->qp;

168 
	`‰ame_pi˘uª
 (
p_Vid
,Ö_Vid->
‰ame_pic
[
rd_∑ss
], &p_Vid->
imgD©a
,Ñd_pass);

169 
£À˘i⁄
 = 
	`pi˘uª_codög_decisi⁄
(
p_Vid
,Ö_Vid->
‰ame_pic
[0],Ö_Vid->‰ame_pic[
rd_∑ss
], 
rd_qp
);

170 #i‡(
DBG_IMAGE_MP
)

171 
	`¥ötf
("rd_∑s†%d, sñe˘i⁄ = %d\n", 
rd_∑ss
, 
£À˘i⁄
);

173 #i‡(
DBG_IMAGE_MP
)

174 
	`¥ötf
("rd_∑s†%d: %d (%.0f, %.0f, %.0f)\n", 
rd_∑ss
,

175 
p_Vid
->
‰ame_pic
[
rd_∑ss
]->
bôs_≥r_pi˘uª
,

176 
p_Vid
->
‰ame_pic
[
rd_∑ss
]->
di°‹ti⁄
.
vÆue
[0],Ö_Vid->frame_pic[rd_pass]->distortion.value[1],Ö_Vid->frame_pic[rd_pass]->distortion.value[2]);

179 i‡(
£À˘i⁄
)

181 
	`sw≠_‰ame_buf„r
(
p_Vid
, 0, 
rd_∑ss
);

182 
	`°‹e_codög_™d_rc_öfo
(
p_Vid
, &
codög_öfo
);

183 
be°_mëhod
 = 
EXP_WP
;

184 
≠∂y_wp
 = 1;

187 if(
p_I≈
->
WPMëhod
 =0 ||Ö_I≈->
WPMCPªcisi⁄
)

189 
wp_∑ss
 = 0;

190 i‡–
p_I≈
->
WPMCPªcisi⁄
 )

191 
p_Vid
->
pWPX
->
cuº_wp_rd_∑ss
 =Ö_Vid->pWPX->
wp_rd_∑s£s
 + 2;

192 i‡(
p_I≈
->
WPMëhod
 =0 && 
p_Vid
->
	`Te°WPPSli˚
(
dummy_¶i˚
, 1) == 1)

195 
p_Vid
->
a˘ive_µs
 =Ö_Vid->
PicP¨Së
[1];

196 i‡–
p_I≈
->
WPMCPªcisi⁄
 )

197 
p_Vid
->
pWPX
->
cuº_wp_rd_∑ss
->
Æg‹ôhm
 = 
WP_REGULAR
;

198 
wp_∑ss
 = 1;

200 i‡–
p_I≈
->
WPMCPªcisi⁄
 )

203 
p_Vid
->
a˘ive_µs
 =Ö_Vid->
PicP¨Së
[1];

204 
wp_∑ss
 = 1;

207 if(
wp_∑ss
)

209 
p_Vid
->
wrôe_ma¸oblock
 = 
FALSE
;

210 
p_Vid
->
p_cuº_‰m_°ru˘
->
qp
 =Ö_Vid->qp;

211 
	`‰ì_¶i˚_li°
(
p_Vid
->
‰ame_pic
[
rd_∑ss
]);

212 
	`‰ì_°‹abÀ_pi˘uª
(
p_Vid
,Ö_Vid->
íc_‰ame_pi˘uª
[
rd_∑ss
]);

213 
	`‰ame_pi˘uª
 (
p_Vid
,Ö_Vid->
‰ame_pic
[
rd_∑ss
], &p_Vid->
imgD©a
,Ñd_pass);

214 
£À˘i⁄
 = 
	`pi˘uª_codög_decisi⁄
(
p_Vid
,Ö_Vid->
‰ame_pic
[0],Ö_Vid->‰ame_pic[
rd_∑ss
], 
rd_qp
);

215 #i‡(
DBG_IMAGE_MP
)

216 
	`¥ötf
("rd_∑s†%d, sñe˘i⁄ = %d\n", 
rd_∑ss
, 
£À˘i⁄
);

218 #i‡(
DBG_IMAGE_MP
)

219 
	`¥ötf
("rd_∑s†%d: %d (%.0f, %.0f, %.0f)\n", 
rd_∑ss
,

220 
p_Vid
->
‰ame_pic
[
rd_∑ss
]->
bôs_≥r_pi˘uª
,

221 
p_Vid
->
‰ame_pic
[
rd_∑ss
]->
di°‹ti⁄
.
vÆue
[0],Ö_Vid->frame_pic[rd_pass]->distortion.value[1],Ö_Vid->frame_pic[rd_pass]->distortion.value[2]);

224 i‡(
£À˘i⁄
)

226 
	`sw≠_‰ame_buf„r
(
p_Vid
, 0, 
rd_∑ss
);

227 
	`°‹e_codög_™d_rc_öfo
(
p_Vid
, &
codög_öfo
);

228 
be°_mëhod
 = 
EXP_WP
;

229 
≠∂y_wp
 = 1;

234 
rd_∑ss
++;

237 if(
rd_∑ss
 >
p_I≈
->
RDPi˘uªMaxPassPSli˚
)

239 
	`‰ame_pi˘uª_mp_exô
(
p_Vid
, &
codög_öfo
);

240 
	`‰ì_¶i˚
(
dummy_¶i˚
);

244 
	`‰ì_¶i˚
(
dummy_¶i˚
);

249 
‰ame_ty≥_∑ss
 = 0;

250 if(
p_I≈
->
RDPSli˚ITe°
 && (
codög_öfo
.
öåas
 * 100/
p_Vid
->
FømeSizeInMbs
) >= 75)

252 
‰ame_ty≥
 = 
I_SLICE
;

253 
	`£t_¶i˚_ty≥
(
p_Vid
, 
p_I≈
, 
I_SLICE
);

254 
	`p›uœã_‰ame_¶i˚_ty≥
–
p_I≈
, 
p_Vid
->
p_cuº_‰m_°ru˘
, 
I_SLICE
,Ö_Vid->
p_¥ed
->
max_num_¶i˚s
 );

255 
p_Vid
->
a˘ive_µs
 =Ö_Vid->
PicP¨Së
[0];

256 
‰ame_ty≥_∑ss
 = 1;

258 i‡(
p_I≈
->
RDPSli˚BTe°
 && 
p_Vid
->
a˘ive_•s
->
¥ofûe_idc
 !
BASELINE
)

261 
‰ame_ty≥
 = 
B_SLICE
;

262 
	`£t_¶i˚_ty≥
(
p_Vid
, 
p_I≈
, 
B_SLICE
 );

263 
	`p›uœã_‰ame_¶i˚_ty≥
–
p_I≈
, 
p_Vid
->
p_cuº_‰m_°ru˘
, 
B_SLICE
,Ö_Vid->
p_¥ed
->
max_num_¶i˚s
 );

264 
p_Vid
->
a˘ive_µs
 =Ö_Vid->
PicP¨Së
[0];

265 
‰ame_ty≥_∑ss
 = 1;

268 if(
‰ame_ty≥_∑ss
)

270 
p_Vid
->
wrôe_ma¸oblock
 = 
FALSE
;

271 
p_Vid
->
p_cuº_‰m_°ru˘
->
qp
 =Ö_Vid->qp;

272 
	`‰ame_pi˘uª
 (
p_Vid
,Ö_Vid->
‰ame_pic
[
rd_∑ss
], &p_Vid->
imgD©a
,Ñd_pass);

273 
£À˘i⁄
 = 
	`pi˘uª_codög_decisi⁄
(
p_Vid
,Ö_Vid->
‰ame_pic
[0],Ö_Vid->‰ame_pic[
rd_∑ss
], 
rd_qp
);

274 #i‡(
DBG_IMAGE_MP
)

275 
	`¥ötf
("rd_∑s†%d, sñe˘i⁄ = %d\n", 
rd_∑ss
, 
£À˘i⁄
);

278 i‡(
£À˘i⁄
)

280 
	`sw≠_‰ame_buf„r
(
p_Vid
, 0, 
rd_∑ss
);

281 
	`°‹e_codög_™d_rc_öfo
(
p_Vid
, &
codög_öfo
);

282 
be°_mëhod
 = 
FRAME_TYPE
;

286 
‰ame_ty≥
 = 
P_SLICE
;

288 
rd_∑ss
++;

289 if(
rd_∑ss
 >
p_I≈
->
RDPi˘uªMaxPassPSli˚
)

291 
	`‰ame_pi˘uª_mp_exô
(
p_Vid
, &
codög_öfo
);

296 if(
p_Vid
->
EvÆu©eDBOff
)

299 
p_Vid
->
a˘ive_µs
 = (
be°_mëhod
 =
EXP_WP
?p_Vid->
PicP¨Së
[1]:p_Vid->PicParSet[0]);

300 if(
‰ame_ty≥
 !
P_SLICE
)

302 
	`£t_¶i˚_ty≥
(
p_Vid
, 
p_I≈
, 
‰ame_ty≥
);

303 
	`p›uœã_‰ame_¶i˚_ty≥
–
p_I≈
, 
p_Vid
->
p_cuº_‰m_°ru˘
, 
‰ame_ty≥
,Ö_Vid->
p_¥ed
->
max_num_¶i˚s
 );

305 
p_Vid
->
Tu∫DBOff
 = 1;

306 
p_Vid
->
wrôe_ma¸oblock
 = 
FALSE
;

307 
p_Vid
->
p_cuº_‰m_°ru˘
->
qp
 =Ö_Vid->qp;

308 
	`‰ame_pi˘uª
 (
p_Vid
,Ö_Vid->
‰ame_pic
[
rd_∑ss
], &p_Vid->
imgD©a
,Ñd_pass);

309 
£À˘i⁄
 = 
	`pi˘uª_codög_decisi⁄
(
p_Vid
,Ö_Vid->
‰ame_pic
[0],Ö_Vid->‰ame_pic[
rd_∑ss
], 
rd_qp
);

310 #i‡(
DBG_IMAGE_MP
)

311 
	`¥ötf
("DB OFF,Ñd_∑s†%d, sñe˘i⁄ = %d\n", 
rd_∑ss
, 
£À˘i⁄
);

314 i‡(
£À˘i⁄
)

316 
	`sw≠_‰ame_buf„r
(
p_Vid
, 0, 
rd_∑ss
);

317 
	`°‹e_codög_™d_rc_öfo
(
p_Vid
, &
codög_öfo
);

318 
be°_mëhod
 = 
DB_OFF
;

321 
rd_∑ss
++;

322 if(
rd_∑ss
 >
p_I≈
->
RDPi˘uªMaxPassPSli˚
)

324 
	`‰ame_pi˘uª_mp_exô
(
p_Vid
, &
codög_öfo
);

329 if(
p_I≈
->
RDPi˘uªFømeQPPSli˚
)

332 
p_Vid
->
a˘ive_µs
 = (
≠∂y_wp
?p_Vid->
PicP¨Së
[1]:p_Vid->PicParSet[0]);

333 if(
‰ame_ty≥
 !
P_SLICE
)

335 
	`£t_¶i˚_ty≥
(
p_Vid
, 
p_I≈
, 
‰ame_ty≥
);

336 
	`p›uœã_‰ame_¶i˚_ty≥
–
p_I≈
, 
p_Vid
->
p_cuº_‰m_°ru˘
, 
I_SLICE
,Ö_Vid->
p_¥ed
->
max_num_¶i˚s
 );

338 
p_Vid
->
qp
 = (p_Vid->
«l_ª„ªn˚_idc
==0 ? 
rd_qp
+1:rd_qp-1);

339 
p_Vid
->
qp
 = 
	`iClù3
–p_Vid->
RCMöQP
,Ö_Vid->
RCMaxQP
,Ö_Vid->qp );

340 i‡–
p_I≈
->
RCE«bÀ
 )

342 
øãR©io
 = 
p_Vid
->
«l_ª„ªn˚_idc
 ? 1.15F : 0.85F;

343 
	`rc_öô_‰ame_rdpic
–
p_Vid
, 
p_I≈
, 
øãR©io
 );

345 
p_Vid
->
Tu∫DBOff
 = 0;

346 
p_Vid
->
wrôe_ma¸oblock
 = 
FALSE
;

347 
p_Vid
->
p_cuº_‰m_°ru˘
->
qp
 =Ö_Vid->qp;

348 
	`‰ame_pi˘uª
 (
p_Vid
,Ö_Vid->
‰ame_pic
[
rd_∑ss
], &p_Vid->
imgD©a
,Ñd_pass);

349 
£À˘i⁄
 = 
	`pi˘uª_codög_decisi⁄
(
p_Vid
,Ö_Vid->
‰ame_pic
[0],Ö_Vid->‰ame_pic[
rd_∑ss
], 
rd_qp
);

350 #i‡(
DBG_IMAGE_MP
)

351 
	`¥ötf
("rd_∑s†%d, sñe˘i⁄ = %d\n", 
rd_∑ss
, 
£À˘i⁄
);

354 i‡(
£À˘i⁄
)

356 
	`sw≠_‰ame_buf„r
(
p_Vid
, 0, 
rd_∑ss
);

357 
	`°‹e_codög_™d_rc_öfo
(
p_Vid
, &
codög_öfo
);

358 
be°_mëhod
 = 
FRAME_QP
;

361 
rd_∑ss
++;

362 if(
rd_∑ss
 >
p_I≈
->
RDPi˘uªMaxPassPSli˚
)

364 
	`‰ame_pi˘uª_mp_exô
(
p_Vid
, &
codög_öfo
);

369 
	`‰ame_pi˘uª_mp_exô
(
p_Vid
, &
codög_öfo
);

370 
	}
}

372 
	$‰ame_pi˘uª_mp_i_¶i˚
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

374 
rd_∑ss
 = 0;

375 
qp
 = 
p_Vid
->qp;

376 
øãR©io
 = 1.0F;

377 
CodögInfo
 
codög_öfo
;

378 
£À˘i⁄
;

381 
	`‰ame_pi˘uª
 (
p_Vid
,Ö_Vid->
‰ame_pic
[
rd_∑ss
], &p_Vid->
imgD©a
,Ñd_pass);

382 
	`°‹e_codög_™d_rc_öfo
(
p_Vid
, &
codög_öfo
);

384 
rd_∑ss
++;

385 if(
rd_∑ss
 >
p_I≈
->
RDPi˘uªMaxPassISli˚
)

387 
	`‰ame_pi˘uª_mp_exô
(
p_Vid
, &
codög_öfo
);

393 
qp
 = 
p_Vid
->qp;

394 
p_Vid
->
qp
 = qp - 1;

395 
p_Vid
->
qp
 = 
	`iClù3
–p_Vid->
RCMöQP
,Ö_Vid->
RCMaxQP
,Ö_Vid->qp );

396 i‡–
p_I≈
->
RCE«bÀ
 )

398 
øãR©io
 = 1.15F;

399 
	`rc_öô_‰ame_rdpic
–
p_Vid
, 
p_I≈
, 
øãR©io
 );

402 
p_Vid
->
wrôe_ma¸oblock
 = 
FALSE
;

403 
p_Vid
->
p_cuº_‰m_°ru˘
->
qp
 =Ö_Vid->qp;

404 
	`‰ame_pi˘uª
 (
p_Vid
,Ö_Vid->
‰ame_pic
[
rd_∑ss
], &p_Vid->
imgD©a
,Ñd_pass);

405 
£À˘i⁄
 = 
	`pi˘uª_codög_decisi⁄
(
p_Vid
,Ö_Vid->
‰ame_pic
[0],Ö_Vid->‰ame_pic[
rd_∑ss
], 
qp
);

407 i‡(
£À˘i⁄
)

409 
	`sw≠_‰ame_buf„r
(
p_Vid
, 0, 
rd_∑ss
);

410 
	`°‹e_codög_™d_rc_öfo
(
p_Vid
, &
codög_öfo
);

413 
rd_∑ss
++;

414 if(
rd_∑ss
 >
p_I≈
->
RDPi˘uªMaxPassISli˚
)

416 
	`‰ame_pi˘uª_mp_exô
(
p_Vid
, &
codög_öfo
);

421 
p_Vid
->
qp
 = (qp + 1);

422 
p_Vid
->
qp
 = 
	`iClù3
–p_Vid->
RCMöQP
,Ö_Vid->
RCMaxQP
,Ö_Vid->qp );

423 
p_Vid
->
wrôe_ma¸oblock
 = 
FALSE
;

425 i‡–
p_I≈
->
RCE«bÀ
 )

427 
øãR©io
 = 1.0F;

428 
	`rc_öô_‰ame_rdpic
–
p_Vid
, 
p_I≈
, 
øãR©io
 );

431 
p_Vid
->
qp
 = 
	`iClù3
–p_Vid->
RCMöQP
,Ö_Vid->
RCMaxQP
,Ö_Vid->qp );

432 
p_Vid
->
p_cuº_‰m_°ru˘
->
qp
 =Ö_Vid->qp;

433 
	`‰ame_pi˘uª
 (
p_Vid
,Ö_Vid->
‰ame_pic
[
rd_∑ss
], &p_Vid->
imgD©a
,Ñd_pass);

434 
£À˘i⁄
 = 
	`pi˘uª_codög_decisi⁄
(
p_Vid
,Ö_Vid->
‰ame_pic
[0],Ö_Vid->‰ame_pic[
rd_∑ss
], 
qp
);

436 i‡–
£À˘i⁄
 )

438 
	`sw≠_‰ame_buf„r
(
p_Vid
, 0, 
rd_∑ss
);

439 
	`°‹e_codög_™d_rc_öfo
(
p_Vid
, &
codög_öfo
);

442 
rd_∑ss
++;

443 if(
rd_∑ss
 >
p_I≈
->
RDPi˘uªMaxPassISli˚
)

445 
	`‰ame_pi˘uª_mp_exô
(
p_Vid
, &
codög_öfo
);

450 
	`‰ame_pi˘uª_mp_exô
(
p_Vid
, &
codög_öfo
);

451 
	}
}

453 
	$‰ame_pi˘uª_mp_b_¶i˚
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

455 
rd_∑ss
 = 0;

456 
rd_qp
 = 
p_Vid
->
p_cuº_‰m_°ru˘
->
qp
;

457 
øãR©io
 = 1.0F;

458 
wp_∑ss
 = 0;

459 
CodögInfo
 
codög_öfo
;

460 
FømeCodögMëhod
 
be°_mëhod
 = 
REGULAR
;

461 
≠∂y_wp
 = 0;

462 
£À˘i⁄
;

463 
Sli˚
 *
dummy_¶i˚
 = 
NULL
;

465 #i‡(
DBG_IMAGE_MP
)

466 
	`¥ötf
("∑ss0_w∞%d\n", 
p_Vid
->
∑ss0_wp
);

469 
	`‰ame_pi˘uª
 (
p_Vid
,Ö_Vid->
‰ame_pic
[
rd_∑ss
], &p_Vid->
imgD©a
,Ñd_pass);

470 
	`°‹e_codög_™d_rc_öfo
(
p_Vid
, &
codög_öfo
);

472 if(
p_I≈
->
WPIãrMC
)

473 
p_Vid
->
‰ameOff£tAvaû
 = 1;

475 
rd_∑ss
++;

476 if(
rd_∑ss
 >
p_I≈
->
RDPi˘uªMaxPassBSli˚
)

478 
	`‰ame_pi˘uª_mp_exô
(
p_Vid
, &
codög_öfo
);

482 
	`öô_¶i˚_lôe
(
p_Vid
, &
dummy_¶i˚
, 0);

484 #i‡(
DBG_IMAGE_MP
)

485 
	`¥ötf
("rd_∑s†%d: %d (%.0f, %.0f, %.0f)\n", 
rd_∑ss
,

486 
p_Vid
->
‰ame_pic
[0]->
bôs_≥r_pi˘uª
,

487 
p_Vid
->
‰ame_pic
[0]->
di°‹ti⁄
.
vÆue
[0],Ö_Vid->frame_pic[0]->distortion.value[1],Ö_Vid->frame_pic[0]->distortion.value[2]);

491 
wp_∑ss
 = 0;

493 i‡(
p_I≈
->
Gíî©eMu…ùÀPPS
)

495 
	`InôWP
(
p_Vid
, 
p_I≈
, 0);

496 i‡–
p_I≈
->
WPMCPªcisi⁄
 )

497 
p_Vid
->
pWPX
->
cuº_wp_rd_∑ss
 =Ö_Vid->pWPX->
wp_rd_∑s£s
 + 1;

499 i‡(
p_Vid
->
	`Te°WPBSli˚
(
dummy_¶i˚
, 1) == 1)

502 
p_Vid
->
a˘ive_µs
 =Ö_Vid->
PicP¨Së
[2];

503 if(
p_I≈
->
WPMCPªcisi⁄
)

504 
p_Vid
->
pWPX
->
cuº_wp_rd_∑ss
->
Æg‹ôhm
 = 
WP_REGULAR
;

505 
wp_∑ss
 = 1;

509 if(
wp_∑ss
)

511 
p_Vid
->
wrôe_ma¸oblock
 = 
FALSE
;

512 
p_Vid
->
p_cuº_‰m_°ru˘
->
qp
 =Ö_Vid->qp;

513 
	`‰ame_pi˘uª
 (
p_Vid
,Ö_Vid->
‰ame_pic
[
rd_∑ss
], &p_Vid->
imgD©a
,Ñd_pass);

514 
£À˘i⁄
 = 
	`pi˘uª_codög_decisi⁄
(
p_Vid
,Ö_Vid->
‰ame_pic
[0],Ö_Vid->‰ame_pic[
rd_∑ss
], 
rd_qp
);

515 #i‡(
DBG_IMAGE_MP
)

516 
	`¥ötf
("IMP WP,Ñd_∑s†%d, sñe˘i⁄ = %d\n", 
rd_∑ss
, 
£À˘i⁄
);

517 
	`¥ötf
("rd_∑s†%d: %d (%.0f, %.0f, %.0f)\n", 
rd_∑ss
,

518 
p_Vid
->
‰ame_pic
[
rd_∑ss
]->
bôs_≥r_pi˘uª
,

519 
p_Vid
->
‰ame_pic
[
rd_∑ss
]->
di°‹ti⁄
.
vÆue
[0],Ö_Vid->frame_pic[rd_pass]->distortion.value[1],Ö_Vid->frame_pic[rd_pass]->distortion.value[2]);

522 i‡(
£À˘i⁄
)

524 
	`sw≠_‰ame_buf„r
(
p_Vid
, 0, 
rd_∑ss
);

525 
	`°‹e_codög_™d_rc_öfo
(
p_Vid
, &
codög_öfo
);

526 
be°_mëhod
 = 
IMP_WP
;

527 
≠∂y_wp
 = 
IMP_WP
;

530 
rd_∑ss
++;

531 if(
rd_∑ss
 >
p_I≈
->
RDPi˘uªMaxPassBSli˚
)

533 
	`‰ame_pi˘uª_mp_exô
(
p_Vid
, &
codög_öfo
);

534 
	`‰ì_¶i˚
(
dummy_¶i˚
);

540 
wp_∑ss
 = 0;

541 i‡(
p_I≈
->
Gíî©eMu…ùÀPPS
)

543 
	`InôWP
(
p_Vid
, 
p_I≈
, 0);

544 if–
p_I≈
->
WPMCPªcisi⁄
 )

545 
p_Vid
->
pWPX
->
cuº_wp_rd_∑ss
 =Ö_Vid->pWPX->
wp_rd_∑s£s
 + 1;

547 i‡(
p_Vid
->
	`Te°WPBSli˚
(
dummy_¶i˚
, 0) == 1)

550 
p_Vid
->
a˘ive_µs
 =Ö_Vid->
PicP¨Së
[1];

551 if–
p_I≈
->
WPMCPªcisi⁄
 )

552 
p_Vid
->
pWPX
->
cuº_wp_rd_∑ss
->
Æg‹ôhm
 = 
WP_REGULAR
;

553 
wp_∑ss
 = 1;

555 i‡–
p_I≈
->
WPMCPªcisi⁄
 =2 && (p_I≈->
WPMCPªcBSli˚
 =2 || (p_I≈->WPMCPªcBSli˚ =1 && 
p_Vid
->
«l_ª„ªn˚_idc
) ) )

557 
p_Vid
->
a˘ive_µs
 =Ö_Vid->
PicP¨Së
[1];

558 
wp_∑ss
 = 1;

562 if(
wp_∑ss
)

564 
p_Vid
->
wrôe_ma¸oblock
 = 
FALSE
;

565 
p_Vid
->
p_cuº_‰m_°ru˘
->
qp
 =Ö_Vid->qp;

566 
	`‰ame_pi˘uª
 (
p_Vid
,Ö_Vid->
‰ame_pic
[
rd_∑ss
], &p_Vid->
imgD©a
,Ñd_pass);

567 
£À˘i⁄
 = 
	`pi˘uª_codög_decisi⁄
(
p_Vid
,Ö_Vid->
‰ame_pic
[0],Ö_Vid->‰ame_pic[
rd_∑ss
], 
rd_qp
);

568 #i‡(
DBG_IMAGE_MP
)

569 
	`¥ötf
("EXP WP,Ñd_∑s†%d, sñe˘i⁄ = %d\n", 
rd_∑ss
, 
£À˘i⁄
);

570 
	`¥ötf
("rd_∑s†%d: %d (%.0f, %.0f, %.0f)\n", 
rd_∑ss
,

571 
p_Vid
->
‰ame_pic
[
rd_∑ss
]->
bôs_≥r_pi˘uª
,

572 
p_Vid
->
‰ame_pic
[
rd_∑ss
]->
di°‹ti⁄
.
vÆue
[0],Ö_Vid->frame_pic[rd_pass]->distortion.value[1],Ö_Vid->frame_pic[rd_pass]->distortion.value[2]);

575 i‡(
£À˘i⁄
)

577 
	`sw≠_‰ame_buf„r
(
p_Vid
, 0, 
rd_∑ss
);

578 
	`°‹e_codög_™d_rc_öfo
(
p_Vid
, &
codög_öfo
);

579 
be°_mëhod
 = 
EXP_WP
;

580 
≠∂y_wp
 = 
EXP_WP
;

583 
rd_∑ss
++;

584 if(
rd_∑ss
 >
p_I≈
->
RDPi˘uªMaxPassBSli˚
)

586 
	`‰ame_pi˘uª_mp_exô
(
p_Vid
, &
codög_öfo
);

587 
	`‰ì_¶i˚
(
dummy_¶i˚
);

593 if(
p_I≈
->
RDPi˘uªFømeQPBSli˚
)

596 
p_Vid
->
a˘ive_µs
 = 
be°_mëhod
 =
EXP_WP
 ?Ö_Vid->
PicP¨Së
[1]:be°_mëhod==
IMP_WP
?p_Vid->PicParSet[2]:p_Vid->PicParSet[0];

598 
p_Vid
->
qp
 = (p_Vid->
«l_ª„ªn˚_idc
==0 ? 
rd_qp
 + 1 :Ñd_qp );

599 
p_Vid
->
qp
 = 
	`iClù3
–p_Vid->
RCMöQP
,Ö_Vid->
RCMaxQP
,Ö_Vid->qp );

600 i‡–
p_I≈
->
RCE«bÀ
 )

602 
øãR©io
 = 
p_Vid
->
«l_ª„ªn˚_idc
 ? 1.15F : 0.85F;

603 
	`rc_öô_‰ame_rdpic
–
p_Vid
, 
p_I≈
, 
øãR©io
 );

606 
p_Vid
->
wrôe_ma¸oblock
 = 
FALSE
;

607 
p_Vid
->
p_cuº_‰m_°ru˘
->
qp
 =Ö_Vid->qp;

608 
	`‰ame_pi˘uª
 (
p_Vid
,Ö_Vid->
‰ame_pic
[
rd_∑ss
], &p_Vid->
imgD©a
,Ñd_pass);

609 
£À˘i⁄
 = 
	`pi˘uª_codög_decisi⁄
(
p_Vid
,Ö_Vid->
‰ame_pic
[0],Ö_Vid->‰ame_pic[
rd_∑ss
], 
rd_qp
);

610 #i‡(
DBG_IMAGE_MP
)

611 
	`¥ötf
("‰amêQP,Ñd_∑s†%d, sñe˘i⁄ = %d \n", 
rd_∑ss
, 
£À˘i⁄
);

612 
	`¥ötf
("rd_∑s†%d: %d (%.0f, %.0f, %.0f)\n", 
rd_∑ss
,

613 
p_Vid
->
‰ame_pic
[
rd_∑ss
]->
bôs_≥r_pi˘uª
,

614 
p_Vid
->
‰ame_pic
[
rd_∑ss
]->
di°‹ti⁄
.
vÆue
[0],Ö_Vid->frame_pic[rd_pass]->distortion.value[1],Ö_Vid->frame_pic[rd_pass]->distortion.value[2]);

617 i‡(
£À˘i⁄
)

619 
	`sw≠_‰ame_buf„r
(
p_Vid
, 0, 
rd_∑ss
);

620 
	`°‹e_codög_™d_rc_öfo
(
p_Vid
, &
codög_öfo
);

621 
be°_mëhod
 = 
FRAME_QP
;

624 
rd_∑ss
++;

625 if(
rd_∑ss
 >
p_I≈
->
RDPi˘uªMaxPassBSli˚
)

627 
	`‰ame_pi˘uª_mp_exô
(
p_Vid
, &
codög_öfo
);

628 
	`‰ì_¶i˚
(
dummy_¶i˚
);

634 if(
p_I≈
->
RDPi˘uªDúe˘Mode
)

637 
p_Vid
->
a˘ive_µs
 = 
≠∂y_wp
 =
IMP_WP
 ?Ö_Vid->
PicP¨Së
[1]:≠∂y_wp==
EXP_WP
?p_Vid->PicParSet[2]:p_Vid->PicParSet[0];

638 if(
be°_mëhod
 =
FRAME_QP
)

639 
p_Vid
->
qp
 = (p_Vid->
«l_ª„ªn˚_idc
==0 ? 
rd_qp
+1:rd_qp-1);

641 
p_Vid
->
qp
 = 
rd_qp
;

642 
p_Vid
->
qp
 = 
	`iClù3
–p_Vid->
RCMöQP
,Ö_Vid->
RCMaxQP
,Ö_Vid->qp );

644 
p_Vid
->
dúe˘_•©ül_mv_¥ed_Êag
 = 1-p_Vid->direct_spatial_mv_pred_flag;

645 
p_Vid
->
wrôe_ma¸oblock
 = 
FALSE
;

646 
p_Vid
->
p_cuº_‰m_°ru˘
->
qp
 =Ö_Vid->qp;

647 
	`‰ame_pi˘uª
 (
p_Vid
,Ö_Vid->
‰ame_pic
[
rd_∑ss
], &p_Vid->
imgD©a
,Ñd_pass);

648 
£À˘i⁄
 = 
	`pi˘uª_codög_decisi⁄
(
p_Vid
,Ö_Vid->
‰ame_pic
[0],Ö_Vid->‰ame_pic[
rd_∑ss
], 
rd_qp
);

649 #i‡(
DBG_IMAGE_MP
)

650 
	`¥ötf
("Æã∫©êdúe˘ mode,Ñd_∑s†%d, sñe˘i⁄ = %d\n", 
rd_∑ss
, 
£À˘i⁄
);

653 i‡(
£À˘i⁄
)

655 
	`sw≠_‰ame_buf„r
(
p_Vid
, 0, 
rd_∑ss
);

656 
	`°‹e_codög_™d_rc_öfo
(
p_Vid
, &
codög_öfo
);

657 
be°_mëhod
 = 
ALT_DIRECT
;

660 
rd_∑ss
++;

661 if(
rd_∑ss
 >
p_I≈
->
RDPi˘uªMaxPassBSli˚
)

663 
	`‰ame_pi˘uª_mp_exô
(
p_Vid
, &
codög_öfo
);

664 
	`‰ì_¶i˚
(
dummy_¶i˚
);

668 
	`‰ame_pi˘uª_mp_exô
(
p_Vid
, &
codög_öfo
);

669 
	`‰ì_¶i˚
(
dummy_¶i˚
);

671 
	}
}

673 
	$‰ame_pi˘uª_mp
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

675 
p_Vid
->
EvÆu©eDBOff
 = 0;

676 
p_Vid
->
Tu∫DBOff
 = 0;

677 if(
p_Vid
->
ty≥
 =
I_SLICE
)

679 
	`‰ame_pi˘uª_mp_i_¶i˚
(
p_Vid
, 
p_I≈
);

681 if(
p_Vid
->
ty≥
 =
P_SLICE
)

683 
	`‰ame_pi˘uª_mp_p_¶i˚
(
p_Vid
, 
p_I≈
);

685 if(
p_Vid
->
ty≥
 =
B_SLICE
)

687 
	`‰ame_pi˘uª_mp_b_¶i˚
(
p_Vid
, 
p_I≈
);

689 
p_Vid
->
rd_∑ss
 = 0;

690 
	}
}

	@lencod/src/img_chroma.c

17 
	~"c⁄åibut‹s.h
"

19 
	~<limôs.h
>

21 
	~"globÆ.h
"

22 
	~"image.h
"

23 
	~"img_chroma.h
"

26 
	$gíî©eChroma00
–
VideoP¨amëîs
 *
p_Vid
, 
size_x_möus1
, 
size_y_möus1
, 
img≥l
 **
wImgD°
, img≥»**
imgUV
)

28 
i
;

29 
j∑d
 = -
p_Vid
->
∑d_size_uv_y
;

30 
img≥l
 *
wBufD°
;

31 
img≥l
 *
wBufSrc0
;

33 
wBufD°
 = 
wImgD°
[
j∑d
++]-
p_Vid
->
∑d_size_uv_x
;

34 
wBufSrc0
 = 
imgUV
[0];

36 
i
 = -
p_Vid
->
∑d_size_uv_x
; i < 0; i++)

38 *
wBufD°
++ = *
wBufSrc0
;

41 
	`mem˝y
(
wBufD°
, 
wBufSrc0
, 
size_x_möus1
 * (
img≥l
));

42 
wBufD°
 +
size_x_möus1
;

43 
wBufSrc0
 +
size_x_möus1
;

45 
i
 = -1; i < 
p_Vid
->
∑d_size_uv_x
; i++)

47 *
wBufD°
++ = *
wBufSrc0
;

50 ; 
j∑d
 < 0; jpad++)

52 
	`mem˝y
(
wImgD°
[
j∑d
]-
p_Vid
->
∑d_size_uv_x
, wImgD°[j∑d - 1]-p_Vid->∑d_size_uv_x, (2 *Ö_Vid->∑d_size_uv_x + 
size_x_möus1
+1Ë* (
img≥l
));

55 
j∑d
 = 0; j∑d < 
size_y_möus1
+1; jpad++)

57 
wBufD°
 = 
wImgD°
[
j∑d
]-
p_Vid
->
∑d_size_uv_x
;

58 
wBufSrc0
 = 
imgUV
[
j∑d
];

60 
i
 = -
p_Vid
->
∑d_size_uv_x
; i < 0; i++)

62 *
wBufD°
++ = *
wBufSrc0
;

66 
wBufD°
 +
size_x_möus1
+1;

67 
wBufSrc0
 +
size_x_möus1
;

69 
i
 = 0; i < 
p_Vid
->
∑d_size_uv_x
; i++)

71 *
wBufD°
++ = *
wBufSrc0
;

75 
j∑d
 = 
size_y_möus1
+1; j∑d < size_y_möus1+1+
p_Vid
->
∑d_size_uv_y
; jpad++)

77 
	`mem˝y
(
wImgD°
[
j∑d
]-
p_Vid
->
∑d_size_uv_x
, wImgD°[j∑d - 1]-p_Vid->∑d_size_uv_x, (2 *Ö_Vid->∑d_size_uv_x + 
size_x_möus1
+1Ë* (
img≥l
));

79 
	}
}

87 
	$gíî©eChroma01
–
VideoP¨amëîs
 *
p_Vid
, 
size_x_möus1
, 
size_y_möus1
, 
weight00
, 
weight01
, 
img≥l
 **
wImgD°
, img≥»**
imgUV
)

89 
i
;

90 
j∑d
 = -
p_Vid
->
∑d_size_uv_y
;

91 
cur_vÆue
;

92 
img≥l
 *
wBufD°
;

93 
img≥l
 *
wBufSrc0
;

95 
wBufD°
 = 
wImgD°
[
j∑d
++]-
p_Vid
->
∑d_size_uv_x
;

96 
wBufSrc0
 = 
imgUV
[0];

98 
i
 = -
p_Vid
->
∑d_size_uv_x
; i < 0; i++)

100 *(
wBufD°
++Ë*
wBufSrc0
;

103 
i
 = 0; i < 
size_x_möus1
; i++)

105 
cur_vÆue
 = 
weight00
 * (*
wBufSrc0
++);

106 
cur_vÆue
 +
weight01
 * (*
wBufSrc0
 );

107 *(
wBufD°
++Ë(
img≥l
Ë
	`rshi·_∫d_sf
(
cur_vÆue
, 6);

110 
i
 = -1; i < 
p_Vid
->
∑d_size_uv_x
; i++)

112 *(
wBufD°
++Ë*
wBufSrc0
;

115 ; 
j∑d
 < 1; jpad++)

117 
	`mem˝y
(
wImgD°
[
j∑d
]-
p_Vid
->
∑d_size_uv_x
, wImgD°[j∑d - 1]-p_Vid->∑d_size_uv_x, (2 *Ö_Vid->∑d_size_uv_x + 
size_x_möus1
+1Ë* (
img≥l
));

120 
j∑d
 = 1; j∑d < 
size_y_möus1
+1; jpad++)

122 
wBufD°
 = 
wImgD°
[
j∑d
]-
p_Vid
->
∑d_size_uv_x
;

123 
wBufSrc0
 = 
imgUV
[
j∑d
];

125 
i
 = -
p_Vid
->
∑d_size_uv_x
; i < 0; i++)

127 *(
wBufD°
++Ë*
wBufSrc0
;

130 
i
 = 0; i < 
size_x_möus1
; i++)

132 
cur_vÆue
 = 
weight00
 * (*
wBufSrc0
++);

133 
cur_vÆue
 +
weight01
 * (*
wBufSrc0
 );

134 *(
wBufD°
++Ë(
img≥l
Ë
	`rshi·_∫d_sf
(
cur_vÆue
, 6);

137 
i
 = -1; i < 
p_Vid
->
∑d_size_uv_x
; i++)

139 *(
wBufD°
++Ë*
wBufSrc0
;

143 
j∑d
 = 
size_y_möus1
+1; j∑d < size_y_möus1+1+
p_Vid
->
∑d_size_uv_y
; jpad++)

145 
	`mem˝y
(
wImgD°
[
j∑d
]-
p_Vid
->
∑d_size_uv_x
, wImgD°[j∑d - 1]-p_Vid->∑d_size_uv_x, (2 *Ö_Vid->∑d_size_uv_x + 
size_x_möus1
+1Ë* (
img≥l
));

147 
	}
}

155 
	$gíî©eChroma10
(
VideoP¨amëîs
 *
p_Vid
, 
size_x_möus1
, 
size_y_möus1
, 
weight00
, 
weight10
, 
img≥l
 **
wImgD°
, img≥»**
imgUV
)

157 
i
;

158 
j∑d
 = -
p_Vid
->
∑d_size_uv_y
;

159 
cur_vÆue
;

160 
img≥l
 *
wBufD°
;

161 
img≥l
 *
wBufSrc0
, *
wBufSrc1
;

163 
wBufD°
 = 
wImgD°
[
j∑d
++]-
p_Vid
->
∑d_size_uv_x
;

164 
wBufSrc0
 = 
imgUV
[0];

167 
i
 = -
p_Vid
->
∑d_size_uv_x
; i < 0; i++)

169 *(
wBufD°
++Ë*
wBufSrc0
;

172 
	`mem˝y
(
wBufD°
, 
wBufSrc0
, 
size_x_möus1
 * (
img≥l
));

173 
wBufD°
 +
size_x_möus1
;

174 
wBufSrc0
 +
size_x_möus1
;

176 
i
 = -1; i < 
p_Vid
->
∑d_size_uv_x
; i++)

178 *(
wBufD°
++Ë*
wBufSrc0
;

181 ;
j∑d
 < 0; jpad++)

183 
	`mem˝y
(
wImgD°
[
j∑d
]-
p_Vid
->
∑d_size_uv_x
, wImgD°[j∑d - 1]-p_Vid->∑d_size_uv_x, (2 *Ö_Vid->∑d_size_uv_x + 
size_x_möus1
+1Ë* (
img≥l
));

186 
j∑d
 = 0; j∑d < 
size_y_möus1
; jpad++)

188 
wBufD°
 = 
wImgD°
[
j∑d
]-
p_Vid
->
∑d_size_uv_x
;

189 
wBufSrc0
 = 
imgUV
[
j∑d
];

190 
wBufSrc1
 = 
imgUV
[
j∑d
+1];

192 
cur_vÆue
 = 
	`rshi·_∫d_sf
(
weight00
 * (*
wBufSrc0
Ë+ 
weight10
 * (*
wBufSrc1
), 6 );

193 
i
 = -
p_Vid
->
∑d_size_uv_x
; i < 0; i++)

195 *(
wBufD°
++Ë(
img≥l
Ë
cur_vÆue
;

198 
i
 = 0; i < 
size_x_möus1
; i++)

200 
cur_vÆue
 = 
weight00
 * (*
wBufSrc0
++Ë+ 
weight10
 * (*
wBufSrc1
++);

201 *(
wBufD°
++Ë(
img≥l
Ë
	`rshi·_∫d_sf
(
cur_vÆue
, 6);

204 
cur_vÆue
 = 
	`rshi·_∫d_sf
(
weight00
 * (*
wBufSrc0
Ë+ 
weight10
 * (*
wBufSrc1
), 6 );

205 
i
 = -1; i < 
p_Vid
->
∑d_size_uv_x
; i++)

207 *(
wBufD°
++Ë(
img≥l
Ë
cur_vÆue
;

211 
wBufD°
 = 
wImgD°
[
j∑d
]-
p_Vid
->
∑d_size_uv_x
;

212 
wBufSrc0
 = 
imgUV
[
size_y_möus1
];

214 
i
 = -
p_Vid
->
∑d_size_uv_x
; i < 0; i++)

216 *(
wBufD°
++Ë*
wBufSrc0
;

219 
	`mem˝y
(
wBufD°
, 
wBufSrc0
, 
size_x_möus1
 * (
img≥l
));

220 
wBufD°
 +
size_x_möus1
;

221 
wBufSrc0
 +
size_x_möus1
;

223 
i
 = -1; i < 
p_Vid
->
∑d_size_uv_x
; i++)

225 *(
wBufD°
++Ë*
wBufSrc0
;

228 
j∑d
 = 
size_y_möus1
+1; j∑d < size_y_möus1+1+
p_Vid
->
∑d_size_uv_y
; jpad++)

230 
	`mem˝y
(
wImgD°
[
j∑d
]-
p_Vid
->
∑d_size_uv_x
, wImgD°[j∑d - 1]-p_Vid->∑d_size_uv_x, (2 *Ö_Vid->∑d_size_uv_x + 
size_x_möus1
+1Ë* (
img≥l
));

232 
	}
}

240 
	$gíî©eChromaXX
–
VideoP¨amëîs
 *
p_Vid
, 
size_x_möus1
, 
size_y_möus1
, 
weight00
, 
weight01
, 
weight10
, 
weight11
, 
img≥l
 **
wImgD°
, img≥»**
imgUV
)

242 
i
;

243 
j∑d
 = -
p_Vid
->
∑d_size_uv_y
;

244 
cur_vÆue
;

245 
img≥l
 *
wBufD°
;

246 
img≥l
 *
wBufSrc0
, *
wBufSrc1
;

247 
weight0001
 = 
weight00
 + 
weight01
;

248 
weight1011
 = 
weight10
 + 
weight11
;

249 
weight0010
 = 
weight00
 + 
weight10
;

250 
weight0111
 = 
weight01
 + 
weight11
;

252 
wBufD°
 = 
wImgD°
[
j∑d
++]-
p_Vid
->
∑d_size_uv_x
;

253 
wBufSrc0
 = 
imgUV
[0];

255 
i
 = -
p_Vid
->
∑d_size_uv_x
; i < 0; i++)

257 *(
wBufD°
++Ë*
wBufSrc0
;

260 
i
 = 0; i < 
size_x_möus1
; i++)

262 
cur_vÆue
 = 
weight0010
 * (*
wBufSrc0
++);

263 
cur_vÆue
 +
weight0111
 * (*
wBufSrc0
 );

264 *(
wBufD°
++Ë(
img≥l
Ë
	`rshi·_∫d_sf
(
cur_vÆue
, 6);

267 
i
 = -1; i < 
p_Vid
->
∑d_size_uv_x
; i++)

269 *(
wBufD°
++Ë*
wBufSrc0
;

272 ; 
j∑d
 < 0; jpad++)

274 
	`mem˝y
(
wImgD°
[
j∑d
]-
p_Vid
->
∑d_size_uv_x
, wImgD°[j∑d - 1]-p_Vid->∑d_size_uv_x, (2 *Ö_Vid->∑d_size_uv_x + 
size_x_möus1
+1Ë* (
img≥l
));

277 
j∑d
 = 0; j∑d < 
size_y_möus1
; jpad++)

279 
wBufD°
 = 
wImgD°
[
j∑d
]-
p_Vid
->
∑d_size_uv_x
;

280 
wBufSrc0
 = 
imgUV
[
j∑d
];

281 
wBufSrc1
 = 
imgUV
[
j∑d
 + 1];

283 
cur_vÆue
 = 
	`rshi·_∫d_sf
(
weight0001
 * (*
wBufSrc0
Ë+ 
weight1011
 * (*
wBufSrc1
), 6 );

284 
i
 = -
p_Vid
->
∑d_size_uv_x
; i < 0; i++)

286 *(
wBufD°
++Ë(
img≥l
Ë
cur_vÆue
;

289 
i
 = 0; i < 
size_x_möus1
; i++)

291 
cur_vÆue
 = 
weight00
 * (*
wBufSrc0
++Ë+ 
weight10
 * (*
wBufSrc1
++);

292 
cur_vÆue
 +
weight01
 * (*
wBufSrc0
 ) + 
weight11
 * (*
wBufSrc1
 );

293 *(
wBufD°
++Ë(
img≥l
Ë
	`rshi·_∫d_sf
(
cur_vÆue
, 6);

296 
cur_vÆue
 = 
	`rshi·_∫d_sf
(
weight0001
 * (*
wBufSrc0
Ë+ 
weight1011
 * (*
wBufSrc1
), 6 );

297 
i
 = -1; i < 
p_Vid
->
∑d_size_uv_x
; i++)

299 *(
wBufD°
++Ë(
img≥l
Ë
cur_vÆue
;

303 
wBufD°
 = 
wImgD°
[
j∑d
]-
p_Vid
->
∑d_size_uv_x
;

304 
wBufSrc0
 = 
imgUV
[
size_y_möus1
];

306 
i
 = -
p_Vid
->
∑d_size_uv_x
; i < 0; i++)

308 *(
wBufD°
++Ë*
wBufSrc0
;

311 
i
 = 0; i < 
size_x_möus1
; i++)

313 
cur_vÆue
 = 
weight0010
 * (*
wBufSrc0
++);

314 
cur_vÆue
 +
weight0111
 * (*
wBufSrc0
 );

315 *(
wBufD°
++Ë(
img≥l
Ë
	`rshi·_∫d_sf
(
cur_vÆue
, 6);

318 
i
 = -1; i < 
p_Vid
->
∑d_size_uv_x
; i++)

320 *(
wBufD°
++Ë*
wBufSrc0
;

323 
j∑d
 = 
size_y_möus1
+1; j∑d < size_y_möus1+1+
p_Vid
->
∑d_size_uv_y
; jpad++)

325 
	`mem˝y
(
wImgD°
[
j∑d
]-
p_Vid
->
∑d_size_uv_x
, wImgD°[j∑d - 1]-p_Vid->∑d_size_uv_x, (2 *Ö_Vid->∑d_size_uv_x + 
size_x_möus1
+1Ë* (
img≥l
));

327 
	}
}

338 
	$gëSubImagesChroma
–
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
s
 )

340 
uv
, 
k
, 
l
, 
m
;

341 
weight00
, 
weight01
, 
weight10
, 
weight11
;

342 
subimages_y
, 
subimages_x
, 
subx
, 
suby
;

343 
size_x_möus1
, 
size_y_möus1
;

344 
img≥l
 ****
cuº_img_sub
;

345 
img≥l
 **
cuº_img
;

348 
mul_x
, 
mul_y
;

349 
mm
, 
kk
;

351 
size_x_möus1
 = 
s
->
size_x_¸
 - 1;

352 
size_y_möus1
 = 
s
->
size_y_¸
 - 1;

354 if–
p_Vid
->
p_I≈
->
OnTheFlyFø˘MCP
 =
OTF_L1
 )

356 i‡–
p_Vid
->
yuv_f‹m©
 =
YUV420
 )

358 
subimages_x
 = 4;

359 
subimages_y
 = 4;

360 
mul_x
 = 
mul_y
 = 2;

362 i‡–
p_Vid
->
yuv_f‹m©
 =
YUV422
 )

364 
subimages_x
 = 4;

365 
subimages_y
 = 2;

366 
mul_y
 = 4;

367 
mul_x
 = 2;

371 
subimages_x
 = 2;

372 
subimages_y
 = 2;

373 
mul_x
 = 
mul_y
 = 4;

378 i‡–
p_Vid
->
yuv_f‹m©
 =
YUV420
 )

380 
subimages_x
 = 8;

381 
subimages_y
 = 8;

382 
mul_x
 = 
mul_y
 = 1;

384 i‡–
p_Vid
->
yuv_f‹m©
 =
YUV422
 )

386 
subimages_x
 = 8;

387 
subimages_y
 = 4;

388 
mul_y
 = 2;

389 
mul_x
 = 1;

393 
subimages_x
 = 4;

394 
subimages_y
 = 4;

395 
mul_x
 = 
mul_y
 = 2;

400  
uv
 = 0; uv < 2; uv++ )

402 
cuº_img
 = 
s
->
imgUV
[
uv
];

403 
cuº_img_sub
 = 
s
->
p_img_sub
[
uv
 + 1];

405  
suby
 = 0, 
k
 = 0; suby < 
subimages_y
; suby++, k +
mul_y
 )

407 
m
 = (8 - 
k
);

408 
mm
 = 
m
 << 3;

409 
kk
 = 
k
 << 3;

410  
subx
 = 0, 
l
 = 0; subx < 
subimages_x
; subx++,Ü +
mul_x
 )

412 
weight01
 = 
m
 * 
l
;

413 
weight00
 = 
mm
 - 
weight01
;

414 
weight11
 = 
k
 * 
l
;

415 
weight10
 = 
kk
 - 
weight11
;

418 i‡(
weight01
 =0 && 
weight10
 =0 && 
weight11
 == 0)

420 
	`gíî©eChroma00
–
p_Vid
, 
size_x_möus1
, 
size_y_möus1
, 
cuº_img_sub
[
suby
][
subx
], 
cuº_img
);

422 i‡(
weight10
 =0 && 
weight11
 == 0)

424 
	`gíî©eChroma01
–
p_Vid
, 
size_x_möus1
, 
size_y_möus1
, 
weight00
, 
weight01
, 
cuº_img_sub
[
suby
][
subx
], 
cuº_img
);

426 i‡(
weight01
 =0 && 
weight11
 == 0)

428 
	`gíî©eChroma10
–
p_Vid
, 
size_x_möus1
, 
size_y_möus1
, 
weight00
, 
weight10
, 
cuº_img_sub
[
suby
][
subx
], 
cuº_img
);

432 
	`gíî©eChromaXX
–
p_Vid
, 
size_x_möus1
, 
size_y_möus1
, 
weight00
, 
weight01
, 
weight10
, 
weight11
, 
cuº_img_sub
[
suby
][
subx
], 
cuº_img
);

437 
	}
}

	@lencod/src/img_dist_ms_ssim.c

17 
	~"c⁄åibut‹s.h
"

18 
	~"globÆ.h
"

19 
	~"img_di°‹ti⁄.h
"

20 
	~"íc_°©i°ics.h
"

21 
	~"memÆloc.h
"

22 
	~"m©h.h
"

24 #i‚de‡
UNBIASED_VARIANCE


25 
	#UNBIASED_VARIANCE


27 

	)

28 
	#MS_SSIM_PAD
 6

	)

29 
	#MS_SSIM_PAD2
 3

	)

31 
	#MS_SSIM_BETA0
 0.0448

	)

32 
	#MS_SSIM_BETA1
 0.2856

	)

33 
	#MS_SSIM_BETA2
 0.3001

	)

34 
	#MS_SSIM_BETA3
 0.2363

	)

35 
	#MS_SSIM_BETA4
 0.1333

	)

37 
	#MAX_SSIM_LEVELS
 5

	)

40 
	$compuã_°ru˘uøl_comp⁄íts
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
img≥l
 **
ªfImg
, img≥»**
ícImg
, 
height
, 
width
, 
wö_height
, 
wö_width
, 
comp
)

42 c⁄° 
K2
 = 0.03f;

43 
max_pix_vÆue_sqd
;

44 
C2
;

45 
wö_pixñs
 = (Ë(
wö_width
 * 
wö_height
);

46 #ifde‡
UNBIASED_VARIANCE


47 
wö_pixñs_büs
 = 
wö_pixñs
 - 1;

49 
wö_pixñs_büs
 = 
wö_pixñs
;

51 
mb_ssim
, 
mónOrg
, 
mónEnc
;

52 
v¨Org
, 
v¨Enc
, 
covOrgEnc
;

53 
imónOrg
, 
imónEnc
, 
iv¨Org
, 
iv¨Enc
, 
icovOrgEnc
;

54 
cur_di°‹ti⁄
 = 0.0;

55 
i
, 
j
, 
n
, 
m
, 
wö_˙t
 = 0;

56 
ovîœpSize
 = 
p_I≈
->
SSIMOvîœpSize
;

58 
max_pix_vÆue_sqd
 = (Ë(
p_Vid
->
max_≥l_vÆue_comp
[
comp
] *Ö_Vid->max_pel_value_comp[comp]);

59 
C2
 = 
K2
 * K2 * 
max_pix_vÆue_sqd
;

61 
j
 = 0; j <
height
 - 
wö_height
; j +
ovîœpSize
)

63 
i
 = 0; i <
width
 - 
wö_width
; i +
ovîœpSize
)

65 
imónOrg
 = 0;

66 
imónEnc
 = 0;

67 
iv¨Org
 = 0;

68 
iv¨Enc
 = 0;

69 
icovOrgEnc
 = 0;

71  
n
 = 
j
;¿< j + 
wö_height
;n ++)

73 
m
 = 
i
;m < i + 
wö_width
;m ++)

75 
imónOrg
 +
ªfImg
[
n
][
m
];

76 
imónEnc
 +
ícImg
[
n
][
m
];

77 
iv¨Org
 +
ªfImg
[
n
][
m
] *ÑefImg[n][m];

78 
iv¨Enc
 +
ícImg
[
n
][
m
] *ÉncImg[n][m];

79 
icovOrgEnc
 +
ªfImg
[
n
][
m
] * 
ícImg
[n][m];

83 
mónOrg
 = (Ë
imónOrg
 / 
wö_pixñs
;

84 
mónEnc
 = (Ë
imónEnc
 / 
wö_pixñs
;

86 
v¨Org
 = ((Ë
iv¨Org
 - ((Ë
imónOrg
Ë* 
mónOrg
Ë/ 
wö_pixñs_büs
;

87 
v¨Enc
 = ((Ë
iv¨Enc
 - ((Ë
imónEnc
Ë* 
mónEnc
Ë/ 
wö_pixñs_büs
;

88 
covOrgEnc
 = ((Ë
icovOrgEnc
 - ((Ë
imónOrg
Ë* 
mónEnc
Ë/ 
wö_pixñs_büs
;

90 
mb_ssim
 = (Ë(2.0 * 
covOrgEnc
 + 
C2
);

91 
mb_ssim
 /(Ë(
v¨Org
 + 
v¨Enc
 + 
C2
);

93 
cur_di°‹ti⁄
 +
mb_ssim
;

94 
wö_˙t
++;

98 
cur_di°‹ti⁄
 /(Ë
wö_˙t
;

100 i‡(
cur_di°‹ti⁄
 >= 1.0 && cur_distortion < 1.01)

101 
cur_di°‹ti⁄
 = 1.0;

103  
cur_di°‹ti⁄
;

104 
	}
}

106 
	$compuã_lumö™˚_comp⁄ít
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
img≥l
 **
ªfImg
, img≥»**
ícImg
, 
height
, 
width
, 
wö_height
, 
wö_width
, 
comp
)

108 c⁄° 
K1
 = 0.01f;

109 
max_pix_vÆue_sqd
;

110 
C1
;

111 
wö_pixñs
 = (Ë(
wö_width
 * 
wö_height
);

112 
mb_ssim
, 
mónOrg
, 
mónEnc
;

113 
imónOrg
, 
imónEnc
;

114 
cur_di°‹ti⁄
 = 0.0;

115 
i
, 
j
, 
n
, 
m
, 
wö_˙t
 = 0;

116 
ovîœpSize
 = 
p_I≈
->
SSIMOvîœpSize
;

118 
max_pix_vÆue_sqd
 = (Ë(
p_Vid
->
max_≥l_vÆue_comp
[
comp
] *Ö_Vid->max_pel_value_comp[comp]);

119 
C1
 = 
K1
 * K1 * 
max_pix_vÆue_sqd
;

121 
j
 = 0; j <
height
 - 
wö_height
; j +
ovîœpSize
)

123 
i
 = 0; i <
width
 - 
wö_width
; i +
ovîœpSize
)

125 
imónOrg
 = 0;

126 
imónEnc
 = 0;

128  
n
 = 
j
;¿< j + 
wö_height
;n ++)

130 
m
 = 
i
;m < i + 
wö_width
;m ++)

132 
imónOrg
 +
ªfImg
[
n
][
m
];

133 
imónEnc
 +
ícImg
[
n
][
m
];

137 
mónOrg
 = (Ë
imónOrg
 / 
wö_pixñs
;

138 
mónEnc
 = (Ë
imónEnc
 / 
wö_pixñs
;

140 
mb_ssim
 = (Ë(2.0 * 
mónOrg
 * 
mónEnc
 + 
C1
);

141 
mb_ssim
 /(Ë(
mónOrg
 * mónOrg + 
mónEnc
 * mónEn¯+ 
C1
);

143 
cur_di°‹ti⁄
 +
mb_ssim
;

144 
wö_˙t
++;

148 
cur_di°‹ti⁄
 /(Ë
wö_˙t
;

150 i‡(
cur_di°‹ti⁄
 >= 1.0 && cur_distortion < 1.01)

151 
cur_di°‹ti⁄
 = 1.0;

153  
cur_di°‹ti⁄
;

154 
	}
}

156 
	$h‹iz⁄èl_symmëric_exãnsi⁄
(**
buf„r
, 
width
, 
height
 )

158 
j
;

159 * 
buf
;

161 
height_∂us_∑d2
 = 
height
 + 
MS_SSIM_PAD2
;

162 
width_∂us_∑d2_möus_⁄e
 = 
width
 + 
MS_SSIM_PAD2
 - 1;

165 
j
 = 
MS_SSIM_PAD2
; j < 
height_∂us_∑d2
; j++ ) {

167 
buf
 = &
buf„r
[
j
][
MS_SSIM_PAD2
];

168 
buf
[-1] = buf[1];

169 
buf
[-2] = buf[2];

172 
buf
 = &
buf„r
[
j
][
width_∂us_∑d2_möus_⁄e
];

173 
buf
[1] = buf[-1];

174 
buf
[2] = buf[-2];

175 
buf
[3] = buf[-3];

177 
	}
}

179 
	$vîtiˇl_symmëric_exãnsi⁄
(**
buf„r
, 
width
, 
height
)

181 
i
;

183 *
bufmöus1
 = &
buf„r
[
MS_SSIM_PAD2
-1][MS_SSIM_PAD2];

184 *
bufmöus2
 = &
buf„r
[
MS_SSIM_PAD2
-2][MS_SSIM_PAD2];

185 *
buÂlus1
 = &
buf„r
[
MS_SSIM_PAD2
+1][MS_SSIM_PAD2];

186 *
buÂlus2
 = &
buf„r
[
MS_SSIM_PAD2
+2][MS_SSIM_PAD2];

188 *
bufhmöus1
 = &
buf„r
[
height
 + 
MS_SSIM_PAD2
-2][MS_SSIM_PAD2];

189 *
bufhmöus2
 = &
buf„r
[
height
 + 
MS_SSIM_PAD2
-3][MS_SSIM_PAD2];

190 *
bufhmöus3
 = &
buf„r
[
height
 + 
MS_SSIM_PAD2
-4][MS_SSIM_PAD2];

191 *
bufh∂us1
 = &
buf„r
[
height
 + 
MS_SSIM_PAD2
][MS_SSIM_PAD2];

192 *
bufh∂us2
 = &
buf„r
[
height
 + 
MS_SSIM_PAD2
+1][MS_SSIM_PAD2];

193 *
bufh∂us3
 = &
buf„r
[
height
 + 
MS_SSIM_PAD2
+2][MS_SSIM_PAD2];

195 
i
 = 0; i < 
width
; i++)

198 
bufmöus1
[
i
] = 
buÂlus1
[i];

199 
bufmöus2
[
i
] = 
buÂlus2
[i];

201 
bufh∂us1
[
i
] = 
bufhmöus1
[i];

202 
bufh∂us2
[
i
] = 
bufhmöus2
[i];

203 
bufh∂us3
[
i
] = 
bufhmöus3
[i];

205 
	}
}

207 
	$img≥l_to_∑dded_öt
(
img≥l
** 
§c
, **
buf„r
, 
width
, 
height
)

209 
i
, 
j
;

210 * 
tmpD°
;

211 
img≥l
* 
tmpSrc
;

213 
tmpD°
 = 
buf„r
[
MS_SSIM_PAD2
];

214 
j
 = 0; j < 
height
; j++)

216 
tmpSrc
 = 
§c
[
j
];

217 
tmpD°
 = &
buf„r
[
j
 + 
MS_SSIM_PAD2
][MS_SSIM_PAD2];

218 
i
 = 0; i < 
width
; i++)

220 
tmpD°
[
i
] = ()
tmpSrc
[i];

223 
	}
}

225 
	$downßm∂e
(
img≥l
** 
§c
, img≥l** 
out
, 
height
, 
width
)

227 
height2
 = 
height
 >> 1;

228 
width2
 = 
width
 >> 1;

229 
i
, 
j
;

230 
ii
, 
jj
;

231 
iD°
;

232 
tmp
, 
tmp1
, 
tmp2
;

233 * 
tmpD°
;

234 * 
tmpSrc
;

236 ** 
ôemp
;

237 ** 
de°
;

239 
	`gë_mem2Döt
(&
ôemp
, 
height
 + 
MS_SSIM_PAD
, 
width
 + MS_SSIM_PAD);

240 
	`gë_mem2Döt
(&
de°
, 
height
 + 
MS_SSIM_PAD
, 
width2
 + MS_SSIM_PAD);

242 
	`img≥l_to_∑dded_öt
(
§c
, 
ôemp
, 
width
, 
height
);

243 
	`h‹iz⁄èl_symmëric_exãnsi⁄
(
ôemp
, 
width
, 
height
);

245 
j
 = 0; j < 
height
; j++)

247 
tmpD°
 = 
de°
[
j
+
MS_SSIM_PAD2
];

248 
tmpSrc
 = 
ôemp
[
j
+
MS_SSIM_PAD2
];

249 
iD°
 = 
MS_SSIM_PAD2
;

250 
i
 = 0; i < 
width2
; i++, 
iD°
++)

252 
ii
 = (
i
 << 1Ë+ 
MS_SSIM_PAD2
;

253 
tmp1
 = 
tmpSrc
[
ii
-1] +ÅmpSrc[ii+2];

254 
tmp2
 = 
tmpSrc
[
ii
] +ÅmpSrc[ii+1];

255 
tmpD°
[
iD°
] = 
tmpSrc
[
ii
-2] +ÅmpSrc[ii+3] + (
tmp1
 << 1Ë+Åmp1 + (
tmp2
 << 5) - (tmp2 << 2);

256 
tmpD°
[
iD°
] >>= 6;

261 
	`vîtiˇl_symmëric_exãnsi⁄
(
de°
, 
width2
, 
height
);

263 
i
 = 0; i < 
width2
; i++)

265 
ii
 = 
i
 + 
MS_SSIM_PAD2
;

266 
j
 = 0; j < 
height2
; j++)

268 
jj
 = (
j
 << 1Ë+ 
MS_SSIM_PAD2
;

269 
tmp1
 = 
de°
[
jj
-1][
ii
] + dest[jj+2][ii];

270 
tmp2
 = 
de°
[
jj
][
ii
] + dest[jj+1][ii];

271 
tmp
 = 
de°
[
jj
-2][
ii
] + de°[jj+3][ii] + (
tmp1
 << 1Ë+Åmp1 + (
tmp2
 << 5) - (tmp2 << 2);

272 
out
[
j
][
i
] = (Ë(
tmp
 >> 6);

275 
	`‰ì_mem2Döt
(
ôemp
);

276 
	`‰ì_mem2Döt
(
de°
);

277 
	}
}

279 
	$compuã_ms_ssim
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
img≥l
 **
ªfImg
, img≥»**
ícImg
, 
height
, 
width
, 
wö_height
, 
wö_width
, 
comp
)

281 
°ru˘uøl
[
MAX_SSIM_LEVELS
];

282 
cur_di°‹ti⁄
;

283 
lumö™˚
;

284 
img≥l
** 
dsRef
;

285 
img≥l
** 
dsEnc
;

286 
m
;

287 c⁄° 
max_ssim_Àvñs_möus_⁄e
 = 
MAX_SSIM_LEVELS
 - 1;

288 c⁄° 
exp⁄ít
[5] = {()
MS_SSIM_BETA0
, ()
MS_SSIM_BETA1
, ()
MS_SSIM_BETA2
, ()
MS_SSIM_BETA3
, ()
MS_SSIM_BETA4
};

290 
dsRef
 = 
NULL
;

291 
dsEnc
 = 
NULL
;

292 
	`gë_mem2D≥l
(&
dsRef
, 
height
>>1, 
width
>>1);

293 
	`gë_mem2D≥l
(&
dsEnc
, 
height
>>1, 
width
>>1);

295 
°ru˘uøl
[0] = 
	`compuã_°ru˘uøl_comp⁄íts
(
p_Vid
, 
p_I≈
, 
ªfImg
, 
ícImg
, 
height
, 
width
, 
wö_height
, 
wö_width
, 
comp
);

296 
cur_di°‹ti⁄
 = ()
	`pow
(
°ru˘uøl
[0], 
exp⁄ít
[0]);

298 
	`downßm∂e
(
ªfImg
, 
dsRef
, 
height
, 
width
);

299 
	`downßm∂e
(
ícImg
, 
dsEnc
, 
height
, 
width
);

301 
m
 = 1; m < 
MAX_SSIM_LEVELS
; m++)

303 
height
 >>= 1;

304 
width
 >>= 1;

305 
°ru˘uøl
[
m
] = 
	`compuã_°ru˘uøl_comp⁄íts
(
p_Vid
, 
p_I≈
, 
dsRef
, 
dsEnc
, 
height
, 
width
, 
	`imö
(
wö_height
,height), imö(
wö_width
,width), 
comp
);

306 
cur_di°‹ti⁄
 *()
	`pow
(
°ru˘uøl
[
m
], 
exp⁄ít
[m]);

307 i‡(
m
 < 
max_ssim_Àvñs_möus_⁄e
)

309 
	`downßm∂e
(
dsRef
, dsRef, 
height
, 
width
);

310 
	`downßm∂e
(
dsEnc
, dsEnc, 
height
, 
width
);

314 
lumö™˚
 = 
	`compuã_lumö™˚_comp⁄ít
(
p_Vid
, 
p_I≈
, 
dsRef
, 
dsEnc
, 
height
, 
width
, 
	`imö
(
wö_height
,height), imö(
wö_width
,width), 
comp
);

315 
cur_di°‹ti⁄
 *()
	`pow
(
lumö™˚
, 
exp⁄ít
[
m
]);

318 
	`‰ì_mem2D≥l
(
dsRef
);

319 
	`‰ì_mem2D≥l
(
dsEnc
);

320 
dsRef
 = 
NULL
;

321 
dsEnc
 = 
NULL
;

323  
cur_di°‹ti⁄
;

324 
	}
}

332 
	$föd_ms_ssim
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
ImageSåu˘uª
 *
ªf
, ImageSåu˘uª *
§c
, 
Di°Mëric
 *
mëricSSIM
)

334 
Di°‹ti⁄P¨ams
 *
p_Di°
 = 
p_Vid
->p_Dist;

335 
FømeF‹m©
 *
f‹m©
 = &
ªf
->format;

337 
mëricSSIM
->
vÆue
[0] = 
	`compuã_ms_ssim
 (
p_Vid
, 
p_I≈
, 
ªf
->
d©a
[0], 
§c
->d©a[0], 
f‹m©
->
height
[0], f‹m©->
width
[0], 
BLOCK_SIZE_8x8
, BLOCK_SIZE_8x8, 0);

339 i‡(
f‹m©
->
yuv_f‹m©
 !
YUV400
)

341 
mëricSSIM
->
vÆue
[1] = 
	`compuã_ms_ssim
 (
p_Vid
, 
p_I≈
, 
ªf
->
d©a
[1], 
§c
->d©a[1], 
f‹m©
->
height
[1], f‹m©->
width
[1],Ö_Vid->
mb_¸_size_y
,Ö_Vid->
mb_¸_size_x
, 1);

342 
mëricSSIM
->
vÆue
[2] = 
	`compuã_ms_ssim
 (
p_Vid
, 
p_I≈
, 
ªf
->
d©a
[2], 
§c
->d©a[2], 
f‹m©
->
height
[1], f‹m©->
width
[1],Ö_Vid->
mb_¸_size_y
,Ö_Vid->
mb_¸_size_x
, 2);

346 
	`accumuœã_avîage
(
mëricSSIM
, 
p_Di°
->
‰ame_˘r
);

347 
	`accumuœã_av¶i˚
(
mëricSSIM
, 
p_Vid
->
ty≥
,Ö_Vid->
p_Sèts
->
‰ame_˘r
[p_Vid->type]);

349 
	}
}

	@lencod/src/img_dist_snr.c

15 
	~"c⁄åibut‹s.h
"

17 
	~<m©h.h
>

19 
	~"íc_°©i°ics.h
"

20 
	~"globÆ.h
"

21 
	~"img_di°‹ti⁄.h
"

22 
	~"md_di°‹ti⁄.h
"

30 
	$föd_¢r
(
VideoP¨amëîs
 *
p_Vid
, 
ImageSåu˘uª
 *
imgREF
, ImageSåu˘uª *
imgSRC
, 
Di°Mëric
 *
mëricSSE
, Di°Mëri¯*
mëricPSNR
)

32 
Di°‹ti⁄P¨ams
 *
p_Di°
 = 
p_Vid
->p_Dist;

33 
FømeF‹m©
 *
f‹m©
 = &
imgREF
->format;

35 
mëricSSE
 ->
vÆue
[0] = (Ë
	`compuã_SSE
(
imgREF
->
d©a
[0], 
imgSRC
->d©a[0], 0, 0, 
f‹m©
->
height
[0], f‹m©->
width
[0]);

36 
mëricPSNR
->
vÆue
[0] = 
	`p¢r
(
f‹m©
->
max_vÆue_sq
[0], f‹m©->
size_cmp
[0], 
mëricSSE
->value[0]);

38 i‡(
f‹m©
->
yuv_f‹m©
 !
YUV400
)

40 
mëricSSE
 ->
vÆue
[1] = (Ë
	`compuã_SSE
(
imgREF
->
d©a
[1], 
imgSRC
->d©a[1], 0, 0, 
f‹m©
->
height
[1], f‹m©->
width
[1]);

41 
mëricPSNR
->
vÆue
[1] = 
	`p¢r
(
f‹m©
->
max_vÆue_sq
[1], f‹m©->
size_cmp
[1], 
mëricSSE
->value[1]);

42 
mëricSSE
 ->
vÆue
[2] = (Ë
	`compuã_SSE
(
imgREF
->
d©a
[2], 
imgSRC
->d©a[2], 0, 0, 
f‹m©
->
height
[1], f‹m©->
width
[1]);

43 
mëricPSNR
->
vÆue
[2] = 
	`p¢r
(
f‹m©
->
max_vÆue_sq
[2], f‹m©->
size_cmp
[2], 
mëricSSE
->value[2]);

45 #i‡(
MVC_EXTENSION_ENABLE
)

46 i‡(
p_Vid
->
p_I≈
->
num_of_võws
 == 2)

49 
p_Vid
->
p_Di°
->
mëric_v
[p_Vid->
võw_id
][
SSE
].
vÆue
[0] = 
mëricSSE
 ->value[0];

50 
p_Vid
->
p_Di°
->
mëric_v
[p_Vid->
võw_id
][
PSNR
].
vÆue
[0] = 
mëricPSNR
->value[0];

52 i‡(
f‹m©
->
yuv_f‹m©
 !
YUV400
)

54 
p_Vid
->
p_Di°
->
mëric_v
[p_Vid->
võw_id
][
SSE
].
vÆue
[1] = 
mëricSSE
 ->value[1];

55 
p_Vid
->
p_Di°
->
mëric_v
[p_Vid->
võw_id
][
PSNR
].
vÆue
[1] = 
mëricPSNR
->value[1];

56 
p_Vid
->
p_Di°
->
mëric_v
[p_Vid->
võw_id
][
SSE
].
vÆue
[2] = 
mëricSSE
 ->value[2];

57 
p_Vid
->
p_Di°
->
mëric_v
[p_Vid->
võw_id
][
PSNR
].
vÆue
[2] = 
mëricPSNR
->value[2];

63 
	`accumuœã_avîage
(
mëricSSE
, 
p_Di°
->
‰ame_˘r
);

64 
	`accumuœã_avîage
(
mëricPSNR
, 
p_Di°
->
‰ame_˘r
);

66 
	`accumuœã_av¶i˚
(
mëricSSE
, 
p_Vid
->
ty≥
,Ö_Vid->
p_Sèts
->
‰ame_˘r
[p_Vid->type]);

67 
	`accumuœã_av¶i˚
(
mëricPSNR
, 
p_Vid
->
ty≥
,Ö_Vid->
p_Sèts
->
‰ame_˘r
[p_Vid->type]);

68 #i‡(
MVC_EXTENSION_ENABLE
)

69 i‡(
p_Vid
->
p_I≈
->
num_of_võws
 == 2)

71 
	`accumuœã_avîage
(&
p_Di°
->
mëric_v
[
p_Vid
->
võw_id
][
SSE
],Ö_Di°->
‰ame_˘r_v
[p_Vid->view_id]);

72 
	`accumuœã_avîage
(&
p_Di°
->
mëric_v
[
p_Vid
->
võw_id
][
PSNR
],Ö_Di°->
‰ame_˘r_v
[p_Vid->view_id]);

76 
	}
}

	@lencod/src/img_dist_ssim.c

16 
	~"c⁄åibut‹s.h
"

17 
	~"globÆ.h
"

18 
	~"img_di°‹ti⁄.h
"

19 
	~"íc_°©i°ics.h
"

23 
	$compuã_ssim
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
img≥l
 **
ªfImg
, img≥»**
ícImg
, 
height
, 
width
, 
wö_height
, 
wö_width
, 
comp
)

26 c⁄° 
K1
 = 0.01f, 
K2
 = 0.03f;

27 
max_pix_vÆue_sqd
;

28 
C1
, 
C2
;

29 
wö_pixñs
 = (Ë(
wö_width
 * 
wö_height
);

30 #ifde‡
UNBIASED_VARIANCE


31 
wö_pixñs_büs
 = 
wö_pixñs
 - 1;

33 
wö_pixñs_büs
 = 
wö_pixñs
;

35 
mb_ssim
, 
mónOrg
, 
mónEnc
;

36 
v¨Org
, 
v¨Enc
, 
covOrgEnc
;

37 
imónOrg
, 
imónEnc
, 
iv¨Org
, 
iv¨Enc
, 
icovOrgEnc
;

38 
cur_di°‹ti⁄
 = 0.0;

39 
i
, 
j
, 
n
, 
m
, 
wö_˙t
 = 0;

40 
ovîœpSize
 = 
p_I≈
->
SSIMOvîœpSize
;

42 
max_pix_vÆue_sqd
 = (Ë(
p_Vid
->
max_≥l_vÆue_comp
[
comp
] *Ö_Vid->max_pel_value_comp[comp]);

43 
C1
 = 
K1
 * K1 * 
max_pix_vÆue_sqd
;

44 
C2
 = 
K2
 * K2 * 
max_pix_vÆue_sqd
;

46 
j
 = 0; j <
height
 - 
wö_height
; j +
ovîœpSize
)

48 
i
 = 0; i <
width
 - 
wö_width
; i +
ovîœpSize
)

50 
imónOrg
 = 0;

51 
imónEnc
 = 0;

52 
iv¨Org
 = 0;

53 
iv¨Enc
 = 0;

54 
icovOrgEnc
 = 0;

56  
n
 = 
j
;¿< j + 
wö_height
;n ++)

58 
m
 = 
i
;m < i + 
wö_width
;m ++)

60 
imónOrg
 +
ªfImg
[
n
][
m
];

61 
imónEnc
 +
ícImg
[
n
][
m
];

62 
iv¨Org
 +
ªfImg
[
n
][
m
] *ÑefImg[n][m];

63 
iv¨Enc
 +
ícImg
[
n
][
m
] *ÉncImg[n][m];

64 
icovOrgEnc
 +
ªfImg
[
n
][
m
] * 
ícImg
[n][m];

68 
mónOrg
 = (Ë
imónOrg
 / 
wö_pixñs
;

69 
mónEnc
 = (Ë
imónEnc
 / 
wö_pixñs
;

71 
v¨Org
 = ((Ë
iv¨Org
 - ((Ë
imónOrg
Ë* 
mónOrg
Ë/ 
wö_pixñs_büs
;

72 
v¨Enc
 = ((Ë
iv¨Enc
 - ((Ë
imónEnc
Ë* 
mónEnc
Ë/ 
wö_pixñs_büs
;

73 
covOrgEnc
 = ((Ë
icovOrgEnc
 - ((Ë
imónOrg
Ë* 
mónEnc
Ë/ 
wö_pixñs_büs
;

75 
mb_ssim
 = (Ë((2.0 * 
mónOrg
 * 
mónEnc
 + 
C1
Ë* (2.0 * 
covOrgEnc
 + 
C2
));

76 
mb_ssim
 /(Ë(
mónOrg
 * mónOrg + 
mónEnc
 * mónEn¯+ 
C1
Ë* (
v¨Org
 + 
v¨Enc
 + 
C2
);

78 
cur_di°‹ti⁄
 +
mb_ssim
;

79 
wö_˙t
++;

83 
cur_di°‹ti⁄
 /(Ë
wö_˙t
;

85 i‡(
cur_di°‹ti⁄
 >= 1.0 && cur_distortion < 1.01)

86 
cur_di°‹ti⁄
 = 1.0;

88  
cur_di°‹ti⁄
;

89 
	}
}

97 
	$föd_ssim
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
ImageSåu˘uª
 *
ªf
, ImageSåu˘uª *
§c
, 
Di°Mëric
 *
mëricSSIM
)

99 
Di°‹ti⁄P¨ams
 *
p_Di°
 = 
p_Vid
->p_Dist;

100 
FømeF‹m©
 *
f‹m©
 = &
ªf
->format;

102 
mëricSSIM
->
vÆue
[0] = 
	`compuã_ssim
 (
p_Vid
, 
p_I≈
, 
ªf
->
d©a
[0], 
§c
->d©a[0], 
f‹m©
->
height
[0], f‹m©->
width
[0], 
BLOCK_SIZE_8x8
, BLOCK_SIZE_8x8, 0);

104 i‡(
f‹m©
->
yuv_f‹m©
 !
YUV400
)

106 
mëricSSIM
->
vÆue
[1] = 
	`compuã_ssim
 (
p_Vid
, 
p_I≈
, 
ªf
->
d©a
[1], 
§c
->d©a[1], 
f‹m©
->
height
[1], f‹m©->
width
[1],Ö_Vid->
mb_¸_size_y
,Ö_Vid->
mb_¸_size_x
, 1);

107 
mëricSSIM
->
vÆue
[2] = 
	`compuã_ssim
 (
p_Vid
, 
p_I≈
, 
ªf
->
d©a
[2], 
§c
->d©a[2], 
f‹m©
->
height
[1], f‹m©->
width
[1],Ö_Vid->
mb_¸_size_y
,Ö_Vid->
mb_¸_size_x
, 2);

111 
	`accumuœã_avîage
(
mëricSSIM
, 
p_Di°
->
‰ame_˘r
);

112 
	`accumuœã_av¶i˚
(
mëricSSIM
, 
p_Vid
->
ty≥
,Ö_Vid->
p_Sèts
->
‰ame_˘r
[p_Vid->type]);

114 
	}
}

	@lencod/src/img_distortion.c

16 
	~<m©h.h
>

17 
	~<time.h
>

19 
	~"globÆ.h
"

21 
	~"ªfbuf.h
"

22 
	~"mbuf„r.h
"

23 
	~"img_luma.h
"

24 
	~"img_chroma.h
"

25 
	~"öå¨e‰esh.h
"

26 
	~"fmo.h
"

27 
	~"£i.h
"

28 
	~"memÆloc.h
"

29 
	~"«lu.h
"

30 
	~"øã˘l.h
"

31 
	~"mb_ac˚ss.h
"

32 
	~"md_di°‹ti⁄.h
"

33 
	~"ouçut.h
"

34 
	~"c⁄ãxt_öi.h
"

35 
	~"c⁄f‹m™˚.h
"

36 
	~"íc_°©i°ics.h
"

38 
	~"q_m©rix.h
"

39 
	~"q_off£ts.h
"

40 
	~"qu™t4x4.h
"

41 
	~"qu™t8x8.h
"

42 
	~"wp.h
"

43 
	~"öput.h
"

44 
	~"image.h
"

45 
	~"img_di°‹ti⁄.h
"

46 
	~"img_di°_¢r.h
"

47 
	~"img_di°_ssim.h
"

48 
	~"img_di°_ms_ssim.h
"

49 
	~"cc⁄v_yuv2rgb.h
"

58 
	$accumuœã_mëric
(*
ave_mëric
, 
cur_mëric
, 
‰ames
)

60 *
ave_mëric
 = (Ë(*ave_mëri¯* (
‰ames
 - 1Ë+ 
cur_mëric
) / frames;

61 
	}
}

69 
	$accumuœã_avîage
(
Di°Mëric
 *
mëric
, 
‰ames
)

71 
	`accumuœã_mëric
(&
mëric
->
avîage
[0], mëric->
vÆue
[0], 
‰ames
);

72 
	`accumuœã_mëric
(&
mëric
->
avîage
[1], mëric->
vÆue
[1], 
‰ames
);

73 
	`accumuœã_mëric
(&
mëric
->
avîage
[2], mëric->
vÆue
[2], 
‰ames
);

74 
	}
}

82 
	$accumuœã_av¶i˚
(
Di°Mëric
 *
mëric
, 
¶i˚_ty≥
, 
‰ames
)

84 
	`accumuœã_mëric
(&
mëric
->
av¶i˚
[
¶i˚_ty≥
][0], mëric->
vÆue
[0], 
‰ames
);

85 
	`accumuœã_mëric
(&
mëric
->
av¶i˚
[
¶i˚_ty≥
][1], mëric->
vÆue
[1], 
‰ames
);

86 
	`accumuœã_mëric
(&
mëric
->
av¶i˚
[
¶i˚_ty≥
][2], mëric->
vÆue
[2], 
‰ames
);

87 
	}
}

95 
	$föd_di°‹ti⁄
 (
VideoP¨amëîs
 *
p_Vid
, 
ImageD©a
 *
imgD©a
)

97 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

98 
Di°‹ti⁄P¨ams
 *
p_Di°
 = 
p_Vid
->p_Dist;

99 
öt64
 
diff_cmp
[3] = {0};

102 i‡(
p_Vid
->
°ru˘uª
!=
FRAME
)

105 
diff_cmp
[0] +
	`compuã_SSE
(
p_Vid
->
pCurImg
,Ö_Vid->
imgY_com
, 0, 0, 
p_I≈
->
ouçut
.
height
[0],Ö_I≈->ouçut.
width
[0]);

108 i‡(
p_Vid
->
yuv_f‹m©
 !
YUV400
)

110 
diff_cmp
[1] +
	`compuã_SSE
(
p_Vid
->
pImgOrg
[1],Ö_Vid->
imgUV_com
[0], 0, 0, 
p_I≈
->
ouçut
.
height
[1],Ö_I≈->ouçut.
width
[1]);

111 
diff_cmp
[2] +
	`compuã_SSE
(
p_Vid
->
pImgOrg
[2],Ö_Vid->
imgUV_com
[1], 0, 0, 
p_I≈
->
ouçut
.
height
[1],Ö_I≈->ouçut.
width
[1]);

116 if–(
p_I≈
->
£∑øã_cﬁour_∂™e_Êag
 != 0) )

118 
p_Vid
->
íc_pi˘uª
 =Ö_Vid->
íc_‰ame_pi˘uª
[0];

120 
p_Vid
->
pCurImg
 = 
imgD©a
->
‰m_d©a
[0];

121 
p_Vid
->
pImgOrg
[0] = 
imgD©a
->
‰m_d©a
[0];

124 
diff_cmp
[0] +
	`compuã_SSE
(
p_Vid
->
pImgOrg
[0],Ö_Vid->
íc_pi˘uª
->
imgY
, 0, 0, 
p_I≈
->
ouçut
.
height
[0],Ö_I≈->ouçut.
width
[0]);

127 i‡(
p_Vid
->
yuv_f‹m©
 !
YUV400
)

129 
p_Vid
->
pImgOrg
[1] = 
imgD©a
->
‰m_d©a
[1];

130 
p_Vid
->
pImgOrg
[2] = 
imgD©a
->
‰m_d©a
[2];

132 
diff_cmp
[1] +
	`compuã_SSE
(
p_Vid
->
pImgOrg
[1],Ö_Vid->
íc_pi˘uª
->
imgUV
[0], 0, 0, 
p_I≈
->
ouçut
.
height
[1],Ö_I≈->ouçut.
width
[1]);

133 
diff_cmp
[2] +
	`compuã_SSE
(
p_Vid
->
pImgOrg
[2],Ö_Vid->
íc_pi˘uª
->
imgUV
[1], 0, 0, 
p_I≈
->
ouçut
.
height
[1],Ö_I≈->ouçut.
width
[1]);

138 
p_Di°
->
mëric
[
SSE
].
vÆue
[0] = (Ë
diff_cmp
[0];

139 
p_Di°
->
mëric
[
SSE
].
vÆue
[1] = (Ë
diff_cmp
[1];

140 
p_Di°
->
mëric
[
SSE
].
vÆue
[2] = (Ë
diff_cmp
[2];

141 
	}
}

143 
	$£À˘_img
(
VideoP¨amëîs
 *
p_Vid
, 
ImageSåu˘uª
 *
imgSRC
, ImageSåu˘uª *
imgREF
, 
ImageD©a
 *
imgD©a
)

145 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

146 i‡(
p_Vid
->
Êd_Êag
 !
FALSE
)

148 
imgSRC
->
f‹m©
 = 
p_I≈
->
ouçut
;

149 
imgREF
->
f‹m©
 = 
p_I≈
->
ouçut
;

151 
imgREF
->
d©a
[0] = 
p_Vid
->
pCurImg
;

152 
imgSRC
->
d©a
[0] = 
p_Vid
->
imgY_com
;

154 i‡(
p_Vid
->
yuv_f‹m©
 !
YUV400
)

156 
imgREF
->
d©a
[1] = 
p_Vid
->
pImgOrg
[1];

157 
imgREF
->
d©a
[2] = 
p_Vid
->
pImgOrg
[2];

158 
imgSRC
->
d©a
[1] = 
p_Vid
->
imgUV_com
[0];

159 
imgSRC
->
d©a
[2] = 
p_Vid
->
imgUV_com
[1];

164 
imgSRC
->
f‹m©
 = 
p_I≈
->
ouçut
;

165 
imgREF
->
f‹m©
 = 
p_I≈
->
ouçut
;

167 
imgREF
->
d©a
[0] = 
imgD©a
->
‰m_d©a
[0];

169 i‡((
p_I≈
->
PicI¡îœ˚
 =
ADAPTIVE_CODING
Ë|| (p_I≈->
£∑øã_cﬁour_∂™e_Êag
 != 0))

171 
p_Vid
->
íc_pi˘uª
 =Ö_Vid->
íc_‰ame_pi˘uª
[0];

173 
imgSRC
->
d©a
[0] = 
p_Vid
->
íc_pi˘uª
->
imgY
;

175 i‡(
p_Vid
->
yuv_f‹m©
 !
YUV400
)

177 
imgREF
->
d©a
[1] = 
imgD©a
->
‰m_d©a
[1];

178 
imgREF
->
d©a
[2] = 
imgD©a
->
‰m_d©a
[2];

180 
imgSRC
->
d©a
[1] = 
p_Vid
->
íc_pi˘uª
->
imgUV
[0];

181 
imgSRC
->
d©a
[2] = 
p_Vid
->
íc_pi˘uª
->
imgUV
[1];

184 
	}
}

186 
	$compuã_di°‹ti⁄
(
VideoP¨amëîs
 *
p_Vid
, 
ImageD©a
 *
imgD©a
)

188 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

189 
Di°‹ti⁄P¨ams
 *
p_Di°
 = 
p_Vid
->p_Dist;

190 i‡(
p_I≈
->
Vîbo£
 != 0)

192 
	`£À˘_img
(
p_Vid
, &p_Vid->
imgSRC
, &p_Vid->
imgREF
, 
imgD©a
);

194 
	`föd_¢r
 (
p_Vid
, &p_Vid->
imgREF
, &p_Vid->
imgSRC
, &
p_Di°
->
mëric
[
SSE
], &p_Di°->mëric[
PSNR
]);

195 i‡(
p_I≈
->
Di°‹ti⁄
[
SSIM
] == 1)

196 
	`föd_ssim
 (
p_Vid
, 
p_I≈
, &p_Vid->
imgREF
, &p_Vid->
imgSRC
, &
p_Di°
->
mëric
[
SSIM
]);

197 i‡(
p_I≈
->
Di°‹ti⁄
[
MS_SSIM
] == 1)

198 
	`föd_ms_ssim
(
p_Vid
, 
p_I≈
, &p_Vid->
imgREF
, &p_Vid->
imgSRC
, &
p_Di°
->
mëric
[
MS_SSIM
]);

200 if(
p_I≈
->
Di°‹ti⁄YUVtoRGB
 == 1)

202 
	`YUVtoRGB
(
p_Vid
, &p_Vid->
imgREF
, &p_Vid->
imgRGB_ªf
);

203 
	`YUVtoRGB
(
p_Vid
, &p_Vid->
imgSRC
, &p_Vid->
imgRGB_§c
);

204 
	`föd_¢r
 (
p_Vid
, &p_Vid->
imgRGB_ªf
, &p_Vid->
imgRGB_§c
, &
p_Di°
->
mëric
[
SSE_RGB
], &p_Di°->mëric[
PSNR_RGB
]);

205 i‡(
p_I≈
->
Di°‹ti⁄
[
SSIM
] == 1)

206 
	`föd_ssim
 (
p_Vid
, 
p_I≈
, &p_Vid->
imgRGB_ªf
, &p_Vid->
imgRGB_§c
, &
p_Di°
->
mëric
[
SSIM_RGB
]);

207 i‡(
p_I≈
->
Di°‹ti⁄
[
MS_SSIM
] == 1)

208 
	`föd_ms_ssim
(
p_Vid
, 
p_I≈
, &p_Vid->
imgRGB_ªf
, &p_Vid->
imgRGB_§c
, &
p_Di°
->
mëric
[
MS_SSIM_RGB
]);

211 
	}
}

	@lencod/src/img_luma.c

17 
	~"c⁄åibut‹s.h
"

19 
	~<limôs.h
>

21 
	~"globÆ.h
"

22 
	~"image.h
"

23 
	~"img_luma.h
"

24 
	~"memÆloc.h
"

40 
	$gëSubImageI¡egî
–
St‹abÀPi˘uª
 *
s
, 
img≥l
 **
d°Img
, img≥»**
§cImg
)

42 
i
, 
j
;

43 
size_x_möus1
 = 
s
->
size_x
 - 1;

45 
img≥l
 *
wBufSrc
, *
wBufD°
;

48 
wBufD°
 = &–
d°Img
[-
IMG_PAD_SIZE_Y
][-
IMG_PAD_SIZE_X
] );

49 
wBufSrc
 = 
§cImg
[0];

51 
i
 = 0; i < 
IMG_PAD_SIZE_X
; i++)

52 *(
wBufD°
++Ë
wBufSrc
[0];

54 
	`mem˝y
(
wBufD°
, 
wBufSrc
, 
s
->
size_x
 * (
img≥l
));

55 
wBufD°
 +
s
->
size_x
;

57 
i
 = 0; i < 
IMG_PAD_SIZE_X
; i++)

58 *(
wBufD°
++Ë
wBufSrc
[
size_x_möus1
];

61 
j
 = -
IMG_PAD_SIZE_Y
+1; j < 1; ++j)

63 
	`mem˝y
(
d°Img
[
j
]-
IMG_PAD_SIZE_X
, d°Img[j - 1]-IMG_PAD_SIZE_X, 
s
->
size_x_∑dded
 * (
img≥l
));

66 
j
 = 1; j < 
s
->
size_y
; j++)

68 
wBufD°
 = &–
d°Img
[
j
][-
IMG_PAD_SIZE_X
] );

69 
wBufSrc
 = 
§cImg
[
j
];

71 
i
 = 0; i < 
IMG_PAD_SIZE_X
; i++)

72 *(
wBufD°
++Ë
wBufSrc
[0];

74 
	`mem˝y
(
wBufD°
, 
wBufSrc
, 
s
->
size_x
 * (
img≥l
));

75 
wBufD°
 +
s
->
size_x
;

77 
i
 = 0; i < 
IMG_PAD_SIZE_X
; i++)

78 *(
wBufD°
++Ë
wBufSrc
[
size_x_möus1
];

82 
j
 = 
s
->
size_y
; j < s->size_y+
IMG_PAD_SIZE_Y
; j++)

84 
	`mem˝y
(
d°Img
[
j
]-
IMG_PAD_SIZE_X
, d°Img[j - 1]-IMG_PAD_SIZE_X, 
s
->
size_x_∑dded
 * (
img≥l
));

86 
	}
}

88 
	$gëSubImageI¡egî_s
–
St‹abÀPi˘uª
 *
s
, 
img≥l
 **
d°Img
, img≥»**
§cImg
)

90 
i
, 
j
;

91 
size_x_möus1
 = 
s
->
size_x
 - 1;

93 
img≥l
 *
wBufSrc
, *
wBufD°
;

96 
wBufD°
 = &–
d°Img
[-
IMG_PAD_SIZE_Y
][-
IMG_PAD_SIZE_X
] );

97 
wBufSrc
 = 
§cImg
[0];

99 
i
 = 0; i < 
IMG_PAD_SIZE_X
; ++i)

100 *(
wBufD°
++Ë
wBufSrc
[0];

102 
	`mem˝y
(
wBufD°
, 
wBufSrc
, 
s
->
size_x
 * (
img≥l
));

103 
wBufD°
 +
s
->
size_x
;

105 
i
 = 0; i < 
IMG_PAD_SIZE_X
; ++i)

106 *(
wBufD°
++Ë
wBufSrc
[
size_x_möus1
];

109 
j
 = -
IMG_PAD_SIZE_Y
+1; j < 1; ++j)

111 
	`mem˝y
(
d°Img
[
j
]-
IMG_PAD_SIZE_X
, d°Img[j - 1]-IMG_PAD_SIZE_X, 
s
->
size_x_∑dded
 * (
img≥l
));

114 
j
 = 1; j < 
s
->
size_y
; ++j)

116 
wBufD°
 = &–
d°Img
[
j
][-
IMG_PAD_SIZE_X
] );

117 
wBufSrc
 = 
§cImg
[
j
];

119 
i
 = 0; i < 
IMG_PAD_SIZE_X
; ++i)

120 *(
wBufD°
++Ë
wBufSrc
[0];

123 
wBufD°
 +
s
->
size_x
;

125 
i
 = 0; i < 
IMG_PAD_SIZE_X
; ++i)

126 *(
wBufD°
++Ë
wBufSrc
[
size_x_möus1
];

130 
j
 = 
s
->
size_y
; j < s->size_y+
IMG_PAD_SIZE_Y
; ++j)

132 
	`mem˝y
(
d°Img
[
j
]-
IMG_PAD_SIZE_X
, d°Img[j - 1]-IMG_PAD_SIZE_X, 
s
->
size_x_∑dded
 * (
img≥l
));

134 
	}
}

151 
	$gëH‹SubImageSixT≠
–
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
s
, 
img≥l
 **
d°Img
, img≥»**
§cImg
)

153 
is
, 
j∑d
, 
ùad
;

154 
y∑dded_size
 = 
s
->
size_y_∑dded
;

155 
x∑dded_size
 = 
s
->
size_x_∑dded
;

157 
img≥l
 *
wBufSrc
, *
wBufD°
;

158 
img≥l
 *
§cImgA
, *
§cImgB
, *
§cImgC
, *
§cImgD
, *
§cImgE
, *
§cImgF
;

159 *
iBufD°
;

160 c⁄° 
èp0
 = 
ONE_FOURTH_TAP
[0][0];

161 c⁄° 
èp1
 = 
ONE_FOURTH_TAP
[0][1];

162 c⁄° 
èp2
 = 
ONE_FOURTH_TAP
[0][2];

164 
j∑d
 = -
IMG_PAD_SIZE_Y
; j∑d < 
y∑dded_size
-IMG_PAD_SIZE_Y; jpad++)

166 
wBufSrc
 = 
§cImg
[
j∑d
]-
IMG_PAD_SIZE_X
;

167 
wBufD°
 = 
d°Img
[
j∑d
]-
IMG_PAD_SIZE_X
;

168 
iBufD°
 = 
p_Vid
->
imgY_sub_tmp
[
j∑d
]-
IMG_PAD_SIZE_X
;

170 
§cImgA
 = &
wBufSrc
[0];

171 
§cImgB
 = &
wBufSrc
[0];

172 
§cImgC
 = &
wBufSrc
[0];

173 
§cImgD
 = &
wBufSrc
[1];

174 
§cImgE
 = &
wBufSrc
[2];

175 
§cImgF
 = &
wBufSrc
[3];

178 
is
 =

179 (
èp0
 * (*
§cImgA
++ + *
§cImgD
++) +

180 
èp1
 * (*
§cImgB
 + *
§cImgE
++) +

181 
èp2
 * (*
§cImgC
 + *
§cImgF
++));

183 *
iBufD°
++ = 
is
;

184 *
wBufD°
++ = (
img≥l
Ë
	`iClù1
 ( 
p_Vid
->
max_img≥l_vÆue
, 
	`rshi·_∫d_sf
–
is
, 5 ) );

186 
is
 =

187 (
èp0
 * (*
§cImgA
++ + *
§cImgD
++) +

188 
èp1
 * (*
§cImgB
++ + *
§cImgE
++) +

189 
èp2
 * (*
§cImgC
 + *
§cImgF
++));

191 *
iBufD°
++ = 
is
;

192 *
wBufD°
++ = (
img≥l
Ë
	`iClù1
 ( 
p_Vid
->
max_img≥l_vÆue
, 
	`rshi·_∫d_sf
–
is
, 5 ) );

195 
ùad
 = 2; i∑d < 
x∑dded_size
 - 4; ipad++)

197 
is
 =

198 (
èp0
 * (*
§cImgA
++ + *
§cImgD
++) +

199 
èp1
 * (*
§cImgB
++ + *
§cImgE
++) +

200 
èp2
 * (*
§cImgC
++ + *
§cImgF
++));

202 *
iBufD°
++ = 
is
;

203 *
wBufD°
++ = (
img≥l
Ë
	`iClù1
 ( 
p_Vid
->
max_img≥l_vÆue
, 
	`rshi·_∫d_sf
–
is
, 5 ) );

206 
is
 = (

207 
èp0
 * (*
§cImgA
++ + *
§cImgD
++) +

208 
èp1
 * (*
§cImgB
++ + *
§cImgE
++) +

209 
èp2
 * (*
§cImgC
++ + *
§cImgF
 ));

211 *
iBufD°
++ = 
is
;

212 *
wBufD°
++ = (
img≥l
Ë
	`iClù1
 ( 
p_Vid
->
max_img≥l_vÆue
, 
	`rshi·_∫d_sf
–
is
, 5 ) );

215 
is
 = (

216 
èp0
 * (*
§cImgA
++ + *
§cImgD
++) +

217 
èp1
 * (*
§cImgB
++ + *
§cImgE
) +

218 
èp2
 * (*
§cImgC
++ + *
§cImgF
));

220 *
iBufD°
++ = 
is
;

221 *
wBufD°
++ = (
img≥l
Ë
	`iClù1
 ( 
p_Vid
->
max_img≥l_vÆue
, 
	`rshi·_∫d_sf
–
is
, 5 ) );

223 
is
 = (

224 
èp0
 * (*
§cImgA
++ + *
§cImgD
) +

225 
èp1
 * (*
§cImgB
++ + *
§cImgE
) +

226 
èp2
 * (*
§cImgC
++ + *
§cImgF
));

228 *
iBufD°
++ = 
is
;

229 *
wBufD°
++ = (
img≥l
Ë
	`iClù1
 ( 
p_Vid
->
max_img≥l_vÆue
, 
	`rshi·_∫d_sf
–
is
, 5 ) );

231 
is
 = (

232 
èp0
 * (*
§cImgA
 + *
§cImgD
) +

233 
èp1
 * (*
§cImgB
 + *
§cImgE
) +

234 
èp2
 * (*
§cImgC
 + *
§cImgF
));

236 *
iBufD°
 = 
is
;

237 *
wBufD°
 = (
img≥l
Ë
	`iClù1
 ( 
p_Vid
->
max_img≥l_vÆue
, 
	`rshi·_∫d_sf
–
is
, 5 ) );

240 
	}
}

257 
	$gëVîSubImageSixT≠
–
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
s
, 
img≥l
 **
d°Img
, img≥»**
§cImg
)

259 
is
, 
j∑d
, 
ùad
;

260 
y∑dded_size
 = 
s
->
size_y_∑dded
;

261 
x∑dded_size
 = 
s
->
size_x_∑dded
;

262 
maxy
 = 
y∑dded_size
 - 1-
IMG_PAD_SIZE_Y
;

264 
img≥l
 *
wxLöeD°
;

265 
img≥l
 *
§cImgA
, *
§cImgB
, *
§cImgC
, *
§cImgD
, *
§cImgE
, *
§cImgF
;

266 c⁄° 
èp0
 = 
ONE_FOURTH_TAP
[0][0];

267 c⁄° 
èp1
 = 
ONE_FOURTH_TAP
[0][1];

268 c⁄° 
èp2
 = 
ONE_FOURTH_TAP
[0][2];

272 
j∑d
 = -
IMG_PAD_SIZE_Y
; jpad < 2-IMG_PAD_SIZE_Y; jpad++)

274 
wxLöeD°
 = 
d°Img
[
j∑d
]-
IMG_PAD_SIZE_X
;

275 
§cImgA
 = 
§cImg
[
j∑d
 ]-
IMG_PAD_SIZE_X
;

276 
§cImgB
 = 
§cImg
[0-
IMG_PAD_SIZE_Y
]-
IMG_PAD_SIZE_X
;

277 
§cImgC
 = 
§cImg
[0-
IMG_PAD_SIZE_Y
]-
IMG_PAD_SIZE_X
;

278 
§cImgD
 = 
§cImg
[
j∑d
 + 1]-
IMG_PAD_SIZE_X
;

279 
§cImgE
 = 
§cImg
[
j∑d
 + 2]-
IMG_PAD_SIZE_X
;

280 
§cImgF
 = 
§cImg
[
j∑d
 + 3]-
IMG_PAD_SIZE_X
;

281 
ùad
 = 0; i∑d < 
x∑dded_size
; ipad++)

283 
is
 =

284 (
èp0
 * (*
§cImgA
++ + *
§cImgD
++) +

285 
èp1
 * (*
§cImgB
++ + *
§cImgE
++) +

286 
èp2
 * (*
§cImgC
++ + *
§cImgF
++));

288 
wxLöeD°
[
ùad
] = (
img≥l
Ë
	`iClù1
 (
p_Vid
->
max_img≥l_vÆue
, 
	`rshi·_∫d_sf
–
is
, 5 ) );

292 
j∑d
 = 2-
IMG_PAD_SIZE_Y
; j∑d < 
y∑dded_size
 - 3-IMG_PAD_SIZE_Y; jpad++)

294 
wxLöeD°
 = 
d°Img
[
j∑d
]-
IMG_PAD_SIZE_X
;

295 
§cImgA
 = 
§cImg
[
j∑d
 ]-
IMG_PAD_SIZE_X
;

296 
§cImgB
 = 
§cImg
[
j∑d
 - 1]-
IMG_PAD_SIZE_X
;

297 
§cImgC
 = 
§cImg
[
j∑d
 - 2]-
IMG_PAD_SIZE_X
;

298 
§cImgD
 = 
§cImg
[
j∑d
 + 1]-
IMG_PAD_SIZE_X
;

299 
§cImgE
 = 
§cImg
[
j∑d
 + 2]-
IMG_PAD_SIZE_X
;

300 
§cImgF
 = 
§cImg
[
j∑d
 + 3]-
IMG_PAD_SIZE_X
;

301 
ùad
 = 0; i∑d < 
x∑dded_size
; ipad++)

303 
is
 =

304 (
èp0
 * (*
§cImgA
++ + *
§cImgD
++) +

305 
èp1
 * (*
§cImgB
++ + *
§cImgE
++) +

306 
èp2
 * (*
§cImgC
++ + *
§cImgF
++));

308 
wxLöeD°
[
ùad
] = (
img≥l
Ë
	`iClù1
 ( 
p_Vid
->
max_img≥l_vÆue
, 
	`rshi·_∫d_sf
–
is
, 5 ) );

313 
j∑d
 = 
y∑dded_size
 - 3-
IMG_PAD_SIZE_Y
; jpad < ypadded_size-IMG_PAD_SIZE_Y; jpad++)

315 
wxLöeD°
 = 
d°Img
[
j∑d
]-
IMG_PAD_SIZE_X
;

316 
§cImgA
 = 
§cImg
[
j∑d
 ]-
IMG_PAD_SIZE_X
;

317 
§cImgB
 = 
§cImg
[
j∑d
 - 1]-
IMG_PAD_SIZE_X
;

318 
§cImgC
 = 
§cImg
[
j∑d
 - 2]-
IMG_PAD_SIZE_X
;

319 
§cImgD
 = 
§cImg
[
	`imö
 (
maxy
, 
j∑d
 + 1)]-
IMG_PAD_SIZE_X
;

320 
§cImgE
 = 
§cImg
[
maxy
]-
IMG_PAD_SIZE_X
;

321 
§cImgF
 = 
§cImg
[
maxy
]-
IMG_PAD_SIZE_X
;

322 
ùad
 = 0; i∑d < 
x∑dded_size
; ipad++)

324 
is
 =

325 (
èp0
 * (*
§cImgA
++ + *
§cImgD
++) +

326 
èp1
 * (*
§cImgB
++ + *
§cImgE
++) +

327 
èp2
 * (*
§cImgC
++ + *
§cImgF
++));

329 
wxLöeD°
[
ùad
] = (
img≥l
Ë
	`iClù1
 ( 
p_Vid
->
max_img≥l_vÆue
, 
	`rshi·_∫d_sf
–
is
, 5 ) );

332 
	}
}

347 
	$gëVîSubImageSixT≠Tmp
–
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
s
, 
img≥l
 **
d°Img
)

349 
is
, 
j∑d
, 
ùad
;

350 
y∑dded_size
 = 
s
->
size_y_∑dded
;

351 
x∑dded_size
 = 
s
->
size_x_∑dded
;

352 
maxy
 = 
y∑dded_size
 - 1-
IMG_PAD_SIZE_Y
;

354 
img≥l
 *
wxLöeD°
;

355 *
§cImgA
, *
§cImgB
, *
§cImgC
, *
§cImgD
, *
§cImgE
, *
§cImgF
;

356 c⁄° 
èp0
 = 
ONE_FOURTH_TAP
[0][0];

357 c⁄° 
èp1
 = 
ONE_FOURTH_TAP
[0][1];

358 c⁄° 
èp2
 = 
ONE_FOURTH_TAP
[0][2];

361 
j∑d
 = -
IMG_PAD_SIZE_Y
; jpad < 2-IMG_PAD_SIZE_Y; jpad++)

363 
wxLöeD°
 = 
d°Img
[
j∑d
]-
IMG_PAD_SIZE_X
;

364 
§cImgA
 = 
p_Vid
->
imgY_sub_tmp
[
j∑d
 ]-
IMG_PAD_SIZE_X
;

365 
§cImgB
 = 
p_Vid
->
imgY_sub_tmp
[0-
IMG_PAD_SIZE_Y
]-
IMG_PAD_SIZE_X
;

366 
§cImgC
 = 
p_Vid
->
imgY_sub_tmp
[0-
IMG_PAD_SIZE_Y
]-
IMG_PAD_SIZE_X
;

367 
§cImgD
 = 
p_Vid
->
imgY_sub_tmp
[
j∑d
 + 1]-
IMG_PAD_SIZE_X
;

368 
§cImgE
 = 
p_Vid
->
imgY_sub_tmp
[
j∑d
 + 2]-
IMG_PAD_SIZE_X
;

369 
§cImgF
 = 
p_Vid
->
imgY_sub_tmp
[
j∑d
 + 3]-
IMG_PAD_SIZE_X
;

371 
ùad
 = 0; i∑d < 
x∑dded_size
; ipad++)

373 
is
 =

374 (
èp0
 * (*
§cImgA
++ + *
§cImgD
++) +

375 
èp1
 * (*
§cImgB
++ + *
§cImgE
++) +

376 
èp2
 * (*
§cImgC
++ + *
§cImgF
++));

378 
wxLöeD°
[
ùad
] = (
img≥l
Ë
	`iClù1
 ( 
p_Vid
->
max_img≥l_vÆue
, 
	`rshi·_∫d_sf
–
is
, 10 ) );

383 
j∑d
 = 2-
IMG_PAD_SIZE_Y
; j∑d < 
y∑dded_size
 - 3-IMG_PAD_SIZE_Y; jpad++)

385 
wxLöeD°
 = 
d°Img
[
j∑d
]-
IMG_PAD_SIZE_X
;

386 
§cImgA
 = 
p_Vid
->
imgY_sub_tmp
[
j∑d
 ]-
IMG_PAD_SIZE_X
;

387 
§cImgB
 = 
p_Vid
->
imgY_sub_tmp
[
j∑d
 - 1]-
IMG_PAD_SIZE_X
;

388 
§cImgC
 = 
p_Vid
->
imgY_sub_tmp
[
j∑d
 - 2]-
IMG_PAD_SIZE_X
;

389 
§cImgD
 = 
p_Vid
->
imgY_sub_tmp
[
j∑d
 + 1]-
IMG_PAD_SIZE_X
;

390 
§cImgE
 = 
p_Vid
->
imgY_sub_tmp
[
j∑d
 + 2]-
IMG_PAD_SIZE_X
;

391 
§cImgF
 = 
p_Vid
->
imgY_sub_tmp
[
j∑d
 + 3]-
IMG_PAD_SIZE_X
;

392 
ùad
 = 0; i∑d < 
x∑dded_size
; ipad++)

394 
is
 =

395 (
èp0
 * (*
§cImgA
++ + *
§cImgD
++) +

396 
èp1
 * (*
§cImgB
++ + *
§cImgE
++) +

397 
èp2
 * (*
§cImgC
++ + *
§cImgF
++));

399 
wxLöeD°
[
ùad
] = (
img≥l
Ë
	`iClù1
 ( 
p_Vid
->
max_img≥l_vÆue
, 
	`rshi·_∫d_sf
–
is
, 10 ) );

404 
j∑d
 = 
y∑dded_size
 - 3-
IMG_PAD_SIZE_Y
; jpad < ypadded_size-IMG_PAD_SIZE_Y; jpad++)

406 
wxLöeD°
 = 
d°Img
[
j∑d
]-
IMG_PAD_SIZE_X
;

407 
§cImgA
 = 
p_Vid
->
imgY_sub_tmp
[
j∑d
 ]-
IMG_PAD_SIZE_X
;

408 
§cImgB
 = 
p_Vid
->
imgY_sub_tmp
[
j∑d
 - 1]-
IMG_PAD_SIZE_X
;

409 
§cImgC
 = 
p_Vid
->
imgY_sub_tmp
[
j∑d
 - 2]-
IMG_PAD_SIZE_X
;

410 
§cImgD
 = 
p_Vid
->
imgY_sub_tmp
[
	`imö
 (
maxy
, 
j∑d
 + 1)]-
IMG_PAD_SIZE_X
;

411 
§cImgE
 = 
p_Vid
->
imgY_sub_tmp
[
maxy
]-
IMG_PAD_SIZE_X
;

412 
§cImgF
 = 
p_Vid
->
imgY_sub_tmp
[
maxy
]-
IMG_PAD_SIZE_X
;

413 
ùad
 = 0; i∑d < 
x∑dded_size
; ipad++)

415 
is
 =

416 (
èp0
 * (*
§cImgA
++ + *
§cImgD
++) +

417 
èp1
 * (*
§cImgB
++ + *
§cImgE
++) +

418 
èp2
 * (*
§cImgC
++ + *
§cImgF
++));

420 
wxLöeD°
[
ùad
] = (
img≥l
Ë
	`iClù1
 ( 
p_Vid
->
max_img≥l_vÆue
, 
	`rshi·_∫d_sf
–
is
, 10 ) );

423 
	}
}

440 
	$gëSubImageBiLöór
–
St‹abÀPi˘uª
 *
s
, 
img≥l
 **
d°Img
, img≥»**
§cImgL
, img≥»**
§cImgR
)

442 
j∑d
, 
ùad
;

443 
y∑dded_size
 = 
s
->
size_y_∑dded
;

444 
x∑dded_size
 = 
s
->
size_x_∑dded
;

446 
img≥l
 *
wBufSrcL
, *
wBufSrcR
, *
wBufD°
;

448 
j∑d
 = -
IMG_PAD_SIZE_Y
; j∑d < 
y∑dded_size
-IMG_PAD_SIZE_Y; jpad++)

450 
wBufSrcL
 = 
§cImgL
[
j∑d
]-
IMG_PAD_SIZE_X
;

451 
wBufSrcR
 = 
§cImgR
[
j∑d
]-
IMG_PAD_SIZE_X
;

452 
wBufD°
 = 
d°Img
[
j∑d
]-
IMG_PAD_SIZE_X
;

454 
ùad
 = 0; i∑d < 
x∑dded_size
; ipad++)

456 *
wBufD°
++ = (
img≥l
Ë
	`rshi·_∫d_sf
–*
wBufSrcL
++ + *
wBufSrcR
++, 1 );

459 
	}
}

477 
	$gëH‹SubImageBiLöór
–
St‹abÀPi˘uª
 *
s
, 
img≥l
 **
d°Img
, img≥»**
§cImgL
, img≥»**
§cImgR
)

479 
j∑d
, 
ùad
;

480 
y∑dded_size
 = 
s
->
size_y_∑dded
;

481 
x∑dded_size
 = 
s
->
size_x_∑dded
 - 1;

483 
img≥l
 *
wBufSrcL
, *
wBufSrcR
, *
wBufD°
;

485 
j∑d
 = -
IMG_PAD_SIZE_Y
; j∑d < 
y∑dded_size
-IMG_PAD_SIZE_Y; jpad++)

487 
wBufSrcL
 = 
§cImgL
[
j∑d
]-
IMG_PAD_SIZE_X
;

488 
wBufSrcR
 = &
§cImgR
[
j∑d
][1-
IMG_PAD_SIZE_X
];

489 
wBufD°
 = 
d°Img
[
j∑d
]-
IMG_PAD_SIZE_X
;

492 
ùad
 = 0; i∑d < 
x∑dded_size
; ipad++)

494 *
wBufD°
++ = (
img≥l
Ë
	`rshi·_∫d_sf
–*
wBufSrcL
++ + *
wBufSrcR
++, 1 );

497 *
wBufD°
++ = (
img≥l
Ë
	`rshi·_∫d_sf
–*
wBufSrcL
++ + 
wBufSrcR
[-1], 1 );

499 
	}
}

517 
	$gëVîSubImageBiLöór
–
St‹abÀPi˘uª
 *
s
, 
img≥l
 **
d°Img
, img≥»**
§cImgT
, img≥»**
§cImgB
)

519 
j∑d
, 
ùad
;

520 
y∑dded_size
 = 
s
->
size_y_∑dded
 - 1;

521 
x∑dded_size
 = 
s
->
size_x_∑dded
;

523 
img≥l
 *
wBufSrcT
, *
wBufSrcB
, *
wBufD°
;

526 
j∑d
 = -
IMG_PAD_SIZE_Y
; j∑d < 
y∑dded_size
-IMG_PAD_SIZE_Y; jpad++)

528 
wBufSrcT
 = 
§cImgT
[
j∑d
]-
IMG_PAD_SIZE_X
;

529 
wBufD°
 = 
d°Img
[
j∑d
]-
IMG_PAD_SIZE_X
;

530 
wBufSrcB
 = 
§cImgB
[
j∑d
 + 1]-
IMG_PAD_SIZE_X
;

532 
ùad
 = 0; i∑d < 
x∑dded_size
; ipad++)

534 *
wBufD°
++ = (
img≥l
Ë
	`rshi·_∫d_sf
(*
wBufSrcT
++ + *
wBufSrcB
++, 1);

538 
wBufSrcT
 = 
§cImgT
[
y∑dded_size
-
IMG_PAD_SIZE_Y
]-
IMG_PAD_SIZE_X
;

539 
wBufD°
 = 
d°Img
[
y∑dded_size
-
IMG_PAD_SIZE_Y
]-
IMG_PAD_SIZE_X
;

540 
wBufSrcB
 = 
§cImgB
[
y∑dded_size
-
IMG_PAD_SIZE_Y
]-
IMG_PAD_SIZE_X
;

542 
ùad
 = 0; i∑d < 
x∑dded_size
; ipad++)

544 *
wBufD°
++ = (
img≥l
Ë
	`rshi·_∫d_sf
(*
wBufSrcT
++ + *
wBufSrcB
++, 1);

546 
	}
}

564 
	$gëDügSubImageBiLöór
–
St‹abÀPi˘uª
 *
s
, 
img≥l
 **
d°Img
, img≥»**
§cImgT
, img≥»**
§cImgB
 )

566 
j∑d
, 
ùad
;

567 
maxx
 = 
s
->
size_x_∑dded
 - 1-
IMG_PAD_SIZE_X
;

568 
maxy
 = 
s
->
size_y_∑dded
 - 1-
IMG_PAD_SIZE_Y
;

570 
img≥l
 *
wBufSrcL
, *
wBufSrcR
, *
wBufD°
;

572 
j∑d
 = -
IMG_PAD_SIZE_Y
; j∑d < 
maxy
; jpad++)

574 
wBufSrcL
 = 
§cImgT
[
j∑d
 + 1]-
IMG_PAD_SIZE_X
;

575 
wBufSrcR
 = &
§cImgB
[
j∑d
][1-
IMG_PAD_SIZE_X
];

576 
wBufD°
 = 
d°Img
[
j∑d
]-
IMG_PAD_SIZE_X
;

578 
ùad
 = -
IMG_PAD_SIZE_X
; i∑d < 
maxx
; ipad++)

580 *
wBufD°
++ = (
img≥l
Ë
	`rshi·_∫d_sf
(*
wBufSrcL
++ + *
wBufSrcR
++, 1);

583 *
wBufD°
++ = (
img≥l
Ë
	`rshi·_∫d_sf
(*
wBufSrcL
++ + 
wBufSrcR
[-1], 1);

586 
wBufSrcL
 = 
§cImgT
[
maxy
]-
IMG_PAD_SIZE_X
;

587 
wBufSrcR
 = &
§cImgB
[
maxy
][1-
IMG_PAD_SIZE_X
];

588 
wBufD°
 = 
d°Img
[
maxy
]-
IMG_PAD_SIZE_X
;

590 
ùad
 = -
IMG_PAD_SIZE_X
; i∑d < 
maxx
; ipad++)

592 *
wBufD°
++ = (
img≥l
Ë
	`rshi·_∫d_sf
(*
wBufSrcL
++ + *
wBufSrcR
++, 1);

595 *
wBufD°
++ = (
img≥l
Ë
	`rshi·_∫d_sf
(*
wBufSrcL
++ + 
wBufSrcR
[-1], 1);

596 
	}
}

611 
	$gëSubImagesLuma
–
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
s
 )

613 
img≥l
 ****
cImgSub
 = 
s
->
p_cuº_img_sub
;

614 
Ÿf_shi·
 = ( 
p_Vid
->
p_I≈
->
OnTheFlyFø˘MCP
 =
OTF_L1
 ) ? (1) : (0) ;

625 i‡(
cImgSub
[0][0][0] !
s
->
p_cuº_img
[0])

627 
	`gëSubImageI¡egî
–
s
, 
cImgSub
[0][0], s->
p_cuº_img
);

631 
	`gëSubImageI¡egî_s
–
s
, 
cImgSub
[0][0], s->
p_cuº_img
);

638 
	`gëH‹SubImageSixT≠
–
p_Vid
, 
s
, 
cImgSub
[0][2>>
Ÿf_shi·
], cImgSub[0][0] );

642 
	`gëVîSubImageSixT≠
–
p_Vid
, 
s
, 
cImgSub
[2>>
Ÿf_shi·
][0], cImgSub[0][0]);

646 
	`gëVîSubImageSixT≠Tmp
–
p_Vid
, 
s
, 
cImgSub
[2>>
Ÿf_shi·
][2>>otf_shift]);

648 if–!
p_Vid
->
p_I≈
->
OnTheFlyFø˘MCP
 )

653 
	`gëSubImageBiLöór
 ( 
s
, 
cImgSub
[0][1], cImgSub[0][0], cImgSub[0][2]);

655 
	`gëSubImageBiLöór
 ( 
s
, 
cImgSub
[1][0], cImgSub[0][0], cImgSub[2][0]);

657 
	`gëSubImageBiLöór
 ( 
s
, 
cImgSub
[1][1], cImgSub[0][2], cImgSub[2][0]);

659 
	`gëSubImageBiLöór
 ( 
s
, 
cImgSub
[1][2], cImgSub[0][2], cImgSub[2][2]);

661 
	`gëSubImageBiLöór
 ( 
s
, 
cImgSub
[2][1], cImgSub[2][0], cImgSub[2][2]);

664 
	`gëH‹SubImageBiLöór
 ( 
s
, 
cImgSub
[0][3], cImgSub[0][2], cImgSub[0][0]);

666 
	`gëH‹SubImageBiLöór
 ( 
s
, 
cImgSub
[1][3], cImgSub[0][2], cImgSub[2][0]);

668 
	`gëH‹SubImageBiLöór
 ( 
s
, 
cImgSub
[2][3], cImgSub[2][2], cImgSub[2][0]);

671 
	`gëVîSubImageBiLöór
 ( 
s
, 
cImgSub
[3][0], cImgSub[2][0], cImgSub[0][0]);

673 
	`gëVîSubImageBiLöór
 ( 
s
, 
cImgSub
[3][1], cImgSub[2][0], cImgSub[0][2]);

675 
	`gëVîSubImageBiLöór
 ( 
s
, 
cImgSub
[3][2], cImgSub[2][2], cImgSub[0][2]);

678 
	`gëDügSubImageBiLöór
–
s
, 
cImgSub
[3][3], cImgSub[0][2], cImgSub[2][0]);

680 
	}
}

	@lencod/src/intra16x16.c

14 
	~"c⁄åibut‹s.h
"

16 
	~"globÆ.h
"

17 
	~"image.h
"

18 
	~"mb_ac˚ss.h
"

19 
	~"å™sf‹m.h
"

20 
	~"memÆloc.h
"

28 
ölöe
 
	$gë_i16x16_vîtiˇl
(
img≥l
 **
cur_¥ed
, img≥»*
PªdPñ
)

30 
j
;

31 
j
 = 0; j < 
MB_BLOCK_SIZE
; j++)

32 
	`mem˝y
(
cur_¥ed
[
j
], &
PªdPñ
[1], 
MB_BLOCK_SIZE
 * (
img≥l
));

33 
	}
}

42 
ölöe
 
	$gë_i16x16_h‹iz⁄èl
(
img≥l
 **
cur_¥ed
, img≥»*
PªdPñ
)

44 
i
, 
j
;

45 
img≥l
 *
¥edi˘i⁄
 = &
PªdPñ
[16];

47 
j
 = 0; j < 
MB_BLOCK_SIZE
; j++)

49 
¥edi˘i⁄
++;

50 
i
 = 0; i < 
MB_BLOCK_SIZE
; i++)

52 
cur_¥ed
[
j
][
i
] = *
¥edi˘i⁄
;

55 
	}
}

63 
ölöe
 
	$gë_i16x16_dc
(
img≥l
 **
cur_¥ed
, img≥»*
PªdPñ
, 
À·_avaûabÀ
, 
up_avaûabÀ
)

65 
i
, 
j
, 
s0
 = 0, 
s1
 = 0, 
s2
 = 0;

67 i‡(
up_avaûabÀ
)

69 
i
 = 1; i < 
MB_BLOCK_SIZE
 + 1; ++i)

70 
s1
 +
PªdPñ
[
i
];

73 i‡(
À·_avaûabÀ
)

75 
i
 = 17; i < 33; ++i)

76 
s2
 +
PªdPñ
[
i
];

79 i‡(
up_avaûabÀ
)

81 
s0
 = 
À·_avaûabÀ


82 ? 
	`rshi·_∫d_sf
((
s1
 + 
s2
),(
MB_BLOCK_SHIFT
 + 1))

83 : 
	`rshi·_∫d_sf
(
s1
, 
MB_BLOCK_SHIFT
);

87 
s0
 = 
À·_avaûabÀ


88 ? 
	`rshi·_∫d_sf
(
s2
, 
MB_BLOCK_SHIFT
)

89 : 
PªdPñ
[1];

92 
j
 = 0; j < 
MB_BLOCK_SIZE
; j++)

94 
i
 = 0; i < 
MB_BLOCK_SIZE
; i++)

95 
cur_¥ed
[
j
][
i
] = (
img≥l
Ë
s0
;

97 
	}
}

105 
ölöe
 
	$gë_i16x16_∂™e
(
img≥l
 **
cur_¥ed
, img≥»*
PªdPñ
, 
max_img≥l_vÆue
)

107 
i
, 
j
;

109 
ih
=0, 
iv
=0;

110 
ib
, 
ic
, 
üa
;

111 
img≥l
 *
t_¥ed
 = &
PªdPñ
[25];

112 
img≥l
 *
u_¥ed
 = &
PªdPñ
[8];

113 
img≥l
 *
b_¥ed
 = &
PªdPñ
[23];

115 
i
 = 1; i < 8;++i)

117 
ih
 +
i
*(*(
u_¥ed
 + i) - *(u_pred - i));

118 
iv
 +
i
*(*
t_¥ed
++ - *
b_¥ed
--);

120 
ih
 +8 * (*(
u_¥ed
 + 8Ë- 
PªdPñ
[0]);

121 
iv
 +8 * (*
t_¥ed
++ - 
PªdPñ
[0]);

123 
ib
 = (5 * 
ih
 + 32) >> 6;

124 
ic
 = (5 * 
iv
 + 32) >> 6;

126 
üa
=16 * (
PªdPñ
[16] + PredPel[32]);

128 
j
=0;j< 
MB_BLOCK_SIZE
;++j)

130 
i
=0;i< 
MB_BLOCK_SIZE
;++i)

132 
cur_¥ed
[
j
][
i
](
img≥l
Ë
	`iClù1
–
max_img≥l_vÆue
, 
	`rshi·_∫d_sf
((
üa
 + (ò- 7Ë* 
ib
 + (j - 7Ë* 
ic
), 5));

135 
	}
}

148 
	$£t_öå≠ªd_16x16
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, *
À·_avaûabÀ
, *
up_avaûabÀ
, *
Æl_avaûabÀ
)

150 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

151 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

153 
i
;

154 
img≥l
 *
PªdPñ
 = 
cuºMB
->
öåa16x16_¥ed
[
∂
];

155 
img≥l
 **
img_íc
 = (
cuºMB
->
p_Sli˚
->
P444_joöed
)? 
p_Vid
->
íc_pi˘uª
->
p_img
[
∂
]:Ö_Vid->íc_pi˘uª->
p_cuº_img
;

157 
PixñPos
 
pix_b
;

158 
PixñPos
 
pix_a
;

159 
PixñPos
 
pix_d
;

161 *
mb_size
 = 
p_Vid
->mb_size[
IS_LUMA
];

163 
p_Vid
->
	`gëNeighbour
(
cuºMB
, -1, -1, 
mb_size
, &
pix_d
);

164 
p_Vid
->
	`gëNeighbour
(
cuºMB
, -1, 0, 
mb_size
, &
pix_a
);

165 
p_Vid
->
	`gëNeighbour
(
cuºMB
, 0, -1, 
mb_size
, &
pix_b
);

167 i‡(
p_I≈
->
U£C⁄°øöedI¡øPªd
 == 0)

169 *
up_avaûabÀ
 = 
pix_b
.
avaûabÀ
;

170 *
À·_avaûabÀ
 = 
pix_a
.
avaûabÀ
;

171 *
Æl_avaûabÀ
 = 
pix_d
.
avaûabÀ
;

175 *
up_avaûabÀ
 = 
pix_b
.
avaûabÀ
 ? 
p_Vid
->
öåa_block
[pix_b.
mb_addr
] : 0;

176 *
À·_avaûabÀ
 = 
pix_a
.
avaûabÀ
 ? 
p_Vid
->
öåa_block
[pix_a.
mb_addr
] : 0;

177 *
Æl_avaûabÀ
 = 
pix_d
.
avaûabÀ
 ? 
p_Vid
->
öåa_block
[pix_d.
mb_addr
] : 0;

181 i‡(*
up_avaûabÀ
)

183 
	`mem˝y
(&
PªdPñ
[1], &
img_íc
[
pix_b
.
pos_y
][pix_b.
pos_x
], 
MB_BLOCK_SIZE
 * (
img≥l
));

187 
i
 = 1; i < 17; ++i)

188 
PªdPñ
[
i
] = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue
;

191 i‡(*
À·_avaûabÀ
)

193 
pos_y
 = 
pix_a
.pos_y;

194 
pos_x
 = 
pix_a
.pos_x;

196 
i
 = 1; i < 
MB_BLOCK_SIZE
 + 1; ++i)

197 
PªdPñ
[
i
 + 16] = 
img_íc
[
pos_y
++][
pos_x
];

201 
i
 = 17; i < 33; ++i)

202 
PªdPñ
[
i
] = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue
;

205 i‡(*
Æl_avaûabÀ
)

207 
PªdPñ
[0] = 
img_íc
[
pix_d
.
pos_y
][pix_d.
pos_x
];

211 
PªdPñ
[0] = 
p_Vid
->
dc_¥ed_vÆue
;

213 
	}
}

227 
	$£t_öå≠ªd_16x16_mbaff
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, *
À·_avaûabÀ
, *
up_avaûabÀ
, *
Æl_avaûabÀ
)

229 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

230 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

232 
i
;

233 
img≥l
 *
PªdPñ
 = 
cuºMB
->
öåa16x16_¥ed
[
∂
];

234 
img≥l
 **
img_íc
 = 
p_Vid
->
íc_pi˘uª
->
p_cuº_img
;

236 
PixñPos
 
pix_b
;

237 
PixñPos
 
pix_a
[17];

239 *
mb_size
 = 
p_Vid
->mb_size[
IS_LUMA
];

241 
i
 = 0; i < 17; ++i)

243 
p_Vid
->
	`gëNeighbour
(
cuºMB
, -1, 
i
 - 1, 
mb_size
, &
pix_a
[i]);

246 
p_Vid
->
	`gëNeighbour
(
cuºMB
, 0, -1, 
mb_size
, &
pix_b
);

248 i‡(
p_I≈
->
U£C⁄°øöedI¡øPªd
 == 0)

250 *
up_avaûabÀ
 = 
pix_b
.
avaûabÀ
;

251 *
À·_avaûabÀ
 = 
pix_a
[1].
avaûabÀ
;

252 *
Æl_avaûabÀ
 = 
pix_a
[0].
avaûabÀ
;

256 *
up_avaûabÀ
 = 
pix_b
.
avaûabÀ
 ? 
p_Vid
->
öåa_block
[pix_b.
mb_addr
] : 0;

257 
i
=1, *
À·_avaûabÀ
=1; i<17;++i)

258 *
À·_avaûabÀ
 &
pix_a
[
i
].
avaûabÀ
 ? 
p_Vid
->
öåa_block
[pix_a[i].
mb_addr
]: 0;

259 *
Æl_avaûabÀ
 = 
pix_a
[0].
avaûabÀ
 ? 
p_Vid
->
öåa_block
[pix_a[0].
mb_addr
]: 0;

263 i‡(*
up_avaûabÀ
)

265 
	`mem˝y
(&
PªdPñ
[1], &
img_íc
[
pix_b
.
pos_y
][pix_b.
pos_x
], 
MB_BLOCK_SIZE
 * (
img≥l
));

269 
i
 = 1; i < 17; ++i)

270 
PªdPñ
[
i
] = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue
;

273 i‡(*
À·_avaûabÀ
)

275 
i
 = 1; i < 
MB_BLOCK_SIZE
 + 1; ++i)

276 
PªdPñ
[
i
 + 16] = 
img_íc
[
pix_a
[i].
pos_y
][pix_a[i].
pos_x
];

280 
i
 = 17; i < 33; ++i)

281 
PªdPñ
[
i
] = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue
;

284 i‡(*
Æl_avaûabÀ
)

286 
PªdPñ
[0] = 
img_íc
[
pix_a
[0].
pos_y
][pix_a[0].
pos_x
];

290 
PªdPñ
[0] = 
p_Vid
->
dc_¥ed_vÆue
;

292 
	}
}

307 
	$gë_öå≠ªd_16x16
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
i16x16_mode
, 
À·_avaûabÀ
, 
up_avaûabÀ
)

309 
img≥l
 *
PªdPñ
 = 
cuºMB
->
öåa16x16_¥ed
[
∂
];

310 
img≥l
 ***
cuº_m¥_16x16
 = 
cuºMB
->
p_Sli˚
->
m¥_16x16
[
∂
];

312 
i16x16_mode
)

314 
VERT_PRED_16
 :

315 
	`gë_i16x16_vîtiˇl
(
cuº_m¥_16x16
[
VERT_PRED_16
], 
PªdPñ
);

317 
HOR_PRED_16
 :

318 
	`gë_i16x16_h‹iz⁄èl
(
cuº_m¥_16x16
[
HOR_PRED_16
], 
PªdPñ
);

320 
DC_PRED_16
 :

321 
	`gë_i16x16_dc
(
cuº_m¥_16x16
[
DC_PRED_16
], 
PªdPñ
, 
À·_avaûabÀ
, 
up_avaûabÀ
);

323 
PLANE_16
 :

324 
	`gë_i16x16_∂™e
(
cuº_m¥_16x16
[
PLANE_16
], 
PªdPñ
, 
cuºMB
->
p_Vid
->
max_img≥l_vÆue
);

327 
	`¥ötf
("invalidÖrediction mode \n");

330 
	}
}

332 
di°blk
 
	$di°I16x16_ßtd
(
Ma¸oblock
 *
cuºMB
, 
img≥l
 **
img_‹g
, img≥»**
¥ed_img
, 
di°blk
 
mö_co°
)

334 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

335 **
M7
 = 
NULL
;

336 **
tblk4x4
 = 
cuºSli˚
->tblk4x4;

337 ****
i16blk4x4
 = 
cuºSli˚
->i16blk4x4;

338 
img≥l
 *
cur_img
, *
¥d_img
;

339 
di°blk
 
cuºít_öåa_ßd_2
 = 0;

340 
ii
, 
jj
, 
i
, 
j
, 
i32Co°
 = 0;

341 
imö_co°
 = 
	`di°_down
(
mö_co°
);

343 
j
 = 0; j < 
MB_BLOCK_SIZE
; j++)

345 
cur_img
 = &
img_‹g
[
cuºMB
->
›ix_y
 + 
j
][cuºMB->
pix_x
];

346 
¥d_img
 = 
¥ed_img
[
j
];

347 
i
 = 0; i < 
MB_BLOCK_SIZE
; i++)

349 
i16blk4x4
[
j
 >> 2][
i
 >> 2][j & 0x03][ò& 0x03] = 
cur_img
[i] - 
¥d_img
[i];

353 
jj
 = 0; jj < 4; jj++)

355 
ii
 = 0; ii < 4;ii++)

357 
M7
 = 
i16blk4x4
[
jj
][
ii
];

358 
	`hadam¨d4x4
(
M7
, M7);

359 
i32Co°
 +
	`übs
(
M7
[0][1]);

360 
i32Co°
 +
	`übs
(
M7
[0][2]);

361 
i32Co°
 +
	`übs
(
M7
[0][3]);

363 i‡(
i32Co°
 > 
imö_co°
)

364  (
mö_co°
);

366 
j
 = 1; j < 4; j++)

369 
i32Co°
 +
	`übs
(
M7
[
j
][0]);

370 
i32Co°
 +
	`übs
(
M7
[
j
][1]);

371 
i32Co°
 +
	`übs
(
M7
[
j
][2]);

372 
i32Co°
 +
	`übs
(
M7
[
j
][3]);

374 i‡(
i32Co°
 > 
imö_co°
)

375  (
mö_co°
);

380 
j
 = 0; j < 4;j++)

382 
tblk4x4
[
j
][0] = (
i16blk4x4
[j][0][0][0] >> 1);

383 
tblk4x4
[
j
][1] = (
i16blk4x4
[j][1][0][0] >> 1);

384 
tblk4x4
[
j
][2] = (
i16blk4x4
[j][2][0][0] >> 1);

385 
tblk4x4
[
j
][3] = (
i16blk4x4
[j][3][0][0] >> 1);

389 
	`hadam¨d4x4
(
tblk4x4
,Åblk4x4);

391 
j
 = 0; j < 4; j++)

393 
i32Co°
 +
	`übs
(
tblk4x4
[
j
][0]);

394 
i32Co°
 +
	`übs
(
tblk4x4
[
j
][1]);

395 
i32Co°
 +
	`übs
(
tblk4x4
[
j
][2]);

396 
i32Co°
 +
	`übs
(
tblk4x4
[
j
][3]);

398 i‡(
i32Co°
 > 
imö_co°
)

399  (
mö_co°
);

402 
cuºít_öåa_ßd_2
 +(
	`di°_sˇÀ
((
di°blk
)
i32Co°
));

403  
cuºít_öåa_ßd_2
;

404 
	}
}

406 
di°blk
 
	$di°I16x16_ßd
(
Ma¸oblock
 *
cuºMB
, 
img≥l
 **
img_‹g
, img≥»**
¥ed_img
, 
di°blk
 
mö_co°
)

408 
img≥l
 *
cur_img
, *
¥d_img
;

409 
i32Co°
 = 0;

410 
i
, 
j
;

411 
imö_co°
 = 
	`di°_down
(
mö_co°
);

413 
j
 = 0; j < 
MB_BLOCK_SIZE
; j++)

415 
cur_img
 = &
img_‹g
[
cuºMB
->
›ix_y
 + 
j
][cuºMB->
pix_x
];

416 
¥d_img
 = 
¥ed_img
[
j
];

417 
i
 = 0; i < 
MB_BLOCK_SIZE
; i++)

419 
i32Co°
 +
	`übs
–*
cur_img
++ - *
¥d_img
++ );

422 i‡(
i32Co°
 > 
imö_co°
)

423  (
mö_co°
);

426  (
	`di°_sˇÀ
((
di°blk
Ë
i32Co°
));

427 
	}
}

429 
di°blk
 
	$di°I16x16_s£
(
Ma¸oblock
 *
cuºMB
, 
img≥l
 **
img_‹g
, img≥»**
¥ed_img
, 
di°blk
 
mö_co°
)

431 
img≥l
 *
cur_img
, *
¥d_img
;

432 
i
, 
j
, 
i32Co°
 = 0;

433 
imö_co°
 = 
	`di°_down
(
mö_co°
);

435 
j
 = 0; j < 
MB_BLOCK_SIZE
;j++)

437 
cur_img
 = &
img_‹g
[
cuºMB
->
›ix_y
 + 
j
][cuºMB->
pix_x
];

438 
¥d_img
 = 
¥ed_img
[
j
];

439 
i
 = 0; i < 
MB_BLOCK_SIZE
; i++)

441 
i32Co°
 +
	`übs2
–*
cur_img
++ - *
¥d_img
++ );

444 i‡(
i32Co°
 > 
imö_co°
)

445  (
mö_co°
);

448  (
	`di°_sˇÀ
((
di°blk
Ë
i32Co°
));

449 
	}
}

463 
di°blk
 
	$föd_ßd_16x16_JM
(
Ma¸oblock
 *
cuºMB
)

465 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

466 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

467 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

468 
di°blk
 
cuºít_öåa_ßd_2
, 
be°_öåa_ßd2
 = 
DISTBLK_MAX
;

469 
k
;

470 
img≥l
 ***
cuº_m¥_16x16
 = 
cuºSli˚
->
m¥_16x16
[0];

472 
up_avaû
, 
À·_avaû
, 
À·_up_avaû
;

474 
cuºMB
->
i16mode
 = 
DC_PRED_16
;

476 
cuºSli˚
->
	`£t_öå≠ªd_16x16
(
cuºMB
, 
PLANE_Y
, &
À·_avaû
, &
up_avaû
, &
À·_up_avaû
);

478 i‡(
cuºSli˚
->
P444_joöed
)

480 
cuºSli˚
->
	`£t_öå≠ªd_16x16
(
cuºMB
, 
PLANE_U
, &
À·_avaû
, &
up_avaû
, &
À·_up_avaû
);

481 
cuºSli˚
->
	`£t_öå≠ªd_16x16
(
cuºMB
, 
PLANE_V
, &
À·_avaû
, &
up_avaû
, &
À·_up_avaû
);

484 
k
 = 
VERT_PRED_16
; k <
PLANE_16
; k++)

486 i‡(
p_I≈
->
I¡øDißbÀI¡îO∆y
 =0 || (
cuºSli˚
->
¶i˚_ty≥
 !
I_SLICE
 && cuºSli˚->¶i˚_ty≥ !
SI_SLICE
) )

488 i‡(
p_I≈
->
I¡ø16x16P¨DißbÀ
 && (
k
 =
VERT_PRED_16
||k =
HOR_PRED_16
))

491 i‡(
p_I≈
->
I¡ø16x16Pœ√DißbÀ
 && 
k
 =
PLANE_16
)

495 i‡(!((
k
 =
VERT_PRED_16
 && !
up_avaû
Ë|| (k =
HOR_PRED_16
 && !
À·_avaû
Ë|| (k =
PLANE_16
 && (!À·_avaû || !up_avaû || !
À·_up_avaû
))))

497 
	`gë_öå≠ªd_16x16
(
cuºMB
, 
PLANE_Y
, 
k
, 
À·_avaû
, 
up_avaû
);

498 
cuºít_öåa_ßd_2
 = 
cuºSli˚
->
	`di°I16x16
(
cuºMB
, 
p_Vid
->
pCurImg
, 
cuº_m¥_16x16
[
k
], 
be°_öåa_ßd2
);

499 i‡(
cuºSli˚
->
P444_joöed
)

501 
	`gë_öå≠ªd_16x16
(
cuºMB
, 
PLANE_U
, 
k
, 
À·_avaû
, 
up_avaû
);

502 
cuºít_öåa_ßd_2
 +
cuºSli˚
->
	`di°I16x16
(
cuºMB
, 
p_Vid
->
pImgOrg
[1], cuºSli˚->
m¥_16x16
[1][
k
], 
be°_öåa_ßd2
);

503 
	`gë_öå≠ªd_16x16
(
cuºMB
, 
PLANE_V
, 
k
, 
À·_avaû
, 
up_avaû
);

504 
cuºít_öåa_ßd_2
 +
cuºSli˚
->
	`di°I16x16
(
cuºMB
, 
p_Vid
->
pImgOrg
[2], cuºSli˚->
m¥_16x16
[2][
k
], 
be°_öåa_ßd2
);

507 i‡(
cuºít_öåa_ßd_2
 < 
be°_öåa_ßd2
)

509 
be°_öåa_ßd2
 = 
cuºít_öåa_ßd_2
;

510 
cuºMB
->
i16mode
 = (Ë
k
;

515  
be°_öåa_ßd2
;

516 
	}
}

	@lencod/src/intra4x4.c

15 
	~"c⁄åibut‹s.h
"

17 
	~"globÆ.h
"

18 
	~"image.h
"

19 
	~"mb_ac˚ss.h
"

21 
	$gíî©e_¥ed_îr‹_4x4
(
img≥l
 **
cur_img
, img≥»**
¥d_img
, img≥»**
cur_¥d
, **
m7
, 
pic_›ix_x
, 
block_x
)

23 
j
, 
i
, *
m7_löe
;

24 
img≥l
 *
cur_löe
, *
¥d_löe
;

26 
j
 = 0; j < 
BLOCK_SIZE
; j++)

28 
m7_löe
 = &
m7
[
j
][
block_x
];

29 
cur_löe
 = &
cur_img
[
j
][
pic_›ix_x
];

30 
¥d_löe
 = 
¥d_img
[
j
];

31 
	`mem˝y
(&
cur_¥d
[
j
][
block_x
], 
¥d_löe
, 
BLOCK_SIZE
 * (
img≥l
));

33 
i
 = 0; i < 
BLOCK_SIZE
; i++)

35 *
m7_löe
++ = (Ë(*
cur_löe
++ - *
¥d_löe
++);

38 
	}
}

52 
	#P_X
 (
PªdPñ
[0])

	)

53 
	#P_A
 (
PªdPñ
[1])

	)

54 
	#P_B
 (
PªdPñ
[2])

	)

55 
	#P_C
 (
PªdPñ
[3])

	)

56 
	#P_D
 (
PªdPñ
[4])

	)

57 
	#P_E
 (
PªdPñ
[5])

	)

58 
	#P_F
 (
PªdPñ
[6])

	)

59 
	#P_G
 (
PªdPñ
[7])

	)

60 
	#P_H
 (
PªdPñ
[8])

	)

61 
	#P_I
 (
PªdPñ
[9])

	)

62 
	#P_J
 (
PªdPñ
[10])

	)

63 
	#P_K
 (
PªdPñ
[11])

	)

64 
	#P_L
 (
PªdPñ
[12])

	)

72 
ölöe
 
	$gë_i4x4_vîtiˇl
(
img≥l
 **
cur_¥ed
, img≥»*
PªdPñ
)

74 
	`mem˝y
(
cur_¥ed
[0], &
PªdPñ
[1], 
BLOCK_SIZE
 * (
img≥l
));

75 
	`mem˝y
(
cur_¥ed
[1], &
PªdPñ
[1], 
BLOCK_SIZE
 * (
img≥l
));

76 
	`mem˝y
(
cur_¥ed
[2], &
PªdPñ
[1], 
BLOCK_SIZE
 * (
img≥l
));

77 
	`mem˝y
(
cur_¥ed
[3], &
PªdPñ
[1], 
BLOCK_SIZE
 * (
img≥l
));

78 
	}
}

86 
ölöe
 
	$gë_i4x4_h‹iz⁄èl
(
img≥l
 **
cur_¥ed
, img≥»*
PªdPñ
)

88 
i
;

90 
i
=0; i < 
BLOCK_SIZE
; i++)

92 
cur_¥ed
[
i
][0] =

93 
cur_¥ed
[
i
][1] =

94 
cur_¥ed
[
i
][2] =

95 
cur_¥ed
[
i
][3] = (
img≥l
Ë(&
P_I
)[i];

97 
	}
}

105 
ölöe
 
	$gë_i4x4_dc
(
img≥l
 **
cur_¥ed
, img≥»*
PªdPñ
, 
À·_avaûabÀ
, 
up_avaûabÀ
)

107 
i
, 
j
, 
s0
 = 0;

108 i‡(
up_avaûabÀ
 && 
À·_avaûabÀ
)

111 
s0
 = (
P_A
 + 
P_B
 + 
P_C
 + 
P_D
 + 
P_I
 + 
P_J
 + 
P_K
 + 
P_L
 + 4Ë>> (
BLOCK_SHIFT
 + 1);

113 i‡(!
up_avaûabÀ
 && 
À·_avaûabÀ
)

116 
s0
 = (
P_I
 + 
P_J
 + 
P_K
 + 
P_L
 + 2Ë>> 
BLOCK_SHIFT
;;

118 i‡(
up_avaûabÀ
 && !
À·_avaûabÀ
)

121 
s0
 = (
P_A
 + 
P_B
 + 
P_C
 + 
P_D
 + 2Ë>> 
BLOCK_SHIFT
;

126 
s0
 = 
P_A
;

129 
j
=0; j < 
BLOCK_SIZE
; j++)

131 
i
=0; i < 
BLOCK_SIZE
; i++)

132 
cur_¥ed
[
j
][
i
] = (
img≥l
Ë
s0
;

134 
	}
}

142 
ölöe
 
	$gë_i4x4_dow∆e·
(
img≥l
 **
cur_¥ed
, img≥»*
PªdPñ
)

144 
cur_¥ed
[0][0] = (
img≥l
Ë((
P_A
 + 
P_C
 + ((
P_B
) << 1) + 2) >> 2);

145 
cur_¥ed
[0][1] =

146 
cur_¥ed
[1][0] = (
img≥l
Ë((
P_B
 + 
P_D
 + ((
P_C
) << 1) + 2) >> 2);

147 
cur_¥ed
[0][2] =

148 
cur_¥ed
[1][1] =

149 
cur_¥ed
[2][0] = (
img≥l
Ë((
P_C
 + 
P_E
 + ((
P_D
) << 1) + 2) >> 2);

150 
cur_¥ed
[0][3] =

151 
cur_¥ed
[1][2] =

152 
cur_¥ed
[2][1] =

153 
cur_¥ed
[3][0] = (
img≥l
Ë((
P_D
 + 
P_F
 + ((
P_E
) << 1) + 2) >> 2);

154 
cur_¥ed
[1][3] =

155 
cur_¥ed
[2][2] =

156 
cur_¥ed
[3][1] = (
img≥l
Ë((
P_E
 + 
P_G
 + ((
P_F
)<<1) + 2) >> 2);

157 
cur_¥ed
[2][3] =

158 
cur_¥ed
[3][2] = (
img≥l
Ë((
P_F
 + 
P_H
 + ((
P_G
)<<1) + 2) >> 2);

159 
cur_¥ed
[3][3] = (
img≥l
Ë((
P_G
 + 3*(
P_H
) + 2) >> 2);

160 
	}
}

168 
ölöe
 
	$gë_i4x4_dowƒight
(
img≥l
 **
cur_¥ed
, img≥»*
PªdPñ
)

170 
cur_¥ed
[3][0] = (
img≥l
Ë((
P_L
 + 2*
P_K
 + 
P_J
 + 2) >> 2);

171 
cur_¥ed
[2][0] =

172 
cur_¥ed
[3][1] = (
img≥l
Ë((
P_K
 + 2*
P_J
 + 
P_I
 + 2) >> 2);

173 
cur_¥ed
[1][0] =

174 
cur_¥ed
[2][1] =

175 
cur_¥ed
[3][2] = (
img≥l
Ë((
P_J
 + 2*
P_I
 + 
P_X
 + 2) >> 2);

176 
cur_¥ed
[0][0] =

177 
cur_¥ed
[1][1] =

178 
cur_¥ed
[2][2] =

179 
cur_¥ed
[3][3] = (
img≥l
Ë((
P_I
 + 2*
P_X
 + 
P_A
 + 2) >> 2);

180 
cur_¥ed
[0][1] =

181 
cur_¥ed
[1][2] =

182 
cur_¥ed
[2][3] = (
img≥l
Ë((
P_X
 + 2*
P_A
 + 
P_B
 + 2) >> 2);

183 
cur_¥ed
[0][2] =

184 
cur_¥ed
[1][3] = (
img≥l
Ë((
P_A
 + 2*
P_B
 + 
P_C
 + 2) >> 2);

185 
cur_¥ed
[0][3] = (
img≥l
Ë((
P_B
 + 2*
P_C
 + 
P_D
 + 2) >> 2);

186 
	}
}

195 
ölöe
 
	$gë_i4x4_vîée·
(
img≥l
 **
cur_¥ed
, img≥»*
PªdPñ
)

197 
cur_¥ed
[0][0] = (
img≥l
Ë((
P_A
 + 
P_B
 + 1) >> 1);

198 
cur_¥ed
[0][1] =

199 
cur_¥ed
[2][0] = (
img≥l
Ë((
P_B
 + 
P_C
 + 1) >> 1);

200 
cur_¥ed
[0][2] =

201 
cur_¥ed
[2][1] = (
img≥l
Ë((
P_C
 + 
P_D
 + 1) >> 1);

202 
cur_¥ed
[0][3] =

203 
cur_¥ed
[2][2] = (
img≥l
Ë((
P_D
 + 
P_E
 + 1) >> 1);

204 
cur_¥ed
[2][3] = (
img≥l
Ë((
P_E
 + 
P_F
 + 1) >> 1);

205 
cur_¥ed
[1][0] = (
img≥l
Ë((
P_A
 + ((
P_B
)<<1Ë+ 
P_C
 + 2) >> 2);

206 
cur_¥ed
[1][1] =

207 
cur_¥ed
[3][0] = (
img≥l
Ë((
P_B
 + ((
P_C
)<<1Ë+ 
P_D
 + 2) >> 2);

208 
cur_¥ed
[1][2] =

209 
cur_¥ed
[3][1] = (
img≥l
Ë((
P_C
 + ((
P_D
)<<1Ë+ 
P_E
 + 2) >> 2);

210 
cur_¥ed
[1][3] =

211 
cur_¥ed
[3][2] = (
img≥l
Ë((
P_D
 + ((
P_E
)<<1Ë+ 
P_F
 + 2) >> 2);

212 
cur_¥ed
[3][3] = (
img≥l
Ë((
P_E
 + ((
P_F
)<<1Ë+ 
P_G
 + 2) >> 2);

213 
	}
}

221 
ölöe
 
	$gë_i4x4_vîåight
(
img≥l
 **
cur_¥ed
, img≥»*
PªdPñ
)

223 
cur_¥ed
[0][0] =

224 
cur_¥ed
[2][1] = (
img≥l
Ë((
P_X
 + 
P_A
 + 1) >> 1);

225 
cur_¥ed
[0][1] =

226 
cur_¥ed
[2][2] = (
img≥l
Ë((
P_A
 + 
P_B
 + 1) >> 1);

227 
cur_¥ed
[0][2] =

228 
cur_¥ed
[2][3] = (
img≥l
Ë((
P_B
 + 
P_C
 + 1) >> 1);

229 
cur_¥ed
[0][3] = (
img≥l
Ë((
P_C
 + 
P_D
 + 1) >> 1);

230 
cur_¥ed
[1][0] =

231 
cur_¥ed
[3][1] = (
img≥l
Ë((
P_I
 + 2*
P_X
 + 
P_A
 + 2) >> 2);

232 
cur_¥ed
[1][1] =

233 
cur_¥ed
[3][2] = (
img≥l
Ë((
P_X
 + 2*
P_A
 + 
P_B
 + 2) >> 2);

234 
cur_¥ed
[1][2] =

235 
cur_¥ed
[3][3] = (
img≥l
Ë((
P_A
 + 2*
P_B
 + 
P_C
 + 2) >> 2);

236 
cur_¥ed
[1][3] = (
img≥l
Ë((
P_B
 + 2*
P_C
 + 
P_D
 + 2) >> 2);

237 
cur_¥ed
[2][0] = (
img≥l
Ë((
P_X
 + 2*
P_I
 + 
P_J
 + 2) >> 2);

238 
cur_¥ed
[3][0] = (
img≥l
Ë((
P_I
 + 2*
P_J
 + 
P_K
 + 2) >> 2);

239 
	}
}

247 
ölöe
 
	$gë_i4x4_h‹down
(
img≥l
 **
cur_¥ed
, img≥»*
PªdPñ
)

249 
cur_¥ed
[0][0] =

250 
cur_¥ed
[1][2] = (
img≥l
Ë((
P_X
 + 
P_I
 + 1) >> 1);

251 
cur_¥ed
[0][1] =

252 
cur_¥ed
[1][3] = (
img≥l
Ë((
P_I
 + 2*
P_X
 + 
P_A
 + 2) >> 2);

253 
cur_¥ed
[0][2] = (
img≥l
Ë((
P_X
 + 2*
P_A
 + 
P_B
 + 2) >> 2);

254 
cur_¥ed
[0][3] = (
img≥l
Ë((
P_A
 + 2*
P_B
 + 
P_C
 + 2) >> 2);

255 
cur_¥ed
[1][0] =

256 
cur_¥ed
[2][2] = (
img≥l
Ë((
P_I
 + 
P_J
 + 1) >> 1);

257 
cur_¥ed
[1][1] =

258 
cur_¥ed
[2][3] = (
img≥l
Ë((
P_X
 + 2*
P_I
 + 
P_J
 + 2) >> 2);

259 
cur_¥ed
[2][0] =

260 
cur_¥ed
[3][2] = (
img≥l
Ë((
P_J
 + 
P_K
 + 1) >> 1);

261 
cur_¥ed
[2][1] =

262 
cur_¥ed
[3][3] = (
img≥l
Ë((
P_I
 + 2*
P_J
 + 
P_K
 + 2) >> 2);

263 
cur_¥ed
[3][0] = (
img≥l
Ë((
P_K
 + 
P_L
 + 1) >> 1);

264 
cur_¥ed
[3][1] = (
img≥l
Ë((
P_J
 + 2*
P_K
 + 
P_L
 + 2) >> 2);

265 
	}
}

274 
ölöe
 
	$gë_i4x4_h‹up
(
img≥l
 **
cur_¥ed
, img≥»*
PªdPñ
)

276 
cur_¥ed
[0][0] = (
img≥l
Ë((
P_I
 + 
P_J
 + 1) >> 1);

277 
cur_¥ed
[0][1] = (
img≥l
Ë((
P_I
 + 2*
P_J
 + 
P_K
 + 2) >> 2);

278 
cur_¥ed
[0][2] =

279 
cur_¥ed
[1][0] = (
img≥l
Ë((
P_J
 + 
P_K
 + 1) >> 1);

280 
cur_¥ed
[0][3] =

281 
cur_¥ed
[1][1] = (
img≥l
Ë((
P_J
 + 2*
P_K
 + 
P_L
 + 2) >> 2);

282 
cur_¥ed
[1][2] =

283 
cur_¥ed
[2][0] = (
img≥l
Ë((
P_K
 + 
P_L
 + 1) >> 1);

284 
cur_¥ed
[1][3] =

285 
cur_¥ed
[2][1] = (
img≥l
Ë((
P_K
 + 2*
P_L
 + P_L + 2) >> 2);

286 
cur_¥ed
[3][0] =

287 
cur_¥ed
[2][2] =

288 
cur_¥ed
[2][3] =

289 
cur_¥ed
[3][1] =

290 
cur_¥ed
[3][2] =

291 
cur_¥ed
[3][3] = (
img≥l
Ë
P_L
;

292 
	}
}

310 
	$£t_öå≠ªd_4x4_mbaff
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
img_x
,
img_y
, *
À·_avaûabÀ
, *
up_avaûabÀ
, *
Æl_avaûabÀ
)

312 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

313 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

315 
i
;

316 
img≥l
 *
PªdPñ
 = 
cuºMB
->
öåa4x4_¥ed
[
∂
];

317 
img≥l
 **
img_íc
 = 
p_Vid
->
íc_pi˘uª
->
p_cuº_img
;

319 
ioff
 = (
img_x
 & 15);

320 
joff
 = (
img_y
 & 15);

322 
PixñPos
 
pix_a
[4];

323 
PixñPos
 
pix_b
, 
pix_c
, 
pix_d
;

325 
block_avaûabÀ_up
;

326 
block_avaûabÀ_À·
;

327 
block_avaûabÀ_up_À·
;

328 
block_avaûabÀ_up_right
;

329 *
mb_size
 = 
p_Vid
->mb_size[
IS_LUMA
];

331 
i
 = 0; i < 4; i++)

333 
p_Vid
->
	`gëNeighbour
(
cuºMB
, 
ioff
 -1 , 
joff
 + 
i
 , 
mb_size
, &
pix_a
[i]);

336 
p_Vid
->
	`gëNeighbour
(
cuºMB
, 
ioff
 , 
joff
 -1 , 
mb_size
, &
pix_b
);

337 
p_Vid
->
	`gëNeighbour
(
cuºMB
, 
ioff
 + 4 , 
joff
 -1 , 
mb_size
, &
pix_c
);

338 
p_Vid
->
	`gëNeighbour
(
cuºMB
, 
ioff
 - 1 , 
joff
 -1 , 
mb_size
, &
pix_d
);

340 
pix_c
.
avaûabÀ
 =Öix_c.avaûabÀ && !((
ioff
==4Ë&& ((
joff
==4)||(joff==12)));

342 i‡(
p_I≈
->
U£C⁄°øöedI¡øPªd
)

344 
i
=0, 
block_avaûabÀ_À·
=1; i<4;i++)

345 
block_avaûabÀ_À·
 &
pix_a
[
i
].
avaûabÀ
 ? 
p_Vid
->
öåa_block
[pix_a[i].
mb_addr
]: 0;

346 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
p_Vid
->
öåa_block
 [pix_b.
mb_addr
] : 0;

347 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
 ? 
p_Vid
->
öåa_block
 [pix_c.
mb_addr
] : 0;

348 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
 ? 
p_Vid
->
öåa_block
 [pix_d.
mb_addr
] : 0;

352 
block_avaûabÀ_À·
 = 
pix_a
[0].
avaûabÀ
;

353 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

354 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
;

355 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
;

358 *
À·_avaûabÀ
 = 
block_avaûabÀ_À·
;

359 *
up_avaûabÀ
 = 
block_avaûabÀ_up
;

360 *
Æl_avaûabÀ
 = 
block_avaûabÀ_up
 && 
block_avaûabÀ_À·
 && 
block_avaûabÀ_up_À·
;

362 
i
 = (
img_x
 & 15);

365 i‡(
block_avaûabÀ_up
)

367 
	`mem˝y
(&
PªdPñ
[1], &
img_íc
[
pix_b
.
pos_y
][pix_b.
pos_x
], 
BLOCK_SIZE
 * (
img≥l
));

371 
P_A
 = 
P_B
 = 
P_C
 = 
P_D
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue
;

374 i‡(
block_avaûabÀ_up_right
)

376 
	`mem˝y
(&
PªdPñ
[5], &
img_íc
[
pix_c
.
pos_y
][pix_c.
pos_x
], 
BLOCK_SIZE
 * (
img≥l
));

380 
P_E
 = 
P_F
 = 
P_G
 = 
P_H
 = 
P_D
;

383 i‡(
block_avaûabÀ_À·
)

385 
P_I
 = 
img_íc
[
pix_a
[0].
pos_y
][pix_a[0].
pos_x
];

386 
P_J
 = 
img_íc
[
pix_a
[1].
pos_y
][pix_a[1].
pos_x
];

387 
P_K
 = 
img_íc
[
pix_a
[2].
pos_y
][pix_a[2].
pos_x
];

388 
P_L
 = 
img_íc
[
pix_a
[3].
pos_y
][pix_a[3].
pos_x
];

392 
P_I
 = 
P_J
 = 
P_K
 = 
P_L
 = 
p_Vid
->
dc_¥ed_vÆue
;

395 i‡(
block_avaûabÀ_up_À·
)

397 
P_X
 = 
img_íc
[
pix_d
.
pos_y
][pix_d.
pos_x
];

401 
P_X
 = 
p_Vid
->
dc_¥ed_vÆue
;

403 
	}
}

421 
	$£t_öå≠ªd_4x4
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
img_x
,
img_y
, *
À·_avaûabÀ
, *
up_avaûabÀ
, *
Æl_avaûabÀ
)

423 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

424 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

426 
img≥l
 *
PªdPñ
 = 
cuºMB
->
öåa4x4_¥ed
[
∂
];

427 
img≥l
 **
img_íc
 = 
p_Vid
->
íc_pi˘uª
->
p_cuº_img
;

429 
ioff
 = (
img_x
 & 15);

430 
joff
 = (
img_y
 & 15);

432 
PixñPos
 
pix_a
, 
pix_b
, 
pix_c
, 
pix_d
;

434 
block_avaûabÀ_up
;

435 
block_avaûabÀ_À·
;

436 
block_avaûabÀ_up_À·
;

437 
block_avaûabÀ_up_right
;

438 *
mb_size
 = 
p_Vid
->mb_size[
IS_LUMA
];

440 
p_Vid
->
	`gëNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 , 
mb_size
, &
pix_a
);

441 
p_Vid
->
	`gëNeighbour
(
cuºMB
, 
ioff
 , 
joff
 - 1, 
mb_size
, &
pix_b
);

442 
p_Vid
->
	`gëNeighbour
(
cuºMB
, 
ioff
 + 4, 
joff
 - 1, 
mb_size
, &
pix_c
);

443 
p_Vid
->
	`gëNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 - 1, 
mb_size
, &
pix_d
);

445 
pix_c
.
avaûabÀ
 =Öix_c.avaûabÀ && !((
ioff
==4Ë&& ((
joff
==4)||(joff==12)));

447 i‡(
p_I≈
->
U£C⁄°øöedI¡øPªd
)

449 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
 ? 
p_Vid
->
öåa_block
 [pix_a.
mb_addr
]: 0;

450 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
p_Vid
->
öåa_block
 [pix_b.
mb_addr
] : 0;

451 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
 ? 
p_Vid
->
öåa_block
 [pix_c.
mb_addr
] : 0;

452 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
 ? 
p_Vid
->
öåa_block
 [pix_d.
mb_addr
] : 0;

456 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
;

457 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

458 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
;

459 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
;

462 *
À·_avaûabÀ
 = 
block_avaûabÀ_À·
;

463 *
up_avaûabÀ
 = 
block_avaûabÀ_up
;

464 *
Æl_avaûabÀ
 = 
block_avaûabÀ_up
 && 
block_avaûabÀ_À·
 && 
block_avaûabÀ_up_À·
;

467 i‡(
block_avaûabÀ_up
)

469 
	`mem˝y
(&
PªdPñ
[1], &
img_íc
[
pix_b
.
pos_y
][pix_b.
pos_x
], 
BLOCK_SIZE
 * (
img≥l
));

473 
P_A
 = 
P_B
 = 
P_C
 = 
P_D
 = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue
;

476 i‡(
block_avaûabÀ_up_right
)

478 
	`mem˝y
(&
PªdPñ
[5], &
img_íc
[
pix_c
.
pos_y
][pix_c.
pos_x
], 
BLOCK_SIZE
 * (
img≥l
));

482 
P_E
 = 
P_F
 = 
P_G
 = 
P_H
 = 
P_D
;

485 i‡(
block_avaûabÀ_À·
)

487 
pos_y
 = 
pix_a
.pos_y;

488 
pos_x
 = 
pix_a
.pos_x;

489 
P_I
 = 
img_íc
[
pos_y
++][
pos_x
];

490 
P_J
 = 
img_íc
[
pos_y
++][
pos_x
];

491 
P_K
 = 
img_íc
[
pos_y
++][
pos_x
];

492 
P_L
 = 
img_íc
[
pos_y
 ][
pos_x
];

496 
P_I
 = 
P_J
 = 
P_K
 = 
P_L
 = 
p_Vid
->
dc_¥ed_vÆue
;

499 i‡(
block_avaûabÀ_up_À·
)

501 
P_X
 = 
img_íc
[
pix_d
.
pos_y
][pix_d.
pos_x
];

505 
P_X
 = 
p_Vid
->
dc_¥ed_vÆue
;

507 
	}
}

521 
	$gë_öå≠ªd_4x4
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
i4x4_mode
, 
img_x
, 
img_y
, 
À·_avaûabÀ
, 
up_avaûabÀ
)

523 
img≥l
 *
PªdPñ
 = 
cuºMB
->
öåa4x4_¥ed
[
∂
];

524 
img≥l
 ***
cuº_m¥_4x4
 = 
cuºMB
->
p_Sli˚
->
m¥_4x4
[
∂
];

528 
i4x4_mode
)

530 
VERT_PRED
 :

531 
	`gë_i4x4_vîtiˇl
(
cuº_m¥_4x4
[
VERT_PRED
], 
PªdPñ
);

533 
HOR_PRED
 :

534 
	`gë_i4x4_h‹iz⁄èl
(
cuº_m¥_4x4
[
HOR_PRED
], 
PªdPñ
);

536 
DC_PRED
 :

537 
	`gë_i4x4_dc
(
cuº_m¥_4x4
[
DC_PRED
], 
PªdPñ
, 
À·_avaûabÀ
, 
up_avaûabÀ
);

539 
DIAG_DOWN_LEFT_PRED
 :

540 
	`gë_i4x4_dow∆e·
(
cuº_m¥_4x4
[
DIAG_DOWN_LEFT_PRED
], 
PªdPñ
);

542 
DIAG_DOWN_RIGHT_PRED
 :

543 
	`gë_i4x4_dowƒight
(
cuº_m¥_4x4
[
DIAG_DOWN_RIGHT_PRED
], 
PªdPñ
);

545 
VERT_RIGHT_PRED
 :

546 
	`gë_i4x4_vîåight
(
cuº_m¥_4x4
[
VERT_RIGHT_PRED
], 
PªdPñ
);

548 
HOR_DOWN_PRED
 :

549 
	`gë_i4x4_h‹down
(
cuº_m¥_4x4
[
HOR_DOWN_PRED
], 
PªdPñ
);

551 
VERT_LEFT_PRED
 :

552 
	`gë_i4x4_vîée·
(
cuº_m¥_4x4
[
VERT_LEFT_PRED
], 
PªdPñ
);

554 
HOR_UP_PRED
 :

555 
	`gë_i4x4_h‹up
(
cuº_m¥_4x4
[
HOR_UP_PRED
], 
PªdPñ
);

558 
	`¥ötf
("invalidÖrediction mode \n");

561 
	}
}

	@lencod/src/intra8x8.c

14 
	~"globÆ.h
"

15 
	~"image.h
"

16 
	~"mb_ac˚ss.h
"

17 
	~"öåa8x8.h
"

34 
	#P_Z
 (
PªdPñ
[0])

	)

35 
	#P_A
 (
PªdPñ
[1])

	)

36 
	#P_B
 (
PªdPñ
[2])

	)

37 
	#P_C
 (
PªdPñ
[3])

	)

38 
	#P_D
 (
PªdPñ
[4])

	)

39 
	#P_E
 (
PªdPñ
[5])

	)

40 
	#P_F
 (
PªdPñ
[6])

	)

41 
	#P_G
 (
PªdPñ
[7])

	)

42 
	#P_H
 (
PªdPñ
[8])

	)

43 
	#P_I
 (
PªdPñ
[9])

	)

44 
	#P_J
 (
PªdPñ
[10])

	)

45 
	#P_K
 (
PªdPñ
[11])

	)

46 
	#P_L
 (
PªdPñ
[12])

	)

47 
	#P_M
 (
PªdPñ
[13])

	)

48 
	#P_N
 (
PªdPñ
[14])

	)

49 
	#P_O
 (
PªdPñ
[15])

	)

50 
	#P_P
 (
PªdPñ
[16])

	)

51 
	#P_Q
 (
PªdPñ
[17])

	)

52 
	#P_R
 (
PªdPñ
[18])

	)

53 
	#P_S
 (
PªdPñ
[19])

	)

54 
	#P_T
 (
PªdPñ
[20])

	)

55 
	#P_U
 (
PªdPñ
[21])

	)

56 
	#P_V
 (
PªdPñ
[22])

	)

57 
	#P_W
 (
PªdPñ
[23])

	)

58 
	#P_X
 (
PªdPñ
[24])

	)

60 
	$gíî©e_¥ed_îr‹_8x8
(
img≥l
 **
cur_img
, img≥»**
¥d_img
, img≥»**
cur_¥d
,

61 **
m7
, 
pic_›ix_x
, 
block_x
)

63 
j
, 
i
, *
m7_löe
;

64 
img≥l
 *
cur_löe
, *
¥d_löe
;

66 
j
=0; j < 
BLOCK_SIZE_8x8
; j++)

68 
¥d_löe
 = 
¥d_img
[
j
];

69 
	`mem˝y
(&
cur_¥d
[
j
][
block_x
], 
¥d_löe
, 
BLOCK_SIZE_8x8
 * (
img≥l
));

70 
cur_löe
 = &
cur_img
[
j
][
pic_›ix_x
];

71 
m7_löe
 = &
m7
[
j
][
block_x
];

72 
i
 = 0; i < 
BLOCK_SIZE_8x8
; i++)

74 *
m7_löe
++ = (Ë(*
cur_löe
++ - *
¥d_löe
++);

77 
	}
}

85 
	$LowPassF‹I¡ø8x8Pªd
(
img≥l
 *
PªdPñ
, 
block_up_À·
, 
block_up
, 
block_À·
)

87 
i
;

88 
img≥l
 
Lo›Aºay
[25];

90 
	`mem˝y
(
Lo›Aºay
,
PªdPñ
, 25 * (
img≥l
));

92 if(
block_up
)

94 if(
block_up_À·
)

96 
Lo›Aºay
[1] = (
img≥l
Ë((
PªdPñ
[0] + (PredPel[1]<<1) + PredPel[2] + 2) >> 2);

99 
Lo›Aºay
[1] = (
img≥l
Ë((
PªdPñ
[1] + (PredPel[1]<<1) + PredPel[2] + 2) >> 2);

102 
i
 = 2; i <16; i++)

104 
Lo›Aºay
[
i
] = (
img≥l
Ë((
PªdPñ
[i-1] + (PredPel[i]<<1) + PredPel[i+1] + 2) >> 2);

106 
Lo›Aºay
[16] = (
img≥l
Ë((
PªdPñ
[15] + PredPel[16] + (PredPel[16]<<1) + 2) >> 2);

109 if(
block_up_À·
)

111 if(
block_up
 && 
block_À·
)

113 
Lo›Aºay
[0] = (
img≥l
Ë(((
PªdPñ
[0] << 1) + PredPel[1] + PredPel[17] + 2) >> 2);

117 if(
block_up
)

118 
Lo›Aºay
[0] = (
img≥l
Ë((
PªdPñ
[0] + (PredPel[0] << 1) + PredPel[1] + 2) >> 2);

120 if(
block_À·
)

121 
Lo›Aºay
[0] = (
img≥l
Ë((
PªdPñ
[0] + (PredPel[0] << 1) + PredPel[17] + 2) >> 2);

125 if(
block_À·
)

127 if(
block_up_À·
)

128 
Lo›Aºay
[17] = (
img≥l
Ë((
PªdPñ
[0] + (PredPel[17] << 1) + PredPel[18] + 2) >> 2);

130 
Lo›Aºay
[17] = (
img≥l
Ë((
PªdPñ
[17] + (PredPel[17] << 1) + PredPel[18] + 2) >> 2);

132 
i
 = 18; i <24; i++)

134 
Lo›Aºay
[
i
] = (
img≥l
Ë((
PªdPñ
[i-1] + (PredPel[i]<<1) + PredPel[i+1] + 2) >> 2);

136 
Lo›Aºay
[24] = (
img≥l
Ë((
PªdPñ
[23] + (PredPel[24] << 1) + PredPel[24] + 2) >> 2);

139 
	`mem˝y
(
PªdPñ
, 
Lo›Aºay
, 25 * (
img≥l
));

140 
	}
}

148 
ölöe
 
	$gë_i8x8_vîtiˇl
(
img≥l
 **
cur_¥ed
, img≥»*
PªdPñ
)

150 
j
;

151 
j
=0; j < 
BLOCK_SIZE_8x8
; j++)

152 
	`mem˝y
(
cur_¥ed
[
j
], &
P_A
, 
BLOCK_SIZE_8x8
 * (
img≥l
));

153 
	}
}

161 
ölöe
 
	$gë_i8x8_h‹iz⁄èl
(
img≥l
 **
cur_¥ed
, img≥»*
PªdPñ
)

163 
i
;

164 
i
=0; i < 
BLOCK_SIZE_8x8
; i++)

166 
cur_¥ed
[
i
][0] =

167 
cur_¥ed
[
i
][1] =

168 
cur_¥ed
[
i
][2] =

169 
cur_¥ed
[
i
][3] =

170 
cur_¥ed
[
i
][4] =

171 
cur_¥ed
[
i
][5] =

172 
cur_¥ed
[
i
][6] =

173 
cur_¥ed
[
i
][7] = (
img≥l
Ë(&
P_Q
)[i];

175 
	}
}

183 
ölöe
 
	$gë_i8x8_dc
(
img≥l
 **
cur_¥ed
, img≥»*
PªdPñ
, 
À·_avaûabÀ
, 
up_avaûabÀ
)

185 
i
, 
j
, 
s0
 = 0;

186 i‡(
up_avaûabÀ
 && 
À·_avaûabÀ
)

189 
s0
 = 
	`rshi·_∫d_sf
((
P_A
 + 
P_B
 + 
P_C
 + 
P_D
 + 
P_E
 + 
P_F
 + 
P_G
 + 
P_H
 + 
P_Q
 + 
P_R
 + 
P_S
 + 
P_T
 + 
P_U
 + 
P_V
 + 
P_W
 + 
P_X
), 4);

191 i‡(!
up_avaûabÀ
 && 
À·_avaûabÀ
)

194 
s0
 = 
	`rshi·_∫d_sf
((
P_Q
 + 
P_R
 + 
P_S
 + 
P_T
 + 
P_U
 + 
P_V
 + 
P_W
 + 
P_X
), 3);

196 i‡(
up_avaûabÀ
 && !
À·_avaûabÀ
)

199 
s0
 = 
	`rshi·_∫d_sf
((
P_A
 + 
P_B
 + 
P_C
 + 
P_D
 + 
P_E
 + 
P_F
 + 
P_G
 + 
P_H
), 3);

204 
s0
 = 
P_A
;

208 
i
=0; i < 
BLOCK_SIZE_8x8
; i++)

210 
cur_¥ed
[0][
i
] = (
img≥l
Ë
s0
;

213 
j
=0; j < 
BLOCK_SIZE_8x8
 - 1; j++)

215 
	`mem˝y
 (
cur_¥ed
[
j
 + 1], cur_¥ed[j], 
BLOCK_SIZE_8x8
 * (
img≥l
));

217 
	}
}

225 
ölöe
 
	$gë_i8x8_dow∆e·
(
img≥l
 **
cur_¥ed
, img≥»*
PªdPñ
)

227 
img≥l
 
PªdAºay
[16];

228 
img≥l
 *
Pªd
 = &
PªdAºay
[0];

231 *
Pªd
++ = (
img≥l
Ë((
P_A
 + 
P_C
 + ((
P_B
) << 1) + 2) >> 2);

232 *
Pªd
++ = (
img≥l
Ë((
P_B
 + 
P_D
 + ((
P_C
) << 1) + 2) >> 2);

233 *
Pªd
++ = (
img≥l
Ë((
P_C
 + 
P_E
 + ((
P_D
) << 1) + 2) >> 2);

234 *
Pªd
++ = (
img≥l
Ë((
P_D
 + 
P_F
 + ((
P_E
) << 1) + 2) >> 2);

235 *
Pªd
++ = (
img≥l
Ë((
P_E
 + 
P_G
 + ((
P_F
) << 1) + 2) >> 2);

236 *
Pªd
++ = (
img≥l
Ë((
P_F
 + 
P_H
 + ((
P_G
) << 1) + 2) >> 2);

237 *
Pªd
++ = (
img≥l
Ë((
P_G
 + 
P_I
 + ((
P_H
) << 1) + 2) >> 2);

238 *
Pªd
++ = (
img≥l
Ë((
P_H
 + 
P_J
 + ((
P_I
) << 1) + 2) >> 2);

239 *
Pªd
++ = (
img≥l
Ë((
P_I
 + 
P_K
 + ((
P_J
) << 1) + 2) >> 2);

240 *
Pªd
++ = (
img≥l
Ë((
P_J
 + 
P_L
 + ((
P_K
) << 1) + 2) >> 2);

241 *
Pªd
++ = (
img≥l
Ë((
P_K
 + 
P_M
 + ((
P_L
) << 1) + 2) >> 2);

242 *
Pªd
++ = (
img≥l
Ë((
P_L
 + 
P_N
 + ((
P_M
) << 1) + 2) >> 2);

243 *
Pªd
++ = (
img≥l
Ë((
P_M
 + 
P_O
 + ((
P_N
) << 1) + 2) >> 2);

244 *
Pªd
++ = (
img≥l
Ë((
P_N
 + 
P_P
 + ((
P_O
) << 1) + 2) >> 2);

245 *
Pªd
 = (
img≥l
Ë((
P_O
 + 
P_P
 + ((P_P) << 1) + 2) >> 2);

247 
Pªd
 = &
PªdAºay
[ 0];

249 
	`mem˝y
(*
cur_¥ed
++, 
Pªd
++, 8 * (
img≥l
));

250 
	`mem˝y
(*
cur_¥ed
++, 
Pªd
++, 8 * (
img≥l
));

251 
	`mem˝y
(*
cur_¥ed
++, 
Pªd
++, 8 * (
img≥l
));

252 
	`mem˝y
(*
cur_¥ed
++, 
Pªd
++, 8 * (
img≥l
));

253 
	`mem˝y
(*
cur_¥ed
++, 
Pªd
++, 8 * (
img≥l
));

254 
	`mem˝y
(*
cur_¥ed
++, 
Pªd
++, 8 * (
img≥l
));

255 
	`mem˝y
(*
cur_¥ed
++, 
Pªd
++, 8 * (
img≥l
));

256 
	`mem˝y
(*
cur_¥ed
 , 
Pªd
 , 8 * (
img≥l
));

257 
	}
}

265 
ölöe
 
	$gë_i8x8_dowƒight
(
img≥l
 **
cur_¥ed
, img≥»*
PªdPñ
)

267 
img≥l
 
PªdAºay
[16];

268 
img≥l
 *
Pªd
 = &
PªdAºay
[0];

271 *
Pªd
++ = (
img≥l
Ë((
P_X
 + 
P_V
 + ((
P_W
) << 1) + 2) >> 2);

272 *
Pªd
++ = (
img≥l
Ë((
P_W
 + 
P_U
 + ((
P_V
) << 1) + 2) >> 2);

273 *
Pªd
++ = (
img≥l
Ë((
P_V
 + 
P_T
 + ((
P_U
) << 1) + 2) >> 2);

274 *
Pªd
++ = (
img≥l
Ë((
P_U
 + 
P_S
 + ((
P_T
) << 1) + 2) >> 2);

275 *
Pªd
++ = (
img≥l
Ë((
P_T
 + 
P_R
 + ((
P_S
) << 1) + 2) >> 2);

276 *
Pªd
++ = (
img≥l
Ë((
P_S
 + 
P_Q
 + ((
P_R
) << 1) + 2) >> 2);

277 *
Pªd
++ = (
img≥l
Ë((
P_R
 + 
P_Z
 + ((
P_Q
) << 1) + 2) >> 2);

278 *
Pªd
++ = (
img≥l
Ë((
P_Q
 + 
P_A
 + ((
P_Z
) << 1) + 2) >> 2);

279 *
Pªd
++ = (
img≥l
Ë((
P_Z
 + 
P_B
 + ((
P_A
) << 1) + 2) >> 2);

280 *
Pªd
++ = (
img≥l
Ë((
P_A
 + 
P_C
 + ((
P_B
) << 1) + 2) >> 2);

281 *
Pªd
++ = (
img≥l
Ë((
P_B
 + 
P_D
 + ((
P_C
) << 1) + 2) >> 2);

282 *
Pªd
++ = (
img≥l
Ë((
P_C
 + 
P_E
 + ((
P_D
) << 1) + 2) >> 2);

283 *
Pªd
++ = (
img≥l
Ë((
P_D
 + 
P_F
 + ((
P_E
) << 1) + 2) >> 2);

284 *
Pªd
++ = (
img≥l
Ë((
P_E
 + 
P_G
 + ((
P_F
) << 1) + 2) >> 2);

285 *
Pªd
 = (
img≥l
Ë((
P_F
 + 
P_H
 + ((
P_G
) << 1) + 2) >> 2);

287 
Pªd
 = &
PªdAºay
[7];

289 
	`mem˝y
(*
cur_¥ed
++, 
Pªd
--, 8 * (
img≥l
));

290 
	`mem˝y
(*
cur_¥ed
++, 
Pªd
--, 8 * (
img≥l
));

291 
	`mem˝y
(*
cur_¥ed
++, 
Pªd
--, 8 * (
img≥l
));

292 
	`mem˝y
(*
cur_¥ed
++, 
Pªd
--, 8 * (
img≥l
));

293 
	`mem˝y
(*
cur_¥ed
++, 
Pªd
--, 8 * (
img≥l
));

294 
	`mem˝y
(*
cur_¥ed
++, 
Pªd
--, 8 * (
img≥l
));

295 
	`mem˝y
(*
cur_¥ed
++, 
Pªd
--, 8 * (
img≥l
));

296 
	`mem˝y
(*
cur_¥ed
 , 
Pªd
 , 8 * (
img≥l
));

297 
	}
}

305 
ölöe
 
	$gë_i8x8_vîée·
(
img≥l
 **
cur_¥ed
, img≥»*
PªdPñ
)

307 
img≥l
 
PªdAºay
[22];

308 
img≥l
 *
Pªd
 = &
PªdAºay
[0];

310 *
Pªd
++ = (
img≥l
Ë((
P_A
 + 
P_B
 + 1) >> 1);

311 *
Pªd
++ = (
img≥l
Ë((
P_B
 + 
P_C
 + 1) >> 1);

312 *
Pªd
++ = (
img≥l
Ë((
P_C
 + 
P_D
 + 1) >> 1);

313 *
Pªd
++ = (
img≥l
Ë((
P_D
 + 
P_E
 + 1) >> 1);

314 *
Pªd
++ = (
img≥l
Ë((
P_E
 + 
P_F
 + 1) >> 1);

315 *
Pªd
++ = (
img≥l
Ë((
P_F
 + 
P_G
 + 1) >> 1);

316 *
Pªd
++ = (
img≥l
Ë((
P_G
 + 
P_H
 + 1) >> 1);

317 *
Pªd
++ = (
img≥l
Ë((
P_H
 + 
P_I
 + 1) >> 1);

318 *
Pªd
++ = (
img≥l
Ë((
P_I
 + 
P_J
 + 1) >> 1);

319 *
Pªd
++ = (
img≥l
Ë((
P_J
 + 
P_K
 + 1) >> 1);

320 *
Pªd
++ = (
img≥l
Ë((
P_K
 + 
P_L
 + 1) >> 1);

321 *
Pªd
++ = (
img≥l
Ë((
P_A
 + 
P_C
 + ((
P_B
) << 1) + 2) >> 2);

322 *
Pªd
++ = (
img≥l
Ë((
P_B
 + 
P_D
 + ((
P_C
) << 1) + 2) >> 2);

323 *
Pªd
++ = (
img≥l
Ë((
P_C
 + 
P_E
 + ((
P_D
) << 1) + 2) >> 2);

324 *
Pªd
++ = (
img≥l
Ë((
P_D
 + 
P_F
 + ((
P_E
) << 1) + 2) >> 2);

325 *
Pªd
++ = (
img≥l
Ë((
P_E
 + 
P_G
 + ((
P_F
) << 1) + 2) >> 2);

326 *
Pªd
++ = (
img≥l
Ë((
P_F
 + 
P_H
 + ((
P_G
) << 1) + 2) >> 2);

327 *
Pªd
++ = (
img≥l
Ë((
P_G
 + 
P_I
 + ((
P_H
) << 1) + 2) >> 2);

328 *
Pªd
++ = (
img≥l
Ë((
P_H
 + 
P_J
 + ((
P_I
) << 1) + 2) >> 2);

329 *
Pªd
++ = (
img≥l
Ë((
P_I
 + 
P_K
 + ((
P_J
) << 1) + 2) >> 2);

330 *
Pªd
++ = (
img≥l
Ë((
P_J
 + 
P_L
 + ((
P_K
) << 1) + 2) >> 2);

331 *
Pªd
 = (
img≥l
Ë((
P_K
 + 
P_M
 + ((
P_L
) << 1) + 2) >> 2);

333 
	`mem˝y
(*
cur_¥ed
++, &
PªdAºay
[ 0], 8 * (
img≥l
));

334 
	`mem˝y
(*
cur_¥ed
++, &
PªdAºay
[11], 8 * (
img≥l
));

335 
	`mem˝y
(*
cur_¥ed
++, &
PªdAºay
[ 1], 8 * (
img≥l
));

336 
	`mem˝y
(*
cur_¥ed
++, &
PªdAºay
[12], 8 * (
img≥l
));

337 
	`mem˝y
(*
cur_¥ed
++, &
PªdAºay
[ 2], 8 * (
img≥l
));

338 
	`mem˝y
(*
cur_¥ed
++, &
PªdAºay
[13], 8 * (
img≥l
));

339 
	`mem˝y
(*
cur_¥ed
++, &
PªdAºay
[ 3], 8 * (
img≥l
));

340 
	`mem˝y
(*
cur_¥ed
 , &
PªdAºay
[14], 8 * (
img≥l
));

341 
	}
}

350 
ölöe
 
	$gë_i8x8_vîåight
(
img≥l
 **
cur_¥ed
, img≥»*
PªdPñ
)

352 
img≥l
 
PªdAºay
[22];

353 
img≥l
 *
Pªd
 = &
PªdAºay
[0];

355 *
Pªd
++ = (
img≥l
Ë((
P_V
 + 
P_T
 + ((
P_U
) << 1) + 2) >> 2);

356 *
Pªd
++ = (
img≥l
Ë((
P_T
 + 
P_R
 + ((
P_S
) << 1) + 2) >> 2);

357 *
Pªd
++ = (
img≥l
Ë((
P_R
 + 
P_Z
 + ((
P_Q
) << 1) + 2) >> 2);

358 *
Pªd
++ = (
img≥l
Ë((
P_Z
 + 
P_A
 + 1) >> 1);

359 *
Pªd
++ = (
img≥l
Ë((
P_A
 + 
P_B
 + 1) >> 1);

360 *
Pªd
++ = (
img≥l
Ë((
P_B
 + 
P_C
 + 1) >> 1);

361 *
Pªd
++ = (
img≥l
Ë((
P_C
 + 
P_D
 + 1) >> 1);

362 *
Pªd
++ = (
img≥l
Ë((
P_D
 + 
P_E
 + 1) >> 1);

363 *
Pªd
++ = (
img≥l
Ë((
P_E
 + 
P_F
 + 1) >> 1);

364 *
Pªd
++ = (
img≥l
Ë((
P_F
 + 
P_G
 + 1) >> 1);

365 *
Pªd
++ = (
img≥l
Ë((
P_G
 + 
P_H
 + 1) >> 1);

367 *
Pªd
++ = (
img≥l
Ë((
P_W
 + 
P_U
 + ((
P_V
) << 1) + 2) >> 2);

368 *
Pªd
++ = (
img≥l
Ë((
P_U
 + 
P_S
 + ((
P_T
) << 1) + 2) >> 2);

369 *
Pªd
++ = (
img≥l
Ë((
P_S
 + 
P_Q
 + ((
P_R
) << 1) + 2) >> 2);

370 *
Pªd
++ = (
img≥l
Ë((
P_Q
 + 
P_A
 + ((
P_Z
) << 1) + 2) >> 2);

371 *
Pªd
++ = (
img≥l
Ë((
P_Z
 + 
P_B
 + ((
P_A
) << 1) + 2) >> 2);

372 *
Pªd
++ = (
img≥l
Ë((
P_A
 + 
P_C
 + ((
P_B
) << 1) + 2) >> 2);

373 *
Pªd
++ = (
img≥l
Ë((
P_B
 + 
P_D
 + ((
P_C
) << 1) + 2) >> 2);

374 *
Pªd
++ = (
img≥l
Ë((
P_C
 + 
P_E
 + ((
P_D
) << 1) + 2) >> 2);

375 *
Pªd
++ = (
img≥l
Ë((
P_D
 + 
P_F
 + ((
P_E
) << 1) + 2) >> 2);

376 *
Pªd
++ = (
img≥l
Ë((
P_E
 + 
P_G
 + ((
P_F
) << 1) + 2) >> 2);

377 *
Pªd
 = (
img≥l
Ë((
P_F
 + 
P_H
 + ((
P_G
) << 1) + 2) >> 2);

379 
	`mem˝y
(*
cur_¥ed
++, &
PªdAºay
[ 3], 8 * (
img≥l
));

380 
	`mem˝y
(*
cur_¥ed
++, &
PªdAºay
[14], 8 * (
img≥l
));

381 
	`mem˝y
(*
cur_¥ed
++, &
PªdAºay
[ 2], 8 * (
img≥l
));

382 
	`mem˝y
(*
cur_¥ed
++, &
PªdAºay
[13], 8 * (
img≥l
));

383 
	`mem˝y
(*
cur_¥ed
++, &
PªdAºay
[ 1], 8 * (
img≥l
));

384 
	`mem˝y
(*
cur_¥ed
++, &
PªdAºay
[12], 8 * (
img≥l
));

385 
	`mem˝y
(*
cur_¥ed
++, &
PªdAºay
[ 0], 8 * (
img≥l
));

386 
	`mem˝y
(*
cur_¥ed
 , &
PªdAºay
[11], 8 * (
img≥l
));

387 
	}
}

395 
ölöe
 
	$gë_i8x8_h‹down
(
img≥l
 **
cur_¥ed
, img≥»*
PªdPñ
)

397 
img≥l
 
PªdAºay
[22];

398 
img≥l
 *
Pªd
 = &
PªdAºay
[0];

400 *
Pªd
++ = (
img≥l
Ë((
P_X
 + 
P_W
 + 1) >> 1);

401 *
Pªd
++ = (
img≥l
Ë((
P_V
 + 
P_X
 + (
P_W
 << 1) + 2) >> 2);

402 *
Pªd
++ = (
img≥l
Ë((
P_W
 + 
P_V
 + 1) >> 1);

403 *
Pªd
++ = (
img≥l
Ë((
P_U
 + 
P_W
 + ((
P_V
) << 1) + 2) >> 2);

404 *
Pªd
++ = (
img≥l
Ë((
P_V
 + 
P_U
 + 1) >> 1);

405 *
Pªd
++ = (
img≥l
Ë((
P_T
 + 
P_V
 + ((
P_U
) << 1) + 2) >> 2);

406 *
Pªd
++ = (
img≥l
Ë((
P_U
 + 
P_T
 + 1) >> 1);

407 *
Pªd
++ = (
img≥l
Ë((
P_S
 + 
P_U
 + ((
P_T
) << 1) + 2) >> 2);

408 *
Pªd
++ = (
img≥l
Ë((
P_T
 + 
P_S
 + 1) >> 1);

409 *
Pªd
++ = (
img≥l
Ë((
P_R
 + 
P_T
 + ((
P_S
) << 1) + 2) >> 2);

410 *
Pªd
++ = (
img≥l
Ë((
P_S
 + 
P_R
 + 1) >> 1);

411 *
Pªd
++ = (
img≥l
Ë((
P_Q
 + 
P_S
 + ((
P_R
) << 1) + 2) >> 2);

412 *
Pªd
++ = (
img≥l
Ë((
P_R
 + 
P_Q
 + 1) >> 1);

413 *
Pªd
++ = (
img≥l
Ë((
P_Z
 + 
P_R
 + ((
P_Q
) << 1) + 2) >> 2);

414 *
Pªd
++ = (
img≥l
Ë((
P_Q
 + 
P_Z
 + 1) >> 1);

415 *
Pªd
++ = (
img≥l
Ë((
P_Q
 + 
P_A
 + ((
P_Z
) << 1) + 2) >> 2);

416 *
Pªd
++ = (
img≥l
Ë((
P_Z
 + 
P_B
 + ((
P_A
) << 1) + 2) >> 2);

417 *
Pªd
++ = (
img≥l
Ë((
P_A
 + 
P_C
 + ((
P_B
) << 1) + 2) >> 2);

418 *
Pªd
++ = (
img≥l
Ë((
P_B
 + 
P_D
 + ((
P_C
) << 1) + 2) >> 2);

419 *
Pªd
++ = (
img≥l
Ë((
P_C
 + 
P_E
 + ((
P_D
) << 1) + 2) >> 2);

420 *
Pªd
++ = (
img≥l
Ë((
P_D
 + 
P_F
 + ((
P_E
) << 1) + 2) >> 2);

421 *
Pªd
 = (
img≥l
Ë((
P_E
 + 
P_G
 + ((
P_F
) << 1) + 2) >> 2);

423 
Pªd
 = &
PªdAºay
[14];

424 
	`mem˝y
(*
cur_¥ed
++, 
Pªd
, 8 * (
img≥l
));

425 
Pªd
 -= 2;

426 
	`mem˝y
(*
cur_¥ed
++, 
Pªd
, 8 * (
img≥l
));

427 
Pªd
 -= 2;

428 
	`mem˝y
(*
cur_¥ed
++, 
Pªd
, 8 * (
img≥l
));

429 
Pªd
 -= 2;

430 
	`mem˝y
(*
cur_¥ed
++, 
Pªd
, 8 * (
img≥l
));

431 
Pªd
 -= 2;

432 
	`mem˝y
(*
cur_¥ed
++, 
Pªd
, 8 * (
img≥l
));

433 
Pªd
 -= 2;

434 
	`mem˝y
(*
cur_¥ed
++, 
Pªd
, 8 * (
img≥l
));

435 
Pªd
 -= 2;

436 
	`mem˝y
(*
cur_¥ed
++, 
Pªd
, 8 * (
img≥l
));

437 
Pªd
 -= 2;

438 
	`mem˝y
(*
cur_¥ed
 , 
Pªd
, 8 * (
img≥l
));

439 
	}
}

448 
ölöe
 
	$gë_i8x8_h‹up
(
img≥l
 **
cur_¥ed
, img≥»*
PªdPñ
)

450 
img≥l
 
PªdAºay
[22];

451 
PªdAºay
[ 0] = (
img≥l
Ë((
P_Q
 + 
P_R
 + 1) >> 1);

452 
PªdAºay
[ 1] = (
img≥l
Ë((
P_S
 + 
P_Q
 + ((
P_R
) << 1) + 2) >> 2);

453 
PªdAºay
[ 2] = (
img≥l
Ë((
P_R
 + 
P_S
 + 1) >> 1);

454 
PªdAºay
[ 3] = (
img≥l
Ë((
P_T
 + 
P_R
 + ((
P_S
) << 1) + 2) >> 2);

455 
PªdAºay
[ 4] = (
img≥l
Ë((
P_S
 + 
P_T
 + 1) >> 1);

456 
PªdAºay
[ 5] = (
img≥l
Ë((
P_U
 + 
P_S
 + ((
P_T
) << 1) + 2) >> 2);

457 
PªdAºay
[ 6] = (
img≥l
Ë((
P_T
 + 
P_U
 + 1) >> 1);

458 
PªdAºay
[ 7] = (
img≥l
Ë((
P_V
 + 
P_T
 + ((
P_U
) << 1) + 2) >> 2);

459 
PªdAºay
[ 8] = (
img≥l
Ë((
P_U
 + 
P_V
 + 1) >> 1);

460 
PªdAºay
[ 9] = (
img≥l
Ë((
P_W
 + 
P_U
 + ((
P_V
) << 1) + 2) >> 2);

461 
PªdAºay
[10] = (
img≥l
Ë((
P_V
 + 
P_W
 + 1) >> 1);

462 
PªdAºay
[11] = (
img≥l
Ë((
P_X
 + 
P_V
 + ((
P_W
) << 1) + 2) >> 2);

463 
PªdAºay
[12] = (
img≥l
Ë((
P_W
 + 
P_X
 + 1) >> 1);

464 
PªdAºay
[13] = (
img≥l
Ë((
P_W
 + 
P_X
 + ((P_X) << 1) + 2) >> 2);

465 
PªdAºay
[14] = (
img≥l
Ë
P_X
;

466 
PªdAºay
[15] = (
img≥l
Ë
P_X
;

467 
PªdAºay
[16] = (
img≥l
Ë
P_X
;

468 
PªdAºay
[17] = (
img≥l
Ë
P_X
;

469 
PªdAºay
[18] = (
img≥l
Ë
P_X
;

470 
PªdAºay
[19] = (
img≥l
Ë
P_X
;

471 
PªdAºay
[20] = (
img≥l
Ë
P_X
;

472 
PªdAºay
[21] = (
img≥l
Ë
P_X
;

474 
	`mem˝y
(*
cur_¥ed
++, &
PªdAºay
[ 0], 8 * (
img≥l
));

475 
	`mem˝y
(*
cur_¥ed
++, &
PªdAºay
[ 2], 8 * (
img≥l
));

476 
	`mem˝y
(*
cur_¥ed
++, &
PªdAºay
[ 4], 8 * (
img≥l
));

477 
	`mem˝y
(*
cur_¥ed
++, &
PªdAºay
[ 6], 8 * (
img≥l
));

478 
	`mem˝y
(*
cur_¥ed
++, &
PªdAºay
[ 8], 8 * (
img≥l
));

479 
	`mem˝y
(*
cur_¥ed
++, &
PªdAºay
[10], 8 * (
img≥l
));

480 
	`mem˝y
(*
cur_¥ed
++, &
PªdAºay
[12], 8 * (
img≥l
));

481 
	`mem˝y
(*
cur_¥ed
 , &
PªdAºay
[14], 8 * (
img≥l
));

482 
	}
}

497 
	$£t_öå≠ªd_8x8
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
img_x
,
img_y
, *
À·_avaûabÀ
, *
up_avaûabÀ
, *
Æl_avaûabÀ
)

499 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

500 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

502 
img≥l
 *
PªdPñ
 = 
cuºMB
->
öåa8x8_¥ed
[
∂
];

503 
img≥l
 **
img_íc
 = 
p_Vid
->
íc_pi˘uª
->
p_cuº_img
;

504 *
mb_size
 = 
p_Vid
->mb_size[
IS_LUMA
];

506 
ioff
 = (
img_x
 & 15);

507 
joff
 = (
img_y
 & 15);

509 
PixñPos
 
pix_a
, 
pix_b
, 
pix_c
, 
pix_d
;

511 
block_avaûabÀ_up
;

512 
block_avaûabÀ_À·
;

513 
block_avaûabÀ_up_À·
;

514 
block_avaûabÀ_up_right
;

516 
p_Vid
->
	`gëNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 , 
mb_size
, &
pix_a
);

517 
p_Vid
->
	`gëNeighbour
(
cuºMB
, 
ioff
 , 
joff
 - 1, 
mb_size
, &
pix_b
);

518 
p_Vid
->
	`gëNeighbour
(
cuºMB
, 
ioff
 + 8, 
joff
 - 1, 
mb_size
, &
pix_c
);

519 
p_Vid
->
	`gëNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 - 1, 
mb_size
, &
pix_d
);

521 
pix_c
.
avaûabÀ
 =Öix_c.avaûabÀ &&!(
ioff
 =8 && 
joff
 == 8);

523 i‡(
p_I≈
->
U£C⁄°øöedI¡øPªd
)

525 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
 ? 
p_Vid
->
öåa_block
 [pix_a.
mb_addr
]: 0;

526 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
p_Vid
->
öåa_block
 [pix_b.
mb_addr
] : 0;

527 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
 ? 
p_Vid
->
öåa_block
 [pix_c.
mb_addr
] : 0;

528 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
 ? 
p_Vid
->
öåa_block
 [pix_d.
mb_addr
] : 0;

532 
block_avaûabÀ_À·
 = 
pix_a
.
avaûabÀ
;

533 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

534 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
;

535 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
;

538 *
À·_avaûabÀ
 = 
block_avaûabÀ_À·
;

539 *
up_avaûabÀ
 = 
block_avaûabÀ_up
;

540 *
Æl_avaûabÀ
 = 
block_avaûabÀ_up
 && 
block_avaûabÀ_À·
 && 
block_avaûabÀ_up_À·
;

543 i‡(
block_avaûabÀ_up
)

545 
	`mem˝y
(&
PªdPñ
[1], &
img_íc
[
pix_b
.
pos_y
][pix_b.
pos_x
], 8 * (
img≥l
));

549 
P_A
 = 
P_B
 = 
P_C
 = 
P_D
 = 
P_E
 = 
P_F
 = 
P_G
 = 
P_H
 = 
p_Vid
->
dc_¥ed_vÆue
;

552 i‡(
block_avaûabÀ_up_right
)

554 
	`mem˝y
(&
PªdPñ
[9], &
img_íc
[
pix_c
.
pos_y
][pix_c.
pos_x
], 8 * (
img≥l
));

558 
P_I
 = 
P_J
 = 
P_K
 = 
P_L
 = 
P_M
 = 
P_N
 = 
P_O
 = 
P_P
 = 
P_H
;

561 i‡(
block_avaûabÀ_À·
)

563 
pos_y
 = 
pix_a
.pos_y;

564 
pos_x
 = 
pix_a
.pos_x;

565 
P_Q
 = 
img_íc
[
pos_y
++][
pos_x
];

566 
P_R
 = 
img_íc
[
pos_y
++][
pos_x
];

567 
P_S
 = 
img_íc
[
pos_y
++][
pos_x
];

568 
P_T
 = 
img_íc
[
pos_y
++][
pos_x
];

569 
P_U
 = 
img_íc
[
pos_y
++][
pos_x
];

570 
P_V
 = 
img_íc
[
pos_y
++][
pos_x
];

571 
P_W
 = 
img_íc
[
pos_y
++][
pos_x
];

572 
P_X
 = 
img_íc
[
pos_y
 ][
pos_x
];

576 
P_Q
 = 
P_R
 = 
P_S
 = 
P_T
 = 
P_U
 = 
P_V
 = 
P_W
 = 
P_X
 = 
p_Vid
->
dc_¥ed_vÆue
;

579 i‡(
block_avaûabÀ_up_À·
)

581 
P_Z
 = 
img_íc
[
pix_d
.
pos_y
][pix_d.
pos_x
];

585 
P_Z
 = 
p_Vid
->
dc_¥ed_vÆue
;

588 
	`LowPassF‹I¡ø8x8Pªd
(
PªdPñ
, 
block_avaûabÀ_up_À·
, 
block_avaûabÀ_up
, 
block_avaûabÀ_À·
);

589 
	}
}

604 
	$£t_öå≠ªd_8x8_mbaff
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
img_x
,
img_y
, *
À·_avaûabÀ
, *
up_avaûabÀ
, *
Æl_avaûabÀ
)

606 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

607 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

609 
i
;

610 
img≥l
 *
PªdPñ
 = 
cuºMB
->
öåa8x8_¥ed
[
∂
];

611 
img≥l
 **
img_íc
 = 
p_Vid
->
íc_pi˘uª
->
p_cuº_img
;

612 *
mb_size
 = 
p_Vid
->mb_size[
IS_LUMA
];

614 
ioff
 = (
img_x
 & 15);

615 
joff
 = (
img_y
 & 15);

617 
PixñPos
 
pix_a
[8];

618 
PixñPos
 
pix_b
, 
pix_c
, 
pix_d
;

620 
block_avaûabÀ_up
;

621 
block_avaûabÀ_À·
;

622 
block_avaûabÀ_up_À·
;

623 
block_avaûabÀ_up_right
;

625 
i
=0;i<8;i++)

627 
p_Vid
->
	`gëNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 + 
i
 , 
mb_size
, &
pix_a
[i]);

630 
p_Vid
->
	`gëNeighbour
(
cuºMB
, 
ioff
 , 
joff
 - 1, 
mb_size
, &
pix_b
);

631 
p_Vid
->
	`gëNeighbour
(
cuºMB
, 
ioff
 + 8, 
joff
 - 1, 
mb_size
, &
pix_c
);

632 
p_Vid
->
	`gëNeighbour
(
cuºMB
, 
ioff
 - 1, 
joff
 - 1, 
mb_size
, &
pix_d
);

634 
pix_c
.
avaûabÀ
 =Öix_c.avaûabÀ &&!(
ioff
 =8 && 
joff
 == 8);

636 i‡(
p_I≈
->
U£C⁄°øöedI¡øPªd
)

638 
i
=0, 
block_avaûabÀ_À·
=1; i<8;i++)

639 
block_avaûabÀ_À·
 &
pix_a
[
i
].
avaûabÀ
 ? 
p_Vid
->
öåa_block
[pix_a[i].
mb_addr
]: 0;

641 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
p_Vid
->
öåa_block
 [pix_b.
mb_addr
] : 0;

642 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
 ? 
p_Vid
->
öåa_block
 [pix_c.
mb_addr
] : 0;

643 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
 ? 
p_Vid
->
öåa_block
 [pix_d.
mb_addr
] : 0;

647 
block_avaûabÀ_À·
 = 
pix_a
[0].
avaûabÀ
;

648 
block_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

649 
block_avaûabÀ_up_right
 = 
pix_c
.
avaûabÀ
;

650 
block_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
;

653 *
À·_avaûabÀ
 = 
block_avaûabÀ_À·
;

654 *
up_avaûabÀ
 = 
block_avaûabÀ_up
;

655 *
Æl_avaûabÀ
 = 
block_avaûabÀ_up
 && 
block_avaûabÀ_À·
 && 
block_avaûabÀ_up_À·
;

658 i‡(
block_avaûabÀ_up
)

660 
	`mem˝y
(&
PªdPñ
[1], &
img_íc
[
pix_b
.
pos_y
][pix_b.
pos_x
], 8 * (
img≥l
));

664 
P_A
 = 
P_B
 = 
P_C
 = 
P_D
 = 
P_E
 = 
P_F
 = 
P_G
 = 
P_H
 = 
p_Vid
->
dc_¥ed_vÆue
;

667 i‡(
block_avaûabÀ_up_right
)

669 
	`mem˝y
(&
PªdPñ
[9], &
img_íc
[
pix_c
.
pos_y
][pix_c.
pos_x
], 8 * (
img≥l
));

673 
P_I
 = 
P_J
 = 
P_K
 = 
P_L
 = 
P_M
 = 
P_N
 = 
P_O
 = 
P_P
 = 
P_H
;

676 i‡(
block_avaûabÀ_À·
)

678 
P_Q
 = 
img_íc
[
pix_a
[0].
pos_y
][pix_a[0].
pos_x
];

679 
P_R
 = 
img_íc
[
pix_a
[1].
pos_y
][pix_a[1].
pos_x
];

680 
P_S
 = 
img_íc
[
pix_a
[2].
pos_y
][pix_a[2].
pos_x
];

681 
P_T
 = 
img_íc
[
pix_a
[3].
pos_y
][pix_a[3].
pos_x
];

682 
P_U
 = 
img_íc
[
pix_a
[4].
pos_y
][pix_a[4].
pos_x
];

683 
P_V
 = 
img_íc
[
pix_a
[5].
pos_y
][pix_a[5].
pos_x
];

684 
P_W
 = 
img_íc
[
pix_a
[6].
pos_y
][pix_a[6].
pos_x
];

685 
P_X
 = 
img_íc
[
pix_a
[7].
pos_y
][pix_a[7].
pos_x
];

689 
P_Q
 = 
P_R
 = 
P_S
 = 
P_T
 = 
P_U
 = 
P_V
 = 
P_W
 = 
P_X
 = 
p_Vid
->
dc_¥ed_vÆue
;

692 i‡(
block_avaûabÀ_up_À·
)

694 
P_Z
 = 
img_íc
[
pix_d
.
pos_y
][pix_d.
pos_x
];

698 
P_Z
 = 
p_Vid
->
dc_¥ed_vÆue
;

701 
	`LowPassF‹I¡ø8x8Pªd
(
PªdPñ
, 
block_avaûabÀ_up_À·
, 
block_avaûabÀ_up
, 
block_avaûabÀ_À·
);

702 
	}
}

716 
	$gë_öå≠ªd_8x8
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
i8x8_mode
, 
À·_avaûabÀ
, 
up_avaûabÀ
)

718 
img≥l
 *
PªdPñ
 = 
cuºMB
->
öåa8x8_¥ed
[
∂
];

719 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

720 
img≥l
 ***
cuº_m¥_8x8
 = 
cuºSli˚
->
m¥_8x8
[
∂
];

722 
i8x8_mode
)

724 
VERT_PRED
 :

725 
	`gë_i8x8_vîtiˇl
(
cuº_m¥_8x8
[
VERT_PRED
], 
PªdPñ
);

727 
HOR_PRED
 :

728 
	`gë_i8x8_h‹iz⁄èl
(
cuº_m¥_8x8
[
HOR_PRED
], 
PªdPñ
);

730 
DC_PRED
 :

731 
	`gë_i8x8_dc
(
cuº_m¥_8x8
[
DC_PRED
], 
PªdPñ
, 
À·_avaûabÀ
, 
up_avaûabÀ
);

733 
DIAG_DOWN_LEFT_PRED
 :

734 
	`gë_i8x8_dow∆e·
(
cuº_m¥_8x8
[
DIAG_DOWN_LEFT_PRED
], 
PªdPñ
);

736 
DIAG_DOWN_RIGHT_PRED
 :

737 
	`gë_i8x8_dowƒight
(
cuº_m¥_8x8
[
DIAG_DOWN_RIGHT_PRED
], 
PªdPñ
);

739 
VERT_RIGHT_PRED
 :

740 
	`gë_i8x8_vîåight
(
cuº_m¥_8x8
[
VERT_RIGHT_PRED
], 
PªdPñ
);

742 
HOR_DOWN_PRED
 :

743 
	`gë_i8x8_h‹down
(
cuº_m¥_8x8
[
HOR_DOWN_PRED
], 
PªdPñ
);

745 
VERT_LEFT_PRED
 :

746 
	`gë_i8x8_vîée·
(
cuº_m¥_8x8
[
VERT_LEFT_PRED
], 
PªdPñ
);

748 
HOR_UP_PRED
 :

749 
	`gë_i8x8_h‹up
(
cuº_m¥_8x8
[
HOR_UP_PRED
], 
PªdPñ
);

752 
	`¥ötf
("invalidÖrediction mode \n");

755 
	}
}

	@lencod/src/intra_chroma.c

14 
	~"c⁄åibut‹s.h
"

16 
	~"globÆ.h
"

17 
	~"image.h
"

18 
	~"mb_ac˚ss.h
"

19 
	~"block.h
"

20 
	~"mv_£¨ch.h
"

22 
	$gë_dif„ªn˚_4x4
(
img≥l
 **
§c
, img≥»**
¥d
, *
diff
, 
pos_x
, 
block_x
)

24 
i
, 
j
;

25 *
p_diff
 = 
diff
;

26 
img≥l
 *
img_¥d
, *
img_§c
;

27 
j
 = 0; j < 
BLOCK_SIZE
; j++)

29 
img_§c
 = &
§c
[
j
][
pos_x
 + 
block_x
];

30 
img_¥d
 = &
¥d
[
j
][
block_x
];

32 
i
 = 0; i < 
BLOCK_SIZE
; i++)

33 *
p_diff
++ = 
img_§c
[
i
] - 
img_¥d
[i];

35 
	}
}

43 
ölöe
 
	$gë_iChroma_vîtiˇl
(
img≥l
 **
cur_¥ed
, img≥»*
PªdPñ
, 
¸_MB_x
, 
¸_MB_y
)

45 
j
;

46 
j
 = 0; j < 
¸_MB_y
; j++)

47 
	`mem˝y
(
cur_¥ed
[
j
], &
PªdPñ
[1], 
¸_MB_x
 * (
img≥l
));

48 
	}
}

57 
ölöe
 
	$gë_iChroma_h‹iz⁄èl
(
img≥l
 **
cur_¥ed
, img≥»*
PªdPñ
, 
¸_MB_x
, 
¸_MB_y
)

59 
i
, 
j
;

60 
img≥l
 *
¥edi˘i⁄
 = &
PªdPñ
[16];

62 
j
 = 0; j < 
¸_MB_y
; j++)

64 
¥edi˘i⁄
++;

65 
i
 = 0; i < 
¸_MB_x
; i++)

67 
cur_¥ed
[
j
][
i
] = *
¥edi˘i⁄
;

70 
	}
}

78 
ölöe
 
	$gë_iChroma_dc
(
img≥l
 **
cur_¥ed
, img≥»*
PªdPñ
, 
À·_avaûabÀ
, 
up_avaûabÀ
)

80 
i
, 
j
, 
s0
 = 0, 
s1
 = 0, 
s2
 = 0;

82 i‡(
up_avaûabÀ
)

84 
i
 = 1; i < 
MB_BLOCK_SIZE
 + 1; ++i)

85 
s1
 +
PªdPñ
[
i
];

88 i‡(
À·_avaûabÀ
)

90 
i
 = 17; i < 33; ++i)

91 
s2
 +
PªdPñ
[
i
];

94 i‡(
up_avaûabÀ
)

96 
s0
 = 
À·_avaûabÀ


97 ? 
	`rshi·_∫d_sf
((
s1
 + 
s2
),(
MB_BLOCK_SHIFT
 + 1))

98 : 
	`rshi·_∫d_sf
(
s1
, 
MB_BLOCK_SHIFT
);

102 
s0
 = 
À·_avaûabÀ


103 ? 
	`rshi·_∫d_sf
(
s2
, 
MB_BLOCK_SHIFT
)

104 : 
PªdPñ
[1];

107 
j
 = 0; j < 
MB_BLOCK_SIZE
; j++)

109 
i
 = 0; i < 
MB_BLOCK_SIZE
; i++)

110 
cur_¥ed
[
j
][
i
] = (
img≥l
Ë
s0
;

112 
	}
}

120 
ölöe
 
	$gë_iChroma_∂™e
(
img≥l
 **
cur_¥ed
, img≥»*
PªdPñ
, 
max_img≥l_vÆue
)

122 
i
, 
j
;

124 
ih
=0, 
iv
=0;

125 
ib
, 
ic
, 
üa
;

126 
img≥l
 *
t_¥ed
 = &
PªdPñ
[25];

127 
img≥l
 *
u_¥ed
 = &
PªdPñ
[8];

128 
img≥l
 *
b_¥ed
 = &
PªdPñ
[23];

130 
i
 = 1; i < 8;++i)

132 
ih
 +
i
*(*(
u_¥ed
 + i) - *(u_pred - i));

133 
iv
 +
i
*(*
t_¥ed
++ - *
b_¥ed
--);

135 
ih
 +8 * (*(
u_¥ed
 + 8Ë- 
PªdPñ
[0]);

136 
iv
 +8 * (*
t_¥ed
++ - 
PªdPñ
[0]);

138 
ib
 = (5 * 
ih
 + 32) >> 6;

139 
ic
 = (5 * 
iv
 + 32) >> 6;

141 
üa
=16 * (
PªdPñ
[16] + PredPel[32]);

143 
j
=0;j< 
MB_BLOCK_SIZE
;++j)

145 
i
=0;i< 
MB_BLOCK_SIZE
;++i)

147 
cur_¥ed
[
j
][
i
](
img≥l
Ë
	`iClù1
–
max_img≥l_vÆue
, 
	`rshi·_∫d_sf
((
üa
 + (ò- 7Ë* 
ib
 + (j - 7Ë* 
ic
), 5));

150 
	}
}

163 
	$£t_öå≠ªd_chroma
(
Ma¸oblock
 *
cuºMB
, *
À·_avaûabÀ
, *
up_avaûabÀ
, *
Æl_avaûabÀ
)

165 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

166 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

168 
i
;

169 
img≥l
 *
PªdPñU
 = 
cuºMB
->
öåa16x16_¥ed
[
PLANE_U
];

170 
img≥l
 *
PªdPñV
 = 
cuºMB
->
öåa16x16_¥ed
[
PLANE_V
];

171 
img≥l
 **
img_íc_u
 = 
p_Vid
->
íc_pi˘uª
->
imgUV
[0];

172 
img≥l
 **
img_íc_v
 = 
p_Vid
->
íc_pi˘uª
->
imgUV
[1];

174 
PixñPos
 
pix_b
;

175 
PixñPos
 
pix_a
;

176 
PixñPos
 
pix_d
;

177 
¸_MB_x
 = 
p_Vid
->
mb_¸_size_x
;

178 
¸_MB_y
 = 
p_Vid
->
mb_¸_size_y
;

180 
img≥l
 
dc_¥ed_vÆue_chroma
 = 
p_Vid
->
dc_¥ed_vÆue_comp
[1];

182 *
mb_size
 = 
p_Vid
->mb_size[
IS_CHROMA
];

184 
p_Vid
->
	`gëNeighbour
(
cuºMB
, -1, -1, 
mb_size
, &
pix_d
);

185 
p_Vid
->
	`gëNeighbour
(
cuºMB
, -1, 0, 
mb_size
, &
pix_a
);

186 
p_Vid
->
	`gëNeighbour
(
cuºMB
, 0, -1, 
mb_size
, &
pix_b
);

188 i‡(
p_I≈
->
U£C⁄°øöedI¡øPªd
 == 0)

190 *
up_avaûabÀ
 = 
pix_b
.
avaûabÀ
;

191 *
À·_avaûabÀ
 = 
pix_a
.
avaûabÀ
;

192 *
Æl_avaûabÀ
 = 
pix_d
.
avaûabÀ
;

196 *
up_avaûabÀ
 = 
pix_b
.
avaûabÀ
 ? 
p_Vid
->
öåa_block
[pix_b.
mb_addr
] : 0;

197 *
À·_avaûabÀ
 = 
pix_a
.
avaûabÀ
 ? 
p_Vid
->
öåa_block
[pix_a.
mb_addr
] : 0;

198 *
Æl_avaûabÀ
 = 
pix_d
.
avaûabÀ
 ? 
p_Vid
->
öåa_block
[pix_d.
mb_addr
] : 0;

202 i‡(*
up_avaûabÀ
)

204 
	`mem˝y
(&
PªdPñU
[1], &
img_íc_u
[
pix_b
.
pos_y
][pix_b.
pos_x
], 
¸_MB_x
 * (
img≥l
));

205 
	`mem˝y
(&
PªdPñV
[1], &
img_íc_v
[
pix_b
.
pos_y
][pix_b.
pos_x
], 
¸_MB_x
 * (
img≥l
));

209 
i
 = 1; i < 
¸_MB_x
 + 1; ++i)

210 
PªdPñU
[
i
] = (
img≥l
Ë
dc_¥ed_vÆue_chroma
;

211 
i
 = 1; i < 
¸_MB_x
 + 1; ++i)

212 
PªdPñV
[
i
] = (
img≥l
Ë
dc_¥ed_vÆue_chroma
;

215 i‡(*
À·_avaûabÀ
)

217 
pos_y
 = 
pix_a
.pos_y;

218 
pos_x
 = 
pix_a
.pos_x;

220 
i
 = 1; i < 
¸_MB_y
 + 1; ++i)

222 
PªdPñU
[
i
 + 
¸_MB_x
] = 
img_íc_u
[
pos_y
 ][
pos_x
];

223 
PªdPñV
[
i
 + 
¸_MB_x
] = 
img_íc_v
[
pos_y
++][
pos_x
];

228 
i
 = 
¸_MB_x
 + 1; i < cr_MB_x + 
¸_MB_y
 + 1; ++i)

229 
PªdPñU
[
i
] = (
img≥l
Ë
dc_¥ed_vÆue_chroma
;

230 
i
 = 
¸_MB_x
 + 1; i < cr_MB_x + 
¸_MB_y
 + 1; ++i)

231 
PªdPñV
[
i
] = (
img≥l
Ë
dc_¥ed_vÆue_chroma
;

234 i‡(*
Æl_avaûabÀ
)

236 
PªdPñU
[0] = 
img_íc_u
[
pix_d
.
pos_y
][pix_d.
pos_x
];

237 
PªdPñV
[0] = 
img_íc_v
[
pix_d
.
pos_y
][pix_d.
pos_x
];

241 
PªdPñU
[0] = 
dc_¥ed_vÆue_chroma
;

242 
PªdPñV
[0] = 
dc_¥ed_vÆue_chroma
;

244 
	}
}

258 
	$£t_öå≠ªd_chroma_mbaff
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, *
À·_avaûabÀ
, *
up_avaûabÀ
, *
Æl_avaûabÀ
)

260 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

261 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

263 
i
;

264 
img≥l
 *
PªdPñU
 = 
cuºMB
->
öåa16x16_¥ed
[
PLANE_U
];

265 
img≥l
 *
PªdPñV
 = 
cuºMB
->
öåa16x16_¥ed
[
PLANE_V
];

266 
img≥l
 **
img_íc_u
 = 
p_Vid
->
íc_pi˘uª
->
imgUV
[0];

267 
img≥l
 **
img_íc_v
 = 
p_Vid
->
íc_pi˘uª
->
imgUV
[1];

269 
PixñPos
 
pix_b
;

270 
PixñPos
 
pix_a
[17];

271 
¸_MB_x
 = 
p_Vid
->
mb_¸_size_x
;

272 
¸_MB_y
 = 
p_Vid
->
mb_¸_size_y
;

274 
img≥l
 
dc_¥ed_vÆue_chroma
 = 
p_Vid
->
dc_¥ed_vÆue_comp
[1];

276 *
mb_size
 = 
p_Vid
->mb_size[
IS_CHROMA
];

278 
i
 = 0; i < 
¸_MB_y
 + 1; ++i)

280 
p_Vid
->
	`gëNeighbour
(
cuºMB
, -1, 
i
 - 1, 
mb_size
, &
pix_a
[i]);

283 
p_Vid
->
	`gëNeighbour
(
cuºMB
, 0, -1, 
mb_size
, &
pix_b
);

285 i‡(
p_I≈
->
U£C⁄°øöedI¡øPªd
 == 0)

287 *
up_avaûabÀ
 = 
pix_b
.
avaûabÀ
;

288 *
À·_avaûabÀ
 = 
pix_a
[1].
avaûabÀ
;

289 *
Æl_avaûabÀ
 = 
pix_a
[0].
avaûabÀ
;

293 *
up_avaûabÀ
 = 
pix_b
.
avaûabÀ
 ? 
p_Vid
->
öåa_block
[pix_b.
mb_addr
] : 0;

294 
i
=1, *
À·_avaûabÀ
=1; i<17;++i)

295 *
À·_avaûabÀ
 &
pix_a
[
i
].
avaûabÀ
 ? 
p_Vid
->
öåa_block
[pix_a[i].
mb_addr
]: 0;

296 *
Æl_avaûabÀ
 = 
pix_a
[0].
avaûabÀ
 ? 
p_Vid
->
öåa_block
[pix_a[0].
mb_addr
]: 0;

300 i‡(*
up_avaûabÀ
)

302 
	`mem˝y
(&
PªdPñU
[1], &
img_íc_u
[
pix_b
.
pos_y
][pix_b.
pos_x
], 
¸_MB_x
 * (
img≥l
));

303 
	`mem˝y
(&
PªdPñV
[1], &
img_íc_v
[
pix_b
.
pos_y
][pix_b.
pos_x
], 
¸_MB_x
 * (
img≥l
));

307 
i
 = 1; i < 
¸_MB_x
 + 1; ++i)

308 
PªdPñU
[
i
] = (
img≥l
Ë
dc_¥ed_vÆue_chroma
;

309 
i
 = 1; i < 
¸_MB_x
 + 1; ++i)

310 
PªdPñV
[
i
] = (
img≥l
Ë
dc_¥ed_vÆue_chroma
;

313 i‡(*
À·_avaûabÀ
)

315 
i
 = 1; i < 
¸_MB_y
 + 1; ++i)

316 
PªdPñU
[
i
 + 
¸_MB_x
] = 
img_íc_u
[
pix_a
[i].
pos_y
][pix_a[i].
pos_x
];

317 
i
 = 1; i < 
¸_MB_y
 + 1; ++i)

318 
PªdPñV
[
i
 + 
¸_MB_x
] = 
img_íc_v
[
pix_a
[i].
pos_y
][pix_a[i].
pos_x
];

322 
i
 = 
¸_MB_x
 + 1; i < cr_MB_x + 
¸_MB_y
 + 1; ++i)

323 
PªdPñU
[
i
] = (
img≥l
Ë
dc_¥ed_vÆue_chroma
;

324 
i
 = 
¸_MB_x
 + 1; i < cr_MB_x + 
¸_MB_y
 + 1; ++i)

325 
PªdPñV
[
i
] = (
img≥l
Ë
dc_¥ed_vÆue_chroma
;

328 i‡(*
Æl_avaûabÀ
)

330 
PªdPñU
[0] = 
img_íc_u
[
pix_a
[0].
pos_y
][pix_a[0].
pos_x
];

331 
PªdPñV
[0] = 
img_íc_v
[
pix_a
[0].
pos_y
][pix_a[0].
pos_x
];

335 
PªdPñU
[0] = 
dc_¥ed_vÆue_chroma
;

336 
PªdPñV
[0] = 
dc_¥ed_vÆue_chroma
;

338 
	}
}

353 
	$gë_öå≠ªd_chroma
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
iChroma_mode
, 
À·_avaûabÀ
, 
up_avaûabÀ
)

355 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

356 
img≥l
 *
PªdPñ
 = 
cuºMB
->
öåa16x16_¥ed
[
∂
];

357 
img≥l
 ***
cuº_m¥_16x16
 = 
cuºMB
->
p_Sli˚
->
m¥_16x16
[
∂
];

358 
¸_MB_x
 = 
p_Vid
->
mb_¸_size_x
;

359 
¸_MB_y
 = 
p_Vid
->
mb_¸_size_y
;

361 
iChroma_mode
)

363 
VERT_PRED_8
 :

364 
	`gë_iChroma_vîtiˇl
(
cuº_m¥_16x16
[
VERT_PRED_16
], 
PªdPñ
, 
¸_MB_x
, 
¸_MB_y
);

366 
HOR_PRED_8
 :

367 
	`gë_iChroma_h‹iz⁄èl
(
cuº_m¥_16x16
[
HOR_PRED_16
], 
PªdPñ
, 
¸_MB_x
, 
¸_MB_y
);

369 
DC_PRED_8
 :

370 
	`gë_iChroma_dc
(
cuº_m¥_16x16
[
DC_PRED_16
], 
PªdPñ
, 
À·_avaûabÀ
, 
up_avaûabÀ
);

372 
PLANE_8
 :

373 
	`gë_iChroma_∂™e
(
cuº_m¥_16x16
[
PLANE_16
], 
PªdPñ
, 
cuºMB
->
p_Vid
->
max_img≥l_vÆue
);

376 
	`¥ötf
("invalidÖrediction mode \n");

379 
	}
}

381 
	$rdo_low_öåa_chroma_decisi⁄_mbaff
(
Ma¸oblock
 *
cuºMB
, 
mb_avaûabÀ_up
, 
mb_avaûabÀ_À·
[2], 
mb_avaûabÀ_up_À·
)

383 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

384 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

385 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºSli˚
->p_Inp;

386 
i
, 
j
, 
uv
;

387 
¸_MB_x
 = 
p_Vid
->
mb_¸_size_x
;

388 
¸_MB_y
 = 
p_Vid
->
mb_¸_size_y
;

389 
block_x
, 
block_y
;

390 
PixñPos
 
pix_a
[17];

391 
img≥l
 **
image
 = 
NULL
;

392 
img≥l
 ***
cuº_m¥_16x16
 = 
NULL
;

395 
diff
 [16];

396 *
p_diff
;

397 
di°blk
 
co°
, 
mö_co°
 = 
DISTBLK_MAX
;

398 
mode
;

399 
be°_mode
 = 
DC_PRED_8
;

400 
img≥l
 *
img_‹g
 = 
NULL
, *
img_¥d
 = NULL;

402 
i
=0;i<
¸_MB_y
;i++)

404 
p_Vid
->
	`gëNeighbour
(
cuºMB
, 0 , 
i
,Ö_Vid->
mb_size
[
IS_CHROMA
], &
pix_a
[i]);

407 i‡–
p_Vid
->
mb_aff_‰ame_Êag
 &&Ö_Vid->
fõld_mode
 )

409 
i
=0;i<
¸_MB_y
;i++)

411 
pix_a
[
i
].
pos_y
 =Öix_a[i].pos_y >> 1;

415 
mode
=
DC_PRED_8
; mode<=
PLANE_8
; mode++)

417 i‡(((
cuºSli˚
->
¶i˚_ty≥
 !
I_SLICE
 && cuºSli˚->¶i˚_ty≥ !
SI_SLICE
Ë|| !
p_I≈
->
I¡øDißbÀI¡îO∆y
Ë&&Ö_I≈->
ChromaI¡øDißbÀ
 =1 && 
mode
!=
DC_PRED_8
)

420 i‡((
mode
==
VERT_PRED_8
 && !
mb_avaûabÀ_up
) ||

421 (
mode
==
HOR_PRED_8
 && (!
mb_avaûabÀ_À·
[0] || !mb_available_left[1])) ||

422 (
mode
==
PLANE_8
 && (!
mb_avaûabÀ_À·
[0] || !mb_avaûabÀ_À·[1] || !
mb_avaûabÀ_up
 || !
mb_avaûabÀ_up_À·
)))

425 
co°
 = 0;

426 
uv
 = 1; uv < 3; uv++)

428 
image
 = 
p_Vid
->
pImgOrg
[
uv
];

429 
cuº_m¥_16x16
 = 
cuºSli˚
->
m¥_16x16
[
uv
];

431 
block_y
 = 0; block_y < 
¸_MB_y
; block_y += 4)

433 
block_x
 = 0; block_x < 
¸_MB_x
; block_x += 4)

435 
p_diff
 = &
diff
[0];

436 
j
 = 
block_y
; j < block_y + 4; j++)

438 
img_¥d
 = 
cuº_m¥_16x16
[
mode
][
j
];

439 
img_‹g
 = &
image
[
pix_a
[
j
].
pos_y
][pix_a[j].
pos_x
];

440 
i
 = 
block_x
; i < block_x + 4; i++)

441 *
p_diff
++ = 
img_‹g
[
i
] - 
img_¥d
[i];

443 
co°
 +
p_Vid
->
	`di°‹ti⁄4x4
(
diff
, 
mö_co°
);

444 i‡(
co°
 > 
mö_co°
) ;

446 i‡(
co°
 > 
mö_co°
) ;

448 i‡(
co°
 > 
mö_co°
) ;

450 i‡(
co°
 < 
mö_co°
)

452 
be°_mode
 = 
mode
;

453 
mö_co°
 = 
co°
;

456 
cuºMB
->
c_ùªd_mode
 = (Ë
be°_mode
;

457 
	}
}

460 
	$rdo_low_öåa_chroma_decisi⁄
(
Ma¸oblock
 *
cuºMB
, 
mb_avaûabÀ_up
, 
mb_avaûabÀ_À·
[2], 
mb_avaûabÀ_up_À·
)

462 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

463 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

464 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºSli˚
->p_Inp;

465 
uv
;

466 
¸_MB_x
 = 
p_Vid
->
mb_¸_size_x
;

467 
¸_MB_y
 = 
p_Vid
->
mb_¸_size_y
;

468 
block_x
, 
block_y
;

469 
PixñPos
 
pix_a
;

471 
img≥l
 **
image
 = 
NULL
;

472 
img≥l
 ***
cuº_m¥_16x16
 = 
NULL
;

474 
diff
 [16];

476 
di°blk
 
co°
, 
mö_co°
 = 
DISTBLK_MAX
;

477 
mode
;

478 
be°_mode
 = 
DC_PRED_8
;

480 
p_Vid
->
	`gëNeighbour
(
cuºMB
, 0 , 0,Ö_Vid->
mb_size
[
IS_CHROMA
], &
pix_a
);

482 
mode
 = 
DC_PRED_8
; modê<
PLANE_8
; mode++)

484 i‡(((
cuºSli˚
->
¶i˚_ty≥
 !
I_SLICE
 && cuºSli˚->¶i˚_ty≥ !
SI_SLICE
Ë|| !
p_I≈
->
I¡øDißbÀI¡îO∆y
Ë&&Ö_I≈->
ChromaI¡øDißbÀ
 =1 && 
mode
!=
DC_PRED_8
)

487 i‡((
mode
==
VERT_PRED_8
 && !
mb_avaûabÀ_up
) ||

488 (
mode
==
HOR_PRED_8
 && (!
mb_avaûabÀ_À·
[0] || !mb_available_left[1])) ||

489 (
mode
==
PLANE_8
 && (!
mb_avaûabÀ_À·
[0] || !mb_avaûabÀ_À·[1] || !
mb_avaûabÀ_up
 || !
mb_avaûabÀ_up_À·
)))

492 
co°
 = 0;

494 
uv
 = 1; uv < 3; uv++)

496 
pos_x
 = 
pix_a
.pos_x;

497 
pos_y
 = 
pix_a
.pos_y;

498 
image
 = 
p_Vid
->
pImgOrg
[
uv
];

499 
cuº_m¥_16x16
 = 
cuºSli˚
->
m¥_16x16
[
uv
];

501 
block_y
 = 0; block_y < 
¸_MB_y
; block_y +
BLOCK_SIZE
)

503 
block_x
 = 0; block_x < 
¸_MB_x
; block_x +
BLOCK_SIZE
)

505 
	`gë_dif„ªn˚_4x4
(&
image
[
pos_y
 + 
block_y
], &
cuº_m¥_16x16
[
mode
][block_y], 
diff
, 
pos_x
, 
block_x
);

506 
co°
 +
p_Vid
->
	`di°‹ti⁄4x4
(
diff
, 
mö_co°
);

507 i‡(
co°
 > 
mö_co°
) ;

509 i‡(
co°
 > 
mö_co°
) ;

511 i‡(
co°
 > 
mö_co°
) ;

514 i‡(
co°
 < 
mö_co°
)

516 
be°_mode
 = 
mode
;

517 
mö_co°
 = 
co°
;

520 
cuºMB
->
c_ùªd_mode
 = (Ë
be°_mode
;

521 
	}
}

530 
	$öåa_chroma_¥edi˘i⁄
 (
Ma¸oblock
 *
cuºMB
, *
mb_up
, *
mb_À·
, *
mb_up_À·
)

532 
s
, 
i
, 
j
;

534 
uv
;

535 
b8
, 
b4
;

536 
img≥l
 
vlöe
[16];

538 
mb_avaûabÀ_up
;

539 
mb_avaûabÀ_À·
[2];

540 
mb_avaûabÀ_up_À·
;

542 
PixñPos
 
pix_c
;

543 
PixñPos
 
pix_d
;

544 
PixñPos
 
pix_a
;

546 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

547 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

548 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºSli˚
->p_Inp;

549 
¸_MB_x
 = 
p_Vid
->
mb_¸_size_x
;

550 
¸_MB_y
 = 
p_Vid
->
mb_¸_size_y
;

551 
img≥l
 **
cur_¥ed
 = 
NULL
;

553 
img≥l
 *
hlöe
 = 
NULL
;

555 
yuv
 = 
p_Vid
->
yuv_f‹m©
 - 1;

556 
dc_¥ed_vÆue_chroma
 = 
p_Vid
->
dc_¥ed_vÆue_comp
[1];

557 
max_img≥l_vÆue_uv
 = 
p_Vid
->
max_≥l_vÆue_comp
[1];

559 c⁄° 
block_pos
[3][4][4]=

566 
p_Vid
->
	`gëNeighbour
(
cuºMB
, -1, -1,Ö_Vid->
mb_size
[
IS_CHROMA
], &
pix_d
);

567 
p_Vid
->
	`gëNeighbour
(
cuºMB
, -1, 0,Ö_Vid->
mb_size
[
IS_CHROMA
], &
pix_a
);

568 
p_Vid
->
	`gëNeighbour
(
cuºMB
, 0, -1,Ö_Vid->
mb_size
[
IS_CHROMA
], &
pix_c
);

570 
mb_avaûabÀ_up
 = 
pix_c
.
avaûabÀ
;

571 
mb_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
;

572 
mb_avaûabÀ_À·
[0] = mb_avaûabÀ_À·[1] = 
pix_a
.
avaûabÀ
;

574 if(
p_I≈
->
U£C⁄°øöedI¡øPªd
)

576 
mb_avaûabÀ_up
 = 
pix_c
.
avaûabÀ
 ? 
p_Vid
->
öåa_block
[pix_c.
mb_addr
] : 0;

577 
mb_avaûabÀ_À·
[0] = mb_avaûabÀ_À·[1] = 
pix_a
.
avaûabÀ
 ? 
p_Vid
->
öåa_block
[pix_a.
mb_addr
] : 0;

578 
mb_avaûabÀ_up_À·
 = 
pix_d
.
avaûabÀ
 ? 
p_Vid
->
öåa_block
[pix_d.
mb_addr
] : 0;

581 i‡(
mb_up
)

582 *
mb_up
 = 
mb_avaûabÀ_up
;

583 i‡(
mb_À·
)

584 *
mb_À·
 = 
mb_avaûabÀ_À·
[0];

585 i‡(
mb_up_À·
)

586 *
mb_up_À·
 = 
mb_avaûabÀ_up_À·
;

589 
uv
=0; uv<2; uv++)

591 
img≥l
 **
image
 = 
p_Vid
->
íc_pi˘uª
->
imgUV
[
uv
];

592 
img≥l
 ***
cuº_m¥_16x16
 = 
cuºSli˚
->
m¥_16x16
[
uv
 + 1];

595 
b8
=0; b8<
p_Vid
->
num_blk8x8_uv
 >> 1;b8++)

597 
b4
 = 0; b4 < 4; b4++)

599 
block_y
 = 
subblk_off£t_y
[
yuv
][
b8
][
b4
];

600 
block_x
 = 
subblk_off£t_x
[
yuv
][
b8
][
b4
];

601 
blk_x
 = 
block_x
;

603 
s
 = 
dc_¥ed_vÆue_chroma
;

606 
block_pos
[
yuv
][
b8
][
b4
])

610 
s0
 = 0, 
s2
 = 0;

611 i‡(
mb_avaûabÀ_up
)

613 
pos_x
 = 
pix_c
.pos_x + 
blk_x
;

614 
pos_y
 = 
pix_c
.pos_y;

616 
i
 = 0; i < 
BLOCK_SIZE
; i++)

617 
s0
 +
image
[
pos_y
][
pos_x
++];

619 i‡(
mb_avaûabÀ_À·
[0])

621 
pos_x
 = 
pix_a
.pos_x;

622 
pos_y
 = 
pix_a
.pos_y + 
block_y
;

624 
i
 = 0; i < 
BLOCK_SIZE
;i++)

625 
s2
 +
image
[
pos_y
++][
pos_x
];

627 i‡(
mb_avaûabÀ_up
 && 
mb_avaûabÀ_À·
[0])

628 
s
 = (
s0
 + 
s2
 + 4) >> 3;

629 i‡(
mb_avaûabÀ_up
)

630 
s
 = (
s0
 + 2) >> 2;

631 i‡(
mb_avaûabÀ_À·
[0])

632 
s
 = (
s2
 + 2) >> 2;

637 
s1
 = 0, 
s2
 = 0;

638 i‡(
mb_avaûabÀ_up
)

640 
pos_x
 = 
pix_c
.pos_x + 
blk_x
;

641 
pos_y
 = 
pix_c
.pos_y;

642 
i
 = 0; i < 
BLOCK_SIZE
; i++)

643 
s1
 +
image
[
pos_y
][
pos_x
++];

645 i‡(
mb_avaûabÀ_À·
[0])

647 
pos_x
 = 
pix_a
.pos_x;

648 
pos_y
 = 
pix_a
.pos_y + 
block_y
;

650 
i
 = 0; i < 
BLOCK_SIZE
; i++)

651 
s2
 +
image
[
pos_y
++][
pos_x
];

653 i‡(
mb_avaûabÀ_up
)

654 
s
 = (
s1
 +2) >> 2;

655 i‡(
mb_avaûabÀ_À·
[0])

656 
s
 = (
s2
 +2) >> 2;

660 i‡(
mb_avaûabÀ_À·
[0])

662 
pos_x
 = 
pix_a
.pos_x;

663 
pos_y
 = 
pix_a
.pos_y + 
block_y
;

664 
s3
 = 0;

666 
i
 = 0; i < 
BLOCK_SIZE
; i++)

667 
s3
 +
image
[
pos_y
++][
pos_x
];

668 
s
 = (
s3
 + 2) >> 2;

670 i‡(
mb_avaûabÀ_up
)

672 
pos_x
 = 
pix_c
.pos_x + 
blk_x
;

673 
pos_y
 = 
pix_c
.pos_y;

675 
s0
 = 0;

676 
i
 = 0; i < 
BLOCK_SIZE
; i++)

677 
s0
 +
image
[
pos_y
][
pos_x
++];

678 
s
 = (
s0
 + 2) >> 2;

683 
s1
 = 0, 
s3
 = 0;

684 i‡(
mb_avaûabÀ_up
)

685 
i
=
blk_x
;i<(blk_x+4);i++)

686 
s1
 +
image
[
pix_c
.
pos_y
][pix_c.
pos_x
 + 
i
];

687 i‡(
mb_avaûabÀ_À·
[0])

689 
pos_x
 = 
pix_a
.pos_x;

690 
pos_y
 = 
pix_a
.pos_y + 
block_y
;

691 
i
 = 0; i < 
BLOCK_SIZE
;i++)

692 
s3
 +
image
[
pos_y
++][
pos_x
];

694 i‡(
mb_avaûabÀ_up
 && 
mb_avaûabÀ_À·
[0])

695 
s
 = (
s1
 + 
s3
 + 4) >> 3;

696 i‡(
mb_avaûabÀ_up
)

697 
s
 = (
s1
 + 2) >> 2;

698 i‡(
mb_avaûabÀ_À·
[0])

699 
s
 = (
s3
 + 2) >> 2;

705 
cur_¥ed
 = 
cuº_m¥_16x16
[
DC_PRED_8
];

706 
j
 = 
block_y
; j < block_y+4; j++)

708 
i
 = 
block_x
; i < block_x+4; i++)

710 
cur_¥ed
[
j
][
i
] = (
img≥l
Ë
s
;

717 i‡(
mb_avaûabÀ_up
)

719 
cur_¥ed
 = 
cuº_m¥_16x16
[
VERT_PRED_8
];

720 
hlöe
 = &
image
[
pix_c
.
pos_y
][pix_c.
pos_x
];

721 
j
=0; j<
¸_MB_y
; j++)

722 
	`mem˝y
(
cur_¥ed
[
j
], 
hlöe
, 
¸_MB_x
 * (
img≥l
));

726 i‡(
mb_avaûabÀ_À·
[0])

728 
pos_x
 = 
pix_a
.pos_x;

729 
pos_y
 = 
pix_a
.pos_y;

730 
cur_¥ed
 = 
cuº_m¥_16x16
[
HOR_PRED_8
];

731 
i
=0; i<
¸_MB_y
; i++)

732 
vlöe
[
i
] = 
image
[
pos_y
++][
pos_x
];

734 
j
=0; j<
¸_MB_y
; j++)

736 
¥edi˘‹
 = 
vlöe
[
j
];

737 
i
 = 0; i < 
¸_MB_x
; i++)

738 
cur_¥ed
[
j
][
i
] = (
img≥l
Ë
¥edi˘‹
;

743 i‡(
mb_avaûabÀ_À·
[0] && 
mb_avaûabÀ_up
 && 
mb_avaûabÀ_up_À·
)

745 
¸_x
 = (
¸_MB_x
 >> 1);

746 
¸_y
 = (
¸_MB_y
 >> 1);

748 
üa
, 
iv
, 
ib
, 
ic
;

749 
ih
 = 
¸_x
 * (
hlöe
[
¸_MB_x
-1] - 
image
[
pix_d
.
pos_y
][pix_d.
pos_x
]);

751 
i
 = 0; i < 
¸_x
 - 1; i++)

752 
ih
 +(
i
 + 1)*(
hlöe
[
¸_x
 + i] - hline[cr_x - 2 - i]);

754 
iv
 = 
¸_y
 * (
vlöe
[
¸_MB_y
-1] - 
image
[
pix_d
.
pos_y
][pix_d.
pos_x
]);

755 
i
 = 0; i < 
¸_y
 - 1; i++)

756 
iv
 +(
i
 + 1Ë* (
vlöe
[
¸_y
 + i] - vline[cr_y - 2 - i]);

758 i‡(
¸_MB_x
 == 8)

759 
ib
 = (17 * 
ih
 + 2 * 
¸_MB_x
) >> 5;

761 
ib
 = ( 5 * 
ih
 + 2 * 
¸_MB_x
) >> 6;

763 i‡(
¸_MB_y
 == 8)

764 
ic
 = (17 * 
iv
 + 2 * 
¸_MB_y
) >> 5;

766 
ic
 = ( 5 * 
iv
 + 2 * 
¸_MB_y
) >> 6;

768 
üa
 = 16 * (
hlöe
[
¸_MB_x
 - 1] + 
vlöe
[
¸_MB_y
 - 1]);

769 
cur_¥ed
 = 
cuº_m¥_16x16
[
PLANE_8
];

770 
üa
 +(1 - 
¸_x
Ë* 
ib
 + (1 - 
¸_y
Ë* 
ic
;

771 
j
 = 0; j < 
¸_MB_y
; j++)

772 
i
 = 0; i < 
¸_MB_x
; i++)

773 
cur_¥ed
[
j
][
i
](
img≥l
Ë
	`iClù1
–
max_img≥l_vÆue_uv
, (
üa
 + i * 
ib
 + j * 
ic
 + 16)>>5);

777 i‡(!
p_I≈
->
rd›t
)

779 
cuºSli˚
->
	`rdo_low_öåa_chroma_decisi⁄
(
cuºMB
, 
mb_avaûabÀ_up
, 
mb_avaûabÀ_À·
, 
mb_avaûabÀ_up_À·
);

781 
	}
}

789 
	$öåa_chroma_¥edi˘i⁄_mbaff
(
Ma¸oblock
 *
cuºMB
, *
mb_up
, *
mb_À·
, *
mb_up_À·
)

791 
s
, 
i
, 
j
;

793 
uv
;

794 
b8
,
b4
;

795 
img≥l
 
vlöe
[16];

797 
mb_avaûabÀ_up
;

798 
mb_avaûabÀ_À·
[2];

799 
mb_avaûabÀ_up_À·
;

801 
PixñPos
 
pix_b
;

802 
PixñPos
 
pix_a
[17];

804 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

805 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

806 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºSli˚
->p_Inp;

807 
¸_MB_x
 = 
p_Vid
->
mb_¸_size_x
;

808 
¸_MB_y
 = 
p_Vid
->
mb_¸_size_y
;

809 
img≥l
 **
cur_¥ed
 = 
NULL
;

810 
img≥l
 ***
cuº_m¥_16x16
 = 
NULL
;

811 
img≥l
 *
hlöe
 = 
NULL
;

813 
yuv
 = 
p_Vid
->
yuv_f‹m©
 - 1;

814 
dc_¥ed_vÆue_chroma
 = 
p_Vid
->
dc_¥ed_vÆue_comp
[1];

815 
max_img≥l_vÆue_uv
 = 
p_Vid
->
max_≥l_vÆue_comp
[1];

816 *
mb_size
 = 
p_Vid
->mb_size[
IS_CHROMA
];

818 c⁄° 
block_pos
[3][4][4]=

825 
i
 = 0; i < 
¸_MB_y
 + 1; ++i)

827 
p_Vid
->
	`gëNeighbour
(
cuºMB
, -1 , 
i
-1 , 
mb_size
, &
pix_a
[i]);

830 
p_Vid
->
	`gëNeighbour
(
cuºMB
, 0 , -1 , 
mb_size
, &
pix_b
);

832 i‡(
p_I≈
->
U£C⁄°øöedI¡øPªd
 == 0)

834 
mb_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
;

835 
mb_avaûabÀ_up_À·
 = 
pix_a
[0].
avaûabÀ
;

836 
mb_avaûabÀ_À·
[0] = mb_avaûabÀ_À·[1] = 
pix_a
[1].
avaûabÀ
;

840 
mb_avaûabÀ_up
 = 
pix_b
.
avaûabÀ
 ? 
p_Vid
->
öåa_block
[pix_b.
mb_addr
] : 0;

841 
i
=0, 
mb_avaûabÀ_À·
[0] = 1; i < (
¸_MB_y
 >> 1); i++)

842 
mb_avaûabÀ_À·
[0] &
pix_a
[
i
 + 1].
avaûabÀ
 ? 
p_Vid
->
öåa_block
[pix_a[i+1].
mb_addr
]: 0;

843 
i
=(
¸_MB_y
>>1), 
mb_avaûabÀ_À·
[1]=1; i<cr_MB_y;i++)

844 
mb_avaûabÀ_À·
[1] &
pix_a
[
i
+1].
avaûabÀ
 ? 
p_Vid
->
öåa_block
[pix_a[i+1].
mb_addr
]: 0;

845 
mb_avaûabÀ_up_À·
 = 
pix_a
[0].
avaûabÀ
 ? 
p_Vid
->
öåa_block
[pix_a[0].
mb_addr
]: 0;

848 i‡(
mb_up
)

849 *
mb_up
 = 
mb_avaûabÀ_up
;

850 i‡(
mb_À·
)

851 *
mb_À·
 = 
mb_avaûabÀ_À·
[0] && mb_available_left[1];

852 i‡(
mb_up_À·
)

853 *
mb_up_À·
 = 
mb_avaûabÀ_up_À·
;

857 
uv
=0; uv<2; uv++)

859 
img≥l
 **
image
 = 
p_Vid
->
íc_pi˘uª
->
imgUV
[
uv
];

860 
cuº_m¥_16x16
 = 
cuºSli˚
->
m¥_16x16
[
uv
 + 1];

863 
b8
=0; b8<
p_Vid
->
num_blk8x8_uv
 >> 1;b8++)

865 
b4
 = 0; b4 < 4; b4++)

867 
block_y
 = 
subblk_off£t_y
[
yuv
][
b8
][
b4
];

868 
block_x
 = 
subblk_off£t_x
[
yuv
][
b8
][
b4
];

869 
blk_x
 = 
block_x
;

870 
blk_y
 = 
block_y
 + 1;

872 
s
 = 
dc_¥ed_vÆue_chroma
;

875 
block_pos
[
yuv
][
b8
][
b4
])

879 
s0
 = 0, 
s2
 = 0;

880 i‡(
mb_avaûabÀ_up
)

881 
i
 = 
blk_x
; i < (blk_x + 4); i++)

882 
s0
 +
image
[
pix_b
.
pos_y
][pix_b.
pos_x
 + 
i
];

883 i‡(
mb_avaûabÀ_À·
[0])

884 
i
 = 
blk_y
; i < (blk_y + 4);i++)

885 
s2
 +
image
[
pix_a
[
i
].
pos_y
][pix_a[i].
pos_x
];

886 i‡(
mb_avaûabÀ_up
 && 
mb_avaûabÀ_À·
[0])

887 
s
 = (
s0
 + 
s2
 + 4) >> 3;

888 i‡(
mb_avaûabÀ_up
)

889 
s
 = (
s0
 + 2) >> 2;

890 i‡(
mb_avaûabÀ_À·
[0])

891 
s
 = (
s2
 + 2) >> 2;

896 
s1
 = 0, 
s2
 = 0;

897 i‡(
mb_avaûabÀ_up
)

898 
i
=
blk_x
;i<(blk_x+4);i++)

899 
s1
 +
image
[
pix_b
.
pos_y
][pix_b.
pos_x
 + 
i
];

900 i‡(
mb_avaûabÀ_À·
[0])

901 
i
=
blk_y
;i<(blk_y+4);i++)

902 
s2
 +
image
[
pix_a
[
i
].
pos_y
][pix_a[i].
pos_x
];

903 i‡(
mb_avaûabÀ_up
)

904 
s
 = (
s1
 +2) >> 2;

905 i‡(
mb_avaûabÀ_À·
[0])

906 
s
 = (
s2
 +2) >> 2;

910 i‡(
mb_avaûabÀ_À·
[1])

912 
s3
 = 0;

913 
i
=
blk_y
;i<(blk_y+4);i++)

914 
s3
 +
image
[
pix_a
[
i
].
pos_y
][pix_a[i].
pos_x
];

915 
s
 = (
s3
 + 2) >> 2;

917 i‡(
mb_avaûabÀ_up
)

919 
s0
 = 0;

920 
i
=
blk_x
;i<(blk_x+4);i++)

921 
s0
 +
image
[
pix_b
.
pos_y
][pix_b.
pos_x
 + 
i
];

922 
s
 = (
s0
 + 2) >> 2;

927 
s1
 = 0, 
s3
 = 0;

928 i‡(
mb_avaûabÀ_up
)

929 
i
=
blk_x
;i<(blk_x+4);i++)

930 
s1
 +
image
[
pix_b
.
pos_y
][pix_b.
pos_x
 + 
i
];

931 i‡(
mb_avaûabÀ_À·
[1])

932 
i
=
blk_y
;i<(blk_y+4);i++)

933 
s3
 +
image
[
pix_a
[
i
].
pos_y
][pix_a[i].
pos_x
];

934 i‡(
mb_avaûabÀ_up
 && 
mb_avaûabÀ_À·
[1])

935 
s
 = (
s1
 + 
s3
 + 4) >> 3;

936 i‡(
mb_avaûabÀ_up
)

937 
s
 = (
s1
 + 2) >> 2;

938 i‡(
mb_avaûabÀ_À·
[1])

939 
s
 = (
s3
 + 2) >> 2;

945 
cur_¥ed
 = 
cuº_m¥_16x16
[
DC_PRED_8
];

946 
j
 = 
block_y
; j < block_y+4; j++)

948 
i
 = 
block_x
; i < block_x+4; i++)

950 
cur_¥ed
[
j
][
i
] = (
img≥l
Ë
s
;

957 i‡(
mb_avaûabÀ_up
)

959 
cur_¥ed
 = 
cuº_m¥_16x16
[
VERT_PRED_8
];

960 
hlöe
 = &
image
[
pix_b
.
pos_y
][pix_b.
pos_x
];

961 
j
=0; j<
¸_MB_y
; j++)

962 
	`mem˝y
(
cur_¥ed
[
j
], 
hlöe
, 
¸_MB_x
 * (
img≥l
));

966 i‡(
mb_avaûabÀ_À·
[0] && mb_available_left[1])

968 
cur_¥ed
 = 
cuº_m¥_16x16
[
HOR_PRED_8
];

969 
i
=0; i<
¸_MB_y
; i++)

970 
vlöe
[
i
] = 
image
[
pix_a
[i+1].
pos_y
][pix_a[i+1].
pos_x
];

971 
j
=0; j<
¸_MB_y
; j++)

973 
¥edi˘‹
 = 
vlöe
[
j
];

974 
i
=0; i<
¸_MB_x
; i++)

975 
cur_¥ed
[
j
][
i
] = (
img≥l
Ë
¥edi˘‹
;

980 i‡(
mb_avaûabÀ_À·
[0] && mb_avaûabÀ_À·[1] && 
mb_avaûabÀ_up
 && 
mb_avaûabÀ_up_À·
)

982 
¸_x
 = (
¸_MB_x
 >> 1);

983 
¸_y
 = (
¸_MB_y
 >> 1);

985 
üa
, 
iv
, 
ib
, 
ic
;

986 
ih
 = 
¸_x
 * (
hlöe
[
¸_MB_x
-1] - 
image
[
pix_a
[0].
pos_y
][pix_a[0].
pos_x
]);

987 
i
 = 0; i < 
¸_x
 - 1; i++)

988 
ih
 +(
i
+1)*(
hlöe
[
¸_x
 + i] - hline[cr_x - 2 - i]);

990 
iv
 = 
¸_y
 * (
vlöe
[
¸_MB_y
-1] - 
image
[
pix_a
[0].
pos_y
][pix_a[0].
pos_x
]);

991 
i
 = 0; i < 
¸_y
 - 1; i++)

992 
iv
 +(
i
 + 1Ë* (
vlöe
[
¸_y
 + i] - vline[cr_y - 2 - i]);

994 i‡(
¸_MB_x
 == 8)

995 
ib
 = (17 * 
ih
 + 2 * 
¸_MB_x
) >> 5;

997 
ib
 = ( 5 * 
ih
 + 2 * 
¸_MB_x
) >> 6;

998 i‡(
¸_MB_y
 == 8)

999 
ic
 = (17 * 
iv
 + 2 * 
¸_MB_y
) >> 5;

1001 
ic
 = ( 5 * 
iv
 + 2 * 
¸_MB_y
) >> 6;

1003 
üa
 = 16 * (
hlöe
[
¸_MB_x
 - 1] + 
vlöe
[
¸_MB_y
 - 1]);

1004 
cur_¥ed
 = 
cuº_m¥_16x16
[
PLANE_8
];

1005 
üa
 +(1 - 
¸_x
Ë* 
ib
 + (1 - 
¸_y
Ë* 
ic
;

1006 
j
 = 0; j < 
¸_MB_y
; j++)

1007 
i
 = 0; i < 
¸_MB_x
; i++)

1008 
cur_¥ed
[
j
][
i
](
img≥l
Ë
	`iClù1
–
max_img≥l_vÆue_uv
, (
üa
 + i * 
ib
 + j * 
ic
 + 16)>>5);

1012 i‡(!
p_I≈
->
rd›t
)

1014 
cuºSli˚
->
	`rdo_low_öåa_chroma_decisi⁄
(
cuºMB
, 
mb_avaûabÀ_up
, 
mb_avaûabÀ_À·
, 
mb_avaûabÀ_up_À·
);

1016 
	}
}

1024 
	$öåa_chroma_RD_decisi⁄
 (
Ma¸oblock
 *
cuºMB
, 
RD_PARAMS
 *
íc_mb
)

1026 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1027 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1028 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

1029 
img≥l
** 
image
;

1030 
block_x
, 
block_y
;

1031 
mb_avaûabÀ_up
;

1032 
mb_avaûabÀ_À·
;

1033 
mb_avaûabÀ_up_À·
;

1034 
uv
;

1035 
mode
;

1036 
be°_mode
 = 
DC_PRED_8
;

1037 
di°blk
 
co°
;

1039 
di°blk
 
mö_co°
 = 
DISTBLK_MAX
;

1041 
PixñPos
 
pix_a
;

1042 
PixñPos
 
pix_b
;

1043 
PixñPos
 
pix_c
;

1044 
PixñPos
 
pix_d
;

1045 
¸_MB_x
 = 
p_Vid
->
mb_¸_size_x
;

1046 
¸_MB_y
 = 
p_Vid
->
mb_¸_size_y
;

1047 
img≥l
 ***
cuº_m¥_16x16
;

1049 
diff
 [16];

1051 
p_Vid
->
	`gëNeighbour
(
cuºMB
, -1 , -1 ,Ö_Vid->
mb_size
[
IS_CHROMA
], &
pix_b
);

1052 
p_Vid
->
	`gëNeighbour
(
cuºMB
, -1 , 0 ,Ö_Vid->
mb_size
[
IS_CHROMA
], &
pix_d
);

1053 
p_Vid
->
	`gëNeighbour
(
cuºMB
, 0 , -1 ,Ö_Vid->
mb_size
[
IS_CHROMA
], &
pix_c
);

1054 
p_Vid
->
	`gëNeighbour
(
cuºMB
, 0 , 0 ,Ö_Vid->
mb_size
[
IS_CHROMA
], &
pix_a
);

1056 
mb_avaûabÀ_up
 = 
pix_c
.
avaûabÀ
;

1057 
mb_avaûabÀ_up_À·
 = 
pix_b
.
avaûabÀ
;

1058 
mb_avaûabÀ_À·
 = 
pix_d
.
avaûabÀ
;

1060 if(
p_I≈
->
U£C⁄°øöedI¡øPªd
)

1062 
mb_avaûabÀ_up
 = 
pix_c
.
avaûabÀ
 ? 
p_Vid
->
öåa_block
[pix_c.
mb_addr
] : 0;

1063 
mb_avaûabÀ_À·
 = 
pix_d
.
avaûabÀ
 ? 
p_Vid
->
öåa_block
[pix_d.
mb_addr
] : 0;

1064 
mb_avaûabÀ_up_À·
 = 
pix_b
.
avaûabÀ
 ? 
p_Vid
->
öåa_block
[pix_b.
mb_addr
] : 0;

1068 
mode
 = 
DC_PRED_8
; modê<
PLANE_8
; ++mode)

1070 i‡((
mode
==
VERT_PRED_8
 && !
mb_avaûabÀ_up
) ||

1071 (
mode
==
HOR_PRED_8
 && (!
mb_avaûabÀ_À·
)) ||

1072 (
mode
==
PLANE_8
 && (!
mb_avaûabÀ_À·
 || !
mb_avaûabÀ_up
 || !
mb_avaûabÀ_up_À·
)))

1075 
co°
 = 
	`weight_co°
(
íc_mb
->
œmbda_mf
[
Q_PEL
], 
p_Vid
->
mvbôs
[ 
mode
 ]);

1077 
uv
 = 1; uv < 3; ++uv)

1079 
pos_x
 = 
pix_a
.pos_x;

1080 
pos_y
 = 
pix_a
.pos_y;

1081 
image
 = 
p_Vid
->
pImgOrg
[
uv
];

1082 
cuº_m¥_16x16
 = 
cuºSli˚
->
m¥_16x16
[
uv
];

1084 
block_y
=0; block_y<
¸_MB_y
; block_y+=4)

1086 
block_x
=0; block_x<
¸_MB_x
; block_x+=4)

1088 
	`gë_dif„ªn˚_4x4
(&
image
[
pos_y
 + 
block_y
], &
cuº_m¥_16x16
[
mode
][block_y], 
diff
, 
pos_x
, 
block_x
);

1089 
co°
 +
p_Vid
->
	`di°‹ti⁄4x4
(
diff
, 
mö_co°
);

1090 i‡(
co°
 > 
mö_co°
) ;

1092 i‡(
co°
 > 
mö_co°
) ;

1094 i‡(
co°
 > 
mö_co°
) ;

1097 i‡(
co°
 < 
mö_co°
)

1099 
be°_mode
 = 
mode
;

1100 
mö_co°
 = 
co°
;

1103 
cuºMB
->
c_ùªd_mode
 = (Ë
be°_mode
;

1104 
	}
}

1112 
	$öåa_chroma_RD_decisi⁄_mbaff
 (
Ma¸oblock
 *
cuºMB
, 
RD_PARAMS
 *
íc_mb
)

1114 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1115 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1116 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

1117 
i
, 
j
, 
k
;

1118 
img≥l
** 
image
;

1119 
block_x
, 
block_y
;

1120 
mb_avaûabÀ_up
;

1121 
mb_avaûabÀ_À·
[2];

1122 
mb_avaûabÀ_up_À·
;

1123 
uv
;

1124 
mode
;

1125 
be°_mode
 = 
DC_PRED_8
;

1126 
di°blk
 
co°
;

1128 
di°blk
 
mö_co°
 = 
DISTBLK_MAX
;

1130 
PixñPos
 
pix_c
;

1131 
PixñPos
 
pix_a
[17];

1132 
¸_MB_x
 = 
p_Vid
->
mb_¸_size_x
;

1133 
¸_MB_y
 = 
p_Vid
->
mb_¸_size_y
;

1134 
img≥l
 *
img_‹g
, *
img_¥d
;

1135 
img≥l
 ***
cuº_m¥_16x16
;

1136 
diff
 [16];

1138 
i
=0;i<
¸_MB_y
+1;++i)

1140 
p_Vid
->
	`gëNeighbour
(
cuºMB
, -1 , 
i
-1 ,Ö_Vid->
mb_size
[
IS_CHROMA
], &
pix_a
[i]);

1142 
p_Vid
->
	`gëNeighbour
(
cuºMB
, 0 , -1 ,Ö_Vid->
mb_size
[
IS_CHROMA
], &
pix_c
);

1144 
mb_avaûabÀ_up
 = 
pix_c
.
avaûabÀ
;

1145 
mb_avaûabÀ_up_À·
 = 
pix_a
[0].
avaûabÀ
;

1146 
mb_avaûabÀ_À·
[0] = mb_avaûabÀ_À·[1] = 
pix_a
[1].
avaûabÀ
;

1148 if(
p_I≈
->
U£C⁄°øöedI¡øPªd
)

1150 
mb_avaûabÀ_up
 = 
pix_c
.
avaûabÀ
 ? 
p_Vid
->
öåa_block
[pix_c.
mb_addr
] : 0;

1151 
i
=1, 
mb_avaûabÀ_À·
[0] = 1; i < (
¸_MB_y
>>1) + 1; ++i)

1152 
mb_avaûabÀ_À·
[0] &
pix_a
[
i
].
avaûabÀ
 ? 
p_Vid
->
öåa_block
[pix_a[i].
mb_addr
]: 0;

1154 
i
=(
¸_MB_y
>>1Ë+ 1, 
mb_avaûabÀ_À·
[1]=1; i < cr_MB_y + 1;++i)

1155 
mb_avaûabÀ_À·
[1] &
pix_a
[
i
].
avaûabÀ
 ? 
p_Vid
->
öåa_block
[pix_a[i].
mb_addr
]: 0;

1157 
mb_avaûabÀ_up_À·
 = 
pix_a
[0].
avaûabÀ
 ? 
p_Vid
->
öåa_block
[pix_a[0].
mb_addr
]: 0;

1160 
i
=0;i<
¸_MB_y
;++i)

1162 
p_Vid
->
	`gëNeighbour
(
cuºMB
, 0, 
i
,Ö_Vid->
mb_size
[
IS_CHROMA
], &
pix_a
[i]);

1164 i‡–
cuºSli˚
->
mb_aff_‰ame_Êag
 && 
p_Vid
->
fõld_mode
 )

1166 
i
=0;i<
¸_MB_y
;++i)

1168 
pix_a
[
i
].
pos_y
 =Öix_a[i].pos_y >> 1;

1172 
mode
=
DC_PRED_8
; mode<=
PLANE_8
; ++mode)

1174 i‡((
mode
==
VERT_PRED_8
 && !
mb_avaûabÀ_up
) ||

1175 (
mode
==
HOR_PRED_8
 && (!
mb_avaûabÀ_À·
[0] || !mb_available_left[1])) ||

1176 (
mode
==
PLANE_8
 && (!
mb_avaûabÀ_À·
[0] || !mb_avaûabÀ_À·[1] || !
mb_avaûabÀ_up
 || !
mb_avaûabÀ_up_À·
)))

1179 
co°
 = 0;

1180 
uv
 = 1; uv < 3; ++uv)

1182 
image
 = 
p_Vid
->
pImgOrg
[
uv
];

1183 
cuº_m¥_16x16
 = 
cuºSli˚
->
m¥_16x16
[
uv
];

1184 
block_y
=0; block_y<
¸_MB_y
; block_y+=4)

1186 
block_x
=0; block_x<
¸_MB_x
; block_x+=4)

1188 
k
=0,
j
=
block_y
; j<block_y+4; ++j)

1190 
img_¥d
 = 
cuº_m¥_16x16
[
mode
][
j
];

1191 
img_‹g
 = &
image
[
pix_a
[
j
].
pos_y
][pix_a[j].
pos_x
];

1193 
i
 = 
block_x
; i < block_x + 4; ++i)

1194 
diff
[
k
++] = 
img_‹g
[
i
] - 
img_¥d
[i];

1197 
co°
 +
p_Vid
->
	`di°‹ti⁄4x4
(
diff
, 
mö_co°
);

1198 i‡(
co°
 > 
mö_co°
) ;

1200 i‡(
co°
 > 
mö_co°
) ;

1202 i‡(
co°
 > 
mö_co°
) ;

1206 
co°
 +
	`weight_co°
(
íc_mb
->
œmbda_mf
[
Q_PEL
], 
p_Vid
->
mvbôs
[ 
mode
 ]);

1208 i‡(
co°
 < 
mö_co°
)

1210 
be°_mode
 = 
mode
;

1211 
mö_co°
 = 
co°
;

1214 
cuºMB
->
c_ùªd_mode
 = (Ë
be°_mode
;

1215 
	}
}

	@lencod/src/intrarefresh.c

17 
	~"globÆ.h
"

34 
	$R™domI¡øInô
(
VideoP¨amëîs
 *
p_Vid
, 
xsize
, 
ysize
, 
ª‰esh
)

36 
i
, 
pos
;

38 
	`§™d
 (1);

39 
p_Vid
->
NumbîOfMBs
 = 
xsize
 * 
ysize
;

40 
p_Vid
->
NumbîI¡øPîPi˘uª
 = 
ª‰esh
;

42 i‡(
ª‰esh
 != 0)

44 
p_Vid
->
Re‰eshP©ã∫
 = 
	`mÆloc
 ( (Ë*Ö_Vid->
NumbîOfMBs
);

45 i‡(
p_Vid
->
Re‰eshP©ã∫
 =
NULL
Ë
	`no_mem_exô
("RandomIntraInit:Ö_Vid->RefreshPattern");

47 
p_Vid
->
I¡øMBs
 = 
	`mÆloc
 ( (Ë* 
ª‰esh
);

48 i‡(
p_Vid
->
I¡øMBs
 =
NULL
Ë
	`no_mem_exô
("RandomIntraInit:Ö_Vid->IntraMBs");

50 
i
0; i<
p_Vid
->
NumbîOfMBs
; i++)

51 
p_Vid
->
Re‰eshP©ã∫
[
i
] = -1;

53 
i
=0; i<
p_Vid
->
NumbîOfMBs
; i++)

57 
pos
 = 
	`ønd
(Ë% 
p_Vid
->
NumbîOfMBs
;

58 } 
p_Vid
->
Re‰eshP©ã∫
 [
pos
] != -1);

59 
p_Vid
->
Re‰eshP©ã∫
 [
pos
] = 
i
;

68 
p_Vid
->
Re‰eshP©ã∫
 = 
NULL
;

69 
p_Vid
->
I¡øMBs
 = 
NULL
;

71 
	}
}

87 
	$R™domI¡ø
 (
VideoP¨amëîs
 *
p_Vid
, 
mb
)

89 
i
;

91 
i
=0; i<
p_Vid
->
NumbîI¡øPîPi˘uª
; i++)

92 i‡(
p_Vid
->
I¡øMBs
[
i
] =
mb
)

95 
	}
}

109 
	$R™domI¡øNewPi˘uª
 (
VideoP¨amëîs
 *
p_Vid
)

111 
i
, 
j
;

113 
p_Vid
->
WÆkAround
 +p_Vid->
NumbîI¡øPîPi˘uª
;

114 
j
=0, 
i
 = 
p_Vid
->
WÆkAround
; j<p_Vid->
NumbîI¡øPîPi˘uª
; j++, i++)

115 
p_Vid
->
I¡øMBs
[
j
] =Ö_Vid->
Re‰eshP©ã∫
 [
i
%p_Vid->
NumbîOfMBs
];

116 
	}
}

118 
	$R™domI¡øUnöô
(
VideoP¨amëîs
 *
p_Vid
)

120 i‡(
p_Vid
->
NumbîI¡øPîPi˘uª
 >0 )

122 
	`‰ì
(
p_Vid
->
Re‰eshP©ã∫
);

123 
	`‰ì
(
p_Vid
->
I¡øMBs
);

125 
	}
}

	@lencod/src/lambda.c

16 
	~"globÆ.h
"

17 
	~"¶i˚.h
"

19 
	$SëLambda
(
VideoP¨amëîs
 *
p_Vid
, 
j
, 
qp
, 
œmbda_sˇÀ
)

21 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

22 
k
;

23 
p_Vid
->
œmbda_md
[
j
][
qp
] *
œmbda_sˇÀ
;

25 
k
 = 
F_PEL
; k <
Q_PEL
; k++)

29 
p_Vid
->
œmbda_me
[
j
][
qp
][
k
] = (
p_I≈
->
MEEº‹Mëric
[k] =
ERROR_SSE
 &&Ö_I≈->
MESo·íSSEMëric
 =0Ë?Ö_Vid->
œmbda_md
[j][qp] : 
	`sqπ
(p_Vid->lambda_md[j][qp]);

30 
p_Vid
->
œmbda_mf
[
j
][
qp
][
k
] = 
	`LAMBDA_FACTOR
 (p_Vid->
œmbda_me
[j][qp][k]);

32 
	}
}

34 
	$CÆcMaxLamdaMD
(
VideoP¨amëîs
 *
p_Vid
, *
p_œmbda_md
)

36 
max_œmbda_md
;

37 
iBôs
;

39 if(
p_Vid
->
p_I≈
->
ProfûeIDC
 >
FREXT_HP
)

40 
iBôs
=128;

42 
iBôs
=80;

44 if(
p_Vid
->
yuv_f‹m©
 =
YUV420
)

45 
iBôs
 += 3072;

46 if(
p_Vid
->
yuv_f‹m©
 =
YUV422
)

47 
iBôs
 += 4096;

48 if(
p_Vid
->
yuv_f‹m©
 =
YUV444
)

49 
iBôs
 += 6144;

50 if(
p_Vid
->
yuv_f‹m©
 =
YUV400
)

51 
iBôs
 += 2048;

53 
max_œmbda_md
 = 
	`Êo‹
((()
DISTBLK_MAX
)/
iBôs
/(1<<
LAMBDA_ACCURACY_BITS
));

54 #i‡
JCOST_OVERFLOWCHECK


56 
di°blk
 
co°
 = 
	`weight_co°
(
	`LAMBDA_FACTOR
(
max_œmbda_md
), 
iBôs
);

57 
	`as£π
(
co°
>=0 && co°<=
DISTBLK_MAX
);

60 *
p_œmbda_md
 = 
max_œmbda_md
;

61 
	}
}

63 
	$ClùLambda
(*
p_œmbda_max
, *
p_œmbda
)

65 if(*
p_œmbda
 > *
p_œmbda_max
)

68 *
p_œmbda
 = *
p_œmbda_max
;

70 
	}
}

72 
	$£t_rdoq_œmbda
–
Sli˚
 *
cuºSli˚
 )

74 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

75 
qp
, 
j
 = 
cuºSli˚
->
¶i˚_ty≥
;

77 
qp
 = -
cuºSli˚
->
bôdïth_luma_qp_sˇÀ
; qp < 52; qp++)

79 
p_Vid
->
œmbda_rdoq
[
j
][
qp
] =Ö_Vid->
œmbda_md
[j][qp];

81 
	}
}

83 
	$gë_im∂icô_œmbda_p_¶i˚
(
Sli˚
 *
cuºSli˚
)

85 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

86 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºSli˚
->p_Inp;

87 
qp
;

88 
qp_ãmp
;

89 
œmbda_md
;

90 
œmbda_sˇÀ
 = 1.0 - 
	`dClù3
(0.0,0.5,0.05 * (Ë
p_I≈
->
jumpd
);

92 
bLimôsLambdaMD
 = ((
p_I≈
->
E«bÀIPCM
 > 0Ë&& (
IMGTYPE
==0));

93 
dMaxLambdaMD
 =0;

95 if(
bLimôsLambdaMD
)

96 
	`CÆcMaxLamdaMD
(
p_Vid
, &
dMaxLambdaMD
);

98 
qp
 = -
cuºSli˚
->
bôdïth_luma_qp_sˇÀ
; qp < 52; qp++)

100 
qp_ãmp
 = ()
qp
 + 
cuºSli˚
->
bôdïth_luma_qp_sˇÀ
 - 
SHIFT_QP
;

102 i‡(
p_I≈
->
NumbîBFømes
 > 0)

104 
œmbda_md
 = 0.68 * 
	`pow
 (2.0, 
qp_ãmp
/3.0);

107 
œmbda_md
 = 0.85 * 
	`pow
 (2.0, 
qp_ãmp
/3.0);

110 
œmbda_md
 = ((
p_I≈
->
MEEº‹Mëric
[
H_PEL
] =
ERROR_SATD
 &&Ö_I≈->MEEº‹Mëric[
Q_PEL
] == ERROR_SATD) ? 1.00 : 0.95) *Üambda_md;

111 
p_Vid
->
œmbda_md
[
P_SLICE
][
qp
] = 
œmbda_sˇÀ
 *Üambda_md;

114 if(
bLimôsLambdaMD
)

115 
	`ClùLambda
(&
dMaxLambdaMD
, &
p_Vid
->
œmbda_md
[
P_SLICE
][
qp
]);

117 
	`SëLambda
(
p_Vid
, 
P_SLICE
, 
qp
, 1.0);

119 i‡(
p_I≈
->
CtxAd±LagøngeMu…
 == 1)

121 
œmbda_qp
 = (
qp
 >32 && !
p_I≈
->
RCE«bÀ
Ë? 
	`imax
(0, qp - 4) : imax(0, qp - 6);

122 
p_Vid
->
œmbda_mf_Á˘‹
[
P_SLICE
][
qp
] = 
	`log
 (p_Vid->
œmbda_me
[P_SLICE][
œmbda_qp
][
Q_PEL
] + 1.0) /Üog (2.0);

125 
	}
}

127 
	$gë_im∂icô_œmbda_b_¶i˚
(
Sli˚
 *
cuºSli˚
)

129 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

130 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºSli˚
->p_Inp;

131 
qp
;

132 
qp_ãmp
;

133 
œmbda_md
;

134 
FømeUnôSåu˘
 *
p_cur_‰m
 = 
p_Vid
->
p_cuº_‰m_°ru˘
;

136 
bLimôsLambdaMD
 = ((
p_I≈
->
E«bÀIPCM
 > 0Ë&& (
IMGTYPE
==0));

137 
dMaxLambdaMD
 =0;

139 if(
bLimôsLambdaMD
)

140 
	`CÆcMaxLamdaMD
(
p_Vid
, &
dMaxLambdaMD
);

142 
qp
 = -
cuºSli˚
->
bôdïth_luma_qp_sˇÀ
; qp < 52; qp++)

144 
qp_ãmp
 = ()
qp
 + 
cuºSli˚
->
bôdïth_luma_qp_sˇÀ
 - 
SHIFT_QP
;

146 i‡(
p_I≈
->
NumbîBFømes
 > 0)

148 
œmbda_md
 = 0.68 * 
	`pow
 (2.0, 
qp_ãmp
/3.0)

149 * (
p_cur_‰m
->
œyî
 !0 ? 
	`dClù3
(2.00, 4.00, (
qp_ãmp
 / 6.0)) : 1.0);

152 
œmbda_md
 = 0.85 * 
	`pow
 (2.0, 
qp_ãmp
/3.0);

155 
œmbda_md
 = ((
p_I≈
->
MEEº‹Mëric
[
H_PEL
] =
ERROR_SATD
 &&Ö_I≈->MEEº‹Mëric[
Q_PEL
] == ERROR_SATD) ? 1.00 : 0.95) *Üambda_md;

157 i‡(
p_cur_‰m
->
œyî
 !0 && 
cuºSli˚
->
«l_ª„ªn˚_idc
)

159 i‡(
p_I≈
->
HõørchiˇlCodög
 == 2)

160 
œmbda_md
 *(1.0 - 
	`dmö
(0.4, 0.2 * (Ë(
p_cur_‰m
->
p_©om
->
g›_Àvñs
 -Ö_cur_‰m->
œyî
)));

162 
œmbda_md
 *= 0.80;

164 
p_Vid
->
œmbda_md
[
B_SLICE
][
qp
] =Üambda_md;

167 if(
bLimôsLambdaMD
)

168 
	`ClùLambda
(&
dMaxLambdaMD
, &
p_Vid
->
œmbda_md
[
B_SLICE
][
qp
]);

170 
	`SëLambda
(
p_Vid
, 
B_SLICE
, 
qp
, 1.0);

172 i‡(
p_I≈
->
CtxAd±LagøngeMu…
 == 1)

174 
œmbda_qp
 = (
qp
 >32 && !
p_I≈
->
RCE«bÀ
Ë? 
	`imax
(0, qp - 4) : imax(0, qp - 6);

175 
p_Vid
->
œmbda_mf_Á˘‹
[
B_SLICE
][
qp
] = 
	`log
 (p_Vid->
œmbda_me
[B_SLICE][
œmbda_qp
][
Q_PEL
] + 1.0) /Üog (2.0);

178 
	}
}

180 
	$gë_im∂icô_œmbda_i_¶i˚
(
Sli˚
 *
cuºSli˚
)

182 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

183 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºSli˚
->p_Inp;

184 
qp
;

185 
qp_ãmp
;

186 
œmbda_md
;

187 
œmbda_sˇÀ
 = 1.0 - 
	`dClù3
(0.0,0.5,0.05 * (Ë
p_I≈
->
jumpd
);

189 
bLimôsLambdaMD
 = ((
p_I≈
->
E«bÀIPCM
 > 0Ë&& (
IMGTYPE
==0));

190 
dMaxLambdaMD
 =0;

192 if(
bLimôsLambdaMD
)

193 
	`CÆcMaxLamdaMD
(
p_Vid
, &
dMaxLambdaMD
);

195 
qp
 = -
cuºSli˚
->
bôdïth_luma_qp_sˇÀ
; qp < 52; qp++)

197 
qp_ãmp
 = ()
qp
 + 
cuºSli˚
->
bôdïth_luma_qp_sˇÀ
 - 
SHIFT_QP
;

199 if(
p_I≈
->
U£RDOQu™t
 && 
p_Vid
->
qp
==qp)

200 
œmbda_md
 = 0.57 * 
	`pow
 (2.0, 
qp_ãmp
/3.0);

201 i‡(
p_I≈
->
NumbîBFømes
 > 0)

203 
œmbda_md
 = 0.68 * 
	`pow
 (2.0, 
qp_ãmp
/3.0);

206 
œmbda_md
 = 0.85 * 
	`pow
 (2.0, 
qp_ãmp
/3.0);

209 
œmbda_md
 = ((
p_I≈
->
MEEº‹Mëric
[
H_PEL
] =
ERROR_SATD
 &&Ö_I≈->MEEº‹Mëric[
Q_PEL
] == ERROR_SATD) ? 1.00 : 0.95) *Üambda_md;

210 
p_Vid
->
œmbda_md
[
I_SLICE
][
qp
] = 
œmbda_sˇÀ
 *Üambda_md;

213 if(
bLimôsLambdaMD
)

214 
	`ClùLambda
(&
dMaxLambdaMD
, &
p_Vid
->
œmbda_md
[
I_SLICE
][
qp
]);

216 
	`SëLambda
(
p_Vid
, 
I_SLICE
, 
qp
, 1.0);

218 i‡(
p_I≈
->
CtxAd±LagøngeMu…
 == 1)

220 
œmbda_qp
 = (
qp
 >32 && !
p_I≈
->
RCE«bÀ
Ë? 
	`imax
(0, qp - 4) : imax(0, qp - 6);

221 
p_Vid
->
œmbda_mf_Á˘‹
[
I_SLICE
][
qp
] = 
	`log
 (p_Vid->
œmbda_me
[I_SLICE][
œmbda_qp
][
Q_PEL
] + 1.0) /Üog (2.0);

224 
	}
}

226 
	$gë_im∂icô_œmbda_•_¶i˚
(
Sli˚
 *
cuºSli˚
)

228 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

229 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºSli˚
->p_Inp;

230 
qp
;

231 
qp_ãmp
;

232 
œmbda_md
;

233 
œmbda_sˇÀ
 = 1.0 - 
	`dClù3
(0.0,0.5,0.05 * (Ë
p_I≈
->
jumpd
);

235 
bLimôsLambdaMD
 = ((
p_I≈
->
E«bÀIPCM
 > 0Ë&& (
IMGTYPE
==0));

236 
dMaxLambdaMD
 =0;

238 
¶i˚_ödex
 = 
cuºSli˚
->
¶i˚_ty≥
;

240 if(
bLimôsLambdaMD
)

241 
	`CÆcMaxLamdaMD
(
p_Vid
, &
dMaxLambdaMD
);

243 
qp
 = -
cuºSli˚
->
bôdïth_luma_qp_sˇÀ
; qp < 52; qp++)

245 
qp_ãmp
 = ()
qp
 + 
cuºSli˚
->
bôdïth_luma_qp_sˇÀ
 - 
SHIFT_QP
;

247 if(
p_I≈
->
U£RDOQu™t
 && 
p_Vid
->
ty≥
 =
I_SLICE
 &&Ö_Vid->
qp
==qp)

248 
œmbda_md
 = 0.57 * 
	`pow
 (2.0, 
qp_ãmp
/3.0);

249 i‡(
p_I≈
->
NumbîBFømes
 > 0)

251 
œmbda_md
 = 0.68 * 
	`pow
 (2.0, 
qp_ãmp
/3.0Ë* 
	`dClù3
(1.4,3.0,(qp_temp / 12.0));

254 
œmbda_md
 = 0.85 * 
	`pow
 (2.0, 
qp_ãmp
/3.0Ë* 
	`dClù3
(1.4, 3.0,(qp_temp / 12.0));

257 
œmbda_md
 = ((
p_I≈
->
MEEº‹Mëric
[
H_PEL
] =
ERROR_SATD
 &&Ö_I≈->MEEº‹Mëric[
Q_PEL
] == ERROR_SATD) ? 1.00 : 0.95) *Üambda_md;

259 
p_Vid
->
œmbda_md
[
¶i˚_ödex
][
qp
] = 
œmbda_sˇÀ
 *Üambda_md;

262 if(
bLimôsLambdaMD
)

263 
	`ClùLambda
(&
dMaxLambdaMD
, &
p_Vid
->
œmbda_md
[
¶i˚_ödex
][
qp
]);

265 
	`SëLambda
(
p_Vid
, 
¶i˚_ödex
, 
qp
, 1.0);

267 i‡(
p_I≈
->
CtxAd±LagøngeMu…
 == 1)

269 
œmbda_qp
 = (
qp
 >32 && !
p_I≈
->
RCE«bÀ
Ë? 
	`imax
(0, qp - 4) : imax(0, qp - 6);

270 
p_Vid
->
œmbda_mf_Á˘‹
[
¶i˚_ödex
][
qp
] = 
	`log
 (p_Vid->
œmbda_me
[¶i˚_ödex][
œmbda_qp
][
Q_PEL
] + 1.0) /Üog (2.0);

273 
	}
}

275 
	$gë_ex∂icô_œmbda
(
Sli˚
 *
cuºSli˚
)

277 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

278 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºSli˚
->p_Inp;

279 
qp
;

280 
qp_ãmp
;

281 
œmbda_sˇÀ
 = 1.0 - 
	`dClù3
(0.0,0.5,0.05 * (Ë
p_I≈
->
jumpd
);

283 
bLimôsLambdaMD
 = ((
p_I≈
->
E«bÀIPCM
 > 0Ë&& (
IMGTYPE
==0));

284 
dMaxLambdaMD
 =0;

285 #i‡(
MVC_EXTENSION_ENABLE
)

286 
tmp_œmbda_md
 = 0.0;

289 
j
 = 
cuºSli˚
->
¶i˚_ty≥
;

291 if(
bLimôsLambdaMD
)

292 
	`CÆcMaxLamdaMD
(
p_Vid
, &
dMaxLambdaMD
);

294 
qp
 = -
cuºSli˚
->
bôdïth_luma_qp_sˇÀ
; qp < 52; qp++)

296 
qp_ãmp
 = ()
qp
 + 
cuºSli˚
->
bôdïth_luma_qp_sˇÀ
 - 
SHIFT_QP
;

298 i‡(
j
 =
B_SLICE
 && 
cuºSli˚
->
«l_ª„ªn˚_idc
)

299 
p_Vid
->
œmbda_md
[
j
][
qp
] = 
p_I≈
->
LambdaWeight
[5] * 
	`pow
 (2, 
qp_ãmp
/3.0);

301 
p_Vid
->
œmbda_md
[
j
][
qp
] = 
p_I≈
->
LambdaWeight
[j] * 
	`pow
 (2, 
qp_ãmp
/3.0);

303 #i‡(
MVC_EXTENSION_ENABLE
)

304 
tmp_œmbda_md
 = 
p_Vid
->
œmbda_md
[
j
][
qp
];

306 i‡(
cuºSli˚
->
võw_id
)

308 
p_Vid
->
œmbda_md
[
j
][
qp
] =Ö_Vid->œmbda_md[j][qp] * 
p_I≈
->
íh_œyî_me_œmbda_mu…ùlõr
;

313 if(
bLimôsLambdaMD
)

314 
	`ClùLambda
(&
dMaxLambdaMD
, &
p_Vid
->
œmbda_md
[
j
][
qp
]);

316 
	`SëLambda
(
p_Vid
, 
j
, 
qp
, ((
p_I≈
->
MEEº‹Mëric
[
H_PEL
] =
ERROR_SATD
 &&Ö_I≈->MEEº‹Mëric[
Q_PEL
] == ERROR_SATD) ? 1.00 : 0.95));

318 #i‡(
MVC_EXTENSION_ENABLE
)

319 i‡(
cuºSli˚
->
võw_id
)

321 
p_Vid
->
œmbda_md
[
j
][
qp
] = 
tmp_œmbda_md
 * 
p_I≈
->
íh_œyî_œmbda_mu…ùlõr
;

323 if(
bLimôsLambdaMD
)

324 
	`ClùLambda
(&
dMaxLambdaMD
, &
p_Vid
->
œmbda_md
[
j
][
qp
]);

325 
p_Vid
->
œmbda_md
[
j
][
qp
] *((
p_I≈
->
MEEº‹Mëric
[
H_PEL
] =
ERROR_SATD
 &&Ö_I≈->MEEº‹Mëric[
Q_PEL
] == ERROR_SATD) ? 1.00 : 0.95);

330 i‡(
j
 !
B_SLICE
)

332 
qp
 = -
cuºSli˚
->
bôdïth_luma_qp_sˇÀ
; qp < 52; qp++)

333 
p_Vid
->
œmbda_md
[
j
][
qp
] *
œmbda_sˇÀ
;

335 
	}
}

338 
	$gë_fixed_œmbda
(
Sli˚
 *
cuºSli˚
)

340 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

341 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºSli˚
->p_Inp;

342 
qp
;

344 
bLimôsLambdaMD
 = ((
p_I≈
->
E«bÀIPCM
 > 0Ë&& (
IMGTYPE
==0));

345 
dMaxLambdaMD
 =0;

347 
j
 = 
cuºSli˚
->
¶i˚_ty≥
;

349 if(
bLimôsLambdaMD
)

350 
	`CÆcMaxLamdaMD
(
p_Vid
, &
dMaxLambdaMD
);

352 
qp
 = -
cuºSli˚
->
bôdïth_luma_qp_sˇÀ
; qp < 52; qp++)

354 i‡(
j
 =
B_SLICE
 && 
cuºSli˚
->
«l_ª„ªn˚_idc
)

355 
p_Vid
->
œmbda_md
[
j
][
qp
] = 
p_I≈
->
FixedLambda
[5];

357 
p_Vid
->
œmbda_md
[
j
][
qp
] = 
p_I≈
->
FixedLambda
[j];

359 if(
bLimôsLambdaMD
)

360 
	`ClùLambda
(&
dMaxLambdaMD
, &
p_Vid
->
œmbda_md
[
j
][
qp
]);

362 
	`SëLambda
(
p_Vid
, 
j
, 
qp
, ((
p_I≈
->
MEEº‹Mëric
[
H_PEL
] =
ERROR_SATD
 &&Ö_I≈->MEEº‹Mëric[
Q_PEL
] == ERROR_SATD) ? 1.00 : 0.95));

364 
	}
}

	@lencod/src/leaky_bucket.c

15 
	~"c⁄åibut‹s.h
"

16 
	~"globÆ.h
"

18 #ifde‡
_LEAKYBUCKET_


42 
	$gë_LókyBuckëR©e
(
I≈utP¨amëîs
 *
p_I≈
, 
NumbîLókyBuckës
, *
Rmö
)

44 
FILE
 *
f
;

45 
i
, 
buf
;

47 if((
f
 = 
	`f›í
(
p_I≈
->
LókyBuckëR©eFûe
, "r")Ë=
NULL
)

49 
	`¥ötf
(" LeakyBucketRate File doesÇotÉxist. UsingÑate calculated fromávg.Ñate \n");

53 
i
=0; i<
NumbîLókyBuckës
; i++)

55 if(1 !
	`fsˇnf
(
f
, "%lu", &
buf
))

57 
	`¥ötf
(" Leaky BucketRateFile doesÇot have validÉntries.\n UsingÑate calculated fromávg.Ñate \n");

58 
	`f˛o£
 (
f
);

61 
Rmö
[
i
] = 
buf
;

63 
	`f˛o£
 (
f
);

65 
	}
}

85 
	$PutBigDoubÀW‹d
(
dw
, 
FILE
 *
Â
)

87 
	`Âutc
((
dw
 >> 0x18Ë& 0xFF, 
Â
);

88 
	`Âutc
((
dw
 >> 0x10Ë& 0xFF, 
Â
);

89 
	`Âutc
((
dw
 >> 0x08Ë& 0xFF, 
Â
);

90 
	`Âutc
(
dw
 & 0xFF, 
Â
);

91 
	}
}

119 
	$wrôe_buf„r
(
I≈utP¨amëîs
 *
p_I≈
, 
NumbîLókyBuckës
, 
Rmö
[], 
Bmö
[], 
Fmö
[])

121 
FILE
 *
outf
;

122 
iBuckë
;

124 i‡((
outf
 = 
	`f›í
(
p_I≈
->
LókyBuckëP¨amFûe
,"wb"))==
NULL
)

126 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Eº‹ o≥¿fûêlk %† \n",
p_I≈
->
LókyBuckëP¨amFûe
);

127 
	`îr‹
(
îr‹ãxt
,1);

130 
	`PutBigDoubÀW‹d
(
NumbîLókyBuckës
, 
outf
);

131 i‡(
p_I≈
->
Vîbo£
 != 0)

132 
	`¥ötf
(" Numbî Lóky Buckës: %ld \¿ Rmö Bmö Fmö \n", 
NumbîLókyBuckës
);

133 
iBuckë
 =0; iBuckë < 
NumbîLókyBuckës
; iBucket++)

138 
	`PutBigDoubÀW‹d
(
Rmö
[
iBuckë
], 
outf
);

139 
	`PutBigDoubÀW‹d
(
Bmö
[
iBuckë
], 
outf
);

140 
	`PutBigDoubÀW‹d
(
Fmö
[
iBuckë
], 
outf
);

141 i‡(
p_I≈
->
Vîbo£
 != 0)

142 
	`¥ötf
(" %8ld %8ld %8ld \n", 
Rmö
[
iBuckë
], 
Bmö
[iBuckë], 
Fmö
[iBucket]);

144 
	`f˛o£
(
outf
);

145 
	}
}

165 
	$S‹t
(
NumbîLókyBuckës
, *
Rmö
)

167 
i
, 
j
;

168 
ãmp
;

169 
i
=0; i< 
NumbîLókyBuckës
-1; i++)

171 
j
=
i
+1; j<
NumbîLókyBuckës
; j++)

173 if(
Rmö
[
i
] > Rmö[
j
])

175 
ãmp
 = 
Rmö
[
i
];

176 
Rmö
[
i
] = Rmö[
j
];

177 
Rmö
[
j
] = 
ãmp
;

181 
	}
}

198 
	$ˇlc_buf„r
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

200 
AvgR©e
, 
TŸÆR©e
, 
NumbîLókyBuckës
;

201 *
buf„r_‰ame
, 
möB
;

202 
iBuckë
, 
iFøme
, 
FømeIndex
 = 0;

203 
maxBuf„r
, 
a˘uÆBuf„r
, 
InôFuŒ√ss
, 
iCh™√lR©e
;

204 *
Rmö
, *
Bmö
, *
Fmö
;

206 
p_I≈
->
Vîbo£
)

209 
	`Ârötf
(
°dout
,"-------------------------------------------------------------------------------\n");

212 
	`Ârötf
(
°dout
,"------------------------------------------------------------------------------------------------\n");

215 
	`Ârötf
(
°dout
,"-------------------------------------------------------------------------------------------------------\n");

219 
	`Ârötf
(
°dout
,"\n-------------------------------------------------------------------------------\n");

222 
	`¥ötf
(" TŸÆ Fømes: %ld \n", 
p_Vid
->
tŸÆ_‰ame_buf„r
);

223 
NumbîLókyBuckës
 = (Ë
p_I≈
->NumberLeakyBuckets;

224 
buf„r_‰ame
 = 
	`ˇŒoc
(
p_Vid
->
tŸÆ_‰ame_buf„r
 + 1, ());

225 if(!
buf„r_‰ame
)

226 
	`no_mem_exô
("init_buffer: buffer_frame");

227 
Rmö
 = 
	`ˇŒoc
(
NumbîLókyBuckës
, ());

228 if(!
Rmö
)

229 
	`no_mem_exô
("init_buffer: Rmin");

230 
Bmö
 = 
	`ˇŒoc
(
NumbîLókyBuckës
, ());

231 if(!
Bmö
)

232 
	`no_mem_exô
("init_buffer: Bmin");

233 
Fmö
 = 
	`ˇŒoc
(
NumbîLókyBuckës
, ());

234 if(!
Fmö
)

235 
	`no_mem_exô
("init_buffer: Fmin");

237 
TŸÆR©e
 = 0;

238 
iFøme
=0; iFømê< 
p_Vid
->
tŸÆ_‰ame_buf„r
; iFrame++)

240 
TŸÆR©e
 +(Ë
p_Vid
->
Bô_Buf„r
[
iFøme
];

242 
AvgR©e
 = (Ë((Ë
TŸÆR©e
/ 
p_Vid
->
tŸÆ_‰ame_buf„r
);

244 if(1 !
	`gë_LókyBuckëR©e
(
p_I≈
, 
NumbîLókyBuckës
, 
Rmö
))

246 
iBuckë
=0; iBuckë < 
NumbîLókyBuckës
; iBucket++)

248 if(
iBuckë
 == 0)

249 
Rmö
[
iBuckë
] = ()((Ë
AvgR©e
 * 
p_Vid
->
‰amî©e
);

251 
Rmö
[
iBuckë
] = (Ë((ËRmö[iBuckë-1] + (
AvgR©e
/4Ë* (
p_Vid
->
‰amî©e
));

254 
	`S‹t
(
NumbîLókyBuckës
, 
Rmö
);

256 
maxBuf„r
 = 
AvgR©e
 * 20;

257 
iBuckë
=0; iBuckë< 
NumbîLókyBuckës
; iBucket++)

259 
iCh™√lR©e
 = (Ë(
Rmö
[
iBuckë
] / (
p_Vid
->
‰amî©e
));

261 
InôFuŒ√ss
 = 
maxBuf„r
;

262 
buf„r_‰ame
[0] = 
InôFuŒ√ss
;

263 
möB
 = 
maxBuf„r
;

265 
iFøme
=0; iFømê< 
p_Vid
->
tŸÆ_‰ame_buf„r
 ; iFrame++)

267 
buf„r_‰ame
[
iFøme
] = buf„r_‰ame[iFøme] - 
p_Vid
->
Bô_Buf„r
[iFrame];

268 if(
buf„r_‰ame
[
iFøme
] < 
möB
)

270 
möB
 = 
buf„r_‰ame
[
iFøme
];

271 
FømeIndex
 = 
iFøme
;

274 i‡–
iFøme
 < 
p_Vid
->
tŸÆ_‰ame_buf„r
 )

276 
buf„r_‰ame
[
iFøme
+1] = buf„r_‰ame[iFøme] + 
iCh™√lR©e
;

277 if(
buf„r_‰ame
[
iFøme
+1] > 
maxBuf„r
)

278 
buf„r_‰ame
[
iFøme
+1] = 
maxBuf„r
;

281 
a˘uÆBuf„r
 = (
maxBuf„r
 - 
möB
);

284 
InôFuŒ√ss
 = 
p_Vid
->
Bô_Buf„r
[0];

285 
buf„r_‰ame
[0] = 
InôFuŒ√ss
;

286 
iFøme
=0; iFømê< 
FømeIndex
+1; iFrame++)

288 
buf„r_‰ame
[
iFøme
] = buf„r_‰ame[iFøme] - 
p_Vid
->
Bô_Buf„r
[iFrame];

289 if(
buf„r_‰ame
[
iFøme
] < 0)

291 
InôFuŒ√ss
 -
buf„r_‰ame
[
iFøme
];

292 
buf„r_‰ame
[
iFøme
] = 0;

294 i‡–
iFøme
 < 
p_Vid
->
tŸÆ_‰ame_buf„r
 )

296 
buf„r_‰ame
[
iFøme
+1] = buf„r_‰ame[iFøme] + 
iCh™√lR©e
;

297 if(
buf„r_‰ame
[
iFøme
+1] > 
a˘uÆBuf„r
)

301 
Bmö
[
iBuckë
] = (Ë
a˘uÆBuf„r
;

302 
Fmö
[
iBuckë
] = (Ë
InôFuŒ√ss
;

305 
	`wrôe_buf„r
(
p_I≈
, 
NumbîLókyBuckës
, 
Rmö
, 
Bmö
, 
Fmö
);

307 
	`‰ì_poöãr
(
buf„r_‰ame
);

308 
	`‰ì_poöãr
(
Rmö
);

309 
	`‰ì_poöãr
(
Bmö
);

310 
	`‰ì_poöãr
(
Fmö
);

312 
	}
}

	@lencod/src/lencod.c

46 
	~"c⁄åibut‹s.h
"

48 
	~<time.h
>

49 
	~<m©h.h
>

51 
	~"wö32.h
"

52 
	~"globÆ.h
"

53 
	~"cc⁄v_yuv2rgb.h
"

54 
	~"c⁄figfûe.h
"

55 
	~"c⁄f‹m™˚.h
"

56 
	~"c⁄ãxt_öi.h
"

57 
	~"ex∂icô_g›.h
"

58 
	~"ex∂icô_£q.h
"

59 
	~"fûeh™dÀ.h
"

60 
	~"image.h
"

61 
	~"öput.h
"

62 
	~"img_io.h
"

63 
	~"¶i˚.h
"

64 
	~"öå¨e‰esh.h
"

65 
	~"Àaky_buckë.h
"

66 
	~"mc_¥edi˘i⁄.h
"

67 
	~"mc_¥edi˘i⁄_Ÿf.h
"

68 
	~"memÆloc.h
"

69 
	~"me_ïzs_comm⁄.h
"

70 
	~"me_ïzs_öt.h
"

71 
	~"me_umhex.h
"

72 
	~"me_umhexsmp.h
"

73 
	~"ouçut.h
"

74 
	~"∑r£t.h
"

75 
	~"q_m©rix.h
"

76 
	~"q_off£ts.h
"

77 
	~"øã˘l.h
"

78 
	~"ªp‹t.h
"

79 
	~"rdoq.h
"

80 
	~"îrdo.h
"

81 
	~"rd›t.h
"

82 
	~"wp_m˝ªc.h
"

83 
	~"mv_£¨ch.h
"

84 
	~"img_¥o˚ss.h
"

85 
	~"q_off£ts.h
"

86 
	~"¥ed_°ru˘.h
"

87 
	~"blk_¥edi˘i⁄.h
"

88 
	~"img_luma.h
"

89 
	~"img_chroma.h
"

90 
	~"mc_¥edi˘i⁄.h
"

91 
	~"me_di°‹ti⁄.h
"

92 
	~"me_di°‹ti⁄_Ÿf.h
"

93 
	~"md_di°‹ti⁄.h
"

94 
	~"mode_decisi⁄.h
"

95 
	~"å™sf‹m8x8.h
"

96 
	~"öåa16x16.h
"

97 
	~"öåa4x4.h
"

98 
	~"öåa8x8.h
"

100 
	~"md_comm⁄.h
"

101 
	~"ma¸oblock.h
"

102 
	~"gë_block_Ÿf.h
"

104 
	~"wp.h
"

107 #i‡!
IMGTYPE


108 #i‡
JCOST_CALC_SCALEUP
 && (
LAMBDA_ACCURACY_BITS
>8)

112 c⁄° 
	gmb_width_¸
[4] = {0, 8, 8,16};

113 c⁄° 
	gmb_height_¸
[4]= {0, 8,16,16};

115 
EncodîP¨ams
 *
	gp_Enc
 = 
NULL
;

117 
£t_Àvñ_ödi˚s
 (
VideoP¨amëîs
 *
p_Vid
);

118 
chroma_mc_£tup
 (
VideoP¨amëîs
 *
p_Vid
);

119 
öô_img
 (
VideoP¨amëîs
 *
p_Vid
);

120 
öô_ícodî
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
);

121 
öô_globÆ_buf„rs
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
);

122 
‰ì_globÆ_buf„rs
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
);

123 
‰ì_img
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
);

124 
‰ì_∑øms
 (
I≈utP¨amëîs
 *
p_I≈
);

126 
ícode_£quí˚
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
);

129 
gíî©e_ícode_∑ømëîs
(
VideoP¨amëîs
 *
p_Vid
);

130 
‰ì_ícode_∑ømëîs
(
VideoP¨amëîs
 *
p_Vid
);

133 
	$öô_°©s
 (
I≈utP¨amëîs
 *
p_I≈
, 
SètP¨amëîs
 *
p_Sèts
)

135 
	`mem£t
(
p_Sèts
, 0, (
SètP¨amëîs
));

136 
p_Sèts
->
NumbîBFømes
 = 
p_I≈
->NumberBFrames;

137 
	}
}

139 
	$öô_d°©s
 (
Di°‹ti⁄P¨ams
 *
p_Di°
)

141 
p_Di°
->
‰ame_˘r
 = 0;

142 
	`mem£t
(
p_Di°
->
mëric
, 0, 
TOTAL_DIST_TYPES
 * (
Di°Mëric
));

143 
	}
}

153 
	$Æloc_video_∑øms
–
VideoP¨amëîs
 **
p_Vid
)

155 i‡((*
p_Vid
 = (
VideoP¨amëîs
 *Ë
	`ˇŒoc
(1, (VideoP¨amëîs)))==
NULL
)

156 
	`no_mem_exô
("alloc_video_params:Ö_Vid");

157 i‡((((*
p_Vid
)->
p_Di°
Ë(
Di°‹ti⁄P¨ams
 *Ë
	`ˇŒoc
(1, (Di°‹ti⁄P¨ams)))==
NULL
)

158 
	`no_mem_exô
("alloc_video_params:Ö_Dist");

159 i‡((((*
p_Vid
)->
p_Sèts
Ë(
SètP¨amëîs
 *Ë
	`ˇŒoc
(1, (SètP¨amëîs)))==
NULL
)

160 
	`no_mem_exô
("alloc_video_params:Ö_Stats");

161 i‡(((*
p_Vid
)->
p_Dpb_œyî
[0] = (
DecodedPi˘uªBuf„r
 *Ë
	`ˇŒoc
(
MAX_NUM_DPB_LAYERS
, (DecodedPi˘uªBuf„r)))==
NULL
)

162 
	`no_mem_exô
("alloc_video_params:Ö_Dpb_layer");

164 
i
;

165 
i
=1; i<
MAX_NUM_DPB_LAYERS
; i++)

167 (*
p_Vid
)->
p_Dpb_œyî
[
i
] = (*p_Vid)->p_Dpb_layer[i-1] + 1;

168 (*
p_Vid
)->
p_Dpb_œyî
[
i
]->
œyî_id
 = i;

171 i‡((((*
p_Vid
)->
p_Qu™t
Ë(
Qu™tP¨amëîs
 *Ë
	`ˇŒoc
(1, (Qu™tP¨amëîs)))==
NULL
)

172 
	`no_mem_exô
("alloc_video_params:Ö_Quant");

173 i‡((((*
p_Vid
)->
p_QSˇÀ
Ë(
SˇÀP¨amëîs
 *Ë
	`ˇŒoc
(1, (SˇÀP¨amëîs)))==
NULL
)

174 
	`no_mem_exô
("alloc_video_params:Ö_QScale");

175 i‡((((*
p_Vid
)->
p_SEI
Ë(
SEIP¨amëîs
 *Ë
	`ˇŒoc
(1, (SEIP¨amëîs)))==
NULL
)

176 
	`no_mem_exô
("alloc_video_params:Ö_SEI");

179 (*
p_Vid
)->
p_dec
 = -1;

180 #i‡(
MVC_EXTENSION_ENABLE
)

181 (*
p_Vid
)->
p_dec2
 = -1;

183 (*
p_Vid
)->
p_log
 = 
NULL
;

184 (*
p_Vid
)->
f_™√xb
 = 
NULL
;

186 (*
p_Vid
)->
f_πp
 = 
NULL
;

187 (*
p_Vid
)->
CuºítRTPTime°amp
 = 0;

188 (*
p_Vid
)->
CuºítRTPSequí˚Numbî
 = 0;

189 
	}
}

199 
	$Æloc_∑øms
–
I≈utP¨amëîs
 **
p_I≈
 )

201 i‡((*
p_I≈
 = (
I≈utP¨amëîs
 *Ë
	`ˇŒoc
(1, (I≈utP¨amëîs)))==
NULL
)

202 
	`no_mem_exô
("alloc_params:Ö_Inp");

204 (*
p_I≈
)->
t›_À·
 = 
NULL
;

205 (*
p_I≈
)->
bŸtom_right
 = 
NULL
;

206 (*
p_I≈
)->
¶i˚_group_id
 = 
NULL
;

207 (*
p_I≈
)->
run_Àngth_möus1
 = 
NULL
;

208 
	}
}

219 
	$Æloc_ícodî
–
EncodîP¨ams
 **
p_Enc
)

221 i‡((*
p_Enc
 = (
EncodîP¨ams
 *Ë
	`ˇŒoc
(1, (EncodîP¨ams)))==
NULL
)

222 
	`no_mem_exô
("alloc_encoder:Ö_Enc");

224 
	`Æloc_video_∑øms
(&((*
p_Enc
)->
p_Vid
));

225 
	`Æloc_∑øms
(&((*
p_Enc
)->
p_I≈
));

226 (*
p_Enc
)->
p_åa˚
 = 
NULL
;

227 (*
p_Enc
)->
buf„rSize
 = 0;

228 
	}
}

236 
	$‰ì_ícodî
 (
EncodîP¨ams
 *
p_Enc
)

238 
	`‰ì_poöãr
–
p_Enc
 );

239 
	}
}

253 
	$maö
(
¨gc
, **
¨gv
)

255 
	`öô_time
();

256 #i‡
MEMORY_DEBUG


257 
	`_CπSëDbgFœg
 ( 
_CRTDBG_ALLOC_MEM_DF
 | 
_CRTDBG_LEAK_CHECK_DF
 );

260 
	`Æloc_ícodî
(&
p_Enc
);

262 
	`C⁄figuª
 (
p_Enc
->
p_Vid
,Ö_Enc->
p_I≈
, 
¨gc
, 
¨gv
);

265 
	`öô_ícodî
(
p_Enc
->
p_Vid
,Ö_Enc->
p_I≈
);

268 
	`ícode_£quí˚
(
p_Enc
->
p_Vid
,Ö_Enc->
p_I≈
);

271 
	`‰ì_ícodî_mem‹y
(
p_Enc
->
p_Vid
,Ö_Enc->
p_I≈
);

273 
	`‰ì_∑øms
 (
p_Enc
->
p_I≈
);

274 
	`‰ì_ícodî
(
p_Enc
);

277 
	}
}

286 
	$CeûLog2
–
uiVÆ
)

288 
uiTmp
 = 
uiVÆ
-1;

289 
uiRë
 = 0;

291  
uiTmp
 != 0 )

293 
uiTmp
 >>= 1;

294 
uiRë
++;

296  
uiRë
;

297 
	}
}

299 
	$£t_dpb_œyî_id
(
VideoP¨amëîs
 *
p_Vid
, 
idx
)

301 
	`as£π
(
idx
>=0 && idx<2);

302 
p_Vid
->
dpb_œyî_id
 = 
idx
;

303 
	}
}

305 
	$£tup_dpb_œyî
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

308  
p_I≈
->
OnTheFlyFø˘MCP
 )

310 
OTF_L1
:

311 
p_Dpb
->
pf_compuãSAD
 = 
compuãSAD_Ÿf
;

312 
p_Dpb
->
pf_compuãSADWP
 = 
compuãSADWP_Ÿf
;

313 
p_Dpb
->
pf_compuãSATD
 = 
compuãSATD_Ÿf
;

314 
p_Dpb
->
pf_compuãSATDWP
 = 
compuãSATDWP_Ÿf
;

315 
p_Dpb
->
pf_compuãBiPªdSAD1
 = 
compuãBiPªdSAD1_Ÿf
;

316 
p_Dpb
->
pf_compuãBiPªdSAD2
 = 
compuãBiPªdSAD2_Ÿf
;

317 
p_Dpb
->
pf_compuãBiPªdSATD1
 = 
compuãBiPªdSATD1_Ÿf
;

318 
p_Dpb
->
pf_compuãBiPªdSATD2
 = 
compuãBiPªdSATD2_Ÿf
;

319 
p_Dpb
->
pf_compuãSSE
 = 
compuãSSE_Ÿf
;

320 
p_Dpb
->
pf_compuãSSEWP
 = 
compuãSSEWP_Ÿf
;

321 
p_Dpb
->
pf_compuãBiPªdSSE1
 = 
compuãBiPªdSSE1_Ÿf
;

322 
p_Dpb
->
pf_compuãBiPªdSSE2
 = 
compuãBiPªdSSE2_Ÿf
;

323 
p_Dpb
->
pf_luma_¥edi˘i⁄
 = 
luma_¥edi˘i⁄_Ÿf
 ;

324 
p_Dpb
->
pf_luma_¥edi˘i⁄_bi
 = 
luma_¥edi˘i⁄_bi_Ÿf
 ;

325 
p_Dpb
->
pf_chroma_¥edi˘i⁄
 = 
chroma_¥edi˘i⁄_Ÿf
 ;

326 
p_Dpb
->
pf_gë_block_luma
 = 
gë_block_luma_Ÿf_L1
 ;

327 
p_Dpb
->
pf_gë_block_chroma
[
OTF_ME
] = (
p_Vid
->
P444_joöed
Ë? ( 
gë_block_luma_Ÿf_L1
 ) : ( 
me_gë_block_chroma_Ÿf_L1
 ) ;

328 
p_Dpb
->
pf_gë_block_chroma
[
OTF_MC
] = (
p_Vid
->
P444_joöed
Ë? ( 
gë_block_luma_Ÿf_L1
 ) : ( 
mc_gë_block_chroma_Ÿf_L1
 ) ;

329 
p_Dpb
->
pf_O√Comp⁄ítChromaPªdi˘i⁄4x4_ªgíî©e
 = 
O√Comp⁄ítChromaPªdi˘i⁄4x4_ªgíî©e
;

330 
p_Dpb
->
pf_O√Comp⁄ítChromaPªdi˘i⁄4x4_ªåõve
 = 
O√Comp⁄ítChromaPªdi˘i⁄4x4_ªgíî©e
;

332 
OTF_L2
:

333 
p_Dpb
->
pf_compuãSAD
 = 
compuãSAD_Ÿf
;

334 
p_Dpb
->
pf_compuãSADWP
 = 
compuãSADWP_Ÿf
;

335 
p_Dpb
->
pf_compuãSATD
 = 
compuãSATD_Ÿf
;

336 
p_Dpb
->
pf_compuãSATDWP
 = 
compuãSATDWP_Ÿf
;

337 
p_Dpb
->
pf_compuãBiPªdSAD1
 = 
compuãBiPªdSAD1_Ÿf
;

338 
p_Dpb
->
pf_compuãBiPªdSAD2
 = 
compuãBiPªdSAD2_Ÿf
;

339 
p_Dpb
->
pf_compuãBiPªdSATD1
 = 
compuãBiPªdSATD1_Ÿf
;

340 
p_Dpb
->
pf_compuãBiPªdSATD2
 = 
compuãBiPªdSATD2_Ÿf
;

341 
p_Dpb
->
pf_compuãSSE
 = 
compuãSSE_Ÿf
;

342 
p_Dpb
->
pf_compuãSSEWP
 = 
compuãSSEWP_Ÿf
;

343 
p_Dpb
->
pf_compuãBiPªdSSE1
 = 
compuãBiPªdSSE1_Ÿf
;

344 
p_Dpb
->
pf_compuãBiPªdSSE2
 = 
compuãBiPªdSSE2_Ÿf
;

345 
p_Dpb
->
pf_luma_¥edi˘i⁄
 = 
luma_¥edi˘i⁄_Ÿf
 ;

346 
p_Dpb
->
pf_luma_¥edi˘i⁄_bi
 = 
luma_¥edi˘i⁄_bi_Ÿf
 ;

347 
p_Dpb
->
pf_chroma_¥edi˘i⁄
 = 
chroma_¥edi˘i⁄_Ÿf
 ;

348 
p_Dpb
->
pf_gë_block_luma
 = 
gë_block_luma_Ÿf_L2
 ;

349 
p_Dpb
->
pf_gë_block_chroma
[
OTF_ME
] =Ö_Dpb->pf_gë_block_chroma[
OTF_MC
] = (
p_Vid
->
P444_joöed
Ë? ( 
gë_block_luma_Ÿf_L2
 ) : ( 
gë_block_chroma_Ÿf_L2
 ) ;

350 
p_Dpb
->
pf_O√Comp⁄ítChromaPªdi˘i⁄4x4_ªgíî©e
 = 
O√Comp⁄ítChromaPªdi˘i⁄4x4_ªgíî©e
;

351 
p_Dpb
->
pf_O√Comp⁄ítChromaPªdi˘i⁄4x4_ªåõve
 = 
O√Comp⁄ítChromaPªdi˘i⁄4x4_ªgíî©e
;

354 
p_Dpb
->
pf_compuãSAD
 = 
compuãSAD
;

355 
p_Dpb
->
pf_compuãSADWP
 = 
compuãSADWP
;

356 
p_Dpb
->
pf_compuãSATD
 = 
compuãSATD
;

357 
p_Dpb
->
pf_compuãSATDWP
 = 
compuãSATDWP
;

358 
p_Dpb
->
pf_compuãBiPªdSAD1
 = 
compuãBiPªdSAD1
;

359 
p_Dpb
->
pf_compuãBiPªdSAD2
 = 
compuãBiPªdSAD2
;

360 
p_Dpb
->
pf_compuãBiPªdSATD1
 = 
compuãBiPªdSATD1
;

361 
p_Dpb
->
pf_compuãBiPªdSATD2
 = 
compuãBiPªdSATD2
;

362 
p_Dpb
->
pf_compuãSSE
 = 
compuãSSE
;

363 
p_Dpb
->
pf_compuãSSEWP
 = 
compuãSSEWP
;

364 
p_Dpb
->
pf_compuãBiPªdSSE1
 = 
compuãBiPªdSSE1
;

365 
p_Dpb
->
pf_compuãBiPªdSSE2
 = 
compuãBiPªdSSE2
;

366 
p_Dpb
->
pf_luma_¥edi˘i⁄
 = 
luma_¥edi˘i⁄
;

367 
p_Dpb
->
pf_luma_¥edi˘i⁄_bi
 = 
luma_¥edi˘i⁄_bi
;

368 
p_Dpb
->
pf_chroma_¥edi˘i⁄
 = 
chroma_¥edi˘i⁄
;

369 
p_Dpb
->
pf_O√Comp⁄ítChromaPªdi˘i⁄4x4_ªgíî©e
 = 
O√Comp⁄ítChromaPªdi˘i⁄4x4_ªgíî©e
;

370 
p_Dpb
->
pf_O√Comp⁄ítChromaPªdi˘i⁄4x4_ªåõve
 = 
O√Comp⁄ítChromaPªdi˘i⁄4x4_ªåõve
;

373 
	}
}

375 
	$£t_°‹age_f‹m©
(
VideoP¨amëîs
 *
p_Vid
, 
FømeF‹m©
 *
p_§c
, FømeF‹m© *
p_d°
)

377 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

378 *
p_d°
 = *
p_§c
;

379 
p_d°
->
width
[0] = (
p_I≈
->
ouçut
.width[0] + 
p_Vid
->
auto_¸›_right
);

380 
p_d°
->
height
[0] = (
p_I≈
->
ouçut
.height[0] + 
p_Vid
->
auto_¸›_bŸtom
);

381 
p_d°
->
width
[1] =Ö_d°->width[2] =Ö_d°->width[0] * 
mb_width_¸
 [p_d°->
yuv_f‹m©
] / 16;

382 
p_d°
->
height
[1]p_d°->height[2] =Ö_d°->height[0] * 
mb_height_¸
[p_d°->
yuv_f‹m©
] / 16;

383 
p_d°
->
size_cmp
[0] =Ö_d°->
width
[0] *Ö_d°->
height
[0];

384 
p_d°
->
size_cmp
[2] =Ö_d°->size_cmp[1] =Ö_d°->
width
[1] *Ö_d°->
height
[1];

385 
p_d°
->
size
 =Ö_d°->
size_cmp
[0] +Ö_dst->size_cmp[1] +Ö_dst->size_cmp[2];

386 
	}
}

394 
	$öô_ícodî
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

396 
i
;

397 
p_Vid
->
p_I≈
 =Ö_Inp;

398 
p_Vid
->
giRDO±_B8O∆yFœg
 = 
FALSE
;

399 
p_Vid
->
p_log
 = 
NULL
;

402 
p_Vid
->
num_of_œyîs
 = 
p_I≈
->
num_of_võws
;

404 
p_Vid
->
ˇbac_ícodög
 = 0;

405 
p_Vid
->
‰ame_°©i°ic_°¨t
 = 1;

407 i‡(
p_I≈
->
Log2MaxFNumMöus4
 == -1)

409 
p_Vid
->
log2_max_‰ame_num_möus4
 = 
	`iClù3
(0,12, (Ë(
	`CeûLog2
(
p_I≈
->
no_‰ames
) - 4));

412 
p_Vid
->
log2_max_‰ame_num_möus4
 = 
p_I≈
->
Log2MaxFNumMöus4
;

414 i‡(
p_Vid
->
log2_max_‰ame_num_möus4
 =0 && 
p_I≈
->
num_ªf_‰ames
 == 16)

416 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, " NumbîRe„ªn˚Fømes=%dánd Log2MaxFNumMöus4=%d mayÜódÅÿ™ invÆid vÆuêo‡‰ame_num.", 
p_I≈
->
num_ªf_‰ames
,Ö_I≈-> 
Log2MaxFNumMöus4
);

417 
	`îr‹
 (
îr‹ãxt
, 500);

421 i‡(
p_I≈
->
Log2MaxPOCLsbMöus4
 == - 1)

422 
p_Vid
->
log2_max_pic_‹dî_˙t_lsb_möus4
 = 
	`iClù3
(0,12, (Ë(
	`CeûLog2
–
	`imax
–
p_I≈
->
no_‰ames
, (p_I≈->
NumbîBFømes
 + 1) << 1 ) << 1 ) - 4));

424 
p_Vid
->
log2_max_pic_‹dî_˙t_lsb_möus4
 = 
p_I≈
->
Log2MaxPOCLsbMöus4
;

426 i‡(((1<<(
p_Vid
->
log2_max_pic_‹dî_˙t_lsb_möus4
 + 3)Ë< 
p_I≈
->
jumpd
 * 4Ë&&Ö_I≈->
Log2MaxPOCLsbMöus4
 != -1)

427 
	`îr‹
("log2_max_pic_order_cnt_lsb_minus4 mightÇot be sufficient forÉncoding. Increase value.",400);

429 i‡(
	`°æí
 (
p_I≈
->
Rec⁄Fûe
Ë> 0 && (
p_Vid
->
p_dec
 = 
	`›í
’_I≈->Rec⁄Fûe, 
OPENFLAGS_WRITE
, 
OPEN_PERMISSIONS
))==-1)

431 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Eº‹ o≥¿fûê%s", 
p_I≈
->
Rec⁄Fûe
);

432 
	`îr‹
 (
îr‹ãxt
, 500);

435 #i‡(
MVC_EXTENSION_ENABLE
)

436 if(
p_Vid
->
num_of_œyîs
 == 2)

438 i‡(
	`°æí
 (
p_I≈
->
Rec⁄Fûe2
Ë> 0 && (
p_Vid
->
p_dec2
 = 
	`›í
’_I≈->Rec⁄Fûe2, 
OPENFLAGS_WRITE
, 
OPEN_PERMISSIONS
))==-1)

440 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Eº‹ o≥¿fûê%s", 
p_I≈
->
Rec⁄Fûe2
);

441 
	`îr‹
 (
îr‹ãxt
, 500);

445 i‡((
p_I≈
->
ouçut
.
width
[0] & 0x0F) != 0)

447 
p_Vid
->
auto_¸›_right
 = 16 - (
p_I≈
->
ouçut
.
width
[0] & 0x0F);

451 
p_Vid
->
auto_¸›_right
 = 0;

454 i‡(
p_I≈
->
PicI¡îœ˚
 ||Ö_I≈->
MbI¡îœ˚
)

456 i‡((
p_I≈
->
ouçut
.
height
[0] & 0x01) != 0)

458 
	`îr‹
 ("evenÇumber ofÜinesÑequired for interlaced coding", 500);

461 i‡((
p_I≈
->
ouçut
.
height
[0] & 0x1F) != 0)

463 
p_Vid
->
auto_¸›_bŸtom
 = 32 - (
p_I≈
->
ouçut
.
height
[0] & 0x1F);

467 
p_Vid
->
auto_¸›_bŸtom
=0;

472 i‡((
p_I≈
->
ouçut
.
height
[0] & 0x0F) != 0)

474 
p_Vid
->
auto_¸›_bŸtom
 = 16 - (
p_I≈
->
ouçut
.
height
[0] & 0x0F);

478 
p_Vid
->
auto_¸›_bŸtom
 = 0;

481 i‡(
p_Vid
->
auto_¸›_bŸtom
 ||Ö_Vid->
auto_¸›_right
)

483 
	`Ârötf
 (
°dîr
, "Warning: Automatic croppingáctivated: Coded frame Size: %dx%d\n",

484 
p_I≈
->
ouçut
.
width
[0] + 
p_Vid
->
auto_¸›_right
,Ö_I≈->ouçut.
height
[0] +Ö_Vid->
auto_¸›_bŸtom
);

488 i‡–0 !
p_I≈
->
num_¶i˚_groups_möus1
 )

490 
	`ªad_¶i˚_group_öfo
(
p_Vid
, 
p_I≈
);

493 if(
p_I≈
->
num_¶i˚_groups_möus1
 > 0)

495 if–(
p_I≈
->
¶i˚_group_m≠_ty≥
 >= 3) && (p_Inp->slice_group_map_type<=5) )

496 
p_I≈
->
num_¶i˚_groups_möus1
 = 1;

499 if(
p_I≈
->
RCE«bÀ
)

501 i‡(
p_I≈
->
basicunô
 == 0)

502 
p_I≈
->
basicunô
 = (p_I≈->
ouçut
.
height
[0] + 
p_Vid
->
auto_¸›_bŸtom
)*’_I≈->ouçut.
width
[0] +Ö_Vid->
auto_¸›_right
)/256;

504 i‡–((
p_I≈
->
ouçut
.
height
[0] + 
p_Vid
->
auto_¸›_bŸtom
)*’_I≈->ouçut.
width
[0] +Ö_Vid->
auto_¸›_right
)/256Ë%Ö_I≈->
basicunô
 != 0)

506 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Frame size in macroblocks must beá multiple of BasicUnit.");

507 
	`îr‹
 (
îr‹ãxt
, 500);

511 
	`Àvñ_check
(
p_Vid
, 
p_I≈
);

514 
	`O≥nFûes
(&
p_I≈
->
öput_fûe1
);

515 #i‡(
MVC_EXTENSION_ENABLE
)

516 if(
p_Vid
->
num_of_œyîs
==2)

518 
	`O≥nFûes
(&
p_I≈
->
öput_fûe2
);

520 
p_Vid
->
¥ev_võw_is_™ch‹
 = 0;

521 
p_Vid
->
võw_id
 = 0;

522 
	`£t_dpb_œyî_id
(
p_Vid
,Ö_Vid->
võw_id
);

526 
p_Vid
->
ouçut_f‹m©
[0] = 
p_I≈
->
ouçut
;

527 
	`£t_°‹age_f‹m©
(
p_Vid
, &(
p_I≈
->
sour˚
), &’_Vid->
p_Dpb_œyî
[0]->
°‹age_f‹m©
));

528 if(
p_Vid
->
num_of_œyîs
 == 2)

531 
p_Vid
->
ouçut_f‹m©
[1] = 
p_I≈
->
ouçut
;

532 
	`£t_°‹age_f‹m©
(
p_Vid
, &(
p_I≈
->
sour˚
), &’_Vid->
p_Dpb_œyî
[1]->
°‹age_f‹m©
));

537 
	`öô_qm©rix
(
p_Vid
, 
p_I≈
);

538 
	`öô_qoff£t
(
p_Vid
);

540 
	`öô_poc
(
p_Vid
);

541 
	`gíî©e_∑ømëî_£ts
(
p_Vid
);

542 
	`gíî©e_ícode_∑ømëîs
(
p_Vid
);

543 
	`£t_Àvñ_ödi˚s
(
p_Vid
);

545 
	`öô_img
 (
p_Vid
);

547 i‡(
p_I≈
->
rd›t
 == 3)

549 
	`öô_îr‹_c⁄˚Æ
(
p_Vid
,
p_I≈
->
Eº‹C⁄˚Æmít
);

551 
	`öô_di°‹ti⁄_e°im©i⁄
(
p_Vid
,
p_I≈
->
de
);

554 #ifde‡
_LEAKYBUCKET_


555 
p_Vid
->
öôül_B‰ames
 = 0;

556 #i‡(
MVC_EXTENSION_ENABLE
)

557 if(
p_Vid
->
num_of_œyîs
 == 2)

558 
p_Vid
->
Bô_Buf„r
 = (*)
	`mÆloc
(((
p_I≈
->
no_‰ames
 << 1) + 1) * ());

560 
p_Vid
->
Bô_Buf„r
 = (*)
	`mÆloc
((
p_I≈
->
no_‰ames
 + 1) * ());

562 
p_Vid
->
Bô_Buf„r
 = (*)
	`mÆloc
((
p_I≈
->
no_‰ames
 + 1) * ());

564 
p_Vid
->
tŸÆ_‰ame_buf„r
 = 0;

569 i‡(
p_I≈
->
NumbîBFømes
 &&Ö_I≈->
HõørchiˇlCodög
 == 3)

571 
	`öô_g›_°ru˘uª
(
p_Vid
, 
p_I≈
);

572 
	`öãΩªt_g›_°ru˘uª
(
p_Vid
, 
p_I≈
);

576 
i
=0; i<
MAX_NUM_DPB_LAYERS
; i++)

578 
p_Vid
->
p_Dpb_œyî
[
i
]->
öô_d⁄e
 = 0;

580 
i
=0; i<
	`imö
(
p_Vid
->
num_of_œyîs
, 
MAX_NUM_DPB_LAYERS
); i++)

582 
	`öô_dpb
(
p_Vid
,Ö_Vid->
p_Dpb_œyî
[
i
]);

585 
	`öô_out_buf„r
(
p_Vid
);

586 
	`öô_°©s
 (
p_I≈
, 
p_Vid
->
p_Sèts
);

587 
	`öô_d°©s
(
p_Vid
->
p_Di°
);

589 #i‡(
MVC_EXTENSION_ENABLE
)

590 if(
p_Vid
->
num_of_œyîs
 == 2)

592 
p_Vid
->
p_Di°
->
‰ame_˘r_v
[0] = 0;

593 
p_Vid
->
p_Di°
->
‰ame_˘r_v
[1] = 0;

594 
	`mem£t
(
p_Vid
->
p_Di°
->
mëric_v
[0], 0, 
TOTAL_DIST_TYPES
 * (
Di°Mëric
));

595 
	`mem£t
(
p_Vid
->
p_Di°
->
mëric_v
[1], 0, 
TOTAL_DIST_TYPES
 * (
Di°Mëric
));

599 
p_Vid
->
íc_pi˘uª
 = 
NULL
;

601 
	`öô_globÆ_buf„rs
(
p_Vid
, 
p_I≈
);

603 i‡–
p_I≈
->
WPMCPªcisi⁄
 )

604 
	`wpxInôWPXPas£s
(
p_Vid
, 
p_I≈
);

606 
	`öô_mŸi⁄_£¨ch_moduÀ
 (
p_Vid
, 
p_I≈
);

607 
	`öf‹m©i⁄_öô
(
p_Vid
, 
p_I≈
,Ö_Vid->
p_Sèts
);

609 if(
p_I≈
->
Di°‹ti⁄YUVtoRGB
)

610 
	`öô_YUVtoRGB
(
p_Vid
, 
p_I≈
);

613 i‡(
p_I≈
->
RCE«bÀ
)

614 
	`rc_öô_£quí˚
(
p_Vid
, 
p_I≈
);

616 
p_Vid
->
œ°_vÆid_ª„ªn˚
 = 0;

617 
p_Vid
->
tŸ_time
 = 0;

618 
p_Vid
->
œ°_bô_˘r_n
 = 0;

620 
p_Vid
->
öôül_B‰ames
 = 
p_I≈
->
NumbîBFømes
;

622 
p_Vid
->
ty≥
 = 
I_SLICE
;

624 
p_Vid
->
p_Sèts
->
bô_˘r_fûÀr_d©a
 = 0;

625 
p_Vid
->
p_Sèts
->
bô_˘r_fûÀr_d©a_n
 = 0;

626 
p_Vid
->
p_Sèts
->
bô_˘r_∑ømëî£ts
 = 0;

628 #i‡(
MVC_EXTENSION_ENABLE
)

629 i‡–
p_Vid
->
num_of_œyîs
 == 2 )

631 
p_Vid
->
p_Sèts
->
bô_˘r_fûÀr_d©a_v
[0] = 0;

632 
p_Vid
->
p_Sèts
->
bô_˘r_fûÀr_d©a_v
[1] = 0;

633 
p_Vid
->
p_Sèts
->
bô_˘r_fûÀr_d©a_n_v
[0] = 0;

634 
p_Vid
->
p_Sèts
->
bô_˘r_fûÀr_d©a_n_v
[1] = 0;

635 
p_Vid
->
p_Sèts
->
bô_˘r_∑ømëî£ts_v
[0] = 0;

636 
p_Vid
->
p_Sèts
->
bô_˘r_∑ømëî£ts_v
[1] = 0;

640 
p_Vid
->
p_Sèts
->
bô_¶i˚
 = 
	`°¨t_£quí˚
’_Vid, 
p_I≈
);

642 i‡(
p_I≈
->
U£RDOQu™t
)

643 
	`¥eˇlcuœã_u«ry_exp_gﬁomb_Àvñ
(
p_Vid
);

645 i‡(
p_I≈
->
Ex∂icôSeqCodög
)

646 
	`O≥nEx∂icôSeqFûe
(
p_Vid
, 
p_I≈
);

648 
p_Vid
->
£¨chR™ge
.
mö_x
 = -
p_I≈
->
£¨ch_ønge
[0] << 2;

649 
p_Vid
->
£¨chR™ge
.
max_x
 = 
p_I≈
->
£¨ch_ønge
[0] << 2;

650 
p_Vid
->
£¨chR™ge
.
mö_y
 = -
p_I≈
->
£¨ch_ønge
[0] << 2;

651 
p_Vid
->
£¨chR™ge
.
max_y
 = 
p_I≈
->
£¨ch_ønge
[0] << 2;

653  
i
 = 0; i < 
p_Vid
->
num_of_œyîs
; i++ )

655 
	`£tup_dpb_œyî
(
p_Vid
->
p_Dpb_œyî
[
i
],Ö_Vid, 
p_I≈
);

657 
	}
}

659 
	$£tup_codög_œyî
(
VideoP¨amëîs
 *
p_Vid
)

662 
i
;

663 
dpb_œyî_id
 = 
p_Vid
->dpb_layer_id;

664 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

665 
DecodedPi˘uªBuf„r
 *
p_Dpb
 = 
p_Vid
->
p_Dpb_œyî
[
dpb_œyî_id
];

667 
p_Vid
->
a˘ive_•s
 =Ö_Vid->
•s
[
dpb_œyî_id
];

668 
p_Vid
->
p_CuºEncodeP¨
 =Ö_Vid->
p_EncodeP¨
[
dpb_œyî_id
];

670 i‡(
p_Vid
->
p_CuºEncodeP¨
->
œ°_ªf_idc
 == 1)

672 
p_Vid
->
p_CuºEncodeP¨
->
‰ame_num
++;

673 
p_Vid
->
p_CuºEncodeP¨
->
‰ame_num
 %p_Vid->
max_‰ame_num
;

675 
p_Vid
->
‰ame_num
 =Ö_Vid->
p_CuºEncodeP¨
->frame_num;

678 if(
p_Vid
->
num_of_œyîs
 >1)

681 
CodögP¨amëîs
 *
˝s
 = 
p_Vid
->
p_CuºEncodeP¨
;

683 
p_Vid
->
yuv_f‹m©
 = 
˝s
->yuv_format;

684 
p_Vid
->
P444_joöed
 = 
˝s
->P444_joined;

685 
p_Vid
->
bôdïth_luma
 = 
˝s
->bitdepth_luma;

686 
p_Vid
->
bôdïth_sˇÀ
[0] = 
˝s
->bitdepth_scale[0];

687 
p_Vid
->
bôdïth_œmbda_sˇÀ
 = 
˝s
->bitdepth_lambda_scale;

688 
p_Vid
->
bôdïth_luma_qp_sˇÀ
 = 
˝s
->bitdepth_luma_qp_scale;

689 
p_Vid
->
dc_¥ed_vÆue_comp
[0] = 
˝s
->dc_pred_value_comp[0];

691 
p_Vid
->
max_≥l_vÆue_comp
[0] = 
˝s
->max_pel_value_comp[0];

692 
p_Vid
->
max_img≥l_vÆue_comp_sq
[0] = 
˝s
->max_imgpel_value_comp_sq[0];

693 
p_Vid
->
mb_size
[0][0] =Ö_Vid->mb_size[0][1] = 
˝s
->mb_size[0][0];

695 i‡(
p_Vid
->
yuv_f‹m©
 !
YUV400
)

697 
p_Vid
->
chroma_qp_off£t
[0] =Ö_Vid->
a˘ive_µs
->
cb_qp_ödex_off£t
;

698 
p_Vid
->
chroma_qp_off£t
[1] =Ö_Vid->
a˘ive_µs
->
¸_qp_ödex_off£t
;

702 
p_Vid
->
chroma_qp_off£t
[0] = 0;

703 
p_Vid
->
chroma_qp_off£t
[1] = 0;

705 
p_Vid
->
bôdïth_chroma
 = 
˝s
->bitdepth_chroma;

706 
p_Vid
->
bôdïth_sˇÀ
[1] = 
˝s
->bitdepth_scale[1];

707 
p_Vid
->
dc_¥ed_vÆue_comp
[2] =Ö_Vid->dc_¥ed_vÆue_comp[1] = 
˝s
->dc_pred_value_comp[1];

708 
p_Vid
->
max_≥l_vÆue_comp
[2] =Ö_Vid->max_≥l_vÆue_comp[1] = 
˝s
->max_pel_value_comp[1];

709 
p_Vid
->
max_img≥l_vÆue_comp_sq
[1] = 
˝s
->max_imgpel_value_comp_sq[1];

710 
p_Vid
->
max_img≥l_vÆue_comp_sq
[2] = 
˝s
->max_imgpel_value_comp_sq[2];

711 
p_Vid
->
num_blk8x8_uv
 = 
˝s
->num_blk8x8_uv;

712 
p_Vid
->
num_cdc_c€ff
 = 
˝s
->num_cdc_coeff;

713 
p_Vid
->
mb_size
[1][0] =Ö_Vid->mb_size[2][0] =Ö_Vid->
mb_¸_size_x
 = 
˝s
->mb_cr_size_x;

714 
p_Vid
->
mb_size
[1][1] =Ö_Vid->mb_size[2][1] =Ö_Vid->
mb_¸_size_y
 = 
˝s
->mb_cr_size_y;

715 
p_Vid
->
bôdïth_chroma_qp_sˇÀ
 = 
˝s
->bitdepth_chroma_qp_scale;

716 
p_Vid
->
max_bôCou¡
 = 
˝s
->max_bitCount;

720 
p_Vid
->
∑d_size_uv_x
 = 
˝s
->pad_size_uv_x;

721 
p_Vid
->
∑d_size_uv_y
 = 
˝s
->pad_size_uv_y;

722 
p_Vid
->
chroma_mask_mv_y
 = 
˝s
->chroma_mask_mv_y;

723 
p_Vid
->
chroma_mask_mv_x
 = 
˝s
->chroma_mask_mv_x;

724 
p_Vid
->
chroma_shi·_y
 = 
˝s
->chroma_shift_y;

725 
p_Vid
->
chroma_shi·_x
 = 
˝s
->chroma_shift_x;

726 
p_Vid
->
shi·_¸_y
 = 
˝s
->shift_cr_y;

727 
p_Vid
->
shi·_¸_x
 = 
˝s
->shift_cr_x;

729 
p_Vid
->
∑dded_size_x
 = 
˝s
->padded_size_x;

730 
p_Vid
->
∑dded_size_x_m8x8
 = 
˝s
->padded_size_x_m8x8;

731 
p_Vid
->
∑dded_size_x_m4x4
 = 
˝s
->padded_size_x_m4x4;

732 
p_Vid
->
¸_∑dded_size_x
 = 
˝s
->cr_padded_size_x;

733 
p_Vid
->
¸_∑dded_size_x2
 = 
˝s
->cr_padded_size_x2;

734 
p_Vid
->
¸_∑dded_size_x4
 = 
˝s
->cr_padded_size_x4;

735 
p_Vid
->
¸_∑dded_size_x_m8
 = 
˝s
->cr_padded_size_x_m8;

738 
p_Vid
->
dc_¥ed_vÆue
 =Ö_Vid->
dc_¥ed_vÆue_comp
[0];

739 
p_Vid
->
max_img≥l_vÆue
 = (Ëp_Vid->
max_≥l_vÆue_comp
[0];

741 
p_Vid
->
œmbda
 =Ö_Vid->
œmbda_buf
[
dpb_œyî_id
];

742 
p_Vid
->
œmbda_md
 =Ö_Vid->
œmbda_md_buf
[
dpb_œyî_id
];

743 
p_Vid
->
œmbda_me
 =Ö_Vid->
œmbda_me_buf
[
dpb_œyî_id
];

744 
p_Vid
->
œmbda_mf
 =Ö_Vid->
œmbda_mf_buf
[
dpb_œyî_id
];

745 i‡–
p_I≈
->
U£RDOQu™t
 )

747 
p_Vid
->
œmbda_rdoq
 =Ö_Vid->
œmbda_rdoq_buf
[
dpb_œyî_id
];

749 i‡(
p_I≈
->
CtxAd±LagøngeMu…
 == 1)

751 
p_Vid
->
œmbda_mf_Á˘‹
 =Ö_Vid->
œmbda_mf_Á˘‹_buf
[
dpb_œyî_id
];

754 
	`£tup_mbs
(
p_Vid
->
mb_d©a
,Ö_Vid->
FømeSizeInMbs
, 
dpb_œyî_id
);

755 
p_Vid
->
nz_c€ff
 =Ö_Vid->
nz_c€ff_buf
[
dpb_œyî_id
];

758 if(
p_Vid
->
imgY_com_buf
[0])

760 
p_Vid
->
imgY_com
 =Ö_Vid->
imgY_com_buf
[
dpb_œyî_id
];

761 
p_Vid
->
imgUV_com
[0] =Ö_Vid->
imgUV_com_buf
[
dpb_œyî_id
][0];

762 
p_Vid
->
imgUV_com
[1] =Ö_Vid->
imgUV_com_buf
[
dpb_œyî_id
][1];

764 if(
p_Vid
->
imgY_tmp_buf
[0])

766 
p_Vid
->
imgY_tmp
 =Ö_Vid->
imgY_tmp_buf
[
dpb_œyî_id
];

767 
p_Vid
->
imgUV_tmp
[0] =Ö_Vid->
imgUV_tmp_buf
[
dpb_œyî_id
][0];

768 
p_Vid
->
imgUV_tmp
[1] =Ö_Vid->
imgUV_tmp_buf
[
dpb_œyî_id
][1];

770 i‡–
p_I≈
->
ChromaMCBuf„r
 )

771 
p_Vid
->
O√Comp⁄ítChromaPªdi˘i⁄4x4
 = 
p_Dpb
->
pf_O√Comp⁄ítChromaPªdi˘i⁄4x4_ªåõve
;

773 
p_Vid
->
O√Comp⁄ítChromaPªdi˘i⁄4x4
 = 
p_Dpb
->
pf_O√Comp⁄ítChromaPªdi˘i⁄4x4_ªgíî©e
;

775 
	`£À˘_di°‹ti⁄
(
p_Vid
, 
p_I≈
);

777 
i
=0; i<3; i++)

779 
p_I≈
->
MEEº‹Mëric
[
i
])

781 
ERROR_SAD
:

782 
p_Vid
->
compuãUniPªd
[
i
] = 
p_Dpb
->
pf_compuãSAD
;

783 
p_Vid
->
compuãUniPªd
[
i
 + 3] = 
p_Dpb
->
pf_compuãSADWP
;

784 
p_Vid
->
compuãBiPªd1
[
i
] = 
p_Dpb
->
pf_compuãBiPªdSAD1
;

785 
p_Vid
->
compuãBiPªd2
[
i
] = 
p_Dpb
->
pf_compuãBiPªdSAD2
;

787 
ERROR_SSE
:

788 
p_Vid
->
compuãUniPªd
[
i
] = 
p_Dpb
->
pf_compuãSSE
;

789 
p_Vid
->
compuãUniPªd
[
i
 + 3] = 
p_Dpb
->
pf_compuãSSEWP
;

790 
p_Vid
->
compuãBiPªd1
[
i
] = 
p_Dpb
->
pf_compuãBiPªdSSE1
;

791 
p_Vid
->
compuãBiPªd2
[
i
] = 
p_Dpb
->
pf_compuãBiPªdSSE2
;

793 
ERROR_SATD
 :

795 
p_Vid
->
compuãUniPªd
[
i
] = 
p_Dpb
->
pf_compuãSATD
;

796 
p_Vid
->
compuãUniPªd
[
i
 + 3] = 
p_Dpb
->
pf_compuãSATDWP
;

797 
p_Vid
->
compuãBiPªd1
[
i
] = 
p_Dpb
->
pf_compuãBiPªdSATD1
;

798 
p_Vid
->
compuãBiPªd2
[
i
] = 
p_Dpb
->
pf_compuãBiPªdSATD2
;

803 
	}
}

811 
	$¥ï¨e_‰ame_∑øms
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
cuº_‰ame_to_code
)

813 
SeqSåu˘uª
 *
p_£q_°ru˘
 = 
p_Vid
->
p_¥ed
;

814 
FømeUnôSåu˘
 *
p_cur_‰m
 = 
p_Vid
->
p_cuº_‰m_°ru˘
;

815 
i
;

817 
	`£tup_codög_œyî
(
p_Vid
);

819 i‡–
p_I≈
->
Ex∂icôSeqCodög
 )

821 
ExpFømeInfo
 *
öfo
 = &
p_Vid
->
expSeq
->öfo[
cuº_‰ame_to_code
 %Ö_Vid->expSeq->
no_‰ames
];

822 
	`RódEx∂icôSeqFûe
(
p_Vid
->
expSeq
,Ö_Vid->
expSFûe
, 
cuº_‰ame_to_code
);

824 
	`p›uœã_‰ame_ex∂icô
–
öfo
, 
p_I≈
, 
p_cur_‰m
, 
p_£q_°ru˘
->
max_num_¶i˚s
 );

828 
p_Vid
->
‰ame_no
 = 
p_cur_‰m
->frame_no;

829 
p_Vid
->
‰m_no_ö_fûe
 = (1 + 
p_I≈
->
‰ame_skù
Ë*Ö_Vid->
‰ame_no
;

830 i‡–
p_cur_‰m
->
ty≥
 =
SI_SLICE
 )

832 
	`£t_¶i˚_ty≥
–
p_Vid
, 
p_I≈
, 
SP_SLICE
 );

836 
	`£t_¶i˚_ty≥
–
p_Vid
, 
p_I≈
, 
p_cur_‰m
->
ty≥
 );

838 
p_Vid
->
«l_ª„ªn˚_idc
 = 
p_cur_‰m
->
«l_ªf_idc
;

839  
p_Vid
->
pic_‹dî_˙t_ty≥
 )

842 
	`gë_poc_ty≥_zîo
–
p_Vid
, 
p_I≈
, 
p_cur_‰m
 );

845 
	`gë_poc_ty≥_⁄e
–
p_Vid
, 
p_I≈
, 
p_cur_‰m
 );

849 
	`gë_poc_ty≥_zîo
–
p_Vid
, 
p_I≈
, 
p_cur_‰m
 );

853 i‡(
p_cur_‰m
->
idr_Êag
 == 1)

855 
i
 = 0; i < 
p_Vid
->
num_of_œyîs
; i++)

857 
p_Vid
->
p_EncodeP¨
[
i
]->
‰ame_num
 = 0;

859 
p_Vid
->
‰ame_num
 = 0;

863 i‡(
p_I≈
->
RCE«bÀ
 && 
p_Vid
->
ty≥
 =
I_SLICE
)

864 
	`rc_öô_g›_∑øms
(
p_Vid
, 
p_I≈
);

867 
p_Vid
->
œyî
 = (’_Vid->
cuº_‰m_idx
 -Ö_Vid->
œ°_idr_code_‹dî
Ë% (
p_I≈
->
NumFømesInELSubSeq
 + 1)) ? 0 : 1;

868 
	}
}

876 
	$ícode_£quí˚
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

878 
cuº_‰ame_to_code
;

879 
‰ames_to_code
;

880 
‰ame_num_bak
 = 0, 
‰ame_coded
;

881 
‰m_°ru˘_buf„r
;

882 
SeqSåu˘uª
 *
p_£q_°ru˘
 = 
p_Vid
->
p_¥ed
;

883 
FømeUnôSåu˘
 *
p_‰m
;

885 #i‡(
MVC_EXTENSION_ENABLE
)

886 
tmp_øã_c⁄åﬁ_íabÀ
 = 
p_I≈
->
RCE«bÀ
;

888 i‡–
p_I≈
->
num_of_võws
 == 2 )

890 
‰ames_to_code
 = 
p_I≈
->
no_‰ames
 << 1;

891 
p_‰m
 = 
p_£q_°ru˘
->
p_‰m_mvc
;

892 
‰m_°ru˘_buf„r
 = 
p_£q_°ru˘
->
num_‰ames_mvc
;

897 
‰ames_to_code
 = 
p_I≈
->
no_‰ames
;

898 
p_‰m
 = 
p_£q_°ru˘
->p_frm;

899 
‰m_°ru˘_buf„r
 = 
p_Vid
->frm_struct_buffer;

902 
cuº_‰ame_to_code
 = 0; cuº_‰ame_to_codê< 
‰ames_to_code
; curr_frame_to_code++)

904 #i‡(
MVC_EXTENSION_ENABLE
)

905 i‡–
p_I≈
->
num_of_võws
 == 2 )

907 i‡–(
cuº_‰ame_to_code
 & 1) == 0 )

910 i‡–(
cuº_‰ame_to_code
 >> 1Ë>
p_Vid
->
p_¥ed
->
p›_°¨t_‰ame
 )

912 
°¨t
 = 
p_£q_°ru˘
->
p›_°¨t_‰ame
, 
íd
;

914 
	`p›uœã_‰m_°ru˘
–
p_Vid
, 
p_I≈
, 
p_£q_°ru˘
,Ö_I≈->
FrmSåu˘Buf„rLígth
, 
‰ames_to_code
 >> 1 );

915 
íd
 = 
p_£q_°ru˘
->
p›_°¨t_‰ame
;

916 
	`p›uœã_‰m_°ru˘_mvc
–
p_Vid
, 
p_I≈
, 
p_£q_°ru˘
, 
°¨t
, 
íd
 );

920 
p_Vid
->
cuº_‰m_idx
 = 
cuº_‰ame_to_code
;

921 
p_Vid
->
p_cuº_‰m_°ru˘
 = 
p_‰m
 + (Ö_Vid->
cuº_‰m_idx
 % 
‰m_°ru˘_buf„r
 );

922 
p_Vid
->
numbî
 = 
cuº_‰ame_to_code
;

924 
p_Vid
->
võw_id
 =Ö_Vid->
p_cuº_‰m_°ru˘
->view_id;

925 
	`£t_dpb_œyî_id
(
p_Vid
,Ö_Vid->
võw_id
);

926 i‡–
p_Vid
->
võw_id
 == 1 )

928 
p_Vid
->
cuº_‰m_idx
 =Ö_Vid->
numbî
 = (
cuº_‰ame_to_code
 - 1) >> 1;

929 
p_Vid
->
p_cuº_‰m_°ru˘
->
qp
 =Ö_Vid->q∞
	`iClù3
–-p_Vid->
bôdïth_luma_qp_sˇÀ
, 
MAX_QP
,Ö_Vid->
AvîageFømeQP
 + 
p_I≈
->
Võw1QPOff£t
 );

933 
p_Vid
->
cuº_‰m_idx
 =Ö_Vid->
numbî
 = 
cuº_‰ame_to_code
 >> 1;

935 i‡–
p_Vid
->
võw_id
 =1 && 
tmp_øã_c⁄åﬁ_íabÀ
 )

937 
p_I≈
->
RCE«bÀ
 = 0;

941 
p_I≈
->
RCE«bÀ
 = 
tmp_øã_c⁄åﬁ_íabÀ
;

948 i‡–
cuº_‰ame_to_code
 >
p_Vid
->
p_¥ed
->
p›_°¨t_‰ame
 )

950 
	`p›uœã_‰m_°ru˘
–
p_Vid
, 
p_I≈
, 
p_£q_°ru˘
,Ö_I≈->
FrmSåu˘Buf„rLígth
, 
‰ames_to_code
 );

952 
p_Vid
->
cuº_‰m_idx
 = 
cuº_‰ame_to_code
;

953 
p_Vid
->
p_cuº_‰m_°ru˘
 = 
p_‰m
 + (Ö_Vid->
cuº_‰m_idx
 % 
‰m_°ru˘_buf„r
 );

954 
p_Vid
->
numbî
 = 
cuº_‰ame_to_code
;

958 i‡–
p_Vid
->
p_cuº_‰m_°ru˘
->
‰ame_no
 >
p_I≈
->
no_‰ames
 )

964 
‰ame_num_bak
 = 
p_Vid
->
p_EncodeP¨
[p_Vid->
dpb_œyî_id
]->
‰ame_num
;

966 
	`¥ï¨e_‰ame_∑øms
(
p_Vid
, 
p_I≈
, 
cuº_‰ame_to_code
);

969 i‡(
p_I≈
->
ªdund™t_pic_Êag
)

971 
	`öô_ªdund™t_‰ame
(
p_Vid
, 
p_I≈
);

972 
	`£t_ªdund™t_‰ame
(
p_Vid
, 
p_I≈
);

975 
‰ame_coded
 = 
	`ícode_⁄e_‰ame
(
p_Vid
, 
p_I≈
);

976 i‡–!
‰ame_coded
 )

978 
p_Vid
->
‰ame_num
 =Ö_Vid->
p_CuºEncodeP¨
->‰ame_num = 
‰ame_num_bak
;

982 
p_Vid
->
p_CuºEncodeP¨
->
œ°_ªf_idc
 =Ö_Vid->
«l_ª„ªn˚_idc
 ? 1 : 0;

985 i‡(
p_I≈
->
ªdund™t_pic_Êag
 && 
p_Vid
->
key_‰ame
)

987 
	`ícode_⁄e_ªdund™t_‰ame
(
p_Vid
, 
p_I≈
);

990 i‡(
p_I≈
->
E«bÀO≥nGOP
 && 
p_Vid
->
p_cuº_‰m_°ru˘
->
øndom_ac˚ss
)

992 i‡(
p_I≈
->
PicI¡îœ˚
)

994 i‡(
p_Vid
->
p_cuº_‰m_°ru˘
->
p_t›_Êd_pic
->
p_Sli˚
[0].
ty≥
 =
I_SLICE
 &&Ö_Vid->p_cuº_‰m_°ru˘->
øndom_ac˚ss
)

996 
p_Vid
->
œ°_vÆid_ª„ªn˚
 =Ö_Vid->
ThisPOC
 & (~( (signed )1 ));

1000 i‡(
p_Vid
->
ty≥
 =
I_SLICE
)

1002 
p_Vid
->
œ°_vÆid_ª„ªn˚
 =Ö_Vid->
ThisPOC
;

1007 i‡(
p_I≈
->
Rï‹tFømeSèts
)

1009 
	`ªp‹t_‰ame_°©i°ic
(
p_Vid
, 
p_I≈
);

1014 #i‡
EOS_OUTPUT


1015 
	`íd_of_°ªam
(
p_Vid
);

1018 #i‡(
MVC_EXTENSION_ENABLE
)

1019 if(
p_I≈
->
num_of_võws
 == 2)

1021 
p_I≈
->
RCE«bÀ
 = 
tmp_øã_c⁄åﬁ_íabÀ
;

1024 
	}
}

1034 
	$‰ì_ícodî_mem‹y
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

1036 
	`ãrmö©e_£quí˚
(
p_Vid
, 
p_I≈
);

1037 
	`Êush_dpb
(
p_Vid
->
p_Dpb_œyî
[0], &
p_I≈
->
ouçut
);

1038 
	`Êush_dpb
(
p_Vid
->
p_Dpb_œyî
[1], &
p_I≈
->
ouçut
);

1039 
	`Clo£Fûes
(&
p_I≈
->
öput_fûe1
);

1041 i‡(-1 !
p_Vid
->
p_dec
)

1042 
	`˛o£
(
p_Vid
->
p_dec
);

1044 #i‡(
MVC_EXTENSION_ENABLE
)

1045 if(
p_Vid
->
num_of_œyîs
==2)

1046 
	`Clo£Fûes
(&
p_I≈
->
öput_fûe2
);

1047 i‡(-1 !
p_Vid
->
p_dec2
)

1048 
	`˛o£
(
p_Vid
->
p_dec2
);

1051 i‡(
p_Enc
->
p_åa˚
)

1052 
	`f˛o£
(
p_Enc
->
p_åa˚
);

1054 
	`˛ór_mŸi⁄_£¨ch_moduÀ
 (
p_Vid
, 
p_I≈
);

1056 
	`R™domI¡øUnöô
(
p_Vid
);

1057 
	`FmoUnöô
(
p_Vid
);

1059 i‡(
p_I≈
->
NumbîBFømes
 &&Ö_I≈->
HõørchiˇlCodög
 == 3)

1061 
	`˛ór_g›_°ru˘uª
 (
p_Vid
);

1064 #ifde‡
_LEAKYBUCKET_


1065 
	`ˇlc_buf„r
(
p_Vid
, 
p_I≈
);

1069 
	`ªp‹t
(
p_Vid
, 
p_I≈
,Ö_Vid->
p_Sèts
);

1071 #ifde‡
_LEAKYBUCKET_


1072 
	`‰ì_poöãr
(
p_Vid
->
Bô_Buf„r
);

1074 
	`‰ì_dpb
(
p_Vid
->
p_Dpb_œyî
[0]);

1075 
	`‰ì_dpb
(
p_Vid
->
p_Dpb_œyî
[1]);

1076 
	`unöô_out_buf„r
(
p_Vid
);

1078 
	`‰ì_globÆ_buf„rs
(
p_Vid
, 
p_I≈
);

1080 
	`FªeP¨amëîSës
(
p_Vid
);

1082 i‡(
p_I≈
->
Ex∂icôSeqCodög
)

1083 
	`Clo£Ex∂icôSeqFûe
(
p_Vid
);

1086 
	`‰ì_img
 (
p_Vid
, 
p_I≈
);

1087 
	}
}

1099 
	$öô_img
–
VideoP¨amëîs
 *
p_Vid
)

1101 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

1102 
i
, 
j
;

1104 
p_Vid
->
numbî
 = -1;

1106 
p_Vid
->
œ°_idr_code_‹dî
 = 0;

1107 
p_Vid
->
œ°_idr_di•_‹dî
 = 0;

1108 
p_Vid
->
œ°_mmco_5_code_‹dî
 = -1;

1109 
p_Vid
->
œ°_mmco_5_di•_‹dî
 = -1;

1111 
p_Vid
->
yuv_f‹m©
 = 
p_I≈
->
ouçut
.yuv_format;

1112 
p_Vid
->
P444_joöed
 = (p_Vid->
yuv_f‹m©
 =
YUV444
 && (
p_I≈
->
£∑øã_cﬁour_∂™e_Êag
 == 0));

1115 
p_Vid
->
bôdïth_luma
 = (Ë
p_I≈
->
ouçut
.
bô_dïth
[0];

1116 
p_Vid
->
bôdïth_sˇÀ
[0] = 1 << (p_Vid->
bôdïth_luma
 - 8);

1117 
p_Vid
->
bôdïth_œmbda_sˇÀ
 = 2 * (p_Vid->
bôdïth_luma
 - 8);

1118 
p_Vid
->
bôdïth_luma_qp_sˇÀ
 = 3 *Ö_Vid->
bôdïth_œmbda_sˇÀ
;

1119 
p_Vid
->
dc_¥ed_vÆue_comp
[0] = (
img≥l
Ë(1<<’_Vid->
bôdïth_luma
 - 1));

1120 
p_Vid
->
max_≥l_vÆue_comp
[0] = (1<<p_Vid->
bôdïth_luma
) - 1;

1121 
p_Vid
->
max_img≥l_vÆue_comp_sq
[0] =Ö_Vid->
max_≥l_vÆue_comp
[0] *Ö_Vid->max_pel_value_comp[0];

1123 
p_Vid
->
dc_¥ed_vÆue
 =Ö_Vid->
dc_¥ed_vÆue_comp
[0];

1124 
p_Vid
->
max_img≥l_vÆue
 = (Ëp_Vid->
max_≥l_vÆue_comp
[0];

1125 
p_Vid
->
mb_size
[0][0] =Ö_Vid->mb_size[0][1] = 
MB_BLOCK_SIZE
;

1128 
p_Vid
->
RCMöQP
 = 
p_I≈
->RCMöQP[
P_SLICE
];

1129 
p_Vid
->
RCMaxQP
 = 
p_I≈
->RCMaxQP[
P_SLICE
];

1131 
p_Vid
->
WÆkAround
 = 0;

1132 
p_Vid
->
NumbîOfMBs
 = 0;

1136 i‡(
p_Vid
->
a˘ive_•s
->
¥ofûe_idc
 =
BASELINE
 ||Ö_Vid->a˘ive_•s->¥ofûe_id¯=
MAIN
 ||Ö_Vid->a˘ive_•s->¥ofûe_id¯=
EXTENDED
)

1137 
p_Vid
->
mö_IPCM_vÆue
 = 1;

1139 
p_Vid
->
mö_IPCM_vÆue
 = 0;

1141 i‡(
p_Vid
->
yuv_f‹m©
 !
YUV400
)

1143 
p_Vid
->
bôdïth_chroma
 = (Ë
p_I≈
->
ouçut
.
bô_dïth
[1];

1144 
p_Vid
->
bôdïth_sˇÀ
[1] = 1 << (p_Vid->
bôdïth_chroma
 - 8);

1145 
p_Vid
->
dc_¥ed_vÆue_comp
[1] = (
img≥l
Ë(1<<’_Vid->
bôdïth_chroma
 - 1));

1146 
p_Vid
->
dc_¥ed_vÆue_comp
[2] =Ö_Vid->dc_pred_value_comp[1];

1147 
p_Vid
->
max_≥l_vÆue_comp
[1] = (1<<p_Vid->
bôdïth_chroma
) - 1;

1148 
p_Vid
->
max_≥l_vÆue_comp
[2] =Ö_Vid->max_pel_value_comp[1];

1149 
p_Vid
->
max_img≥l_vÆue_comp_sq
[1] =Ö_Vid->
max_≥l_vÆue_comp
[1] *Ö_Vid->max_pel_value_comp[1];

1150 
p_Vid
->
max_img≥l_vÆue_comp_sq
[2] =Ö_Vid->
max_≥l_vÆue_comp
[2] *Ö_Vid->max_pel_value_comp[2];

1151 
p_Vid
->
num_blk8x8_uv
 = (1<<p_Vid->
yuv_f‹m©
)&(~(0x1));

1152 
p_Vid
->
num_cdc_c€ff
 =Ö_Vid->
num_blk8x8_uv
 << 1;

1154 
p_Vid
->
mb_size
[1][0] =Ö_Vid->mb_size[2][0] =Ö_Vid->
mb_¸_size_x
 = (p_Vid->
yuv_f‹m©
 =
YUV420
 ||Ö_Vid->yuv_f‹m© =
YUV422
) ? 8 : 16;

1155 
p_Vid
->
mb_size
[1][1] =Ö_Vid->mb_size[2][1] =Ö_Vid->
mb_¸_size_y
 = (p_Vid->
yuv_f‹m©
 =
YUV444
 ||Ö_Vid->yuv_f‹m© =
YUV422
) ? 16 : 8;

1157 
p_Vid
->
bôdïth_chroma_qp_sˇÀ
 = 6*’_Vid->
bôdïth_chroma
 - 8);

1159 
p_Vid
->
chroma_qp_off£t
[0] =Ö_Vid->
a˘ive_µs
->
cb_qp_ödex_off£t
;

1160 
p_Vid
->
chroma_qp_off£t
[1] =Ö_Vid->
a˘ive_µs
->
¸_qp_ödex_off£t
;

1164 
p_Vid
->
bôdïth_chroma
 = 0;

1165 
p_Vid
->
bôdïth_sˇÀ
[1] = 0;

1166 
p_Vid
->
max_≥l_vÆue_comp
[1] = 0;

1167 
p_Vid
->
max_≥l_vÆue_comp
[2] =Ö_Vid->max_pel_value_comp[1];

1168 
p_Vid
->
max_img≥l_vÆue_comp_sq
[1] =Ö_Vid->
max_≥l_vÆue_comp
[1] *Ö_Vid->max_pel_value_comp[1];

1169 
p_Vid
->
max_img≥l_vÆue_comp_sq
[2] =Ö_Vid->
max_≥l_vÆue_comp
[2] *Ö_Vid->max_pel_value_comp[2];

1170 
p_Vid
->
num_blk8x8_uv
 = 0;

1171 
p_Vid
->
num_cdc_c€ff
 = 0;

1172 
p_Vid
->
mb_size
[1][0] =Ö_Vid->mb_size[2][0] =Ö_Vid->
mb_¸_size_x
 = 0;

1173 
p_Vid
->
mb_size
[1][1] =Ö_Vid->mb_size[2][1] =Ö_Vid->
mb_¸_size_y
 = 0;

1175 
p_Vid
->
bôdïth_chroma_qp_sˇÀ
 = 0;

1177 
p_Vid
->
chroma_qp_off£t
[0] = 0;

1178 
p_Vid
->
chroma_qp_off£t
[1] = 0;

1181 
p_Vid
->
max_bôCou¡
 = 128 + 256 *Ö_Vid->
bôdïth_luma
 + 2 *Ö_Vid->
mb_¸_size_y
 *Ö_Vid->
mb_¸_size_x
 *Ö_Vid->
bôdïth_chroma
;

1184 
p_Vid
->
max_qp_dñè
 = (25 + (p_Vid->
bôdïth_luma_qp_sˇÀ
>>1));

1185 
p_Vid
->
mö_qp_dñè
 =Ö_Vid->
max_qp_dñè
 + 1;

1187 
p_Vid
->
num_ªf_‰ames
 =Ö_Vid->
a˘ive_•s
->num_ref_frames;

1188 
p_Vid
->
max_num_ª„ªn˚s
 =Ö_Vid->
a˘ive_•s
->
‰ame_mbs_⁄ly_Êag
 ?Ö_Vid->a˘ive_•s->
num_ªf_‰ames
 : 2 *Ö_Vid->active_sps->num_ref_frames;

1190 #i‡(
MVC_EXTENSION_ENABLE
)

1191 
p_Vid
->
£c_võw_f‹˚_Êd
 = 0;

1194 
p_Vid
->
ba£_di°
 = 
p_I≈
->
jumpd
 + 1;

1197 
p_Vid
->
œ°I¡øNumbî
 = 0;

1198 
p_Vid
->
œ°INTRA
 = 0;

1199 
p_Vid
->
œ°_ªf_idc
 = 0;

1200 
p_Vid
->
idr_ª‰esh
 = 0;

1202 
p_Vid
->
‰amî©e
 = (Ë
p_I≈
->
ouçut
.
‰ame_øã
;

1204 i‡(
p_I≈
->
Ad≠tiveRoundög
)

1206 i‡(
p_Vid
->
yuv_f‹m©
 != 0)

1208 
	`gë_mem4Döt
(&(
p_Vid
->
ARCofAdj4x4
), 3, 
MAXMODE
, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE);

1209 
	`gë_mem4Döt
(&(
p_Vid
->
ARCofAdj8x8
),Ö_Vid->
P444_joöed
 ? 3 : 1, 
MAXMODE
, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE);

1213 
	`gë_mem4Döt
(&(
p_Vid
->
ARCofAdj4x4
), 1, 
MAXMODE
, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE);

1214 
	`gë_mem4Döt
(&(
p_Vid
->
ARCofAdj8x8
), 1, 
MAXMODE
, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE);

1218 
p_Vid
->
width
 = (
p_I≈
->
ouçut
.width[0] +Ö_Vid->
auto_¸›_right
);

1219 
p_Vid
->
height
 = (
p_I≈
->
ouçut
.height[0] +Ö_Vid->
auto_¸›_bŸtom
);

1220 
p_Vid
->
width_blk
 =Ö_Vid->
width
 / 
BLOCK_SIZE
;

1221 
p_Vid
->
height_blk
 =Ö_Vid->
height
 / 
BLOCK_SIZE
;

1222 
p_Vid
->
width_∑dded
 =Ö_Vid->
width
 + 2 * 
IMG_PAD_SIZE_X
;

1223 
p_Vid
->
height_∑dded
 =Ö_Vid->
height
 + 2 * 
IMG_PAD_SIZE_Y
;

1225 i‡(
p_Vid
->
yuv_f‹m©
 !
YUV400
)

1227 
p_Vid
->
width_¸
 =Ö_Vid->
width
 * 
mb_width_¸
 [p_Vid->
yuv_f‹m©
] / 16;

1228 
p_Vid
->
height_¸
p_Vid->
height
 * 
mb_height_¸
[p_Vid->
yuv_f‹m©
] / 16;

1232 
p_Vid
->
width_¸
 = 0;

1233 
p_Vid
->
height_¸
= 0;

1236 
p_Vid
->
height_¸_‰ame
 =Ö_Vid->
height_¸
;

1238 
p_Vid
->
size
 =Ö_Vid->
width
 *Ö_Vid->
height
;

1239 
p_Vid
->
size_¸
 =Ö_Vid->
width_¸
 *Ö_Vid->
height_¸
;

1241 
p_Vid
->
PicWidthInMbs
 =Ö_Vid->
width
 / 
MB_BLOCK_SIZE
;

1242 
p_Vid
->
FømeHeightInMbs
 =Ö_Vid->
height
 / 
MB_BLOCK_SIZE
;

1243 
p_Vid
->
FømeSizeInMbs
 =Ö_Vid->
PicWidthInMbs
 *Ö_Vid->
FømeHeightInMbs
;

1245 
p_Vid
->
PicHeightInM≠Unôs
 = (Ö_Vid->
a˘ive_•s
->
‰ame_mbs_⁄ly_Êag
 ?Ö_Vid->
FømeHeightInMbs
 :Ö_Vid->FrameHeightInMbs >> 1 );

1247 i‡((
p_Vid
->
b8x8öfo
 = (
Block8x8Info
 *Ë
	`ˇŒoc
(1, (Block8x8Info))Ë=
NULL
)

1248 
	`no_mem_exô
("init_img:Ö_Vid->block8x8info");

1250 if–(
p_I≈
->
£∑øã_cﬁour_∂™e_Êag
 != 0) )

1252  
i
 = 0; i < 
MAX_PLANE
; i++ ){

1254 if((
p_Vid
->
mb_d©a_JV
[
i
] = 
	`Æloc_mbs
’_Vid,Ö_Vid->
FømeSizeInMbs
,Ö_Vid->
num_of_œyîs
)Ë=
NULL
)

1255 
	`no_mem_exô
("init_img:Ö_Vid->mb_data_JV");

1257 
p_Vid
->
mb_d©a
 = 
NULL
;

1262 i‡((
p_Vid
->
mb_d©a
 = 
	`Æloc_mbs
’_Vid,Ö_Vid->
FømeSizeInMbs
,Ö_Vid->
num_of_œyîs
)Ë=
NULL
)

1263 
	`no_mem_exô
("init_img:Ö_Vid->mb_data");

1266 i‡(
p_I≈
->
U£C⁄°øöedI¡øPªd
)

1268 i‡((
p_Vid
->
öåa_block
 = (*Ë
	`ˇŒoc
’_Vid->
FømeSizeInMbs
, ())Ë=
NULL
)

1269 
	`no_mem_exô
("init_img:Ö_Vid->intra_block");

1272 i‡(
p_I≈
->
CtxAd±LagøngeMu…
 == 1)

1274 i‡((
p_Vid
->
mb16x16_co°_‰ame
 = (*)
	`ˇŒoc
’_Vid->
FømeSizeInMbs
, ())Ë=
NULL
)

1276 
	`no_mem_exô
("initÖ_Vid->mb16x16_cost_frame");

1279 
	`gë_mem2D
((
byã
***)&(
p_Vid
->
ùªdmode
),Ö_Vid->
height_blk
,Ö_Vid->
width_blk
);

1280 
	`gë_mem2D
((
byã
***)&(
p_Vid
->
ùªdmode8x8
),Ö_Vid->
height_blk
,Ö_Vid->
width_blk
);

1281 
	`mem£t
(&(
p_Vid
->
ùªdmode
[0][0]Ë, -1,Ö_Vid->
height_blk
 *Ö_Vid->
width_blk
 *());

1282 
	`mem£t
(&(
p_Vid
->
ùªdmode8x8
[0][0]), -1,Ö_Vid->
height_blk
 *Ö_Vid->
width_blk
 *());

1286 if(
p_Vid
->
num_of_œyîs
>1)

1288 
	`gë_mem3Döt
(&(
p_Vid
->
nz_c€ff_buf
[0]),Ö_Vid->
FømeSizeInMbs
, 4, 4+p_Vid->
num_blk8x8_uv
);

1289 if(
p_Vid
->
p_Dpb_œyî
[1]->
°‹age_f‹m©
.
yuv_f‹m©
 !
YUV400
 &&Ö_Vid->p_Dpb_layer[1]->storage_format.yuv_format !=Ö_Vid->p_Dpb_layer[0]->storage_format.yuv_format)

1291 
num_blk8x8_uv
 = (1<<
p_Vid
->
p_Dpb_œyî
[1]->
°‹age_f‹m©
.
yuv_f‹m©
)&(~(0x1));

1292 
	`gë_mem3Döt
(&(
p_Vid
->
nz_c€ff_buf
[1]),Ö_Vid->
FømeSizeInMbs
, 4, 4+
num_blk8x8_uv
);

1295 
p_Vid
->
nz_c€ff_buf
[1] =Ö_Vid->nz_coeff_buf[0];

1296 
p_Vid
->
nz_c€ff
 =Ö_Vid->
nz_c€ff_buf
[0];

1300 
	`gë_mem3Döt
(&(
p_Vid
->
nz_c€ff_buf
[0]),Ö_Vid->
FømeSizeInMbs
, 4, 4+p_Vid->
num_blk8x8_uv
);

1301 
p_Vid
->
nz_c€ff
 =Ö_Vid->
nz_c€ff_buf
[0];

1302 
p_Vid
->
nz_c€ff_buf
[1] = 
NULL
;

1305 
	`gë_mem2Dﬁm
 (&(
p_Vid
->
œmbda_buf
[0]Ë, 10, 52 +Ö_Vid->
bôdïth_luma_qp_sˇÀ
,Ö_Vid->bitdepth_luma_qp_scale);

1306 
p_Vid
->
œmbda
 =Ö_Vid->
œmbda_buf
[0];

1307 
	`gë_mem2DodoubÀ
 (&(
p_Vid
->
œmbda_md_buf
[0]), 10, 52 +Ö_Vid->
bôdïth_luma_qp_sˇÀ
,Ö_Vid->bitdepth_luma_qp_scale);

1308 
p_Vid
->
œmbda_md
 =Ö_Vid->
œmbda_md_buf
[0];

1309 
	`gë_mem3DodoubÀ
 (&(
p_Vid
->
œmbda_me_buf
[0]), 10, 52 +Ö_Vid->
bôdïth_luma_qp_sˇÀ
, 3,Ö_Vid->bitdepth_luma_qp_scale);

1310 
p_Vid
->
œmbda_me
 =Ö_Vid->
œmbda_me_buf
[0];

1311 
	`gë_mem3Doöt
 (&(
p_Vid
->
œmbda_mf_buf
[0]), 10, 52 +Ö_Vid->
bôdïth_luma_qp_sˇÀ
, 3,Ö_Vid->bitdepth_luma_qp_scale);

1312 
p_Vid
->
œmbda_mf
 =Ö_Vid->
œmbda_mf_buf
[0];

1313 i‡–
p_I≈
->
U£RDOQu™t
 )

1315 
	`gë_mem2DodoubÀ
 (&(
p_Vid
->
œmbda_rdoq_buf
[0]), 10, 52 +Ö_Vid->
bôdïth_luma_qp_sˇÀ
,Ö_Vid->bitdepth_luma_qp_scale);

1316 
p_Vid
->
œmbda_rdoq
 =Ö_Vid->
œmbda_rdoq_buf
[0];

1318 i‡(
p_I≈
->
CtxAd±LagøngeMu…
 == 1)

1320 
	`gë_mem2DodoubÀ
(&(
p_Vid
->
œmbda_mf_Á˘‹_buf
[0]), 10, 52 +Ö_Vid->
bôdïth_luma_qp_sˇÀ
,Ö_Vid->bitdepth_luma_qp_scale);

1321 
p_Vid
->
œmbda_mf_Á˘‹
 =Ö_Vid->
œmbda_mf_Á˘‹_buf
[0];

1323 if(
p_Vid
->
num_of_œyîs
>1)

1325 
p_Vid
->
œmbda_buf
[1] =Ö_Vid->lambda_buf[0];

1326 
p_Vid
->
œmbda_md_buf
[1] =Ö_Vid->lambda_md_buf[0];

1327 
p_Vid
->
œmbda_me_buf
[1] =Ö_Vid->lambda_me_buf[0];

1328 
p_Vid
->
œmbda_mf_buf
[1] =Ö_Vid->lambda_mf_buf[0];

1329 
p_Vid
->
œmbda_rdoq_buf
[1] =Ö_Vid->lambda_rdoq_buf[0];

1330 
p_Vid
->
œmbda_mf_Á˘‹_buf
[1] =Ö_Vid->lambda_mf_factor_buf[0];

1333 
p_Vid
->
mb_y_upd
 = 0;

1335 if(((
p_I≈
->
RDPi˘uªDecisi⁄
Ë&&Ö_I≈->
Gíî©eMu…ùÀPPS
Ë|| (p_I≈->
WeighãdPªdi˘i⁄
 ||Ö_I≈->
WeighãdBùªdi˘i⁄
))

1337 
num_¶i˚s
;

1339 if(
p_I≈
->
¶i˚_mode
 == 1)

1341 
num_¶i˚s
 = 
p_Vid
->
FømeSizeInMbs
/
p_I≈
->
¶i˚_¨gumít
;

1342 if(()(
num_¶i˚s
 * 
p_I≈
->
¶i˚_¨gumít
Ë< 
p_Vid
->
FømeSizeInMbs
)

1343 
num_¶i˚s
++;

1346 
num_¶i˚s
 = 1;

1350 
p_Vid
->
num_¶i˚s_wp
 = 
num_¶i˚s
;

1351 
	`gë_mem4Dsh‹t
(&(
p_Vid
->
wp_weights
), 3, 2, 
MAX_REFERENCE_PICTURES
, 
num_¶i˚s
);

1352 
	`gë_mem4Dsh‹t
(&(
p_Vid
->
wp_off£ts
), 3, 2, 
MAX_REFERENCE_PICTURES
, 
num_¶i˚s
);

1353 
	`gë_mem5Dsh‹t
(&(
p_Vid
->
wbp_weight
), 3, 2, 
MAX_REFERENCE_PICTURES
, MAX_REFERENCE_PICTURES, 
num_¶i˚s
);

1357 
p_Vid
->
num_¶i˚s_wp
 = 0;

1358 
p_Vid
->
wp_weights
 = 
NULL
;

1359 
p_Vid
->
wp_off£ts
 = 
NULL
;

1360 
p_Vid
->
wbp_weight
 = 
NULL
;

1363 
	`R™domI¡øInô
 (
p_Vid
,Ö_Vid->
PicWidthInMbs
,Ö_Vid->
FømeHeightInMbs
, 
p_I≈
->
R™domI¡øMBRe‰esh
);

1365 
	`InôSEIMesßges
(
p_Vid
, 
p_I≈
);

1367 
	`öôI≈ut
(
p_Vid
, &
p_I≈
->
sour˚
, &p_I≈->
ouçut
);

1370 
	`AŒoˇãFømeMem‹y
(
p_Vid
, 
p_I≈
, &p_I≈->
sour˚
);

1375 i‡(
p_I≈
->
DFSídP¨amëîs
)

1377 
j
 = 0; j < 2; j++)

1379 
i
 = 0; i < 
NUM_SLICE_TYPES
; i++)

1381 
p_I≈
->
DFAÕha
[
j
][
i
] <<= 1;

1382 
p_I≈
->
DFBëa
 [
j
][
i
] <<= 1;

1383 #i‡(
MVC_EXTENSION_ENABLE
)

1384 i‡(
p_Vid
->
num_of_œyîs
 == 2)

1386 
p_I≈
->
EnhLayîDFAÕha
[
j
][
i
] <<= 1;

1387 
p_I≈
->
EnhLayîDFBëa
 [
j
][
i
] <<= 1;

1395 
j
 = 0; j < 2; j++)

1397 
i
 = 0; i < 
NUM_SLICE_TYPES
; i++)

1399 
p_I≈
->
DFDißbÀIdc
[
j
][
i
] = 0;

1400 
p_I≈
->
DFAÕha
 [
j
][
i
] = 0;

1401 
p_I≈
->
DFBëa
 [
j
][
i
] = 0;

1402 #i‡(
MVC_EXTENSION_ENABLE
)

1403 i‡(
p_Vid
->
num_of_œyîs
 == 2)

1405 
p_I≈
->
EnhLayîDFDißbÀIdc
[
j
][
i
] = 0;

1406 
p_I≈
->
EnhLayîDFAÕha
[
j
][
i
] = 0;

1407 
p_I≈
->
EnhLayîDFBëa
 [
j
][
i
] = 0;

1414 
p_Vid
->
ChromaAºayTy≥
 = 
p_I≈
->
£∑øã_cﬁour_∂™e_Êag
 ? 0 :Ö_I≈->
ouçut
.
yuv_f‹m©
;

1415 
p_Vid
->
cﬁour_∂™e_id
 = 0;

1417 i‡(
p_I≈
->
RDPi˘uªDecisi⁄
)

1418 
p_Vid
->
‰m_ôî
 = 3;

1420 
p_Vid
->
‰m_ôî
 = 1;

1422 
p_Vid
->
max_‰ame_num
 = 1 << (p_Vid->
log2_max_‰ame_num_möus4
 + 4);

1423 
p_Vid
->
max_pic_‹dî_˙t_lsb
 = 1 << (p_Vid->
log2_max_pic_‹dî_˙t_lsb_möus4
 + 4);

1425 
p_Vid
->
¥ev_‰ame_no
 = 0;

1426 
p_Vid
->
c⁄£cutive_n⁄_ª„ªn˚_pi˘uªs
 = 0;

1428 
p_Vid
->
Êd_ty≥
 = 0;

1430 
p_Vid
->
p_I≈
 =Ö_Inp;

1432 
	`¸óã_c⁄ãxt_mem‹y
 (
p_Vid
, 
p_I≈
);

1434 
	}
}

1445 
	$‰ì_img
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

1448 
	`DñëeFømeMem‹y
(
p_Vid
);

1450 
	`Clo£SEIMesßges
(
p_Vid
, 
p_I≈
);

1452 
	`‰ì_c⁄ãxt_mem‹y
 (
p_Vid
);

1454 i‡(
p_I≈
->
Ad≠tiveRoundög
)

1456 
	`‰ì_mem4Döt
(
p_Vid
->
ARCofAdj4x4
);

1457 
	`‰ì_mem4Döt
(
p_Vid
->
ARCofAdj8x8
);

1460 i‡(
p_Vid
->
wp_weights
)

1461 
	`‰ì_mem4Dsh‹t
(
p_Vid
->
wp_weights
);

1462 i‡(
p_Vid
->
wp_off£ts
)

1463 
	`‰ì_mem4Dsh‹t
(
p_Vid
->
wp_off£ts
);

1464 i‡(
p_Vid
->
wbp_weight
)

1465 
	`‰ì_mem5Dsh‹t
(
p_Vid
->
wbp_weight
);

1468 
	`‰ì_poöãr
 (
p_Vid
->
p_SEI
);

1469 
	`‰ì_poöãr
 (
p_Vid
->
p_QSˇÀ
);

1470 
	`‰ì_poöãr
 (
p_Vid
->
p_Qu™t
);

1471 
	`‰ì_poöãr
(
p_Vid
->
p_Dpb_œyî
[0]);

1472 
p_Vid
->
p_Dpb_œyî
[0] =Ö_Vid->p_Dpb_œyî[1] = 
NULL
;

1473 
	`‰ì_poöãr
 (
p_Vid
->
p_Sèts
);

1474 
	`‰ì_poöãr
 (
p_Vid
->
p_Di°
);

1476 
	`‰ì_ícode_∑ømëîs
(
p_Vid
);

1477 
	`‰ì_poöãr
 (
p_Vid
);

1478 
	}
}

1489 
	$‰ì_∑øms
 (
I≈utP¨amëîs
 *
p_I≈
)

1491 i‡–
p_I≈
 !
NULL
 )

1493 
	`‰ì_poöãr
–
p_I≈
->
t›_À·
 );

1494 
	`‰ì_poöãr
–
p_I≈
->
bŸtom_right
 );

1495 
	`‰ì_poöãr
–
p_I≈
->
¶i˚_group_id
 );

1496 
	`‰ì_poöãr
–
p_I≈
->
run_Àngth_möus1
 );

1497 
	`‰ì_poöãr
–
p_I≈
 );

1499 
	}
}

1511 
Pi˘uª
 *
	$mÆloc_pi˘uª
()

1513 
Pi˘uª
 *
pic
;

1514 i‡((
pic
 = 
	`ˇŒoc
 (1,  (
Pi˘uª
))Ë=
NULL
Ë
	`no_mem_exô
 ("malloc_picture: Picture structure");

1516  
pic
;

1517 
	}
}

1527 
	$‰ì_pi˘uª
(
Pi˘uª
 *
pic
)

1529 i‡(
pic
 !
NULL
)

1531 
	`‰ì_¶i˚_li°
(
pic
);

1532 
	`‰ì_poöãr
 (
pic
);

1534 
	}
}

1543 
	$öô_‹ig_buf„rs
(
VideoP¨amëîs
 *
p_Vid
, 
ImageD©a
 *
imgD©a
)

1545 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

1546 
mem‹y_size
 = 0;

1547 
≈œ√
;

1550 
imgD©a
->
f‹m©
 = 
p_I≈
->
ouçut
;

1551 
imgD©a
->
f‹m©
.
width
[0] = 
p_Vid
->width;

1552 
imgD©a
->
f‹m©
.
width
[1] = 
p_Vid
->
width_¸
;

1553 
imgD©a
->
f‹m©
.
width
[2] = 
p_Vid
->
width_¸
;

1554 
imgD©a
->
f‹m©
.
height
[0] = 
p_Vid
->height;

1555 
imgD©a
->
f‹m©
.
height
[1] = 
p_Vid
->
height_¸
;

1556 
imgD©a
->
f‹m©
.
height
[2] = 
p_Vid
->
height_¸
;

1557 
imgD©a
->
f‹m©
.
yuv_f‹m©
 = 
p_Vid
->yuv_format;

1558 
imgD©a
->
f‹m©
.
auto_¸›_bŸtom
 = 
p_Vid
->auto_crop_bottom;

1559 
imgD©a
->
f‹m©
.
auto_¸›_right
 = 
p_Vid
->auto_crop_right;

1560 
imgD©a
->
f‹m©
.
auto_¸›_bŸtom_¸
 = (
p_Vid
->
auto_¸›_bŸtom
 * 
mb_height_¸
 [p_Vid->
yuv_f‹m©
]Ë/ 
MB_BLOCK_SIZE
;

1561 
imgD©a
->
f‹m©
.
auto_¸›_right_¸
 = (
p_Vid
->
auto_¸›_right
 * 
mb_width_¸
 [p_Vid->
yuv_f‹m©
]Ë/ 
MB_BLOCK_SIZE
;

1562 
imgD©a
->
‰m_°ride
[0] = 
p_Vid
->
width
;

1563 
imgD©a
->
‰m_°ride
[1] = imgD©a->‰m_°ride[2] = 
p_Vid
->
width_¸
;

1564 
imgD©a
->
t›_°ride
[0] = imgD©a->
bŸ_°ride
[0] = imgD©a->
‰m_°ride
[0] << 1;

1565 
imgD©a
->
t›_°ride
[1] = imgD©a->t›_°ride[2] = imgD©a->
bŸ_°ride
[1] = imgD©a->bŸ_°ride[2] = imgD©a->
‰m_°ride
[1] << 1;

1567 
imgD©a
->
‰m_d©a_buf
[0][0] = imgD©a->‰m_d©a_buf[0][1] = imgD©a->‰m_d©a_buf[0][2] = 
NULL
;

1568 
imgD©a
->
‰m_d©a_buf
[1][0] = imgD©a->‰m_d©a_buf[1][1] = imgD©a->‰m_d©a_buf[1][2] = 
NULL
;

1569 if–(
p_I≈
->
£∑øã_cﬁour_∂™e_Êag
 != 0) )

1571  
≈œ√
=0;Ç∂™e<
MAX_PLANE
;Çplane++ )

1573 
mem‹y_size
 +
	`gë_mem2D≥l
(&(
imgD©a
->
‰m_d©a
[
≈œ√
]), 
p_Vid
->
height
,Ö_Vid->
width
);

1579 
mem‹y_size
 +
	`gë_mem2D≥l
(&(
imgD©a
->
‰m_d©a
[0]), 
p_Vid
->
height
,Ö_Vid->
width
);

1581 i‡(
p_Vid
->
yuv_f‹m©
 !
YUV400
)

1583 
i
, 
j
, 
k
;

1584 
mem‹y_size
 +
	`gë_mem2D≥l
(&(
imgD©a
->
‰m_d©a
[1]), 
p_Vid
->
height_¸
,Ö_Vid->
width_¸
);

1585 
mem‹y_size
 +
	`gë_mem2D≥l
(&(
imgD©a
->
‰m_d©a
[2]), 
p_Vid
->
height_¸
,Ö_Vid->
width_¸
);

1587 i‡((
img≥l
) == ())

1589 
k
 = 1; k < 3; k++)

1590 
	`mem£t
(&(
imgD©a
->
‰m_d©a
[
k
][0][0]), 128, 
p_Vid
->
height_¸
 *Ö_Vid->
width_¸
 * (
img≥l
));

1594 
k
 = 1; k < 3; k++)

1595 
j
 = 0; j < 
p_Vid
->
height_¸
; j++)

1596 
i
 = 0; i < 
p_Vid
->
width_¸
; i++)

1597 
imgD©a
->
‰m_d©a
[
k
][
j
][
i
] = 128;

1602 i‡(!
p_Vid
->
a˘ive_•s
->
‰ame_mbs_⁄ly_Êag
)

1605 
mem‹y_size
 +
	`öô_t›_bŸ_∂™es
(
imgD©a
->
‰m_d©a
[0], 
p_Vid
->
height
, &(imgD©a->
t›_d©a
[0]), &(imgD©a->
bŸ_d©a
[0]));

1607 i‡(
p_Vid
->
yuv_f‹m©
 !
YUV400
)

1609 
mem‹y_size
 +4*((
img≥l
**));

1611 
mem‹y_size
 +
	`öô_t›_bŸ_∂™es
(
imgD©a
->
‰m_d©a
[1], 
p_Vid
->
height_¸
, &(imgD©a->
t›_d©a
[1]), &(imgD©a->
bŸ_d©a
[1]));

1612 
mem‹y_size
 +
	`öô_t›_bŸ_∂™es
(
imgD©a
->
‰m_d©a
[2], 
p_Vid
->
height_¸
, &(imgD©a->
t›_d©a
[2]), &(imgD©a->
bŸ_d©a
[2]));

1615  
mem‹y_size
;

1616 
	}
}

1630 
	$öô_globÆ_buf„rs
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

1632 
j
, 
mem‹y_size
=0;

1634 i‡((
p_Vid
->
íc_‰ame_pi˘uª
 = (
St‹abÀPi˘uª
**)
	`mÆloc
(6 * (St‹abÀPi˘uª*))Ë=
NULL
)

1635 
	`no_mem_exô
("init_global_buffers: *p_Vid->enc_frame_picture");

1637 
j
 = 0; j < 6; j++)

1638 
p_Vid
->
íc_‰ame_pi˘uª
[
j
] = 
NULL
;

1640 i‡((
p_Vid
->
íc_fõld_pi˘uª
 = (
St‹abÀPi˘uª
**)
	`mÆloc
(2 * (St‹abÀPi˘uª*))Ë=
NULL
)

1641 
	`no_mem_exô
("init_global_buffers: *p_Vid->enc_field_picture");

1643 
j
 = 0; j < 2; j++)

1644 
p_Vid
->
íc_fõld_pi˘uª
[
j
] = 
NULL
;

1646 i‡((
p_Vid
->
‰ame_pic
 = (
Pi˘uª
**)
	`mÆloc
’_Vid->
‰m_ôî
 * (Pi˘uª*))Ë=
NULL
)

1647 
	`no_mem_exô
("init_global_buffers: *p_Vid->frame_pic");

1649 
j
 = 0; j < 
p_Vid
->
‰m_ôî
; j++)

1650 
p_Vid
->
‰ame_pic
[
j
] = 
	`mÆloc_pi˘uª
();

1652 i‡(
p_I≈
->
si_‰ame_ödiˇt‹
 ||Ö_I≈->
•_≥riodicôy
)

1654 
p_Vid
->
numbî_•2_‰ames
=0;

1655 
p_Vid
->
‰ame_pic_si
 = 
	`mÆloc_pi˘uª
();

1657 
	`gë_mem2Döt
 (&
p_Vid
->
Ãec
,Ö_Vid->
height
,Ö_Vid->
width
);

1658 
	`gë_mem3Döt
 (&
p_Vid
->
Ãec_uv
, 2,Ö_Vid->
height
,Ö_Vid->
width
);

1661 #i‡(
MVC_EXTENSION_ENABLE
)

1662 
p_Vid
->
fõld_pic_±r
 = 
NULL
;

1663 
p_Vid
->
fõld_pic1
 = 
NULL
;

1664 
p_Vid
->
fõld_pic2
 = 
NULL
;

1667 i‡(
p_I≈
->
PicI¡îœ˚
 !
FRAME_CODING
)

1669 i‡((
p_Vid
->
fõld_pic1
 = (
Pi˘uª
**)
	`mÆloc
(2 * (Pi˘uª*))Ë=
NULL
)

1670 
	`no_mem_exô
("init_global_buffers: *p_Vid->field_pic1");

1672 
j
 = 0; j < 2; j++)

1673 
p_Vid
->
fõld_pic1
[
j
] = 
	`mÆloc_pi˘uª
();

1675 if(
p_Vid
->
num_of_œyîs
==2)

1677 i‡((
p_Vid
->
fõld_pic2
 = (
Pi˘uª
**)
	`mÆloc
(2 * (Pi˘uª*))Ë=
NULL
)

1678 
	`no_mem_exô
("init_global_buffers: *p_Vid->field_pic2");

1680 
j
 = 0; j < 2; j++)

1681 
p_Vid
->
fõld_pic2
[
j
] = 
	`mÆloc_pi˘uª
();

1686 i‡(
p_I≈
->
PicI¡îœ˚
 !
FRAME_CODING
)

1688 i‡((
p_Vid
->
fõld_pic
 = (
Pi˘uª
**)
	`mÆloc
(2 * (Pi˘uª*))Ë=
NULL
)

1689 
	`no_mem_exô
("init_global_buffers: *p_Vid->field_pic");

1691 
j
 = 0; j < 2; j++)

1692 
p_Vid
->
fõld_pic
[
j
] = 
	`mÆloc_pi˘uª
();

1697 
mem‹y_size
 +
	`öô_‹ig_buf„rs
(
p_Vid
, &p_Vid->
imgD©a
);

1699 i‡–
p_I≈
->
MDRe„ªn˚
[0] ||Ö_Inp->MDReference[1] )

1701 
mem‹y_size
 +
	`öô_‹ig_buf„rs
(
p_Vid
, &p_Vid->
imgRefD©a
);

1704 
mem‹y_size
 +
	`öô_‹ig_buf„rs
(
p_Vid
, &p_Vid->
imgD©a0
);

1706 i‡(
p_I≈
->
íabÀ_32_puŒdown
)

1708 
mem‹y_size
 +
	`öô_‹ig_buf„rs
(
p_Vid
, &p_Vid->
imgD©a32
);

1709 
mem‹y_size
 +
	`öô_‹ig_buf„rs
(
p_Vid
, &p_Vid->
imgD©a4
);

1710 
mem‹y_size
 +
	`öô_‹ig_buf„rs
(
p_Vid
, &p_Vid->
imgD©a5
);

1711 
mem‹y_size
 +
	`öô_‹ig_buf„rs
(
p_Vid
, &p_Vid->
imgD©a6
);

1716 
p_Vid
->
PicPos
 = 
	`ˇŒoc
’_Vid->
FømeSizeInMbs
 + 1, (
BlockPos
));

1718 
j
 = 0; j < (Ë
p_Vid
->
FømeSizeInMbs
 + 1; j++)

1720 
p_Vid
->
PicPos
[
j
].
x
 = (Ë(j %Ö_Vid->
PicWidthInMbs
);

1721 
p_Vid
->
PicPos
[
j
].
y
 = (Ë(j /Ö_Vid->
PicWidthInMbs
);

1725 i‡(
p_I≈
->
rd›t
 == 3)

1727 
mem‹y_size
 +
	`Æloˇã_îrdo_mem
(
p_Vid
, 
p_I≈
);

1730 i‡(
p_I≈
->
Re°ri˘Ref
)

1732 
mem‹y_size
 +
	`gë_mem2D
(&
p_Vid
->
pixñ_m≠
,Ö_Vid->
height
,Ö_Vid->
width
);

1733 
mem‹y_size
 +
	`gë_mem2D
(&
p_Vid
->
ª‰esh_m≠
,Ö_Vid->
height
 >> 3,Ö_Vid->
width
 >> 3);

1736 i‡(!
p_Vid
->
a˘ive_•s
->
‰ame_mbs_⁄ly_Êag
)

1738 
j
=0; j<
p_Vid
->
num_of_œyîs
; j++)

1740 
CodögP¨amëîs
 *
˝s
 = 
p_Vid
->
p_EncodeP¨
[
j
];

1741 
mem‹y_size
 +
	`gë_mem2D≥l
(&(
p_Vid
->
imgY_com_buf
[
j
]), 
˝s
->
height
, cps->
width
);

1742 i‡(
˝s
->
yuv_f‹m©
 !
YUV400
)

1744 
mem‹y_size
 +
	`gë_mem2D≥l
(&(
p_Vid
->
imgUV_com_buf
[
j
][0]), 
˝s
->
height_¸
, cps->
width_¸
);

1745 
mem‹y_size
 +
	`gë_mem2D≥l
(&(
p_Vid
->
imgUV_com_buf
[
j
][1]), 
˝s
->
height_¸
, cps->
width_¸
);

1749 
p_Vid
->
imgY_com
 =Ö_Vid->
imgY_com_buf
[0];

1750 
p_Vid
->
imgUV_com
[0] =Ö_Vid->
imgUV_com_buf
[0][0];

1751 
p_Vid
->
imgUV_com
[1] =Ö_Vid->
imgUV_com_buf
[0][1];

1755 i‡(!
p_I≈
->
I¡øProfûe
)

1757 i‡(
p_I≈
->
SórchMode
[0] =
UM_HEX
 ||Ö_Inp->SearchMode[1] == UM_HEX)

1759 i‡((
p_Vid
->
p_UMHex
 = (
UMHexSåu˘
*)
	`ˇŒoc
(1, (UMHexSåu˘))Ë=
NULL
)

1760 
	`no_mem_exô
("init_mv_block:Ö_Vid->p_UMHex");

1761 
mem‹y_size
 +
	`UMHEX_gë_mem
(
p_Vid
, 
p_I≈
);

1763 i‡(
p_I≈
->
SórchMode
[0] =
UM_HEX_SIMPLE
 ||Ö_Inp->SearchMode[1] == UM_HEX_SIMPLE)

1765 i‡((
p_Vid
->
p_UMHexSMP
 = (
UMHexSMPSåu˘
*)
	`ˇŒoc
(1, (UMHexSMPSåu˘))Ë=
NULL
)

1766 
	`no_mem_exô
("init_mv_block:Ö_Vid->p_UMHexSMP");

1768 
	`smpUMHEX_öô
(
p_Vid
);

1769 
mem‹y_size
 +
	`smpUMHEX_gë_mem
(
p_Vid
);

1771 i‡(
p_I≈
->
SórchMode
[0] =
EPZS
 ||Ö_Inp->SearchMode[1] == EPZS)

1773 
mem‹y_size
 +
	`EPZSInô
(
p_Vid
);

1777 i‡(
p_I≈
->
RCE«bÀ
)

1778 
	`rc_Æloˇã_mem‹y
(
p_Vid
, 
p_I≈
);

1780 i‡(
p_I≈
->
ªdund™t_pic_Êag
)

1782 
j
=0; j<
p_Vid
->
num_of_œyîs
; j++)

1784 
CodögP¨amëîs
 *
˝s
 = 
p_Vid
->
p_EncodeP¨
[
j
];

1785 
mem‹y_size
 +
	`gë_mem2D≥l
(&
p_Vid
->
imgY_tmp_buf
[
j
], 
˝s
->
height
, cps->
width
);

1786 
mem‹y_size
 +
	`gë_mem2D≥l
(&
p_Vid
->
imgUV_tmp_buf
[
j
][0], 
˝s
->
height_¸
, cps->
width_¸
);

1787 
mem‹y_size
 +
	`gë_mem2D≥l
(&
p_Vid
->
imgUV_tmp_buf
[
j
][1], 
˝s
->
height_¸
, cps->
width_¸
);

1789 
p_Vid
->
imgY_tmp
 =Ö_Vid->
imgY_tmp_buf
[0];

1790 
p_Vid
->
imgUV_tmp
[0] =Ö_Vid->
imgUV_tmp_buf
[0][0];

1791 
p_Vid
->
imgUV_tmp
[1] =Ö_Vid->
imgUV_tmp_buf
[0][1];

1794 if–!(
p_I≈
->
OnTheFlyFø˘MCP
Ë|| (p_I≈->OnTheFlyFø˘MCP==
OTF_L1
) )

1796 
mem‹y_size
 +
	`gë_mem2Döt_∑d
 (&
p_Vid
->
imgY_sub_tmp
,Ö_Vid->
height
,Ö_Vid->
width
, 
IMG_PAD_SIZE_Y
, 
IMG_PAD_SIZE_X
);

1800 
	`chroma_mc_£tup
(
p_Vid
);

1802 
p_Vid
->
∑dded_size_x
 = (p_Vid->
width
 + 2 * 
IMG_PAD_SIZE_X
);

1803 
p_Vid
->
∑dded_size_x_m8x8
 = (p_Vid->
∑dded_size_x
 - 
BLOCK_SIZE_8x8
);

1804 
p_Vid
->
∑dded_size_x_m4x4
 = (p_Vid->
∑dded_size_x
 - 
BLOCK_SIZE
);

1805 
p_Vid
->
¸_∑dded_size_x
 = (p_Vid->
width_¸
 + 2 *Ö_Vid->
∑d_size_uv_x
);

1806 
p_Vid
->
¸_∑dded_size_x2
 = (p_Vid->
¸_∑dded_size_x
 << 1);

1807 
p_Vid
->
¸_∑dded_size_x4
 = (p_Vid->
¸_∑dded_size_x
 << 2);

1808 
p_Vid
->
¸_∑dded_size_x_m8
 = (p_Vid->
¸_∑dded_size_x
 - 8);

1813 if(
p_I≈
->
Di°‹ti⁄YUVtoRGB
)

1815 
mem‹y_size
 +
	`¸óã_RGB_mem‹y
(
p_Vid
);

1818 
p_Vid
->
pWPX
 = 
NULL
;

1819 i‡–
p_I≈
->
WPMCPªcisi⁄
 )

1821 
	`wpxInôWPXObje˘
(
p_Vid
);

1824 
mem‹y_size
 +
	`öô_¥o˚ss_image
–
p_Vid
, 
p_I≈
 );

1826 
p_Vid
->
p_¥ed
 = 
	`öô_£q_°ru˘uª
–p_Vid, 
p_I≈
, &
mem‹y_size
 );

1828  
mem‹y_size
;

1829 
	}
}

1837 
	$‰ì_‹ig_∂™es
(
VideoP¨amëîs
 *
p_Vid
, 
ImageD©a
 *
imgD©a
)

1839 if–(
p_Vid
->
p_I≈
->
£∑øã_cﬁour_∂™e_Êag
 != 0) )

1841 
≈œ√
;

1842  
≈œ√
=0;Ç∂™e<
MAX_PLANE
;Çplane++ )

1844 
	`‰ì_mem2D≥l
(
imgD©a
->
‰m_d©a
[
≈œ√
]);

1845 
imgD©a
->
‰m_d©a
[
≈œ√
] = 
NULL
;

1850 
	`‰ì_mem2D≥l
(
imgD©a
->
‰m_d©a
[0]);

1851 
imgD©a
->
‰m_d©a
[0] = 
NULL
;

1852 i‡(
imgD©a
->
f‹m©
.
yuv_f‹m©
 !
YUV400
)

1854 
	`‰ì_mem2D≥l
(
imgD©a
->
‰m_d©a
[1]);

1855 
imgD©a
->
‰m_d©a
[1] = 
NULL
;

1856 
	`‰ì_mem2D≥l
(
imgD©a
->
‰m_d©a
[2]);

1857 
imgD©a
->
‰m_d©a
[2] = 
NULL
;

1861 i‡(!
p_Vid
->
a˘ive_•s
->
‰ame_mbs_⁄ly_Êag
)

1863 
	`‰ì_t›_bŸ_∂™es
(
imgD©a
->
t›_d©a
[0], imgD©a->
bŸ_d©a
[0]);

1864 i‡(
imgD©a
->
f‹m©
.
yuv_f‹m©
 !
YUV400
)

1866 
	`‰ì_t›_bŸ_∂™es
(
imgD©a
->
t›_d©a
[1], imgD©a->
bŸ_d©a
[1]);

1867 
	`‰ì_t›_bŸ_∂™es
(
imgD©a
->
t›_d©a
[2], imgD©a->
bŸ_d©a
[2]);

1869 
imgD©a
->
t›_d©a
[0] = imgD©a->
bŸ_d©a
[0] = 
NULL
;

1870 
imgD©a
->
t›_d©a
[1] = imgD©a->
bŸ_d©a
[1] = 
NULL
;

1871 
imgD©a
->
t›_d©a
[2] = imgD©a->
bŸ_d©a
[2] = 
NULL
;

1873 
	}
}

1889 
	$‰ì_globÆ_buf„rs
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

1891 
i
,
j
;

1893 
	`‰ì_poöãr
 (
p_Vid
->
íc_‰ame_pi˘uª
);

1895 i‡(
p_Vid
->
‰ame_pic
)

1897 
j
 = 0; j < 
p_Vid
->
‰m_ôî
; j++)

1899 i‡(
p_Vid
->
‰ame_pic
[
j
])

1900 
	`‰ì_pi˘uª
 (
p_Vid
->
‰ame_pic
[
j
]);

1902 
	`‰ì_poöãr
 (
p_Vid
->
‰ame_pic
);

1905 
	`‰ì_poöãr
 (
p_Vid
->
íc_fõld_pi˘uª
);

1907 #i‡(
MVC_EXTENSION_ENABLE
)

1908 i‡(
p_Vid
->
fõld_pic1
)

1910 
j
 = 0; j < 2; j++)

1912 i‡(
p_Vid
->
fõld_pic1
[
j
])

1913 
	`‰ì_pi˘uª
 (
p_Vid
->
fõld_pic1
[
j
]);

1915 
	`‰ì_poöãr
 (
p_Vid
->
fõld_pic1
);

1917 if(
p_Vid
->
num_of_œyîs
==2)

1919 
j
 = 0; j < 2; j++)

1921 i‡(
p_Vid
->
fõld_pic2
[
j
])

1922 
	`‰ì_pi˘uª
 (
p_Vid
->
fõld_pic2
[
j
]);

1924 
	`‰ì_poöãr
 (
p_Vid
->
fõld_pic2
);

1928 i‡(
p_Vid
->
fõld_pic
)

1930 
j
 = 0; j < 2; j++)

1932 i‡(
p_Vid
->
fõld_pic
[
j
])

1933 
	`‰ì_pi˘uª
 (
p_Vid
->
fõld_pic
[
j
]);

1935 
	`‰ì_poöãr
 (
p_Vid
->
fõld_pic
);

1940 i‡(
p_I≈
->
si_‰ame_ödiˇt‹
 ||Ö_I≈->
•_≥riodicôy
)

1942 
	`‰ì_pi˘uª
 (
p_Vid
->
‰ame_pic_si
);

1944 
	`‰ì_mem2Döt
 (
p_Vid
->
Ãec
);

1945 
	`‰ì_mem3Döt
 (
p_Vid
->
Ãec_uv
);

1948 
	`‰ì_‹ig_∂™es
(
p_Vid
, &p_Vid->
imgD©a
);

1949 i‡–
p_Vid
->
p_I≈
->
MDRe„ªn˚
[0] ||Ö_Vid->p_Inp->MDReference[1] )

1951 
	`‰ì_‹ig_∂™es
(
p_Vid
, &p_Vid->
imgRefD©a
);

1954 
	`‰ì_‹ig_∂™es
(
p_Vid
, &p_Vid->
imgD©a0
);

1956 i‡(
p_I≈
->
íabÀ_32_puŒdown
)

1958 
	`‰ì_‹ig_∂™es
(
p_Vid
, &p_Vid->
imgD©a32
);

1959 
	`‰ì_‹ig_∂™es
(
p_Vid
, &p_Vid->
imgD©a4
);

1960 
	`‰ì_‹ig_∂™es
(
p_Vid
, &p_Vid->
imgD©a5
);

1961 
	`‰ì_‹ig_∂™es
(
p_Vid
, &p_Vid->
imgD©a6
);

1966 
	`‰ì_poöãr
(
p_Vid
->
PicPos
);

1968 
	`‰ì_QM©rix
(
p_Vid
->
p_Qu™t
);

1969 
	`‰ì_QOff£ts
(
p_Vid
->
p_Qu™t
, 
p_I≈
);

1972 i‡–
p_I≈
->
WPMCPªcisi⁄
 )

1974 
	`wpxFªeWPXObje˘
(
p_Vid
);

1977 i‡(
p_Vid
->
imgY_sub_tmp
)

1979 
	`‰ì_mem2Döt_∑d
 (
p_Vid
->
imgY_sub_tmp
, 
IMG_PAD_SIZE_Y
, 
IMG_PAD_SIZE_X
);

1980 
p_Vid
->
imgY_sub_tmp
 = 
NULL
;

1985 
	`‰ì_mem2D
((
byã
**)
p_Vid
->
ùªdmode
);

1986 
	`‰ì_mem2D
((
byã
**)
p_Vid
->
ùªdmode8x8
);

1988 if(
p_Vid
->
ùªdmode4x4_löe
)

1990 
	`‰ì_mem2D
((
byã
**)
p_Vid
->
ùªdmode4x4_löe
);

1991 
p_Vid
->
ùªdmode4x4_löe
=
NULL
;

1993 if(
p_Vid
->
ùªdmode8x8_löe
)

1995 
	`‰ì_mem2D
((
byã
 **)
p_Vid
->
ùªdmode8x8_löe
);

1996 
p_Vid
->
ùªdmode8x8_löe
 = 
NULL
;

1999 
	`‰ì_poöãr
–
p_Vid
->
b8x8öfo
 );

2001 if–(
p_I≈
->
£∑øã_cﬁour_∂™e_Êag
 != 0) )

2003  
i
=0; i<
MAX_PLANE
; i++ )

2005 
	`‰ì_mbs
(
p_Vid
->
mb_d©a_JV
[
i
],Ö_Vid->
FømeSizeInMbs
);

2011 
	`‰ì_mbs
(
p_Vid
->
mb_d©a
,Ö_Vid->
FømeSizeInMbs
);

2014 if(
p_I≈
->
U£C⁄°øöedI¡øPªd
)

2016 
	`‰ì_poöãr
 (
p_Vid
->
öåa_block
);

2019 i‡(
p_I≈
->
CtxAd±LagøngeMu…
 == 1)

2021 
	`‰ì_poöãr
(
p_Vid
->
mb16x16_co°_‰ame
);

2024 i‡(
p_I≈
->
rd›t
 == 3)

2026 
	`‰ì_îrdo_mem
(
p_Vid
);

2029 i‡(
p_I≈
->
Re°ri˘Ref
)

2031 
	`‰ì_poöãr
(
p_Vid
->
pixñ_m≠
[0]);

2032 
	`‰ì_poöãr
(
p_Vid
->
pixñ_m≠
);

2033 
	`‰ì_poöãr
(
p_Vid
->
ª‰esh_m≠
[0]);

2034 
	`‰ì_poöãr
(
p_Vid
->
ª‰esh_m≠
);

2037 i‡(!
p_Vid
->
a˘ive_•s
->
‰ame_mbs_⁄ly_Êag
)

2039 
i
=0; i<
p_Vid
->
num_of_œyîs
; i++)

2041 
	`‰ì_mem2D≥l
(
p_Vid
->
imgY_com_buf
[
i
]);

2042 
	`‰ì_mem2D≥l
(
p_Vid
->
imgUV_com_buf
[
i
][0]);

2043 
	`‰ì_mem2D≥l
(
p_Vid
->
imgUV_com_buf
[
i
][1]);

2045 
p_Vid
->
imgY_com
 = 
NULL
;

2046 
p_Vid
->
imgUV_com
[0] =Ö_Vid->imgUV_com[1] = 
NULL
;

2049 if(
p_Vid
->
num_of_œyîs
>1)

2051 
bEquÆ
 = 
p_Vid
->
nz_c€ff_buf
[0] ==Ö_Vid->nz_coeff_buf[1];

2052 
	`‰ì_mem3Döt
(
p_Vid
->
nz_c€ff_buf
[0]);

2053 
p_Vid
->
nz_c€ff_buf
[0] = 
NULL
;

2054 if(!
bEquÆ
 && 
p_Vid
->
nz_c€ff_buf
[1])

2055 
	`‰ì_mem3Döt
(
p_Vid
->
nz_c€ff_buf
[1]);

2056 
p_Vid
->
nz_c€ff_buf
[1] = 
NULL
;

2059 
	`‰ì_mem3Döt
(
p_Vid
->
nz_c€ff_buf
[0]);

2060 
p_Vid
->
nz_c€ff
 = 
NULL
;

2062 
	`‰ì_mem2Dﬁm
 (
p_Vid
->
œmbda_buf
[0],Ö_Vid->
bôdïth_luma_qp_sˇÀ
);

2063 
p_Vid
->
œmbda
 =Ö_Vid->
œmbda_buf
[0] =Ö_Vid->œmbda_buf[1] = 
NULL
;

2064 
	`‰ì_mem2DodoubÀ
 (
p_Vid
->
œmbda_md_buf
[0],Ö_Vid->
bôdïth_luma_qp_sˇÀ
);

2065 
p_Vid
->
œmbda_md
 =Ö_Vid->
œmbda_md_buf
[0] =Ö_Vid->œmbda_md_buf[1] = 
NULL
;

2066 
	`‰ì_mem3DodoubÀ
 (
p_Vid
->
œmbda_me_buf
[0], 10, 52 +Ö_Vid->
bôdïth_luma_qp_sˇÀ
,Ö_Vid->bitdepth_luma_qp_scale);

2067 
p_Vid
->
œmbda_me
 =Ö_Vid->
œmbda_me_buf
[0] =Ö_Vid->œmbda_me_buf[1] = 
NULL
;

2068 
	`‰ì_mem3Doöt
 (
p_Vid
->
œmbda_mf_buf
[0], 10, 52 +Ö_Vid->
bôdïth_luma_qp_sˇÀ
,Ö_Vid->bitdepth_luma_qp_scale);

2069 
p_Vid
->
œmbda_mf
 =Ö_Vid->
œmbda_mf_buf
[0] =Ö_Vid->œmbda_mf_buf[1] = 
NULL
;

2070 i‡–
p_I≈
->
U£RDOQu™t
 )

2072 
	`‰ì_mem2DodoubÀ
 (
p_Vid
->
œmbda_rdoq_buf
[0],Ö_Vid->
bôdïth_luma_qp_sˇÀ
);

2073 
p_Vid
->
œmbda_rdoq
 =Ö_Vid->
œmbda_rdoq_buf
[0] =Ö_Vid->œmbda_rdoq_buf[1] = 
NULL
;

2075 i‡(
p_I≈
->
CtxAd±LagøngeMu…
 == 1)

2077 
	`‰ì_mem2DodoubÀ
(
p_Vid
->
œmbda_mf_Á˘‹_buf
[0],Ö_Vid->
bôdïth_luma_qp_sˇÀ
);

2078 
p_Vid
->
œmbda_mf_Á˘‹
 =Ö_Vid->
œmbda_mf_Á˘‹_buf
[0] =Ö_Vid->œmbda_mf_Á˘‹_buf[1] = 
NULL
;

2081 i‡(!
p_I≈
->
I¡øProfûe
)

2083 i‡(
p_I≈
->
SórchMode
[0] =
UM_HEX
 ||Ö_Inp->SearchMode[1] == UM_HEX)

2085 
	`UMHEX_‰ì_mem
(
p_Vid
, 
p_I≈
);

2087 i‡(
p_I≈
->
SórchMode
[0] =
UM_HEX_SIMPLE
 ||Ö_Inp->SearchMode[1] == UM_HEX_SIMPLE)

2089 
	`smpUMHEX_‰ì_mem
(
p_Vid
);

2091 i‡(
p_I≈
->
SórchMode
[0] =
EPZS
 ||Ö_Inp->SearchMode[1] == EPZS)

2093 
	`EPZSDñëe
(
p_Vid
);

2097 i‡(
p_I≈
->
RCE«bÀ
)

2098 
	`rc_‰ì_mem‹y
(
p_Vid
, 
p_I≈
);

2100 i‡(
p_I≈
->
ªdund™t_pic_Êag
)

2102 
i
=0; i<
p_Vid
->
num_of_œyîs
; i++)

2104 
	`‰ì_mem2D≥l
(
p_Vid
->
imgY_tmp_buf
[
i
]);

2105 
	`‰ì_mem2D≥l
(
p_Vid
->
imgUV_tmp_buf
[
i
][0]);

2106 
	`‰ì_mem2D≥l
(
p_Vid
->
imgUV_tmp_buf
[
i
][1]);

2108 
p_Vid
->
imgY_tmp
 = 
NULL
;

2109 
p_Vid
->
imgUV_tmp
[0] = 
NULL
;

2110 
p_Vid
->
imgUV_tmp
[1] = 
NULL
;

2115 if(
p_I≈
->
Di°‹ti⁄YUVtoRGB
)

2117 
	`dñëe_RGB_mem‹y
(
p_Vid
);

2120 
	`˛ór_¥o˚ss_image
–
p_Vid
, 
p_I≈
 );

2121 
	`‰ì_£q_°ru˘uª
–
p_Vid
->
p_¥ed
 );

2122 
	}
}

2131 
	$gë_mem_ACc€ff
 (
VideoP¨amëîs
 *
p_Vid
, ***** 
cofAC
)

2133 
num_blk8x8
 = 
BLOCK_SIZE
 + 
p_Vid
->
num_blk8x8_uv
;

2135 
	`gë_mem4Döt
(
cofAC
, 
num_blk8x8
, 
BLOCK_SIZE
, 2, 65);

2137  
num_blk8x8
 * 
BLOCK_SIZE
 * 2 * 65 * ();

2138 
	}
}

2146 
	$gë_mem_ACc€ff_√w
 (****** 
cofAC
, 
chroma
)

2148 
	`gë_mem5Döt
(
cofAC
, 
BLOCK_SIZE
, 
chroma
, BLOCK_SIZE, 2, 65);

2149  
chroma
 * 
BLOCK_PIXELS
 * 2 * 65 * ();

2150 
	}
}

2158 
	$gë_mem_DCc€ff
 (**** 
cofDC
)

2160 
	`gë_mem3Döt
(
cofDC
, 3, 2, 18);

2162 
	}
}

2171 
	$‰ì_mem_ACc€ff
 (**** 
cofAC
)

2173 
	`‰ì_mem4Döt
(
cofAC
);

2174 
	}
}

2182 
	$‰ì_mem_ACc€ff_√w
 (***** 
cofAC
)

2184 
	`‰ì_mem5Döt
(
cofAC
);

2185 
	}
}

2193 
	$‰ì_mem_DCc€ff
 (*** 
cofDC
)

2195 
	`‰ì_mem3Döt
(
cofDC
);

2196 
	}
}

2205 
	$£t_Àvñ_ödi˚s
(
VideoP¨amëîs
 *
p_Vid
)

2207 
p_Vid
->
a˘ive_•s
->
Àvñ_idc
)

2210 
p_Vid
->
LevñIndex
=1;

2213 
p_Vid
->
LevñIndex
=0;

2216 i‡(!
	`is_FREXT_¥ofûe
(
p_Vid
->
a˘ive_•s
->
¥ofûe_idc
Ë&& (p_Vid->a˘ive_•s->
c⁄°øöed_£t3_Êag
 == 0))

2217 
p_Vid
->
LevñIndex
=2;

2219 
p_Vid
->
LevñIndex
=1;

2222 
p_Vid
->
LevñIndex
=3;

2225 
p_Vid
->
LevñIndex
=4;

2228 
p_Vid
->
LevñIndex
=5;

2231 
p_Vid
->
LevñIndex
=6;

2234 
p_Vid
->
LevñIndex
=7;

2237 
p_Vid
->
LevñIndex
=8;

2240 
p_Vid
->
LevñIndex
=9;

2243 
p_Vid
->
LevñIndex
=10;

2246 
p_Vid
->
LevñIndex
=11;

2249 
p_Vid
->
LevñIndex
=12;

2252 i‡(!
	`is_FREXT_¥ofûe
(
p_Vid
->
a˘ive_•s
->
¥ofûe_idc
))

2253 
p_Vid
->
LevñIndex
=13;

2255 
p_Vid
->
LevñIndex
=14;

2258 
p_Vid
->
LevñIndex
=15;

2261 
p_Vid
->
LevñIndex
=16;

2264 
p_Vid
->
LevñIndex
=17;

2267 
	`Ârötf
 ( 
°dîr
, "Warning: unknown LevelIDC, using maximumÜevel 5.2 \n" );

2268 
p_Vid
->
LevñIndex
=17;

2271 
	}
}

2279 
	$öô_ªdund™t_‰ame
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

2281 i‡(
p_I≈
->
ªdund™t_pic_Êag
)

2283 i‡(
p_I≈
->
NumbîBFømes
)

2285 
	`îr‹
("B frameÇot supported whenÑedundantÖicture used!", 100);

2288 i‡(
p_I≈
->
PicI¡îœ˚
)

2290 
	`îr‹
("InterlaceÇot supported whenÑedundantÖicture used!", 100);

2293 i‡(
p_I≈
->
num_ªf_‰ames
 <Ö_I≈->
Prim¨yGOPLígth
)

2295 
	`îr‹
("NumberReferenceFrames must beÇoÜessÅhan PrimaryGOPLength", 100);

2298 i‡((1<<
p_I≈
->
NumRedund™tHõørchy
Ë>Ö_I≈->
Prim¨yGOPLígth
)

2300 
	`îr‹
("PrimaryGOPLength must be greaterÅhan 2^NumRedundantHeirarchy", 100);

2303 i‡(
p_I≈
->
Vîbo£
 != 1)

2305 
	`îr‹
("Redundant slicesÇot supported when Verbose != 1", 100);

2309 
p_Vid
->
key_‰ame
 = 0;

2310 
p_Vid
->
ªdund™t_codög
 = 0;

2311 
p_Vid
->
ªdund™t_pic_˙t
 = 0;

2312 
p_Vid
->
‰ameNumöGOP
 =Ö_Vid->
cuº_‰m_idx
 % 
p_I≈
->
Prim¨yGOPLígth
;

2313 i‡(
p_Vid
->
cuº_‰m_idx
 == 0)

2315 
p_Vid
->
‰ameNumöGOP
 = -1;

2317 
	}
}

2325 
	$£t_ªdund™t_‰ame
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

2327 
GOPÀngth
 = 
p_I≈
->
Prim¨yGOPLígth
;

2330 i‡(
p_Vid
->
‰ameNumöGOP
 == 0)

2332 
p_Vid
->
ªdund™t_codög
 = 0;

2333 
p_Vid
->
key_‰ame
 = 1;

2334 
p_Vid
->
ªdund™t_ªf_idx
 = 
GOPÀngth
;

2338 i‡(
p_I≈
->
NumRedund™tHõørchy
 > 0)

2340 i‡(
p_Vid
->
‰ameNumöGOP
 =
GOPÀngth
 >> 1)

2342 
p_Vid
->
ªdund™t_codög
 = 0;

2343 
p_Vid
->
key_‰ame
 = 1;

2344 
p_Vid
->
ªdund™t_ªf_idx
 = 
GOPÀngth
 >> 1;

2349 i‡(
p_I≈
->
NumRedund™tHõørchy
 > 1)

2351 i‡(
p_Vid
->
‰ameNumöGOP
 =(
GOPÀngth
 >> 2) ||Ö_Vid->frameNuminGOP == ((GOPlength*3) >> 2))

2353 
p_Vid
->
ªdund™t_codög
 = 0;

2354 
p_Vid
->
key_‰ame
 = 1;

2355 
p_Vid
->
ªdund™t_ªf_idx
 = 
GOPÀngth
 >> 2;

2360 i‡(
p_I≈
->
NumRedund™tHõørchy
 > 2)

2362 i‡(
p_Vid
->
‰ameNumöGOP
 =
GOPÀngth
 >> 3 ||Ö_Vid->frameNuminGOP == ((GOPlength*3) >> 3)

2363 || 
p_Vid
->
‰ameNumöGOP
 =((
GOPÀngth
*5) >> 3) ||Ö_Vid->frameNuminGOP == ((GOPlength*7) & 0x03))

2365 
p_Vid
->
ªdund™t_codög
 = 0;

2366 
p_Vid
->
key_‰ame
 = 1;

2367 
p_Vid
->
ªdund™t_ªf_idx
 = 
GOPÀngth
 >> 3;

2372 i‡(
p_I≈
->
NumRedund™tHõørchy
 > 3)

2374 i‡(
p_Vid
->
‰ameNumöGOP
 =(
GOPÀngth
 >> 4) ||Ö_Vid->frameNuminGOP == ((GOPlength*3) >> 4)

2375 || 
p_Vid
->
‰ameNumöGOP
 =((
GOPÀngth
*5) >> 4) ||Ö_Vid->frameNuminGOP == ((GOPlength*7) >> 4)

2376 || 
p_Vid
->
‰ameNumöGOP
 =((
GOPÀngth
*9) >> 4) ||Ö_Vid->frameNuminGOP == ((GOPlength*11) >> 4)

2377 || 
p_Vid
->
‰ameNumöGOP
 =((
GOPÀngth
*13) >> 4))

2379 
p_Vid
->
ªdund™t_codög
 = 0;

2380 
p_Vid
->
key_‰ame
 = 1;

2381 
p_Vid
->
ªdund™t_ªf_idx
 = 
GOPÀngth
 >> 4;

2384 
	}
}

2392 
	$ícode_⁄e_ªdund™t_‰ame
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

2394 
p_Vid
->
key_‰ame
 = 0;

2395 
p_Vid
->
ªdund™t_codög
 = 1;

2396 
p_Vid
->
ªdund™t_pic_˙t
 = 1;

2398 i‡(!
p_Vid
->
cuºítPi˘uª
->
idr_Êag
)

2400 i‡(
p_Vid
->
ty≥
 =
I_SLICE
)

2402 
	`£t_¶i˚_ty≥
–
p_Vid
, 
p_I≈
, 
P_SLICE
 );

2406 
	`ícode_⁄e_‰ame
(
p_Vid
, 
p_I≈
);

2407 
	}
}

2415 
	$chroma_mc_£tup
(
VideoP¨amëîs
 *
p_Vid
)

2418 i‡–
p_Vid
->
yuv_f‹m©
 =
YUV420
 )

2420 
p_Vid
->
∑d_size_uv_x
 = 
IMG_PAD_SIZE_X
 >> 1;

2421 
p_Vid
->
∑d_size_uv_y
 = 
IMG_PAD_SIZE_Y
 >> 1;

2422 
p_Vid
->
chroma_mask_mv_y
 = 7;

2423 
p_Vid
->
chroma_mask_mv_x
 = 7;

2424 
p_Vid
->
chroma_shi·_x
 = 3;

2425 
p_Vid
->
chroma_shi·_y
 = 3;

2427 i‡–
p_Vid
->
yuv_f‹m©
 =
YUV422
 )

2429 
p_Vid
->
∑d_size_uv_x
 = 
IMG_PAD_SIZE_X
 >> 1;

2430 
p_Vid
->
∑d_size_uv_y
 = 
IMG_PAD_SIZE_Y
;

2431 
p_Vid
->
chroma_mask_mv_y
 = 3;

2432 
p_Vid
->
chroma_mask_mv_x
 = 7;

2433 
p_Vid
->
chroma_shi·_y
 = 2;

2434 
p_Vid
->
chroma_shi·_x
 = 3;

2438 
p_Vid
->
∑d_size_uv_x
 = 
IMG_PAD_SIZE_X
;

2439 
p_Vid
->
∑d_size_uv_y
 = 
IMG_PAD_SIZE_Y
;

2440 
p_Vid
->
chroma_mask_mv_y
 = 3;

2441 
p_Vid
->
chroma_mask_mv_x
 = 3;

2442 
p_Vid
->
chroma_shi·_y
 = 2;

2443 
p_Vid
->
chroma_shi·_x
 = 2;

2445 
p_Vid
->
shi·_¸_y
 =Ö_Vid->
chroma_shi·_y
 - 2;

2446 
p_Vid
->
shi·_¸_x
 =Ö_Vid->
chroma_shi·_x
 - 2;

2447 
	}
}

2450 
	$gí_íc_∑r
(
VideoP¨amëîs
 *
p_Vid
, 
œyî_idx
)

2452 
CodögP¨amëîs
 *
˝s
;

2453 
DecodedPi˘uªBuf„r
 *
p_Dpb
;

2454 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

2456 
˝s
 = 
p_Vid
->
p_EncodeP¨
[
œyî_idx
];

2457 
p_Dpb
 = 
p_Vid
->
p_Dpb_œyî
[
œyî_idx
];

2459 
˝s
->
œyî_id
 = 
œyî_idx
;

2460 
˝s
->
yuv_f‹m©
 = 
p_Dpb
->
°‹age_f‹m©
.yuv_format;

2461 
˝s
->
P444_joöed
 = (˝s->
yuv_f‹m©
 =
YUV444
 && (
p_I≈
->
£∑øã_cﬁour_∂™e_Êag
 == 0));

2462 
˝s
->
bôdïth_luma
 = ()
p_Dpb
->
°‹age_f‹m©
.
bô_dïth
[0];

2463 
˝s
->
bôdïth_sˇÀ
[0] = 1 << (˝s->
bôdïth_luma
 - 8);

2464 
˝s
->
bôdïth_œmbda_sˇÀ
 = 2 * (˝s->
bôdïth_luma
 - 8);

2465 
˝s
->
bôdïth_luma_qp_sˇÀ
 = 3 * cps->
bôdïth_œmbda_sˇÀ
;

2466 
˝s
->
dc_¥ed_vÆue_comp
[0] = (
uöt32
Ë(1<<(˝s->
bôdïth_luma
 - 1));

2467 
˝s
->
max_≥l_vÆue_comp
[0] = (1<<˝s->
bôdïth_luma
) - 1;

2468 
˝s
->
max_img≥l_vÆue_comp_sq
[0] = cps->
max_≥l_vÆue_comp
[0] * cps->max_pel_value_comp[0];

2469 
˝s
->
mb_size
[0][0] = cps->mb_size[0][1] = 
MB_BLOCK_SIZE
;

2470 i‡(
˝s
->
yuv_f‹m©
 !
YUV400
)

2472 
˝s
->
bôdïth_chroma
 = ()
p_Dpb
->
°‹age_f‹m©
.
bô_dïth
[1];

2473 
˝s
->
bôdïth_sˇÀ
[1] = 1 << (˝s->
bôdïth_chroma
 - 8);

2474 
˝s
->
dc_¥ed_vÆue_comp
[1] = (
uöt32
Ë(1<<(˝s->
bôdïth_chroma
 - 1));

2475 
˝s
->
dc_¥ed_vÆue_comp
[2] = cps->dc_pred_value_comp[1];

2476 
˝s
->
max_≥l_vÆue_comp
[1] = (1<<˝s->
bôdïth_chroma
) - 1;

2477 
˝s
->
max_≥l_vÆue_comp
[2] = cps->max_pel_value_comp[1];

2478 
˝s
->
max_img≥l_vÆue_comp_sq
[1] = cps->
max_≥l_vÆue_comp
[1] * cps->max_pel_value_comp[1];

2479 
˝s
->
max_img≥l_vÆue_comp_sq
[2] = cps->
max_≥l_vÆue_comp
[2] * cps->max_pel_value_comp[2];

2480 
˝s
->
num_blk8x8_uv
 = (1<<˝s->
yuv_f‹m©
)&(~(0x1));

2481 
˝s
->
num_cdc_c€ff
 = cps->
num_blk8x8_uv
 << 1;

2482 
˝s
->
mb_size
[1][0] = cps->mb_size[2][0] = cps->
mb_¸_size_x
 = (˝s->
yuv_f‹m©
 =
YUV420
 || cps->yuv_f‹m© =
YUV422
) ? 8 : 16;

2483 
˝s
->
mb_size
[1][1] = cps->mb_size[2][1] = cps->
mb_¸_size_y
 = (˝s->
yuv_f‹m©
 =
YUV444
 || cps->yuv_f‹m© =
YUV422
) ? 16 : 8;

2484 
˝s
->
bôdïth_chroma_qp_sˇÀ
 = 6*(˝s->
bôdïth_chroma
 - 8);

2488 
˝s
->
bôdïth_chroma
 = 0;

2489 
˝s
->
bôdïth_sˇÀ
[1] = 0;

2490 
˝s
->
max_≥l_vÆue_comp
[1] = 0;

2491 
˝s
->
max_≥l_vÆue_comp
[2] = cps->max_pel_value_comp[1];

2492 
˝s
->
max_img≥l_vÆue_comp_sq
[1] = cps->
max_≥l_vÆue_comp
[1] * cps->max_pel_value_comp[1];

2493 
˝s
->
max_img≥l_vÆue_comp_sq
[2] = cps->
max_≥l_vÆue_comp
[2] * cps->max_pel_value_comp[2];

2494 
˝s
->
num_blk8x8_uv
 = 0;

2495 
˝s
->
num_cdc_c€ff
 = 0;

2496 
˝s
->
mb_size
[1][0] = cps->mb_size[2][0] = cps->
mb_¸_size_x
 = 0;

2497 
˝s
->
mb_size
[1][1] = cps->mb_size[2][1] = cps->
mb_¸_size_y
 = 0;

2499 
˝s
->
bôdïth_chroma_qp_sˇÀ
 = 0;

2501 
˝s
->
max_bôCou¡
 = 128 + 256 * cps->
bôdïth_luma
 + 2 * cps->
mb_¸_size_y
 * cps->
mb_¸_size_x
 * cps->
bôdïth_chroma
;

2502 
˝s
->
width
 = (
p_I≈
->
ouçut
.width[0] + 
p_Vid
->
auto_¸›_right
);

2503 
˝s
->
height
 = (
p_I≈
->
ouçut
.height[0] + 
p_Vid
->
auto_¸›_bŸtom
);

2504 
˝s
->
width_blk
 = cps->
width
 / 
BLOCK_SIZE
;

2505 
˝s
->
height_blk
 = cps->
height
 / 
BLOCK_SIZE
;

2506 
˝s
->
width_∑dded
 = cps->
width
 + 2 * 
IMG_PAD_SIZE_X
;

2507 
˝s
->
height_∑dded
 = cps->
height
 + 2 * 
IMG_PAD_SIZE_Y
;

2509 i‡(
˝s
->
yuv_f‹m©
 !
YUV400
)

2511 
˝s
->
width_¸
 = cps->
width
 * 
mb_width_¸
 [˝s->
yuv_f‹m©
] / 16;

2512 
˝s
->
height_¸
˝s->
height
 * 
mb_height_¸
[˝s->
yuv_f‹m©
] / 16;

2516 
˝s
->
width_¸
 = 0;

2517 
˝s
->
height_¸
= 0;

2520 
˝s
->
height_¸_‰ame
 = cps->
height_¸
;

2521 
˝s
->
size
 = cps->
width
 * cps->
height
;

2522 
˝s
->
size_¸
 = cps->
width_¸
 * cps->
height_¸
;

2524 
˝s
->
PicWidthInMbs
 = cps->
width
 / 
MB_BLOCK_SIZE
;

2525 
˝s
->
FømeHeightInMbs
 = cps->
height
 / 
MB_BLOCK_SIZE
;

2526 
˝s
->
FømeSizeInMbs
 = cps->
PicWidthInMbs
 * cps->
FømeHeightInMbs
;

2527 
˝s
->
PicHeightInM≠Unôs
 = ( 
p_Vid
->
•s
[
œyî_idx
]->
‰ame_mbs_⁄ly_Êag
 ? cps->
FømeHeightInMbs
 : cps->FrameHeightInMbs >> 1 );

2529 i‡–
˝s
->
yuv_f‹m©
 =
YUV420
 )

2531 
˝s
->
∑d_size_uv_x
 = 
IMG_PAD_SIZE_X
 >> 1;

2532 
˝s
->
∑d_size_uv_y
 = 
IMG_PAD_SIZE_Y
 >> 1;

2533 
˝s
->
chroma_mask_mv_y
 = 7;

2534 
˝s
->
chroma_mask_mv_x
 = 7;

2535 
˝s
->
chroma_shi·_x
 = 3;

2536 
˝s
->
chroma_shi·_y
 = 3;

2538 i‡–
˝s
->
yuv_f‹m©
 =
YUV422
 )

2540 
˝s
->
∑d_size_uv_x
 = 
IMG_PAD_SIZE_X
 >> 1;

2541 
˝s
->
∑d_size_uv_y
 = 
IMG_PAD_SIZE_Y
;

2542 
˝s
->
chroma_mask_mv_y
 = 3;

2543 
˝s
->
chroma_mask_mv_x
 = 7;

2544 
˝s
->
chroma_shi·_y
 = 2;

2545 
˝s
->
chroma_shi·_x
 = 3;

2549 
˝s
->
∑d_size_uv_x
 = 
IMG_PAD_SIZE_X
;

2550 
˝s
->
∑d_size_uv_y
 = 
IMG_PAD_SIZE_Y
;

2551 
˝s
->
chroma_mask_mv_y
 = 3;

2552 
˝s
->
chroma_mask_mv_x
 = 3;

2553 
˝s
->
chroma_shi·_y
 = 2;

2554 
˝s
->
chroma_shi·_x
 = 2;

2556 
˝s
->
shi·_¸_y
 = cps->
chroma_shi·_y
 - 2;

2557 
˝s
->
shi·_¸_x
 = cps->
chroma_shi·_x
 - 2;

2559 
˝s
->
∑dded_size_x
 = (˝s->
width
 + 2 * 
IMG_PAD_SIZE_X
);

2560 
˝s
->
∑dded_size_x_m8x8
 = (˝s->
∑dded_size_x
 - 
BLOCK_SIZE_8x8
);

2561 
˝s
->
∑dded_size_x_m4x4
 = (˝s->
∑dded_size_x
 - 
BLOCK_SIZE
);

2562 
˝s
->
¸_∑dded_size_x
 = (˝s->
width_¸
 + 2 * cps->
∑d_size_uv_x
);

2563 
˝s
->
¸_∑dded_size_x2
 = (˝s->
¸_∑dded_size_x
 << 1);

2564 
˝s
->
¸_∑dded_size_x4
 = (˝s->
¸_∑dded_size_x
 << 2);

2565 
˝s
->
¸_∑dded_size_x_m8
 = (˝s->
¸_∑dded_size_x
 - 8);

2567 
	}
}

2569 
	$gíî©e_ícode_∑ømëîs
(
VideoP¨amëîs
 *
p_Vid
)

2571 
i
;

2572 
p_Vid
->
p_EncodeP¨
[0] = (
CodögP¨amëîs
 *)
	`ˇŒoc
’_Vid->
num_of_œyîs
, (CodingParameters));

2574 
i
=0; i<
p_Vid
->
num_of_œyîs
; i++)

2576 
p_Vid
->
p_EncodeP¨
[
i
] =Ö_Vid->p_EncodePar[0]+i;

2577 
	`gí_íc_∑r
(
p_Vid
, 
i
);

2579 
p_Vid
->
p_CuºEncodeP¨
 =Ö_Vid->
p_EncodeP¨
[0];

2580 
	}
}

2582 
	$‰ì_ícode_∑ømëîs
(
VideoP¨amëîs
 *
p_Vid
)

2584 
i
;

2585 if(
p_Vid
->
p_EncodeP¨
[0])

2587 
	`‰ì_poöãr
(
p_Vid
->
p_EncodeP¨
[0]);

2589 
i
=0; i<
p_Vid
->
num_of_œyîs
; i++)

2591 
p_Vid
->
p_EncodeP¨
[
i
] = 
NULL
;

2593 
p_Vid
->
p_CuºEncodeP¨
 = 
NULL
;

2594 
	}
}

2596 
	$öô_¥o˚ss_image
–
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

2598 
mem‹y_size
 = 0;

2599  
p_I≈
->
Pro˚ssI≈ut
 )

2604 if–(
p_Vid
->
num_of_œyîs
 =2Ë&& 
	`is_MVC_¥ofûe
(
p_I≈
->
ProfûeIDC
) )

2605 
mem‹y_size
 +
	`öô_‹ig_buf„rs
(
p_Vid
, &p_Vid->
ãmpD©a3
);

2608  
mem‹y_size
;

2609 
	}
}

2611 
	$˛ór_¥o˚ss_image
–
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

2613  
p_I≈
->
Pro˚ssI≈ut
 )

2618 if–(
p_Vid
->
num_of_œyîs
 =2Ë&& 
	`is_MVC_¥ofûe
(
p_I≈
->
ProfûeIDC
) )

2619 
	`‰ì_‹ig_∂™es
(
p_Vid
, &p_Vid->
ãmpD©a3
);

2622 
	}
}

	@lencod/src/list_reorder.c

17 
	~"c⁄åibut‹s.h
"

19 
	~<m©h.h
>

20 
	~<Êﬂt.h
>

22 
	~"globÆ.h
"

23 
	~"image.h
"

24 
	~"wp.h
"

25 
	~"li°_ª‹dî.h
"

27 
poc_ªf_pic_ª‹dî_dummy
(
Sli˚
 *
cuºSli˚
, 
num_ªf_idx_lX_a˘ive
, 
li°_no
);

28 
ª‹dî_li°s_dummy
–
Sli˚
 *
cuºSli˚
 );

36 
	$öô_ªf_pic_li°_ª‹dîög
(
Sli˚
* 
cuºSli˚
, 
ªfRe‹dîMëhod
)

38 
cuºSli˚
->
ªf_pic_li°_ª‹dîög_Êag
[
LIST_0
] = 0;

39 
cuºSli˚
->
ªf_pic_li°_ª‹dîög_Êag
[
LIST_1
] = 0;

41 i‡(
ªfRe‹dîMëhod
 == 2)

43 
cuºSli˚
->
poc_ªf_pic_ª‹dî_‰ame
 = 
éyr_ªf_pic_ª‹dî_‰ame_deÁu…
;

44 
cuºSli˚
->
ª‹dî_li°s
 =Ñeorder_lists;

46 #i‡(
MVC_EXTENSION_ENABLE
)

47 i‡((
ªfRe‹dîMëhod
 =1Ë&& (
cuºSli˚
->
œyî_id
 > 0Ë&& (cuºSli˚->
p_I≈
->
MVCI¡îVõwRe‹dî
 > 0 ))

49 
cuºSli˚
->
poc_ªf_pic_ª‹dî_‰ame
 = 
poc_ªf_pic_ª‹dî_‰ame_íh
;

50 
cuºSli˚
->
ª‹dî_li°s
 =Ñeorder_lists;

52 i‡((
ªfRe‹dîMëhod
 =0Ë&& (
cuºSli˚
->
œyî_id
 > 0Ë&& (cuºSli˚->
p_I≈
->
MVCI¡îVõwRe‹dî
 > 0 ))

54 
cuºSli˚
->
poc_ªf_pic_ª‹dî_‰ame
 = 
poc_ªf_pic_ª‹dî_‰ame_íh
;

55 
cuºSli˚
->
ª‹dî_li°s
 =Ñeorder_lists;

58 i‡((
ªfRe‹dîMëhod
 =0Ë|| (
cuºSli˚
->
¶i˚_ty≥
 =
I_SLICE
Ë|| (cuºSli˚->¶i˚_ty≥ =
SI_SLICE
))

60 
cuºSli˚
->
poc_ªf_pic_ª‹dî_‰ame
 = 
poc_ªf_pic_ª‹dî_dummy
;

61 
cuºSli˚
->
ª‹dî_li°s
 = 
ª‹dî_li°s_dummy
;

65 
cuºSli˚
->
poc_ªf_pic_ª‹dî_‰ame
 = 
poc_ªf_pic_ª‹dî_‰ame_íh
;

66 
cuºSli˚
->
ª‹dî_li°s
 =Ñeorder_lists;

68 
	}
}

76 
	$poc_ªf_pic_ª‹dî_‰ame_deÁu…
(
Sli˚
 *
cuºSli˚
, 
num_ªf_idx_lX_a˘ive
, 
li°_no
)

78 
St‹abÀPi˘uª
 **
li°
 = 
cuºSli˚
->
li°X
[
li°_no
];

79 *
modifiˇti⁄_of_pic_nums_idc
 = 
cuºSli˚
->modifiˇti⁄_of_pic_nums_idc[
li°_no
];

80 *
abs_diff_pic_num_möus1
 = 
cuºSli˚
->abs_diff_pic_num_möus1[
li°_no
];

81 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

82 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºSli˚
->p_Inp;

83 
St‹abÀPi˘uª
 *
p_Enc_Pic
 = 
p_Vid
->
íc_pi˘uª
;

84 
DecodedPi˘uªBuf„r
 *
p_Dpb
 = 
cuºSli˚
->p_Dpb;

86 
i
,
j
,
k
;

88 
cuºPicNum
, 
picNumLXPªd
;

90 
deÁu…_‹dî
[32];

91 
ª_‹dî
[32];

92 
tmp_ª‹dî
[32];

93 
li°_sign
[32];

94 
ª‹dî_°›
, 
no_ª‹dî
;

95 
poc_diff
[32];

96 
diff
;

98 
abs_poc_di°
;

99 
maxPicNum
;

100 
num_ªfs
;

102 
maxPicNum
 = 
p_Vid
->
max_‰ame_num
;

103 
cuºPicNum
 = 
p_Vid
->
‰ame_num
;

105 
picNumLXPªd
 = 
cuºPicNum
;

108 
i
=0; i<()
num_ªf_idx_lX_a˘ive
; i++)

110 
deÁu…_‹dî
[
i
] = 
li°
[i]->
pic_num
;

117 
num_ªfs
 = 
cuºSli˚
->
p_Dpb
->
ªf_‰ames_ö_buf„r
;

118 
i
 = 0; i < ()
p_Dpb
->
ªf_‰ames_ö_buf„r
; i++)

120 
poc_diff
[
i
] = 0xFFFF;

121 
ª_‹dî
[
i
] = 
p_Dpb
->
fs_ªf
[i]->
‰ame
->
pic_num
;

123 i‡(
p_Dpb
->
fs_ªf
[
i
]->
is_u£d
==3 && (p_Dpb->fs_ªf[i]->
‰ame
->
u£d_f‹_ª„ªn˚
)&&(!p_Dpb->fs_ªf[i]->‰ame->
is_l⁄g_ãrm
))

125 
abs_poc_di°
 = 
	`übs
(
p_Dpb
->
fs_ªf
[
i
]->
‰ame
->
poc
 - 
p_Enc_Pic
->poc) ;

126 
poc_diff
[
i
] = 
abs_poc_di°
;

127 i‡(
li°_no
 =
LIST_0
)

129 
li°_sign
[
i
] = (
p_Enc_Pic
->
poc
 < 
p_Dpb
->
fs_ªf
[i]->
‰ame
->poc) ? +1 : -1;

133 
li°_sign
[
i
] = (
p_Enc_Pic
->
poc
 > 
p_Dpb
->
fs_ªf
[i]->
‰ame
->poc) ? +1 : -1;

139 
i
 = 0; i < (()
num_ªfs
 - 1); i++)

141 
j
 = 
i
 + 1; j < ()
num_ªfs
; j++)

143 i‡(
poc_diff
[
i
]>poc_diff[
j
] || (poc_diff[i] =poc_diff[j] && 
li°_sign
[j] >Üist_sign[i]))

145 
	`i32_sw≠
(
poc_diff
[
i
],Öoc_diff[
j
]);

146 
	`i32_sw≠
(
ª_‹dî
[
i
],Ñe_‹dî[
j
]);

147 
	`i32_sw≠
(
li°_sign
[
i
],Üi°_sign[
j
]);

153 i‡–
p_I≈
->
WPMCPªcisi⁄


154 && 
p_Vid
->
pWPX
->
cuº_wp_rd_∑ss
->
Æg‹ôhm
 !
WP_REGULAR


155 && 
p_Vid
->
pWPX
->
num_wp_ªf_li°
[
li°_no
] )

157 
i
=0; i<()
num_ªf_idx_lX_a˘ive
; i++)

159 
ª_‹dî
[
i
] = 
p_Vid
->
pWPX
->
wp_ªf_li°
[
li°_no
][i].
PicNum
;

163 i‡(
p_I≈
->
E«bÀO≥nGOP
)

165 
cou¡î
 = 0;

166 
i
 = 0; i < 
cuºSli˚
->
li°Xsize
[
li°_no
]; i++)

168 i‡(
cuºSli˚
->
li°X
[
li°_no
][
i
]->
poc
 < 
p_Vid
->
œ°_vÆid_ª„ªn˚
 &&Ö_Vid->
ThisPOC
 >Ö_Vid->last_valid_reference)

170 
cou¡î
++;

174 
cuºSli˚
->
li°Xsize
[
li°_no
] -
cou¡î
;

175 
num_ªf_idx_lX_a˘ive
 = 
cuºSli˚
->
li°Xsize
[
li°_no
];

180 
no_ª‹dî
 = 1;

181 
i
=0; i<()
num_ªf_idx_lX_a˘ive
; i++)

183 i‡(
deÁu…_‹dî
[
i
] !
ª_‹dî
[i])

185 
no_ª‹dî
 = 0;

190 i‡(
no_ª‹dî
==0)

192 
i
=0; i<()
num_ªf_idx_lX_a˘ive
; i++)

194 
diff
 = 
ª_‹dî
[
i
]-
picNumLXPªd
;

195 i‡(
diff
 <= 0)

197 
modifiˇti⁄_of_pic_nums_idc
[
i
] = 0;

198 
abs_diff_pic_num_möus1
[
i
] = 
	`übs
(
diff
)-1;

199 i‡(
abs_diff_pic_num_möus1
[
i
] < 0)

200 
abs_diff_pic_num_möus1
[
i
] = 
maxPicNum
 -1;

204 
modifiˇti⁄_of_pic_nums_idc
[
i
] = 1;

205 
abs_diff_pic_num_möus1
[
i
] = 
	`übs
(
diff
)-1;

207 
picNumLXPªd
 = 
ª_‹dî
[
i
];

209 
tmp_ª‹dî
[
i
] = 
ª_‹dî
[i];

211 
k
 = 
i
;

212 
j
=
i
; j<()
num_ªf_idx_lX_a˘ive
; j++)

214 i‡(
deÁu…_‹dî
[
j
] !
ª_‹dî
[
i
])

216 ++
k
;

217 
tmp_ª‹dî
[
k
] = 
deÁu…_‹dî
[
j
];

220 
ª‹dî_°›
 = 1;

221 
j
=
i
+1; j<()
num_ªf_idx_lX_a˘ive
; j++)

223 i‡(
tmp_ª‹dî
[
j
] !
ª_‹dî
[j])

225 
ª‹dî_°›
 = 0;

230 i‡(
ª‹dî_°›
==1)

232 ++
i
;

235 
	`mem˝y
 ( 
deÁu…_‹dî
, 
tmp_ª‹dî
, 
num_ªf_idx_lX_a˘ive
 * ());

238 
modifiˇti⁄_of_pic_nums_idc
[
i
] = 3;

240 
	`mem˝y
 ( 
deÁu…_‹dî
, 
tmp_ª‹dî
, 
num_ªf_idx_lX_a˘ive
 * ());

242 i‡(
li°_no
==0)

244 
cuºSli˚
->
ªf_pic_li°_ª‹dîög_Êag
[
LIST_0
] = 1;

248 
cuºSli˚
->
ªf_pic_li°_ª‹dîög_Êag
[
LIST_1
] = 1;

251 
	}
}

259 
	$poc_ªf_pic_ª‹dî_dummy
(
Sli˚
 *
cuºSli˚
, 
num_ªf_idx_lX_a˘ive
, 
li°_no
)

261 
	}
}

269 
	$poc_ªf_pic_ª‹dî_‰ame_íh
(
Sli˚
 *
cuºSli˚
, 
num_ªf_idx_lX_a˘ive
, 
li°_no
)

271 
St‹abÀPi˘uª
 **
li°
 = 
cuºSli˚
->
li°X
[
li°_no
];

272 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

273 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºSli˚
->p_Inp;

274 
St‹abÀPi˘uª
 *
p_Enc_Pic
 = 
p_Vid
->
íc_pi˘uª
;

275 
DecodedPi˘uªBuf„r
 *
p_Dpb
 = 
cuºSli˚
->p_Dpb;

277 
i
, 
j
, 
k
;

278 
found
 = 0;

280 
St‹abÀPi˘uª
 *
ª_‹dî
[32];

281 
St‹abÀPi˘uª
 *
öãr_œyî_ªf
[32];

282 
St‹abÀPi˘uª
 *
tmp_pic_vÆue
;

284 
li°_sign
[32];

285 
poc_diff
[32];

286 
öãr_œyî_ªf_idx
[32];

288 
abs_poc_di°
;

289 
num_ªfs
;

290 
pic_num
;

295 #i‡(
MVC_EXTENSION_ENABLE
)

296 i‡(
cuºSli˚
->
œyî_id
 > 0)

298 
i
 = 0; i < (Ë
num_ªf_idx_lX_a˘ive
; i++)

300 i‡(
li°
[
i
]->
võw_id
 < 
cuºSli˚
->
œyî_id
)

302 
öãr_œyî_ªf
[
found
] = 
li°
[
i
];

303 
öãr_œyî_ªf_idx
[
found
] = 
i
;

304 
found
++;

314 
num_ªfs
 = 
p_Dpb
->
ªf_‰ames_ö_buf„r
;

315 
i
 = 0; i < 
num_ªfs
; i++)

317 
poc_diff
[
i
] = 0xFFFF;

318 
ª_‹dî
[
i
] = 
p_Dpb
->
fs_ªf
[i]->
‰ame
;

321 i‡(
p_Dpb
->
fs_ªf
[
i
]->
is_u£d
==3 && (p_Dpb->fs_ªf[i]->
‰ame
->
u£d_f‹_ª„ªn˚
Ë&& (!p_Dpb->fs_ªf[i]->‰ame->
is_l⁄g_ãrm
))

323 
abs_poc_di°
 = 
	`übs
(
p_Dpb
->
fs_ªf
[
i
]->
‰ame
->
poc
 - 
p_Enc_Pic
->poc) ;

324 
poc_diff
[
i
] = 
abs_poc_di°
;

325 i‡(
li°_no
 =
LIST_0
)

327 
li°_sign
[
i
] = (
p_Enc_Pic
->
poc
 < 
p_Dpb
->
fs_ªf
[i]->
‰ame
->poc) ? +1 : -1;

331 
li°_sign
[
i
] = (
p_Enc_Pic
->
poc
 > 
p_Dpb
->
fs_ªf
[i]->
‰ame
->poc) ? +1 : -1;

337 
i
 = 0; i < (
num_ªfs
 - 1); i++)

339 
j
 = 
i
 + 1; j < 
num_ªfs
; j++)

341 i‡(
poc_diff
[
i
] >Öoc_diff[
j
] || (poc_diff[i] =poc_diff[j] && 
li°_sign
[j] >Üist_sign[i]))

343 
	`i32_sw≠
(
poc_diff
[
i
],Öoc_diff[
j
]);

344 
tmp_pic_vÆue
 = 
ª_‹dî
[
i
];

345 
ª_‹dî
[
i
] =Ñe_‹dî[
j
];

346 
ª_‹dî
[
j
] = 
tmp_pic_vÆue
 ;

347 
	`i32_sw≠
(
li°_sign
[
i
],Üi°_sign[
j
]);

353 i‡–
p_I≈
->
WPMCPªcisi⁄


354 && 
p_Vid
->
pWPX
->
cuº_wp_rd_∑ss
->
Æg‹ôhm
 !
WP_REGULAR


355 && 
p_Vid
->
pWPX
->
num_wp_ªf_li°
[
li°_no
] )

357 
i
 = 0; i < (Ë
num_ªf_idx_lX_a˘ive
; i++)

359 
pic_num
 = 
p_Vid
->
pWPX
->
wp_ªf_li°
[
li°_no
][
i
].
PicNum
;

360 
j
 = 0; j < (Ë
p_Dpb
->
ªf_‰ames_ö_buf„r
; j++)

362 i‡(
pic_num
 =
p_Dpb
->
fs_ªf
[
i
]->
‰ame
->pic_num)

364 
ª_‹dî
[
i
] = 
p_Dpb
->
fs_ªf
[i]->
‰ame
;

371 i‡(
cuºSli˚
->
œyî_id
 > 0)

376 
j
 = 0;

377 
k
 = 0;

378 
i
 = 0; i < (Ë
num_ªf_idx_lX_a˘ive
+
found
; i++)

380 i‡((
found
 > 0Ë&& (
i
 =
öãr_œyî_ªf_idx
[
k
]))

382 
li°
[
i
] = 
öãr_œyî_ªf
[
k
++];

384 
found
--;

388 
li°
[
i
] = 
ª_‹dî
[
j
++];

394 
i
 = 0; i < (Ë
num_ªf_idx_lX_a˘ive
; i++)

396 
li°
[
i
] = 
ª_‹dî
[i];

399 
	}
}

407 
	$poc_ªf_pic_ª‹dî_fõld_íh
(
Sli˚
 *
cuºSli˚
, 
num_ªf_idx_lX_a˘ive
, 
li°_no
)

409 
St‹abÀPi˘uª
 **
li°
 = 
cuºSli˚
->
li°X
[
li°_no
];

410 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

412 
St‹abÀPi˘uª
 *
p_Enc_Pic
 = 
p_Vid
->
íc_pi˘uª
;

413 
DecodedPi˘uªBuf„r
 *
p_Dpb
 = 
cuºSli˚
->p_Dpb;

415 
i
,
j
,
k
;

416 
found
 = 0;

418 
St‹abÀPi˘uª
 *
ª_‹dî
[32];

419 
St‹abÀPi˘uª
 *
tmp_ª‹dî
[32];

420 
St‹abÀPi˘uª
 *
öãr_œyî_ªf
[32];

421 
St‹abÀPi˘uª
 *
tmp_pic_vÆue
;

422 
St‹abÀPi˘uª
 *
pFõld
[2];

423 
FømeSt‹e
 *
pFømeSt‹e
;

425 
li°_sign
[32];

426 
poc_diff
[32];

427 
öãr_œyî_ªf_idx
[32];

429 
abs_poc_di°
;

430 
num_ªfs
;

432 
fõld_u£d
[2] = {1, 2};

433 
Êd_ty≥
[32];

434 
num_Êds
, 
Êd
, 
idx
;

435 
li°_size
 = 0;

436 
t›_idx
 = 0;

437 
bŸ_idx
 = 0;

441 #i‡(
MVC_EXTENSION_ENABLE
)

442 i‡(
cuºSli˚
->
œyî_id
 > 0)

444 
i
 = 0; i < (Ë
num_ªf_idx_lX_a˘ive
; i++)

446 i‡(
li°
[
i
]->
võw_id
 < 
cuºSli˚
->
œyî_id
)

448 
öãr_œyî_ªf
[
found
] = 
li°
[
i
];

449 
öãr_œyî_ªf_idx
[
found
] = 
i
;

450 
found
++;

460 
idx
 = 0;

461 
num_ªfs
 = 
p_Dpb
->
ªf_‰ames_ö_buf„r
;

462 
i
 = 0; i < 
num_ªfs
; i++)

464 
pFømeSt‹e
 = 
p_Dpb
->
fs_ªf
[
i
];

465 
pFõld
[0] = 
pFømeSt‹e
->
t›_fõld
;

466 
pFõld
[1] = 
pFømeSt‹e
->
bŸtom_fõld
;

467 
num_Êds
 = (
cuºSli˚
->
°ru˘uª
 =
BOTTOM_FIELD
 && (
p_Enc_Pic
->
poc
 =(
pFõld
[0]->poc + 1) ) ) ? 1 : 2;

469 
poc_diff
[2*
i
 ] = 0xFFFF;

470 
poc_diff
[2*
i
 + 1] = 0xFFFF;

472  
Êd
 = 0; fld < 
num_Êds
; fld++ )

474 i‡–(
pFømeSt‹e
->
is_u£d
 & 
fõld_u£d
[
Êd
]Ë&& 
pFõld
[Êd]->
u£d_f‹_ª„ªn˚
 && !’Fõld[Êd]->
is_l⁄g_ãrm
))

476 
abs_poc_di°
 = 
	`übs
(
pFõld
[
Êd
]->
poc
 - 
p_Enc_Pic
->poc) ;

477 
poc_diff
[
idx
] = 
abs_poc_di°
;

478 
ª_‹dî
[
idx
] = 
pFõld
[
Êd
];

479 
Êd_ty≥
[
idx
] = 
Êd
 + 1;

481 i‡(
li°_no
 =
LIST_0
)

483 
li°_sign
[
idx
] = (
p_Enc_Pic
->
poc
 < 
pFõld
[
Êd
]->poc) ? +1 : -1;

487 
li°_sign
[
idx
] = (
p_Enc_Pic
->
poc
 > 
pFõld
[
Êd
]->poc) ? +1 : -1;

489 
idx
++;

493 
num_ªfs
 = 
idx
;

496 
i
=0; i < 
num_ªfs
-1; i++)

498 
j
 = (
i
 + 1); j < 
num_ªfs
; j++)

500 i‡(
poc_diff
[
i
] >Öoc_diff[
j
] || (poc_diff[i] =poc_diff[j] && 
li°_sign
[j] >Üist_sign[i]))

503 
	`i32_sw≠
 (
poc_diff
[
i
],Öoc_diff[
j
]);

505 
tmp_pic_vÆue
 = 
ª_‹dî
[
i
];

506 
ª_‹dî
[
i
] =Ñe_‹dî[
j
];

507 
ª_‹dî
[
j
] = 
tmp_pic_vÆue
;

509 
	`i32_sw≠
 (
li°_sign
[
i
],Üi°_sign[
j
]);

511 
	`i32_sw≠
 (
Êd_ty≥
[
i
], fld_ty≥[
j
]);

516 i‡(
cuºSli˚
->
°ru˘uª
 =
TOP_FIELD
)

518 (
t›_idx
 < 
num_ªfs
)||(
bŸ_idx
 <Çum_refs))

520  ; 
t›_idx
 < 
num_ªfs
;Åop_idx++)

522 i‡–
Êd_ty≥
[
t›_idx
] =
TOP_FIELD
 )

524 
tmp_ª‹dî
[
li°_size
] = 
ª_‹dî
[
t›_idx
];

525 
li°_size
++;

526 
t›_idx
++;

530  ; 
bŸ_idx
 < 
num_ªfs
; bot_idx++)

532 i‡–
Êd_ty≥
[
bŸ_idx
] =
BOTTOM_FIELD
 )

534 
tmp_ª‹dî
[
li°_size
] = 
ª_‹dî
[
bŸ_idx
];

535 
li°_size
++;

536 
bŸ_idx
++;

543 i‡(
cuºSli˚
->
°ru˘uª
 =
BOTTOM_FIELD
)

545 (
t›_idx
 < 
num_ªfs
)||(
bŸ_idx
 <Çum_refs))

547  ; 
bŸ_idx
 < 
num_ªfs
; bot_idx++)

549 i‡–
Êd_ty≥
[
bŸ_idx
] =
BOTTOM_FIELD
 )

551 
tmp_ª‹dî
[
li°_size
] = 
ª_‹dî
[
bŸ_idx
];

552 
li°_size
++;

553 
bŸ_idx
++;

557  ; 
t›_idx
 < 
num_ªfs
;Åop_idx++)

559 i‡–
Êd_ty≥
[
t›_idx
] =
TOP_FIELD
 )

561 
tmp_ª‹dî
[
li°_size
] = 
ª_‹dî
[
t›_idx
];

562 
li°_size
++;

563 
t›_idx
++;

570 
j
 = 0;

571 
k
 = 0;

572 
i
 = 0; i < (Ë
num_ªf_idx_lX_a˘ive
; i++)

574 i‡((
found
 > 0Ë&& (
i
 =
öãr_œyî_ªf_idx
[
k
]))

576 
li°
[
i
] = 
öãr_œyî_ªf
[
k
++];

577 
found
--;

581 
li°
[
i
] = 
tmp_ª‹dî
[
j
++];

584 
	}
}

592 
	$poc_ªf_pic_ª‹dî_fõld
(
Sli˚
 *
cuºSli˚
, 
num_ªf_idx_lX_a˘ive
, 
li°_no
)

594 
St‹abÀPi˘uª
 **
li°
 = 
cuºSli˚
->
li°X
[
li°_no
];

595 *
modifiˇti⁄_of_pic_nums_idc
 = 
cuºSli˚
->modifiˇti⁄_of_pic_nums_idc[
li°_no
];

596 *
abs_diff_pic_num_möus1
 = 
cuºSli˚
->abs_diff_pic_num_möus1[
li°_no
];

598 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

600 
St‹abÀPi˘uª
 *
p_Enc_Pic
 = 
p_Vid
->
íc_pi˘uª
;

601 
DecodedPi˘uªBuf„r
 *
p_Dpb
 = 
cuºSli˚
->p_Dpb;

603 
i
,
j
,
k
;

605 
cuºPicNum
, 
picNumLXPªd
;

607 
deÁu…_‹dî
[32];

608 
ª_‹dî
[32];

609 
tmp_ª‹dî
[32];

610 
li°_sign
[32];

611 
poc_diff
[32];

612 
Êd_ty≥
[32];

614 
ª‹dî_°›
, 
no_ª‹dî
;

615 
tmp_vÆue
, 
diff
;

617 
abs_poc_di°
;

618 
maxPicNum
;

619 
num_ªfs
;

621 
fõld_u£d
[2] = {1, 2};

622 
Êd
, 
idx
, 
num_Êds
;

624 
t›_idx
 = 0;

625 
bŸ_idx
 = 0;

626 
li°_size
 = 0;

628 
St‹abÀPi˘uª
 *
pFõld
[2];

629 
FømeSt‹e
 *
pFømeSt‹e
;

631 
maxPicNum
 = 2 * 
p_Vid
->
max_‰ame_num
;

632 
cuºPicNum
 = 2 * 
p_Vid
->
‰ame_num
 + 1;

634 
picNumLXPªd
 = 
cuºPicNum
;

637 
i
=0; i<
num_ªf_idx_lX_a˘ive
; i++)

639 
deÁu…_‹dî
[
i
] = 
li°
[i]->
pic_num
;

647 
idx
 = 0;

649 
i
=0; i<
p_Dpb
->
ªf_‰ames_ö_buf„r
; i++)

651 
pFømeSt‹e
 = 
p_Dpb
->
fs_ªf
[
i
];

652 
pFõld
[0] = 
pFømeSt‹e
->
t›_fõld
;

653 
pFõld
[1] = 
pFømeSt‹e
->
bŸtom_fõld
;

654 
num_Êds
 = (
cuºSli˚
->
°ru˘uª
 =
BOTTOM_FIELD
 && (
p_Enc_Pic
->
poc
 =(
pFõld
[0]->poc + 1) ) ) ? 1 : 2;

656 
poc_diff
[2*
i
 ] = 0xFFFF;

657 
poc_diff
[2*
i
 + 1] = 0xFFFF;

659  
Êd
 = 0; fld < 
num_Êds
; fld++ )

661 #i‡(
MVC_EXTENSION_ENABLE
)

662 i‡–(
pFømeSt‹e
->
is_u£d
 & 
fõld_u£d
[
Êd
]Ë&& 
pFõld
[Êd]->
u£d_f‹_ª„ªn˚
 && !’Fõld[Êd]->
is_l⁄g_ãrm
)

663 && (
p_Vid
->
p_I≈
->
num_of_võws
==1 || 
pFõld
[
Êd
]->
võw_id
==p_Vid->view_id))

665 i‡–(
pFømeSt‹e
->
is_u£d
 & 
fõld_u£d
[
Êd
]Ë&& 
pFõld
[Êd]->
u£d_f‹_ª„ªn˚
 && !’Fõld[Êd]->
is_l⁄g_ãrm
))

668 
abs_poc_di°
 = 
	`übs
(
pFõld
[
Êd
]->
poc
 - 
p_Enc_Pic
->poc) ;

669 
poc_diff
[
idx
] = 
abs_poc_di°
;

670 
ª_‹dî
[
idx
] = 
pFõld
[
Êd
]->
pic_num
;

671 
Êd_ty≥
[
idx
] = 
Êd
 + 1;

673 i‡(
li°_no
 =
LIST_0
)

675 
li°_sign
[
idx
] = (
p_Enc_Pic
->
poc
 < 
pFõld
[
Êd
]->poc) ? +1 : -1;

679 
li°_sign
[
idx
] = (
p_Enc_Pic
->
poc
 > 
pFõld
[
Êd
]->poc) ? +1 : -1;

681 
idx
++;

685 
num_ªfs
 = 
idx
;

688 
i
=0; i < 
num_ªfs
-1; i++)

690 
j
 = (
i
 + 1); j < 
num_ªfs
; j++)

692 i‡(
poc_diff
[
i
] >Öoc_diff[
j
] || (poc_diff[i] =poc_diff[j] && 
li°_sign
[j] >Üist_sign[i]))

695 
tmp_vÆue
 = 
poc_diff
[
i
];

696 
poc_diff
[
i
] =Öoc_diff[
j
];

697 
poc_diff
[
j
] = 
tmp_vÆue
;

699 
tmp_vÆue
 = 
ª_‹dî
[
i
];

700 
ª_‹dî
[
i
] =Ñe_‹dî[
j
];

701 
ª_‹dî
[
j
] = 
tmp_vÆue
;

703 
tmp_vÆue
 = 
li°_sign
[
i
];

704 
li°_sign
[
i
] =Üi°_sign[
j
];

705 
li°_sign
[
j
] = 
tmp_vÆue
;

707 
tmp_vÆue
 = 
Êd_ty≥
[
i
];

708 
Êd_ty≥
[
i
] = fld_ty≥[
j
];

709 
Êd_ty≥
[
j
] = 
tmp_vÆue
 ;

714 i‡(
cuºSli˚
->
°ru˘uª
 =
TOP_FIELD
)

716 (
t›_idx
 < 
num_ªfs
)||(
bŸ_idx
 <Çum_refs))

718  ; 
t›_idx
 < 
num_ªfs
;Åop_idx++)

720 i‡–
Êd_ty≥
[
t›_idx
] =
TOP_FIELD
 )

722 
tmp_ª‹dî
[
li°_size
] = 
ª_‹dî
[
t›_idx
];

723 
li°_size
++;

724 
t›_idx
++;

728  ; 
bŸ_idx
 < 
num_ªfs
; bot_idx++)

730 i‡–
Êd_ty≥
[
bŸ_idx
] =
BOTTOM_FIELD
 )

732 
tmp_ª‹dî
[
li°_size
] = 
ª_‹dî
[
bŸ_idx
];

733 
li°_size
++;

734 
bŸ_idx
++;

740 i‡(
cuºSli˚
->
°ru˘uª
 =
BOTTOM_FIELD
)

742 (
t›_idx
 < 
num_ªfs
)||(
bŸ_idx
 <Çum_refs))

744  ; 
bŸ_idx
 < 
num_ªfs
; bot_idx++)

746 i‡–
Êd_ty≥
[
bŸ_idx
] =
BOTTOM_FIELD
 )

748 
tmp_ª‹dî
[
li°_size
] = 
ª_‹dî
[
bŸ_idx
];

749 
li°_size
++;

750 
bŸ_idx
++;

754  ; 
t›_idx
 < 
num_ªfs
;Åop_idx++)

756 i‡–
Êd_ty≥
[
t›_idx
] =
TOP_FIELD
 )

758 
tmp_ª‹dî
[
li°_size
] = 
ª_‹dî
[
t›_idx
];

759 
li°_size
++;

760 
t›_idx
++;

768 
li°_size
 = 
	`imö
(Üist_size, 32 );

769  
i
 = 0; i < 
li°_size
; i++ )

771 
ª_‹dî
[
i
] = 
tmp_ª‹dî
[i];

776 
no_ª‹dî
 = 1;

777 
i
=0; i<
num_ªf_idx_lX_a˘ive
; i++)

779 i‡(
deÁu…_‹dî
[
i
] !
ª_‹dî
[i])

781 
no_ª‹dî
 = 0;

786 i‡(
no_ª‹dî
 == 0)

788 
i
=0; i<
num_ªf_idx_lX_a˘ive
; i++)

790 
diff
 = 
ª_‹dî
[
i
] - 
picNumLXPªd
;

791 i‡(
diff
 <= 0)

793 
modifiˇti⁄_of_pic_nums_idc
[
i
] = 0;

794 
abs_diff_pic_num_möus1
[
i
] = 
	`übs
(
diff
)-1;

795 i‡(
abs_diff_pic_num_möus1
[
i
] < 0)

796 
abs_diff_pic_num_möus1
[
i
] = 
maxPicNum
 -1;

800 
modifiˇti⁄_of_pic_nums_idc
[
i
] = 1;

801 
abs_diff_pic_num_möus1
[
i
] = 
	`übs
(
diff
)-1;

803 
picNumLXPªd
 = 
ª_‹dî
[
i
];

805 
tmp_ª‹dî
[
i
] = 
ª_‹dî
[i];

807 
k
 = 
i
;

808 
j
 = 
i
; j < 
num_ªf_idx_lX_a˘ive
; j++)

810 i‡(
deÁu…_‹dî
[
j
] !
ª_‹dî
[
i
])

812 ++
k
;

813 
tmp_ª‹dî
[
k
] = 
deÁu…_‹dî
[
j
];

816 
ª‹dî_°›
 = 1;

817 
j
=
i
+1; j<
num_ªf_idx_lX_a˘ive
; j++)

819 i‡(
tmp_ª‹dî
[
j
] !
ª_‹dî
[j])

821 
ª‹dî_°›
 = 0;

826 i‡(
ª‹dî_°›
==1)

828 ++
i
;

832 
	`mem˝y
 ( 
deÁu…_‹dî
, 
tmp_ª‹dî
, 
num_ªf_idx_lX_a˘ive
 * ());

834 
modifiˇti⁄_of_pic_nums_idc
[
i
] = 3;

836 
	`mem˝y
 ( 
deÁu…_‹dî
, 
tmp_ª‹dî
, 
num_ªf_idx_lX_a˘ive
 * ());

838 i‡(
li°_no
==0)

840 
cuºSli˚
->
ªf_pic_li°_ª‹dîög_Êag
[
LIST_0
] = 1;

844 
cuºSli˚
->
ªf_pic_li°_ª‹dîög_Êag
[
LIST_1
] = 1;

847 
	}
}

856 
	$éyr_ªf_pic_ª‹dî_‰ame_deÁu…
(
Sli˚
 *
cuºSli˚
, 
num_ªf_idx_lX_a˘ive
, 
li°_no
)

858 
St‹abÀPi˘uª
 **
li°
 = 
cuºSli˚
->
li°X
[
li°_no
];

859 *
modifiˇti⁄_of_pic_nums_idc
 = 
cuºSli˚
->modifiˇti⁄_of_pic_nums_idc[
li°_no
];

860 *
abs_diff_pic_num_möus1
 = 
cuºSli˚
->abs_diff_pic_num_möus1[
li°_no
];

862 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

863 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºSli˚
->p_Inp;

864 
St‹abÀPi˘uª
 *
p_Enc_Pic
 = 
p_Vid
->
íc_pi˘uª
;

865 
decoded_pi˘uª_buf„r
 *
p_Dpb
 = 
cuºSli˚
->p_Dpb;

867 
i
,
j
,
k
;

869 
cuºPicNum
, 
picNumLXPªd
;

871 
deÁu…_‹dî
[32];

872 
ª_‹dî
[32];

873 
tmp_ª‹dî
[32];

874 
li°_sign
[32];

875 
ª‹dî_°›
, 
no_ª‹dî
;

876 
poc_diff
[32];

878 
ãmp‹Æ_œyî
[32];

880 
diff
;

882 
abs_poc_di°
;

883 
maxPicNum
;

884 
num_ªfs
;

886 
tmp_poc_diff
, 
tmp_ª_‹dî
, 
tmp_li°_sign
, 
tmp_ãmp‹Æ_œyî
;

887 
begöIdx
 = 0;

888 
√wSize
 = 0;

891 
maxPicNum
 = 
p_Vid
->
max_‰ame_num
;

892 
cuºPicNum
 = 
p_Vid
->
‰ame_num
;

894 
picNumLXPªd
 = 
cuºPicNum
;

897 
i
=0; i<
num_ªf_idx_lX_a˘ive
; i++)

899 
deÁu…_‹dî
[
i
] = 
li°
[i]->
pic_num
;

906 
num_ªfs
 = 
p_Dpb
->
ªf_‰ames_ö_buf„r
;

907 
i
=0; i<
p_Dpb
->
ªf_‰ames_ö_buf„r
; i++)

909 
poc_diff
[
i
] = 0xFFFF;

910 
ª_‹dî
[
i
] = 
p_Dpb
->
fs_ªf
[i]->
‰ame
->
pic_num
;

912 
ãmp‹Æ_œyî
[
i
] = 
p_Dpb
->
fs_ªf
[i]->
‰ame
->temporal_layer;

914 i‡(
p_Dpb
->
fs_ªf
[
i
]->
is_u£d
==3 && (p_Dpb->fs_ªf[i]->
‰ame
->
u£d_f‹_ª„ªn˚
)&&(!p_Dpb->fs_ªf[i]->‰ame->
is_l⁄g_ãrm
))

916 
abs_poc_di°
 = 
	`übs
(
p_Dpb
->
fs_ªf
[
i
]->
‰ame
->
poc
 - 
p_Enc_Pic
->poc) ;

917 
poc_diff
[
i
] = 
abs_poc_di°
;

918 i‡(
li°_no
 =
LIST_0
)

920 
li°_sign
[
i
] = (
p_Enc_Pic
->
poc
 < 
p_Dpb
->
fs_ªf
[i]->
‰ame
->poc) ? +1 : -1;

924 
li°_sign
[
i
] = (
p_Enc_Pic
->
poc
 > 
p_Dpb
->
fs_ªf
[i]->
‰ame
->poc) ? +1 : -1;

930 
i
 = 0; i < (
num_ªfs
 - 1); i++)

932 
j
 = 
i
 + 1; j < 
num_ªfs
; j++)

934 i‡(
li°_sign
[
i
] =li°_sign[
j
] && 
poc_diff
[i] >Öoc_diff[j])

936 
tmp_poc_diff
 = 
poc_diff
[
i
];

937 
tmp_ª_‹dî
 = 
ª_‹dî
[
i
];

938 
tmp_li°_sign
 = 
li°_sign
[
i
];

939 
tmp_ãmp‹Æ_œyî
 = 
ãmp‹Æ_œyî
[
i
];

940 
poc_diff
[
i
] =Öoc_diff[
j
];

941 
ª_‹dî
[
i
] =Ñe_‹dî[
j
];

942 
li°_sign
[
i
] =Üi°_sign[
j
];

943 
ãmp‹Æ_œyî
[
i
] =Åemp‹Æ_œyî[
j
];

944 
poc_diff
[
j
] = 
tmp_poc_diff
;

945 
ª_‹dî
[
j
] = 
tmp_ª_‹dî
 ;

946 
li°_sign
[
j
] = 
tmp_li°_sign
;

947 
ãmp‹Æ_œyî
[
j
] = 
tmp_ãmp‹Æ_œyî
;

953 
i
 = 0; i < 
num_ªfs
; i++)

959 i‡(
ãmp‹Æ_œyî
[
i
] <
p_Enc_Pic
->temporal_layer)

961 
tmp_poc_diff
 = 
poc_diff
[
i
];

962 
tmp_ª_‹dî
 = 
ª_‹dî
[
i
];

963 
tmp_li°_sign
 = 
li°_sign
[
i
];

964 
tmp_ãmp‹Æ_œyî
 = 
ãmp‹Æ_œyî
[
i
];

965 
j
 = 
i
; j > 
begöIdx
; j--)

967 
poc_diff
[
j
] =Öoc_diff[j-1];

968 
ª_‹dî
[
j
] =Ñe_order[j-1];

969 
li°_sign
[
j
] =Üist_sign[j-1];

970 
ãmp‹Æ_œyî
[
j
] =Åemporal_layer[j-1];

972 
poc_diff
[
begöIdx
] = 
tmp_poc_diff
;

973 
ª_‹dî
[
begöIdx
] = 
tmp_ª_‹dî
;

974 
li°_sign
[
begöIdx
] = 
tmp_li°_sign
;

975 
ãmp‹Æ_œyî
[
begöIdx
] = 
tmp_ãmp‹Æ_œyî
;

976 
begöIdx
 += 1;

978 
√wSize
++;

984 i‡–
p_I≈
->
WPMCPªcisi⁄


985 && 
p_Vid
->
pWPX
->
cuº_wp_rd_∑ss
->
Æg‹ôhm
 !
WP_REGULAR


986 && 
p_Vid
->
pWPX
->
num_wp_ªf_li°
[
li°_no
] )

988 
i
=0; i<
num_ªf_idx_lX_a˘ive
; i++)

990 
ª_‹dî
[
i
] = 
p_Vid
->
pWPX
->
wp_ªf_li°
[
li°_no
][i].
PicNum
;

996 
no_ª‹dî
 = 1;

997 
i
=0; i<
num_ªf_idx_lX_a˘ive
; i++)

999 i‡(
deÁu…_‹dî
[
i
] !
ª_‹dî
[i])

1001 
no_ª‹dî
 = 0;

1006 i‡(
no_ª‹dî
==0)

1008 
i
=0; i<
num_ªf_idx_lX_a˘ive
; i++)

1010 
diff
 = 
ª_‹dî
[
i
]-
picNumLXPªd
;

1011 i‡(
diff
 <= 0)

1013 
modifiˇti⁄_of_pic_nums_idc
[
i
] = 0;

1014 
abs_diff_pic_num_möus1
[
i
] = 
	`übs
(
diff
)-1;

1015 i‡(
abs_diff_pic_num_möus1
[
i
] < 0)

1016 
abs_diff_pic_num_möus1
[
i
] = 
maxPicNum
 -1;

1020 
modifiˇti⁄_of_pic_nums_idc
[
i
] = 1;

1021 
abs_diff_pic_num_möus1
[
i
] = 
	`übs
(
diff
)-1;

1023 
picNumLXPªd
 = 
ª_‹dî
[
i
];

1025 
tmp_ª‹dî
[
i
] = 
ª_‹dî
[i];

1027 
k
 = 
i
;

1028 
j
=
i
; j<
num_ªf_idx_lX_a˘ive
; j++)

1030 i‡(
deÁu…_‹dî
[
j
] !
ª_‹dî
[
i
])

1032 ++
k
;

1033 
tmp_ª‹dî
[
k
] = 
deÁu…_‹dî
[
j
];

1036 
ª‹dî_°›
 = 1;

1037 
j
=
i
+1; j<
num_ªf_idx_lX_a˘ive
; j++)

1039 i‡(
tmp_ª‹dî
[
j
] !
ª_‹dî
[j])

1041 
ª‹dî_°›
 = 0;

1046 i‡(
ª‹dî_°›
==1)

1048 ++
i
;

1051 
	`mem˝y
 ( 
deÁu…_‹dî
, 
tmp_ª‹dî
, 
num_ªf_idx_lX_a˘ive
 * ());

1054 
modifiˇti⁄_of_pic_nums_idc
[
i
] = 3;

1056 
	`mem˝y
 ( 
deÁu…_‹dî
, 
tmp_ª‹dî
, 
num_ªf_idx_lX_a˘ive
 * ());

1058 i‡(
li°_no
==0)

1060 
cuºSli˚
->
ªf_pic_li°_ª‹dîög_Êag
[
LIST_0
] = 1;

1064 
cuºSli˚
->
ªf_pic_li°_ª‹dîög_Êag
[
LIST_1
] = 1;

1067 
	}
}

1077 
	$ª‹dî_li°s_dummy
–
Sli˚
 *
cuºSli˚
 )

1079 
	}
}

1088 
	$ª‹dî_li°s
–
Sli˚
 *
cuºSli˚
 )

1090 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºSli˚
->p_Inp;

1093 i‡–
p_I≈
->
Re„ªn˚Re‹dî
 && (
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
 || cuºSli˚->¶i˚_ty≥ =
SP_SLICE
))

1095 
i
, 
num_ªf
;

1097 
i
 = 0; i < 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
] + 1; i++)

1099 
cuºSli˚
->
modifiˇti⁄_of_pic_nums_idc
[
LIST_0
][
i
] = 3;

1100 
cuºSli˚
->
abs_diff_pic_num_möus1
[
LIST_0
][
i
] = 0;

1101 
cuºSli˚
->
l⁄g_ãrm_pic_idx
[
LIST_0
][
i
] = 0;

1104 
num_ªf
 = 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
];

1106 i‡–
p_I≈
->
Re„ªn˚Re‹dî
 == 2 )

1108 i‡–
cuºSli˚
->
°ru˘uª
 =
FRAME
 )

1109 
cuºSli˚
->
	`poc_ªf_pic_ª‹dî_‰ame
(cuºSli˚, 
num_ªf
, 
LIST_0
);

1113 i‡–
cuºSli˚
->
°ru˘uª
 =
FRAME
 )

1114 
cuºSli˚
->
	`poc_ªf_pic_ª‹dî_‰ame
(cuºSli˚, 
num_ªf
, 
LIST_0
);

1117 
	`poc_ªf_pic_ª‹dî_fõld_íh
(
cuºSli˚
, 
num_ªf
, 
LIST_0
);

1121 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
] = cuºSli˚->
li°Xsize
[0];

1123 i‡(
p_I≈
->
Re„ªn˚Re‹dî
 > 1)

1125 
	`‰ì_ªf_pic_li°_ª‹dîög_buf„r
(
cuºSli˚
);

1126 
	`Æloc_ªf_pic_li°_ª‹dîög_buf„r
(
cuºSli˚
);

1127 
	`ª‹dî_ªf_pic_li°
 ( 
cuºSli˚
, 
LIST_0
);

1130 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
] = cuºSli˚->
li°Xsize
[0];

1132 #i‡
KEEP_B_SAME_LIST


1133 i‡–
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
 && cuºSli˚->
p_Dpb
->
ªf_‰ames_ö_buf„r
 >= 2 )

1135 
iSídAddti⁄ÆRPLR
 = 0;

1136 
iSídAddti⁄ÆRPLR
 = ( 
p_I≈
->
BIdítiˇlLi°
 =1 && ( (
cuºSli˚
->
ThisPOC
/2Ë% (p_I≈->
NumbîBFømes
+1) ) == 0 ) ||

1137 –
p_I≈
->
BIdítiˇlLi°
 == 2 );

1139 i‡–
iSídAddti⁄ÆRPLR
 )

1141 
i
, 
diff_num
, 
œ°_‰ame_num
;

1143 
	`Æloc_ªf_pic_li°_ª‹dîög_buf„r
(
cuºSli˚
);

1145 
i
 = 0; i < 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_1
] + 1; i++)

1147 
cuºSli˚
->
modifiˇti⁄_of_pic_nums_idc
[
LIST_1
][
i
] = 3;

1148 
cuºSli˚
->
abs_diff_pic_num_möus1
[
LIST_1
][
i
] = 0;

1149 
cuºSli˚
->
l⁄g_ãrm_pic_idx
[
LIST_1
][
i
] = 0;

1152 
œ°_‰ame_num
 = 
cuºSli˚
->
‰ame_num
;

1153  
i
=0; i<
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_1
]; i++ )

1155 
diff_num
 = 
cuºSli˚
->
li°X
[
LIST_0
][
i
]->
‰ame_num
 - 
œ°_‰ame_num
;

1156 
œ°_‰ame_num
 = 
cuºSli˚
->
li°X
[
LIST_0
][
i
]->
‰ame_num
;

1157 i‡–
diff_num
 <= 0 )

1159 
cuºSli˚
->
modifiˇti⁄_of_pic_nums_idc
[
LIST_1
][
i
] = 0;

1160 
cuºSli˚
->
abs_diff_pic_num_möus1
[
LIST_1
][
i
] = 
	`übs
(
diff_num
) - 1;

1161 i‡–
cuºSli˚
->
abs_diff_pic_num_möus1
[
LIST_1
][
i
] < 0 )

1163 
cuºSli˚
->
abs_diff_pic_num_möus1
[
LIST_1
][
i
] = cuºSli˚->
max_‰ame_num
 - 1;

1168 
cuºSli˚
->
modifiˇti⁄_of_pic_nums_idc
[
LIST_1
][
i
] = 1;

1169 
cuºSli˚
->
abs_diff_pic_num_möus1
[
LIST_1
][
i
] = 
	`übs
(
diff_num
) - 1;

1173 
cuºSli˚
->
ªf_pic_li°_ª‹dîög_Êag
[
LIST_1
] = 1;

1174 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_1
] = cuºSli˚->
li°Xsize
[1];

1175 
	`ª‹dî_ªf_pic_li°
 ( 
cuºSli˚
, 
LIST_1
);

1176 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_1
] = cuºSli˚->
li°Xsize
[1];

1183 #i‡
CRA


1184 i‡–
p_I≈
->
u£CRA
 )

1186 i‡–
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
 && cuºSli˚->
p_Dpb
->
ªf_‰ames_ö_buf„r
 >= 2 )

1188 i‡––(
cuºSli˚
->
ThisPOC
/2Ë- (
p_I≈
->
NumbîBFømes
+1ËË%Ö_I≈->
öåa_≥riod
 == 0 )

1190 
i
, 
diff_num
;

1191 
	`Æloc_ªf_pic_li°_ª‹dîög_buf„r
(
cuºSli˚
);

1192 
i
 = 0; i < 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_1
] + 1; i++)

1194 
cuºSli˚
->
modifiˇti⁄_of_pic_nums_idc
[
LIST_1
][
i
] = 3;

1195 
cuºSli˚
->
abs_diff_pic_num_möus1
[
LIST_1
][
i
] = 0;

1196 
cuºSli˚
->
l⁄g_ãrm_pic_idx
[
LIST_1
][
i
] = 0;

1199 
diff_num
 = 
cuºSli˚
->
li°X
[
LIST_0
][0]->
‰ame_num
 - currSlice->frame_num;

1200 i‡–
diff_num
 <= 0 )

1202 
cuºSli˚
->
modifiˇti⁄_of_pic_nums_idc
[
LIST_1
][0] = 0;

1203 
cuºSli˚
->
abs_diff_pic_num_möus1
[
LIST_1
][0] = 
	`übs
(
diff_num
) - 1;

1204 i‡–
cuºSli˚
->
abs_diff_pic_num_möus1
[
LIST_1
][0] < 0 )

1206 
cuºSli˚
->
abs_diff_pic_num_möus1
[
LIST_1
][0] = cuºSli˚->
max_‰ame_num
 - 1;

1211 
cuºSli˚
->
modifiˇti⁄_of_pic_nums_idc
[
LIST_1
][0] = 1;

1212 
cuºSli˚
->
abs_diff_pic_num_möus1
[
LIST_1
][0] = 
	`übs
(
diff_num
) - 1;

1215 
cuºSli˚
->
ªf_pic_li°_ª‹dîög_Êag
[
LIST_1
] = 1;

1216 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_1
] = cuºSli˚->
li°Xsize
[1];

1217 
	`ª‹dî_ªf_pic_li°
 ( 
cuºSli˚
, 
LIST_1
);

1218 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_1
] = cuºSli˚->
li°Xsize
[1];

1223 
	}
}

1232 
	$wp_m˝ªc_ª‹dî_li°s
–
Sli˚
 *
cuºSli˚
 )

1235 
i
, 
num_ªf
;

1237 
	`wpxModifyRefPicLi°
–
cuºSli˚
 );

1239 
	`Æloc_ªf_pic_li°_ª‹dîög_buf„r
(
cuºSli˚
);

1241 
i
 = 0; i < 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
] + 1; i++)

1243 
cuºSli˚
->
modifiˇti⁄_of_pic_nums_idc
[
LIST_0
][
i
] = 3;

1244 
cuºSli˚
->
abs_diff_pic_num_möus1
[
LIST_0
][
i
] = 0;

1245 
cuºSli˚
->
l⁄g_ãrm_pic_idx
[
LIST_0
][
i
] = 0;

1248 i‡(
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
)

1250 
i
 = 0; i < 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_1
] + 1; i++)

1252 
cuºSli˚
->
modifiˇti⁄_of_pic_nums_idc
[
LIST_1
][
i
] = 3;

1253 
cuºSli˚
->
abs_diff_pic_num_möus1
[
LIST_1
][
i
] = 0;

1254 
cuºSli˚
->
l⁄g_ãrm_pic_idx
[
LIST_1
][
i
] = 0;

1259 
num_ªf
 = 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
];

1261 
cuºSli˚
->
	`poc_ªf_pic_ª‹dî_‰ame
(cuºSli˚, 
num_ªf
, 
LIST_0
);

1263 
	`ª‹dî_ªf_pic_li°
 ( 
cuºSli˚
, 
LIST_0
);

1265 i‡–
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
 )

1268 
num_ªf
 = 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_1
];

1270 
cuºSli˚
->
	`poc_ªf_pic_ª‹dî_‰ame
(cuºSli˚, 
num_ªf
, 
LIST_1
);

1272 
	`ª‹dî_ªf_pic_li°
 ( 
cuºSli˚
, 
LIST_1
);

1274 
	}
}

1276 
	$£t_deÁu…_ªf_pic_li°s
(
Sli˚
 *
cuºSli˚
)

1278 
li°
, 
ªf
;

1280 
li°
 = 
LIST_0
;Üi° <(
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
 ? LIST_0:
LIST_1
);Üist++)

1282 
ªf
 = 0;Ñe‡< 
cuºSli˚
->
li°Xsize
[
li°
];Ñef++)

1284 
cuºSli˚
->
deÁu…_pic_num
[
li°
][
ªf
] = cuºSli˚->
li°X
[li°][ªf]->
pic_num
;

1285 #i‡
MVC_EXTENSION_ENABLE


1286 
cuºSli˚
->
deÁu…_võw_id
[
li°
][
ªf
] = cuºSli˚->
li°X
[li°][ªf]->
võw_id
;

1290 
	}
}

1292 
	$ª‹dî_agaö°_deÁu…_ªf_pic_li°s
(
Sli˚
 *
cuºSli˚
, 
cur_li°
)

1294 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

1295 *
modifiˇti⁄_of_pic_nums_idc
 = 
cuºSli˚
->modifiˇti⁄_of_pic_nums_idc[
cur_li°
];

1296 *
abs_diff_pic_num_möus1
 = 
cuºSli˚
->abs_diff_pic_num_möus1[
cur_li°
];

1297 #i‡
MVC_EXTENSION_ENABLE


1298 *
abs_diff_võw_idx_möus1
 = 
cuºSli˚
->abs_diff_võw_idx_möus1[
cur_li°
];

1299 
picVõwIdxLX
;

1301 
i
;

1303 
maxPicNum
, 
cuºPicNum
, 
picNumLXNoWøp
, 
picNumLXPªd
;

1304 
maxVõwIdx
 =0;

1305 
cuºVõwIdx
 = -1;

1306 
picVõwIdxLXPªd
=-1;

1308 
diff
;

1310 i‡(
p_Vid
->
°ru˘uª
==
FRAME
)

1312 
maxPicNum
 = 
p_Vid
->
max_‰ame_num
;

1313 
cuºPicNum
 = 
p_Vid
->
‰ame_num
;

1317 
maxPicNum
 = 2*
p_Vid
->
max_‰ame_num
;

1318 
cuºPicNum
 = 2*
p_Vid
->
‰ame_num
+1;

1321 
cuºVõwIdx
 = 
p_Vid
->
võw_id
;

1322 
maxVõwIdx
 = 1;

1323 
picVõwIdxLXPªd
=-1;

1325 
picNumLXPªd
 = 
cuºPicNum
;

1327 
cuºSli˚
->
ªf_pic_li°_ª‹dîög_Êag
[
cur_li°
] = 0;

1328 
i
 = 0; i < 
cuºSli˚
->
li°Xsize
[
cur_li°
]; i++)

1333 #i‡
MVC_EXTENSION_ENABLE


1334 
cuºSli˚
->
deÁu…_võw_id
[
cur_li°
][
i
] !cuºSli˚->
li°X
[cur_li°][i]->
võw_id
 ||

1336 
cuºSli˚
->
deÁu…_pic_num
[
cur_li°
][
i
] !cuºSli˚->
li°X
[cur_li°][i]->
pic_num
)

1338 
cuºSli˚
->
ªf_pic_li°_ª‹dîög_Êag
[
cur_li°
] = 1;

1343 if(!
cuºSli˚
->
ªf_pic_li°_ª‹dîög_Êag
[
cur_li°
])

1347 
i
 = 0; i < 
cuºSli˚
->
li°Xsize
[
cur_li°
]+1; i++)

1348 
modifiˇti⁄_of_pic_nums_idc
[
i
] = 3;

1350 
i
=0; i < 
cuºSli˚
->
li°Xsize
[
cur_li°
]; i++)

1352 
St‹abÀPi˘uª
 *
ªf_pic
 = 
cuºSli˚
->
li°X
[
cur_li°
][
i
];

1354 #i‡
MVC_EXTENSION_ENABLE


1355 if(
ªf_pic
->
võw_id
 !
cuºVõwIdx
)

1357 
diff
 = 1;

1359 
modifiˇti⁄_of_pic_nums_idc
[
i
] = 5;

1360 
abs_diff_võw_idx_möus1
[
i
] = 
	`übs
(
diff
)-1;

1366 
diff
 = 
ªf_pic
->
pic_num
-
picNumLXPªd
;

1367 i‡(
diff
 <= 0)

1369 
modifiˇti⁄_of_pic_nums_idc
[
i
] = 0;

1370 
abs_diff_pic_num_möus1
[
i
] = 
	`übs
(
diff
)-1;

1371 i‡(
abs_diff_pic_num_möus1
[
i
] < 0)

1372 
abs_diff_pic_num_möus1
[
i
] = 
maxPicNum
-1;

1376 
modifiˇti⁄_of_pic_nums_idc
[
i
] = 1;

1377 
abs_diff_pic_num_möus1
[
i
] = 
	`übs
(
diff
)-1;

1381 i‡(
modifiˇti⁄_of_pic_nums_idc
[
i
] == 0 || modification_of_pic_nums_idc[i] == 1)

1383 i‡(
modifiˇti⁄_of_pic_nums_idc
[
i
] == 0)

1385 if–
picNumLXPªd
 - ( 
abs_diff_pic_num_möus1
[
i
] + 1 ) < 0 )

1386 
picNumLXNoWøp
 = 
picNumLXPªd
 - ( 
abs_diff_pic_num_möus1
[
i
] + 1 ) + 
maxPicNum
;

1388 
picNumLXNoWøp
 = 
picNumLXPªd
 - ( 
abs_diff_pic_num_möus1
[
i
] + 1 );

1392 if–
picNumLXPªd
 + ( 
abs_diff_pic_num_möus1
[
i
] + 1 ) >
maxPicNum
 )

1393 
picNumLXNoWøp
 = 
picNumLXPªd
 + ( 
abs_diff_pic_num_möus1
[
i
] + 1 ) - 
maxPicNum
;

1395 
picNumLXNoWøp
 = 
picNumLXPªd
 + ( 
abs_diff_pic_num_möus1
[
i
] + 1 );

1397 
picNumLXPªd
 = 
picNumLXNoWøp
;

1399 #i‡
MVC_EXTENSION_ENABLE


1400 i‡(
modifiˇti⁄_of_pic_nums_idc
[
i
] == 4 || modification_of_pic_nums_idc[i] == 5)

1402 if(
modifiˇti⁄_of_pic_nums_idc
[
i
] == 4)

1404 
picVõwIdxLX
 = 
picVõwIdxLXPªd
 - (
abs_diff_võw_idx_möus1
[
i
] + 1);

1405 if–
picVõwIdxLX
 <0)

1406 
picVõwIdxLX
 +
maxVõwIdx
;

1410 
picVõwIdxLX
 = 
picVõwIdxLXPªd
 + (
abs_diff_võw_idx_möus1
[
i
] + 1);

1411 if–
picVõwIdxLX
 >
maxVõwIdx
)

1412 
picVõwIdxLX
 -
maxVõwIdx
;

1414 
picVõwIdxLXPªd
 = 
picVõwIdxLX
;

1418 
	}
}

	@lencod/src/lln_mc_prediction.c

16 
	~"globÆ.h
"

17 
	~"mbuf„r.h
"

18 
	~"mb_ac˚ss.h
"

19 
	~"ma¸oblock.h
"

20 
	~"îrdo.h
"

21 
	~"block.h
"

22 
	~"Œn_mc_¥edi˘i⁄.h
"

24 c⁄° 
	gCOEF
[6] = { 1, -5, 20, 20, -5, 1 };

31 
ölöe
 
	$mc_¥edi˘i⁄
(
img≥l
** 
mb_¥ed
,

32 
block_size_y
,

33 
block_size_x
,

34 
ioff
,

35 
img≥l
 
block
[
MB_BLOCK_SIZE
][MB_BLOCK_SIZE])

37 
jj
;

39 i‡(
block_size_x
 =
MB_BLOCK_SIZE
)

41 
	`mem˝y
(&(
mb_¥ed
[0][
ioff
]), &(
block
[0][0]), 
block_size_x
 * 
block_size_y
 * (
img≥l
));

45 
jj
 = 0; jj < 
block_size_y
; jj++)

47 
	`mem˝y
(&(
mb_¥ed
[
jj
][
ioff
]), &(
block
[jj][0]), 
block_size_x
 * (
img≥l
));

50 
	}
}

60 
ölöe
 
	$weighãd_mc_¥edi˘i⁄
(
img≥l
** 
mb_¥ed
,

61 
block_size_y
,

62 
block_size_x
,

63 
ioff
,

64 
img≥l
 
block
[
MB_BLOCK_SIZE
][MB_BLOCK_SIZE],

65 
wp_sˇÀ
,

66 
wp_off£t
,

67 
weight_díom
,

68 
cﬁ‹_˛ù
)

70 
ii
, 
jj
;

71 
img≥l
 *
m¥
, *
b0
;

73 
jj
=0;jj<
block_size_y
;jj++)

75 
m¥
 = &
mb_¥ed
[
jj
][
ioff
];

76 
b0
 = 
block
[
jj
];

77 
ii
=0;ii<
block_size_x
;ii++)

78 *(
m¥
++Ë(
img≥l
Ë
	`iClù1
(
cﬁ‹_˛ù
, (
	`rshi·_∫d
((
wp_sˇÀ
 * *(
b0
++)), 
weight_díom
Ë+ 
wp_off£t
 ));

80 
	}
}

89 
ölöe
 
	$bi_¥edi˘i⁄
(
img≥l
** 
mb_¥ed
,

90 
img≥l
 
block_l0
[
MB_BLOCK_SIZE
][MB_BLOCK_SIZE],

91 
img≥l
 
block_l1
[
MB_BLOCK_SIZE
][MB_BLOCK_SIZE],

92 
block_size_y
,

93 
block_size_x
,

94 
ioff
)

96 
ii
, 
jj
;

97 
img≥l
 *
m¥
, *
b0
, *
b1
;

99 
jj
 = 0;jj < 
block_size_y
;jj++)

101 
m¥
 = &
mb_¥ed
[
jj
][
ioff
];

102 
b0
 = 
block_l0
[
jj
];

103 
b1
 = 
block_l1
[
jj
];

104 
ii
 = 0; iò< 
block_size_x
;ii++)

105 *(
m¥
++Ë(
img≥l
Ë
	`rshi·_∫d_sf
((*(
b0
++Ë+ *(
b1
++)), 1);

107 
	}
}

115 
ölöe
 
	$weighãd_bi_¥edi˘i⁄
(
img≥l
** 
mb_¥ed
,

116 
img≥l
 
block_l0
[
MB_BLOCK_SIZE
][MB_BLOCK_SIZE],

117 
img≥l
 
block_l1
[
MB_BLOCK_SIZE
][MB_BLOCK_SIZE],

118 
block_size_y
,

119 
block_size_x
,

120 
ioff
,

121 
wp_sˇÀ_l0
,

122 
wp_sˇÀ_l1
,

123 
wp_off£t
,

124 
weight_díom
,

125 
cﬁ‹_˛ù
)

127 
ii
, 
jj
;

128 
img≥l
 *
m¥
, *
b0
, *
b1
;

130 
jj
 = 0; jj < 
block_size_y
; jj++)

132 
m¥
 = &
mb_¥ed
[
jj
][
ioff
];

133 
b0
 = 
block_l0
[
jj
];

134 
b1
 = 
block_l1
[
jj
];

136 
ii
=0;ii<
block_size_x
;ii++)

137 *(
m¥
++Ë(
img≥l
Ë
	`iClù1
(
cﬁ‹_˛ù
, (
	`rshi·_∫d
((
wp_sˇÀ_l0
 * *(
b0
++Ë+ 
wp_sˇÀ_l1
 * *(
b1
++)), 
weight_díom
Ë+ 
wp_off£t
));

139 
	}
}

141 
	$gë_block_luma
(
Ma¸oblock
 *
cuºMB
, 
decodî
, 
Cﬁ‹Pœ√
 
∂
, 
St‹abÀPi˘uª
* 
dec_pi˘uª
, St‹abÀPi˘uª *
cuº_ªf
, 
x_pos
, 
y_pos
, 
block_size_x
, 
block_size_y
, 
img≥l
 
block
[
MB_BLOCK_SIZE
][MB_BLOCK_SIZE])

143 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

144 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

146 
tmp_ªs
[21][21];

147 *
tmp_löe
;

148 
img≥l
 *
p0
, *
p1
, *
p2
, *
p3
, *
p4
, *
p5
;

149 *
x0
, *
x1
, *
x2
, *
x3
, *
x4
, *
x5
;

151 
img≥l
 **
cur_imgY
, *
cur_löeY
;

152 
ùos_m2
, 
ùos_m1
, 
ùos
, 
ùos_p1
, 
ùos_p2
, 
ùos_p3
;

153 
img≥l
 *
‹ig_löe
;

154 
tmp_pos
;

156 
dx
 = (
x_pos
 & 3), 
dy
 = (
y_pos
 & 3);

157 
i
, 
j
, 
jj
;

158 
shi·_x
 = 
dec_pi˘uª
->
size_x
;

159 
maxﬁd_x
 = 
dec_pi˘uª
->
size_x
 - 1;

160 
maxﬁd_y
 = (
cuºMB
->
mb_fõld
Ë? (
dec_pi˘uª
->
size_y
 >> 1) - 1 : dec_picture->size_y - 1;

161 
ªsu…
;

162 
¥es_x
;

163 
max_img≥l_vÆue
 = 
p_Vid
->
max_≥l_vÆue_comp
[
∂
];

165 if–(
p_I≈
->
£∑øã_cﬁour_∂™e_Êag
 != 0) )

167 
cur_imgY
 = 
cuº_ªf
->
de_mem
->
p_dec_img
[(Ë
p_Vid
->
cﬁour_∂™e_id
][
decodî
];

171 
cur_imgY
 = 
cuº_ªf
->
de_mem
->
p_dec_img
[
∂
][
decodî
];

174 
x_pos
 = x_pos >> 2;

175 
y_pos
 = y_pos >> 2;

177 i‡–(
y_pos
 > 1Ë&& (y_po†< 
maxﬁd_y
 - 2 - 
block_size_y
Ë&& (
x_pos
 > 1Ë&& (x_po†< 
maxﬁd_x
 - 2 - 
block_size_x
))

179 
cur_imgY
 = &cur_imgY[ 
y_pos
];

180 i‡(
dx
 =0 && 
dy
 == 0)

182 
j
 = 0; j < 
block_size_y
; j++)

184 
	`mem˝y
(&(
block
[
j
][0]), &(
cur_imgY
[j][
x_pos
]), 
block_size_x
 * (
img≥l
));

190 i‡(
dy
 == 0)

192 
j
 = 0; j < 
block_size_y
; j++)

194 
p0
 = &
cur_imgY
[
j
][
x_pos
 - 2];

195 
p1
 = 
p0
 + 1;

196 
p2
 = 
p1
 + 1;

197 
p3
 = 
p2
 + 1;

198 
p4
 = 
p3
 + 1;

199 
p5
 = 
p4
 + 1;

200 
‹ig_löe
 = 
block
[
j
];

202 
i
 = 0; i < 
block_size_x
; i++)

204 
ªsu…
 = (*(
p0
++Ë+ *(
p5
++)Ë* 
COEF
[0]

205 + (*(
p1
++Ë+ *(
p4
++)Ë* 
COEF
[1]

206 + (*(
p2
++Ë+ *(
p3
++)Ë* 
COEF
[2];

208 *
‹ig_löe
++ = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((
ªsu…
 + 16)>>5));

212 i‡((
dx
&1) == 1)

214 
j
 = 0; j < 
block_size_y
; j++)

216 
cur_löeY
 = &(
cur_imgY
[
j
][
x_pos
 + (
dx
 >> 1)]);

217 
‹ig_löe
 = 
block
[
j
];

218 
i
 = 0; i < 
block_size_x
; i++)

220 *
‹ig_löe
 = (
img≥l
Ë((*‹ig_löê+ *(
cur_löeY
++) + 1 ) >> 1);

221 
‹ig_löe
++;

226 i‡(
dx
 == 0)

228 
p0
 = &(
cur_imgY
[ - 2][
x_pos
]);

229 
j
 = 0; j < 
block_size_y
; j++)

231 
p1
 = 
p0
 + 
shi·_x
;

232 
p2
 = 
p1
 + 
shi·_x
;

233 
p3
 = 
p2
 + 
shi·_x
;

234 
p4
 = 
p3
 + 
shi·_x
;

235 
p5
 = 
p4
 + 
shi·_x
;

236 
‹ig_löe
 = 
block
[
j
];

238 
i
 = 0; i < 
block_size_x
; i++)

240 
ªsu…
 = (*(
p0
++Ë+ *(
p5
++)Ë* 
COEF
[0]

241 + (*(
p1
++Ë+ *(
p4
++)Ë* 
COEF
[1]

242 + (*(
p2
++Ë+ *(
p3
++)Ë* 
COEF
[2];

244 *
‹ig_löe
++ = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((
ªsu…
 + 16)>>5));

246 
p0
 = 
p1
 - 
block_size_x
;

249 i‡((
dy
&1) == 1)

251 
jj
 = (
dy
 >> 1);

252 
j
 = 0; j < 
block_size_y
; j++)

254 
cur_löeY
 = &(
cur_imgY
[
jj
++][
x_pos
]);

255 
‹ig_löe
 = 
block
[
j
];

256 
i
 = 0; i < 
block_size_x
; i++)

258 *
‹ig_löe
 = (
img≥l
Ë((*‹ig_löê+ *(
cur_löeY
++) + 1 ) >> 1);

259 
‹ig_löe
++;

264 i‡(
dx
 == 2)

266 
jj
 = - 2;

267 
j
 = 0; j < 
block_size_y
 + 5; j++)

269 
p0
 = &
cur_imgY
[
jj
++][
x_pos
 - 2];

270 
p1
 = 
p0
 + 1;

271 
p2
 = 
p1
 + 1;

272 
p3
 = 
p2
 + 1;

273 
p4
 = 
p3
 + 1;

274 
p5
 = 
p4
 + 1;

275 
‹ig_löe
 = 
block
[
j
];

276 
tmp_löe
 = 
tmp_ªs
[
j
];

278 
i
 = 0; i < 
block_size_x
; i++)

280 *(
tmp_löe
++Ë(*(
p0
++Ë+ *(
p5
++)Ë* 
COEF
[0]

281 + (*(
p1
++Ë+ *(
p4
++)Ë* 
COEF
[1]

282 + (*(
p2
++Ë+ *(
p3
++)Ë* 
COEF
[2];

286 
j
 = 0; j < 
block_size_y
; j++)

288 
x0
 = 
tmp_ªs
[
j
 ];

289 
x1
 = 
tmp_ªs
[
j
 + 1];

290 
x2
 = 
tmp_ªs
[
j
 + 2];

291 
x3
 = 
tmp_ªs
[
j
 + 3];

292 
x4
 = 
tmp_ªs
[
j
 + 4];

293 
x5
 = 
tmp_ªs
[
j
 + 5];

294 
‹ig_löe
 = 
block
[
j
];

296 
i
 = 0; i < 
block_size_x
; i++)

298 
ªsu…
 = (*
x0
++ + *
x5
++Ë* 
COEF
[0]

299 + (*
x1
++ + *
x4
++Ë* 
COEF
[1]

300 + (*
x2
++ + *
x3
++Ë* 
COEF
[2];

302 *(
‹ig_löe
++Ë(
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((
ªsu…
+512)>>10));

306 i‡((
dy
&1) == 1)

308 
jj
 = 2 + (
dy
>>1);

309 
j
 = 0; j < 
block_size_y
; j++)

311 
tmp_löe
 = 
tmp_ªs
[
jj
++];

312 
‹ig_löe
 = 
block
[
j
];

313 
i
 = 0; i < 
block_size_x
; i++)

315 *
‹ig_löe
 = (
img≥l
Ë((*‹ig_löê+ 
	`iClù1
(
max_img≥l_vÆue
, ((*(
tmp_löe
++) + 16) >> 5)) + 1 )>> 1);

316 
‹ig_löe
++;

321 i‡(
dy
 == 2)

323 
p0
 = &(
cur_imgY
[ -2][
x_pos
 - 2]);

324 
j
 = 0; j < 
block_size_y
; j++)

326 
p1
 = 
p0
 + 
shi·_x
;

327 
p2
 = 
p1
 + 
shi·_x
;

328 
p3
 = 
p2
 + 
shi·_x
;

329 
p4
 = 
p3
 + 
shi·_x
;

330 
p5
 = 
p4
 + 
shi·_x
;

331 
tmp_löe
 = 
tmp_ªs
[
j
];

333 
i
 = 0; i < 
block_size_x
 + 5; i++)

335 *(
tmp_löe
++Ë(*(
p0
++Ë+ *(
p5
++)Ë* 
COEF
[0]

336 + (*(
p1
++Ë+ *(
p4
++)Ë* 
COEF
[1]

337 + (*(
p2
++Ë+ *(
p3
++)Ë* 
COEF
[2];

339 
p0
 = 
p1
 - (
block_size_x
 + 5);

342 
j
 = 0; j < 
block_size_y
; j++)

344 
‹ig_löe
 = 
block
[
j
];

345 
x0
 = 
tmp_ªs
[
j
];

346 
x1
 = 
x0
 + 1;

347 
x2
 = 
x1
 + 1;

348 
x3
 = 
x2
 + 1;

349 
x4
 = 
x3
 + 1;

350 
x5
 = 
x4
 + 1;

352 
i
 = 0; i < 
block_size_x
; i++)

354 
ªsu…
 = (*(
x0
++Ë+ *(
x5
++)Ë* 
COEF
[0]

355 + (*(
x1
++Ë+ *(
x4
++)Ë* 
COEF
[1]

356 + (*(
x2
++Ë+ *(
x3
++)Ë* 
COEF
[2];

358 *(
‹ig_löe
++Ë(
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((
ªsu…
 + 512)>>10));

362 i‡((
dx
&1) == 1)

364 
j
 = 0; j < 
block_size_y
; j++)

366 
tmp_löe
 = &
tmp_ªs
[
j
][2 + (
dx
>>1)];

367 
‹ig_löe
 = 
block
[
j
];

368 
i
 = 0; i < 
block_size_x
; i++)

370 *
‹ig_löe
 = (
img≥l
Ë((*‹ig_löê+ 
	`iClù1
(
max_img≥l_vÆue
, ((*(
tmp_löe
++) + 16)>>5))+1)>>1);

371 
‹ig_löe
 ++;

378 
jj
 = (
dy
 == 1 ? 0 : 1);

380 
j
 = 0; j < 
block_size_y
; j++)

382 
p0
 = &
cur_imgY
[
jj
++][
x_pos
 - 2];

383 
p1
 = 
p0
 + 1;

384 
p2
 = 
p1
 + 1;

385 
p3
 = 
p2
 + 1;

386 
p4
 = 
p3
 + 1;

387 
p5
 = 
p4
 + 1;

389 
‹ig_löe
 = 
block
[
j
];

391 
i
 = 0; i < 
block_size_x
; i++)

393 
ªsu…
 = (*(
p0
++Ë+ *(
p5
++)Ë* 
COEF
[0]

394 + (*(
p1
++Ë+ *(
p4
++)Ë* 
COEF
[1]

395 + (*(
p2
++Ë+ *(
p3
++)Ë* 
COEF
[2];

397 *(
‹ig_löe
++Ë(
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((
ªsu…
 + 16)>>5));

401 
p0
 = &(
cur_imgY
[-2][(
dx
 =1 ? 
x_pos
 : x_pos + 1)]);

402 
j
 = 0; j < 
block_size_y
; j++)

404 
p1
 = 
p0
 + 
shi·_x
;

405 
p2
 = 
p1
 + 
shi·_x
;

406 
p3
 = 
p2
 + 
shi·_x
;

407 
p4
 = 
p3
 + 
shi·_x
;

408 
p5
 = 
p4
 + 
shi·_x
;

409 
‹ig_löe
 = 
block
[
j
];

411 
i
 = 0; i < 
block_size_x
; i++)

413 
ªsu…
 = (*(
p0
++Ë+ *(
p5
++)Ë* 
COEF
[0]

414 + (*(
p1
++Ë+ *(
p4
++)Ë* 
COEF
[1]

415 + (*(
p2
++Ë+ *(
p3
++)Ë* 
COEF
[2];

417 *
‹ig_löe
 = (
img≥l
Ë((*‹ig_löê+ 
	`iClù1
(
max_img≥l_vÆue
, ((
ªsu…
 + 16) >> 5)) + 1) >> 1);

418 
‹ig_löe
++;

420 
p0
 = 
p1
 - 
block_size_x
 ;

427 i‡(
dx
 =0 && 
dy
 == 0)

429 
j
 = 0; j < 
block_size_y
; j++)

431 
cur_löeY
 = 
cur_imgY
[
	`iClù3
(0, 
maxﬁd_y
, 
y_pos
 + 
j
)];

432 
‹ig_löe
 = 
block
[
j
];

433 
i
 = 0; i < 
block_size_x
; i++)

435 *(
‹ig_löe
++Ë
cur_löeY
[
	`iClù3
(0, 
maxﬁd_x
, 
x_pos
 + 
i
 )];

442 i‡(
dy
 == 0)

444 
tmp_pos
 = 
x_pos
 - 2;

445 
i
 = 0; i < 
block_size_x
; i++)

447 
ùos_m2
 = 
	`iClù3
(0, 
maxﬁd_x
, 
tmp_pos
++);

448 
ùos_m1
 = 
	`iClù3
(0, 
maxﬁd_x
, 
tmp_pos
++);

449 
ùos
 = 
	`iClù3
(0, 
maxﬁd_x
, 
tmp_pos
++);

450 
ùos_p1
 = 
	`iClù3
(0, 
maxﬁd_x
, 
tmp_pos
++);

451 
ùos_p2
 = 
	`iClù3
(0, 
maxﬁd_x
, 
tmp_pos
++);

452 
ùos_p3
 = 
	`iClù3
(0, 
maxﬁd_x
, 
tmp_pos
 );

453 
tmp_pos
 -= 4;

455 
j
 = 0; j < 
block_size_y
; j++)

457 
cur_löeY
 = 
cur_imgY
[
	`iClù3
(0,
maxﬁd_y
,
y_pos
+
j
)];

459 
ªsu…
 = (
cur_löeY
[
ùos_m2
] + cur_löeY[
ùos_p3
]Ë* 
COEF
[0];

460 
ªsu…
 +(
cur_löeY
[
ùos_m1
] + cur_löeY[
ùos_p2
]Ë* 
COEF
[1];

461 
ªsu…
 +(
cur_löeY
[
ùos
 ] + cur_löeY[
ùos_p1
]Ë* 
COEF
[2];

463 
block
[
j
][
i
] = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((
ªsu…
 + 16)>>5));

467 i‡((
dx
&1) == 1)

469 
j
 = 0; j < 
block_size_y
; j++)

471 
cur_löeY
 = 
cur_imgY
[
	`iClù3
(0,
maxﬁd_y
,
y_pos
+
j
)];

472 
‹ig_löe
 = 
block
[
j
];

473 
i
 = 0; i < 
block_size_x
; i++)

475 *
‹ig_löe
 = (
img≥l
Ë((*‹ig_löê+ 
cur_löeY
[
	`iClù3
(0, 
maxﬁd_x
, 
x_pos
 + 
i
 + (
dx
 >> 1))] + 1 ) >> 1);

476 
‹ig_löe
++;

481 i‡(
dx
 == 0)

483 
tmp_pos
 = 
y_pos
 - 2;

484 
j
 = 0; j < 
block_size_y
; j++)

486 
p0
 = 
cur_imgY
[
	`iClù3
(0, 
maxﬁd_y
, 
tmp_pos
++)];

487 
p1
 = 
cur_imgY
[
	`iClù3
(0, 
maxﬁd_y
, 
tmp_pos
++)];

488 
p2
 = 
cur_imgY
[
	`iClù3
(0, 
maxﬁd_y
, 
tmp_pos
++)];

489 
p3
 = 
cur_imgY
[
	`iClù3
(0, 
maxﬁd_y
, 
tmp_pos
++)];

490 
p4
 = 
cur_imgY
[
	`iClù3
(0, 
maxﬁd_y
, 
tmp_pos
++)];

491 
p5
 = 
cur_imgY
[
	`iClù3
(0, 
maxﬁd_y
, 
tmp_pos
 )];

493 
tmp_pos
 -= 4;

494 
‹ig_löe
 = 
block
[
j
];

496 
i
 = 0; i < 
block_size_x
; i++)

498 
¥es_x
 = 
	`iClù3
(0,
maxﬁd_x
,
x_pos
+
i
);

500 
ªsu…
 = (
p0
[
¥es_x
] + 
p5
[¥es_x]Ë* 
COEF
[0];

501 
ªsu…
 +(
p1
[
¥es_x
] + 
p4
[¥es_x]Ë* 
COEF
[1];

502 
ªsu…
 +(
p2
[
¥es_x
] + 
p3
[¥es_x]Ë* 
COEF
[2];

503 *(
‹ig_löe
++Ë(
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((
ªsu…
+16)>>5));

507 i‡((
dy
&1) == 1)

509 
j
 = 0; j < 
block_size_y
; j++)

511 
cur_löeY
 = 
cur_imgY
[
	`iClù3
(0,
maxﬁd_y
,
y_pos
+
j
+(
dy
>>1))];

512 
‹ig_löe
 = 
block
[
j
];

513 
i
 = 0; i < 
block_size_x
; i++)

515 *
‹ig_löe
 = (
img≥l
Ë((*‹ig_löê+ 
cur_löeY
[
	`iClù3
(0, 
maxﬁd_x
, 
x_pos
 + 
i
)] + 1 ) >> 1);

516 
‹ig_löe
++;

521 i‡(
dx
 == 2)

523 
tmp_pos
 = 
x_pos
 - 2;

524 
i
 = 0; i < 
block_size_x
; i++)

526 
ùos_m2
 = 
	`iClù3
(0, 
maxﬁd_x
, 
tmp_pos
++);

527 
ùos_m1
 = 
	`iClù3
(0, 
maxﬁd_x
, 
tmp_pos
++);

528 
ùos
 = 
	`iClù3
(0, 
maxﬁd_x
, 
tmp_pos
++);

529 
ùos_p1
 = 
	`iClù3
(0, 
maxﬁd_x
, 
tmp_pos
++);

530 
ùos_p2
 = 
	`iClù3
(0, 
maxﬁd_x
, 
tmp_pos
++);

531 
ùos_p3
 = 
	`iClù3
(0, 
maxﬁd_x
, 
tmp_pos
 );

532 
tmp_pos
 -= 4;

534 
j
 = 0; j < 
block_size_y
 + 5; j++)

536 
cur_löeY
 = 
cur_imgY
[
	`iClù3
(0,
maxﬁd_y
,
y_pos
 + 
j
 - 2)];

538 
tmp_ªs
[
j
][
i
] = (
cur_löeY
[
ùos_m2
] + cur_löeY[
ùos_p3
]Ë* 
COEF
[0];

539 
tmp_ªs
[
j
][
i
] +(
cur_löeY
[
ùos_m1
] + cur_löeY[
ùos_p2
]Ë* 
COEF
[1];

540 
tmp_ªs
[
j
][
i
] +(
cur_löeY
[
ùos
 ] + cur_löeY[
ùos_p1
]Ë* 
COEF
[2];

544 
j
 = 0; j < 
block_size_y
; j++)

546 
x0
 = 
tmp_ªs
[
j
 ];

547 
x1
 = 
tmp_ªs
[
j
 + 1];

548 
x2
 = 
tmp_ªs
[
j
 + 2];

549 
x3
 = 
tmp_ªs
[
j
 + 3];

550 
x4
 = 
tmp_ªs
[
j
 + 4];

551 
x5
 = 
tmp_ªs
[
j
 + 5];

552 
‹ig_löe
 = 
block
[
j
];

554 
i
 = 0; i < 
block_size_x
; i++)

556 
ªsu…
 = (*
x0
++ + *
x5
++Ë* 
COEF
[0]

557 + (*
x1
++ + *
x4
++Ë* 
COEF
[1]

558 + (*
x2
++ + *
x3
++Ë* 
COEF
[2];

560 *(
‹ig_löe
++Ë(
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((
ªsu…
+512)>>10));

564 i‡((
dy
&1) == 1)

566 
j
 = 0; j < 
block_size_y
; j++)

568 
tmp_löe
 = 
tmp_ªs
[
j
 + 2 + (
dy
>>1)];

569 
‹ig_löe
 = 
block
[
j
];

570 
i
 = 0; i < 
block_size_x
; i++)

572 *
‹ig_löe
 = (
img≥l
Ë((*‹ig_löê+ 
	`iClù1
(
max_img≥l_vÆue
, ((*(
tmp_löe
++) + 16) >> 5)) + 1 )>>1);

573 
‹ig_löe
++;

578 i‡(
dy
 == 2)

581 
tmp_pos
 = 
y_pos
 - 2;

582 
j
 = 0; j < 
block_size_y
; j++)

584 
p0
 = 
cur_imgY
[
	`iClù3
(0, 
maxﬁd_y
, 
tmp_pos
++)];

585 
p1
 = 
cur_imgY
[
	`iClù3
(0, 
maxﬁd_y
, 
tmp_pos
++)];

586 
p2
 = 
cur_imgY
[
	`iClù3
(0, 
maxﬁd_y
, 
tmp_pos
++)];

587 
p3
 = 
cur_imgY
[
	`iClù3
(0, 
maxﬁd_y
, 
tmp_pos
++)];

588 
p4
 = 
cur_imgY
[
	`iClù3
(0, 
maxﬁd_y
, 
tmp_pos
++)];

589 
p5
 = 
cur_imgY
[
	`iClù3
(0, 
maxﬁd_y
, 
tmp_pos
 )];

591 
tmp_pos
 -= 4;

593 
i
 = 0; i < 
block_size_x
 + 5; i++)

595 
¥es_x
 = 
	`iClù3
(0,
maxﬁd_x
, 
x_pos
 + 
i
 - 2);

596 
ªsu…
 = (
p0
[
¥es_x
] + 
p5
[¥es_x])*
COEF
[0]

597 + (
p1
[
¥es_x
] + 
p4
[¥es_x])*
COEF
[1]

598 + (
p2
[
¥es_x
] + 
p3
[¥es_x])*
COEF
[2];

599 
tmp_ªs
[
j
][
i
] = 
ªsu…
;

603 
j
 = 0; j < 
block_size_y
; j++)

605 
‹ig_löe
 = 
block
[
j
];

606 
tmp_löe
 = 
tmp_ªs
[
j
];

607 
x0
 = 
tmp_ªs
[
j
];

608 
x1
 = 
x0
 + 1;

609 
x2
 = 
x1
 + 1;

610 
x3
 = 
x2
 + 1;

611 
x4
 = 
x3
 + 1;

612 
x5
 = 
x4
 + 1;

614 
i
 = 0; i < 
block_size_x
; i++)

616 
ªsu…
 = (*(
x0
++Ë+ *(
x5
++)Ë* 
COEF
[0]

617 + (*(
x1
++Ë+ *(
x4
++)Ë* 
COEF
[1]

618 + (*(
x2
++Ë+ *(
x3
++)Ë* 
COEF
[2];

620 *(
‹ig_löe
++Ë(
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((
ªsu…
 + 512)>>10));

624 i‡((
dx
&1) == 1)

626 
j
 = 0; j < 
block_size_y
; j++)

628 
tmp_löe
 = &
tmp_ªs
[
j
][2 + (
dx
>>1)];

629 
‹ig_löe
 = 
block
[
j
];

630 
i
 = 0; i < 
block_size_x
; i++)

632 *
‹ig_löe
 = (
img≥l
Ë((*‹ig_löê+ 
	`iClù1
(
max_img≥l_vÆue
, ((*(
tmp_löe
++) + 16)>>5)) + 1)>> 1);

633 
‹ig_löe
++;

640 
tmp_pos
 = 
x_pos
 - 2;

641 
i
 = 0; i < 
block_size_x
; i++)

643 
ùos_m2
 = 
	`iClù3
(0, 
maxﬁd_x
, 
tmp_pos
++);

644 
ùos_m1
 = 
	`iClù3
(0, 
maxﬁd_x
, 
tmp_pos
++);

645 
ùos
 = 
	`iClù3
(0, 
maxﬁd_x
, 
tmp_pos
++);

646 
ùos_p1
 = 
	`iClù3
(0, 
maxﬁd_x
, 
tmp_pos
++);

647 
ùos_p2
 = 
	`iClù3
(0, 
maxﬁd_x
, 
tmp_pos
++);

648 
ùos_p3
 = 
	`iClù3
(0, 
maxﬁd_x
, 
tmp_pos
 );

649 
tmp_pos
 -= 4;

651 
j
 = 0; j < 
block_size_y
; j++)

653 
cur_löeY
 = 
cur_imgY
[
	`iClù3
(0,
maxﬁd_y
,(
dy
 =1 ? 
y_pos
+
j
 : y_pos+j+1))];

655 
ªsu…
 = (
cur_löeY
[
ùos_m2
] + cur_löeY[
ùos_p3
]Ë* 
COEF
[0];

656 
ªsu…
 +(
cur_löeY
[
ùos_m1
] + cur_löeY[
ùos_p2
]Ë* 
COEF
[1];

657 
ªsu…
 +(
cur_löeY
[
ùos
 ] + cur_löeY[
ùos_p1
]Ë* 
COEF
[2];

659 
block
[
j
][
i
] = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, ((
ªsu…
+16)>>5));

663 
tmp_pos
 = 
y_pos
 - 2;

664 
j
 = 0; j < 
block_size_y
; j++)

666 
p0
 = 
cur_imgY
[
	`iClù3
(0, 
maxﬁd_y
, 
tmp_pos
++)];

667 
p1
 = 
cur_imgY
[
	`iClù3
(0, 
maxﬁd_y
, 
tmp_pos
++)];

668 
p2
 = 
cur_imgY
[
	`iClù3
(0, 
maxﬁd_y
, 
tmp_pos
++)];

669 
p3
 = 
cur_imgY
[
	`iClù3
(0, 
maxﬁd_y
, 
tmp_pos
++)];

670 
p4
 = 
cur_imgY
[
	`iClù3
(0, 
maxﬁd_y
, 
tmp_pos
++)];

671 
p5
 = 
cur_imgY
[
	`iClù3
(0, 
maxﬁd_y
, 
tmp_pos
 )];

673 
tmp_pos
 -= 4;

674 
‹ig_löe
 = 
block
[
j
];

676 
i
 = 0; i < 
block_size_x
; i++)

678 
¥es_x
 = 
dx
 =1 ? 
x_pos
+
i
 : x_pos+i+1;

679 
¥es_x
 = 
	`iClù3
(0, 
maxﬁd_x
,Öres_x);

681 
ªsu…
 = (
p0
[
¥es_x
] + 
p5
[¥es_x]Ë* 
COEF
[0];

682 
ªsu…
 +(
p1
[
¥es_x
] + 
p4
[¥es_x]Ë* 
COEF
[1];

683 
ªsu…
 +(
p2
[
¥es_x
] + 
p3
[¥es_x]Ë* 
COEF
[2];

685 *
‹ig_löe
 = (
img≥l
Ë((*‹ig_löê+ 
	`iClù1
(
max_img≥l_vÆue
, ((
ªsu…
+16)>>5)) + 1 ) >> 1);

686 
‹ig_löe
++;

692 
	}
}

694 
	$gë_block_chroma
(
Ma¸oblock
 *
cuºMB
, 
decodî
, 
uv
, 
St‹abÀPi˘uª
* 
dec_pi˘uª
, St‹abÀPi˘uª *
cuº_ªf
, 
x_pos
, 
y_pos
, 
block_size_x
, 
block_size_y
, 
img≥l
 
block
[
MB_BLOCK_SIZE
][MB_BLOCK_SIZE])

696 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

697 
sub≥l_x
 = 
p_Vid
->
mb_¸_size_x
 == 8 ? 7 : 3;

698 
sub≥l_y
 = 
p_Vid
->
mb_¸_size_y
 == 8 ? 7 : 3;

699 
shi·≥l_x
 = 
p_Vid
->
mb_¸_size_x
 == 8 ? 3 : 2;

700 
shi·≥l_y
 = 
p_Vid
->
mb_¸_size_y
 == 8 ? 3 : 2;

701 
tŸÆ_sˇÀ
 = 
shi·≥l_x
 + 
shi·≥l_y
;

703 
dx
 = (
x_pos
 & 
sub≥l_x
);

704 
dy
 = (
y_pos
 & 
sub≥l_y
);

705 
dxcur
 = (
sub≥l_x
 + 1 - 
dx
);

706 
dycur
 = (
sub≥l_y
 + 1 - 
dy
);

708 
w00
 = 
dxcur
 * 
dycur
;

709 
w01
 = 
dxcur
 * 
dy
;

710 
w10
 = 
dx
 * 
dycur
;

711 
w11
 = 
dx
 * 
dy
;

713 
i
, 
j
;

714 
maxﬁd_x
 = 
dec_pi˘uª
->
size_x_¸
 - 1;

715 
maxﬁd_y
 = (
cuºMB
->
mb_fõld
Ë? (
dec_pi˘uª
->
size_y_¸
 >> 1) - 1 : dec_picture->size_y_cr - 1;

716 
ªsu…
;

718 
img≥l
 **
cur_img
, *
blk_löe
;

719 
img≥l
 *
cur_löe
, *
cur_löe_p1
;

720 
tmp_pos
;

721 
ùos
, 
ùos_p1
;

722 
max_img≥l_vÆue
 = 
p_Vid
->
max_≥l_vÆue_comp
[
uv
 + 1];

724 
cur_img
 = 
cuº_ªf
->
de_mem
->
p_dec_img
[
uv
+1][
decodî
];

726 
x_pos
 = x_po†>> 
shi·≥l_x
;

727 
y_pos
 = y_po†>> 
shi·≥l_y
;

729 i‡((
y_pos
 >0Ë&& (y_po†< 
maxﬁd_y
 - 
block_size_y
Ë&& (
x_pos
 >0Ë&& (x_po†< 
maxﬁd_x
 - 
block_size_x
))

731 i‡(
dx
 =0 && 
dy
 == 0)

733 
j
 = 0; j < 
block_size_y
; j++)

735 
	`mem˝y
(&(
block
[
j
][0]), &(
cur_img
[ 
y_pos
 + j ][
x_pos
]), 
block_size_x
 * (
img≥l
));

738 i‡(
dx
 == 0)

740 
j
 = 0; j < 
block_size_y
; j++)

742 
cur_löe
 = &
cur_img
[
y_pos
 + 
j
 ][
x_pos
];

743 
cur_löe_p1
 = &
cur_img
[
y_pos
 + 
j
 + 1][
x_pos
];

744 
blk_löe
 = 
block
[
j
];

746 
i
 = 0; i < 
block_size_x
; i++)

748 
ªsu…
 = (
w00
 * *
cur_löe
++ + 
w01
 * *
cur_löe_p1
++);

749 *(
blk_löe
++Ë(
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, 
	`rshi·_∫d_sf
(
ªsu…
, 
tŸÆ_sˇÀ
));

753 i‡(
dy
 == 0)

755 
j
 = 0; j < 
block_size_y
; j++)

757 
cur_löe
 = &
cur_img
[
y_pos
 + 
j
][
x_pos
];

758 
cur_löe_p1
 = 
cur_löe
 + 1;

759 
blk_löe
 = 
block
[
j
];

761 
i
 = 0; i < 
block_size_x
; i++)

763 
ªsu…
 = (
w00
 * *
cur_löe
++ + 
w10
 * *
cur_löe_p1
++);

764 *(
blk_löe
++Ë(
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, 
	`rshi·_∫d_sf
(
ªsu…
, 
tŸÆ_sˇÀ
));

770 
j
 = 0; j < 
block_size_y
; j++)

772 
cur_löe
 = &
cur_img
[
y_pos
 + 
j
 ][
x_pos
];

773 
cur_löe_p1
 = &
cur_img
[
y_pos
 + 
j
 + 1][
x_pos
];

774 
blk_löe
 = 
block
[
j
];

776 
i
 = 0; i < 
block_size_x
; i++)

778 
ªsu…
 = (
w00
 * *(
cur_löe
++Ë+ 
w01
 * *(
cur_löe_p1
++));

779 
ªsu…
 +(
w10
 * *(
cur_löe
 ) + 
w11
 * *(
cur_löe_p1
 ));

780 *(
blk_löe
++Ë(
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, 
	`rshi·_∫d_sf
(
ªsu…
, 
tŸÆ_sˇÀ
));

787 i‡(
dx
 =0 && 
dy
 == 0)

789 
j
 = 0; j < 
block_size_y
; j++)

791 
cur_löe
 = 
cur_img
[
	`iClù3
(0, 
maxﬁd_y
, 
y_pos
 + 
j
)];

792 
blk_löe
 = 
block
[
j
];

793 
i
 = 0; i < 
block_size_x
; i++)

795 *(
blk_löe
++Ë
cur_löe
[
	`iClù3
(0, 
maxﬁd_x
, 
x_pos
 + 
i
 )];

799 i‡(
dx
 == 0)

801 
j
 = 0; j < 
block_size_y
; j++)

803 
cur_löe
 = 
cur_img
[
	`iClù3
(0, 
maxﬁd_y
, 
y_pos
 + 
j
)];

804 
cur_löe_p1
 = 
cur_img
[
	`iClù3
(0, 
maxﬁd_y
, 
y_pos
 + 
j
 + 1)];

805 
tmp_pos
 = 
x_pos
;

806 
blk_löe
 = 
block
[
j
];

808 
i
 = 0; i < 
block_size_x
; i++)

810 
ùos
 = 
	`iClù3
(0, 
maxﬁd_x
, 
tmp_pos
++);

812 
ªsu…
 = (
w00
 * 
cur_löe
[
ùos
] + 
w01
 * 
cur_löe_p1
[ipos]);

813 *(
blk_löe
++Ë(
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, 
	`rshi·_∫d_sf
(
ªsu…
, 
tŸÆ_sˇÀ
));

817 i‡(
dy
 == 0)

819 
j
 = 0; j < 
block_size_y
; j++)

821 
cur_löe
 = 
cur_img
[
	`iClù3
(0, 
maxﬁd_y
, 
y_pos
 + 
j
)];

822 
tmp_pos
 = 
x_pos
;

823 
blk_löe
 = 
block
[
j
];

825 
i
 = 0; i < 
block_size_x
; i++)

827 
ùos
 = 
	`iClù3
(0, 
maxﬁd_x
, 
tmp_pos
++);

828 
ùos_p1
 = 
	`iClù3
(0, 
maxﬁd_x
, 
tmp_pos
 );

830 
ªsu…
 = (
w00
 * 
cur_löe
[
ùos
 ] + 
w10
 * cur_löe[
ùos_p1
]);

831 *(
blk_löe
++Ë(
img≥l
)
	`iClù1
(
max_img≥l_vÆue
, 
	`rshi·_∫d_sf
(
ªsu…
, 
tŸÆ_sˇÀ
));

837 
j
 = 0; j < 
block_size_y
; j++)

839 
cur_löe
 = 
cur_img
[
	`iClù3
(0, 
maxﬁd_y
, 
y_pos
 + 
j
)];

840 
cur_löe_p1
 = 
cur_img
[
	`iClù3
(0, 
maxﬁd_y
, 
y_pos
 + 
j
 + 1)];

841 
tmp_pos
 = 
x_pos
;

842 
blk_löe
 = 
block
[
j
];

844 
i
 = 0; i < 
block_size_x
; i++)

846 
ùos
 = 
	`iClù3
(0, 
maxﬁd_x
, 
tmp_pos
++);

847 
ùos_p1
 = 
	`iClù3
(0, 
maxﬁd_x
, 
tmp_pos
 );

849 
ªsu…
 = (

850 
w00
 * 
cur_löe
 [
ùos
 ] +

851 
w10
 * 
cur_löe
 [
ùos_p1
] +

852 
w01
 * 
cur_löe_p1
[
ùos
 ] +

853 
w11
 * 
cur_löe_p1
[
ùos_p1
]);

854 *(
blk_löe
++Ë(
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, 
	`rshi·_∫d_sf
(
ªsu…
, 
tŸÆ_sˇÀ
));

859 
	}
}

862 
	$öåa_¸_decodög
(
Ma¸oblock
 *
cuºMB
, 
yuv
, 
smb
)

864 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

865 
img≥l
 **
curUV
, *
cur_img
;

866 (*
m7UV
)[16], *
m7
;

867 
uv
;

868 
b8
,
b4
;

869 
ioff
, 
joff
, 
ii
, 
jj
;

871 
uv
 = 0; uv < 2; uv++)

873 
Boﬁón
 
los¶ess_qµrime
 = (BoﬁónË((
p_Vid
->
los¶ess_qµrime_Êag
 =1Ë&&(’_Vid->
qp
 + 
dec_pi˘uª
->
chroma_qp_off£t
[
uv
] +Ö_Vid->
bôdïth_chroma_qp_sˇÀ
) == 0));

874 
ôøns_4x4
 = (!
los¶ess_qµrime
Ë? 
ôøns4x4
 : 
ôøns4x4_ls
;

876 
curUV
 = 
dec_pi˘uª
->
imgUV
[
uv
];

877 
m7UV
 = 
p_Vid
->
cuºítSli˚
->
mb_ºes
[
uv
+1];

878 
	`öå≠ªd_chroma
(
cuºMB
, 
uv
);

880 i‡(!
smb
 && (
cuºMB
->
cbp
 >> 4))

882 
b8
 = 0; b8 < (
p_Vid
->
num_uv_blocks
); b8++)

884 
b4
 = 0; b4 < 4; b4++)

886 
joff
 = 
subblk_off£t_y
[
yuv
][
b8
][
b4
];

887 
ioff
 = 
subblk_off£t_x
[
yuv
][
b8
][
b4
];

889 
	`ôøns_4x4
(
p_Vid
, (
Cﬁ‹Pœ√
Ë(
uv
 + 1), 
ioff
, 
joff
);

891 
jj
=
joff
; jj<joff + 4;jj++)

893 
cur_img
 = &
curUV
[
cuºMB
->
pix_c_y
 + 
jj
][cuºMB->
pix_c_x
 + 
ioff
];

894 
m7
 = &
m7UV
[
jj
][
ioff
];

896 
ii
=0; ii<4;ii++)

898 *
cur_img
++ = (
img≥l
Ë*
m7
++;

904 i‡((
cuºMB
->
cbp
 >> 4) == 0)

906 
b8
 = 0; b8 < (
p_Vid
->
num_uv_blocks
); b8++)

908 
b4
 = 0; b4 < 4; b4++)

910 
joff
 = 
subblk_off£t_y
[
yuv
][
b8
][
b4
];

911 
ioff
 = 
subblk_off£t_x
[
yuv
][
b8
][
b4
];

913 
jj
 = 
joff
; jj < 4 + joff;jj++)

914 
	`mem˝y
(&(
curUV
[
cuºMB
->
pix_c_y
 + 
jj
][cuºMB->
pix_c_x
 + 
ioff
]), &(
p_Vid
->
cuºítSli˚
->
mb_¥ed
[
uv
 + 1][jj][ioff]), 
BLOCK_SIZE
 * (
img≥l
));

920 
	`ôøns_•_¸
(
p_Vid
, 
uv
);

922 
joff
 = 0; joff < 8; joff += 4)

924 
ioff
 = 0; ioff < 8;ioff+=4)

926 
	`ôøns_4x4
(
p_Vid
, (
Cﬁ‹Pœ√
Ë(
uv
 + 1), 
ioff
, 
joff
);

928 
jj
 = 
joff
; jj < joff + 4; jj++)

929 
ii
 = 
ioff
; ii < ioff + 4; ii++)

931 
curUV
[
cuºMB
->
pix_c_y
+
jj
][
ii
 + cuºMB->
pix_c_x
] = (
img≥l
Ë
p_Vid
->
cuºítSli˚
->
mb_ºes
[
uv
+1][jj][ii];

937 
	}
}

939 
	$¥ï¨e_dúe˘_∑øms
(
Ma¸oblock
 *
cuºMB
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
, 
MŸi⁄Ve˘‹
 *
pmvl0
, MŸi⁄Ve˘‹ *
pmvl1
, *
l0_rFøme
, *
l1_rFøme
)

941 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

942 
l0_rFømeL
, 
l0_rFømeU
, 
l0_rFømeUR
;

943 
l1_rFømeL
, 
l1_rFømeU
, 
l1_rFømeUR
;

944 
PicMŸi⁄P¨amsOld
 *
mŸi⁄
 = &
dec_pi˘uª
->motion;

946 
PixñPos
 
mb
[4];

948 
	`gë_√ighb‹s
(
cuºMB
, 
mb
, 0, 0, 16);

950 i‡(!
p_Vid
->
mb_aff_‰ame_Êag
)

952 
l0_rFømeL
 = (Ë(
mb
[0].
avaûabÀ
 ? 
dec_pi˘uª
->
mv_öfo
[mb[0].
pos_y
][mb[0].
pos_x
].
ªf_idx
[
LIST_0
] : -1);

953 
l0_rFømeU
 = (Ë(
mb
[1].
avaûabÀ
 ? 
dec_pi˘uª
->
mv_öfo
[mb[1].
pos_y
][mb[1].
pos_x
].
ªf_idx
[
LIST_0
] : -1);

954 
l0_rFømeUR
 = (Ë(
mb
[2].
avaûabÀ
 ? 
dec_pi˘uª
->
mv_öfo
[mb[2].
pos_y
][mb[2].
pos_x
].
ªf_idx
[
LIST_0
] : -1);

956 
l1_rFømeL
 = (Ë(
mb
[0].
avaûabÀ
 ? 
dec_pi˘uª
->
mv_öfo
[mb[0].
pos_y
][mb[0].
pos_x
].
ªf_idx
[
LIST_1
] : -1);

957 
l1_rFømeU
 = (Ë(
mb
[1].
avaûabÀ
 ? 
dec_pi˘uª
->
mv_öfo
[mb[1].
pos_y
][mb[1].
pos_x
].
ªf_idx
[
LIST_1
] : -1);

958 
l1_rFømeUR
 = (Ë(
mb
[2].
avaûabÀ
 ? 
dec_pi˘uª
->
mv_öfo
[mb[2].
pos_y
][mb[2].
pos_x
].
ªf_idx
[
LIST_1
] : -1);

962 i‡(
cuºMB
->
mb_fõld
)

964 
l0_rFømeL
 = (Ë(
mb
[0].
avaûabÀ


965 ? 
p_Vid
->
mb_d©a
[
mb
[0].
mb_addr
].
mb_fõld
 || 
dec_pi˘uª
->
mv_öfo
[mb[0].
pos_y
][mb[0].
pos_x
].
ªf_idx
[
LIST_0
] < 0

966 ? 
dec_pi˘uª
->
mv_öfo
[
mb
[0].
pos_y
][mb[0].
pos_x
].
ªf_idx
[
LIST_0
]

967 : 
dec_pi˘uª
->
mv_öfo
[
mb
[0].
pos_y
][mb[0].
pos_x
].
ªf_idx
[
LIST_0
] * 2: -1);

969 
l0_rFømeU
 = (Ë(
mb
[1].
avaûabÀ


970 ? 
p_Vid
->
mb_d©a
[
mb
[1].
mb_addr
].
mb_fõld
 || 
dec_pi˘uª
->
mv_öfo
[mb[1].
pos_y
][mb[1].
pos_x
].
ªf_idx
[
LIST_0
] < 0

971 ? 
dec_pi˘uª
->
mv_öfo
[
mb
[1].
pos_y
][mb[1].
pos_x
].
ªf_idx
[
LIST_0
]

972 : 
dec_pi˘uª
->
mv_öfo
[
mb
[1].
pos_y
][mb[1].
pos_x
].
ªf_idx
[
LIST_0
] * 2: -1);

974 
l0_rFømeUR
 = (Ë(
mb
[2].
avaûabÀ


975 ? 
p_Vid
->
mb_d©a
[
mb
[2].
mb_addr
].
mb_fõld
 || 
dec_pi˘uª
->
mv_öfo
[mb[2].
pos_y
][mb[2].
pos_x
].
ªf_idx
[
LIST_0
] < 0

976 ? 
dec_pi˘uª
->
mv_öfo
[
mb
[2].
pos_y
][mb[2].
pos_x
].
ªf_idx
[
LIST_0
]

977 : 
dec_pi˘uª
->
mv_öfo
[
mb
[2].
pos_y
][mb[2].
pos_x
].
ªf_idx
[
LIST_0
] * 2: -1);

979 
l1_rFømeL
 = (Ë(
mb
[0].
avaûabÀ


980 ? 
p_Vid
->
mb_d©a
[
mb
[0].
mb_addr
].
mb_fõld
 || 
dec_pi˘uª
->
mv_öfo
[mb[0].
pos_y
][mb[0].
pos_x
].
ªf_idx
[
LIST_1
] < 0

981 ? 
dec_pi˘uª
->
mv_öfo
[
mb
[0].
pos_y
][mb[0].
pos_x
].
ªf_idx
[
LIST_1
]

982 : 
dec_pi˘uª
->
mv_öfo
[
mb
[0].
pos_y
][mb[0].
pos_x
].
ªf_idx
[
LIST_1
] * 2: -1);

984 
l1_rFømeU
 = (Ë(
mb
[1].
avaûabÀ


985 ? 
p_Vid
->
mb_d©a
[
mb
[1].
mb_addr
].
mb_fõld
 || 
dec_pi˘uª
->
mv_öfo
[mb[1].
pos_y
][mb[1].
pos_x
].
ªf_idx
[
LIST_1
] < 0

986 ? 
dec_pi˘uª
->
mv_öfo
[
mb
[1].
pos_y
][mb[1].
pos_x
].
ªf_idx
[
LIST_1
]

987 : 
dec_pi˘uª
->
mv_öfo
[
mb
[1].
pos_y
][mb[1].
pos_x
].
ªf_idx
[
LIST_1
] * 2: -1);

989 
l1_rFømeUR
 = (Ë(
mb
[2].
avaûabÀ


990 ? 
p_Vid
->
mb_d©a
[
mb
[2].
mb_addr
].
mb_fõld
 || 
dec_pi˘uª
->
mv_öfo
[mb[2].
pos_y
][mb[2].
pos_x
].
ªf_idx
[
LIST_1
] < 0

991 ? 
dec_pi˘uª
->
mv_öfo
[
mb
[2].
pos_y
][mb[2].
pos_x
].
ªf_idx
[
LIST_1
]

992 : 
dec_pi˘uª
->
mv_öfo
[
mb
[2].
pos_y
][mb[2].
pos_x
].
ªf_idx
[
LIST_1
] * 2: -1);

996 
l0_rFømeL
 = (Ë(
mb
[0].
avaûabÀ


997 ? 
p_Vid
->
mb_d©a
[
mb
[0].
mb_addr
].
mb_fõld
 || 
dec_pi˘uª
->
mv_öfo
[mb[0].
pos_y
][mb[0].
pos_x
].
ªf_idx
[
LIST_0
] < 0

998 ? 
dec_pi˘uª
->
mv_öfo
[
mb
[0].
pos_y
][mb[0].
pos_x
].
ªf_idx
[
LIST_0
] >> 1

999 : 
dec_pi˘uª
->
mv_öfo
[
mb
[0].
pos_y
][mb[0].
pos_x
].
ªf_idx
[
LIST_0
]: -1);

1001 
l0_rFømeU
 = (Ë(
mb
[1].
avaûabÀ


1002 ? 
p_Vid
->
mb_d©a
[
mb
[1].
mb_addr
].
mb_fõld
 || 
dec_pi˘uª
->
mv_öfo
[mb[1].
pos_y
][mb[1].
pos_x
].
ªf_idx
[
LIST_0
] < 0

1003 ? 
dec_pi˘uª
->
mv_öfo
[
mb
[1].
pos_y
][mb[1].
pos_x
].
ªf_idx
[
LIST_0
] >> 1

1004 : 
dec_pi˘uª
->
mv_öfo
[
mb
[1].
pos_y
][mb[1].
pos_x
].
ªf_idx
[
LIST_0
] : -1);

1006 
l0_rFømeUR
 = (Ë(
mb
[2].
avaûabÀ


1007 ? 
p_Vid
->
mb_d©a
[
mb
[2].
mb_addr
].
mb_fõld
 || 
dec_pi˘uª
->
mv_öfo
[mb[2].
pos_y
][mb[2].
pos_x
].
ªf_idx
[
LIST_0
] < 0

1008 ? 
dec_pi˘uª
->
mv_öfo
[
mb
[2].
pos_y
][mb[2].
pos_x
].
ªf_idx
[
LIST_0
] >> 1

1009 : 
dec_pi˘uª
->
mv_öfo
[
mb
[2].
pos_y
][mb[2].
pos_x
].
ªf_idx
[
LIST_0
] : -1);

1011 
l1_rFømeL
 = (Ë(
mb
[0].
avaûabÀ


1012 ? 
p_Vid
->
mb_d©a
[
mb
[0].
mb_addr
].
mb_fõld
 || 
dec_pi˘uª
->
mv_öfo
[mb[0].
pos_y
][mb[0].
pos_x
].
ªf_idx
[
LIST_1
] < 0

1013 ? 
dec_pi˘uª
->
mv_öfo
[
mb
[0].
pos_y
][mb[0].
pos_x
].
ªf_idx
[
LIST_1
] >> 1

1014 : 
dec_pi˘uª
->
mv_öfo
[
mb
[0].
pos_y
][mb[0].
pos_x
].
ªf_idx
[
LIST_1
] : -1);

1016 
l1_rFømeU
 = (Ë(
mb
[1].
avaûabÀ


1017 ? 
p_Vid
->
mb_d©a
[
mb
[1].
mb_addr
].
mb_fõld
 || 
dec_pi˘uª
->
mv_öfo
[mb[1].
pos_y
][mb[1].
pos_x
].
ªf_idx
[
LIST_1
] < 0

1018 ? 
dec_pi˘uª
->
mv_öfo
[
mb
[1].
pos_y
][mb[1].
pos_x
].
ªf_idx
[
LIST_1
] >> 1

1019 : 
dec_pi˘uª
->
mv_öfo
[
mb
[1].
pos_y
][mb[1].
pos_x
].
ªf_idx
[
LIST_1
] : -1);

1021 
l1_rFømeUR
 = (Ë(
mb
[2].
avaûabÀ


1022 ? 
p_Vid
->
mb_d©a
[
mb
[2].
mb_addr
].
mb_fõld
 || 
dec_pi˘uª
->
mv_öfo
[mb[2].
pos_y
][mb[2].
pos_x
].
ªf_idx
[
LIST_1
] < 0

1023 ? 
dec_pi˘uª
->
mv_öfo
[
mb
[2].
pos_y
][mb[2].
pos_x
].
ªf_idx
[
LIST_1
] >> 1

1024 : 
dec_pi˘uª
->
mv_öfo
[
mb
[2].
pos_y
][mb[2].
pos_x
].
ªf_idx
[
LIST_1
] : -1);

1028 *
l0_rFøme
 = (Ë((
l0_rFømeL
 >0 && 
l0_rFømeU
 >0Ë? 
	`imö
÷0_rFømeL,l0_rFømeUË: 
	`imax
(l0_rFrameL,l0_rFrameU));

1029 *
l0_rFøme
 = (Ë((*l0_rFømê>0 && 
l0_rFømeUR
 >0Ë? 
	`imö
(*l0_rFøme,l0_rFømeUR): 
	`imax
(*l0_rFrame,l0_rFrameUR));

1031 *
l1_rFøme
 = (Ë((
l1_rFømeL
 >0 && 
l1_rFømeU
 >0Ë? 
	`imö
÷1_rFømeL,l1_rFømeUË: 
	`imax
(l1_rFrameL,l1_rFrameU));

1032 *
l1_rFøme
 = (Ë((*l1_rFømê>0 && 
l1_rFømeUR
 >0Ë? 
	`imö
(*l1_rFøme,l1_rFømeUR): 
	`imax
(*l1_rFrame,l1_rFrameUR));

1034 i‡(*
l0_rFøme
 >=0)

1035 
cuºMB
->
	`GëMVPªdi˘‹
 (cuºMB, 
mb
, 
pmvl0
, *
l0_rFøme
, 
dec_pi˘uª
->
mv_öfo
, 
LIST_0
, 0, 0, 16, 16);

1037 i‡(*
l1_rFøme
 >=0)

1038 
cuºMB
->
	`GëMVPªdi˘‹
 (cuºMB, 
mb
, 
pmvl1
, *
l1_rFøme
, 
dec_pi˘uª
->
mv_öfo
, 
LIST_1
, 0, 0, 16, 16);

1039 
	}
}

1042 
	$check_mŸi⁄_ve˘‹_ønge
(
VideoP¨amëîs
 *
p_Vid
, c⁄° 
MŸi⁄Ve˘‹
 *
mv
)

1044 i‡(
mv
->
mv_x
 > 8191 || mv->mv_x < -8192)

1046 
	`Ârötf
(
°dîr
,"WARNING! H‹iz⁄è»mŸi⁄ ve˘‹ %d i†ouào‡ÆlowedÑ™gê{-8192, 8191} i¿pi˘uª %d, ma¸oblock %d\n", 
mv
->
mv_x
, 
p_Vid
->
numbî
,Ö_Vid->
cuºít_mb_ƒ
);

1050 i‡(
mv
->
mv_y
 > (
p_Vid
->
max_mb_vmv_r
 - 1) || mv->mv_y < (-p_Vid->max_mb_vmv_r))

1052 
	`Ârötf
(
°dîr
,"WARNING! Vîtiˇ»mŸi⁄ ve˘‹ %d i†ouào‡ÆlowedÑ™gê{%d, %d} i¿pi˘uª %d, ma¸oblock %d\n", 
mv
->
mv_y
, (-
p_Vid
->
max_mb_vmv_r
), (p_Vid->max_mb_vmv_∏- 1),Ö_Vid->
numbî
,Ö_Vid->
cuºít_mb_ƒ
);

1055 
	}
}

1059 
	$≥rf‹m_mc
(
Ma¸oblock
* 
cuºMB
, 
decodî
, 
Cﬁ‹Pœ√
 
∂
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
, 
¥ed_dú
, 
l0_mode
, 
l1_mode
,

1060 
PicMŸi⁄P¨ams
 **
mv_öfo
, 
i
, 
j
, 
block_size_x
, 
block_size_y
, 
bùªd_me
)

1062 
img≥l
 
tmp_block_l0
[
MB_BLOCK_SIZE
][MB_BLOCK_SIZE];

1063 
img≥l
 
tmp_block_l1
[
MB_BLOCK_SIZE
][MB_BLOCK_SIZE];

1065 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1066 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1068 
vec1_x
=0, 
vec1_y
=0;

1069 
vec2_x
=0, 
vec2_y
=0;

1071 
Æpha_l0
, 
Æpha_l1
, 
wp_off
;

1072 
max_img≥l_vÆue
 = 
p_Vid
->
max_≥l_vÆue_comp
[
∂
];

1073 
≠∂y_weights
 = ( (
p_Vid
->
a˘ive_µs
->
weighãd_¥ed_Êag
 && (
cuºSli˚
->
¶i˚_ty≥
=
P_SLICE
 || cuºSli˚->¶i˚_ty≥ =
SP_SLICE
)) ||

1074 (
p_Vid
->
a˘ive_µs
->
weighãd_bùªd_idc
 && (
cuºSli˚
->
¶i˚_ty≥
=
B_SLICE
)));

1075 c⁄° 
mv_mul
 = 16;

1077 
i4
 = 
cuºMB
->
block_x
 + 
i
;

1078 
j4
 = 
cuºMB
->
block_y
 + 
j
;

1079 
ioff
 = (
i
 << 2);

1080 
joff
 = (
j
 << 2);

1082 
	`as£π
 (
¥ed_dú
<=2);

1084 i‡(
¥ed_dú
 != 2)

1087 
ªf_idx
 = 
mv_öfo
[
j4
][
i4
].ªf_idx[
¥ed_dú
];

1088 
ªf_idx_wp
 = 
ªf_idx
;

1089 
MŸi⁄Ve˘‹
 **
mv_¨øy
 = 
cuºSli˚
->
Æl_mv
[
¥ed_dú
][
ªf_idx
][
l0_mode
];

1090 
St‹abÀPi˘uª
 **
li°
 = 
cuºSli˚
->
li°X
[
cuºMB
->
li°_off£t
 + 
¥ed_dú
];

1092 
vec1_x
 = 
i4
 * 
mv_mul
 + 
mv_¨øy
[
j
][
i
].
mv_x
;

1093 
vec1_y
 = 
j4
 * 
mv_mul
 + 
mv_¨øy
[
j
][
i
].
mv_y
;

1095 
	`gë_block_luma
 (
cuºMB
, 
decodî
, 
∂
, 
dec_pi˘uª
, 
li°
[
ªf_idx
], 
vec1_x
, 
vec1_y
, 
block_size_x
, 
block_size_y
, 
tmp_block_l0
);

1097 i‡(
≠∂y_weights
)

1099 i‡(
cuºMB
->
mb_fõld
)

1101 
ªf_idx_wp
 >>=1;

1103 
Æpha_l0
 = 
cuºSli˚
->
wp_weight
[
¥ed_dú
][
ªf_idx_wp
][0];

1104 
wp_off
 = 
cuºSli˚
->
wp_off£t
[
¥ed_dú
][
ªf_idx_wp
][0];

1106 
	`weighãd_mc_¥edi˘i⁄
(&
p_Vid
->
p_decs
->
dec_mb_¥ed
[
decodî
][
joff
], 
block_size_y
, 
block_size_x
, 
ioff
, 
tmp_block_l0
, 
Æpha_l0
, 
wp_off
, 
cuºSli˚
->
luma_log_weight_díom
, 
max_img≥l_vÆue
);

1110 
	`mc_¥edi˘i⁄
(&
p_Vid
->
p_decs
->
dec_mb_¥ed
[
decodî
][
joff
], 
block_size_y
, 
block_size_x
, 
ioff
, 
tmp_block_l0
);

1114 i‡((
dec_pi˘uª
->
chroma_f‹m©_idc
 !
YUV400
Ë&& (dec_pi˘uª->chroma_f‹m©_id¯!
YUV444
) )

1116 
uv
;

1118 
ioff_¸
 = (
p_Vid
->
mb_¸_size_x
 =
MB_BLOCK_SIZE
Ë? 
ioff
 : ioff >> 1;

1119 
joff_¸
 = (
p_Vid
->
mb_¸_size_y
 =
MB_BLOCK_SIZE
Ë? 
joff
 : joff >> 1;

1120 
block_size_x_¸
 = 
p_Vid
->
mb_¸_size_x
 =
MB_BLOCK_SIZE
 ? 
block_size_x
 : block_size_x >> 1;

1121 
block_size_y_¸
 = 
p_Vid
->
mb_¸_size_y
 =
MB_BLOCK_SIZE
 ? 
block_size_y
 : block_size_y >> 1;

1123 
vec1_y_¸
 = 
vec1_y
 + ((
a˘ive_•s
->
chroma_f‹m©_idc
 =1)? 
li°
[
ªf_idx
]->
chroma_ve˘‹_adju°mít
 : 0);

1125 
uv
=0;uv<2;uv++)

1127 
	`gë_block_chroma
 (
cuºMB
, 
uv
, 
li°
[
ªf_idx
], 
vec1_x
, 
vec1_y_¸
, 
block_size_x_¸
, 
block_size_y_¸
, 
tmp_block_l0
);

1129 i‡(
p_Vid
->
≠∂y_weights
)

1131 
Æpha_l0
 = 
p_Vid
->
wp_weight
[
¥ed_dú
][
ªf_idx_wp
][
uv
 + 1];

1132 
wp_off£t
 = 
p_Vid
->wp_off£t[
¥ed_dú
][
ªf_idx_wp
][
uv
 + 1];

1134 
	`weighãd_mc_¥edi˘i⁄
(&
cuºSli˚
->
mb_¥ed
[
uv
 + 1][
joff_¸
], 
block_size_y_¸
, 
block_size_x_¸
, 
ioff_¸
, 
tmp_block_l0
, 
Æpha_l0
, 
wp_off£t
, 
p_Vid
->
chroma_log2_weight_díom
,Ö_Vid->
max_≥l_vÆue_comp
[uv + 1]);

1138 
	`mc_¥edi˘i⁄
(&
cuºSli˚
->
mb_¥ed
[
uv
 + 1][
joff_¸
], 
block_size_y_¸
, 
block_size_x_¸
, 
ioff_¸
, 
tmp_block_l0
);

1147 
l0_ªf
 = 
mv_öfo
[
j4
][
i4
].
ªf_idx
[
LIST_0
];

1148 
l1_ªf
 = 
mv_öfo
[
j4
][
i4
].
ªf_idx
[
LIST_1
];

1150 
MŸi⁄Ve˘‹
 **
l0_mv_¨øy
 = (
bùªd_me
 ? 
cuºSli˚
->
bùªd_mv
[bùªd_me-1][
LIST_0
][
l0_ªf
][
l0_mode
]:cuºSli˚->
Æl_mv
[LIST_0][l0_ref][l0_mode]);

1151 
MŸi⁄Ve˘‹
 **
l1_mv_¨øy
 = (
bùªd_me
 ? 
cuºSli˚
->
bùªd_mv
[bùªd_me-1][
LIST_1
][
l1_ªf
][
l1_mode
]:cuºSli˚->
Æl_mv
[LIST_1][l1_ref][l1_mode]);

1153 
vec1_x
 = 
i4
 * 
mv_mul
 + 
l0_mv_¨øy
[
j
][
i
].
mv_x
;

1154 
vec2_x
 = 
i4
 * 
mv_mul
 + 
l1_mv_¨øy
[
j
][
i
].
mv_x
;

1156 
vec1_y
 = 
j4
 * 
mv_mul
 + 
l0_mv_¨øy
[
j
][
i
].
mv_y
;

1157 
vec2_y
 = 
j4
 * 
mv_mul
 + 
l1_mv_¨øy
[
j
][
i
].
mv_y
;

1159 
	`gë_block_luma
 (
cuºMB
, 
decodî
, 
∂
, 
dec_pi˘uª
, 
cuºSli˚
->
li°X
[
LIST_0
 + cuºMB->
li°_off£t
][
l0_ªf
], 
vec1_x
, 
vec1_y
, 
block_size_x
, 
block_size_y
, 
tmp_block_l0
);

1160 
	`gë_block_luma
 (
cuºMB
, 
decodî
, 
∂
, 
dec_pi˘uª
, 
cuºSli˚
->
li°X
[
LIST_1
 + cuºMB->
li°_off£t
][
l1_ªf
], 
vec2_x
, 
vec2_y
, 
block_size_x
, 
block_size_y
, 
tmp_block_l1
);

1162 if(
≠∂y_weights
)

1164 
wt_li°_off£t
 = (
p_Vid
->
a˘ive_µs
->
weighãd_bùªd_idc
==2)? 
cuºMB
->
li°_off£t
 : 0;

1168 i‡(
cuºMB
->
mb_fõld
)

1170 
l0_ªf
 >>=1;

1171 
l1_ªf
 >>=1;

1174 
Æpha_l0
 = 
cuºSli˚
->
wbp_weight
[
LIST_0
 + 
wt_li°_off£t
][
l0_ªf
][
l1_ªf
][0];

1175 
Æpha_l1
 = 
cuºSli˚
->
wbp_weight
[
LIST_1
 + 
wt_li°_off£t
][
l0_ªf
][
l1_ªf
][0];

1176 
wp_off
 = ((
cuºSli˚
->
wp_off£t
 [
LIST_0
 + 
wt_li°_off£t
][
l0_ªf
][0] + cuºSli˚->wp_off£t[
LIST_1
 + wt_li°_off£t][
l1_ªf
][0] + 1) >>1);

1178 
	`weighãd_bi_¥edi˘i⁄
(&
p_Vid
->
p_decs
->
dec_mb_¥ed
[
decodî
][
joff
], 
tmp_block_l0
, 
tmp_block_l1
, 
block_size_y
, 
block_size_x
, 
ioff
, 
Æpha_l0
, 
Æpha_l1
, 
wp_off
, (
cuºSli˚
->
luma_log_weight_díom
 + 1), 
max_img≥l_vÆue
);

1182 
	`bi_¥edi˘i⁄
(&
p_Vid
->
p_decs
->
dec_mb_¥ed
[
decodî
][
joff
], 
tmp_block_l0
, 
tmp_block_l1
, 
block_size_y
, 
block_size_x
, 
ioff
);

1185 i‡((
dec_pi˘uª
->
chroma_f‹m©_idc
 !
YUV400
Ë&& (dec_pi˘uª->chroma_f‹m©_id¯!
YUV444
) )

1187 
uv
;

1189 
ioff_¸
 = 
p_Vid
->
mb_¸_size_x
 =
MB_BLOCK_SIZE
 ? 
ioff
 : ioff >> 1;

1190 
joff_¸
 = 
p_Vid
->
mb_¸_size_y
 =
MB_BLOCK_SIZE
 ? 
joff
 : joff >> 1;

1191 
block_size_x_¸
 = 
p_Vid
->
mb_¸_size_x
 =
MB_BLOCK_SIZE
 ? 
block_size_x
 : block_size_x >> 1;

1192 
block_size_y_¸
 = 
p_Vid
->
mb_¸_size_y
 =
MB_BLOCK_SIZE
 ? 
block_size_y
 : block_size_y >> 1;

1194 
vec1_y_¸
 = 
vec1_y
 + ((
a˘ive_•s
->
chroma_f‹m©_idc
 =1)? 
cuºSli˚
->
li°X
[
LIST_0
 + 
li°_off£t
][
l0_ªf‰ame
]->
chroma_ve˘‹_adju°mít
 : 0);

1195 
vec2_y_¸
 = 
vec2_y
 + ((
a˘ive_•s
->
chroma_f‹m©_idc
 =1)? 
cuºSli˚
->
li°X
[
LIST_1
 + 
li°_off£t
][
l1_ªf‰ame
]->
chroma_ve˘‹_adju°mít
 : 0);

1197 
uv
=0;uv<2;uv++)

1199 
	`gë_block_chroma
 (
cuºMB
, 
uv
, 
cuºSli˚
->
li°X
[
LIST_0
 + 
li°_off£t
][
l0_ªf‰ame
], 
vec1_x
, 
vec1_y_¸
, 
block_size_x_¸
, 
block_size_y_¸
, 
tmp_block_l0
);

1200 
	`gë_block_chroma
 (
cuºMB
, 
uv
, 
cuºSli˚
->
li°X
[
LIST_1
 + 
li°_off£t
][
l1_ªf‰ame
], 
vec2_x
, 
vec2_y_¸
, 
block_size_x_¸
, 
block_size_y_¸
, 
tmp_block_l1
);

1202 if(
p_Vid
->
≠∂y_weights
)

1204 
wt_li°_off£t
 = (
a˘ive_µs
->
weighãd_bùªd_idc
==2)? 
li°_off£t
 : 0;

1206 
Æpha_l0
 = 
p_Vid
->
wbp_weight
[
LIST_0
 + 
wt_li°_off£t
][
l0_ªf_idx
][
l1_ªf_idx
][
uv
 + 1];

1207 
Æpha_l1
 = 
p_Vid
->
wbp_weight
[
LIST_1
 + 
wt_li°_off£t
][
l0_ªf_idx
][
l1_ªf_idx
][
uv
 + 1];

1208 
wp_off£t
 = ((
p_Vid
->wp_off£à[
LIST_0
 + 
wt_li°_off£t
][
l0_ªf_idx
][
uv
 + 1] +Ö_Vid->wp_off£t[
LIST_1
 + wt_li°_off£t][
l1_ªf_idx
][uv + 1] + 1) >>1);

1210 
	`weighãd_bi_¥edi˘i⁄
(&
cuºSli˚
->
mb_¥ed
[
uv
+1][
joff_¸
], 
tmp_block_l0
, 
tmp_block_l1
, 
block_size_y_¸
, 
block_size_x_¸
, 
ioff_¸
, 
Æpha_l0
, 
Æpha_l1
, 
wp_off£t
, (
p_Vid
->
chroma_log2_weight_díom
 + 1),Ö_Vid->
max_≥l_vÆue_comp
[uv + 1]);

1214 
	`bi_¥edi˘i⁄
(&
p_Vid
->
cuºítSli˚
->
mb_¥ed
[
uv
 + 1][
joff_¸
], 
tmp_block_l0
, 
tmp_block_l1
, 
block_size_y_¸
, 
block_size_x_¸
, 
ioff_¸
);

1220 
	}
}

1222 
	$≥rf‹m_mc_c⁄˚Æmít
(
Ma¸oblock
* 
cuºMB
, 
decodî
, 
Cﬁ‹Pœ√
 
∂
, 
St‹abÀPi˘uª
 *
dec_pi˘uª
, 
¥ed_dú
, 
l0_mode
, 
l1_mode
,

1223 
PicMŸi⁄P¨ams
 **
mv_öfo
, 
i
, 
j
, 
block_size_x
, 
block_size_y
)

1225 
img≥l
 
tmp_block_l0
[
MB_BLOCK_SIZE
][MB_BLOCK_SIZE];

1226 
img≥l
 
tmp_block_l1
[
MB_BLOCK_SIZE
][MB_BLOCK_SIZE];

1228 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1229 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1231 
vec1_x
=0, 
vec1_y
=0;

1232 
vec2_x
=0, 
vec2_y
=0;

1234 
Æpha_l0
, 
Æpha_l1
, 
wp_off
;

1235 
max_img≥l_vÆue
 = 
p_Vid
->
max_≥l_vÆue_comp
[
∂
];

1236 
≠∂y_weights
 = ( (
p_Vid
->
a˘ive_µs
->
weighãd_¥ed_Êag
 && (
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
 || cuºSli˚->¶i˚_ty≥ =
SP_SLICE
)) ||

1237 (
p_Vid
->
a˘ive_µs
->
weighãd_bùªd_idc
 && (
cuºSli˚
->
¶i˚_ty≥
=
B_SLICE
)));

1238 c⁄° 
mv_mul
 = 16;

1240 
i4
 = 
cuºMB
->
block_x
 + 
i
;

1241 
j4
 = 
cuºMB
->
block_y
 + 
j
;

1242 
ioff
 = (
i
 << 2);

1243 
joff
 = (
j
 << 2);

1245 
	`as£π
 (
¥ed_dú
<=2);

1247 i‡(
¥ed_dú
 != 2)

1250 
ªf_idx
 = 
mv_öfo
[
j4
][
i4
].ªf_idx[
¥ed_dú
];

1251 
ªf_idx_wp
 = 
ªf_idx
;

1252 
PicMŸi⁄P¨ams
 **
mŸi⁄
 = 
dec_pi˘uª
->
mv_öfo
;

1254 
St‹abÀPi˘uª
 **
li°
 = 
cuºSli˚
->
li°X
[
cuºMB
->
li°_off£t
 + 
¥ed_dú
];

1256 
vec1_x
 = 
i4
 * 
mv_mul
 + 
mŸi⁄
[
j4
][i4].
mv
[
¥ed_dú
].
mv_x
;

1258 
vec1_y
 = 
j4
 * 
mv_mul
 + 
mŸi⁄
[j4][
i4
].
mv
[
¥ed_dú
].
mv_y
;

1260 
	`gë_block_luma
 (
cuºMB
, 
decodî
, 
∂
, 
dec_pi˘uª
, 
li°
[
ªf_idx
], 
vec1_x
, 
vec1_y
, 
block_size_x
, 
block_size_y
, 
tmp_block_l0
);

1262 i‡(
≠∂y_weights
)

1264 i‡(
cuºMB
->
mb_fõld
)

1266 
ªf_idx_wp
 >>=1;

1268 
Æpha_l0
 = 
p_Vid
->
cuºítSli˚
->
wp_weight
[
¥ed_dú
][
ªf_idx_wp
][0];

1269 
wp_off
 = 
p_Vid
->
cuºítSli˚
->
wp_off£t
[
¥ed_dú
][
ªf_idx_wp
][0];

1271 
	`weighãd_mc_¥edi˘i⁄
(&
p_Vid
->
p_decs
->
dec_mb_¥ed
[
decodî
][
joff
], 
block_size_y
, 
block_size_x
, 
ioff
, 
tmp_block_l0
, 
Æpha_l0
, 
wp_off
,Ö_Vid->
cuºítSli˚
->
luma_log_weight_díom
, 
max_img≥l_vÆue
);

1275 
	`mc_¥edi˘i⁄
(&
p_Vid
->
p_decs
->
dec_mb_¥ed
[
decodî
][
joff
], 
block_size_y
, 
block_size_x
, 
ioff
, 
tmp_block_l0
);

1281 
l0_ªf
 = 
mv_öfo
[
j4
][
i4
].
ªf_idx
[
LIST_0
];

1282 
l1_ªf
 = 
mv_öfo
[
j4
][
i4
].
ªf_idx
[
LIST_1
];

1284 
vec1_x
 = 
i4
 * 
mv_mul
 + 
dec_pi˘uª
->
mv_öfo
[
j4
][i4].
mv
[
LIST_0
].
mv_x
;

1285 
vec2_x
 = 
i4
 * 
mv_mul
 + 
dec_pi˘uª
->
mv_öfo
[
j4
][i4].
mv
[
LIST_1
].
mv_x
;

1287 
vec1_y
 = 
j4
 * 
mv_mul
 + 
dec_pi˘uª
->
mv_öfo
[j4][
i4
].
mv
[
LIST_0
].
mv_y
;

1288 
vec2_y
 = 
j4
 * 
mv_mul
 + 
dec_pi˘uª
->
mv_öfo
[j4][
i4
].
mv
[
LIST_1
].
mv_y
;

1290 
	`gë_block_luma
 (
cuºMB
, 
decodî
, 
∂
, 
dec_pi˘uª
, 
cuºSli˚
->
li°X
[
LIST_0
 + cuºMB->
li°_off£t
][
l0_ªf
], 
vec1_x
, 
vec1_y
, 
block_size_x
, 
block_size_y
, 
tmp_block_l0
);

1291 
	`gë_block_luma
 (
cuºMB
, 
decodî
, 
∂
, 
dec_pi˘uª
, 
cuºSli˚
->
li°X
[
LIST_1
 + cuºMB->
li°_off£t
][
l1_ªf
], 
vec2_x
, 
vec2_y
, 
block_size_x
, 
block_size_y
, 
tmp_block_l1
);

1293 if(
≠∂y_weights
)

1295 
wt_li°_off£t
 = (
p_Vid
->
a˘ive_µs
->
weighãd_bùªd_idc
==2)? 
cuºMB
->
li°_off£t
 : 0;

1299 i‡(
cuºMB
->
mb_fõld
)

1301 
l0_ªf
 >>=1;

1302 
l1_ªf
 >>=1;

1305 
Æpha_l0
 = 
p_Vid
->
cuºítSli˚
->
wbp_weight
[
LIST_0
 + 
wt_li°_off£t
][
l0_ªf
][
l1_ªf
][0];

1306 
Æpha_l1
 = 
p_Vid
->
cuºítSli˚
->
wbp_weight
[
LIST_1
 + 
wt_li°_off£t
][
l0_ªf
][
l1_ªf
][0];

1307 
wp_off
 = ((
p_Vid
->
cuºítSli˚
->
wp_off£t
 [
LIST_0
 + 
wt_li°_off£t
][
l0_ªf
][0] +Ö_Vid->cuºítSli˚->wp_off£t[
LIST_1
 + wt_li°_off£t][
l1_ªf
][0] + 1) >>1);

1309 
	`weighãd_bi_¥edi˘i⁄
(&
p_Vid
->
p_decs
->
dec_mb_¥ed
[
decodî
][
joff
], 
tmp_block_l0
, 
tmp_block_l1
, 
block_size_y
, 
block_size_x
, 
ioff
, 
Æpha_l0
, 
Æpha_l1
, 
wp_off
, (p_Vid->
cuºítSli˚
->
luma_log_weight_díom
 + 1), 
max_img≥l_vÆue
);

1313 
	`bi_¥edi˘i⁄
(&
p_Vid
->
p_decs
->
dec_mb_¥ed
[
decodî
][
joff
], 
tmp_block_l0
, 
tmp_block_l1
, 
block_size_y
, 
block_size_x
, 
ioff
);

1316 
	}
}

	@lencod/src/loopFilter.c

23 
	~"globÆ.h
"

24 
	~"image.h
"

25 
	~"mb_ac˚ss.h
"

26 
	~"lo›_fûãr.h
"

28 
£t_lo›_fûãr_fun˘i⁄s_mbaff
 (
VideoP¨amëîs
 *
p_Vid
);

29 
£t_lo›_fûãr_fun˘i⁄s_n‹mÆ
(
VideoP¨amëîs
 *
p_Vid
);

31 
DeblockMb
(
VideoP¨amëîs
 *
p_Vid
, 
img≥l
 **
imgY
, img≥»***
imgUV
, 
MbQAddr
);

33 
	$öô_Deblock
(
VideoP¨amëîs
 *
p_Vid
)

35 
i
;

36 i‡(
p_Vid
->
mb_aff_‰ame_Êag
 == 1)

38 
	`£t_lo›_fûãr_fun˘i⁄s_mbaff
(
p_Vid
);

42 
	`£t_lo›_fûãr_fun˘i⁄s_n‹mÆ
(
p_Vid
);

45 
i
=0; i < 
p_Vid
->
PicSizeInMbs
; i++)

47 i‡(
p_Vid
->
mb_d©a
[
i
].
mb_ty≥
==
IPCM
)

49 
p_Vid
->
mb_d©a
[
i
].
qp
 = 0;

50 
p_Vid
->
mb_d©a
[
i
].
qpc
[0] = 0;

51 
p_Vid
->
mb_d©a
[
i
].
qpc
[1] = 0;

54 
	}
}

56 #i‡(
JM_PARALLEL_DEBLOCK
 == 0)

63 
	$DeblockFøme
(
VideoP¨amëîs
 *
p_Vid
, 
img≥l
 **
imgY
, img≥»***
imgUV
)

65 
i
;

66 
	`öô_Deblock
(
p_Vid
);

67 
i
=0; i < 
p_Vid
->
PicSizeInMbs
; i++)

69 
	`DeblockMb
–
p_Vid
, 
imgY
, 
imgUV
, 
i
 ) ;

71 
	}
}

73 
	$DeblockP¨ÆÀl
(
VideoP¨amëîs
 *
p_Vid
, 
img≥l
 **
imgY
, img≥»***
imgUV
, 
cﬁumn
, 
block
, 
n_œ°
)

75 
i
, 
j
;

77 
j
 = 0; j < 
GROUP_SIZE
; j++)

79 
i
 = 
block
++ * (
p_Vid
->
PicWidthInMbs
 - 2Ë+ 
cﬁumn
;

81 
	`DeblockMb
–
p_Vid
, 
imgY
, 
imgUV
, 
i
 ) ;

82 i‡(
block
 =
n_œ°
) ;

84 
	}
}

92 
	$DeblockFøme
(
VideoP¨amëîs
 *
p_Vid
, 
img≥l
 **
imgY
, img≥»***
imgUV
)

94 
iheightMBs
 =(
p_Vid
->
PicSizeInMbs
/p_Vid->
PicWidthInMbs
);

95 
i
, 
k
 = 
p_Vid
->
PicWidthInMbs
 + 2 * (
iheightMBs
 - 1);

96 
	`öô_Deblock
(
p_Vid
);

98 
i
 = 0; i < 
k
; i++)

100 
¬
;

101 
n_œ°
 = 
	`imö
(
iheightMBs
, (
i
 >> 1) + 1);

102 
n_°¨t
 = (
i
 < 
p_Vid
->
PicWidthInMbs
) ? 0 : ((i -Ö_Vid->PicWidthInMbs) >> 1) + 1;

104 #i‡
	`deföed
(
OPENMP
)

105 #¥agm®
omp
 
∑øŒñ
 

107 
¬
 = 
n_°¨t
;Ç¿< 
n_œ°
;Ç¿+
GROUP_SIZE
)

108 
	`DeblockP¨ÆÀl
(
p_Vid
, 
imgY
, 
imgUV
, 
i
, 
¬
, 
n_œ°
);

110 
	}
}

120 
	$DeblockMb
(
VideoP¨amëîs
 *
p_Vid
, 
img≥l
 **
imgY
, img≥»***
imgUV
, 
MbQAddr
)

122 
edge
;

123 
byã
 
Såígth
[16];

125 
öt64
 *
p_Såígth64
 = (öt64 *Ë
Såígth
;

126 
mb_x
, 
mb_y
;

128 
fûãrN⁄8x8LumaEdgesFœg
[4] = {1,1,1,1};

129 
fûãrLe·MbEdgeFœg
;

130 
fûãrT›MbEdgeFœg
;

131 
edge_¸
;

132 
Ma¸oblock
 *
MbQ
 = &(
p_Vid
->
mb_d©a
[
MbQAddr
]) ;

133 
Sli˚
 *
cuºSli˚
 = 
MbQ
->
p_Sli˚
;

134 
mvlimô
 = (
p_Vid
->
°ru˘uª
!=
FRAME
Ë|| (p_Vid->
mb_aff_‰ame_Êag
 && 
MbQ
->
mb_fõld
) ? 2 : 4;

135 
£q_∑ømëî_£t_rb•_t
 *
a˘ive_•s
 = 
p_Vid
->active_sps;

136 
p_Vid
->
mixedModeEdgeFœg
 = 0;

139 i‡(
MbQ
->
DFDißbÀIdc
 == 1)

141 
MbQ
->
DeblockCÆl
 = 0;

145 
MbQ
->
DeblockCÆl
 = 1;

146 
	`gë_mb_pos
 (
p_Vid
, 
MbQAddr
,Ö_Vid->
mb_size
[
IS_LUMA
], &
mb_x
, &
mb_y
);

148 i‡(
MbQ
->
mb_ty≥
 =
I8MB
)

149 
	`as£π
(
MbQ
->
luma_å™sf‹m_size_8x8_Êag
);

151 
fûãrN⁄8x8LumaEdgesFœg
[1] =

152 
fûãrN⁄8x8LumaEdgesFœg
[3] = !(
MbQ
->
luma_å™sf‹m_size_8x8_Êag
);

154 
fûãrLe·MbEdgeFœg
 = (
mb_x
 != 0);

155 
fûãrT›MbEdgeFœg
 = (
mb_y
 != 0);

157 i‡(
p_Vid
->
mb_aff_‰ame_Êag
 && 
mb_y
 =
MB_BLOCK_SIZE
 && 
MbQ
->
mb_fõld
)

158 
fûãrT›MbEdgeFœg
 = 0;

160 i‡(
MbQ
->
DFDißbÀIdc
==2)

163 
fûãrLe·MbEdgeFœg
 = 
MbQ
->
mbAvaûA
;

165 
fûãrT›MbEdgeFœg
 = (
p_Vid
->
mb_aff_‰ame_Êag
 && !
MbQ
->
mb_fõld
 && (
MbQAddr
 & 0x01)Ë? 1 : MbQ->
mbAvaûB
;

168 
	`CheckAvaûabûôyOfNeighb‹s
(
MbQ
);

171 
edge
 = 0;Édge < 4 ; ++edge )

174 i‡(
MbQ
->
cbp
 == 0)

176 i‡(
fûãrN⁄8x8LumaEdgesFœg
[
edge
] =0 && 
a˘ive_•s
->
chroma_f‹m©_idc
!=
YUV444
)

178 i‡(
edge
 > 0 && (
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
 || cuºSli˚->¶i˚_ty≥ =
B_SLICE
))

180 i‡((
MbQ
->
mb_ty≥
 =0 && 
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
) || (MbQ->mb_type == 1) || (MbQ->mb_type == 2))

182 i‡((
edge
 & 0x01Ë&& ((
MbQ
->
mb_ty≥
 =3Ë|| (”dgê& 0x01Ë&& MbQ->mb_ty≥ =0 && 
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
 && 
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
)))

187 if–
edge
 || 
fûãrLe·MbEdgeFœg
 )

190 
p_Vid
->
	`GëSåígthVî
(
Såígth
, 
MbQ
, 
edge
 << 2, 
mvlimô
);

192 i‡((
p_Såígth64
[0]) || (p_Strength64[1]))

194 i‡(
fûãrN⁄8x8LumaEdgesFœg
[
edge
])

196 
p_Vid
->
	`EdgeLo›LumaVî
–
PLANE_Y
, 
imgY
, 
Såígth
, 
MbQ
, 
edge
 << 2) ;

197 i‡(
p_Vid
->
P444_joöed
)

199 
p_Vid
->
	`EdgeLo›LumaVî
(
PLANE_U
, 
imgUV
[0], 
Såígth
, 
MbQ
, 
edge
 << 2);

200 
p_Vid
->
	`EdgeLo›LumaVî
(
PLANE_V
, 
imgUV
[1], 
Såígth
, 
MbQ
, 
edge
 << 2);

203 if(
p_Vid
->
yuv_f‹m©
==
YUV420
 ||Ö_Vid->yuv_f‹m©==
YUV422
 )

205 
edge_¸
 = 
chroma_edge
[0][
edge
][
p_Vid
->
yuv_f‹m©
];

206 if–(
imgUV
 !
NULL
Ë&& (
edge_¸
 >= 0))

208 
p_Vid
->
	`EdgeLo›ChromaVî
–
imgUV
[0], 
Såígth
, 
MbQ
, 
edge_¸
, 0);

209 
p_Vid
->
	`EdgeLo›ChromaVî
–
imgUV
[1], 
Såígth
, 
MbQ
, 
edge_¸
, 1);

217  
edge
 = 0;Édge < 4 ; ++edge )

220 i‡(
MbQ
->
cbp
 == 0)

222 i‡(
fûãrN⁄8x8LumaEdgesFœg
[
edge
] =0 && 
a˘ive_•s
->
chroma_f‹m©_idc
==
YUV420
)

224 i‡(
edge
 > 0 && (
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
 || cuºSli˚->¶i˚_ty≥ =
B_SLICE
))

226 i‡(((
MbQ
->
mb_ty≥
 =
PSKIP
 && 
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
Ë|| (MbQ->mb_ty≥ =
P16x16
Ë|| (MbQ->mb_ty≥ =
P8x16
)))

228 i‡((
edge
 & 0x01Ë&& (–
MbQ
->
mb_ty≥
 =
P16x8
Ë|| (
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
 && MbQ->mb_ty≥ =
BSKIP_DIRECT
 && 
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
)))

233 if–
edge
 || 
fûãrT›MbEdgeFœg
 )

236 
p_Vid
->
	`GëSåígthH‹
(
Såígth
, 
MbQ
, 
edge
 << 2, 
mvlimô
);

238 i‡((
p_Såígth64
[0]) || (p_Strength64[1]))

240 i‡(
fûãrN⁄8x8LumaEdgesFœg
[
edge
])

242 
p_Vid
->
	`EdgeLo›LumaH‹
–
PLANE_Y
, 
imgY
, 
Såígth
, 
MbQ
, 
edge
 << 2,Ö_Vid->
width_∑dded
) ;

243 i‡(
p_Vid
->
P444_joöed
)

245 
p_Vid
->
	`EdgeLo›LumaH‹
(
PLANE_U
, 
imgUV
[0], 
Såígth
, 
MbQ
, 
edge
 << 2,Ö_Vid->
width_∑dded
);

246 
p_Vid
->
	`EdgeLo›LumaH‹
(
PLANE_V
, 
imgUV
[1], 
Såígth
, 
MbQ
, 
edge
 << 2,Ö_Vid->
width_∑dded
);

249 if(
p_Vid
->
yuv_f‹m©
==
YUV420
 ||Ö_Vid->yuv_f‹m©==
YUV422
 )

251 
edge_¸
 = 
chroma_edge
[1][
edge
][
p_Vid
->
yuv_f‹m©
];

252 if–(
imgUV
 !
NULL
Ë&& (
edge_¸
 >= 0))

254 
p_Vid
->
	`EdgeLo›ChromaH‹
–
imgUV
[0], 
Såígth
, 
MbQ
, 
edge_¸
,Ö_Vid->
width_¸
 +Ö_Vid->
∑d_size_uv_x
 * 2, 0);

255 
p_Vid
->
	`EdgeLo›ChromaH‹
–
imgUV
[1], 
Såígth
, 
MbQ
, 
edge_¸
,Ö_Vid->
width_¸
 +Ö_Vid->
∑d_size_uv_x
 * 2, 1);

260 i‡(!
edge
 && !
MbQ
->
mb_fõld
 && 
p_Vid
->
mixedModeEdgeFœg
)

263 
MbQ
->
DeblockCÆl
 = 2;

264 
p_Vid
->
	`GëSåígthH‹
(
Såígth
, 
MbQ
, 
MB_BLOCK_SIZE
, 
mvlimô
);

267 i‡(
fûãrN⁄8x8LumaEdgesFœg
[
edge
])

269 
p_Vid
->
	`EdgeLo›LumaH‹
–
PLANE_Y
, 
imgY
, 
Såígth
, 
MbQ
, 
MB_BLOCK_SIZE
,Ö_Vid->
width_∑dded
) ;

270 i‡(
p_Vid
->
P444_joöed
)

272 
p_Vid
->
	`EdgeLo›LumaH‹
(
PLANE_U
, 
imgUV
[0], 
Såígth
, 
MbQ
, 
MB_BLOCK_SIZE
,Ö_Vid->
width_∑dded
) ;

273 
p_Vid
->
	`EdgeLo›LumaH‹
(
PLANE_V
, 
imgUV
[1], 
Såígth
, 
MbQ
, 
MB_BLOCK_SIZE
,Ö_Vid->
width_∑dded
) ;

276 if–
p_Vid
->
yuv_f‹m©
 =
YUV420
 ||Ö_Vid->yuv_f‹m©==
YUV422
 )

278 
edge_¸
 = 
chroma_edge
[1][
edge
][
p_Vid
->
yuv_f‹m©
];

279 if–(
imgUV
 !
NULL
Ë&& (
edge_¸
 >= 0))

281 
p_Vid
->
	`EdgeLo›ChromaH‹
–
imgUV
[0], 
Såígth
, 
MbQ
, 
MB_BLOCK_SIZE
,Ö_Vid->
width_¸
+p_Vid->
∑d_size_uv_x
*2, 0) ;

282 
p_Vid
->
	`EdgeLo›ChromaH‹
–
imgUV
[1], 
Såígth
, 
MbQ
, 
MB_BLOCK_SIZE
,Ö_Vid->
width_¸
+p_Vid->
∑d_size_uv_x
*2, 1) ;

286 
MbQ
->
DeblockCÆl
 = 1;

291 
MbQ
->
DeblockCÆl
 = 0;

292 
	}
}

	@lencod/src/loop_filter_mbaff.c

23 
	~"globÆ.h
"

24 
	~"image.h
"

25 
	~"mb_ac˚ss.h
"

26 
	~"lo›_fûãr.h
"

30 
gë_°ªngth_vî_MBAff
 (
byã
 
Såígth
[
MB_BLOCK_SIZE
], 
Ma¸oblock
 *
MbQ
, 
edge
, 
mvlimô
);

31 
gë_°ªngth_h‹_MBAff
 (
byã
 
Såígth
[
MB_BLOCK_SIZE
], 
Ma¸oblock
 *
MbQ
, 
edge
, 
mvlimô
);

32 
edge_lo›_luma_vî_MBAff
 (
Cﬁ‹Pœ√
 
∂
, 
img≥l
** 
Img
, 
byã
 
Såígth
[
MB_BLOCK_SIZE
], 
Ma¸oblock
 *
MbQ
, 
edge
);

33 
edge_lo›_luma_h‹_MBAff
 (
Cﬁ‹Pœ√
 
∂
, 
img≥l
** 
Img
, 
byã
 
Såígth
[
MB_BLOCK_SIZE
], 
Ma¸oblock
 *
MbQ
, 
edge
, 
width
);

34 
edge_lo›_chroma_vî_MBAff
 (
img≥l
** 
Img
, 
byã
 
Såígth
[
MB_BLOCK_SIZE
], 
Ma¸oblock
 *
MbQ
, 
edge
, 
uv
);

35 
edge_lo›_chroma_h‹_MBAff
 (
img≥l
** 
Img
, 
byã
 
Såígth
[
MB_BLOCK_SIZE
], 
Ma¸oblock
 *
MbQ
, 
edge
, 
width
, 
uv
);

38 
	$£t_lo›_fûãr_fun˘i⁄s_mbaff
(
VideoP¨amëîs
 *
p_Vid
)

40 
p_Vid
->
GëSåígthVî
 = 
gë_°ªngth_vî_MBAff
;

41 
p_Vid
->
GëSåígthH‹
 = 
gë_°ªngth_h‹_MBAff
;

42 
p_Vid
->
EdgeLo›LumaVî
 = 
edge_lo›_luma_vî_MBAff
;

43 
p_Vid
->
EdgeLo›LumaH‹
 = 
edge_lo›_luma_h‹_MBAff
;

44 
p_Vid
->
EdgeLo›ChromaVî
 = 
edge_lo›_chroma_vî_MBAff
;

45 
p_Vid
->
EdgeLo›ChromaH‹
 = 
edge_lo›_chroma_h‹_MBAff
;

46 
	}
}

54 
	$gë_°ªngth_vî_MBAff
(
byã
 
Såígth
[
MB_BLOCK_SIZE
], 
Ma¸oblock
 *
MbQ
, 
edge
, 
mvlimô
)

56 
blkP
, 
blkQ
, 
idx
;

57 
blk_x
, 
blk_x2
, 
blk_y
, 
blk_y2
 ;

59 
xQ
, 
yQ
;

60 
mb_x
, 
mb_y
;

62 
Ma¸oblock
 *
MbP
;

64 
PixñPos
 
pixP
;

65 
VideoP¨amëîs
 *
p_Vid
 = 
MbQ
->p_Vid;

66 
PicMŸi⁄P¨ams
 **
mv_öfo
 = 
p_Vid
->
íc_pi˘uª
->mv_info;

68  
idx
 = 0; idx < 16; ++idx )

70 
xQ
 = 
edge
;

71 
yQ
 = 
idx
;

72 
p_Vid
->
	`gëNeighbour
(
MbQ
, 
xQ
 - 1, 
yQ
,Ö_Vid->
mb_size
[
IS_LUMA
], &
pixP
);

73 
blkQ
 = (Ë((
yQ
 & 0xFFFCË+ (
xQ
 >> 2));

74 
blkP
 = (Ë((
pixP
.
y
 & 0xFFFCË+ (pixP.
x
 >> 2));

76 
MbP
 = &(
p_Vid
->
mb_d©a
[
pixP
.
mb_addr
]);

77 
p_Vid
->
mixedModeEdgeFœg
 = (
byã
Ë(
MbQ
->
mb_fõld
 !
MbP
->mb_field);

79 i‡(
p_Vid
->
ty≥
==
SP_SLICE
 ||Ö_Vid->ty≥==
SI_SLICE
)

81 
Såígth
[
idx
] = (
edge
 == 0) ? 4 : 3;

86 
Såígth
[
idx
] = (
edge
 == 0) ? 4 : 3;

88 if–!(
MbP
->
mb_ty≥
==
I4MB
 || MbP->mb_ty≥==
I16MB
 || MbP->mb_ty≥==
I8MB
 || MbP->mb_ty≥==
IPCM
)

89 && !(
MbQ
->
mb_ty≥
==
I4MB
 || MbQ->mb_ty≥==
I16MB
 || MbQ->mb_ty≥==
I8MB
 || MbQ->mb_ty≥==
IPCM
) )

91 if–((
MbQ
->
cbp_blk
 & ((
öt64
)1 << 
blkQ
 )Ë!0Ë|| ((
MbP
->cbp_blk & ((öt64)1 << 
blkP
)) != 0) )

92 
Såígth
[
idx
] = 2 ;

98 i‡(
p_Vid
->
mixedModeEdgeFœg
)

100 (
Såígth
[
idx
] = 1);

104 
p_Vid
->
	`gë_mb_block_pos
 (p_Vid->
PicPos
, 
MbQ
->
mbAddrX
, &
mb_x
, &
mb_y
);

105 
blk_y
 = (Ë((
mb_y
<<2Ë+ (
blkQ
 >> 2));

106 
blk_x
 = (Ë((
mb_x
<<2Ë+ (
blkQ
 & 3));

107 
blk_y2
 = (Ë(
pixP
.
pos_y
 >> 2);

108 
blk_x2
 = (Ë(
pixP
.
pos_x
 >> 2);

110 
PicMŸi⁄P¨ams
 *
mv_öfo_p
 = &
mv_öfo
[
blk_y
 ][
blk_x
 ];

111 
PicMŸi⁄P¨ams
 *
mv_öfo_q
 = &
mv_öfo
[
blk_y2
][
blk_x2
];

113 
St‹abÀPi˘uªPå
 
ªf_p0
 = 
mv_öfo_p
->
ªf_idx
[
LIST_0
] =-1 ? 
NULL
 : mv_öfo_p->
ªf_pic
[LIST_0];

114 
St‹abÀPi˘uªPå
 
ªf_q0
 = 
mv_öfo_q
->
ªf_idx
[
LIST_0
] =-1 ? 
NULL
 : mv_öfo_q->
ªf_pic
[LIST_0];

115 
St‹abÀPi˘uªPå
 
ªf_p1
 = 
mv_öfo_p
->
ªf_idx
[
LIST_1
] =-1 ? 
NULL
 : mv_öfo_p->
ªf_pic
[LIST_1];

116 
St‹abÀPi˘uªPå
 
ªf_q1
 = 
mv_öfo_q
->
ªf_idx
[
LIST_1
] =-1 ? 
NULL
 : mv_öfo_q->
ªf_pic
[LIST_1];

118 i‡–((
ªf_p0
==
ªf_q0
Ë&& (
ªf_p1
==
ªf_q1
)) ||

119 ((
ªf_p0
==
ªf_q1
Ë&& (
ªf_p1
==
ªf_q0
)))

121 
Såígth
[
idx
]=0;

123 i‡(
ªf_p0
 !
ªf_p1
)

126 i‡(
ªf_p0
==
ªf_q0
)

128 
Såígth
[
idx
] = (
byã
) (

129 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_0
], &
mv_öfo_q
->mv[LIST_0], 
mvlimô
) ||

130 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_1
], &
mv_öfo_q
->mv[LIST_1], 
mvlimô
));

134 
Såígth
[
idx
] = (
byã
) (

135 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_0
], &
mv_öfo_q
->mv[
LIST_1
], 
mvlimô
) ||

136 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_1
], &
mv_öfo_q
->mv[
LIST_0
], 
mvlimô
));

142 
Såígth
[
idx
] = (
byã
) ((

143 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_0
], &
mv_öfo_q
->mv[LIST_0], 
mvlimô
) ||

144 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_1
], &
mv_öfo_q
->mv[LIST_1], 
mvlimô
))

146 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_0
], &
mv_öfo_q
->mv[
LIST_1
], 
mvlimô
) ||

147 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_1
], &
mv_öfo_q
->mv[
LIST_0
], 
mvlimô
)));

152 
Såígth
[
idx
] = 1;

160 
	}
}

168 
	$gë_°ªngth_h‹_MBAff
(
byã
 
Såígth
[
MB_BLOCK_SIZE
], 
Ma¸oblock
 *
MbQ
, 
edge
, 
mvlimô
)

170 
blkP
, 
blkQ
, 
idx
;

171 
blk_x
, 
blk_x2
, 
blk_y
, 
blk_y2
 ;

173 
xQ
, 
yQ
;

174 
mb_x
, 
mb_y
;

176 
Ma¸oblock
 *
MbP
;

178 
PixñPos
 
pixP
;

179 
VideoP¨amëîs
 *
p_Vid
 = 
MbQ
->p_Vid;

180 
PicMŸi⁄P¨ams
 **
mv_öfo
 = 
p_Vid
->
íc_pi˘uª
->mv_info;

183  
idx
 = 0; idx < 16; ++idx )

185 
xQ
 = 
idx
;

186 
yQ
 = (
edge
 < 
MB_BLOCK_SIZE
 ?Édge : 1);

187 
p_Vid
->
	`gëNeighbour
(
MbQ
, 
xQ
, 
yQ
 - 1,Ö_Vid->
mb_size
[
IS_LUMA
], &
pixP
);

188 
blkQ
 = (Ë((
yQ
 & 0xFFFCË+ (
xQ
 >> 2));

189 
blkP
 = (Ë((
pixP
.
y
 & 0xFFFCË+ (pixP.
x
 >> 2));

191 
MbP
 = &(
p_Vid
->
mb_d©a
[
pixP
.
mb_addr
]);

192 
p_Vid
->
mixedModeEdgeFœg
 = (
byã
Ë(
MbQ
->
mb_fõld
 !
MbP
->mb_field);

194 i‡(
p_Vid
->
ty≥
==
SP_SLICE
 ||Ö_Vid->ty≥==
SI_SLICE
)

196 
Såígth
[
idx
] = (
edge
 =0 && (((!
p_Vid
->
mb_aff_‰ame_Êag
 && (p_Vid->
°ru˘uª
==
FRAME
)) ||

197 (
p_Vid
->
mb_aff_‰ame_Êag
 && !
MbP
->
mb_fõld
 && !
MbQ
->mb_field)))) ? 4 : 3;

202 
Såígth
[
idx
] = (
edge
 =0 && (((!
p_Vid
->
mb_aff_‰ame_Êag
 && (p_Vid->
°ru˘uª
==
FRAME
)) ||

203 (
p_Vid
->
mb_aff_‰ame_Êag
 && !
MbP
->
mb_fõld
 && !
MbQ
->mb_field)))) ? 4 : 3;

205 if–!(
MbP
->
mb_ty≥
==
I4MB
 || MbP->mb_ty≥==
I16MB
 || MbP->mb_ty≥==
I8MB
 || MbP->mb_ty≥==
IPCM
)

206 && !(
MbQ
->
mb_ty≥
==
I4MB
 || MbQ->mb_ty≥==
I16MB
 || MbQ->mb_ty≥==
I8MB
 || MbQ->mb_ty≥==
IPCM
) )

208 if–((
MbQ
->
cbp_blk
 & ((
öt64
)1 << 
blkQ
 )Ë!0Ë|| ((
MbP
->cbp_blk & ((öt64)1 << 
blkP
)) != 0) )

209 
Såígth
[
idx
] = 2 ;

215 i‡(
p_Vid
->
mixedModeEdgeFœg
)

217 (
Såígth
[
idx
] = 1);

221 
p_Vid
->
	`gë_mb_block_pos
 (p_Vid->
PicPos
, 
MbQ
->
mbAddrX
, &
mb_x
, &
mb_y
);

222 
blk_y
 = (Ë((
mb_y
<<2Ë+ (
blkQ
 >> 2));

223 
blk_x
 = (Ë((
mb_x
<<2Ë+ (
blkQ
 & 3));

224 
blk_y2
 = (Ë(
pixP
.
pos_y
 >> 2);

225 
blk_x2
 = (Ë(
pixP
.
pos_x
 >> 2);

227 
PicMŸi⁄P¨ams
 *
mv_öfo_p
 = &
mv_öfo
[
blk_y
 ][
blk_x
 ];

228 
PicMŸi⁄P¨ams
 *
mv_öfo_q
 = &
mv_öfo
[
blk_y2
][
blk_x2
];

230 
St‹abÀPi˘uªPå
 
ªf_p0
 = 
mv_öfo_p
->
ªf_idx
[
LIST_0
] =-1 ? 
NULL
 : mv_öfo_p->
ªf_pic
[LIST_0];

231 
St‹abÀPi˘uªPå
 
ªf_q0
 = 
mv_öfo_q
->
ªf_idx
[
LIST_0
] =-1 ? 
NULL
 : mv_öfo_q->
ªf_pic
[LIST_0];

232 
St‹abÀPi˘uªPå
 
ªf_p1
 = 
mv_öfo_p
->
ªf_idx
[
LIST_1
] =-1 ? 
NULL
 : mv_öfo_p->
ªf_pic
[LIST_1];

233 
St‹abÀPi˘uªPå
 
ªf_q1
 = 
mv_öfo_q
->
ªf_idx
[
LIST_1
] =-1 ? 
NULL
 : mv_öfo_q->
ªf_pic
[LIST_1];

235 i‡–((
ªf_p0
==
ªf_q0
Ë&& (
ªf_p1
==
ªf_q1
)) ||

236 ((
ªf_p0
==
ªf_q1
Ë&& (
ªf_p1
==
ªf_q0
)))

238 
Såígth
[
idx
]=0;

240 i‡(
ªf_p0
 !
ªf_p1
)

243 i‡(
ªf_p0
==
ªf_q0
)

245 
Såígth
[
idx
] = (
byã
) (

246 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_0
], &
mv_öfo_q
->mv[LIST_0], 
mvlimô
) ||

247 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_1
], &
mv_öfo_q
->mv[LIST_1], 
mvlimô
));

251 
Såígth
[
idx
] = (
byã
) (

252 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_0
], &
mv_öfo_q
->mv[
LIST_1
], 
mvlimô
) ||

253 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_1
], &
mv_öfo_q
->mv[
LIST_0
], 
mvlimô
));

259 
Såígth
[
idx
] = (
byã
) ((

260 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_0
], &
mv_öfo_q
->mv[LIST_0], 
mvlimô
) ||

261 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_1
], &
mv_öfo_q
->mv[LIST_1], 
mvlimô
))

263 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_0
], &
mv_öfo_q
->mv[
LIST_1
], 
mvlimô
) ||

264 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_1
], &
mv_öfo_q
->mv[
LIST_0
], 
mvlimô
)));

269 
Såígth
[
idx
] = 1;

277 
	}
}

288 
	$edge_lo›_luma_vî_MBAff
(
Cﬁ‹Pœ√
 
∂
, 
img≥l
** 
Img
, 
byã
 
Såígth
[16], 
Ma¸oblock
 *
MbQ
, 
edge
)

290 
≥l
, 
≠
 = 0, 
aq
 = 0, 
Sång
 ;

291 
C0
, 
tc0
, 
dif
;

292 
img≥l
 
L2
 = 0, 
L1
, 
L0
, 
R0
, 
R1
, 
R2
 = 0, 
L3
, 
R3
;

293 
RL0
;

294 
AÕha
 = 0, 
Bëa
 = 0 ;

295 c⁄° 
byã
* 
ClùTab
 = 
NULL
;

296 
smÆl_g≠
;

297 
ödexA
, 
ödexB
;

299 
QP
;

300 
xQ
, 
yQ
;

302 
PixñPos
 
pixP
, 
pixQ
;

304 
VideoP¨amëîs
 *
p_Vid
 = 
MbQ
->p_Vid;

305 
bôdïth_sˇÀ
 = 
∂
? 
p_Vid
->bôdïth_sˇÀ[
IS_CHROMA
] :Ö_Vid->bôdïth_sˇÀ[
IS_LUMA
];

306 
max_img≥l_vÆue
 = 
p_Vid
->
max_≥l_vÆue_comp
[
∂
];

308 
AÕhaC0Off£t
 = 
MbQ
->
DFAÕhaC0Off£t
;

309 
BëaOff£t
 = 
MbQ
->
DFBëaOff£t
;

311 
Ma¸oblock
 *
MbP
;

312 
img≥l
 *
SrcPåP
, *
SrcPåQ
;

314  
≥l
 = 0 ;Öñ < 
MB_BLOCK_SIZE
 ; ++pel )

316 
xQ
 = 
edge
;

317 
yQ
 = 
≥l
;

318 
p_Vid
->
	`gëNeighbour
(
MbQ
, 
xQ
 - 1, 
yQ
,Ö_Vid->
mb_size
[
IS_LUMA
], &
pixP
);

320 i‡(
pixP
.
avaûabÀ
 || (
MbQ
->
DFDißbÀIdc
== 0))

322 if–(
Sång
 = 
Såígth
[
≥l
]) != 0)

324 
p_Vid
->
	`gëNeighbour
(
MbQ
, 
xQ
, 
yQ
,Ö_Vid->
mb_size
[
IS_LUMA
], &
pixQ
);

326 
MbP
 = &(
p_Vid
->
mb_d©a
[
pixP
.
mb_addr
]);

328 
SrcPåQ
 = &(
Img
[
pixQ
.
pos_y
][pixQ.
pos_x
]);

329 
SrcPåP
 = &(
Img
[
pixP
.
pos_y
][pixP.
pos_x
]);

332 
QP
 = 
∂
? ((
MbP
->
qpc
[∂-1] + 
MbQ
->qpc[∂-1] + 1Ë>> 1Ë: (MbP->
qp
 + MbQ->qp + 1) >> 1;

334 
ödexA
 = 
	`iClù3
(0, 
MAX_QP
, 
QP
 + 
AÕhaC0Off£t
);

335 
ödexB
 = 
	`iClù3
(0, 
MAX_QP
, 
QP
 + 
BëaOff£t
);

337 
AÕha
 = 
ALPHA_TABLE
[
ödexA
] * 
bôdïth_sˇÀ
;

338 
Bëa
 = 
BETA_TABLE
 [
ödexB
] * 
bôdïth_sˇÀ
;

339 
ClùTab
 = 
CLIP_TAB
[
ödexA
];

341 
L3
 = 
SrcPåP
[-3];

342 
L2
 = 
SrcPåP
[-2];

343 
L1
 = 
SrcPåP
[-1];

344 
L0
 = 
SrcPåP
[0] ;

345 
R0
 = 
SrcPåQ
[0] ;

346 
R1
 = 
SrcPåQ
[ 1];

347 
R2
 = 
SrcPåQ
[ 2];

348 
R3
 = 
SrcPåQ
[ 3];

350 if–
	`übs
–
R0
 - 
L0
 ) < 
AÕha
 )

352 i‡((
	`übs
–
R0
 - 
R1
Ë< 
Bëa
 ) && (übs(
L0
 - 
L1
) < Beta ))

354 if(
Sång
 == 4 )

356 
RL0
 = 
L0
 + 
R0
;

357 
smÆl_g≠
 = (
	`übs
–
R0
 - 
L0
 ) < ((
AÕha
 >> 2) + 2));

358 
aq
 = ( 
	`übs
–
R0
 - 
R2
Ë< 
Bëa
 ) & 
smÆl_g≠
;

359 
≠
 = ( 
	`übs
–
L0
 - 
L2
Ë< 
Bëa
 ) & 
smÆl_g≠
;

361 i‡(
≠
)

363 
SrcPåP
[-2 ] = (
img≥l
Ë((((
L3
 + 
L2
Ë<< 1Ë+ L2 + 
L1
 + 
RL0
 + 4) >> 3);

364 
SrcPåP
[-1 ] = (
img≥l
Ë(–
L2
 + 
L1
 + 
L0
 + 
R0
 + 2) >> 2);

365 
SrcPåP
[ 0 ] = (
img≥l
Ë(–
R1
 + ((
L1
 + 
RL0
Ë<< 1Ë+ 
L2
 + 4) >> 3);

369 
SrcPåP
[ 0 ] = (
img≥l
Ë(((
L1
 << 1Ë+ 
L0
 + 
R1
 + 2) >> 2) ;

372 i‡(
aq
)

374 
SrcPåQ
[ 0 ] = (
img≥l
Ë(–
L1
 + ((
R1
 + 
RL0
Ë<< 1Ë+ 
R2
 + 4) >> 3);

375 
SrcPåQ
[ 1 ] = (
img≥l
Ë(–
R2
 + 
R0
 + 
R1
 + 
L0
 + 2) >> 2);

376 
SrcPåQ
[ 2 ] = (
img≥l
Ë((((
R3
 + 
R2
Ë<< 1Ë+ R2 + 
R1
 + 
RL0
 + 4) >> 3);

380 
SrcPåQ
[ 0 ] = (
img≥l
Ë(((
R1
 << 1Ë+ 
R0
 + 
L1
 + 2) >> 2);

385 
RL0
 = (
L0
 + 
R0
 + 1) >> 1;

386 
aq
 = (
	`übs
–
R0
 - 
R2
Ë< 
Bëa
);

387 
≠
 = (
	`übs
–
L0
 - 
L2
Ë< 
Bëa
);

389 
C0
 = 
ClùTab
[ 
Sång
 ] * 
bôdïth_sˇÀ
;

390 
tc0
 = (
C0
 + 
≠
 + 
aq
) ;

391 
dif
 = 
	`iClù3
–-
tc0
,Åc0, (((
R0
 - 
L0
Ë<< 2Ë+ (
L1
 - 
R1
) + 4) >> 3) ;

393 if–
≠
 )

394 *(
SrcPåP
 - 1Ë+
	`iClù3
–-
C0
, C0, ( 
L2
 + 
RL0
 - (
L1
 << 1)) >> 1 ) ;

396 *
SrcPåP
 = (
img≥l
Ë
	`iClù1
 (
max_img≥l_vÆue
, 
L0
 + 
dif
) ;

397 *
SrcPåQ
 = (
img≥l
Ë
	`iClù1
 (
max_img≥l_vÆue
, 
R0
 - 
dif
) ;

399 if–
aq
 )

400 *(
SrcPåQ
 + 1Ë+
	`iClù3
–-
C0
, C0, ( 
R2
 + 
RL0
 - (
R1
 << 1)) >> 1 ) ;

407 
	}
}

415 
	$edge_lo›_luma_h‹_MBAff
(
Cﬁ‹Pœ√
 
∂
, 
img≥l
** 
Img
, 
byã
 
Såígth
[16], 
Ma¸oblock
 *
MbQ
, 
edge
, 
width
)

417 
≥l
, 
≠
 = 0, 
aq
 = 0, 
Sång
 ;

418 
öcP
, 
öcQ
;

419 
C0
, 
tc0
, 
dif
;

420 
img≥l
 
L2
 = 0, 
L1
, 
L0
, 
R0
, 
R1
, 
R2
 = 0, 
L3
, 
R3
;

421 
RL0
;

422 
AÕha
 = 0, 
Bëa
 = 0 ;

423 c⁄° 
byã
* 
ClùTab
 = 
NULL
;

424 
smÆl_g≠
;

425 
ödexA
, 
ödexB
;

427 
QP
;

428 
xQ
, 
yQ
;

430 
PixñPos
 
pixP
, 
pixQ
;

431 
VideoP¨amëîs
 *
p_Vid
 = 
MbQ
->p_Vid;

432 
bôdïth_sˇÀ
 = 
∂
? 
p_Vid
->bôdïth_sˇÀ[
IS_CHROMA
] :Ö_Vid->bôdïth_sˇÀ[
IS_LUMA
];

433 
max_img≥l_vÆue
 = 
p_Vid
->
max_≥l_vÆue_comp
[
∂
];

435 
AÕhaC0Off£t
 = 
MbQ
->
DFAÕhaC0Off£t
;

436 
BëaOff£t
 = 
MbQ
->
DFBëaOff£t
;

438 
Ma¸oblock
 *
MbP
;

439 
img≥l
 *
SrcPåP
, *
SrcPåQ
;

441  
≥l
 = 0 ;Öñ < 
MB_BLOCK_SIZE
 ; ++pel )

443 
xQ
 = 
≥l
;

444 
yQ
 = (
edge
 < 16 ?Édge : 1);

445 
p_Vid
->
	`gëNeighbour
(
MbQ
, 
xQ
, 
yQ
 - 1,Ö_Vid->
mb_size
[
IS_LUMA
], &
pixP
);

447 i‡(
pixP
.
avaûabÀ
 || (
MbQ
->
DFDißbÀIdc
== 0))

449 if–(
Sång
 = 
Såígth
[
≥l
]) != 0)

451 
p_Vid
->
	`gëNeighbour
(
MbQ
, 
xQ
, 
yQ
,Ö_Vid->
mb_size
[
IS_LUMA
], &
pixQ
);

453 
MbP
 = &(
p_Vid
->
mb_d©a
[
pixP
.
mb_addr
]);

455 
öcQ
 = ((
MbP
->
mb_fõld
 && !
MbQ
->mb_fõldË? 2 * 
width
 : width);

456 
öcP
 = ((
MbQ
->
mb_fõld
 && !
MbP
->mb_fõldË? 2 * 
width
 : width);

457 
SrcPåQ
 = &(
Img
[
pixQ
.
pos_y
][pixQ.
pos_x
]);

458 
SrcPåP
 = &(
Img
[
pixP
.
pos_y
][pixP.
pos_x
]);

461 
QP
 = 
∂
? ((
MbP
->
qpc
[∂-1] + 
MbQ
->qpc[∂-1] + 1Ë>> 1Ë: (MbP->
qp
 + MbQ->qp + 1) >> 1;

463 
ödexA
 = 
	`iClù3
(0, 
MAX_QP
, 
QP
 + 
AÕhaC0Off£t
);

464 
ödexB
 = 
	`iClù3
(0, 
MAX_QP
, 
QP
 + 
BëaOff£t
);

466 
AÕha
 = 
ALPHA_TABLE
[
ödexA
] * 
bôdïth_sˇÀ
;

467 
Bëa
 = 
BETA_TABLE
 [
ödexB
] * 
bôdïth_sˇÀ
;

468 
ClùTab
 = 
CLIP_TAB
[
ödexA
];

470 
L3
 = 
SrcPåP
[-
öcP
*3];

471 
L2
 = 
SrcPåP
[-
öcP
*2];

472 
L1
 = 
SrcPåP
[-
öcP
];

473 
L0
 = 
SrcPåP
[0] ;

474 
R0
 = 
SrcPåQ
[0] ;

475 
R1
 = 
SrcPåQ
[ 
öcQ
];

476 
R2
 = 
SrcPåQ
[ 
öcQ
*2];

477 
R3
 = 
SrcPåQ
[ 
öcQ
*3];

479 if–
	`übs
–
R0
 - 
L0
 ) < 
AÕha
 )

481 i‡((
	`übs
–
R0
 - 
R1
Ë< 
Bëa
 ) && (übs(
L0
 - 
L1
) < Beta ))

483 if(
Sång
 == 4 )

485 
RL0
 = 
L0
 + 
R0
;

486 
smÆl_g≠
 = (
	`übs
–
R0
 - 
L0
 ) < ((
AÕha
 >> 2) + 2));

487 
aq
 = ( 
	`übs
–
R0
 - 
R2
Ë< 
Bëa
 ) & 
smÆl_g≠
;

488 
≠
 = ( 
	`übs
–
L0
 - 
L2
Ë< 
Bëa
 ) & 
smÆl_g≠
;

490 i‡(
≠
)

492 
SrcPåP
[-
öcP
 * 2] = (
img≥l
Ë((((
L3
 + 
L2
Ë<< 1Ë+ L2 + 
L1
 + 
RL0
 + 4) >> 3);

493 
SrcPåP
[-
öcP
 ] = (
img≥l
Ë(–
L2
 + 
L1
 + 
L0
 + 
R0
 + 2) >> 2);

494 
SrcPåP
[ 0 ] = (
img≥l
Ë(–
R1
 + ((
L1
 + 
RL0
Ë<< 1Ë+ 
L2
 + 4) >> 3);

498 
SrcPåP
[ 0 ] = (
img≥l
Ë(((
L1
 << 1Ë+ 
L0
 + 
R1
 + 2) >> 2) ;

501 i‡(
aq
)

503 
SrcPåQ
[ 0 ] = (
img≥l
Ë(–
L1
 + ((
R1
 + 
RL0
Ë<< 1Ë+ 
R2
 + 4) >> 3);

504 
SrcPåQ
[ 
öcQ
 ] = (
img≥l
Ë(–
R2
 + 
R0
 + 
R1
 + 
L0
 + 2) >> 2);

505 
SrcPåQ
[ 
öcQ
 * 2 ] = (
img≥l
Ë((((
R3
 + 
R2
Ë<< 1Ë+ R2 + 
R1
 + 
RL0
 + 4) >> 3);

509 
SrcPåQ
[ 0 ] = (
img≥l
Ë(((
R1
 << 1Ë+ 
R0
 + 
L1
 + 2) >> 2);

514 
RL0
 = (
L0
 + 
R0
 + 1) >> 1;

515 
aq
 = (
	`übs
–
R0
 - 
R2
Ë< 
Bëa
);

516 
≠
 = (
	`übs
–
L0
 - 
L2
Ë< 
Bëa
);

518 
C0
 = 
ClùTab
[ 
Sång
 ] * 
bôdïth_sˇÀ
;

519 
tc0
 = (
C0
 + 
≠
 + 
aq
) ;

520 
dif
 = 
	`iClù3
–-
tc0
,Åc0, (((
R0
 - 
L0
Ë<< 2Ë+ (
L1
 - 
R1
) + 4) >> 3) ;

522 if–
≠
 )

523 *(
SrcPåP
 - 
öcP
Ë+
	`iClù3
–-
C0
, C0, ( 
L2
 + 
RL0
 - (
L1
 << 1)) >> 1 ) ;

525 *
SrcPåP
 = (
img≥l
Ë
	`iClù1
 (
max_img≥l_vÆue
, 
L0
 + 
dif
) ;

526 *
SrcPåQ
 = (
img≥l
Ë
	`iClù1
 (
max_img≥l_vÆue
, 
R0
 - 
dif
) ;

528 if–
aq
 )

529 *(
SrcPåQ
 + 
öcQ
Ë+
	`iClù3
–-
C0
, C0, ( 
R2
 + 
RL0
 - (
R1
 << 1)) >> 1 ) ;

536 
	}
}

544 
	$edge_lo›_chroma_vî_MBAff
(
img≥l
** 
Img
, 
byã
 
Såígth
[16], 
Ma¸oblock
 *
MbQ
, 
edge
, 
uv
)

546 
≥l
, 
Sång
 ;

547 
C0
, 
tc0
, 
dif
;

548 
img≥l
 
L1
, 
L0
, 
R0
, 
R1
;

549 
AÕha
 = 0, 
Bëa
 = 0;

550 c⁄° 
byã
* 
ClùTab
 = 
NULL
;

551 
ödexA
, 
ödexB
;

552 
VideoP¨amëîs
 *
p_Vid
 = 
MbQ
->p_Vid;

553 
PñNum
 = 
≥ um_¸
[0][
p_Vid
->
yuv_f‹m©
];

554 
SåígthIdx
;

555 
QP
;

556 
xQ
, 
yQ
;

557 
PixñPos
 
pixP
, 
pixQ
;

558 
bôdïth_sˇÀ
 = 
p_Vid
->bôdïth_sˇÀ[
IS_CHROMA
];

559 
max_img≥l_vÆue
 = 
p_Vid
->
max_≥l_vÆue_comp
[
uv
 + 1];

561 
AÕhaC0Off£t
 = 
MbQ
->
DFAÕhaC0Off£t
;

562 
BëaOff£t
 = 
MbQ
->
DFBëaOff£t
;

563 
Ma¸oblock
 *
MbP
;

564 
img≥l
 *
SrcPåP
, *
SrcPåQ
;

566  
≥l
 = 0 ;Öñ < 
PñNum
 ; ++pel )

568 
xQ
 = 
edge
;

569 
yQ
 = 
≥l
;

570 
p_Vid
->
	`gëNeighbour
(
MbQ
, 
xQ
, 
yQ
,Ö_Vid->
mb_size
[
IS_CHROMA
], &
pixQ
);

571 
p_Vid
->
	`gëNeighbour
(
MbQ
, 
xQ
 - 1, 
yQ
,Ö_Vid->
mb_size
[
IS_CHROMA
], &
pixP
);

572 
MbP
 = &(
p_Vid
->
mb_d©a
[
pixP
.
mb_addr
]);

573 
SåígthIdx
 = (
PñNum
 =8Ë? ((
MbQ
->
mb_fõld
 && !
MbP
->mb_fõldË? 
≥l
 << 1 :((pel >> 1) << 2) + (pel & 0x01)) :Öel;

575 i‡(
pixP
.
avaûabÀ
 || (
MbQ
->
DFDißbÀIdc
 == 0))

577 if–(
Sång
 = 
Såígth
[
SåígthIdx
]) != 0)

579 
SrcPåQ
 = &(
Img
[
pixQ
.
pos_y
][pixQ.
pos_x
]);

580 
SrcPåP
 = &(
Img
[
pixP
.
pos_y
][pixP.
pos_x
]);

583 
QP
 = (
MbP
->
qpc
[
uv
] + 
MbQ
->qpc[uv] + 1) >> 1;

585 
ödexA
 = 
	`iClù3
(0, 
MAX_QP
, 
QP
 + 
AÕhaC0Off£t
);

586 
ödexB
 = 
	`iClù3
(0, 
MAX_QP
, 
QP
 + 
BëaOff£t
);

588 
AÕha
 = 
ALPHA_TABLE
[
ödexA
] * 
bôdïth_sˇÀ
;

589 
Bëa
 = 
BETA_TABLE
 [
ödexB
] * 
bôdïth_sˇÀ
;

590 
ClùTab
 = 
CLIP_TAB
[
ödexA
];

592 
L1
 = 
SrcPåP
[-1];

593 
L0
 = 
SrcPåP
[0] ;

594 
R0
 = 
SrcPåQ
[0] ;

595 
R1
 = 
SrcPåQ
[ 1];

597 if–
	`übs
–
R0
 - 
L0
 ) < 
AÕha
 )

599 if–((
	`übs
–
R0
 - 
R1
Ë- 
Bëa
 < 0Ë&& (übs(
L0
 - 
L1
) - Beta < 0 )) )

601 if–
Sång
 == 4 )

603 
SrcPåQ
[0] = (
img≥l
Ë–((
R1
 << 1Ë+ 
R0
 + 
L1
 + 2) >> 2 );

604 
SrcPåP
[0] = (
img≥l
Ë–((
L1
 << 1Ë+ 
L0
 + 
R1
 + 2) >> 2 );

608 
C0
 = 
ClùTab
[ 
Sång
 ] * 
bôdïth_sˇÀ
;

609 
tc0
 = (
C0
 + 1);

610 
dif
 = 
	`iClù3
–-
tc0
,Åc0, ( ((
R0
 - 
L0
Ë<< 2Ë+ (
L1
 - 
R1
) + 4) >> 3 );

612 
SrcPåP
[0] = (
img≥l
Ë
	`iClù1
 ( 
max_img≥l_vÆue
, 
L0
 + 
dif
 );

613 
SrcPåQ
[0] = (
img≥l
Ë
	`iClù1
 ( 
max_img≥l_vÆue
, 
R0
 - 
dif
 );

620 
	}
}

628 
	$edge_lo›_chroma_h‹_MBAff
(
img≥l
** 
Img
, 
byã
 
Såígth
[16], 
Ma¸oblock
 *
MbQ
, 
edge
, 
width
, 
uv
)

630 
≥l
, 
Sång
 ;

631 
öcP
, 
öcQ
;

632 
C0
, 
tc0
, 
dif
;

633 
img≥l
 
L1
, 
L0
, 
R0
, 
R1
;

634 
AÕha
 = 0, 
Bëa
 = 0;

635 c⁄° 
byã
* 
ClùTab
 = 
NULL
;

636 
ödexA
, 
ödexB
;

637 
VideoP¨amëîs
 *
p_Vid
 = 
MbQ
->p_Vid;

638 
PñNum
 = 
≥ um_¸
[1][
p_Vid
->
yuv_f‹m©
];

639 
SåígthIdx
;

640 
QP
;

641 
xQ
, 
yQ
;

642 
PixñPos
 
pixP
, 
pixQ
;

643 
bôdïth_sˇÀ
 = 
p_Vid
->bôdïth_sˇÀ[
IS_CHROMA
];

644 
max_img≥l_vÆue
 = 
p_Vid
->
max_≥l_vÆue_comp
[
uv
 + 1];

646 
AÕhaC0Off£t
 = 
MbQ
->
DFAÕhaC0Off£t
;

647 
BëaOff£t
 = 
MbQ
->
DFBëaOff£t
;

648 
Ma¸oblock
 *
MbP
;

649 
img≥l
 *
SrcPåP
, *
SrcPåQ
;

651  
≥l
 = 0 ;Öñ < 
PñNum
 ; ++pel )

653 
xQ
 = 
≥l
;

654 
yQ
 = (
edge
 < 16?Édge : 1);

655 
p_Vid
->
	`gëNeighbour
(
MbQ
, 
xQ
, 
yQ
,Ö_Vid->
mb_size
[
IS_CHROMA
], &
pixQ
);

656 
p_Vid
->
	`gëNeighbour
(
MbQ
, 
xQ
, 
yQ
 - 1,Ö_Vid->
mb_size
[
IS_CHROMA
], &
pixP
);

657 
MbP
 = &(
p_Vid
->
mb_d©a
[
pixP
.
mb_addr
]);

658 
SåígthIdx
 = (
PñNum
 =8Ë? ((
MbQ
->
mb_fõld
 && !
MbP
->mb_fõldË? 
≥l
 << 1 :((pel >> 1) << 2) + (pel & 0x01)) :Öel;

660 i‡(
pixP
.
avaûabÀ
 || (
MbQ
->
DFDißbÀIdc
 == 0))

662 if–(
Sång
 = 
Såígth
[
SåígthIdx
]) != 0)

664 
öcQ
 = ((
MbP
->
mb_fõld
 && !
MbQ
->mb_fõldË? 2 * 
width
 : width);

665 
öcP
 = ((
MbQ
->
mb_fõld
 && !
MbP
->mb_fõldË? 2 * 
width
 : width);

666 
SrcPåQ
 = &(
Img
[
pixQ
.
pos_y
][pixQ.
pos_x
]);

667 
SrcPåP
 = &(
Img
[
pixP
.
pos_y
][pixP.
pos_x
]);

670 
QP
 = (
MbP
->
qpc
[
uv
] + 
MbQ
->qpc[uv] + 1) >> 1;

672 
ödexA
 = 
	`iClù3
(0, 
MAX_QP
, 
QP
 + 
AÕhaC0Off£t
);

673 
ödexB
 = 
	`iClù3
(0, 
MAX_QP
, 
QP
 + 
BëaOff£t
);

675 
AÕha
 = 
ALPHA_TABLE
[
ödexA
] * 
bôdïth_sˇÀ
;

676 
Bëa
 = 
BETA_TABLE
 [
ödexB
] * 
bôdïth_sˇÀ
;

677 
ClùTab
 = 
CLIP_TAB
[
ödexA
];

679 
L1
 = 
SrcPåP
[-
öcP
];

680 
L0
 = 
SrcPåP
[0] ;

681 
R0
 = 
SrcPåQ
[0] ;

682 
R1
 = 
SrcPåQ
[ 
öcQ
];

684 if–
	`übs
–
R0
 - 
L0
 ) < 
AÕha
 )

686 if–((
	`übs
–
R0
 - 
R1
Ë- 
Bëa
 < 0Ë&& (übs(
L0
 - 
L1
) - Beta < 0 )) )

688 if–
Sång
 == 4 )

690 
SrcPåQ
[0] = (
img≥l
Ë–((
R1
 << 1Ë+ 
R0
 + 
L1
 + 2) >> 2 );

691 
SrcPåP
[0] = (
img≥l
Ë–((
L1
 << 1Ë+ 
L0
 + 
R1
 + 2) >> 2 );

695 
C0
 = 
ClùTab
[ 
Sång
 ] * 
bôdïth_sˇÀ
;

696 
tc0
 = (
C0
 + 1);

697 
dif
 = 
	`iClù3
–-
tc0
,Åc0, ( ((
R0
 - 
L0
Ë<< 2Ë+ (
L1
 - 
R1
) + 4) >> 3 );

699 
SrcPåP
[0] = (
img≥l
Ë
	`iClù1
 ( 
max_img≥l_vÆue
, 
L0
 + 
dif
 );

700 
SrcPåQ
[0] = (
img≥l
Ë
	`iClù1
 ( 
max_img≥l_vÆue
, 
R0
 - 
dif
 );

707 
	}
}

	@lencod/src/loop_filter_normal.c

23 
	~"globÆ.h
"

24 
	~"image.h
"

25 
	~"mb_ac˚ss.h
"

26 
	~"lo›_fûãr.h
"

28 
GëSåígthVî
 (
byã
 
Såígth
[
MB_BLOCK_SIZE
], 
Ma¸oblock
 *
MbQ
, 
edge
, 
mvlimô
);

29 
GëSåígthH‹
 (
byã
 
Såígth
[
MB_BLOCK_SIZE
], 
Ma¸oblock
 *
MbQ
, 
edge
, 
mvlimô
);

30 
EdgeLo›LumaVî
 (
Cﬁ‹Pœ√
 
∂
, 
img≥l
** 
Img
, 
byã
 
Såígth
[
MB_BLOCK_SIZE
], 
Ma¸oblock
 *
MbQ
, 
edge
);

31 
EdgeLo›LumaH‹
 (
Cﬁ‹Pœ√
 
∂
, 
img≥l
** 
Img
, 
byã
 
Såígth
[
MB_BLOCK_SIZE
], 
Ma¸oblock
 *
MbQ
, 
edge
, 
width
);

32 
EdgeLo›ChromaVî
 (
img≥l
** 
Img
, 
byã
 
Såígth
[
MB_BLOCK_SIZE
], 
Ma¸oblock
 *
MbQ
, 
edge
, 
uv
);

33 
EdgeLo›ChromaH‹
 (
img≥l
** 
Img
, 
byã
 
Såígth
[
MB_BLOCK_SIZE
], 
Ma¸oblock
 *
MbQ
, 
edge
, 
width
, 
uv
);

36 
	$£t_lo›_fûãr_fun˘i⁄s_n‹mÆ
(
VideoP¨amëîs
 *
p_Vid
)

38 
p_Vid
->
GëSåígthVî
 = GetStrengthVer;

39 
p_Vid
->
GëSåígthH‹
 = GetStrengthHor;

40 
p_Vid
->
EdgeLo›LumaVî
 = EdgeLoopLumaVer;

41 
p_Vid
->
EdgeLo›LumaH‹
 = EdgeLoopLumaHor;

42 
p_Vid
->
EdgeLo›ChromaVî
 = EdgeLoopChromaVer;

43 
p_Vid
->
EdgeLo›ChromaH‹
 = EdgeLoopChromaHor;

44 
	}
}

52 
	$GëSåígthVî
(
byã
 
Såígth
[
MB_BLOCK_SIZE
], 
Ma¸oblock
 *
MbQ
, 
edge
, 
mvlimô
)

54 
VideoP¨amëîs
 *
p_Vid
 = 
MbQ
->p_Vid;

55 
Sli˚
 *
cuºSli˚
 = 
MbQ
->
p_Sli˚
;

56 
SåVÆue
;

58 i‡((
cuºSli˚
->
¶i˚_ty≥
==
SP_SLICE
)||(cuºSli˚->¶i˚_ty≥==
SI_SLICE
) )

61 
SåVÆue
 = (
edge
 == 0) ? 4 : 3;

62 
	`mem£t
(
Såígth
, (
byã
Ë
SåVÆue
, 
MB_BLOCK_SIZE
 * (byte));

66 i‡(!(
MbQ
->
mb_ty≥
==
I4MB
||MbQ->mb_ty≥==
I8MB
||MbQ->mb_ty≥==
I16MB
||MbQ->mb_ty≥==
IPCM
))

68 
PixñPos
 
pixMB
;

69 
Ma¸oblock
 *
MbP
;

70 
xQ
 = 
edge
 - 1;

72 
	`gëN⁄AffNeighbour
(
MbQ
, 
xQ
, 0, 
p_Vid
->
mb_size
[
IS_LUMA
], &
pixMB
);

73 
MbP
 = (
edge
Ë? 
MbQ
 : &(
p_Vid
->
mb_d©a
[
pixMB
.
mb_addr
]);

75 i‡(!(
MbP
->
mb_ty≥
==
I4MB
||MbP->mb_ty≥==
I8MB
||MbP->mb_ty≥==
I16MB
||MbP->mb_ty≥==
IPCM
))

77 
PixñPos
 
pixP
 = 
pixMB
;

78 
PicMŸi⁄P¨ams
 **
mv_öfo
 = 
p_Vid
->
íc_pi˘uª
->mv_info;

80 
blkP
, 
blkQ
, 
idx
;

82 
mb_x
, 
mb_y
;

84 
	`gë_mb_block_pos_n‹mÆ
 (
p_Vid
->
PicPos
, 
MbQ
->
mbAddrX
, &
mb_x
, &
mb_y
);

85 
mb_x
 <<= 2;

86 
mb_y
 <<= 2;

88 
xQ
 ++;

90  
idx
 = 0 ; idx < 
MB_BLOCK_SIZE
 ; idx +
BLOCK_SIZE
 )

92 
pixP
.
y
 = (Ë(
pixMB
.y + 
idx
);

93 
pixP
.
pos_y
 = (Ë(
pixMB
.pos_y + 
idx
);

95 
blkQ
 = (
idx
 & 0xFFFCË+ (
xQ
 >> 2);

96 
blkP
 = (
pixP
.
y
 & 0xFFFCË+ (pixP.
x
 >> 2);

98 i‡(((
MbQ
->
cbp_blk
 & 
	`i64_powî2
(
blkQ
)Ë!0Ë|| ((
MbP
->cbp_blk & i64_powî2(
blkP
)) != 0))

99 
SåVÆue
 = 2;

100 i‡(
edge
 && ((
MbQ
->
mb_ty≥
 == 1) || (MbQ->mb_type == 2)))

101 
SåVÆue
 = 0;

104 
blk_y
 = 
mb_y
 + (
blkQ
 >> 2);

105 
blk_x
 = 
mb_x
 + (
blkQ
 & 3);

106 
blk_y2
 = 
pixP
.
pos_y
 >> 2;

107 
blk_x2
 = 
pixP
.
pos_x
 >> 2;

109 
PicMŸi⁄P¨ams
 *
mv_öfo_p
 = &
mv_öfo
[
blk_y
 ][
blk_x
 ];

110 
PicMŸi⁄P¨ams
 *
mv_öfo_q
 = &
mv_öfo
[
blk_y2
][
blk_x2
];

112 
St‹abÀPi˘uªPå
 
ªf_p0
 = 
mv_öfo_p
->
ªf_idx
[
LIST_0
] =-1 ? 
NULL
 : mv_öfo_p->
ªf_pic
[LIST_0];

113 
St‹abÀPi˘uªPå
 
ªf_q0
 = 
mv_öfo_q
->
ªf_idx
[
LIST_0
] =-1 ? 
NULL
 : mv_öfo_q->
ªf_pic
[LIST_0];

114 
St‹abÀPi˘uªPå
 
ªf_p1
 = 
mv_öfo_p
->
ªf_idx
[
LIST_1
] =-1 ? 
NULL
 : mv_öfo_p->
ªf_pic
[LIST_1];

115 
St‹abÀPi˘uªPå
 
ªf_q1
 = 
mv_öfo_q
->
ªf_idx
[
LIST_1
] =-1 ? 
NULL
 : mv_öfo_q->
ªf_pic
[LIST_1];

117 i‡–((
ªf_p0
==
ªf_q0
Ë&& (
ªf_p1
==
ªf_q1
)) || ((ref_p0==ref_q1) && (ref_p1==ref_q0)))

120 i‡(
ªf_p0
 !
ªf_p1
)

123 i‡(
ªf_p0
 =
ªf_q0
)

125 
SåVÆue
 =

126 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_0
], &
mv_öfo_q
->mv[LIST_0], 
mvlimô
) |

127 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_1
], &
mv_öfo_q
->mv[LIST_1], 
mvlimô
);

131 
SåVÆue
 =

132 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_0
], &
mv_öfo_q
->mv[
LIST_1
], 
mvlimô
) |

133 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_1
], &
mv_öfo_q
->mv[
LIST_0
], 
mvlimô
);

138 
SåVÆue
 = ((

139 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_0
], &
mv_öfo_q
->mv[LIST_0], 
mvlimô
) |

140 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_1
], &
mv_öfo_q
->mv[LIST_1], 
mvlimô
))

142 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_0
], &
mv_öfo_q
->mv[
LIST_1
], 
mvlimô
) |

143 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_1
], &
mv_öfo_q
->mv[
LIST_0
], 
mvlimô
)

148 
SåVÆue
 = 1;

152 *(*)(
Såígth
+
idx
Ë
SåVÆue
 * 0x01010101;

158 
SåVÆue
 = (
edge
 == 0) ? 4 : 3;

159 
	`mem£t
(
Såígth
, (
byã
Ë
SåVÆue
, 
MB_BLOCK_SIZE
 * (byte));

165 
SåVÆue
 = (
edge
 == 0) ? 4 : 3;

166 
	`mem£t
(
Såígth
, (
byã
Ë
SåVÆue
, 
MB_BLOCK_SIZE
 * (byte));

169 
	}
}

177 
	$GëSåígthH‹
(
byã
 
Såígth
[
MB_BLOCK_SIZE
], 
Ma¸oblock
 *
MbQ
, 
edge
, 
mvlimô
)

179 
SåVÆue
;

180 
Sli˚
 *
cuºSli˚
 = 
MbQ
->
p_Sli˚
;

181 
VideoP¨amëîs
 *
p_Vid
 = 
MbQ
->p_Vid;

183 i‡((
cuºSli˚
->
¶i˚_ty≥
==
SP_SLICE
)||(cuºSli˚->¶i˚_ty≥==
SI_SLICE
) )

186 
SåVÆue
 = (
edge
 =0 && (
p_Vid
->
°ru˘uª
 =
FRAME
)) ? 4 : 3;

187 
	`mem£t
(
Såígth
, (
byã
Ë
SåVÆue
, 
MB_BLOCK_SIZE
 * (byte));

191 i‡(!(
MbQ
->
mb_ty≥
==
I4MB
||MbQ->mb_ty≥==
I8MB
||MbQ->mb_ty≥==
I16MB
||MbQ->mb_ty≥==
IPCM
))

193 
PixñPos
 
pixMB
;

194 
Ma¸oblock
 *
MbP
;

195 
yQ
 = (
edge
 < 16 ?Édge - 1: 0);

197 
	`gëN⁄AffNeighbour
(
MbQ
, 0, 
yQ
, 
p_Vid
->
mb_size
[
IS_LUMA
], &
pixMB
);

198 
MbP
 = (
edge
Ë? 
MbQ
 : &(
p_Vid
->
mb_d©a
[
pixMB
.
mb_addr
]);

200 i‡(!(
MbP
->
mb_ty≥
==
I4MB
||MbP->mb_ty≥==
I8MB
||MbP->mb_ty≥==
I16MB
||MbP->mb_ty≥==
IPCM
))

202 
PixñPos
 
pixP
 = 
pixMB
;

203 
PicMŸi⁄P¨ams
 **
mv_öfo
 = 
p_Vid
->
íc_pi˘uª
->mv_info;

205 
blkP
, 
blkQ
, 
idx
;

207 
mb_x
, 
mb_y
;

209 
	`gë_mb_block_pos_n‹mÆ
 (
p_Vid
->
PicPos
, 
MbQ
->
mbAddrX
, &
mb_x
, &
mb_y
);

210 
mb_x
 <<= 2;

211 
mb_y
 <<= 2;

212 
yQ
 ++;

214  
idx
 = 0 ; idx < 
MB_BLOCK_SIZE
 ; idx +
BLOCK_SIZE
 )

216 
pixP
.
x
 = (Ë(
pixMB
.x + 
idx
);

217 
pixP
.
pos_x
 = (Ë(
pixMB
.pos_x + 
idx
);

219 
blkQ
 = (
yQ
 & 0xFFFCË+ (
idx
 >> 2);

220 
blkP
 = (
pixP
.
y
 & 0xFFFCË+ (pixP.
x
 >> 2);

222 if–((
MbQ
->
cbp_blk
 & 
	`i64_powî2
(
blkQ
)Ë!0Ë|| ((
MbP
->cbp_blk & i64_powî2(
blkP
)) != 0) )

223 
SåVÆue
 = 2;

224 i‡(
edge
 && ((
MbQ
->
mb_ty≥
 == 1) || (MbQ->mb_type == 3)))

225 
SåVÆue
 = 0;

228 
blk_y
 = 
mb_y
 + (
blkQ
 >> 2);

229 
blk_x
 = 
mb_x
 + (
blkQ
 & 3);

230 
blk_y2
 = 
pixP
.
pos_y
 >> 2;

231 
blk_x2
 = 
pixP
.
pos_x
 >> 2;

233 
PicMŸi⁄P¨ams
 *
mv_öfo_p
 = &
mv_öfo
[
blk_y
 ][
blk_x
 ];

234 
PicMŸi⁄P¨ams
 *
mv_öfo_q
 = &
mv_öfo
[
blk_y2
][
blk_x2
];

236 
St‹abÀPi˘uªPå
 
ªf_p0
 = 
mv_öfo_p
->
ªf_idx
[
LIST_0
] =-1 ? 
NULL
 : mv_öfo_p->
ªf_pic
[LIST_0];

237 
St‹abÀPi˘uªPå
 
ªf_q0
 = 
mv_öfo_q
->
ªf_idx
[
LIST_0
] =-1 ? 
NULL
 : mv_öfo_q->
ªf_pic
[LIST_0];

238 
St‹abÀPi˘uªPå
 
ªf_p1
 = 
mv_öfo_p
->
ªf_idx
[
LIST_1
] =-1 ? 
NULL
 : mv_öfo_p->
ªf_pic
[LIST_1];

239 
St‹abÀPi˘uªPå
 
ªf_q1
 = 
mv_öfo_q
->
ªf_idx
[
LIST_1
] =-1 ? 
NULL
 : mv_öfo_q->
ªf_pic
[LIST_1];

241 i‡–((
ªf_p0
==
ªf_q0
Ë&& (
ªf_p1
==
ªf_q1
)) || ((ref_p0==ref_q1) && (ref_p1==ref_q0)))

244 i‡(
ªf_p0
 !
ªf_p1
)

247 i‡(
ªf_p0
 =
ªf_q0
)

249 
SåVÆue
 =

250 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_0
], &
mv_öfo_q
->mv[LIST_0], 
mvlimô
) |

251 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_1
], &
mv_öfo_q
->mv[LIST_1], 
mvlimô
);

255 
SåVÆue
 =

256 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_0
], &
mv_öfo_q
->mv[
LIST_1
], 
mvlimô
) |

257 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_1
], &
mv_öfo_q
->mv[
LIST_0
], 
mvlimô
);

262 
SåVÆue
 = ((

263 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_0
], &
mv_öfo_q
->mv[LIST_0], 
mvlimô
) |

264 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_1
], &
mv_öfo_q
->mv[LIST_1], 
mvlimô
))

266 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_0
], &
mv_öfo_q
->mv[
LIST_1
], 
mvlimô
) |

267 
	`com∑ª_mvs
(&
mv_öfo_p
->
mv
[
LIST_1
], &
mv_öfo_q
->mv[
LIST_0
], 
mvlimô
)

272 
SåVÆue
 = 1;

275 *(*)(
Såígth
+
idx
Ë
SåVÆue
 * 0x01010101;

281 
SåVÆue
 = (
edge
 =0 && (
p_Vid
->
°ru˘uª
 =
FRAME
)) ? 4 : 3;

282 
	`mem£t
(
Såígth
, (
byã
Ë
SåVÆue
, 
MB_BLOCK_SIZE
 * (byte));

288 
SåVÆue
 = (
edge
 =0 && (
p_Vid
->
°ru˘uª
 =
FRAME
)) ? 4 : 3;

289 
	`mem£t
(
Såígth
, (
byã
Ë
SåVÆue
, 
MB_BLOCK_SIZE
 * (byte));

292 
	}
}

301 
	$EdgeLo›LumaVî
(
Cﬁ‹Pœ√
 
∂
, 
img≥l
** 
Img
, 
byã
 
Såígth
[16], 
Ma¸oblock
 *
MbQ
, 
edge
)

303 
VideoP¨amëîs
 *
p_Vid
 = 
MbQ
->p_Vid;

305 
PixñPos
 
pixMB1
;

306 
	`gëN⁄AffNeighbour
(
MbQ
, 
edge
 - 1, 0, 
p_Vid
->
mb_size
[
IS_LUMA
], &
pixMB1
);

308 i‡(
pixMB1
.
avaûabÀ
 || (
MbQ
->
DFDißbÀIdc
== 0))

310 
bôdïth_sˇÀ
 = 
∂
 ? 
p_Vid
->bôdïth_sˇÀ[
IS_CHROMA
] :Ö_Vid->bôdïth_sˇÀ[
IS_LUMA
];

312 
Ma¸oblock
 *
MbP
 = &(
p_Vid
->
mb_d©a
[
pixMB1
.
mb_addr
]);

315 
QP
 = 
∂
? ((
MbP
->
qpc
[∂-1] + 
MbQ
->qpc[∂-1] + 1Ë>> 1Ë: (MbP->
qp
 + MbQ->qp + 1) >> 1;

317 
ödexA
 = 
	`iClù3
(0, 
MAX_QP
, 
QP
 + 
MbQ
->
DFAÕhaC0Off£t
);

318 
ödexB
 = 
	`iClù3
(0, 
MAX_QP
, 
QP
 + 
MbQ
->
DFBëaOff£t
);

320 
AÕha
 = 
ALPHA_TABLE
[
ödexA
] * 
bôdïth_sˇÀ
;

321 
Bëa
 = 
BETA_TABLE
 [
ödexB
] * 
bôdïth_sˇÀ
;

323 i‡((
AÕha
 | 
Bëa
 )!= 0)

325 c⁄° 
byã
 *
ClùTab
 = 
CLIP_TAB
[
ödexA
];

326 
max_img≥l_vÆue
 = 
p_Vid
->
max_≥l_vÆue_comp
[
∂
];

328 
pos_x1
 = 
pixMB1
.
pos_x
;

329 
img≥l
 **
cur_img
 = &
Img
[
pixMB1
.
pos_y
];

330 
≥l
;

332  
≥l
 = 0 ;Öñ < 
MB_BLOCK_SIZE
 ;Öel += 4 )

334 if(*
Såígth
 == 4 )

336 
i
;

337  
i
 = 0 ; i < 
BLOCK_SIZE
 ; ++i )

339 
img≥l
 *
SrcPåP
 = *(
cur_img
++Ë+ 
pos_x1
;

340 
img≥l
 *
SrcPåQ
 = 
SrcPåP
 + 1;

341 
img≥l
 
L0
 = *
SrcPåP
;

342 
img≥l
 
R0
 = *
SrcPåQ
;

344 if–
	`übs
–
R0
 - 
L0
 ) < 
AÕha
 )

346 
img≥l
 
R1
 = *(
SrcPåQ
 + 1);

347 
img≥l
 
L1
 = *(
SrcPåP
 - 1);

348 i‡((
	`übs
–
R0
 - 
R1
Ë< 
Bëa
Ë&& (übs(
L0
 - 
L1
) < Beta))

350 
img≥l
 
R2
 = *(
SrcPåQ
 + 2);

351 
img≥l
 
L2
 = *(
SrcPåP
 - 2);

352 
RL0
 = 
L0
 + 
R0
;

353 
smÆl_g≠
 = (
	`übs
–
R0
 - 
L0
 ) < ((
AÕha
 >> 2) + 2));

354 
aq
 = ( 
	`übs
–
R0
 - 
R2
Ë< 
Bëa
 ) & 
smÆl_g≠
;

355 
≠
 = ( 
	`übs
–
L0
 - 
L2
Ë< 
Bëa
 ) & 
smÆl_g≠
;

357 i‡(
≠
)

359 
img≥l
 
L3
 = *(
SrcPåP
 - 3);

360 *(
SrcPåP
--Ë(
img≥l
Ë(–
R1
 + ((
L1
 + 
RL0
Ë<< 1Ë+ 
L2
 + 4) >> 3);

361 *(
SrcPåP
--Ë(
img≥l
Ë(–
L2
 + 
L1
 + 
RL0
 + 2) >> 2);

362 *(
SrcPåP
 ) = (
img≥l
Ë((((
L3
 + 
L2
Ë<<1Ë+ L2 + 
L1
 + 
RL0
 + 4) >> 3);

366 *
SrcPåP
 = (
img≥l
Ë(((
L1
 << 1Ë+ 
L0
 + 
R1
 + 2) >> 2);

369 i‡(
aq
)

371 
img≥l
 
R3
 = *(
SrcPåQ
 + 3);

372 *(
SrcPåQ
++Ë(
img≥l
Ë(–
L1
 + ((
R1
 + 
RL0
Ë<< 1Ë+ 
R2
 + 4) >> 3);

373 *(
SrcPåQ
++Ë(
img≥l
Ë(–
R2
 + 
R0
 + 
L0
 + 
R1
 + 2) >> 2);

374 *(
SrcPåQ
 ) = (
img≥l
Ë((((
R3
 + 
R2
Ë<<1Ë+ R2 + 
R1
 + 
RL0
 + 4) >> 3);

378 *
SrcPåQ
 = (
img≥l
Ë(((
R1
 << 1Ë+ 
R0
 + 
L1
 + 2) >> 2);

384 if–*
Såígth
 != 0)

386 
C0
 = 
ClùTab
[ *
Såígth
 ] * 
bôdïth_sˇÀ
;

387 
i
;

388 
img≥l
 *
SrcPåP
, *
SrcPåQ
;

389 
edge_diff
;

390  
i
 = 0 ; i < 
BLOCK_SIZE
 ; ++i )

392 
SrcPåP
 = *(
cur_img
++Ë+ 
pos_x1
;

393 
SrcPåQ
 = 
SrcPåP
 + 1;

394 
edge_diff
 = *
SrcPåQ
 - *
SrcPåP
;

396 if–
	`übs
–
edge_diff
 ) < 
AÕha
 )

398 
img≥l
 *
SrcPåQ1
 = 
SrcPåQ
 + 1;

399 
img≥l
 *
SrcPåP1
 = 
SrcPåP
 - 1;

401 i‡((
	`übs
–*
SrcPåQ
 - *
SrcPåQ1
Ë< 
Bëa
Ë&& (übs(*
SrcPåP
 - *
SrcPåP1
) < Beta))

403 
RL0
 = (*
SrcPåP
 + *
SrcPåQ
 + 1) >> 1;

404 
img≥l
 
R2
 = *(
SrcPåQ1
 + 1);

405 
img≥l
 
L2
 = *(
SrcPåP1
 - 1);

407 
aq
 = (
	`übs
(*
SrcPåQ
 - 
R2
Ë< 
Bëa
);

408 
≠
 = (
	`übs
(*
SrcPåP
 - 
L2
Ë< 
Bëa
);

410 
tc0
 = (
C0
 + 
≠
 + 
aq
) ;

411 
dif
 = 
	`iClù3
–-
tc0
,Åc0, (((
edge_diff
Ë<< 2Ë+ (*
SrcPåP1
 - *
SrcPåQ1
) + 4) >> 3 );

413 if–
≠
 )

414 *
SrcPåP1
 +
	`iClù3
–-
C0
, C0, (
L2
 + 
RL0
 - (*SrcPtrP1<<1)) >> 1 );

416 i‡(
dif
 != 0)

418 *
SrcPåP
 = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, *SrcPåP + 
dif
);

419 *
SrcPåQ
 = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, *SrcPåQ - 
dif
);

421 if–
aq
 )

422 *
SrcPåQ1
 +
	`iClù3
–-
C0
, C0, (
R2
 + 
RL0
 - (*SrcPtrQ1<<1)) >> 1 );

429 
cur_img
 += 4;

431 
Såígth
 += 4;

435 
	}
}

444 
	$EdgeLo›LumaH‹
(
Cﬁ‹Pœ√
 
∂
, 
img≥l
** 
Img
, 
byã
 
Såígth
[16], 
Ma¸oblock
 *
MbQ
, 
edge
, 
width
)

446 
VideoP¨amëîs
 *
p_Vid
 = 
MbQ
->p_Vid;

448 
PixñPos
 
pixMB1
;

449 
	`gëN⁄AffNeighbour
(
MbQ
, 0, (
edge
 < 
MB_BLOCK_SIZE
 ?Édgê- 1: 0), 
p_Vid
->
mb_size
[
IS_LUMA
], &
pixMB1
);

451 i‡(
pixMB1
.
avaûabÀ
 || (
MbQ
->
DFDißbÀIdc
== 0))

453 
bôdïth_sˇÀ
 = 
∂
 ? 
p_Vid
->bôdïth_sˇÀ[
IS_CHROMA
] :Ö_Vid->bôdïth_sˇÀ[
IS_LUMA
];

455 
Ma¸oblock
 *
MbP
 = &(
p_Vid
->
mb_d©a
[
pixMB1
.
mb_addr
]);

458 
QP
 = 
∂
? ((
MbP
->
qpc
[∂-1] + 
MbQ
->qpc[∂-1] + 1Ë>> 1Ë: (MbP->
qp
 + MbQ->qp + 1) >> 1;

460 
ödexA
 = 
	`iClù3
(0, 
MAX_QP
, 
QP
 + 
MbQ
->
DFAÕhaC0Off£t
);

461 
ödexB
 = 
	`iClù3
(0, 
MAX_QP
, 
QP
 + 
MbQ
->
DFBëaOff£t
);

463 
AÕha
 = 
ALPHA_TABLE
[
ödexA
] * 
bôdïth_sˇÀ
;

464 
Bëa
 = 
BETA_TABLE
 [
ödexB
] * 
bôdïth_sˇÀ
;

465 i‡((
AÕha
 | 
Bëa
 )!= 0)

467 c⁄° 
byã
 *
ClùTab
 = 
CLIP_TAB
[
ödexA
];

468 
max_img≥l_vÆue
 = 
p_Vid
->
max_≥l_vÆue_comp
[
∂
];

469 
img≥l
 *
imgP
 = &
Img
[
pixMB1
.
pos_y
 ][pixMB1.
pos_x
];

470 
img≥l
 *
imgQ
 = 
imgP
 + 
width
;

471 
≥l
;

473  
≥l
 = 0 ;Öñ < 
MB_BLOCK_SIZE
 ;Öel += 4 )

475 if(*
Såígth
 == 4 )

477 
pixñ
;

478 
öc_dim2
 = 
width
 * 2;

479 
öc_dim3
 = 
width
 * 3;

480  
pixñ
 = 0 ;Öixñ < 
BLOCK_SIZE
 ; ++pixel )

482 
img≥l
 *
SrcPåP
 = 
imgP
++;

483 
img≥l
 *
SrcPåQ
 = 
imgQ
++;

484 
img≥l
 
L0
 = *
SrcPåP
;

485 
img≥l
 
R0
 = *
SrcPåQ
;

487 if–
	`übs
–
R0
 - 
L0
 ) < 
AÕha
 )

489 
img≥l
 
L1
 = *(
SrcPåP
 - 
width
);

490 
img≥l
 
R1
 = *(
SrcPåQ
 + 
width
);

492 i‡((
	`übs
–
R0
 - 
R1
Ë< 
Bëa
Ë&& (übs(
L0
 - 
L1
) < Beta))

494 
img≥l
 
L2
 = *(
SrcPåP
 - 
öc_dim2
);

495 
img≥l
 
R2
 = *(
SrcPåQ
 + 
öc_dim2
);

496 
RL0
 = 
L0
 + 
R0
;

497 
smÆl_g≠
 = (
	`übs
–
R0
 - 
L0
 ) < ((
AÕha
 >> 2) + 2));

498 
aq
 = ( 
	`übs
–
R0
 - 
R2
Ë< 
Bëa
 ) & 
smÆl_g≠
;

499 
≠
 = ( 
	`übs
–
L0
 - 
L2
Ë< 
Bëa
 ) & 
smÆl_g≠
;

501 i‡(
≠
)

503 
img≥l
 
L3
 = *(
SrcPåP
 - 
öc_dim3
);

504 *
SrcPåP
 = (
img≥l
Ë(–
R1
 + ((
L1
 + 
RL0
Ë<< 1Ë+ 
L2
 + 4) >> 3);

505 *(
SrcPåP
 -
width
Ë(
img≥l
Ë(–
L2
 + 
L1
 + 
RL0
 + 2) >> 2);

506 *(
SrcPåP
 - 
width
Ë(
img≥l
Ë((((
L3
 + 
L2
Ë<<1Ë+ L2 + 
L1
 + 
RL0
 + 4) >> 3);

510 *
SrcPåP
 = (
img≥l
Ë(((
L1
 << 1Ë+ 
L0
 + 
R1
 + 2) >> 2);

513 i‡(
aq
)

515 
img≥l
 
R3
 = *(
SrcPåQ
 + 
öc_dim3
);

516 *(
SrcPåQ
 ) = (
img≥l
Ë(–
L1
 + ((
R1
 + 
RL0
Ë<< 1Ë+ 
R2
 + 4) >> 3);

517 *(
SrcPåQ
 +
width
 ) = (
img≥l
Ë(–
R2
 + 
R0
 + 
L0
 + 
R1
 + 2) >> 2);

518 *(
SrcPåQ
 + 
width
 ) = (
img≥l
Ë((((
R3
 + 
R2
Ë<<1Ë+ R2 + 
R1
 + 
RL0
 + 4) >> 3);

522 *
SrcPåQ
 = (
img≥l
Ë(((
R1
 << 1Ë+ 
R0
 + 
L1
 + 2) >> 2);

528 if–*
Såígth
 != 0)

530 
C0
 = 
ClùTab
[ *
Såígth
 ] * 
bôdïth_sˇÀ
;

531 
i
;

532 
img≥l
 *
SrcPåP
, *
SrcPåQ
;

533 
edge_diff
;

534  
i
0 ; i < 
BLOCK_SIZE
 ; ++i )

536 
SrcPåP
 = 
imgP
++;

537 
SrcPåQ
 = 
imgQ
++;

538 
edge_diff
 = *
SrcPåQ
 - *
SrcPåP
;

540 if–
	`übs
–
edge_diff
 ) < 
AÕha
 )

542 
img≥l
 *
SrcPåQ1
 = 
SrcPåQ
 + 
width
;

543 
img≥l
 *
SrcPåP1
 = 
SrcPåP
 - 
width
;

545 i‡((
	`übs
–*
SrcPåQ
 - *
SrcPåQ1
Ë< 
Bëa
Ë&& (übs(*
SrcPåP
 - *
SrcPåP1
) < Beta))

547 
RL0
 = (*
SrcPåP
 + *
SrcPåQ
 + 1) >> 1;

548 
img≥l
 
R2
 = *(
SrcPåQ1
 + 
width
);

549 
img≥l
 
L2
 = *(
SrcPåP1
 - 
width
);

551 
aq
 = (
	`übs
(*
SrcPåQ
 - 
R2
Ë< 
Bëa
);

552 
≠
 = (
	`übs
(*
SrcPåP
 - 
L2
Ë< 
Bëa
);

554 
tc0
 = (
C0
 + 
≠
 + 
aq
) ;

555 
dif
 = 
	`iClù3
–-
tc0
,Åc0, (((
edge_diff
Ë<< 2Ë+ (*
SrcPåP1
 - *
SrcPåQ1
) + 4) >> 3 );

557 if–
≠
 )

558 *
SrcPåP1
 +
	`iClù3
–-
C0
, C0, (
L2
 + 
RL0
 - (*SrcPtrP1<<1)) >> 1 );

560 i‡(
dif
 != 0)

562 *
SrcPåP
 = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, *SrcPåP + 
dif
);

563 *
SrcPåQ
 = (
img≥l
Ë
	`iClù1
(
max_img≥l_vÆue
, *SrcPåQ - 
dif
);

566 if–
aq
 )

567 *
SrcPåQ1
 +
	`iClù3
–-
C0
, C0, (
R2
 + 
RL0
 - (*SrcPtrQ1<<1)) >> 1 );

574 
imgP
 += 4;

575 
imgQ
 += 4;

577 
Såígth
 += 4;

581 
	}
}

590 
	$EdgeLo›ChromaVî
(
img≥l
** 
Img
, 
byã
 
Såígth
[16], 
Ma¸oblock
 *
MbQ
, 
edge
, 
uv
)

592 
VideoP¨amëîs
 *
p_Vid
 = 
MbQ
->p_Vid;

594 
xQ
 = 
edge
 - 1;

595 
yQ
 = 0;

596 
PixñPos
 
pixMB1
;

598 
	`gëN⁄AffNeighbour
(
MbQ
, 
xQ
, 
yQ
, 
p_Vid
->
mb_size
[
IS_CHROMA
], &
pixMB1
);

600 i‡(
pixMB1
.
avaûabÀ
 || (
MbQ
->
DFDißbÀIdc
 == 0))

602 
bôdïth_sˇÀ
 = 
p_Vid
->bôdïth_sˇÀ[
IS_CHROMA
];

603 
max_img≥l_vÆue
 = 
p_Vid
->
max_≥l_vÆue_comp
[
uv
 + 1];

605 
AÕhaC0Off£t
 = 
MbQ
->
DFAÕhaC0Off£t
;

606 
BëaOff£t
 = 
MbQ
->
DFBëaOff£t
;

607 
Ma¸oblock
 *
MbP
 = &(
p_Vid
->
mb_d©a
[
pixMB1
.
mb_addr
]);

610 
QP
 = (
MbP
->
qpc
[
uv
] + 
MbQ
->qpc[uv] + 1) >> 1;

612 
ödexA
 = 
	`iClù3
(0, 
MAX_QP
, 
QP
 + 
AÕhaC0Off£t
);

613 
ödexB
 = 
	`iClù3
(0, 
MAX_QP
, 
QP
 + 
BëaOff£t
);

615 
AÕha
 = 
ALPHA_TABLE
[
ödexA
] * 
bôdïth_sˇÀ
;

616 
Bëa
 = 
BETA_TABLE
 [
ödexB
] * 
bôdïth_sˇÀ
;

617 i‡((
AÕha
 | 
Bëa
) != 0)

619 c⁄° 
PñNum
 = 
≥ um_¸
[0][
p_Vid
->
yuv_f‹m©
];

620 c⁄° 
byã
 *
ClùTab
 = 
CLIP_TAB
[
ödexA
];

622 
≥l
;

623 
pos_x1
 = 
pixMB1
.
pos_x
;

624 
img≥l
 **
cur_img
 = &
Img
[
pixMB1
.
pos_y
];

626  
≥l
 = 0 ;Öñ < 
PñNum
 ; ++pel )

628 
Sång
 = 
Såígth
[(
PñNum
 =8Ë? (((
≥l
 >> 1) << 2) + (pel & 0x01)) :Öel];

630 if–
Sång
 != 0)

632 
img≥l
 *
SrcPåP
 = *
cur_img
 + 
pos_x1
;

633 
img≥l
 *
SrcPåQ
 = 
SrcPåP
 + 1;

634 
edge_diff
 = *
SrcPåQ
 - *
SrcPåP
;

636 i‡–
	`übs
–
edge_diff
 ) < 
AÕha
 )

638 
img≥l
 
R1
 = *(
SrcPåQ
 + 1);

639 i‡–
	`übs
(*
SrcPåQ
 - 
R1
Ë< 
Bëa
 )

641 
img≥l
 
L1
 = *(
SrcPåP
 - 1);

642 i‡–
	`übs
(*
SrcPåP
 - 
L1
Ë< 
Bëa
 )

644 if–
Sång
 == 4 )

646 *
SrcPåP
 = (
img≥l
Ë–((
L1
 << 1Ë+ *SrcPåP + 
R1
 + 2) >> 2 );

647 *
SrcPåQ
 = (
img≥l
Ë–((
R1
 << 1Ë+ *SrcPåQ + 
L1
 + 2) >> 2 );

651 
tc0
 = 
ClùTab
[ 
Sång
 ] * 
bôdïth_sˇÀ
 + 1;

652 
dif
 = 
	`iClù3
–-
tc0
,Åc0, ( ((
edge_diff
Ë<< 2Ë+ (
L1
 - 
R1
) + 4) >> 3 );

654 i‡(
dif
 != 0)

656 *
SrcPåP
 = (
img≥l
Ë
	`iClù1
 ( 
max_img≥l_vÆue
, *SrcPåP + 
dif
 );

657 *
SrcPåQ
 = (
img≥l
Ë
	`iClù1
 ( 
max_img≥l_vÆue
, *SrcPåQ - 
dif
 );

664 
cur_img
++;

668 
	}
}

677 
	$EdgeLo›ChromaH‹
(
img≥l
** 
Img
, 
byã
 
Såígth
[16], 
Ma¸oblock
 *
MbQ
, 
edge
, 
width
, 
uv
)

679 
VideoP¨amëîs
 *
p_Vid
 = 
MbQ
->p_Vid;

681 
xQ
 = 0;

682 
yQ
 = (
edge
 < 16 ?Édge - 1: 0);

683 
PixñPos
 
pixMB1
;

685 
	`gëN⁄AffNeighbour
(
MbQ
, 
xQ
, 
yQ
, 
p_Vid
->
mb_size
[
IS_CHROMA
], &
pixMB1
);

687 i‡(
pixMB1
.
avaûabÀ
 || (
MbQ
->
DFDißbÀIdc
 == 0))

689 
bôdïth_sˇÀ
 = 
p_Vid
->bôdïth_sˇÀ[
IS_CHROMA
];

690 
max_img≥l_vÆue
 = 
p_Vid
->
max_≥l_vÆue_comp
[
uv
 + 1];

692 
AÕhaC0Off£t
 = 
MbQ
->
DFAÕhaC0Off£t
;

693 
BëaOff£t
 = 
MbQ
->
DFBëaOff£t
;

694 
Ma¸oblock
 *
MbP
 = &(
p_Vid
->
mb_d©a
[
pixMB1
.
mb_addr
]);

697 
QP
 = (
MbP
->
qpc
[
uv
] + 
MbQ
->qpc[uv] + 1) >> 1;

699 
ödexA
 = 
	`iClù3
(0, 
MAX_QP
, 
QP
 + 
AÕhaC0Off£t
);

700 
ödexB
 = 
	`iClù3
(0, 
MAX_QP
, 
QP
 + 
BëaOff£t
);

702 
AÕha
 = 
ALPHA_TABLE
[
ödexA
] * 
bôdïth_sˇÀ
;

703 
Bëa
 = 
BETA_TABLE
 [
ödexB
] * 
bôdïth_sˇÀ
;

704 i‡((
AÕha
 | 
Bëa
) != 0)

706 c⁄° 
PñNum
 = 
≥ um_¸
[1][
p_Vid
->
yuv_f‹m©
];

707 c⁄° 
byã
 *
ClùTab
 = 
CLIP_TAB
[
ödexA
];

709 
≥l
;

711 
img≥l
 *
imgP
 = &
Img
[
pixMB1
.
pos_y
 ][pixMB1.
pos_x
];

712 
img≥l
 *
imgQ
 = 
imgP
 + 
width
 ;

714  
≥l
 = 0 ;Öñ < 
PñNum
 ; ++pel )

716 
Sång
 = 
Såígth
[(
PñNum
 =8Ë? (((
≥l
 >> 1) << 2) + (pel & 0x01)) :Öel];

718 if–
Sång
 != 0)

720 
img≥l
 *
SrcPåP
 = 
imgP
;

721 
img≥l
 *
SrcPåQ
 = 
imgQ
;

722 
edge_diff
 = *
imgQ
 - *
imgP
;

724 i‡–
	`übs
–
edge_diff
 ) < 
AÕha
 )

726 
img≥l
 
R1
 = *(
SrcPåQ
 + 
width
);

727 i‡–
	`übs
(*
SrcPåQ
 - 
R1
Ë< 
Bëa
 )

729 
img≥l
 
L1
 = *(
SrcPåP
 - 
width
);

730 i‡–
	`übs
(*
SrcPåP
 - 
L1
Ë< 
Bëa
 )

732 if–
Sång
 == 4 )

734 *
SrcPåP
 = (
img≥l
Ë–((
L1
 << 1Ë+ *SrcPåP + 
R1
 + 2) >> 2 );

735 *
SrcPåQ
 = (
img≥l
Ë–((
R1
 << 1Ë+ *SrcPåQ + 
L1
 + 2) >> 2 );

739 
tc0
 = 
ClùTab
[ 
Sång
 ] * 
bôdïth_sˇÀ
 + 1;

740 
dif
 = 
	`iClù3
–-
tc0
,Åc0, ( ((
edge_diff
Ë<< 2Ë+ (
L1
 - 
R1
) + 4) >> 3 );

742 i‡(
dif
 != 0)

744 *
SrcPåP
 = (
img≥l
Ë
	`iClù1
 ( 
max_img≥l_vÆue
, *SrcPåP + 
dif
 );

745 *
SrcPåQ
 = (
img≥l
Ë
	`iClù1
 ( 
max_img≥l_vÆue
, *SrcPåQ - 
dif
 );

752 
imgP
++;

753 
imgQ
++;

757 
	}
}

	@lencod/src/macroblock.c

21 
	~"c⁄åibut‹s.h
"

23 
	~<limôs.h
>

24 
	~<m©h.h
>

26 
	~"globÆ.h
"

27 
	~"íc_°©i°ics.h
"

29 
	~"block.h
"

30 
	~"ñemíts.h
"

31 
	~"ma¸oblock.h
"

32 
	~"memÆloc.h
"

33 
	~"blk_¥edi˘i⁄.h
"

34 
	~"mc_¥edi˘i⁄.h
"

35 
	~"fmo.h
"

36 
	~"vlc.h
"

37 
	~"image.h
"

38 
	~"mb_ac˚ss.h
"

39 
	~"øã˘l.h
"

40 
	~"ˇbac.h
"

41 
	~"bürõncode.h
"

42 
	~"me_fuŒ£¨ch.h
"

43 
	~"me_fuŒÁ°.h
"

44 
	~"symbﬁ.h
"

45 
	~"c⁄f‹m™˚.h
"

46 
	~"md_comm⁄.h
"

47 
	~"mv_¥edi˘i⁄.h
"

48 
	~"rd›t.h
"

49 
	~"å™sf‹m.h
"

52 #i‡
TRACE


53 
	#TRACE_SE
(
åa˚
,
°r
Ë
	`¢¥ötf
—ø˚,
TRACESTRING_SIZE
,°r)

	)

55 
	#TRACE_SE
(
åa˚
,
°r
)

	)

59 
¶i˚_too_big
 (
Sli˚
 *
cuºSli˚
, 
æc_bôs
);

60 
wrôe_chroma_öåa_¥ed_mode
 (
Ma¸oblock
* 
cuºMB
);

61 
wrôe_chroma_c€ff
 (
Ma¸oblock
* 
cuºMB
);

62 
wrôe_CBP_™d_Dqu™t
 (
Ma¸oblock
* 
cuºMB
);

75 
	$£t_MB_∑ømëîs
 (
Sli˚
 *
cuºSli˚
, 
Ma¸oblock
 *
cuºMB
)

77 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

78 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºSli˚
->p_Inp;

80 
mb_addr
 = 
cuºMB
->
mbAddrX
;

81 
p_Vid
->
cuºít_mb_ƒ
 = 
mb_addr
;

83 
p_Vid
->
	`gë_mb_block_pos
’_Vid->
PicPos
, 
cuºMB
->
mbAddrX
, &cuºMB->
mb_x
, &cuºMB->
mb_y
);

85 
cuºMB
->
block_x
 = cuºMB->
mb_x
 << 2;

86 
cuºMB
->
block_y
 = cuºMB->
mb_y
 << 2;

88 
cuºMB
->
pix_x
 = cuºMB->
block_x
 << 2;

89 
cuºMB
->
pix_y
 = cuºMB->
block_y
 << 2;

91 i‡(
cuºSli˚
->
mb_aff_‰ame_Êag
)

93 i‡(
cuºMB
->
mb_fõld
)

95 
p_Vid
->
pCurImg
 = (
mb_addr
 & 0x01Ë?Ö_Vid->
imgD©a
.
bŸ_d©a
[0] :Ö_Vid->imgD©a.
t›_d©a
[0];

96 
p_Vid
->
pImgOrg
[0] =Ö_Vid->
pCurImg
;

98 i‡((
p_Vid
->
yuv_f‹m©
 !
YUV400
Ë&& (
p_I≈
->
£∑øã_cﬁour_∂™e_Êag
 == 0))

100 i‡(
mb_addr
 & 0x01)

102 
p_Vid
->
pImgOrg
[1] =Ö_Vid->
imgD©a
.
bŸ_d©a
[1];

103 
p_Vid
->
pImgOrg
[2] =Ö_Vid->
imgD©a
.
bŸ_d©a
[2];

107 
p_Vid
->
pImgOrg
[1] =Ö_Vid->
imgD©a
.
t›_d©a
[1];

108 
p_Vid
->
pImgOrg
[2] =Ö_Vid->
imgD©a
.
t›_d©a
[2];

112 
cuºMB
->
›ix_y
 = (cuºMB->
mb_y
 >> 1 ) << 4;

113 
cuºMB
->
li°_off£t
 = (
mb_addr
 & 0x01) ? 4 : 2;

117 
p_Vid
->
pCurImg
 =Ö_Vid->
imgD©a
.
‰m_d©a
[0];

118 
p_Vid
->
pImgOrg
[0] =Ö_Vid->
imgD©a
.
‰m_d©a
[0];

120 i‡((
p_Vid
->
yuv_f‹m©
 !
YUV400
Ë&& (
p_I≈
->
£∑øã_cﬁour_∂™e_Êag
 == 0))

122 
p_Vid
->
pImgOrg
[1] =Ö_Vid->
imgD©a
.
‰m_d©a
[1];

123 
p_Vid
->
pImgOrg
[2] =Ö_Vid->
imgD©a
.
‰m_d©a
[2];

126 
cuºMB
->
›ix_y
 = cuºMB->
block_y
 << 2;

127 
cuºMB
->
li°_off£t
 = 0;

132 
cuºMB
->
›ix_y
 = cuºMB->
block_y
 << 2;

133 
cuºMB
->
li°_off£t
 = 0;

136 i‡(
p_Vid
->
yuv_f‹m©
 !
YUV400
)

138 
cuºMB
->
pix_c_x
 = (
p_Vid
->
mb_¸_size_x
 * cuºMB->
pix_x
) >> 4;

139 
cuºMB
->
pix_c_y
 = (
p_Vid
->
mb_¸_size_y
 * cuºMB->
pix_y
) >> 4;

141 
cuºMB
->
›ix_c_y
 = (
p_Vid
->
mb_¸_size_y
 * cuºMB->
›ix_y
) >> 4;

145 
	}
}

155 
	$√xt_ma¸oblock
(
Ma¸oblock
 *
cuºMB
)

157 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

158 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

159 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

160 
¶i˚_ty≥
 = 
cuºSli˚
->slice_type;

161 
BôCou¡î
 *
mbBôs
 = &
cuºMB
->
bôs
;

162 
i
;

163 
SètP¨amëîs
 *
cur_°©s
 = &
p_Vid
->
íc_pi˘uª
->
°©s
;

165 i‡(
mbBôs
->
mb_tŸÆ
 > 
p_Vid
->
max_bôCou¡
)

166 
	`¥ötf
("W¨nög!!! Numbî o‡bô†(%dËo‡ma¸oblock_œyî(Ëd©®£em†tÿex˚ed deföedÜimô (%d).\n", 
mbBôs
->
mb_tŸÆ
,
p_Vid
->
max_bôCou¡
);

169 
cur_°©s
->
bô_u£_mb_ty≥
[
¶i˚_ty≥
] +
mbBôs
->
mb_mode
;

170 
cur_°©s
->
tmp_bô_u£_cbp
[
¶i˚_ty≥
] +
mbBôs
->
mb_cbp
;

171 
cur_°©s
->
bô_u£_c€ffC
[
¶i˚_ty≥
] +
mbBôs
->
mb_uv_c€ff
;

172 
cur_°©s
->
bô_u£_c€ff
[0][
¶i˚_ty≥
] +
mbBôs
->
mb_y_c€ff
;

173 
cur_°©s
->
bô_u£_c€ff
[1][
¶i˚_ty≥
] +
mbBôs
->
mb_cb_c€ff
;

174 
cur_°©s
->
bô_u£_c€ff
[2][
¶i˚_ty≥
] +
mbBôs
->
mb_¸_c€ff
;

175 
cur_°©s
->
bô_u£_dñè_qu™t
[
¶i˚_ty≥
] +
mbBôs
->
mb_dñè_qu™t
;

176 
cur_°©s
->
bô_u£_°uffög_bôs
[
¶i˚_ty≥
] +
mbBôs
->
mb_°uffög
;

178 i‡(
	`is_öåa
(
cuºMB
))

180 ++
cur_°©s
->
öåa_chroma_mode
[ (Ë
cuºMB
->
c_ùªd_mode
];

183 i‡((
cuºMB
->
cbp
&15) != 0)

185 ++
cur_°©s
->
mode_u£_å™sf‹m
[
¶i˚_ty≥
][
cuºMB
->
mb_ty≥
][cuºMB->
luma_å™sf‹m_size_8x8_Êag
];

189 ++
cur_°©s
->
mode_u£
[
¶i˚_ty≥
][
cuºMB
->
mb_ty≥
];

190 
cur_°©s
->
bô_u£_mode
[
¶i˚_ty≥
][
cuºMB
->
mb_ty≥
] +
mbBôs
->
mb_öãr
;

192 i‡(
¶i˚_ty≥
 !
I_SLICE
)

194 i‡(
cuºMB
->
mb_ty≥
 =
P8x8
)

196 
i
=0;i<4;++i)

198 i‡(
cuºMB
->
b8x8
[
i
].
mode
 > 0)

199 ++
cur_°©s
->
mode_u£
[
¶i˚_ty≥
][(Ë
cuºMB
->
b8x8
[
i
].
mode
];

201 ++
cur_°©s
->
b8_mode_0_u£
[
¶i˚_ty≥
][
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
];

203 i‡(
cuºMB
->
b8x8
[
i
].
mode
 ==4)

205 i‡((
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 && (cuºMB->
cbp
&15Ë!0Ë|| 
p_I≈
->
Tønsf‹m8x8Mode
 == 2)

206 ++
cur_°©s
->
mode_u£_å™sf‹m
[
¶i˚_ty≥
][4][1];

208 ++
cur_°©s
->
mode_u£_å™sf‹m
[
¶i˚_ty≥
][4][0];

212 i‡(
cuºMB
->
mb_ty≥
 >0 && cuºMB->mb_ty≥ <=3 && ((cuºMB->
cbp
&15) != 0))

214 ++
cur_°©s
->
mode_u£_å™sf‹m
[
¶i˚_ty≥
][
cuºMB
->
mb_ty≥
][cuºMB->
luma_å™sf‹m_size_8x8_Êag
];

219 
cur_°©s
->
qu™t
[
¶i˚_ty≥
] +
cuºMB
->
qp
;

220 ++
cur_°©s
->
num_ma¸oblocks
[
¶i˚_ty≥
];

221 
	}
}

223 
	$£t_chroma_qp
(
Ma¸oblock
* 
cuºMB
)

225 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

226 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

227 
i
;

228 
i
 = 0; i <= 1; ++i)

230 
cuºMB
->
qpc
[
i
] = (Ë
	`iClù3
 ( -
cuºSli˚
->
bôdïth_chroma_qp_sˇÀ
, 51, cuºMB->
qp
 + 
p_Vid
->
chroma_qp_off£t
[i] );

231 
cuºMB
->
qpc
[
i
] = (Ë(cuºMB->qpc[i] < 0 ? cuºMB->qpc[i] : 
QP_SCALE_CR
[currMB->qpc[i]]);

232 
cuºMB
->
qp_sˇÀd
[
i
 + 1] = (Ë(cuºMB->
qpc
[i] + 
cuºSli˚
->
bôdïth_chroma_qp_sˇÀ
);

234 
	}
}

242 
	$upd©e_qp
(
Ma¸oblock
 *
cuºMB
)

244 
cuºMB
->
qp_sˇÀd
[
PLANE_Y
] = (Ë(cuºMB->
qp
 + cuºMB->
p_Sli˚
->
bôdïth_luma_qp_sˇÀ
);

245 
	`£t_chroma_qp
(
cuºMB
);

247 
	`£À˘_å™sf‹m
(
cuºMB
);

248 
	}
}

259 
	$ª£t_ma¸oblock
(
Ma¸oblock
 *
cuºMB
)

261 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

262 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

263 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

264 
PicMŸi⁄P¨ams
 **
mŸi⁄
 = 
p_Vid
->
íc_pi˘uª
->
mv_öfo
;

265 
PicMŸi⁄P¨ams
 *
p_mŸi⁄
;

266 
j
, 
i
;

269 
j
=
cuºMB
->
block_y
; j < cuºMB->block_y + 
BLOCK_MULTIPLE
; ++j)

271 
i
 = 
cuºMB
->
block_x
; i < cuºMB->block_x + 
BLOCK_MULTIPLE
; ++i)

273 
p_mŸi⁄
 = &
mŸi⁄
[
j
][
i
];

274 
p_mŸi⁄
->
ªf_pic
[
LIST_0
] = 
NULL
;

275 
p_mŸi⁄
->
ªf_pic
[
LIST_1
] = 
NULL
;

276 
p_mŸi⁄
->
mv
 [
LIST_0
] = 
zîo_mv
;

277 
p_mŸi⁄
->
mv
 [
LIST_1
] = 
zîo_mv
;

278 
p_mŸi⁄
->
ªf_idx
[
LIST_0
] = -1;

279 
p_mŸi⁄
->
ªf_idx
[
LIST_1
] = -1;

285 
cuºMB
->
mb_ty≥
 = 0;

286 
cuºMB
->
cbp_blk
 = 0;

287 
cuºMB
->
cbp
 = 0;

288 
cuºMB
->
c_ùªd_mode
 = 
DC_PRED_8
;

290 
cuºSli˚
->
cmp_cbp
[1] = cuºSli˚->cmp_cbp[2] = cuºSli˚->
cuº_cbp
[0] = currSlice->curr_cbp[1] = 0;

292 
	`mem£t
(
cuºMB
->
cbp_bôs
 , 0, 3 * (
öt64
));

293 
	`mem£t
(
cuºMB
->
cbp_bôs_8x8
, 0, 3 * (
öt64
));

295 
	`mem£t
 (
cuºMB
->
mvd
, 0, 
BLOCK_CONTEXT
 * ());

296 
	`mem£t
 (
cuºMB
->
öåa_¥ed_modes
, 
DC_PRED
, 
MB_BLOCK_PARTITIONS
 * ());

297 
	`mem£t
 (
cuºMB
->
öåa_¥ed_modes8x8
, 
DC_PRED
, 
MB_BLOCK_PARTITIONS
 * ());

299 
cuºMB
->
b8x8
[0].
bùªd
 = 0;

300 
cuºMB
->
b8x8
[1].
bùªd
 = 0;

301 
cuºMB
->
b8x8
[2].
bùªd
 = 0;

302 
cuºMB
->
b8x8
[3].
bùªd
 = 0;

304 
cuºMB
->
wrôe_mb
 = 
FALSE
;

308 i‡(
p_I≈
->
U£C⁄°øöedI¡øPªd
)

310 
p_Vid
->
öåa_block
[
cuºMB
->
mbAddrX
] = 1;

314 
	`mem£t
(&
cuºMB
->
bôs
, 0, (
BôCou¡î
));

316 
cuºMB
->
mö_rdco°
 = 
DISTBLK_MAX
;

317 
cuºMB
->
mö_dco°
 = 
DISTBLK_MAX
;

318 
cuºMB
->
mö_øã
 = 
DISTBLK_MAX
;

320 
cuºMB
->
be°_mode
 = 0;

321 
cuºMB
->
be°_c_imode
 = 0;

322 
cuºMB
->
be°_i16off£t
 = 0;

323 
cuºMB
->
be°_cbp
 = 0;

324 
	}
}

342 
	$°¨t_ma¸oblock
(
Sli˚
 *
cuºSli˚
, 
Ma¸oblock
 **
cuºMB
, 
mb_addr
, 
Boﬁón
 
mb_fõld
)

344 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

345 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºSli˚
->p_Inp;

346 
i
, 
mb_qp
;

347 
u£_bô°ªam_backög
 = (
p_I≈
->
¶i˚_mode
 =
FIXED_RATE
 ||Ö_I≈->¶i˚_modê=
CALL_BACK
);

349 
Ma¸oblock
 *
œ°_coded_mb
 = 
NULL
;

351 
D©aP¨tôi⁄
 *
d©aP¨t
;

352 
Bô°ªam
 *
cuºSåóm
;

353 
¥ev_mb
;

355 *
cuºMB
 = &
p_Vid
->
mb_d©a
[
mb_addr
];

356 (*
cuºMB
)->
p_Sli˚
 = 
cuºSli˚
;

357 (*
cuºMB
)->
p_Vid
 =Ö_Vid;

358 (*
cuºMB
)->
p_I≈
 =Ö_Inp;

360 (*
cuºMB
)->
mbAddrX
 = 
mb_addr
;

362 (*
cuºMB
)->
is_öåa_block
 = (
cuºSli˚
->
¶i˚_ty≥
 =
I_SLICE
 || cuºSli˚->¶i˚_ty≥ =
SI_SLICE
Ë? 
TRUE
 : 
FALSE
;

364 (*
cuºMB
)->
mb_fõld
 = (
byã
) mb_field;

365 
p_Vid
->
íc_pi˘uª
->
mŸi⁄
.
mb_fõld
[
mb_addr
] = (
byã
) mb_field;

367 (*
cuºMB
)->
is_fõld_mode
 = (
byã
Ë(
p_Vid
->
fõld_pi˘uª
 || ( 
cuºSli˚
->
mb_aff_‰ame_Êag
 && (*cuºMB)->
mb_fõld
));

368 (*
cuºMB
)->
¥ev_ªcode_mb
 = 
FALSE
;

369 (*
cuºMB
)->
DeblockCÆl
 = 
FALSE
;

371 (*
cuºMB
)->
öåa4x4_¥ed
 = (*cuºMB)->
öåa4x4_¥ed_buf
[
p_Vid
->
dpb_œyî_id
];

372 (*
cuºMB
)->
öåa8x8_¥ed
 = (*cuºMB)->
öåa8x8_¥ed_buf
[
p_Vid
->
dpb_œyî_id
];

373 (*
cuºMB
)->
öåa16x16_¥ed
 = (*cuºMB)->
öåa16x16_¥ed_buf
[
p_Vid
->
dpb_œyî_id
];

375 
	`£t_MB_∑ømëîs
 (
cuºSli˚
, *
cuºMB
);

377 
¥ev_mb
 = 
	`FmoGëPªviousMBNr
(
p_Vid
, 
mb_addr
);

379 if(
u£_bô°ªam_backög
)

381 i‡((!
p_I≈
->
MbI¡îœ˚
)||((
mb_addr
 & 0x01)==0))

384 if(!
p_Vid
->
cod_cou¡î
)

386 
i
=0; i<
cuºSli˚
->
max_∑π_ƒ
; ++i)

388 
d©aP¨t
 = &(
cuºSli˚
->
∑πAº
[
i
]);

389 
cuºSåóm
 = 
d©aP¨t
->
bô°ªam
;

390 
cuºSåóm
->
°‹ed_bôs_to_go
 = cuºSåóm->
bôs_to_go
;

391 
cuºSåóm
->
°‹ed_byã_pos
 = cuºSåóm->
byã_pos
;

392 
cuºSåóm
->
°‹ed_byã_buf
 = cuºSåóm->
byã_buf
;

393 
p_Vid
->
p_Sèts
->
°‹ed_bô_¶i˚
 =Ö_Vid->p_Sèts->
bô_¶i˚
;

395 i‡(
cuºSli˚
->
symbﬁ_mode
 ==
CABAC
)

397 
d©aP¨t
->
ì_ªcode
 = d©aP¨t->
ì_ˇbac
;

406 (*
cuºMB
)->
¶i˚_ƒ
 = 
cuºSli˚
->slice_nr;

410 (*
cuºMB
)->
qp•
 = (Ë
p_Vid
->qpsp;

412 i‡(
¥ev_mb
 > -1 && (
p_Vid
->
mb_d©a
[¥ev_mb].
¶i˚_ƒ
 =
cuºSli˚
->slice_nr))

414 (*
cuºMB
)->
PªvMB
 = &
p_Vid
->
mb_d©a
[
¥ev_mb
];

415 (*
cuºMB
)->
¥ev_qp
 = (*cuºMB)->
PªvMB
->
qp
;

416 (*
cuºMB
)->
¥ev_dqp
 = (*cuºMB)->
¥ev_qp
 - (*cuºMB)->
PªvMB
->prev_qp;

420 
¥ev_mb
 = - 1;

421 (*
cuºMB
)->
PªvMB
 = 
NULL
;

422 (*
cuºMB
)->
¥ev_qp
 = (Ë
cuºSli˚
->
qp
;

423 (*
cuºMB
)->
¥ev_dqp
 = 0;

426 if(
p_I≈
->
RCE«bÀ
 && (
œ°_coded_mb
 !*
cuºMB
))

428 
mb_qp
 = 
	`rc_h™dÀ_mb
–*
cuºMB
, 
¥ev_mb
);

432 
mb_qp
 = 
p_Vid
->
qp
;

435 
œ°_coded_mb
 = *
cuºMB
;

437 i‡((*
cuºMB
)->
mbAddrX
 == 0)

438 
p_Vid
->
BasicUnôQP
 = 
mb_qp
;

440 
mb_qp
 = 
	`iClù3
(-
cuºSli˚
->
bôdïth_luma_qp_sˇÀ
, 51, mb_qp);

441 (*
cuºMB
)->
qp
 = (Ë
mb_qp
;

442 
p_Vid
->
qp
 = 
mb_qp
;

444 
	`upd©e_qp
 (*
cuºMB
);

448 i‡(
p_Vid
->
a˘ive_µs
->
deblockög_fûãr_c⁄åﬁ_¥e£¡_Êag
)

450 (*
cuºMB
)->
DFDißbÀIdc
 = 
cuºSli˚
->DFDisableIdc;

451 (*
cuºMB
)->
DFAÕhaC0Off£t
 = 
cuºSli˚
->DFAlphaC0Offset;

452 (*
cuºMB
)->
DFBëaOff£t
 = 
cuºSli˚
->DFBetaOffset;

456 (*
cuºMB
)->
DFDißbÀIdc
 = 0;

457 (*
cuºMB
)->
DFAÕhaC0Off£t
 = 0;

458 (*
cuºMB
)->
DFBëaOff£t
 = 0;

460 (*
cuºMB
)->
mö_rdco°
 = 
DISTBLK_MAX
;

461 (*
cuºMB
)->
mö_dco°
 = 
DISTBLK_MAX
;

462 (*
cuºMB
)->
mö_øã
 = 
DISTBLK_MAX
;

464 (*
cuºMB
)->
i16mode
 = 0;

465 (*
cuºMB
)->
be°_mode
 = 10;

467 i‡((
p_Vid
->
yuv_f‹m©
!=0) && (p_Vid->yuv_format!=3))

469 (*
cuºMB
)->
cbp_löfo_öåa
 = 
cbp_löfo_öåa_n‹mÆ
;

470 (*
cuºMB
)->
cbp_löfo_öãr
 = 
cbp_löfo_öãr_n‹mÆ
;

474 (*
cuºMB
)->
cbp_löfo_öåa
 = 
cbp_löfo_öåa_Ÿhî
;

475 (*
cuºMB
)->
cbp_löfo_öãr
 = 
cbp_löfo_öãr_Ÿhî
;

479 i‡(
cuºSli˚
->
¶i˚_ty≥
 !
I_SLICE
 && cuºSli˚->¶i˚_ty≥ !
SI_SLICE
)

481 
	`öô_mŸi⁄_ve˘‹_¥edi˘i⁄
(*
cuºMB
, 
cuºSli˚
->
mb_aff_‰ame_Êag
);

482 
	`öô_ME_ígöe
(*
cuºMB
);

486 
	`CheckAvaûabûôyOfNeighb‹s
(*
cuºMB
);

488 i‡(
cuºSli˚
->
symbﬁ_mode
 =
CABAC
)

489 
	`CheckAvaûabûôyOfNeighb‹sCABAC
(*
cuºMB
);

491 
	`ª£t_ma¸oblock
(*
cuºMB
);

493 i‡((
p_I≈
->
SórchMode
[
p_Vid
->
võw_id
] =
FAST_FULL_SEARCH
Ë&& (!p_I≈->
I¡øProfûe
))

494 
	`ª£t_Á°_fuŒ_£¨ch
 (
p_Vid
);

497 #i‡
TRACE


498 
i
=0; i<
cuºSli˚
->
max_∑π_ƒ
; ++i )

500 
cuºSli˚
->
∑πAº
[
i
].
bô°ªam
->
åa˚_íabÀd
 = 
FALSE
;

503 
	}
}

512 
	$íd_ma¸oblock
(
Ma¸oblock
 *
cuºMB
,

513 
Boﬁón
 *
íd_of_¶i˚
,

514 
Boﬁón
 *
ªcode_ma¸oblock


517 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

518 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

519 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

520 
i
;

521 
Sy¡axEÀmít
 
£
;

522 c⁄° *
∑πM≠
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
∑πôi⁄_mode
];

523 
D©aP¨tôi⁄
 *
d©aP¨t
;

524 
Bô°ªam
 *
cuºSåóm
;

525 
æc_bôs
=0;

526 
u£_bô°ªam_backög
 = (
p_I≈
->
¶i˚_mode
 =
FIXED_RATE
 ||Ö_I≈->¶i˚_modê=
CALL_BACK
);

527 
skù
 = 
FALSE
;

528 
√w_¶i˚
 = 0;

532 i‡((
cuºMB
->
mbAddrX
 =0Ë|| cuºMB->
PªvMB
 =
NULL
 || ( cuºMB->PªvMB->
¶i˚_ƒ
 !
cuºSli˚
->slice_nr ))

533 
√w_¶i˚
=1;

535 *
ªcode_ma¸oblock
=
FALSE
;

537 
p_I≈
->
¶i˚_mode
)

539 
NO_SLICES
:

540 ++
cuºSli˚
->
num_mb
;

541 *
ªcode_ma¸oblock
 = 
FALSE
;

542 i‡((
cuºSli˚
->
num_mb
Ë=()
p_Vid
->
PicSizeInMbs
)

543 *
íd_of_¶i˚
 = 
TRUE
;

546 *
íd_of_¶i˚
 = (
Boﬁón
Ë(*íd_of_¶i˚ | (
cuºMB
->
mbAddrX
 =
	`FmoGëLa°CodedMBOfSli˚Group
 (
p_Vid
, 
	`FmoMB2Sli˚Group
 (p_Vid, currMB->mbAddrX))));

549 
FIXED_MB
:

551 ++
cuºSli˚
->
num_mb
;

552 *
ªcode_ma¸oblock
 = 
FALSE
;

554 *
íd_of_¶i˚
 = (
Boﬁón
Ë(
cuºMB
->
mbAddrX
 =
	`FmoGëLa°CodedMBOfSli˚Group
 (
p_Vid
, 
	`FmoMB2Sli˚Group
 (p_Vid, currMB->mbAddrX)));

556 *
íd_of_¶i˚
 = (
Boﬁón
Ë(*íd_of_¶i˚ | (
cuºSli˚
->
num_mb
 >
p_I≈
->
¶i˚_¨gumít
));

563 
FIXED_RATE
:

566 if(
p_Vid
->
cod_cou¡î
)

569 
£
.
vÆue1
 = 
p_Vid
->
cod_cou¡î
;

570 
£
.
vÆue2
 = 0;

571 
£
.
ty≥
 = 
SE_MBTYPE
;

572 
d©aP¨t
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
£
.
ty≥
]]);

574 
	`TRACE_SE
 (
£
.
åa˚°rög
, "mb_skip_run");

575 
	`wrôeSE_UVLC
(&
£
, 
d©aP¨t
);

576 
æc_bôs
=
£
.
Àn
;

578 
i
=0; i<
cuºSli˚
->
max_∑π_ƒ
; ++i)

580 
d©aP¨t
 = &(
cuºSli˚
->
∑πAº
[
i
]);

581 
cuºSåóm
 = 
d©aP¨t
->
bô°ªam
;

583 
cuºSåóm
->
bôs_to_go_skù
 = cuºSåóm->
bôs_to_go
;

584 
cuºSåóm
->
byã_pos_skù
 = cuºSåóm->
byã_pos
;

585 
cuºSåóm
->
byã_buf_skù
 = cuºSåóm->
byã_buf
;

587 
cuºSåóm
->
bôs_to_go
 = cuºSåóm->
°‹ed_bôs_to_go
;

588 
cuºSåóm
->
byã_pos
 = cuºSåóm->
°‹ed_byã_pos
;

589 
cuºSåóm
->
byã_buf
 = cuºSåóm->
°‹ed_byã_buf
;

591 
skù
 = 
TRUE
;

595 i‡(!
√w_¶i˚
)

597 if(
	`¶i˚_too_big
(
cuºSli˚
, 
æc_bôs
))

599 *
ªcode_ma¸oblock
 = 
TRUE
;

600 *
íd_of_¶i˚
 = 
TRUE
;

602 if(!
p_Vid
->
cod_cou¡î
)

603 
skù
 = 
FALSE
;

608 i‡((*
ªcode_ma¸oblock
 =
FALSE
Ë&& (
cuºMB
->
mbAddrX
 =
	`FmoGëLa°CodedMBOfSli˚Group
 (
p_Vid
, 
	`FmoMB2Sli˚Group
 (p_Vid, currMB->mbAddrX))))

610 *
íd_of_¶i˚
 = 
TRUE
;

611 if(!
p_Vid
->
cod_cou¡î
)

612 
skù
 = 
FALSE
;

616 i‡(
√w_¶i˚
 && 
	`¶i˚_too_big
(
cuºSli˚
, 
æc_bôs
))

618 *
íd_of_¶i˚
 = 
TRUE
;

619 if(!
p_Vid
->
cod_cou¡î
)

620 
skù
 = 
FALSE
;

622 i‡(!*
ªcode_ma¸oblock
)

623 ++
cuºSli˚
->
num_mb
;

626 
CALL_BACK
:

627 i‡(
cuºMB
->
mbAddrX
 > 0 && !
√w_¶i˚
)

629 i‡(
cuºSli˚
->
	`¶i˚_too_big
(
æc_bôs
))

631 *
ªcode_ma¸oblock
 = 
TRUE
;

632 *
íd_of_¶i˚
 = 
TRUE
;

636 i‡–(*
ªcode_ma¸oblock
 =
FALSE
Ë&& (
cuºMB
->
mbAddrX
 =
	`FmoGëLa°CodedMBOfSli˚Group
 (
p_Vid
, 
	`FmoMB2Sli˚Group
 (p_Vid, currMB->mbAddrX))))

637 *
íd_of_¶i˚
 = 
TRUE
;

641 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Sli˚ Modê%dÇŸ suµ‹ãd", 
p_I≈
->
¶i˚_mode
);

642 
	`îr‹
(
îr‹ãxt
, 600);

645 i‡(*
ªcode_ma¸oblock
 =
TRUE
)

648 
i
=0; i<
cuºSli˚
->
max_∑π_ƒ
; ++i)

650 
d©aP¨t
 = &(
cuºSli˚
->
∑πAº
[
i
]);

651 
cuºSåóm
 = 
d©aP¨t
->
bô°ªam
;

652 
cuºSåóm
->
bôs_to_go
 = cuºSåóm->
°‹ed_bôs_to_go
;

653 
cuºSåóm
->
byã_pos
 = cuºSåóm->
°‹ed_byã_pos
;

654 
cuºSåóm
->
byã_buf
 = cuºSåóm->
°‹ed_byã_buf
;

655 
p_Vid
->
p_Sèts
->
bô_¶i˚
 =Ö_Vid->p_Sèts->
°‹ed_bô_¶i˚
;

657 i‡(
cuºSli˚
->
symbﬁ_mode
 =
CABAC
)

659 
d©aP¨t
->
ì_ˇbac
 = d©aP¨t->
ì_ªcode
;

664 i‡(
cuºSli˚
->
symbﬁ_mode
 =
CAVLC
)

667 
d©aP¨t
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_MBTYPE
]]);

668 if(*
íd_of_¶i˚
 =
TRUE
 && 
skù
 == TRUE)

672 if(
p_Vid
->
cod_cou¡î
 && *
ªcode_ma¸oblock
 =
TRUE
)

676 
p_Vid
->
cod_cou¡î
--;

677 if(
p_Vid
->
cod_cou¡î
)

679 
£
.
vÆue1
 = 
p_Vid
->
cod_cou¡î
;

680 
£
.
vÆue2
 = 0;

681 
£
.
ty≥
 = 
SE_MBTYPE
;

682 #i‡
TRACE


683 
	`¢¥ötf
(
£
.
åa˚°rög
, 
TRACESTRING_SIZE
, "FöÆ MBÑu∆ígth = %3d",
p_Vid
->
cod_cou¡î
);

685 
	`wrôeSE_UVLC
(&
£
, 
d©aP¨t
);

686 
æc_bôs
=
£
.
Àn
;

687 
cuºMB
->
bôs
.
mb_mode
 = cuºMB->bôs.mb_modê+ (Ë
æc_bôs
;

688 
p_Vid
->
cod_cou¡î
 = 0;

693 
i
=0; i<
cuºSli˚
->
max_∑π_ƒ
; ++i)

695 
d©aP¨t
 = &(
cuºSli˚
->
∑πAº
[
i
]);

696 
cuºSåóm
 = 
d©aP¨t
->
bô°ªam
;

698 
cuºSåóm
->
bôs_to_go
 = cuºSåóm->
bôs_to_go_skù
;

699 
cuºSåóm
->
byã_pos
 = cuºSåóm->
byã_pos_skù
;

700 
cuºSåóm
->
byã_buf
 = cuºSåóm->
byã_buf_skù
;

703 
p_Vid
->
cod_cou¡î
 = 0;

704 
skù
 = 
FALSE
;

709 if(*
íd_of_¶i˚
 =
TRUE
 && 
p_Vid
->
cod_cou¡î
 && !
u£_bô°ªam_backög
)

711 
£
.
vÆue1
 = 
p_Vid
->
cod_cou¡î
;

712 
£
.
vÆue2
 = 0;

713 
£
.
ty≥
 = 
SE_MBTYPE
;

715 
	`TRACE_SE
 (
£
.
åa˚°rög
, "mb_skip_run");

716 
	`wrôeSE_UVLC
(&
£
, 
d©aP¨t
);

718 
æc_bôs
=
£
.
Àn
;

719 
cuºMB
->
bôs
.
mb_mode
 = cuºMB->bôs.mb_modê+ (Ë
æc_bôs
;

720 
p_Vid
->
cod_cou¡î
 = 0;

723 
	}
}

746 
	$¶i˚_too_big
(
Sli˚
 *
cuºSli˚
, 
æc_bôs
)

748 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºSli˚
->p_Inp;

749 
D©aP¨tôi⁄
 *
d©aP¨t
;

750 
Bô°ªam
 *
cuºSåóm
;

751 
EncodögEnvú⁄mítPå
 
ìp
;

752 
i
;

753 
size_ö_byãs
;

756 i‡(
cuºSli˚
->
symbﬁ_mode
 =
CAVLC
)

758 
i
 = 0; i < 
cuºSli˚
->
max_∑π_ƒ
; ++i)

760 
d©aP¨t
 = &(
cuºSli˚
->
∑πAº
[
i
]);

761 
cuºSåóm
 = 
d©aP¨t
->
bô°ªam
;

762 
size_ö_byãs
 = 
cuºSåóm
->
byã_pos
 ;

764 i‡(
cuºSåóm
->
bôs_to_go
 < 8)

765 ++
size_ö_byãs
;

766 i‡(
cuºSåóm
->
bôs_to_go
 < 
æc_bôs
)

767 ++
size_ö_byãs
;

768 if(
size_ö_byãs
 > 
p_I≈
->
¶i˚_¨gumít
)

769  
TRUE
;

774 
i
=0; i<
cuºSli˚
->
max_∑π_ƒ
; ++i)

776 
d©aP¨t
&(
cuºSli˚
->
∑πAº
[
i
]);

777 
ìp
 = &(
d©aP¨t
->
ì_ˇbac
);

779 if–
	`¨õnco_bôs_wrôãn
(
ìp
Ë> (
p_I≈
->
¶i˚_¨gumít
*8))

780  
TRUE
;

784  
FALSE
;

785 
	}
}

806 
	$ª£t_block
(
Ma¸oblock
* 
cuºMB
, *
cbp
, 
öt64
 *
cbp_blk
, 
block8x8
)

808 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

809 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

810 
i
, 
j
;

811 
mb_y
 = (
block8x8
 >> 1) << 3;

812 
mb_x
 = (
block8x8
 & 0x01) << 3;

813 
cbp_mask
 = 1 << 
block8x8
;

815 (*
cbp
Ë&(63 - 
cbp_mask
);

816 (*
cbp_blk
Ë&~(51 << (4 * 
block8x8
 - 2 * (block8x8 & 0x01)));

818 
	`mem£t
–
cuºSli˚
->
cofAC
[
block8x8
][0][0], 0, 4 * 2 * 65 * ());

820 
	`c›y_image_d©a_8x8
(&
p_Vid
->
íc_pi˘uª
->
imgY
[
cuºMB
->
pix_y
 + 
mb_y
], &
cuºSli˚
->
mb_¥ed
[0][mb_y], cuºMB->
pix_x
 + 
mb_x
, mb_x);

822 i‡(
cuºSli˚
->
¶i˚_ty≥
 =
SP_SLICE
 || cuºSli˚->¶i˚_ty≥ =
SI_SLICE
)

824 
i
 = 
mb_x
; i < mb_x + 
BLOCK_SIZE_8x8
; i +
BLOCK_SIZE
)

825 
j
 = 
mb_y
; j < mb_y + 
BLOCK_SIZE_8x8
; j +
BLOCK_SIZE
)

826 
	`c›yblock_•
(
cuºMB
, 
PLANE_Y
, 
i
, 
j
);

830 
	}
}

841 
	$luma_ªsiduÆ_codög_16x16
 (
Ma¸oblock
* 
cuºMB
,

842 
block8x8
,

843 
li°_mode
[2]

847 *
cbp
 = &(
cuºMB
->cbp);

848 
öt64
 *
cbp_blk
 = &(
cuºMB
->cbp_blk);

849 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

850 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

851 
n⁄zîo
 = 0, 
cbp_blk_mask
;

852 
c€ff_co°
 = 0;

853 
mb_y
 = (
block8x8
 >> 1) << 3;

854 
mb_x
 = (
block8x8
 & 0x01) << 3;

855 
cbp_mask
 = 1 << 
block8x8
;

857 
skù≥d
 = (
li°_mode
[0] =0 &&Üi°_mode[1] =0 && (
cuºSli˚
->
¶i˚_ty≥
 !
B_SLICE
));

862 if(!
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
)

865 i‡(!
skù≥d
 && ( (
cuºSli˚
->
NoResidueDúe˘
 !1Ë|| (
cuºMB
->
qp_sˇÀd
[
PLANE_Y
] =0 && 
p_Vid
->
a˘ive_•s
->
los¶ess_qµrime_Êag
 == 1) ))

867 
block_y
, 
block_x
;

869 
block_y
=
mb_y
; block_y<mb_y + 8; block_y += 4)

871 
block_x
=
mb_x
; block_x<mb_x + 8; block_x += 4)

874 
n⁄zîo
 = 
cuºMB
->
	`ªsiduÆ_å™sf‹m_qu™t_luma_4x4
 (cuºMB, 
PLANE_Y
, 
block_x
, 
block_y
, &
c€ff_co°
, 0);

876 i‡(
n⁄zîo
)

878 
cbp_blk_mask
 = (
block_x
 >> 2Ë+ 
block_y
;

879 (*
cbp_blk
Ë|(
öt64
Ë1 << 
cbp_blk_mask
;

880 (*
cbp
Ë|
cbp_mask
;

888 i‡(
cuºSli˚
->
NoResidueDúe˘
 !1 && !
skù≥d
)

890 i‡(
cuºSli˚
->
¶i˚_ty≥
 !
SP_SLICE
 && cuºSli˚->¶i˚_ty≥ !
SI_SLICE
)

891 
n⁄zîo
 = 
cuºMB
->
	`ªsiduÆ_å™sf‹m_qu™t_luma_8x8
 (cuºMB, 
PLANE_Y
, 
block8x8
, &
c€ff_co°
, 0);

893 i‡(
n⁄zîo
)

895 (*
cbp_blk
Ë|51 << (4*
block8x8
 - 2*(block8x8 & 0x01));

896 (*
cbp
Ë|
cbp_mask
;

901 i‡(
cuºSli˚
->
NoResidueDúe˘
 !1 && !
skù≥d
 && 
c€ff_co°
 <
_LUMA_COEFF_COST_
 &&

902 ((
cuºMB
->
qp_sˇÀd
[
PLANE_Y
])!=0 || 
p_Vid
->
a˘ive_•s
->
los¶ess_qµrime_Êag
==0))

904 
c€ff_co°
 = 
	`ª£t_block
(
cuºMB
, 
cbp
, 
cbp_blk
, 
block8x8
);

907  
c€ff_co°
;

908 
	}
}

919 
	$luma_ªsiduÆ_codög_8x8
 (
Ma¸oblock
* 
cuºMB
,

920 *
cbp
,

921 
öt64
 *
cbp_blk
,

922 
block8x8
,

923 
p_dú
,

924 
li°_mode
[2],

925 *
ªf_idx
)

927 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

928 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

929 
DecodedPi˘uªBuf„r
 *
p_Dpb
 = 
p_Vid
->
p_Dpb_œyî
[p_Vid->
dpb_œyî_id
];

930 
block_y
, 
block_x
, 
pic_pix_x
, 
n⁄zîo
 = 0, 
cbp_blk_mask
;

931 
c€ff_co°
 = 0;

932 
mb_y
 = (
block8x8
 >> 1) << 3;

933 
mb_x
 = (
block8x8
 & 0x01) << 3;

934 
cbp_mask
 = 1 << 
block8x8
;

935 
skù≥d
 = (
li°_mode
[0] =0 &&Üi°_mode[1] =0 && (
cuºSli˚
->
¶i˚_ty≥
 !
B_SLICE
));

936 
Boﬁón
 
dúe˘_ö„ªn˚
 = (
li°_mode
[0] =0 &&Üi°_mode[1] =0 && 
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
 && 
p_Vid
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
 == 0);

938 
bùªd_me
 = 
cuºMB
->
b8x8
[
block8x8
].
bùªd
;

939 
cuºSli˚
->
c€ff_co°_¸
[1] = currSlice->coeff_cost_cr[2] = 0;

944 if(!
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
)

946 
bxx
, 
byy
;

947 i‡(!
dúe˘_ö„ªn˚
 && (((
p_dú
 =0 ||Ö_dú =2 )&& 
li°_mode
[0] < 5) || ((p_dir == 1 ||Ö_dir == 2 ) &&Üist_mode[1] < 5)))

949 
p_Dpb
->
	`pf_luma_¥edi˘i⁄
 (
cuºMB
, 
mb_x
, 
mb_y
, 8, 8, 
p_dú
, 
li°_mode
, 
ªf_idx
, 
bùªd_me
);

952 
	`compuã_ªsidue
 (&
p_Vid
->
pCurImg
[
cuºMB
->
›ix_y
 + 
mb_y
], &
cuºSli˚
->
mb_¥ed
[0][mb_y], &cuºSli˚->
mb_‹es
[0][mb_y], 
mb_x
, cuºMB->
pix_x
 + mb_x, 8, 8);

955 
byy
=0, 
block_y
=
mb_y
; block_y<mb_y+8; byy+=4, block_y+=4)

957 
bxx
=0, 
block_x
=
mb_x
; block_x<mb_x+8; bxx+=4, block_x+=4)

959 
pic_pix_x
 = 
cuºMB
->
pix_x
 + 
block_x
;

960 
cbp_blk_mask
 = (
block_x
 >> 2Ë+ 
block_y
;

963 i‡(
dúe˘_ö„ªn˚
 || !(((
p_dú
 =0 ||Ö_dú =2 )&& 
li°_mode
[0] < 5) || ((p_dir == 1 ||Ö_dir == 2 ) &&Üist_mode[1] < 5)))

965 
p_Dpb
->
	`pf_luma_¥edi˘i⁄
 (
cuºMB
, 
block_x
, 
block_y
, 4, 4, 
p_dú
, 
li°_mode
, 
ªf_idx
, 
bùªd_me
);

968 
	`compuã_ªsidue
(&
p_Vid
->
pCurImg
[
cuºMB
->
›ix_y
 + 
block_y
], &
cuºSli˚
->
mb_¥ed
[0][block_y], &cuºSli˚->
mb_‹es
[0][block_y], 
block_x
, 
pic_pix_x
, 4, 4);

972 i‡(!
skù≥d
 && ( (
cuºSli˚
->
NoResidueDúe˘
 !1Ë|| (
cuºMB
->
qp_sˇÀd
[
PLANE_Y
] =0 && 
p_Vid
->
a˘ive_•s
->
los¶ess_qµrime_Êag
 == 1) ))

975 
n⁄zîo
 = 
cuºMB
->
	`ªsiduÆ_å™sf‹m_qu™t_luma_4x4
 (cuºMB, 
PLANE_Y
, 
block_x
, 
block_y
, &
c€ff_co°
, 0);

977 i‡(
n⁄zîo
)

979 (*
cbp_blk
Ë|(
öt64
)1 << 
cbp_blk_mask
;

980 (*
cbp
Ë|
cbp_mask
;

988 
block_y
 = 
mb_y
;

989 
block_x
 = 
mb_x
;

990 
pic_pix_x
 = 
cuºMB
->
pix_x
 + 
block_x
;

992 
cbp_blk_mask
 = (
block_x
>>2Ë+ 
block_y
;

995 
p_Dpb
->
	`pf_luma_¥edi˘i⁄
 (
cuºMB
, 
block_x
, 
block_y
, 8, 8, 
p_dú
, 
li°_mode
, 
ªf_idx
, 
bùªd_me
);

998 
	`compuã_ªsidue
 (&
p_Vid
->
pCurImg
[
cuºMB
->
›ix_y
 + 
block_y
], &
cuºSli˚
->
mb_¥ed
[0][block_y], &cuºSli˚->
mb_‹es
[0][block_y], 
block_x
, 
pic_pix_x
, 8, 8);

1000 i‡(
cuºSli˚
->
NoResidueDúe˘
 !1 && !
skù≥d
)

1002 i‡(
cuºSli˚
->
¶i˚_ty≥
 !
SP_SLICE
 && cuºSli˚->¶i˚_ty≥ !
SI_SLICE
)

1003 
n⁄zîo
 = 
cuºMB
->
	`ªsiduÆ_å™sf‹m_qu™t_luma_8x8
 (cuºMB, 
PLANE_Y
, 
block8x8
, &
c€ff_co°
, 0);

1005 i‡(
n⁄zîo
)

1007 (*
cbp_blk
Ë|51 << (4*
block8x8
 - 2*(block8x8 & 0x01));

1008 (*
cbp
Ë|
cbp_mask
;

1013 i‡(
cuºSli˚
->
NoResidueDúe˘
 !1 && !
skù≥d
 && 
c€ff_co°
 <
_LUMA_COEFF_COST_
 &&

1014 ((
cuºMB
->
qp_sˇÀd
[
PLANE_Y
])!=0 || 
p_Vid
->
a˘ive_•s
->
los¶ess_qµrime_Êag
==0))

1016 
c€ff_co°
 = 
	`ª£t_block
(
cuºMB
, 
cbp
, 
cbp_blk
, 
block8x8
);

1019  
c€ff_co°
;

1020 
	}
}

1028 
	$£t_modes_™d_ª‰ame
 (
Ma¸oblock
* 
cuºMB
, 
b8
, * 
p_dú
, 
li°_mode
[2], *
li°_ªf_idx
)

1030 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1031 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1032 
PicMŸi⁄P¨ams
 **
mŸi⁄
 = 
p_Vid
->
íc_pi˘uª
->
mv_öfo
;

1033 
j
 = 2*(
b8
>>1);

1034 
i
 = 2*(
b8
 & 0x01);

1036 
li°_mode
[0] =Üi°_mode[1] = 
li°_ªf_idx
[0] =Üist_ref_idx[1] = -1;

1038 *
p_dú
 = 
cuºMB
->
b8x8
[
b8
].
pdú
;

1040 i‡(
cuºSli˚
->
¶i˚_ty≥
 !
B_SLICE
)

1042 
li°_ªf_idx
[0] = 
mŸi⁄
[
cuºMB
->
block_y
 + 
j
][cuºMB->
block_x
 + 
i
].
ªf_idx
[
LIST_0
];

1043 
li°_ªf_idx
[1] = 0;

1044 
li°_mode
[0] = 
cuºMB
->
b8x8
[
b8
].
mode
;

1045 
li°_mode
[1] = 0;

1049 i‡(*
p_dú
 == -1)

1051 
li°_ªf_idx
[0] = -1;

1052 
li°_ªf_idx
[1] = -1;

1053 
li°_mode
[0] = 0;

1054 
li°_mode
[1] = 0;

1056 i‡(*
p_dú
 == 0)

1058 
li°_ªf_idx
[0] = 
mŸi⁄
[
cuºMB
->
block_y
 + 
j
][cuºMB->
block_x
 + 
i
].
ªf_idx
[
LIST_0
];

1059 
li°_ªf_idx
[1] = 0;

1060 
li°_mode
[0] = 
cuºMB
->
b8x8
[
b8
].
mode
;

1061 
li°_mode
[1] = 0;

1063 i‡(*
p_dú
 == 1)

1065 
li°_ªf_idx
[0] = 0;

1066 
li°_ªf_idx
[1] = 
mŸi⁄
[
cuºMB
->
block_y
 + 
j
][cuºMB->
block_x
 + 
i
].
ªf_idx
[
LIST_1
];

1067 
li°_mode
[0] = 0;

1068 
li°_mode
[1] = 
cuºMB
->
b8x8
[
b8
].
mode
;

1072 
li°_ªf_idx
[0] = 
mŸi⁄
[
cuºMB
->
block_y
 + 
j
][cuºMB->
block_x
 + 
i
].
ªf_idx
[
LIST_0
];

1073 
li°_ªf_idx
[1] = 
mŸi⁄
[
cuºMB
->
block_y
 + 
j
][cuºMB->
block_x
 + 
i
].
ªf_idx
[
LIST_1
];

1074 
li°_mode
[0] = 
cuºMB
->
b8x8
[
b8
].
mode
;

1075 
li°_mode
[1] = 
cuºMB
->
b8x8
[
b8
].
mode
;

1078 
	}
}

1087 
	$£t_modes_™d_ª‰ame_i_¶i˚
 (
Ma¸oblock
* 
cuºMB
, 
b8
, * 
p_dú
, 
li°_mode
[2], *
li°_ªf_idx
)

1089 *
p_dú
 = 
cuºMB
->
b8x8
[
b8
].
pdú
;

1091 
li°_ªf_idx
[0] = -1;

1092 
li°_ªf_idx
[1] = 0;

1093 
li°_mode
[0] = 
cuºMB
->
b8x8
[
b8
].
mode
;

1094 
li°_mode
[1] = 0;

1095 
	}
}

1103 
	$£t_modes_™d_ª‰ame_p_¶i˚
 (
Ma¸oblock
* 
cuºMB
, 
b8
, * 
p_dú
, 
li°_mode
[2], *
li°_ªf_idx
)

1105 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1106 
PicMŸi⁄P¨ams
 **
mŸi⁄
 = 
p_Vid
->
íc_pi˘uª
->
mv_öfo
;

1107 
j
 = 2*(
b8
>>1);

1108 
i
 = 2*(
b8
 & 0x01);

1110 *
p_dú
 = 
cuºMB
->
b8x8
[
b8
].
pdú
;

1112 
li°_ªf_idx
[0] = 
mŸi⁄
[
cuºMB
->
block_y
 + 
j
][cuºMB->
block_x
 + 
i
].
ªf_idx
[
LIST_0
];

1113 
li°_ªf_idx
[1] = 0;

1114 
li°_mode
[0] = 
cuºMB
->
b8x8
[
b8
].
mode
;

1115 
li°_mode
[1] = 0;

1116 
	}
}

1126 
	$£t_modes_™d_ª‰ame_b_¶i˚
 (
Ma¸oblock
* 
cuºMB
, 
b8
, * 
p_dú
, 
li°_mode
[2], *
li°_ªf_idx
)

1128 *
p_dú
 = 
cuºMB
->
b8x8
[
b8
].
pdú
;

1130 i‡(*
p_dú
 == -1)

1132 
li°_ªf_idx
[0] = -1;

1133 
li°_ªf_idx
[1] = -1;

1134 
li°_mode
[0] = 0;

1135 
li°_mode
[1] = 0;

1137 i‡(*
p_dú
 == 0)

1139 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1140 
PicMŸi⁄P¨ams
 **
mŸi⁄
 = 
p_Vid
->
íc_pi˘uª
->
mv_öfo
;

1141 
j
 = 2*(
b8
>>1);

1142 
i
 = 2*(
b8
 & 0x01);

1144 
li°_ªf_idx
[0] = 
mŸi⁄
[
cuºMB
->
block_y
 + 
j
][cuºMB->
block_x
 + 
i
].
ªf_idx
[
LIST_0
];

1145 
li°_ªf_idx
[1] = 0;

1146 
li°_mode
[0] = 
cuºMB
->
b8x8
[
b8
].
mode
;

1147 
li°_mode
[1] = 0;

1149 i‡(*
p_dú
 == 1)

1151 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1152 
PicMŸi⁄P¨ams
 **
mŸi⁄
 = 
p_Vid
->
íc_pi˘uª
->
mv_öfo
;

1153 
j
 = 2*(
b8
>>1);

1154 
i
 = 2*(
b8
 & 0x01);

1156 
li°_ªf_idx
[0] = 0;

1157 
li°_ªf_idx
[1] = 
mŸi⁄
[
cuºMB
->
block_y
 + 
j
][cuºMB->
block_x
 + 
i
].
ªf_idx
[
LIST_1
];

1158 
li°_mode
[0] = 0;

1159 
li°_mode
[1] = 
cuºMB
->
b8x8
[
b8
].
mode
;

1163 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1164 
PicMŸi⁄P¨ams
 **
mŸi⁄
 = 
p_Vid
->
íc_pi˘uª
->
mv_öfo
;

1165 
j
 = 2*(
b8
>>1);

1166 
i
 = 2*(
b8
 & 0x01);

1168 
li°_ªf_idx
[0] = 
mŸi⁄
[
cuºMB
->
block_y
 + 
j
][cuºMB->
block_x
 + 
i
].
ªf_idx
[
LIST_0
];

1169 
li°_ªf_idx
[1] = 
mŸi⁄
[
cuºMB
->
block_y
 + 
j
][cuºMB->
block_x
 + 
i
].
ªf_idx
[
LIST_1
];

1170 
li°_mode
[0] = 
cuºMB
->
b8x8
[
b8
].
mode
;

1171 
li°_mode
[1] = 
cuºMB
->
b8x8
[
b8
].
mode
;

1173 
	}
}

1182 
	$luma_ªsiduÆ_codög
 (
Ma¸oblock
 *
cuºMB
)

1184 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1185 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1186 
DecodedPi˘uªBuf„r
 *
p_Dpb
 = 
p_Vid
->
p_Dpb_œyî
[p_Vid->
dpb_œyî_id
];

1188 
block8x8
;

1189 
li°_mode
[2];

1190 
li°_ªf_idx
[2];

1191 
p_dú
 = 0;

1193 
is_skù
 = 
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
 && 
cuºMB
->
mb_ty≥
 =
PSKIP
;

1195 
cuºMB
->
cbp
 = 0;

1196 
cuºMB
->
cbp_blk
 = 0;

1198 
cuºSli˚
->
cmp_cbp
[1] = currSlice->cmp_cbp[2] = 0;

1199 
cuºSli˚
->
cur_cbp_blk
[1] = currSlice->cur_cbp_blk[2] = 0;

1201 i‡(
is_skù
)

1203 
block8x8
=0; block8x8<4; ++block8x8)

1205 
cuºSli˚
->
	`£t_modes_™d_ª‰ame
 (
cuºMB
, 
block8x8
, &
p_dú
, 
li°_mode
, 
li°_ªf_idx
);

1209 
p_Dpb
->
	`pf_luma_¥edi˘i⁄
 (
cuºMB
, 0, 0, 16, 16, 
p_dú
, 
li°_mode
, 
li°_ªf_idx
, cuºMB->
b8x8
[0].
bùªd
);

1213 
	`compuã_ªsidue
 (&
p_Vid
->
pCurImg
[
cuºMB
->
›ix_y
], *
cuºSli˚
->
mb_¥ed
, *cuºSli˚->
mb_‹es
, 0, cuºMB->
pix_x
, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE);

1215 
	`c›y_image_d©a_16x16
(&
p_Vid
->
íc_pi˘uª
->
imgY
[
cuºMB
->
pix_y
], *
cuºSli˚
->
mb_¥ed
, cuºMB->
pix_x
, 0);

1219 
sum_˙t_n⁄z
 = 0;

1220 i‡(
cuºMB
->
mb_ty≥
 =
P16x16
)

1222 
block8x8
 = 0; block8x8 < 4; ++block8x8)

1224 
cuºSli˚
->
	`£t_modes_™d_ª‰ame
 (
cuºMB
, 
block8x8
, &
p_dú
, 
li°_mode
, 
li°_ªf_idx
);

1227 
p_Dpb
->
	`pf_luma_¥edi˘i⁄
 (
cuºMB
, 0, 0, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE, 
p_dú
, 
li°_mode
, 
li°_ªf_idx
, cuºMB->
b8x8
[0].
bùªd
);

1230 
	`compuã_ªsidue
 (&
p_Vid
->
pCurImg
[
cuºMB
->
›ix_y
], *
cuºSli˚
->
mb_¥ed
, *cuºSli˚->
mb_‹es
, 0, cuºMB->
pix_x
, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE);

1233 
block8x8
 = 0; block8x8 < 4; ++block8x8)

1235 
sum_˙t_n⁄z
 +
	`luma_ªsiduÆ_codög_16x16
 (
cuºMB
, 
block8x8
, 
li°_mode
);

1240 
block8x8
 = 0; block8x8 < 4; ++block8x8)

1242 
cuºSli˚
->
	`£t_modes_™d_ª‰ame
 (
cuºMB
, 
block8x8
, &
p_dú
, 
li°_mode
, 
li°_ªf_idx
);

1243 
sum_˙t_n⁄z
 +
cuºSli˚
->
	`luma_ªsiduÆ_codög_8x8
 (
cuºMB
, &(cuºMB->
cbp
), &(cuºMB->
cbp_blk
), 
block8x8
, 
p_dú
, 
li°_mode
, 
li°_ªf_idx
);

1248 i‡(
sum_˙t_n⁄z
 <
_LUMA_MB_COEFF_COST_
 && ((
cuºMB
->
qp_sˇÀd
[
PLANE_Y
])!=0 || 
p_Vid
->
a˘ive_•s
->
los¶ess_qµrime_Êag
 == 0))

1250 
cuºMB
->
cbp
 &= 0xfffff0 ;

1251 
cuºMB
->
cbp_blk
 &= 0xff0000 ;

1253 
	`c›y_image_d©a_16x16
(&
p_Vid
->
íc_pi˘uª
->
imgY
[
cuºMB
->
pix_y
], 
cuºSli˚
->
mb_¥ed
[0], cuºMB->
pix_x
, 0);

1257 
	}
}

1266 
	$luma_ªsiduÆ_codög_•
 (
Ma¸oblock
 *
cuºMB
)

1268 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1269 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1270 
DecodedPi˘uªBuf„r
 *
p_Dpb
 = 
p_Vid
->
p_Dpb_œyî
[p_Vid->
dpb_œyî_id
];

1272 
i
, 
j
, 
block8x8
, 
b8_x
, 
b8_y
;

1273 
li°_mode
[2];

1274 
li°_ªf_idx
[2];

1275 
p_dú
 = 0;

1276 
sum_˙t_n⁄z
 = 0;

1278 
is_skù
 = 
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
 && 
cuºMB
->
mb_ty≥
 =
PSKIP
;

1280 
cuºMB
->
cbp
 = 0;

1281 
cuºMB
->
cbp_blk
 = 0;

1283 
cuºSli˚
->
cmp_cbp
[1] = currSlice->cmp_cbp[2] = 0;

1284 
cuºSli˚
->
cur_cbp_blk
[1] = currSlice->cur_cbp_blk[2] = 0;

1286 i‡(
is_skù
 || 
cuºMB
->
mb_ty≥
 == 1)

1288 
block8x8
=0; block8x8<4; ++block8x8)

1290 
cuºSli˚
->
	`£t_modes_™d_ª‰ame
 (
cuºMB
, 
block8x8
, &
p_dú
, 
li°_mode
, 
li°_ªf_idx
);

1294 
p_Dpb
->
	`pf_luma_¥edi˘i⁄
 (
cuºMB
, 0, 0, 16, 16, 
p_dú
, 
li°_mode
, 
li°_ªf_idx
, cuºMB->
b8x8
[0].
bùªd
);

1298 
	`compuã_ªsidue
 (&
p_Vid
->
pCurImg
[
cuºMB
->
›ix_y
], &
cuºSli˚
->
mb_¥ed
[0][0], &cuºSli˚->
mb_‹es
[0][0], 0, cuºMB->
pix_x
, 16, 16);

1301 i‡(!
is_skù
)

1303 
block8x8
=0; block8x8<4; ++block8x8)

1305 
sum_˙t_n⁄z
 +
	`luma_ªsiduÆ_codög_16x16
 (
cuºMB
, 
block8x8
, 
li°_mode
);

1311 
block8x8
=0; block8x8<4; ++block8x8)

1313 
cuºSli˚
->
	`£t_modes_™d_ª‰ame
 (
cuºMB
, 
block8x8
, &
p_dú
, 
li°_mode
, 
li°_ªf_idx
);

1314 
sum_˙t_n⁄z
 +
cuºSli˚
->
	`luma_ªsiduÆ_codög_8x8
 (
cuºMB
, &(cuºMB->
cbp
), &(cuºMB->
cbp_blk
), 
block8x8
, 
p_dú
, 
li°_mode
, 
li°_ªf_idx
);

1320 i‡((
is_skù
 ||

1321 (
sum_˙t_n⁄z
 <
_LUMA_MB_COEFF_COST_
 && ((
cuºMB
->
qp_sˇÀd
[
PLANE_Y
])!=0 || 
p_Vid
->
a˘ive_•s
->
los¶ess_qµrime_Êag
 == 0))))

1323 
cuºMB
->
cbp
 &= 0xfffff0 ;

1324 
cuºMB
->
cbp_blk
 &= 0xff0000 ;

1326 
	`c›y_image_d©a_16x16
(&
p_Vid
->
íc_pi˘uª
->
imgY
[
cuºMB
->
pix_y
], 
cuºSli˚
->
mb_¥ed
[0], cuºMB->
pix_x
, 0);

1330 
block8x8
 = 0;block8x8 < 4; ++block8x8)

1332 
b8_x
=(
block8x8
&1)<<3;

1333 
b8_y
=(
block8x8
&2)<<2;

1334 
i
 = 
b8_x
; i < b8_x + 
BLOCK_SIZE_8x8
; i += 4)

1335 
j
 = 
b8_y
; j < b8_y + 
BLOCK_SIZE_8x8
;j += 4)

1336 
	`c›yblock_•
(
cuºMB
, 
PLANE_Y
, 
i
, 
j
);

1339 
	}
}

1347 
byã
 
	$å™sf‹m_decisi⁄
 (
Ma¸oblock
 *
cuºMB
, 
block_check
, 
di°blk
 *
co°
)

1349 if(
cuºMB
->
p_I≈
->
Tønsf‹m8x8Mode
 == 2)

1355 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1356 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1357 
DecodedPi˘uªBuf„r
 *
p_Dpb
 = 
p_Vid
->
p_Dpb_œyî
[p_Vid->
dpb_œyî_id
];

1358 
pic_pix_y
, 
pic_pix_x
, 
i
, 
j
;

1359 
mb_y
, 
mb_x
, 
block8x8
;

1360 
li°_mode
[2];

1361 
li°_ªf_idx
[2];

1362 
p_dú
;

1363 
num_blks
;

1364 
di°blk
 
co°8x8
=0, 
co°4x4
=0;

1365 
bùªd_me
;

1366 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_pred[0];

1367 
diff16
[4][16];

1368 
diff64
[64];

1369 
ödex
;

1371 if(
block_check
 == -1)

1373 
block8x8
 = 0;

1374 
num_blks
 = 4;

1378 
block8x8
 = 
block_check
;

1379 
num_blks
 = 
block_check
 + 1;

1382 ; 
block8x8
<
num_blks
; ++block8x8)

1384 *
tmp64
 = 
diff64
;

1385 *
tmp16
[4];

1387 
tmp16
[0] = 
diff16
[0];

1388 
tmp16
[1] = 
diff16
[1];

1389 
tmp16
[2] = 
diff16
[2];

1390 
tmp16
[3] = 
diff16
[3];

1392 
cuºSli˚
->
	`£t_modes_™d_ª‰ame
 (
cuºMB
, 
block8x8
, &
p_dú
, 
li°_mode
, 
li°_ªf_idx
);

1393 
bùªd_me
 = 
cuºMB
->
b8x8
[
block8x8
].
bùªd
;

1394 
mb_y
 = (
block8x8
 >> 1) << 3;

1395 
mb_x
 = (
block8x8
 & 0x01) << 3;

1398 
p_Dpb
->
	`pf_luma_¥edi˘i⁄
 (
cuºMB
, 
mb_x
, 
mb_y
, 8, 8, 
p_dú
, 
li°_mode
, 
li°_ªf_idx
, 
bùªd_me
);

1401 
pic_pix_y
 = 
cuºMB
->
›ix_y
;

1402 
pic_pix_x
 = 
cuºMB
->
pix_x
;

1404 
j
 = 
mb_y
; j < 8 + mb_y; j++)

1406 
i
 = 
mb_x
; i < 8 + mb_x; i++)

1408 
ödex
 = 2 * ((
j
 - 
mb_y
)> 3Ë+ ((
i
 - 
mb_x
)> 3);

1409 *
tmp64
++ = *(
tmp16
[
ödex
])++ = (Ë(
p_Vid
->
pCurImg
[
pic_pix_y
 + 
j
][
pic_pix_x
 + 
i
] - 
mb_¥ed
[j][i]);

1413 
co°4x4
 +
p_Vid
->
	`di°‹ti⁄4x4
 (
diff16
[0], 
DISTBLK_MAX
);

1414 
co°4x4
 +
p_Vid
->
	`di°‹ti⁄4x4
 (
diff16
[1], 
DISTBLK_MAX
);

1415 
co°4x4
 +
p_Vid
->
	`di°‹ti⁄4x4
 (
diff16
[2], 
DISTBLK_MAX
);

1416 
co°4x4
 +
p_Vid
->
	`di°‹ti⁄4x4
 (
diff16
[3], 
DISTBLK_MAX
);

1417 
co°8x8
 +
p_Vid
->
	`di°‹ti⁄8x8
 (
diff64
 , 
DISTBLK_MAX
);

1421 if(
co°8x8
 < 
co°4x4
)

1427 *
co°
 +(
co°4x4
 - 
co°8x8
);

1431 
	}
}

1439 
	$chroma_ªsiduÆ_codög
 (
Ma¸oblock
 *
cuºMB
)

1441 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1442 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

1443 
chroma_cbp
 = 0;

1444 
uv
, 
block_y
, 
block_x
;

1445 
li°_mode
[2];

1446 
li°_ªf_idx
[2];

1447 
p_dú
;

1448 
skù≥d
 = (
cuºMB
->
mb_ty≥
 =0 && (
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
));

1449 
yuv
 = 
p_Vid
->
yuv_f‹m©
 - 1;

1451 
uv
 = 0; uv < 2; ++uv)

1455 i‡(
cuºMB
->
mb_ty≥
 > 
P8x8
)

1457 
block_y
=0; block_y < 
p_Vid
->
mb_¸_size_y
; block_y +
BLOCK_SIZE
)

1459 
block_x
=0; block_x < 
p_Vid
->
mb_¸_size_x
; block_x +
BLOCK_SIZE
)

1461 
block8
 = 
block8x8_idx
[
yuv
][
block_y
>>2][
block_x
>>2];

1462 
cuºSli˚
->
	`£t_modes_™d_ª‰ame
 (
cuºMB
, 
block8
, &
p_dú
, 
li°_mode
, 
li°_ªf_idx
);

1463 
	`I¡øChromaPªdi˘i⁄4x4
 (
cuºMB
, 
uv
 + 1, 
block_x
, 
block_y
);

1469 
block_y
 = 0; block_y < 
p_Vid
->
mb_¸_size_y
; block_y +
BLOCK_SIZE
)

1471 
block_x
 = 0; block_x < 
p_Vid
->
mb_¸_size_x
; block_x +
BLOCK_SIZE
)

1473 
block8
 = 
block8x8_idx
[
yuv
][
block_y
>>2][
block_x
>>2];

1474 
bùªd_me
 = 
cuºMB
->
b8x8
[
block8
].
bùªd
;

1475 
cuºSli˚
->
	`£t_modes_™d_ª‰ame
 (
cuºMB
, 
block8
, &
p_dú
, 
li°_mode
, 
li°_ªf_idx
);

1477 
	`chroma_¥edi˘i⁄_4x4
 (
cuºMB
, 
uv
, 
block_x
, 
block_y
, 
p_dú
, 
li°_mode
[0],Üi°_mode[1], 
li°_ªf_idx
[0],Üi°_ªf_idx[1], 
bùªd_me
);

1483 i‡(
cuºSli˚
->
NoResidueDúe˘
)

1485 
	`c›y_image_d©a
(&
p_Vid
->
íc_pi˘uª
->
imgUV
[
uv
][
cuºMB
->
pix_c_y
], 
cuºSli˚
->
mb_¥ed
[ uv + 1], cuºMB->
pix_c_x
, 0,Ö_Vid->
mb_¸_size_x
,Ö_Vid->
mb_¸_size_y
);

1487 i‡(
skù≥d
)

1489 
	`c›y_image_d©a
(&
p_Vid
->
íc_pi˘uª
->
imgUV
[
uv
][
cuºMB
->
pix_c_y
], 
cuºSli˚
->
mb_¥ed
[ uv + 1], cuºMB->
pix_c_x
, 0,Ö_Vid->
mb_¸_size_x
,Ö_Vid->
mb_¸_size_y
);

1493 
	`compuã_ªsidue
(&
p_Vid
->
pImgOrg
[
uv
 + 1][
cuºMB
->
›ix_c_y
 ], 
cuºSli˚
->
mb_¥ed
[ uv + 1], cuºSli˚->
mb_‹es
[uv + 1], 0, cuºMB->
pix_c_x
,Ö_Vid->
mb_¸_size_x
,Ö_Vid->
mb_¸_size_y
);

1496 
chroma_cbp
 = 
cuºMB
->
ªsiduÆ_å™sf‹m_qu™t_chroma_4x4
[
uv
] (currMB, uv, chroma_cbp);

1501 
cuºMB
->
cbp
 +((
chroma_cbp
) << 4);

1502 
	}
}

1510 
	$chroma_ªsiduÆ_codög_si
 (
Ma¸oblock
 *
cuºMB
)

1512 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1513 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

1514 
chroma_cbp
 = 0;

1515 
uv
, 
block_y
, 
block_x
;

1516 
li°_mode
[2];

1517 
li°_ªf_idx
[2];

1518 
p_dú
;

1519 
yuv
 = 
p_Vid
->
yuv_f‹m©
 - 1;

1521 
uv
 = 0; uv < 2; ++uv)

1524 
block_y
=0; block_y < 
p_Vid
->
mb_¸_size_y
; block_y+=4)

1526 
block_x
=0; block_x < 
p_Vid
->
mb_¸_size_x
; block_x+=4)

1528 
block8
 = 
block8x8_idx
[
yuv
][
block_y
>>2][
block_x
>>2];

1529 
cuºSli˚
->
	`£t_modes_™d_ª‰ame
 (
cuºMB
, 
block8
, &
p_dú
, 
li°_mode
, 
li°_ªf_idx
);

1530 
	`I¡øChromaPªdi˘i⁄4x4
 (
cuºMB
, 
uv
 + 1, 
block_x
, 
block_y
);

1534 
	`compuã_ªsidue
(&
p_Vid
->
pImgOrg
[
uv
 + 1][
cuºMB
->
›ix_c_y
 ], 
cuºSli˚
->
mb_¥ed
[ uv + 1], cuºSli˚->
mb_‹es
[uv + 1], 0, cuºMB->
pix_c_x
,Ö_Vid->
mb_¸_size_x
,Ö_Vid->
mb_¸_size_y
);

1537 i‡(
cuºMB
->
mb_ty≥
==
I16MB
 || cuºMB->mb_ty≥ =
I4MB
)

1539 
chroma_cbp
 = 
	`ªsiduÆ_å™sf‹m_qu™t_chroma_4x4
(
cuºMB
, 
uv
, chroma_cbp);

1543 
chroma_cbp
 = 
	`ªsiduÆ_å™sf‹m_qu™t_chroma_4x4_•2
(
cuºMB
, 
uv
, chroma_cbp);

1548 
cuºMB
->
cbp
 +((
chroma_cbp
) << 4);

1549 
	}
}

1558 
	$chroma_ªsiduÆ_codög_•
 (
Ma¸oblock
 *
cuºMB
)

1560 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1561 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

1562 
chroma_cbp
;

1563 
uv
, 
block_y
, 
block_x
, 
j
;

1564 
li°_mode
[2];

1565 
li°_ªf_idx
[2];

1566 
p_dú
;

1567 
skù≥d
 = (
cuºMB
->
mb_ty≥
 == 0);

1568 
yuv
 = 
p_Vid
->
yuv_f‹m©
 - 1;

1571 
chroma_cbp
 = 0, 
uv
=0; uv<2; ++uv)

1575 i‡(
cuºMB
->
mb_ty≥
 > 
P8x8
)

1577 
block_y
=0; block_y < 
p_Vid
->
mb_¸_size_y
; block_y +
BLOCK_SIZE
)

1579 
block_x
=0; block_x < 
p_Vid
->
mb_¸_size_x
; block_x +
BLOCK_SIZE
)

1581 
block8
 = 
block8x8_idx
[
yuv
][
block_y
>>2][
block_x
>>2];

1582 
cuºSli˚
->
	`£t_modes_™d_ª‰ame
 (
cuºMB
, 
block8
, &
p_dú
, 
li°_mode
, 
li°_ªf_idx
);

1583 
	`I¡øChromaPªdi˘i⁄4x4
 (
cuºMB
, 
uv
 + 1, 
block_x
, 
block_y
);

1589 
block_y
=0; block_y < 
p_Vid
->
mb_¸_size_y
; block_y +
BLOCK_SIZE
)

1591 
block_x
=0; block_x < 
p_Vid
->
mb_¸_size_x
; block_x +
BLOCK_SIZE
)

1593 
block8
 = 
block8x8_idx
[
yuv
][
block_y
>>2][
block_x
>>2];

1594 
bùªd_me
 = 
cuºMB
->
b8x8
[
block8
].
bùªd
;

1595 
cuºSli˚
->
	`£t_modes_™d_ª‰ame
 (
cuºMB
, 
block8
, &
p_dú
, 
li°_mode
, 
li°_ªf_idx
);

1597 
	`chroma_¥edi˘i⁄_4x4
 (
cuºMB
, 
uv
, 
block_x
, 
block_y
, 
p_dú
, 
li°_mode
[0],Üi°_mode[1], 
li°_ªf_idx
[0],Üi°_ªf_idx[1], 
bùªd_me
);

1603 i‡(
cuºSli˚
->
NoResidueDúe˘
)

1605 
	`c›y_image_d©a
(&
p_Vid
->
íc_pi˘uª
->
imgUV
[
uv
][
cuºMB
->
pix_c_y
], 
cuºSli˚
->
mb_¥ed
[ uv + 1], cuºMB->
pix_c_x
, 0,Ö_Vid->
mb_¸_size_x
,Ö_Vid->
mb_¸_size_y
);

1607 i‡(
skù≥d
)

1609 
j
=0; j<
p_Vid
->
mb_¸_size_y
; ++j)

1610 
	`mem£t
(
cuºSli˚
->
mb_‹es
[
uv
 + 1][
j
], 0 , 
p_Vid
->
mb_¸_size_x
 * ());

1611 
j
=0; j<
p_Vid
->
mb_¸_size_y
; ++j)

1612 
	`mem£t
(
cuºSli˚
->
mb_ºes
[
uv
 + 1][
j
], 0 , 
p_Vid
->
mb_¸_size_x
 * ());

1616 
	`compuã_ªsidue
(&
p_Vid
->
pImgOrg
[
uv
 + 1][
cuºMB
->
›ix_c_y
 ], &
cuºSli˚
->
mb_¥ed
[ uv + 1][0], &cuºSli˚->
mb_‹es
[uv + 1][0], 0, cuºMB->
pix_c_x
,Ö_Vid->
mb_¸_size_x
,Ö_Vid->
mb_¸_size_y
);

1622 i‡(
skù≥d
)

1624 if(
p_Vid
->
•2_‰ame_ödiˇt‹
)

1625 
chroma_cbp
 = 
	`ªsiduÆ_å™sf‹m_qu™t_chroma_4x4_•2
(
cuºMB
, 
uv
, chroma_cbp);

1627 
chroma_cbp
 = 
	`ªsiduÆ_å™sf‹m_qu™t_chroma_4x4_•
(
cuºMB
, 
uv
, chroma_cbp);

1631 i‡(!
cuºSli˚
->
NoResidueDúe˘
 && !
skù≥d
)

1633 i‡(
cuºMB
->
mb_ty≥
==
I16MB
 || cuºMB->mb_ty≥ =
I4MB
)

1635 
chroma_cbp
 = 
	`ªsiduÆ_å™sf‹m_qu™t_chroma_4x4
(
cuºMB
, 
uv
,chroma_cbp);

1639 if(
p_Vid
->
•2_‰ame_ödiˇt‹
)

1640 
chroma_cbp
 = 
	`ªsiduÆ_å™sf‹m_qu™t_chroma_4x4_•2
(
cuºMB
, 
uv
, chroma_cbp);

1642 
chroma_cbp
=
	`ªsiduÆ_å™sf‹m_qu™t_chroma_4x4_•
(
cuºMB
, 
uv
, chroma_cbp);

1649 
cuºMB
->
cbp
 +((
chroma_cbp
)<<4);

1650 
	}
}

1658 
	$ZîoRef
 (
Ma¸oblock
* 
cuºMB
)

1660 
PicMŸi⁄P¨ams
 **
mŸi⁄
 = 
cuºMB
->
p_Vid
->
íc_pi˘uª
->
mv_öfo
;

1661 
i
,
j
;

1663 
j
=
cuºMB
->
block_y
; j<cuºMB->block_y + 
BLOCK_MULTIPLE
; ++j)

1665 
i
=
cuºMB
->
block_x
; i<cuºMB->block_x + 
BLOCK_MULTIPLE
; ++i)

1667 i‡(
mŸi⁄
[
j
][
i
].
ªf_idx
[
LIST_0
] != 0)

1672 
	}
}

1681 
	$MBTy≥2VÆue
 (
Ma¸oblock
* 
cuºMB
)

1683 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1684 c⁄° 
dú1off£t
[3] = { 1, 2, 3};

1685 c⁄° 
dú2off£t
[3][3] = {{ 0, 4, 8},

1689 
si_¶i˚
 = (
cuºSli˚
->
¶i˚_ty≥
 =
SI_SLICE
) ? 1 : 0;

1691 i‡(
cuºSli˚
->
¶i˚_ty≥
 !
B_SLICE
)

1693  
cuºMB
->
mb_ty≥
 )

1695 
I8MB
:

1696 
I4MB
:

1697  ((
cuºSli˚
->
¶i˚_ty≥
 =
I_SLICE
 || 
si_¶i˚
) ? (0 + si_slice) : 6);

1699 
SI4MB
:

1702 
I16MB
:

1703  ((
cuºSli˚
->
¶i˚_ty≥
 =
I_SLICE
 || 
si_¶i˚
Ë? (0 + si_¶i˚Ë: 6Ë+ 
cuºMB
->
i16off£t
;

1705 
IPCM
:

1706  ((
cuºSli˚
->
¶i˚_ty≥
 =
I_SLICE
 || 
si_¶i˚
 ) ? (25 + si_slice) : 31);

1708 
P8x8
:

1710 i‡(
cuºSli˚
->
symbﬁ_mode
==
CAVLC
 && 
	`ZîoRef
 (
cuºMB
))

1717  
cuºMB
->
mb_ty≥
;

1723  
cuºMB
->
mb_ty≥
 )

1728 
I4MB
:

1729 
I8MB
:

1732 
I16MB
:

1733  23 + 
cuºMB
->
i16off£t
;

1735 
IPCM
:

1738 
P8x8
:

1743 
pdú0
 = 
cuºMB
->
b8x8
[0].
pdú
;

1744  
dú1off£t
[
pdú0
];

1749 
pdú0
 = 
cuºMB
->
b8x8
[0].
pdú
;

1750 
pdú1
 = 
cuºMB
->
b8x8
[3].
pdú
;

1752  4 + 
dú2off£t
[
pdú0
][
pdú1
];

1757 
pdú0
 = 
cuºMB
->
b8x8
[0].
pdú
;

1758 
pdú1
 = 
cuºMB
->
b8x8
[3].
pdú
;

1759  5 + 
dú2off£t
[
pdú0
][
pdú1
];

1764 
	}
}

1772 
	$wrôeI¡ø4x4Modes
(
Ma¸oblock
 *
cuºMB
)

1774 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1775 
i
;

1776 
Sy¡axEÀmít
 
£
;

1777 
BôCou¡î
 *
mbBôs
 = &
cuºMB
->
bôs
;

1778 c⁄° *
∑πM≠
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
∑πôi⁄_mode
];

1779 
D©aP¨tôi⁄
 *
d©aP¨t
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_INTRAPREDMODE
]]);

1781 
øã
 = 0;

1783 
cuºMB
->
I¡øChromaPªdModeFœg
 = 1;

1785 
i
 = 0; i < 16; ++i)

1787 
£
.
c⁄ãxt
 = 
i
;

1788 
£
.
vÆue1
 = 
cuºMB
->
öåa_¥ed_modes
[
i
];

1789 
£
.
vÆue2
 = 0;

1791 #i‡
TRACE


1792 i‡(
£
.
vÆue1
 < 0 )

1793 
	`¢¥ötf
(
£
.
åa˚°rög
, 
TRACESTRING_SIZE
, "I¡ø 4x4 modê =Öªdi˘ed (c⁄ãxt: %d)",£.
c⁄ãxt
);

1795 
	`¢¥ötf
(
£
.
åa˚°rög
, 
TRACESTRING_SIZE
, "I¡ø 4x4 modê = %3d (c⁄ãxt: %d)",£.
vÆue1
,£.
c⁄ãxt
);

1799 
£
.
ty≥
 = 
SE_INTRAPREDMODE
;

1802 
cuºSli˚
->
	`wrôeI¡øPªdMode
 (&
£
, 
d©aP¨t
);

1804 
øã
 +
£
.
Àn
;

1807 
mbBôs
->
mb_mode
 +
øã
;

1809  
øã
;

1810 
	}
}

1818 
	$wrôeI¡ø8x8Modes
(
Ma¸oblock
 *
cuºMB
)

1820 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1821 
block8x8
;

1822 
Sy¡axEÀmít
 
£
;

1823 
BôCou¡î
 *
mbBôs
 = &
cuºMB
->
bôs
;

1824 c⁄° *
∑πM≠
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
∑πôi⁄_mode
];

1825 
D©aP¨tôi⁄
 *
d©aP¨t
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_INTRAPREDMODE
]]);

1827 
øã
 = 0;

1829 
cuºMB
->
I¡øChromaPªdModeFœg
 = 1;

1831 
block8x8
 = 0; block8x8 < 16; block8x8 += 4)

1834 
£
.
c⁄ãxt
 = 
block8x8
;

1835 
£
.
vÆue1
 = 
cuºMB
->
öåa_¥ed_modes8x8
[
block8x8
];

1836 
£
.
vÆue2
 = 0;

1838 #i‡
TRACE


1839 i‡(
£
.
vÆue1
 < 0 )

1840 
	`¢¥ötf
(
£
.
åa˚°rög
, 
TRACESTRING_SIZE
, "I¡ø 8x8 modê =Öªdi˘ed (c⁄ãxt: %d)",£.
c⁄ãxt
);

1842 
	`¢¥ötf
(
£
.
åa˚°rög
, 
TRACESTRING_SIZE
, "I¡ø 8x8 modê = %3d (c⁄ãxt: %d)",£.
vÆue1
,£.
c⁄ãxt
);

1846 
£
.
ty≥
 = 
SE_INTRAPREDMODE
;

1849 
cuºSli˚
->
	`wrôeI¡øPªdMode
 (&
£
, 
d©aP¨t
);

1851 
øã
 +
£
.
Àn
;

1853 
mbBôs
->
mb_mode
 +
øã
;

1855  
øã
;

1856 
	}
}

1858 
	$wrôeI¡øModes
(
Ma¸oblock
 *
cuºMB
)

1860 
cuºMB
->
mb_ty≥
)

1862 
I4MB
:

1863  
	`wrôeI¡ø4x4Modes
(
cuºMB
);

1865 
I8MB
:

1866  
	`wrôeI¡ø8x8Modes
(
cuºMB
);

1872 
	}
}

1880 
	$B8Mode2VÆue
 (
Sli˚
 *
cuºSli˚
, 
b8mode
, 
b8pdú
)

1882 c⁄° 
b8°¨t
[8] = {0,0,0,0, 1, 4, 5, 10};

1883 c⁄° 
b8öc
 [8] = {0,0,0,0, 1, 2, 2, 1};

1885  (
cuºSli˚
->
¶i˚_ty≥
!=
B_SLICE
Ë? (
b8mode
 - 4Ë: 
b8°¨t
[b8mode] + 
b8öc
[b8mode] * 
b8pdú
;

1886 
	}
}

1888 
	$wrôeIPCMLuma
 (
Ma¸oblock
 *
cuºMB
, 
img≥l
 **
imgY
, 
Bô°ªam
 *
cuºSåóm
, 
Sy¡axEÀmít
 *
£
, *
bôCou¡
)

1890 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1891 
i
, 
j
;

1892 
bô_size
 = 
MB_BLOCK_SIZE
 * MB_BLOCK_SIZE * 
p_Vid
->
bôdïth_luma
;

1894 *
bôCou¡
 +
bô_size
;

1895 
£
->
Àn
 = 
p_Vid
->
bôdïth_luma
;

1896 
£
->
ty≥
 = 
SE_MBTYPE
;

1898 
j
 = 
cuºMB
->
pix_y
; j < cuºMB->pix_y + 
MB_BLOCK_SIZE
; ++j)

1900 
i
 = 
cuºMB
->
pix_x
; i < cuºMB->pix_x + 
MB_BLOCK_SIZE
; ++i)

1902 
£
->
bô∑âîn
 = 
	`imax
(
p_Vid
->
mö_IPCM_vÆue
, 
imgY
[
j
][
i
]);

1903 
£
->
vÆue1
 = se->
bô∑âîn
;

1904 #i‡
TRACE


1905 
	`¢¥ötf
(
£
->
åa˚°rög
, 
TRACESTRING_SIZE
, "pcm_ßm∂e_lum®(%d %dË%d", 
j
, 
i
, se->
bô∑âîn
);

1907 
	`wrôeSE_Fix
(
£
, 
cuºSåóm
);

1910  
bô_size
;

1911 
	}
}

1913 
	$wrôeIPCMChroma
 (
Ma¸oblock
 *
cuºMB
, 
img≥l
 **
imgUV
, 
Bô°ªam
 *
cuºSåóm
, 
Sy¡axEÀmít
 *
£
, *
bôCou¡
)

1915 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1916 
i
, 
j
;

1917 
bô_size
 = 
p_Vid
->
mb_¸_size_y
 *Ö_Vid->
mb_¸_size_x
 *Ö_Vid->
bôdïth_luma
;

1918 *
bôCou¡
 +
bô_size
;

1920 
£
->
Àn
 = 
p_Vid
->
bôdïth_chroma
;

1921 
£
->
ty≥
 = 
SE_MBTYPE
;

1923 
j
 = 
cuºMB
->
pix_c_y
; j < cuºMB->pix_c_y + 
p_Vid
->
mb_¸_size_y
; ++j)

1925 
i
 = 
cuºMB
->
pix_c_x
; i < cuºMB->pix_c_x + 
p_Vid
->
mb_¸_size_x
; ++i)

1927 
£
->
bô∑âîn
 = 
	`imax
(
p_Vid
->
mö_IPCM_vÆue
, 
imgUV
[
j
][
i
]);

1928 
£
->
vÆue1
 = se->
bô∑âîn
;

1929 #i‡
TRACE


1931 
	`¢¥ötf
(
£
->
åa˚°rög
, 
TRACESTRING_SIZE
, "pcm_ßm∂e_chrom®(%d %dË%d", 
j
, 
i
, se->
bô∑âîn
);

1933 
	`wrôeSE_Fix
(
£
, 
cuºSåóm
);

1936  
bô_size
;

1937 
	}
}

1939 
	$wrôeIPCMByãAlign
(
Bô°ªam
 *
cuºSåóm
, 
Sy¡axEÀmít
 *
£
, *
bôCou¡
)

1941 i‡(
cuºSåóm
->
bôs_to_go
 < 8)

1944 
£
->
ty≥
 = 
SE_MBTYPE
;

1945 
£
->
Àn
 = 
cuºSåóm
->
bôs_to_go
;

1946 *
bôCou¡
 +
£
->
Àn
;

1947 
£
->
bô∑âîn
 = 0;

1948 #i‡
TRACE


1949 
	`¢¥ötf
(
£
->
åa˚°rög
, 
TRACESTRING_SIZE
, "pcm_Æignmít_zîo_bô†%d", se->
Àn
);

1951 
	`wrôeSE_Fix
(
£
, 
cuºSåóm
);

1953  
£
->
Àn
;

1957 
	}
}

1965 
	$wrôeIPCMD©a
(
Ma¸oblock
 *
cuºMB
, 
D©aP¨tôi⁄
* 
d©aP¨t
)

1967 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1968 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1969 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

1970 
no_bôs
 = 0;

1971 
Sy¡axEÀmít
 
£
;

1972 
BôCou¡î
 *
mbBôs
 = &
cuºMB
->
bôs
;

1974 i‡(
cuºSli˚
->
symbﬁ_mode
 =
CABAC
)

1976 
Àn
;

1977 
EncodögEnvú⁄mítPå
 
ìp
 = &
d©aP¨t
->
ì_ˇbac
;

1978 
Àn
 = 
	`¨õnco_bôs_wrôãn
(
ìp
);

1979 
	`¨õnco_d⁄e_ícodög
(
cuºMB
, 
ìp
);

1980 
Àn
 = 
	`¨õnco_bôs_wrôãn
(
ìp
) -Üen;

1981 
no_bôs
 +
Àn
;

1983 
	`¨õnco_°¨t_ícodög
(
ìp
, 
d©aP¨t
->
bô°ªam
->
°ªamBuf„r
, &(d©aP¨t->bô°ªam->
byã_pos
));

1986 
	`wrôeIPCMByãAlign
(
d©aP¨t
->
bô°ªam
, &
£
, &(
cuºMB
->
bôs
.
mb_y_c€ff
));

1988 
no_bôs
 +
	`wrôeIPCMLuma
 (
cuºMB
, 
p_Vid
->
íc_pi˘uª
->
imgY
, 
d©aP¨t
->
bô°ªam
, &
£
, &
mbBôs
->
mb_y_c€ff
);

1990 i‡((
p_Vid
->
a˘ive_•s
->
chroma_f‹m©_idc
 !
YUV400
Ë&& (
p_I≈
->
£∑øã_cﬁour_∂™e_Êag
 == 0))

1992 
uv
;

1993 
uv
 = 0; uv < 2; ++uv )

1995 
no_bôs
 +
	`wrôeIPCMChroma
 (
cuºMB
, 
p_Vid
->
íc_pi˘uª
->
imgUV
[
uv
], 
d©aP¨t
->
bô°ªam
, &
£
, &
mbBôs
->
mb_uv_c€ff
);

1998  
no_bôs
;

1999 
	}
}

2013 
	$wrôe_b_¶i˚_MB_œyî
 (
Ma¸oblock
 *
cuºMB
, 
rd›t
, *
c€ff_øã
)

2015 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

2016 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

2017 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

2019 
i
;

2020 
mb_ƒ
 = 
cuºMB
->
mbAddrX
;

2021 
Ma¸oblock
 *
¥evMB
 = 
cuºMB
->
PªvMB
;

2022 
¥ev_mb_ƒ
 = (
NULL
 =
¥evMB
Ë? -1 :ÖªvMB->
mbAddrX
;

2024 
Sy¡axEÀmít
 
£
;

2025 
BôCou¡î
 *
mbBôs
 = &
cuºMB
->
bôs
;

2026 c⁄° * 
∑πM≠
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
∑πôi⁄_mode
];

2028 
D©aP¨tôi⁄
* 
d©aP¨t
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_MBTYPE
]]);

2029 
Bô°ªam
 *
cuºSåóm
;

2031 
no_bôs
 = 0;

2032 
skù
 = 
cuºMB
->
mb_ty≥
 ? 0 : !cuºMB->
cbp
;

2033 
¥evMbSkù≥d
 = 0;

2034 
WrôeFømeFõldMBInHódî
 = 0;

2036 i‡(
cuºSli˚
->
mb_aff_‰ame_Êag
)

2038 i‡((
mb_ƒ
 & 0x01) == 0)

2040 
WrôeFømeFõldMBInHódî
 = 1;

2042 
¥evMbSkù≥d
 = 0;

2046 i‡(
¥evMB
->
mb_ty≥
 ? 0: !¥evMB->
cbp
)

2048 
WrôeFømeFõldMBInHódî
 = 1;

2051 
¥evMbSkù≥d
 = 
p_Vid
->
mb_d©a
[
¥ev_mb_ƒ
].
skù_Êag
;

2054 
cuºMB
->
I¡øChromaPªdModeFœg
 = (Ë
	`is_öåa
(currMB);

2056 i‡(
cuºSli˚
->
symbﬁ_mode
 =
CABAC
)

2058 
mb_ty≥
 = 
	`MBTy≥2VÆue
 (
cuºMB
);

2059 i‡(
cuºSli˚
->
mb_aff_‰ame_Êag
 && ((
cuºMB
->
mbAddrX
 & 0x01Ë=0 || 
¥evMbSkù≥d
))

2061 
byã
 
mb_fõld_tmp
 = 
cuºMB
->
mb_fõld
;

2062 
cuºMB
->
mb_fõld
 = 
	`fõld_Êag_ö„ªn˚
(currMB);

2063 
	`CheckAvaûabûôyOfNeighb‹sCABAC
(
cuºMB
);

2064 
cuºMB
->
mb_fõld
 = 
mb_fõld_tmp
;

2068 
£
.
vÆue1
 = 
mb_ty≥
;

2069 
£
.
vÆue2
 = 
cuºMB
->
cbp
;

2070 
£
.
ty≥
 = 
SE_MBTYPE
;

2072 
	`TRACE_SE
 (
£
.
åa˚°rög
, "mb_skip_flag");

2073 
cuºSli˚
->
	`wrôeMB_Skù
(
cuºMB
, &
£
, 
d©aP¨t
);

2075 
no_bôs
 +
£
.
Àn
;

2077 
	`CheckAvaûabûôyOfNeighb‹sCABAC
(
cuºMB
);

2080 if(
cuºSli˚
->
mb_aff_‰ame_Êag
 && !
skù
)

2082 if(
WrôeFømeFõldMBInHódî
)

2084 
£
.
vÆue1
 = 
cuºMB
->
mb_fõld
;

2085 
£
.
vÆue2
 = 0;

2086 
£
.
ty≥
 = 
SE_MBTYPE
;

2088 
	`TRACE_SE
(
£
.
åa˚°rög
, "mb_field_decoding_flag");

2089 
cuºSli˚
->
	`wrôeFõldModeInfo
(
cuºMB
, &
£
, 
d©aP¨t
);

2091 
no_bôs
 +
£
.
Àn
;

2096 i‡(
cuºMB
->
mb_ty≥
 !0 || ((cuºMB->
cbp
 !0 || 
cuºSli˚
->
cmp_cbp
[1] !=0 || currSlice->cmp_cbp[2]!=0 )))

2098 
£
.
vÆue1
 = 
mb_ty≥
;

2099 
£
.
vÆue2
 = 0;

2100 
£
.
ty≥
 = 
SE_MBTYPE
;

2102 #i‡
TRACE


2103 
	`¢¥ötf
(
£
.
åa˚°rög
, 
TRACESTRING_SIZE
, "mb_ty≥ (B_SLICEË(%2d,%2dË%3d",
cuºMB
->
mb_x
, cuºMB->
mb_y
, cuºMB->
mb_ty≥
);

2105 
cuºSli˚
->
	`wrôeMB_ty≥Info
(
cuºMB
, &
£
, 
d©aP¨t
);

2107 
no_bôs
 +
£
.
Àn
;

2111 i‡(
cuºMB
->
mb_ty≥
 !0 || ((cuºMB->
cbp
 !0 || 
cuºSli˚
->
cmp_cbp
[1] != 0 || currSlice->cmp_cbp[2]!=0 )))

2114 
£
.
vÆue1
 = 
p_Vid
->
cod_cou¡î
;

2115 
£
.
vÆue2
 = 0;

2116 
£
.
ty≥
 = 
SE_MBTYPE
;

2118 
	`TRACE_SE
 (
£
.
åa˚°rög
, "mb_skip_run");

2119 
	`wrôeSE_UVLC
(&
£
, 
d©aP¨t
);

2121 
no_bôs
 +
£
.
Àn
;

2124 i‡–(
p_Vid
->
cod_cou¡î
Ë&& (
p_I≈
->
¶i˚_mode
 =
FIXED_RATE
Ë&& (!
rd›t
))

2126 
i
=0; i<
cuºSli˚
->
max_∑π_ƒ
; ++i)

2128 
cuºSåóm
 = 
cuºSli˚
->
∑πAº
[
i
].
bô°ªam
;

2129 
cuºSåóm
->
°‹ed_bôs_to_go
 = cuºSåóm->
bôs_to_go
;

2130 
cuºSåóm
->
°‹ed_byã_pos
 = cuºSåóm->
byã_pos
;

2131 
cuºSåóm
->
°‹ed_byã_buf
 = cuºSåóm->
byã_buf
;

2133 
p_Vid
->
p_Sèts
->
°‹ed_bô_¶i˚
 =Ö_Vid->p_Sèts->
bô_¶i˚
;

2137 
p_Vid
->
cod_cou¡î
 = 0;

2140 if(
cuºSli˚
->
mb_aff_‰ame_Êag
 && !
skù
)

2142 if(
WrôeFømeFõldMBInHódî
)

2144 
£
.
vÆue1
 = 
cuºMB
->
mb_fõld
;

2145 
£
.
ty≥
 = 
SE_MBTYPE
;

2147 
	`TRACE_SE
(
£
.
åa˚°rög
, "mb_field_decoding_flag");

2148 
	`wrôeSE_Fœg
 (&
£
, 
d©aP¨t
);

2150 
no_bôs
 +
£
.
Àn
;

2154 
£
.
vÆue1
 = 
	`MBTy≥2VÆue
 (
cuºMB
);

2156 
£
.
ty≥
 = 
SE_MBTYPE
;

2157 
£
.
vÆue2
 = 0;

2159 #i‡
TRACE


2160 
	`¢¥ötf
(
£
.
åa˚°rög
, 
TRACESTRING_SIZE
, "mb_ty≥ (B_SLICEË(%2d,%2dË%3d",
cuºMB
->
mb_x
, cuºMB->
mb_y
, cuºMB->
mb_ty≥
);

2163 
cuºSli˚
->
	`wrôeMB_ty≥Info
(
cuºMB
, &
£
, 
d©aP¨t
);

2165 
no_bôs
 +
£
.
Àn
;

2170 ++(
p_Vid
->
cod_cou¡î
);

2172 
cuºMB
->
skù_Êag
 = 1;

2174 
	`ª£t_mb_nz_c€ff
(
p_Vid
, 
cuºMB
->
mbAddrX
);

2176 if(
	`FmoGëNextMBNr
(
p_Vid
, 
cuºMB
->
mbAddrX
Ë=-1 &&Ö_Vid->
cod_cou¡î
 > 0)

2179 
£
.
vÆue1
 = 
p_Vid
->
cod_cou¡î
;

2180 
£
.
vÆue2
 = 0;

2181 
£
.
ty≥
 = 
SE_MBTYPE
;

2183 
	`TRACE_SE
(
£
.
åa˚°rög
, "mb_skip_run");

2184 
	`wrôeSE_UVLC
(&
£
, 
d©aP¨t
);

2186 
no_bôs
 +
£
.
Àn
;

2189 
p_Vid
->
cod_cou¡î
 = 0;

2192 
mbBôs
->
mb_mode
 = mbBôs->mb_modê+ (Ë
no_bôs
;;

2195 
cuºMB
->
NoMbP¨tLessTh™8x8Fœg
 = (cuºMB->
mb_ty≥
 =0 && !(
p_Vid
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
))? 
FALSE
 : 
TRUE
;

2197 i‡(
cuºMB
->
mb_ty≥
 =
IPCM
)

2199 
no_bôs
 +
	`wrôeIPCMD©a
(
cuºMB
, &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_LUM_DC_INTRA
]]));

2200  
no_bôs
;

2203 
d©aP¨t
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_MBTYPE
]]);

2206 i‡(
cuºMB
->
mb_ty≥
 =
P8x8
)

2208 
i
=0; i<4; ++i)

2210 
£
.
vÆue1
 = 
	`B8Mode2VÆue
 (
cuºSli˚
, 
cuºMB
->
b8x8
[
i
].
mode
, cuºMB->b8x8[i].
pdú
);

2211 
£
.
vÆue2
 = 0;

2212 
£
.
ty≥
 = 
SE_MBTYPE
;

2213 #i‡
TRACE


2214 
	`¢¥ötf
(
£
.
åa˚°rög
, 
TRACESTRING_SIZE
, "8x8 mode/pdú(%2dË%3d/%d", 
i
, 
cuºMB
->
b8x8
[i].
mode
, cuºMB->b8x8[i].
pdú
);

2216 
cuºSli˚
->
	`wrôeB8_ty≥Info
 (&
£
, 
d©aP¨t
);

2217 
mbBôs
->
mb_mode
 = mbBôs->mb_modê+ (Ë
£
.
Àn
;;

2218 
no_bôs
 +
£
.
Àn
;

2221 
cuºMB
->
NoMbP¨tLessTh™8x8Fœg
 &(
Boﬁón
Ë((cuºMB->
b8x8
[
i
].
mode
 =0 && 
p_Vid
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
)

2222 || (
cuºMB
->
b8x8
[
i
].
mode
 == 4));

2225 
no_bôs
 +
cuºSli˚
->
	`wrôeMŸi⁄Info2NAL
 (
cuºMB
);

2231 i‡((
cuºMB
->
mb_ty≥
 =
I8MB
 || cuºMB->mb_ty≥ =
I4MB
Ë&& 
p_I≈
->
Tønsf‹m8x8Mode
)

2233 
£
.
vÆue1
 = 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
;

2234 
£
.
ty≥
 = 
SE_MBTYPE
;

2236 #i‡
TRACE


2237 
	`¢¥ötf
(
£
.
åa˚°rög
, 
TRACESTRING_SIZE
, "å™sf‹m_size_8x8_Êag = %3d", 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
);

2239 
cuºSli˚
->
	`wrôeMB_å™sf‹m_size
(
cuºMB
, &
£
, 
d©aP¨t
);

2241 
mbBôs
->
mb_mode
 = mbBôs->mb_modê+ (Ë
£
.
Àn
;;

2242 
no_bôs
 +
£
.
Àn
;

2246 
no_bôs
 +
	`wrôeI¡øModes
(
cuºMB
);

2248 i‡(
cuºMB
->
I¡øChromaPªdModeFœg
 && ((
p_Vid
->
a˘ive_•s
->
chroma_f‹m©_idc
 !
YUV400
Ë&& (p_Vid->a˘ive_•s->chroma_f‹m©_id¯!
YUV444
)))

2249 
no_bôs
 +
	`wrôe_chroma_öåa_¥ed_mode
(
cuºMB
);

2250 if(!
rd›t
)

2252 
cuºMB
->
c_ùªd_mode
 = 
DC_PRED_8
;

2260 i‡(
cuºMB
->
mb_ty≥
 !=0 && cuºMB->mb_ty≥ !
P8x8
 && (!
	`is_öåa
(currMB)))

2262 
no_bôs
 +
cuºSli˚
->
	`wrôeMŸi⁄Info2NAL
 (
cuºMB
);

2265 i‡((
cuºMB
->
mb_ty≥
!=0Ë|| ((cuºMB->
cbp
!=0 || 
cuºSli˚
->
cmp_cbp
[1]!=0 || currSlice->cmp_cbp[2]!=0)))

2267 *
c€ff_øã
 = 
	`wrôe_CBP_™d_Dqu™t
 (
cuºMB
);

2268 *
c€ff_øã
 +
cuºSli˚
->
	`wrôeC€ff16x16
 (
cuºMB
, 
PLANE_Y
);

2270 i‡((
p_Vid
->
a˘ive_•s
->
chroma_f‹m©_idc
 !
YUV400
Ë&& ((
p_I≈
->
£∑øã_cﬁour_∂™e_Êag
 == 0)))

2272 if(
p_Vid
->
a˘ive_•s
->
chroma_f‹m©_idc
 =
YUV444
)

2274 *
c€ff_øã
 +
cuºSli˚
->
	`wrôeC€ff16x16
(
cuºMB
, 
PLANE_U
);

2275 *
c€ff_øã
 +
cuºSli˚
->
	`wrôeC€ff16x16
(
cuºMB
, 
PLANE_V
);

2278 *
c€ff_øã
 +
	`wrôe_chroma_c€ff
 (
cuºMB
);

2280 
no_bôs
 +*
c€ff_øã
;

2283  
no_bôs
;

2284 
	}
}

2298 
	$wrôe_p_¶i˚_MB_œyî
 (
Ma¸oblock
 *
cuºMB
, 
rd›t
, *
c€ff_øã
)

2300 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

2301 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

2302 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

2304 
i
;

2305 
mb_ƒ
 = 
cuºMB
->
mbAddrX
;

2306 
Ma¸oblock
 *
¥evMB
 = 
cuºMB
->
PªvMB
;

2307 
¥ev_mb_ƒ
 = (
NULL
 =
¥evMB
Ë? -1 :ÖªvMB->
mbAddrX
;

2309 
Sy¡axEÀmít
 
£
;

2310 
BôCou¡î
 *
mbBôs
 = &
cuºMB
->
bôs
;

2311 c⁄° * 
∑πM≠
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
∑πôi⁄_mode
];

2313 
D©aP¨tôi⁄
* 
d©aP¨t
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_MBTYPE
]]);

2314 
Bô°ªam
 *
cuºSåóm
;

2316 
no_bôs
 = 0;

2317 
skù
 = 
cuºMB
->
mb_ty≥
 ? 0 : 1;

2318 
¥evMbSkù≥d
 = 0;

2319 
WrôeFømeFõldMBInHódî
 = 0;

2321 i‡(
cuºSli˚
->
mb_aff_‰ame_Êag
)

2323 i‡((
mb_ƒ
 & 0x01) == 0)

2325 
WrôeFømeFõldMBInHódî
 = 1;

2327 
¥evMbSkù≥d
 = 0;

2331 i‡(
¥evMB
->
mb_ty≥
 ? 0 : 1)

2333 
WrôeFømeFõldMBInHódî
 = 1;

2336 
¥evMbSkù≥d
 = 
p_Vid
->
mb_d©a
[
¥ev_mb_ƒ
].
skù_Êag
;

2339 
cuºMB
->
I¡øChromaPªdModeFœg
 = (Ë
	`is_öåa
(currMB);

2341 i‡(
cuºSli˚
->
symbﬁ_mode
 =
CABAC
)

2343 
mb_ty≥
 = 
	`MBTy≥2VÆue
 (
cuºMB
);

2344 i‡(
cuºSli˚
->
mb_aff_‰ame_Êag
 && ((
cuºMB
->
mbAddrX
 & 0x01Ë=0 || 
¥evMbSkù≥d
))

2346 
byã
 
mb_fõld_tmp
 = 
cuºMB
->
mb_fõld
;

2347 
cuºMB
->
mb_fõld
 = 
	`fõld_Êag_ö„ªn˚
(currMB);

2348 
	`CheckAvaûabûôyOfNeighb‹sCABAC
(
cuºMB
);

2349 
cuºMB
->
mb_fõld
 = 
mb_fõld_tmp
;

2353 
£
.
vÆue1
 = 
mb_ty≥
;

2354 
£
.
vÆue2
 = 
cuºMB
->
cbp
;

2355 
£
.
ty≥
 = 
SE_MBTYPE
;

2357 
	`TRACE_SE
 (
£
.
åa˚°rög
, "mb_skip_flag");

2358 
cuºSli˚
->
	`wrôeMB_Skù
(
cuºMB
, &
£
, 
d©aP¨t
);

2360 
no_bôs
 +
£
.
Àn
;

2362 
	`CheckAvaûabûôyOfNeighb‹sCABAC
(
cuºMB
);

2365 if(
cuºSli˚
->
mb_aff_‰ame_Êag
 && !
skù
)

2367 if(
WrôeFømeFõldMBInHódî
)

2369 
£
.
vÆue1
 = 
cuºMB
->
mb_fõld
;

2370 
£
.
vÆue2
 = 0;

2371 
£
.
ty≥
 = 
SE_MBTYPE
;

2373 
	`TRACE_SE
(
£
.
åa˚°rög
, "mb_field_decoding_flag");

2374 
cuºSli˚
->
	`wrôeFõldModeInfo
(
cuºMB
, &
£
, 
d©aP¨t
);

2376 
no_bôs
 +
£
.
Àn
;

2381 i‡(
cuºMB
->
mb_ty≥
 != 0)

2383 
£
.
vÆue1
 = 
mb_ty≥
;

2384 
£
.
vÆue2
 = 0;

2385 
£
.
ty≥
 = 
SE_MBTYPE
;

2387 #i‡
TRACE


2388 
	`¢¥ötf
(
£
.
åa˚°rög
, 
TRACESTRING_SIZE
, "mb_ty≥ (P_SLICEË(%2d,%2dË%3d",
cuºMB
->
mb_x
, cuºMB->
mb_y
, cuºMB->
mb_ty≥
);

2390 
cuºSli˚
->
	`wrôeMB_ty≥Info
(
cuºMB
, &
£
, 
d©aP¨t
);

2392 
no_bôs
 +
£
.
Àn
;

2396 i‡(
cuºMB
->
mb_ty≥
 != 0)

2399 
£
.
vÆue1
 = 
p_Vid
->
cod_cou¡î
;

2400 
£
.
vÆue2
 = 0;

2401 
£
.
ty≥
 = 
SE_MBTYPE
;

2403 
	`TRACE_SE
 (
£
.
åa˚°rög
, "mb_skip_run");

2404 
	`wrôeSE_UVLC
(&
£
, 
d©aP¨t
);

2406 
no_bôs
 +
£
.
Àn
;

2409 i‡–(
p_Vid
->
cod_cou¡î
Ë&& (
p_I≈
->
¶i˚_mode
 =
FIXED_RATE
Ë&& (!
rd›t
))

2411 
i
=0; i<
cuºSli˚
->
max_∑π_ƒ
; ++i)

2413 
cuºSåóm
 = 
cuºSli˚
->
∑πAº
[
i
].
bô°ªam
;

2414 
cuºSåóm
->
°‹ed_bôs_to_go
 = cuºSåóm->
bôs_to_go
;

2415 
cuºSåóm
->
°‹ed_byã_pos
 = cuºSåóm->
byã_pos
;

2416 
cuºSåóm
->
°‹ed_byã_buf
 = cuºSåóm->
byã_buf
;

2417 
p_Vid
->
p_Sèts
->
°‹ed_bô_¶i˚
 =Ö_Vid->p_Sèts->
bô_¶i˚
;

2421 
p_Vid
->
cod_cou¡î
 = 0;

2424 if(
cuºSli˚
->
mb_aff_‰ame_Êag
 && !
skù
)

2426 if(
WrôeFømeFõldMBInHódî
)

2428 
£
.
vÆue1
 = 
cuºMB
->
mb_fõld
;

2429 
£
.
ty≥
 = 
SE_MBTYPE
;

2431 
	`TRACE_SE
(
£
.
åa˚°rög
, "mb_field_decoding_flag");

2432 
	`wrôeSE_Fœg
 (&
£
, 
d©aP¨t
);

2434 
no_bôs
 +
£
.
Àn
;

2438 
£
.
vÆue1
 = 
	`MBTy≥2VÆue
 (
cuºMB
);

2439 
£
.
vÆue1
--;

2441 
£
.
ty≥
 = 
SE_MBTYPE
;

2442 
£
.
vÆue2
 = 0;

2444 #i‡
TRACE


2445 
	`¢¥ötf
(
£
.
åa˚°rög
, 
TRACESTRING_SIZE
, "mb_ty≥ (P_SLICEË(%2d,%2dË%3d",
cuºMB
->
mb_x
, cuºMB->
mb_y
, cuºMB->
mb_ty≥
);

2448 
cuºSli˚
->
	`wrôeMB_ty≥Info
(
cuºMB
, &
£
, 
d©aP¨t
);

2450 
no_bôs
 +
£
.
Àn
;

2455 ++(
p_Vid
->
cod_cou¡î
);

2457 
cuºMB
->
skù_Êag
 = 1;

2459 
	`ª£t_mb_nz_c€ff
(
p_Vid
, 
cuºMB
->
mbAddrX
);

2461 if(
	`FmoGëNextMBNr
(
p_Vid
, 
cuºMB
->
mbAddrX
Ë=-1 &&Ö_Vid->
cod_cou¡î
 > 0)

2464 
£
.
vÆue1
 = 
p_Vid
->
cod_cou¡î
;

2465 
£
.
vÆue2
 = 0;

2466 
£
.
ty≥
 = 
SE_MBTYPE
;

2468 
	`TRACE_SE
(
£
.
åa˚°rög
, "mb_skip_run");

2469 
	`wrôeSE_UVLC
(&
£
, 
d©aP¨t
);

2471 
no_bôs
 +
£
.
Àn
;

2474 
p_Vid
->
cod_cou¡î
 = 0;

2477 
mbBôs
->
mb_mode
 = mbBôs->mb_modê+ (Ë
no_bôs
;;

2480 
cuºMB
->
NoMbP¨tLessTh™8x8Fœg
 = 
TRUE
;

2482 i‡(
cuºMB
->
mb_ty≥
 =
IPCM
)

2484 
no_bôs
 +
	`wrôeIPCMD©a
(
cuºMB
, &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_LUM_DC_INTRA
]]));

2485  
no_bôs
;

2488 
d©aP¨t
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_MBTYPE
]]);

2491 i‡(
cuºMB
->
mb_ty≥
 =
P8x8
)

2493 
i
=0; i<4; ++i)

2495 
£
.
vÆue1
 = 
	`B8Mode2VÆue
 (
cuºSli˚
, 
cuºMB
->
b8x8
[
i
].
mode
, cuºMB->b8x8[i].
pdú
);

2496 
£
.
vÆue2
 = 0;

2497 
£
.
ty≥
 = 
SE_MBTYPE
;

2498 #i‡
TRACE


2499 
	`¢¥ötf
(
£
.
åa˚°rög
, 
TRACESTRING_SIZE
, "8x8 mode/pdú(%2dË%3d/%d", 
i
, 
cuºMB
->
b8x8
[i].
mode
, cuºMB->b8x8[i].
pdú
);

2501 
cuºSli˚
->
	`wrôeB8_ty≥Info
 (&
£
, 
d©aP¨t
);

2502 
mbBôs
->
mb_mode
 = mbBôs->mb_modê+ (Ë
£
.
Àn
;;

2503 
no_bôs
 +
£
.
Àn
;

2506 
cuºMB
->
NoMbP¨tLessTh™8x8Fœg
 &(
Boﬁón
Ë((cuºMB->
b8x8
[
i
].
mode
 =0 && 
p_Vid
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
)

2507 || (
cuºMB
->
b8x8
[
i
].
mode
 ==4));

2510 
no_bôs
 +
cuºSli˚
->
	`wrôeMŸi⁄Info2NAL
 (
cuºMB
);

2516 i‡((
cuºMB
->
mb_ty≥
 =
I8MB
 || cuºMB->mb_ty≥ =
I4MB
Ë&& 
p_I≈
->
Tønsf‹m8x8Mode
)

2518 
£
.
vÆue1
 = 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
;

2519 
£
.
ty≥
 = 
SE_MBTYPE
;

2521 #i‡
TRACE


2522 
	`¢¥ötf
(
£
.
åa˚°rög
, 
TRACESTRING_SIZE
, "å™sf‹m_size_8x8_Êag = %3d", 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
);

2524 
cuºSli˚
->
	`wrôeMB_å™sf‹m_size
(
cuºMB
, &
£
, 
d©aP¨t
);

2526 
mbBôs
->
mb_mode
 = mbBôs->mb_modê+ (Ë
£
.
Àn
;;

2527 
no_bôs
 +
£
.
Àn
;

2531 
no_bôs
 +
	`wrôeI¡øModes
(
cuºMB
);

2533 i‡(
cuºMB
->
I¡øChromaPªdModeFœg
 && ((
p_Vid
->
a˘ive_•s
->
chroma_f‹m©_idc
 !
YUV400
Ë&& (p_Vid->a˘ive_•s->chroma_f‹m©_id¯!
YUV444
)))

2534 
no_bôs
 +
	`wrôe_chroma_öåa_¥ed_mode
(
cuºMB
);

2535 if(!
rd›t
)

2537 
cuºMB
->
c_ùªd_mode
 = 
DC_PRED_8
;

2545 i‡(
cuºMB
->
mb_ty≥
 !=0 && cuºMB->mb_ty≥ !
P8x8
 && (!
	`is_öåa
(currMB)))

2547 
no_bôs
 +
cuºSli˚
->
	`wrôeMŸi⁄Info2NAL
 (
cuºMB
);

2550 i‡(
cuºMB
->
mb_ty≥
!=0)

2552 *
c€ff_øã
 = 
	`wrôe_CBP_™d_Dqu™t
 (
cuºMB
);

2553 *
c€ff_øã
 +
cuºSli˚
->
	`wrôeC€ff16x16
 (
cuºMB
, 
PLANE_Y
);

2555 i‡((
p_Vid
->
a˘ive_•s
->
chroma_f‹m©_idc
 !
YUV400
Ë&& ((
p_I≈
->
£∑øã_cﬁour_∂™e_Êag
 == 0)))

2557 if(
p_Vid
->
a˘ive_•s
->
chroma_f‹m©_idc
 =
YUV444
)

2559 *
c€ff_øã
 +
cuºSli˚
->
	`wrôeC€ff16x16
(
cuºMB
, 
PLANE_U
);

2560 *
c€ff_øã
 +
cuºSli˚
->
	`wrôeC€ff16x16
(
cuºMB
, 
PLANE_V
);

2563 *
c€ff_øã
 +
	`wrôe_chroma_c€ff
 (
cuºMB
);

2565 
no_bôs
 +*
c€ff_øã
;

2568  
no_bôs
;

2569 
	}
}

2572 
	$wrôe_i_¶i˚_MB_œyî
 (
Ma¸oblock
 *
cuºMB
, 
rd›t
, *
c€ff_øã
)

2574 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

2575 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

2576 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

2578 
mb_ƒ
 = 
cuºMB
->
mbAddrX
;

2579 
Ma¸oblock
 *
¥evMB
 = 
cuºMB
->
PªvMB
;

2581 
Sy¡axEÀmít
 
£
;

2582 
BôCou¡î
 *
mbBôs
 = &
cuºMB
->
bôs
;

2583 c⁄° * 
∑πM≠
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
∑πôi⁄_mode
];

2585 
D©aP¨tôi⁄
* 
d©aP¨t
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_MBTYPE
]]);

2587 
no_bôs
 = 0;

2588 
WrôeFømeFõldMBInHódî
 = 0;

2590 i‡(
cuºSli˚
->
mb_aff_‰ame_Êag
)

2592 i‡((
mb_ƒ
 & 0x01) == 0)

2594 
WrôeFømeFõldMBInHódî
 = 1;

2598 i‡(
¥evMB
->
mb_ty≥
 ? 0: 1)

2600 
WrôeFømeFõldMBInHódî
 = 1;

2605 if(
WrôeFømeFõldMBInHódî
)

2607 
£
.
vÆue1
 = 
cuºMB
->
mb_fõld
;

2608 
£
.
vÆue2
 = 0;

2609 
£
.
ty≥
 = 
SE_MBTYPE
;

2611 
	`TRACE_SE
 (
£
.
åa˚°rög
, "mb_field_decoding_flag");

2612 
cuºSli˚
->
	`wrôeFõldModeInfo
(
cuºMB
, &
£
, 
d©aP¨t
);

2614 
no_bôs
 +
£
.
Àn
;

2617 
cuºMB
->
I¡øChromaPªdModeFœg
 = (Ë
	`is_öåa
(currMB);

2621 
£
.
vÆue1
 = 
	`MBTy≥2VÆue
 (
cuºMB
);

2622 
£
.
vÆue2
 = 0;

2623 
£
.
ty≥
 = 
SE_MBTYPE
;

2625 #i‡
TRACE


2626 
	`¢¥ötf
(
£
.
åa˚°rög
, 
TRACESTRING_SIZE
, "mb_ty≥ (I_SLICEË(%2d,%2dË%3d",
cuºMB
->
mb_x
, cuºMB->
mb_y
, cuºMB->
mb_ty≥
);

2629 
cuºSli˚
->
	`wrôeMB_ty≥Info
 (
cuºMB
, &
£
, 
d©aP¨t
);

2631 
no_bôs
 +
£
.
Àn
;

2633 
mbBôs
->
mb_mode
 = mbBôs->mb_modê+ (Ë
no_bôs
;

2636 
cuºMB
->
NoMbP¨tLessTh™8x8Fœg
 = 
TRUE
;

2638 i‡(
cuºMB
->
mb_ty≥
 =
IPCM
)

2640 
no_bôs
 +
	`wrôeIPCMD©a
(
cuºMB
, &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_LUM_DC_INTRA
]]));

2641  
no_bôs
;

2644 
d©aP¨t
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_MBTYPE
]]);

2649 i‡((
cuºMB
->
mb_ty≥
 =
I8MB
 || cuºMB->mb_ty≥ =
I4MB
Ë&& 
p_I≈
->
Tønsf‹m8x8Mode
)

2651 
£
.
vÆue1
 = 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
;

2652 
£
.
ty≥
 = 
SE_MBTYPE
;

2654 #i‡
TRACE


2655 
	`¢¥ötf
(
£
.
åa˚°rög
, 
TRACESTRING_SIZE
, "å™sf‹m_size_8x8_Êag = %3d", 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
);

2657 
cuºSli˚
->
	`wrôeMB_å™sf‹m_size
(
cuºMB
, &
£
, 
d©aP¨t
);

2659 
mbBôs
->
mb_mode
 = mbBôs->mb_modê+ (Ë
£
.
Àn
;;

2660 
no_bôs
 +
£
.
Àn
;

2664 
no_bôs
 +
	`wrôeI¡øModes
(
cuºMB
);

2666 i‡(
cuºMB
->
I¡øChromaPªdModeFœg
 && ((
p_Vid
->
a˘ive_•s
->
chroma_f‹m©_idc
 !
YUV400
Ë&& (p_Vid->a˘ive_•s->chroma_f‹m©_id¯!
YUV444
)))

2667 
no_bôs
 +
	`wrôe_chroma_öåa_¥ed_mode
(
cuºMB
);

2668 if(!
rd›t
)

2670 
cuºMB
->
c_ùªd_mode
 = 
DC_PRED_8
;

2677 *
c€ff_øã
 = 
	`wrôe_CBP_™d_Dqu™t
 (
cuºMB
);

2678 *
c€ff_øã
 +
cuºSli˚
->
	`wrôeC€ff16x16
 (
cuºMB
, 
PLANE_Y
);

2680 i‡((
p_Vid
->
a˘ive_•s
->
chroma_f‹m©_idc
 !
YUV400
Ë&& ((
p_I≈
->
£∑øã_cﬁour_∂™e_Êag
 == 0)))

2682 if(
p_Vid
->
a˘ive_•s
->
chroma_f‹m©_idc
 =
YUV444
)

2684 *
c€ff_øã
 +
cuºSli˚
->
	`wrôeC€ff16x16
(
cuºMB
, 
PLANE_U
);

2685 *
c€ff_øã
 +
cuºSli˚
->
	`wrôeC€ff16x16
(
cuºMB
, 
PLANE_V
);

2688 *
c€ff_øã
 +
	`wrôe_chroma_c€ff
 (
cuºMB
);

2691 
no_bôs
 +*
c€ff_øã
;

2693  
no_bôs
;

2694 
	}
}

2696 
	$wrôe_ãrmö©ög_bô
 (
Sli˚
 *
cuºSli˚
, 
bô
)

2698 c⁄° * 
∑πM≠
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
∑πôi⁄_mode
];

2700 
D©aP¨tôi⁄
* 
d©aP¨t
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_MBTYPE
]]);

2701 
d©aP¨t
->
bô°ªam
->
wrôe_Êag
 = 1;

2703 
	`büri_ícode_symbﬁ_föÆ
(&(
d©aP¨t
->
ì_ˇbac
), 
bô
);

2704 #i‡
TRACE


2705 
	`Ârötf
 (
p_Enc
->
p_åa˚
, " CABACÅîmö©ög bô = %d\n",
bô
);

2707 
	}
}

2716 
	$wrôe_chroma_öåa_¥ed_mode
(
Ma¸oblock
* 
cuºMB
)

2718 
Sli˚
* 
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

2719 
Sy¡axEÀmít
 
£
;

2720 c⁄° * 
∑πM≠
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
∑πôi⁄_mode
];

2721 
D©aP¨tôi⁄
* 
d©aP¨t
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_INTRAPREDMODE
]]);

2722 
øã
 = 0;

2727 
£
.
vÆue1
 = 
cuºMB
->
c_ùªd_mode
;

2728 
£
.
vÆue2
 = 0;

2729 
£
.
ty≥
 = 
SE_INTRAPREDMODE
;

2731 
	`TRACE_SE
(
£
.
åa˚°rög
, "intra_chroma_pred_mode");

2732 
cuºSli˚
->
	`wrôeCIPªdMode
(
cuºMB
, &
£
, 
d©aP¨t
);

2734 
cuºMB
->
bôs
.
mb_uv_c€ff
 +
£
.
Àn
;

2735 
øã
 +
£
.
Àn
;

2737  
øã
;

2738 
	}
}

2741 #i‡(
MVC_EXTENSION_ENABLE
)

2742 
	$is_öãrvõw_mb
(
Ma¸oblock
 *
cuºMB
)

2744 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

2745 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

2746 
°‹abÀ_pi˘uª
 **
pLi°
 = 
cuºSli˚
->
li°X
[0];

2747 
i
,
j
, 
iRefIdx
=-1, 
k
;

2748 
öãrvõw_ö_l0
 = 1;

2749 
°ï_h0
 = (
block_size
[(
cuºMB
->
mb_ty≥
 =
P8x8
) ? 4 : currMB->mb_type][0] >> 2);

2750 
°ï_v0
 = (
block_size
[(
cuºMB
->
mb_ty≥
 =
P8x8
) ? 4 : currMB->mb_type][1] >> 2);

2751 
PicMŸi⁄P¨ams
 **
mŸi⁄
 = 
p_Vid
->
íc_pi˘uª
->
mv_öfo
;

2753 
i
=0; i<
cuºSli˚
->
li°Xsize
[
LIST_0
]; i++)

2755 if(
pLi°
[
i
]->
võw_id
==0)

2757 
iRefIdx
 = 
i
;

2761 if(
iRefIdx
 =-1 && 
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
)

2763 
öãrvõw_ö_l0
 = 0;

2764 
pLi°
 = 
cuºSli˚
->
li°X
[
LIST_1
];

2765 
i
=0; i<
cuºSli˚
->
li°Xsize
[
LIST_1
]; i++)

2767 if(
pLi°
[
i
]->
võw_id
==0)

2769 
iRefIdx
 = 
i
;

2775 if(
iRefIdx
<0)

2779 if(
cuºMB
->
mb_ty≥
 =
PSKIP
 && 
cuºSli˚
->
¶i˚_ty≥
==
P_SLICE
)

2781  (
iRefIdx
==0);

2783 
j
=0; j<4; j+=
°ï_v0
)

2785 
i
=0; i<4; i +=
°ï_h0
)

2787 
k
 = 
j
 + (
i
 >> 1);

2788 i‡(
öãrvõw_ö_l0
 && (
cuºMB
->
b8x8
[
k
].
pdú
 == 0 || currMB->b8x8[k].pdir == 2))

2790 if(
mŸi⁄
[
cuºMB
->
block_y
 + 
j
][cuºMB->
block_x
 + 
i
].
ªf_idx
[
LIST_0
] =
iRefIdx
)

2793 i‡(!
öãrvõw_ö_l0
 && (
cuºMB
->
b8x8
[
k
].
pdú
 == 1 || currMB->b8x8[k].pdir == 2))

2795 if(
mŸi⁄
[
cuºMB
->
block_y
 + 
j
][cuºMB->
block_x
 + 
i
].
ªf_idx
[
LIST_1
] =
iRefIdx
)

2802 
	}
}

2810 
	$wrôe_ma¸oblock
 (
Ma¸oblock
* 
cuºMB
, 
eos_bô
)

2812 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

2813 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

2814 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

2815 
BôCou¡î
 *
mbBôs
 = &
cuºMB
->
bôs
;

2816 
i
;

2819 #i‡
TRACE


2820 i‡–
cuºMB
->
¥ev_ªcode_mb
 =
FALSE
 )

2822 
i
=0; i<
cuºSli˚
->
max_∑π_ƒ
; ++i)

2824 
cuºSli˚
->
∑πAº
[
i
].
bô°ªam
->
åa˚_íabÀd
 = 
TRUE
;

2830 if(
p_I≈
->
U£C⁄°øöedI¡øPªd
 && (
cuºSli˚
->
¶i˚_ty≥
==
P_SLICE
 || cuºSli˚->¶i˚_ty≥==
B_SLICE
))

2832 
p_Vid
->
öåa_block
[
cuºMB
->
mbAddrX
] = 
	`is_öåa
(currMB);

2836 i‡(
cuºMB
->
mbAddrX
 == 0)

2838 
p_Vid
->
öåas
 = 0;

2839 
p_Vid
->
iI¡îVõwMBs
 =0;

2842 i‡(
	`is_öåa
(
cuºMB
))

2843 ++
p_Vid
->
öåas
;

2844 #i‡(
MVC_EXTENSION_ENABLE
)

2845 if(
p_Vid
->
num_of_œyîs
==2 &&Ö_Vid->
dpb_œyî_id
==1)

2847 
is_öãrvõw
 = 
	`is_öãrvõw_mb
(
cuºMB
);

2849 if(
is_öãrvõw
)

2850 
p_Vid
->
iI¡îVõwMBs
++;

2855 i‡(
cuºSli˚
->
symbﬁ_mode
==
CABAC
 && 
cuºMB
->
mbAddrX
 !cuºSli˚->
°¨t_mb_ƒ
 && 
eos_bô
)

2857 
	`wrôe_ãrmö©ög_bô
 (
cuºSli˚
, 0);

2860 #i‡
TRACE


2862 i‡(
p_Enc
->
p_åa˚
)

2864 
	`Ârötf
(
p_Enc
->
p_åa˚
, "\n*********** Pic: %ò(I/PËMB: %òSli˚: %ò**********\n\n", 
p_Vid
->
‰ame_no
, 
cuºMB
->
mbAddrX
, 
cuºSli˚
->
¶i˚_ƒ
);

2868 
p_Vid
->
ˇbac_ícodög
 = 1;

2870 
cuºMB
->
wrôe_mb
 = 
TRUE
;

2872 
cuºSli˚
->
	`wrôe_MB_œyî
 (
cuºMB
, 0, &
i
);

2874 i‡(!((
cuºMB
->
mb_ty≥
 !=0 ) || ((
cuºSli˚
->
¶i˚_ty≥
==
B_SLICE
Ë&& cuºMB->
cbp
 != 0) ))

2876 
	`ª£t_mb_nz_c€ff
(
p_Vid
, 
cuºMB
->
mbAddrX
);

2880 
mbBôs
->
mb_tŸÆ
 = mbBôs->
mb_mode


2881 + 
mbBôs
->
mb_y_c€ff


2882 + 
mbBôs
->
mb_öãr


2883 + 
mbBôs
->
mb_cbp


2884 + 
mbBôs
->
mb_dñè_qu™t


2885 + 
mbBôs
->
mb_uv_c€ff


2886 + 
mbBôs
->
mb_cb_c€ff


2887 + 
mbBôs
->
mb_¸_c€ff
;

2889 i‡–
p_I≈
->
RCE«bÀ
 )

2890 
	`rc_upd©e_mb_°©s
(
cuºMB
);

2893 ++(
p_Vid
->
NumbîofCodedMa¸oBlocks
);

2895 
p_Vid
->
p_Sèts
->
bô_¶i˚
 +
mbBôs
->
mb_tŸÆ
;

2897 
p_Vid
->
ˇbac_ícodög
 = 0;

2898 
	}
}

2907 
	$wrôeRe„ªn˚Føme
 (
Ma¸oblock
* 
cuºMB
, 
i
, 
j
, 
li°_idx
, 
ªf
)

2909 
BôCou¡î
 *
mbBôs
 = &
cuºMB
->
bôs
;

2910 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

2911 c⁄° * 
∑πM≠
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
∑πôi⁄_mode
];

2912 
D©aP¨tôi⁄
* 
d©aP¨t
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_REFFRAME
]]);

2913 
li°
 = 
li°_idx
 + 
cuºMB
->
li°_off£t
;

2914 
Sy¡axEÀmít
 
£
;

2916 
£
.
vÆue1
 = 
ªf
;

2917 
£
.
ty≥
 = 
SE_REFFRAME
;

2918 
£
.
vÆue2
 = 
li°_idx
;

2920 
cuºMB
->
subblock_x
 = (Ë(
i
 << 2);

2921 
cuºMB
->
subblock_y
 = (Ë(
j
 << 2);

2923 #i‡
TRACE


2924 i‡(!
li°_idx
)

2925 
	`¢¥ötf
(
£
.
åa˚°rög
, 
TRACESTRING_SIZE
, "ªf_idx_l0 = %d", se.
vÆue1
);

2927 
	`¢¥ötf
(
£
.
åa˚°rög
, 
TRACESTRING_SIZE
, "ªf_idx_l1 = %d", se.
vÆue1
);

2930 
cuºSli˚
->
wrôeRefFøme
[
li°
](
cuºMB
, &
£
, 
d©aP¨t
);

2932 
mbBôs
->
mb_öãr
 = mbBôs->mb_öã∏+ (Ë
£
.
Àn
;

2934  (
£
.
Àn
);

2935 
	}
}

2944 
	$wrôeMŸi⁄Ve˘‹8x8
 (
Ma¸oblock
 *
cuºMB
,

2945 
i0
,

2946 
j0
,

2947 
i1
,

2948 
j1
,

2949 
ªf‰ame
,

2950 
li°_idx
,

2951 
mv_mode
,

2952 
bùªd_me


2955 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

2956 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

2958 
PixñPos
 
block
[4];

2959 
i
, 
j
, 
k
, 
l
, 
m
;

2960 
cuº_mvd
;

2962 
øã
 = 0;

2963 
°ï_h
 = 
∑π_size
[
mv_mode
][0];

2964 
°ï_v
 = 
∑π_size
[
mv_mode
][1];

2965 
Sy¡axEÀmít
 
£
;

2966 
BôCou¡î
 *
mbBôs
 = &
cuºMB
->
bôs
;

2968 c⁄° * 
∑πM≠
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
∑πôi⁄_mode
];

2969 
D©aP¨tôi⁄
* 
d©aP¨t
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_MVD
]]);

2970 
ªfödex
 = 
ªf‰ame
;

2972 
MŸi⁄Ve˘‹
 **
Æl_mv
 = 
cuºSli˚
->Æl_mv[
li°_idx
][
ªfödex
][
mv_mode
];

2973 
MŸi⁄Ve˘‹
 *
cur_mv
;

2974 
MŸi⁄Ve˘‹
 
¥edMV
;

2975 
PicMŸi⁄P¨ams
 **
mŸi⁄
 = 
p_Vid
->
íc_pi˘uª
->
mv_öfo
;

2977 
mvd
[2];

2978 (*
cuºMB_mvd
)[4][2] = 
cuºMB
->
mvd
[
li°_idx
];

2979 
£
.
ty≥
 = 
SE_MVD
;

2981 i‡(
bùªd_me
 && 
	`is_bùªd_íabÀd
(
p_Vid
, 
mv_mode
Ë&& 
ªfödex
 == 0)

2982 
Æl_mv
 = 
cuºSli˚
->
bùªd_mv
[
bùªd_me
 - 1][
li°_idx
][
ªfödex
][
mv_mode
];

2984 
j
 = 
j0
; j < 
j1
; j +
°ï_v
)

2986 
cuºMB
->
subblock_y
 = (Ë(
j
 << 2);

2987 
i
 = 
i0
; i < 
i1
; i +
°ï_h
)

2989 
cuºMB
->
subblock_x
 = (Ë(
i
 << 2);

2991 i‡(
cuºMB
->
wrôe_mb
)

2992 
cur_mv
 = &
mŸi⁄
[
cuºMB
->
block_y
 + 
j
][cuºMB->
block_x
 + 
i
].
mv
[
li°_idx
];

2994 
cur_mv
 = &
Æl_mv
[
j
][
i
];

2997 
	`gë_√ighb‹s
(
cuºMB
, 
block
, 
i
<<2, 
j
<<2, 
°ï_h
<<2);

2998 
cuºMB
->
	`GëMVPªdi˘‹
 (cuºMB, 
block
, &
¥edMV
, (Ë
ªfödex
, 
p_Vid
->
íc_pi˘uª
->
mv_öfo
, 
li°_idx
, (
i
<<2), (
j
<<2), 
°ï_h
<<2, 
°ï_v
<<2);

3000 
mvd
[0] = 
cur_mv
->
mv_x
 - 
¥edMV
.mv_x;

3001 
mvd
[1] = 
cur_mv
->
mv_y
 - 
¥edMV
.mv_y;

3003 
k
=0; k<2; ++k)

3005 
cuº_mvd
 = 
mvd
[
k
];

3008 
l
 = 
j
;Ü < j + 
°ï_v
; ++l)

3010 
m
 = 
i
; m < i + 
°ï_h
; ++m)

3012 
cuºMB_mvd
[
l
][
m
][
k
] = (Ë
cuº_mvd
;

3016 
£
.
vÆue1
 = 
cuº_mvd
;

3017 
£
.
vÆue2
 = (
k
 << 1Ë+ 
li°_idx
;

3018 #i‡
TRACE


3019 i‡(
k
 == 0)

3020 
	`¢¥ötf
(
£
.
åa˚°rög
, 
TRACESTRING_SIZE
, "mvd_l%d (%dË%3d (‹g_mv %3dÖªd_mv %3d)",
li°_idx
, 
k
, 
cuº_mvd
, 
cur_mv
->
mv_x
, 
¥edMV
.mv_x);

3022 
	`¢¥ötf
(
£
.
åa˚°rög
, 
TRACESTRING_SIZE
, "mvd_l%d (%dË%3d (‹g_mv %3dÖªd_mv %3d)",
li°_idx
, 
k
, 
cuº_mvd
, 
cur_mv
->
mv_y
, 
¥edMV
.mv_y);

3024 
cuºSli˚
->
	`wrôeMVD
 (
cuºMB
, &
£
, 
d©aP¨t
);

3026 
øã
 +
£
.
Àn
;

3031 
mbBôs
->
mb_öãr
 = mbBôs->mb_öã∏+ (Ë
øã
;

3032  
øã
;

3033 
	}
}

3042 
	$wrôe_b_¶i˚_mŸi⁄_öfo_to_NAL
 (
Ma¸oblock
* 
cuºMB
)

3044 
no_bôs
 = 0;

3046 i‡(
cuºMB
->
mb_ty≥
 !
I4MB
 && cuºMB->mb_ty≥ !
I16MB
 && cuºMB->mb_ty≥ !
I8MB
 && currMB->mb_type != 0)

3048 
Sli˚
* 
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

3049 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

3050 
PicMŸi⁄P¨ams
 **
mŸi⁄
 = 
p_Vid
->
íc_pi˘uª
->
mv_öfo
;

3051 
k
, 
j0
, 
i0
;

3053 
°ï_h0
 = (
block_size
[(
cuºMB
->
mb_ty≥
 =
P8x8
) ? 4 : currMB->mb_type][0] >> 2);

3054 
°ï_v0
 = (
block_size
[(
cuºMB
->
mb_ty≥
 =
P8x8
) ? 4 : currMB->mb_type][1] >> 2);

3059 
j0
 = 0; j0 < 4; j0 +
°ï_v0
)

3061 
i0
 = 0; i0 < 4; i0 +
°ï_h0
)

3063 
k
 = 
j0
 + (
i0
 >> 1);

3064 i‡(
cuºMB
->
b8x8
[
k
].
mode
 !=0 && (cuºMB->b8x8[k].
pdú
 == 0 || currMB->b8x8[k].pdir == 2))

3066 
no_bôs
 +
	`wrôeRe„ªn˚Føme
 (
cuºMB
, 
i0
, 
j0
, 
LIST_0
, 
mŸi⁄
[cuºMB->
block_y
 + j0][cuºMB->
block_x
 + i0].
ªf_idx
[LIST_0]);

3074 
j0
 = 0; j0 < 4; j0 +
°ï_v0
)

3076 
i0
 = 0; i0 < 4; i0 +
°ï_h0
)

3078 
k
 = 
j0
 + (
i0
 >> 1);

3079 i‡(
cuºMB
->
b8x8
[
k
].
mode
 !=0 && (cuºMB->b8x8[k].
pdú
 == 1 || currMB->b8x8[k].pdir == 2))

3081 
no_bôs
 +
	`wrôeRe„ªn˚Føme
 (
cuºMB
, 
i0
, 
j0
, 
LIST_1
, 
mŸi⁄
[cuºMB->
block_y
 + j0][cuºMB->
block_x
 + i0].
ªf_idx
[LIST_1]);

3088 
j0
=0; j0<4; j0+=
°ï_v0
)

3090 
i0
=0; i0<4; i0+=
°ï_h0
)

3092 
k
 = 
j0
 + (
i0
 >> 1);

3093 i‡(
cuºMB
->
b8x8
[
k
].
mode
 !=0 && (cuºMB->b8x8[k].
pdú
 == 0 || currMB->b8x8[k].pdir == 2))

3096 
no_bôs
 +
	`wrôeMŸi⁄Ve˘‹8x8
 (
cuºMB
, 
i0
, 
j0
, i0 + 
°ï_h0
, j0 + 
°ï_v0
, 
mŸi⁄
[cuºMB->
block_y
 + j0][cuºMB->
block_x
 + i0].
ªf_idx
[
LIST_0
],

3097 
LIST_0
, 
cuºMB
->
b8x8
[
k
].
mode
, cuºMB->b8x8[k].
bùªd
);

3104 
j0
=0; j0<4; j0+=
°ï_v0
)

3106 
i0
 = 0; i0 < 4; i0 +
°ï_h0
)

3108 
k
=
j0
+(
i0
 >> 1);

3109 i‡(
cuºMB
->
b8x8
[
k
].
mode
 !=0 && (cuºMB->b8x8[k].
pdú
 == 1 || currMB->b8x8[k].pdir == 2))

3111 
no_bôs
 +
	`wrôeMŸi⁄Ve˘‹8x8
 (
cuºMB
, 
i0
, 
j0
, i0+
°ï_h0
, j0+
°ï_v0
, 
mŸi⁄
[cuºMB->
block_y
 + j0][cuºMB->
block_x
 + i0].
ªf_idx
[
LIST_1
],

3112 
LIST_1
, 
cuºMB
->
b8x8
[
k
].
mode
, cuºMB->b8x8[k].
bùªd
);

3118  
no_bôs
;

3119 
	}
}

3128 
	$wrôe_p_¶i˚_mŸi⁄_öfo_to_NAL
 (
Ma¸oblock
* 
cuºMB
)

3130 
no_bôs
 = 0;

3132 i‡(
cuºMB
->
mb_ty≥
 !
I4MB
 && cuºMB->mb_ty≥ !
I16MB
 && cuºMB->mb_ty≥ !
I8MB
 && currMB->mb_type != 0)

3134 
Sli˚
* 
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

3135 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

3136 
PicMŸi⁄P¨ams
 **
mŸi⁄
 = 
p_Vid
->
íc_pi˘uª
->
mv_öfo
;

3137 
k
, 
j0
, 
i0
;

3138 
°ï_h0
 = (
block_size
[(
cuºMB
->
mb_ty≥
 =
P8x8
) ? 4 : currMB->mb_type][0] >> 2);

3139 
°ï_v0
 = (
block_size
[(
cuºMB
->
mb_ty≥
 =
P8x8
) ? 4 : currMB->mb_type][1] >> 2);

3142 i‡((
cuºMB
->
mb_ty≥
 !
P8x8
Ë|| !
	`ZîoRef
 (cuºMBË|| 
cuºSli˚
->
symbﬁ_mode
==
CABAC
)

3144 
j0
 = 0; j0 < 4; j0 +
°ï_v0
)

3146 
i0
 = 0; i0 < 4; i0 +
°ï_h0
)

3148 
k
 = 
j0
 + (
i0
 >> 1);

3149 i‡(
cuºMB
->
b8x8
[
k
].
mode
 !=0 && (cuºMB->b8x8[k].
pdú
 == 0 || currMB->b8x8[k].pdir == 2))

3151 
no_bôs
 +
	`wrôeRe„ªn˚Føme
 (
cuºMB
, 
i0
, 
j0
, 
LIST_0
, 
mŸi⁄
[cuºMB->
block_y
 + j0][cuºMB->
block_x
 + i0].
ªf_idx
[LIST_0]);

3158 
j0
=0; j0<4; j0+=
°ï_v0
)

3160 
i0
=0; i0<4; i0+=
°ï_h0
)

3162 
k
 = 
j0
 + (
i0
 >> 1);

3163 i‡(
cuºMB
->
b8x8
[
k
].
mode
 !=0 && (cuºMB->b8x8[k].
pdú
 == 0 || currMB->b8x8[k].pdir == 2))

3165 
no_bôs
 +
	`wrôeMŸi⁄Ve˘‹8x8
 (
cuºMB
, 
i0
, 
j0
, i0 + 
°ï_h0
, j0 + 
°ï_v0
, 
mŸi⁄
[cuºMB->
block_y
 + j0][cuºMB->
block_x
 + i0].
ªf_idx
[
LIST_0
],

3166 
LIST_0
, 
cuºMB
->
b8x8
[
k
].
mode
, cuºMB->b8x8[k].
bùªd
);

3172  
no_bôs
;

3173 
	}
}

3182 
	$wrôe_chroma_c€ff
 (
Ma¸oblock
* 
cuºMB
)

3184 
Sli˚
* 
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

3185 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

3187 
øã
 = 0;

3188 
block_øã
 = 0;

3189 
Sy¡axEÀmít
 
£
;

3190 c⁄° * 
∑πM≠
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
∑πôi⁄_mode
];

3191 
cbp
 = 
cuºMB
->cbp;

3192 
D©aP¨tôi⁄
* 
d©aP¨t
;

3194 
Àvñ
;

3195 
k
, 
uv
;

3196 
b8
, 
b4
;

3197 * 
ACLevñ
;

3198 * 
ACRun
;

3199 * 
DCLevñ
;

3200 * 
DCRun
;

3202 c⁄° 
chroma_dc_c⁄ãxt
[3]=

3204 
CHROMA_DC
, 
CHROMA_DC_2x4
, 
CHROMA_DC_4x4


3207 c⁄° 
chroma_ac_∑øm
[3][8][4] =

3235 
yuv
 = 
p_Vid
->
yuv_f‹m©
 - 1;

3239 i‡(
cbp
 > 15)

3241 i‡(
cuºSli˚
->
symbﬁ_mode
 =
CAVLC
)

3243 
øã
 +
cuºSli˚
->
	`wrôeC€ff4x4_CAVLC
 (
cuºMB
, 
CHROMA_DC
, 0, 0, 0);

3244 
øã
 +
cuºSli˚
->
	`wrôeC€ff4x4_CAVLC
 (
cuºMB
, 
CHROMA_DC
, 0, 0, 1);

3248 
cuºMB
->
is_öåa_block
 = (
byã
Ë
	`is_öåa
(currMB);

3249 
£
.
ty≥
 = (
cuºMB
->
is_öåa_block
 ? 
SE_CHR_DC_INTRA
 : 
SE_CHR_DC_INTER
);

3251 
d©aP¨t
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
£
.
ty≥
]]);

3252 
£
.
c⁄ãxt
 = 
chroma_dc_c⁄ãxt
[
yuv
];

3254 
uv
=0; uv < 2; ++uv)

3256 
p_Vid
->
is_v_block
 = 
uv
;

3258 
DCLevñ
 = 
cuºSli˚
->
cofDC
[
uv
+1][0];

3259 
DCRun
 = 
cuºSli˚
->
cofDC
[
uv
+1][1];

3261 
Àvñ
 = 1;

3262 
k
=0; k <
p_Vid
->
num_cdc_c€ff
 && 
Àvñ
 != 0; ++k)

3264 
Àvñ
 = 
£
.
vÆue1
 = 
DCLevñ
[
k
];

3265 
£
.
vÆue2
 = 
DCRun
 [
k
];

3267 #i‡
TRACE


3268 
	`¢¥ötf
(
£
.
åa˚°rög
, 
TRACESTRING_SIZE
, "DC Chrom®%2d:Üevñ =%3dÑu¿=%2d",
k
, 
Àvñ
, se.
vÆue2
);

3270 
	`wrôeRunLevñ_CABAC
(
cuºMB
, &
£
, 
d©aP¨t
);

3272 
block_øã
 +
£
.
Àn
;

3275 
cuºMB
->
bôs
.
mb_uv_c€ff
 +
block_øã
;

3276 
øã
 +
block_øã
;

3283 
uv
=-1;

3284 i‡(
cbp
 >> 4 == 2)

3286 i‡(
cuºSli˚
->
symbﬁ_mode
 =
CAVLC
)

3288 
b8
=4; b8 < (4 + 
p_Vid
->
num_blk8x8_uv
); b8++)

3290 
øã
 +
cuºSli˚
->
	`wrôeC€ff4x4_CAVLC
 (
cuºMB
, 
CHROMA_AC
, 
b8
, 0, 
chroma_ac_∑øm
[
yuv
][b8 - 4][0]);

3291 
øã
 +
cuºSli˚
->
	`wrôeC€ff4x4_CAVLC
 (
cuºMB
, 
CHROMA_AC
, 
b8
, 1, 
chroma_ac_∑øm
[
yuv
][b8 - 4][1]);

3292 
øã
 +
cuºSli˚
->
	`wrôeC€ff4x4_CAVLC
 (
cuºMB
, 
CHROMA_AC
, 
b8
, 2, 
chroma_ac_∑øm
[
yuv
][b8 - 4][2]);

3293 
øã
 +
cuºSli˚
->
	`wrôeC€ff4x4_CAVLC
 (
cuºMB
, 
CHROMA_AC
, 
b8
, 3, 
chroma_ac_∑øm
[
yuv
][b8 - 4][3]);

3298 
block_øã
 = 0;

3299 
cuºMB
->
is_öåa_block
 = (
byã
Ë
	`is_öåa
(currMB);

3300 
£
.
c⁄ãxt
 = 
CHROMA_AC
;

3301 
£
.
ty≥
 = (
cuºMB
->
is_öåa_block
 ? 
SE_CHR_AC_INTRA
 : 
SE_CHR_AC_INTER
);

3303 
d©aP¨t
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
£
.
ty≥
]]);

3305 
b8
=4; b8 < (4+
p_Vid
->
num_blk8x8_uv
); b8++)

3307 
b4
=0; b4 < 4; b4++)

3309 
ACLevñ
 = 
cuºSli˚
->
cofAC
[
b8
][
b4
][0];

3310 
ACRun
 = 
cuºSli˚
->
cofAC
[
b8
][
b4
][1];

3312 
Àvñ
=1;

3313 
uv
++;

3314 
p_Vid
->
is_v_block
 = (
uv
 >’_Vid->
num_blk8x8_uv
 << 1));

3316 
cuºMB
->
subblock_y
 = 
subblk_off£t_y
[
yuv
][
b8
 - 4][
b4
];

3317 
cuºMB
->
subblock_x
 = 
subblk_off£t_x
[
yuv
][
b8
 - 4][
b4
];

3319 
k
=0; k < 16 && 
Àvñ
 != 0; k++)

3321 
Àvñ
 = 
£
.
vÆue1
 = 
ACLevñ
[
k
];

3322 
£
.
vÆue2
 = 
ACRun
 [
k
];

3324 #i‡
TRACE


3325 
	`¢¥ötf
(
£
.
åa˚°rög
, 
TRACESTRING_SIZE
, "AC Chrom®%2d:Üevñ =%3dÑu¿=%2d",
k
, 
Àvñ
, se.
vÆue2
);

3327 
	`wrôeRunLevñ_CABAC
(
cuºMB
, &
£
, 
d©aP¨t
);

3328 
block_øã
 +
£
.
Àn
;

3332 
cuºMB
->
bôs
.
mb_uv_c€ff
 +
block_øã
;

3333 
øã
 +
block_øã
;

3337  
øã
;

3338 
	}
}

3340 #i‡
TRACE


3341 
ölöe
 
	$åa˚_c€ff
(
Sy¡axEÀmít
 *
£
, 
∂™e
, *
ty≥
, 
k
, 
Àvñ
, 
run
)

3343 i‡(
∂™e
 == 0)

3344 
	`¢¥ötf
(
£
->
åa˚°rög
, 
TRACESTRING_SIZE
, "Luma%†¢g(%2dËÀvñ =%3dÑu¿=%2d", 
ty≥
, 
k
, 
Àvñ
,
run
);

3345 i‡(
∂™e
 == 1)

3346 
	`¢¥ötf
(
£
->
åa˚°rög
, 
TRACESTRING_SIZE
, "Cb%† sng(%2dËÀvñ =%3dÑu¿=%2d", 
ty≥
, 
k
, 
Àvñ
,
run
);

3348 
	`¢¥ötf
(
£
->
åa˚°rög
, 
TRACESTRING_SIZE
, "Cr%† sng(%2dËÀvñ =%3dÑu¿=%2d", 
ty≥
, 
k
, 
Àvñ
,
run
);

3349 
	}
}

3358 
	$wrôeC€ff4x4_CABAC
 (
Ma¸oblock
* 
cuºMB
, 
Cﬁ‹Pœ√
 
∂™e
, 
b8
, 
b4
, 
öåa4x4mode
)

3360 
Sli˚
* 
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

3362 
øã
 = 0;

3363 
Sy¡axEÀmít
 
£
;

3364 c⁄° * 
∑πM≠
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
∑πôi⁄_mode
];

3365 
D©aP¨tôi⁄
* 
d©aP¨t
;

3367 
Àvñ
;

3368 
k
;

3369 
∂_off
=
∂™e
<<2;

3371 *
mb_bôs_c€ff
 = ((
∂™e
==0Ë? &
cuºMB
->
bôs
.
mb_y_c€ff
 : (’œ√==1Ë? &cuºMB->bôs.
mb_cb_c€ff
 : &cuºMB->bôs.
mb_¸_c€ff
));

3372 * 
ACLevñ
 = 
cuºSli˚
->
cofAC
[
b8
+
∂_off
][
b4
][0];

3373 * 
ACRun
 = 
cuºSli˚
->
cofAC
[
b8
+
∂_off
][
b4
][1];

3375 
cuºMB
->
subblock_x
 = ((
b8
&0x1)==0Ë? (((
b4
&0x1)==0)? 0: 4) : (((b4&0x1)==0)? 8: 12);

3376 
cuºMB
->
subblock_y
 = (
b8
<2Ë? ((
b4
<2) ? 0: 4) : ((b4<2) ? 8: 12);

3377 
cuºMB
->
is_öåa_block
 = (
byã
Ë
öåa4x4mode
;

3378 
£
.
c⁄ãxt
 = ((
∂™e
 =0Ë? (
LUMA_4x4
Ë: (’œ√==1Ë? 
CB_4x4
 : 
CR_4x4
));

3381 
£
.
ty≥
 = (
öåa4x4mode
 ? 
SE_LUM_DC_INTRA
 : 
SE_LUM_DC_INTER
);

3384 
d©aP¨t
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
£
.
ty≥
]]);

3386 
Àvñ
 = 
£
.
vÆue1
 = 
ACLevñ
[0];

3387 
£
.
vÆue2
 = 
ACRun
 [0];

3389 #i‡
TRACE


3390 
	`åa˚_c€ff
(&
£
, 
∂™e
, "4x4", 0, 
Àvñ
, se.
vÆue2
);

3393 
	`wrôeRunLevñ_CABAC
(
cuºMB
, &
£
, 
d©aP¨t
);

3394 
øã
 +
£
.
Àn
;

3397 
£
.
ty≥
 = (
öåa4x4mode
 ? 
SE_LUM_AC_INTRA
 : 
SE_LUM_AC_INTER
);

3399 
d©aP¨t
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
£
.
ty≥
]]);

3401 
k
 = 1; k <16 && 
Àvñ
 != 0; k++)

3403 
Àvñ
 = 
£
.
vÆue1
 = 
ACLevñ
[
k
];

3404 
£
.
vÆue2
 = 
ACRun
 [
k
];

3405 #i‡
TRACE


3406 
	`åa˚_c€ff
(&
£
, 
∂™e
, "4x4", 
k
, 
Àvñ
, se.
vÆue2
);

3408 
	`wrôeRunLevñ_CABAC
(
cuºMB
, &
£
, 
d©aP¨t
);

3410 
øã
 +
£
.
Àn
;

3413 *
mb_bôs_c€ff
 +
øã
;

3415  
øã
;

3416 
	}
}

3424 
	$wrôeC€ff8x8_CABAC
 (
Ma¸oblock
* 
cuºMB
, 
Cﬁ‹Pœ√
 
∂™e
, 
b8
, 
öåa_mode
)

3426 
Sli˚
* 
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

3428 
øã
 = 0;

3429 
Sy¡axEÀmít
 
£
;

3430 c⁄° * 
∑πM≠
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
∑πôi⁄_mode
];

3431 
D©aP¨tôi⁄
* 
d©aP¨t
;

3433 
Àvñ
;

3434 
k
;

3436 
∂_off
 = 
∂™e
<<2;

3437 *
mb_bôs_c€ff
 = ((
∂™e
==0Ë? &
cuºMB
->
bôs
.
mb_y_c€ff
 : (’œ√==1Ë? &cuºMB->bôs.
mb_cb_c€ff
 : &cuºMB->bôs.
mb_¸_c€ff
));

3438 * 
ACLevñ
 = 
cuºSli˚
->
cofAC
[
b8
+
∂_off
][0][0];

3439 * 
ACRun
 = 
cuºSli˚
->
cofAC
[
b8
+
∂_off
][0][1];

3441 
cuºMB
->
subblock_x
 = ((
b8
&0x1) == 0) ? 0 : 8;

3442 
cuºMB
->
subblock_y
 = (
b8
 < 2) ? 0 : 8;

3443 
cuºMB
->
is_öåa_block
 = (
byã
Ë
öåa_mode
;

3445 
£
.
c⁄ãxt
 = ((
∂™e
==0Ë? (
LUMA_8x8
Ë: (’œ√ =1)? 
CB_8x8
 : 
CR_8x8
));

3448 
Àvñ
 = 
£
.
vÆue1
 = 
ACLevñ
[0];

3449 
£
.
vÆue2
 = 
ACRun
 [0];

3451 
£
.
ty≥
 = (
öåa_mode
 ? 
SE_LUM_DC_INTRA
 : 
SE_LUM_DC_INTER
);

3454 
d©aP¨t
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[cuºSli˚->
¶i˚_ty≥
 !
B_SLICE
 ? 
£
.
ty≥
 : 
SE_BFRAME
]]);

3456 #i‡
TRACE


3457 
	`åa˚_c€ff
(&
£
, 
∂™e
, "8x8", 0, 
Àvñ
, se.
vÆue2
);

3460 
	`wrôeRunLevñ_CABAC
(
cuºMB
, &
£
, 
d©aP¨t
);

3461 
øã
 +
£
.
Àn
;

3464 
£
.
ty≥
 = (
öåa_mode
 ? 
SE_LUM_AC_INTRA
 : 
SE_LUM_AC_INTER
);

3466 
d©aP¨t
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[cuºSli˚->
¶i˚_ty≥
 !
B_SLICE
 ? 
£
.
ty≥
 : 
SE_BFRAME
]]);

3468 
k
=1; k<=64 && 
Àvñ
 !=0; k++)

3470 
Àvñ
 = 
£
.
vÆue1
 = 
ACLevñ
[
k
];

3471 
£
.
vÆue2
 = 
ACRun
 [
k
];

3473 #i‡
TRACE


3474 
	`åa˚_c€ff
(&
£
, 
∂™e
, "8x8", 
k
, 
Àvñ
, se.
vÆue2
);

3477 
	`wrôeRunLevñ_CABAC
(
cuºMB
, &
£
, 
d©aP¨t
);

3478 
øã
 +
£
.
Àn
;

3481 *
mb_bôs_c€ff
 +
øã
;

3482  
øã
;

3483 
	}
}

3491 
	$wrôeC€ff8x8
 (
Ma¸oblock
* 
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
block8x8
, 
block_mode
, 
å™sf‹m_size_Êag
)

3493 
Sli˚
* 
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

3494 
øã
 = 0;

3495 
is_öåa
 = (
block_mode
 =
IBLOCK
Ë|| (block_modê=
I8MB
);

3500 i‡(
cuºSli˚
->
symbﬁ_mode
 =
CAVLC
 )

3502 
block_cﬁ‹_ty≥
 = ((
∂
 =0Ë? 
LUMA
 : (’»=1Ë? 
CB
 : 
CR
));

3504 
øã
 +
cuºSli˚
->
	`wrôeC€ff4x4_CAVLC
 (
cuºMB
, 
block_cﬁ‹_ty≥
, 
block8x8
, 0, 
is_öåa
);

3505 
øã
 +
cuºSli˚
->
	`wrôeC€ff4x4_CAVLC
 (
cuºMB
, 
block_cﬁ‹_ty≥
, 
block8x8
, 1, 
is_öåa
);

3506 
øã
 +
cuºSli˚
->
	`wrôeC€ff4x4_CAVLC
 (
cuºMB
, 
block_cﬁ‹_ty≥
, 
block8x8
, 2, 
is_öåa
);

3507 
øã
 +
cuºSli˚
->
	`wrôeC€ff4x4_CAVLC
 (
cuºMB
, 
block_cﬁ‹_ty≥
, 
block8x8
, 3, 
is_öåa
);

3511 if(
å™sf‹m_size_Êag
)

3512 
øã
 +
	`wrôeC€ff8x8_CABAC
 (
cuºMB
, 
∂
, 
block8x8
, 
is_öåa
);

3515 
øã
 +
	`wrôeC€ff4x4_CABAC
 (
cuºMB
, 
∂
, 
block8x8
, 0, 
is_öåa
);

3516 
øã
 +
	`wrôeC€ff4x4_CABAC
 (
cuºMB
, 
∂
, 
block8x8
, 1, 
is_öåa
);

3517 
øã
 +
	`wrôeC€ff4x4_CABAC
 (
cuºMB
, 
∂
, 
block8x8
, 2, 
is_öåa
);

3518 
øã
 +
	`wrôeC€ff4x4_CABAC
 (
cuºMB
, 
∂
, 
block8x8
, 3, 
is_öåa
);

3522  
øã
;

3523 
	}
}

3531 
	$wrôe_CBP_™d_Dqu™t
 (
Ma¸oblock
* 
cuºMB
)

3533 
Sli˚
* 
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

3535 
øã
 = 0;

3536 
BôCou¡î
 *
mbBôs
 = &
cuºMB
->
bôs
;

3537 
Sy¡axEÀmít
 
£
;

3538 c⁄° * 
∑πM≠
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
∑πôi⁄_mode
];

3539 
cbp
 = 
cuºMB
->cbp;

3540 
D©aP¨tôi⁄
* 
d©aP¨t
;

3542 
£
.
vÆue2
 = 0;

3544 i‡(
cuºMB
->
mb_ty≥
 !
I16MB
)

3546 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

3547 
√ed_å™sf‹m_size_Êag
;

3550 
£
.
vÆue1
 = 
cbp
;

3551 
£
.
ty≥
 = 
SE_CBP
;

3554 
d©aP¨t
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
£
.
ty≥
]]);

3556 #i‡
TRACE


3557 
	`¢¥ötf
(
£
.
åa˚°rög
, 
TRACESTRING_SIZE
, "CBP (%2d,%2dË%3d",
cuºMB
->
mb_x
, cuºMB->
mb_y
, 
cbp
);

3559 
cuºSli˚
->
	`wrôeCBP
 (
cuºMB
, &
£
, 
d©aP¨t
);

3561 
cuºMB
->
bôs
.
mb_cbp
 = cuºMB->bôs.mb_cb∞+ (Ë
£
.
Àn
;

3562 
øã
 +
£
.
Àn
;

3566 
√ed_å™sf‹m_size_Êag
 = (((
cuºMB
->
mb_ty≥
 >= 1 && currMB->mb_type <= 3)||

3567 (
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
 && 
cuºMB
->
mb_ty≥
 =0 && 
p_Vid
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
) ||

3568 (
cuºMB
->
NoMbP¨tLessTh™8x8Fœg
))

3569 && 
cuºMB
->
mb_ty≥
 !
I8MB
 && cuºMB->mb_ty≥ !
I4MB


3570 && (
cuºMB
->
cbp
&15 || 
cuºSli˚
->
cmp_cbp
[1]&15 || currSlice->cmp_cbp[2] & 15)

3571 && 
cuºSli˚
->
p_I≈
->
Tønsf‹m8x8Mode
);

3573 i‡(
√ed_å™sf‹m_size_Êag
)

3575 
£
.
vÆue1
 = 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
;

3576 
£
.
ty≥
 = 
SE_MBTYPE
;

3578 #i‡
TRACE


3579 
	`¢¥ötf
(
£
.
åa˚°rög
, 
TRACESTRING_SIZE
, "å™sf‹m_size_8x8_Êag = %3d", 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
);

3581 
cuºSli˚
->
	`wrôeMB_å™sf‹m_size
(
cuºMB
, &
£
, 
d©aP¨t
);

3583 
mbBôs
->
mb_mode
 = mbBôs->mb_modê+ (Ë
£
.
Àn
;

3584 
øã
 +
£
.
Àn
;

3590 i‡(
cbp
!=0 || (
cuºMB
->
mb_ty≥
 =
I16MB
))

3592 
£
.
vÆue1
 = 
cuºMB
->
qp
 - cuºMB->
¥ev_qp
;

3593 
£
.
ty≥
 = 
SE_DELTA_QUANT
;

3596 
d©aP¨t
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
£
.
ty≥
]]);

3597 #i‡
TRACE


3598 
	`¢¥ötf
(
£
.
åa˚°rög
, 
TRACESTRING_SIZE
, "Dñè QP (%2d,%2dË%3d",
cuºMB
->
mb_x
, cuºMB->
mb_y
, se.
vÆue1
);

3600 
cuºSli˚
->
	`wrôeDqu™t
 (
cuºMB
, &
£
, 
d©aP¨t
);

3601 
cuºMB
->
bôs
.
mb_dñè_qu™t
 = cuºMB->bôs.mb_dñè_qu™à+ (Ë
£
.
Àn
;

3602 
øã
 +
£
.
Àn
;

3605  
øã
;

3606 
	}
}

3615 
	$wrôeC€ff16x16_CAVLC
 (
Ma¸oblock
* 
cuºMB
, 
Cﬁ‹Pœ√
 
∂™e
)

3617 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

3618 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

3620 
cbp
 = 
cuºMB
->cbp;

3622 
i
, 
k
;

3623 
øã
 = 0;

3625 
b8
, 
d©a_ty≥
;

3626 *
mb_bôs_c€ff
 = ((
∂™e
==0Ë? &
cuºMB
->
bôs
.
mb_y_c€ff
 : (’œ√==1Ë? &cuºMB->bôs.
mb_cb_c€ff
 : &cuºMB->bôs.
mb_¸_c€ff
));

3628 i‡(
cuºSli˚
->
P444_joöed
)

3630 
i
=0; i < 4; i++)

3631 
k
=4*
∂™e
; k<4*(plane+1); k++)

3632 
p_Vid
->
nz_c€ff
 [
cuºMB
->
mbAddrX
][
i
][
k
] = 0;

3636 
	`ª£t_mb_nz_c€ff
(
p_Vid
, 
cuºMB
->
mbAddrX
);

3640 i‡(
cuºMB
->
mb_ty≥
 !
I16MB
)

3644 
i
=0; i<4; i++)

3646 i‡(
cbp
 & (1<<
i
))

3648 
øã
 +
	`wrôeC€ff8x8
 (
cuºMB
, 
∂™e
, 
i
, cuºMB->
b8x8
[i].
mode
, cuºMB->
luma_å™sf‹m_size_8x8_Êag
);

3657 
∂™e
)

3661 
d©a_ty≥
 = 
LUMA_INTRA16x16DC
;

3664 
d©a_ty≥
 = 
CB_INTRA16x16DC
;

3667 
d©a_ty≥
 = 
CR_INTRA16x16DC
;

3670 
øã
 +
cuºSli˚
->
	`wrôeC€ff4x4_CAVLC
 (
cuºMB
, 
d©a_ty≥
, 0, 0, 0);

3674 i‡(
cbp
 & 15)

3676 
∂™e
)

3680 
d©a_ty≥
 = 
LUMA_INTRA16x16AC
;

3683 
d©a_ty≥
 = 
CB_INTRA16x16AC
;

3686 
d©a_ty≥
 = 
CR_INTRA16x16AC
;

3690 
b8
 = 0; b8 < 4; b8 ++)

3692 
øã
 +
cuºSli˚
->
	`wrôeC€ff4x4_CAVLC
 (
cuºMB
, 
d©a_ty≥
, 
b8
, 0, 0);

3693 
øã
 +
cuºSli˚
->
	`wrôeC€ff4x4_CAVLC
 (
cuºMB
, 
d©a_ty≥
, 
b8
, 1, 0);

3694 
øã
 +
cuºSli˚
->
	`wrôeC€ff4x4_CAVLC
 (
cuºMB
, 
d©a_ty≥
, 
b8
, 2, 0);

3695 
øã
 +
cuºSli˚
->
	`wrôeC€ff4x4_CAVLC
 (
cuºMB
, 
d©a_ty≥
, 
b8
, 3, 0);

3699 
mb_bôs_c€ff
 +
øã
;

3700  
øã
;

3701 
	}
}

3711 
	$wrôeC€ff16x16_CABAC
 (
Ma¸oblock
* 
cuºMB
, 
Cﬁ‹Pœ√
 
∂™e
)

3713 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

3714 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

3716 
cbp
 = 
cuºMB
->cbp;

3718 
mb_x
, 
mb_y
, 
i
, 
j
, 
k
;

3719 
Àvñ
;

3720 
øã
 = 0;

3721 
block_øã
 = 0;

3722 
Sy¡axEÀmít
 
£
;

3723 c⁄° * 
∑πM≠
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
∑πôi⁄_mode
];

3724 
∂_off
 = 
∂™e
<<2;

3725 
D©aP¨tôi⁄
* 
d©aP¨t
;

3727 
b8
, 
b4
;

3728 * 
DCLevñ
 = 
cuºSli˚
->
cofDC
[
∂™e
][0];

3729 * 
DCRun
 = 
cuºSli˚
->
cofDC
[
∂™e
][1];

3730 * 
ACLevñ
;

3731 * 
ACRun
;

3732 
d©a_ty≥
;

3733 * 
mb_bôs_c€ff
 = ((
∂™e
==0Ë? &
cuºMB
->
bôs
.
mb_y_c€ff
 : (’œ√==1Ë? &cuºMB->bôs.
mb_cb_c€ff
 : &cuºMB->bôs.
mb_¸_c€ff
));

3735 i‡(
cuºSli˚
->
P444_joöed
)

3737 
i
=0; i < 4; i++)

3738 
k
=4*
∂™e
; k<4*(plane+1); k++)

3739 
p_Vid
->
nz_c€ff
 [
cuºMB
->
mbAddrX
][
i
][
k
] = 0;

3743 
	`ª£t_mb_nz_c€ff
(
p_Vid
, 
cuºMB
->
mbAddrX
);

3747 i‡(
cuºMB
->
mb_ty≥
 !
I16MB
)

3751 i‡(
cbp
 != 0)

3753 
i
=0; i<4; i++)

3755 i‡(
cbp
 & (1<<
i
))

3757 
øã
 +
	`wrôeC€ff8x8
 (
cuºMB
, 
∂™e
, 
i
, cuºMB->
b8x8
[i].
mode
, cuºMB->
luma_å™sf‹m_size_8x8_Êag
);

3767 
cuºMB
->
is_öåa_block
 = 
TRUE
;

3768 
∂™e
)

3772 
d©a_ty≥
 = 
LUMA_16DC
;

3775 
d©a_ty≥
 = 
CB_16DC
;

3778 
d©a_ty≥
 = 
CR_16DC
;

3782 
£
.
c⁄ãxt
 = 
d©a_ty≥
;

3783 
£
.
ty≥
 = 
SE_LUM_DC_INTRA
;

3786 
d©aP¨t
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
£
.
ty≥
]]);

3788 
Àvñ
 = 1;

3789 
k
=0; k<=16 && 
Àvñ
!=0; k++)

3791 
Àvñ
 = 
£
.
vÆue1
 = 
DCLevñ
[
k
];

3792 
£
.
vÆue2
 = 
DCRun
 [
k
];

3793 #i‡
TRACE


3794 
	`åa˚_c€ff
(&
£
, 
∂™e
, "16x16 DC", 
k
, 
Àvñ
, se.
vÆue2
);

3796 
	`wrôeRunLevñ_CABAC
(
cuºMB
, &
£
, 
d©aP¨t
);

3797 
block_øã
 +
£
.
Àn
;

3799 *
mb_bôs_c€ff
 +
block_øã
;

3800 
øã
 +
block_øã
;

3803 i‡(
cbp
 & 15)

3805 
∂™e
)

3809 
d©a_ty≥
 = 
LUMA_16AC
;

3812 
d©a_ty≥
 = 
CB_16AC
;

3815 
d©a_ty≥
 = 
CR_16AC
;

3819 
£
.
c⁄ãxt
 = 
d©a_ty≥
;

3820 
£
.
ty≥
 = 
SE_LUM_AC_INTRA
;

3823 
d©aP¨t
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
£
.
ty≥
]]);

3824 
block_øã
 = 0;

3826 
mb_y
 = 0; mb_y < 4; mb_y += 2)

3828 
mb_x
 = 0; mb_x < 4; mb_x += 2)

3830 
j
 = 
mb_y
; j < mb_y + 2; j++)

3832 
j1
 = 2*(
j
 >> 1);

3833 
j2
 = 2*(
j
 & 0x01);

3834 
cuºMB
->
subblock_y
 = (Ë(
j
 << 2);

3836 
i
=
mb_x
; i < mb_x+2; i++)

3838 
cuºMB
->
subblock_x
 = (Ë(
i
 << 2);

3839 
b8
 = 
j1
 + (
i
 >> 1Ë+ 
∂_off
;

3840 
b4
 = 
j2
 + (
i
 & 0x01);

3842 
ACLevñ
 = 
cuºSli˚
->
cofAC
[
b8
][
b4
][0];

3843 
ACRun
 = 
cuºSli˚
->
cofAC
[
b8
][
b4
][1];

3845 
Àvñ
=1;

3847 
k
=0; k < 16 && 
Àvñ
 !=0; k++)

3849 
Àvñ
 = 
£
.
vÆue1
 = 
ACLevñ
[
k
];

3850 
£
.
vÆue2
 = 
ACRun
 [
k
];

3851 #i‡
TRACE


3852 
	`åa˚_c€ff
(&
£
, 
∂™e
, "16x16 AC", 
k
, 
Àvñ
, se.
vÆue2
);

3854 
	`wrôeRunLevñ_CABAC
(
cuºMB
, &
£
, 
d©aP¨t
);

3855 
block_øã
 +
£
.
Àn
;

3862 
øã
 +
block_øã
;

3863 *
mb_bôs_c€ff
 +
block_øã
;

3867  
øã
;

3868 
	}
}

3878 
	$¥edi˘_¬z
(
Ma¸oblock
 *
cuºMB
, 
block_ty≥
, 
i
,
j
)

3880 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

3881 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

3882 
PixñPos
 
pix
;

3884 
¥ed_¬z
 = 0;

3885 
˙t
 = 0;

3888 
	`gë4x4Neighbour
(
cuºMB
, (
i
 << 2Ë- 1, (
j
 << 2), 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix
);

3890 i‡(
	`is_öåa
(
cuºMB
Ë&& 
pix
.
avaûabÀ
 && 
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
 && ((
cuºSli˚
->
∑πôi⁄_mode
 !0Ë&& !cuºSli˚->
idr_Êag
))

3892 
pix
.
avaûabÀ
 &
p_Vid
->
öåa_block
[pix.
mb_addr
];

3893 i‡(!
pix
.
avaûabÀ
)

3894 
˙t
++;

3897 i‡(
pix
.
avaûabÀ
)

3899 
block_ty≥
)

3901 
LUMA
:

3902 
¥ed_¬z
 +
p_Vid
->
nz_c€ff
 [
pix
.
mb_addr
 ][pix.
x
][pix.
y
];

3903 
˙t
++;

3905 
CB
:

3906 
¥ed_¬z
 +
p_Vid
->
nz_c€ff
 [
pix
.
mb_addr
 ][pix.
x
][4+pix.
y
];

3907 
˙t
++;

3909 
CR
:

3910 
¥ed_¬z
 +
p_Vid
->
nz_c€ff
 [
pix
.
mb_addr
 ][pix.
x
][8+pix.
y
];

3911 
˙t
++;

3914 
	`îr‹
("writeCoeff4x4_CAVLC: Invalid blockÅype", 600);

3920 
	`gë4x4Neighbour
(
cuºMB
, (
i
<<2), (
j
<<2Ë- 1, 
p_Vid
->
mb_size
[
IS_LUMA
], &
pix
);

3922 i‡(
	`is_öåa
(
cuºMB
Ë&& 
pix
.
avaûabÀ
 && 
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
 && ((
cuºSli˚
->
∑πôi⁄_mode
 !0Ë&& !cuºSli˚->
idr_Êag
))

3924 
pix
.
avaûabÀ
 &
p_Vid
->
öåa_block
[pix.
mb_addr
];

3925 i‡(!
pix
.
avaûabÀ
)

3926 
˙t
++;

3929 i‡(
pix
.
avaûabÀ
)

3931 
block_ty≥
)

3933 
LUMA
:

3934 
¥ed_¬z
 +
p_Vid
->
nz_c€ff
 [
pix
.
mb_addr
 ][pix.
x
][pix.
y
];

3935 
˙t
++;

3937 
CB
:

3938 
¥ed_¬z
 +
p_Vid
->
nz_c€ff
 [
pix
.
mb_addr
 ][pix.
x
][4+pix.
y
];

3939 
˙t
++;

3941 
CR
:

3942 
¥ed_¬z
 +
p_Vid
->
nz_c€ff
 [
pix
.
mb_addr
 ][pix.
x
][8+pix.
y
];

3943 
˙t
++;

3946 
	`îr‹
("writeCoeff4x4_CAVLC: Invalid blockÅype", 600);

3951 i‡(
˙t
==2)

3953 
¥ed_¬z
++;

3954 
¥ed_¬z
>>=1;

3957  
¥ed_¬z
;

3958 
	}
}

3969 
	$¥edi˘_¬z_chroma
(
Ma¸oblock
 *
cuºMB
, 
i
,
j
)

3971 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

3972 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

3973 
PixñPos
 
pix
;

3975 
¥ed_¬z
 = 0;

3976 
˙t
 = 0;

3978 i‡(
p_Vid
->
yuv_f‹m©
 !
YUV444
)

3982 
	`gë4x4Neighbour
(
cuºMB
, ((
i
 & 0x01)<<2Ë- 1, ((
j
-4)<<2), 
p_Vid
->
mb_size
[
IS_CHROMA
], &
pix
);

3984 i‡(
	`is_öåa
(
cuºMB
Ë&& 
pix
.
avaûabÀ
 && 
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
 && ((
cuºSli˚
->
∑πôi⁄_mode
 !0Ë&& !cuºSli˚->
idr_Êag
))

3986 
pix
.
avaûabÀ
 &
p_Vid
->
öåa_block
[pix.
mb_addr
];

3987 i‡(!
pix
.
avaûabÀ
)

3988 
˙t
++;

3991 i‡(
pix
.
avaûabÀ
)

3993 
¥ed_¬z
 = 
p_Vid
->
nz_c€ff
 [
pix
.
mb_addr
 ][2 * (
i
 >> 1Ë+Öix.
x
][4 +Öix.
y
];

3994 
˙t
++;

3998 
	`gë4x4Neighbour
(
cuºMB
, ((
i
 & 0x01)<<2), ((
j
-4)<<2Ë-1, 
p_Vid
->
mb_size
[
IS_CHROMA
], &
pix
);

4000 i‡(
	`is_öåa
(
cuºMB
Ë&& 
pix
.
avaûabÀ
 && 
p_Vid
->
a˘ive_µs
->
c⁄°øöed_öåa_¥ed_Êag
 && ((
cuºSli˚
->
∑πôi⁄_mode
 !0Ë&& !cuºSli˚->
idr_Êag
))

4002 
pix
.
avaûabÀ
 &
p_Vid
->
öåa_block
[pix.
mb_addr
];

4003 i‡(!
pix
.
avaûabÀ
)

4004 
˙t
++;

4007 i‡(
pix
.
avaûabÀ
)

4009 
¥ed_¬z
 +
p_Vid
->
nz_c€ff
 [
pix
.
mb_addr
 ][2 * (
i
 >> 1Ë+Öix.
x
][4 +Öix.
y
];

4010 
˙t
++;

4015 i‡(
˙t
==2)

4017 
¥ed_¬z
++;

4018 
¥ed_¬z
>>=1;

4021  
¥ed_¬z
;

4022 
	}
}

4034 
	$wrôeC€ff4x4_CAVLC_n‹mÆ
 (
Ma¸oblock
* 
cuºMB
, 
block_ty≥
, 
b8
, 
b4
, 
∑øm
)

4036 
Sli˚
* 
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

4037 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

4038 
no_bôs
 = 0;

4039 
Sy¡axEÀmít
 
£
;

4040 
D©aP¨tôi⁄
 *
d©aP¨t
;

4041 c⁄° *
∑πM≠
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
∑πôi⁄_mode
];

4043 
k
,
Àvñ
 = 1,
run
 = 0, 
vl˙um
;

4044 
numc€ff
 = 0, 
œ°c€ff
 = 0, 
numåaûög⁄es
 = 0;

4045 
num⁄es
 = 0, 
tŸzîos
 = 0, 
zîo¶e·
, 
numc€f
;

4046 
numc€ff_vlc
;

4047 
code
, 
Àvñ_two_‹_highî
;

4048 
d±y≥
 = 0;

4049 
¬z
, 
max_c€ff_num
 = 0, 
cdc
 = 0, 
ˇc
 = 0;

4050 
subblock_x
, 
subblock_y
;

4051 *
mb_bôs_c€ff
 = &
cuºMB
->
bôs
.
mb_y_c€ff
;

4052 #i‡
TRACE


4053 
ty≥
[15];

4056 c⁄° 
öcVlc
[] = {0, 3, 6, 12, 24, 48, 32768};

4059 * 
pLevñ
 = 
NULL
;

4060 * 
pRun
 = 
NULL
;

4062 
block_ty≥
)

4064 
LUMA
:

4065 
max_c€ff_num
 = 16;

4067 
pLevñ
 = 
cuºSli˚
->
cofAC
[
b8
][
b4
][0];

4068 
pRun
 = 
cuºSli˚
->
cofAC
[
b8
][
b4
][1];

4069 #i‡
TRACE


4070 
	`•rötf
(
ty≥
, "%s", "Luma");

4072 
d±y≥
 = (
	`is_öåa
 (
cuºMB
)Ë? 
SE_LUM_AC_INTRA
 : 
SE_LUM_AC_INTER
;

4075 
CHROMA_AC
:

4076 
max_c€ff_num
 = 15;

4077 
mb_bôs_c€ff
 = &
cuºMB
->
bôs
.
mb_uv_c€ff
;

4078 
ˇc
 = 1;

4080 
pLevñ
 = 
cuºSli˚
->
cofAC
[
b8
][
b4
][0];

4081 
pRun
 = 
cuºSli˚
->
cofAC
[
b8
][
b4
][1];

4082 #i‡
TRACE


4083 
	`•rötf
(
ty≥
, "%s", "ChrAC");

4085 
d±y≥
 = (
	`is_öåa
 (
cuºMB
)Ë? 
SE_CHR_AC_INTRA
 : 
SE_CHR_AC_INTER
;

4088 
CHROMA_DC
:

4089 
max_c€ff_num
 = 
p_Vid
->
num_cdc_c€ff
;

4090 
mb_bôs_c€ff
 = &
cuºMB
->
bôs
.
mb_uv_c€ff
;

4091 
cdc
 = 1;

4093 
pLevñ
 = 
cuºSli˚
->
cofDC
[
∑øm
 + 1][0];

4094 
pRun
 = 
cuºSli˚
->
cofDC
[
∑øm
 + 1][1];

4095 #i‡
TRACE


4096 
	`•rötf
(
ty≥
, "%s", "ChrDC");

4098 
d±y≥
 = (
	`is_öåa
 (
cuºMB
)Ë? 
SE_CHR_DC_INTRA
 : 
SE_CHR_DC_INTER
;

4101 
LUMA_INTRA16x16AC
:

4102 
max_c€ff_num
 = 15;

4104 
pLevñ
 = 
cuºSli˚
->
cofAC
[
b8
][
b4
][0];

4105 
pRun
 = 
cuºSli˚
->
cofAC
[
b8
][
b4
][1];

4106 #i‡
TRACE


4107 
	`•rötf
(
ty≥
, "%s", "Lum16AC");

4109 
d±y≥
 = 
SE_LUM_AC_INTRA
;

4112 
LUMA_INTRA16x16DC
:

4113 
max_c€ff_num
 = 16;

4115 
pLevñ
 = 
cuºSli˚
->
cofDC
[0][0];

4116 
pRun
 = 
cuºSli˚
->
cofDC
[0][1];

4117 #i‡
TRACE


4118 
	`•rötf
(
ty≥
, "%s", "Lum16DC");

4120 
d±y≥
 = 
SE_LUM_DC_INTRA
;

4125 
	`îr‹
("writeCoeff4x4_CAVLC: Invalid blockÅype", 600);

4129 
d©aP¨t
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
d±y≥
]]);

4131 
k
 = 0; (k <((
cdc
Ë? 
p_Vid
->
num_cdc_c€ff
 : 16)Ë&& 
Àvñ
 != 0; k++)

4133 
Àvñ
 = 
pLevñ
[
k
];

4134 
run
 = 
pRun
[
k
];

4136 i‡(
Àvñ
)

4139 
tŸzîos
 +
run
;

4140 i‡(
	`übs
(
Àvñ
) == 1)

4142 
num⁄es
 ++;

4143 
numåaûög⁄es
 ++;

4144 
numåaûög⁄es
 = 
	`imö
(numtrailingones, 3);

4148 
numåaûög⁄es
 = 0;

4150 
numc€ff
 ++;

4151 
œ°c€ff
 = 
k
;

4155 i‡(!
cdc
)

4157 i‡(!
ˇc
)

4160 
subblock_x
 = ((
b8
 & 0x1Ë=0Ë? (((
b4
 & 0x1) == 0) ? 0 : 1) : (((b4 & 0x1) == 0) ? 2 : 3);

4162 
subblock_y
 = (
b8
 < 2Ë? ((
b4
 < 2) ? 0 : 1) : ((b4 < 2) ? 2 : 3);

4164 
¬z
 = 
	`¥edi˘_¬z
(
cuºMB
, 
LUMA
, 
subblock_x
,
subblock_y
);

4169 
subblock_x
 = 
∑øm
 >> 4;

4170 
subblock_y
 = 
∑øm
 & 15;

4171 
¬z
 = 
	`¥edi˘_¬z_chroma
(
cuºMB
, 
subblock_x
, 
subblock_y
);

4173 
p_Vid
->
nz_c€ff
 [
cuºMB
->
mbAddrX
 ][
subblock_x
][
subblock_y
] = 
numc€ff
;

4175 
numc€ff_vlc
 = (
¬z
 < 2) ? 0 : ((nnz < 4) ? 1 : ((nnz < 8) ? 2 : 3));

4181 
numc€ff_vlc
 = 0;

4183 
subblock_x
 = 
∑øm
;

4184 
subblock_y
 = 
∑øm
;

4187 
£
.
ty≥
 = 
d±y≥
;

4189 
£
.
vÆue1
 = 
numc€ff
;

4190 
£
.
vÆue2
 = 
numåaûög⁄es
;

4191 
£
.
Àn
 = 
numc€ff_vlc
;

4193 #i‡
TRACE


4194 
	`¢¥ötf
(
£
.
åa˚°rög
,

4195 
TRACESTRING_SIZE
, "%s # c &År.1s(%d,%d) vlc=%d #c=%d #t1=%d",

4196 
ty≥
, 
subblock_x
, 
subblock_y
, 
numc€ff_vlc
, 
numc€ff
, 
numåaûög⁄es
);

4199 i‡(!
cdc
)

4200 
	`wrôeSy¡axEÀmít_NumC€ffTøûögO√s
(&
£
, 
d©aP¨t
);

4202 
	`wrôeSy¡axEÀmít_NumC€ffTøûögO√sChromaDC
(
p_Vid
, &
£
, 
d©aP¨t
);

4204 *
mb_bôs_c€ff
 +
£
.
Àn
;

4205 
no_bôs
 +
£
.
Àn
;

4207 i‡(!
numc€ff
)

4208  
no_bôs
;

4210 i‡(
numc€ff
)

4212 
code
 = 0;

4213 
k
 = 
œ°c€ff
; k >Üa°c€f‡- 
numåaûög⁄es
; k--)

4215 
Àvñ
 = 
pLevñ
[
k
];

4216 #ifde‡ 
_DEBUG


4217 i‡(
	`übs
(
Àvñ
) > 1)

4219 
	`¥ötf
("ERROR:Üevel > 1\n");

4220 
	`exô
(-1);

4223 
code
 <<= 1;

4225 
code
 |(
Àvñ
 < 0);

4228 i‡(
numåaûög⁄es
)

4230 
£
.
ty≥
 = 
d±y≥
;

4232 
£
.
vÆue2
 = 
numåaûög⁄es
;

4233 
£
.
vÆue1
 = 
code
;

4235 #i‡
TRACE


4236 
	`¢¥ötf
(
£
.
åa˚°rög
,

4237 
TRACESTRING_SIZE
, "%sÅrailing ones sign (%d,%d)",

4238 
ty≥
, 
subblock_x
, 
subblock_y
);

4241 
	`wrôeSy¡axEÀmít_VLC
 (&
£
, 
d©aP¨t
);

4242 *
mb_bôs_c€ff
 +
£
.
Àn
;

4243 
no_bôs
 +
£
.
Àn
;

4248 
Àvñ_two_‹_highî
 = (
numc€ff
 > 3 && 
numåaûög⁄es
 == 3) ? 0 : 1;

4250 
vl˙um
 = (
numc€ff
 > 10 && 
numåaûög⁄es
 < 3) ? 1 : 0;

4252 
k
 = 
œ°c€ff
 - 
numåaûög⁄es
; k >= 0; k--)

4254 
Àvñ
 = 
pLevñ
[
k
];

4256 
£
.
vÆue1
 = 
Àvñ
;

4257 
£
.
ty≥
 = 
d±y≥
;

4259 #i‡
TRACE


4260 
	`¢¥ötf
(
£
.
åa˚°rög
,

4261 
TRACESTRING_SIZE
, "%sÜev (%d,%d) k=%d vlc=%dÜev=%3d",

4262 
ty≥
, 
subblock_x
, 
subblock_y
, 
k
, 
vl˙um
, 
Àvñ
);

4265 i‡(
Àvñ_two_‹_highî
)

4267 
Àvñ_two_‹_highî
 = 0;

4269 i‡(
£
.
vÆue1
 > 0)

4270 
£
.
vÆue1
 --;

4272 
£
.
vÆue1
 ++;

4277 i‡(
vl˙um
 == 0)

4278 
	`wrôeSy¡axEÀmít_Levñ_VLC1
(&
£
, 
d©aP¨t
, 
p_Vid
->
a˘ive_•s
->
¥ofûe_idc
);

4280 
	`wrôeSy¡axEÀmít_Levñ_VLCN
(&
£
, 
vl˙um
, 
d©aP¨t
, 
p_Vid
->
a˘ive_•s
->
¥ofûe_idc
);

4283 i‡(
	`übs
(
Àvñ
Ë> 
öcVlc
[
vl˙um
])

4284 
vl˙um
++;

4286 i‡((
k
 =
œ°c€ff
 - 
numåaûög⁄es
Ë&& 
	`übs
(
Àvñ
) > 3)

4287 
vl˙um
 = 2;

4289 *
mb_bôs_c€ff
 +
£
.
Àn
;

4290 
no_bôs
 +
£
.
Àn
;

4294 i‡(
numc€ff
 < 
max_c€ff_num
)

4297 
£
.
ty≥
 = 
d±y≥
;

4298 
£
.
vÆue1
 = 
tŸzîos
;

4300 
vl˙um
 = 
numc€ff
 - 1;

4302 
£
.
Àn
 = 
vl˙um
;

4304 #i‡
TRACE


4305 
	`¢¥ötf
(
£
.
åa˚°rög
,

4306 
TRACESTRING_SIZE
, "%sÅotalrun (%d,%d) vlc=%dÅotzeros=%3d",

4307 
ty≥
, 
subblock_x
, 
subblock_y
, 
vl˙um
, 
tŸzîos
);

4309 i‡(!
cdc
)

4310 
	`wrôeSy¡axEÀmít_TŸÆZîos
(&
£
, 
d©aP¨t
);

4312 
	`wrôeSy¡axEÀmít_TŸÆZîosChromaDC
(
p_Vid
, &
£
, 
d©aP¨t
);

4314 *
mb_bôs_c€ff
 +
£
.
Àn
;

4315 
no_bôs
 +
£
.
Àn
;

4319 
zîo¶e·
 = 
tŸzîos
;

4320 
numc€f
 = 
numc€ff
;

4321 
k
 = 
œ°c€ff
; k >= 0; k--)

4323 
run
 = 
pRun
[
k
];

4325 
£
.
vÆue1
 = 
run
;

4326 
£
.
ty≥
 = 
d±y≥
;

4330 i‡((!
zîo¶e·
Ë|| (
numc€ff
 <= 1 ))

4333 i‡(
numc€f
 > 1 && 
zîo¶e·
)

4335 
vl˙um
 = 
	`imö
(
zîo¶e·
 - 1, 
RUNBEFORE_NUM_M1
);

4336 
£
.
Àn
 = 
vl˙um
;

4338 #i‡
TRACE


4339 
	`¢¥ötf
(
£
.
åa˚°rög
,

4340 
TRACESTRING_SIZE
, "%sÑun (%d,%d) k=%d vlc=%dÑun=%2d",

4341 
ty≥
, 
subblock_x
, 
subblock_y
, 
k
, 
vl˙um
, 
run
);

4344 
	`wrôeSy¡axEÀmít_Run
(&
£
, 
d©aP¨t
);

4346 *
mb_bôs_c€ff
 +
£
.
Àn
;

4347 
no_bôs
 +
£
.
Àn
;

4349 
zîo¶e·
 -
run
;

4350 
numc€f
 --;

4355  
no_bôs
;

4356 
	}
}

4368 
	$wrôeC€ff4x4_CAVLC_444
 (
Ma¸oblock
* 
cuºMB
, 
block_ty≥
, 
b8
, 
b4
, 
∑øm
)

4370 
Sli˚
* 
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

4371 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

4372 
no_bôs
 = 0;

4373 
Sy¡axEÀmít
 
£
;

4374 
D©aP¨tôi⁄
 *
d©aP¨t
;

4375 c⁄° *
∑πM≠
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
∑πôi⁄_mode
];

4377 
k
,
Àvñ
 = 1,
run
 = 0, 
vl˙um
;

4378 
numc€ff
 = 0, 
œ°c€ff
 = 0, 
numåaûög⁄es
 = 0;

4379 
num⁄es
 = 0, 
tŸzîos
 = 0, 
zîo¶e·
, 
numc€f
;

4380 
numc€ff_vlc
;

4381 
code
, 
Àvñ_two_‹_highî
;

4382 
d±y≥
 = 0;

4383 
¬z
, 
max_c€ff_num
 = 0, 
cdc
 = 0, 
ˇc
 = 0;

4384 
subblock_x
, 
subblock_y
;

4385 *
mb_bôs_c€ff
 = &
cuºMB
->
bôs
.
mb_y_c€ff
;

4386 #i‡
TRACE


4387 
ty≥
[15];

4390 c⁄° 
öcVlc
[] = {0, 3, 6, 12, 24, 48, 32768};

4392 * 
pLevñ
 = 
NULL
;

4393 * 
pRun
 = 
NULL
;

4395 
block_ty≥
)

4397 
LUMA
:

4398 
max_c€ff_num
 = 16;

4400 
pLevñ
 = 
cuºSli˚
->
cofAC
[
b8
][
b4
][0];

4401 
pRun
 = 
cuºSli˚
->
cofAC
[
b8
][
b4
][1];

4402 #i‡
TRACE


4403 
	`•rötf
(
ty≥
, "%s", "Luma");

4405 
d±y≥
 = (
	`is_öåa
 (
cuºMB
)Ë? 
SE_LUM_AC_INTRA
 : 
SE_LUM_AC_INTER
;

4407 
LUMA_INTRA16x16DC
:

4408 
max_c€ff_num
 = 16;

4410 
pLevñ
 = 
cuºSli˚
->
cofDC
[0][0];

4411 
pRun
 = 
cuºSli˚
->
cofDC
[0][1];

4412 #i‡
TRACE


4413 
	`•rötf
(
ty≥
, "%s", "Lum16DC");

4415 
d±y≥
 = 
SE_LUM_DC_INTRA
;

4417 
LUMA_INTRA16x16AC
:

4418 
max_c€ff_num
 = 15;

4420 
pLevñ
 = 
cuºSli˚
->
cofAC
[
b8
][
b4
][0];

4421 
pRun
 = 
cuºSli˚
->
cofAC
[
b8
][
b4
][1];

4422 #i‡
TRACE


4423 
	`•rötf
(
ty≥
, "%s", "Lum16AC");

4425 
d±y≥
 = 
SE_LUM_AC_INTRA
;

4427 
CB
:

4428 
max_c€ff_num
 = 16;

4429 
mb_bôs_c€ff
 = &
cuºMB
->
bôs
.
mb_cb_c€ff
;

4431 
pLevñ
 = 
cuºSli˚
->
cofAC
[4+
b8
][
b4
][0];

4432 
pRun
 = 
cuºSli˚
->
cofAC
[4+
b8
][
b4
][1];

4433 #i‡
TRACE


4434 
	`•rötf
(
ty≥
, "%s", "CB");

4436 
d±y≥
 = (
	`is_öåa
 (
cuºMB
)Ë? 
SE_LUM_AC_INTRA
 : 
SE_LUM_AC_INTER
;

4438 
CB_INTRA16x16DC
:

4439 
max_c€ff_num
 = 16;

4440 
mb_bôs_c€ff
 = &
cuºMB
->
bôs
.
mb_cb_c€ff
;

4442 
pLevñ
 = 
cuºSli˚
->
cofDC
[1][0];

4443 
pRun
 = 
cuºSli˚
->
cofDC
[1][1];

4444 #i‡
TRACE


4445 
	`•rötf
(
ty≥
, "%s", "CB_16DC");

4447 
d±y≥
 = 
SE_LUM_DC_INTRA
;

4449 
CB_INTRA16x16AC
:

4450 
max_c€ff_num
 = 15;

4451 
mb_bôs_c€ff
 = &
cuºMB
->
bôs
.
mb_cb_c€ff
;

4453 
pLevñ
 = 
cuºSli˚
->
cofAC
[4+
b8
][
b4
][0];

4454 
pRun
 = 
cuºSli˚
->
cofAC
[4+
b8
][
b4
][1];

4455 #i‡
TRACE


4456 
	`•rötf
(
ty≥
, "%s", "CB_16AC");

4458 
d±y≥
 = 
SE_LUM_AC_INTRA
;

4461 
CR
:

4462 
max_c€ff_num
 = 16;

4463 
mb_bôs_c€ff
 = &
cuºMB
->
bôs
.
mb_¸_c€ff
;

4465 
pLevñ
 = 
cuºSli˚
->
cofAC
[8+
b8
][
b4
][0];

4466 
pRun
 = 
cuºSli˚
->
cofAC
[8+
b8
][
b4
][1];

4467 #i‡
TRACE


4468 
	`•rötf
(
ty≥
, "%s", "CR");

4470 
d±y≥
 = (
	`is_öåa
 (
cuºMB
)Ë? 
SE_LUM_AC_INTRA
 : 
SE_LUM_AC_INTER
;

4472 
CR_INTRA16x16DC
:

4473 
max_c€ff_num
 = 16;

4474 
mb_bôs_c€ff
 = &
cuºMB
->
bôs
.
mb_¸_c€ff
;

4476 
pLevñ
 = 
cuºSli˚
->
cofDC
[2][0];

4477 
pRun
 = 
cuºSli˚
->
cofDC
[2][1];

4478 #i‡
TRACE


4479 
	`•rötf
(
ty≥
, "%s", "CR_16DC");

4481 
d±y≥
 = 
SE_LUM_DC_INTRA
;

4483 
CR_INTRA16x16AC
:

4484 
max_c€ff_num
 = 15;

4485 
mb_bôs_c€ff
 = &
cuºMB
->
bôs
.
mb_¸_c€ff
;

4487 
pLevñ
 = 
cuºSli˚
->
cofAC
[8+
b8
][
b4
][0];

4488 
pRun
 = 
cuºSli˚
->
cofAC
[8+
b8
][
b4
][1];

4489 #i‡
TRACE


4490 
	`•rötf
(
ty≥
, "%s", "CR_16AC");

4492 
d±y≥
 = 
SE_LUM_AC_INTRA
;

4495 
CHROMA_DC
:

4496 
max_c€ff_num
 = 
p_Vid
->
num_cdc_c€ff
;

4497 
mb_bôs_c€ff
 = &
cuºMB
->
bôs
.
mb_uv_c€ff
;

4498 
cdc
 = 1;

4500 
pLevñ
 = 
cuºSli˚
->
cofDC
[
∑øm
+1][0];

4501 
pRun
 = 
cuºSli˚
->
cofDC
[
∑øm
+1][1];

4502 #i‡
TRACE


4503 
	`•rötf
(
ty≥
, "%s", "ChrDC");

4505 
d±y≥
 = (
	`is_öåa
 (
cuºMB
)Ë? 
SE_CHR_DC_INTRA
 : 
SE_CHR_DC_INTER
;

4507 
CHROMA_AC
:

4508 
max_c€ff_num
 = 15;

4509 
mb_bôs_c€ff
 = &
cuºMB
->
bôs
.
mb_uv_c€ff
;

4510 
ˇc
 = 1;

4512 
pLevñ
 = 
cuºSli˚
->
cofAC
[
b8
][
b4
][0];

4513 
pRun
 = 
cuºSli˚
->
cofAC
[
b8
][
b4
][1];

4514 #i‡
TRACE


4515 
	`•rötf
(
ty≥
, "%s", "ChrAC");

4517 
d±y≥
 = (
	`is_öåa
 (
cuºMB
)Ë? 
SE_CHR_AC_INTRA
 : 
SE_CHR_AC_INTER
;

4520 
	`îr‹
("writeCoeff4x4_CAVLC: Invalid blockÅype", 600);

4524 
d©aP¨t
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
d±y≥
]]);

4526 
k
 = 0; (k <((
cdc
Ë? 
p_Vid
->
num_cdc_c€ff
 : 16)Ë&& 
Àvñ
 != 0; k++)

4528 
Àvñ
 = 
pLevñ
[
k
];

4529 
run
 = 
pRun
[
k
];

4531 i‡(
Àvñ
)

4534 
tŸzîos
 +
run
;

4535 i‡(
	`übs
(
Àvñ
) == 1)

4537 
num⁄es
 ++;

4538 
numåaûög⁄es
 ++;

4539 
numåaûög⁄es
 = 
	`imö
(numtrailingones, 3);

4543 
numåaûög⁄es
 = 0;

4545 
numc€ff
 ++;

4546 
œ°c€ff
 = 
k
;

4550 i‡(!
cdc
)

4552 if(
block_ty≥
==
LUMA
 || block_ty≥==
LUMA_INTRA16x16DC
 || block_ty≥==
LUMA_INTRA16x16AC


4553 ||
block_ty≥
==
CHROMA_AC
)

4555 i‡(!
ˇc
)

4558 
subblock_x
 = ((
b8
 & 0x1Ë=0Ë? (((
b4
 & 0x1) == 0) ? 0 : 1) : (((b4 & 0x1) == 0) ? 2 : 3);

4560 
subblock_y
 = (
b8
 < 2Ë? ((
b4
 < 2) ? 0 : 1) : ((b4 < 2) ? 2 : 3);

4562 
¬z
 = 
	`¥edi˘_¬z
(
cuºMB
, 
LUMA
, 
subblock_x
,
subblock_y
);

4567 
subblock_x
 = 
∑øm
 >> 4;

4568 
subblock_y
 = 
∑øm
 & 15;

4569 
¬z
 = 
	`¥edi˘_¬z_chroma
(
cuºMB
, 
subblock_x
, 
subblock_y
);

4571 
p_Vid
->
nz_c€ff
 [
cuºMB
->
mbAddrX
 ][
subblock_x
][
subblock_y
] = 
numc€ff
;

4573 i‡(
block_ty≥
==
CB
 || block_ty≥==
CB_INTRA16x16DC


4574 || 
block_ty≥
==
CB_INTRA16x16AC
)

4576 
subblock_x
 = ((
b8
 & 0x1Ë=0)?(((
b4
 & 0x1) == 0) ? 0 : 1):(((b4 & 0x1) == 0) ? 2 : 3);

4578 
subblock_y
 = (
b8
 < 2Ë? ((
b4
 < 2) ? 0 : 1) : ((b4 < 2) ? 2 : 3);

4580 
¬z
 = 
	`¥edi˘_¬z
(
cuºMB
, 
CB
, 
subblock_x
,
subblock_y
);

4581 
p_Vid
->
nz_c€ff
 [
cuºMB
->
mbAddrX
 ][
subblock_x
][4+
subblock_y
] = 
numc€ff
;

4585 
subblock_x
 = ((
b8
 & 0x1Ë=0)?(((
b4
 & 0x1) == 0) ? 0 : 1) : (((b4 & 0x1) == 0) ? 2 : 3);

4587 
subblock_y
 = (
b8
 < 2Ë? ((
b4
 < 2) ? 0 : 1) : ((b4 < 2) ? 2 : 3);

4589 
¬z
 = 
	`¥edi˘_¬z
(
cuºMB
, 
CR
, 
subblock_x
,
subblock_y
);

4590 
p_Vid
->
nz_c€ff
 [
cuºMB
->
mbAddrX
 ][
subblock_x
][8+
subblock_y
] = 
numc€ff
;

4593 
numc€ff_vlc
 = (
¬z
 < 2) ? 0 : ((nnz < 4) ? 1 : ((nnz < 8) ? 2 : 3));

4599 
numc€ff_vlc
 = 0;

4601 
subblock_x
 = 
∑øm
;

4602 
subblock_y
 = 
∑øm
;

4605 
£
.
ty≥
 = 
d±y≥
;

4607 
£
.
vÆue1
 = 
numc€ff
;

4608 
£
.
vÆue2
 = 
numåaûög⁄es
;

4609 
£
.
Àn
 = 
numc€ff_vlc
;

4611 #i‡
TRACE


4612 
	`¢¥ötf
(
£
.
åa˚°rög
,

4613 
TRACESTRING_SIZE
, "%s # c &År.1s(%d,%d) vlc=%d #c=%d #t1=%d",

4614 
ty≥
, 
subblock_x
, 
subblock_y
, 
numc€ff_vlc
, 
numc€ff
, 
numåaûög⁄es
);

4617 i‡(!
cdc
)

4618 
	`wrôeSy¡axEÀmít_NumC€ffTøûögO√s
(&
£
, 
d©aP¨t
);

4620 
	`wrôeSy¡axEÀmít_NumC€ffTøûögO√sChromaDC
(
p_Vid
, &
£
, 
d©aP¨t
);

4622 *
mb_bôs_c€ff
 +
£
.
Àn
;

4623 
no_bôs
 +
£
.
Àn
;

4625 i‡(!
numc€ff
)

4626  
no_bôs
;

4628 i‡(
numc€ff
)

4630 
code
 = 0;

4631 
k
 = 
œ°c€ff
; k >Üa°c€f‡- 
numåaûög⁄es
; k--)

4633 
Àvñ
 = 
pLevñ
[
k
];

4635 i‡(
	`übs
(
Àvñ
) > 1)

4637 
	`¥ötf
("ERROR:Üevel > 1\n");

4638 
	`exô
(-1);

4641 
code
 <<= 1;

4643 i‡(
Àvñ
 < 0)

4645 
code
 |= 0x1;

4649 i‡(
numåaûög⁄es
)

4651 
£
.
ty≥
 = 
d±y≥
;

4653 
£
.
vÆue2
 = 
numåaûög⁄es
;

4654 
£
.
vÆue1
 = 
code
;

4656 #i‡
TRACE


4657 
	`¢¥ötf
(
£
.
åa˚°rög
,

4658 
TRACESTRING_SIZE
, "%sÅrailing ones sign (%d,%d)",

4659 
ty≥
, 
subblock_x
, 
subblock_y
);

4662 
	`wrôeSy¡axEÀmít_VLC
 (&
£
, 
d©aP¨t
);

4663 *
mb_bôs_c€ff
 +
£
.
Àn
;

4664 
no_bôs
 +
£
.
Àn
;

4669 
Àvñ_two_‹_highî
 = (
numc€ff
 > 3 && 
numåaûög⁄es
 == 3) ? 0 : 1;

4671 
vl˙um
 = (
numc€ff
 > 10 && 
numåaûög⁄es
 < 3) ? 1 : 0;

4673 
k
 = 
œ°c€ff
 - 
numåaûög⁄es
; k >= 0; k--)

4675 
Àvñ
 = 
pLevñ
[
k
];

4677 
£
.
vÆue1
 = 
Àvñ
;

4678 
£
.
ty≥
 = 
d±y≥
;

4680 #i‡
TRACE


4681 
	`¢¥ötf
(
£
.
åa˚°rög
,

4682 
TRACESTRING_SIZE
, "%sÜev (%d,%d) k=%d vlc=%dÜev=%3d",

4683 
ty≥
, 
subblock_x
, 
subblock_y
, 
k
, 
vl˙um
, 
Àvñ
);

4686 i‡(
Àvñ_two_‹_highî
)

4688 
Àvñ_two_‹_highî
 = 0;

4690 i‡(
£
.
vÆue1
 > 0)

4691 
£
.
vÆue1
 --;

4693 
£
.
vÆue1
 ++;

4698 i‡(
vl˙um
 == 0)

4699 
	`wrôeSy¡axEÀmít_Levñ_VLC1
(&
£
, 
d©aP¨t
, 
p_Vid
->
a˘ive_•s
->
¥ofûe_idc
);

4701 
	`wrôeSy¡axEÀmít_Levñ_VLCN
(&
£
, 
vl˙um
, 
d©aP¨t
, 
p_Vid
->
a˘ive_•s
->
¥ofûe_idc
);

4704 i‡(
	`übs
(
Àvñ
Ë> 
öcVlc
[
vl˙um
])

4705 
vl˙um
++;

4707 i‡((
k
 =
œ°c€ff
 - 
numåaûög⁄es
Ë&& 
	`übs
(
Àvñ
) > 3)

4708 
vl˙um
 = 2;

4710 *
mb_bôs_c€ff
 +
£
.
Àn
;

4711 
no_bôs
 +
£
.
Àn
;

4715 i‡(
numc€ff
 < 
max_c€ff_num
)

4718 
£
.
ty≥
 = 
d±y≥
;

4719 
£
.
vÆue1
 = 
tŸzîos
;

4721 
vl˙um
 = 
numc€ff
 - 1;

4723 
£
.
Àn
 = 
vl˙um
;

4725 #i‡
TRACE


4726 
	`¢¥ötf
(
£
.
åa˚°rög
,

4727 
TRACESTRING_SIZE
, "%sÅotalrun (%d,%d) vlc=%dÅotzeros=%3d",

4728 
ty≥
, 
subblock_x
, 
subblock_y
, 
vl˙um
, 
tŸzîos
);

4730 i‡(!
cdc
)

4731 
	`wrôeSy¡axEÀmít_TŸÆZîos
(&
£
, 
d©aP¨t
);

4733 
	`wrôeSy¡axEÀmít_TŸÆZîosChromaDC
(
p_Vid
, &
£
, 
d©aP¨t
);

4735 *
mb_bôs_c€ff
 +
£
.
Àn
;

4736 
no_bôs
 +
£
.
Àn
;

4740 
zîo¶e·
 = 
tŸzîos
;

4741 
numc€f
 = 
numc€ff
;

4742 
k
 = 
œ°c€ff
; k >= 0; k--)

4744 
run
 = 
pRun
[
k
];

4746 
£
.
vÆue1
 = 
run
;

4747 
£
.
ty≥
 = 
d±y≥
;

4751 i‡((!
zîo¶e·
Ë|| (
numc€ff
 <= 1 ))

4754 i‡(
numc€f
 > 1 && 
zîo¶e·
)

4756 
vl˙um
 = 
	`imö
(
zîo¶e·
 - 1, 
RUNBEFORE_NUM_M1
);

4757 
£
.
Àn
 = 
vl˙um
;

4759 #i‡
TRACE


4760 
	`¢¥ötf
(
£
.
åa˚°rög
,

4761 
TRACESTRING_SIZE
, "%sÑun (%d,%d) k=%d vlc=%dÑun=%2d",

4762 
ty≥
, 
subblock_x
, 
subblock_y
, 
k
, 
vl˙um
, 
run
);

4765 
	`wrôeSy¡axEÀmít_Run
(&
£
, 
d©aP¨t
);

4767 *
mb_bôs_c€ff
 +
£
.
Àn
;

4768 
no_bôs
 +
£
.
Àn
;

4770 
zîo¶e·
 -
run
;

4771 
numc€f
 --;

4776  
no_bôs
;

4777 
	}
}

4786 
	$ch™ge_∂™e_JV
–
VideoP¨amëîs
 *
p_Vid
, 
≈œ√
 )

4788 
p_Vid
->
cﬁour_∂™e_id
 = (Ë
≈œ√
;

4789 
p_Vid
->
mb_d©a
 =Ö_Vid->
mb_d©a_JV
[
≈œ√
];

4790 
p_Vid
->
íc_pi˘uª
 =Ö_Vid->
íc_‰ame_pi˘uª_JV
[
≈œ√
];

4791 
p_Vid
->
pCurImg
 =Ö_Vid->
imgD©a
.
‰m_d©a
[
≈œ√
];

4792 
	}
}

4799 
	$make_‰ame_pi˘uª_JV
(
VideoP¨amëîs
 *
p_Vid
)

4801 
uv
, 
löe
;

4802 
nsize
;

4804 
p_Vid
->
íc_‰ame_pi˘uª
[0] =Ö_Vid->
íc_‰ame_pi˘uª_JV
[0];

4807 if(
p_Vid
->
cuºítSli˚
->
«l_ª„ªn˚_idc
)

4809 
nsize
 = (
p_Vid
->
íc_‰ame_pi˘uª_JV
[0]->
size_y
/
BLOCK_SIZE
)*’_Vid->íc_‰ame_pi˘uª_JV[0]->
size_x
/BLOCK_SIZE)*(
PicMŸi⁄P¨ams
);

4810 
	`mem˝y
–&(
p_Vid
->
íc_‰ame_pi˘uª
[0]->
JVmv_öfo
[
PLANE_Y
][0][0]), &’_Vid->
íc_‰ame_pi˘uª_JV
[PLANE_Y]->
mv_öfo
[0][0]), 
nsize
);

4811 
	`mem˝y
–&(
p_Vid
->
íc_‰ame_pi˘uª
[0]->
JVmv_öfo
[
PLANE_U
][0][0]), &’_Vid->
íc_‰ame_pi˘uª_JV
[PLANE_U]->
mv_öfo
[0][0]), 
nsize
);

4812 
	`mem˝y
–&(
p_Vid
->
íc_‰ame_pi˘uª
[0]->
JVmv_öfo
[
PLANE_V
][0][0]), &’_Vid->
íc_‰ame_pi˘uª_JV
[PLANE_V]->
mv_öfo
[0][0]), 
nsize
);

4815  
uv
=0; uv<2; uv++ )

4817  
löe
=0;Üöe<
p_Vid
->
height
;Üine++ )

4819 
nsize
 = (
img≥l
Ë* 
p_Vid
->
width
;

4820 
	`mem˝y
–
p_Vid
->
íc_‰ame_pi˘uª
[0]->
imgUV
[
uv
][
löe
],Ö_Vid->
íc_‰ame_pi˘uª_JV
[uv+1]->
imgY
[löe], 
nsize
 );

4822 
	`‰ì_°‹abÀ_pi˘uª
(
p_Vid
,Ö_Vid->
íc_‰ame_pi˘uª_JV
[
uv
+1]);

4825 
	}
}

4827 
Ma¸oblock
 *
	$Æloc_mbs
(
VideoP¨amëîs
 *
p_Vid
, 
mb_num
, 
œyîs
)

4829 
i
, 
j
;

4830 
Ma¸oblock
 *
pMBs
 = (Ma¸oblock *)
	`ˇŒoc
(
mb_num
, (Ma¸oblock)), *
pMB
;

4831 if(!
pMBs
)

4832  
NULL
;

4833 
i
=0; i<
mb_num
; i++)

4835 
pMB
 = 
pMBs
+
i
;

4836 
j
=0; j<2; j++)

4838 
	`gë_mem2D≥l
(&
pMB
->
öåa4x4_¥ed_buf
[
j
], 3, 17);

4839 
	`gë_mem2D≥l
(&
pMB
->
öåa8x8_¥ed_buf
[
j
], 3, 25);

4840 
	`gë_mem2D≥l
(&
pMB
->
öåa16x16_¥ed_buf
[
j
], 3, 33);

4842 
pMB
->
öåa4x4_¥ed
 =ÖMB->
öåa4x4_¥ed_buf
[0];

4843 
pMB
->
öåa8x8_¥ed
 =ÖMB->
öåa8x8_¥ed_buf
[0];

4844 
pMB
->
öåa16x16_¥ed
 =ÖMB->
öåa16x16_¥ed_buf
[0];

4846  
pMBs
;

4847 
	}
}

4849 
	$£tup_mbs
(
Ma¸oblock
 *
pMBs
, 
mb_num
, 
œyî_id
)

4851 
i
;

4852 
Ma¸oblock
 *
pMB
;

4853 
i
=0; i<
mb_num
; i++)

4855 
pMB
 = 
pMBs
+
i
;

4856 
pMB
->
öåa4x4_¥ed
 =ÖMB->
öåa4x4_¥ed_buf
[
œyî_id
];

4857 
pMB
->
öåa8x8_¥ed
 =ÖMB->
öåa8x8_¥ed_buf
[
œyî_id
];

4858 
pMB
->
öåa16x16_¥ed
 =ÖMB->
öåa16x16_¥ed_buf
[
œyî_id
];

4860 
	}
}

4862 
	$‰ì_mbs
(
Ma¸oblock
 *
pMBs
, 
mb_num
)

4864 
i
, 
j
;

4865 
Ma¸oblock
 *
pMB
;

4866 if(!
pMBs
)

4868 
i
=0; i<
mb_num
; i++)

4870 
pMB
 = 
pMBs
+
i
;

4871 
j
=0; j<2; j++)

4873 
	`‰ì_mem2D≥l
(
pMB
->
öåa4x4_¥ed_buf
[
j
]);

4874 
	`‰ì_mem2D≥l
(
pMB
->
öåa8x8_¥ed_buf
[
j
]);

4875 
	`‰ì_mem2D≥l
(
pMB
->
öåa16x16_¥ed_buf
[
j
]);

4877 
pMB
->
öåa4x4_¥ed
 = 
NULL
;

4878 
pMB
->
öåa8x8_¥ed
 = 
NULL
;

4879 
pMB
->
öåa16x16_¥ed
 = 
NULL
;

4881 
	`‰ì
(
pMBs
);

4882 
	}
}

	@lencod/src/macroblock_P444.c

14 
	~"c⁄åibut‹s.h
"

15 
	~"globÆ.h
"

16 
	~"blk_¥edi˘i⁄.h
"

17 
	~"mc_¥edi˘i⁄.h
"

18 
	~"md_comm⁄.h
"

19 
	~"rd›t.h
"

20 
	~"ma¸oblock.h
"

32 
	$luma_ªsiduÆ_codög_p444_16x16
 (
Ma¸oblock
* 
cuºMB
,

33 
block8x8
,

34 
p_dú
,

35 
li°_mode
[2],

36 *
ªf_idx
)

39 *
cbp
 = &(
cuºMB
->cbp);

40 
öt64
 *
cbp_blk
 = &(
cuºMB
->cbp_blk);

41 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

42 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

43 
DecodedPi˘uªBuf„r
 *
p_Dpb
 = 
p_Vid
->
p_Dpb_œyî
[p_Vid->
dpb_œyî_id
];

44 
i
, 
j
, 
n⁄zîo
 = 0, 
cbp_blk_mask
;

45 
c€ff_co°
 = 0;

46 
mb_y
 = (
block8x8
 >> 1) << 3;

47 
mb_x
 = (
block8x8
 & 0x01) << 3;

48 
cbp_mask
 = 1 << 
block8x8
;

50 
skù≥d
 = (
li°_mode
[0] =0 &&Üi°_mode[1] =0 && (
cuºSli˚
->
¶i˚_ty≥
 !
B_SLICE
));

51 
Cﬁ‹Pœ√
 
uv
;

53 
bùªd_me
 = 
cuºMB
->
b8x8
[
block8x8
].
bùªd
;

54 
cuºSli˚
->
c€ff_co°_¸
[1] = currSlice->coeff_cost_cr[2] = 0;

59 
p_Dpb
->
	`pf_luma_¥edi˘i⁄
 (
cuºMB
, 
mb_x
, 
mb_y
, 8, 8, 
p_dú
, 
li°_mode
, 
ªf_idx
, 
bùªd_me
);

62 
	`compuã_ªsidue
 (&
p_Vid
->
pCurImg
[
cuºMB
->
›ix_y
 + 
mb_y
], &
cuºSli˚
->
mb_¥ed
[0][mb_y], &cuºSli˚->
mb_‹es
[0][mb_y], 
mb_x
, cuºMB->
pix_x
 + mb_x, 8, 8);

64 
uv
 = 
PLANE_U
; uv <
PLANE_V
; ++uv)

66 
	`£À˘_∂™e
(
p_Vid
, 
uv
);

67 
p_Dpb
->
	`pf_chroma_¥edi˘i⁄
 (
cuºMB
, 
uv
 - 1, 
mb_x
, 
mb_y
, 8, 8, 
p_dú
, 
li°_mode
[0],Üi°_mode[1], 
ªf_idx
[0],Ñef_idx[1], 
bùªd_me
);

70 
	`compuã_ªsidue
(&
p_Vid
->
pImgOrg
[
uv
][
cuºMB
->
›ix_y
 + 
mb_y
], &
cuºSli˚
->
mb_¥ed
[uv][mb_y], &cuºSli˚->
mb_‹es
[uv][mb_y], 
mb_x
, cuºMB->
pix_x
 + mb_x, 8, 8);

72 
	`£À˘_∂™e
(
p_Vid
, 
PLANE_Y
);

75 if(!
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
)

78 i‡(!
skù≥d
 && ( (
cuºSli˚
->
NoResidueDúe˘
 !1Ë|| (
cuºMB
->
qp_sˇÀd
[0] =0 && 
p_Vid
->
a˘ive_•s
->
los¶ess_qµrime_Êag
 == 1) ))

80 
block_y
, 
block_x
;

82 
block_y
=
mb_y
; block_y<mb_y + 8; block_y += 4)

84 
block_x
=
mb_x
; block_x<mb_x + 8; block_x += 4)

87 
n⁄zîo
 = 
cuºMB
->
	`ªsiduÆ_å™sf‹m_qu™t_luma_4x4
 (cuºMB, 
PLANE_Y
, 
block_x
, 
block_y
, &
c€ff_co°
, 0);

89 i‡(
n⁄zîo
)

91 
cbp_blk_mask
 = (
block_x
 >> 2Ë+ 
block_y
;

92 (*
cbp_blk
Ë|(
öt64
Ë1 << 
cbp_blk_mask
;

93 (*
cbp
Ë|
cbp_mask
;

96 i‡(
cuºSli˚
->
¶i˚_ty≥
 !
SP_SLICE
 && cuºSli˚->¶i˚_ty≥ !
SI_SLICE
)

98 
uv
 = 
PLANE_U
; uv <
PLANE_V
; ++uv)

100 
	`£À˘_∂™e
(
p_Vid
, (
Cﬁ‹Pœ√
Ë
uv
);

101 
n⁄zîo
 = 
cuºMB
->
	`ªsiduÆ_å™sf‹m_qu™t_luma_4x4
–cuºMB, (
Cﬁ‹Pœ√
Ë
uv
, 
block_x
, 
block_y
, &
cuºSli˚
->
c€ff_co°_¸
[uv], 0);

102 i‡(
n⁄zîo
)

104 
cbp_blk_mask
 = (
block_x
 >> 2Ë+ 
block_y
;

105 (
cuºSli˚
->
cur_cbp_blk
[
uv
]Ë|(
öt64
Ë1 << 
cbp_blk_mask
;

106 (
cuºSli˚
->
cmp_cbp
[
uv
]Ë|
cbp_mask
;

109 
	`£À˘_∂™e
(
p_Vid
, 
PLANE_Y
);

113 
	`as£π
(
cuºSli˚
->
¶i˚_ty≥
 =
SP_SLICE
 || cuºSli˚->¶i˚_ty≥ =
SI_SLICE
);

121 i‡(
cuºSli˚
->
NoResidueDúe˘
 !1 && !
skù≥d
)

123 i‡(
cuºSli˚
->
¶i˚_ty≥
 !
SP_SLICE
 && cuºSli˚->¶i˚_ty≥ !
SI_SLICE
)

124 
n⁄zîo
 = 
cuºMB
->
	`ªsiduÆ_å™sf‹m_qu™t_luma_8x8
 (cuºMB, 
PLANE_Y
, 
block8x8
, &
c€ff_co°
, 0);

126 i‡(
n⁄zîo
)

128 (*
cbp_blk
Ë|51 << (4*
block8x8
 - 2*(block8x8 & 0x01));

129 (*
cbp
Ë|
cbp_mask
;

132 i‡(
cuºSli˚
->
¶i˚_ty≥
 !
SP_SLICE
 && cuºSli˚->¶i˚_ty≥ !
SI_SLICE
)

134 
uv
 = 
PLANE_U
; uv <
PLANE_V
; ++uv)

136 
	`£À˘_∂™e
(
p_Vid
, (
Cﬁ‹Pœ√
Ë
uv
);

137 
n⁄zîo
 = 
cuºMB
->
	`ªsiduÆ_å™sf‹m_qu™t_luma_8x8
–cuºMB, (
Cﬁ‹Pœ√
Ë
uv
, 
block8x8
, &
cuºSli˚
->
c€ff_co°_¸
[uv], 0);

138 i‡(
n⁄zîo
)

140 (
cuºSli˚
->
cur_cbp_blk
[
uv
]Ë|51 << (4*
block8x8
-2*(block8x8 & 0x01));

141 (
cuºSli˚
->
cmp_cbp
[
uv
]Ë|
cbp_mask
;

144 
	`£À˘_∂™e
(
p_Vid
, 
PLANE_Y
);

149 i‡(
cuºSli˚
->
NoResidueDúe˘
 !1 && !
skù≥d
 && 
c€ff_co°
 <
_LUMA_COEFF_COST_
 &&

150 ((
cuºMB
->
qp_sˇÀd
[0])!=0 || 
p_Vid
->
a˘ive_•s
->
los¶ess_qµrime_Êag
==0)&&

151 !(
cuºSli˚
->
¶i˚_ty≥
 =
SI_SLICE
 || (cuºSli˚->¶i˚_ty≥ =
SP_SLICE
 && 
p_Vid
->
•2_‰ame_ödiˇt‹
 =
TRUE
 )))

154 
c€ff_co°
 = 0;

155 (*
cbp
Ë&(63 - 
cbp_mask
);

156 (*
cbp_blk
Ë&~(51 << (4 * 
block8x8
 - 2 * (block8x8 & 0x01)));

158 
	`mem£t
–
cuºSli˚
->
cofAC
[
block8x8
][0][0], 0, 4 * 2 * 65 * ());

160 
	`c›y_image_d©a_8x8
(&
p_Vid
->
íc_pi˘uª
->
imgY
[
cuºMB
->
pix_y
 + 
mb_y
], &
cuºSli˚
->
mb_¥ed
[0][mb_y], cuºMB->
pix_x
 + 
mb_x
, mb_x);

162 i‡(
cuºSli˚
->
¶i˚_ty≥
 =
SP_SLICE
 || cuºSli˚->¶i˚_ty≥ =
SI_SLICE
)

164 
i
 = 
mb_x
; i < mb_x + 
BLOCK_SIZE_8x8
; i +
BLOCK_SIZE
)

165 
j
 = 
mb_y
; j < mb_y + 
BLOCK_SIZE_8x8
; j +
BLOCK_SIZE
)

166 
	`c›yblock_•
(
cuºMB
, 
PLANE_Y
, 
i
, 
j
);

170 
uv
 = 
PLANE_U
; uv <
PLANE_V
; ++uv)

172 i‡(
cuºSli˚
->
NoResidueDúe˘
 !1 && !
skù≥d
 && cuºSli˚->
c€ff_co°_¸
[
uv
] <
_LUMA_COEFF_COST_
 &&

173 (
cuºMB
->
qp_sˇÀd
[
uv
]!=0 || 
p_Vid
->
a˘ive_•s
->
los¶ess_qµrime_Êag
==0))

175 
cuºSli˚
->
c€ff_co°_¸
[
uv
] = 0;

176 
cuºSli˚
->
cmp_cbp
[
uv
] &(63 - 
cbp_mask
);

177 
cuºSli˚
->
cur_cbp_blk
[
uv
] &~(51 << (4*
block8x8
-2*(block8x8 & 0x01)));

179 
	`mem£t
–
cuºSli˚
->
cofAC
[
block8x8
 + 4 * 
uv
][0][0], 0, 4 * 2 * 65 * ());

181 
	`c›y_image_d©a_8x8
(&
p_Vid
->
íc_pi˘uª
->
imgUV
[
uv
 - 1][
cuºMB
->
pix_y
 + 
mb_y
], &
cuºSli˚
->
mb_¥ed
[uv][mb_y], cuºMB->
pix_x
 + 
mb_x
, mb_x);

185  
c€ff_co°
;

186 
	}
}

198 
	$luma_ªsiduÆ_codög_p444_8x8
 (
Ma¸oblock
* 
cuºMB
,

199 *
cbp
,

200 
öt64
 *
cbp_blk
,

201 
block8x8
,

202 
p_dú
,

203 
li°_mode
[2],

204 *
ªf_idx
)

206 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

207 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

208 
DecodedPi˘uªBuf„r
 *
p_Dpb
 = 
p_Vid
->
p_Dpb_œyî
[p_Vid->
dpb_œyî_id
];

209 
block_y
, 
block_x
, 
pic_pix_x
, 
n⁄zîo
 = 0, 
cbp_blk_mask
;

210 
c€ff_co°
 = 0;

211 
mb_y
 = (
block8x8
 >> 1) << 3;

212 
mb_x
 = (
block8x8
 & 0x01) << 3;

213 
cbp_mask
 = 1 << 
block8x8
;

214 
bxx
, 
byy
;

215 
skù≥d
 = (
li°_mode
[0] =0 &&Üi°_mode[1] =0 && (
cuºSli˚
->
¶i˚_ty≥
 !
B_SLICE
));

216 
Cﬁ‹Pœ√
 
uv
;

218 
bùªd_me
 = 
cuºMB
->
b8x8
[
block8x8
].
bùªd
;

219 
cuºSli˚
->
c€ff_co°_¸
[1] = currSlice->coeff_cost_cr[2] = 0;

224 if(!
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
)

226 i‡(((
p_dú
 =0 ||Ö_dú =2 )&& 
li°_mode
[0] < 5) || ((p_dir == 1 ||Ö_dir == 2 ) &&Üist_mode[1] < 5))

228 
p_Dpb
->
	`pf_luma_¥edi˘i⁄
 (
cuºMB
, 
mb_x
, 
mb_y
, 8, 8, 
p_dú
, 
li°_mode
, 
ªf_idx
, 
bùªd_me
);

231 
	`compuã_ªsidue
 (&
p_Vid
->
pCurImg
[
cuºMB
->
›ix_y
 + 
mb_y
], &
cuºSli˚
->
mb_¥ed
[0][mb_y], &cuºSli˚->
mb_‹es
[0][mb_y], 
mb_x
, cuºMB->
pix_x
 + mb_x, 8, 8);

234 
byy
=0, 
block_y
=
mb_y
; block_y<mb_y+8; byy+=4, block_y+=4)

236 
bxx
=0, 
block_x
=
mb_x
; block_x<mb_x+8; bxx+=4, block_x+=4)

238 
pic_pix_x
 = 
cuºMB
->
pix_x
 + 
block_x
;

239 
cbp_blk_mask
 = (
block_x
 >> 2Ë+ 
block_y
;

242 i‡(!(((
p_dú
 =0 ||Ö_dú =2 )&& 
li°_mode
[0] < 5) || ((p_dir == 1 ||Ö_dir == 2 ) &&Üist_mode[1] < 5)))

244 
p_Dpb
->
	`pf_luma_¥edi˘i⁄
 (
cuºMB
, 
block_x
, 
block_y
, 4, 4, 
p_dú
, 
li°_mode
, 
ªf_idx
, 
bùªd_me
);

247 
	`compuã_ªsidue
(&
p_Vid
->
pCurImg
[
cuºMB
->
›ix_y
 + 
block_y
], &
cuºSli˚
->
mb_¥ed
[0][block_y], &cuºSli˚->
mb_‹es
[0][block_y], 
block_x
, 
pic_pix_x
, 4, 4);

250 
uv
 = 
PLANE_U
; uv <
PLANE_V
; ++uv)

252 
	`£À˘_∂™e
(
p_Vid
, 
uv
);

253 
p_Dpb
->
	`pf_chroma_¥edi˘i⁄
 (
cuºMB
, 
uv
 - 1, 
block_x
, 
block_y
, 4, 4, 
p_dú
, 
li°_mode
[0],Üi°_mode[1], 
ªf_idx
[0],Ñef_idx[1], 
bùªd_me
);

256 
	`compuã_ªsidue
(&
p_Vid
->
pImgOrg
[
uv
][
cuºMB
->
›ix_y
 + 
block_y
], &
cuºSli˚
->
mb_¥ed
[uv][block_y], &cuºSli˚->
mb_‹es
[uv][block_y], 
block_x
, 
pic_pix_x
, 4, 4);

258 
	`£À˘_∂™e
(
p_Vid
, 
PLANE_Y
);

261 i‡(!
skù≥d
 && ( (
cuºSli˚
->
NoResidueDúe˘
 !1Ë|| (
cuºMB
->
qp_sˇÀd
[0] =0 && 
p_Vid
->
a˘ive_•s
->
los¶ess_qµrime_Êag
 == 1) ))

264 
n⁄zîo
 = 
cuºMB
->
	`ªsiduÆ_å™sf‹m_qu™t_luma_4x4
 (cuºMB, 
PLANE_Y
, 
block_x
, 
block_y
, &
c€ff_co°
, 0);

266 i‡(
n⁄zîo
)

268 (*
cbp_blk
Ë|(
öt64
)1 << 
cbp_blk_mask
;

269 (*
cbp
Ë|
cbp_mask
;

272 i‡(
cuºSli˚
->
¶i˚_ty≥
 !
SP_SLICE
 && cuºSli˚->¶i˚_ty≥ !
SI_SLICE
)

274 
uv
 = 
PLANE_U
; uv <
PLANE_V
; ++uv)

276 
	`£À˘_∂™e
(
p_Vid
, (
Cﬁ‹Pœ√
Ë
uv
);

277 
n⁄zîo
 = 
cuºMB
->
	`ªsiduÆ_å™sf‹m_qu™t_luma_4x4
–cuºMB, (
Cﬁ‹Pœ√
Ë
uv
, 
block_x
, 
block_y
, &
cuºSli˚
->
c€ff_co°_¸
[uv], 0);

278 i‡(
n⁄zîo
)

280 (
cuºSli˚
->
cur_cbp_blk
[
uv
]Ë|(
öt64
Ë1 << 
cbp_blk_mask
;

281 (
cuºSli˚
->
cmp_cbp
[
uv
]Ë|
cbp_mask
;

284 
	`£À˘_∂™e
(
p_Vid
, 
PLANE_Y
);

288 
	`as£π
(
cuºSli˚
->
¶i˚_ty≥
 =
SP_SLICE
 || cuºSli˚->¶i˚_ty≥ =
SI_SLICE
);

296 
block_y
 = 
mb_y
;

297 
block_x
 = 
mb_x
;

299 
pic_pix_x
 = 
cuºMB
->
pix_x
 + 
block_x
;

301 
cbp_blk_mask
 = (
block_x
>>2Ë+ 
block_y
;

304 
p_Dpb
->
	`pf_luma_¥edi˘i⁄
 (
cuºMB
, 
block_x
, 
block_y
, 8, 8, 
p_dú
, 
li°_mode
, 
ªf_idx
, 
bùªd_me
);

307 
	`compuã_ªsidue
 (&
p_Vid
->
pCurImg
[
cuºMB
->
›ix_y
 + 
block_y
], &
cuºSli˚
->
mb_¥ed
[0][block_y], &cuºSli˚->
mb_‹es
[0][block_y], 
block_x
, 
pic_pix_x
, 8, 8);

309 
uv
 = 
PLANE_U
; uv <
PLANE_V
; ++uv)

311 
	`£À˘_∂™e
(
p_Vid
, (
Cﬁ‹Pœ√
Ë
uv
);

312 
p_Dpb
->
	`pf_chroma_¥edi˘i⁄
 (
cuºMB
, 
uv
 - 1, 
block_x
, 
block_y
, 8, 8, 
p_dú
, 
li°_mode
[0],Üi°_mode[1], 
ªf_idx
[0],Ñef_idx[1], 
bùªd_me
);

315 
	`compuã_ªsidue
 (&
p_Vid
->
pImgOrg
[
uv
][
cuºMB
->
›ix_y
 + 
block_y
], &
cuºSli˚
->
mb_¥ed
[uv][block_y], &cuºSli˚->
mb_‹es
[uv][block_y], 
block_x
, 
pic_pix_x
, 8, 8);

317 
	`£À˘_∂™e
(
p_Vid
, 
PLANE_Y
);

319 i‡(
cuºSli˚
->
NoResidueDúe˘
 !1 && !
skù≥d
)

321 i‡(
cuºSli˚
->
¶i˚_ty≥
 !
SP_SLICE
 && cuºSli˚->¶i˚_ty≥ !
SI_SLICE
)

322 
n⁄zîo
 = 
cuºMB
->
	`ªsiduÆ_å™sf‹m_qu™t_luma_8x8
 (cuºMB, 
PLANE_Y
, 
block8x8
, &
c€ff_co°
, 0);

324 i‡(
n⁄zîo
)

326 (*
cbp_blk
Ë|51 << (4*
block8x8
 - 2*(block8x8 & 0x01));

327 (*
cbp
Ë|
cbp_mask
;

330 i‡(
cuºSli˚
->
¶i˚_ty≥
 !
SP_SLICE
 && cuºSli˚->¶i˚_ty≥ !
SI_SLICE
)

332 
uv
 = 
PLANE_U
; uv <
PLANE_V
; ++uv)

334 
	`£À˘_∂™e
(
p_Vid
, (
Cﬁ‹Pœ√
Ë
uv
);

335 
n⁄zîo
 = 
cuºMB
->
	`ªsiduÆ_å™sf‹m_qu™t_luma_8x8
–cuºMB, (
Cﬁ‹Pœ√
Ë
uv
, 
block8x8
, &
cuºSli˚
->
c€ff_co°_¸
[uv], 0);

336 i‡(
n⁄zîo
)

338 (
cuºSli˚
->
cur_cbp_blk
[
uv
]Ë|51 << (4*
block8x8
-2*(block8x8 & 0x01));

339 (
cuºSli˚
->
cmp_cbp
[
uv
]Ë|
cbp_mask
;

342 
	`£À˘_∂™e
(
p_Vid
, 
PLANE_Y
);

347 i‡(
cuºSli˚
->
NoResidueDúe˘
 !1 && !
skù≥d
 && 
c€ff_co°
 <
_LUMA_COEFF_COST_
 &&

348 ((
cuºMB
->
qp_sˇÀd
[0])!=0 || 
p_Vid
->
a˘ive_•s
->
los¶ess_qµrime_Êag
==0)&&

349 !(
cuºSli˚
->
¶i˚_ty≥
 =
SI_SLICE
 || (cuºSli˚->¶i˚_ty≥ =
SP_SLICE
 && 
p_Vid
->
•2_‰ame_ödiˇt‹
 =
TRUE
 )))

352 
c€ff_co°
 = 
	`ª£t_block
(
cuºMB
, 
cbp
, 
cbp_blk
, 
block8x8
);

355 
uv
 = 
PLANE_U
; uv <
PLANE_V
; ++uv)

357 i‡(
cuºSli˚
->
NoResidueDúe˘
 !1 && !
skù≥d
 && cuºSli˚->
c€ff_co°_¸
[
uv
] <
_LUMA_COEFF_COST_
 &&

358 (
cuºMB
->
qp_sˇÀd
[
uv
]!=0 || 
p_Vid
->
a˘ive_•s
->
los¶ess_qµrime_Êag
==0))

360 
cuºSli˚
->
c€ff_co°_¸
[
uv
] = 0;

361 
cuºSli˚
->
cmp_cbp
[
uv
] &(63 - 
cbp_mask
);

362 
cuºSli˚
->
cur_cbp_blk
[
uv
] &~(51 << (4*
block8x8
-2*(block8x8 & 0x01)));

364 
	`mem£t
–
cuºSli˚
->
cofAC
[
block8x8
 + 4 * 
uv
][0][0], 0, 4 * 2 * 65 * ());

366 
	`c›y_image_d©a_8x8
(&
p_Vid
->
íc_pi˘uª
->
imgUV
[
uv
 - 1][
cuºMB
->
pix_y
 + 
mb_y
], &
cuºSli˚
->
mb_¥ed
[uv][mb_y], cuºMB->
pix_x
 + 
mb_x
, mb_x);

370  
c€ff_co°
;

371 
	}
}

380 
	$luma_ªsiduÆ_codög_p444
 (
Ma¸oblock
 *
cuºMB
)

382 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

383 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

385 
uv
, 
i
,
j
,
block8x8
,
b8_x
,
b8_y
;

386 
li°_mode
[2];

387 
li°_ªf_idx
[2];

388 
p_dú
;

389 
sum_˙t_n⁄z
[3] = {0 ,0, 0};

390 
is_skù
 = 
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
 && 
cuºMB
->
mb_ty≥
 =
PSKIP
;

392 
cuºMB
->
cbp
 = 0;

393 
cuºMB
->
cbp_blk
 = 0;

394 
cuºSli˚
->
cmp_cbp
[1] = currSlice->cmp_cbp[2] = 0;

395 
cuºSli˚
->
cur_cbp_blk
[1] = currSlice->cur_cbp_blk[2] = 0;

397 i‡(
is_skù
 || 
cuºMB
->
mb_ty≥
 == 1)

400 
block8x8
=0; block8x8<4; ++block8x8)

402 
cuºSli˚
->
	`£t_modes_™d_ª‰ame
 (
cuºMB
, 
block8x8
, &
p_dú
, 
li°_mode
, 
li°_ªf_idx
);

404 
sum_˙t_n⁄z
[0] +
	`luma_ªsiduÆ_codög_p444_16x16
 (
cuºMB
, 
block8x8
, 
p_dú
, 
li°_mode
, 
li°_ªf_idx
);

405 
sum_˙t_n⁄z
[1] +
cuºSli˚
->
c€ff_co°_¸
[1];

406 
sum_˙t_n⁄z
[2] +
cuºSli˚
->
c€ff_co°_¸
[2];

411 
block8x8
=0; block8x8<4; ++block8x8)

413 
cuºSli˚
->
	`£t_modes_™d_ª‰ame
 (
cuºMB
, 
block8x8
, &
p_dú
, 
li°_mode
, 
li°_ªf_idx
);

415 
sum_˙t_n⁄z
[0] +
	`luma_ªsiduÆ_codög_p444_8x8
 (
cuºMB
, &(cuºMB->
cbp
), &(cuºMB->
cbp_blk
), 
block8x8
, 
p_dú
, 
li°_mode
, 
li°_ªf_idx
);

417 if(
p_Vid
->
P444_joöed
)

419 
sum_˙t_n⁄z
[1] +
cuºSli˚
->
c€ff_co°_¸
[1];

420 
sum_˙t_n⁄z
[2] +
cuºSli˚
->
c€ff_co°_¸
[2];

425 i‡((
is_skù
 ||

426 (
sum_˙t_n⁄z
[0] <
_LUMA_MB_COEFF_COST_
 && ((
cuºMB
->
qp_sˇÀd
[0])!=0 || 
p_Vid
->
a˘ive_•s
->
los¶ess_qµrime_Êag
==0))) &&

427 !(
cuºSli˚
->
¶i˚_ty≥
 =
SI_SLICE
 || (cuºSli˚->¶i˚_ty≥ =
SP_SLICE
 && 
p_Vid
->
•2_‰ame_ödiˇt‹
 =
TRUE
 )))

430 
cuºMB
->
cbp
 &= 0xfffff0 ;

431 
cuºMB
->
cbp_blk
 &= 0xff0000 ;

433 
	`c›y_image_d©a_16x16
(&
p_Vid
->
íc_pi˘uª
->
imgY
[
cuºMB
->
pix_y
], 
cuºSli˚
->
mb_¥ed
[0], cuºMB->
pix_x
, 0);

435 
	`mem£t
–
cuºSli˚
->
cofAC
[0][0][0], 0, 2080 * ());

437 i‡(
cuºSli˚
->
¶i˚_ty≥
 =
SP_SLICE
 || cuºSli˚->¶i˚_ty≥ =
SI_SLICE
)

439 
block8x8
=0;block8x8<4; ++block8x8)

441 
b8_x
=(
block8x8
&1)<<3;

442 
b8_y
=(
block8x8
&2)<<2;

443 
i
 = 
b8_x
; i < b8_x + 
BLOCK_SIZE_8x8
; i += 4)

444 
j
 = 
b8_y
; j < b8_y + 
BLOCK_SIZE_8x8
;j += 4)

445 
	`c›yblock_•
(
cuºMB
, 
PLANE_Y
, 
i
, 
j
);

450 
uv
 = 
PLANE_U
; uv <
PLANE_V
; ++uv)

452 if(
is_skù
 || (
sum_˙t_n⁄z
[
uv
] <
_LUMA_MB_COEFF_COST_
 &&

453 ((
cuºMB
->
qp_sˇÀd
[
uv
])!=0 ||
p_Vid
->
a˘ive_•s
->
los¶ess_qµrime_Êag
==0)))

455 
cuºSli˚
->
cmp_cbp
[
uv
] &= 0xfffff0 ;

456 
cuºSli˚
->
cur_cbp_blk
[
uv
] &= 0xff0000 ;

458 
	`c›y_image_d©a_16x16
(&
p_Vid
->
íc_pi˘uª
->
p_img
[
uv
][
cuºMB
->
pix_y
], 
cuºSli˚
->
mb_¥ed
[uv], cuºMB->
pix_x
, 0);

460 
	`mem£t
–
cuºSli˚
->
cofAC
[4 * 
uv
][0][0], 0, 2080 * ());

462 
cuºMB
->
cbp
 |
cuºSli˚
->
cmp_cbp
[
uv
];

464 
	}
}

	@lencod/src/mb_access.c

15 
	~"globÆ.h
"

16 
	~"mb_ac˚ss.h
"

24 
Boﬁón
 
	$mb_is_avaûabÀ
(
mbAddr
, 
Ma¸oblock
 *
cuºMB
)

26 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

27 i‡((
mbAddr
 < 0Ë|| (mbAdd∏> (()
p_Vid
->
PicSizeInMbs
 - 1)))

28  
FALSE
;

31 i‡(!
cuºMB
->
DeblockCÆl
)

33 i‡(
p_Vid
->
mb_d©a
[
mbAddr
].
¶i˚_ƒ
 !
cuºMB
->slice_nr)

34  
FALSE
;

37  
TRUE
;

38 
	}
}

48 
	$CheckAvaûabûôyOfNeighb‹s
(
Ma¸oblock
 *
cuºMB
)

50 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

51 c⁄° 
mb_ƒ
 = 
cuºMB
->
mbAddrX
;

52 
BlockPos
 *
PicPos
 = 
p_Vid
->PicPos;

55 
cuºMB
->
mb_up
 = 
NULL
;

56 
cuºMB
->
mb_À·
 = 
NULL
;

58 i‡(
p_Vid
->
mb_aff_‰ame_Êag
)

60 
cur_mb_∑ú
 = 
mb_ƒ
 >> 1;

61 
cuºMB
->
mbAddrA
 = 2 * (
cur_mb_∑ú
 - 1);

62 
cuºMB
->
mbAddrB
 = 2 * (
cur_mb_∑ú
 - 
p_Vid
->
PicWidthInMbs
);

63 
cuºMB
->
mbAddrC
 = 2 * (
cur_mb_∑ú
 - 
p_Vid
->
PicWidthInMbs
 + 1);

64 
cuºMB
->
mbAddrD
 = 2 * (
cur_mb_∑ú
 - 
p_Vid
->
PicWidthInMbs
 - 1);

66 
cuºMB
->
mbAvaûA
 = (
byã
Ë(
	`mb_is_avaûabÀ
(cuºMB->
mbAddrA
, cuºMBË&& ((
PicPos
[
cur_mb_∑ú
 ].
x
)!=0));

67 
cuºMB
->
mbAvaûB
 = (
byã
Ë(
	`mb_is_avaûabÀ
(cuºMB->
mbAddrB
, currMB));

68 
cuºMB
->
mbAvaûC
 = (
byã
Ë(
	`mb_is_avaûabÀ
(cuºMB->
mbAddrC
, cuºMBË&& ((
PicPos
[
cur_mb_∑ú
 + 1].
x
)!=0));

69 
cuºMB
->
mbAvaûD
 = (
byã
Ë(
	`mb_is_avaûabÀ
(cuºMB->
mbAddrD
, cuºMBË&& ((
PicPos
[
cur_mb_∑ú
 ].
x
)!=0));

73 
cuºMB
->
mbAddrA
 = 
mb_ƒ
 - 1;

74 
cuºMB
->
mbAddrB
 = 
mb_ƒ
 - 
p_Vid
->
PicWidthInMbs
;

75 
cuºMB
->
mbAddrC
 = 
mb_ƒ
 - 
p_Vid
->
PicWidthInMbs
 + 1;

76 
cuºMB
->
mbAddrD
 = 
mb_ƒ
 - 
p_Vid
->
PicWidthInMbs
 - 1;

78 
cuºMB
->
mbAvaûA
 = (
byã
Ë(
	`mb_is_avaûabÀ
(cuºMB->
mbAddrA
, cuºMBË&& ((
PicPos
[
mb_ƒ
 ].
x
)!=0));

79 
cuºMB
->
mbAvaûB
 = (
byã
Ë(
	`mb_is_avaûabÀ
(cuºMB->
mbAddrB
, currMB));

80 
cuºMB
->
mbAvaûC
 = (
byã
Ë(
	`mb_is_avaûabÀ
(cuºMB->
mbAddrC
, cuºMBË&& ((
PicPos
[
mb_ƒ
 + 1].
x
)!=0));

81 
cuºMB
->
mbAvaûD
 = (
byã
Ë(
	`mb_is_avaûabÀ
(cuºMB->
mbAddrD
, cuºMBË&& ((
PicPos
[
mb_ƒ
 ].
x
)!=0));

84 i‡(
cuºMB
->
mbAvaûA
ËcuºMB->
mb_À·
 = &(
p_Vid
->
mb_d©a
[cuºMB->
mbAddrA
]);

85 i‡(
cuºMB
->
mbAvaûB
ËcuºMB->
mb_up
 = &(
p_Vid
->
mb_d©a
[cuºMB->
mbAddrB
]);

86 
	}
}

95 
	$gë_mb_block_pos_n‹mÆ
 (
BlockPos
 *
PicPos
, 
mb_addr
, *
x
, *
y
)

97 *
x
 = (Ë
PicPos
[ 
mb_addr
 ].x;

98 *
y
 = (Ë
PicPos
[ 
mb_addr
 ].y;

99 
	}
}

108 
	$gë_mb_block_pos_mbaff
 (
BlockPos
 *
PicPos
, 
mb_addr
, *
x
, *
y
)

110 *
x
 = (Ë
PicPos
[
mb_addr
>>1].x;

111 *
y
 = (Ë((
PicPos
[
mb_addr
>>1].y << 1) + (mb_addr & 0x01));

112 
	}
}

120 
	$gë_mb_pos
 (
VideoP¨amëîs
 *
p_Vid
, 
mb_addr
, 
mb_size
[2], *
x
, *
y
)

122 
p_Vid
->
	`gë_mb_block_pos
’_Vid->
PicPos
, 
mb_addr
, 
x
, 
y
);

124 (*
x
Ë(Ë((*xË* 
mb_size
[0]);

125 (*
y
Ë(Ë((*yË* 
mb_size
[1]);

126 
	}
}

145 
	$gëN⁄AffNeighbour
(
Ma¸oblock
 *
cuºMB
, 
xN
, 
yN
, 
mb_size
[2], 
PixñPos
 *
pix
)

147 
BlockPos
 *
PicPos
 = 
cuºMB
->
p_Vid
->PicPos;

148 i‡(
xN
 < 0)

150 i‡(
yN
 < 0)

152 
pix
->
mb_addr
 = 
cuºMB
->
mbAddrD
;

153 
pix
->
avaûabÀ
 = 
cuºMB
->
mbAvaûD
;

155 i‡((
yN
 >0)&&(yN < 
mb_size
[1]))

157 
pix
->
mb_addr
 = 
cuºMB
->
mbAddrA
;

158 
pix
->
avaûabÀ
 = 
cuºMB
->
mbAvaûA
;

162 
pix
->
avaûabÀ
 = 
FALSE
;

165 i‡((
xN
 >0)&&(xN < 
mb_size
[0]))

167 i‡(
yN
<0)

169 
pix
->
mb_addr
 = 
cuºMB
->
mbAddrB
;

170 
pix
->
avaûabÀ
 = 
cuºMB
->
mbAvaûB
;

172 i‡(((
yN
 >0)&&(yN < 
mb_size
[1])))

174 
pix
->
mb_addr
 = 
cuºMB
->
mbAddrX
;

175 
pix
->
avaûabÀ
 = 
TRUE
;

179 
pix
->
avaûabÀ
 = 
FALSE
;

182 i‡((
xN
 >
mb_size
[0])&&(
yN
 < 0))

184 
pix
->
mb_addr
 = 
cuºMB
->
mbAddrC
;

185 
pix
->
avaûabÀ
 = 
cuºMB
->
mbAvaûC
;

189 
pix
->
avaûabÀ
 = 
FALSE
;

192 i‡(
pix
->
avaûabÀ
 || 
cuºMB
->
DeblockCÆl
)

194 
pix
->
x
 = (Ë(
xN
 & (
mb_size
[0] - 1));

195 
pix
->
y
 = (Ë(
yN
 & (
mb_size
[1] - 1));

196 
pix
->
pos_x
 = (Ë’ix->
x
 + 
PicPos
[Öix->
mb_addr
 ].x * 
mb_size
[0]);

197 
pix
->
pos_y
 = (Ë’ix->
y
 + 
PicPos
[Öix->
mb_addr
 ].y * 
mb_size
[1]);

199 
	}
}

217 
	$gëAffNeighbour
(
Ma¸oblock
 *
cuºMB
, 
xN
, 
yN
, 
mb_size
[2], 
PixñPos
 *
pix
)

219 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

220 
maxW
, 
maxH
;

221 
yM
 = -1;

223 
maxW
 = 
mb_size
[0];

224 
maxH
 = 
mb_size
[1];

227 
pix
->
avaûabÀ
 = 
FALSE
;

229 if(
yN
 > (
maxH
 - 1))

233 i‡(
xN
 > (
maxW
 - 1Ë&& 
yN
 >0 && yN < 
maxH
)

238 i‡(
xN
 < 0)

240 i‡(
yN
 < 0)

242 if(!
cuºMB
->
mb_fõld
)

245 i‡((
cuºMB
->
mbAddrX
 & 0x01) == 0)

248 
pix
->
mb_addr
 = 
cuºMB
->
mbAddrD
 + 1;

249 
pix
->
avaûabÀ
 = 
cuºMB
->
mbAvaûD
;

250 
yM
 = 
yN
;

255 
pix
->
mb_addr
 = 
cuºMB
->
mbAddrA
;

256 
pix
->
avaûabÀ
 = 
cuºMB
->
mbAvaûA
;

257 i‡(
cuºMB
->
mbAvaûA
)

259 if(!
p_Vid
->
mb_d©a
[
cuºMB
->
mbAddrA
].
mb_fõld
)

261 
yM
 = 
yN
;

265 (
pix
->
mb_addr
)++;

266 
yM
 = (
yN
 + 
maxH
) >> 1;

274 i‡((
cuºMB
->
mbAddrX
 & 0x01) == 0)

277 
pix
->
mb_addr
 = 
cuºMB
->
mbAddrD
;

278 
pix
->
avaûabÀ
 = 
cuºMB
->
mbAvaûD
;

279 i‡(
cuºMB
->
mbAvaûD
)

281 if(!
p_Vid
->
mb_d©a
[
cuºMB
->
mbAddrD
].
mb_fõld
)

283 (
pix
->
mb_addr
)++;

284 
yM
 = 2 * 
yN
;

288 
yM
 = 
yN
;

295 
pix
->
mb_addr
 = 
cuºMB
->
mbAddrD
+1;

296 
pix
->
avaûabÀ
 = 
cuºMB
->
mbAvaûD
;

297 
yM
 = 
yN
;

303 i‡(
yN
 >0 && yN <
maxH
)

305 i‡(!
cuºMB
->
mb_fõld
)

308 i‡((
cuºMB
->
mbAddrX
 & 0x01) == 0)

311 
pix
->
mb_addr
 = 
cuºMB
->
mbAddrA
;

312 
pix
->
avaûabÀ
 = 
cuºMB
->
mbAvaûA
;

313 i‡(
cuºMB
->
mbAvaûA
)

315 if(!
p_Vid
->
mb_d©a
[
cuºMB
->
mbAddrA
].
mb_fõld
)

317 
yM
 = 
yN
;

321 (
pix
->
mb_addr
)+((
yN
 & 0x01) != 0);

322 
yM
 = 
yN
 >> 1;

329 
pix
->
mb_addr
 = 
cuºMB
->
mbAddrA
;

330 
pix
->
avaûabÀ
 = 
cuºMB
->
mbAvaûA
;

331 i‡(
cuºMB
->
mbAvaûA
)

333 if(!
p_Vid
->
mb_d©a
[
cuºMB
->
mbAddrA
].
mb_fõld
)

335 (
pix
->
mb_addr
)++;

336 
yM
 = 
yN
;

340 (
pix
->
mb_addr
)+((
yN
 & 0x01) != 0);

341 
yM
 = (
yN
 + 
maxH
) >> 1;

349 i‡((
cuºMB
->
mbAddrX
 & 0x01) == 0)

352 
pix
->
mb_addr
 = 
cuºMB
->
mbAddrA
;

353 
pix
->
avaûabÀ
 = 
cuºMB
->
mbAvaûA
;

354 i‡(
cuºMB
->
mbAvaûA
)

356 if(!
p_Vid
->
mb_d©a
[
cuºMB
->
mbAddrA
].
mb_fõld
)

358 i‡(
yN
 < (
maxH
 >> 1))

360 
yM
 = 
yN
 << 1;

364 (
pix
->
mb_addr
)++;

365 
yM
 = (
yN
 << 1 ) - 
maxH
;

370 
yM
 = 
yN
;

377 
pix
->
mb_addr
 = 
cuºMB
->
mbAddrA
;

378 
pix
->
avaûabÀ
 = 
cuºMB
->
mbAvaûA
;

379 i‡(
cuºMB
->
mbAvaûA
)

381 if(!
p_Vid
->
mb_d©a
[
cuºMB
->
mbAddrA
].
mb_fõld
)

383 i‡(
yN
 < (
maxH
 >> 1))

385 
yM
 = (
yN
 << 1) + 1;

389 (
pix
->
mb_addr
)++;

390 
yM
 = (
yN
 << 1 ) + 1 - 
maxH
;

395 (
pix
->
mb_addr
)++;

396 
yM
 = 
yN
;

406 i‡(
xN
 >0 && xN < 
maxW
)

408 i‡(
yN
<0)

410 i‡(!
cuºMB
->
mb_fõld
)

413 i‡((
cuºMB
->
mbAddrX
 & 0x01) == 0)

416 
pix
->
mb_addr
 = 
cuºMB
->
mbAddrB
;

419 i‡(
cuºMB
->
mbAvaûB
)

421 i‡(!(
cuºMB
->
DeblockCÆl
 =1 && (
p_Vid
->
mb_d©a
[cuºMB->
mbAddrB
]).
mb_fõld
))

422 
pix
->
mb_addr
 += 1;

425 
pix
->
avaûabÀ
 = 
cuºMB
->
mbAvaûB
;

426 
yM
 = 
yN
;

431 
pix
->
mb_addr
 = 
cuºMB
->
mbAddrX
 - 1;

432 
pix
->
avaûabÀ
 = 
TRUE
;

433 
yM
 = 
yN
;

439 i‡((
cuºMB
->
mbAddrX
 & 0x01) == 0)

442 
pix
->
mb_addr
 = 
cuºMB
->
mbAddrB
;

443 
pix
->
avaûabÀ
 = 
cuºMB
->
mbAvaûB
;

444 i‡(
cuºMB
->
mbAvaûB
)

446 if(!
p_Vid
->
mb_d©a
[
cuºMB
->
mbAddrB
].
mb_fõld
)

448 (
pix
->
mb_addr
)++;

449 
yM
 = 2 * 
yN
;

453 
yM
 = 
yN
;

460 
pix
->
mb_addr
 = 
cuºMB
->
mbAddrB
 + 1;

461 
pix
->
avaûabÀ
 = 
cuºMB
->
mbAvaûB
;

462 
yM
 = 
yN
;

470 i‡(
yN
 =0 && 
cuºMB
->
DeblockCÆl
 == 2)

472 
pix
->
mb_addr
 = 
cuºMB
->
mbAddrB
 + 1;

473 
pix
->
avaûabÀ
 = 
TRUE
;

474 
yM
 = 
yN
 - 1;

477 i‡((
yN
 >0Ë&& (yN <
maxH
))

479 
pix
->
mb_addr
 = 
cuºMB
->
mbAddrX
;

480 
pix
->
avaûabÀ
 = 
TRUE
;

481 
yM
 = 
yN
;

487 if(
yN
 < 0)

489 i‡(!
cuºMB
->
mb_fõld
)

492 i‡((
cuºMB
->
mbAddrX
 & 0x01) == 0)

495 
pix
->
mb_addr
 = 
cuºMB
->
mbAddrC
 + 1;

496 
pix
->
avaûabÀ
 = 
cuºMB
->
mbAvaûC
;

497 
yM
 = 
yN
;

502 
pix
->
avaûabÀ
 = 
FALSE
;

508 i‡((
cuºMB
->
mbAddrX
 & 0x01) == 0)

511 
pix
->
mb_addr
 = 
cuºMB
->
mbAddrC
;

512 
pix
->
avaûabÀ
 = 
cuºMB
->
mbAvaûC
;

513 i‡(
cuºMB
->
mbAvaûC
)

515 if(!
p_Vid
->
mb_d©a
[
cuºMB
->
mbAddrC
].
mb_fõld
)

517 (
pix
->
mb_addr
)++;

518 
yM
 = 2* 
yN
;

522 
yM
 = 
yN
;

529 
pix
->
mb_addr
 = 
cuºMB
->
mbAddrC
 + 1;

530 
pix
->
avaûabÀ
 = 
cuºMB
->
mbAvaûC
;

531 
yM
 = 
yN
;

537 i‡(
pix
->
avaûabÀ
 || 
cuºMB
->
DeblockCÆl
)

539 
pix
->
x
 = (Ë(
xN
 & (
maxW
 - 1));

540 
pix
->
y
 = (Ë(
yM
 & (
maxH
 - 1));

541 
	`gë_mb_pos
(
p_Vid
, 
pix
->
mb_addr
, 
mb_size
, &’ix->
pos_x
), &’ix->
pos_y
));

542 
pix
->
pos_x
 =Öix->pos_x +Öix->
x
;

543 
pix
->
pos_y
 =Öix->pos_y +Öix->
y
;

545 
	}
}

564 
	$gë4x4Neighbour
 (
Ma¸oblock
 *
cuºMB
, 
block_x
, 
block_y
, 
mb_size
[2], 
PixñPos
 *
pix
)

566 
cuºMB
->
p_Vid
->
	`gëNeighbour
(cuºMB, 
block_x
, 
block_y
, 
mb_size
, 
pix
);

568 i‡(
pix
->
avaûabÀ
)

570 
pix
->
x
 >>= 2;

571 
pix
->
y
 >>= 2;

572 
pix
->
pos_x
 >>= 2;

573 
pix
->
pos_y
 >>= 2;

575 
	}
}

	@lencod/src/mbuffer.c

17 
	~<limôs.h
>

19 
	~"globÆ.h
"

20 
	~"mbuf„r.h
"

21 
	~"mbuf„r_comm⁄.h
"

22 
	~"memÆloc.h
"

23 
	~"ouçut.h
"

24 
	~"image.h
"

25 
	~"«lucomm⁄.h
"

26 
	~"img_luma.h
"

27 
	~"img_chroma.h
"

28 
	~"îrdo.h
"

30 
SbSMuxBasic
(
ImageD©a
 *
imgOut
, ImageD©®*
imgIn0
, ImageD©®*
imgIn1
, 
off£t
);

31 
öô_°©s
 (
I≈utP¨amëîs
 *
p_I≈
, 
SètP¨amëîs
 *
°©s
);

32 
ö£π_pi˘uª_ö_dpb
 (
VideoP¨amëîs
 *
p_Vid
, 
FømeSt‹e
* 
fs
, 
St‹abÀPi˘uª
* 
p
);

33 
ouçut_⁄e_‰ame_‰om_dpb
 (
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
FømeF‹m©
 *
ouçut
);

34 
gí_fõld_ªf_ids
 (
St‹abÀPi˘uª
 *
p
);

35 
Êush_unu£d_‰ame_‰om_dpb
 (
DecodedPi˘uªBuf„r
 *
p_Dpb
);

36 
¥o˚ss_pi˘uª_ö_dpb_s
(
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
p_pic
);

37 
St‹abÀPi˘uª
 * 
˛⁄e_°‹abÀ_pi˘uª
–
VideoP¨amëîs
 *
p_Vid
, St‹abÀPi˘uª *
p_pic
 );

39 
	#MAX_LIST_SIZE
 33

	)

41 
‰ì_mem2Duöt16
(
uöt16
 **
¨øy2D
);

42 
‰ì_mem3Duöt16
(
uöt16
 ***
¨øy3D
);

50 
	$dump_dpb
(
DecodedPi˘uªBuf„r
 *
p_Dpb
)

52 #i‡
DUMP_DPB


53 
i
;

55 
i
=0; i<
p_Dpb
->
u£d_size
;i++)

57 
	`¥ötf
("(");

58 
	`¥ötf
("‚=%d ", 
p_Dpb
->
fs
[
i
]->
‰ame_num
);

59 i‡(
p_Dpb
->
fs
[
i
]->
is_u£d
 & 1)

61 i‡(
p_Dpb
->
fs
[
i
]->
t›_fõld
)

62 
	`¥ötf
("T:Öoc=%d ", 
p_Dpb
->
fs
[
i
]->
t›_fõld
->
poc
);

64 
	`¥ötf
("T:Öoc=%d ", 
p_Dpb
->
fs
[
i
]->
‰ame
->
t›_poc
);

66 i‡(
p_Dpb
->
fs
[
i
]->
is_u£d
 & 2)

68 i‡(
p_Dpb
->
fs
[
i
]->
bŸtom_fõld
)

69 
	`¥ötf
("B:Öoc=%d ", 
p_Dpb
->
fs
[
i
]->
bŸtom_fõld
->
poc
);

71 
	`¥ötf
("B:Öoc=%d ", 
p_Dpb
->
fs
[
i
]->
‰ame
->
bŸtom_poc
);

73 i‡(
p_Dpb
->
fs
[
i
]->
is_u£d
 == 3)

74 
	`¥ötf
("F:Öoc=%d ", 
p_Dpb
->
fs
[
i
]->
‰ame
->
poc
);

75 
	`¥ötf
("G:Öoc=%dË ", 
p_Dpb
->
fs
[
i
]->
poc
);

76 i‡(
p_Dpb
->
fs
[
i
]->
is_ª„ªn˚
Ë
	`¥ötf
 ("ref (%d) ",Ö_Dpb->fs[i]->is_reference);

77 i‡(
p_Dpb
->
fs
[
i
]->
is_l⁄g_ãrm
Ë
	`¥ötf
 ("…_ª‡(%dË",Ö_Dpb->fs[i]->
is_ª„ªn˚
);

78 i‡(
p_Dpb
->
fs
[
i
]->
is_ouçut
Ë
	`¥ötf
 ("out ");

79 i‡(
p_Dpb
->
fs
[
i
]->
is_u£d
 == 3)

81 i‡(
p_Dpb
->
fs
[
i
]->
‰ame
->
n⁄_exi°ög
Ë
	`¥ötf
 ("ne ");

83 #i‡(
MVC_EXTENSION_ENABLE
)

84 if(
p_Dpb
->
p_I≈
->
num_of_võws
==2)

85 
	`¥ötf
 ("võw_id=%d ", 
p_Dpb
->
fs
[
i
]->
võw_id
);

87 
	`¥ötf
 ("\n");

90 
	}
}

100 
	$gëDpbSize
(
VideoP¨amëîs
 *
p_Vid
, 
£q_∑ømëî_£t_rb•_t
 *
a˘ive_•s
)

102 
pic_size
 = (
a˘ive_•s
->
pic_width_ö_mbs_möus1
 + 1Ë* (a˘ive_•s->
pic_height_ö_m≠_unôs_möus1
 + 1Ë* (a˘ive_•s->
‰ame_mbs_⁄ly_Êag
?1:2) * 384;

104 
size
 = 0;

106 
a˘ive_•s
->
Àvñ_idc
)

109 
size
 = 152064;

112 
size
 = 152064;

115 i‡(!
	`is_FREXT_¥ofûe
(
a˘ive_•s
->
¥ofûe_idc
Ë&& (a˘ive_•s->
c⁄°øöed_£t3_Êag
 == 1))

116 
size
 = 152064;

118 
size
 = 345600;

121 
size
 = 912384;

124 
size
 = 912384;

127 
size
 = 912384;

130 
size
 = 1824768;

133 
size
 = 3110400;

136 
size
 = 3110400;

139 
size
 = 6912000;

142 
size
 = 7864320;

145 
size
 = 12582912;

148 
size
 = 12582912;

151 
size
 = 13369344;

154 
size
 = 42393600;

157 
size
 = 70778880;

160 
size
 = 70778880;

163 
	`îr‹
 ("undefinedÜevel", 500);

167 
size
 /
pic_size
;

168 if(
	`is_MVC_¥ofûe
(
p_Vid
->
p_I≈
->
ProfûeIDC
))

170 
num_võws
 = 
p_Vid
->
p_I≈
->
num_of_võws
;

171 
size
 = 
	`imö
(2*size, 
	`imax
(1, 
	`RoundLog2
(
num_võws
))*16)/num_views;

174 
size
 = 
	`imö
( size, 16);

176 i‡(
a˘ive_•s
->
vui_∑ømëîs_¥e£¡_Êag
 &&á˘ive_•s->
vui_£q_∑ømëîs
.
bô°ªam_ª°ri˘i⁄_Êag
)

178 i‡(()
a˘ive_•s
->
vui_£q_∑ømëîs
.
max_dec_‰ame_buf„rög
 > 
size
)

180 
	`îr‹
 ("max_dec_frame_bufferingÜargerÅhan MaxDpbSize", 500);

182 
size
 = 
	`imax
 (1, 
a˘ive_•s
->
vui_£q_∑ømëîs
.
max_dec_‰ame_buf„rög
);

185  
size
;

186 
	}
}

196 
	$check_num_ªf
(
DecodedPi˘uªBuf„r
 *
p_Dpb
)

198 i‡(()(
p_Dpb
->
…ªf_‰ames_ö_buf„r
 +Ö_Dpb->
ªf_‰ames_ö_buf„r
 ) > 
	`imax
(1,Ö_Dpb->
num_ªf_‰ames
))

200 
	`îr‹
 ("Max.Çumber ofÑeference framesÉxceeded. Invalid stream.", 500);

202 
	}
}

212 
	$öô_dpb
(
VideoP¨amëîs
 *
p_Vid
, 
DecodedPi˘uªBuf„r
 *
p_Dpb
)

214 
i
;

216 
p_Dpb
->
p_Vid
 =Ö_Vid;

217 
p_Dpb
->
p_I≈
 = 
p_Vid
->p_Inp;

218 
p_Dpb
->
num_ªf_‰ames
 = 
p_Vid
->num_ref_frames;

220 i‡(
p_Dpb
->
öô_d⁄e
)

222 
	`‰ì_dpb
(
p_Dpb
);

225 
p_Dpb
->
size
 = 
	`gëDpbSize
(
p_Vid
,Ö_Vid->
•s
[p_Dpb->
œyî_id
]);

228 i‡(
p_Dpb
->
size
 < (Ë(
p_Vid
->
p_I≈
)->
num_ªf_‰ames
)

230 
	`îr‹
 ("DPB sizeát specifiedÜevel is smallerÅhanÅhe specifiedÇumber ofÑeference frames. This isÇotállowed.\n", 1000);

233 
p_Dpb
->
u£d_size
 = 0;

234 
p_Dpb
->
œ°_pi˘uª
 = 
NULL
;

236 
p_Dpb
->
ªf_‰ames_ö_buf„r
 = 0;

237 
p_Dpb
->
…ªf_‰ames_ö_buf„r
 = 0;

239 
p_Dpb
->
fs
 = 
	`ˇŒoc
’_Dpb->
size
,  (
FømeSt‹e
*));

240 i‡(
NULL
==
p_Dpb
->
fs
)

241 
	`no_mem_exô
("init_dpb:Ö_Dpb->fs");

243 
p_Dpb
->
fs_ªf
 = 
	`ˇŒoc
’_Dpb->
size
,  (
FømeSt‹e
*));

244 i‡(
NULL
==
p_Dpb
->
fs_ªf
)

245 
	`no_mem_exô
("init_dpb:Ö_Dpb->fs_ref");

247 
p_Dpb
->
fs_…ªf
 = 
	`ˇŒoc
’_Dpb->
size
,  (
FømeSt‹e
*));

248 i‡(
NULL
==
p_Dpb
->
fs_…ªf
)

249 
	`no_mem_exô
("init_dpb:Ö_Dpb->fs_ltref");

251 
i
 = 0; i < 
p_Dpb
->
size
; i++)

253 
p_Dpb
->
fs
[
i
] = 
	`Æloc_‰ame_°‹e
();

254 
p_Dpb
->
fs_ªf
[
i
] = 
NULL
;

255 
p_Dpb
->
fs_…ªf
[
i
] = 
NULL
;

257 
p_Dpb
->
fs_ûªf
 = 
	`ˇŒoc
(1,  (
FømeSt‹e
*));

258 i‡(
NULL
==
p_Dpb
->
fs_ûªf
)

259 
	`no_mem_exô
("init_dpb:Ö_Dpb->fs_ilref");

261 if(
p_Dpb
->
œyî_id
 == 0)

263 
p_Dpb
->
fs_ûªf
[0] = 
NULL
;

265 if(
p_Dpb
->
œyî_id
 == 1)

267 
p_Dpb
->
fs_ûªf
[0] = 
	`Æloc_‰ame_°‹e
();

270 
p_Dpb
->
œ°_ouçut_poc
 = 
INT_MIN
;

272 #i‡(
MVC_EXTENSION_ENABLE
)

273 
p_Dpb
->
œ°_ouçut_võw_id
 = 0;

276 
p_Vid
->
œ°_has_mmco_5
 = 0;

278 
p_Dpb
->
öô_d⁄e
 = 1;

280 
	}
}

289 
	$‰ì_dpb
(
DecodedPi˘uªBuf„r
 *
p_Dpb
)

291 
VideoP¨amëîs
 *
p_Vid
 = 
p_Dpb
->p_Vid;

292 
i
;

293 i‡(
p_Dpb
->
fs
)

295 
i
=0; i<
p_Dpb
->
size
; i++)

297 
	`‰ì_‰ame_°‹e
(
p_Vid
, 
p_Dpb
->
fs
[
i
]);

299 
	`‰ì
 (
p_Dpb
->
fs
);

300 
p_Dpb
->
fs
=
NULL
;

303 i‡(
p_Dpb
->
fs_ªf
)

305 
	`‰ì
 (
p_Dpb
->
fs_ªf
);

307 i‡(
p_Dpb
->
fs_…ªf
)

309 
	`‰ì
 (
p_Dpb
->
fs_…ªf
);

311 if(
p_Dpb
->
fs_ûªf
)

313 if(
p_Dpb
->
fs_ûªf
[0])

315 
	`‰ì_‰ame_°‹e
(
p_Vid
, 
p_Dpb
->
fs_ûªf
[0]);

316 
p_Dpb
->
fs_ûªf
[0] = 
NULL
;

318 
	`‰ì
(
p_Dpb
->
fs_ûªf
);

320 
p_Dpb
->
œ°_ouçut_poc
 = 
INT_MIN
;

322 #i‡(
MVC_EXTENSION_ENABLE
)

323 
p_Dpb
->
œ°_ouçut_võw_id
 = 0;

326 
p_Dpb
->
öô_d⁄e
 = 0;

327 
	}
}

339 
FømeSt‹e
* 
	$Æloc_‰ame_°‹e
()

341 
FømeSt‹e
 *
f
;

343 
f
 = 
	`ˇŒoc
 (1, (
FømeSt‹e
));

344 i‡(
NULL
==
f
)

345 
	`no_mem_exô
("alloc_frame_store: f");

347 
f
->
is_u£d
 = 0;

348 
f
->
is_ª„ªn˚
 = 0;

349 
f
->
is_l⁄g_ãrm
 = 0;

350 
f
->
is_‹ig_ª„ªn˚
 = 0;

352 
f
->
is_ouçut
 = 0;

354 
f
->
‰ame
 = 
NULL
;;

355 
f
->
t›_fõld
 = 
NULL
;

356 
f
->
bŸtom_fõld
 = 
NULL
;

358 #i‡(
MVC_EXTENSION_ENABLE
)

359 
f
->
võw_id
 = -1;

360 
f
->
öãr_võw_Êag
[0] = 0;

361 
f
->
öãr_võw_Êag
[1] = 0;

362 
f
->
™ch‹_pic_Êag
[0] = 0;

363 
f
->
™ch‹_pic_Êag
[1] = 0;

366  
f
;

367 
	}
}

369 
	$Æloc_pic_mŸi⁄
(
PicMŸi⁄P¨amsOld
 *
mŸi⁄
, 
size_y
, 
size_x
)

371 
mŸi⁄
->
mb_fõld
 = 
	`ˇŒoc
 (
size_y
 * 
size_x
, (
byã
));

372 i‡(
mŸi⁄
->
mb_fõld
 =
NULL
)

373 
	`no_mem_exô
("alloc_storable_picture: motion->mb_field");

374 
	}
}

398 
St‹abÀPi˘uª
* 
	$Æloc_°‹abÀ_pi˘uª
(
VideoP¨amëîs
 *
p_Vid
, 
Pi˘uªSåu˘uª
 
°ru˘uª
, 
size_x
, 
size_y
, 
size_x_¸
, 
size_y_¸
)

400 
St‹abÀPi˘uª
 *
s
;

401 
≈œ√
;

402 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

406 
s
 = 
	`ˇŒoc
 (1, (
St‹abÀPi˘uª
));

407 i‡(
NULL
==
s
)

408 
	`no_mem_exô
("alloc_storable_picture: s");

410 
s
->
imgY
 = 
NULL
;

411 
s
->
imgUV
 = 
NULL
;

412 
s
->
imgY_sub
 = 
NULL
;

413 
s
->
imgUV_sub
 = 
NULL
;

415 
s
->
p_img_sub
[0] = 
NULL
;

416 
s
->
p_img_sub
[1] = 
NULL
;

417 
s
->
p_img_sub
[2] = 
NULL
;

419 
s
->
de_mem
 = 
NULL
;

421 #i‡(
MVC_EXTENSION_ENABLE
)

422 i‡((
p_Vid
->
«l_ª„ªn˚_idc
 !
NALU_PRIORITY_DISPOSABLE
Ë|| ((
p_I≈
->
num_of_võws
 =2Ë&&Ö_Vid->
võw_id
 == 0))

424 i‡(
p_Vid
->
«l_ª„ªn˚_idc
 !
NALU_PRIORITY_DISPOSABLE
)

427 i‡(!
p_I≈
->
OnTheFlyFø˘MCP
)

429 
	`gë_mem4D≥l_∑d
(&(
s
->
imgY_sub
), 4, 4, 
size_y
, 
size_x
, 
IMG_PAD_SIZE_Y
, 
IMG_PAD_SIZE_X
);

430 
s
->
imgY
 = s->
imgY_sub
[0][0];

432 i‡–
p_I≈
->
ChromaMCBuf„r
 || 
p_Vid
->
P444_joöed
 || (p_I≈->
yuv_f‹m©
==
YUV444
 && !p_Vid->P444_joined))

435 i‡–
p_Vid
->
yuv_f‹m©
 !
YUV400
 )

437 i‡–
p_Vid
->
yuv_f‹m©
 =
YUV420
 )

439 
	`gë_mem5D≥l_∑d
(&(
s
->
imgUV_sub
), 2, 8, 8, 
size_y_¸
, 
size_x_¸
, 
p_Vid
->
∑d_size_uv_y
,Ö_Vid->
∑d_size_uv_x
);

441 i‡–
p_Vid
->
yuv_f‹m©
 =
YUV422
 )

443 
	`gë_mem5D≥l_∑d
(&(
s
->
imgUV_sub
), 2, 4, 8, 
size_y_¸
, 
size_x_¸
, 
p_Vid
->
∑d_size_uv_y
,Ö_Vid->
∑d_size_uv_x
);

447 
	`gë_mem5D≥l_∑d
(&(
s
->
imgUV_sub
), 2, 4, 4, 
size_y_¸
, 
size_x_¸
, 
p_Vid
->
∑d_size_uv_y
,Ö_Vid->
∑d_size_uv_x
);

449 
s
->
p_img_sub
[1] = s->
imgUV_sub
[0];

450 
s
->
p_img_sub
[2] = s->
imgUV_sub
[1];

451 
s
->
imgUV
 = (
img≥l
 ***)
	`mÆloc
(2*(imgpel**));

452 
s
->
imgUV
[0] = s->
imgUV_sub
[0][0][0];

453 
s
->
imgUV
[1] = s->
imgUV_sub
[1][0][0];

458 
	`gë_mem3D≥l_∑d
(&(
s
->
imgUV
), 2, 
size_y_¸
, 
size_x_¸
, 
p_Vid
->
∑d_size_uv_y
,Ö_Vid->
∑d_size_uv_x
);

461 i‡–
p_I≈
->
OnTheFlyFø˘MCP
 =
OTF_L1
 )

463 
	`gë_mem4D≥l_∑d
(&(
s
->
imgY_sub
), 2, 2, 
size_y
, 
size_x
, 
IMG_PAD_SIZE_Y
, 
IMG_PAD_SIZE_X
);

464 
s
->
imgY
 = s->
imgY_sub
[0][0];

466 i‡–
p_I≈
->
ChromaMCBuf„r
 || 
p_Vid
->
P444_joöed
 || (p_I≈->
yuv_f‹m©
==
YUV444
 && !p_Vid->P444_joined))

469 i‡–
p_Vid
->
yuv_f‹m©
 !
YUV400
 )

471 i‡–
p_Vid
->
yuv_f‹m©
 =
YUV420
 )

473 
	`gë_mem5D≥l_∑d
(&(
s
->
imgUV_sub
), 2, 4, 4, 
size_y_¸
, 
size_x_¸
, 
p_Vid
->
∑d_size_uv_y
,Ö_Vid->
∑d_size_uv_x
);

475 i‡–
p_Vid
->
yuv_f‹m©
 =
YUV422
 )

477 
	`gë_mem5D≥l_∑d
(&(
s
->
imgUV_sub
), 2, 2, 4, 
size_y_¸
, 
size_x_¸
, 
p_Vid
->
∑d_size_uv_y
,Ö_Vid->
∑d_size_uv_x
);

481 
	`gë_mem5D≥l_∑d
(&(
s
->
imgUV_sub
), 2, 2, 2, 
size_y_¸
, 
size_x_¸
, 
p_Vid
->
∑d_size_uv_y
,Ö_Vid->
∑d_size_uv_x
);

483 
s
->
p_img_sub
[1] = s->
imgUV_sub
[0];

484 
s
->
p_img_sub
[2] = s->
imgUV_sub
[1];

485 
s
->
imgUV
 = (
img≥l
 ***)
	`mÆloc
(2*(imgpel**));

486 
s
->
imgUV
[0] = s->
imgUV_sub
[0][0][0];

487 
s
->
imgUV
[1] = s->
imgUV_sub
[1][0][0];

492 
	`gë_mem3D≥l_∑d
(&(
s
->
imgUV
), 2, 
size_y_¸
, 
size_x_¸
, 
p_Vid
->
∑d_size_uv_y
,Ö_Vid->
∑d_size_uv_x
);

497 
	`gë_mem2D≥l_∑d
(&(
s
->
imgY
), 
size_y
, 
size_x
, 
IMG_PAD_SIZE_Y
, 
IMG_PAD_SIZE_X
);

498 
	`gë_mem3D≥l_∑d
(&(
s
->
imgUV
), 2, 
size_y_¸
, 
size_x_¸
, 
p_Vid
->
∑d_size_uv_y
,Ö_Vid->
∑d_size_uv_x
);

503 
	`gë_mem2D≥l_∑d
(&(
s
->
imgY
), 
size_y
, 
size_x
, 
IMG_PAD_SIZE_Y
, 
IMG_PAD_SIZE_X
);

504 
	`gë_mem3D≥l_∑d
(&(
s
->
imgUV
), 2, 
size_y_¸
, 
size_x_¸
, 
p_Vid
->
∑d_size_uv_y
,Ö_Vid->
∑d_size_uv_x
);

507 
s
->
p_img
[0] = s->
imgY
;

508 
s
->
p_cuº_img
 = s->
p_img
[0];

509 
s
->
p_cuº_img_sub
 = s->
p_img_sub
[0];

511 i‡(
p_Vid
->
yuv_f‹m©
 !
YUV400
)

514 
s
->
p_img
[1] = s->
imgUV
[0];

515 
s
->
p_img
[2] = s->
imgUV
[1];

518 
	`gë_mem2Dmp
 (&
s
->
mv_öfo
, (
size_y
 >> 
BLOCK_SHIFT
), (
size_x
 >> BLOCK_SHIFT));

519 
	`Æloc_pic_mŸi⁄
(&
s
->
mŸi⁄
, (
size_y
 >> 
BLOCK_SHIFT
), (
size_x
 >> BLOCK_SHIFT));

521 if–(
p_I≈
->
£∑øã_cﬁour_∂™e_Êag
 != 0) )

523  
≈œ√
=0;Ç∂™e<
MAX_PLANE
;Çplane++ )

525 
	`gë_mem2Dmp
 (&
s
->
JVmv_öfo
[
≈œ√
], (
size_y
 >> 
BLOCK_SHIFT
), (
size_x
 >> BLOCK_SHIFT));

526 
	`Æloc_pic_mŸi⁄
(&
s
->
JVmŸi⁄
[
≈œ√
], (
size_y
 >> 
BLOCK_SHIFT
), (
size_x
 >> BLOCK_SHIFT));

530 i‡(
p_I≈
->
rd›t
 == 3)

532 
	`îrdo_Æloc_°‹abÀ_pi˘uª
(
s
, 
p_Vid
, 
p_I≈
, 
size_x
, 
size_y
, 
size_x_¸
, 
size_y_¸
);

535 
s
->
pic_num
=0;

536 
s
->
‰ame_num
=0;

537 
s
->
l⁄g_ãrm_‰ame_idx
=0;

538 
s
->
l⁄g_ãrm_pic_num
=0;

539 
s
->
u£d_f‹_ª„ªn˚
=0;

540 
s
->
is_l⁄g_ãrm
=0;

541 
s
->
n⁄_exi°ög
=0;

542 
s
->
is_ouçut
 = 0;

544 
s
->
°ru˘uª
=structure;

545 
s
->
size_x
 = size_x;

546 
s
->
size_y
 = size_y;

547 
s
->
size_x_∑dded
 = 
size_x
 + 2 * 
IMG_PAD_SIZE_X
;

548 
s
->
size_y_∑dded
 = 
size_y
 + 2 * 
IMG_PAD_SIZE_Y
;

549 
s
->
size_x_∑d
 = 
size_x
 + 2 * 
IMG_PAD_SIZE_X
 - 1 - 
MB_BLOCK_SIZE
 -IMG_PAD_SIZE_X;

550 
s
->
size_y_∑d
 = 
size_y
 + 2 * 
IMG_PAD_SIZE_Y
 - 1 - 
MB_BLOCK_SIZE
 -IMG_PAD_SIZE_Y;

551 
s
->
size_x_¸
 = size_x_cr;

552 
s
->
size_y_¸
 = size_y_cr;

553 
s
->
size_x_¸_∑d
 = (Ë(
size_x_¸
 - 1Ë+ (
p_Vid
->
∑d_size_uv_x
 << 1Ë- (p_Vid->
mb_¸_size_x
) -Ö_Vid->pad_size_uv_x;

554 
s
->
size_y_¸_∑d
 = (Ë(
size_y_¸
 - 1Ë+ (
p_Vid
->
∑d_size_uv_y
 << 1Ë- (p_Vid->
mb_¸_size_y
) -Ö_Vid->pad_size_uv_y;

555 
s
->
∑d_size_uv_x
 = 
p_Vid
->pad_size_uv_x;

556 
s
->
∑d_size_uv_y
 = 
p_Vid
->pad_size_uv_y;

558 
s
->
t›_fõld
 = 
NULL
;

559 
s
->
bŸtom_fõld
 = 
NULL
;

560 
s
->
‰ame
 = 
NULL
;

562 
s
->
coded_‰ame
 = 0;

563 
s
->
mb_aff_‰ame_Êag
 = 0;

565 
	`mem£t
(
s
->
ªf_pic_«
, 0xff, ()*6);

567 
	`öô_°©s
(
p_I≈
, &
s
->
°©s
);

568  
s
;

569 
	}
}

584 
	$‰ì_‰ame_°‹e
(
VideoP¨amëîs
 *
p_Vid
, 
FømeSt‹e
* 
f
)

586 i‡(
f
)

588 i‡(
f
->
‰ame
)

590 
	`‰ì_°‹abÀ_pi˘uª
(
p_Vid
, 
f
->
‰ame
);

591 
f
->
‰ame
=
NULL
;

593 i‡(
f
->
t›_fõld
)

595 
	`‰ì_°‹abÀ_pi˘uª
(
p_Vid
, 
f
->
t›_fõld
);

596 
f
->
t›_fõld
=
NULL
;

598 i‡(
f
->
bŸtom_fõld
)

600 
	`‰ì_°‹abÀ_pi˘uª
(
p_Vid
, 
f
->
bŸtom_fõld
);

601 
f
->
bŸtom_fõld
=
NULL
;

603 
	`‰ì
(
f
);

605 
	}
}

607 
	$‰ì_pic_mŸi⁄
(
PicMŸi⁄P¨amsOld
 *
mŸi⁄
)

609 i‡(
mŸi⁄
->
mb_fõld
)

611 
	`‰ì
(
mŸi⁄
->
mb_fõld
);

612 
mŸi⁄
->
mb_fõld
 = 
NULL
;

614 
	}
}

616 
	$‰ì_‰ame_d©a_mem‹y
(
St‹abÀPi˘uª
 *
pi˘uª
, 
bFªeImage
)

618 if(
pi˘uª
)

620 i‡(
pi˘uª
->
imgY_sub
)

622 if(
bFªeImage
)

624 
pi˘uª
->
imgY
 = 
NULL
;

625 if–
pi˘uª
->
Ÿf_Êag
 =
OTF_L1
 )

627 
	`‰ì_mem4D≥l_∑d
(
pi˘uª
->
imgY_sub
, 4, 
IMG_PAD_SIZE_Y
, 
IMG_PAD_SIZE_X
);

631 
	`‰ì_mem4D≥l_∑d
(
pi˘uª
->
imgY_sub
, 16, 
IMG_PAD_SIZE_Y
, 
IMG_PAD_SIZE_X
);

633 
pi˘uª
->
imgY_sub
=
NULL
;

637 
k
;

638 
K
 = (
pi˘uª
->
Ÿf_Êag
==
OTF_L1
) ? (4):(16) ;

639 
k
 = 1; k < 
K
; k++)

641 if(
pi˘uª
->
imgY_sub
[
k
>>2][k&3])

643 
	`‰ì_mem2D≥l_∑d
(
pi˘uª
->
imgY_sub
[
k
>>2][k&3], 
IMG_PAD_SIZE_Y
, 
IMG_PAD_SIZE_X
);

644 
pi˘uª
->
imgY_sub
[
k
>>2][k&3] = 
NULL
;

650 i‡(
pi˘uª
->
imgUV_sub
)

652 
iUVResX
 = 4*(
pi˘uª
->
size_x
/pi˘uª->
size_x_¸
);

653 
iUVResY
 = 4*(
pi˘uª
->
size_y
/pi˘uª->
size_y_¸
);

655 i‡–
pi˘uª
->
Ÿf_Êag
 =
OTF_L1
 )

657 
iUVResX
 >>= 1 ;

658 
iUVResY
 >>= 1 ;

661 if(
bFªeImage
)

663 if(
pi˘uª
->
imgUV
)

665 
	`‰ì
(
pi˘uª
->
imgUV
);

666 
pi˘uª
->
imgUV
 = 
NULL
;

668 
	`‰ì_mem5D≥l_∑d
(
pi˘uª
->
imgUV_sub
, 2*
iUVResY
*
iUVResX
,Öi˘uª->
∑d_size_uv_y
,Öi˘uª->
∑d_size_uv_x
);

669 
pi˘uª
->
imgUV_sub
 = 
NULL
;

673 
i
, 
j
, 
k
;

674 
k
=1; k<
iUVResY
*
iUVResX
; k++)

676 
j
 = 
k
/
iUVResX
;

677 
i
 = 
k
%
iUVResX
;

678 if(
pi˘uª
->
imgUV_sub
[0][
j
][
i
])

680 
	`‰ì_mem2D≥l_∑d
(
pi˘uª
->
imgUV_sub
[0][
j
][
i
],Öi˘uª->
∑d_size_uv_y
,Öi˘uª->
∑d_size_uv_x
);

681 
pi˘uª
->
imgUV_sub
[0][
j
][
i
] = 
NULL
;

683 if(
pi˘uª
->
imgUV_sub
[1][
j
][
i
])

685 
	`‰ì_mem2D≥l_∑d
(
pi˘uª
->
imgUV_sub
[1][
j
][
i
],Öi˘uª->
∑d_size_uv_y
,Öi˘uª->
∑d_size_uv_x
);

686 
pi˘uª
->
imgUV_sub
[1][
j
][
i
] = 
NULL
;

692 i‡(
pi˘uª
->
mv_öfo
)

694 
	`‰ì_mem2Dmp
(
pi˘uª
->
mv_öfo
);

695 
pi˘uª
->
mv_öfo
 = 
NULL
;

698 
	`‰ì_pic_mŸi⁄
(&
pi˘uª
->
mŸi⁄
);

700 
	}
}

714 
	$‰ì_°‹abÀ_pi˘uª
(
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
* 
p
)

716 i‡(
p
)

718 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

720 if(
p
->
imgY
 && !p->
imgY_sub
)

722 
	`‰ì_mem2D≥l_∑d
(
p
->
imgY
, 
IMG_PAD_SIZE_Y
, 
IMG_PAD_SIZE_X
);

723 
p
->
imgY
=
NULL
;

726 i‡(
p
->
imgUV
 && !p->
imgUV_sub
)

728 
	`‰ì_mem3D≥l_∑d
(
p
->
imgUV
, 2,Ö->
∑d_size_uv_y
,Ö->
∑d_size_uv_x
);

729 
p
->
imgUV
=
NULL
;

732 
	`‰ì_‰ame_d©a_mem‹y
(
p
, 1);

734 if–(
p_I≈
->
£∑øã_cﬁour_∂™e_Êag
 != 0) )

736 
≈œ√
;

737  
≈œ√
=0;Ç∂™e<
MAX_PLANE
;Çplane++ )

739 i‡(
p
->
JVmv_öfo
[
≈œ√
])

741 
	`‰ì_mem2Dmp
(
p
->
JVmv_öfo
[
≈œ√
]);

742 
p
->
JVmv_öfo
[
≈œ√
] = 
NULL
;

744 
	`‰ì_pic_mŸi⁄
(&
p
->
JVmŸi⁄
[
≈œ√
]);

746 
p
->
p_cuº_img
 = 
NULL
;

747 
p
->
p_cuº_img_sub
 = 
NULL
;

748 
p
->
p_img
[0] = 
NULL
;

749 
p
->
p_img
[1] = 
NULL
;

750 
p
->
p_img
[2] = 
NULL
;

751 
p
->
p_img_sub
[0] = 
NULL
;

752 
p
->
p_img_sub
[1] = 
NULL
;

753 
p
->
p_img_sub
[2] = 
NULL
;

756 i‡(
p_I≈
->
rd›t
 == 3)

758 
	`îrdo_‰ì_°‹abÀ_pi˘uª
(
p
);

761 
	`‰ì
(
p
);

762 
p
 = 
NULL
;

764 
	}
}

773 
	$unm¨k_f‹_ª„ªn˚
(
FømeSt‹e
* 
fs
)

775 i‡(
fs
->
is_u£d
 & 1)

777 i‡(
fs
->
t›_fõld
)

779 
fs
->
t›_fõld
->
u£d_f‹_ª„ªn˚
 = 0;

782 i‡(
fs
->
is_u£d
 & 2)

784 i‡(
fs
->
bŸtom_fõld
)

786 
fs
->
bŸtom_fõld
->
u£d_f‹_ª„ªn˚
 = 0;

789 i‡(
fs
->
is_u£d
 == 3)

791 i‡(
fs
->
t›_fõld
 && fs->
bŸtom_fõld
)

793 
fs
->
t›_fõld
->
u£d_f‹_ª„ªn˚
 = 0;

794 
fs
->
bŸtom_fõld
->
u£d_f‹_ª„ªn˚
 = 0;

796 
fs
->
‰ame
->
u£d_f‹_ª„ªn˚
 = 0;

799 
fs
->
is_ª„ªn˚
 = 0;

801 
	`‰ì_‰ame_d©a_mem‹y
(
fs
->
‰ame
, 0);

802 
	`‰ì_‰ame_d©a_mem‹y
(
fs
->
t›_fõld
, 0);

803 
	`‰ì_‰ame_d©a_mem‹y
(
fs
->
bŸtom_fõld
, 0);

804 
	}
}

814 
	$unm¨k_f‹_l⁄g_ãrm_ª„ªn˚
(
FømeSt‹e
* 
fs
)

816 i‡(
fs
->
is_u£d
 & 1)

818 i‡(
fs
->
t›_fõld
)

820 
fs
->
t›_fõld
->
u£d_f‹_ª„ªn˚
 = 0;

821 
fs
->
t›_fõld
->
is_l⁄g_ãrm
 = 0;

824 i‡(
fs
->
is_u£d
 & 2)

826 i‡(
fs
->
bŸtom_fõld
)

828 
fs
->
bŸtom_fõld
->
u£d_f‹_ª„ªn˚
 = 0;

829 
fs
->
bŸtom_fõld
->
is_l⁄g_ãrm
 = 0;

832 i‡(
fs
->
is_u£d
 == 3)

834 i‡(
fs
->
t›_fõld
 && fs->
bŸtom_fõld
)

836 
fs
->
t›_fõld
->
u£d_f‹_ª„ªn˚
 = 0;

837 
fs
->
t›_fõld
->
is_l⁄g_ãrm
 = 0;

838 
fs
->
bŸtom_fõld
->
u£d_f‹_ª„ªn˚
 = 0;

839 
fs
->
bŸtom_fõld
->
is_l⁄g_ãrm
 = 0;

841 
fs
->
‰ame
->
u£d_f‹_ª„ªn˚
 = 0;

842 
fs
->
‰ame
->
is_l⁄g_ãrm
 = 0;

845 
	`‰ì_‰ame_d©a_mem‹y
(
fs
->
‰ame
, 0);

846 
	`‰ì_‰ame_d©a_mem‹y
(
fs
->
t›_fõld
, 0);

847 
	`‰ì_‰ame_d©a_mem‹y
(
fs
->
bŸtom_fõld
, 0);

849 
fs
->
is_ª„ªn˚
 = 0;

850 
fs
->
is_l⁄g_ãrm
 = 0;

851 
	}
}

855 
	$upd©e_pic_num
(
Sli˚
 *
cuºSli˚
)

857 
i
;

859 
DecodedPi˘uªBuf„r
 *
p_Dpb
 = 
cuºSli˚
->p_Dpb;

861 
add_t›
 = 0, 
add_bŸtom
 = 0;

863 
max_‰ame_num
 = 
cuºSli˚
->max_frame_num;

866 i‡(
cuºSli˚
->
°ru˘uª
 =
FRAME
)

868 
i
=0; i<
p_Dpb
->
ªf_‰ames_ö_buf„r
; i++)

870 i‡–
p_Dpb
->
fs_ªf
[
i
]->
is_u£d
==3 )

872 i‡((
p_Dpb
->
fs_ªf
[
i
]->
‰ame
->
u£d_f‹_ª„ªn˚
)&&(!p_Dpb->fs_ªf[i]->‰ame->
is_l⁄g_ãrm
))

874 if–
p_Dpb
->
fs_ªf
[
i
]->
‰ame_num
 > 
cuºSli˚
->frame_num )

876 
p_Dpb
->
fs_ªf
[
i
]->
‰ame_num_wøp
 =Ö_Dpb->fs_ªf[i]->
‰ame_num
 - 
max_‰ame_num
;

880 
p_Dpb
->
fs_ªf
[
i
]->
‰ame_num_wøp
 =Ö_Dpb->fs_ªf[i]->
‰ame_num
;

882 
p_Dpb
->
fs_ªf
[
i
]->
‰ame
->
pic_num
 =Ö_Dpb->fs_ªf[i]->
‰ame_num_wøp
;

887 
i
 = 0; i < 
p_Dpb
->
…ªf_‰ames_ö_buf„r
; i++)

889 i‡(
p_Dpb
->
fs_…ªf
[
i
]->
is_u£d
==3)

891 i‡(
p_Dpb
->
fs_…ªf
[
i
]->
‰ame
->
is_l⁄g_ãrm
)

893 
p_Dpb
->
fs_…ªf
[
i
]->
‰ame
->
l⁄g_ãrm_pic_num
 =Ö_Dpb->fs_…ªf[i]->‰ame->
l⁄g_ãrm_‰ame_idx
;

900 i‡(
cuºSli˚
->
°ru˘uª
 =
TOP_FIELD
)

902 
add_t›
 = 1;

903 
add_bŸtom
 = 0;

907 
add_t›
 = 0;

908 
add_bŸtom
 = 1;

911 
i
=0; i<
p_Dpb
->
ªf_‰ames_ö_buf„r
; i++)

913 i‡(
p_Dpb
->
fs_ªf
[
i
]->
is_ª„ªn˚
)

915 if–
p_Dpb
->
fs_ªf
[
i
]->
‰ame_num
 > 
cuºSli˚
->frame_num )

917 
p_Dpb
->
fs_ªf
[
i
]->
‰ame_num_wøp
 =Ö_Dpb->fs_ªf[i]->
‰ame_num
 - 
max_‰ame_num
;

921 
p_Dpb
->
fs_ªf
[
i
]->
‰ame_num_wøp
 =Ö_Dpb->fs_ªf[i]->
‰ame_num
;

923 i‡(
p_Dpb
->
fs_ªf
[
i
]->
is_ª„ªn˚
 & 1)

925 
p_Dpb
->
fs_ªf
[
i
]->
t›_fõld
->
pic_num
 = (2 *Ö_Dpb->fs_ªf[i]->
‰ame_num_wøp
Ë+ 
add_t›
;

927 i‡(
p_Dpb
->
fs_ªf
[
i
]->
is_ª„ªn˚
 & 2)

929 
p_Dpb
->
fs_ªf
[
i
]->
bŸtom_fõld
->
pic_num
 = (2 *Ö_Dpb->fs_ªf[i]->
‰ame_num_wøp
Ë+ 
add_bŸtom
;

934 
i
=0; i<
p_Dpb
->
…ªf_‰ames_ö_buf„r
; i++)

936 i‡(
p_Dpb
->
fs_…ªf
[
i
]->
is_l⁄g_ãrm
 & 1)

938 
p_Dpb
->
fs_…ªf
[
i
]->
t›_fõld
->
l⁄g_ãrm_pic_num
 = 2 *Ö_Dpb->fs_…ªf[i]->t›_fõld->
l⁄g_ãrm_‰ame_idx
 + 
add_t›
;

940 i‡(
p_Dpb
->
fs_…ªf
[
i
]->
is_l⁄g_ãrm
 & 2)

942 
p_Dpb
->
fs_…ªf
[
i
]->
bŸtom_fõld
->
l⁄g_ãrm_pic_num
 = 2 *Ö_Dpb->fs_…ªf[i]->bŸtom_fõld->
l⁄g_ãrm_‰ame_idx
 + 
add_bŸtom
;

946 
	}
}

954 
	$öô_li°s_i_¶i˚
(
Sli˚
 *
cuºSli˚
)

956 
cuºSli˚
->
li°Xsize
[0] = 0;

957 
cuºSli˚
->
li°Xsize
[1] = 0;

958 
	}
}

969 
	$öô_li°s_p_¶i˚
(
Sli˚
 *
cuºSli˚
)

971 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

972 
DecodedPi˘uªBuf„r
 *
p_Dpb
 = 
cuºSli˚
->p_Dpb;

974 
i
, 
j
;

976 
li°0idx
 = 0;

977 
li°…idx
 = 0;

979 #i‡(
MVC_EXTENSION_ENABLE
)

980 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºSli˚
->p_Inp;

981 
öãrvõw_pos
 = 0;

984 
FømeSt‹e
 **
fs_li°0
;

985 
FømeSt‹e
 **
fs_li°…
;

987 
i
 = 0; i < 6; i++)

989 
cuºSli˚
->
li°X
[
i
] = 
	`ˇŒoc
(
MAX_LIST_SIZE
,  (
St‹abÀPi˘uª
*));

990 i‡(
NULL
 =
cuºSli˚
->
li°X
[
i
])

991 
	`no_mem_exô
("init_dpb: currSlice->listX[i]");

994 
j
 = 0; j < 6; j++)

996 
i
 = 0; i < 
MAX_LIST_SIZE
; i++)

998 
cuºSli˚
->
li°X
[
j
][
i
] = 
NULL
;

1000 
cuºSli˚
->
li°Xsize
[
j
]=0;

1004 i‡(
cuºSli˚
->
°ru˘uª
 =
FRAME
)

1006 
i
=0; i<
p_Dpb
->
ªf_‰ames_ö_buf„r
; i++)

1008 i‡(
p_Dpb
->
fs_ªf
[
i
]->
is_u£d
==3)

1010 i‡((
p_Dpb
->
fs_ªf
[
i
]->
‰ame
->
u£d_f‹_ª„ªn˚
)&&(!p_Dpb->fs_ªf[i]->‰ame->
is_l⁄g_ãrm
))

1012 
cuºSli˚
->
li°X
[0][
li°0idx
++] = 
p_Dpb
->
fs_ªf
[
i
]->
‰ame
;

1017 
	`qs‹t
((*)
cuºSli˚
->
li°X
[0], 
li°0idx
, (
St‹abÀPi˘uª
*), 
com∑ª_pic_by_pic_num_desc
);

1018 
cuºSli˚
->
li°Xsize
[0] = (Ë
li°0idx
;

1022 
i
=0; i<
p_Dpb
->
…ªf_‰ames_ö_buf„r
; i++)

1024 i‡(
p_Dpb
->
fs_…ªf
[
i
]->
is_u£d
==3)

1026 i‡(
p_Dpb
->
fs_…ªf
[
i
]->
‰ame
->
is_l⁄g_ãrm
)

1028 
cuºSli˚
->
li°X
[0][
li°0idx
++] = 
p_Dpb
->
fs_…ªf
[
i
]->
‰ame
;

1032 
	`qs‹t
((*)&
cuºSli˚
->
li°X
[0][(ËcuºSli˚->
li°Xsize
[0]], 
li°0idx
 - cuºSli˚->li°Xsize[0], (
St‹abÀPi˘uª
*), 
com∑ª_pic_by_…_pic_num_asc
);

1033 
cuºSli˚
->
li°Xsize
[0] = (Ë
li°0idx
;

1037 
fs_li°0
 = 
	`ˇŒoc
(
p_Dpb
->
size
,  (
FømeSt‹e
*));

1038 i‡(
NULL
==
fs_li°0
)

1039 
	`no_mem_exô
("init_lists: fs_list0");

1040 
fs_li°…
 = 
	`ˇŒoc
(
p_Dpb
->
size
,  (
FømeSt‹e
*));

1041 i‡(
NULL
==
fs_li°…
)

1042 
	`no_mem_exô
("init_lists: fs_listlt");

1044 
i
=0; i<
p_Dpb
->
ªf_‰ames_ö_buf„r
; i++)

1046 i‡(
p_Dpb
->
fs_ªf
[
i
]->
is_ª„ªn˚
)

1048 
fs_li°0
[
li°0idx
++] = 
p_Dpb
->
fs_ªf
[
i
];

1052 
	`qs‹t
((*)
fs_li°0
, 
li°0idx
, (
FømeSt‹e
*), 
com∑ª_fs_by_‰ame_num_desc
);

1056 
cuºSli˚
->
li°Xsize
[0] = 0;

1057 
	`gí_pic_li°_‰om_‰ame_li°
(
cuºSli˚
->
°ru˘uª
, 
fs_li°0
, 
li°0idx
, cuºSli˚->
li°X
[0], &cuºSli˚->
li°Xsize
[0], 0);

1062 
i
=0; i<
p_Dpb
->
…ªf_‰ames_ö_buf„r
; i++)

1064 
fs_li°…
[
li°…idx
++]=
p_Dpb
->
fs_…ªf
[
i
];

1067 
	`qs‹t
((*)
fs_li°…
, 
li°…idx
, (
FømeSt‹e
*), 
com∑ª_fs_by_…_pic_idx_asc
);

1069 
	`gí_pic_li°_‰om_‰ame_li°
(
cuºSli˚
->
°ru˘uª
, 
fs_li°…
, 
li°…idx
, cuºSli˚->
li°X
[0], &cuºSli˚->
li°Xsize
[0], 1);

1071 
	`‰ì
(
fs_li°0
);

1072 
	`‰ì
(
fs_li°…
);

1074 
cuºSli˚
->
li°Xsize
[1] = 0;

1077 #i‡(
MVC_EXTENSION_ENABLE
 && !
SIMULCAST_ENABLE
)

1079 if(
p_I≈
->
num_of_võws
 =2 && 
p_Vid
->
võw_id
 == 1)

1081 
St‹abÀPi˘uª
 *
ba£_ªf
;

1082 if(
cuºSli˚
->
°ru˘uª
 =
FRAME
)

1084 
cuºSli˚
->
li°Xsize
[0] = (Ë
	`imö
 (cuºSli˚->li°Xsize[0], cuºSli˚->
num_ªf_idx_a˘ive
[
LIST_0
]);

1085 
cuºSli˚
->
li°Xsize
[1] = (Ë
	`imö
 (cuºSli˚->li°Xsize[1], cuºSli˚->
num_ªf_idx_a˘ive
[
LIST_1
]);

1086 
li°0idx
 = 
cuºSli˚
->
li°Xsize
[0];

1091 
öãrvõw_pos
 = 0;

1092 
ba£_ªf
 = 
p_Dpb
->
fs_ûªf
[
öãrvõw_pos
]->
‰ame
;

1094 i‡(
ba£_ªf
->
u£d_f‹_ª„ªn˚
 || ba£_ªf->
öãr_võw_Êag
[0])

1097 
p_Dpb
->
fs_ûªf
[
öãrvõw_pos
]->
‰ame_num_wøp
 = -99;

1098 
cuºSli˚
->
li°X
[0][
li°0idx
++] = 
ba£_ªf
;

1099 
cuºSli˚
->
li°Xsize
[0] = (Ë
li°0idx
;

1104 
cur_öãr_võw_Êag
 = 
cuºSli˚
->
°ru˘uª
 !
BOTTOM_FIELD
 ? 0 : 1;

1105 
cuºSli˚
->
li°Xsize
[0] = (Ë
	`imö
 (cuºSli˚->li°Xsize[0], cuºSli˚->
num_ªf_idx_a˘ive
[
LIST_0
]);

1106 
cuºSli˚
->
li°Xsize
[1] = (Ë
	`imö
 (cuºSli˚->li°Xsize[1], cuºSli˚->
num_ªf_idx_a˘ive
[
LIST_1
]);

1107 
li°0idx
 = 
cuºSli˚
->
li°Xsize
[0];

1112 
öãrvõw_pos
 = 0;

1113 
ba£_ªf
 = 
cuºSli˚
->
°ru˘uª
!=
BOTTOM_FIELD
? 
p_Dpb
->
fs_ûªf
[
öãrvõw_pos
]->
t›_fõld
:p_Dpb->fs_ûªf[öãrvõw_pos]->
bŸtom_fõld
;

1114 i‡(
ba£_ªf
->
u£d_f‹_ª„ªn˚
 || ba£_ªf->
öãr_võw_Êag
[
cur_öãr_võw_Êag
])

1117 
p_Dpb
->
fs_ûªf
[
öãrvõw_pos
]->
‰ame_num_wøp
 = -99;

1118 
cuºSli˚
->
li°X
[0][
li°0idx
++] = 
ba£_ªf
;

1119 
cuºSli˚
->
li°Xsize
[0] = (Ë
li°0idx
;

1126 #i‡(
MVC_EXTENSION_ENABLE
)

1127 if(
p_Vid
->
num_of_œyîs
 =2 && 
p_I≈
->
MVCI¡îVõwRe‹dî
 &&Ö_Vid->
võw_id
 == 1)

1129 
cuºSli˚
->
li°Xsize
[0] = (Ë
	`imö
 (cuºSli˚->li°Xsize[0], cuºSli˚->
num_ªf_idx_a˘ive
[
LIST_0
] + 1);

1130 
cuºSli˚
->
li°Xsize
[1] = (Ë
	`imö
 (cuºSli˚->li°Xsize[1], cuºSli˚->
num_ªf_idx_a˘ive
[
LIST_1
]);

1135 
cuºSli˚
->
li°Xsize
[0] = (Ë
	`imö
 (cuºSli˚->li°Xsize[0], cuºSli˚->
num_ªf_idx_a˘ive
[
LIST_0
]);

1136 
cuºSli˚
->
li°Xsize
[1] = (Ë
	`imö
 (cuºSli˚->li°Xsize[1], cuºSli˚->
num_ªf_idx_a˘ive
[
LIST_1
]);

1140 
i
=
cuºSli˚
->
li°Xsize
[0]; i< (
MAX_LIST_SIZE
) ; i++)

1142 
cuºSli˚
->
li°X
[0][
i
] = 
NULL
;

1144 
i
=
cuºSli˚
->
li°Xsize
[1]; i< (
MAX_LIST_SIZE
) ; i++)

1146 
cuºSli˚
->
li°X
[1][
i
] = 
NULL
;

1149 #i‡
PRINTREFLIST


1150 #i‡(
MVC_EXTENSION_ENABLE
)

1152 if(
p_I≈
->
num_of_võws
==2 && 
p_Vid
->
cuºít_¶i˚_ƒ
==0)

1154 if(
cuºSli˚
->
li°Xsize
[0]>0)

1156 
	`¥ötf
("\n");

1157 
	`¥ötf
(" ** (CurVõwID:%dË%†Re‡Pi¯Li° 0 ****\n", 
p_Vid
->
võw_id
, 
cuºSli˚
->
°ru˘uª
==
FRAME
 ? "FRM":(cuºSli˚->°ru˘uª==
TOP_FIELD
 ? "TOP":"BOT"));

1158 
i
=0; i<()(
cuºSli˚
->
li°Xsize
[0]); i++)

1160 
	`¥ötf
(" %2d -> POC: %4d PicNum: %4d VõwID: %d\n", 
i
, 
cuºSli˚
->
li°X
[0][i]->
poc
, cuºSli˚->li°X[0][i]->
pic_num
, cuºSli˚->li°X[0][i]->
võw_id
);

1166 
	}
}

1176 
	$öô_li°s_b_¶i˚
(
Sli˚
 *
cuºSli˚
)

1178 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

1179 
DecodedPi˘uªBuf„r
 *
p_Dpb
 = 
cuºSli˚
->p_Dpb;

1181 
i
;

1182 
j
;

1184 
li°0idx
 = 0;

1185 
li°0idx_1
 = 0;

1186 
li°…idx
 = 0;

1188 #i‡(
MVC_EXTENSION_ENABLE
)

1189 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºSli˚
->p_Inp;

1190 
li°1idx
 = 0;

1191 
öãrvõw_pos
 = 0;

1194 
FømeSt‹e
 **
fs_li°0
;

1195 
FømeSt‹e
 **
fs_li°1
;

1196 
FømeSt‹e
 **
fs_li°…
;

1199 
i
 = 0; i < 6; i++)

1201 
cuºSli˚
->
li°X
[
i
] = 
	`ˇŒoc
(
MAX_LIST_SIZE
,  (
St‹abÀPi˘uª
*));

1202 i‡(
NULL
 =
cuºSli˚
->
li°X
[
i
])

1203 
	`no_mem_exô
("init_dpb: currSlice->listX[i]");

1206 
j
 = 0; j < 6; j++)

1208 
i
 = 0; i < 
MAX_LIST_SIZE
; i++)

1210 
cuºSli˚
->
li°X
[
j
][
i
] = 
NULL
;

1212 
cuºSli˚
->
li°Xsize
[
j
]=0;

1217 i‡(
cuºSli˚
->
°ru˘uª
 =
FRAME
)

1219 
i
 = 0; i < 
p_Dpb
->
ªf_‰ames_ö_buf„r
; i++)

1221 i‡(
p_Dpb
->
fs_ªf
[
i
]->
is_u£d
==3)

1223 i‡((
p_Dpb
->
fs_ªf
[
i
]->
‰ame
->
u£d_f‹_ª„ªn˚
)&&(!p_Dpb->fs_ªf[i]->‰ame->
is_l⁄g_ãrm
))

1225 i‡(
cuºSli˚
->
‰amïoc
 > 
p_Dpb
->
fs_ªf
[
i
]->
‰ame
->
poc
)

1227 
cuºSli˚
->
li°X
[0][
li°0idx
++] = 
p_Dpb
->
fs_ªf
[
i
]->
‰ame
;

1232 
	`qs‹t
((*)
cuºSli˚
->
li°X
[0], 
li°0idx
, (
St‹abÀPi˘uª
*), 
com∑ª_pic_by_poc_desc
);

1235 
li°0idx_1
 = 
li°0idx
;

1236 
i
=0; i<
p_Dpb
->
ªf_‰ames_ö_buf„r
; i++)

1238 i‡(
p_Dpb
->
fs_ªf
[
i
]->
is_u£d
==3)

1240 i‡((
p_Dpb
->
fs_ªf
[
i
]->
‰ame
->
u£d_f‹_ª„ªn˚
)&&(!p_Dpb->fs_ªf[i]->‰ame->
is_l⁄g_ãrm
))

1242 i‡(
cuºSli˚
->
‰amïoc
 < 
p_Dpb
->
fs_ªf
[
i
]->
‰ame
->
poc
)

1244 
cuºSli˚
->
li°X
[0][
li°0idx
++] = 
p_Dpb
->
fs_ªf
[
i
]->
‰ame
;

1249 
	`qs‹t
((*)&
cuºSli˚
->
li°X
[0][
li°0idx_1
], 
li°0idx
-li°0idx_1, (
St‹abÀPi˘uª
*), 
com∑ª_pic_by_poc_asc
);

1251 
j
=0; j<
li°0idx_1
; j++)

1253 
cuºSli˚
->
li°X
[1][
li°0idx
-
li°0idx_1
+
j
]=currSlice->listX[0][j];

1255 
j
=
li°0idx_1
; j<
li°0idx
; j++)

1257 
cuºSli˚
->
li°X
[1][
j
-
li°0idx_1
]=currSlice->listX[0][j];

1260 
cuºSli˚
->
li°Xsize
[0] = cuºSli˚->li°Xsize[1] = (Ë
li°0idx
;

1266 
i
=0; i<
p_Dpb
->
…ªf_‰ames_ö_buf„r
; i++)

1268 i‡(
p_Dpb
->
fs_…ªf
[
i
]->
is_u£d
==3)

1270 i‡(
p_Dpb
->
fs_…ªf
[
i
]->
‰ame
->
is_l⁄g_ãrm
)

1272 
cuºSli˚
->
li°X
[0][
li°0idx
] = 
p_Dpb
->
fs_…ªf
[
i
]->
‰ame
;

1273 
cuºSli˚
->
li°X
[1][
li°0idx
++] = 
p_Dpb
->
fs_…ªf
[
i
]->
‰ame
;

1277 
	`qs‹t
((*)&
cuºSli˚
->
li°X
[0][(ËcuºSli˚->
li°Xsize
[0]], 
li°0idx
 - cuºSli˚->li°Xsize[0], (
St‹abÀPi˘uª
*), 
com∑ª_pic_by_…_pic_num_asc
);

1278 
	`qs‹t
((*)&
cuºSli˚
->
li°X
[1][(ËcuºSli˚->
li°Xsize
[0]], 
li°0idx
 - cuºSli˚->li°Xsize[0], (
St‹abÀPi˘uª
*), 
com∑ª_pic_by_…_pic_num_asc
);

1279 
cuºSli˚
->
li°Xsize
[0] = cuºSli˚->li°Xsize[1] = (Ë
li°0idx
;

1283 
fs_li°0
 = 
	`ˇŒoc
(
p_Dpb
->
size
,  (
FømeSt‹e
*));

1284 i‡(
NULL
==
fs_li°0
)

1285 
	`no_mem_exô
("init_lists: fs_list0");

1286 
fs_li°1
 = 
	`ˇŒoc
(
p_Dpb
->
size
,  (
FømeSt‹e
*));

1287 i‡(
NULL
==
fs_li°1
)

1288 
	`no_mem_exô
("init_lists: fs_list1");

1289 
fs_li°…
 = 
	`ˇŒoc
(
p_Dpb
->
size
,  (
FømeSt‹e
*));

1290 i‡(
NULL
==
fs_li°…
)

1291 
	`no_mem_exô
("init_lists: fs_listlt");

1293 
cuºSli˚
->
li°Xsize
[0] = 0;

1294 
cuºSli˚
->
li°Xsize
[1] = 1;

1296 
i
=0; i<
p_Dpb
->
ªf_‰ames_ö_buf„r
; i++)

1298 i‡(
p_Dpb
->
fs_ªf
[
i
]->
is_u£d
)

1300 i‡(
cuºSli˚
->
ThisPOC
 >
p_Dpb
->
fs_ªf
[
i
]->
poc
)

1302 
fs_li°0
[
li°0idx
++] = 
p_Dpb
->
fs_ªf
[
i
];

1306 
	`qs‹t
((*)
fs_li°0
, 
li°0idx
, (
FømeSt‹e
*), 
com∑ª_fs_by_poc_desc
);

1307 
li°0idx_1
 = 
li°0idx
;

1308 
i
=0; i<
p_Dpb
->
ªf_‰ames_ö_buf„r
; i++)

1310 i‡(
p_Dpb
->
fs_ªf
[
i
]->
is_u£d
)

1312 i‡(
cuºSli˚
->
ThisPOC
 < 
p_Dpb
->
fs_ªf
[
i
]->
poc
)

1314 
fs_li°0
[
li°0idx
++] = 
p_Dpb
->
fs_ªf
[
i
];

1318 
	`qs‹t
((*)&
fs_li°0
[
li°0idx_1
], 
li°0idx
-li°0idx_1, (
FømeSt‹e
*), 
com∑ª_fs_by_poc_asc
);

1320 
j
=0; j<
li°0idx_1
; j++)

1322 
fs_li°1
[
li°0idx
-
li°0idx_1
+
j
]=
fs_li°0
[j];

1324 
j
=
li°0idx_1
; j<
li°0idx
; j++)

1326 
fs_li°1
[
j
-
li°0idx_1
]=
fs_li°0
[j];

1332 
cuºSli˚
->
li°Xsize
[0] = 0;

1333 
cuºSli˚
->
li°Xsize
[1] = 0;

1334 
	`gí_pic_li°_‰om_‰ame_li°
(
cuºSli˚
->
°ru˘uª
, 
fs_li°0
, 
li°0idx
, cuºSli˚->
li°X
[0], &cuºSli˚->
li°Xsize
[0], 0);

1335 
	`gí_pic_li°_‰om_‰ame_li°
(
cuºSli˚
->
°ru˘uª
, 
fs_li°1
, 
li°0idx
, cuºSli˚->
li°X
[1], &cuºSli˚->
li°Xsize
[1], 0);

1341 
i
=0; i<
p_Dpb
->
…ªf_‰ames_ö_buf„r
; i++)

1343 
fs_li°…
[
li°…idx
++]=
p_Dpb
->
fs_…ªf
[
i
];

1346 
	`qs‹t
((*)
fs_li°…
, 
li°…idx
, (
FømeSt‹e
*), 
com∑ª_fs_by_…_pic_idx_asc
);

1348 
	`gí_pic_li°_‰om_‰ame_li°
(
cuºSli˚
->
°ru˘uª
, 
fs_li°…
, 
li°…idx
, cuºSli˚->
li°X
[0], &cuºSli˚->
li°Xsize
[0], 1);

1349 
	`gí_pic_li°_‰om_‰ame_li°
(
cuºSli˚
->
°ru˘uª
, 
fs_li°…
, 
li°…idx
, cuºSli˚->
li°X
[1], &cuºSli˚->
li°Xsize
[1], 1);

1351 
	`‰ì
(
fs_li°0
);

1352 
	`‰ì
(
fs_li°1
);

1353 
	`‰ì
(
fs_li°…
);

1357 i‡((
cuºSli˚
->
li°Xsize
[0] == currSlice->listXsize[1]) && (currSlice->listXsize[0] > 1))

1360 
diff
=0;

1361 
j
 = 0; j< 
cuºSli˚
->
li°Xsize
[0]; j++)

1363 i‡(
cuºSli˚
->
li°X
[0][
j
] != currSlice->listX[1][j])

1365 
diff
 = 1;

1369 i‡(!
diff
)

1371 
St‹abÀPi˘uª
 *
tmp_s
 = 
cuºSli˚
->
li°X
[1][0];

1372 
cuºSli˚
->
li°X
[1][0]=currSlice->listX[1][1];

1373 
cuºSli˚
->
li°X
[1][1]=
tmp_s
;

1377 #i‡(
MVC_EXTENSION_ENABLE
 && !
SIMULCAST_ENABLE
)

1379 if(
p_I≈
->
num_of_võws
 =2 && 
p_Vid
->
võw_id
 == 1)

1381 
St‹abÀPi˘uª
 *
ba£_ªf
;

1382 if(
cuºSli˚
->
°ru˘uª
 =
FRAME
)

1384 
cuºSli˚
->
li°Xsize
[0] = (Ë
	`imö
 (cuºSli˚->li°Xsize[0], cuºSli˚->
num_ªf_idx_a˘ive
[
LIST_0
]);

1385 
cuºSli˚
->
li°Xsize
[1] = (Ë
	`imö
 (cuºSli˚->li°Xsize[1], cuºSli˚->
num_ªf_idx_a˘ive
[
LIST_1
]);

1386 
li°0idx
 = 
cuºSli˚
->
li°Xsize
[0];

1387 
li°1idx
 = 
cuºSli˚
->
li°Xsize
[1];

1392 
öãrvõw_pos
 = 0;

1393 
ba£_ªf
 = 
p_Dpb
->
fs_ûªf
[
öãrvõw_pos
]->
‰ame
;

1395 i‡(
ba£_ªf
->
u£d_f‹_ª„ªn˚
 || ba£_ªf->
öãr_võw_Êag
[0])

1398 
p_Dpb
->
fs_ûªf
[
öãrvõw_pos
]->
‰ame_num_wøp
 = -99;

1399 
cuºSli˚
->
li°X
[0][
li°0idx
++] = 
ba£_ªf
;

1400 
cuºSli˚
->
li°X
[1][
li°1idx
++] = 
ba£_ªf
;

1401 
cuºSli˚
->
li°Xsize
[0] = (Ë
li°0idx
;

1402 
cuºSli˚
->
li°Xsize
[1] = (Ë
li°1idx
;

1407 
cur_öãr_võw_Êag
 = 
cuºSli˚
->
°ru˘uª
 !
BOTTOM_FIELD
 ? 0 : 1;

1408 
cuºSli˚
->
li°Xsize
[0] = (Ë
	`imö
 (cuºSli˚->li°Xsize[0], cuºSli˚->
num_ªf_idx_a˘ive
[
LIST_0
]);

1409 
cuºSli˚
->
li°Xsize
[1] = (Ë
	`imö
 (cuºSli˚->li°Xsize[1], cuºSli˚->
num_ªf_idx_a˘ive
[
LIST_1
]);

1410 
li°0idx
 = 
cuºSli˚
->
li°Xsize
[0];

1411 
li°1idx
 = 
cuºSli˚
->
li°Xsize
[1];

1416 
öãrvõw_pos
 = 0;

1417 
ba£_ªf
 = 
cuºSli˚
->
°ru˘uª
 !
BOTTOM_FIELD
 ? 
p_Dpb
->
fs_ûªf
[
öãrvõw_pos
]->
t›_fõld
:p_Dpb->fs_ûªf[öãrvõw_pos]->
bŸtom_fõld
;

1418 i‡(
ba£_ªf
->
u£d_f‹_ª„ªn˚
 || ba£_ªf->
öãr_võw_Êag
[
cur_öãr_võw_Êag
])

1421 
p_Dpb
->
fs_ûªf
[
öãrvõw_pos
]->
‰ame_num_wøp
 = -99;

1422 
cuºSli˚
->
li°X
[0][
li°0idx
++] = 
ba£_ªf
;

1423 
cuºSli˚
->
li°X
[1][
li°1idx
++] = 
ba£_ªf
;

1424 
cuºSli˚
->
li°Xsize
[0] = (Ë
li°0idx
;

1425 
cuºSli˚
->
li°Xsize
[1] = (Ë
li°1idx
;

1432 #i‡(
MVC_EXTENSION_ENABLE
)

1433 if(
p_Vid
->
num_of_œyîs
 =2 && 
p_I≈
->
MVCI¡îVõwRe‹dî
 &&Ö_Vid->
võw_id
 == 1)

1435 
cuºSli˚
->
li°Xsize
[0] = (Ë
	`imö
 (cuºSli˚->li°Xsize[0], cuºSli˚->
num_ªf_idx_a˘ive
[
LIST_0
] + 1);

1436 
cuºSli˚
->
li°Xsize
[1] = (Ë
	`imö
 (cuºSli˚->li°Xsize[1], cuºSli˚->
num_ªf_idx_a˘ive
[
LIST_1
]);

1441 
cuºSli˚
->
li°Xsize
[0] = (Ë
	`imö
 (cuºSli˚->li°Xsize[0], cuºSli˚->
num_ªf_idx_a˘ive
[
LIST_0
]);

1442 
cuºSli˚
->
li°Xsize
[1] = (Ë
	`imö
 (cuºSli˚->li°Xsize[1], cuºSli˚->
num_ªf_idx_a˘ive
[
LIST_1
]);

1446 
i
=
cuºSli˚
->
li°Xsize
[0]; i< (
MAX_LIST_SIZE
) ; i++)

1448 
cuºSli˚
->
li°X
[0][
i
] = 
NULL
;

1450 
i
=
cuºSli˚
->
li°Xsize
[1]; i< (
MAX_LIST_SIZE
) ; i++)

1452 
cuºSli˚
->
li°X
[1][
i
] = 
NULL
;

1455 #i‡
PRINTREFLIST


1456 #i‡(
MVC_EXTENSION_ENABLE
)

1458 if(
p_I≈
->
num_of_võws
==2 && 
p_Vid
->
cuºít_¶i˚_ƒ
==0)

1460 if((
cuºSli˚
->
li°Xsize
[0]>0) || (currSlice->listXsize[1]>0))

1461 
	`¥ötf
("\n");

1462 if(
cuºSli˚
->
li°Xsize
[0]>0)

1464 
	`¥ötf
(" ** (CurVõwID:%dË%†Re‡Pi¯Li° 0 ****\n", 
p_Vid
->
võw_id
, 
cuºSli˚
->
°ru˘uª
==
FRAME
 ? "FRM":(cuºSli˚->°ru˘uª==
TOP_FIELD
 ? "TOP":"BOT"));

1465 
i
=0; i<()(
cuºSli˚
->
li°Xsize
[0]); i++)

1467 
	`¥ötf
(" %2d -> POC: %4d PicNum: %4d VõwID: %d\n", 
i
, 
cuºSli˚
->
li°X
[0][i]->
poc
, cuºSli˚->li°X[0][i]->
pic_num
, cuºSli˚->li°X[0][i]->
võw_id
);

1470 if(
cuºSli˚
->
li°Xsize
[1]>0)

1472 
	`¥ötf
(" ** (CurVõwID:%dË%†Re‡Pi¯Li° 1 ****\n", 
p_Vid
->
võw_id
, 
cuºSli˚
->
°ru˘uª
==
FRAME
 ? "FRM":(cuºSli˚->°ru˘uª==
TOP_FIELD
 ? "TOP":"BOT"));

1473 
i
=0; i<()(
cuºSli˚
->
li°Xsize
[1]); i++)

1475 
	`¥ötf
(" %2d -> POC: %4d PicNum: %4d VõwID: %d\n", 
i
, 
cuºSli˚
->
li°X
[1][i]->
poc
, cuºSli˚->li°X[1][i]->
pic_num
, cuºSli˚->li°X[1][i]->
võw_id
);

1481 
	}
}

1494 
	$öô_mbaff_li°s
(
Sli˚
 *
cuºSli˚
)

1496 
j
;

1497 
i
;

1499 
i
=2;i<6;i++)

1501 if(
cuºSli˚
->
li°X
[
i
])

1503 
j
=0; j<
MAX_LIST_SIZE
; j++)

1505 
cuºSli˚
->
li°X
[
i
][
j
] = 
NULL
;

1508 
cuºSli˚
->
li°Xsize
[
i
]=0;

1511 
i
 = 0; i < 
cuºSli˚
->
li°Xsize
[0]; i++)

1513 
cuºSli˚
->
li°X
[2][2*
i
 ] = cuºSli˚->li°X[0][i]->
t›_fõld
;

1514 
cuºSli˚
->
li°X
[2][2*
i
+1] = cuºSli˚->li°X[0][i]->
bŸtom_fõld
;

1515 
cuºSli˚
->
li°X
[4][2*
i
 ] = cuºSli˚->li°X[0][i]->
bŸtom_fõld
;

1516 
cuºSli˚
->
li°X
[4][2*
i
+1] = cuºSli˚->li°X[0][i]->
t›_fõld
;

1518 
cuºSli˚
->
li°Xsize
[2] = currSlice->listXsize[4] = currSlice->listXsize[0] * 2;

1520 
i
 = 0; i < 
cuºSli˚
->
li°Xsize
[1]; i++)

1522 
cuºSli˚
->
li°X
[3][2*
i
 ] = cuºSli˚->li°X[1][i]->
t›_fõld
;

1523 
cuºSli˚
->
li°X
[3][2*
i
+1] = cuºSli˚->li°X[1][i]->
bŸtom_fõld
;

1524 
cuºSli˚
->
li°X
[5][2*
i
 ] = cuºSli˚->li°X[1][i]->
bŸtom_fõld
;

1525 
cuºSli˚
->
li°X
[5][2*
i
+1] = cuºSli˚->li°X[1][i]->
t›_fõld
;

1527 
cuºSli˚
->
li°Xsize
[3] = currSlice->listXsize[5] = currSlice->listXsize[1] * 2;

1528 
	}
}

1537 
St‹abÀPi˘uª
 *
	$gë_sh‹t_ãrm_pic
(
Sli˚
 *
cuºSli˚
, 
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
picNum
)

1539 
i
;

1541 
i
 = 0; i < 
p_Dpb
->
ªf_‰ames_ö_buf„r
; i++)

1543 i‡(
cuºSli˚
->
°ru˘uª
 =
FRAME
)

1545 i‡(
p_Dpb
->
fs_ªf
[
i
]->
is_ª„ªn˚
 == 3)

1546 i‡((!
p_Dpb
->
fs_ªf
[
i
]->
‰ame
->
is_l⁄g_ãrm
)&&’_Dpb->fs_ªf[i]->‰ame->
pic_num
 =
picNum
))

1547  
p_Dpb
->
fs_ªf
[
i
]->
‰ame
;

1551 i‡(
p_Dpb
->
fs_ªf
[
i
]->
is_ª„ªn˚
 & 1)

1552 i‡((!
p_Dpb
->
fs_ªf
[
i
]->
t›_fõld
->
is_l⁄g_ãrm
)&&’_Dpb->fs_ªf[i]->t›_fõld->
pic_num
 =
picNum
))

1553  
p_Dpb
->
fs_ªf
[
i
]->
t›_fõld
;

1554 i‡(
p_Dpb
->
fs_ªf
[
i
]->
is_ª„ªn˚
 & 2)

1555 i‡((!
p_Dpb
->
fs_ªf
[
i
]->
bŸtom_fõld
->
is_l⁄g_ãrm
)&&’_Dpb->fs_ªf[i]->bŸtom_fõld->
pic_num
 =
picNum
))

1556  
p_Dpb
->
fs_ªf
[
i
]->
bŸtom_fõld
;

1559  
NULL
;

1560 
	}
}

1570 
	$ª‹dî_sh‹t_ãrm
(
Sli˚
 *
cuºSli˚
, 
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
cur_li°
, 
picNumLX
, *
ªfIdxLX
)

1572 
St‹abÀPi˘uª
 **
RefPicLi°X
 = 
cuºSli˚
->
li°X
[
cur_li°
];

1573 
cIdx
, 
nIdx
;

1575 
St‹abÀPi˘uª
 *
picLX
;

1577 
picLX
 = 
	`gë_sh‹t_ãrm_pic
(
cuºSli˚
, 
p_Dpb
, 
picNumLX
);

1579  
cIdx
 = 
cuºSli˚
->
num_ªf_idx_a˘ive
[
cur_li°
]; cIdx > *
ªfIdxLX
; cIdx-- )

1580 
RefPicLi°X
[ 
cIdx
 ] = RefPicListX[ cIdx - 1];

1582 
RefPicLi°X
[ (*
ªfIdxLX
)++ ] = 
picLX
;

1584 
nIdx
 = *
ªfIdxLX
;

1586  
cIdx
 = *
ªfIdxLX
; cIdx <
cuºSli˚
->
num_ªf_idx_a˘ive
[
cur_li°
]; cIdx++ )

1588 i‡(
RefPicLi°X
[ 
cIdx
 ])

1589 if–(
RefPicLi°X
[ 
cIdx
 ]->
is_l⁄g_ãrm
 ) || (RefPicLi°X[ cIdx ]->
pic_num
 !
picNumLX
 ))

1590 
RefPicLi°X
[ 
nIdx
++ ] = RefPicLi°X[ 
cIdx
 ];

1592 
	}
}

1602 
	$ª‹dî_l⁄g_ãrm
(
Sli˚
 *
cuºSli˚
, 
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
St‹abÀPi˘uª
 **
RefPicLi°X
, 
cur_li°
, 
‰ame_no
, *
ªfIdxLX
)

1604 
cIdx
, 
nIdx
;

1605 
L⁄gTîmPicNum
 = 
cuºSli˚
->
l⁄g_ãrm_pic_idx
[
cur_li°
][
‰ame_no
];

1607 
St‹abÀPi˘uª
 *
picLX
;

1609 
picLX
 = 
	`gë_l⁄g_ãrm_pic
(
cuºSli˚
, 
p_Dpb
, 
L⁄gTîmPicNum
);

1611  
cIdx
 = 
cuºSli˚
->
num_ªf_idx_a˘ive
[
cur_li°
]; cIdx > *
ªfIdxLX
; cIdx-- )

1612 
RefPicLi°X
[ 
cIdx
 ] = RefPicListX[ cIdx - 1];

1614 
RefPicLi°X
[ (*
ªfIdxLX
)++ ] = 
picLX
;

1616 
nIdx
 = *
ªfIdxLX
;

1618  
cIdx
 = *
ªfIdxLX
; cIdx <
cuºSli˚
->
num_ªf_idx_a˘ive
[
cur_li°
]; cIdx++ )

1619 if–(!
RefPicLi°X
[ 
cIdx
 ]->
is_l⁄g_ãrm
 ) || (RefPicLi°X[ cIdx ]->
l⁄g_ãrm_pic_num
 !
L⁄gTîmPicNum
 ))

1620 
RefPicLi°X
[ 
nIdx
++ ] = RefPicLi°X[ 
cIdx
 ];

1621 
	}
}

1632 
	$ª‹dî_ªf_pic_li°
(
Sli˚
 *
cuºSli˚
, 
cur_li°
)

1634 *
modifiˇti⁄_of_pic_nums_idc
 = 
cuºSli˚
->modifiˇti⁄_of_pic_nums_idc[
cur_li°
];

1635 *
abs_diff_pic_num_möus1
 = 
cuºSli˚
->abs_diff_pic_num_möus1[
cur_li°
];

1636 
DecodedPi˘uªBuf„r
 *
p_Dpb
 = 
cuºSli˚
->p_Dpb;

1637 
i
;

1639 
maxPicNum
, 
cuºPicNum
, 
picNumLXNoWøp
, 
picNumLXPªd
, 
picNumLX
;

1640 
ªfIdxLX
 = 0;

1642 i‡(
cuºSli˚
->
°ru˘uª
==
FRAME
)

1644 
maxPicNum
 = 
cuºSli˚
->
max_‰ame_num
;

1645 
cuºPicNum
 = 
cuºSli˚
->
‰ame_num
;

1649 
maxPicNum
 = 2 * 
cuºSli˚
->
max_‰ame_num
;

1650 
cuºPicNum
 = 2 * 
cuºSli˚
->
‰ame_num
 + 1;

1653 
picNumLXPªd
 = 
cuºPicNum
;

1655 
i
=0; 
modifiˇti⁄_of_pic_nums_idc
[i]!=3; i++)

1657 i‡(
modifiˇti⁄_of_pic_nums_idc
[
i
] > 3)

1658 
	`îr‹
 ("Invalid modification_of_pic_nums_idc command", 500);

1660 i‡(
modifiˇti⁄_of_pic_nums_idc
[
i
] < 2)

1662 i‡(
modifiˇti⁄_of_pic_nums_idc
[
i
] == 0)

1664 if–
picNumLXPªd
 - ( 
abs_diff_pic_num_möus1
[
i
] + 1 ) < 0 )

1665 
picNumLXNoWøp
 = 
picNumLXPªd
 - ( 
abs_diff_pic_num_möus1
[
i
] + 1 ) + 
maxPicNum
;

1667 
picNumLXNoWøp
 = 
picNumLXPªd
 - ( 
abs_diff_pic_num_möus1
[
i
] + 1 );

1671 if–
picNumLXPªd
 + ( 
abs_diff_pic_num_möus1
[
i
] + 1 ) >
maxPicNum
 )

1672 
picNumLXNoWøp
 = 
picNumLXPªd
 + ( 
abs_diff_pic_num_möus1
[
i
] + 1 ) - 
maxPicNum
;

1674 
picNumLXNoWøp
 = 
picNumLXPªd
 + ( 
abs_diff_pic_num_möus1
[
i
] + 1 );

1676 
picNumLXPªd
 = 
picNumLXNoWøp
;

1678 if–
picNumLXNoWøp
 > 
cuºPicNum
 )

1679 
picNumLX
 = 
picNumLXNoWøp
 - 
maxPicNum
;

1681 
picNumLX
 = 
picNumLXNoWøp
;

1683 
	`ª‹dî_sh‹t_ãrm
(
cuºSli˚
, 
p_Dpb
, 
cur_li°
, 
picNumLX
, &
ªfIdxLX
);

1687 
	`ª‹dî_l⁄g_ãrm
 (
cuºSli˚
, 
p_Dpb
, cuºSli˚->
li°X
[
cur_li°
], cur_li°, 
i
, &
ªfIdxLX
);

1692 
cuºSli˚
->
li°Xsize
[
cur_li°
] = cuºSli˚->
num_ªf_idx_a˘ive
[cur_list];

1693 
	}
}

1705 
	$idr_mem‹y_m™agemít
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
St‹abÀPi˘uª
* 
p
, 
FømeF‹m©
 *
ouçut
)

1707 
i
;

1708 
VideoP¨amëîs
 *
p_Vid
 = 
p_Dpb
->p_Vid;

1710 
	`as£π
 (
p_Vid
->
cuºítPi˘uª
->
idr_Êag
);

1712 i‡(
p_Vid
->
no_ouçut_of_¥i‹_pics_Êag
)

1715 
i
=0; i<
p_Dpb
->
u£d_size
; i++)

1718 
	`‰ì_‰ame_°‹e
(
p_Vid
, 
p_Dpb
->
fs
[
i
]);

1719 
p_Dpb
->
fs
[
i
] = 
	`Æloc_‰ame_°‹e
();

1721 
i
=0; i<
p_Dpb
->
ªf_‰ames_ö_buf„r
; i++)

1723 
p_Dpb
->
fs_ªf
[
i
]=
NULL
;

1725 
i
=0; i<
p_Dpb
->
…ªf_‰ames_ö_buf„r
; i++)

1727 
p_Dpb
->
fs_…ªf
[
i
]=
NULL
;

1729 
p_Dpb
->
u£d_size
=0;

1733 
	`Êush_dpb
(
p_Dpb
, 
ouçut
);

1735 
p_Dpb
->
œ°_pi˘uª
 = 
NULL
;

1737 
	`upd©e_ªf_li°
(
p_Dpb
);

1738 
	`upd©e_…ªf_li°
(
p_Dpb
);

1739 
p_Dpb
->
œ°_ouçut_poc
 = 
INT_MIN
;

1740 #i‡(
MVC_EXTENSION_ENABLE
)

1741 
p_Dpb
->
œ°_ouçut_võw_id
 = 0;

1744 i‡(
p_Vid
->
l⁄g_ãrm_ª„ªn˚_Êag
)

1746 
p_Dpb
->
max_l⁄g_ãrm_pic_idx
 = 0;

1747 
p
->
is_l⁄g_ãrm
 = 1;

1748 
p
->
l⁄g_ãrm_‰ame_idx
 = 0;

1752 
p_Dpb
->
max_l⁄g_ãrm_pic_idx
 = -1;

1753 
p
->
is_l⁄g_ãrm
 = 0;

1755 
	}
}

1764 
	$¶idög_wödow_mem‹y_m™agemít
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
St‹abÀPi˘uª
* 
p
)

1766 
VideoP¨amëîs
 *
p_Vid
 = 
p_Dpb
->p_Vid;

1767 
i
;

1770 i‡(
p_Dpb
->
ªf_‰ames_ö_buf„r
 =
	`imax
(1, 
p_Vid
->
a˘ive_•s
->
num_ªf_‰ames
Ë-Ö_Dpb->
…ªf_‰ames_ö_buf„r
)

1772 
i
 = 0; i < 
p_Dpb
->
u£d_size
; i++)

1774 i‡(
p_Dpb
->
fs
[
i
]->
is_ª„ªn˚
 && (!’_Dpb->fs[i]->
is_l⁄g_ãrm
)))

1776 
	`unm¨k_f‹_ª„ªn˚
(
p_Dpb
->
fs
[
i
]);

1777 
	`upd©e_ªf_li°
(
p_Dpb
);

1783 
p
->
is_l⁄g_ãrm
 = 0;

1784 
	}
}

1797 
	$ad≠tive_mem‹y_m™agemít
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
St‹abÀPi˘uª
* 
p
, 
FømeF‹m©
 *
ouçut
)

1799 
DecRefPicM¨kög_t
 *
tmp_dΩm
;

1800 
VideoP¨amëîs
 *
p_Vid
 = 
p_Dpb
->p_Vid;

1802 
p_Vid
->
œ°_has_mmco_5
 = 0;

1804 
	`as£π
 (!
p_Vid
->
cuºítPi˘uª
->
idr_Êag
);

1805 
	`as£π
 (
p_Vid
->
ad≠tive_ªf_pic_buf„rög_Êag
);

1807 
p_Vid
->
dec_ªf_pic_m¨kög_buf„r
)

1809 
tmp_dΩm
 = 
p_Vid
->
dec_ªf_pic_m¨kög_buf„r
;

1810 
tmp_dΩm
->
mem‹y_m™agemít_c⁄åﬁ_›î©i⁄
)

1813 i‡(
tmp_dΩm
->
Next
 !
NULL
)

1815 
	`îr‹
 ("memory_management_control_operation = 0ÇotÜast operation in buffer", 500);

1819 
	`mm_unm¨k_sh‹t_ãrm_f‹_ª„ªn˚
(
p_Dpb
, 
p
, 
tmp_dΩm
->
dif„ªn˚_of_pic_nums_möus1
);

1820 
	`upd©e_ªf_li°
(
p_Dpb
);

1823 
	`mm_unm¨k_l⁄g_ãrm_f‹_ª„ªn˚
(
p_Dpb
, 
p
, 
tmp_dΩm
->
l⁄g_ãrm_pic_num
);

1824 
	`upd©e_…ªf_li°
(
p_Dpb
);

1827 
	`mm_assign_l⁄g_ãrm_‰ame_idx
(
p_Dpb
, 
p
, 
tmp_dΩm
->
dif„ªn˚_of_pic_nums_möus1
,Åmp_dΩm->
l⁄g_ãrm_‰ame_idx
);

1828 
	`upd©e_ªf_li°
(
p_Dpb
);

1829 
	`upd©e_…ªf_li°
(
p_Dpb
);

1832 
	`mm_upd©e_max_l⁄g_ãrm_‰ame_idx
 (
p_Dpb
, 
tmp_dΩm
->
max_l⁄g_ãrm_‰ame_idx_∂us1
);

1833 
	`upd©e_…ªf_li°
(
p_Dpb
);

1836 
	`mm_unm¨k_Æl_sh‹t_ãrm_f‹_ª„ªn˚
(
p_Dpb
);

1837 
	`mm_unm¨k_Æl_l⁄g_ãrm_f‹_ª„ªn˚
(
p_Dpb
);

1838 
p_Vid
->
œ°_has_mmco_5
 = 1;

1841 
	`mm_m¨k_cuºít_pi˘uª_l⁄g_ãrm
(
p_Dpb
, 
p
, 
tmp_dΩm
->
l⁄g_ãrm_‰ame_idx
);

1842 
	`check_num_ªf
(
p_Dpb
);

1845 
	`îr‹
 ("invalid memory_management_control_operation in buffer", 500);

1847 
p_Vid
->
dec_ªf_pic_m¨kög_buf„r
 = 
tmp_dΩm
->
Next
;

1848 
	`‰ì
 (
tmp_dΩm
);

1850 i‡–
p_Vid
->
œ°_has_mmco_5
 )

1852 
p
->
pic_num
 =Ö->
‰ame_num
 = 0;

1854 
p
->
°ru˘uª
)

1856 
TOP_FIELD
:

1858 
p
->
poc
 =Ö->
t›_poc
 = 
p_Vid
->
t›poc
 =0;

1861 
BOTTOM_FIELD
:

1863 
p
->
poc
 =Ö->
bŸtom_poc
 = 
p_Vid
->
bŸtompoc
 = 0;

1866 
FRAME
:

1868 
p
->
t›_poc
 -p->
poc
;

1869 
p
->
bŸtom_poc
 -p->
poc
;

1871 
p_Vid
->
t›poc
 = 
p
->
t›_poc
;

1872 
p_Vid
->
bŸtompoc
 = 
p
->
bŸtom_poc
;

1874 
p
->
poc
 = 
	`imö
 (p->
t›_poc
,Ö->
bŸtom_poc
);

1875 
p_Vid
->
‰amïoc
 = 
p
->
poc
;

1879 
p_Vid
->
ThisPOC
 = 
p
->
poc
;

1880 
	`Êush_dpb
(
p_Vid
->
p_Dpb_œyî
[0], 
ouçut
);

1881 if(
p_Vid
->
num_of_œyîs
 >1)

1882 
	`Êush_dpb
(
p_Vid
->
p_Dpb_œyî
[1], 
ouçut
);

1884 
	}
}

1905 
	$°‹e_pi˘uª_ö_dpb
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
St‹abÀPi˘uª
* 
p
, 
FømeF‹m©
 *
ouçut
)

1907 
VideoP¨amëîs
 *
p_Vid
 = 
p_Dpb
->p_Vid;

1908 
i
;

1909 
poc
, 
pos
;

1914 
	`as£π
 (
p
!=
NULL
);

1916 
p
->
Ÿf_Êag
 = 
p_Vid
->
p_I≈
->
OnTheFlyFø˘MCP
 ;

1918 
p
->
u£d_f‹_ª„ªn˚
 = (
p_Vid
->
«l_ª„ªn˚_idc
 !
NALU_PRIORITY_DISPOSABLE
);

1920 
p
->
ty≥
 = 
p_Vid
->type;

1922 #i‡(
MVC_EXTENSION_ENABLE
)

1923 if(
p_Vid
->
p_I≈
->
num_of_võws
==2)

1925 
p
->
võw_id
 = 
p_Vid
->view_id;

1927 if(
p
->
°ru˘uª
==
FRAME
)

1929 
p
->
öãr_võw_Êag
[0] =Ö->öãr_võw_Êag[1] = 
p_Vid
->inter_view_flag[0];

1930 
p
->
™ch‹_pic_Êag
[0] =Ö->™ch‹_pic_Êag[1] = 
p_Vid
->anchor_pic_flag[0];

1934 if(
p
->
°ru˘uª
==
TOP_FIELD
)

1936 
p
->
öãr_võw_Êag
[0] = 
p_Vid
->inter_view_flag[0];

1937 
p
->
™ch‹_pic_Êag
[0] = 
p_Vid
->anchor_pic_flag[0];

1941 
p
->
öãr_võw_Êag
[1] = 
p_Vid
->inter_view_flag[1];

1942 
p
->
™ch‹_pic_Êag
[1] = 
p_Vid
->anchor_pic_flag[1];

1946 if(
p_Vid
->
võw_id
 == 0)

1948 
	`¥o˚ss_pi˘uª_ö_dpb_s
(
p_Vid
, 
p
);

1949 
p_Vid
->
¥oc_pi˘uª
 = 
	`˛⁄e_°‹abÀ_pi˘uª
’_Vid, 
p
);

1954 
p_Vid
->
œ°_has_mmco_5
 = 0;

1955 
p_Vid
->
œ°_pic_bŸtom_fõld
 = (p_Vid->
°ru˘uª
 =
BOTTOM_FIELD
);

1957 i‡(
p_Vid
->
cuºítPi˘uª
->
idr_Êag
)

1959 
	`idr_mem‹y_m™agemít
(
p_Dpb
, 
p
, 
ouçut
);

1960 if(
p_Vid
->
num_of_œyîs
 > 1)

1961 
	`idr_mem‹y_m™agemít
(
p_Vid
->
p_Dpb_œyî
[1], 
p
, 
ouçut
);

1966 i‡(
p
->
u£d_f‹_ª„ªn˚
 && (
p_Vid
->
ad≠tive_ªf_pic_buf„rög_Êag
))

1967 
	`ad≠tive_mem‹y_m™agemít
(
p_Dpb
, 
p
, 
ouçut
);

1970 i‡((
p
->
°ru˘uª
==
TOP_FIELD
)||’->°ru˘uª==
BOTTOM_FIELD
))

1973 i‡(
p_Dpb
->
œ°_pi˘uª
)

1975 i‡(()
p_Dpb
->
œ°_pi˘uª
->
‰ame_num
 =
p
->
pic_num
)

1977 i‡(((
p
->
°ru˘uª
==
TOP_FIELD
)&&(
p_Dpb
->
œ°_pi˘uª
->
is_u£d
==2))||(’->°ru˘uª==
BOTTOM_FIELD
)&&(p_Dpb->last_picture->is_used==1)))

1979 i‡((
p
->
u£d_f‹_ª„ªn˚
 && (
p_Dpb
->
œ°_pi˘uª
->
is_‹ig_ª„ªn˚
!=0))||

1980 (!
p
->
u£d_f‹_ª„ªn˚
 && (
p_Dpb
->
œ°_pi˘uª
->
is_‹ig_ª„ªn˚
==0)))

1982 
	`ö£π_pi˘uª_ö_dpb
(
p_Vid
, 
p_Dpb
->
œ°_pi˘uª
, 
p
);

1983 
	`upd©e_ªf_li°
(
p_Dpb
);

1984 
	`upd©e_…ªf_li°
(
p_Dpb
);

1985 #i‡(
DUMP_DPB
)

1986 
	`¥ötf
("\nstore_picture_in_dpb inserting complementary field\n");

1988 
	`dump_dpb
(
p_Dpb
);

1989 
p_Dpb
->
œ°_pi˘uª
 = 
NULL
;

2000 i‡((!
p_Vid
->
cuºítPi˘uª
->
idr_Êag
Ë&& (
p
->
u£d_f‹_ª„ªn˚
 && (!p_Vid->
ad≠tive_ªf_pic_buf„rög_Êag
)))

2002 
	`¶idög_wödow_mem‹y_m™agemít
(
p_Dpb
, 
p
);

2006 i‡(
p_Dpb
->
u£d_size
 =p_Dpb->
size
)

2008 
	`ªmove_unu£d_‰ame_‰om_dpb
(
p_Dpb
);

2012 
p_Dpb
->
u£d_size
 =p_Dpb->
size
)

2015 i‡(!
p
->
u£d_f‹_ª„ªn˚
)

2017 
	`gë_smÆÀ°_poc
(
p_Dpb
, &
poc
, &
pos
);

2019 #i‡(
MVC_EXTENSION_ENABLE
)

2020 if(
p_Vid
->
p_I≈
->
num_of_võws
==2)

2022 i‡(((-1==
pos
Ë|| (
p
->
poc
 <Öoc)))

2024 
	`dúe˘_ouçut
(
p_Vid
, 
p
, 
ouçut
, (
p_Dpb
->
œyî_id
 ?Ö_Vid->
p_dec2
:Ö_Vid->
p_dec
));

2031 i‡((-1==
pos
Ë|| (
p
->
poc
 <Öoc))

2033 
	`dúe˘_ouçut
(
p_Vid
, 
p
, 
ouçut
,Ö_Vid->
p_dec
);

2039 
	`ouçut_⁄e_‰ame_‰om_dpb
(
p_Dpb
, 
ouçut
);

2043 i‡((
p
->
u£d_f‹_ª„ªn˚
)&&(!p->
is_l⁄g_ãrm
))

2045 
i
=0; i<
p_Dpb
->
ªf_‰ames_ö_buf„r
; i++)

2047 i‡(
p_Dpb
->
fs_ªf
[
i
]->
‰ame_num
 =
p
->frame_num)

2049 
	`îr‹
("duplicate frame_num in short-termÑeferenceÖicture buffer", 500);

2054 
	`ö£π_pi˘uª_ö_dpb
(
p_Vid
, 
p_Dpb
->
fs
[p_Dpb->
u£d_size
],
p
);

2056 i‡(
p
->
°ru˘uª
 !
FRAME
)

2058 
p_Dpb
->
œ°_pi˘uª
 =Ö_Dpb->
fs
[p_Dpb->
u£d_size
];

2062 
p_Dpb
->
œ°_pi˘uª
 = 
NULL
;

2065 
p_Dpb
->
u£d_size
++;

2067 
	`upd©e_ªf_li°
(
p_Dpb
);

2068 
	`upd©e_…ªf_li°
(
p_Dpb
);

2070 
	`check_num_ªf
(
p_Dpb
);

2071 #i‡(
DUMP_DPB
)

2072 
	`¥ötf
("\nEnd of store_picture_in_dpb\n");

2074 
	`dump_dpb
(
p_Dpb
);

2075 
	}
}

2077 #i‡(
MVC_EXTENSION_ENABLE
)

2094 
	$ª∂a˚_t›_¥oc_pic_wôh_‰ame
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
St‹abÀPi˘uª
* 
p
)

2096 
VideoP¨amëîs
 *
p_Vid
 = 
p_Dpb
->p_Vid;

2097 
St‹abÀPi˘uª
 *
¥oc_pi˘uª
 = 
p_Vid
->proc_picture;

2098 
FømeSt‹e
* 
fs
 = 
NULL
;

2099 
found
;

2101 
	`as£π
 (
p
!=
NULL
);

2102 
	`as£π
 (
p
->
°ru˘uª
==
FRAME
);

2103 
	`as£π
 (
¥oc_pi˘uª
==
NULL
);

2104 
	`as£π
 (
p_Vid
->
p_I≈
->
ProfûeIDC
 <=
STEREO_HIGH
);

2105 
	`¥o˚ss_pi˘uª_ö_dpb_s
(
p_Vid
, 
p
);

2106 
¥oc_pi˘uª
 = 
	`˛⁄e_°‹abÀ_pi˘uª
(
p_Vid
, 
p
);

2108 
¥oc_pi˘uª
->
u£d_f‹_ª„ªn˚
 = (
p_Vid
->
«l_ª„ªn˚_idc
 !
NALU_PRIORITY_DISPOSABLE
);

2109 
¥oc_pi˘uª
->
ty≥
 = 
p_Vid
->type;

2110 
p_Vid
->
œ°_has_mmco_5
=0;

2111 
p_Vid
->
œ°_pic_bŸtom_fõld
 = (p_Vid->
°ru˘uª
 =
BOTTOM_FIELD
);

2114 if–(
p_Vid
->
p_I≈
->
£∑øã_cﬁour_∂™e_Êag
 != 0) )

2116 
	`UnifõdO√F‹thPix_JV
(
p_Vid
, 0, 
¥oc_pi˘uª
);

2117 
	`UnifõdO√F‹thPix_JV
(
p_Vid
, 1, 
¥oc_pi˘uª
);

2118 
	`UnifõdO√F‹thPix_JV
(
p_Vid
, 2, 
¥oc_pi˘uª
);

2122 
	`UnifõdO√F‹thPix
(
p_Vid
, 
¥oc_pi˘uª
);

2125 
found
=0;

2127 if(
p_Dpb
->
fs_ûªf
[0] && (p_Dpb->fs_ûªf[0]->
‰ame_num
 =
p_Vid
->‰ame_numË&& (p_Dpb->fs_ûªf[0]->
is_u£d
 == 1))

2129 
found
 = 1;

2130 
fs
 = 
p_Dpb
->
fs_ûªf
[0];

2133 i‡(!
found
)

2135 
	`¥ötf
("replace_top_proc_pic_with_frame: Warning! ReferenceÖrocessed fieldÇot found. Processed frameÇot inserted in DPB\n");

2136 
	`‰ì_°‹abÀ_pi˘uª
(
p_Vid
, 
¥oc_pi˘uª
);

2140 
	`‰ì_°‹abÀ_pi˘uª
(
p_Vid
, 
fs
->
t›_fõld
);

2141 
fs
->
t›_fõld
=
NULL
;

2142 
fs
->
‰ame
=
¥oc_pi˘uª
;

2143 
fs
->
is_u£d
 = 3;

2144 i‡(
p
->
u£d_f‹_ª„ªn˚
)

2146 
fs
->
is_ª„ªn˚
 = 3;

2147 i‡(
p
->
is_l⁄g_ãrm
)

2149 
fs
->
is_l⁄g_ãrm
 = 3;

2153 
	`dpb_•lô_fõld
(
p_Vid
, 
fs
);

2154 
fs
->
t›_fõld
->
võw_id
 = fs->
bŸtom_fõld
->võw_id = fs->
‰ame
->view_id;

2155 
	`upd©e_ªf_li°
(
p_Dpb
);

2156 
	`upd©e_…ªf_li°
(
p_Dpb
);

2159 
p_Vid
->
¥oc_pi˘uª
 = 
NULL
;

2160 
	}
}

2178 
	$ª∂a˚_t›_pic_wôh_‰ame
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
St‹abÀPi˘uª
* 
p
, 
FømeF‹m©
 *
ouçut
)

2180 
VideoP¨amëîs
 *
p_Vid
 = 
p_Dpb
->p_Vid;

2181 
FømeSt‹e
* 
fs
 = 
NULL
;

2182 
i
, 
found
;

2184 
	`as£π
 (
p
!=
NULL
);

2185 
	`as£π
 (
p
->
°ru˘uª
==
FRAME
);

2187 
p
->
u£d_f‹_ª„ªn˚
 = (
p_Vid
->
«l_ª„ªn˚_idc
 !
NALU_PRIORITY_DISPOSABLE
);

2188 
p
->
ty≥
 = 
p_Vid
->type;

2191 #i‡(
MVC_EXTENSION_ENABLE
)

2192 i‡(
p
->
u£d_f‹_ª„ªn˚
 || (
p_Vid
->
p_I≈
->
num_of_võws
==2 &&Ö_Vid->
võw_id
 == 0))

2194 i‡(
p
->
u£d_f‹_ª„ªn˚
)

2197 if–(
p_Vid
->
p_I≈
->
£∑øã_cﬁour_∂™e_Êag
 != 0) )

2199 
	`UnifõdO√F‹thPix_JV
(
p_Vid
, 0, 
p
);

2200 
	`UnifõdO√F‹thPix_JV
(
p_Vid
, 1, 
p
);

2201 
	`UnifõdO√F‹thPix_JV
(
p_Vid
, 2, 
p
);

2205 
	`UnifõdO√F‹thPix
(
p_Vid
, 
p
);

2209 
found
=0;

2211 
i
 = 0; i < 
p_Dpb
->
u£d_size
; i++)

2213 if((
p_Dpb
->
fs
[
i
]->
‰ame_num
 =
p_Vid
->‰ame_numË&& (p_Dpb->fs[i]->
is_u£d
 == 1))

2215 
found
=1;

2216 
fs
 = 
p_Dpb
->fs[
i
];

2221 #i‡(
MVC_EXTENSION_ENABLE
)

2222 if(
p_Vid
->
p_I≈
->
num_of_võws
 == 2)

2224 i‡(
p_Dpb
->
œyî_id
 == 0)

2226 
	`ª∂a˚_t›_¥oc_pic_wôh_‰ame
(
p_Vid
->
p_Dpb_œyî
[1], 
p
);

2231 i‡(!
found
)

2234 #i‡(
MVC_EXTENSION_ENABLE
)

2235 if(
p_Vid
->
p_I≈
->
num_of_võws
 == 2)

2237 i‡(
p_Dpb
->
œyî_id
 == 0)

2238 
	`dúe˘_ouçut_∑ff
(
p_Vid
, 
p
, 
ouçut
,Ö_Vid->
p_dec
);

2240 
	`dúe˘_ouçut_∑ff
(
p_Vid
, 
p
, 
ouçut
,Ö_Vid->
p_dec2
);

2244 
	`dúe˘_ouçut_∑ff
(
p_Vid
, 
p
, 
ouçut
,Ö_Vid->
p_dec
);

2248 
	`‰ì_°‹abÀ_pi˘uª
(
p_Vid
, 
fs
->
t›_fõld
);

2249 
fs
->
t›_fõld
 = 
NULL
;

2250 
fs
->
‰ame
 = 
p
;

2251 
fs
->
is_u£d
 = 3;

2252 i‡(
p
->
u£d_f‹_ª„ªn˚
)

2254 
fs
->
is_ª„ªn˚
 = 3;

2255 i‡(
p
->
is_l⁄g_ãrm
)

2257 
fs
->
is_l⁄g_ãrm
 = 3;

2261 
	`dpb_•lô_fõld
(
p_Vid
, 
fs
);

2262 
	`upd©e_ªf_li°
(
p_Dpb
);

2263 
	`upd©e_…ªf_li°
(
p_Dpb
);

2265 #i‡(
DUMP_DPB
)

2266 
	`¥ötf
("\nReplace TopÖic with Frame\n");

2267 
	`dump_dpb
(
p_Dpb
);

2269 
	}
}

2287 
	$ö£π_pi˘uª_ö_dpb
(
VideoP¨amëîs
 *
p_Vid
, 
FømeSt‹e
* 
fs
, 
St‹abÀPi˘uª
* 
p
)

2290 
	`as£π
 (
p
!=
NULL
);

2291 
	`as£π
 (
fs
!=
NULL
);

2294 i‡(
p
->
u£d_f‹_ª„ªn˚
)

2296 if–(
p_Vid
->
p_I≈
->
£∑øã_cﬁour_∂™e_Êag
 != 0) )

2298 
	`UnifõdO√F‹thPix_JV
(
p_Vid
, 0, 
p
);

2299 
	`UnifõdO√F‹thPix_JV
(
p_Vid
, 1, 
p
);

2300 
	`UnifõdO√F‹thPix_JV
(
p_Vid
, 2, 
p
);

2304 
	`UnifõdO√F‹thPix
(
p_Vid
, 
p
);

2307 #i‡(
MVC_EXTENSION_ENABLE
)

2308 if(
p_Vid
->
p_I≈
->
num_of_võws
==2 && 
p
->
öãr_võw_Êag
[p->
°ru˘uª
>>1])

2310 
	`UnifõdO√F‹thPix
(
p_Vid
, 
p
);

2314 
p
->
°ru˘uª
)

2316 
FRAME
:

2317 
fs
->
‰ame
 = 
p
;

2318 
fs
->
is_u£d
 = 3;

2319 i‡(
p
->
u£d_f‹_ª„ªn˚
)

2321 
fs
->
is_ª„ªn˚
 = 3;

2322 
fs
->
is_‹ig_ª„ªn˚
 = 3;

2323 i‡(
p
->
is_l⁄g_ãrm
)

2325 
fs
->
is_l⁄g_ãrm
 = 3;

2326 
fs
->
l⁄g_ãrm_‰ame_idx
 = 
p
->long_term_frame_idx;

2330 
	`dpb_•lô_fõld
(
p_Vid
, 
fs
);

2331 #i‡(
MVC_EXTENSION_ENABLE
)

2332 if(
p_Vid
->
p_I≈
->
num_of_võws
==2)

2334 
fs
->
™ch‹_pic_Êag
[0] = fs->™ch‹_pic_Êag[1] = 
p
->anchor_pic_flag[0];

2335 
fs
->
öãr_võw_Êag
[0] = fs->öãr_võw_Êag[1] = 
p
->inter_view_flag[0];

2337 i‡(
fs
->
t›_fõld
)

2339 
fs
->
t›_fõld
->
võw_id
 = 
p
->view_id;

2341 i‡(
fs
->
bŸtom_fõld
)

2343 
fs
->
bŸtom_fõld
->
võw_id
 = 
p
->view_id;

2347 
TOP_FIELD
:

2348 
fs
->
t›_fõld
 = 
p
;

2349 
fs
->
is_u£d
 |= 1;

2350 i‡(
p
->
u£d_f‹_ª„ªn˚
)

2352 
fs
->
is_ª„ªn˚
 |= 1;

2353 
fs
->
is_‹ig_ª„ªn˚
 |= 1;

2354 i‡(
p
->
is_l⁄g_ãrm
)

2356 
fs
->
is_l⁄g_ãrm
 |= 1;

2357 
fs
->
l⁄g_ãrm_‰ame_idx
 = 
p
->long_term_frame_idx;

2360 i‡(
fs
->
is_u£d
 == 3)

2363 
	`dpb_comböe_fõld
(
p_Vid
, 
fs
);

2367 
fs
->
poc
 = 
p
->poc;

2368 
	`gí_fõld_ªf_ids
(
p
);

2370 #i‡(
MVC_EXTENSION_ENABLE
)

2371 if(
p_Vid
->
p_I≈
->
num_of_võws
==2)

2373 
fs
->
™ch‹_pic_Êag
[0] = 
p
->anchor_pic_flag[0];

2374 
fs
->
öãr_võw_Êag
[0] = 
p
->inter_view_flag[0];

2376 
fs
->
t›_fõld
->
võw_id
 = 
p
->view_id;

2379 
BOTTOM_FIELD
:

2380 
fs
->
bŸtom_fõld
 = 
p
;

2381 
fs
->
is_u£d
 |= 2;

2382 i‡(
p
->
u£d_f‹_ª„ªn˚
)

2384 
fs
->
is_ª„ªn˚
 |= 2;

2385 
fs
->
is_‹ig_ª„ªn˚
 |= 2;

2386 i‡(
p
->
is_l⁄g_ãrm
)

2388 
fs
->
is_l⁄g_ãrm
 |= 2;

2389 
fs
->
l⁄g_ãrm_‰ame_idx
 = 
p
->long_term_frame_idx;

2392 i‡(
fs
->
is_u£d
 == 3)

2395 
	`dpb_comböe_fõld
(
p_Vid
, 
fs
);

2396 #i‡(
MVC_EXTENSION_ENABLE
)

2397 
fs
->
‰ame
->
võw_id
 = 
p
->view_id;

2402 
fs
->
poc
 = 
p
->poc;

2403 
	`gí_fõld_ªf_ids
(
p
);

2405 #i‡(
MVC_EXTENSION_ENABLE
)

2406 if(
p_Vid
->
p_I≈
->
num_of_võws
==2)

2408 
fs
->
™ch‹_pic_Êag
[1] = 
p
->anchor_pic_flag[1];

2409 
fs
->
öãr_võw_Êag
[1] = 
p
->inter_view_flag[1];

2411 
fs
->
bŸtom_fõld
->
võw_id
 = 
p
->view_id;

2415 
fs
->
‰ame_num
 = 
p
->
pic_num
;

2416 
fs
->
is_ouçut
 = 
p
->is_output;

2417 
fs
->
is_öãr_œyî
 = 
FALSE
;

2419 #i‡(
MVC_EXTENSION_ENABLE
)

2420 
fs
->
võw_id
 = 
p
->view_id;

2422 
	}
}

2432 
	$ªmove_‰ame_‰om_dpb
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
pos
)

2434 
VideoP¨amëîs
 *
p_Vid
 = 
p_Dpb
->p_Vid;

2435 
FømeSt‹e
* 
fs
 = 
p_Dpb
->fs[
pos
];

2436 
FømeSt‹e
* 
tmp
;

2437 
i
;

2440 
fs
->
is_u£d
)

2443 
	`‰ì_°‹abÀ_pi˘uª
(
p_Vid
, 
fs
->
‰ame
);

2444 
	`‰ì_°‹abÀ_pi˘uª
(
p_Vid
, 
fs
->
t›_fõld
);

2445 
	`‰ì_°‹abÀ_pi˘uª
(
p_Vid
, 
fs
->
bŸtom_fõld
);

2446 
fs
->
‰ame
=
NULL
;

2447 
fs
->
t›_fõld
=
NULL
;

2448 
fs
->
bŸtom_fõld
=
NULL
;

2451 
	`‰ì_°‹abÀ_pi˘uª
(
p_Vid
, 
fs
->
bŸtom_fõld
);

2452 
fs
->
bŸtom_fõld
=
NULL
;

2455 
	`‰ì_°‹abÀ_pi˘uª
(
p_Vid
, 
fs
->
t›_fõld
);

2456 
fs
->
t›_fõld
=
NULL
;

2461 
	`îr‹
("invalid frame storeÅype",500);

2463 
fs
->
is_u£d
 = 0;

2464 
fs
->
is_l⁄g_ãrm
 = 0;

2465 
fs
->
is_ª„ªn˚
 = 0;

2466 
fs
->
is_‹ig_ª„ªn˚
 = 0;

2469 
tmp
 = 
p_Dpb
->
fs
[
pos
];

2471 
i
=
pos
; i<
p_Dpb
->
u£d_size
-1;i++)

2473 
p_Dpb
->
fs
[
i
] =Ö_Dpb->fs[i+1];

2475 
p_Dpb
->
fs
[p_Dpb->
u£d_size
-1] = 
tmp
;

2476 
p_Dpb
->
u£d_size
--;

2477 
	}
}

2486 
	$Êush_unu£d_‰ame_‰om_dpb
(
DecodedPi˘uªBuf„r
 *
p_Dpb
)

2488 
i
;

2491 
i
 = 0; i < 
p_Dpb
->
u£d_size
; i++)

2493 i‡(
p_Dpb
->
fs
[
i
]->
is_ouçut
 && (!
	`is_u£d_f‹_ª„ªn˚
(p_Dpb->fs[i])))

2495 
	`ªmove_‰ame_‰om_dpb
(
p_Dpb
, 
i
);

2500 
	}
}

2510 
	$ouçut_⁄e_‰ame_‰om_dpb
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
FømeF‹m©
 *
ouçut
)

2512 
VideoP¨amëîs
 *
p_Vid
 = 
p_Dpb
->p_Vid;

2513 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Dpb
->p_Inp;

2514 
poc
, 
pos
;

2516 i‡(
p_Dpb
->
u£d_size
 < 1)

2518 
	`îr‹
("Cannot output frame, DPBÉmpty.",150);

2522 
	`gë_smÆÀ°_poc
(
p_Dpb
, &
poc
, &
pos
);

2524 if(
pos
==-1)

2526 
	`îr‹
("no frames for outputávailable", 150);

2531 #i‡(
MVC_EXTENSION_ENABLE
)

2532 if(
p_I≈
->
num_of_võws
==2)

2534 if(
p_Dpb
->
fs
[
pos
]->
võw_id
==1)

2535 
	`wrôe_°‹ed_‰ame
(
p_Vid
, 
p_Dpb
->
fs
[
pos
], 
ouçut
,Ö_Vid->
p_dec2
);

2537 
	`wrôe_°‹ed_‰ame
(
p_Vid
, 
p_Dpb
->
fs
[
pos
], 
ouçut
,Ö_Vid->
p_dec
);

2541 
	`wrôe_°‹ed_‰ame
(
p_Vid
, 
p_Dpb
->
fs
[
pos
], 
ouçut
,Ö_Vid->
p_dec
);

2544 if(
p_I≈
->
ªdund™t_pic_Êag
 == 0)

2546 i‡(
p_Dpb
->
œ°_ouçut_poc
 >
poc
)

2548 
	`îr‹
 ("output POC must be ináscending order", 150);

2551 
p_Dpb
->
œ°_ouçut_poc
 = 
poc
;

2554 i‡(!
	`is_u£d_f‹_ª„ªn˚
(
p_Dpb
->
fs
[
pos
]))

2556 
	`ªmove_‰ame_‰om_dpb
(
p_Dpb
, 
pos
);

2558 
	}
}

2568 
	$Êush_dpb
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
FømeF‹m©
 *
ouçut
)

2570 
i
;

2577 
i
=0; i<
p_Dpb
->
u£d_size
; i++)

2579 
	`unm¨k_f‹_ª„ªn˚
 (
p_Dpb
->
fs
[
i
]);

2582 
	`Êush_unu£d_‰ame_‰om_dpb
(
p_Dpb
)) ;

2585 
p_Dpb
->
u£d_size
)

2587 
	`ouçut_⁄e_‰ame_‰om_dpb
(
p_Dpb
, 
ouçut
);

2590 
p_Dpb
->
œ°_ouçut_poc
 = 
INT_MIN
;

2591 #i‡(
MVC_EXTENSION_ENABLE
)

2592 
p_Dpb
->
œ°_ouçut_võw_id
 = 0;

2594 
	}
}

2597 
	$gí_fõld_ªf_ids
(
St‹abÀPi˘uª
 *
p
)

2599 
i
,
j
;

2601 
i
 = 0; i < (
p
->
size_x
 >> 2); i++)

2603 
j
 = 0; j < (
p
->
size_y
 >> 2); j++)

2605 
p
->
mv_öfo
[
j
][
i
].
fõld_‰ame
=1;

2608 
	}
}

2616 
	$dpb_•lô_fõld
(
VideoP¨amëîs
 *
p_Vid
, 
FømeSt‹e
 *
fs
)

2618 
i
, 
j
, 
k
, 
ii
, 
jj
, 
jj4
;

2619 
idiv
,
jdiv
;

2620 
cuºítmb
;

2622 
twosz16
 = 2 * (
fs
->
‰ame
->
size_x
 >> 4);

2623 
St‹abÀPi˘uª
 *
fs_t›
, *
fs_btm
;

2624 
St‹abÀPi˘uª
 *
‰ame
 = 
fs
->frame;

2626 
fs
->
poc
 = 
‰ame
->poc;

2628 i‡(!
p_Vid
->
a˘ive_•s
->
‰ame_mbs_⁄ly_Êag
)

2630 
fs_t›
 = 
fs
->
t›_fõld
 = 
	`Æloc_°‹abÀ_pi˘uª
(
p_Vid
, 
TOP_FIELD
, 
‰ame
->
size_x
, føme->
size_y
 >> 1, føme->
size_x_¸
, føme->
size_y_¸
 >> 1);

2631 
fs_btm
 = 
fs
->
bŸtom_fõld
 = 
	`Æloc_°‹abÀ_pi˘uª
(
p_Vid
, 
BOTTOM_FIELD
, 
‰ame
->
size_x
, føme->
size_y
 >> 1, føme->
size_x_¸
, føme->
size_y_¸
 >> 1);

2633 
i
 = 0; i < (
‰ame
->
size_y
 >> 1); i++)

2635 
	`mem˝y
(
fs_t›
->
imgY
[
i
], 
‰ame
->imgY[i*2], føme->
size_x
*(
img≥l
));

2636 
	`mem˝y
(
fs_btm
->
imgY
[
i
], 
‰ame
->imgY[i*2 + 1], føme->
size_x
*(
img≥l
));

2639 
k
 = 0; k < 2; k++)

2641 
i
=0; i< (
‰ame
->
size_y_¸
 >> 1); i++)

2643 
	`mem˝y
(
fs_t›
->
imgUV
[
k
][
i
], 
‰ame
->imgUV[k][i*2], føme->
size_x_¸
*(
img≥l
));

2644 
	`mem˝y
(
fs_btm
->
imgUV
[
k
][
i
], 
‰ame
->imgUV[k][i*2 + 1], føme->
size_x_¸
*(
img≥l
));

2647 if(
‰ame
->
u£d_f‹_ª„ªn˚
)

2649 if–(
p_Vid
->
p_I≈
->
£∑øã_cﬁour_∂™e_Êag
 != 0) )

2651 
	`UnifõdO√F‹thPix_JV
(
p_Vid
, 0, 
fs
->
t›_fõld
);

2652 
	`UnifõdO√F‹thPix_JV
(
p_Vid
, 1, 
fs
->
t›_fõld
);

2653 
	`UnifõdO√F‹thPix_JV
(
p_Vid
, 2, 
fs
->
t›_fõld
);

2654 
	`UnifõdO√F‹thPix_JV
(
p_Vid
, 0, 
fs
->
bŸtom_fõld
);

2655 
	`UnifõdO√F‹thPix_JV
(
p_Vid
, 1, 
fs
->
bŸtom_fõld
);

2656 
	`UnifõdO√F‹thPix_JV
(
p_Vid
, 2, 
fs
->
bŸtom_fõld
);

2660 
	`UnifõdO√F‹thPix
(
p_Vid
, 
fs
->
t›_fõld
);

2661 
	`UnifõdO√F‹thPix
(
p_Vid
, 
fs
->
bŸtom_fõld
);

2664 
fs
->
t›_fõld
->
poc
 = 
‰ame
->
t›_poc
;

2665 
fs
->
bŸtom_fõld
->
poc
 = 
‰ame
->
bŸtom_poc
;

2667 
fs
->
t›_fõld
->
‰ame_poc
 = 
‰ame
->frame_poc;

2669 
fs
->
t›_fõld
->
bŸtom_poc
 =fs->
bŸtom_fõld
->bŸtom_po¯
‰ame
->bottom_poc;

2670 
fs
->
t›_fõld
->
t›_poc
 =fs->
bŸtom_fõld
->t›_po¯
‰ame
->top_poc;

2671 
fs
->
bŸtom_fõld
->
‰ame_poc
 = 
‰ame
->frame_poc;

2673 
fs
->
t›_fõld
->
u£d_f‹_ª„ªn˚
 = fs->
bŸtom_fõld
->used_for_reference

2674 
‰ame
->
u£d_f‹_ª„ªn˚
;

2675 
fs
->
t›_fõld
->
is_l⁄g_ãrm
 = fs->
bŸtom_fõld
->is_long_term

2676 
‰ame
->
is_l⁄g_ãrm
;

2677 
fs
->
l⁄g_ãrm_‰ame_idx
 = fs->
t›_fõld
->long_term_frame_idx

2678 
fs
->
bŸtom_fõld
->
l⁄g_ãrm_‰ame_idx


2679 
‰ame
->
l⁄g_ãrm_‰ame_idx
;

2681 
fs
->
t›_fõld
->
coded_‰ame
 = fs->
bŸtom_fõld
->coded_frame = 1;

2682 
fs
->
t›_fõld
->
mb_aff_‰ame_Êag
 = fs->
bŸtom_fõld
->mb_aff_frame_flag

2683 
‰ame
->
mb_aff_‰ame_Êag
;

2685 
‰ame
->
t›_fõld
 = 
fs
->top_field;

2686 
‰ame
->
bŸtom_fõld
 = 
fs
->bottom_field;

2687 
‰ame
->frame = frame;

2688 
fs
->
t›_fõld
->
bŸtom_fõld
 = fs->bottom_field;

2689 
fs
->
t›_fõld
->
‰ame
 = fs->frame;

2690 
fs
->
t›_fõld
->top_field = fs->top_field;

2691 
fs
->
bŸtom_fõld
->
t›_fõld
 = fs->top_field;

2692 
fs
->
bŸtom_fõld
->
‰ame
 = frame;

2693 
fs
->
bŸtom_fõld
->bottom_field = fs->bottom_field;

2695 
fs
->
t›_fõld
->
chroma_f‹m©_idc
 = fs->
bŸtom_fõld
->chroma_f‹m©_id¯
‰ame
->chroma_format_idc;

2696 
fs
->
t›_fõld
->
chroma_mask_mv_x
 = fs->
bŸtom_fõld
->chroma_mask_mv_x = 
‰ame
->chroma_mask_mv_x;

2697 
fs
->
t›_fõld
->
chroma_mask_mv_y
 = fs->
bŸtom_fõld
->chroma_mask_mv_y = 
‰ame
->chroma_mask_mv_y;

2698 
fs
->
t›_fõld
->
chroma_shi·_x
 = fs->
bŸtom_fõld
->chroma_shi·_x = 
‰ame
->chroma_shift_x;

2699 
fs
->
t›_fõld
->
chroma_shi·_y
 = fs->
bŸtom_fõld
->chroma_shi·_y = 
‰ame
->chroma_shift_y;

2702 
fs
->
t›_fõld
->
Ÿf_Êag
 = fs->
bŸtom_fõld
->Ÿf_Êag = 
‰ame
->otf_flag ;

2706 
fs
->
t›_fõld
=
NULL
;

2707 
fs
->
bŸtom_fõld
=
NULL
;

2708 
‰ame
->
t›_fõld
=
NULL
;

2709 
‰ame
->
bŸtom_fõld
=
NULL
;

2710 
‰ame
->frame = frame;

2714 i‡(!
p_Vid
->
a˘ive_•s
->
‰ame_mbs_⁄ly_Êag
 && 
fs
->
‰ame
->
mb_aff_‰ame_Êag
)

2716 
j
=0 ; j< 
‰ame
->
size_y
 >> 3; j++)

2718 
jj
 = (
j
 >> 2)*8 + (j & 0x03);

2719 
jj4
 = 
jj
 + 4;

2720 
jdiv
 = (
j
 >> 1);

2721 
i
=0 ; i < (
‰ame
->
size_x
 >> 2); i++)

2723 
idiv
=
i
 >> 2;

2725 
cuºítmb
 = 
twosz16
*(
jdiv
 >> 1)+ (
idiv
)*2 + (jdiv & 0x01);

2727 i‡(
fs
->
‰ame
->
mŸi⁄
.
mb_fõld
[
cuºítmb
])

2729 
fs
->
bŸtom_fõld
->
mv_öfo
[
j
][
i
].
fõld_‰ame
 = fs->
t›_fõld
->mv_info[j][i].field_frame=1;

2730 
fs
->
‰ame
->
mv_öfo
[2*
j
][
i
].
fõld_‰ame
 = fs->frame->mv_info[2*j+1][i].field_frame = 1;

2732 
fs
->
bŸtom_fõld
->
mv_öfo
[
j
][
i
].
mv
[
LIST_0
] = fs->
‰ame
->mv_öfo[
jj4
][i].mv[LIST_0];

2733 
fs
->
bŸtom_fõld
->
mv_öfo
[
j
][
i
].
mv
[
LIST_1
] = fs->
‰ame
->mv_öfo[
jj4
][i].mv[LIST_1];

2734 
fs
->
bŸtom_fõld
->
mv_öfo
[
j
][
i
].
ªf_idx
[
LIST_0
] = fs->
‰ame
->mv_öfo[
jj4
][i].ref_idx[LIST_0];

2735 
fs
->
bŸtom_fõld
->
mv_öfo
[
j
][
i
].
ªf_idx
[
LIST_1
] = fs->
‰ame
->mv_öfo[
jj4
][i].ref_idx[LIST_1];

2737 
fs
->
t›_fõld
->
mv_öfo
[
j
][
i
].
mv
[
LIST_0
] = fs->
‰ame
->mv_öfo[
jj
][i].mv[LIST_0];

2738 
fs
->
t›_fõld
->
mv_öfo
[
j
][
i
].
mv
[
LIST_1
] = fs->
‰ame
->mv_öfo[
jj
][i].mv[LIST_1];

2739 
fs
->
t›_fõld
->
mv_öfo
[
j
][
i
].
ªf_idx
[
LIST_0
] = fs->
‰ame
->mv_öfo[
jj
][i].ref_idx[LIST_0];

2740 
fs
->
t›_fõld
->
mv_öfo
[
j
][
i
].
ªf_idx
[
LIST_1
] = fs->
‰ame
->mv_öfo[
jj
][i].ref_idx[LIST_1];

2747 i‡(!
p_Vid
->
a˘ive_•s
->
‰ame_mbs_⁄ly_Êag
)

2749 
j
=0 ; j<
fs
->
‰ame
->
size_y
 >> 3 ; j++)

2751 
jj
 = 2* 
	`RSD
(
j
);

2752 
jdiv
 = 
j
 >> 1;

2753 
i
=0 ; i<
fs
->
‰ame
->
size_x
 >> 2 ; i++)

2755 
ii
 = 
	`RSD
(
i
);

2756 
idiv
 = 
i
 >> 2;

2758 
cuºítmb
 = 
twosz16
*(
jdiv
 >> 1)+ (
idiv
)*2 + (jdiv & 0x01);

2760 i‡(!
fs
->
‰ame
->
mb_aff_‰ame_Êag
 || !fs->‰ame->
mŸi⁄
.
mb_fõld
[
cuºítmb
])

2762 
fs
->
‰ame
->
mv_öfo
[2*
j
+1][
i
].
fõld_‰ame
 = fs->frame->mv_info[2*j][i].field_frame = 0;

2764 
fs
->
t›_fõld
->
mv_öfo
[
j
][
i
].
fõld_‰ame
 = fs->
bŸtom_fõld
->mv_info[j][i].field_frame = 0;

2766 
fs
->
t›_fõld
->
mv_öfo
[
j
][
i
].
mv
[
LIST_0
] = fs->
bŸtom_fõld
->mv_öfo[j][i].mv[LIST_0] = fs->
‰ame
->mv_öfo[
jj
][
ii
].mv[LIST_0];

2767 
fs
->
t›_fõld
->
mv_öfo
[
j
][
i
].
mv
[
LIST_1
] = fs->
bŸtom_fõld
->mv_öfo[j][i].mv[LIST_1] = fs->
‰ame
->mv_öfo[
jj
][
ii
].mv[LIST_1];

2770 i‡(
fs
->
‰ame
->
mv_öfo
[
jj
][
ii
].
ªf_idx
[
LIST_0
] == -1)

2771 
fs
->
t›_fõld
->
mv_öfo
[
j
][
i
].
ªf_idx
[
LIST_0
] = fs->
bŸtom_fõld
->mv_info[j][i].ref_idx[LIST_0] = - 1;

2774 
fs
->
t›_fõld
->
mv_öfo
[
j
][
i
].
ªf_idx
[
LIST_0
] = fs->
bŸtom_fõld
->mv_öfo[j][i].ªf_idx[LIST_0] = fs->
‰ame
->mv_öfo[
jj
][
ii
].ref_idx[LIST_0];

2777 i‡(
fs
->
‰ame
->
mv_öfo
[
jj
][
ii
].
ªf_idx
[
LIST_1
] == -1)

2778 
fs
->
t›_fõld
->
mv_öfo
[
j
][
i
].
ªf_idx
[
LIST_1
] = fs->
bŸtom_fõld
->mv_info[j][i].ref_idx[LIST_1] = - 1;

2781 
fs
->
t›_fõld
->
mv_öfo
[
j
][
i
].
ªf_idx
[
LIST_1
] = fs->
bŸtom_fõld
->mv_öfo[j][i].ªf_idx[LIST_1] = fs->
‰ame
->mv_öfo[
jj
][
ii
].ref_idx[LIST_1];

2786 
fs
->
‰ame
->
mv_öfo
[2*
j
+1][
i
].
fõld_‰ame
 = fs->‰ame->mv_öfo[2*j][i].fõld_‰amefs->‰ame->
mŸi⁄
.
mb_fõld
[
cuºítmb
];

2793 
j
=0 ; j<
fs
->
‰ame
->
size_y
 >> 2 ; j++)

2795 
i
=0 ; i<
fs
->
‰ame
->
size_x
 >> 2 ; i++)

2797 
‰ame
->
mv_öfo
[
j
][
i
].
fõld_‰ame
 = 0;

2801 
	}
}

2811 
	$dpb_comböe_fõld_yuv
(
VideoP¨amëîs
 *
p_Vid
, 
FømeSt‹e
 *
fs
)

2813 
i
, 
j
;

2815 i‡(!
fs
->
‰ame
)

2817 
fs
->
‰ame
 = 
	`Æloc_°‹abÀ_pi˘uª
(
p_Vid
, 
FRAME
, fs->
t›_fõld
->
size_x
, fs->t›_fõld->
size_y
*2, fs->t›_fõld->
size_x_¸
, fs->t›_fõld->
size_y_¸
*2);

2820 
i
=0; i<
fs
->
t›_fõld
->
size_y
; i++)

2822 
	`mem˝y
(
fs
->
‰ame
->
imgY
[
i
*2], fs->
t›_fõld
->imgY[i] , fs->t›_fõld->
size_x
 * (
img≥l
));

2823 
	`mem˝y
(
fs
->
‰ame
->
imgY
[
i
*2 + 1], fs->
bŸtom_fõld
->imgY[i], fs->bŸtom_fõld->
size_x
 * (
img≥l
));

2826 
j
 = 0; j < 2; j++)

2828 
i
=0; i<
fs
->
t›_fõld
->
size_y_¸
; i++)

2830 
	`mem˝y
(
fs
->
‰ame
->
imgUV
[
j
][
i
*2], fs->
t›_fõld
->imgUV[j][i], fs->t›_fõld->
size_x_¸
*(
img≥l
));

2831 
	`mem˝y
(
fs
->
‰ame
->
imgUV
[
j
][
i
*2 + 1], fs->
bŸtom_fõld
->imgUV[j][i], fs->bŸtom_fõld->
size_x_¸
*(
img≥l
));

2835 
fs
->
poc
=fs->
‰ame
->po¯=fs->‰ame->
‰ame_poc
 = 
	`imö
 (fs->
t›_fõld
->poc, fs->
bŸtom_fõld
->poc);

2837 
fs
->
bŸtom_fõld
->
‰ame_poc
=fs->
t›_fõld
->‰ame_poc=fs->
‰ame
->
poc
;

2839 
fs
->
bŸtom_fõld
->
t›_poc
=fs->
‰ame
->t›_poc=fs->
t›_fõld
->
poc
;

2840 
fs
->
t›_fõld
->
bŸtom_poc
=fs->
‰ame
->bŸtom_poc=fs->
bŸtom_fõld
->
poc
;

2842 
fs
->
‰ame
->
u£d_f‹_ª„ªn˚
 = (fs->
t›_fõld
->u£d_f‹_ª„ªn˚ && fs->
bŸtom_fõld
->used_for_reference );

2843 
fs
->
‰ame
->
is_l⁄g_ãrm
 = (fs->
t›_fõld
->is_l⁄g_ãrm && fs->
bŸtom_fõld
->is_long_term );

2845 i‡(
fs
->
‰ame
->
is_l⁄g_ãrm
)

2846 
fs
->
‰ame
->
l⁄g_ãrm_‰ame_idx
 = fs->long_term_frame_idx;

2848 
fs
->
‰ame
->
t›_fõld
 = fs->top_field;

2849 
fs
->
‰ame
->
bŸtom_fõld
 = fs->bottom_field;

2850 
fs
->
‰ame
->frame = fs->frame;

2852 
fs
->
‰ame
->
coded_‰ame
 = 0;

2854 
fs
->
‰ame
->
chroma_f‹m©_idc
 = fs->
t›_fõld
->chroma_format_idc;

2855 
fs
->
‰ame
->
chroma_mask_mv_x
 = fs->
t›_fõld
->chroma_mask_mv_x;

2856 
fs
->
‰ame
->
chroma_mask_mv_y
 = fs->
t›_fõld
->chroma_mask_mv_y;

2857 
fs
->
‰ame
->
chroma_shi·_x
 = fs->
t›_fõld
->chroma_shift_x;

2858 
fs
->
‰ame
->
chroma_shi·_y
 = fs->
t›_fõld
->chroma_shift_y;

2860 
fs
->
‰ame
->
‰ame_¸›pög_Êag
 = fs->
t›_fõld
->frame_cropping_flag;

2861 i‡(
fs
->
‰ame
->
‰ame_¸›pög_Êag
)

2863 
fs
->
‰ame
->
‰ame_¸›_t›_off£t
 = fs->
t›_fõld
->frame_crop_top_offset;

2864 
fs
->
‰ame
->
‰ame_¸›_bŸtom_off£t
 = fs->
t›_fõld
->frame_crop_bottom_offset;

2865 
fs
->
‰ame
->
‰ame_¸›_À·_off£t
 = fs->
t›_fõld
->frame_crop_left_offset;

2866 
fs
->
‰ame
->
‰ame_¸›_right_off£t
 = fs->
t›_fõld
->frame_crop_right_offset;

2869 
fs
->
t›_fõld
->
‰ame
 = fs->
bŸtom_fõld
->frame = fs->frame;

2870 
fs
->
t›_fõld
->top_field = fs->top_field;

2871 
fs
->
t›_fõld
->
bŸtom_fõld
 = fs->bottom_field;

2872 
fs
->
bŸtom_fõld
->
t›_fõld
 = fs->top_field;

2873 
fs
->
bŸtom_fõld
->bottom_field = fs->bottom_field;

2876 
fs
->
‰ame
->
Ÿf_Êag
 = fs->
t›_fõld
->otf_flag;

2877 
	}
}

2886 
	$dpb_comböe_fõld
(
VideoP¨amëîs
 *
p_Vid
, 
FømeSt‹e
 *
fs
)

2888 
i
,
j
, 
jj
, 
jj4
;

2890 
	`dpb_comböe_fõld_yuv
(
p_Vid
, 
fs
);

2891 i‡(
fs
->
‰ame
->
u£d_f‹_ª„ªn˚
)

2893 if–(
p_Vid
->
p_I≈
->
£∑øã_cﬁour_∂™e_Êag
 != 0) )

2895 
	`UnifõdO√F‹thPix_JV
(
p_Vid
, 0, 
fs
->
‰ame
);

2896 
	`UnifõdO√F‹thPix_JV
(
p_Vid
, 1, 
fs
->
‰ame
);

2897 
	`UnifõdO√F‹thPix_JV
(
p_Vid
, 2, 
fs
->
‰ame
);

2901 
	`UnifõdO√F‹thPix
(
p_Vid
, 
fs
->
‰ame
);

2906 
j
=0 ; j<
fs
->
t›_fõld
->
size_y
 >> 2 ; j++)

2908 
jj
 = 8*(
j
 >> 2) + (j & 0x03);

2909 
jj4
 = 
jj
 + 4;

2910 
i
=0 ; i<
fs
->
t›_fõld
->
size_x
 >> 2 ; i++)

2912 
fs
->
‰ame
->
mv_öfo
[
jj
][
i
].
fõld_‰ame
fs->‰ame->mv_öfo[
jj4
][i].field_frame = 1;

2914 
fs
->
‰ame
->
mv_öfo
[
jj
][
i
].
mv
[
LIST_0
] = fs->
t›_fõld
->mv_öfo[
j
][i].mv[LIST_0];

2915 
fs
->
‰ame
->
mv_öfo
[
jj
][
i
].
mv
[
LIST_1
] = fs->
t›_fõld
->mv_öfo[
j
][i].mv[LIST_1];

2917 
fs
->
‰ame
->
mv_öfo
[
jj4
][
i
].
mv
[
LIST_0
] = fs->
bŸtom_fõld
->mv_öfo[
j
][i].mv[LIST_0];

2918 
fs
->
‰ame
->
mv_öfo
[
jj4
][
i
].
mv
[
LIST_1
] = fs->
bŸtom_fõld
->mv_öfo[
j
][i].mv[LIST_1];

2920 
fs
->
t›_fõld
->
mv_öfo
[
j
][
i
].
fõld_‰ame
 = 1;

2921 
fs
->
bŸtom_fõld
->
mv_öfo
[
j
][
i
].
fõld_‰ame
 = 1;

2924 
	}
}

2933 
	$Æloc_ªf_pic_li°_ª‹dîög_buf„r
(
Sli˚
 *
cuºSli˚
)

2935 
	`‰ì_ªf_pic_li°_ª‹dîög_buf„r
(
cuºSli˚
);

2937 i‡(
cuºSli˚
->
¶i˚_ty≥
 !
I_SLICE
 && cuºSli˚->¶i˚_ty≥ !
SI_SLICE
)

2939 
size
 = 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
] + 1;

2940 i‡((
cuºSli˚
->
modifiˇti⁄_of_pic_nums_idc
[
LIST_0
] = 
	`ˇŒoc
(
size
, ()))==
NULL
)

2941 
	`no_mem_exô
("alloc_ref_pic_list_reordering_buffer: modification_of_pic_nums_idc_l0");

2942 i‡((
cuºSli˚
->
abs_diff_pic_num_möus1
[
LIST_0
] = 
	`ˇŒoc
(
size
, ()))==
NULL
)

2943 
	`no_mem_exô
("alloc_ref_pic_list_reordering_buffer:ábs_diff_pic_num_minus1_l0");

2944 i‡((
cuºSli˚
->
l⁄g_ãrm_pic_idx
[
LIST_0
] = 
	`ˇŒoc
(
size
, ()))==
NULL
)

2945 
	`no_mem_exô
("alloc_ref_pic_list_reordering_buffer:Üong_term_pic_idx_l0");

2946 #i‡(
MVC_EXTENSION_ENABLE
)

2947 i‡((
cuºSli˚
->
abs_diff_võw_idx_möus1
[
LIST_0
] = 
	`ˇŒoc
(
size
, ()))==
NULL
)

2948 
	`no_mem_exô
("alloc_ref_pic_list_reordering_buffer:ábs_diff_view_idx_minus1_l0");

2953 
cuºSli˚
->
modifiˇti⁄_of_pic_nums_idc
[
LIST_0
] = 
NULL
;

2954 
cuºSli˚
->
abs_diff_pic_num_möus1
[
LIST_0
] = 
NULL
;

2955 
cuºSli˚
->
l⁄g_ãrm_pic_idx
[
LIST_0
] = 
NULL
;

2956 #i‡(
MVC_EXTENSION_ENABLE
)

2957 
cuºSli˚
->
abs_diff_võw_idx_möus1
[
LIST_0
] = 
NULL
;

2961 i‡(
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
)

2963 
size
 = 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_1
] + 1;

2964 i‡((
cuºSli˚
->
modifiˇti⁄_of_pic_nums_idc
[
LIST_1
] = 
	`ˇŒoc
(
size
, ()))==
NULL
)

2965 
	`no_mem_exô
("alloc_ref_pic_list_reordering_buffer: modification_of_pic_nums_idc_l1");

2966 i‡((
cuºSli˚
->
abs_diff_pic_num_möus1
[
LIST_1
] = 
	`ˇŒoc
(
size
, ()))==
NULL
)

2967 
	`no_mem_exô
("alloc_ref_pic_list_reordering_buffer:ábs_diff_pic_num_minus1_l1");

2968 i‡((
cuºSli˚
->
l⁄g_ãrm_pic_idx
[
LIST_1
] = 
	`ˇŒoc
(
size
, ()))==
NULL
)

2969 
	`no_mem_exô
("alloc_ref_pic_list_reordering_buffer:Üong_term_pic_idx_l1");

2970 #i‡(
MVC_EXTENSION_ENABLE
)

2971 i‡((
cuºSli˚
->
abs_diff_võw_idx_möus1
[
LIST_1
] = 
	`ˇŒoc
(
size
, ()))==
NULL
)

2972 
	`no_mem_exô
("alloc_ref_pic_list_reordering_buffer:ábs_diff_view_idx_minus1_l1");

2977 
cuºSli˚
->
modifiˇti⁄_of_pic_nums_idc
[
LIST_1
] = 
NULL
;

2978 
cuºSli˚
->
abs_diff_pic_num_möus1
[
LIST_1
] = 
NULL
;

2979 
cuºSli˚
->
l⁄g_ãrm_pic_idx
[
LIST_1
] = 
NULL
;

2980 #i‡(
MVC_EXTENSION_ENABLE
)

2981 
cuºSli˚
->
abs_diff_võw_idx_möus1
[
LIST_1
] = 
NULL
;

2984 
	}
}

2993 
	$‰ì_ªf_pic_li°_ª‹dîög_buf„r
(
Sli˚
 *
cuºSli˚
)

2995 i‡(
cuºSli˚
->
modifiˇti⁄_of_pic_nums_idc
[
LIST_0
])

2996 
	`‰ì
(
cuºSli˚
->
modifiˇti⁄_of_pic_nums_idc
[
LIST_0
]);

2997 i‡(
cuºSli˚
->
abs_diff_pic_num_möus1
[
LIST_0
])

2998 
	`‰ì
(
cuºSli˚
->
abs_diff_pic_num_möus1
[
LIST_0
]);

2999 i‡(
cuºSli˚
->
l⁄g_ãrm_pic_idx
[
LIST_0
])

3000 
	`‰ì
(
cuºSli˚
->
l⁄g_ãrm_pic_idx
[
LIST_0
]);

3002 
cuºSli˚
->
modifiˇti⁄_of_pic_nums_idc
[
LIST_0
] = 
NULL
;

3003 
cuºSli˚
->
abs_diff_pic_num_möus1
[
LIST_0
] = 
NULL
;

3004 
cuºSli˚
->
l⁄g_ãrm_pic_idx
[
LIST_0
] = 
NULL
;

3006 i‡(
cuºSli˚
->
modifiˇti⁄_of_pic_nums_idc
[
LIST_1
])

3007 
	`‰ì
(
cuºSli˚
->
modifiˇti⁄_of_pic_nums_idc
[
LIST_1
]);

3008 i‡(
cuºSli˚
->
abs_diff_pic_num_möus1
[
LIST_1
])

3009 
	`‰ì
(
cuºSli˚
->
abs_diff_pic_num_möus1
[
LIST_1
]);

3010 i‡(
cuºSli˚
->
l⁄g_ãrm_pic_idx
[
LIST_1
])

3011 
	`‰ì
(
cuºSli˚
->
l⁄g_ãrm_pic_idx
[
LIST_1
]);

3013 
cuºSli˚
->
modifiˇti⁄_of_pic_nums_idc
[
LIST_1
] = 
NULL
;

3014 
cuºSli˚
->
abs_diff_pic_num_möus1
[
LIST_1
] = 
NULL
;

3015 
cuºSli˚
->
l⁄g_ãrm_pic_idx
[
LIST_1
] = 
NULL
;

3017 #i‡(
MVC_EXTENSION_ENABLE
)

3018 i‡(
cuºSli˚
->
abs_diff_võw_idx_möus1
[
LIST_0
])

3019 
	`‰ì_poöãr
(
cuºSli˚
->
abs_diff_võw_idx_möus1
[
LIST_0
]);

3020 i‡(
cuºSli˚
->
abs_diff_võw_idx_möus1
[
LIST_1
])

3021 
	`‰ì_poöãr
(
cuºSli˚
->
abs_diff_võw_idx_möus1
[
LIST_1
]);

3023 
	}
}

3039 
	$fûl_‰ame_num_g≠
(
VideoP¨amëîs
 *
p_Vid
, 
FømeF‹m©
 *
ouçut
)

3041 
CuºFømeNum
;

3042 
Unu£dSh‹tTîmFømeNum
;

3043 
St‹abÀPi˘uª
 *
pi˘uª
 = 
NULL
;

3044 
«l_ªf_idc_bak
 = 
p_Vid
->
«l_ª„ªn˚_idc
;

3049 
p_Vid
->
«l_ª„ªn˚_idc
 = 
NALU_PRIORITY_LOW
;

3051 
Unu£dSh‹tTîmFømeNum
 = (
p_Vid
->
¥e_‰ame_num
 + 1Ë%Ö_Vid->
max_‰ame_num
;

3052 
CuºFømeNum
 = 
p_Vid
->
‰ame_num
;

3054 
CuºFømeNum
 !
Unu£dSh‹tTîmFømeNum
)

3056 
pi˘uª
 = 
	`Æloc_°‹abÀ_pi˘uª
 (
p_Vid
, 
FRAME
,Ö_Vid->
width
,Ö_Vid->
height
,Ö_Vid->
width_¸
,Ö_Vid->
height_¸
);

3057 
pi˘uª
->
coded_‰ame
 = 1;

3058 
pi˘uª
->
pic_num
 = 
Unu£dSh‹tTîmFømeNum
;

3059 
pi˘uª
->
n⁄_exi°ög
 = 1;

3060 
pi˘uª
->
is_ouçut
 = 1;

3062 
p_Vid
->
ad≠tive_ªf_pic_buf„rög_Êag
 = 0;

3063 
	`°‹e_pi˘uª_ö_dpb
(
p_Vid
->
p_Dpb_œyî
[0], 
pi˘uª
, 
ouçut
);

3064 
pi˘uª
=
NULL
;

3065 
Unu£dSh‹tTîmFømeNum
 = (Unu£dSh‹tTîmFømeNum + 1Ë% 
p_Vid
->
max_‰ame_num
;

3068 
p_Vid
->
«l_ª„ªn˚_idc
 = 
«l_ªf_idc_bak
;

3069 
	}
}

3078 
	$compuã_cﬁoˇãd
(
Sli˚
 *
cuºSli˚
, 
St‹abÀPi˘uª
 **
li°X
[6])

3080 
i
, 
j
;

3082 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

3084 i‡(
cuºSli˚
->
dúe˘_•©ül_mv_¥ed_Êag
 == 0)

3086 
j
 = 0; j < 2 + (
cuºSli˚
->
mb_aff_‰ame_Êag
 * 4); j += 2)

3088 
i
 = 0; i < 
cuºSli˚
->
li°Xsize
[
j
];i++)

3090 
¥esˇÀ
, 
iTRb
, 
iTRp
;

3092 i‡(
j
==0)

3094 
iTRb
 = 
	`iClù3
–-128, 127, 
p_Vid
->
íc_pi˘uª
->
poc
 - 
li°X
[
LIST_0
 + 
j
][
i
]->poc );

3096 i‡(
j
 == 2)

3098 
iTRb
 = 
	`iClù3
–-128, 127, 
p_Vid
->
íc_pi˘uª
->
t›_poc
 - 
li°X
[
LIST_0
 + 
j
][
i
]->
poc
 );

3102 
iTRb
 = 
	`iClù3
–-128, 127, 
p_Vid
->
íc_pi˘uª
->
bŸtom_poc
 - 
li°X
[
LIST_0
 + 
j
][
i
]->
poc
 );

3105 
iTRp
 = 
	`iClù3
–-128, 127, 
li°X
[
LIST_1
 + 
j
][0]->
poc
 -Üi°X[
LIST_0
 + j][
i
]->poc);

3107 i‡(
iTRp
!=0)

3109 
¥esˇÀ
 = ( 16384 + 
	`übs
–
iTRp
 / 2 ) ) / iTRp;

3110 
cuºSli˚
->
mvsˇÀ
[
j
][
i
] = 
	`iClù3
–-1024, 1023, ( 
iTRb
 * 
¥esˇÀ
 + 32 ) >> 6 ) ;

3114 
cuºSli˚
->
mvsˇÀ
[
j
][
i
] = 9999;

3119 
	}
}

3122 
	$¥o˚ss_pi˘uª_ö_dpb_s
(
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
p_pic
)

3126 
ImageD©a
 *
p_img_out
 = &
p_Vid
->
ãmpD©a3
;

3127 
ImageD©a
 
img_ö
;

3128 
img≥l
*** 
d_img
;

3129 
i
;

3131 
img_ö
.
‰m_°ride
[0] = 
p_pic
->
size_x_∑dded
;

3132 
img_ö
.
‰m_°ride
[1] = img_ö.‰m_°ride[2] = 
p_pic
->
size_x_¸
 + (p_pic->
∑d_size_uv_x
 << 1);

3134 i‡(
p_pic
->
°ru˘uª
 =
FRAME
)

3136 
img_ö
.
‰m_d©a
[0] = 
p_pic
->
imgY
;

3137 
img_ö
.
‰m_d©a
[1] = 
p_pic
->
imgUV
[0];

3138 
img_ö
.
‰m_d©a
[2] = 
p_pic
->
imgUV
[1];

3139 
img_ö
.
t›_°ride
[0] = img_ö.
bŸ_°ride
[0] = img_ö.
‰m_°ride
[0] << 1;

3140 
img_ö
.
t›_°ride
[1] = img_ö.
bŸ_°ride
[1] = img_ö.t›_°ride[2] = img_ö.bŸ_°ride[2] = img_ö.
‰m_°ride
[1] << 1;

3141 
d_img
 = 
p_img_out
->
‰m_d©a
;

3145 
img_ö
.
t›_°ride
[0] = img_ö.
bŸ_°ride
[0] = img_ö.
‰m_°ride
[0];

3146 
img_ö
.
t›_°ride
[1] = img_ö.
bŸ_°ride
[1] = img_ö.t›_°ride[2] = img_ö.bŸ_°ride[2] =img_ö.
‰m_°ride
[1];

3147 i‡(
p_pic
->
°ru˘uª
 =
TOP_FIELD
)

3149 
img_ö
.
t›_d©a
[0] = 
p_pic
->
imgY
;

3150 
img_ö
.
t›_d©a
[1] = 
p_pic
->
imgUV
[0];

3151 
img_ö
.
t›_d©a
[2] = 
p_pic
->
imgUV
[1];

3152 
d_img
 = 
p_img_out
->
t›_d©a
;

3156 
img_ö
.
bŸ_d©a
[0] = 
p_pic
->
imgY
;

3157 
img_ö
.
bŸ_d©a
[1] = 
p_pic
->
imgUV
[0];

3158 
img_ö
.
bŸ_d©a
[2] = 
p_pic
->
imgUV
[1];

3159 
d_img
 = 
p_img_out
->
bŸ_d©a
;

3163 
i
=0; i<
p_pic
->
size_y
; i++)

3164 
	`mem˝y
(
d_img
[0][
i
], 
p_pic
->
imgY
[i],Ö_pic->
size_x
*(
img≥l
));

3165 i‡(
p_Vid
->
yuv_f‹m©
 !
YUV400
)

3167 
i
=0; i<
p_pic
->
size_y_¸
; i++)

3168 
	`mem˝y
(
d_img
[1][
i
], 
p_pic
->
imgUV
[0][i],Ö_pic->
size_x_¸
 * (
img≥l
));

3169 
i
=0; i<
p_pic
->
size_y_¸
; i++)

3170 
	`mem˝y
(
d_img
[2][
i
], 
p_pic
->
imgUV
[1][i],Ö_pic->
size_x_¸
 * (
img≥l
));

3172 
	}
}

3180 
	$c›y_°‹abÀ_pi˘uª
(
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
s
, St‹abÀPi˘uª *
d
)

3182 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

3183 
≈œ√
;

3184 
i
, 
j
;

3185 
size_x
 = 
s
->size_x;

3186 
size_y
 = 
s
->size_y;

3187 
size_x_¸
 = 
s
->size_x_cr;

3188 
size_y_¸
 = 
s
->size_y_cr;

3189 
img≥l
*** 
s_img
;

3190 
	`check_vÆue
(
img≥l
 **
pBufIn
, 
width
, 
height
, 
max
);

3193 i‡(
s
->
°ru˘uª
 =
FRAME
)

3195 
s_img
 = 
p_Vid
->
ãmpD©a3
.
‰m_d©a
;

3197 i‡(
s
->
°ru˘uª
 =
TOP_FIELD
)

3199 
s_img
 = 
p_Vid
->
ãmpD©a3
.
t›_d©a
;

3203 
s_img
 = 
p_Vid
->
ãmpD©a3
.
bŸ_d©a
;

3206 
i
=0; i<
size_y
; i++)

3207 
	`mem˝y
((*)
d
->
imgY
[
i
], (*)
s_img
[0][i], 
size_x
 *  (
img≥l
));

3209 
d
->
p_img
[0] = d->
imgY
;

3210 
d
->
p_cuº_img
 = d->
p_img
[0];

3212 i‡(
p_Vid
->
yuv_f‹m©
 !
YUV400
)

3215 
i
=0; i<
size_y_¸
; i++)

3216 
	`mem˝y
((*)
d
->
imgUV
[0][
i
], (*)
s_img
[1][i], 
size_x_¸
 *  (
img≥l
));

3217 
i
=0; i<
size_y_¸
; i++)

3218 
	`mem˝y
((*)
d
->
imgUV
[1][
i
], (*)
s_img
[2][i], 
size_x_¸
 *  (
img≥l
));

3220 
d
->
p_img
[1] = d->
imgUV
[0];

3221 
d
->
p_img
[2] = d->
imgUV
[1];

3224 
d
->
p_cuº_img_sub
 = d->
p_img_sub
[0];

3225 
j
 = 0; j < (
size_y
 >> 
BLOCK_SHIFT
); j++)

3227 
i
 = 0; i < (
size_x
 >> 
BLOCK_SHIFT
); i++)

3229 
d
->
mv_öfo
[
j
][
i
].
ªf_idx
[
LIST_0
] = -1;

3230 
d
->
mv_öfo
[
j
][
i
].
ªf_idx
[
LIST_1
] = -1;

3231 
d
->
mv_öfo
[
j
][
i
].
ªf_pic
[
LIST_0
] = 
NULL
;

3232 
d
->
mv_öfo
[
j
][
i
].
ªf_pic
[
LIST_1
] = 
NULL
;

3236 if–(
p_I≈
->
£∑øã_cﬁour_∂™e_Êag
 != 0) )

3238  
≈œ√
=0;Ç∂™e<
MAX_PLANE
;Çplane++ )

3240 
j
 = 0; j < (
size_y
 >> 
BLOCK_SHIFT
); j++)

3242 
i
 = 0; i < (
size_x
 >> 
BLOCK_SHIFT
); i++)

3244 
d
->
JVmv_öfo
[
≈œ√
][
j
][
i
].
ªf_idx
[
LIST_0
] = -1;

3245 
d
->
JVmv_öfo
[
≈œ√
][
j
][
i
].
ªf_idx
[
LIST_1
] = -1;

3251 
d
->
pic_num
 = 
s
->pic_num;

3252 
d
->
‰ame_num
 = 
s
->frame_num;

3253 
d
->
l⁄g_ãrm_‰ame_idx
 = 
s
->long_term_frame_idx;

3254 
d
->
l⁄g_ãrm_pic_num
 = 
s
->long_term_pic_num;

3255 
d
->
u£d_f‹_ª„ªn˚
 = 
s
->used_for_reference;

3256 
d
->
is_l⁄g_ãrm
 = 
s
->is_long_term;

3257 
d
->
n⁄_exi°ög
 = 
s
->non_existing;

3258 
d
->
is_ouçut
 = 1;

3259 
d
->
°ru˘uª
 = 
s
->structure;

3262 
d
->
t›_fõld
 = 
NULL
;

3263 
d
->
bŸtom_fõld
 = 
NULL
;

3264 
d
->
‰ame
 = 
NULL
;

3266 
d
->
coded_‰ame
 = 
s
->coded_frame;

3267 
d
->
mb_aff_‰ame_Êag
 = 
s
->mb_aff_frame_flag;

3269 
	`mem˝y
–(*)&
d
->
°©s
, (*)&
s
->°©s, –
SètP¨amëîs
 ) );

3270 
d
->
°©s
.
NumbîBFømes
 = 
s
->stats.NumberBFrames;

3271 
	}
}

3279 
St‹abÀPi˘uª
 * 
	$˛⁄e_°‹abÀ_pi˘uª
–
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
p_pic
 )

3281 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

3282 
St‹abÀPi˘uª
 *
p_°‹ed_pic
;

3283 
«l_ª„ªn˚_idc

p_Vid
->nal_reference_idc;

3284 
p_Vid
->
«l_ª„ªn˚_idc
 = 
NALU_PRIORITY_HIGH
;

3285 
p_°‹ed_pic
 = 
	`Æloc_°‹abÀ_pi˘uª
 (
p_Vid
, (
Pi˘uªSåu˘uª
Ëp_Vid->
°ru˘uª
, 
p_pic
->
size_x
,Ö_pic->
size_y
,Ö_pic->
size_x_¸
,Ö_pic->
size_y_¸
);

3286 
p_Vid
->
«l_ª„ªn˚_idc
 =Çal_reference_idc;

3287 
p_°‹ed_pic
->
poc
 = 
p_Vid
->
‰amïoc
;

3288 
p_°‹ed_pic
->
t›_poc
 = 
p_Vid
->
t›poc
;

3289 
p_°‹ed_pic
->
bŸtom_poc
 = 
p_Vid
->
bŸtompoc
;

3290 
p_°‹ed_pic
->
‰ame_poc
 = 
p_Vid
->
‰amïoc
;

3291 
p_°‹ed_pic
->
pic_num
 = 
p_pic
->pic_num;

3292 
p_°‹ed_pic
->
‰ame_num
 = 
p_pic
->frame_num;

3293 
p_°‹ed_pic
->
coded_‰ame
 = 1;

3294 
p_°‹ed_pic
->
mb_aff_‰ame_Êag
 = 
p_Vid
->mb_aff_‰ame_Êag = (
Boﬁón
Ë(
p_I≈
->
MbI¡îœ˚
 !
FRAME_CODING
);

3296 
	`c›y_∑øms
(
p_Vid
, 
p_°‹ed_pic
,Ö_Vid->
a˘ive_•s
);

3299 
	`c›y_°‹abÀ_pi˘uª
(
p_Vid
, 
p_pic
, 
p_°‹ed_pic
);

3300 #i‡(
MVC_EXTENSION_ENABLE
)

3302 
p_°‹ed_pic
->
öãr_võw_Êag
[0] = 
p_pic
->inter_view_flag[0];

3303 
p_°‹ed_pic
->
öãr_võw_Êag
[1] = 
p_pic
->inter_view_flag[1];

3304 
p_°‹ed_pic
->
™ch‹_pic_Êag
[0] =Ö_stored_pic->anchor_pic_flag[1] = 0;

3305 
p_°‹ed_pic
->
võw_id
 = 0;

3308  
p_°‹ed_pic
;

3309 
	}
}

3323 #i‡(
MVC_EXTENSION_ENABLE
)

3324 
	$°‹e_¥oc_pi˘uª_ö_dpb
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
St‹abÀPi˘uª
* 
p
, 
FømeF‹m©
 *
ouçut
)

3326 
VideoP¨amëîs
 *
p_Vid
 = 
p_Dpb
->p_Vid;

3327 
FømeSt‹e
 *
fs
 = 
p_Dpb
->
fs_ûªf
[0];

3328 if(
p_Dpb
->
u£d_size_û
>0 && 
fs
->
is_u£d
==3)

3331 #ifde‡
_DEBUG


3332 if(
p
->
°ru˘uª
==
FRAME
)

3333 
	`as£π
(
fs
->
‰ame
->
‰ame_poc
 !
p
->
poc
);

3334 if(
p
->
°ru˘uª
==
TOP_FIELD
)

3335 
	`as£π
(
fs
->
t›_fõld
->
t›_poc
 !
p
->
poc
);

3336 if(
p
->
°ru˘uª
==
BOTTOM_FIELD
)

3337 
	`as£π
(
fs
->
bŸtom_fõld
->
bŸtom_poc
 !
p
->
poc
);

3339 if(
fs
->
‰ame
)

3341 
	`‰ì_°‹abÀ_pi˘uª
(
p_Vid
, 
fs
->
‰ame
);

3342 
fs
->
‰ame
 = 
NULL
;

3344 if(
fs
->
t›_fõld
)

3346 
	`‰ì_°‹abÀ_pi˘uª
(
p_Vid
, 
fs
->
t›_fõld
);

3347 
fs
->
t›_fõld
 = 
NULL
;

3349 if(
fs
->
bŸtom_fõld
)

3351 
	`‰ì_°‹abÀ_pi˘uª
(
p_Vid
, 
fs
->
bŸtom_fõld
);

3352 
fs
->
bŸtom_fõld
 = 
NULL
;

3354 
fs
->
is_u£d
 = 0;

3355 
fs
->
is_ª„ªn˚
 = 0;

3356 
fs
->
is_öãr_œyî
 = 
TRUE
;

3357 
p_Dpb
->
u£d_size_û
--;

3359 #ifde‡
_DEBUG


3360 if(
fs
->
is_u£d
>0)

3363 if(
p
->
°ru˘uª
==
FRAME
)

3364 
	`as£π
(
fs
->
‰ame
 =
NULL
);

3365 if(
p
->
°ru˘uª
==
TOP_FIELD
)

3366 
	`as£π
(
fs
->
t›_fõld
 =
NULL
);

3367 if(
p
->
°ru˘uª
==
BOTTOM_FIELD
)

3368 
	`as£π
(
fs
->
bŸtom_fõld
 =
NULL
);

3372 
	`ö£π_pi˘uª_ö_dpb
(
p_Vid
, 
fs
, 
p
);

3373 if((
p
->
°ru˘uª
==
FRAME
 && 
fs
->
is_u£d
 == 3) || (p->structure!=FRAME && fs->is_used && fs->is_used <3))

3374 
p_Dpb
->
u£d_size_û
++;

3375 
	}
}

	@lencod/src/mc_prediction.c

15 
	~"c⁄åibut‹s.h
"

17 
	~<°dlib.h
>

18 
	~<as£π.h
>

19 
	~<limôs.h
>

20 
	~<m©h.h
>

22 
	~"globÆ.h
"

23 
	~"block.h
"

25 
	~"ma¸oblock.h
"

26 
	~"mc_¥edi˘i⁄.h
"

27 
	~"ªfbuf.h
"

28 
	~"image.h
"

29 
	~"mb_ac˚ss.h
"

30 
	~"me_di°‹ti⁄.h
"

38 
ölöe
 
	$weighãd_bi_¥edi˘i⁄
(
img≥l
** 
mb_¥ed
, img≥l* 
l0¥ed
, img≥»*
l1¥ed
,

39 
block_size_y
, 
block_x
, 
block_size_x
,

40 
max_img≥l_vÆue
,

41 
wbp0
, 
wbp1
, 
off£t
, 
wp_round
, 
weight_díom
)

43 
i
, 
j
;

44 
block_x4
 = 
block_x
 + 
block_size_x
;

46 
j
 = 0; j< 
block_size_y
; j++)

48 
i
=
block_x
; i<
block_x4
; i++)

49 
mb_¥ed
[
j
][
i
] = (
img≥l
Ë
	`iClù1
–
max_img≥l_vÆue
,

50 ((
wbp0
 * *
l0¥ed
++ + 
wbp1
 * *
l1¥ed
++ + 
wp_round
Ë>> (
weight_díom
)Ë+ 
off£t
);

52 
	}
}

60 
ölöe
 
	$weighãd_mc_¥edi˘i⁄
(
img≥l
** 
mb_¥ed
, img≥l* 
Õªd
,

61 
block_size_y
, 
block_x
, 
block_size_x
,

62 
max_img≥l_vÆue
,

63 
wp
, 
off£t
, 
wp_round
, 
weight_díom
)

65 
i
, 
j
;

66 
block_x4
 = 
block_x
 + 
block_size_x
;

68 
j
 = 0; j < 
block_size_y
; j++)

70 
i
=
block_x
; i<
block_x4
; i++)

71 
mb_¥ed
[
j
][
i
] = (
img≥l
Ë
	`iClù1
–
max_img≥l_vÆue
,

72 ((
wp
 * *
Õªd
++ + 
wp_round
Ë>> 
weight_díom
Ë+ 
off£t
);

74 
	}
}

82 
ölöe
 
	$bi_¥edi˘i⁄
(
img≥l
** 
mb_¥ed
, img≥l* 
l0¥ed
, img≥»*
l1¥ed
,

83 
block_size_y
, 
block_x
, 
block_size_x
)

85 
i
, 
j
;

86 
block_x4
 = 
block_x
 + 
block_size_x
;

88 
j
 = 0; j < 
block_size_y
; j++)

90 
i
=
block_x
; i<
block_x4
; i++)

91 
mb_¥ed
[
j
][
i
] = (*
l0¥ed
++ + *
l1¥ed
++ + 1) >> 1;

93 
	}
}

101 
ölöe
 
	$mc_¥edi˘i⁄
(
img≥l
** 
mb_¥ed
, img≥l* 
Õªd
, 
block_size_y
, 
block_x
, 
block_size_x
)

103 
j
;

104 
j
 = 0; j < 
block_size_y
; j++)

106 
	`mem˝y
(&(
mb_¥ed
[
j
][
block_x
]), 
Õªd
, 
block_size_x
 * (
img≥l
));

107 
Õªd
 +
block_size_x
;

109 
	}
}

117 
ölöe
 
	$O√Comp⁄ítLumaPªdi˘i⁄
 ( 
VideoP¨amëîs
 *
p_Vid
,

118 
img≥l
* 
m¥ed
,

119 
pic_pix_x
,

120 
pic_pix_y
,

121 
block_size_x
,

122 
block_size_y
,

123 
St‹abÀPi˘uª
 *
li°


126 
j
;

127 
img≥l
 *
ªf_löe
 = 
	`UMVLöe4X
 (
li°
, 
pic_pix_y
, 
pic_pix_x
);

129 
j
 = 0; j < 
block_size_y
; j++)

131 
	`mem˝y
(
m¥ed
, 
ªf_löe
, 
block_size_x
 * (
img≥l
));

132 
ªf_löe
 +
p_Vid
->
∑dded_size_x
;

133 
m¥ed
 +
block_size_x
;

135 
	}
}

144 
	$luma_¥edi˘i⁄
 (
Ma¸oblock
* 
cuºMB
,

145 
block_x
,

146 
block_y
,

147 
block_size_x
,

148 
block_size_y
,

149 
p_dú
,

150 
li°_mode
[2],

151 *
ªf_idx
,

152 
bùªd_me


155 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

156 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

157 
img≥l
 
l0_¥ed
[
MB_PIXELS
];

158 
img≥l
 
l1_¥ed
[
MB_PIXELS
];

160 
pic_›ix_x
 = ((
cuºMB
->
pix_x
 + 
block_x
) << 2);

161 
pic_›ix_y
 = ((
cuºMB
->
›ix_y
 + 
block_y
) << 2);

162 
bx
 = 
block_x
 >> 2;

163 
by
 = 
block_y
 >> 2;

164 
MŸi⁄Ve˘‹
 ***** 
mv_¨øy
 = 
cuºSli˚
->
Æl_mv
;

165 
MŸi⁄Ve˘‹
 *
cuº_mv
 = 
NULL
;

166 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_pred[0];

168 
≠∂y_weights
 = ( (
cuºSli˚
->
weighãd_¥edi˘i⁄
 =1Ë|| (cuºSli˚->weighãd_¥edi˘i⁄ =2 && 
p_dú
 == 2) );

170 i‡(
bùªd_me
 && 
ªf_idx
[0] =0 &&Ñef_idx[1] =0 && 
p_dú
 =2 && 
	`is_bùªd_íabÀd
(
p_Vid
, 
li°_mode
[0]) && is_bipred_enabled(p_Vid,Üist_mode[1]))

171 
mv_¨øy
 = 
cuºSli˚
->
bùªd_mv
[
bùªd_me
 - 1];

173 
p_dú
)

176 
cuº_mv
 = &
mv_¨øy
[
LIST_0
][(Ë
ªf_idx
[LIST_0]][
li°_mode
[LIST_0]][
by
][
bx
];

177 
	`O√Comp⁄ítLumaPªdi˘i⁄
 (
p_Vid
, 
l0_¥ed
, 
pic_›ix_x
 + 
cuº_mv
->
mv_x
, 
pic_›ix_y
 + cuº_mv->
mv_y
, 
block_size_x
, 
block_size_y
, 
cuºSli˚
->
li°X
[
LIST_0
 + 
cuºMB
->
li°_off£t
][(Ë
ªf_idx
[LIST_0]]);

180 
cuº_mv
 = &
mv_¨øy
[
LIST_1
][(Ë
ªf_idx
[LIST_1]][
li°_mode
[LIST_1]][
by
][
bx
];

181 
	`O√Comp⁄ítLumaPªdi˘i⁄
 (
p_Vid
, 
l1_¥ed
, 
pic_›ix_x
 + 
cuº_mv
->
mv_x
, 
pic_›ix_y
 + cuº_mv->
mv_y
, 
block_size_x
, 
block_size_y
, 
cuºSli˚
->
li°X
[
LIST_1
 + 
cuºMB
->
li°_off£t
][()
ªf_idx
[LIST_1]]);

184 
cuº_mv
 = &
mv_¨øy
[
LIST_0
][(Ë
ªf_idx
[LIST_0]][
li°_mode
[LIST_0]][
by
][
bx
];

185 
	`O√Comp⁄ítLumaPªdi˘i⁄
 (
p_Vid
, 
l0_¥ed
, 
pic_›ix_x
 + 
cuº_mv
->
mv_x
, 
pic_›ix_y
 + cuº_mv->
mv_y
, 
block_size_x
, 
block_size_y
, 
cuºSli˚
->
li°X
[
LIST_0
 + 
cuºMB
->
li°_off£t
][()
ªf_idx
[LIST_0]]);

186 
cuº_mv
 = &
mv_¨øy
[
LIST_1
][(Ë
ªf_idx
[LIST_1]][
li°_mode
[LIST_1]][
by
][
bx
];

187 
	`O√Comp⁄ítLumaPªdi˘i⁄
 (
p_Vid
, 
l1_¥ed
, 
pic_›ix_x
 + 
cuº_mv
->
mv_x
, 
pic_›ix_y
 + cuº_mv->
mv_y
, 
block_size_x
, 
block_size_y
, 
cuºSli˚
->
li°X
[
LIST_1
 + 
cuºMB
->
li°_off£t
][()
ªf_idx
[LIST_1]]);

193 i‡(
≠∂y_weights
)

195 i‡(
p_dú
==2)

197 
	`weighãd_bi_¥edi˘i⁄
(&
mb_¥ed
[
block_y
], 
l0_¥ed
, 
l1_¥ed
, 
block_size_y
, 
block_x
, 
block_size_x
,

198 
p_Vid
->
max_img≥l_vÆue
,

199 
cuºSli˚
->
wbp_weight
[0][()
ªf_idx
[0]][()ref_idx[1]][0], currSlice->wbp_weight[1][()ref_idx[0]][()ref_idx[1]][0],

200 (
cuºSli˚
->
wp_off£t
[0][()
ªf_idx
[0]][0] + currSlice->wp_offset[1][()ref_idx[1]][0] + 1)>>1,

201 (
cuºSli˚
->
wp_luma_round
 << 1), cuºSli˚->
luma_log_weight_díom
 + 1);

203 i‡(
p_dú
==0)

205 
	`weighãd_mc_¥edi˘i⁄
(&
mb_¥ed
[
block_y
], 
l0_¥ed
, 
block_size_y
, 
block_x
, 
block_size_x
,

206 
p_Vid
->
max_img≥l_vÆue
,

207 
cuºSli˚
->
wp_weight
[0][()
ªf_idx
[0]][0], cuºSli˚->
wp_off£t
[0][(Ïef_idx[0]][0], cuºSli˚->
wp_luma_round
, cuºSli˚->
luma_log_weight_díom
);

211 
	`weighãd_mc_¥edi˘i⁄
(&
mb_¥ed
[
block_y
], 
l1_¥ed
, 
block_size_y
, 
block_x
, 
block_size_x
,

212 
p_Vid
->
max_img≥l_vÆue
,

213 
cuºSli˚
->
wp_weight
[1][()
ªf_idx
[1]][0], cuºSli˚->
wp_off£t
[1][(Ïef_idx[1]][0], cuºSli˚->
wp_luma_round
, cuºSli˚->
luma_log_weight_díom
);

218 i‡(
p_dú
==2)

220 
	`bi_¥edi˘i⁄
(&
mb_¥ed
[
block_y
], 
l0_¥ed
, 
l1_¥ed
, 
block_size_y
, 
block_x
, 
block_size_x
);

222 i‡(
p_dú
==0)

224 
	`mc_¥edi˘i⁄
(&
mb_¥ed
[
block_y
], 
l0_¥ed
, 
block_size_y
, 
block_x
, 
block_size_x
);

228 
	`mc_¥edi˘i⁄
(&
mb_¥ed
[
block_y
], 
l1_¥ed
, 
block_size_y
, 
block_x
, 
block_size_x
);

231 
	}
}

239 
	$luma_¥edi˘i⁄_bi
 (
Ma¸oblock
* 
cuºMB
,

240 
block_x
,

241 
block_y
,

242 
block_size_x
,

243 
block_size_y
,

244 
l0_mode
,

245 
l1_mode
,

246 
l0_ªf_idx
,

247 
l1_ªf_idx
,

248 
li°


251 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

252 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

254 
img≥l
 
l0_¥ed
[
MB_PIXELS
];

255 
img≥l
 
l1_¥ed
[
MB_PIXELS
];

256 
pic_›ix_x
 = ((
cuºMB
->
pix_x
 + 
block_x
) << 2);

257 
pic_›ix_y
 = ((
cuºMB
->
›ix_y
 + 
block_y
) << 2);

258 
bx
 = 
block_x
 >> 2;

259 
by
 = 
block_y
 >> 2;

261 
≠∂y_weights
 = ( 
cuºSli˚
->
weighãd_¥edi˘i⁄
 != 0 );

263 
MŸi⁄Ve˘‹
 *****
mv_¨øy
 = 
cuºSli˚
->
bùªd_mv
[
li°
];

264 
MŸi⁄Ve˘‹
 *
mv_¨øyl0
 = &
mv_¨øy
[
LIST_0
][
l0_ªf_idx
][
l0_mode
][
by
][
bx
];

265 
MŸi⁄Ve˘‹
 *
mv_¨øyl1
 = &
mv_¨øy
[
LIST_1
][
l1_ªf_idx
][
l1_mode
][
by
][
bx
];

266 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_pred[0];

268 
	`O√Comp⁄ítLumaPªdi˘i⁄
 (
p_Vid
, 
l0_¥ed
, 
pic_›ix_x
 + 
mv_¨øyl0
->
mv_x
, 
pic_›ix_y
 + mv_¨øyl0->
mv_y
, 
block_size_x
, 
block_size_y
, 
cuºSli˚
->
li°X
[0+
cuºMB
->
li°_off£t
][
l0_ªf_idx
]);

269 
	`O√Comp⁄ítLumaPªdi˘i⁄
 (
p_Vid
, 
l1_¥ed
, 
pic_›ix_x
 + 
mv_¨øyl1
->
mv_x
, 
pic_›ix_y
 + mv_¨øyl1->
mv_y
, 
block_size_x
, 
block_size_y
, 
cuºSli˚
->
li°X
[1+
cuºMB
->
li°_off£t
][
l1_ªf_idx
]);

271 i‡(
≠∂y_weights
)

273 
	`weighãd_bi_¥edi˘i⁄
(&
mb_¥ed
[
block_y
], 
l0_¥ed
, 
l1_¥ed
, 
block_size_y
, 
block_x
, 
block_size_x
,

274 
p_Vid
->
max_img≥l_vÆue
,

275 
cuºSli˚
->
wbp_weight
[0][
l0_ªf_idx
][
l1_ªf_idx
][0], currSlice->wbp_weight[1][l0_ref_idx][l1_ref_idx][0],

276 (
cuºSli˚
->
wp_off£t
[0][
l0_ªf_idx
][0] + cuºSli˚->wp_off£t[1][
l1_ªf_idx
][0] + 1)>>1,

277 (
cuºSli˚
->
wp_luma_round
 << 1), cuºSli˚->
luma_log_weight_díom
 + 1);

281 
	`bi_¥edi˘i⁄
(&
mb_¥ed
[
block_y
], 
l0_¥ed
, 
l1_¥ed
, 
block_size_y
, 
block_x
, 
block_size_x
);

283 
	}
}

292 
	$O√Comp⁄ítChromaPªdi˘i⁄4x4_ªgíî©e
 (

293 
Ma¸oblock
 *
cuºMB
,

294 
img≥l
* 
m¥ed
,

295 
block_c_x
,

296 
block_c_y
,

297 
MŸi⁄Ve˘‹
 **
mv
,

298 
St‹abÀPi˘uª
 *
li°
,

299 
uv
)

301 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

302 
i
, 
j
, 
ii
, 
jj
, 
ii0
, 
jj0
, 
ii1
, 
jj1
, 
if0
, 
if1
, 
jf0
, 
jf1
;

303 
MŸi⁄Ve˘‹
 *
mvb
;

305 
f1_x
 = 64/
p_Vid
->
mb_¸_size_x
;

306 
f2_x
=
f1_x
-1;

308 
f1_y
 = 64/
p_Vid
->
mb_¸_size_y
;

309 
f2_y
=
f1_y
-1;

311 
f3
=
f1_x
*
f1_y
, 
f4
=f3>>1;

312 
li°_off£t
 = 
p_Vid
->
mb_d©a
[
cuºMB
->
mbAddrX
].list_offset;

313 
max_y_¸
 = (Ë(
li°_off£t
 ? (
p_Vid
->
height_¸
 >> 1) - 1 :Ö_Vid->height_cr - 1);

314 
max_x_¸
 = (Ë(
p_Vid
->
width_¸
 - 1);

315 
jjx
, 
iix
;

316 
mb_¸_y_div4
 = 
p_Vid
->
mb_¸_size_y
>>2;

317 
mb_¸_x_div4
 = 
p_Vid
->
mb_¸_size_x
>>2;

318 
jpos
;

320 
img≥l
** 
ªfimage
 = 
li°
->
imgUV
[
uv
];

322 
j
=
block_c_y
; j < block_c_y + 
BLOCK_SIZE
; j++)

324 
jjx
 = 
j
/
mb_¸_y_div4
;

325 
jpos
 = (
j
 + 
cuºMB
->
›ix_c_y
)*
f1_y
;

327 
i
=
block_c_x
; i < block_c_x + 
BLOCK_SIZE
; i++)

329 
iix
 = 
i
/
mb_¸_x_div4
;

330 
mvb
 = &
mv
 [
jjx
][
iix
];

332 
ii
 = (
i
 + 
cuºMB
->
pix_c_x
)*
f1_x
 + 
mvb
->
mv_x
;

333 
jj
 = 
jpos
 + 
mvb
->
mv_y
;

335 i‡(
p_Vid
->
a˘ive_•s
->
chroma_f‹m©_idc
 == 1)

336 
jj
 +
li°
->
chroma_ve˘‹_adju°mít
;

338 
ii0
 = 
	`iClù3
 (0, 
max_x_¸
, 
ii
/
f1_x
);

339 
jj0
 = 
	`iClù3
 (0, 
max_y_¸
, 
jj
/
f1_y
);

340 
ii1
 = 
	`iClù3
 (0, 
max_x_¸
, (
ii
+
f2_x
)/
f1_x
);

341 
jj1
 = 
	`iClù3
 (0, 
max_y_¸
, (
jj
+
f2_y
)/
f1_y
);

343 
if1
 = (
ii
&
f2_x
); 
if0
 = 
f1_x
-if1;

344 
jf1
 = (
jj
&
f2_y
); 
jf0
 = 
f1_y
-jf1;

346 *
m¥ed
++ = (
img≥l
) (

347 (
if0
 * 
jf0
 * 
ªfimage
[
jj0
][
ii0
] +

348 
if1
 * 
jf0
 * 
ªfimage
[
jj0
][
ii1
] +

349 
if0
 * 
jf1
 * 
ªfimage
[
jj1
][
ii0
] +

350 
if1
 * 
jf1
 * 
ªfimage
[
jj1
][
ii1
] + 
f4
Ë/ 
f3
);

353 
	}
}

361 
	$O√Comp⁄ítChromaPªdi˘i⁄4x4_ªåõve
 (

362 
Ma¸oblock
 *
cuºMB
,

363 
img≥l
* 
m¥ed
,

364 
block_c_x
,

365 
block_c_y
,

366 
MŸi⁄Ve˘‹
 **
mv
,

367 
St‹abÀPi˘uª
 *
li°
,

368 
uv
)

370 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

371 
j
, 
ii
, 
jj
;

372 
MŸi⁄Ve˘‹
* 
mvb
;

374 
jjx
;

375 
right_shi·_x
 = 4 - 
p_Vid
->
chroma_shi·_x
;

376 
right_shi·_y
 = 4 - 
p_Vid
->
chroma_shi·_y
;

377 
jpos
;

379 
pos_x1
 = 
block_c_x
 >> 
right_shi·_x
;

380 
pos_x2
 = (
block_c_x
 + 2Ë>> 
right_shi·_x
;

382 
ùos1
 = ((
block_c_x
 + 
cuºMB
->
pix_c_x
 ) << 
p_Vid
->
chroma_shi·_x
);

383 
ùos2
 = ((
block_c_x
 + 
cuºMB
->
pix_c_x
 + 2Ë<< 
p_Vid
->
chroma_shi·_x
);

384 
jj_chroma
 = ((
p_Vid
->
a˘ive_•s
->
chroma_f‹m©_idc
 =1Ë? 
li°
->
chroma_ve˘‹_adju°mít
 : 0);

386 
img≥l
 *
löe_±r
 = 
NULL
;

388 
j
=
block_c_y
; j < block_c_y + 
BLOCK_SIZE
; j++)

390 
jjx
 = 
j
 >> 
right_shi·_y
;

392 
jpos
 = ( (
j
 + 
cuºMB
->
›ix_c_y
Ë<< 
p_Vid
->
chroma_shi·_y
 ) + 
jj_chroma
;

394 
mvb
 = &
mv
 [
jjx
][
pos_x1
];

396 
ii
 = 
ùos1
 + 
mvb
->
mv_x
;

397 
jj
 = 
jpos
 + 
mvb
->
mv_y
;

399 
löe_±r
 = 
	`UMVLöe8X_chroma
 ( 
li°
, 
uv
 + 1, 
jj
, 
ii
);

400 *
m¥ed
++ = *
löe_±r
++;

401 *
m¥ed
++ = *
löe_±r
;

403 
mvb
 = &
mv
 [
jjx
][
pos_x2
];

405 
ii
 = 
ùos2
 + 
mvb
->
mv_x
;

406 
jj
 = 
jpos
 + 
mvb
->
mv_y
;

408 
löe_±r
 = 
	`UMVLöe8X_chroma
 ( 
li°
, 
uv
 + 1, 
jj
, 
ii
);

409 *
m¥ed
++ = *
löe_±r
++;

410 *
m¥ed
++ = *
löe_±r
;

412 
	}
}

421 
ölöe


422 
	$O√Comp⁄ítChromaPªdi˘i⁄
 (
VideoP¨amëîs
 *
p_Vid
,

423 
img≥l
* 
m¥ed
,

424 
pic_pix_x
,

425 
pic_pix_y
,

426 
block_size_x
,

427 
block_size_y
,

428 
St‹abÀPi˘uª
 *
li°
,

429 
uv
)

431 
j
;

432 
img≥l
 *
ªf_löe
 = 
	`UMVLöe4X¸
 (
li°
, 
uv
 + 1, 
pic_pix_y
, 
pic_pix_x
);

434 
j
 = 0; j < 
block_size_y
; j++)

436 
	`mem˝y
(
m¥ed
, 
ªf_löe
, 
block_size_x
 * (
img≥l
));

437 
ªf_löe
 +
p_Vid
->
¸_∑dded_size_x
;

438 
m¥ed
 +
block_size_x
;

440 
	}
}

448 
	$I¡øChromaPªdi˘i⁄4x4
 (
Ma¸oblock
* 
cuºMB
,

449 
uv
,

450 
block_x
,

451 
block_y
)

453 
j
;

454 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

455 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_¥ed[ 
uv
 ];

456 
img≥l
 **
cuº_m¥_16x16
 = 
cuºSli˚
->
m¥_16x16
[
uv
][ (Ë
cuºMB
->
c_ùªd_mode
];

459 
j
=
block_y
; j<block_y + 
BLOCK_SIZE
; j++)

460 
	`mem˝y
(&
mb_¥ed
[
j
][
block_x
],&
cuº_m¥_16x16
[j][block_x], 
BLOCK_SIZE
 * (
img≥l
));

461 
	}
}

469 
	$chroma_¥edi˘i⁄
 (
Ma¸oblock
* 
cuºMB
,

470 
uv
,

471 
block_x
,

472 
block_y
,

473 
block_size_x
,

474 
block_size_y
,

475 
p_dú
,

476 
l0_mode
,

477 
l1_mode
,

478 
l0_ªf_idx
,

479 
l1_ªf_idx
,

480 
bùªd_me


483 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

484 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

486 
img≥l
 
l0_¥ed
[
MB_PIXELS
];

487 
img≥l
 
l1_¥ed
[
MB_PIXELS
];

489 
pic_›ix_x
 = ((
cuºMB
->
pix_c_x
 + 
block_x
) << 2);

490 
pic_›ix_y
 = ((
cuºMB
->
›ix_c_y
 + 
block_y
) << 2);

492 
bx
 = 
block_x
 >> 2;

493 
by
 = 
block_y
 >> 2;

494 
MŸi⁄Ve˘‹
 ***** 
mv_¨øy
 = 
cuºSli˚
->
Æl_mv
;

495 
uv_comp
 = 
uv
 + 1;

496 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_¥ed[ 
uv_comp
];

498 
≠∂y_weights
 = ( (
cuºSli˚
->
weighãd_¥edi˘i⁄
 =1Ë|| (cuºSli˚->weighãd_¥edi˘i⁄ =2 && 
p_dú
 == 2) );

500 i‡(
bùªd_me
 && 
l0_ªf_idx
 =0 && 
l1_ªf_idx
 =0 && 
p_dú
 =2 && 
	`is_bùªd_íabÀd
(
p_Vid
, 
l0_mode
Ë&& is_bùªd_íabÀd’_Vid, 
l1_mode
))

501 
mv_¨øy
 = 
cuºSli˚
->
bùªd_mv
[
bùªd_me
 - 1];

504 
p_dú
)

507 
	`O√Comp⁄ítChromaPªdi˘i⁄
 (
p_Vid
, 
l0_¥ed
, 
pic_›ix_x
 + 
mv_¨øy
[
LIST_0
][
l0_ªf_idx
][
l0_mode
][
by
][
bx
].
mv_x
, 
pic_›ix_y
 + mv_¨øy[LIST_0][l0_ªf_idx][l0_mode][by][bx].
mv_y
, 
block_size_x
, 
block_size_y
, 
cuºSli˚
->
li°X
[0+
cuºMB
->
li°_off£t
][l0_ªf_idx], 
uv
);

510 
	`O√Comp⁄ítChromaPªdi˘i⁄
 (
p_Vid
, 
l1_¥ed
, 
pic_›ix_x
 + 
mv_¨øy
[
LIST_1
][
l1_ªf_idx
][
l1_mode
][
by
][
bx
].
mv_x
, 
pic_›ix_y
 + mv_¨øy[LIST_1][l1_ªf_idx][l1_mode][by][bx].
mv_y
, 
block_size_x
, 
block_size_y
, 
cuºSli˚
->
li°X
[1+
cuºMB
->
li°_off£t
][l1_ªf_idx], 
uv
);

513 
	`O√Comp⁄ítChromaPªdi˘i⁄
 (
p_Vid
, 
l0_¥ed
, 
pic_›ix_x
 + 
mv_¨øy
[
LIST_0
][
l0_ªf_idx
][
l0_mode
][
by
][
bx
].
mv_x
, 
pic_›ix_y
 + mv_¨øy[LIST_0][l0_ªf_idx][l0_mode][by][bx].
mv_y
, 
block_size_x
, 
block_size_y
, 
cuºSli˚
->
li°X
[0+
cuºMB
->
li°_off£t
][l0_ªf_idx], 
uv
);

514 
	`O√Comp⁄ítChromaPªdi˘i⁄
 (
p_Vid
, 
l1_¥ed
, 
pic_›ix_x
 + 
mv_¨øy
[
LIST_1
][
l1_ªf_idx
][
l1_mode
][
by
][
bx
].
mv_x
, 
pic_›ix_y
 + mv_¨øy[LIST_1][l1_ªf_idx][l1_mode][by][bx].
mv_y
, 
block_size_x
, 
block_size_y
, 
cuºSli˚
->
li°X
[1+
cuºMB
->
li°_off£t
][l1_ªf_idx], 
uv
);

520 i‡(
≠∂y_weights
)

522 i‡(
p_dú
==2)

524 
	`weighãd_bi_¥edi˘i⁄
(&
mb_¥ed
[
block_y
], 
l0_¥ed
, 
l1_¥ed
, 
block_size_y
, 
block_x
, 
block_size_x
,

525 
p_Vid
->
max_≥l_vÆue_comp
[1],

526 
cuºSli˚
->
wbp_weight
[0][
l0_ªf_idx
][
l1_ªf_idx
][
uv_comp
], currSlice->wbp_weight[1][l0_ref_idx][l1_ref_idx][uv_comp],

527 (
cuºSli˚
->
wp_off£t
[0][
l0_ªf_idx
][
uv_comp
] + cuºSli˚->wp_off£t[1][
l1_ªf_idx
][uv_comp] + 1)>>1,

528 (
cuºSli˚
->
wp_chroma_round
 << 1), cuºSli˚->
chroma_log_weight_díom
 + 1);

530 i‡(
p_dú
==0)

532 
	`weighãd_mc_¥edi˘i⁄
(&
mb_¥ed
[
block_y
], 
l0_¥ed
, 
block_size_y
, 
block_x
, 
block_size_x
,

533 
p_Vid
->
max_≥l_vÆue_comp
[1],

534 
cuºSli˚
->
wp_weight
[0][
l0_ªf_idx
][
uv_comp
], cuºSli˚->
wp_off£t
[0][l0_ªf_idx][uv_comp], cuºSli˚->
wp_chroma_round
, cuºSli˚->
chroma_log_weight_díom
 );

538 
	`weighãd_mc_¥edi˘i⁄
(&
mb_¥ed
[
block_y
], 
l1_¥ed
, 
block_size_y
, 
block_x
, 
block_size_x
,

539 
p_Vid
->
max_≥l_vÆue_comp
[1],

540 
cuºSli˚
->
wp_weight
[1][
l1_ªf_idx
][
uv_comp
], cuºSli˚->
wp_off£t
[1][l1_ªf_idx][uv_comp], cuºSli˚->
wp_chroma_round
, cuºSli˚->
chroma_log_weight_díom
 );

545 i‡(
p_dú
==2)

547 
	`bi_¥edi˘i⁄
(&
mb_¥ed
[
block_y
], 
l0_¥ed
, 
l1_¥ed
, 
block_size_y
, 
block_x
, 
block_size_x
);

549 i‡(
p_dú
==0)

551 
	`mc_¥edi˘i⁄
(&
mb_¥ed
[
block_y
], 
l0_¥ed
, 
block_size_y
, 
block_x
, 
block_size_x
);

555 
	`mc_¥edi˘i⁄
(&
mb_¥ed
[
block_y
], 
l1_¥ed
, 
block_size_y
, 
block_x
, 
block_size_x
);

558 
	}
}

568 
	$chroma_¥edi˘i⁄_4x4
 (
Ma¸oblock
* 
cuºMB
,

569 
uv
,

570 
block_x
,

571 
block_y
,

572 
p_dú
,

573 
l0_mode
,

574 
l1_mode
,

575 
l0_ªf_idx
,

576 
l1_ªf_idx
,

577 
bùªd_me


580 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

581 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

583 
img≥l
 
l0_¥ed
[
MB_PIXELS
];

584 
img≥l
 
l1_¥ed
[
MB_PIXELS
];

586 
MŸi⁄Ve˘‹
 ***** 
mv_¨øy
 = 
cuºSli˚
->
Æl_mv
;

587 
uv_comp
 = 
uv
 + 1;

588 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_¥ed[
uv_comp
];

589 
li°_off£t
 = 
cuºMB
->list_offset;

591 
≠∂y_weights
 = ( (
cuºSli˚
->
weighãd_¥edi˘i⁄
 =1Ë|| (cuºSli˚->weighãd_¥edi˘i⁄ =2 && 
p_dú
 == 2) );

593 i‡(
bùªd_me
 && 
l0_ªf_idx
 =0 && 
l1_ªf_idx
 =0 && 
p_dú
 =2 && 
	`is_bùªd_íabÀd
(
p_Vid
, 
l0_mode
Ë&& is_bùªd_íabÀd’_Vid, 
l1_mode
) )

594 
mv_¨øy
 = 
cuºSli˚
->
bùªd_mv
[
bùªd_me
 - 1];

597 
p_dú
)

600 
p_Vid
->
	`O√Comp⁄ítChromaPªdi˘i⁄4x4
 (
cuºMB
, 
l0_¥ed
, 
block_x
, 
block_y
, 
mv_¨øy
[
LIST_0
][
l0_ªf_idx
][
l0_mode
], 
cuºSli˚
->
li°X
[LIST_0 + 
li°_off£t
][l0_ªf_idx], 
uv
);

603 
p_Vid
->
	`O√Comp⁄ítChromaPªdi˘i⁄4x4
 (
cuºMB
, 
l1_¥ed
, 
block_x
, 
block_y
, 
mv_¨øy
[
LIST_1
][
l1_ªf_idx
][
l1_mode
], 
cuºSli˚
->
li°X
[LIST_1 + 
li°_off£t
][l1_ªf_idx], 
uv
);

606 
p_Vid
->
	`O√Comp⁄ítChromaPªdi˘i⁄4x4
 (
cuºMB
, 
l0_¥ed
, 
block_x
, 
block_y
, 
mv_¨øy
[
LIST_0
][
l0_ªf_idx
][
l0_mode
], 
cuºSli˚
->
li°X
[LIST_0 + 
li°_off£t
][l0_ªf_idx], 
uv
);

607 
p_Vid
->
	`O√Comp⁄ítChromaPªdi˘i⁄4x4
 (
cuºMB
, 
l1_¥ed
, 
block_x
, 
block_y
, 
mv_¨øy
[
LIST_1
][
l1_ªf_idx
][
l1_mode
], 
cuºSli˚
->
li°X
[LIST_1 + 
li°_off£t
][l1_ªf_idx], 
uv
);

613 i‡(
≠∂y_weights
)

615 i‡(
p_dú
==2)

617 
	`weighãd_bi_¥edi˘i⁄
(&
mb_¥ed
[
block_y
], 
l0_¥ed
, 
l1_¥ed
, 
BLOCK_SIZE
, 
block_x
, BLOCK_SIZE,

618 
p_Vid
->
max_≥l_vÆue_comp
[1],

619 
cuºSli˚
->
wbp_weight
[0][
l0_ªf_idx
][
l1_ªf_idx
][
uv_comp
], currSlice->wbp_weight[1][l0_ref_idx][l1_ref_idx][uv_comp],

620 (
cuºSli˚
->
wp_off£t
[0][
l0_ªf_idx
][
uv_comp
] + cuºSli˚->wp_off£t[1][
l1_ªf_idx
][uv_comp] + 1)>>1,

621 (
cuºSli˚
->
wp_chroma_round
 << 1), cuºSli˚->
chroma_log_weight_díom
 + 1);

624 i‡(
p_dú
==0)

626 
	`weighãd_mc_¥edi˘i⁄
(&
mb_¥ed
[
block_y
], 
l0_¥ed
, 
BLOCK_SIZE
, 
block_x
, BLOCK_SIZE,

627 
p_Vid
->
max_≥l_vÆue_comp
[1],

628 
cuºSli˚
->
wp_weight
[0][
l0_ªf_idx
][
uv_comp
], cuºSli˚->
wp_off£t
[0][l0_ªf_idx][uv_comp], cuºSli˚->
wp_chroma_round
, cuºSli˚->
chroma_log_weight_díom
 );

632 
	`weighãd_mc_¥edi˘i⁄
(&
mb_¥ed
[
block_y
], 
l1_¥ed
, 
BLOCK_SIZE
, 
block_x
, BLOCK_SIZE,

633 
p_Vid
->
max_≥l_vÆue_comp
[1],

634 
cuºSli˚
->
wp_weight
[1][
l1_ªf_idx
][
uv_comp
], cuºSli˚->
wp_off£t
[1][l1_ªf_idx][uv_comp], cuºSli˚->
wp_chroma_round
, cuºSli˚->
chroma_log_weight_díom
 );

639 i‡(
p_dú
==2)

641 
	`bi_¥edi˘i⁄
(&
mb_¥ed
[
block_y
], 
l0_¥ed
, 
l1_¥ed
, 
BLOCK_SIZE
, 
block_x
, BLOCK_SIZE);

643 i‡(
p_dú
==0)

645 
	`mc_¥edi˘i⁄
(&
mb_¥ed
[
block_y
], 
l0_¥ed
, 
BLOCK_SIZE
, 
block_x
, BLOCK_SIZE);

649 
	`mc_¥edi˘i⁄
(&
mb_¥ed
[
block_y
], 
l1_¥ed
, 
BLOCK_SIZE
, 
block_x
, BLOCK_SIZE);

652 
	}
}

	@lencod/src/mc_prediction_otf.c

15 
	~"c⁄åibut‹s.h
"

17 
	~<°dlib.h
>

18 
	~<as£π.h
>

19 
	~<limôs.h
>

20 
	~<m©h.h
>

22 
	~"globÆ.h
"

23 
	~"block.h
"

25 
	~"ma¸oblock.h
"

26 
	~"mc_¥edi˘i⁄.h
"

27 
	~"mc_¥edi˘i⁄_Ÿf.h
"

29 
	~"ªfbuf.h
"

30 
	~"image.h
"

31 
	~"mb_ac˚ss.h
"

32 
	~"me_di°‹ti⁄.h
"

33 
	~"gë_block_Ÿf.h
"

41 
	$mc_¥edi˘i⁄
(
img≥l
** 
mb_¥ed
, img≥l* 
Õªd
, 
block_size_y
, 
block_size_x
, 
ioff
)

43 
j
;

44 
j
 = 0; j < 
block_size_y
; j++)

46 
	`mem˝y
(&(
mb_¥ed
[
j
][
ioff
]), 
Õªd
, 
block_size_x
 * (
img≥l
));

47 
Õªd
 +
block_size_x
;

49 
	}
}

57 
	$weighãd_mc_¥edi˘i⁄
(
img≥l
** 
mb_¥ed
,

58 
img≥l
* 
Õªd
,

59 
block_size_y
,

60 
block_size_x
,

61 
ioff
,

62 
max_img≥l_vÆue
,

63 
wp_sˇÀ
,

64 
wp_off£t
,

65 
wp_round
,

66 
weight_díom
)

68 
i
, 
j
;

69 
ªsu…
;

70 
block_x4
 = 
ioff
 + 
block_size_x
;

72 
j
 = 0; j < 
block_size_y
; j++)

74 
i
 = 
ioff
; i < 
block_x4
; i++)

76 
ªsu…
 = 
	`rshi·_∫d
((
wp_sˇÀ
 * *
Õªd
++), 
weight_díom
Ë+ 
wp_off£t
;

77 
mb_¥ed
[
j
][
i
] = (
img≥l
Ë
	`iClù1
–
max_img≥l_vÆue
, 
ªsu…
);

80 
	}
}

88 
	$bi_¥edi˘i⁄
(
img≥l
 **
mb_¥ed
,

89 
img≥l
 *
l0¥ed
,

90 
img≥l
 *
l1¥ed
,

91 
block_size_y
,

92 
block_size_x
,

93 
ioff
)

95 
i
, 
j
;

96 
block_x4
 = 
ioff
 + 
block_size_x
;

98 
j
 = 0; j < 
block_size_y
; j++)

100 
i
=
ioff
; i<
block_x4
; i++)

101 
mb_¥ed
[
j
][
i
] = (*
l0¥ed
++ + *
l1¥ed
++ + 1) >> 1;

103 
	}
}

113 
	$weighãd_bi_¥edi˘i⁄
(
img≥l
** 
mb_¥ed
,

114 
img≥l
 *
block_l0
,

115 
img≥l
 *
block_l1
,

116 
block_size_y
,

117 
block_x
,

118 
block_size_x
,

119 
max_img≥l_vÆue
,

120 
wp_sˇÀ_l0
,

121 
wp_sˇÀ_l1
,

122 
wp_off£t
,

123 
weight_díom
)

125 
i
, 
j
, 
ªsu…
;

126 
block_x4
 = 
block_x
 + 
block_size_x
;

128 
j
 = 0; j< 
block_size_y
; j++)

130 
i
=
block_x
; i<
block_x4
; i++)

132 
ªsu…
 = 
	`rshi·_∫d_sf
((
wp_sˇÀ_l0
 * *(
block_l0
++Ë+ 
wp_sˇÀ_l1
 * *(
block_l1
++)), 
weight_díom
);

133 
mb_¥ed
[
j
][
i
] = (
img≥l
Ë
	`iClù1
–
max_img≥l_vÆue
, 
ªsu…
 + 
wp_off£t
);

136 
	}
}

145 
	$luma_¥edi˘i⁄_Ÿf
 ( 
Ma¸oblock
* 
cuºMB
,

146 
block_x
,

147 
block_y
,

148 
block_size_x
,

149 
block_size_y
,

150 
p_dú
,

151 
li°_mode
[2],

152 *
ªf_idx
,

153 
bùªd_me


156 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

157 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

158 
DecodedPi˘uªBuf„r
 *
p_Dpb
 = 
p_Vid
->
p_Dpb_œyî
[p_Vid->
dpb_œyî_id
];

159 
img≥l
 
l0_¥ed
[
MB_PIXELS
];

160 
img≥l
 
l1_¥ed
[
MB_PIXELS
];

161 
tmp_¥ed
[ (
MB_BLOCK_SIZE
+5)*(MB_BLOCK_SIZE+5) ];

163 
pic_›ix_x
 = ((
cuºMB
->
pix_x
 + 
block_x
) << 2);

164 
pic_›ix_y
 = ((
cuºMB
->
›ix_y
 + 
block_y
) << 2);

165 
bx
 = 
block_x
 >> 2;

166 
by
 = 
block_y
 >> 2;

167 
MŸi⁄Ve˘‹
 ***** 
mv_¨øy
 = 
cuºSli˚
->
Æl_mv
;

168 
MŸi⁄Ve˘‹
 *
cuº_mv
 = 
NULL
;

169 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_pred[0];

170 
≠∂y_weights
 = ( (
cuºSli˚
->
weighãd_¥edi˘i⁄
 =1Ë|| (cuºSli˚->weighãd_¥edi˘i⁄ =2 && 
p_dú
 == 2) );

172 i‡(
bùªd_me
 && 
ªf_idx
[0] =0 &&Ñef_idx[1] =0 && 
p_dú
 =2 && 
	`is_bùªd_íabÀd
(
p_Vid
, 
li°_mode
[0]) && is_bipred_enabled(p_Vid,Üist_mode[1]))

173 
mv_¨øy
 = 
cuºSli˚
->
bùªd_mv
[
bùªd_me
 - 1];

175 
p_dú
)

178 
cuº_mv
 = &
mv_¨øy
[
LIST_0
][(Ë
ªf_idx
[0]][
li°_mode
[0]][
by
][
bx
];

179 
p_Dpb
->
	`pf_gë_block_luma
 (
p_Vid
, 
l0_¥ed
, 
tmp_¥ed
, 
pic_›ix_x
 + 
cuº_mv
->
mv_x
, 
pic_›ix_y
 + cuº_mv->
mv_y
, 
block_size_x
, 
block_size_y
, 
cuºSli˚
->
li°X
[
LIST_0
 + 
cuºMB
->
li°_off£t
][(Ë
ªf_idx
[0]], 0 );

182 
cuº_mv
 = &
mv_¨øy
[
LIST_1
][(Ë
ªf_idx
[1]][
li°_mode
[1]][
by
][
bx
];

183 
p_Dpb
->
	`pf_gë_block_luma
 (
p_Vid
, 
l1_¥ed
, 
tmp_¥ed
, 
pic_›ix_x
 + 
cuº_mv
->
mv_x
, 
pic_›ix_y
 + cuº_mv->
mv_y
, 
block_size_x
, 
block_size_y
, 
cuºSli˚
->
li°X
[
LIST_1
 + 
cuºMB
->
li°_off£t
][()
ªf_idx
[1]], 0 );

186 
cuº_mv
 = &
mv_¨øy
[
LIST_0
][(Ë
ªf_idx
[0]][
li°_mode
[0]][
by
][
bx
];

187 
p_Dpb
->
	`pf_gë_block_luma
 (
p_Vid
, 
l0_¥ed
, 
tmp_¥ed
, 
pic_›ix_x
 + 
cuº_mv
->
mv_x
, 
pic_›ix_y
 + cuº_mv->
mv_y
, 
block_size_x
, 
block_size_y
, 
cuºSli˚
->
li°X
[
LIST_0
 + 
cuºMB
->
li°_off£t
][()
ªf_idx
[0]], 0);

188 
cuº_mv
 = &
mv_¨øy
[
LIST_1
][(Ë
ªf_idx
[1]][
li°_mode
[1]][
by
][
bx
];

189 
p_Dpb
->
	`pf_gë_block_luma
 (
p_Vid
, 
l1_¥ed
, 
tmp_¥ed
, 
pic_›ix_x
 + 
cuº_mv
->
mv_x
, 
pic_›ix_y
 + cuº_mv->
mv_y
, 
block_size_x
, 
block_size_y
, 
cuºSli˚
->
li°X
[
LIST_1
 + 
cuºMB
->
li°_off£t
][()
ªf_idx
[1]], 0);

195 i‡(
≠∂y_weights
)

197 i‡(
p_dú
==2)

199 
	`weighãd_bi_¥edi˘i⁄
(&
mb_¥ed
[
block_y
], 
l0_¥ed
, 
l1_¥ed
, 
block_size_y
, 
block_x
, 
block_size_x
,

200 
p_Vid
->
max_img≥l_vÆue
,

201 
cuºSli˚
->
wbp_weight
[0][()
ªf_idx
[0]][()ref_idx[1]][0], currSlice->wbp_weight[1][()ref_idx[0]][()ref_idx[1]][0],

202 (
cuºSli˚
->
wp_off£t
[0][()
ªf_idx
[0]][0] + currSlice->wp_offset[1][()ref_idx[1]][0] + 1)>>1,

203 
cuºSli˚
->
luma_log_weight_díom
 + 1);

205 i‡(
p_dú
==0)

207 
	`weighãd_mc_¥edi˘i⁄
(&
mb_¥ed
[
block_y
], 
l0_¥ed
, 
block_size_y
, 
block_size_x
, 
block_x
,

208 
p_Vid
->
max_img≥l_vÆue
,

209 
cuºSli˚
->
wp_weight
[0][()
ªf_idx
[0]][0], cuºSli˚->
wp_off£t
[0][(Ïef_idx[0]][0], cuºSli˚->
wp_luma_round
, cuºSli˚->
luma_log_weight_díom
);

213 
	`weighãd_mc_¥edi˘i⁄
(&
mb_¥ed
[
block_y
], 
l1_¥ed
, 
block_size_y
, 
block_size_x
, 
block_x
,

214 
p_Vid
->
max_img≥l_vÆue
,

215 
cuºSli˚
->
wp_weight
[1][()
ªf_idx
[1]][0], cuºSli˚->
wp_off£t
[1][(Ïef_idx[1]][0], cuºSli˚->
wp_luma_round
, cuºSli˚->
luma_log_weight_díom
);

220 i‡(
p_dú
==2)

222 
	`bi_¥edi˘i⁄
(&
mb_¥ed
[
block_y
], 
l0_¥ed
, 
l1_¥ed
, 
block_size_y
, 
block_size_x
, 
block_x
);

224 i‡(
p_dú
==0)

226 
	`mc_¥edi˘i⁄
(&
mb_¥ed
[
block_y
], 
l0_¥ed
, 
block_size_y
, 
block_size_x
, 
block_x
);

230 
	`mc_¥edi˘i⁄
(&
mb_¥ed
[
block_y
], 
l1_¥ed
, 
block_size_y
, 
block_size_x
, 
block_x
);

233 
	}
}

241 
	$luma_¥edi˘i⁄_bi_Ÿf
 ( 
Ma¸oblock
* 
cuºMB
,

242 
block_x
,

243 
block_y
,

244 
block_size_x
,

245 
block_size_y
,

246 
l0_mode
,

247 
l1_mode
,

248 
l0_ªf_idx
,

249 
l1_ªf_idx
,

250 
li°


253 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

254 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

255 
DecodedPi˘uªBuf„r
 *
p_Dpb
 = 
p_Vid
->
p_Dpb_œyî
[p_Vid->
dpb_œyî_id
];

257 
img≥l
 
l0_¥ed
[
MB_PIXELS
];

258 
img≥l
 
l1_¥ed
[
MB_PIXELS
];

260 
tmp_¥ed
[ (
MB_BLOCK_SIZE
+5)*(MB_BLOCK_SIZE+5) ];

261 
pic_›ix_x
 = ((
cuºMB
->
pix_x
 + 
block_x
) << 2);

262 
pic_›ix_y
 = ((
cuºMB
->
›ix_y
 + 
block_y
) << 2);

263 
bx
 = 
block_x
 >> 2;

264 
by
 = 
block_y
 >> 2;

266 
≠∂y_weights
 = ( 
cuºSli˚
->
weighãd_¥edi˘i⁄
 != 0 );

268 
MŸi⁄Ve˘‹
 *****
mv_¨øy
 = 
cuºSli˚
->
bùªd_mv
[
li°
];

269 
MŸi⁄Ve˘‹
 *
mv_¨øyl0
 = &
mv_¨øy
[
LIST_0
][
l0_ªf_idx
][
l0_mode
][
by
][
bx
];

270 
MŸi⁄Ve˘‹
 *
mv_¨øyl1
 = &
mv_¨øy
[
LIST_1
][
l1_ªf_idx
][
l1_mode
][
by
][
bx
];

271 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_pred[0];

273 
p_Dpb
->
	`pf_gë_block_luma
(
p_Vid
, 
l0_¥ed
, 
tmp_¥ed
, 
pic_›ix_x
 + 
mv_¨øyl0
->
mv_x
, 
pic_›ix_y
 + mv_¨øyl0->
mv_y
, 
block_size_x
, 
block_size_y
, 
cuºSli˚
->
li°X
[0+
cuºMB
->
li°_off£t
][
l0_ªf_idx
], 0);

274 
p_Dpb
->
	`pf_gë_block_luma
(
p_Vid
, 
l1_¥ed
, 
tmp_¥ed
, 
pic_›ix_x
 + 
mv_¨øyl1
->
mv_x
, 
pic_›ix_y
 + mv_¨øyl1->
mv_y
, 
block_size_x
, 
block_size_y
, 
cuºSli˚
->
li°X
[1+
cuºMB
->
li°_off£t
][
l1_ªf_idx
], 0);

276 i‡(
≠∂y_weights
)

278 
	`weighãd_bi_¥edi˘i⁄
(&
mb_¥ed
[
block_y
], 
l0_¥ed
, 
l1_¥ed
, 
block_size_y
, 
block_x
, 
block_size_x
,

279 
p_Vid
->
max_img≥l_vÆue
,

280 
cuºSli˚
->
wbp_weight
[0][
l0_ªf_idx
][
l1_ªf_idx
][0], currSlice->wbp_weight[1][l0_ref_idx][l1_ref_idx][0],

281 (
cuºSli˚
->
wp_off£t
[0][
l0_ªf_idx
][0] + cuºSli˚->wp_off£t[1][
l1_ªf_idx
][0] + 1)>>1,

282 
cuºSli˚
->
luma_log_weight_díom
 + 1);

286 
	`bi_¥edi˘i⁄
(&
mb_¥ed
[
block_y
], 
l0_¥ed
, 
l1_¥ed
, 
block_size_y
, 
block_size_x
, 
block_x
);

288 
	}
}

296 
	$chroma_¥edi˘i⁄_Ÿf
 ( 
Ma¸oblock
* 
cuºMB
,

297 
uv
,

298 
block_x
,

299 
block_y
,

300 
block_size_x
,

301 
block_size_y
,

302 
p_dú
,

303 
l0_mode
,

304 
l1_mode
,

305 
l0_ªf_idx
,

306 
l1_ªf_idx
,

307 
bùªd_me


310 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

311 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

312 
DecodedPi˘uªBuf„r
 *
p_Dpb
 = 
p_Vid
->
p_Dpb_œyî
[p_Vid->
dpb_œyî_id
];

314 
img≥l
 
l0_¥ed
[
MB_PIXELS
];

315 
img≥l
 
l1_¥ed
[
MB_PIXELS
];

316 
tmp_¥ed
[(
MB_BLOCK_SIZE
+5)*(MB_BLOCK_SIZE+5)];

318 
pic_›ix_x
 = ((
cuºMB
->
pix_c_x
 + 
block_x
) << 2);

319 
pic_›ix_y
 = ((
cuºMB
->
›ix_c_y
 + 
block_y
) << 2);

321 
bx
 = 
block_x
 >> 2;

322 
by
 = 
block_y
 >> 2;

323 
MŸi⁄Ve˘‹
 ***** 
mv_¨øy
 = 
cuºSli˚
->
Æl_mv
;

324 
uv_comp
 = 
uv
 + 1;

325 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_¥ed[ 
uv_comp
];

327 
≠∂y_weights
 = ( (
cuºSli˚
->
weighãd_¥edi˘i⁄
 =1Ë|| (cuºSli˚->weighãd_¥edi˘i⁄ =2 && 
p_dú
 == 2) );

329 i‡(
bùªd_me
 && 
l0_ªf_idx
 =0 && 
l1_ªf_idx
 =0 && 
p_dú
 =2 && 
	`is_bùªd_íabÀd
(
p_Vid
, 
l0_mode
Ë&& is_bùªd_íabÀd’_Vid, 
l1_mode
))

330 
mv_¨øy
 = 
cuºSli˚
->
bùªd_mv
[
bùªd_me
 - 1];

333 
p_dú
)

336 
p_Dpb
->
pf_gë_block_chroma
[
OTF_MC
] (
p_Vid
, 
l0_¥ed
, 
tmp_¥ed
, 
pic_›ix_x
 + 
mv_¨øy
[
LIST_0
][
l0_ªf_idx
][
l0_mode
][
by
][
bx
].
mv_x
, 
pic_›ix_y
 + mv_¨øy[LIST_0][l0_ªf_idx][l0_mode][by][bx].
mv_y
, 
block_size_x
, 
block_size_y
, 
cuºSli˚
->
li°X
[0+
cuºMB
->
li°_off£t
][l0_ªf_idx], 
uv
+1 );

339 
p_Dpb
->
pf_gë_block_chroma
[
OTF_MC
] (
p_Vid
, 
l1_¥ed
, 
tmp_¥ed
, 
pic_›ix_x
 + 
mv_¨øy
[
LIST_1
][
l1_ªf_idx
][
l1_mode
][
by
][
bx
].
mv_x
, 
pic_›ix_y
 + mv_¨øy[LIST_1][l1_ªf_idx][l1_mode][by][bx].
mv_y
, 
block_size_x
, 
block_size_y
, 
cuºSli˚
->
li°X
[1+
cuºMB
->
li°_off£t
][l1_ªf_idx], 
uv
+1 );

342 
p_Dpb
->
pf_gë_block_chroma
[
OTF_MC
] (
p_Vid
, 
l0_¥ed
, 
tmp_¥ed
, 
pic_›ix_x
 + 
mv_¨øy
[
LIST_0
][
l0_ªf_idx
][
l0_mode
][
by
][
bx
].
mv_x
, 
pic_›ix_y
 + mv_¨øy[LIST_0][l0_ªf_idx][l0_mode][by][bx].
mv_y
, 
block_size_x
, 
block_size_y
, 
cuºSli˚
->
li°X
[0+
cuºMB
->
li°_off£t
][l0_ªf_idx], 
uv
+1 );

343 
p_Dpb
->
pf_gë_block_chroma
[
OTF_MC
] (
p_Vid
, 
l1_¥ed
, 
tmp_¥ed
, 
pic_›ix_x
 + 
mv_¨øy
[
LIST_1
][
l1_ªf_idx
][
l1_mode
][
by
][
bx
].
mv_x
, 
pic_›ix_y
 + mv_¨øy[LIST_1][l1_ªf_idx][l1_mode][by][bx].
mv_y
, 
block_size_x
, 
block_size_y
, 
cuºSli˚
->
li°X
[1+
cuºMB
->
li°_off£t
][l1_ªf_idx], 
uv
+1 );

349 i‡(
≠∂y_weights
)

351 i‡(
p_dú
==2)

353 
	`weighãd_bi_¥edi˘i⁄
(&
mb_¥ed
[
block_y
], 
l0_¥ed
, 
l1_¥ed
, 
block_size_y
, 
block_x
, 
block_size_x
,

354 
p_Vid
->
max_≥l_vÆue_comp
[1],

355 
cuºSli˚
->
wbp_weight
[0][
l0_ªf_idx
][
l1_ªf_idx
][
uv_comp
], currSlice->wbp_weight[1][l0_ref_idx][l1_ref_idx][uv_comp],

356 (
cuºSli˚
->
wp_off£t
[0][
l0_ªf_idx
][
uv_comp
] + cuºSli˚->wp_off£t[1][
l1_ªf_idx
][uv_comp] + 1)>>1,

357 
cuºSli˚
->
chroma_log_weight_díom
 + 1);

359 i‡(
p_dú
==0)

361 
	`weighãd_mc_¥edi˘i⁄
(&
mb_¥ed
[
block_y
], 
l0_¥ed
, 
block_size_y
, 
block_size_x
, 
block_x
,

362 
p_Vid
->
max_≥l_vÆue_comp
[1],

363 
cuºSli˚
->
wp_weight
[0][
l0_ªf_idx
][
uv_comp
], cuºSli˚->
wp_off£t
[0][l0_ªf_idx][uv_comp], cuºSli˚->
wp_chroma_round
, cuºSli˚->
chroma_log_weight_díom
 );

367 
	`weighãd_mc_¥edi˘i⁄
(&
mb_¥ed
[
block_y
], 
l1_¥ed
, 
block_size_y
, 
block_size_x
, 
block_x
,

368 
p_Vid
->
max_≥l_vÆue_comp
[1],

369 
cuºSli˚
->
wp_weight
[1][
l1_ªf_idx
][
uv_comp
], cuºSli˚->
wp_off£t
[1][l1_ªf_idx][uv_comp], cuºSli˚->
wp_chroma_round
, cuºSli˚->
chroma_log_weight_díom
 );

374 i‡(
p_dú
==2)

376 
	`bi_¥edi˘i⁄
(&
mb_¥ed
[
block_y
], 
l0_¥ed
, 
l1_¥ed
, 
block_size_y
, 
block_size_x
, 
block_x
);

378 i‡(
p_dú
==0)

380 
	`mc_¥edi˘i⁄
(&
mb_¥ed
[
block_y
], 
l0_¥ed
, 
block_size_y
, 
block_size_x
, 
block_x
);

384 
	`mc_¥edi˘i⁄
(&
mb_¥ed
[
block_y
], 
l1_¥ed
, 
block_size_y
, 
block_size_x
, 
block_x
);

387 
	}
}

	@lencod/src/md_common.c

15 
	~<limôs.h
>

16 
	~"globÆ.h
"

17 
	~"image.h
"

18 
	~"ma¸oblock.h
"

19 
	~"mc_¥edi˘i⁄.h
"

27 
ölöe
 
	$C›yMVBlock16
(
PicMŸi⁄P¨ams
 **
mv_öfo
, 
MŸi⁄Ve˘‹
 **
rdo_mv
, 
li°
, 
block_x
, 
block_y
, 
°¨t
, 
íd
)

29 
j
, 
i
;

30 
j
 = 
°¨t
; j < 
íd
; j++)

32 
i
 = 0; i < 
BLOCK_MULTIPLE
; i++)

34 
mv_öfo
[
block_y
 + 
j
][
block_x
 + 
i
].
mv
[
li°
] = 
rdo_mv
[j][i];

37 
	}
}

45 
ölöe
 
	$Re£tMŸi⁄Block16
(
PicMŸi⁄P¨ams
 **
mv_öfo
, 
li°
, 
block_x
, 
block_y
, 
°¨t
, 
íd
)

47 
j
, 
i
;

48 
j
 = 
block_y
 + 
°¨t
; j < block_y + 
íd
; j++)

50 
i
 = 
block_x
; i < block_x + 
BLOCK_MULTIPLE
; i++)

52 
mv_öfo
[
j
][
i
].
mv
[
li°
] = 
zîo_mv
;

53 
mv_öfo
[
j
][
i
].
ªf_idx
[
li°
] = -1;

54 
mv_öfo
[
j
][
i
].
ªf_pic
[
li°
] = 
NULL
;

57 
	}
}

65 
ölöe
 
	$Re£tMVBlock16
(
PicMŸi⁄P¨ams
 **
mv_öfo
, 
li°
, 
block_x
, 
block_y
, 
°¨t
, 
íd
)

67 
j
, 
i
;

68 
j
 = 
block_y
 + 
°¨t
; j < block_y + 
íd
; j++)

70 
i
 = 
block_x
; i < block_x + 
BLOCK_MULTIPLE
; i++)

71 
mv_öfo
[
j
][
i
].
mv
[
li°
] = 
zîo_mv
;

73 
	}
}

81 
ölöe
 
	$Re£tRefBlock16
(
PicMŸi⁄P¨ams
 **
mv_öfo
, 
li°
, 
block_x
, 
block_y
, 
°¨t
, 
íd
)

83 
j
, 
i
;

84 
j
 = 
block_y
 + 
°¨t
; j < block_y + 
íd
; j++)

86 
i
 = 
block_x
; i < block_x + 
BLOCK_MULTIPLE
; ++i)

88 
mv_öfo
[
j
][
i
].
ªf_idx
[
li°
] = -1;

89 
mv_öfo
[
j
][
i
].
ªf_pic
[
li°
] = 
NULL
;

92 
	}
}

100 
ölöe
 
	$C›yMVBlock8
(
PicMŸi⁄P¨ams
 **
mv_öfo
, 
MŸi⁄Ve˘‹
 **
rdo_mv
, 
li°
, 
block_x
, 
°¨t
, 
íd
, 
off£t
)

102 
j
;

103 
j
 = 
°¨t
; j < 
íd
; j++)

105 
mv_öfo
[
j
][
block_x
 ].
mv
[
li°
] = 
rdo_mv
[j][
off£t
];

106 
mv_öfo
[
j
][
block_x
 + 1].
mv
[
li°
] = 
rdo_mv
[j][
off£t
 + 1];

108 
	}
}

116 
ölöe
 
	$Re£tMŸi⁄Block8
(
PicMŸi⁄P¨ams
 **
mv_öfo
, 
li°
, 
block_x
, 
°¨t
, 
íd
)

118 
j
;

120 
j
 = 
°¨t
; j < 
íd
; j++)

122 
mv_öfo
[
j
][
block_x
 ].
mv
[
li°
] = 
zîo_mv
;

123 
mv_öfo
[
j
][
block_x
 ].
ªf_idx
[
li°
] = -1;

124 
mv_öfo
[
j
][
block_x
 ].
ªf_pic
[
li°
] = 
NULL
;

125 
mv_öfo
[
j
][
block_x
 + 1].
mv
[
li°
] = 
zîo_mv
;

126 
mv_öfo
[
j
][
block_x
 + 1].
ªf_idx
[
li°
] = -1;

127 
mv_öfo
[
j
][
block_x
 + 1].
ªf_pic
[
li°
] = 
NULL
;

129 
	}
}

137 
ölöe
 
	$Re£tMVBlock8
(
PicMŸi⁄P¨ams
 **
mv_öfo
, 
li°
, 
block_x
, 
°¨t
, 
íd
)

139 
j
;

141 
j
 = 
°¨t
; j < 
íd
; j++)

143 
mv_öfo
[
j
][
block_x
 ].
mv
[
li°
] = 
zîo_mv
;

144 
mv_öfo
[
j
][
block_x
 + 1].
mv
[
li°
] = 
zîo_mv
;

146 
	}
}

154 
ölöe
 
	$Re£tRefBlock8
(
PicMŸi⁄P¨ams
 **
mv_öfo
, 
li°
, 
block_x
, 
°¨t
, 
íd
)

156 
j
;

157 
j
 = 
°¨t
; j < 
íd
; j++)

159 
mv_öfo
[
j
][
block_x
 ].
ªf_idx
[
li°
] = -1;

160 
mv_öfo
[
j
][
block_x
 ].
ªf_pic
[
li°
] = 
NULL
;

161 
mv_öfo
[
j
][
block_x
 + 1].
ªf_idx
[
li°
] = -1;

162 
mv_öfo
[
j
][
block_x
 + 1].
ªf_pic
[
li°
] = 
NULL
;

164 
	}
}

172 
	$SëMŸi⁄Ve˘‹sMBPSli˚
 (
Ma¸oblock
* 
cuºMB
)

174 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

175 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

176 
PicMŸi⁄P¨ams
 **
mv_öfo
 = 
p_Vid
->
íc_pi˘uª
->mv_info;

178 
RD_DATA
 *
rd›t
 = 
cuºSli˚
->
rdd©a
;

179 
MŸi⁄Ve˘‹
 ****
Æl_mv
 = 
cuºSli˚
->Æl_mv[
LIST_0
];

180 
l0_ªf
, 
mode8
;

182 i‡(
cuºSli˚
->
mb_aff_‰ame_Êag
 || (cuºSli˚->
U£RDOQu™t
 && cuºSli˚->
RDOQ_QP_Num
 > 1))

184 
	`mem˝y
(&
rd›t
->
Æl_mv
[
LIST_0
][0][0][0][0], &Æl_mv[0][0][0][0], 
p_Vid
->
max_num_ª„ªn˚s
 * 9 * 
MB_BLOCK_PARTITIONS
 * (
MŸi⁄Ve˘‹
));

187 i‡(
cuºMB
->
mb_ty≥
 =
PSKIP
)

189 
	`C›yMVBlock16
(
mv_öfo
, 
Æl_mv
[0][
PSKIP
], 
LIST_0
, 
cuºMB
->
block_x
, cuºMB->
block_y
, 0, 4);

191 i‡(
cuºMB
->
mb_ty≥
 =
P16x16
)

193 
l0_ªf
 = 
mv_öfo
[
cuºMB
->
block_y
][cuºMB->
block_x
].
ªf_idx
[
LIST_0
];

194 
	`C›yMVBlock16
(
mv_öfo
, 
Æl_mv
[
l0_ªf
][
P16x16
], 
LIST_0
, 
cuºMB
->
block_x
, cuºMB->
block_y
, 0, 4);

196 i‡(
cuºMB
->
mb_ty≥
 =
P16x8
)

198 
l0_ªf
 = 
mv_öfo
[
cuºMB
->
block_y
][cuºMB->
block_x
].
ªf_idx
[
LIST_0
];

199 
	`C›yMVBlock16
(
mv_öfo
, 
Æl_mv
[
l0_ªf
][
P16x8
], 
LIST_0
, 
cuºMB
->
block_x
, cuºMB->
block_y
, 0, 2);

201 
l0_ªf
 = 
mv_öfo
[
cuºMB
->
block_y
 + 2][cuºMB->
block_x
].
ªf_idx
[
LIST_0
];

202 
	`C›yMVBlock16
(
mv_öfo
, 
Æl_mv
[
l0_ªf
][
P16x8
], 
LIST_0
, 
cuºMB
->
block_x
, cuºMB->
block_y
, 2, 4);

204 i‡(
cuºMB
->
mb_ty≥
 =
P8x16
)

206 
l0_ªf
 = 
mv_öfo
[
cuºMB
->
block_y
][cuºMB->
block_x
].
ªf_idx
[
LIST_0
];

207 
	`C›yMVBlock8
(&
mv_öfo
[
cuºMB
->
block_y
], 
Æl_mv
[
l0_ªf
][
P8x16
], 
LIST_0
, cuºMB->
block_x
 , 0, 4, 0);

209 
l0_ªf
 = 
mv_öfo
[
cuºMB
->
block_y
][cuºMB->
block_x
 + 2].
ªf_idx
[
LIST_0
];

210 
	`C›yMVBlock8
(&
mv_öfo
[
cuºMB
->
block_y
], 
Æl_mv
[
l0_ªf
][
P8x16
], 
LIST_0
, cuºMB->
block_x
 + 2, 0, 4, 2);

212 i‡(
cuºMB
->
mb_ty≥
 =
P8x8
)

214 
mode8
 = 
cuºMB
->
b8x8
[0].
mode
;

215 
l0_ªf
 = 
mv_öfo
[
cuºMB
->
block_y
 ][cuºMB->
block_x
 ].
ªf_idx
[
LIST_0
];

216 
	`C›yMVBlock8
(&
mv_öfo
[
cuºMB
->
block_y
], 
Æl_mv
[
l0_ªf
][
mode8
], 
LIST_0
, cuºMB->
block_x
 , 0, 2, 0);

218 
mode8
 = 
cuºMB
->
b8x8
[1].
mode
;

219 
l0_ªf
 = 
mv_öfo
[
cuºMB
->
block_y
 ][cuºMB->
block_x
 + 2].
ªf_idx
[
LIST_0
];

220 
	`C›yMVBlock8
(&
mv_öfo
[
cuºMB
->
block_y
], 
Æl_mv
[
l0_ªf
][
mode8
], 
LIST_0
, cuºMB->
block_x
 + 2, 0, 2, 2);

222 
mode8
 = 
cuºMB
->
b8x8
[2].
mode
;

223 
l0_ªf
 = 
mv_öfo
[
cuºMB
->
block_y
 + 2][cuºMB->
block_x
 ].
ªf_idx
[
LIST_0
];

224 
	`C›yMVBlock8
(&
mv_öfo
[
cuºMB
->
block_y
], 
Æl_mv
[
l0_ªf
][
mode8
], 
LIST_0
, cuºMB->
block_x
, 2, 4, 0);

226 
mode8
 = 
cuºMB
->
b8x8
[3].
mode
;

227 
l0_ªf
 = 
mv_öfo
[
cuºMB
->
block_y
 + 2][cuºMB->
block_x
 + 2].
ªf_idx
[
LIST_0
];

228 
	`C›yMVBlock8
(&
mv_öfo
[
cuºMB
->
block_y
], 
Æl_mv
[
l0_ªf
][
mode8
], 
LIST_0
, cuºMB->
block_x
 + 2, 2, 4, 2);

232 
	`Re£tMŸi⁄Block16
 (
mv_öfo
, 
LIST_0
, 
cuºMB
->
block_x
, cuºMB->
block_y
, 0, 4);

234 
	}
}

242 
	$SëMVBSli˚16x8
(
Sli˚
 *
cuºSli˚
, 
PicMŸi⁄P¨ams
 **
mŸi⁄
, 
Ma¸oblock
* 
cuºMB
, 
pos
)

244 
l0_ªf
, 
l1_ªf
;

245 
pdú
 = 
cuºMB
->
b8x8
[
pos
].pdir;

246 i‡(
pdú
 =
LIST_0
)

248 
l0_ªf
 = 
mŸi⁄
[
cuºMB
->
block_y
 + 
pos
][cuºMB->
block_x
].
ªf_idx
[
LIST_0
];

249 
	`C›yMVBlock16
(
mŸi⁄
, 
cuºSli˚
->
Æl_mv
 [
LIST_0
][
l0_ªf
][
P16x8
], LIST_0, 
cuºMB
->
block_x
, cuºMB->
block_y
, 
pos
,Öos + 2);

250 
	`Re£tMŸi⁄Block16
 (
mŸi⁄
, 
LIST_1
, 
cuºMB
->
block_x
, cuºMB->
block_y
, 
pos
,Öos + 2);

252 i‡(
pdú
 =
LIST_1
)

254 
	`Re£tMŸi⁄Block16
 (
mŸi⁄
, 
LIST_0
, 
cuºMB
->
block_x
, cuºMB->
block_y
, 
pos
,Öos + 2);

255 
l1_ªf
 = 
mŸi⁄
[
cuºMB
->
block_y
 + 
pos
][cuºMB->
block_x
].
ªf_idx
[
LIST_1
];

256 
	`C›yMVBlock16
 (
mŸi⁄
, 
cuºSli˚
->
Æl_mv
 [
LIST_1
][
l1_ªf
][
P16x8
], LIST_1, 
cuºMB
->
block_x
, cuºMB->
block_y
, 
pos
,Öos + 2);

260 
bùªd_me
 = 
cuºMB
->
b8x8
[
pos
].
bùªd
;

261 
MŸi⁄Ve˘‹
 *****
Æl_mv
 = 
bùªd_me
 ? 
cuºSli˚
->
bùªd_mv
[bipred_me - 1]: currSlice->all_mv;

262 
l0_ªf
 = 
mŸi⁄
[
cuºMB
->
block_y
 + 
pos
][cuºMB->
block_x
].
ªf_idx
[
LIST_0
];

263 
	`C›yMVBlock16
 (
mŸi⁄
, 
Æl_mv
 [
LIST_0
][
l0_ªf
][
P16x8
], LIST_0, 
cuºMB
->
block_x
, cuºMB->
block_y
, 
pos
,Öos + 2);

265 
l1_ªf
 = 
mŸi⁄
[
cuºMB
->
block_y
 + 
pos
][cuºMB->
block_x
].
ªf_idx
[
LIST_1
];

266 
	`C›yMVBlock16
 (
mŸi⁄
, 
Æl_mv
 [
LIST_1
][
l1_ªf
][
P16x8
], LIST_1, 
cuºMB
->
block_x
, cuºMB->
block_y
, 
pos
,Öos + 2);

268 i‡(
bùªd_me
 && (
cuºSli˚
->
mb_aff_‰ame_Êag
 || (cuºSli˚->
U£RDOQu™t
 && cuºSli˚->
RDOQ_QP_Num
 > 1)))

270 
	`mem˝y
(
cuºSli˚
->
rdd©a
->
Æl_mv
 [
LIST_0
][
l0_ªf
][
P16x8
][
pos
],áŒ_mv [LIST_0][l0_ªf][P16x8][pos], 2 * 
BLOCK_MULTIPLE
 * (
MŸi⁄Ve˘‹
));

271 
	`mem˝y
(
cuºSli˚
->
rdd©a
->
Æl_mv
 [
LIST_1
][
l1_ªf
][
P16x8
][
pos
],áŒ_mv [LIST_1][l1_ªf][P16x8][pos], 2 * 
BLOCK_MULTIPLE
 * (
MŸi⁄Ve˘‹
));

274 
	}
}

282 
	$SëMVBSli˚8x16
(
Sli˚
 *
cuºSli˚
, 
PicMŸi⁄P¨ams
 **
mŸi⁄
, 
Ma¸oblock
* 
cuºMB
, 
pos
)

284 
l0_ªf
, 
l1_ªf
;

285 
pdú
 = 
cuºMB
->
b8x8
[
pos
 >> 1].pdir;

286 i‡(
pdú
 =
LIST_0
)

288 
l0_ªf
 = 
mŸi⁄
[
cuºMB
->
block_y
][cuºMB->
block_x
 + 
pos
].
ªf_idx
[
LIST_0
];

289 
	`C›yMVBlock8
 (&
mŸi⁄
[
cuºMB
->
block_y
], 
cuºSli˚
->
Æl_mv
 [
LIST_0
][
l0_ªf
][
P8x16
], LIST_0, cuºMB->
block_x
 + 
pos
, 0, 4,Öos);

290 
	`Re£tMŸi⁄Block8
(&
mŸi⁄
[
cuºMB
->
block_y
], 
LIST_1
, cuºMB->
block_x
 + 
pos
, 0, 4);

292 i‡(
pdú
 =
LIST_1
)

294 
	`Re£tMŸi⁄Block8
(&
mŸi⁄
[
cuºMB
->
block_y
], 
LIST_0
, cuºMB->
block_x
 + 
pos
, 0, 4);

295 
l1_ªf
 = 
mŸi⁄
[
cuºMB
->
block_y
][cuºMB->
block_x
 + 
pos
].
ªf_idx
[
LIST_1
];

296 
	`C›yMVBlock8
 (&
mŸi⁄
[
cuºMB
->
block_y
], 
cuºSli˚
->
Æl_mv
 [
LIST_1
][
l1_ªf
][
P8x16
], LIST_1, cuºMB->
block_x
 + 
pos
, 0, 4,Öos);

300 
bùªd_me
 = 
cuºMB
->
b8x8
[
pos
 >> 1].
bùªd
;

301 
MŸi⁄Ve˘‹
 *****
Æl_mv
 = 
bùªd_me
 ? 
cuºSli˚
->
bùªd_mv
[bipred_me - 1]: currSlice->all_mv;

303 
l0_ªf
 = 
mŸi⁄
[
cuºMB
->
block_y
][cuºMB->
block_x
 + 
pos
].
ªf_idx
[
LIST_0
];

304 
	`C›yMVBlock8
(&
mŸi⁄
[
cuºMB
->
block_y
], 
Æl_mv
 [
LIST_0
][
l0_ªf
][
P8x16
], LIST_0, cuºMB->
block_x
 + 
pos
, 0, 4,Öos);

305 
l1_ªf
 = 
mŸi⁄
[
cuºMB
->
block_y
][cuºMB->
block_x
 + 
pos
].
ªf_idx
[
LIST_1
];

306 
	`C›yMVBlock8
(&
mŸi⁄
[
cuºMB
->
block_y
], 
Æl_mv
 [
LIST_1
][
l1_ªf
][
P8x16
], LIST_1, cuºMB->
block_x
 + 
pos
, 0, 4,Öos);

308 i‡(
bùªd_me
 && (
cuºSli˚
->
mb_aff_‰ame_Êag
 || (cuºSli˚->
U£RDOQu™t
 && cuºSli˚->
RDOQ_QP_Num
 > 1)))

310 
j
;

311 
j
 = 0; j < 
BLOCK_MULTIPLE
; j++)

313 
	`mem˝y
(&
cuºSli˚
->
rdd©a
->
Æl_mv
 [
LIST_0
][
l0_ªf
][
P8x16
][
j
][
pos
], &Æl_mv [LIST_0][l0_ªf][P8x16][j][pos], 2 * (
MŸi⁄Ve˘‹
));

315 
j
 = 0; j < 
BLOCK_MULTIPLE
; j++)

317 
	`mem˝y
(&
cuºSli˚
->
rdd©a
->
Æl_mv
 [
LIST_1
][
l1_ªf
][
P8x16
][
j
][
pos
], &Æl_mv [LIST_1][l1_ªf][P8x16][j][pos], 2 * (
MŸi⁄Ve˘‹
));

321 
	}
}

329 
	$SëMVBSli˚8x8
(
Sli˚
 *
cuºSli˚
, 
PicMŸi⁄P¨ams
 **
mŸi⁄
, 
Ma¸oblock
* 
cuºMB
, 
pos_y
, 
pos_x
)

331 
l0_ªf
, 
l1_ªf
;

332 
pos
 = 
pos_y
 + (
pos_x
 >> 1);

333 
pdú
 = 
cuºMB
->
b8x8
[
pos
].pdir;

334 
mode
 = 
cuºMB
->
b8x8
[
pos
].mode;

335 
block_y
 = 
cuºMB
->block_y + 
pos_y
;

336 
block_x
 = 
cuºMB
->block_x + 
pos_x
;

338 i‡(
pdú
 =
LIST_0
)

340 
l0_ªf
 = 
mŸi⁄
[
block_y
][
block_x
].
ªf_idx
[
LIST_0
];

341 
	`C›yMVBlock8
 (&
mŸi⁄
[
cuºMB
->
block_y
], 
cuºSli˚
->
Æl_mv
 [
LIST_0
][
l0_ªf
][
mode
], LIST_0, cuºMB->
block_x
 + 
pos_x
, 
pos_y
,Öos_y + 2,Öos_x);

342 
	`Re£tMŸi⁄Block8
 (&
mŸi⁄
[
cuºMB
->
block_y
], 
LIST_1
, cuºMB->
block_x
 + 
pos_x
, 
pos_y
,Öos_y + 2);

344 i‡(
pdú
 =
LIST_1
)

346 
	`Re£tMŸi⁄Block8
(&
mŸi⁄
[
cuºMB
->
block_y
], 
LIST_0
, cuºMB->
block_x
 + 
pos_x
, 
pos_y
,Öos_y + 2);

347 
l1_ªf
 = 
mŸi⁄
[
block_y
][
block_x
].
ªf_idx
[
LIST_1
];

348 
	`C›yMVBlock8
 (&
mŸi⁄
[
cuºMB
->
block_y
], 
cuºSli˚
->
Æl_mv
 [
LIST_1
][
l1_ªf
][
mode
], LIST_1, cuºMB->
block_x
 + 
pos_x
, 
pos_y
,Öos_y + 2,Öos_x);

350 i‡(
pdú
 =
BI_PRED
)

352 
bùªd_me
 = 
cuºMB
->
b8x8
[
pos
].
bùªd
;

353 
MŸi⁄Ve˘‹
 *****
Æl_mv
 = 
bùªd_me
 ? 
cuºSli˚
->
bùªd_mv
[bipred_me - 1]: currSlice->all_mv;

354 
l0_ªf
 = 
mŸi⁄
[
block_y
][
block_x
].
ªf_idx
[
LIST_0
];

355 
	`C›yMVBlock8
(&
mŸi⁄
[
cuºMB
->
block_y
], 
Æl_mv
 [
LIST_0
][
l0_ªf
][
mode
], LIST_0, cuºMB->
block_x
 + 
pos_x
, 
pos_y
,Öos_y + 2,Öos_x);

357 
l1_ªf
 = 
mŸi⁄
[
block_y
][
block_x
].
ªf_idx
[
LIST_1
];

358 
	`C›yMVBlock8
(&
mŸi⁄
[
cuºMB
->
block_y
], 
Æl_mv
 [
LIST_1
][
l1_ªf
][
mode
], LIST_1, cuºMB->
block_x
 + 
pos_x
, 
pos_y
,Öos_y + 2,Öos_x);

360 i‡(
bùªd_me
 && (
cuºSli˚
->
mb_aff_‰ame_Êag
 || (cuºSli˚->
U£RDOQu™t
 && cuºSli˚->
RDOQ_QP_Num
 > 1)))

362 
	`mem˝y
(&
cuºSli˚
->
rdd©a
->
Æl_mv
 [
LIST_0
][
l0_ªf
][
mode
][
pos_y
 ][
pos_x
], &Æl_mv [LIST_0][l0_ªf][mode][pos_y ][pos_x], 2 * (
MŸi⁄Ve˘‹
));

363 
	`mem˝y
(&
cuºSli˚
->
rdd©a
->
Æl_mv
 [
LIST_0
][
l0_ªf
][
mode
][
pos_y
 + 1][
pos_x
], &Æl_mv [LIST_0][l0_ªf][mode][pos_y + 1][pos_x], 2 * (
MŸi⁄Ve˘‹
));

364 
	`mem˝y
(&
cuºSli˚
->
rdd©a
->
Æl_mv
 [
LIST_1
][
l1_ªf
][
mode
][
pos_y
 ][
pos_x
], &Æl_mv [LIST_1][l1_ªf][mode][pos_y ][pos_x], 2 * (
MŸi⁄Ve˘‹
));

365 
	`mem˝y
(&
cuºSli˚
->
rdd©a
->
Æl_mv
 [
LIST_1
][
l1_ªf
][
mode
][
pos_y
 + 1][
pos_x
], &Æl_mv [LIST_1][l1_ªf][mode][pos_y + 1][pos_x], 2 * (
MŸi⁄Ve˘‹
));

370 
	`Re£tMŸi⁄Block8
(&
mŸi⁄
[
cuºMB
->
block_y
], 
LIST_0
, cuºMB->
block_x
 + 
pos_x
, 
pos_y
,Öos_y + 2);

371 
	`Re£tMŸi⁄Block8
(&
mŸi⁄
[
cuºMB
->
block_y
], 
LIST_1
, cuºMB->
block_x
 + 
pos_x
, 
pos_y
,Öos_y + 2);

373 
	}
}

375 
	$SëMŸi⁄Ve˘‹sMBISli˚
 (
Ma¸oblock
* 
cuºMB
)

377 
	}
}

385 
	$SëMŸi⁄Ve˘‹sMBBSli˚
 (
Ma¸oblock
* 
cuºMB
)

387 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

388 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

389 
PicMŸi⁄P¨ams
 **
mŸi⁄
 = 
p_Vid
->
íc_pi˘uª
->
mv_öfo
;

391 
l0_ªf
, 
l1_ªf
;

397 i‡(
cuºSli˚
->
mb_aff_‰ame_Êag
 || (cuºSli˚->
U£RDOQu™t
 && cuºSli˚->
RDOQ_QP_Num
 > 1))

399 
	`mem˝y
(&
cuºSli˚
->
rdd©a
->
Æl_mv
[
LIST_0
][0][0][0][0], &cuºSli˚->Æl_mv[LIST_0][0][0][0][0], 2 * 
p_Vid
->
max_num_ª„ªn˚s
 * 9 * 
MB_BLOCK_PARTITIONS
 * (
MŸi⁄Ve˘‹
));

402 i‡(
cuºMB
->
mb_ty≥
 =
P16x16
)

404 
pdú
 = 
cuºMB
->
b8x8
[0].pdir;

405 i‡(
pdú
 =
LIST_0
)

407 
l0_ªf
 = 
mŸi⁄
[
cuºMB
->
block_y
][cuºMB->
block_x
].
ªf_idx
[
LIST_0
];

408 
	`C›yMVBlock16
 (
mŸi⁄
, 
cuºSli˚
->
Æl_mv
 [
LIST_0
][
l0_ªf
][
P16x16
], LIST_0, 
cuºMB
->
block_x
, cuºMB->
block_y
, 0, 4);

409 
	`Re£tMŸi⁄Block16
(
mŸi⁄
, 
LIST_1
, 
cuºMB
->
block_x
, cuºMB->
block_y
, 0, 4);

411 i‡(
pdú
 =
LIST_1
)

413 
l1_ªf
 = 
mŸi⁄
[
cuºMB
->
block_y
][cuºMB->
block_x
].
ªf_idx
[
LIST_1
];

414 
	`Re£tMŸi⁄Block16
 (
mŸi⁄
, 
LIST_0
, 
cuºMB
->
block_x
, cuºMB->
block_y
, 0, 4);

415 
	`C›yMVBlock16
 (
mŸi⁄
, 
cuºSli˚
->
Æl_mv
 [
LIST_1
][
l1_ªf
][
P16x16
], LIST_1, 
cuºMB
->
block_x
, cuºMB->
block_y
, 0, 4);

419 
bùªd_me
 = 
cuºMB
->
b8x8
[0].
bùªd
;

420 
MŸi⁄Ve˘‹
 *****
Æl_mv
 = 
bùªd_me
 ? 
cuºSli˚
->
bùªd_mv
[bipred_me - 1]: currSlice->all_mv;

421 
l0_ªf
 = 
mŸi⁄
[
cuºMB
->
block_y
][cuºMB->
block_x
].
ªf_idx
[
LIST_0
];

422 
	`C›yMVBlock16
 (
mŸi⁄
, 
Æl_mv
 [
LIST_0
][
l0_ªf
][
P16x16
], LIST_0, 
cuºMB
->
block_x
, cuºMB->
block_y
, 0, 4);

423 
l1_ªf
 = 
mŸi⁄
[
cuºMB
->
block_y
][cuºMB->
block_x
].
ªf_idx
[
LIST_1
];

424 
	`C›yMVBlock16
 (
mŸi⁄
, 
Æl_mv
 [
LIST_1
][
l1_ªf
][
P16x16
], LIST_1, 
cuºMB
->
block_x
, cuºMB->
block_y
, 0, 4);

427 i‡(
bùªd_me
 && (
cuºSli˚
->
mb_aff_‰ame_Êag
 || (cuºSli˚->
U£RDOQu™t
 && cuºSli˚->
RDOQ_QP_Num
 > 1)))

429 
	`mem˝y
(&
cuºSli˚
->
rdd©a
->
Æl_mv
 [
LIST_0
][
l0_ªf
][
P16x16
][0][0], &Æl_mv [LIST_0][l0_ªf][P16x16][0][0], 
MB_BLOCK_PARTITIONS
 * (
MŸi⁄Ve˘‹
));

430 
	`mem˝y
(&
cuºSli˚
->
rdd©a
->
Æl_mv
 [
LIST_1
][
l1_ªf
][
P16x16
][0][0], &Æl_mv [LIST_1][l1_ªf][P16x16][0][0], 
MB_BLOCK_PARTITIONS
 * (
MŸi⁄Ve˘‹
));

434 i‡(
cuºMB
->
mb_ty≥
 =
P16x8
)

436 
	`SëMVBSli˚16x8
(
cuºSli˚
, 
mŸi⁄
, 
cuºMB
, 0);

437 
	`SëMVBSli˚16x8
(
cuºSli˚
, 
mŸi⁄
, 
cuºMB
, 2);

439 i‡(
cuºMB
->
mb_ty≥
 =
P8x16
)

441 
	`SëMVBSli˚8x16
(
cuºSli˚
, 
mŸi⁄
, 
cuºMB
, 0);

442 
	`SëMVBSli˚8x16
(
cuºSli˚
, 
mŸi⁄
, 
cuºMB
, 2);

444 i‡(
cuºMB
->
mb_ty≥
 =
P8x8
 || cuºMB->mb_ty≥ =
BSKIP_DIRECT
)

446 
	`SëMVBSli˚8x8
(
cuºSli˚
, 
mŸi⁄
, 
cuºMB
, 0, 0);

447 
	`SëMVBSli˚8x8
(
cuºSli˚
, 
mŸi⁄
, 
cuºMB
, 0, 2);

448 
	`SëMVBSli˚8x8
(
cuºSli˚
, 
mŸi⁄
, 
cuºMB
, 2, 0);

449 
	`SëMVBSli˚8x8
(
cuºSli˚
, 
mŸi⁄
, 
cuºMB
, 2, 2);

453 
	`Re£tMŸi⁄Block16
 (
mŸi⁄
, 
LIST_0
, 
cuºMB
->
block_x
, cuºMB->
block_y
, 0, 4);

454 
	`Re£tMŸi⁄Block16
 (
mŸi⁄
, 
LIST_1
, 
cuºMB
->
block_x
, cuºMB->
block_y
, 0, 4);

456 
	}
}

464 
	$c›y_image_d©a_16x16
(
img≥l
 **
imgBuf1
, img≥»**
imgBuf2
, 
off1
, 
off2
)

466 
j
;

467 
j
=0; j<
MB_BLOCK_SIZE
; j++)

469 
	`mem˝y
(&
imgBuf1
[
j
][
off1
], &
imgBuf2
[j][
off2
], 
MB_BLOCK_SIZE
 *  (
img≥l
));

471 
	}
}

479 
	$c›y_image_d©a_8x8
(
img≥l
 **
imgBuf1
, img≥»**
imgBuf2
, 
off1
, 
off2
)

481 
j
;

482 
j
 = 0; j < 
BLOCK_SIZE_8x8
; j++)

484 
	`mem˝y
(&
imgBuf1
[
j
][
off1
], &
imgBuf2
[j][
off2
], 
BLOCK_SIZE_8x8
 *  (
img≥l
));

486 
	}
}

494 
	$c›y_image_d©a_4x4
(
img≥l
 **
imgBuf1
, img≥»**
imgBuf2
, 
off1
, 
off2
)

496 
j
;

497 
j
 = 0; j < 
BLOCK_SIZE
; j++)

499 
	`mem˝y
(&
imgBuf1
[
j
][
off1
], &
imgBuf2
[j][
off2
], 
BLOCK_SIZE
 *  (
img≥l
));

501 
	}
}

509 
	$c›y_image_d©a
(
img≥l
 **
imgBuf1
, img≥»**
imgBuf2
, 
off1
, 
off2
, 
width
, 
height
)

511 
j
;

512 
j
 = 0; j < 
height
; j++)

514 
	`mem˝y
(&
imgBuf1
[
j
][
off1
], &
imgBuf2
[j][
off2
], 
width
 *  (
img≥l
));

516 
	}
}

524 
	$Re£tRD8x8D©a
(
VideoP¨amëîs
 *
p_Vid
, 
RD_8x8DATA
 *
rd_d©a
)

526 
block
;

527 
p_Vid
->
giRDO±_B8O∆yFœg
 = 
TRUE
;

529 
rd_d©a
->
mb_p8x8_co°
 = 0;

530 
rd_d©a
->
cbp8x8
 = 0;

531 
rd_d©a
->
cbp_blk8x8
 = 0;

532 
rd_d©a
->
˙t_n⁄z_8x8
 = 0;

534 
block
 = 0; block < 4; block++)

536 
rd_d©a
->
smb_p8x8_co°
[
block
] = 
DISTBLK_MAX
;

537 
rd_d©a
->
smb_p8x8_rdco°
[
block
] = 
DISTBLK_MAX
;

538 
rd_d©a
->
∑π
[
block
].
mode
 = -1;

540 
	}
}

548 
	$£t_chroma_¥ed_mode
(
Ma¸oblock
 *
cuºMB
, 
RD_PARAMS
 
íc_mb
, *
mb_avaûabÀ
, 
chroma_¥ed_mode_ønge
[2])

550 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

551 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

553 i‡((
p_Vid
->
yuv_f‹m©
 !
YUV400
Ë&& (
p_I≈
->
£∑øã_cﬁour_∂™e_Êag
 == 0))

555 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

557 
cuºSli˚
->
	`öåa_chroma_¥edi˘i⁄
(
cuºMB
, &
mb_avaûabÀ
[0], &mb_available[1], &mb_available[2]);

559 i‡(
p_I≈
->
Fa°CrI¡øDecisi⁄
)

561 
cuºSli˚
->
	`öåa_chroma_RD_decisi⁄
(
cuºMB
, &
íc_mb
);

563 
chroma_¥ed_mode_ønge
[0] = 
cuºMB
->
c_ùªd_mode
;

564 
chroma_¥ed_mode_ønge
[1] = 
cuºMB
->
c_ùªd_mode
;

568 
chroma_¥ed_mode_ønge
[0] = 
DC_PRED_8
;

569 
chroma_¥ed_mode_ønge
[1] = 
PLANE_8
;

574 
chroma_¥ed_mode_ønge
[0] = 
DC_PRED_8
;

575 
chroma_¥ed_mode_ønge
[1] = 
DC_PRED_8
;

577 
	}
}

	@lencod/src/md_distortion.c

12 
	~<m©h.h
>

13 
	~<limôs.h
>

14 
	~<Êﬂt.h
>

16 
	~"globÆ.h
"

17 
	~"rd›t_codög_°©e.h
"

18 
	~"mb_ac˚ss.h
"

19 
	~"öå¨e‰esh.h
"

20 
	~"image.h
"

21 
	~"å™sf‹m8x8.h
"

22 
	~"øã˘l.h
"

23 
	~"mode_decisi⁄.h
"

24 
	~"fmo.h
"

25 
	~"me_umhex.h
"

26 
	~"me_umhexsmp.h
"

27 
	~"ma¸oblock.h
"

28 
	~"mv_£¨ch.h
"

29 
	~"md_di°‹ti⁄.h
"

31 
	$£tupDi°‹ti⁄
(
Sli˚
 *
cuºSli˚
)

33 
cuºSli˚
->
gëDi°‹ti⁄
 = 
di°‹ti⁄SSE
;

34 
	}
}

42 
öt64
 
	$compuã_SSE
(
img≥l
 **
imgRef
, img≥»**
imgSrc
, 
xRef
, 
xSrc
, 
ySize
, 
xSize
)

44 
i
, 
j
;

45 
img≥l
 *
löeRef
, *
löeSrc
;

46 
öt64
 
di°‹ti⁄
 = 0;

48 
j
 = 0; j < 
ySize
; j++)

50 
löeRef
 = &
imgRef
[
j
][
xRef
];

51 
löeSrc
 = &
imgSrc
[
j
][
xSrc
];

53 
i
 = 0; i < 
xSize
; i++)

54 
di°‹ti⁄
 +
	`übs2
–*
löeRef
++ - *
löeSrc
++ );

56  
di°‹ti⁄
;

57 
	}
}

59 
di°blk
 
	$compuã_SSE_¸
(
img≥l
 **
imgRef
, img≥»**
imgSrc
, 
xRef
, 
xSrc
, 
ySize
, 
xSize
)

61 
i
, 
j
;

62 
img≥l
 *
löeRef
, *
löeSrc
;

63 
di°blk
 
di°‹ti⁄
 = 0;

65 
j
 = 0; j < 
ySize
; j++)

67 
löeRef
 = &
imgRef
[
j
][
xRef
];

68 
löeSrc
 = &
imgSrc
[
j
][
xSrc
];

70 
i
 = 0; i < 
xSize
; i++)

71 
di°‹ti⁄
 +
	`übs2
–*
löeRef
++ - *
löeSrc
++ );

74  
	`di°_sˇÀ
(
di°‹ti⁄
);

75 
	}
}

83 
di°blk
 
	$compuã_SSE16x16
(
img≥l
 **
imgRef
, img≥»**
imgSrc
, 
xRef
, 
xSrc
)

85 
i
, 
j
;

86 
img≥l
 *
löeRef
, *
löeSrc
;

87 
di°blk
 
di°‹ti⁄
 = 0;

89 
j
 = 0; j < 
MB_BLOCK_SIZE
; j++)

91 
löeRef
 = &
imgRef
[
j
][
xRef
];

92 
löeSrc
 = &
imgSrc
[
j
][
xSrc
];

94 
i
 = 0; i < 
MB_BLOCK_SIZE
; i++)

95 
di°‹ti⁄
 +
	`übs2
–*
löeRef
++ - *
löeSrc
++ );

98  
	`di°_sˇÀ
(
di°‹ti⁄
);

99 
	}
}

101 
di°blk
 
	$compuã_SSE16x16_thªs
(
img≥l
 **
imgRef
, img≥»**
imgSrc
, 
xRef
, 
xSrc
, 
di°blk
 
mö_co°
)

103 
i
, 
j
;

104 
img≥l
 *
löeRef
, *
löeSrc
;

105 
di°blk
 
di°‹ti⁄
 = 0;

106 
imö_co°
 = 
	`di°_down
(
mö_co°
);

108 
j
 = 0; j < 
MB_BLOCK_SIZE
; j++)

110 
löeRef
 = &
imgRef
[
j
][
xRef
];

111 
löeSrc
 = &
imgSrc
[
j
][
xSrc
];

113 
i
 = 0; i < 
MB_BLOCK_SIZE
; i++)

114 
di°‹ti⁄
 +
	`übs2
–*
löeRef
++ - *
löeSrc
++ );

115 i‡(
di°‹ti⁄
 > 
imö_co°
)

116  (
mö_co°
);

119  
	`di°_sˇÀ
(
di°‹ti⁄
);

120 
	}
}

127 
di°blk
 
	$compuã_SSE8x8
(
img≥l
 **
imgRef
, img≥»**
imgSrc
, 
xRef
, 
xSrc
)

129 
i
, 
j
;

130 
img≥l
 *
löeRef
, *
löeSrc
;

131 
di°blk
 
di°‹ti⁄
 = 0;

133 
j
 = 0; j < 
BLOCK_SIZE_8x8
; j++)

135 
löeRef
 = &
imgRef
[
j
][
xRef
];

136 
löeSrc
 = &
imgSrc
[
j
][
xSrc
];

138 
i
 = 0; i < 
BLOCK_SIZE_8x8
; i++)

139 
di°‹ti⁄
 +
	`übs2
–*
löeRef
++ - *
löeSrc
++ );

142  
	`di°_sˇÀ
(
di°‹ti⁄
);

143 
	}
}

152 
di°blk
 
	$compuã_SSE4x4
(
img≥l
 **
imgRef
, img≥»**
imgSrc
, 
xRef
, 
xSrc
)

154 
i
, 
j
;

155 
img≥l
 *
löeRef
, *
löeSrc
;

156 
di°blk
 
di°‹ti⁄
 = 0;

158 
j
 = 0; j < 
BLOCK_SIZE
; j++)

160 
löeRef
 = &
imgRef
[
j
][
xRef
];

161 
löeSrc
 = &
imgSrc
[
j
][
xSrc
];

163 
i
 = 0; i < 
BLOCK_SIZE
; i++)

164 
di°‹ti⁄
 +
	`übs2
–*
löeRef
++ - *
löeSrc
++ );

167  
	`di°_sˇÀ
(
di°‹ti⁄
);

168 
	}
}

176 
di°blk
 
	$di°‹ti⁄SSE
(
Ma¸oblock
 *
cuºMB
)

178 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

179 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

180 
di°blk
 
di°‹ti⁄Y
 = 0;

181 
di°blk
 
di°‹ti⁄Cr
[2] = {0, 0};

184 
di°‹ti⁄Y
 = 
	`compuã_SSE16x16
(&
p_Vid
->
pCurImg
[
cuºMB
->
›ix_y
], &p_Vid->
íc_pi˘uª
->
p_cuº_img
[cuºMB->
pix_y
], cuºMB->
pix_x
, currMB->pix_x);

187 i‡((
p_Vid
->
yuv_f‹m©
 !
YUV400
Ë&& (
p_I≈
->
£∑øã_cﬁour_∂™e_Êag
 == 0))

189 
di°‹ti⁄Cr
[0] = 
	`compuã_SSE_¸
(&
p_Vid
->
pImgOrg
[1][
cuºMB
->
›ix_c_y
], &p_Vid->
íc_pi˘uª
->
imgUV
[0][cuºMB->
pix_c_y
], cuºMB->
pix_c_x
, cuºMB->pix_c_x,Ö_Vid->
mb_¸_size_y
,Ö_Vid->
mb_¸_size_x
);

190 
di°‹ti⁄Cr
[1] = 
	`compuã_SSE_¸
(&
p_Vid
->
pImgOrg
[2][
cuºMB
->
›ix_c_y
], &p_Vid->
íc_pi˘uª
->
imgUV
[1][cuºMB->
pix_c_y
], cuºMB->
pix_c_x
, cuºMB->pix_c_x,Ö_Vid->
mb_¸_size_y
,Ö_Vid->
mb_¸_size_x
);

192 #i‡
JCOST_OVERFLOWCHECK


193 if(
di°‹ti⁄Y
 * 
p_I≈
->
WeightY
 + 
di°‹ti⁄Cr
[0] *Ö_I≈->
WeightCb
 + di°‹ti⁄Cr[1] *Ö_I≈->
WeightCr
 > 
DISTBLK_MAX
)

195 
	`¥ötf
("OvîÊow: %†: %d \¿MB: %d, VÆue: %lf\n", 
__FILE__
, 
__LINE__
, 
cuºMB
->
mbAddrX
, (
di°‹ti⁄Y
 * 
p_I≈
->
WeightY
 + 
di°‹ti⁄Cr
[0] *Ö_I≈->
WeightCb
 + di°‹ti⁄Cr[1] *Ö_I≈->
WeightCr
));

196 
	`exô
(-1);

199  (
di°blk
)–
di°‹ti⁄Y
 * 
p_I≈
->
WeightY
 + 
di°‹ti⁄Cr
[0] *Ö_I≈->
WeightCb
 + di°‹ti⁄Cr[1] *Ö_I≈->
WeightCr
 );

200 
	}
}

	@lencod/src/md_high.c

11 
	~<m©h.h
>

12 
	~<limôs.h
>

13 
	~<Êﬂt.h
>

15 
	~"globÆ.h
"

16 
	~"rd›t_codög_°©e.h
"

17 
	~"öå¨e‰esh.h
"

18 
	~"image.h
"

19 
	~"øã˘l.h
"

20 
	~"mode_decisi⁄.h
"

21 
	~"mode_decisi⁄_p8x8.h
"

22 
	~"fmo.h
"

23 
	~"me_umhex.h
"

24 
	~"me_umhexsmp.h
"

25 
	~"ma¸oblock.h
"

26 
	~"md_comm⁄.h
"

27 
	~"c⁄f‹m™˚.h
"

28 
	~"vlc.h
"

29 
	~"rd›t.h
"

30 
	~"mv_£¨ch.h
"

38 
	$ícode_⁄e_ma¸oblock_high
 (
Ma¸oblock
 *
cuºMB
)

40 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

41 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

42 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

43 
PicMŸi⁄P¨ams
 **
mŸi⁄
 = 
p_Vid
->
íc_pi˘uª
->
mv_öfo
;

44 
RDOPTSåu˘uª
 *
p_RDO
 = 
cuºSli˚
->p_RDO;

46 
max_ödex
 = 9;

47 
block
, 
ödex
, 
mode
, 
i
, 
j
;

48 
RD_PARAMS
 
íc_mb
;

49 
di°blk
 
bmco°
[5] = {
DISTBLK_MAX
};

50 
di°blk
 
co°
=0;

51 
di°blk
 
mö_co°
 = 
DISTBLK_MAX
;

52 
öåa1
 = 0;

53 
mb_avaûabÀ
[3];

55 
b¶i˚
 = (Ë(
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
);

56 
p¶i˚
 = (Ë((
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
Ë|| (cuºSli˚->¶i˚_ty≥ =
SP_SLICE
));

57 
öåa
 = (Ë((
cuºSli˚
->
¶i˚_ty≥
 =
I_SLICE
Ë|| (cuºSli˚->¶i˚_ty≥ =
SI_SLICE
Ë|| (
p¶i˚
 && 
cuºMB
->
mb_y
 =
p_Vid
->
mb_y_upd
 &&Ö_Vid->mb_y_upd !p_Vid->
mb_y_öåa
));

58 
œmbda_mf
[3];

60 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_pred[0];

61 
Block8x8Info
 *
b8x8öfo
 = 
p_Vid
->b8x8info;

63 
chroma_¥ed_mode_ønge
[2];

64 
öãr_skù
 = 0;

65 
Be°Mode
 
md_be°
;

66 
Info8x8
 
be°
;

69 
	`öô_md_be°
(&
md_be°
);

72 
be°
.
pdú
 = 0;

73 
be°
.
bùªd
 = 0;

74 
be°
.
ªf
[
LIST_0
] = 0;

75 
be°
.
ªf
[
LIST_1
] = -1;

77 
öåa
 |
	`R™domI¡ø
 (
p_Vid
, 
cuºMB
->
mbAddrX
);

80 
	`öô_íc_mb_∑øms
(
cuºMB
, &
íc_mb
, 
öåa
);

81 i‡(
p_I≈
->
Ad≠tiveRoundög
)

83 
	`ª£t_ad≠tive_roundög
(
p_Vid
);

86 i‡(
cuºSli˚
->
mb_aff_‰ame_Êag
)

88 
	`ª£t_mb_nz_c€ff
(
p_Vid
, 
cuºMB
->
mbAddrX
);

93 
cuºSli˚
->
	`°‹e_codög_°©e
 (
cuºMB
, cuºSli˚->
p_RDO
->
cs_cm
);

95 i‡(!
öåa
)

98 i‡(
íc_mb
.
vÆid
[0])

100 i‡(
b¶i˚
)

101 
cuºSli˚
->
	`Gë_Dúe˘_MŸi⁄_Ve˘‹s
 (
cuºMB
);

103 
	`FödSkùModeMŸi⁄Ve˘‹
 (
cuºMB
);

105 i‡(
p_I≈
->
CtxAd±LagøngeMu…
 == 1)

107 
	`gë_öôül_mb16x16_co°
(
cuºMB
);

111 
mode
 = 1; mode < 4; mode++)

113 
be°
.
mode
 = () mode;

114 
be°
.
bùªd
 = 0;

115 
b8x8öfo
->
be°
[
mode
][0].
bùªd
 = 0;

117 i‡(
íc_mb
.
vÆid
[
mode
])

119 
co°
=0, 
block
=0; block<(
mode
==1?1:2); block++)

121 
	`upd©e_œmbda_co°s
(
cuºMB
, &
íc_mb
, 
œmbda_mf
);

122 
	`P¨tôi⁄MŸi⁄Sórch
 (
cuºMB
, 
mode
, 
block
, 
œmbda_mf
);

125 
j
 = (
block
==1 && 
mode
==2 ? 2 : 0);

126 
i
 = (
block
==1 && 
mode
==3 ? 2 : 0);

129 
bmco°
[
LIST_0
] = 
DISTBLK_MAX
;

130 
	`li°_¥edi˘i⁄_co°
(
cuºMB
, 
LIST_0
, 
block
, 
mode
, &
íc_mb
, 
bmco°
, 
be°
.
ªf
);

132 i‡(
b¶i˚
)

135 
bmco°
[
LIST_1
] = 
DISTBLK_MAX
;

136 
	`li°_¥edi˘i⁄_co°
(
cuºMB
, 
LIST_1
, 
block
, 
mode
, &
íc_mb
, 
bmco°
, 
be°
.
ªf
);

139 
	`li°_¥edi˘i⁄_co°
(
cuºMB
, 
BI_PRED
, 
block
, 
mode
, &
íc_mb
, 
bmco°
, 
be°
.
ªf
);

142 i‡(
	`is_bùªd_íabÀd
(
p_Vid
, 
mode
))

144 
	`gë_bùªd_co°
(
cuºMB
, 
mode
, 
block
, 
i
, 
j
, &
be°
, &
íc_mb
, 
bmco°
);

148 
bmco°
[
BI_PRED_L0
] = 
DISTBLK_MAX
;

149 
bmco°
[
BI_PRED_L1
] = 
DISTBLK_MAX
;

153 
	`dëîmöe_¥edi˘i⁄_li°
(
bmco°
, &
be°
, &
co°
);

157 
be°
.
pdú
 = 0;

158 
co°
 +
bmco°
[
LIST_0
];

161 
	`assign_íc_pi˘uª_∑øms
(
cuºMB
, 
mode
, &
be°
, 2 * 
block
);

164 
	`£t_block8x8_öfo
(
b8x8öfo
, 
mode
, 
block
, &
be°
);

167 i‡(
mode
>1 && 
block
 == 0)

168 
cuºSli˚
->
	`£t_ªf_™d_mŸi⁄_ve˘‹s
 (
cuºMB
, 
mŸi⁄
, &
be°
, 
block
);

170 i‡(
co°
 < 
mö_co°
)

172 
md_be°
.
mode
 = (
byã
) mode;

173 
md_be°
.
co°
 = cost;

174 
cuºMB
->
be°_mode
 = (Ë
mode
;

175 
mö_co°
 = 
co°
;

176 i‡(
p_I≈
->
CtxAd±LagøngeMu…
 == 1)

178 
	`adju°_mb16x16_co°
(
cuºMB
, 
co°
);

184 i‡(
íc_mb
.
vÆid
[
P8x8
])

186 
cuºMB
->
vÆid_8x8
 = 
FALSE
;

188 i‡(
p_I≈
->
Tønsf‹m8x8Mode
)

190 
	`Re£tRD8x8D©a
(
p_Vid
, 
p_RDO
->
å8x8
);

191 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
TRUE
;

196 
block
 = 0; block < 4; block++)

198 
cuºSli˚
->
	`subma¸oblock_mode_decisi⁄
(
cuºMB
, &
íc_mb
, 
p_RDO
->
å8x8
,Ö_RDO->
cofAC8x8ts
[
block
], block, &
co°
);

199 if(!
cuºMB
->
vÆid_8x8
)

201 
	`£t_subblock8x8_öfo
(
b8x8öfo
, 
P8x8
, 
block
, 
p_RDO
->
å8x8
);

206 
cuºMB
->
vÆid_4x4
 = 
FALSE
;

207 i‡(
p_I≈
->
Tønsf‹m8x8Mode
 != 2)

209 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
FALSE
;

210 
	`Re£tRD8x8D©a
(
p_Vid
, 
p_RDO
->
å4x4
);

215 
block
 = 0; block < 4; block++)

217 
cuºSli˚
->
	`subma¸oblock_mode_decisi⁄
(
cuºMB
, &
íc_mb
, 
p_RDO
->
å4x4
,Ö_RDO->
c€fAC8x8
[
block
], block, &
co°
);

218 if(!
cuºMB
->
vÆid_4x4
)

220 
	`£t_subblock8x8_öfo
(
b8x8öfo
, 
P8x8
, 
block
, 
p_RDO
->
å4x4
);

224 i‡(
p_I≈
->
RCE«bÀ
)

225 
	`rc_°‹e_diff
(
cuºSli˚
->
diffy
, &
p_Vid
->
pCurImg
[
cuºMB
->
›ix_y
], cuºMB->
pix_x
, 
mb_¥ed
);

227 
p_Vid
->
giRDO±_B8O∆yFœg
 = 
FALSE
;

232 
mö_co°
 = 
DISTBLK_MAX
;

236 
	`£t_chroma_¥ed_mode
(
cuºMB
, 
íc_mb
, 
mb_avaûabÀ
, 
chroma_¥ed_mode_ønge
);

241 
cuºMB
->
c_ùªd_mode
 = 
chroma_¥ed_mode_ønge
[0]; currMB->c_ipred_mode<=chroma_pred_mode_range[1]; currMB->c_ipred_mode++)

244 i‡–(
p_Vid
->
yuv_f‹m©
 !
YUV400
) &&

245 –((!
öåa
 || !
p_I≈
->
I¡øDißbÀI¡îO∆y
Ë&&Ö_I≈->
ChromaI¡øDißbÀ
 =1 && 
cuºMB
->
c_ùªd_mode
!=
DC_PRED_8
)

246 || (
cuºMB
->
c_ùªd_mode
 =
VERT_PRED_8
 && !
mb_avaûabÀ
[0])

247 || (
cuºMB
->
c_ùªd_mode
 =
HOR_PRED_8
 && !
mb_avaûabÀ
[1])

248 || (
cuºMB
->
c_ùªd_mode
 =
PLANE_8
 && (!
mb_avaûabÀ
[1] || !mb_available[0] || !mb_available[2]))))

252 
ödex
=0; index < 
max_ödex
; index++)

254 
mode
 = 
mb_mode_èbÀ
[
ödex
];

256 i‡(
íc_mb
.
vÆid
[
mode
])

259 i‡(
p_Vid
->
yuv_f‹m©
 !
YUV400
)

261 
cuºMB
->
i16mode
 = 0;

265 i‡(
cuºSli˚
->
P444_joöed
)

267 i‡(
p_I≈
->
SkùI¡øInI¡îSli˚s
 && !
öåa
 && 
mode
 >
I16MB


268 && 
cuºMB
->
be°_mode
 <=3 && cuºMB->
be°_cbp
 =0 && 
cuºSli˚
->
cmp_cbp
[1] =0 && cuºSli˚->cmp_cbp[2] =0 && (cuºMB->
mö_rdco°
 < 
	`weighãd_co°
(
íc_mb
.
œmbda_mdÂ
,5)))

273 i‡(
p_I≈
->
SkùI¡øInI¡îSli˚s
)

275 i‡(!
öåa
 && 
mode
 >
I4MB
)

277 i‡(
cuºMB
->
be°_mode
 <=3 && cuºMB->
be°_cbp
 =0 && (cuºMB->
mö_rdco°
 < 
	`weighãd_co°
(
íc_mb
.
œmbda_mdÂ
, 5)))

281 i‡(
cuºMB
->
be°_mode
 =0 && (cuºMB->
mö_rdco°
 < 
	`weighãd_co°
(
íc_mb
.
œmbda_mdÂ
,6)))

289 
	`compuã_mode_RD_co°
(
cuºMB
, &
íc_mb
, (Ë
mode
, &
öãr_skù
);

296 
	`ª°‹e_nz_c€ff
(
cuºMB
);

298 
öåa1
 = 
	`is_öåa
(
cuºMB
);

302 
	`upd©e_qp_cbp_tmp
(
cuºMB
, 
p_RDO
->
cbp
);

303 
cuºSli˚
->
	`£t_°‹ed_mb_∑ømëîs
 (
cuºMB
);

306 if(
p_I≈
->
RCE«bÀ
 &&Ö_I≈->
RCUpd©eMode
 <
MAX_RC_MODE
)

307 
	`rc_°‹e_mad
(
cuºMB
);

311 i‡(
p_I≈
->
Re°ri˘Ref
)

312 
	`upd©e_ª‰esh_m≠
(
cuºMB
, 
öåa
, 
öåa1
);

313 
	}
}

	@lencod/src/md_highfast.c

11 
	~<m©h.h
>

12 
	~<limôs.h
>

13 
	~<Êﬂt.h
>

15 
	~"globÆ.h
"

16 
	~"rd›t_codög_°©e.h
"

17 
	~"mb_ac˚ss.h
"

18 
	~"öå¨e‰esh.h
"

19 
	~"image.h
"

20 
	~"øã˘l.h
"

21 
	~"mode_decisi⁄.h
"

22 
	~"mode_decisi⁄_p8x8.h
"

23 
	~"fmo.h
"

24 
	~"me_umhex.h
"

25 
	~"me_umhexsmp.h
"

26 
	~"ma¸oblock.h
"

27 
	~"md_comm⁄.h
"

28 
	~"c⁄f‹m™˚.h
"

29 
	~"vlc.h
"

30 
	~"rd›t.h
"

31 
	~"mv_£¨ch.h
"

40 
	$Á°_mode_öåa_decisi⁄
(
Ma¸oblock
 *
cuºMB
, *
öåa_skù
)

42 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

43 
i
;

44 
mb_avaûabÀ_up
, 
mb_avaûabÀ_À·
;

45 
SBE
;

46 
AR
 = 0, 
ABE
 = 0;

47 
PixñPos
 
up
;

48 
PixñPos
 
À·
[2];

50 
p_Vid
->
	`gëNeighbour
(
cuºMB
, 0 , -1 ,Ö_Vid->
mb_size
[
IS_LUMA
], &
up
);

51 
p_Vid
->
	`gëNeighbour
(
cuºMB
, -1 , -1 ,Ö_Vid->
mb_size
[
IS_LUMA
], &
À·
[0]);

52 
p_Vid
->
	`gëNeighbour
(
cuºMB
, -1 , 0 ,Ö_Vid->
mb_size
[
IS_LUMA
], &
À·
[1]);

54 
mb_avaûabÀ_up
 = 
up
.
avaûabÀ
;

55 
mb_avaûabÀ_À·
 = 
À·
[1].
avaûabÀ
;

57 
AR
=(1.0/384)*
cuºMB
->
mö_øã
;

59 
SBE
 = 0;

61 if–(
cuºMB
->
mb_y
 !()
p_Vid
->
FømeHeightInMbs
-1Ë&& (cuºMB->
mb_x
 !(Ì_Vid->
PicWidthInMbs
-1Ë&& 
mb_avaûabÀ_À·
 && 
mb_avaûabÀ_up
)

63 
i
 = 0; i < 
MB_BLOCK_SIZE
; i++)

65 
SBE
 +
	`übs
(
p_Vid
->
pCurImg
[
cuºMB
->
›ix_y
][cuºMB->
pix_x
 + 
i
] -Ö_Vid->
íc_pi˘uª
->
imgY
[cuºMB->
pix_y
 - 1][currMB->pix_x + i]);

66 
SBE
 +
	`übs
(
p_Vid
->
pCurImg
[
cuºMB
->
›ix_y
 + 
i
][cuºMB->
pix_x
] -Ö_Vid->
íc_pi˘uª
->
imgY
[cuºMB->
pix_y
 + i][currMB->pix_x - 1]);

69 
i
 = 0; i < 8; i++)

71 
SBE
 +
	`übs
(
p_Vid
->
pImgOrg
[1][
cuºMB
->
›ix_c_y
][cuºMB->
pix_c_x
 + 
i
] -Ö_Vid->
íc_pi˘uª
->
imgUV
[0][cuºMB->
pix_c_y
 - 1][currMB->pix_c_x + i]);

72 
SBE
 +
	`übs
(
p_Vid
->
pImgOrg
[1][
cuºMB
->
›ix_c_y
+
i
][cuºMB->
pix_c_x
] -Ö_Vid->
íc_pi˘uª
->
imgUV
[0][cuºMB->
pix_c_y
 + i][currMB->pix_c_x - 1]);

73 
SBE
 +
	`übs
(
p_Vid
->
pImgOrg
[2][
cuºMB
->
›ix_c_y
][cuºMB->
pix_c_x
 + 
i
] -Ö_Vid->
íc_pi˘uª
->
imgUV
[1][cuºMB->
pix_c_y
 - 1][currMB->pix_c_x + i]);

74 
SBE
 +
	`übs
(
p_Vid
->
pImgOrg
[2][
cuºMB
->
›ix_c_y
+
i
][cuºMB->
pix_c_x
] -Ö_Vid->
íc_pi˘uª
->
imgUV
[1][cuºMB->
pix_c_y
 + i][currMB->pix_c_x - 1]);

76 
ABE
 = 1.0/64 * 
SBE
;

80 
ABE
 = 0;

83 if(
AR
 <
ABE
)

85 *
öåa_skù
 = 1;

87 
	}
}

95 
	$ícode_⁄e_ma¸oblock_highÁ°
 (
Ma¸oblock
 *
cuºMB
)

97 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

98 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

99 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

100 
PicMŸi⁄P¨ams
 **
mŸi⁄
 = 
p_Vid
->
íc_pi˘uª
->
mv_öfo
;

101 
RDOPTSåu˘uª
 *
p_RDO
 = 
cuºSli˚
->p_RDO;

103 
max_ödex
;

104 
block
, 
ödex
, 
mode
, 
i
, 
j
;

105 
RD_PARAMS
 
íc_mb
;

106 
di°blk
 
max_rdco°
 = 
DISTBLK_MAX
;

107 
di°blk
 
bmco°
[5] = {
DISTBLK_MAX
};

108 
di°blk
 
co°
=0;

109 
di°blk
 
mö_co°
 = 
DISTBLK_MAX
;

110 
öåa1
 = 0;

111 
mb_avaûabÀ
[3];

113 
i¶i˚
 = (Ë(
cuºSli˚
->
¶i˚_ty≥
 =
I_SLICE
);

114 
b¶i˚
 = (Ë(
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
);

115 
p¶i˚
 = (Ë((
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
Ë|| (cuºSli˚->¶i˚_ty≥ =
SP_SLICE
));

116 
öåa
 = (Ë((
cuºSli˚
->
¶i˚_ty≥
 =
I_SLICE
Ë|| (cuºSli˚->¶i˚_ty≥ =
SI_SLICE
Ë|| (
p¶i˚
 && 
cuºMB
->
mb_y
 =
p_Vid
->
mb_y_upd
 &&Ö_Vid->mb_y_upd !p_Vid->
mb_y_öåa
));

117 
œmbda_mf
[3];

119 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_pred[0];

120 
Block8x8Info
 *
b8x8öfo
 = 
p_Vid
->b8x8info;

122 
chroma_¥ed_mode_ønge
[2];

125 
MŸi⁄Ve˘‹
 *
Ælmvs
 = (
cuºSli˚
->
¶i˚_ty≥
 =
I_SLICE
Ë? 
NULL
: &cuºSli˚->
Æl_mv
[0][0][0][0][0];

128 
öãr_skù
 = 0, 
öåa_skù
 = 0;

129 
mode16
 = 0;

130 
di°blk
 
RDCo°16
 = 
DISTBLK_MAX
;

131 
Be°Mode
 
md_be°
;

132 
Info8x8
 
be°
;

134 
	`öô_md_be°
(&
md_be°
);

137 
be°
.
pdú
 = 0;

138 
be°
.
bùªd
 = 0;

139 
be°
.
ªf
[
LIST_0
] = 0;

140 
be°
.
ªf
[
LIST_1
] = -1;

142 
öåa
 |
	`R™domI¡ø
 (
p_Vid
, 
cuºMB
->
mbAddrX
);

145 
	`öô_íc_mb_∑øms
(
cuºMB
, &
íc_mb
, 
öåa
);

146 i‡(
p_I≈
->
Ad≠tiveRoundög
)

148 
	`ª£t_ad≠tive_roundög
(
p_Vid
);

151 i‡(
cuºSli˚
->
mb_aff_‰ame_Êag
)

153 
	`ª£t_mb_nz_c€ff
(
p_Vid
, 
cuºMB
->
mbAddrX
);

158 
cuºSli˚
->
	`°‹e_codög_°©e
 (
cuºMB
, cuºSli˚->
p_RDO
->
cs_cm
);

160 i‡(!
öåa
)

163 i‡(
b¶i˚
 && 
íc_mb
.
vÆid
[0])

165 
cuºSli˚
->
	`Gë_Dúe˘_MŸi⁄_Ve˘‹s
 (
cuºMB
);

166 
cuºMB
->
be°_mode
 = 0;

167 
cuºMB
->
c_ùªd_mode
=
DC_PRED_8
;

168 
cuºMB
->
mö_rdco°
 = 
max_rdco°
;

169 
	`compuã_mode_RD_co°
(
cuºMB
, &
íc_mb
, 0, &
öãr_skù
);

171 i‡(
p_I≈
->
CtxAd±LagøngeMu…
 == 1)

173 
	`gë_öôül_mb16x16_co°
(
cuºMB
);

177 
mode
 = 1; mode < 4; mode++)

179 
be°
.
mode
 = () mode;

180 
be°
.
bùªd
 = 0;

181 
b8x8öfo
->
be°
[
mode
][0].
bùªd
 = 0;

183 i‡(
íc_mb
.
vÆid
[
mode
] && !
öãr_skù
)

185 
co°
=0, 
block
=0; block<(
mode
==1?1:2); block++)

187 
	`upd©e_œmbda_co°s
(
cuºMB
, &
íc_mb
, 
œmbda_mf
);

188 
	`P¨tôi⁄MŸi⁄Sórch
 (
cuºMB
, 
mode
, 
block
, 
œmbda_mf
);

191 
j
 = (
block
==1 && 
mode
==2 ? 2 : 0);

192 
i
 = (
block
==1 && 
mode
==3 ? 2 : 0);

195 
bmco°
[
LIST_0
] = 
DISTBLK_MAX
;

196 
	`li°_¥edi˘i⁄_co°
(
cuºMB
, 
LIST_0
, 
block
, 
mode
, &
íc_mb
, 
bmco°
, 
be°
.
ªf
);

198 i‡(
b¶i˚
)

201 
bmco°
[
LIST_1
] = 
DISTBLK_MAX
;

202 
	`li°_¥edi˘i⁄_co°
(
cuºMB
, 
LIST_1
, 
block
, 
mode
, &
íc_mb
, 
bmco°
, 
be°
.
ªf
);

205 
	`li°_¥edi˘i⁄_co°
(
cuºMB
, 
BI_PRED
, 
block
, 
mode
, &
íc_mb
, 
bmco°
, 
be°
.
ªf
);

208 i‡(
	`is_bùªd_íabÀd
(
p_Vid
, 
mode
))

210 
	`gë_bùªd_co°
(
cuºMB
, 
mode
, 
block
, 
i
, 
j
, &
be°
, &
íc_mb
, 
bmco°
);

214 
bmco°
[
BI_PRED_L0
] = 
DISTBLK_MAX
;

215 
bmco°
[
BI_PRED_L1
] = 
DISTBLK_MAX
;

219 
	`dëîmöe_¥edi˘i⁄_li°
(
bmco°
, &
be°
, &
co°
);

223 
be°
.
pdú
 = 0;

224 
co°
 +
bmco°
[
LIST_0
];

227 
	`assign_íc_pi˘uª_∑øms
(
cuºMB
, 
mode
, &
be°
, 2 * 
block
);

230 
	`£t_block8x8_öfo
(
b8x8öfo
, 
mode
, 
block
, &
be°
);

233 i‡(
mode
>1 && 
block
 == 0)

234 
cuºSli˚
->
	`£t_ªf_™d_mŸi⁄_ve˘‹s
 (
cuºMB
, 
mŸi⁄
, &
be°
, 
block
);

238 if(
mode
 == 1)

240 if(
p¶i˚
)

241 
cuºMB
->
mö_rdco°
 = 
max_rdco°
;

243 
cuºMB
->
c_ùªd_mode
=
DC_PRED_8
;

244 
	`compuã_mode_RD_co°
(
cuºMB
, &
íc_mb
, (Ë
mode
, &
öãr_skù
);

246 if(
p¶i˚
)

249 
	`FödSkùModeMŸi⁄Ve˘‹
 (
cuºMB
);

251 if(
p_I≈
->
E¨lySkùE«bÀ
)

254 i‡–
cuºMB
->
cbp
==0 && 
mŸi⁄
[cuºMB->
block_y
][cuºMB->
block_x
].
ªf_idx
[
LIST_0
]==0 &&

255 
mŸi⁄
[
cuºMB
->
block_y
][cuºMB->
block_x
].
mv
[
LIST_0
].
mv_x
 =
Ælmvs
->mv_x &&

256 
mŸi⁄
[
cuºMB
->
block_y
][cuºMB->
block_x
].
mv
[
LIST_0
].
mv_y
 =
Ælmvs
->mv_y)

258 
öãr_skù
 = 1;

259 
cuºMB
->
be°_mode
 = 0;

265 
RDCo°16
 = 
cuºMB
->
mö_rdco°
;

266 
mode16
 = 
cuºMB
->
be°_mode
;

269 i‡((!
öãr_skù
Ë&& (
co°
 < 
mö_co°
))

271 
md_be°
.
mode
 = (
byã
) mode;

272 
md_be°
.
co°
 = cost;

273 
cuºMB
->
be°_mode
 = (Ë
mode
;

274 
mö_co°
 = 
co°
;

275 i‡(
p_I≈
->
CtxAd±LagøngeMu…
 == 1)

277 
	`adju°_mb16x16_co°
(
cuºMB
, 
co°
);

283 i‡((!
öãr_skù
Ë&& 
íc_mb
.
vÆid
[
P8x8
])

285 
cuºMB
->
vÆid_8x8
 = 
FALSE
;

287 i‡(
p_I≈
->
Tønsf‹m8x8Mode
)

289 
	`Re£tRD8x8D©a
(
p_Vid
, 
p_RDO
->
å8x8
);

290 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
TRUE
;

295 
block
 = 0; block < 4; block++)

297 
cuºSli˚
->
	`subma¸oblock_mode_decisi⁄
(
cuºMB
, &
íc_mb
, 
p_RDO
->
å8x8
,Ö_RDO->
cofAC8x8ts
[
block
], block, &
co°
);

298 if(!
cuºMB
->
vÆid_8x8
)

300 
	`£t_subblock8x8_öfo
(
b8x8öfo
, 
P8x8
, 
block
, 
p_RDO
->
å8x8
);

304 
cuºMB
->
vÆid_4x4
 = 
FALSE
;

305 i‡(
p_I≈
->
Tønsf‹m8x8Mode
 != 2)

307 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
FALSE
;

308 
	`Re£tRD8x8D©a
(
p_Vid
, 
p_RDO
->
å4x4
);

313 
block
 = 0; block < 4; block++)

315 
cuºSli˚
->
	`subma¸oblock_mode_decisi⁄
(
cuºMB
, &
íc_mb
, 
p_RDO
->
å4x4
,Ö_RDO->
c€fAC8x8
[
block
], block, &
co°
);

316 if(!
cuºMB
->
vÆid_4x4
)

318 
	`£t_subblock8x8_öfo
(
b8x8öfo
, 
P8x8
, 
block
, 
p_RDO
->
å4x4
);

322 i‡(
p_I≈
->
RCE«bÀ
)

323 
	`rc_°‹e_diff
(
cuºSli˚
->
diffy
, &
p_Vid
->
pCurImg
[
cuºMB
->
›ix_y
], cuºMB->
pix_x
, 
mb_¥ed
);

325 
p_Vid
->
giRDO±_B8O∆yFœg
 = 
FALSE
;

330 
mö_co°
 = 
DISTBLK_MAX
;

336 i‡(!
öãr_skù
)

338 if(
cuºSli˚
->
¶i˚_ty≥
 !
I_SLICE
 && cuºSli˚->¶i˚_ty≥ !
SI_SLICE
)

340 
cuºMB
->
mö_rdco°
 = 
RDCo°16
;

341 
cuºMB
->
be°_mode
 = (Ë
mode16
;

344 
cuºMB
->
mö_rdco°
 = 
max_rdco°
;

347 
max_ödex
 = ((!
öåa
 && 
p_I≈
->
Sñe˘iveI¡øE«bÀ
 ) ? 5 : 9);

350 
	`£t_chroma_¥ed_mode
(
cuºMB
, 
íc_mb
, 
mb_avaûabÀ
, 
chroma_¥ed_mode_ønge
);

355 
cuºMB
->
c_ùªd_mode
 = 
chroma_¥ed_mode_ønge
[0]; currMB->c_ipred_mode<=chroma_pred_mode_range[1]; currMB->c_ipred_mode++)

358 i‡–(
p_Vid
->
yuv_f‹m©
 !
YUV400
) &&

359 –((!
öåa
 || !
p_I≈
->
I¡øDißbÀI¡îO∆y
Ë&&Ö_I≈->
ChromaI¡øDißbÀ
 =1 && 
cuºMB
->
c_ùªd_mode
!=
DC_PRED_8
)

360 || (
cuºMB
->
c_ùªd_mode
 =
VERT_PRED_8
 && !
mb_avaûabÀ
[0])

361 || (
cuºMB
->
c_ùªd_mode
 =
HOR_PRED_8
 && !
mb_avaûabÀ
[1])

362 || (
cuºMB
->
c_ùªd_mode
 =
PLANE_8
 && (!
mb_avaûabÀ
[1] || !mb_available[0] || !mb_available[2]))))

366 
ödex
=0; index < 
max_ödex
; index++)

368 
mode
 = 
mb_mode_èbÀ
[
ödex
];

369 i‡(
mode
 == 1)

371 i‡(
íc_mb
.
vÆid
[
mode
])

373 i‡(
p_Vid
->
yuv_f‹m©
 !
YUV400
)

375 
cuºMB
->
i16mode
 = 0;

379 i‡(
cuºSli˚
->
P444_joöed
)

381 i‡(
p_I≈
->
SkùI¡øInI¡îSli˚s
 && !
öåa
 && 
mode
 >
I16MB


382 && 
cuºMB
->
be°_mode
 <=3 && cuºMB->
be°_cbp
 =0 && 
cuºSli˚
->
cmp_cbp
[1] =0 && cuºSli˚->cmp_cbp[2] =0 && (cuºMB->
mö_rdco°
 < 
	`weighãd_co°
(
íc_mb
.
œmbda_mdÂ
, 5)))

387 i‡(
p_I≈
->
SkùI¡øInI¡îSli˚s
 && !
öåa
 && 
mode
 >
I4MB
 && 
cuºMB
->
be°_mode
 <=3 && cuºMB->
be°_cbp
 =0 && (cuºMB->
mö_rdco°
 < 
	`weighãd_co°
(
íc_mb
.
œmbda_mdÂ
,5)))

391 
	`compuã_mode_RD_co°
(
cuºMB
, &
íc_mb
, (Ë
mode
, &
öãr_skù
);

398 if((
cuºSli˚
->
¶i˚_ty≥
 !
I_SLICE
 && cuºSli˚->¶i˚_ty≥ !
SI_SLICE
Ë&& 
p_I≈
->
Sñe˘iveI¡øE«bÀ
 && !
	`is_FREXT_¥ofûe
’_I≈->
ProfûeIDC
))

400 
	`Á°_mode_öåa_decisi⁄
(
cuºMB
, &
öåa_skù
);

402 if(!
öåa_skù
)

405 
	`£t_chroma_¥ed_mode
(
cuºMB
, 
íc_mb
, 
mb_avaûabÀ
, 
chroma_¥ed_mode_ønge
);

407 
max_ödex
 = 9;

409 
cuºMB
->
c_ùªd_mode
=
chroma_¥ed_mode_ønge
[0]; currMB->c_ipred_mode<=chroma_pred_mode_range[1]; currMB->c_ipred_mode++)

413 i‡–(
p_Vid
->
yuv_f‹m©
 !
YUV400
) &&

414 –((!
öåa
 || !
p_I≈
->
I¡øDißbÀI¡îO∆y
Ë&&Ö_I≈->
ChromaI¡øDißbÀ
 =1 && 
cuºMB
->
c_ùªd_mode
!=
DC_PRED_8
)

415 || (
cuºMB
->
c_ùªd_mode
 =
VERT_PRED_8
 && !
mb_avaûabÀ
[0])

416 || (
cuºMB
->
c_ùªd_mode
 =
HOR_PRED_8
 && !
mb_avaûabÀ
[1])

417 || (
cuºMB
->
c_ùªd_mode
 =
PLANE_8
 && (!
mb_avaûabÀ
[0] || !mb_available[1]|| !mb_available[2]))))

421 
ödex
 = 5; index < 
max_ödex
; index++)

423 
mode
 = 
mb_mode_èbÀ
[
ödex
];

426 i‡(
p_I≈
->
SkùI¡øInI¡îSli˚s
 && !
öåa
 && 
mode
 >
I4MB
 && 
cuºMB
->
be°_mode
 <=3 && cuºMB->
be°_cbp
 == 0)

429 i‡(
p_Vid
->
yuv_f‹m©
 !
YUV400
)

431 
cuºMB
->
i16mode
 = 0;

433 if(((
b¶i˚
 && 
mode
 =0Ë|| (!
i¶i˚
 && mode == 1)))

437 i‡(
íc_mb
.
vÆid
[
mode
])

438 
	`compuã_mode_RD_co°
(
cuºMB
, &
íc_mb
, (Ë
mode
, &
öãr_skù
);

444 
	`ª°‹e_nz_c€ff
(
cuºMB
);

448 
öåa1
 = 
	`is_öåa
(
cuºMB
);

452 
	`upd©e_qp_cbp_tmp
(
cuºMB
, 
p_RDO
->
cbp
);

453 
cuºSli˚
->
	`£t_°‹ed_mb_∑ømëîs
 (
cuºMB
);

456 if(
p_I≈
->
RCE«bÀ
 &&Ö_I≈->
RCUpd©eMode
 <
MAX_RC_MODE
)

457 
	`rc_°‹e_mad
(
cuºMB
);

460 i‡(
p_I≈
->
Re°ri˘Ref
)

461 
	`upd©e_ª‰esh_m≠
(
cuºMB
, 
öåa
, 
öåa1
);

463 
	}
}

	@lencod/src/md_highloss.c

11 
	~<m©h.h
>

12 
	~<limôs.h
>

13 
	~<Êﬂt.h
>

15 
	~"globÆ.h
"

16 
	~"rd›t_codög_°©e.h
"

17 
	~"öå¨e‰esh.h
"

18 
	~"image.h
"

19 
	~"øã˘l.h
"

20 
	~"mode_decisi⁄.h
"

21 
	~"mode_decisi⁄_p8x8.h
"

22 
	~"fmo.h
"

23 
	~"me_umhex.h
"

24 
	~"me_umhexsmp.h
"

25 
	~"ma¸oblock.h
"

26 
	~"md_comm⁄.h
"

27 
	~"c⁄f‹m™˚.h
"

28 
	~"vlc.h
"

29 
	~"rd›t.h
"

30 
	~"mv_£¨ch.h
"

38 
	$ícode_⁄e_ma¸oblock_highloss
 (
Ma¸oblock
 *
cuºMB
)

40 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

41 
RDOPTSåu˘uª
 *
p_RDO
 = 
cuºSli˚
->p_RDO;

42 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

43 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

44 
PicMŸi⁄P¨ams
 **
mŸi⁄
 = 
p_Vid
->
íc_pi˘uª
->
mv_öfo
;

46 
max_ödex
 = 9;

47 
ªrun
, 
block
, 
ödex
, 
mode
, 
i
, 
j
;

48 
RD_PARAMS
 
íc_mb
;

49 
di°blk
 
bmco°
[5] = {
DISTBLK_MAX
};

50 
di°blk
 
co°
=0;

51 
di°blk
 
mö_co°
 = 
DISTBLK_MAX
;

52 
öåa1
 = 0;

53 
mb_avaûabÀ
[3];

55 
b¶i˚
 = (Ë(
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
);

56 
p¶i˚
 = (Ë((
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
Ë|| (cuºSli˚->¶i˚_ty≥ =
SP_SLICE
));

57 
öåa
 = (Ë((
cuºSli˚
->
¶i˚_ty≥
 =
I_SLICE
Ë|| (cuºSli˚->¶i˚_ty≥ =
SI_SLICE
Ë|| (
p¶i˚
 && 
cuºMB
->
mb_y
 =
p_Vid
->
mb_y_upd
 &&Ö_Vid->mb_y_upd !p_Vid->
mb_y_öåa
));

58 
œmbda_mf
[3];

59 
runs
 = (Ë((
p_I≈
->
Re°ri˘Ref
==1 && (
p¶i˚
 || (
b¶i˚
 && 
p_Vid
->
«l_ª„ªn˚_idc
>0))) ? 2 : 1);

61 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_pred[0];

62 
Block8x8Info
 *
b8x8öfo
 = 
p_Vid
->b8x8info;

64 
chroma_¥ed_mode_ønge
[2];

65 
öãr_skù
 = 0;

66 
Be°Mode
 
md_be°
;

67 
Info8x8
 
be°
;

69 
	`öô_md_be°
(&
md_be°
);

72 
be°
.
pdú
 = 0;

73 
be°
.
bùªd
 = 0;

74 
be°
.
ªf
[
LIST_0
] = 0;

75 
be°
.
ªf
[
LIST_1
] = -1;

77 
öåa
 |
	`R™domI¡ø
 (
p_Vid
, 
cuºMB
->
mbAddrX
);

80 
	`öô_íc_mb_∑øms
(
cuºMB
, &
íc_mb
, 
öåa
);

83 
ªrun
=0;Ñîun<
runs
;Ñerun++)

85 i‡(
runs
==2)

86 
p_I≈
->
rd›t
(
ªrun
==0) ? 1 : 3;

88 i‡(
p_I≈
->
Ad≠tiveRoundög
)

90 
	`ª£t_ad≠tive_roundög
(
p_Vid
);

93 i‡(
cuºSli˚
->
mb_aff_‰ame_Êag
)

95 
	`ª£t_mb_nz_c€ff
(
p_Vid
, 
cuºMB
->
mbAddrX
);

100 
cuºSli˚
->
	`°‹e_codög_°©e
 (
cuºMB
, cuºSli˚->
p_RDO
->
cs_cm
);

102 i‡(!
öåa
)

105 i‡(
íc_mb
.
vÆid
[0])

107 i‡(
b¶i˚
)

108 
cuºSli˚
->
	`Gë_Dúe˘_MŸi⁄_Ve˘‹s
 (
cuºMB
);

110 
	`FödSkùModeMŸi⁄Ve˘‹
 (
cuºMB
);

112 i‡(
p_I≈
->
CtxAd±LagøngeMu…
 == 1)

114 
	`gë_öôül_mb16x16_co°
(
cuºMB
);

118 
mode
 = 1; mode < 4; mode++)

120 
be°
.
mode
 = () mode;

121 
be°
.
bùªd
 = 0;

122 
b8x8öfo
->
be°
[
mode
][0].
bùªd
 = 0;

124 i‡(
íc_mb
.
vÆid
[
mode
])

126 
co°
=0, 
block
=0; block<(
mode
==1?1:2); block++)

128 
	`upd©e_œmbda_co°s
(
cuºMB
, &
íc_mb
, 
œmbda_mf
);

129 
	`P¨tôi⁄MŸi⁄Sórch
 (
cuºMB
, 
mode
, 
block
, 
œmbda_mf
);

132 
j
 = (
block
==1 && 
mode
==2 ? 2 : 0);

133 
i
 = (
block
==1 && 
mode
==3 ? 2 : 0);

136 
bmco°
[
LIST_0
] = 
DISTBLK_MAX
;

137 
	`li°_¥edi˘i⁄_co°
(
cuºMB
, 
LIST_0
, 
block
, 
mode
, &
íc_mb
, 
bmco°
, 
be°
.
ªf
);

139 i‡(
b¶i˚
)

142 
bmco°
[
LIST_1
] = 
DISTBLK_MAX
;

143 
	`li°_¥edi˘i⁄_co°
(
cuºMB
, 
LIST_1
, 
block
, 
mode
, &
íc_mb
, 
bmco°
, 
be°
.
ªf
);

146 
	`li°_¥edi˘i⁄_co°
(
cuºMB
, 
BI_PRED
, 
block
, 
mode
, &
íc_mb
, 
bmco°
, 
be°
.
ªf
);

149 i‡(
	`is_bùªd_íabÀd
(
p_Vid
, 
mode
))

151 
	`gë_bùªd_co°
(
cuºMB
, 
mode
, 
block
, 
i
, 
j
, &
be°
, &
íc_mb
, 
bmco°
);

155 
bmco°
[
BI_PRED_L0
] = 
DISTBLK_MAX
;

156 
bmco°
[
BI_PRED_L1
] = 
DISTBLK_MAX
;

160 
	`dëîmöe_¥edi˘i⁄_li°
(
bmco°
, &
be°
, &
co°
);

164 
be°
.
pdú
 = 0;

165 
co°
 +
bmco°
[
LIST_0
];

168 
	`assign_íc_pi˘uª_∑øms
(
cuºMB
, 
mode
, &
be°
, 2 * 
block
);

171 
	`£t_block8x8_öfo
(
b8x8öfo
, 
mode
, 
block
, &
be°
);

174 i‡(
mode
>1 && 
block
==0)

175 
cuºSli˚
->
	`£t_ªf_™d_mŸi⁄_ve˘‹s
 (
cuºMB
, 
mŸi⁄
, &
be°
, 
block
);

177 i‡(
co°
 < 
mö_co°
)

179 
md_be°
.
mode
 = (
byã
) mode;

180 
md_be°
.
co°
 = cost;

181 
cuºMB
->
be°_mode
 = (Ë
mode
;

182 
mö_co°
 = 
co°
;

183 i‡(
p_I≈
->
CtxAd±LagøngeMu…
 == 1)

185 
	`adju°_mb16x16_co°
(
cuºMB
, 
co°
);

191 i‡(
íc_mb
.
vÆid
[
P8x8
])

193 
cuºMB
->
vÆid_8x8
 = 
FALSE
;

195 i‡(
p_I≈
->
Tønsf‹m8x8Mode
)

197 
	`Re£tRD8x8D©a
(
p_Vid
, 
p_RDO
->
å8x8
);

198 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
TRUE
;

203 
block
 = 0; block < 4; block++)

205 
cuºSli˚
->
	`subma¸oblock_mode_decisi⁄
(
cuºMB
, &
íc_mb
, 
p_RDO
->
å8x8
,Ö_RDO->
cofAC8x8ts
[
block
], block, &
co°
);

206 if(!
cuºMB
->
vÆid_8x8
)

208 
	`£t_subblock8x8_öfo
(
b8x8öfo
, 
P8x8
, 
block
, 
p_RDO
->
å8x8
);

212 
cuºMB
->
vÆid_4x4
 = 
FALSE
;

213 i‡(
p_I≈
->
Tønsf‹m8x8Mode
 != 2)

215 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
FALSE
;

216 
	`Re£tRD8x8D©a
(
p_Vid
, 
p_RDO
->
å4x4
);

221 
block
 = 0; block < 4; block++)

223 
cuºSli˚
->
	`subma¸oblock_mode_decisi⁄
(
cuºMB
, &
íc_mb
, 
p_RDO
->
å4x4
,Ö_RDO->
c€fAC8x8
[
block
], block, &
co°
);

224 if(!
cuºMB
->
vÆid_4x4
)

226 
	`£t_subblock8x8_öfo
(
b8x8öfo
, 
P8x8
, 
block
, 
p_RDO
->
å4x4
);

231 i‡(
p_I≈
->
RCE«bÀ
)

232 
	`rc_°‹e_diff
(
cuºSli˚
->
diffy
, &
p_Vid
->
pCurImg
[
cuºMB
->
›ix_y
], cuºMB->
pix_x
, 
mb_¥ed
);

234 
p_Vid
->
giRDO±_B8O∆yFœg
 = 
FALSE
;

239 
mö_co°
 = 
DISTBLK_MAX
;

243 
	`£t_chroma_¥ed_mode
(
cuºMB
, 
íc_mb
, 
mb_avaûabÀ
, 
chroma_¥ed_mode_ønge
);

247 
cuºMB
->
c_ùªd_mode
 = 
chroma_¥ed_mode_ønge
[0]; currMB->c_ipred_mode<=chroma_pred_mode_range[1]; currMB->c_ipred_mode++)

250 i‡–(
p_Vid
->
yuv_f‹m©
 !
YUV400
) &&

251 –((!
öåa
 || !
p_I≈
->
I¡øDißbÀI¡îO∆y
Ë&&Ö_I≈->
ChromaI¡øDißbÀ
 =1 && 
cuºMB
->
c_ùªd_mode
!=
DC_PRED_8
)

252 || (
cuºMB
->
c_ùªd_mode
 =
VERT_PRED_8
 && !
mb_avaûabÀ
[0])

253 || (
cuºMB
->
c_ùªd_mode
 =
HOR_PRED_8
 && !
mb_avaûabÀ
[1])

254 || (
cuºMB
->
c_ùªd_mode
 =
PLANE_8
 && (!
mb_avaûabÀ
[1] || !mb_available[0] || !mb_available[2]))))

258 
ödex
=0; index < 
max_ödex
; index++)

260 
mode
 = 
mb_mode_èbÀ
[
ödex
];

261 i‡(
íc_mb
.
vÆid
[
mode
])

263 i‡(
p_Vid
->
yuv_f‹m©
 !
YUV400
)

265 
cuºMB
->
i16mode
 = 0;

269 i‡(
cuºSli˚
->
P444_joöed
)

271 i‡(
p_I≈
->
SkùI¡øInI¡îSli˚s
 && !
öåa
 && 
mode
 >
I16MB


272 && 
cuºMB
->
be°_mode
 <=3 && cuºMB->
be°_cbp
 =0 && 
cuºSli˚
->
cmp_cbp
[1] =0 && cuºSli˚->cmp_cbp[2] =0 && (cuºMB->
mö_rdco°
 < 
	`weighãd_co°
(
íc_mb
.
œmbda_mdÂ
,5)))

277 i‡(
p_I≈
->
SkùI¡øInI¡îSli˚s
)

279 i‡(!
öåa
 && 
mode
 >
I4MB
)

281 i‡(
cuºMB
->
be°_mode
 <=3 && cuºMB->
be°_cbp
 =0 && (cuºMB->
mö_rdco°
 < 
	`weighãd_co°
(
íc_mb
.
œmbda_mdÂ
, 5)))

285 i‡(
cuºMB
->
be°_mode
 =0 && (cuºMB->
mö_rdco°
 < 
	`weighãd_co°
(
íc_mb
.
œmbda_mdÂ
,6)))

292 
	`compuã_mode_RD_co°
(
cuºMB
, &
íc_mb
, (Ë
mode
, &
öãr_skù
);

298 
	`ª°‹e_nz_c€ff
(
cuºMB
);

300 i‡(
ªrun
==0)

301 
öåa1
 = 
	`is_öåa
(
cuºMB
);

306 
	`upd©e_qp_cbp_tmp
(
cuºMB
, 
p_RDO
->
cbp
);

307 
cuºSli˚
->
	`£t_°‹ed_mb_∑ømëîs
 (
cuºMB
);

310 if(
p_I≈
->
RCE«bÀ
 &&Ö_I≈->
RCUpd©eMode
 <
MAX_RC_MODE
)

311 
	`rc_°‹e_mad
(
cuºMB
);

314 i‡(
p_I≈
->
Re°ri˘Ref
)

315 
	`upd©e_ª‰esh_m≠
(
cuºMB
, 
öåa
, 
öåa1
);

316 
	}
}

	@lencod/src/md_low.c

12 
	~<m©h.h
>

13 
	~<limôs.h
>

14 
	~<Êﬂt.h
>

16 
	~"globÆ.h
"

17 
	~"rd›t_codög_°©e.h
"

18 
	~"mb_ac˚ss.h
"

19 
	~"öå¨e‰esh.h
"

20 
	~"image.h
"

21 
	~"å™sf‹m8x8.h
"

22 
	~"øã˘l.h
"

23 
	~"mode_decisi⁄.h
"

24 
	~"mode_decisi⁄_p8x8.h
"

25 
	~"fmo.h
"

26 
	~"me_umhex.h
"

27 
	~"me_umhexsmp.h
"

28 
	~"ma¸oblock.h
"

29 
	~"q_¨ound.h
"

30 
	~"vlc.h
"

31 
	~"md_comm⁄.h
"

32 
	~"rd›t.h
"

33 
	~"memÆloc.h
"

34 
	~"mc_¥edi˘i⁄.h
"

35 
	~"rd_öåa_jm.h
"

43 
	$gë_be°_å™sf‹m_8x8
(
Ma¸oblock
 *
cuºMB
)

45 if(
cuºMB
->
p_I≈
->
Tønsf‹m8x8Mode
 == 2)

49 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

50 
RDOPTSåu˘uª
 *
p_RDO
 = 
cuºMB
->
p_Sli˚
->p_RDO;

52 
diff16
[4][16];

53 
diff64
[64];

54 
pic_pix_y
, 
pic_pix_x
, 
i
, 
j
;

55 
mb_y
, 
mb_x
, 
block8x8
;

56 
di°blk
 
co°8x8
=0, 
co°4x4
=0;

58 
block8x8
 = 0; block8x8 < 4; block8x8++)

60 *
tmp64
 = 
diff64
;

61 *
tmp16
[4];

62 
sour˚_≥l
, 
ödex
;

64 
tmp16
[0] = 
diff16
[0];

65 
tmp16
[1] = 
diff16
[1];

66 
tmp16
[2] = 
diff16
[2];

67 
tmp16
[3] = 
diff16
[3];

69 
mb_y
 = (
block8x8
 >> 1) << 3;

70 
mb_x
 = (
block8x8
 & 0x01) << 3;

73 
pic_pix_y
 = 
cuºMB
->
›ix_y
;

74 
pic_pix_x
 = 
cuºMB
->
pix_x
;

76 
j
 = 
mb_y
; j < 8 + mb_y; j++)

78 
i
 = 
mb_x
; i < 8 + mb_x; i++)

80 
ödex
 = (Ë(2 * ((
j
 - 
mb_y
)> 3Ë+ ((
i
 - 
mb_x
)> 3));

81 
sour˚_≥l
 = 
p_Vid
->
pCurImg
[
pic_pix_y
 + 
j
][
pic_pix_x
 + 
i
];

82 *(
tmp16
[
ödex
])++ = (Ë(
sour˚_≥l
 - 
p_RDO
->
å4x4
->
m¥8x8
[
j
][
i
]);

83 *
tmp64
++ = (Ë(
sour˚_≥l
 - 
p_RDO
->
å8x8
->
m¥8x8
[
j
][
i
]);

87 
co°4x4
 +
p_Vid
->
	`di°‹ti⁄4x4
 (
diff16
[0], 
DISTBLK_MAX
);

88 
co°4x4
 +
p_Vid
->
	`di°‹ti⁄4x4
 (
diff16
[1], 
DISTBLK_MAX
);

89 
co°4x4
 +
p_Vid
->
	`di°‹ti⁄4x4
 (
diff16
[2], 
DISTBLK_MAX
);

90 
co°4x4
 +
p_Vid
->
	`di°‹ti⁄4x4
 (
diff16
[3], 
DISTBLK_MAX
);

91 
co°8x8
 +
p_Vid
->
	`di°‹ti⁄8x8
 (
diff64
 , 
DISTBLK_MAX
);

94  (
co°8x8
 < 
co°4x4
);

96 
	}
}

104 
	$ícode_⁄e_ma¸oblock_low
 (
Ma¸oblock
 *
cuºMB
)

106 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

107 
RDOPTSåu˘uª
 *
p_RDO
 = 
cuºSli˚
->p_RDO;

108 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

109 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

110 
PicMŸi⁄P¨ams
 **
mŸi⁄
 = 
p_Vid
->
íc_pi˘uª
->
mv_öfo
;

112 
img≥l
 ***
ãmp_img
;

114 
block
, 
mode
, 
j
;

115 
RD_PARAMS
 
íc_mb
;

116 
di°blk
 
bmco°
[5] = {
DISTBLK_MAX
};

117 
di°blk
 
rd_co°
 = 0;

118 
di°blk
 
co°
 = 0;

119 
di°blk
 
mö_co°
 = 
DISTBLK_MAX
;

120 
di°blk
 
co°_dúe˘
=0;

121 
di°blk
 
co°8x8_dúe˘
 = 0;

122 
have_dúe˘
=0;

123 
öåa1
 = 0;

124 
ãmp_˝b
 = 0;

125 
byã
 
be°_å™sf‹m_Êag
 = (byte) 0;

126 
i¶i˚
 = (Ë(
cuºSli˚
->
¶i˚_ty≥
 =
I_SLICE
);

127 
b¶i˚
 = (Ë(
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
);

128 
p¶i˚
 = (Ë((
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
Ë|| (cuºSli˚->¶i˚_ty≥ =
SP_SLICE
));

129 
öåa
 = (Ë(
i¶i˚
 || (
cuºSli˚
->
¶i˚_ty≥
 =
SI_SLICE
Ë|| (
p¶i˚
 && 
cuºMB
->
mb_y
 =
p_Vid
->
mb_y_upd
 &&Ö_Vid->mb_y_upd!ı_Vid->
mb_y_öåa
));

130 
œmbda_mf
[3];

131 
Block8x8Info
 *
b8x8öfo
 = 
p_Vid
->b8x8info;

134 **
ùªdmodes
 = 
p_Vid
->
ùªdmode
;

135 
MŸi⁄Ve˘‹
 *
Ælmvs
 = (
cuºSli˚
->
¶i˚_ty≥
 =
I_SLICE
 || (cuºSli˚->¶i˚_ty≥ =
SI_SLICE
)Ë? 
NULL
: &cuºSli˚->
Æl_mv
[0][0][0][0][0];

136 ****
i4p
;

137 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_pred[0];

139 
byã
 
tmp_8x8_Êag
, 
tmp_no_mb∑π
;

141 
Be°Mode
 
md_be°
;

142 
Info8x8
 
be°
 = 
	`öô_öfo_8x8_°ru˘
();

144 
	`öô_md_be°
(&
md_be°
);

146 
	`gë_mem3D≥l
(&
ãmp_img
, 3, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE);

148 
öåa
 |
	`R™domI¡ø
 (
p_Vid
, 
cuºMB
->
mbAddrX
);

149 #i‡(
MVC_EXTENSION_ENABLE
)

150 if(
p_I≈
->
num_of_võws
==2)

151 
öåa
 |(
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
]==0 && cuºSli˚->num_ªf_idx_a˘ive[
LIST_1
]==0);

155 
	`öô_íc_mb_∑øms
(
cuºMB
, &
íc_mb
, 
öåa
);

156 i‡(
p_I≈
->
Ad≠tiveRoundög
)

158 
	`ª£t_ad≠tive_roundög
(
p_Vid
);

161 i‡(
cuºSli˚
->
mb_aff_‰ame_Êag
)

163 
	`ª£t_mb_nz_c€ff
(
p_Vid
, 
cuºMB
->
mbAddrX
);

168 
cuºSli˚
->
	`°‹e_codög_°©e
 (
cuºMB
, cuºSli˚->
p_RDO
->
cs_cm
);

170 i‡(!
öåa
)

173 
cuºMB
->
be°_mode
 = 10;

174 i‡(
b¶i˚
 && 
íc_mb
.
vÆid
[0])

176 
cuºSli˚
->
	`Gë_Dúe˘_MŸi⁄_Ve˘‹s
 (
cuºMB
);

179 i‡(
p_I≈
->
CtxAd±LagøngeMu…
 == 1)

181 
	`gë_öôül_mb16x16_co°
(
cuºMB
);

185 
mode
 = 1; mode < 4; mode++)

187 
be°
.
bùªd
 = 0;

188 
be°
.
mode
 = () mode;

189 
b8x8öfo
->
be°
[
mode
][0].
bùªd
 = 0;

190 i‡(
íc_mb
.
vÆid
[
mode
])

192 
co°
=0, 
block
=0; block<(
mode
==1?1:2); block++)

194 
	`upd©e_œmbda_co°s
(
cuºMB
, &
íc_mb
, 
œmbda_mf
);

195 
	`P¨tôi⁄MŸi⁄Sórch
 (
cuºMB
, 
mode
, 
block
, 
œmbda_mf
);

198 
j
 = (
block
==1 && 
mode
==2 ? 2 : 0);

201 
bmco°
[
LIST_0
] = 
DISTBLK_MAX
;

202 
	`li°_¥edi˘i⁄_co°
(
cuºMB
, 
LIST_0
, 
block
, 
mode
, &
íc_mb
, 
bmco°
, 
be°
.
ªf
);

204 i‡(
b¶i˚
)

207 
bmco°
[
LIST_1
] = 
DISTBLK_MAX
;

208 
	`li°_¥edi˘i⁄_co°
(
cuºMB
, 
LIST_1
, 
block
, 
mode
, &
íc_mb
, 
bmco°
, 
be°
.
ªf
);

211 
	`li°_¥edi˘i⁄_co°
(
cuºMB
, 
BI_PRED
, 
block
, 
mode
, &
íc_mb
, 
bmco°
, 
be°
.
ªf
);

214 i‡(
	`is_bùªd_íabÀd
(
p_Vid
, 
mode
))

216 
	`li°_¥edi˘i⁄_co°
(
cuºMB
, 
BI_PRED_L0
, 
block
, 
mode
, &
íc_mb
, 
bmco°
, 0);

217 
	`li°_¥edi˘i⁄_co°
(
cuºMB
, 
BI_PRED_L1
, 
block
, 
mode
, &
íc_mb
, 
bmco°
, 0);

221 
bmco°
[
BI_PRED_L0
] = 
DISTBLK_MAX
;

222 
bmco°
[
BI_PRED_L1
] = 
DISTBLK_MAX
;

226 
	`dëîmöe_¥edi˘i⁄_li°
(
bmco°
, &
be°
, &
co°
);

230 
be°
.
pdú
 = 0;

231 
co°
 +
bmco°
[
LIST_0
];

234 
	`assign_íc_pi˘uª_∑øms
(
cuºMB
, 
mode
, &
be°
, 2 * 
block
);

237 
	`£t_block8x8_öfo
(
b8x8öfo
, 
mode
, 
block
, &
be°
);

240 i‡(
mode
>1 && 
block
==0)

241 
cuºSli˚
->
	`£t_ªf_™d_mŸi⁄_ve˘‹s
 (
cuºMB
, 
mŸi⁄
, &
be°
, 
block
);

244 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
FALSE
;

245 i‡(
p_I≈
->
Tønsf‹m8x8Mode
)

247 
cuºSli˚
->
	`£t_modes_™d_ªfs_f‹_blocks
(
cuºMB
, (Ë
mode
);

248 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = (
byã
Ë
	`å™sf‹m_decisi⁄
(cuºMB, -1, &
co°
);

251 i‡(
co°
 < 
mö_co°
)

253 
cuºMB
->
be°_mode
 = (Ë
mode
;

254 
mö_co°
 = 
co°
;

255 
be°_å™sf‹m_Êag
 = 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
;

257 i‡(
p_I≈
->
CtxAd±LagøngeMu…
 == 1)

259 
	`adju°_mb16x16_co°
(
cuºMB
, 
co°
);

265 i‡(
íc_mb
.
vÆid
[
P8x8
])

268 
cuºSli˚
->
	`°‹e_codög_°©e
 (
cuºMB
, cuºSli˚->
p_RDO
->
cs_mb
);

269 
	`mem£t
–
cuºSli˚
->
cofAC
[0][0][0], 0, 2080 * ());

271 
cuºMB
->
vÆid_8x8
 = 
FALSE
;

273 i‡(
p_I≈
->
Tønsf‹m8x8Mode
)

275 
	`Re£tRD8x8D©a
(
p_Vid
, 
p_RDO
->
å8x8
);

280 
co°_dúe˘
 = 0, 
block
 = 0; block < 4; block++)

282 
	`subma¸oblock_mode_decisi⁄_low
(
cuºMB
, &
íc_mb
, 
p_RDO
->
å8x8
,Ö_RDO->
cofAC8x8ts
[
block
],

283 &
have_dúe˘
, 
block
, &
co°_dúe˘
, &
co°
, &
co°8x8_dúe˘
, 1);

285 
	`£t_subblock8x8_öfo
(
b8x8öfo
, 
P8x8
, 
block
, 
p_RDO
->
å8x8
);

288 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
FALSE
;

292 i‡(
p_I≈
->
Tønsf‹m8x8Mode
 != 2)

294 
	`Re£tRD8x8D©a
(
p_Vid
, 
p_RDO
->
å4x4
);

299 
co°_dúe˘
 = 0, 
block
=0; block<4; block++)

301 
	`subma¸oblock_mode_decisi⁄_low
(
cuºMB
, &
íc_mb
, 
p_RDO
->
å4x4
,Ö_RDO->
c€fAC8x8
[
block
],

302 &
have_dúe˘
, 
block
, &
co°_dúe˘
, &
co°
, &
co°8x8_dúe˘
, 0);

304 
	`£t_subblock8x8_öfo
(
b8x8öfo
, 
P8x8
, 
block
, 
p_RDO
->
å4x4
);

308 i‡(
p_I≈
->
RCE«bÀ
)

309 
	`rc_°‹e_diff
(
cuºSli˚
->
diffy
, &
p_Vid
->
pCurImg
[
cuºMB
->
›ix_y
], cuºMB->
pix_x
, 
mb_¥ed
);

312 i‡(((
p_I≈
->
Tønsf‹m8x8Mode
 < 2Ë&& (
p_RDO
->
å4x4
->
mb_p8x8_co°
 < 
mö_co°
)) ||

313 ((
p_I≈
->
Tønsf‹m8x8Mode
 > 0Ë&& (
p_RDO
->
å8x8
->
mb_p8x8_co°
 < 
mö_co°
)))

315 
cuºMB
->
be°_mode
 = 
P8x8
;

316 i‡(
p_I≈
->
Tønsf‹m8x8Mode
 == 2)

318 
mö_co°
 = 
p_RDO
->
å8x8
->
mb_p8x8_co°
;

319 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
TRUE
;

321 i‡(
p_I≈
->
Tønsf‹m8x8Mode
)

323 i‡(
p_RDO
->
å8x8
->
mb_p8x8_co°
 <Ö_RDO->
å4x4
->mb_p8x8_cost)

325 
mö_co°
 = 
p_RDO
->
å8x8
->
mb_p8x8_co°
;

326 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
TRUE
;

328 if(
p_RDO
->
å4x4
->
mb_p8x8_co°
 <Ö_RDO->
å8x8
->mb_p8x8_cost)

330 
mö_co°
 = 
p_RDO
->
å4x4
->
mb_p8x8_co°
;

331 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
FALSE
;

335 i‡(
	`gë_be°_å™sf‹m_8x8
(
cuºMB
) == 0)

337 
mö_co°
 = 
p_RDO
->
å4x4
->
mb_p8x8_co°
;

338 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
FALSE
;

342 
mö_co°
 = 
p_RDO
->
å8x8
->
mb_p8x8_co°
;

343 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
TRUE
;

349 
mö_co°
 = 
p_RDO
->
å4x4
->
mb_p8x8_co°
;

350 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
FALSE
;

353 
p_Vid
->
giRDO±_B8O∆yFœg
 = 
FALSE
;

357 if(
p¶i˚
)

358 
	`FödSkùModeMŸi⁄Ve˘‹
 (
cuºMB
);

362 
mö_co°
 = 
DISTBLK_MAX
;

368 
tmp_8x8_Êag
 = 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
;

369 
tmp_no_mb∑π
 = 
cuºMB
->
NoMbP¨tLessTh™8x8Fœg
;

370 i‡((
p_Vid
->
yuv_f‹m©
 !
YUV400
Ë&& (p_Vid->yuv_f‹m© !
YUV444
))

372 
cuºSli˚
->
	`öåa_chroma_¥edi˘i⁄
(
cuºMB
, 
NULL
, NULL, NULL);

374 i‡(
íc_mb
.
vÆid
[0] && 
b¶i˚
)

376 if(
have_dúe˘
)

378 
p_I≈
->
Tønsf‹m8x8Mode
)

381 
co°
 = ((
co°8x8_dúe˘
 < 
co°_dúe˘
Ë|| !(
íc_mb
.
vÆid
[5] &&Énc_mb.valid[6] &&Énc_mb.valid[7]))

382 ? 
co°8x8_dúe˘
 : 
co°_dúe˘
;

385 
co°
 = 
co°8x8_dúe˘
;

388 
co°
 = 
co°_dúe˘
;

394 
co°
 = 
	`GëDúe˘Co°MB
 (
cuºMB
);

396 i‡(
co°
!=
DISTBLK_MAX
)

398 
co°
 -
	`weighãd_co°
(
íc_mb
.
œmbda_mdÂ
, 16);

401 i‡(
co°
 <
mö_co°
)

403 if(
p_Vid
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
 && 
p_I≈
->
Tønsf‹m8x8Mode
)

405 if(
p_I≈
->
Tønsf‹m8x8Mode
==2)

406 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
TRUE
;

409 if(
co°8x8_dúe˘
 < 
co°_dúe˘
)

410 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
TRUE
;

412 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
FALSE
;

416 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
FALSE
;

419 i‡(
p_I≈
->
RCE«bÀ
)

420 
	`rc_°‹e_diff
(
cuºSli˚
->
diffy
, &
p_Vid
->
pCurImg
[
cuºMB
->
›ix_y
], cuºMB->
pix_x
, 
mb_¥ed
);

422 
mö_co°
 = 
co°
;

423 
cuºMB
->
be°_mode
 = 0;

424 
tmp_8x8_Êag
 = 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
;

428 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
tmp_8x8_Êag
;

429 
cuºMB
->
NoMbP¨tLessTh™8x8Fœg
 = 
tmp_no_mb∑π
;

432 
cuºMB
->
mö_rdco°
 = 
mö_co°
;

433 i‡(
íc_mb
.
vÆid
[
I8MB
])

435 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
TRUE
;

437 
cuºMB
->
mb_ty≥
 = cuºMB->
¨_mode
 = 
I8MB
;

438 
ãmp_˝b
 = 
	`mode_decisi⁄_f‹_I8x8_MB
 (
cuºMB
, 
íc_mb
.
œmbda_mdÂ
, &
rd_co°
);

440 i‡(
rd_co°
 <
cuºMB
->
mö_rdco°
)

442 
cuºMB
->
cbp
 = 
ãmp_˝b
;

443 i‡(
p_Vid
->
P444_joöed
)

445 
cuºSli˚
->
cuº_cbp
[0] = cuºSli˚->
cmp_cbp
[1];

446 
cuºSli˚
->
cuº_cbp
[1] = cuºSli˚->
cmp_cbp
[2];

449 if(
íc_mb
.
vÆid
[
I4MB
])

452 i‡(
p_I≈
->
Tønsf‹m8x8Mode
 != 2)

454 
i4p
 = 
p_RDO
->
cofAC
;

455 
p_RDO
->
cofAC
 = 
cuºSli˚
->cofAC;

456 
cuºSli˚
->
cofAC
 = 
i4p
;

460 
	`c›y_image_d©a_16x16
(
ãmp_img
[0], &
p_Vid
->
íc_pi˘uª
->
imgY
[
cuºMB
->
pix_y
], 0, cuºMB->
pix_x
);

462 i‡(
p_Vid
->
P444_joöed
)

464 
	`c›y_image_d©a_16x16
(
ãmp_img
[1], &
p_Vid
->
íc_pi˘uª
->
imgUV
[0][
cuºMB
->
pix_y
], 0, cuºMB->
pix_x
);

465 
	`c›y_image_d©a_16x16
(
ãmp_img
[2], &
p_Vid
->
íc_pi˘uª
->
imgUV
[1][
cuºMB
->
pix_y
], 0, cuºMB->
pix_x
);

469 i‡(
p_I≈
->
RCE«bÀ
)

470 
	`rc_°‹e_diff
(
cuºSli˚
->
diffy
, &
p_Vid
->
pCurImg
[
cuºMB
->
›ix_y
], cuºMB->
pix_x
, 
mb_¥ed
);

472 
cuºMB
->
mö_rdco°
 = 
rd_co°
;

473 
cuºMB
->
be°_mode
 = 
I8MB
;

474 
tmp_8x8_Êag
 = 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
;

478 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
tmp_8x8_Êag
;

479 i‡(
p_Vid
->
P444_joöed
)

481 
cuºMB
->
cbp
 |
cuºSli˚
->
cuº_cbp
[0];

482 
cuºMB
->
cbp
 |
cuºSli˚
->
cuº_cbp
[1];

483 
cuºSli˚
->
cmp_cbp
[1] = 
cuºMB
->
cbp
;

484 
cuºSli˚
->
cmp_cbp
[2] = 
cuºMB
->
cbp
;

489 i‡(
íc_mb
.
vÆid
[
I4MB
])

491 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
FALSE
;

492 
cuºMB
->
mb_ty≥
 = cuºMB->
¨_mode
 = 
I4MB
;

493 
ãmp_˝b
 = 
	`mode_decisi⁄_f‹_I4x4_MB
 (
cuºMB
, 
íc_mb
.
œmbda_mdÂ
, &
rd_co°
);

494 i‡(
rd_co°
 <
cuºMB
->
mö_rdco°
)

496 
cuºMB
->
cbp
 = 
ãmp_˝b
;

499 i‡(
p_I≈
->
RCE«bÀ
)

500 
	`rc_°‹e_diff
(
cuºSli˚
->
diffy
, &
p_Vid
->
pCurImg
[
cuºMB
->
›ix_y
], cuºMB->
pix_x
, 
mb_¥ed
);

502 
cuºMB
->
mö_rdco°
 = 
rd_co°
;

503 
cuºMB
->
be°_mode
 = 
I4MB
;

504 
tmp_8x8_Êag
 = 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
;

508 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
tmp_8x8_Êag
;

509 i‡(
p_Vid
->
P444_joöed
)

511 
cuºMB
->
cbp
 |
cuºSli˚
->
cuº_cbp
[0];

512 
cuºMB
->
cbp
 |
cuºSli˚
->
cuº_cbp
[1];

513 
cuºSli˚
->
cmp_cbp
[1] = 
cuºMB
->
cbp
;

514 
cuºSli˚
->
cmp_cbp
[2] = 
cuºMB
->
cbp
;

517 
i4p
 = 
p_RDO
->
cofAC
;

518 
p_RDO
->
cofAC
 = 
cuºSli˚
->cofAC;

519 
cuºSli˚
->
cofAC
=
i4p
;

522 i‡(
íc_mb
.
vÆid
[
I16MB
])

524 
rd_co°
 = 
	`föd_be°_mode_I16x16_MB
 (
cuºMB
, 
íc_mb
.
œmbda_mdÂ
, cuºMB->
mö_rdco°
);

526 i‡(
rd_co°
 < 
cuºMB
->
mö_rdco°
)

529 i‡(
p_I≈
->
RCE«bÀ
)

530 
	`rc_°‹e_diff
(
cuºSli˚
->
diffy
, &
p_Vid
->
pCurImg
[
cuºMB
->
›ix_y
], cuºMB->
pix_x
, cuºSli˚->
m¥_16x16
[0][(ËcuºMB->
i16mode
]);

532 
cuºMB
->
be°_mode
 = 
I16MB
;

533 
cuºMB
->
mö_rdco°
 = 
rd_co°
;

534 
cuºMB
->
cbp
 = cuºMB->
	`ªsiduÆ_å™sf‹m_qu™t_luma_16x16
 (cuºMB, 
PLANE_Y
);

536 i‡(
p_Vid
->
P444_joöed
)

538 
	`£À˘_∂™e
(
p_Vid
, 
PLANE_U
);

539 
cuºSli˚
->
cmp_cbp
[1] = 
cuºMB
->
	`ªsiduÆ_å™sf‹m_qu™t_luma_16x16
(cuºMB, 
PLANE_U
);

540 
	`£À˘_∂™e
(
p_Vid
, 
PLANE_V
);

541 
cuºSli˚
->
cmp_cbp
[2] = 
cuºMB
->
	`ªsiduÆ_å™sf‹m_qu™t_luma_16x16
(cuºMB, 
PLANE_V
);

543 
	`£À˘_∂™e
(
p_Vid
, 
PLANE_Y
);

544 
cuºMB
->
cbp
 |
cuºSli˚
->
cmp_cbp
[1];

545 
cuºMB
->
cbp
 |
cuºSli˚
->
cmp_cbp
[2];

546 
cuºSli˚
->
cmp_cbp
[1] = 
cuºMB
->
cbp
;

547 
cuºSli˚
->
cmp_cbp
[2] = 
cuºMB
->
cbp
;

553 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
tmp_8x8_Êag
;

554 
cuºMB
->
NoMbP¨tLessTh™8x8Fœg
 = 
tmp_no_mb∑π
;

558 
öåa1
 = 
	`is_öåa
(
cuºMB
);

564 
cuºSli˚
->
	`£t_modes_™d_ªfs_f‹_blocks
 (
cuºMB
, cuºMB->
be°_mode
);

566 i‡(
cuºMB
->
be°_mode
 =
P8x8
)

568 i‡(
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 && (
p_RDO
->
å8x8
->
cbp8x8
 =0Ë&& 
p_I≈
->
Tønsf‹m8x8Mode
 != 2)

569 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
FALSE
;

571 
cuºSli˚
->
	`£t_c€ff_™d_ªc⁄_8x8
 (
cuºMB
);

573 
	`mem£t
(
cuºMB
->
öåa_¥ed_modes
, 
DC_PRED
, 
MB_BLOCK_PARTITIONS
 * ());

574 
j
 = 
cuºMB
->
block_y
; j < cuºMB->block_y + 
BLOCK_MULTIPLE
; j++)

575 
	`mem£t
(&
ùªdmodes
[
j
][
cuºMB
->
block_x
], 
DC_PRED
, 
BLOCK_MULTIPLE
 * ());

580 i‡(
cuºMB
->
be°_mode
 =
I8MB
)

582 
	`mem˝y
(
cuºMB
->
öåa_¥ed_modes
,cuºMB->
öåa_¥ed_modes8x8
, 
MB_BLOCK_PARTITIONS
 * ());

583 
j
 = 
cuºMB
->
block_y
; j < cuºMB->block_y + 
BLOCK_MULTIPLE
; j++)

584 
	`mem˝y
(&
p_Vid
->
ùªdmode
[
j
][
cuºMB
->
block_x
],&p_Vid->
ùªdmode8x8
[j][cuºMB->block_x], 
BLOCK_MULTIPLE
 * ());

587 
	`c›y_image_d©a_16x16
(&
p_Vid
->
íc_pi˘uª
->
imgY
[
cuºMB
->
pix_y
], 
ãmp_img
[0], cuºMB->
pix_x
, 0);

589 i‡(
p_Vid
->
P444_joöed
)

591 
	`c›y_image_d©a_16x16
(&
p_Vid
->
íc_pi˘uª
->
imgUV
[0][
cuºMB
->
pix_y
], 
ãmp_img
[1], cuºMB->
pix_x
, 0);

592 
	`c›y_image_d©a_16x16
(&
p_Vid
->
íc_pi˘uª
->
imgUV
[1][
cuºMB
->
pix_y
], 
ãmp_img
[2], cuºMB->
pix_x
, 0);

596 i‡((
cuºMB
->
be°_mode
!=
I4MB
)&&(cuºMB->be°_modê!
I8MB
))

598 
	`mem£t
(
cuºMB
->
öåa_¥ed_modes
,
DC_PRED
, 
MB_BLOCK_PARTITIONS
 * ());

599 
j
 = 
cuºMB
->
block_y
; j < cuºMB->block_y + 
BLOCK_MULTIPLE
; j++)

600 
	`mem£t
(&
ùªdmodes
[
j
][
cuºMB
->
block_x
],
DC_PRED
, 
BLOCK_MULTIPLE
 * ());

601 
cuºMB
->
¨_mode
 = cuºMB->
be°_mode
;

603 i‡(
cuºMB
->
be°_mode
!=
I16MB
)

605 if((
cuºMB
->
be°_mode
 >= 1) && (currMB->best_mode <= 3))

606 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
be°_å™sf‹m_Êag
;

608 
cuºSli˚
->
	`luma_ªsiduÆ_codög
(
cuºMB
);

609 i‡(
cuºSli˚
->
P444_joöed
)

611 if((
cuºMB
->
cbp
==0 && 
cuºSli˚
->
cmp_cbp
[1] =0 && cuºSli˚->cmp_cbp[2] =0Ë&&(cuºMB->
be°_mode
 == 0))

612 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
FALSE
;

616 if((
cuºMB
->
cbp
==0)&&(cuºMB->
be°_mode
 == 0))

617 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
FALSE
;

621 i‡(
p_I≈
->
RCE«bÀ
)

622 
	`rc_°‹e_diff
(
cuºSli˚
->
diffy
, &
p_Vid
->
pCurImg
[
cuºMB
->
›ix_y
], cuºMB->
pix_x
, 
mb_¥ed
);

627 i‡(((
cuºMB
->
cbp
&15Ë=0Ë&& cuºMB->
mb_ty≥
 !
I4MB
 && cuºMB->mb_ty≥ !
I8MB
)

628 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
FALSE
;

631 i‡((
p_Vid
->
yuv_f‹m©
 !
YUV400
Ë&& (p_Vid->yuv_f‹m© !
YUV444
))

632 
cuºSli˚
->
	`öåa_chroma_¥edi˘i⁄
(
cuºMB
, 
NULL
, NULL, NULL);

634 
cuºMB
->
i16off£t
 = 0;

636 i‡((
p_Vid
->
yuv_f‹m©
 !
YUV400
Ë&& (p_Vid->yuv_f‹m© !
YUV444
))

637 
cuºSli˚
->
	`chroma_ªsiduÆ_codög
 (
cuºMB
);

639 i‡(
cuºMB
->
be°_mode
 =
I16MB
)

641 
cuºMB
->
i16off£t
 = 
	`I16Off£t
 (cuºMB->
cbp
, cuºMB->
i16mode
);

644 
cuºSli˚
->
	`£t_mŸi⁄_ve˘‹s_mb
 (
cuºMB
);

647 if(
p_Vid
->
P444_joöed
)

649 i‡((
p¶i˚
Ë&& 
cuºMB
->
be°_mode
 =1 && cuºMB->
cbp
==0 && 
cuºSli˚
->
cmp_cbp
[1] == 0 && currSlice->cmp_cbp[2] == 0 &&

650 
mŸi⁄
[
cuºMB
->
block_y
][cuºMB->
block_x
].
ªf_idx
[
LIST_0
] == 0 &&

651 
mŸi⁄
[
cuºMB
->
block_y
][cuºMB->
block_x
].
mv
 [
LIST_0
].
mv_x
 =
Ælmvs
->mv_x &&

652 
mŸi⁄
[
cuºMB
->
block_y
][cuºMB->
block_x
].
mv
 [
LIST_0
].
mv_y
 =
Ælmvs
->mv_y)

654 
cuºMB
->
mb_ty≥
 = cuºMB->
b8x8
[0].
mode
 = currMB->b8x8[1].mode = currMB->b8x8[2].mode = currMB->b8x8[3].mode = 0;

655 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
FALSE
;

658 i‡((
p¶i˚
Ë&& 
cuºMB
->
be°_mode
 =1 && cuºMB->
cbp
==0 &&

659 
mŸi⁄
[
cuºMB
->
block_y
][cuºMB->
block_x
].
ªf_idx
[
LIST_0
] == 0 &&

660 
mŸi⁄
[
cuºMB
->
block_y
][cuºMB->
block_x
].
mv
 [
LIST_0
].
mv_x
 =
Ælmvs
->mv_x &&

661 
mŸi⁄
[
cuºMB
->
block_y
][cuºMB->
block_x
].
mv
 [
LIST_0
].
mv_y
 =
Ælmvs
->mv_y)

663 
cuºMB
->
mb_ty≥
 = cuºMB->
b8x8
[0].
mode
 = currMB->b8x8[1].mode = currMB->b8x8[2].mode = currMB->b8x8[3].mode = 0;

664 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
FALSE
;

667 i‡(
cuºSli˚
->
mb_aff_‰ame_Êag
 || (
p_I≈
->
U£RDOQu™t
 && cuºSli˚->
RDOQ_QP_Num
 > 1))

668 
	`£t_mbaff_∑ømëîs
(
cuºMB
);

672 if(
p_I≈
->
RCE«bÀ
 &&Ö_I≈->
RCUpd©eMode
 <
MAX_RC_MODE
)

673 
	`rc_°‹e_mad
(
cuºMB
);

676 i‡(
p_I≈
->
Re°ri˘Ref
)

677 
	`upd©e_ª‰esh_m≠
(
cuºMB
, 
öåa
, 
öåa1
);

681 i‡(
p_Vid
->
Ad≠tiveRoundög
)

683 
	`upd©e_off£t_∑øms
(
cuºMB
, cuºMB->
be°_mode
, cuºMB->
luma_å™sf‹m_size_8x8_Êag
);

686 
	`‰ì_mem3D≥l
(
ãmp_img
);

687 
	}
}

	@lencod/src/me_distortion.c

16 
	~"c⁄åibut‹s.h
"

18 
	~<limôs.h
>

20 
	~"globÆ.h
"

21 
	~"image.h
"

22 
	~"memÆloc.h
"

23 
	~"mb_ac˚ss.h
"

24 
	~"ªfbuf.h
"

25 
	~"mv_£¨ch.h
"

26 
	~"me_di°‹ti⁄.h
"

30 
	#CHECKOVERFLOW
(
mco°
)

	)

38 
di°blk
 
	$di°‹ti⁄4x4SAD
(* 
diff
, 
di°blk
 
mö_di°
)

40 
di°‹ti⁄
 = 0, 
k
;

41 
k
 = 0; k < 16; k++)

43 
di°‹ti⁄
 +
	`übs
(*
diff
++);

45  (
	`di°_sˇÀ
((
di°blk
Ë
di°‹ti⁄
));

46 
	}
}

54 
di°blk
 
	$di°‹ti⁄4x4SSE
(* 
diff
, 
di°blk
 
mö_di°
)

56 
di°‹ti⁄
 = 0, 
k
;

57 
k
 = 0; k < 16; k++)

59 
di°‹ti⁄
 +
	`übs2
(*
diff
++);

61  (
	`di°_sˇÀ
((
di°blk
Ë
di°‹ti⁄
));

62 
	}
}

70 
di°blk
 
	$di°‹ti⁄4x4SATD
(* 
diff
, 
di°blk
 
mö_di°
)

72 
di°blk
 
i64Rë
 = 
	`Hadam¨dSAD4x4
–
diff
 );

73  (
	`di°_sˇÀ
(
i64Rë
));

74 
	}
}

82 
di°blk
 
	$di°‹ti⁄8x8SADthªs
(* 
diff
, 
di°blk
 
mö_co°
)

84 
di°‹ti⁄
 = 0;

85 
i
, 
j
;

86 
imö_co°
 = 
	`di°_down
(
mö_co°
);

88 
j
 = 0; j < 8; j++)

90 
i
 = 0; i < 8; i++)

92 
di°‹ti⁄
 +
	`übs
(*
diff
++);

94 i‡(
di°‹ti⁄
 > 
imö_co°
)

98  (
	`di°_sˇÀ
((
di°blk
Ë
di°‹ti⁄
));

99 
	}
}

107 
di°blk
 
	$di°‹ti⁄8x8SAD
(* 
diff
, 
di°blk
 
mö_di°
)

109 
di°‹ti⁄
 = 0;

110 
k
;

112 
k
 = 0; k < 64; k++)

114 
di°‹ti⁄
 +
	`übs
(*
diff
++);

116  (
	`di°_sˇÀ
((
di°blk
Ë
di°‹ti⁄
));

117 
	}
}

125 
di°blk
 
	$di°‹ti⁄8x8SSE
(* 
diff
, 
di°blk
 
mö_di°
)

127 
di°blk
 
di°‹ti⁄
 = 0;

128 
k
;

129 
k
 = 0; k < 64; k++)

131 
di°‹ti⁄
 +
	`übs2
(*
diff
++);

133  (
	`di°_sˇÀ
(
di°‹ti⁄
));

134 
	}
}

142 
di°blk
 
	$di°‹ti⁄8x8SATD
(* 
diff
, 
di°blk
 
mö_di°
)

144 
di°blk
 
i64Rë
 = 
	`Hadam¨dSAD8x8
–
diff
 );

145  (
	`di°_sˇÀ
(
i64Rë
));

146 
	}
}

148 
	$£À˘_di°‹ti⁄
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

150 
p_I≈
->
ModeDecisi⁄Mëric
)

152 
ERROR_SAD
:

153 
p_Vid
->
di°‹ti⁄4x4
 = 
di°‹ti⁄4x4SAD
;

154 
p_Vid
->
di°‹ti⁄8x8
 = 
di°‹ti⁄8x8SAD
;

156 
ERROR_SSE
:

157 
p_Vid
->
di°‹ti⁄4x4
 = 
di°‹ti⁄4x4SSE
;

158 
p_Vid
->
di°‹ti⁄8x8
 = 
di°‹ti⁄8x8SSE
;

160 
ERROR_SATD
 :

162 
p_Vid
->
di°‹ti⁄4x4
 = 
di°‹ti⁄4x4SATD
;

163 
p_Vid
->
di°‹ti⁄8x8
 = 
di°‹ti⁄8x8SATD
;

166 
	}
}

175 
	$Hadam¨dSAD4x4
 (* 
diff
)

177 
k
, 
ßtd
 = 0;

178 
m
[16], 
d
[16];

181 
m
[ 0] = 
diff
[ 0] + diff[12];

182 
m
[ 1] = 
diff
[ 1] + diff[13];

183 
m
[ 2] = 
diff
[ 2] + diff[14];

184 
m
[ 3] = 
diff
[ 3] + diff[15];

185 
m
[ 4] = 
diff
[ 4] + diff[ 8];

186 
m
[ 5] = 
diff
[ 5] + diff[ 9];

187 
m
[ 6] = 
diff
[ 6] + diff[10];

188 
m
[ 7] = 
diff
[ 7] + diff[11];

189 
m
[ 8] = 
diff
[ 4] - diff[ 8];

190 
m
[ 9] = 
diff
[ 5] - diff[ 9];

191 
m
[10] = 
diff
[ 6] - diff[10];

192 
m
[11] = 
diff
[ 7] - diff[11];

193 
m
[12] = 
diff
[ 0] - diff[12];

194 
m
[13] = 
diff
[ 1] - diff[13];

195 
m
[14] = 
diff
[ 2] - diff[14];

196 
m
[15] = 
diff
[ 3] - diff[15];

198 
d
[ 0] = 
m
[ 0] + m[ 4];

199 
d
[ 1] = 
m
[ 1] + m[ 5];

200 
d
[ 2] = 
m
[ 2] + m[ 6];

201 
d
[ 3] = 
m
[ 3] + m[ 7];

202 
d
[ 4] = 
m
[ 8] + m[12];

203 
d
[ 5] = 
m
[ 9] + m[13];

204 
d
[ 6] = 
m
[10] + m[14];

205 
d
[ 7] = 
m
[11] + m[15];

206 
d
[ 8] = 
m
[ 0] - m[ 4];

207 
d
[ 9] = 
m
[ 1] - m[ 5];

208 
d
[10] = 
m
[ 2] - m[ 6];

209 
d
[11] = 
m
[ 3] - m[ 7];

210 
d
[12] = 
m
[12] - m[ 8];

211 
d
[13] = 
m
[13] - m[ 9];

212 
d
[14] = 
m
[14] - m[10];

213 
d
[15] = 
m
[15] - m[11];

215 
m
[ 0] = 
d
[ 0] + d[ 3];

216 
m
[ 1] = 
d
[ 1] + d[ 2];

217 
m
[ 2] = 
d
[ 1] - d[ 2];

218 
m
[ 3] = 
d
[ 0] - d[ 3];

219 
m
[ 4] = 
d
[ 4] + d[ 7];

220 
m
[ 5] = 
d
[ 5] + d[ 6];

221 
m
[ 6] = 
d
[ 5] - d[ 6];

222 
m
[ 7] = 
d
[ 4] - d[ 7];

223 
m
[ 8] = 
d
[ 8] + d[11];

224 
m
[ 9] = 
d
[ 9] + d[10];

225 
m
[10] = 
d
[ 9] - d[10];

226 
m
[11] = 
d
[ 8] - d[11];

227 
m
[12] = 
d
[12] + d[15];

228 
m
[13] = 
d
[13] + d[14];

229 
m
[14] = 
d
[13] - d[14];

230 
m
[15] = 
d
[12] - d[15];

232 
d
[ 0] = 
m
[ 0] + m[ 1];

233 
d
[ 1] = 
m
[ 0] - m[ 1];

234 
d
[ 2] = 
m
[ 2] + m[ 3];

235 
d
[ 3] = 
m
[ 3] - m[ 2];

236 
d
[ 4] = 
m
[ 4] + m[ 5];

237 
d
[ 5] = 
m
[ 4] - m[ 5];

238 
d
[ 6] = 
m
[ 6] + m[ 7];

239 
d
[ 7] = 
m
[ 7] - m[ 6];

240 
d
[ 8] = 
m
[ 8] + m[ 9];

241 
d
[ 9] = 
m
[ 8] - m[ 9];

242 
d
[10] = 
m
[10] + m[11];

243 
d
[11] = 
m
[11] - m[10];

244 
d
[12] = 
m
[12] + m[13];

245 
d
[13] = 
m
[12] - m[13];

246 
d
[14] = 
m
[14] + m[15];

247 
d
[15] = 
m
[15] - m[14];

251 
k
=0; k<16; ++k)

253 
ßtd
 +
	`übs
(
d
 [
k
]);

257  ((
ßtd
+1)>>1);

258 
	}
}

266 
	$Hadam¨dSAD8x8
 (* 
diff
)

268 
i
, 
j
, 
jj
, 
ßd
=0;

271 
m1
[8][8], 
m2
[8][8], 
m3
[8][8];

275 
j
=0; j < 8; j++)

277 
jj
 = 
j
 << 3;

278 
m2
[
j
][0] = 
diff
[
jj
 ] + diff[jj+4];

279 
m2
[
j
][1] = 
diff
[
jj
+1] + diff[jj+5];

280 
m2
[
j
][2] = 
diff
[
jj
+2] + diff[jj+6];

281 
m2
[
j
][3] = 
diff
[
jj
+3] + diff[jj+7];

282 
m2
[
j
][4] = 
diff
[
jj
 ] - diff[jj+4];

283 
m2
[
j
][5] = 
diff
[
jj
+1] - diff[jj+5];

284 
m2
[
j
][6] = 
diff
[
jj
+2] - diff[jj+6];

285 
m2
[
j
][7] = 
diff
[
jj
+3] - diff[jj+7];

287 
m1
[
j
][0] = 
m2
[j][0] + m2[j][2];

288 
m1
[
j
][1] = 
m2
[j][1] + m2[j][3];

289 
m1
[
j
][2] = 
m2
[j][0] - m2[j][2];

290 
m1
[
j
][3] = 
m2
[j][1] - m2[j][3];

291 
m1
[
j
][4] = 
m2
[j][4] + m2[j][6];

292 
m1
[
j
][5] = 
m2
[j][5] + m2[j][7];

293 
m1
[
j
][6] = 
m2
[j][4] - m2[j][6];

294 
m1
[
j
][7] = 
m2
[j][5] - m2[j][7];

296 
m2
[
j
][0] = 
m1
[j][0] + m1[j][1];

297 
m2
[
j
][1] = 
m1
[j][0] - m1[j][1];

298 
m2
[
j
][2] = 
m1
[j][2] + m1[j][3];

299 
m2
[
j
][3] = 
m1
[j][2] - m1[j][3];

300 
m2
[
j
][4] = 
m1
[j][4] + m1[j][5];

301 
m2
[
j
][5] = 
m1
[j][4] - m1[j][5];

302 
m2
[
j
][6] = 
m1
[j][6] + m1[j][7];

303 
m2
[
j
][7] = 
m1
[j][6] - m1[j][7];

307 
i
=0; i < 8; i++)

309 
m3
[0][
i
] = 
m2
[0][i] + m2[4][i];

310 
m3
[1][
i
] = 
m2
[1][i] + m2[5][i];

311 
m3
[2][
i
] = 
m2
[2][i] + m2[6][i];

312 
m3
[3][
i
] = 
m2
[3][i] + m2[7][i];

313 
m3
[4][
i
] = 
m2
[0][i] - m2[4][i];

314 
m3
[5][
i
] = 
m2
[1][i] - m2[5][i];

315 
m3
[6][
i
] = 
m2
[2][i] - m2[6][i];

316 
m3
[7][
i
] = 
m2
[3][i] - m2[7][i];

318 
m1
[0][
i
] = 
m3
[0][i] + m3[2][i];

319 
m1
[1][
i
] = 
m3
[1][i] + m3[3][i];

320 
m1
[2][
i
] = 
m3
[0][i] - m3[2][i];

321 
m1
[3][
i
] = 
m3
[1][i] - m3[3][i];

322 
m1
[4][
i
] = 
m3
[4][i] + m3[6][i];

323 
m1
[5][
i
] = 
m3
[5][i] + m3[7][i];

324 
m1
[6][
i
] = 
m3
[4][i] - m3[6][i];

325 
m1
[7][
i
] = 
m3
[5][i] - m3[7][i];

327 
m2
[0][
i
] = 
m1
[0][i] + m1[1][i];

328 
m2
[1][
i
] = 
m1
[0][i] - m1[1][i];

329 
m2
[2][
i
] = 
m1
[2][i] + m1[3][i];

330 
m2
[3][
i
] = 
m1
[2][i] - m1[3][i];

331 
m2
[4][
i
] = 
m1
[4][i] + m1[5][i];

332 
m2
[5][
i
] = 
m1
[4][i] - m1[5][i];

333 
m2
[6][
i
] = 
m1
[6][i] + m1[7][i];

334 
m2
[7][
i
] = 
m1
[6][i] - m1[7][i];

336 
j
=0; j < 8; j++)

337 
i
=0; i < 8; i++)

338 
ßd
 +
	`übs
 (
m2
[
j
][
i
]);

340  ((
ßd
+2)>>2);

341 
	}
}

349 
di°blk
 
	$compuãSAD
(
St‹abÀPi˘uª
 *
ªf1
,

350 
MEBlock
 *
mv_block
,

351 
di°blk
 
mö_mco°
,

352 
MŸi⁄Ve˘‹
 *
ˇnd
)

354 
mco°
 = 0;

355 
imö_co°
 = 
	`di°_down
(
mö_mco°
);

356 
y
,
x
;

357 
blocksize_x
 = 
mv_block
->blocksize_x;

358 
blocksize_y
 = 
mv_block
->blocksize_y;

359 
VideoP¨amëîs
 *
p_Vid
 = 
mv_block
->p_Vid;

360 
∑d_size_x
 = 
p_Vid
->
∑dded_size_x
 - 
blocksize_x
;

361 #i‡(
JM_MEM_DISTORTION
)

362 *
img≥l_abs
 = 
p_Vid
->imgpel_abs;

365 
img≥l
 *
§c_löe
, *
ªf_löe
;

366 
§c_löe
 = 
mv_block
->
‹ig_pic
[0];

367 
ªf_löe
 = 
	`UMVLöe4X
 (
ªf1
, 
ˇnd
->
mv_y
, c™d->
mv_x
);

368 
y
=0; y<
blocksize_y
; y++)

370 
x
 = 0; x < 
blocksize_x
; x+=4)

372 #i‡(
JM_MEM_DISTORTION
)

373 
mco°
 +
img≥l_abs
[ *
§c_löe
++ - *
ªf_löe
++ ];

374 
mco°
 +
img≥l_abs
[ *
§c_löe
++ - *
ªf_löe
++ ];

375 
mco°
 +
img≥l_abs
[ *
§c_löe
++ - *
ªf_löe
++ ];

376 
mco°
 +
img≥l_abs
[ *
§c_löe
++ - *
ªf_löe
++ ];

378 
mco°
 +
	`übs
–*
§c_löe
++ - *
ªf_löe
++ );

379 
mco°
 +
	`übs
–*
§c_löe
++ - *
ªf_löe
++ );

380 
mco°
 +
	`übs
–*
§c_löe
++ - *
ªf_löe
++ );

381 
mco°
 +
	`übs
–*
§c_löe
++ - *
ªf_löe
++ );

384 if(
mco°
 > 
imö_co°
)

385  (
	`di°_sˇÀ_f
((
di°blk
)
mco°
));

386 
ªf_löe
 +
∑d_size_x
;

388 i‡–
mv_block
->
ChromaMEE«bÀ
 )

391 
blocksize_x_¸
 = 
mv_block
->
blocksize_¸_x
;

392 
blocksize_y_¸
 = 
mv_block
->
blocksize_¸_y
;

393 
¸_∑d_size_x
 = 
p_Vid
->
¸_∑dded_size_x
 - 
blocksize_x_¸
;

394 
k
;

395 
m¸_co°
 = 0;

397 
k
=0; k < 2; k++)

399 
§c_löe
 = 
mv_block
->
‹ig_pic
[
k
+1];

400 
ªf_löe
 = 
	`UMVLöe8X_chroma
 ( 
ªf1
, 
k
+1, 
ˇnd
->
mv_y
, c™d->
mv_x
);

401 
m¸_co°
 = 0;

403 
y
 = 0; y < 
blocksize_y_¸
; y++)

405 
x
 = 0; x < 
blocksize_x_¸
; x += 2)

407 #i‡(
JM_MEM_DISTORTION
)

408 
m¸_co°
 +
img≥l_abs
[ *
§c_löe
++ - *
ªf_löe
++ ];

409 
m¸_co°
 +
img≥l_abs
[ *
§c_löe
++ - *
ªf_löe
++ ];

411 
m¸_co°
 +
	`übs
–*
§c_löe
++ - *
ªf_löe
++ );

412 
m¸_co°
 +
	`übs
–*
§c_löe
++ - *
ªf_löe
++ );

415 
ªf_löe
 +
¸_∑d_size_x
;

417 
mco°
 +
mv_block
->
ChromaMEWeight
 * 
m¸_co°
;

419 if(
mco°
 >
imö_co°
)

420  (
	`di°_sˇÀ_f
((
di°blk
)
mco°
));

424 
	`CHECKOVERFLOW
(
mco°
);

425  (
	`di°_sˇÀ
((
di°blk
)
mco°
));

426 
	}
}

434 
di°blk
 
	$compuãSADWP
(
St‹abÀPi˘uª
 *
ªf1
,

435 
MEBlock
 *
mv_block
,

436 
di°blk
 
mö_mco°
,

437 
MŸi⁄Ve˘‹
 *
ˇnd


440 
mco°
 = 0;

441 
imö_co°
 = 
	`di°_down
(
mö_mco°
);

442 
y
, 
x
;

443 
weighãd_≥l
;

444 
blocksize_x
 = 
mv_block
->blocksize_x;

445 
blocksize_y
 = 
mv_block
->blocksize_y;

447 
VideoP¨amëîs
 *
p_Vid
 = 
mv_block
->p_Vid;

448 
Sli˚
 *
cuºSli˚
 = 
mv_block
->
p_Sli˚
;

449 
∑d_size_x
 = 
p_Vid
->
∑dded_size_x
 - 
blocksize_x
;

450 
max_img≥l_vÆue
 = 
p_Vid
->max_imgpel_value;

451 
weight
 = 
mv_block
->
weight_luma
;

452 
off£t
 = 
mv_block
->
off£t_luma
;

454 
wp_luma_round
 = 
cuºSli˚
->wp_luma_round;

455 
luma_log_weight_díom
 = 
cuºSli˚
->luma_log_weight_denom;

457 
img≥l
 *
§c_löe
 = 
mv_block
->
‹ig_pic
[0];

458 
img≥l
 *
ªf_löe
 = 
	`UMVLöe4X
 (
ªf1
, 
ˇnd
->
mv_y
, c™d->
mv_x
);

460 
y
=0; y<
blocksize_y
; y++)

462 
x
 = 0; x < 
blocksize_x
; x+=4)

464 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
weight
 * *
ªf_löe
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t
);

465 
mco°
 +
	`übs
–*
§c_löe
++ - 
weighãd_≥l
 );

466 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
weight
 * *
ªf_löe
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t
);

467 
mco°
 +
	`übs
–*
§c_löe
++ - 
weighãd_≥l
 );

468 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
weight
 * *
ªf_löe
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t
);

469 
mco°
 +
	`übs
–*
§c_löe
++ - 
weighãd_≥l
 );

470 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
weight
 * *
ªf_löe
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t
);

471 
mco°
 +
	`übs
–*
§c_löe
++ - 
weighãd_≥l
 );

473 if(
mco°
 > 
imö_co°
)

474  (
	`di°_sˇÀ_f
((
di°blk
)
mco°
));

475 
ªf_löe
 +
∑d_size_x
;

477 i‡–
mv_block
->
ChromaMEE«bÀ
 )

480 
blocksize_x_¸
 = 
mv_block
->
blocksize_¸_x
;

481 
blocksize_y_¸
 = 
mv_block
->
blocksize_¸_y
;

482 
¸_∑d_size_x
 = 
p_Vid
->
¸_∑dded_size_x
 - 
blocksize_x_¸
;

483 
k
;

484 
m¸_co°
 = 0;

485 
max_img≥l_vÆue_uv
 = 
p_Vid
->
max_≥l_vÆue_comp
[1];

486 
wp_chroma_round
 = 
cuºSli˚
->wp_chroma_round;

487 
chroma_log_weight_díom
 = 
cuºSli˚
->chroma_log_weight_denom;

489 
k
=0; k < 2; k++)

491 
weight
 = 
mv_block
->
weight_¸
[
k
];

492 
off£t
 = 
mv_block
->
off£t_¸
[
k
];

494 
m¸_co°
 = 0;

495 
§c_löe
 = 
mv_block
->
‹ig_pic
[
k
+1];

496 
ªf_löe
 = 
	`UMVLöe8X_chroma
 ( 
ªf1
, 
k
+1, 
ˇnd
->
mv_y
, c™d->
mv_x
);

497 
y
=0; y<
blocksize_y_¸
; y++)

499 
x
 = 0; x < 
blocksize_x_¸
; x+=2)

501 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue_uv
, ((
weight
 * *
ªf_löe
++ + 
wp_chroma_round
Ë>> 
chroma_log_weight_díom
Ë+ 
off£t
);

502 
m¸_co°
 +
	`übs
–*
§c_löe
++ - 
weighãd_≥l
 );

503 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue_uv
, ((
weight
 * *
ªf_löe
++ + 
wp_chroma_round
Ë>> 
chroma_log_weight_díom
Ë+ 
off£t
);

504 
m¸_co°
 +
	`übs
–*
§c_löe
++ - 
weighãd_≥l
 );

506 
ªf_löe
 +
¸_∑d_size_x
;

508 
mco°
 +
mv_block
->
ChromaMEWeight
 * 
m¸_co°
;

510 if(
mco°
 >
imö_co°
)

511  (
	`di°_sˇÀ_f
((
di°blk
)
mco°
));

515 
	`CHECKOVERFLOW
(
mco°
);

516  (
	`di°_sˇÀ
((
di°blk
)
mco°
));

517 
	}
}

525 
di°blk
 
	$compuãBiPªdSAD1
(
St‹abÀPi˘uª
 *
ªf1
,

526 
St‹abÀPi˘uª
 *
ªf2
,

527 
MEBlock
 *
mv_block
,

528 
di°blk
 
mö_mco°
,

529 
MŸi⁄Ve˘‹
 *
ˇnd1
,

530 
MŸi⁄Ve˘‹
 *
ˇnd2
)

532 
imö_co°
 = 
	`di°_down
(
mö_mco°
);

533 
mco°
 = 0;

534 
bi_diff
;

535 
y
,
x
;

536 
blocksize_x
 = 
mv_block
->blocksize_x;

537 
blocksize_y
 = 
mv_block
->blocksize_y;

538 
VideoP¨amëîs
 *
p_Vid
 = 
mv_block
->p_Vid;

539 
∑d_size_x
 = 
p_Vid
->
∑dded_size_x
 - 
blocksize_x
;

540 #i‡(
JM_MEM_DISTORTION
)

541 *
img≥l_abs
 = 
p_Vid
->imgpel_abs;

544 
img≥l
 *
§c_löe
 = 
mv_block
->
‹ig_pic
[0];

545 
img≥l
 *
ªf2_löe
 = 
	`UMVLöe4X
(
ªf2
, 
ˇnd2
->
mv_y
, c™d2->
mv_x
);

546 
img≥l
 *
ªf1_löe
 = 
	`UMVLöe4X
(
ªf1
, 
ˇnd1
->
mv_y
, c™d1->
mv_x
);

548 
y
 = 0; y < 
blocksize_y
; y++)

550 
x
 = 0; x < 
blocksize_x
; x+=4)

552 #i‡(
JM_MEM_DISTORTION
)

553 
bi_diff
 = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

554 
mco°
 +
img≥l_abs
[ 
bi_diff
 ];

555 
bi_diff
 = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

556 
mco°
 +
img≥l_abs
[ 
bi_diff
 ];

557 
bi_diff
 = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

558 
mco°
 +
img≥l_abs
[ 
bi_diff
 ];

559 
bi_diff
 = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

560 
mco°
 +
img≥l_abs
[ 
bi_diff
 ];

562 
bi_diff
 = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

563 
mco°
 +
	`übs
(
bi_diff
);

564 
bi_diff
 = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

565 
mco°
 +
	`übs
(
bi_diff
);

566 
bi_diff
 = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

567 
mco°
 +
	`übs
(
bi_diff
);

568 
bi_diff
 = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

569 
mco°
 +
	`übs
(
bi_diff
);

572 if(
mco°
 > 
imö_co°
)

573  (
	`di°_sˇÀ_f
((
di°blk
)
mco°
));

575 
ªf2_löe
 +
∑d_size_x
;

576 
ªf1_löe
 +
∑d_size_x
;

579 i‡–
mv_block
->
ChromaMEE«bÀ
 )

582 
blocksize_x_¸
 = 
mv_block
->
blocksize_¸_x
;

583 
blocksize_y_¸
 = 
mv_block
->
blocksize_¸_y
;

584 
¸_∑d_size_x
 = 
p_Vid
->
¸_∑dded_size_x
 - 
blocksize_x_¸
;

585 
k
;

586 
m¸_co°
 = 0;

588 
k
=1; k<3; k++)

590 
m¸_co°
 = 0;

591 
§c_löe
 = 
mv_block
->
‹ig_pic
[
k
];

592 
ªf2_löe
 = 
	`UMVLöe8X_chroma
 ( 
ªf2
, 
k
, 
ˇnd2
->
mv_y
, c™d2->
mv_x
);

593 
ªf1_löe
 = 
	`UMVLöe8X_chroma
 ( 
ªf1
, 
k
, 
ˇnd1
->
mv_y
, c™d1->
mv_x
);

595 
y
=0; y<
blocksize_y_¸
; y++)

597 
x
 = 0; x < 
blocksize_x_¸
; x+=2)

599 
bi_diff
 = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

600 
m¸_co°
 +
	`übs
(
bi_diff
);

601 
bi_diff
 = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

602 
m¸_co°
 +
	`übs
(
bi_diff
);

604 
ªf2_löe
 +
¸_∑d_size_x
;

605 
ªf1_löe
 +
¸_∑d_size_x
;

607 
mco°
 +
mv_block
->
ChromaMEWeight
 * 
m¸_co°
;

609 if(
mco°
 > 
imö_co°
)

610  (
	`di°_sˇÀ_f
((
di°blk
)
mco°
));

614 
	`CHECKOVERFLOW
(
mco°
);

615  (
	`di°_sˇÀ
((
di°blk
)
mco°
));

616 
	}
}

624 
di°blk
 
	$compuãBiPªdSAD2
(
St‹abÀPi˘uª
 *
ªf1
,

625 
St‹abÀPi˘uª
 *
ªf2
,

626 
MEBlock
 *
mv_block
,

627 
di°blk
 
mö_mco°
,

628 
MŸi⁄Ve˘‹
 *
ˇnd1
,

629 
MŸi⁄Ve˘‹
 *
ˇnd2
)

631 
imö_co°
 = 
	`di°_down
(
mö_mco°
);

632 
mco°
 = 0;

633 
bi_diff
;

634 
VideoP¨amëîs
 *
p_Vid
 = 
mv_block
->p_Vid;

635 
Sli˚
 *
cuºSli˚
 = 
mv_block
->
p_Sli˚
;

636 
díom
 = 
cuºSli˚
->
luma_log_weight_díom
 + 1;

637 
Ãound
 = 2 * 
cuºSli˚
->
wp_luma_round
;

638 
max_img≥l_vÆue
 = 
p_Vid
->max_imgpel_value;

639 
y
,
x
;

640 
weighãd_≥l
, 
pixñ1
, 
pixñ2
;

641 
blocksize_x
 = 
mv_block
->blocksize_x;

642 
blocksize_y
 = 
mv_block
->blocksize_y;

643 
weight1
 = 
mv_block
->weight1;

644 
weight2
 = 
mv_block
->weight2;

645 
off£tBi
 = 
mv_block
->offsetBi;

647 
∑d_size_x
 = 
p_Vid
->
∑dded_size_x
 - 
blocksize_x
;

649 
img≥l
 *
§c_löe
 = 
mv_block
->
‹ig_pic
[0];

650 
img≥l
 *
ªf2_löe
 = 
	`UMVLöe4X
(
ªf2
, 
ˇnd2
->
mv_y
, c™d2->
mv_x
);

651 
img≥l
 *
ªf1_löe
 = 
	`UMVLöe4X
(
ªf1
, 
ˇnd1
->
mv_y
, c™d1->
mv_x
);

653 
y
=0; y<
blocksize_y
; y++)

655 
x
 = 0; x < 
blocksize_x
; x+=4)

657 
pixñ1
 = 
weight1
 * (*
ªf1_löe
++);

658 
pixñ2
 = 
weight2
 * (*
ªf2_löe
++);

659 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
pixñ1
 + 
pixñ2
 + 
Ãound
Ë>> 
díom
Ë+ 
off£tBi
);

660 
bi_diff
 = (*
§c_löe
++Ë- 
weighãd_≥l
;

661 
mco°
 +
	`übs
(
bi_diff
);

663 
pixñ1
 = 
weight1
 * (*
ªf1_löe
++);

664 
pixñ2
 = 
weight2
 * (*
ªf2_löe
++);

665 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
pixñ1
 + 
pixñ2
 + 
Ãound
Ë>> 
díom
Ë+ 
off£tBi
);

666 
bi_diff
 = (*
§c_löe
++Ë- 
weighãd_≥l
;

667 
mco°
 +
	`übs
(
bi_diff
);

669 
pixñ1
 = 
weight1
 * (*
ªf1_löe
++);

670 
pixñ2
 = 
weight2
 * (*
ªf2_löe
++);

671 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
pixñ1
 + 
pixñ2
 + 
Ãound
Ë>> 
díom
Ë+ 
off£tBi
);

672 
bi_diff
 = (*
§c_löe
++Ë- 
weighãd_≥l
;

673 
mco°
 +
	`übs
(
bi_diff
);

675 
pixñ1
 = 
weight1
 * (*
ªf1_löe
++);

676 
pixñ2
 = 
weight2
 * (*
ªf2_löe
++);

677 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
pixñ1
 + 
pixñ2
 + 
Ãound
Ë>> 
díom
Ë+ 
off£tBi
);

678 
bi_diff
 = (*
§c_löe
++Ë- 
weighãd_≥l
;

679 
mco°
 +
	`übs
(
bi_diff
);

682 if(
mco°
 > 
imö_co°
)

683  
	`di°_sˇÀ_f
((
di°blk
)
mco°
);

684 
ªf2_löe
 +
∑d_size_x
;

685 
ªf1_löe
 +
∑d_size_x
;

688 i‡–
mv_block
->
ChromaMEE«bÀ
 )

691 
blocksize_x_¸
 = 
mv_block
->
blocksize_¸_x
;

692 
blocksize_y_¸
 = 
mv_block
->
blocksize_¸_y
;

693 
¸_∑d_size_x
 = 
p_Vid
->
¸_∑dded_size_x
 - 
blocksize_x_¸
;

694 
k
;

695 
m¸_co°
 = 0;

696 
max_img≥l_vÆue_uv
 = 
p_Vid
->
max_≥l_vÆue_comp
[1];

698 
k
=0; k<2; k++)

700 
weight1
 = 
mv_block
->
weight1_¸
[
k
];

701 
weight2
 = 
mv_block
->
weight2_¸
[
k
];

702 
off£tBi
 = 
mv_block
->
off£tBi_¸
[
k
];

704 
m¸_co°
 = 0;

705 
§c_löe
 = 
mv_block
->
‹ig_pic
[
k
+1];

706 
ªf2_löe
 = 
	`UMVLöe8X_chroma
 ( 
ªf2
, 
k
+1, 
ˇnd2
->
mv_y
, c™d2->
mv_x
);

707 
ªf1_löe
 = 
	`UMVLöe8X_chroma
 ( 
ªf1
, 
k
+1, 
ˇnd1
->
mv_y
, c™d1->
mv_x
);

709 
y
=0; y<
blocksize_y_¸
; y++)

711 
x
 = 0; x < 
blocksize_x_¸
; x+=2)

713 
pixñ1
 = 
weight1
 * (*
ªf1_löe
++);

714 
pixñ2
 = 
weight2
 * (*
ªf2_löe
++);

715 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue_uv
, ((
pixñ1
 + 
pixñ2
 + 
Ãound
Ë>> 
díom
Ë+ 
off£tBi
);

716 
bi_diff
 = (*
§c_löe
++Ë- 
weighãd_≥l
;

717 
m¸_co°
 +
	`übs
(
bi_diff
);

719 
pixñ1
 = 
weight1
 * (*
ªf1_löe
++);

720 
pixñ2
 = 
weight2
 * (*
ªf2_löe
++);

721 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue_uv
, ((
pixñ1
 + 
pixñ2
 + 
Ãound
Ë>> 
díom
Ë+ 
off£tBi
);

722 
bi_diff
 = (*
§c_löe
++Ë- 
weighãd_≥l
;

723 
m¸_co°
 +
	`übs
(
bi_diff
);

725 
ªf2_löe
 +
¸_∑d_size_x
;

726 
ªf1_löe
 +
¸_∑d_size_x
;

728 
mco°
 +
mv_block
->
ChromaMEWeight
 * 
m¸_co°
;

730 if(
mco°
 > 
imö_co°
)

731  
	`di°_sˇÀ_f
((
di°blk
)
mco°
);

735 
	`CHECKOVERFLOW
(
mco°
);

736  
	`di°_sˇÀ
((
di°blk
)
mco°
);

737 
	}
}

745 
di°blk
 
	$compuãSATD
(
St‹abÀPi˘uª
 *
ªf1
,

746 
MEBlock
 *
mv_block
,

747 
di°blk
 
mö_mco°
,

748 
MŸi⁄Ve˘‹
 *
ˇnd


751 
imö_co°
 = 
	`di°_down
(
mö_mco°
);

752 
mco°
 = 0;

753 
y
, 
x
, 
y4
;

754 
§c_size_x
, 
§c_size_mul
;

755 
blocksize_x
 = 
mv_block
->blocksize_x;

756 
blocksize_y
 = 
mv_block
->blocksize_y;

757 
VideoP¨amëîs
 *
p_Vid
 = 
mv_block
->p_Vid;

758 
img≥l
 *
§c_tmp
 = 
mv_block
->
‹ig_pic
[0];

759 *
d
, 
diff
[
MB_PIXELS
];

760 
img≥l
 *
§c_löe
, *
ªf_löe
;

762 i‡–!
mv_block
->
ã°8x8
 )

764 
§c_size_x
 = 
blocksize_x
 - 
BLOCK_SIZE
;

765 
§c_size_mul
 = 
blocksize_x
 * 
BLOCK_SIZE
;

766 
y
 = 
ˇnd
->
mv_y
; y < c™d->mv_y + (
blocksize_y
<<2); y +(
BLOCK_SIZE_SP
))

768 
x
=0; x<
blocksize_x
; x +
BLOCK_SIZE
)

770 
d
 = 
diff
;

771 
ªf_löe
 = 
	`UMVLöe4X
 (
ªf1
, 
y
, 
ˇnd
->
mv_x
 + (
x
<<2));

772 
§c_löe
 = 
§c_tmp
 + 
x
;

773 
y4
 = 0; y4 < 
BLOCK_SIZE
; y4++ )

775 *
d
++ = *
§c_löe
++ - *
ªf_löe
++ ;

776 *
d
++ = *
§c_löe
++ - *
ªf_löe
++ ;

777 *
d
++ = *
§c_löe
++ - *
ªf_löe
++ ;

778 *
d
++ = *
§c_löe
++ - *
ªf_löe
++ ;

780 
ªf_löe
 +
p_Vid
->
∑dded_size_x_m4x4
;

781 
§c_löe
 +
§c_size_x
;

783 
mco°
 +
	`Hadam¨dSAD4x4
 (
diff
);

784 if(
mco°
 > 
imö_co°
)

785  
	`di°_sˇÀ_f
((
di°blk
)
mco°
);

787 
§c_tmp
 +
§c_size_mul
;

792 
§c_size_x
 = (
blocksize_x
 - 
BLOCK_SIZE_8x8
);

793 
§c_size_mul
 = 
blocksize_x
 * 
BLOCK_SIZE_8x8
;

794 
y
 = 
ˇnd
->
mv_y
; y < c™d->mv_y + (
blocksize_y
<<2); y +(
BLOCK_SIZE_8x8_SP
) )

796 
x
=0; x<
blocksize_x
; x +
BLOCK_SIZE_8x8
 )

798 
d
 = 
diff
;

799 
ªf_löe
 = 
	`UMVLöe4X
 (
ªf1
, 
y
, 
ˇnd
->
mv_x
 + (
x
<<2));

800 
§c_löe
 = 
§c_tmp
 + 
x
;

801 
y4
 = 0; y4 < 
BLOCK_SIZE_8x8
; y4++ )

803 *
d
++ = *
§c_löe
++ - *
ªf_löe
++ ;

804 *
d
++ = *
§c_löe
++ - *
ªf_löe
++ ;

805 *
d
++ = *
§c_löe
++ - *
ªf_löe
++ ;

806 *
d
++ = *
§c_löe
++ - *
ªf_löe
++ ;

807 *
d
++ = *
§c_löe
++ - *
ªf_löe
++ ;

808 *
d
++ = *
§c_löe
++ - *
ªf_löe
++ ;

809 *
d
++ = *
§c_löe
++ - *
ªf_löe
++ ;

810 *
d
++ = *
§c_löe
++ - *
ªf_löe
++ ;

812 
ªf_löe
 +
p_Vid
->
∑dded_size_x_m8x8
;

813 
§c_löe
 +
§c_size_x
;

815 
mco°
 +
	`Hadam¨dSAD8x8
 (
diff
);

816 if(
mco°
 > 
imö_co°
)

817  
	`di°_sˇÀ_f
((
di°blk
)
mco°
);

819 
§c_tmp
 +
§c_size_mul
;

823 
	`CHECKOVERFLOW
(
mco°
);

824  
	`di°_sˇÀ
((
di°blk
)
mco°
);

825 
	}
}

833 
di°blk
 
	$compuãSATDWP
(
St‹abÀPi˘uª
 *
ªf1
,

834 
MEBlock
 *
mv_block
,

835 
di°blk
 
mö_mco°
,

836 
MŸi⁄Ve˘‹
 *
ˇnd


839 
imö_co°
 = 
	`di°_down
(
mö_mco°
);

840 
mco°
 = 0;

841 
y
, 
x
, 
y4
;

842 
weighãd_≥l
;

843 
§c_size_x
, 
§c_size_mul
;

844 
blocksize_x
 = 
mv_block
->blocksize_x;

845 
blocksize_y
 = 
mv_block
->blocksize_y;

847 
img≥l
 *
§c_tmp
 = 
mv_block
->
‹ig_pic
[0];

848 
VideoP¨amëîs
 *
p_Vid
 = 
mv_block
->p_Vid;

849 
Sli˚
 *
cuºSli˚
 = 
mv_block
->
p_Sli˚
;

850 
luma_log_weight_díom
 = 
cuºSli˚
->luma_log_weight_denom;

851 
weight
 = 
mv_block
->
weight_luma
;

852 
off£t
 = 
mv_block
->
off£t_luma
;

854 
wp_luma_round
 = 
cuºSli˚
->wp_luma_round;

855 
max_img≥l_vÆue
 = 
p_Vid
->max_imgpel_value;

856 *
d
, 
diff
[
MB_PIXELS
];

857 
img≥l
 *
§c_löe
, *
ªf_löe
;

859 i‡–!
mv_block
->
ã°8x8
 )

861 
§c_size_x
 = (
blocksize_x
 - 
BLOCK_SIZE
);

862 
§c_size_mul
 = 
blocksize_x
 * 
BLOCK_SIZE
;

863 
y
 = 
ˇnd
->
mv_y
; y < c™d->mv_y + (
blocksize_y
<<2); y +(
BLOCK_SIZE_SP
))

865 
x
=0; x<
blocksize_x
; x +
BLOCK_SIZE
)

867 
d
 = 
diff
;

868 
ªf_löe
 = 
	`UMVLöe4X
 (
ªf1
, 
y
, 
ˇnd
->
mv_x
 + (
x
<<2));

869 
§c_löe
 = 
§c_tmp
 + 
x
;

870 
y4
 = 0; y4 < 
BLOCK_SIZE
; y4++ )

872 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
weight
 * *
ªf_löe
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t
);

873 *
d
++ = (Ë(*
§c_löe
++ - 
weighãd_≥l
);

874 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
weight
 * *
ªf_löe
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t
);

875 *
d
++ = (Ë(*
§c_löe
++ - 
weighãd_≥l
);

876 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
weight
 * *
ªf_löe
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t
);

877 *
d
++ = (Ë(*
§c_löe
++ - 
weighãd_≥l
);

878 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
weight
 * *
ªf_löe
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t
);

879 *
d
++ = (Ë(*
§c_löe
++ - 
weighãd_≥l
);

881 
ªf_löe
 +
p_Vid
->
∑dded_size_x_m4x4
;

882 
§c_löe
 +
§c_size_x
;

884 
mco°
 +
	`Hadam¨dSAD4x4
 (
diff
);

886 if(
mco°
 > 
imö_co°
)

887  
	`di°_sˇÀ_f
((
di°blk
)
mco°
);

889 
§c_tmp
 +
§c_size_mul
;

894 
§c_size_x
 = (
blocksize_x
 - 
BLOCK_SIZE_8x8
);

895 
§c_size_mul
 = 
blocksize_x
 * 
BLOCK_SIZE_8x8
;

896 
y
 = 
ˇnd
->
mv_y
; y < c™d->mv_y + (
blocksize_y
<<2); y +(
BLOCK_SIZE_8x8_SP
) )

898 
x
=0; x<
blocksize_x
; x +
BLOCK_SIZE_8x8
 )

900 
d
 = 
diff
;

901 
ªf_löe
 = 
	`UMVLöe4X
 (
ªf1
, 
y
, 
ˇnd
->
mv_x
 + (
x
<<2));

902 
§c_löe
 = 
§c_tmp
 + 
x
;

903 
y4
 = 0; y4 < 
BLOCK_SIZE_8x8
; y4++ )

905 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
weight
 * *
ªf_löe
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t
);

906 *
d
++ = (Ë(*
§c_löe
++ - 
weighãd_≥l
);

907 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
weight
 * *
ªf_löe
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t
);

908 *
d
++ = (Ë(*
§c_löe
++ - 
weighãd_≥l
);

909 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
weight
 * *
ªf_löe
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t
);

910 *
d
++ = (Ë(*
§c_löe
++ - 
weighãd_≥l
);

911 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
weight
 * *
ªf_löe
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t
);

912 *
d
++ = (Ë(*
§c_löe
++ - 
weighãd_≥l
);

913 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
weight
 * *
ªf_löe
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t
);

914 *
d
++ = (Ë(*
§c_löe
++ - 
weighãd_≥l
);

915 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
weight
 * *
ªf_löe
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t
);

916 *
d
++ = (Ë(*
§c_löe
++ - 
weighãd_≥l
);

917 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
weight
 * *
ªf_löe
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t
);

918 *
d
++ = (Ë(*
§c_löe
++ - 
weighãd_≥l
);

919 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
weight
 * *
ªf_löe
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t
);

920 *
d
++ = (Ë(*
§c_löe
++ - 
weighãd_≥l
);

922 
ªf_löe
 +
p_Vid
->
∑dded_size_x_m8x8
;

923 
§c_löe
 +
§c_size_x
;

925 
mco°
 +
	`Hadam¨dSAD8x8
 (
diff
);

926 if(
mco°
 > 
imö_co°
)

927  
	`di°_sˇÀ_f
((
di°blk
)
mco°
);

929 
§c_tmp
 +
§c_size_mul
;

933 
	`CHECKOVERFLOW
(
mco°
);

934  
	`di°_sˇÀ
((
di°blk
)
mco°
);

935 
	}
}

943 
di°blk
 
	$compuãBiPªdSATD1
(
St‹abÀPi˘uª
 *
ªf1
,

944 
St‹abÀPi˘uª
 *
ªf2
,

945 
MEBlock
 *
mv_block
,

946 
di°blk
 
mö_mco°
,

947 
MŸi⁄Ve˘‹
 *
ˇnd1
,

948 
MŸi⁄Ve˘‹
 *
ˇnd2
)

950 
imö_co°
 = 
	`di°_down
(
mö_mco°
);

951 
mco°
 = 0;

952 
y
, 
x
, 
y4
;

953 
§c_size_x
, 
§c_size_mul
;

954 
img≥l
 *
§c_tmp
 = 
mv_block
->
‹ig_pic
[0];

955 *
d
, 
diff
[
MB_PIXELS
];

956 
img≥l
 *
§c_löe
, *
ªf1_löe
, *
ªf2_löe
;

957 
blocksize_x
 = 
mv_block
->blocksize_x;

958 
blocksize_y
 = 
mv_block
->blocksize_y;

959 
VideoP¨amëîs
 *
p_Vid
 = 
mv_block
->p_Vid;

961 i‡–!
mv_block
->
ã°8x8
 )

963 
§c_size_x
 = (
blocksize_x
 - 
BLOCK_SIZE
);

964 
§c_size_mul
 = 
blocksize_x
 * 
BLOCK_SIZE
;

965 
y
=0; y<(
blocksize_y
<<2); y +(
BLOCK_SIZE_SP
))

967 
x
=0; x<
blocksize_x
; x +
BLOCK_SIZE
)

969 
d
 = 
diff
;

970 
§c_löe
 = 
§c_tmp
 + 
x
;

971 
ªf2_löe
 = 
	`UMVLöe4X
(
ªf2
, 
ˇnd2
->
mv_y
 + 
y
, c™d2->
mv_x
 + (
x
<<2));

972 
ªf1_löe
 = 
	`UMVLöe4X
(
ªf1
, 
ˇnd1
->
mv_y
 + 
y
, c™d1->
mv_x
 + (
x
<<2));

973 
y4
 = 0; y4 < 
BLOCK_SIZE
; y4++ )

975 *
d
++ = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

976 *
d
++ = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

977 *
d
++ = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

978 *
d
++ = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

980 
ªf1_löe
 +
p_Vid
->
∑dded_size_x_m4x4
;

981 
ªf2_löe
 +
p_Vid
->
∑dded_size_x_m4x4
;

982 
§c_löe
 +
§c_size_x
;

984 
mco°
 +
	`Hadam¨dSAD4x4
 (
diff
);

985 if(
mco°
 > 
imö_co°
)

986  
	`di°_sˇÀ_f
((
di°blk
)
mco°
);

988 
§c_tmp
 +
§c_size_mul
;

993 
§c_size_x
 = (
blocksize_x
 - 
BLOCK_SIZE_8x8
);

994 
§c_size_mul
 = 
blocksize_x
 * 
BLOCK_SIZE_8x8
;

995 
y
=0; y<(
blocksize_y
 << 2); y +
BLOCK_SIZE_8x8_SP
 )

997 
y_pos2
 = 
ˇnd2
->
mv_y
 + 
y
;

998 
y_pos1
 = 
ˇnd1
->
mv_y
 + 
y
;

999 
x
=0; x<
blocksize_x
; x +
BLOCK_SIZE_8x8
 )

1001 
d
 = 
diff
;

1002 
§c_löe
 = 
§c_tmp
 + 
x
;

1003 
ªf2_löe
 = 
	`UMVLöe4X
(
ªf2
, 
y_pos2
, 
ˇnd2
->
mv_x
 + (
x
<<2));

1004 
ªf1_löe
 = 
	`UMVLöe4X
(
ªf1
, 
y_pos1
, 
ˇnd1
->
mv_x
 + (
x
<<2));

1005 
y4
 = 0; y4 < 
BLOCK_SIZE_8x8
; y4++ )

1007 *
d
++ = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

1008 *
d
++ = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

1009 *
d
++ = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

1010 *
d
++ = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

1011 *
d
++ = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

1012 *
d
++ = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

1013 *
d
++ = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

1014 *
d
++ = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

1016 
ªf1_löe
 +
p_Vid
->
∑dded_size_x_m8x8
;

1017 
ªf2_löe
 +
p_Vid
->
∑dded_size_x_m8x8
;

1018 
§c_löe
 +
§c_size_x
;

1020 
mco°
 +
	`Hadam¨dSAD8x8
 (
diff
);

1021 if(
mco°
 > 
imö_co°
)

1022  
	`di°_sˇÀ_f
((
di°blk
)
mco°
);

1024 
§c_tmp
 +
§c_size_mul
;

1028 
	`CHECKOVERFLOW
(
mco°
);

1029  
	`di°_sˇÀ
((
di°blk
)
mco°
);

1030 
	}
}

1038 
di°blk
 
	$compuãBiPªdSATD2
(
St‹abÀPi˘uª
 *
ªf1
,

1039 
St‹abÀPi˘uª
 *
ªf2
,

1040 
MEBlock
 *
mv_block
,

1041 
di°blk
 
mö_mco°
,

1042 
MŸi⁄Ve˘‹
 *
ˇnd1
,

1043 
MŸi⁄Ve˘‹
 *
ˇnd2
)

1045 
imö_co°
 = 
	`di°_down
(
mö_mco°
);

1046 
mco°
 = 0;

1047 
y
, 
x
, 
y4
;

1048 
weighãd_≥l
, 
pixñ1
, 
pixñ2
;

1049 
VideoP¨amëîs
 *
p_Vid
 = 
mv_block
->p_Vid;

1050 
Sli˚
 *
cuºSli˚
 = 
mv_block
->
p_Sli˚
;

1051 
díom
 = 
cuºSli˚
->
luma_log_weight_díom
 + 1;

1052 
Ãound
 = 2 * 
cuºSli˚
->
wp_luma_round
;

1053 
weight1
 = 
mv_block
->weight1;

1054 
weight2
 = 
mv_block
->weight2;

1055 
off£tBi
 = 
mv_block
->offsetBi;

1058 
max_img≥l_vÆue
 = 
p_Vid
->max_imgpel_value;

1059 
§c_size_x
, 
§c_size_mul
;

1060 
img≥l
 *
§c_tmp
 = 
mv_block
->
‹ig_pic
[0];

1061 *
d
, 
diff
[
MB_PIXELS
];

1062 
img≥l
 *
§c_löe
, *
ªf1_löe
, *
ªf2_löe
;

1063 
blocksize_x
 = 
mv_block
->blocksize_x;

1064 
blocksize_y
 = 
mv_block
->blocksize_y;

1066 i‡–!
mv_block
->
ã°8x8
 )

1068 
§c_size_x
 = (
blocksize_x
 - 
BLOCK_SIZE
);

1069 
§c_size_mul
 = 
blocksize_x
 * 
BLOCK_SIZE
;

1070 
y
=0; y<(
blocksize_y
<<2); y +
BLOCK_SIZE_SP
)

1072 
x
=0; x<
blocksize_x
; x +
BLOCK_SIZE
)

1074 
d
 = 
diff
;

1075 
§c_löe
 = 
§c_tmp
 + 
x
;

1076 
ªf2_löe
 = 
	`UMVLöe4X
(
ªf2
, 
ˇnd2
->
mv_y
 + 
y
, c™d2->
mv_x
 + (
x
<<2));

1077 
ªf1_löe
 = 
	`UMVLöe4X
(
ªf1
, 
ˇnd1
->
mv_y
 + 
y
, c™d1->
mv_x
 + (
x
<<2));

1078 
y4
 = 0; y4 < 
BLOCK_SIZE
; y4++ )

1081 
pixñ1
 = 
weight1
 * (*
ªf1_löe
++);

1082 
pixñ2
 = 
weight2
 * (*
ªf2_löe
++);

1083 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
pixñ1
 + 
pixñ2
 + 
Ãound
Ë>> 
díom
Ë+ 
off£tBi
);

1084 *
d
++ = (Ë((*
§c_löe
++Ë- 
weighãd_≥l
);

1086 
pixñ1
 = 
weight1
 * (*
ªf1_löe
++);

1087 
pixñ2
 = 
weight2
 * (*
ªf2_löe
++);

1088 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
pixñ1
 + 
pixñ2
 + 
Ãound
Ë>> 
díom
Ë+ 
off£tBi
);

1089 *
d
++ = (Ë((*
§c_löe
++Ë- 
weighãd_≥l
);

1091 
pixñ1
 = 
weight1
 * (*
ªf1_löe
++);

1092 
pixñ2
 = 
weight2
 * (*
ªf2_löe
++);

1093 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
pixñ1
 + 
pixñ2
 + 
Ãound
Ë>> 
díom
Ë+ 
off£tBi
);

1094 *
d
++ = (Ë((*
§c_löe
++Ë- 
weighãd_≥l
);

1096 
pixñ1
 = 
weight1
 * (*
ªf1_löe
++);

1097 
pixñ2
 = 
weight2
 * (*
ªf2_löe
++);

1098 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
pixñ1
 + 
pixñ2
 + 
Ãound
Ë>> 
díom
Ë+ 
off£tBi
);

1099 *
d
++ = (Ë((*
§c_löe
++Ë- 
weighãd_≥l
);

1101 
ªf1_löe
 +
p_Vid
->
∑dded_size_x_m4x4
;

1102 
ªf2_löe
 +
p_Vid
->
∑dded_size_x_m4x4
;

1103 
§c_löe
 +
§c_size_x
;

1105 
mco°
 +
	`Hadam¨dSAD4x4
 (
diff
);

1106 if(
mco°
 > 
imö_co°
)

1107  
	`di°_sˇÀ_f
((
di°blk
)
mco°
);

1109 
§c_tmp
 +
§c_size_mul
;

1114 
§c_size_x
 = (
blocksize_x
 - 
BLOCK_SIZE_8x8
);

1115 
§c_size_mul
 = 
blocksize_x
 * 
BLOCK_SIZE_8x8
;

1116 
y
=0; y < (
blocksize_y
 << 2); y +
BLOCK_SIZE_8x8_SP
 )

1118 
y_pos2
 = 
ˇnd2
->
mv_y
 + 
y
;

1119 
y_pos1
 = 
ˇnd1
->
mv_y
 + 
y
;

1120 
x
=0; x<
blocksize_x
; x +
BLOCK_SIZE_8x8
 )

1122 
d
 = 
diff
;

1123 
§c_löe
 = 
§c_tmp
 + 
x
;

1124 
ªf2_löe
 = 
	`UMVLöe4X
(
ªf2
, 
y_pos2
, 
ˇnd2
->
mv_x
 + (
x
<<2));

1125 
ªf1_löe
 = 
	`UMVLöe4X
(
ªf1
, 
y_pos1
, 
ˇnd1
->
mv_x
 + (
x
<<2));

1126 
y4
 = 0; y4 < 
BLOCK_SIZE_8x8
; y4++ )

1129 
pixñ1
 = 
weight1
 * (*
ªf1_löe
++);

1130 
pixñ2
 = 
weight2
 * (*
ªf2_löe
++);

1131 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
pixñ1
 + 
pixñ2
 + 
Ãound
Ë>> 
díom
Ë+ 
off£tBi
);

1132 *
d
++ = (Ë((*
§c_löe
++Ë- 
weighãd_≥l
);

1134 
pixñ1
 = 
weight1
 * (*
ªf1_löe
++);

1135 
pixñ2
 = 
weight2
 * (*
ªf2_löe
++);

1136 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
pixñ1
 + 
pixñ2
 + 
Ãound
Ë>> 
díom
Ë+ 
off£tBi
);

1137 *
d
++ = (Ë((*
§c_löe
++Ë- 
weighãd_≥l
);

1139 
pixñ1
 = 
weight1
 * (*
ªf1_löe
++);

1140 
pixñ2
 = 
weight2
 * (*
ªf2_löe
++);

1141 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
pixñ1
 + 
pixñ2
 + 
Ãound
Ë>> 
díom
Ë+ 
off£tBi
);

1142 *
d
++ = (Ë((*
§c_löe
++Ë- 
weighãd_≥l
);

1144 
pixñ1
 = 
weight1
 * (*
ªf1_löe
++);

1145 
pixñ2
 = 
weight2
 * (*
ªf2_löe
++);

1146 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
pixñ1
 + 
pixñ2
 + 
Ãound
Ë>> 
díom
Ë+ 
off£tBi
);

1147 *
d
++ = (Ë((*
§c_löe
++Ë- 
weighãd_≥l
);

1149 
pixñ1
 = 
weight1
 * (*
ªf1_löe
++);

1150 
pixñ2
 = 
weight2
 * (*
ªf2_löe
++);

1151 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
pixñ1
 + 
pixñ2
 + 
Ãound
Ë>> 
díom
Ë+ 
off£tBi
);

1152 *
d
++ = (Ë((*
§c_löe
++Ë- 
weighãd_≥l
);

1154 
pixñ1
 = 
weight1
 * (*
ªf1_löe
++);

1155 
pixñ2
 = 
weight2
 * (*
ªf2_löe
++);

1156 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
pixñ1
 + 
pixñ2
 + 
Ãound
Ë>> 
díom
Ë+ 
off£tBi
);

1157 *
d
++ = (Ë((*
§c_löe
++Ë- 
weighãd_≥l
);

1159 
pixñ1
 = 
weight1
 * (*
ªf1_löe
++);

1160 
pixñ2
 = 
weight2
 * (*
ªf2_löe
++);

1161 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
pixñ1
 + 
pixñ2
 + 
Ãound
Ë>> 
díom
Ë+ 
off£tBi
);

1162 *
d
++ = (Ë((*
§c_löe
++Ë- 
weighãd_≥l
);

1164 
pixñ1
 = 
weight1
 * (*
ªf1_löe
++);

1165 
pixñ2
 = 
weight2
 * (*
ªf2_löe
++);

1166 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
pixñ1
 + 
pixñ2
 + 
Ãound
Ë>> 
díom
Ë+ 
off£tBi
);

1167 *
d
++ = (Ë((*
§c_löe
Ë- 
weighãd_≥l
);

1169 
ªf1_löe
 +
p_Vid
->
∑dded_size_x_m8x8
;

1170 
ªf2_löe
 +
p_Vid
->
∑dded_size_x_m8x8
;

1171 
§c_löe
 +
§c_size_x
;

1173 
mco°
 +
	`Hadam¨dSAD8x8
 (
diff
);

1174 if(
mco°
 > 
imö_co°
)

1175  
	`di°_sˇÀ_f
((
di°blk
)
mco°
);

1177 
§c_tmp
 +
§c_size_mul
;

1180 
	`CHECKOVERFLOW
(
mco°
);

1181  
	`di°_sˇÀ
((
di°blk
)
mco°
);

1182 
	}
}

1190 
di°blk
 
	$compuãSSE
(
St‹abÀPi˘uª
 *
ªf1
,

1191 
MEBlock
 *
mv_block
,

1192 
di°blk
 
mö_mco°
,

1193 
MŸi⁄Ve˘‹
 *
ˇnd


1196 
imö_co°
 = 
	`di°_down
(
mö_mco°
);

1197 
mco°
 = 0;

1198 
y
,
x
;

1199 
blocksize_x
 = 
mv_block
->blocksize_x;

1200 
blocksize_y
 = 
mv_block
->blocksize_y;

1201 
VideoP¨amëîs
 *
p_Vid
 = 
mv_block
->p_Vid;

1202 
∑d_size_x
 = 
p_Vid
->
∑dded_size_x
 - 
blocksize_x
;

1204 
img≥l
 *
§c_löe
 = 
mv_block
->
‹ig_pic
[0];

1205 
img≥l
 *
ªf_löe
 = 
	`UMVLöe4X
 (
ªf1
, 
ˇnd
->
mv_y
, c™d->
mv_x
);

1207 
y
=0; y<
blocksize_y
; y++)

1209 
x
 = 0; x < 
blocksize_x
; x+=4)

1211 
mco°
 +
	`übs2
–*
§c_löe
++ - *
ªf_löe
++ );

1212 
mco°
 +
	`übs2
–*
§c_löe
++ - *
ªf_löe
++ );

1213 
mco°
 +
	`übs2
–*
§c_löe
++ - *
ªf_löe
++ );

1214 
mco°
 +
	`übs2
–*
§c_löe
++ - *
ªf_löe
++ );

1216 if(
mco°
 > 
imö_co°
)

1217  
	`di°_sˇÀ_f
((
di°blk
)
mco°
);

1218 
ªf_löe
 +
∑d_size_x
;

1221 i‡–
mv_block
->
ChromaMEE«bÀ
 )

1224 
blocksize_x_¸
 = 
mv_block
->
blocksize_¸_x
;

1225 
blocksize_y_¸
 = 
mv_block
->
blocksize_¸_y
;

1226 
¸_∑d_size_x
 = 
p_Vid
->
¸_∑dded_size_x
 - 
blocksize_x_¸
;

1227 
k
;

1228 
m¸_co°
 = 0;

1230 
k
=0; k<2; k++)

1232 
m¸_co°
 = 0;

1233 
§c_löe
 = 
mv_block
->
‹ig_pic
[
k
+1];

1234 
ªf_löe
 = 
	`UMVLöe8X_chroma
 ( 
ªf1
, 
k
+1, 
ˇnd
->
mv_y
, c™d->
mv_x
);

1235 
y
=0; y<
blocksize_y_¸
; y++)

1237 
x
 = 0; x < 
blocksize_x_¸
; x+=2)

1239 
m¸_co°
 +
	`übs2
–*
§c_löe
++ - *
ªf_löe
++ );

1240 
m¸_co°
 +
	`übs2
–*
§c_löe
++ - *
ªf_löe
++ );

1242 
ªf_löe
 +
¸_∑d_size_x
;

1244 
mco°
 +
mv_block
->
ChromaMEWeight
 * 
m¸_co°
;

1245 if(
mco°
 > 
imö_co°
)

1246  
	`di°_sˇÀ_f
((
di°blk
)
mco°
);

1250 
	`CHECKOVERFLOW
(
mco°
);

1251  
	`di°_sˇÀ
((
di°blk
)
mco°
);

1252 
	}
}

1261 
di°blk
 
	$compuãSSEWP
(
St‹abÀPi˘uª
 *
ªf1
,

1262 
MEBlock
 *
mv_block
,

1263 
di°blk
 
mö_mco°
,

1264 
MŸi⁄Ve˘‹
 *
ˇnd


1267 
imö_co°
 = 
	`di°_down
(
mö_mco°
);

1268 
mco°
 = 0;

1269 
y
,
x
;

1270 
weighãd_≥l
;

1271 
blocksize_x
 = 
mv_block
->blocksize_x;

1272 
blocksize_y
 = 
mv_block
->blocksize_y;

1273 
VideoP¨amëîs
 *
p_Vid
 = 
mv_block
->p_Vid;

1274 
Sli˚
 *
cuºSli˚
 = 
mv_block
->
p_Sli˚
;

1275 
weight
 = 
mv_block
->
weight_luma
;

1276 
off£t
 = 
mv_block
->
off£t_luma
;

1278 
wp_luma_round
 = 
cuºSli˚
->wp_luma_round;

1279 
∑d_size_x
 = 
p_Vid
->
∑dded_size_x
 - 
blocksize_x
;

1280 
max_img≥l_vÆue
 = 
p_Vid
->max_imgpel_value;

1281 
luma_log_weight_díom
 = 
cuºSli˚
->luma_log_weight_denom;

1283 
img≥l
 *
§c_löe
 = 
mv_block
->
‹ig_pic
[0];

1284 
img≥l
 *
ªf_löe
 = 
	`UMVLöe4X
 (
ªf1
, 
ˇnd
->
mv_y
, c™d->
mv_x
);

1286 
y
=0; y<
blocksize_y
; y++)

1288 
x
 = 0; x < 
blocksize_x
; x+=4)

1290 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
weight
 * *
ªf_löe
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t
);

1291 
mco°
 +
	`übs2
–*
§c_löe
++ - 
weighãd_≥l
 );

1292 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
weight
 * *
ªf_löe
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t
);

1293 
mco°
 +
	`übs2
–*
§c_löe
++ - 
weighãd_≥l
 );

1294 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
weight
 * *
ªf_löe
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t
);

1295 
mco°
 +
	`übs2
–*
§c_löe
++ - 
weighãd_≥l
 );

1296 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
weight
 * *
ªf_löe
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t
);

1297 
mco°
 +
	`übs2
–*
§c_löe
++ - 
weighãd_≥l
 );

1299 if(
mco°
 > 
imö_co°
)

1300  
	`di°_sˇÀ_f
((
di°blk
)
mco°
);

1301 
ªf_löe
 +
∑d_size_x
;

1304 i‡–
mv_block
->
ChromaMEE«bÀ
 )

1308 
blocksize_x_¸
 = 
mv_block
->
blocksize_¸_x
;

1309 
blocksize_y_¸
 = 
mv_block
->
blocksize_¸_y
;

1310 
¸_∑d_size_x
 = 
p_Vid
->
¸_∑dded_size_x
 - 
blocksize_x_¸
;

1311 
k
;

1312 
m¸_co°
 = 0;

1313 
max_img≥l_vÆue_uv
 = 
p_Vid
->
max_≥l_vÆue_comp
[1];

1314 
wp_chroma_round
 = 
cuºSli˚
->wp_chroma_round;

1315 
chroma_log_weight_díom
 = 
cuºSli˚
->chroma_log_weight_denom;

1317 
k
=0; k<2; k++)

1319 
weight
 = 
mv_block
->
weight_¸
[
k
];

1320 
off£t
 = 
mv_block
->
off£t_¸
[
k
];

1322 
m¸_co°
 = 0;

1323 
§c_löe
 = 
mv_block
->
‹ig_pic
[
k
+1];

1324 
ªf_löe
 = 
	`UMVLöe8X_chroma
 ( 
ªf1
, 
k
+1, 
ˇnd
->
mv_y
, c™d->
mv_x
);

1325 
y
=0; y<
blocksize_y_¸
; y++)

1328 
x
 = 0; x < 
blocksize_x_¸
; x+=2)

1330 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue_uv
, ((
weight
 * *
ªf_löe
++ + 
wp_chroma_round
Ë>> 
chroma_log_weight_díom
Ë+ 
off£t
);

1331 
m¸_co°
 +
	`übs2
–*
§c_löe
++ - 
weighãd_≥l
 );

1332 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue_uv
, ((
weight
 * *
ªf_löe
++ + 
wp_chroma_round
Ë>> 
chroma_log_weight_díom
Ë+ 
off£t
);

1333 
m¸_co°
 +
	`übs2
–*
§c_löe
++ - 
weighãd_≥l
 );

1335 
ªf_löe
 +
¸_∑d_size_x
;

1337 
mco°
 +
mv_block
->
ChromaMEWeight
 * 
m¸_co°
;

1338 if(
mco°
 > 
imö_co°
)

1339  
	`di°_sˇÀ_f
((
di°blk
)
mco°
);

1343 
	`CHECKOVERFLOW
(
mco°
);

1344  
	`di°_sˇÀ
((
di°blk
)
mco°
);

1345 
	}
}

1353 
di°blk
 
	$compuãBiPªdSSE1
(
St‹abÀPi˘uª
 *
ªf1
,

1354 
St‹abÀPi˘uª
 *
ªf2
,

1355 
MEBlock
 *
mv_block
,

1356 
di°blk
 
mö_mco°
,

1357 
MŸi⁄Ve˘‹
 *
ˇnd1
,

1358 
MŸi⁄Ve˘‹
 *
ˇnd2
)

1360 
imö_co°
 = 
	`di°_down
(
mö_mco°
);

1361 
mco°
 = 0;

1362 
bi_diff
;

1363 
y
,
x
;

1364 
blocksize_x
 = 
mv_block
->blocksize_x;

1365 
blocksize_y
 = 
mv_block
->blocksize_y;

1366 
VideoP¨amëîs
 *
p_Vid
 = 
mv_block
->p_Vid;

1367 
∑d_size_x
 = 
p_Vid
->
∑dded_size_x
 - 
blocksize_x
;

1369 
img≥l
 *
§c_löe
 = 
mv_block
->
‹ig_pic
[0];

1370 
img≥l
 *
ªf2_löe
 = 
	`UMVLöe4X
(
ªf2
, 
ˇnd2
->
mv_y
, c™d2->
mv_x
);

1371 
img≥l
 *
ªf1_löe
 = 
	`UMVLöe4X
(
ªf1
, 
ˇnd1
->
mv_y
, c™d1->
mv_x
);

1373 
y
 = 0; y < 
blocksize_y
; y++)

1375 
x
 = 0; x < 
blocksize_x
; x+=4)

1377 
bi_diff
 = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

1378 
mco°
 +
	`übs2
(
bi_diff
);

1379 
bi_diff
 = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

1380 
mco°
 +
	`übs2
(
bi_diff
);

1381 
bi_diff
 = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

1382 
mco°
 +
	`übs2
(
bi_diff
);

1383 
bi_diff
 = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

1384 
mco°
 +
	`übs2
(
bi_diff
);

1386 if(
mco°
 > 
imö_co°
)

1387  
	`di°_sˇÀ_f
((
di°blk
)
mco°
);

1389 
ªf2_löe
 +
∑d_size_x
;

1390 
ªf1_löe
 +
∑d_size_x
;

1393 i‡–
mv_block
->
ChromaMEE«bÀ
 )

1396 
blocksize_x_¸
 = 
mv_block
->
blocksize_¸_x
;

1397 
blocksize_y_¸
 = 
mv_block
->
blocksize_¸_y
;

1398 
¸_∑d_size_x
 = 
p_Vid
->
¸_∑dded_size_x
 - 
blocksize_x_¸
;

1399 
k
;

1400 
m¸_co°
 = 0;

1402 
k
=0; k<2; k++)

1404 
m¸_co°
 = 0;

1405 
§c_löe
 = 
mv_block
->
‹ig_pic
[
k
+1];

1406 
ªf2_löe
 = 
	`UMVLöe8X_chroma
 ( 
ªf2
, 
k
+1, 
ˇnd2
->
mv_y
, c™d2->
mv_x
);

1407 
ªf1_löe
 = 
	`UMVLöe8X_chroma
 ( 
ªf1
, 
k
+1, 
ˇnd1
->
mv_y
, c™d1->
mv_x
);

1409 
y
=0; y<
blocksize_y_¸
; y++)

1411 
x
 = 0; x < 
blocksize_x_¸
; x+=2)

1413 
bi_diff
 = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

1414 
m¸_co°
 +
	`übs2
(
bi_diff
);

1415 
bi_diff
 = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

1416 
m¸_co°
 +
	`übs2
(
bi_diff
);

1418 
ªf2_löe
 +
¸_∑d_size_x
;

1419 
ªf1_löe
 +
¸_∑d_size_x
;

1421 
mco°
 +
mv_block
->
ChromaMEWeight
 * 
m¸_co°
;

1422 if(
mco°
 > 
imö_co°
)

1423  
	`di°_sˇÀ_f
((
di°blk
)
mco°
);

1427 
	`CHECKOVERFLOW
(
mco°
);

1428  
	`di°_sˇÀ
((
di°blk
)
mco°
);

1429 
	}
}

1438 
di°blk
 
	$compuãBiPªdSSE2
(
St‹abÀPi˘uª
 *
ªf1
,

1439 
St‹abÀPi˘uª
 *
ªf2
,

1440 
MEBlock
 *
mv_block
,

1441 
di°blk
 
mö_mco°
,

1442 
MŸi⁄Ve˘‹
 *
ˇnd1
,

1443 
MŸi⁄Ve˘‹
 *
ˇnd2
)

1445 
imö_co°
 = 
	`di°_down
(
mö_mco°
);

1446 
mco°
 = 0;

1447 
bi_diff
;

1448 
VideoP¨amëîs
 *
p_Vid
 = 
mv_block
->p_Vid;

1449 
Sli˚
 *
cuºSli˚
 = 
mv_block
->
p_Sli˚
;

1450 
díom
 = 
cuºSli˚
->
luma_log_weight_díom
 + 1;

1451 
Ãound
 = 2 * 
cuºSli˚
->
wp_luma_round
;

1452 
max_img≥l_vÆue
 = 
p_Vid
->max_imgpel_value;

1453 
y
,
x
;

1454 
weighãd_≥l
, 
pixñ1
, 
pixñ2
;

1455 
weight1
 = 
mv_block
->weight1;

1456 
weight2
 = 
mv_block
->weight2;

1457 
off£tBi
 = 
mv_block
->offsetBi;

1459 
blocksize_x
 = 
mv_block
->blocksize_x;

1460 
blocksize_y
 = 
mv_block
->blocksize_y;

1461 
∑d_size_x
 = 
p_Vid
->
∑dded_size_x
 - 
blocksize_x
;

1463 
img≥l
 *
§c_löe
 = 
mv_block
->
‹ig_pic
[0];

1464 
img≥l
 *
ªf2_löe
 = 
	`UMVLöe4X
(
ªf2
, 
ˇnd2
->
mv_y
, c™d2->
mv_x
);

1465 
img≥l
 *
ªf1_löe
 = 
	`UMVLöe4X
(
ªf1
, 
ˇnd1
->
mv_y
, c™d1->
mv_x
);

1466 
y
=0; y<
blocksize_y
; y++)

1468 
x
 = 0; x < 
blocksize_x
; x+=4)

1470 
pixñ1
 = 
weight1
 * (*
ªf1_löe
++);

1471 
pixñ2
 = 
weight2
 * (*
ªf2_löe
++);

1472 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
pixñ1
 + 
pixñ2
 + 
Ãound
Ë>> 
díom
Ë+ 
off£tBi
);

1473 
bi_diff
 = (*
§c_löe
++Ë- 
weighãd_≥l
;

1474 
mco°
 +
bi_diff
 * bi_diff;

1476 
pixñ1
 = 
weight1
 * (*
ªf1_löe
++);

1477 
pixñ2
 = 
weight2
 * (*
ªf2_löe
++);

1478 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
pixñ1
 + 
pixñ2
 + 
Ãound
Ë>> 
díom
Ë+ 
off£tBi
);

1479 
bi_diff
 = (*
§c_löe
++Ë- 
weighãd_≥l
;

1480 
mco°
 +
bi_diff
 * bi_diff;

1482 
pixñ1
 = 
weight1
 * (*
ªf1_löe
++);

1483 
pixñ2
 = 
weight2
 * (*
ªf2_löe
++);

1484 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
pixñ1
 + 
pixñ2
 + 
Ãound
Ë>> 
díom
Ë+ 
off£tBi
);

1485 
bi_diff
 = (*
§c_löe
++Ë- 
weighãd_≥l
;

1486 
mco°
 +
bi_diff
 * bi_diff;

1488 
pixñ1
 = 
weight1
 * (*
ªf1_löe
++);

1489 
pixñ2
 = 
weight2
 * (*
ªf2_löe
++);

1490 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
pixñ1
 + 
pixñ2
 + 
Ãound
Ë>> 
díom
Ë+ 
off£tBi
);

1491 
bi_diff
 = (*
§c_löe
++Ë- 
weighãd_≥l
;

1492 
mco°
 +
bi_diff
 * bi_diff;

1494 if(
mco°
 > 
imö_co°
)

1495  
	`di°_sˇÀ_f
((
di°blk
)
mco°
);

1497 
ªf2_löe
 +
∑d_size_x
;

1498 
ªf1_löe
 +
∑d_size_x
;

1501 i‡–
mv_block
->
ChromaMEE«bÀ
 )

1504 
blocksize_x_¸
 = 
mv_block
->
blocksize_¸_x
;

1505 
blocksize_y_¸
 = 
mv_block
->
blocksize_¸_y
;

1506 
¸_∑d_size_x
 = 
p_Vid
->
¸_∑dded_size_x
 - 
blocksize_x_¸
;

1507 
k
;

1508 
m¸_co°
 = 0;

1509 
max_img≥l_vÆue_uv
 = 
p_Vid
->
max_≥l_vÆue_comp
[1];

1511 
k
=0; k<2; k++)

1513 
weight1
 = 
mv_block
->
weight1_¸
[
k
];

1514 
weight2
 = 
mv_block
->
weight2_¸
[
k
];

1515 
off£tBi
 = 
mv_block
->
off£tBi_¸
[
k
];

1517 
m¸_co°
 = 0;

1518 
§c_löe
 = 
mv_block
->
‹ig_pic
[
k
+1];

1519 
ªf2_löe
 = 
	`UMVLöe8X_chroma
 ( 
ªf2
, 
k
+1, 
ˇnd2
->
mv_y
, c™d2->
mv_x
);

1520 
ªf1_löe
 = 
	`UMVLöe8X_chroma
 ( 
ªf1
, 
k
+1, 
ˇnd1
->
mv_y
, c™d1->
mv_x
);

1522 
y
=0; y<
blocksize_y_¸
; y++)

1524 
x
 = 0; x < 
blocksize_x_¸
; x+=2)

1526 
pixñ1
 = 
weight1
 * (*
ªf1_löe
++);

1527 
pixñ2
 = 
weight2
 * (*
ªf2_löe
++);

1528 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue_uv
, ((
pixñ1
 + 
pixñ2
 + 
Ãound
Ë>> 
díom
Ë+ 
off£tBi
);

1529 
bi_diff
 = (*
§c_löe
++Ë- 
weighãd_≥l
;

1530 
m¸_co°
 +
bi_diff
 * bi_diff;

1532 
pixñ1
 = 
weight1
 * (*
ªf1_löe
++);

1533 
pixñ2
 = 
weight2
 * (*
ªf2_löe
++);

1534 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue_uv
, ((
pixñ1
 + 
pixñ2
 + 
Ãound
Ë>> 
díom
Ë+ 
off£tBi
);

1535 
bi_diff
 = (*
§c_löe
++Ë- 
weighãd_≥l
;

1536 
m¸_co°
 +
bi_diff
 * bi_diff;

1538 
ªf2_löe
 +
¸_∑d_size_x
;

1539 
ªf1_löe
 +
¸_∑d_size_x
;

1541 
mco°
 +
mv_block
->
ChromaMEWeight
 * 
m¸_co°
;

1542 if(
mco°
 > 
imö_co°
)

1543  
	`di°_sˇÀ_f
((
di°blk
)
mco°
);

1547 
	`CHECKOVERFLOW
(
mco°
);

1548  
	`di°_sˇÀ
((
di°blk
)
mco°
);

1549 
	}
}

1552 
	$ˇlcDif„ªn˚
(
img≥l
 **
‹igImg
, 
ox
, 
oy
, img≥»**
¥edImg
, 
px
, 
py
, 
width
, 
height
, *
diff
)

1554 
i
, 
j
;

1555 
img≥l
 *
‹ig
, *
¥ed
;

1556 
j
 = 0; j < 
height
; j++)

1558 
‹ig
 = 
‹igImg
[
oy
+
j
]+
ox
;

1559 
¥ed
 = 
¥edImg
[
py
+
j
]+
px
;

1560 
i
 = 0; i < 
width
; i++)

1562 *
diff
++ = *
‹ig
++ - *
¥ed
++;

1565 
	}
}

	@lencod/src/me_distortion_otf.c

12 
	~"c⁄åibut‹s.h
"

14 
	~<limôs.h
>

16 
	~"globÆ.h
"

17 
	~"image.h
"

18 
	~"memÆloc.h
"

19 
	~"mb_ac˚ss.h
"

20 
	~"mv_£¨ch.h
"

21 
	~"me_di°‹ti⁄.h
"

22 
	~"me_di°‹ti⁄_Ÿf.h
"

23 
	~"gë_block_Ÿf.h
"

25 
	~"ªfbuf_Ÿf.h
"

29 
	#CHECKOVERFLOW
(
mco°
)

	)

38 
di°blk
 
	$compuãSAD_Ÿf
(
St‹abÀPi˘uª
 *
ªf1
,

39 
MEBlock
 *
mv_block
,

40 
di°blk
 
mö_mco°
,

41 
MŸi⁄Ve˘‹
 *
ˇnd
)

43 
mco°
 = 0;

44 
imö_co°
 = 
	`di°_down
(
mö_mco°
);

45 
y
,
x
;

46 
blocksize_x
 = 
mv_block
->blocksize_x;

47 
blocksize_y
 = 
mv_block
->blocksize_y;

48 
VideoP¨amëîs
 *
p_Vid
 = 
mv_block
->p_Vid;

49 
DecodedPi˘uªBuf„r
 *
p_Dpb
 = 
p_Vid
->
p_Dpb_œyî
[p_Vid->
dpb_œyî_id
];

50 #i‡(
JM_MEM_DISTORTION
)

51 *
img≥l_abs
 = 
p_Vid
->imgpel_abs;

53 
img≥l
 *
§c_löe
, *
ªf_löe
 ;

54 
img≥l
 
d©a
[
MB_PIXELS
];

55 
tmp_löe
[ (
MB_BLOCK_SIZE
+5)*(MB_BLOCK_SIZE+5) ] ;

57 
§c_löe
 = 
mv_block
->
‹ig_pic
[0];

58 
ªf_löe
 = 
d©a
 ;

60 
p_Dpb
->
	`pf_gë_block_luma
–
p_Vid
, 
ªf_löe
, 
tmp_löe
, 
ˇnd
->
mv_x
, c™d->
mv_y
, 
blocksize_x
, 
blocksize_y
, 
ªf1
, 0 ) ;

62 
y
=0; y<
blocksize_y
; y++)

64 
x
 = 0; x < 
blocksize_x
; x+=4)

66 #i‡(
JM_MEM_DISTORTION
)

67 
mco°
 +
img≥l_abs
[ *
§c_löe
++ - *
ªf_löe
++ ];

68 
mco°
 +
img≥l_abs
[ *
§c_löe
++ - *
ªf_löe
++ ];

69 
mco°
 +
img≥l_abs
[ *
§c_löe
++ - *
ªf_löe
++ ];

70 
mco°
 +
img≥l_abs
[ *
§c_löe
++ - *
ªf_löe
++ ];

72 
mco°
 +
	`übs
–*
§c_löe
++ - *
ªf_löe
++ );

73 
mco°
 +
	`übs
–*
§c_löe
++ - *
ªf_löe
++ );

74 
mco°
 +
	`übs
–*
§c_löe
++ - *
ªf_löe
++ );

75 
mco°
 +
	`übs
–*
§c_löe
++ - *
ªf_löe
++ );

78 if(
mco°
 > 
imö_co°
)

79  (
	`di°_sˇÀ_f
((
di°blk
)
mco°
));

81 i‡–
mv_block
->
ChromaMEE«bÀ
 )

84 
blocksize_x_¸
 = 
mv_block
->
blocksize_¸_x
;

85 
blocksize_y_¸
 = 
mv_block
->
blocksize_¸_y
;

86 
k
;

87 
m¸_co°
 = 0;

89 
k
=0; k < 2; k++)

91 
§c_löe
 = 
mv_block
->
‹ig_pic
[
k
+1];

92 
ªf_löe
 = 
d©a
 ;

93 
p_Dpb
->
pf_gë_block_chroma
[
OTF_ME
]–
p_Vid
, 
ªf_löe
, 
tmp_löe
, 
ˇnd
->
mv_x
, c™d->
mv_y
, 
blocksize_x_¸
, 
blocksize_y_¸
, 
ªf1
, 
k
+1 ) ;

94 
m¸_co°
 = 0;

96 
y
 = 0; y < 
blocksize_y_¸
; y++)

98 
x
 = 0; x < 
blocksize_x_¸
; x += 2)

100 #i‡(
JM_MEM_DISTORTION
)

101 
m¸_co°
 +
img≥l_abs
[ *
§c_löe
++ - *
ªf_löe
++ ];

102 
m¸_co°
 +
img≥l_abs
[ *
§c_löe
++ - *
ªf_löe
++ ];

104 
m¸_co°
 +
	`übs
–*
§c_löe
++ - *
ªf_löe
++ );

105 
m¸_co°
 +
	`übs
–*
§c_löe
++ - *
ªf_löe
++ );

109 
mco°
 +
mv_block
->
ChromaMEWeight
 * 
m¸_co°
;

111 if(
mco°
 >
imö_co°
)

112  (
	`di°_sˇÀ_f
((
di°blk
)
mco°
));

116 
	`CHECKOVERFLOW
(
mco°
);

117  (
	`di°_sˇÀ
((
di°blk
)
mco°
));

118 
	}
}

126 
di°blk
 
	$compuãSADWP_Ÿf
(
St‹abÀPi˘uª
 *
ªf1
,

127 
MEBlock
 *
mv_block
,

128 
di°blk
 
mö_mco°
,

129 
MŸi⁄Ve˘‹
 *
ˇnd


132 
mco°
 = 0;

133 
imö_co°
 = 
	`di°_down
(
mö_mco°
);

134 
y
, 
x
;

135 
weighãd_≥l
;

136 
blocksize_x
 = 
mv_block
->blocksize_x;

137 
blocksize_y
 = 
mv_block
->blocksize_y;

139 
VideoP¨amëîs
 *
p_Vid
 = 
mv_block
->p_Vid;

140 
Sli˚
 *
cuºSli˚
 = 
mv_block
->
p_Sli˚
;

141 
DecodedPi˘uªBuf„r
 *
p_Dpb
 = 
p_Vid
->
p_Dpb_œyî
[p_Vid->
dpb_œyî_id
];

142 
max_img≥l_vÆue
 = 
p_Vid
->max_imgpel_value;

143 
weight
 = 
mv_block
->
weight_luma
;

144 
off£t
 = 
mv_block
->
off£t_luma
;

146 
wp_luma_round
 = 
cuºSli˚
->wp_luma_round;

147 
luma_log_weight_díom
 = 
cuºSli˚
->luma_log_weight_denom;

149 
img≥l
 *
§c_löe
, *
ªf_löe
 ;

150 
img≥l
 
d©a
[
MB_PIXELS
];

151 
tmp_löe
[ (
MB_BLOCK_SIZE
+5)*(MB_BLOCK_SIZE+5) ] ;

153 
§c_löe
 = 
mv_block
->
‹ig_pic
[0];

154 
ªf_löe
 = 
d©a
 ;

156 
p_Dpb
->
	`pf_gë_block_luma
–
p_Vid
, 
ªf_löe
, 
tmp_löe
, 
ˇnd
->
mv_x
, c™d->
mv_y
, 
blocksize_x
, 
blocksize_y
, 
ªf1
, 0 );

158 
y
=0; y<
blocksize_y
; y++)

160 
x
 = 0; x < 
blocksize_x
; x+=4)

162 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
weight
 * *
ªf_löe
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t
);

163 
mco°
 +
	`übs
–*
§c_löe
++ - 
weighãd_≥l
 );

164 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
weight
 * *
ªf_löe
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t
);

165 
mco°
 +
	`übs
–*
§c_löe
++ - 
weighãd_≥l
 );

166 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
weight
 * *
ªf_löe
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t
);

167 
mco°
 +
	`übs
–*
§c_löe
++ - 
weighãd_≥l
 );

168 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
weight
 * *
ªf_löe
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t
);

169 
mco°
 +
	`übs
–*
§c_löe
++ - 
weighãd_≥l
 );

171 if(
mco°
 > 
imö_co°
)

172  (
	`di°_sˇÀ_f
((
di°blk
)
mco°
));

174 i‡–
mv_block
->
ChromaMEE«bÀ
 )

177 
blocksize_x_¸
 = 
mv_block
->
blocksize_¸_x
;

178 
blocksize_y_¸
 = 
mv_block
->
blocksize_¸_y
;

179 
k
;

180 
m¸_co°
 = 0;

181 
max_img≥l_vÆue_uv
 = 
p_Vid
->
max_≥l_vÆue_comp
[1];

182 
wp_chroma_round
 = 
cuºSli˚
->wp_chroma_round;

183 
chroma_log_weight_díom
 = 
cuºSli˚
->chroma_log_weight_denom;

185 
k
=0; k < 2; k++)

187 
weight
 = 
mv_block
->
weight_¸
[
k
];

188 
off£t
 = 
mv_block
->
off£t_¸
[
k
];

190 
m¸_co°
 = 0;

191 
§c_löe
 = 
mv_block
->
‹ig_pic
[
k
+1];

192 
ªf_löe
 = 
d©a
 ;

193 
p_Dpb
->
pf_gë_block_chroma
[
OTF_ME
]–
p_Vid
, 
ªf_löe
, 
tmp_löe
, 
ˇnd
->
mv_x
, c™d->
mv_y
, 
blocksize_x_¸
, 
blocksize_y_¸
, 
ªf1
, 
k
+1 ) ;

195 
y
=0; y<
blocksize_y_¸
; y++)

197 
x
 = 0; x < 
blocksize_x_¸
; x+=2)

199 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue_uv
, ((
weight
 * *
ªf_löe
++ + 
wp_chroma_round
Ë>> 
chroma_log_weight_díom
Ë+ 
off£t
);

200 
m¸_co°
 +
	`übs
–*
§c_löe
++ - 
weighãd_≥l
 );

201 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue_uv
, ((
weight
 * *
ªf_löe
++ + 
wp_chroma_round
Ë>> 
chroma_log_weight_díom
Ë+ 
off£t
);

202 
m¸_co°
 +
	`übs
–*
§c_löe
++ - 
weighãd_≥l
 );

205 
mco°
 +
mv_block
->
ChromaMEWeight
 * 
m¸_co°
;

207 if(
mco°
 >
imö_co°
)

208  (
	`di°_sˇÀ_f
((
di°blk
)
mco°
));

212 
	`CHECKOVERFLOW
(
mco°
);

213  (
	`di°_sˇÀ
((
di°blk
)
mco°
));

214 
	}
}

222 
di°blk
 
	$compuãBiPªdSAD1_Ÿf
(
St‹abÀPi˘uª
 *
ªf1
,

223 
St‹abÀPi˘uª
 *
ªf2
,

224 
MEBlock
 *
mv_block
,

225 
di°blk
 
mö_mco°
,

226 
MŸi⁄Ve˘‹
 *
ˇnd1
,

227 
MŸi⁄Ve˘‹
 *
ˇnd2
)

229 
imö_co°
 = 
	`di°_down
(
mö_mco°
);

230 
mco°
 = 0;

231 
bi_diff
;

232 
y
,
x
;

233 
blocksize_x
 = 
mv_block
->blocksize_x;

234 
blocksize_y
 = 
mv_block
->blocksize_y;

235 
VideoP¨amëîs
 *
p_Vid
 = 
mv_block
->p_Vid;

236 
DecodedPi˘uªBuf„r
 *
p_Dpb
 = 
p_Vid
->
p_Dpb_œyî
[p_Vid->
dpb_œyî_id
];

237 #i‡(
JM_MEM_DISTORTION
)

238 *
img≥l_abs
 = 
p_Vid
->imgpel_abs;

241 
img≥l
 *
§c_löe
, *
ªf2_löe
, *
ªf1_löe
 ;

242 
img≥l
 
d©a2
[
MB_PIXELS
], 
d©a1
[MB_PIXELS];

243 
tmp_löe
[ (
MB_BLOCK_SIZE
+5)*(MB_BLOCK_SIZE+5) ] ;

245 
§c_löe
 = 
mv_block
->
‹ig_pic
[0];

246 
ªf2_löe
 = 
d©a2
 ;

247 
ªf1_löe
 = 
d©a1
 ;

249 
p_Dpb
->
	`pf_gë_block_luma
–
p_Vid
, 
ªf2_löe
, 
tmp_löe
, 
ˇnd2
->
mv_x
, c™d2->
mv_y
, 
blocksize_x
, 
blocksize_y
, 
ªf2
, 0 );

250 
p_Dpb
->
	`pf_gë_block_luma
–
p_Vid
, 
ªf1_löe
, 
tmp_löe
, 
ˇnd1
->
mv_x
, c™d1->
mv_y
, 
blocksize_x
, 
blocksize_y
, 
ªf1
, 0 );

252 
y
 = 0; y < 
blocksize_y
; y++)

254 
x
 = 0; x < 
blocksize_x
; x+=4)

256 #i‡(
JM_MEM_DISTORTION
)

257 
bi_diff
 = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

258 
mco°
 +
img≥l_abs
[ 
bi_diff
 ];

259 
bi_diff
 = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

260 
mco°
 +
img≥l_abs
[ 
bi_diff
 ];

261 
bi_diff
 = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

262 
mco°
 +
img≥l_abs
[ 
bi_diff
 ];

263 
bi_diff
 = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

264 
mco°
 +
img≥l_abs
[ 
bi_diff
 ];

266 
bi_diff
 = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

267 
mco°
 +
	`übs
(
bi_diff
);

268 
bi_diff
 = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

269 
mco°
 +
	`übs
(
bi_diff
);

270 
bi_diff
 = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

271 
mco°
 +
	`übs
(
bi_diff
);

272 
bi_diff
 = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

273 
mco°
 +
	`übs
(
bi_diff
);

276 if(
mco°
 > 
imö_co°
)

277  (
	`di°_sˇÀ_f
((
di°blk
)
mco°
));

280 i‡–
mv_block
->
ChromaMEE«bÀ
 )

283 
blocksize_x_¸
 = 
mv_block
->
blocksize_¸_x
;

284 
blocksize_y_¸
 = 
mv_block
->
blocksize_¸_y
;

285 
k
;

286 
m¸_co°
 = 0;

288 
k
=1; k<3; k++)

290 
m¸_co°
 = 0;

292 
§c_löe
 = 
mv_block
->
‹ig_pic
[
k
];

293 
ªf2_löe
 = 
d©a2
 ;

294 
ªf1_löe
 = 
d©a1
 ;

295 
p_Dpb
->
pf_gë_block_chroma
[
OTF_ME
]–
p_Vid
, 
ªf2_löe
, 
tmp_löe
, 
ˇnd2
->
mv_x
, c™d2->
mv_y
, 
blocksize_x_¸
, 
blocksize_y_¸
, 
ªf2
, 
k
 ) ;

296 
p_Dpb
->
pf_gë_block_chroma
[
OTF_ME
]–
p_Vid
, 
ªf1_löe
, 
tmp_löe
, 
ˇnd1
->
mv_x
, c™d1->
mv_y
, 
blocksize_x_¸
, 
blocksize_y_¸
, 
ªf1
, 
k
 ) ;

298 
y
=0; y<
blocksize_y_¸
; y++)

300 
x
 = 0; x < 
blocksize_x_¸
; x+=2)

302 
bi_diff
 = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

303 
m¸_co°
 +
	`übs
(
bi_diff
);

304 
bi_diff
 = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

305 
m¸_co°
 +
	`übs
(
bi_diff
);

308 
mco°
 +
mv_block
->
ChromaMEWeight
 * 
m¸_co°
;

310 if(
mco°
 > 
imö_co°
)

311  (
	`di°_sˇÀ_f
((
di°blk
)
mco°
));

315 
	`CHECKOVERFLOW
(
mco°
);

316  (
	`di°_sˇÀ
((
di°blk
)
mco°
));

317 
	}
}

325 
di°blk
 
	$compuãBiPªdSAD2_Ÿf
(
St‹abÀPi˘uª
 *
ªf1
,

326 
St‹abÀPi˘uª
 *
ªf2
,

327 
MEBlock
 *
mv_block
,

328 
di°blk
 
mö_mco°
,

329 
MŸi⁄Ve˘‹
 *
ˇnd1
,

330 
MŸi⁄Ve˘‹
 *
ˇnd2
)

332 
imö_co°
 = 
	`di°_down
(
mö_mco°
);

333 
mco°
 = 0;

334 
bi_diff
;

335 
VideoP¨amëîs
 *
p_Vid
 = 
mv_block
->p_Vid;

336 
Sli˚
 *
cuºSli˚
 = 
mv_block
->
p_Sli˚
;

337 
DecodedPi˘uªBuf„r
 *
p_Dpb
 = 
p_Vid
->
p_Dpb_œyî
[p_Vid->
dpb_œyî_id
];

338 
díom
 = 
cuºSli˚
->
luma_log_weight_díom
 + 1;

339 
Ãound
 = 2 * 
cuºSli˚
->
wp_luma_round
;

340 
max_img≥l_vÆue
 = 
p_Vid
->max_imgpel_value;

341 
y
,
x
;

342 
weighãd_≥l
, 
pixñ1
, 
pixñ2
;

343 
blocksize_x
 = 
mv_block
->blocksize_x;

344 
blocksize_y
 = 
mv_block
->blocksize_y;

345 
weight1
 = 
mv_block
->weight1;

346 
weight2
 = 
mv_block
->weight2;

347 
off£tBi
 = 
mv_block
->offsetBi;

349 
img≥l
 *
§c_löe
, *
ªf2_löe
, *
ªf1_löe
 ;

350 
img≥l
 
d©a2
[
MB_PIXELS
], 
d©a1
[MB_PIXELS];

351 
tmp_löe
[ (
MB_BLOCK_SIZE
+5)*(MB_BLOCK_SIZE+5) ] ;

352 
§c_löe
 = 
mv_block
->
‹ig_pic
[0];

353 
ªf2_löe
 = 
d©a2
 ;

354 
ªf1_löe
 = 
d©a1
 ;

356 
p_Dpb
->
	`pf_gë_block_luma
–
p_Vid
, 
ªf2_löe
, 
tmp_löe
, 
ˇnd2
->
mv_x
, c™d2->
mv_y
, 
blocksize_x
, 
blocksize_y
, 
ªf2
, 0 );

357 
p_Dpb
->
	`pf_gë_block_luma
–
p_Vid
, 
ªf1_löe
, 
tmp_löe
, 
ˇnd1
->
mv_x
, c™d1->
mv_y
, 
blocksize_x
, 
blocksize_y
, 
ªf1
, 0 );

359 
y
=0; y<
blocksize_y
; y++)

361 
x
 = 0; x < 
blocksize_x
; x+=4)

363 
pixñ1
 = 
weight1
 * (*
ªf1_löe
++);

364 
pixñ2
 = 
weight2
 * (*
ªf2_löe
++);

365 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
pixñ1
 + 
pixñ2
 + 
Ãound
Ë>> 
díom
Ë+ 
off£tBi
);

366 
bi_diff
 = (*
§c_löe
++Ë- 
weighãd_≥l
;

367 
mco°
 +
	`übs
(
bi_diff
);

369 
pixñ1
 = 
weight1
 * (*
ªf1_löe
++);

370 
pixñ2
 = 
weight2
 * (*
ªf2_löe
++);

371 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
pixñ1
 + 
pixñ2
 + 
Ãound
Ë>> 
díom
Ë+ 
off£tBi
);

372 
bi_diff
 = (*
§c_löe
++Ë- 
weighãd_≥l
;

373 
mco°
 +
	`übs
(
bi_diff
);

375 
pixñ1
 = 
weight1
 * (*
ªf1_löe
++);

376 
pixñ2
 = 
weight2
 * (*
ªf2_löe
++);

377 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
pixñ1
 + 
pixñ2
 + 
Ãound
Ë>> 
díom
Ë+ 
off£tBi
);

378 
bi_diff
 = (*
§c_löe
++Ë- 
weighãd_≥l
;

379 
mco°
 +
	`übs
(
bi_diff
);

381 
pixñ1
 = 
weight1
 * (*
ªf1_löe
++);

382 
pixñ2
 = 
weight2
 * (*
ªf2_löe
++);

383 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
pixñ1
 + 
pixñ2
 + 
Ãound
Ë>> 
díom
Ë+ 
off£tBi
);

384 
bi_diff
 = (*
§c_löe
++Ë- 
weighãd_≥l
;

385 
mco°
 +
	`übs
(
bi_diff
);

388 if(
mco°
 > 
imö_co°
)

389  
	`di°_sˇÀ_f
((
di°blk
)
mco°
);

392 i‡–
mv_block
->
ChromaMEE«bÀ
 )

395 
blocksize_x_¸
 = 
mv_block
->
blocksize_¸_x
;

396 
blocksize_y_¸
 = 
mv_block
->
blocksize_¸_y
;

397 
k
;

398 
m¸_co°
 = 0;

399 
max_img≥l_vÆue_uv
 = 
p_Vid
->
max_≥l_vÆue_comp
[1];

401 
k
=0; k<2; k++)

403 
weight1
 = 
mv_block
->
weight1_¸
[
k
];

404 
weight2
 = 
mv_block
->
weight2_¸
[
k
];

405 
off£tBi
 = 
mv_block
->
off£tBi_¸
[
k
];

407 
m¸_co°
 = 0;

408 
§c_löe
 = 
mv_block
->
‹ig_pic
[
k
+1];

409 
ªf2_löe
 = 
d©a2
 ;

410 
ªf1_löe
 = 
d©a1
 ;

411 
p_Dpb
->
pf_gë_block_chroma
[
OTF_ME
]–
p_Vid
, 
ªf2_löe
, 
tmp_löe
, 
ˇnd2
->
mv_x
, c™d2->
mv_y
, 
blocksize_x_¸
, 
blocksize_y_¸
, 
ªf2
, 
k
+1 ) ;

412 
p_Dpb
->
pf_gë_block_chroma
[
OTF_ME
]–
p_Vid
, 
ªf1_löe
, 
tmp_löe
, 
ˇnd1
->
mv_x
, c™d1->
mv_y
, 
blocksize_x_¸
, 
blocksize_y_¸
, 
ªf1
, 
k
+1 ) ;

414 
y
=0; y<
blocksize_y_¸
; y++)

416 
x
 = 0; x < 
blocksize_x_¸
; x+=2)

418 
pixñ1
 = 
weight1
 * (*
ªf1_löe
++);

419 
pixñ2
 = 
weight2
 * (*
ªf2_löe
++);

420 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue_uv
, ((
pixñ1
 + 
pixñ2
 + 
Ãound
Ë>> 
díom
Ë+ 
off£tBi
);

421 
bi_diff
 = (*
§c_löe
++Ë- 
weighãd_≥l
;

422 
m¸_co°
 +
	`übs
(
bi_diff
);

424 
pixñ1
 = 
weight1
 * (*
ªf1_löe
++);

425 
pixñ2
 = 
weight2
 * (*
ªf2_löe
++);

426 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue_uv
, ((
pixñ1
 + 
pixñ2
 + 
Ãound
Ë>> 
díom
Ë+ 
off£tBi
);

427 
bi_diff
 = (*
§c_löe
++Ë- 
weighãd_≥l
;

428 
m¸_co°
 +
	`übs
(
bi_diff
);

431 
mco°
 +
mv_block
->
ChromaMEWeight
 * 
m¸_co°
;

433 if(
mco°
 > 
imö_co°
)

434  
	`di°_sˇÀ_f
((
di°blk
)
mco°
);

438 
	`CHECKOVERFLOW
(
mco°
);

439  
	`di°_sˇÀ
((
di°blk
)
mco°
);

440 
	}
}

448 
di°blk
 
	$compuãSATD_Ÿf
(
St‹abÀPi˘uª
 *
ªf1
,

449 
MEBlock
 *
mv_block
,

450 
di°blk
 
mö_mco°
,

451 
MŸi⁄Ve˘‹
 *
ˇnd


454 
imö_co°
 = 
	`di°_down
(
mö_mco°
);

455 
mco°
 = 0;

456 
y
, 
x
, 
y4
;

457 
§c_size_x
, 
§c_size_mul
;

458 
blocksize_x
 = 
mv_block
->blocksize_x;

459 
blocksize_y
 = 
mv_block
->blocksize_y;

460 
VideoP¨amëîs
 *
p_Vid
 = 
mv_block
->p_Vid;

461 
DecodedPi˘uªBuf„r
 *
p_Dpb
 = 
p_Vid
->
p_Dpb_œyî
[p_Vid->
dpb_œyî_id
];

463 
img≥l
 *
§c_tmp
 = 
mv_block
->
‹ig_pic
[0];

464 *
d
, 
diff
[
MB_PIXELS
];

465 
img≥l
 *
§c_löe
, *
ªf_löe
, 
d©a
[
MB_PIXELS
] ;

466 
tmp_löe
[ (
MB_BLOCK_SIZE
+5)*(MB_BLOCK_SIZE+5) ] ;

469 i‡–!
mv_block
->
ã°8x8
 )

471 
§c_size_x
 = 
blocksize_x
 - 
BLOCK_SIZE
;

472 
§c_size_mul
 = 
blocksize_x
 * 
BLOCK_SIZE
;

473 
y
 = 
ˇnd
->
mv_y
; y < c™d->mv_y + (
blocksize_y
<<2); y +(
BLOCK_SIZE_SP
))

475 
x
=0; x<
blocksize_x
; x +
BLOCK_SIZE
)

477 
d
 = 
diff
;

478 
ªf_löe
 = 
d©a
 ;

479 
p_Dpb
->
	`pf_gë_block_luma
–
p_Vid
, 
ªf_löe
, 
tmp_löe
, 
ˇnd
->
mv_x
 + (
x
<<2Ë, 
y
, 
BLOCK_SIZE
, BLOCK_SIZE, 
ªf1
, 0 );

480 
§c_löe
 = 
§c_tmp
 + 
x
;

481 
y4
 = 0; y4 < 
BLOCK_SIZE
; y4++ )

483 *
d
++ = *
§c_löe
++ - *
ªf_löe
++ ;

484 *
d
++ = *
§c_löe
++ - *
ªf_löe
++ ;

485 *
d
++ = *
§c_löe
++ - *
ªf_löe
++ ;

486 *
d
++ = *
§c_löe
++ - *
ªf_löe
++ ;

488 
§c_löe
 +
§c_size_x
;

490 
mco°
 +
	`Hadam¨dSAD4x4
 (
diff
);

491 if(
mco°
 > 
imö_co°
)

492  
	`di°_sˇÀ_f
((
di°blk
)
mco°
);

494 
§c_tmp
 +
§c_size_mul
;

499 
§c_size_x
 = (
blocksize_x
 - 
BLOCK_SIZE_8x8
);

500 
§c_size_mul
 = 
blocksize_x
 * 
BLOCK_SIZE_8x8
;

501 
y
 = 
ˇnd
->
mv_y
; y < c™d->mv_y + (
blocksize_y
<<2); y +(
BLOCK_SIZE_8x8_SP
) )

503 
x
=0; x<
blocksize_x
; x +
BLOCK_SIZE_8x8
 )

505 
d
 = 
diff
;

506 
ªf_löe
 = 
d©a
 ;

507 
p_Dpb
->
	`pf_gë_block_luma
–
p_Vid
, 
ªf_löe
, 
tmp_löe
, 
ˇnd
->
mv_x
 + (
x
<<2Ë, 
y
, 
BLOCK_SIZE_8x8
, BLOCK_SIZE_8x8, 
ªf1
, 0 );

508 
§c_löe
 = 
§c_tmp
 + 
x
;

509 
y4
 = 0; y4 < 
BLOCK_SIZE_8x8
; y4++ )

511 *
d
++ = *
§c_löe
++ - *
ªf_löe
++ ;

512 *
d
++ = *
§c_löe
++ - *
ªf_löe
++ ;

513 *
d
++ = *
§c_löe
++ - *
ªf_löe
++ ;

514 *
d
++ = *
§c_löe
++ - *
ªf_löe
++ ;

515 *
d
++ = *
§c_löe
++ - *
ªf_löe
++ ;

516 *
d
++ = *
§c_löe
++ - *
ªf_löe
++ ;

517 *
d
++ = *
§c_löe
++ - *
ªf_löe
++ ;

518 *
d
++ = *
§c_löe
++ - *
ªf_löe
++ ;

520 
§c_löe
 +
§c_size_x
;

522 
mco°
 +
	`Hadam¨dSAD8x8
 (
diff
);

523 if(
mco°
 > 
imö_co°
)

524  
	`di°_sˇÀ_f
((
di°blk
)
mco°
);

526 
§c_tmp
 +
§c_size_mul
;

530 
	`CHECKOVERFLOW
(
mco°
);

531  
	`di°_sˇÀ
((
di°blk
)
mco°
);

532 
	}
}

540 
di°blk
 
	$compuãSATDWP_Ÿf
(
St‹abÀPi˘uª
 *
ªf1
,

541 
MEBlock
 *
mv_block
,

542 
di°blk
 
mö_mco°
,

543 
MŸi⁄Ve˘‹
 *
ˇnd


546 
imö_co°
 = 
	`di°_down
(
mö_mco°
);

547 
mco°
 = 0;

548 
y
, 
x
, 
y4
;

549 
weighãd_≥l
;

550 
§c_size_x
, 
§c_size_mul
;

551 
blocksize_x
 = 
mv_block
->blocksize_x;

552 
blocksize_y
 = 
mv_block
->blocksize_y;

554 
img≥l
 *
§c_tmp
 = 
mv_block
->
‹ig_pic
[0];

555 
VideoP¨amëîs
 *
p_Vid
 = 
mv_block
->p_Vid;

556 
Sli˚
 *
cuºSli˚
 = 
mv_block
->
p_Sli˚
;

557 
DecodedPi˘uªBuf„r
 *
p_Dpb
 = 
p_Vid
->
p_Dpb_œyî
[p_Vid->
dpb_œyî_id
];

558 
luma_log_weight_díom
 = 
cuºSli˚
->luma_log_weight_denom;

559 
weight
 = 
mv_block
->
weight_luma
;

560 
off£t
 = 
mv_block
->
off£t_luma
;

562 
wp_luma_round
 = 
cuºSli˚
->wp_luma_round;

563 
max_img≥l_vÆue
 = 
p_Vid
->max_imgpel_value;

564 *
d
, 
diff
[
MB_PIXELS
];

565 
img≥l
 *
§c_löe
, *
ªf_löe
, 
d©a
[
MB_PIXELS
];

566 
tmp_löe
[ (
MB_BLOCK_SIZE
+5)*(MB_BLOCK_SIZE+5) ] ;

568 i‡–!
mv_block
->
ã°8x8
 )

570 
§c_size_x
 = (
blocksize_x
 - 
BLOCK_SIZE
);

571 
§c_size_mul
 = 
blocksize_x
 * 
BLOCK_SIZE
;

572 
y
 = 
ˇnd
->
mv_y
; y < c™d->mv_y + (
blocksize_y
<<2); y +(
BLOCK_SIZE_SP
))

574 
x
=0; x<
blocksize_x
; x +
BLOCK_SIZE
)

576 
d
 = 
diff
;

577 
ªf_löe
 = 
d©a
;

578 
p_Dpb
->
	`pf_gë_block_luma
–
p_Vid
, 
ªf_löe
, 
tmp_löe
, 
ˇnd
->
mv_x
 + (
x
<<2Ë, 
y
, 
BLOCK_SIZE
, BLOCK_SIZE, 
ªf1
, 0 );

579 
§c_löe
 = 
§c_tmp
 + 
x
;

580 
y4
 = 0; y4 < 
BLOCK_SIZE
; y4++ )

582 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
weight
 * *
ªf_löe
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t
);

583 *
d
++ = (Ë(*
§c_löe
++ - 
weighãd_≥l
);

584 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
weight
 * *
ªf_löe
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t
);

585 *
d
++ = (Ë(*
§c_löe
++ - 
weighãd_≥l
);

586 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
weight
 * *
ªf_löe
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t
);

587 *
d
++ = (Ë(*
§c_löe
++ - 
weighãd_≥l
);

588 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
weight
 * *
ªf_löe
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t
);

589 *
d
++ = (Ë(*
§c_löe
++ - 
weighãd_≥l
);

591 
§c_löe
 +
§c_size_x
;

593 
mco°
 +
	`Hadam¨dSAD4x4
 (
diff
);

595 if(
mco°
 > 
imö_co°
)

596  
	`di°_sˇÀ_f
((
di°blk
)
mco°
);

598 
§c_tmp
 +
§c_size_mul
;

603 
§c_size_x
 = (
blocksize_x
 - 
BLOCK_SIZE_8x8
);

604 
§c_size_mul
 = 
blocksize_x
 * 
BLOCK_SIZE_8x8
;

605 
y
 = 
ˇnd
->
mv_y
; y < c™d->mv_y + (
blocksize_y
<<2); y +(
BLOCK_SIZE_8x8_SP
) )

607 
x
=0; x<
blocksize_x
; x +
BLOCK_SIZE_8x8
 )

609 
d
 = 
diff
;

610 
ªf_löe
 = 
d©a
;

611 
p_Dpb
->
	`pf_gë_block_luma
–
p_Vid
, 
ªf_löe
, 
tmp_löe
, 
ˇnd
->
mv_x
 + (
x
<<2Ë, 
y
, 
BLOCK_SIZE_8x8
, BLOCK_SIZE_8x8, 
ªf1
, 0 );

612 
§c_löe
 = 
§c_tmp
 + 
x
;

613 
y4
 = 0; y4 < 
BLOCK_SIZE_8x8
; y4++ )

615 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
weight
 * *
ªf_löe
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t
);

616 *
d
++ = (Ë(*
§c_löe
++ - 
weighãd_≥l
);

617 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
weight
 * *
ªf_löe
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t
);

618 *
d
++ = (Ë(*
§c_löe
++ - 
weighãd_≥l
);

619 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
weight
 * *
ªf_löe
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t
);

620 *
d
++ = (Ë(*
§c_löe
++ - 
weighãd_≥l
);

621 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
weight
 * *
ªf_löe
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t
);

622 *
d
++ = (Ë(*
§c_löe
++ - 
weighãd_≥l
);

623 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
weight
 * *
ªf_löe
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t
);

624 *
d
++ = (Ë(*
§c_löe
++ - 
weighãd_≥l
);

625 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
weight
 * *
ªf_löe
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t
);

626 *
d
++ = (Ë(*
§c_löe
++ - 
weighãd_≥l
);

627 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
weight
 * *
ªf_löe
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t
);

628 *
d
++ = (Ë(*
§c_löe
++ - 
weighãd_≥l
);

629 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
weight
 * *
ªf_löe
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t
);

630 *
d
++ = (Ë(*
§c_löe
++ - 
weighãd_≥l
);

632 
§c_löe
 +
§c_size_x
;

634 
mco°
 +
	`Hadam¨dSAD8x8
 (
diff
);

635 if(
mco°
 > 
imö_co°
)

636  
	`di°_sˇÀ_f
((
di°blk
)
mco°
);

638 
§c_tmp
 +
§c_size_mul
;

642 
	`CHECKOVERFLOW
(
mco°
);

643  
	`di°_sˇÀ
((
di°blk
)
mco°
);

644 
	}
}

652 
di°blk
 
	$compuãBiPªdSATD1_Ÿf
(
St‹abÀPi˘uª
 *
ªf1
,

653 
St‹abÀPi˘uª
 *
ªf2
,

654 
MEBlock
 *
mv_block
,

655 
di°blk
 
mö_mco°
,

656 
MŸi⁄Ve˘‹
 *
ˇnd1
,

657 
MŸi⁄Ve˘‹
 *
ˇnd2
)

659 
imö_co°
 = 
	`di°_down
(
mö_mco°
);

660 
mco°
 = 0;

661 
y
, 
x
, 
y4
;

662 
§c_size_x
, 
§c_size_mul
;

663 
img≥l
 *
§c_tmp
 = 
mv_block
->
‹ig_pic
[0];

664 *
d
, 
diff
[
MB_PIXELS
];

665 
img≥l
 *
§c_löe
, *
ªf1_löe
, *
ªf2_löe
, 
d©a1
[
MB_PIXELS
], 
d©a2
[MB_PIXELS] ;

666 
tmp_löe
[ (
MB_BLOCK_SIZE
+5)*(MB_BLOCK_SIZE+5) ] ;

667 
blocksize_x
 = 
mv_block
->blocksize_x;

668 
blocksize_y
 = 
mv_block
->blocksize_y;

669 
VideoP¨amëîs
 *
p_Vid
 = 
mv_block
->p_Vid;

670 
DecodedPi˘uªBuf„r
 *
p_Dpb
 = 
p_Vid
->
p_Dpb_œyî
[p_Vid->
dpb_œyî_id
];

672 i‡–!
mv_block
->
ã°8x8
 )

674 
§c_size_x
 = (
blocksize_x
 - 
BLOCK_SIZE
);

675 
§c_size_mul
 = 
blocksize_x
 * 
BLOCK_SIZE
;

676 
y
=0; y<(
blocksize_y
<<2); y +(
BLOCK_SIZE_SP
))

678 
x
=0; x<
blocksize_x
; x +
BLOCK_SIZE
)

680 
d
 = 
diff
;

681 
ªf2_löe
 = 
d©a2
;

682 
ªf1_löe
 = 
d©a1
;

683 
§c_löe
 = 
§c_tmp
 + 
x
;

684 
p_Dpb
->
	`pf_gë_block_luma
–
p_Vid
, 
ªf2_löe
, 
tmp_löe
, 
ˇnd2
->
mv_x
 + (
x
<<2Ë, c™d2->
mv_y
 + 
y
, 
BLOCK_SIZE
, BLOCK_SIZE, 
ªf2
, 0 );

685 
p_Dpb
->
	`pf_gë_block_luma
–
p_Vid
, 
ªf1_löe
, 
tmp_löe
, 
ˇnd1
->
mv_x
 + (
x
<<2Ë, c™d1->
mv_y
 + 
y
, 
BLOCK_SIZE
, BLOCK_SIZE, 
ªf1
, 0 );

687 
y4
 = 0; y4 < 
BLOCK_SIZE
; y4++ )

689 *
d
++ = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

690 *
d
++ = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

691 *
d
++ = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

692 *
d
++ = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

694 
§c_löe
 +
§c_size_x
;

696 
mco°
 +
	`Hadam¨dSAD4x4
 (
diff
);

697 if(
mco°
 > 
imö_co°
)

698  
	`di°_sˇÀ_f
((
di°blk
)
mco°
);

700 
§c_tmp
 +
§c_size_mul
;

705 
§c_size_x
 = (
blocksize_x
 - 
BLOCK_SIZE_8x8
);

706 
§c_size_mul
 = 
blocksize_x
 * 
BLOCK_SIZE_8x8
;

707 
y
=0; y<(
blocksize_y
 << 2); y +
BLOCK_SIZE_8x8_SP
 )

709 
y_pos2
 = 
ˇnd2
->
mv_y
 + 
y
;

710 
y_pos1
 = 
ˇnd1
->
mv_y
 + 
y
;

711 
x
=0; x<
blocksize_x
; x +
BLOCK_SIZE_8x8
 )

713 
d
 = 
diff
;

714 
ªf2_löe
 = 
d©a2
;

715 
ªf1_löe
 = 
d©a1
;

716 
§c_löe
 = 
§c_tmp
 + 
x
;

717 
p_Dpb
->
	`pf_gë_block_luma
–
p_Vid
, 
ªf2_löe
, 
tmp_löe
, 
ˇnd2
->
mv_x
 + (
x
<<2Ë, 
y_pos2
, 
BLOCK_SIZE_8x8
, BLOCK_SIZE_8x8, 
ªf2
, 0 );

718 
p_Dpb
->
	`pf_gë_block_luma
–
p_Vid
, 
ªf1_löe
, 
tmp_löe
, 
ˇnd1
->
mv_x
 + (
x
<<2Ë, 
y_pos1
, 
BLOCK_SIZE_8x8
, BLOCK_SIZE_8x8, 
ªf1
, 0 );

720 
y4
 = 0; y4 < 
BLOCK_SIZE_8x8
; y4++ )

722 *
d
++ = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

723 *
d
++ = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

724 *
d
++ = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

725 *
d
++ = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

726 *
d
++ = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

727 *
d
++ = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

728 *
d
++ = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

729 *
d
++ = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

731 
§c_löe
 +
§c_size_x
;

733 
mco°
 +
	`Hadam¨dSAD8x8
 (
diff
);

734 if(
mco°
 > 
imö_co°
)

735  
	`di°_sˇÀ_f
((
di°blk
)
mco°
);

737 
§c_tmp
 +
§c_size_mul
;

741 
	`CHECKOVERFLOW
(
mco°
);

742  
	`di°_sˇÀ
((
di°blk
)
mco°
);

743 
	}
}

751 
di°blk
 
	$compuãBiPªdSATD2_Ÿf
(
St‹abÀPi˘uª
 *
ªf1
,

752 
St‹abÀPi˘uª
 *
ªf2
,

753 
MEBlock
 *
mv_block
,

754 
di°blk
 
mö_mco°
,

755 
MŸi⁄Ve˘‹
 *
ˇnd1
,

756 
MŸi⁄Ve˘‹
 *
ˇnd2
)

758 
imö_co°
 = 
	`di°_down
(
mö_mco°
);

759 
mco°
 = 0;

760 
y
, 
x
, 
y4
;

761 
weighãd_≥l
, 
pixñ1
, 
pixñ2
;

762 
VideoP¨amëîs
 *
p_Vid
 = 
mv_block
->p_Vid;

763 
Sli˚
 *
cuºSli˚
 = 
mv_block
->
p_Sli˚
;

764 
DecodedPi˘uªBuf„r
 *
p_Dpb
 = 
p_Vid
->
p_Dpb_œyî
[p_Vid->
dpb_œyî_id
];

765 
díom
 = 
cuºSli˚
->
luma_log_weight_díom
 + 1;

766 
Ãound
 = 2 * 
cuºSli˚
->
wp_luma_round
;

767 
weight1
 = 
mv_block
->weight1;

768 
weight2
 = 
mv_block
->weight2;

769 
off£tBi
 = 
mv_block
->offsetBi;

772 
max_img≥l_vÆue
 = 
p_Vid
->max_imgpel_value;

773 
§c_size_x
, 
§c_size_mul
;

774 
img≥l
 *
§c_tmp
 = 
mv_block
->
‹ig_pic
[0];

775 *
d
, 
diff
[
MB_PIXELS
];

776 
img≥l
 *
§c_löe
, *
ªf1_löe
, *
ªf2_löe
, 
d©a1
[
MB_PIXELS
], 
d©a2
[MB_PIXELS] ;

777 
tmp_löe
[ (
MB_BLOCK_SIZE
+5)*(MB_BLOCK_SIZE+5) ] ;

778 
blocksize_x
 = 
mv_block
->blocksize_x;

779 
blocksize_y
 = 
mv_block
->blocksize_y;

781 i‡–!
mv_block
->
ã°8x8
 )

783 
§c_size_x
 = (
blocksize_x
 - 
BLOCK_SIZE
);

784 
§c_size_mul
 = 
blocksize_x
 * 
BLOCK_SIZE
;

785 
y
=0; y<(
blocksize_y
<<2); y +
BLOCK_SIZE_SP
)

787 
x
=0; x<
blocksize_x
; x +
BLOCK_SIZE
)

789 
d
 = 
diff
;

790 
ªf2_löe
 = 
d©a2
;

791 
ªf1_löe
 = 
d©a1
;

792 
§c_löe
 = 
§c_tmp
 + 
x
;

793 
p_Dpb
->
	`pf_gë_block_luma
–
p_Vid
, 
ªf2_löe
, 
tmp_löe
, 
ˇnd2
->
mv_x
 + (
x
<<2Ë, c™d2->
mv_y
 + 
y
, 
BLOCK_SIZE
, BLOCK_SIZE, 
ªf2
, 0 );

794 
p_Dpb
->
	`pf_gë_block_luma
–
p_Vid
, 
ªf1_löe
, 
tmp_löe
, 
ˇnd1
->
mv_x
 + (
x
<<2Ë, c™d1->
mv_y
 + 
y
, 
BLOCK_SIZE
, BLOCK_SIZE, 
ªf1
, 0 );

796 
y4
 = 0; y4 < 
BLOCK_SIZE
; y4++ )

799 
pixñ1
 = 
weight1
 * (*
ªf1_löe
++);

800 
pixñ2
 = 
weight2
 * (*
ªf2_löe
++);

801 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
pixñ1
 + 
pixñ2
 + 
Ãound
Ë>> 
díom
Ë+ 
off£tBi
);

802 *
d
++ = (Ë((*
§c_löe
++Ë- 
weighãd_≥l
);

804 
pixñ1
 = 
weight1
 * (*
ªf1_löe
++);

805 
pixñ2
 = 
weight2
 * (*
ªf2_löe
++);

806 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
pixñ1
 + 
pixñ2
 + 
Ãound
Ë>> 
díom
Ë+ 
off£tBi
);

807 *
d
++ = (Ë((*
§c_löe
++Ë- 
weighãd_≥l
);

809 
pixñ1
 = 
weight1
 * (*
ªf1_löe
++);

810 
pixñ2
 = 
weight2
 * (*
ªf2_löe
++);

811 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
pixñ1
 + 
pixñ2
 + 
Ãound
Ë>> 
díom
Ë+ 
off£tBi
);

812 *
d
++ = (Ë((*
§c_löe
++Ë- 
weighãd_≥l
);

814 
pixñ1
 = 
weight1
 * (*
ªf1_löe
++);

815 
pixñ2
 = 
weight2
 * (*
ªf2_löe
++);

816 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
pixñ1
 + 
pixñ2
 + 
Ãound
Ë>> 
díom
Ë+ 
off£tBi
);

817 *
d
++ = (Ë((*
§c_löe
++Ë- 
weighãd_≥l
);

819 
§c_löe
 +
§c_size_x
;

821 
mco°
 +
	`Hadam¨dSAD4x4
 (
diff
);

822 if(
mco°
 > 
imö_co°
)

823  
	`di°_sˇÀ_f
((
di°blk
)
mco°
);

825 
§c_tmp
 +
§c_size_mul
;

830 
§c_size_x
 = (
blocksize_x
 - 
BLOCK_SIZE_8x8
);

831 
§c_size_mul
 = 
blocksize_x
 * 
BLOCK_SIZE_8x8
;

832 
y
=0; y < (
blocksize_y
 << 2); y +
BLOCK_SIZE_8x8_SP
 )

834 
y_pos2
 = 
ˇnd2
->
mv_y
 + 
y
;

835 
y_pos1
 = 
ˇnd1
->
mv_y
 + 
y
;

836 
x
=0; x<
blocksize_x
; x +
BLOCK_SIZE_8x8
 )

838 
d
 = 
diff
;

839 
ªf2_löe
 = 
d©a2
;

840 
ªf1_löe
 = 
d©a1
;

841 
§c_löe
 = 
§c_tmp
 + 
x
;

842 
p_Dpb
->
	`pf_gë_block_luma
–
p_Vid
, 
ªf2_löe
, 
tmp_löe
, 
ˇnd2
->
mv_x
 + (
x
<<2Ë, 
y_pos2
, 
BLOCK_SIZE_8x8
, BLOCK_SIZE_8x8, 
ªf2
, 0 );

843 
p_Dpb
->
	`pf_gë_block_luma
–
p_Vid
, 
ªf1_löe
, 
tmp_löe
, 
ˇnd1
->
mv_x
 + (
x
<<2Ë, 
y_pos1
, 
BLOCK_SIZE_8x8
, BLOCK_SIZE_8x8, 
ªf1
, 0 );

845 
y4
 = 0; y4 < 
BLOCK_SIZE_8x8
; y4++ )

848 
pixñ1
 = 
weight1
 * (*
ªf1_löe
++);

849 
pixñ2
 = 
weight2
 * (*
ªf2_löe
++);

850 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
pixñ1
 + 
pixñ2
 + 
Ãound
Ë>> 
díom
Ë+ 
off£tBi
);

851 *
d
++ = (Ë((*
§c_löe
++Ë- 
weighãd_≥l
);

853 
pixñ1
 = 
weight1
 * (*
ªf1_löe
++);

854 
pixñ2
 = 
weight2
 * (*
ªf2_löe
++);

855 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
pixñ1
 + 
pixñ2
 + 
Ãound
Ë>> 
díom
Ë+ 
off£tBi
);

856 *
d
++ = (Ë((*
§c_löe
++Ë- 
weighãd_≥l
);

858 
pixñ1
 = 
weight1
 * (*
ªf1_löe
++);

859 
pixñ2
 = 
weight2
 * (*
ªf2_löe
++);

860 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
pixñ1
 + 
pixñ2
 + 
Ãound
Ë>> 
díom
Ë+ 
off£tBi
);

861 *
d
++ = (Ë((*
§c_löe
++Ë- 
weighãd_≥l
);

863 
pixñ1
 = 
weight1
 * (*
ªf1_löe
++);

864 
pixñ2
 = 
weight2
 * (*
ªf2_löe
++);

865 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
pixñ1
 + 
pixñ2
 + 
Ãound
Ë>> 
díom
Ë+ 
off£tBi
);

866 *
d
++ = (Ë((*
§c_löe
++Ë- 
weighãd_≥l
);

868 
pixñ1
 = 
weight1
 * (*
ªf1_löe
++);

869 
pixñ2
 = 
weight2
 * (*
ªf2_löe
++);

870 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
pixñ1
 + 
pixñ2
 + 
Ãound
Ë>> 
díom
Ë+ 
off£tBi
);

871 *
d
++ = (Ë((*
§c_löe
++Ë- 
weighãd_≥l
);

873 
pixñ1
 = 
weight1
 * (*
ªf1_löe
++);

874 
pixñ2
 = 
weight2
 * (*
ªf2_löe
++);

875 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
pixñ1
 + 
pixñ2
 + 
Ãound
Ë>> 
díom
Ë+ 
off£tBi
);

876 *
d
++ = (Ë((*
§c_löe
++Ë- 
weighãd_≥l
);

878 
pixñ1
 = 
weight1
 * (*
ªf1_löe
++);

879 
pixñ2
 = 
weight2
 * (*
ªf2_löe
++);

880 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
pixñ1
 + 
pixñ2
 + 
Ãound
Ë>> 
díom
Ë+ 
off£tBi
);

881 *
d
++ = (Ë((*
§c_löe
++Ë- 
weighãd_≥l
);

883 
pixñ1
 = 
weight1
 * (*
ªf1_löe
++);

884 
pixñ2
 = 
weight2
 * (*
ªf2_löe
++);

885 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
pixñ1
 + 
pixñ2
 + 
Ãound
Ë>> 
díom
Ë+ 
off£tBi
);

886 *
d
++ = (Ë((*
§c_löe
Ë- 
weighãd_≥l
);

888 
§c_löe
 +
§c_size_x
;

890 
mco°
 +
	`Hadam¨dSAD8x8
 (
diff
);

891 if(
mco°
 > 
imö_co°
)

892  
	`di°_sˇÀ_f
((
di°blk
)
mco°
);

894 
§c_tmp
 +
§c_size_mul
;

897 
	`CHECKOVERFLOW
(
mco°
);

898  
	`di°_sˇÀ
((
di°blk
)
mco°
);

899 
	}
}

907 
di°blk
 
	$compuãSSE_Ÿf
(
St‹abÀPi˘uª
 *
ªf1
,

908 
MEBlock
 *
mv_block
,

909 
di°blk
 
mö_mco°
,

910 
MŸi⁄Ve˘‹
 *
ˇnd


913 
imö_co°
 = 
	`di°_down
(
mö_mco°
);

914 
mco°
 = 0;

915 
y
,
x
;

916 
blocksize_x
 = 
mv_block
->blocksize_x;

917 
blocksize_y
 = 
mv_block
->blocksize_y;

918 
VideoP¨amëîs
 *
p_Vid
 = 
mv_block
->p_Vid;

919 
DecodedPi˘uªBuf„r
 *
p_Dpb
 = 
p_Vid
->
p_Dpb_œyî
[p_Vid->
dpb_œyî_id
];

921 
img≥l
 *
§c_löe
 = 
mv_block
->
‹ig_pic
[0];

922 
img≥l
 *
ªf_löe
 , 
d©a
[
MB_PIXELS
] ;

923 
tmp_löe
[ (
MB_BLOCK_SIZE
+5)*(MB_BLOCK_SIZE+5) ] ;

924 
ªf_löe
 = 
d©a
;

926 
p_Dpb
->
	`pf_gë_block_luma
–
p_Vid
, 
ªf_löe
, 
tmp_löe
, 
ˇnd
->
mv_x
, c™d->
mv_y
, 
blocksize_x
, 
blocksize_y
, 
ªf1
, 0 );

928 
y
=0; y<
blocksize_y
; y++)

930 
x
 = 0; x < 
blocksize_x
; x+=4)

932 
mco°
 +
	`übs2
–*
§c_löe
++ - *
ªf_löe
++ );

933 
mco°
 +
	`übs2
–*
§c_löe
++ - *
ªf_löe
++ );

934 
mco°
 +
	`übs2
–*
§c_löe
++ - *
ªf_löe
++ );

935 
mco°
 +
	`übs2
–*
§c_löe
++ - *
ªf_löe
++ );

937 if(
mco°
 > 
imö_co°
)

938  
	`di°_sˇÀ_f
((
di°blk
)
mco°
);

941 i‡–
mv_block
->
ChromaMEE«bÀ
 )

944 
blocksize_x_¸
 = 
mv_block
->
blocksize_¸_x
;

945 
blocksize_y_¸
 = 
mv_block
->
blocksize_¸_y
;

946 
k
;

947 
m¸_co°
 = 0;

949 
k
=0; k<2; k++)

951 
m¸_co°
 = 0;

952 
§c_löe
 = 
mv_block
->
‹ig_pic
[
k
+1];

953 
ªf_löe
 = 
d©a
 ;

954 
p_Dpb
->
pf_gë_block_chroma
[
OTF_ME
]–
p_Vid
, 
ªf_löe
, 
tmp_löe
, 
ˇnd
->
mv_x
, c™d->
mv_y
, 
blocksize_x_¸
, 
blocksize_y_¸
, 
ªf1
, 
k
+1 ) ;

955 
y
=0; y<
blocksize_y_¸
; y++)

957 
x
 = 0; x < 
blocksize_x_¸
; x+=2)

959 
m¸_co°
 +
	`übs2
–*
§c_löe
++ - *
ªf_löe
++ );

960 
m¸_co°
 +
	`übs2
–*
§c_löe
++ - *
ªf_löe
++ );

963 
mco°
 +
mv_block
->
ChromaMEWeight
 * 
m¸_co°
;

964 if(
mco°
 > 
imö_co°
)

965  
	`di°_sˇÀ_f
((
di°blk
)
mco°
);

969 
	`CHECKOVERFLOW
(
mco°
);

970  
	`di°_sˇÀ
((
di°blk
)
mco°
);

971 
	}
}

979 
di°blk
 
	$compuãSSEWP_Ÿf
(
St‹abÀPi˘uª
 *
ªf1
,

980 
MEBlock
 *
mv_block
,

981 
di°blk
 
mö_mco°
,

982 
MŸi⁄Ve˘‹
 *
ˇnd


985 
imö_co°
 = 
	`di°_down
(
mö_mco°
);

986 
mco°
 = 0;

987 
y
,
x
;

988 
weighãd_≥l
;

989 
blocksize_x
 = 
mv_block
->blocksize_x;

990 
blocksize_y
 = 
mv_block
->blocksize_y;

991 
VideoP¨amëîs
 *
p_Vid
 = 
mv_block
->p_Vid;

992 
Sli˚
 *
cuºSli˚
 = 
mv_block
->
p_Sli˚
;

993 
DecodedPi˘uªBuf„r
 *
p_Dpb
 = 
p_Vid
->
p_Dpb_œyî
[p_Vid->
dpb_œyî_id
];

994 
weight
 = 
mv_block
->
weight_luma
;

995 
off£t
 = 
mv_block
->
off£t_luma
;

997 
wp_luma_round
 = 
cuºSli˚
->wp_luma_round;

998 
max_img≥l_vÆue
 = 
p_Vid
->max_imgpel_value;

999 
luma_log_weight_díom
 = 
cuºSli˚
->luma_log_weight_denom;

1001 
img≥l
 *
§c_löe
 = 
mv_block
->
‹ig_pic
[0];

1002 
img≥l
 *
ªf_löe
 , 
d©a
[
MB_PIXELS
] ;

1003 
tmp_löe
[ (
MB_BLOCK_SIZE
+5)*(MB_BLOCK_SIZE+5) ] ;

1005 
ªf_löe
 = 
d©a
;

1006 
p_Dpb
->
	`pf_gë_block_luma
–
p_Vid
, 
ªf_löe
, 
tmp_löe
, 
ˇnd
->
mv_x
, c™d->
mv_y
, 
blocksize_x
, 
blocksize_y
, 
ªf1
, 0 );

1008 
y
=0; y<
blocksize_y
; y++)

1010 
x
 = 0; x < 
blocksize_x
; x+=4)

1012 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
weight
 * *
ªf_löe
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t
);

1013 
mco°
 +
	`übs2
–*
§c_löe
++ - 
weighãd_≥l
 );

1014 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
weight
 * *
ªf_löe
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t
);

1015 
mco°
 +
	`übs2
–*
§c_löe
++ - 
weighãd_≥l
 );

1016 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
weight
 * *
ªf_löe
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t
);

1017 
mco°
 +
	`übs2
–*
§c_löe
++ - 
weighãd_≥l
 );

1018 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
weight
 * *
ªf_löe
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t
);

1019 
mco°
 +
	`übs2
–*
§c_löe
++ - 
weighãd_≥l
 );

1021 if(
mco°
 > 
imö_co°
)

1022  
	`di°_sˇÀ_f
((
di°blk
)
mco°
);

1025 i‡–
mv_block
->
ChromaMEE«bÀ
 )

1029 
blocksize_x_¸
 = 
mv_block
->
blocksize_¸_x
;

1030 
blocksize_y_¸
 = 
mv_block
->
blocksize_¸_y
;

1031 
k
;

1032 
m¸_co°
 = 0;

1033 
max_img≥l_vÆue_uv
 = 
p_Vid
->
max_≥l_vÆue_comp
[1];

1034 
wp_chroma_round
 = 
cuºSli˚
->wp_chroma_round;

1035 
chroma_log_weight_díom
 = 
cuºSli˚
->chroma_log_weight_denom;

1037 
k
=0; k<2; k++)

1039 
weight
 = 
mv_block
->
weight_¸
[
k
];

1040 
off£t
 = 
mv_block
->
off£t_¸
[
k
];

1042 
m¸_co°
 = 0;

1043 
§c_löe
 = 
mv_block
->
‹ig_pic
[
k
+1];

1044 
ªf_löe
 = 
d©a
 ;

1045 
p_Dpb
->
pf_gë_block_chroma
[
OTF_ME
]–
p_Vid
, 
ªf_löe
, 
tmp_löe
, 
ˇnd
->
mv_x
, c™d->
mv_y
, 
blocksize_x_¸
, 
blocksize_y_¸
, 
ªf1
, 
k
+1 ) ;

1046 
y
=0; y<
blocksize_y_¸
; y++)

1049 
x
 = 0; x < 
blocksize_x_¸
; x+=2)

1051 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue_uv
, ((
weight
 * *
ªf_löe
++ + 
wp_chroma_round
Ë>> 
chroma_log_weight_díom
Ë+ 
off£t
);

1052 
m¸_co°
 +
	`übs2
–*
§c_löe
++ - 
weighãd_≥l
 );

1053 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue_uv
, ((
weight
 * *
ªf_löe
++ + 
wp_chroma_round
Ë>> 
chroma_log_weight_díom
Ë+ 
off£t
);

1054 
m¸_co°
 +
	`übs2
–*
§c_löe
++ - 
weighãd_≥l
 );

1057 
mco°
 +
mv_block
->
ChromaMEWeight
 * 
m¸_co°
;

1058 if(
mco°
 > 
imö_co°
)

1059  
	`di°_sˇÀ_f
((
di°blk
)
mco°
);

1063 
	`CHECKOVERFLOW
(
mco°
);

1064  
	`di°_sˇÀ
((
di°blk
)
mco°
);

1065 
	}
}

1073 
di°blk
 
	$compuãBiPªdSSE1_Ÿf
(
St‹abÀPi˘uª
 *
ªf1
,

1074 
St‹abÀPi˘uª
 *
ªf2
,

1075 
MEBlock
 *
mv_block
,

1076 
di°blk
 
mö_mco°
,

1077 
MŸi⁄Ve˘‹
 *
ˇnd1
,

1078 
MŸi⁄Ve˘‹
 *
ˇnd2
)

1080 
imö_co°
 = 
	`di°_down
(
mö_mco°
);

1081 
mco°
 = 0;

1082 
bi_diff
;

1083 
y
,
x
;

1084 
blocksize_x
 = 
mv_block
->blocksize_x;

1085 
blocksize_y
 = 
mv_block
->blocksize_y;

1086 
VideoP¨amëîs
 *
p_Vid
 = 
mv_block
->p_Vid;

1087 
DecodedPi˘uªBuf„r
 *
p_Dpb
 = 
p_Vid
->
p_Dpb_œyî
[p_Vid->
dpb_œyî_id
];

1089 
img≥l
 *
§c_löe
, *
ªf2_löe
, *
ªf1_löe
 ;

1090 
img≥l
 
d©a2
[
MB_PIXELS
], 
d©a1
[MB_PIXELS];

1091 
tmp_löe
[ (
MB_BLOCK_SIZE
+5)*(MB_BLOCK_SIZE+5) ] ;

1092 
§c_löe
 = 
mv_block
->
‹ig_pic
[0];

1093 
ªf2_löe
 = 
d©a2
 ;

1094 
ªf1_löe
 = 
d©a1
 ;

1096 
p_Dpb
->
	`pf_gë_block_luma
–
p_Vid
, 
ªf2_löe
, 
tmp_löe
, 
ˇnd2
->
mv_x
, c™d2->
mv_y
, 
blocksize_x
, 
blocksize_y
, 
ªf2
, 0 );

1097 
p_Dpb
->
	`pf_gë_block_luma
–
p_Vid
, 
ªf1_löe
, 
tmp_löe
, 
ˇnd1
->
mv_x
, c™d1->
mv_y
, 
blocksize_x
, 
blocksize_y
, 
ªf1
, 0 );

1099 
y
 = 0; y < 
blocksize_y
; y++)

1101 
x
 = 0; x < 
blocksize_x
; x+=4)

1103 
bi_diff
 = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

1104 
mco°
 +
	`übs2
(
bi_diff
);

1105 
bi_diff
 = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

1106 
mco°
 +
	`übs2
(
bi_diff
);

1107 
bi_diff
 = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

1108 
mco°
 +
	`übs2
(
bi_diff
);

1109 
bi_diff
 = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

1110 
mco°
 +
	`übs2
(
bi_diff
);

1112 if(
mco°
 > 
imö_co°
)

1113  
	`di°_sˇÀ_f
((
di°blk
)
mco°
);

1116 i‡–
mv_block
->
ChromaMEE«bÀ
 )

1119 
blocksize_x_¸
 = 
mv_block
->
blocksize_¸_x
;

1120 
blocksize_y_¸
 = 
mv_block
->
blocksize_¸_y
;

1121 
k
;

1122 
m¸_co°
 = 0;

1124 
k
=0; k<2; k++)

1126 
m¸_co°
 = 0;

1127 
§c_löe
 = 
mv_block
->
‹ig_pic
[
k
+1];

1128 
ªf2_löe
 = 
d©a2
 ;

1129 
ªf1_löe
 = 
d©a1
 ;

1130 
p_Dpb
->
pf_gë_block_chroma
[
OTF_ME
]–
p_Vid
, 
ªf2_löe
, 
tmp_löe
, 
ˇnd2
->
mv_x
, c™d2->
mv_y
, 
blocksize_x_¸
, 
blocksize_y_¸
, 
ªf2
, 
k
+1 ) ;

1131 
p_Dpb
->
pf_gë_block_chroma
[
OTF_ME
]–
p_Vid
, 
ªf1_löe
, 
tmp_löe
, 
ˇnd1
->
mv_x
, c™d1->
mv_y
, 
blocksize_x_¸
, 
blocksize_y_¸
, 
ªf1
, 
k
+1 ) ;

1133 
y
=0; y<
blocksize_y_¸
; y++)

1135 
x
 = 0; x < 
blocksize_x_¸
; x+=2)

1137 
bi_diff
 = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

1138 
m¸_co°
 +
	`übs2
(
bi_diff
);

1139 
bi_diff
 = (*
§c_löe
++Ë- ((*
ªf1_löe
++ + *
ªf2_löe
++ + 1)>>1);

1140 
m¸_co°
 +
	`übs2
(
bi_diff
);

1143 
mco°
 +
mv_block
->
ChromaMEWeight
 * 
m¸_co°
;

1144 if(
mco°
 > 
imö_co°
)

1145  
	`di°_sˇÀ_f
((
di°blk
)
mco°
);

1149 
	`CHECKOVERFLOW
(
mco°
);

1150  
	`di°_sˇÀ
((
di°blk
)
mco°
);

1151 
	}
}

1159 
di°blk
 
	$compuãBiPªdSSE2_Ÿf
(
St‹abÀPi˘uª
 *
ªf1
,

1160 
St‹abÀPi˘uª
 *
ªf2
,

1161 
MEBlock
 *
mv_block
,

1162 
di°blk
 
mö_mco°
,

1163 
MŸi⁄Ve˘‹
 *
ˇnd1
,

1164 
MŸi⁄Ve˘‹
 *
ˇnd2
)

1166 
imö_co°
 = 
	`di°_down
(
mö_mco°
);

1167 
mco°
 = 0;

1168 
bi_diff
;

1169 
VideoP¨amëîs
 *
p_Vid
 = 
mv_block
->p_Vid;

1170 
Sli˚
 *
cuºSli˚
 = 
mv_block
->
p_Sli˚
;

1171 
DecodedPi˘uªBuf„r
 *
p_Dpb
 = 
p_Vid
->
p_Dpb_œyî
[p_Vid->
dpb_œyî_id
];

1172 
díom
 = 
cuºSli˚
->
luma_log_weight_díom
 + 1;

1173 
Ãound
 = 2 * 
cuºSli˚
->
wp_luma_round
;

1174 
max_img≥l_vÆue
 = 
p_Vid
->max_imgpel_value;

1175 
y
,
x
;

1176 
weighãd_≥l
, 
pixñ1
, 
pixñ2
;

1177 
weight1
 = 
mv_block
->weight1;

1178 
weight2
 = 
mv_block
->weight2;

1179 
off£tBi
 = 
mv_block
->offsetBi;

1181 
blocksize_x
 = 
mv_block
->blocksize_x;

1182 
blocksize_y
 = 
mv_block
->blocksize_y;

1184 
img≥l
 *
§c_löe
, *
ªf2_löe
, *
ªf1_löe
 ;

1185 
img≥l
 
d©a2
[
MB_PIXELS
], 
d©a1
[MB_PIXELS];

1186 
tmp_löe
[ (
MB_BLOCK_SIZE
+5)*(MB_BLOCK_SIZE+5) ] ;

1187 
§c_löe
 = 
mv_block
->
‹ig_pic
[0];

1188 
ªf2_löe
 = 
d©a2
 ;

1189 
ªf1_löe
 = 
d©a1
 ;

1191 
p_Dpb
->
	`pf_gë_block_luma
–
p_Vid
, 
ªf2_löe
, 
tmp_löe
, 
ˇnd2
->
mv_x
, c™d2->
mv_y
, 
blocksize_x
, 
blocksize_y
, 
ªf2
, 0 );

1192 
p_Dpb
->
	`pf_gë_block_luma
–
p_Vid
, 
ªf1_löe
, 
tmp_löe
, 
ˇnd1
->
mv_x
, c™d1->
mv_y
, 
blocksize_x
, 
blocksize_y
, 
ªf1
, 0 );

1194 
y
=0; y<
blocksize_y
; y++)

1196 
x
 = 0; x < 
blocksize_x
; x+=4)

1198 
pixñ1
 = 
weight1
 * (*
ªf1_löe
++);

1199 
pixñ2
 = 
weight2
 * (*
ªf2_löe
++);

1200 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
pixñ1
 + 
pixñ2
 + 
Ãound
Ë>> 
díom
Ë+ 
off£tBi
);

1201 
bi_diff
 = (*
§c_löe
++Ë- 
weighãd_≥l
;

1202 
mco°
 +
bi_diff
 * bi_diff;

1204 
pixñ1
 = 
weight1
 * (*
ªf1_löe
++);

1205 
pixñ2
 = 
weight2
 * (*
ªf2_löe
++);

1206 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
pixñ1
 + 
pixñ2
 + 
Ãound
Ë>> 
díom
Ë+ 
off£tBi
);

1207 
bi_diff
 = (*
§c_löe
++Ë- 
weighãd_≥l
;

1208 
mco°
 +
bi_diff
 * bi_diff;

1210 
pixñ1
 = 
weight1
 * (*
ªf1_löe
++);

1211 
pixñ2
 = 
weight2
 * (*
ªf2_löe
++);

1212 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
pixñ1
 + 
pixñ2
 + 
Ãound
Ë>> 
díom
Ë+ 
off£tBi
);

1213 
bi_diff
 = (*
§c_löe
++Ë- 
weighãd_≥l
;

1214 
mco°
 +
bi_diff
 * bi_diff;

1216 
pixñ1
 = 
weight1
 * (*
ªf1_löe
++);

1217 
pixñ2
 = 
weight2
 * (*
ªf2_löe
++);

1218 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue
, ((
pixñ1
 + 
pixñ2
 + 
Ãound
Ë>> 
díom
Ë+ 
off£tBi
);

1219 
bi_diff
 = (*
§c_löe
++Ë- 
weighãd_≥l
;

1220 
mco°
 +
bi_diff
 * bi_diff;

1222 if(
mco°
 > 
imö_co°
)

1223  
	`di°_sˇÀ_f
((
di°blk
)
mco°
);

1226 i‡–
mv_block
->
ChromaMEE«bÀ
 )

1229 
blocksize_x_¸
 = 
mv_block
->
blocksize_¸_x
;

1230 
blocksize_y_¸
 = 
mv_block
->
blocksize_¸_y
;

1231 
k
;

1232 
m¸_co°
 = 0;

1233 
max_img≥l_vÆue_uv
 = 
p_Vid
->
max_≥l_vÆue_comp
[1];

1235 
k
=0; k<2; k++)

1237 
weight1
 = 
mv_block
->
weight1_¸
[
k
];

1238 
weight2
 = 
mv_block
->
weight2_¸
[
k
];

1239 
off£tBi
 = 
mv_block
->
off£tBi_¸
[
k
];

1241 
m¸_co°
 = 0;

1242 
§c_löe
 = 
mv_block
->
‹ig_pic
[
k
+1];

1243 
ªf2_löe
 = 
d©a2
 ;

1244 
ªf1_löe
 = 
d©a1
 ;

1245 
p_Dpb
->
pf_gë_block_chroma
[
OTF_ME
]–
p_Vid
, 
ªf2_löe
, 
tmp_löe
, 
ˇnd2
->
mv_x
, c™d2->
mv_y
, 
blocksize_x_¸
, 
blocksize_y_¸
, 
ªf2
, 
k
+1 ) ;

1246 
p_Dpb
->
pf_gë_block_chroma
[
OTF_ME
]–
p_Vid
, 
ªf1_löe
, 
tmp_löe
, 
ˇnd1
->
mv_x
, c™d1->
mv_y
, 
blocksize_x_¸
, 
blocksize_y_¸
, 
ªf1
, 
k
+1 ) ;

1248 
y
=0; y<
blocksize_y_¸
; y++)

1250 
x
 = 0; x < 
blocksize_x_¸
; x+=2)

1252 
pixñ1
 = 
weight1
 * (*
ªf1_löe
++);

1253 
pixñ2
 = 
weight2
 * (*
ªf2_löe
++);

1254 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue_uv
, ((
pixñ1
 + 
pixñ2
 + 
Ãound
Ë>> 
díom
Ë+ 
off£tBi
);

1255 
bi_diff
 = (*
§c_löe
++Ë- 
weighãd_≥l
;

1256 
m¸_co°
 +
bi_diff
 * bi_diff;

1258 
pixñ1
 = 
weight1
 * (*
ªf1_löe
++);

1259 
pixñ2
 = 
weight2
 * (*
ªf2_löe
++);

1260 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue_uv
, ((
pixñ1
 + 
pixñ2
 + 
Ãound
Ë>> 
díom
Ë+ 
off£tBi
);

1261 
bi_diff
 = (*
§c_löe
++Ë- 
weighãd_≥l
;

1262 
m¸_co°
 +
bi_diff
 * bi_diff;

1265 
mco°
 +
mv_block
->
ChromaMEWeight
 * 
m¸_co°
;

1266 if(
mco°
 > 
imö_co°
)

1267  
	`di°_sˇÀ_f
((
di°blk
)
mco°
);

1271 
	`CHECKOVERFLOW
(
mco°
);

1272  
	`di°_sˇÀ
((
di°blk
)
mco°
);

1273 
	}
}

	@lencod/src/me_epzs.c

17 
	~"c⁄åibut‹s.h
"

19 
	~<limôs.h
>

21 
	~"globÆ.h
"

22 
	~"image.h
"

23 
	~"memÆloc.h
"

24 
	~"mb_ac˚ss.h
"

25 
	~"ªfbuf.h
"

26 
	~"ma¸oblock.h
"

27 
	~"me_di°‹ti⁄.h
"

28 
	~"me_ïzs.h
"

29 
	~"me_ïzs_comm⁄.h
"

30 
	~"mv_£¨ch.h
"

40 
ölöe
 
	$£t_öãgî_mv
(
MŸi⁄Ve˘‹
 *
mv
)

42 
mv
->
mv_x
 &= 0xFFFC;

43 
mv
->
mv_y
 &= 0xFFFC;

44 
	}
}

53 
di°blk


54 
	$EPZS_mŸi⁄_e°im©i⁄
 (
Ma¸oblock
 * 
cuºMB
,

55 
MŸi⁄Ve˘‹
 * 
¥ed_mv
,

56 
MEBlock
 * 
mv_block
,

57 
di°blk
 
mö_mco°
,

58 
œmbda_Á˘‹


61 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

62 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

63 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

64 
EPZSP¨amëîs
 *
p_EPZS
 = 
cuºSli˚
->p_EPZS;

65 
PicMŸi⁄P¨ams
 **
mŸi⁄
 = 
p_Vid
->
íc_pi˘uª
->
mv_öfo
;

67 
blockty≥
 = 
mv_block
->blocktype;

69 
li°
 = 
mv_block
->list;

70 
cur_li°
 = 
li°
 + 
cuºMB
->
li°_off£t
;

71 
ªf
 = 
mv_block
->
ªf_idx
;

72 
MŸi⁄Ve˘‹
 *
mv
 = &
mv_block
->mv[
li°
];

73 
SórchWödow
 *
£¨chR™ge
 = &
mv_block
->searchRange;

74 
m≠Cíãr_x
 = 
£¨chR™ge
->
max_x
 - 
mv
->
mv_x
;

75 
m≠Cíãr_y
 = 
£¨chR™ge
->
max_y
 - 
mv
->
mv_y
;

76 
St‹abÀPi˘uª
 *
ªf_pi˘uª
 = 
cuºSli˚
->
li°X
[
cur_li°
][
ªf
];

78 
di°blk
 
œmbda_di°
 = 
	`weighãd_co°
(
œmbda_Á˘‹
, 2);

79 
di°blk
 
°›Crôîi⁄
 = 
p_EPZS
->
medthªs
[
blockty≥
] + 
œmbda_di°
;

80 
di°blk
 *
¥evSad
 = &
p_EPZS
->
di°‹ti⁄
[
cur_li°
][
blockty≥
 - 1][
mv_block
->
pos_x2
];

82 
MŸi⁄Ve˘‹
 *
p_mŸi⁄
 = 
NULL
;

84 
EPZSSåu˘uª
 *
£¨chP©ã∫F
 = 
p_EPZS
->
£¨chP©ã∫
;

85 
uöt16
 **
EPZSM≠
 = &
p_EPZS
->EPZSM≠[
m≠Cíãr_y
];

86 
uöt16
 *
EPZSPoöt
 = &
p_EPZS
->
EPZSM≠
[
£¨chR™ge
->
max_y
][£¨chR™ge->
max_x
];

88 
MŸi⁄Ve˘‹
 
˚¡î
 = 
	`∑d_MVs
 (*
mv
, 
mv_block
);

89 
MŸi⁄Ve˘‹
 
¥ed
 = 
	`∑d_MVs
 (*
¥ed_mv
, 
mv_block
);

90 
MŸi⁄Ve˘‹
 
tmp
 = *
mv
, 
ˇnd
 = 
˚¡î
;

92 ++
p_EPZS
->
BlkCou¡
;

93 i‡(
p_EPZS
->
BlkCou¡
 == 0)

94 ++
p_EPZS
->
BlkCou¡
;

96 i‡(
p_I≈
->
EPZSS∑tülMem
)

98 #i‡
EPZSREF


99 
p_mŸi⁄
 = &
p_EPZS
->p_mŸi⁄[
cur_li°
][
ªf
][
blockty≥
 - 1][
mv_block
->
block_y
][mv_block->
pos_x2
];

101 
p_mŸi⁄
 = &
p_EPZS
->p_mŸi⁄[
cur_li°
][
blockty≥
 - 1][
mv_block
->
block_y
][mv_block->
pos_x2
];

109 *
EPZSPoöt
 = 
p_EPZS
->
BlkCou¡
;

112 
mö_mco°
 = 
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd
, &
¥ed
);

115 
mö_mco°
 +
mv_block
->
	`compuãPªdFPñ
 (
ªf_pi˘uª
, mv_block, 
DISTBLK_MAX
 - mö_mco°, &
ˇnd
);

118 i‡((
ªf
 > 0 && 
cuºSli˚
->
°ru˘uª
 =
FRAME
Ë&& (*
¥evSad
 < 
	`di°blkmö
 (
p_EPZS
->
medthªs
[
blockty≥
] + 
œmbda_di°
, 
mö_mco°
)))

120 #i‡
EPZSREF


121 i‡(
p_I≈
->
EPZSS∑tülMem
)

123 i‡(
p_I≈
->
EPZSS∑tülMem
 && 
ªf
 == 0)

126 *
p_mŸi⁄
 = 
tmp
;

128  
mö_mco°
;

133 i‡(
mö_mco°
 > 
°›Crôîi⁄
)

135 
SPoöt
 *
p_EPZS_poöt
 = 
p_EPZS
->
¥edi˘‹
->
poöt
;

136 
Boﬁón
 
checkMedün
 = 
FALSE
;

137 
di°blk
 
£c⁄d_mco°
 = 
DISTBLK_MAX
;

138 
di°blk
 
mco°
;

139 
¥ednum
 = 5;

140 
c⁄dôi⁄EPZS
;

141 
MŸi⁄Ve˘‹
 
tmp2
 = {0, 0}, 
tmv
;

142 
pos
;

143 
övÆid_ªfs
 = 0;

145 
°›Crôîi⁄
 = 
	`EPZSDëîmöeSt›Crôîi⁄
 (
p_EPZS
, 
¥evSad
, 
mv_block
, 
œmbda_di°
);

147 i‡(
mö_mco°
 < (
°›Crôîi⁄
 >> 1))

149 #i‡
EPZSREF


150 i‡(
p_I≈
->
EPZSS∑tülMem
)

152 i‡(
p_I≈
->
EPZSS∑tülMem
 && 
ªf
 == 0)

155 *
p_mŸi⁄
 = 
tmp
;

158  
mö_mco°
;

164 
övÆid_ªfs
 = 
	`EPZS_•©ül_¥edi˘‹s
 (
p_EPZS
, 
mv_block
,

165 
li°
, 
cuºMB
->
li°_off£t
, 
ªf
, 
mŸi⁄
);

167 i‡(
p_I≈
->
EPZSS∑tülMem
)

168 
	`EPZS_•©ül_mem‹y_¥edi˘‹s
 (
p_EPZS
, 
mv_block
, 
cur_li°
, &
¥ednum
, 
ªf_pi˘uª
->
size_x
 >> 2);

170 #i‡(
MVC_EXTENSION_ENABLE
)

171 i‡–
p_I≈
->
EPZSTemp‹Æ
[
cuºSli˚
->
võw_id
] && 
blockty≥
 < 5 )

174 i‡(
p_I≈
->
EPZSTemp‹Æ
 && 
blockty≥
 < 5)

177 
	`EPZS_ãmp‹Æ_¥edi˘‹s
 (
cuºMB
, 
ªf_pi˘uª
, 
p_EPZS
, 
mv_block
, &
¥ednum
, 
°›Crôîi⁄
, 
mö_mco°
);

193 
c⁄dôi⁄EPZS
 = (
p_I≈
->
EPZSFixed
 =3 && (
cuºMB
->
mb_x
 =0 || cuºMB->
mb_y
 == 0))

194 || ((
mö_mco°
 > 3 * 
°›Crôîi⁄
Ë&& ((
ªf
 < 2 && 
blockty≥
 < 4) || (ref < 1 && blocktype == 4)

195 || ((
cuºSli˚
->
°ru˘uª
 !
FRAME
 || 
cuºMB
->
li°_off£t
)

196 && 
ªf
 < 3))

197 && (
p_I≈
->
EPZSFixed
 > 1 || (p_I≈->EPZSFixed && 
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
)));

199 i‡(
c⁄dôi⁄EPZS
)

200 
	`EPZSWödowPªdi˘‹s
 (
mv
, 
p_EPZS
->
¥edi˘‹
, &
¥ednum
,

201 (
blockty≥
 < 5Ë&& (
övÆid_ªfs
 > 2Ë&& (
ªf
 < 1 + (
cuºSli˚
->
°ru˘uª
 !
FRAME
 || 
cuºMB
->
li°_off£t
))

202 ? 
p_EPZS
->
wödow_¥edi˘‹_ext
 :Ö_EPZS->
wödow_¥edi˘‹
);

209 
c⁄dôi⁄EPZS
 = (
ªf
 =0 || (ª‡> 0 && 
mö_mco°
 > 2 * 
°›Crôîi⁄
));

211 i‡(
c⁄dôi⁄EPZS
 && 
cuºMB
->
mbAddrX
 !0 && 
p_I≈
->
EPZSBlockTy≥
)

212 
	`EPZSBlockTy≥Pªdi˘‹sMB
 (
cuºSli˚
, 
mv_block
, 
p_EPZS_poöt
, &
¥ednum
);

215 
pos
 = 0;Öo†< 
¥ednum
; ++pos)

217 
tmv
 = 
p_EPZS_poöt
[
pos
].
mŸi⁄
;

218 
	`£t_öãgî_mv
(&
tmv
);

221 i‡((
	`übs
 (
tmv
.
mv_x
 - 
mv
->mv_xË- 
£¨chR™ge
->
max_x
 <0Ë&& (üb†—mv.
mv_y
 - mv->mv_yË- sórchR™ge->
max_y
 <= 0))

223 
EPZSPoöt
 = &
EPZSM≠
[
tmv
.
mv_y
][
m≠Cíãr_x
 +Åmv.
mv_x
];

224 i‡(*
EPZSPoöt
 !
p_EPZS
->
BlkCou¡
)

226 *
EPZSPoöt
 = 
p_EPZS
->
BlkCou¡
;

227 
ˇnd
 = 
	`∑d_MVs
 (
tmv
, 
mv_block
);

230 
mco°
 = 
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd
, &
¥ed
);

232 i‡(
mco°
 < 
£c⁄d_mco°
)

234 
mco°
 +
mv_block
->
	`compuãPªdFPñ
 (
ªf_pi˘uª
, mv_block, 
£c⁄d_mco°
 - mco°, &
ˇnd
);

237 i‡(
mco°
 < 
mö_mco°
)

239 
tmp2
 = 
tmp
;

240 
tmp
 = 
tmv
;

241 
£c⁄d_mco°
 = 
mö_mco°
;

242 
mö_mco°
 = 
mco°
;

243 
checkMedün
 = 
TRUE
;

246 i‡(
mco°
 < 
£c⁄d_mco°
)

248 
tmp2
 = 
tmv
;

249 
£c⁄d_mco°
 = 
mco°
;

250 
checkMedün
 = 
TRUE
;

261 i‡(
mö_mco°
 > 
°›Crôîi⁄
)

263 c⁄° 
mv_ønge
 = 10;

264 
∑âînSt›
 = 0, 
poötNumbî
 = 0, 
checkPts
, 
√xtLa°
 = 0;

265 
tŸÆCheckPts
 = 0, 
mŸi⁄Dúe˘i⁄
 = 0;

268 i‡(
p_I≈
->
EPZSP©ã∫
 != 0)

270 i‡((
mö_mco°
 < 
°›Crôîi⁄
 + ((3 * 
p_EPZS
->
medthªs
[
blockty≥
]) >> 1)))

272 i‡((
tmp
.
mv_x
 =0 &&Åmp.
mv_y
 == 0)

273 || (
	`übs
 (
tmp
.
mv_x
 - 
mv
->mv_xË< (
mv_ønge
Ë&& iab†—mp.
mv_y
 - mv->mv_y) < (mv_range)))

274 
£¨chP©ã∫F
 = 
p_Vid
->
sdüm⁄d
;

276 
£¨chP©ã∫F
 = 
p_Vid
->
squ¨e
;

278 i‡(
blockty≥
 > 4 || (
ªf
 > 0 && blocktype != 1))

279 
£¨chP©ã∫F
 = 
p_Vid
->
squ¨e
;

281 
£¨chP©ã∫F
 = 
p_EPZS
->
£¨chP©ã∫
;

285 
˚¡î
 = 
tmp
;

289 
tŸÆCheckPts
 = 
£¨chP©ã∫F
->
£¨chPoöts
;

292 
checkPts
 = 
tŸÆCheckPts
;

295 
tmv
 = 
	`add_MVs
 (
˚¡î
, &(
£¨chP©ã∫F
->
poöt
[
poötNumbî
].
mŸi⁄
));

297 i‡(((
	`übs
 (
tmv
.
mv_x
 - 
mv
->mv_xË- 
£¨chR™ge
->
max_x
Ë<0Ë&& ((üb†—mv.
mv_y
 - mv->mv_yË- sórchR™ge->
max_y
) <= 0))

299 
EPZSPoöt
 = &
EPZSM≠
[
tmv
.
mv_y
][
m≠Cíãr_x
 +Åmv.
mv_x
];

300 i‡(*
EPZSPoöt
 !
p_EPZS
->
BlkCou¡
)

302 *
EPZSPoöt
 = 
p_EPZS
->
BlkCou¡
;

303 
ˇnd
 = 
	`∑d_MVs
 (
tmv
, 
mv_block
);

305 
mco°
 = 
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd
, &
¥ed
);

307 i‡(
mco°
 < 
mö_mco°
)

309 
mco°
 +
mv_block
->
	`compuãPªdFPñ
 (
ªf_pi˘uª
, mv_block, 
mö_mco°
 - mco°, &
ˇnd
);

311 i‡(
mco°
 < 
mö_mco°
)

313 
tmp
 = 
tmv
;

314 
mö_mco°
 = 
mco°
;

315 
mŸi⁄Dúe˘i⁄
 = 
poötNumbî
;

320 ++
poötNumbî
;

321 i‡(
poötNumbî
 >
£¨chP©ã∫F
->
£¨chPoöts
)

322 
poötNumbî
 -
£¨chP©ã∫F
->
£¨chPoöts
;

323 
checkPts
--;

325 
checkPts
 > 0);

327 i‡(
√xtLa°
 || ((
tmp
.
mv_x
 =
˚¡î
.mv_xË&& (tmp.
mv_y
 == center.mv_y)))

329 
∑âînSt›
 = 
£¨chP©ã∫F
->
°›Sórch
;

330 
£¨chP©ã∫F
 = sórchP©ã∫F->
√xç©ã∫
;

331 
tŸÆCheckPts
 = 
£¨chP©ã∫F
->
£¨chPoöts
;

332 
√xtLa°
 = 
£¨chP©ã∫F
->nextLast;

333 
mŸi⁄Dúe˘i⁄
 = 0;

334 
poötNumbî
 = 0;

338 
tŸÆCheckPts
 = 
£¨chP©ã∫F
->
poöt
[
mŸi⁄Dúe˘i⁄
].
√xt_poöts
;

339 
poötNumbî
 = 
£¨chP©ã∫F
->
poöt
[
mŸi⁄Dúe˘i⁄
].
°¨t_nmbr
;

340 
˚¡î
 = 
tmp
;

343 
∑âînSt›
 != 1);

345 i‡((
ªf
 > 0Ë&& (
cuºSli˚
->
°ru˘uª
 =
FRAME
)

346 && ((4 * *
¥evSad
 < 
mö_mco°
Ë|| ((3 * *¥evSad < mö_mco°Ë&& (*¥evSad <
°›Crôîi⁄
))))

348 *
mv
 = 
tmp
;

349 #i‡
EPZSREF


350 i‡(
p_I≈
->
EPZSS∑tülMem
)

352 i‡(
p_I≈
->
EPZSS∑tülMem
 && 
ªf
 == 0)

355 *
p_mŸi⁄
 = 
tmp
;

358  
mö_mco°
;

362 
c⁄dôi⁄EPZS
 = (
checkMedün
 =
TRUE
)

363 && ((
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
Ë|| (
blockty≥
 < 5))

364 && (
mö_mco°
 > 
°›Crôîi⁄
Ë&& (
p_I≈
->
EPZSDuÆ
 > 0);

366 i‡(!
c⁄dôi⁄EPZS
)

369 
poötNumbî
 = 0;

370 
∑âînSt›
 = 0;

371 
mŸi⁄Dúe˘i⁄
 = 0;

372 
√xtLa°
 = 0;

374 i‡((
tmp
.
mv_x
 =0 &&Åmp.
mv_y
 =0Ë|| (tmp.mv_x =
mv
->mv_x &&Åmp.mv_y == mv->mv_y))

376 i‡(
	`übs
 (
tmp
.
mv_x
 - 
mv
->mv_xË< (
mv_ønge
Ë&& iab†—mp.
mv_y
 - mv->mv_y) < (mv_range))

377 
£¨chP©ã∫F
 = 
p_Vid
->
sdüm⁄d
;

379 
£¨chP©ã∫F
 = 
p_Vid
->
squ¨e
;

382 
£¨chP©ã∫F
 = 
p_EPZS
->
£¨chP©ã∫D
;

385 
˚¡î
 = 
tmp2
;

386 
checkMedün
 = 
FALSE
;

391 i‡((
ªf
 =0Ë|| (*
¥evSad
 > 
mö_mco°
))

392 *
¥evSad
 = 
mö_mco°
;

393 #i‡
EPZSREF


394 i‡(
p_I≈
->
EPZSS∑tülMem
)

396 i‡(
p_I≈
->
EPZSS∑tülMem
 && 
ªf
 == 0)

399 *
p_mŸi⁄
 = 
tmp
;

404 *
mv
 = 
tmp
;

406  
mö_mco°
;

407 
	}
}

416 
di°blk


417 
	$EPZS_subMB_mŸi⁄_e°im©i⁄
 (
Ma¸oblock
 * 
cuºMB
,

418 
MŸi⁄Ve˘‹
 * 
¥ed_mv
,

419 
MEBlock
 * 
mv_block
,

420 
di°blk
 
mö_mco°
,

421 
œmbda_Á˘‹


424 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

425 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

426 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

427 
EPZSP¨amëîs
 *
p_EPZS
 = 
cuºSli˚
->p_EPZS;

428 
PicMŸi⁄P¨ams
 **
mŸi⁄
 = 
p_Vid
->
íc_pi˘uª
->
mv_öfo
;

430 
blockty≥
 = 
mv_block
->blocktype;

431 
li°
 = 
mv_block
->list;

432 
cur_li°
 = 
li°
 + 
cuºMB
->
li°_off£t
;

433 
ªf
 = 
mv_block
->
ªf_idx
;

434 
St‹abÀPi˘uª
 *
ªf_pi˘uª
 = 
cuºSli˚
->
li°X
[
cur_li°
][
ªf
];

436 
MŸi⁄Ve˘‹
 *
mv
 = &
mv_block
->mv[
li°
];

437 
MŸi⁄Ve˘‹
 
˚¡î
 = 
	`∑d_MVs
 (*
mv
, 
mv_block
);

438 
MŸi⁄Ve˘‹
 
ˇnd
 = 
˚¡î
;

439 
MŸi⁄Ve˘‹
 
¥ed
 = 
	`∑d_MVs
 (*
¥ed_mv
, 
mv_block
);

440 
MŸi⁄Ve˘‹
 
tmp
 = *
mv
;

441 
SórchWödow
 *
£¨chR™ge
 = &
mv_block
->searchRange;

442 
m≠Cíãr_x
 = 
£¨chR™ge
->
max_x
 - 
mv
->
mv_x
;

443 
m≠Cíãr_y
 = 
£¨chR™ge
->
max_y
 - 
mv
->
mv_y
;

445 
pic_pix_x2
 = 
mv_block
->
pos_x2
;

446 
di°blk
 
œmbda_di°
 = 
	`weighãd_co°
(
œmbda_Á˘‹
,3);

447 
di°blk
 
°›Crôîi⁄
 = 
p_EPZS
->
medthªs
[
blockty≥
] + 
œmbda_di°
;

448 
di°blk
 *
¥evSad
 = &
p_EPZS
->
di°‹ti⁄
[
cur_li°
][
blockty≥
 - 1][
pic_pix_x2
];

449 
MŸi⁄Ve˘‹
 *
p_mŸi⁄
 = 
NULL
;

451 
EPZSSåu˘uª
 *
£¨chP©ã∫F
 = 
p_EPZS
->
£¨chP©ã∫
;

452 
uöt16
 **
EPZSM≠
 = &
p_EPZS
->EPZSM≠[
m≠Cíãr_y
];

454 ++
p_EPZS
->
BlkCou¡
;

455 i‡(
p_EPZS
->
BlkCou¡
 == 0)

456 ++
p_EPZS
->
BlkCou¡
;

458 i‡(
p_I≈
->
EPZSS∑tülMem
)

460 #i‡
EPZSREF


461 
p_mŸi⁄
 = &
p_EPZS
->p_mŸi⁄[
cur_li°
][
ªf
][
blockty≥
 - 1][
mv_block
->
block_y
][
pic_pix_x2
];

463 
p_mŸi⁄
 = &
p_EPZS
->p_mŸi⁄[
cur_li°
][
blockty≥
 - 1][
mv_block
->
block_y
][
pic_pix_x2
];

471 
p_EPZS
->
EPZSM≠
[
£¨chR™ge
->
max_y
][£¨chR™ge->
max_x
] =Ö_EPZS->
BlkCou¡
;

474 
mö_mco°
 = 
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd
, &
¥ed
);

477 
mö_mco°
 +
mv_block
->
	`compuãPªdFPñ
 (
ªf_pi˘uª
, mv_block, 
DISTBLK_MAX
-mö_mco°, &
ˇnd
);

480 i‡((
ªf
 > 0 && 
cuºSli˚
->
°ru˘uª
 =
FRAME
) &&

481 (*
¥evSad
 < 
	`di°blkmö
 (
p_EPZS
->
medthªs
[
blockty≥
] + 
œmbda_di°
, 
mö_mco°
)))

483 #i‡
EPZSREF


484 i‡(
p_I≈
->
EPZSS∑tülMem
)

486 i‡(
p_I≈
->
EPZSS∑tülMem
 && 
ªf
 == 0)

489 *
p_mŸi⁄
 = 
tmp
;

491  
mö_mco°
;

496 i‡(
mö_mco°
 > 
°›Crôîi⁄
)

498 
SPoöt
 *
p_EPZS_poöt
 = 
p_EPZS
->
¥edi˘‹
->
poöt
;

499 
Boﬁón
 
checkMedün
 = 
FALSE
;

500 
di°blk
 
£c⁄d_mco°
 = 
DISTBLK_MAX
;

501 
di°blk
 
mco°
;

502 
¥ednum
 = 5;

503 
c⁄dôi⁄EPZS
;

505 
MŸi⁄Ve˘‹
 
tmv
, 
tmp2
 = {0,0};

506 
pos
;

508 
°›Crôîi⁄
 = 
	`EPZSDëîmöeSt›Crôîi⁄
 (
p_EPZS
, 
¥evSad
, 
mv_block
, 
œmbda_di°
);

510 i‡(
mö_mco°
 < (
°›Crôîi⁄
 >> 1))

512 #i‡
EPZSREF


513 i‡(
p_I≈
->
EPZSS∑tülMem
)

515 i‡(
p_I≈
->
EPZSS∑tülMem
 && 
ªf
 == 0)

518 *
p_mŸi⁄
 = 
tmp
;

520  
mö_mco°
;

526 
	`EPZS_•©ül_¥edi˘‹s
 (
p_EPZS
, 
mv_block
 , 
li°
, 
cuºMB
->
li°_off£t
, 
ªf
, 
mŸi⁄
);

528 i‡(
p_I≈
->
EPZSS∑tülMem
)

529 
	`EPZS_•©ül_mem‹y_¥edi˘‹s
 (
p_EPZS
, 
mv_block
, 
cur_li°
, &
¥ednum
, 
ªf_pi˘uª
->
size_x
 >> 2);

535 
c⁄dôi⁄EPZS
 = (
ªf
 =0 || (ª‡> 0 && 
mö_mco°
 > 2 * 
°›Crôîi⁄
));

537 i‡(
c⁄dôi⁄EPZS
 && 
cuºMB
->
mbAddrX
 !0 && 
p_I≈
->
EPZSBlockTy≥
)

538 
	`EPZSBlockTy≥Pªdi˘‹s
 (
cuºSli˚
, 
mv_block
, 
p_EPZS_poöt
, &
¥ednum
);

541 
pos
 = 0;Öo†< 
¥ednum
; ++pos)

543 
tmv
 = 
p_EPZS_poöt
[
pos
].
mŸi⁄
;

544 
	`£t_öãgî_mv
(&
tmv
);

547 i‡((
	`übs
 (
tmv
.
mv_x
 - 
mv
->mv_xË- 
£¨chR™ge
->
max_x
 <0Ë&& (üb†—mv.
mv_y
 - mv->mv_yË- sórchR™ge->
max_y
 <= 0))

550 i‡(
EPZSM≠
[
tmv
.
mv_y
][
m≠Cíãr_x
 +Åmv.
mv_x
] !
p_EPZS
->
BlkCou¡
)

552 
EPZSM≠
[
tmv
.
mv_y
][
m≠Cíãr_x
 +Åmv.
mv_x
] = 
p_EPZS
->
BlkCou¡
;

554 
ˇnd
 = 
	`∑d_MVs
 (
tmv
, 
mv_block
);

557 
mco°
 = 
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd
, &
¥ed
);

559 i‡(
mco°
 < 
£c⁄d_mco°
)

561 
mco°
 +
mv_block
->
	`compuãPªdFPñ
 (
ªf_pi˘uª
, mv_block, 
£c⁄d_mco°
 - mco°, &
ˇnd
);

564 i‡(
mco°
 < 
mö_mco°
)

566 
tmp2
 = 
tmp
;

567 
tmp
 = 
tmv
;

568 
£c⁄d_mco°
 = 
mö_mco°
;

569 
mö_mco°
 = 
mco°
;

570 
checkMedün
 = 
TRUE
;

573 i‡(
mco°
 < 
£c⁄d_mco°
)

575 
tmp2
 = 
tmv
;

576 
£c⁄d_mco°
 = 
mco°
;

577 
checkMedün
 = 
TRUE
;

586 i‡(
mö_mco°
 < ((3 * 
°›Crôîi⁄
) >> 2))

588 #i‡
EPZSREF


589 i‡(
p_I≈
->
EPZSS∑tülMem
)

591 i‡(
p_I≈
->
EPZSS∑tülMem
 && 
ªf
 == 0)

594 *
p_mŸi⁄
 = 
tmp
;

596 *
mv
 = 
tmp
;

597  
mö_mco°
;

605 i‡(
mö_mco°
 > 
°›Crôîi⁄
)

607 
∑âînSt›
 = 0, 
poötNumbî
 = 0, 
checkPts
, 
√xtLa°
 = 0;

608 
tŸÆCheckPts
 = 0, 
mŸi⁄Dúe˘i⁄
 = 0;

609 c⁄° 
mv_ønge
 = 12;

612 i‡(
p_I≈
->
EPZSP©ã∫
 != 0)

614 i‡((
mö_mco°
 < 
°›Crôîi⁄
 + ((3 * 
p_EPZS
->
medthªs
[
blockty≥
]) >> 1)))

616 i‡((
tmp
.
mv_x
 =0 &&Åmp.
mv_y
 =0Ë|| (
	`übs
 (tmp.mv_x - 
mv
->mv_xË< (
mv_ønge
) && iabs (tmp.mv_y - mv->mv_y) < (mv_range)))

617 
£¨chP©ã∫F
 = 
p_Vid
->
sdüm⁄d
;

619 
£¨chP©ã∫F
 = 
p_Vid
->
squ¨e
;

622 
£¨chP©ã∫F
 = 
p_Vid
->
squ¨e
;

626 
˚¡î
 = 
tmp
;

629 
tŸÆCheckPts
 = 
£¨chP©ã∫F
->
£¨chPoöts
;

632 
checkPts
 = 
tŸÆCheckPts
;

635 
tmv
 = 
	`add_MVs
 (
˚¡î
, &(
£¨chP©ã∫F
->
poöt
[
poötNumbî
].
mŸi⁄
));

637 i‡((
	`übs
 (
tmv
.
mv_x
 - 
mv
->mv_xË<
£¨chR™ge
->
max_x
Ë&& (üb†—mv.
mv_y
 - mv->mv_yË<£¨chR™ge->
max_y
))

639 i‡(
EPZSM≠
[
tmv
.
mv_y
][
m≠Cíãr_x
 +Åmv.
mv_x
] !
p_EPZS
->
BlkCou¡
)

641 
EPZSM≠
[
tmv
.
mv_y
][
m≠Cíãr_x
 +Åmv.
mv_x
] = 
p_EPZS
->
BlkCou¡
;

642 
ˇnd
 = 
	`∑d_MVs
(
tmv
, 
mv_block
);

644 
mco°
 = 
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd
, &
¥ed
);

645 i‡(
mco°
 < 
mö_mco°
)

648 
mco°
 +
mv_block
->
	`compuãPªdFPñ
 (
ªf_pi˘uª
, mv_block, 
mö_mco°
 - mco°, &
ˇnd
);

650 i‡(
mco°
 < 
mö_mco°
)

652 
tmp
 = 
tmv
;

653 
mö_mco°
 = 
mco°
;

654 
mŸi⁄Dúe˘i⁄
 = 
poötNumbî
;

659 ++
poötNumbî
;

660 i‡(
poötNumbî
 >
£¨chP©ã∫F
->
£¨chPoöts
)

661 
poötNumbî
 -
£¨chP©ã∫F
->
£¨chPoöts
;

662 
checkPts
--;

664 
checkPts
 > 0);

666 i‡(
√xtLa°
 || ((
tmp
.
mv_x
 =
˚¡î
.mv_xË&& (tmp.
mv_y
 == center.mv_y)))

668 
∑âînSt›
 = 
£¨chP©ã∫F
->
°›Sórch
;

669 
£¨chP©ã∫F
 = sórchP©ã∫F->
√xç©ã∫
;

670 
tŸÆCheckPts
 = 
£¨chP©ã∫F
->
£¨chPoöts
;

671 
√xtLa°
 = 
£¨chP©ã∫F
->nextLast;

672 
mŸi⁄Dúe˘i⁄
 = 0;

673 
poötNumbî
 = 0;

677 
tŸÆCheckPts
 = 
£¨chP©ã∫F
->
poöt
[
mŸi⁄Dúe˘i⁄
].
√xt_poöts
;

678 
poötNumbî
 = 
£¨chP©ã∫F
->
poöt
[
mŸi⁄Dúe˘i⁄
].
°¨t_nmbr
;

679 
˚¡î
 = 
tmp
;

682 
∑âînSt›
 != 1);

684 i‡((
ªf
 > 0Ë&& (
cuºSli˚
->
°ru˘uª
 =
FRAME
)

685 && ((4 * *
¥evSad
 < 
mö_mco°
Ë|| ((3 * *¥evSad < mö_mco°Ë&& (*¥evSad <
°›Crôîi⁄
))))

687 *
mv
 = 
tmp
;

688 #i‡
EPZSREF


689 i‡(
p_I≈
->
EPZSS∑tülMem
)

691 i‡(
p_I≈
->
EPZSS∑tülMem
 && 
ªf
 == 0)

694 *
p_mŸi⁄
 = 
tmp
;

697  
mö_mco°
;

701 
c⁄dôi⁄EPZS
 = (
checkMedün
 =
TRUE
)

702 && ((
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
))

703 && (
mö_mco°
 > 
°›Crôîi⁄
Ë&& (
p_I≈
->
EPZSDuÆ
 > 0);

705 i‡(!
c⁄dôi⁄EPZS
)

708 
poötNumbî
 = 0;

709 
∑âînSt›
 = 0;

710 
mŸi⁄Dúe˘i⁄
 = 0;

711 
√xtLa°
 = 0;

713 i‡((
tmp
.
mv_x
 =0 &&Åmp.
mv_y
 =0Ë|| (tmp.mv_x =
mv
->mv_x &&Åmp.mv_y == mv->mv_y))

715 i‡(
	`übs
 (
tmp
.
mv_x
 - 
mv
->mv_xË< (
mv_ønge
Ë&& iab†—mp.
mv_y
 - mv->mv_y) < (mv_range))

716 
£¨chP©ã∫F
 = 
p_Vid
->
sdüm⁄d
;

718 
£¨chP©ã∫F
 = 
p_Vid
->
squ¨e
;

721 
£¨chP©ã∫F
 = 
p_EPZS
->
£¨chP©ã∫D
;

724 
˚¡î
 = 
tmp2
;

725 
checkMedün
 = 
FALSE
;

730 i‡((
ªf
 =0Ë|| (*
¥evSad
 > 
mö_mco°
))

731 *
¥evSad
 = 
mö_mco°
;

733 #i‡
EPZSREF


734 i‡(
p_I≈
->
EPZSS∑tülMem
)

736 i‡(
p_I≈
->
EPZSS∑tülMem
 && 
ªf
 == 0)

739 *
p_mŸi⁄
 = 
tmp
;

742 *
mv
 = 
tmp
;

744  
mö_mco°
;

745 
	}
}

756 
di°blk


757 
	$EPZS_bùªd_mŸi⁄_e°im©i⁄
 (
Ma¸oblock
 * 
cuºMB
,

758 
li°
,

759 
MŸi⁄Ve˘‹
 * 
¥ed_mv1
,

760 
MŸi⁄Ve˘‹
 * 
¥ed_mv2
,

761 
MŸi⁄Ve˘‹
 * 
mv1
,

762 
MŸi⁄Ve˘‹
 * 
mv2
,

763 
MEBlock
 * 
mv_block
,

764 
£¨ch_ønge
,

765 
di°blk
 
mö_mco°
,

766 
œmbda_Á˘‹


769 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

770 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

771 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

772 
EPZSP¨amëîs
 *
p_EPZS
 = 
cuºSli˚
->p_EPZS;

773 
PicMŸi⁄P¨ams
 **
mŸi⁄
 = 
p_Vid
->
íc_pi˘uª
->
mv_öfo
;

775 
blockty≥
 = 
mv_block
->blocktype;

776 
ªf
 = 
mv_block
->
ªf_idx
;

778 
St‹abÀPi˘uª
 *
ªf_pi˘uª1
 = 
cuºSli˚
->
li°X
[
li°
 + 
cuºMB
->
li°_off£t
][
ªf
];

779 
St‹abÀPi˘uª
 *
ªf_pi˘uª2
 = 
cuºSli˚
->
li°X
[(
li°
 ^ 1Ë+ 
cuºMB
->
li°_off£t
][0];

781 
m≠Cíãr_x
 = 
£¨ch_ønge
 - 
mv1
->
mv_x
;

782 
m≠Cíãr_y
 = 
£¨ch_ønge
 - 
mv1
->
mv_y
;

783 
di°blk
 
œmbda_di°
 = 
	`weighãd_co°
(
œmbda_Á˘‹
, 4);

784 
di°blk
 
°›Crôîi⁄
 = 
p_EPZS
->
medthªs
[
blockty≥
] + 
œmbda_di°
;

785 
di°blk
 *
¥evSad
 = &
p_EPZS
->
bi_di°‹ti⁄
[
li°
 + 
cuºMB
->
li°_off£t
][
blockty≥
 - 1][
mv_block
->
pos_x2
];

786 
EPZSSåu˘uª
 *
£¨chP©ã∫F
 = 
p_EPZS
->
£¨chP©ã∫
;

787 
uöt16
 **
EPZSM≠
 = &
p_EPZS
->EPZSM≠[
m≠Cíãr_y
];

789 
MŸi⁄Ve˘‹
 
tmp
 = *
mv1
;

790 
MŸi⁄Ve˘‹
 
˚¡î1
 = 
	`∑d_MVs
 (*
mv1
, 
mv_block
);

791 
MŸi⁄Ve˘‹
 
˚¡î2
 = 
	`∑d_MVs
 (*
mv2
, 
mv_block
);

792 
MŸi⁄Ve˘‹
 
¥ed1
 = 
	`∑d_MVs
 (*
¥ed_mv1
, 
mv_block
);

793 
MŸi⁄Ve˘‹
 
¥ed2
 = 
	`∑d_MVs
 (*
¥ed_mv2
, 
mv_block
);

794 
MŸi⁄Ve˘‹
 
ˇnd1
 = 
˚¡î1
;

795 
MŸi⁄Ve˘‹
 
ˇnd2
 = 
˚¡î2
;

797 ++
p_EPZS
->
BlkCou¡
;

798 i‡(
p_EPZS
->
BlkCou¡
 == 0)

799 ++
p_EPZS
->
BlkCou¡
;

806 
p_EPZS
->
EPZSM≠
[
£¨ch_ønge
][£¨ch_ønge] =Ö_EPZS->
BlkCou¡
;

809 
mö_mco°
 = 
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd1
, &
¥ed1
);

810 
mö_mco°
 +
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd2
, &
¥ed2
);

813 
mö_mco°
 +
mv_block
->
	`compuãBiPªdFPñ
 (
ªf_pi˘uª1
, 
ªf_pi˘uª2
, mv_block, 
DISTBLK_MAX
-mö_mco°, &
ˇnd1
, &
ˇnd2
);

816 i‡(
mö_mco°
 > 
°›Crôîi⁄
)

818 
SPoöt
 *
p_EPZS_poöt
 = 
p_EPZS
->
¥edi˘‹
->
poöt
;

819 
Boﬁón
 
checkMedün
 = 
FALSE
;

820 
di°blk
 
£c⁄d_mco°
 = 
DISTBLK_MAX
;

821 
di°blk
 
mco°
;

822 
¥ednum
 = 5;

823 
MŸi⁄Ve˘‹
 
tmv
, 
tmp2
 = { 0, 0 };

824 
pos
;

826 
°›Crôîi⁄
 = 
	`EPZSDëîmöeSt›Crôîi⁄
 (
p_EPZS
, 
¥evSad
, 
mv_block
, 
œmbda_di°
);

831 
	`EPZS_•©ül_¥edi˘‹s
 (
p_EPZS
, 
mv_block
 , 
li°
, 
cuºMB
->
li°_off£t
, 
ªf
, 
mŸi⁄
);

834 
pos
 = 0;Öo†< 
¥ednum
; ++pos)

836 
tmv
 = 
p_EPZS_poöt
[
pos
].
mŸi⁄
;

837 
	`£t_öãgî_mv
(&
tmv
);

839 i‡(
	`übs
 (
tmv
.
mv_x
 - 
mv1
->mv_xË<
£¨ch_ønge
 && iab†—mv.
mv_y
 - mv1->mv_y) <= search_range)

841 i‡(
EPZSM≠
[
tmv
.
mv_y
][
m≠Cíãr_x
 +Åmv.
mv_x
] !
p_EPZS
->
BlkCou¡
)

843 
EPZSM≠
[
tmv
.
mv_y
][
m≠Cíãr_x
 +Åmv.
mv_x
] = 
p_EPZS
->
BlkCou¡
;

845 
ˇnd1
 = 
	`∑d_MVs
 (
tmv
, 
mv_block
);

848 
mco°
 = 
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd1
, &
¥ed1
);

849 
mco°
 +
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd2
, &
¥ed2
);

851 i‡(
mco°
 >
£c⁄d_mco°
)

854 
mco°
 +
mv_block
->
	`compuãBiPªdFPñ
 (
ªf_pi˘uª1
, 
ªf_pi˘uª2
, mv_block, 
£c⁄d_mco°
 - mco°, &
ˇnd1
, &
ˇnd2
);

857 i‡(
mco°
 < 
mö_mco°
)

859 
tmp2
 = 
tmp
;

860 
tmp
 = 
tmv
;

861 
£c⁄d_mco°
 = 
mö_mco°
;

862 
mö_mco°
 = 
mco°
;

863 
checkMedün
 = 
TRUE
;

866 i‡(
mco°
 < 
£c⁄d_mco°
)

868 
tmp2
 = 
tmv
;

869 
£c⁄d_mco°
 = 
mco°
;

870 
checkMedün
 = 
TRUE
;

880 i‡(
mö_mco°
 > 
°›Crôîi⁄
)

882 
c⁄dôi⁄EPZS
;

883 
∑âînSt›
 = 0, 
poötNumbî
 = 0, 
checkPts
, 
√xtLa°
 = 0;

884 
tŸÆCheckPts
 = 0, 
mŸi⁄Dúe˘i⁄
 = 0;

886 c⁄° 
mv_ønge
 = 12;

889 i‡(
p_I≈
->
EPZSP©ã∫
 != 0)

891 i‡((
mö_mco°
 < 
°›Crôîi⁄
 + ((4 * 
p_EPZS
->
medthªs
[
blockty≥
]) >> 1)))

893 i‡((
tmp
.
mv_x
 =0 &&Åmp.
mv_y
 =0Ë|| (
	`übs
 (tmp.mv_x - 
mv1
->mv_xË< (
mv_ønge
) && iabs (tmp.mv_y - mv1->mv_y) < (mv_range)))

894 
£¨chP©ã∫F
 = 
p_Vid
->
sdüm⁄d
;

896 
£¨chP©ã∫F
 = 
p_Vid
->
squ¨e
;

898 i‡(
blockty≥
 > 5 || (
ªf
 > 0 && blocktype != 1))

899 
£¨chP©ã∫F
 = 
p_Vid
->
squ¨e
;

901 
£¨chP©ã∫F
 = 
p_EPZS
->
£¨chP©ã∫
;

905 
˚¡î1
 = 
tmp
;

908 
tŸÆCheckPts
 = 
£¨chP©ã∫F
->
£¨chPoöts
;

911 
checkPts
 = 
tŸÆCheckPts
;

914 
tmv
 = 
	`add_MVs
 (
˚¡î1
, &(
£¨chP©ã∫F
->
poöt
[
poötNumbî
].
mŸi⁄
));

916 i‡((
	`übs
 (
tmv
.
mv_x
 - 
mv1
->mv_xË<
£¨ch_ønge
Ë&& (üb†—mv.
mv_y
 - mv1->mv_y) <= search_range))

918 i‡(
EPZSM≠
[
tmv
.
mv_y
][
m≠Cíãr_x
 +Åmv.
mv_x
] !
p_EPZS
->
BlkCou¡
)

920 
EPZSM≠
[
tmv
.
mv_y
][
m≠Cíãr_x
 +Åmv.
mv_x
] = 
p_EPZS
->
BlkCou¡
;

921 
ˇnd1
 = 
	`∑d_MVs
 (
tmv
, 
mv_block
);

923 
mco°
 = 
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd1
, &
¥ed1
);

924 
mco°
 +
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd2
, &
¥ed2
);

926 i‡(
mco°
 < 
mö_mco°
)

928 
mco°
 +
mv_block
->
	`compuãBiPªdFPñ
 (
ªf_pi˘uª1
, 
ªf_pi˘uª2
, mv_block, 
mö_mco°
 - mco°, &
ˇnd1
, &
ˇnd2
);

930 i‡(
mco°
 < 
mö_mco°
)

932 
tmp
 = 
tmv
;

933 
mö_mco°
 = 
mco°
;

934 
mŸi⁄Dúe˘i⁄
 = 
poötNumbî
;

939 ++
poötNumbî
;

940 i‡(
poötNumbî
 >
£¨chP©ã∫F
->
£¨chPoöts
)

941 
poötNumbî
 -
£¨chP©ã∫F
->
£¨chPoöts
;

942 
checkPts
--;

944 
checkPts
 > 0);

946 i‡(
√xtLa°
 || ((
tmp
.
mv_x
 =
˚¡î1
.mv_xË&& (tmp.
mv_y
 == center1.mv_y)))

948 
∑âînSt›
 = 
£¨chP©ã∫F
->
°›Sórch
;

949 
£¨chP©ã∫F
 = sórchP©ã∫F->
√xç©ã∫
;

950 
tŸÆCheckPts
 = 
£¨chP©ã∫F
->
£¨chPoöts
;

951 
√xtLa°
 = 
£¨chP©ã∫F
->nextLast;

952 
mŸi⁄Dúe˘i⁄
 = 0;

953 
poötNumbî
 = 0;

957 
tŸÆCheckPts
 = 
£¨chP©ã∫F
->
poöt
[
mŸi⁄Dúe˘i⁄
].
√xt_poöts
;

958 
poötNumbî
 = 
£¨chP©ã∫F
->
poöt
[
mŸi⁄Dúe˘i⁄
].
°¨t_nmbr
;

959 
˚¡î1
 = 
tmp
;

962 
∑âînSt›
 != 1);

965 
c⁄dôi⁄EPZS
 = (
checkMedün
 =
TRUE
Ë&& (
blockty≥
 < 5Ë&& (
mö_mco°
 > 
°›Crôîi⁄
Ë&& (
p_I≈
->
EPZSDuÆ
 > 0);

967 i‡(!
c⁄dôi⁄EPZS
)

970 
poötNumbî
 = 0;

971 
∑âînSt›
 = 0;

972 
mŸi⁄Dúe˘i⁄
 = 0;

973 
√xtLa°
 = 0;

975 i‡((
tmp
.
mv_x
 =0 &&Åmp.
mv_y
 =0Ë|| (tmp.mv_x =
mv1
->mv_x &&Åmp.mv_y == mv1->mv_y))

977 i‡(
	`übs
 (
tmp
.
mv_x
 - 
mv1
->mv_xË< (
mv_ønge
Ë&& iab†—mp.
mv_y
 - mv1->mv_y) < (mv_range))

978 
£¨chP©ã∫F
 = 
p_Vid
->
sdüm⁄d
;

980 
£¨chP©ã∫F
 = 
p_Vid
->
squ¨e
;

983 
£¨chP©ã∫F
 = 
p_EPZS
->
£¨chP©ã∫D
;

984 
tŸÆCheckPts
 = 
£¨chP©ã∫F
->
£¨chPoöts
;

987 
˚¡î1
 = 
tmp2
;

988 
checkMedün
 = 
FALSE
;

993 i‡(
mv_block
->
ôî©i⁄_no
 == 0)

995 *
¥evSad
 = 
mö_mco°
;

998 *
mv1
 = 
tmp
;

1000  
mö_mco°
;

1001 
	}
}

	@lencod/src/me_epzs_common.c

16 
	~<limôs.h
>

18 
	~"c⁄åibut‹s.h
"

19 
	~"globÆ.h
"

20 
	~"image.h
"

21 
	~"memÆloc.h
"

22 
	~"mb_ac˚ss.h
"

23 
	~"ªfbuf.h
"

24 
	~"ma¸oblock.h
"

25 
	~"me_di°‹ti⁄.h
"

26 
	~"me_ïzs.h
"

27 
	~"me_ïzs_comm⁄.h
"

28 
	~"me_ïzs_öt.h
"

29 
	~"me_fuŒ£¨ch.h
"

30 
	~"mv_£¨ch.h
"

32 c⁄° 
	gBLOCK_PARENT
[8] = { 1, 1, 1, 1, 2, 4, 4, 5 };

33 c⁄° 
	gMIN_THRES_BASE
[8] = { 0, 64, 32, 32, 16, 8, 8, 4 };

34 c⁄° 
	gMED_THRES_BASE
[8] = { 0, 256, 128, 128, 64, 32, 32, 16 };

35 c⁄° 
	gMAX_THRES_BASE
[8] = { 0, 768, 384, 384, 192, 96, 96, 48 };

38 c⁄° 
	gEPZS_PATTERN
[6][20] = { "Diamond", "Square", "Extended Diamond", "Large Diamond", "SBP Large Diamond", "PMVFAST" };

39 c⁄° 
	gEPZS_DUAL_PATTERN
[7][20] =

41 c⁄° 
	gEPZS_FIXED_PREDICTORS
[4][20] = { "Disabled", "All P", "All P + B", "Aggressive" };

42 c⁄° 
	gEPZS_OTHER_PREDICTORS
[2][20] = { "Disabled", "Enabled" };

43 c⁄° 
	gEPZS_SUBPEL_METHOD
[3][20] = { "Full", "Basic", "Enhanced" };

46 c⁄° 
	g∑âîn_d©a
[7][12][4] =

84 
EPZSSåu˘uª
 *

85 
	$ÆlocEPZS∑âîn
 (
£¨chpoöts
)

87 
EPZSSåu˘uª
 *
s
;

88 
s
 = 
	`ˇŒoc
 (1,  (
EPZSSåu˘uª
));

90 i‡(
NULL
 =
s
)

91 
	`no_mem_exô
 ("alloc_EPZSpattern: s");

93 
s
->
£¨chPoöts
 = 
£¨chpoöts
;

94 
s
->
poöt
 = (
SPoöt
 *Ë
	`ˇŒoc
 (
£¨chpoöts
,  (SPoint));

96  
s
;

97 
	}
}

110 
	$‰ìEPZS∑âîn
 (
EPZSSåu˘uª
 * 
p
)

112 i‡(
p
)

114 
	`‰ì
 ((
SPoöt
 *Ë
p
->
poöt
);

115 
	`‰ì
 (
p
);

116 
p
 = 
NULL
;

118 
	}
}

129 
	$assignEPZS∑âîn
 (
EPZSSåu˘uª
 * 
∑âîn
, 
ty≥
, 
°›Sórch
, 
√xtLa°
, EPZSSåu˘uª * 
√xç©ã∫
)

131 
i
;

133 
i
 = 0; i < 
∑âîn
->
£¨chPoöts
; ++i)

135 
∑âîn
->
poöt
[
i
].
mŸi⁄
.
mv_x
 = 
∑âîn_d©a
[
ty≥
][i][0];

136 
∑âîn
->
poöt
[
i
].
mŸi⁄
.
mv_y
 = 
∑âîn_d©a
[
ty≥
][i][1];

137 
∑âîn
->
poöt
[
i
].
°¨t_nmbr
 = 
∑âîn_d©a
[
ty≥
][i][2];

138 
∑âîn
->
poöt
[
i
].
√xt_poöts
 = 
∑âîn_d©a
[
ty≥
][i][3];

140 
∑âîn
->
°›Sórch
 = stopSearch;

141 
∑âîn
->
√xtLa°
 =ÇextLast;

142 
∑âîn
->
√xç©ã∫
 =Çextpattern;

143 
	}
}

151 
	$EPZS_£tup_ígöe
(
Ma¸oblock
 *
cuºMB
, 
I≈utP¨amëîs
 *
p_I≈
)

153 
cuºMB
->
I¡PñME
 = (
p_I≈
->
EPZSSubPñGrid
Ë? 
EPZS_öãgî_mŸi⁄_e°im©i⁄
 : 
EPZS_mŸi⁄_e°im©i⁄
;

154 
cuºMB
->
BiPªdME
 = (
p_I≈
->
EPZSSubPñGrid
Ë? 
EPZS_öãgî_bùªd_mŸi⁄_e°im©i⁄
 : 
EPZS_bùªd_mŸi⁄_e°im©i⁄
;

155 i‡(
p_I≈
->
EPZSSubPñME
 == 1)

156 
cuºMB
->
SubPñME
 = 
EPZS_sub_≥l_mŸi⁄_e°im©i⁄
;

157 i‡(
p_I≈
->
EPZSSubPñME
 == 2)

158 
cuºMB
->
SubPñME
 = 
fuŒ_sub_≥l_mŸi⁄_e°im©i⁄
;

160 
cuºMB
->
SubPñME
 = 
sub_≥l_mŸi⁄_e°im©i⁄
;

161 i‡(
p_I≈
->
EPZSSubPñMEBiPªd
 == 1)

162 
cuºMB
->
SubPñBiPªdME
 = 
EPZS_sub_≥l_bùªd_mŸi⁄_e°im©i⁄
;

163 i‡(
p_I≈
->
EPZSSubPñMEBiPªd
 == 2)

164 
cuºMB
->
SubPñBiPªdME
 = 
fuŒ_sub_≥l_bùªd_mŸi⁄_e°im©i⁄
;

166 
cuºMB
->
SubPñBiPªdME
 = 
sub_≥l_bùªd_mŸi⁄_e°im©i⁄
;

167 
	}
}

176 
	$EPZSInô
 (
VideoP¨amëîs
 * 
p_Vid
)

179 
mem‹y_size
 = 0;

191 if(!
p_Vid
->
sdüm⁄d
)

193 
p_Vid
->
sdüm⁄d
 = 
	`ÆlocEPZS∑âîn
 (4);

194 
	`assignEPZS∑âîn
 (
p_Vid
->
sdüm⁄d
, 
SDIAMOND
, 
TRUE
, TRUE,Ö_Vid->sdiamond);

196 if(!
p_Vid
->
squ¨e
)

198 
p_Vid
->
squ¨e
 = 
	`ÆlocEPZS∑âîn
 (8);

199 
	`assignEPZS∑âîn
 (
p_Vid
->
squ¨e
, 
SQUARE
, 
TRUE
, TRUE,Ö_Vid->square);

201 if(!
p_Vid
->
edüm⁄d
)

203 
p_Vid
->
edüm⁄d
 = 
	`ÆlocEPZS∑âîn
 (12);

204 
	`assignEPZS∑âîn
 (
p_Vid
->
edüm⁄d
, 
EDIAMOND
, 
TRUE
, TRUE,Ö_Vid->ediamond);

206 if(!
p_Vid
->
ldüm⁄d
)

208 
p_Vid
->
ldüm⁄d
 = 
	`ÆlocEPZS∑âîn
 (8);

209 
	`assignEPZS∑âîn
 (
p_Vid
->
ldüm⁄d
, 
LDIAMOND
, 
TRUE
, TRUE,Ö_Vid->ldiamond);

211 if(!
p_Vid
->
sbdüm⁄d
)

213 
p_Vid
->
sbdüm⁄d
 = 
	`ÆlocEPZS∑âîn
 (12);

214 
	`assignEPZS∑âîn
 (
p_Vid
->
sbdüm⁄d
, 
SBDIAMOND
, 
FALSE
, 
TRUE
,Ö_Vid->
sdüm⁄d
);

216 if(!
p_Vid
->
pmvÁ°
)

218 
p_Vid
->
pmvÁ°
 = 
	`ÆlocEPZS∑âîn
 (8);

219 
	`assignEPZS∑âîn
 (
p_Vid
->
pmvÁ°
, 
LDIAMOND
, 
FALSE
, 
TRUE
,Ö_Vid->
sdüm⁄d
);

222  
mem‹y_size
;

223 
	}
}

232 
	$EPZSDñëe
 (
VideoP¨amëîs
 * 
p_Vid
)

235 if(
p_Vid
->
pmvÁ°
)

237 
	`‰ìEPZS∑âîn
 (
p_Vid
->
pmvÁ°
);

238 
p_Vid
->
pmvÁ°
 = 
NULL
;

240 if(
p_Vid
->
sbdüm⁄d
)

242 
	`‰ìEPZS∑âîn
 (
p_Vid
->
sbdüm⁄d
);

243 
p_Vid
->
sbdüm⁄d
 = 
NULL
;

245 if(
p_Vid
->
ldüm⁄d
)

247 
	`‰ìEPZS∑âîn
 (
p_Vid
->
ldüm⁄d
);

248 
p_Vid
->
ldüm⁄d
 = 
NULL
;

250 if(
p_Vid
->
edüm⁄d
)

252 
	`‰ìEPZS∑âîn
 (
p_Vid
->
edüm⁄d
);

253 
p_Vid
->
edüm⁄d
 = 
NULL
;

255 if(
p_Vid
->
sdüm⁄d
)

257 
	`‰ìEPZS∑âîn
 (
p_Vid
->
sdüm⁄d
);

258 
p_Vid
->
sdüm⁄d
 = 
NULL
;

260 if(
p_Vid
->
squ¨e
)

262 
	`‰ìEPZS∑âîn
 (
p_Vid
->
squ¨e
);

263 
p_Vid
->
squ¨e
 = 
NULL
;

265 
	}
}

283 
EPZSCﬁocP¨ams
 *

284 
	$ÆlocEPZScﬁoˇãd
 (
size_x
, 
size_y
, 
mb_ad≠tive_‰ame_fõld_Êag
)

286 
EPZSCﬁocP¨ams
 *
s
;

287 
s
 = 
	`ˇŒoc
 (1,  (
EPZSCﬁocP¨ams
));

288 i‡(
NULL
 =
s
)

289 
	`no_mem_exô
 ("alloc_EPZScolocated: s");

291 
s
->
size_x
 = size_x;

292 
s
->
size_y
 = size_y;

293 
	`gë_mem3Dmv
 (&(
s
->
‰ame
), 2, (
size_y
 >> 
BLOCK_SHIFT
), (
size_x
 >> BLOCK_SHIFT));

295 i‡(
mb_ad≠tive_‰ame_fõld_Êag
)

297 
	`gë_mem3Dmv
 (&(
s
->
t›
), 2, (
size_y
 >> (
BLOCK_SHIFT
 + 1)), (
size_x
 >> BLOCK_SHIFT));

298 
	`gë_mem3Dmv
 (&(
s
->
bŸ
), 2, (
size_y
 >> (
BLOCK_SHIFT
 + 1)), (
size_x
 >> BLOCK_SHIFT));

301 
s
->
mb_ad≠tive_‰ame_fõld_Êag
 = mb_adaptive_frame_field_flag;

303  
s
;

304 
	}
}

317 
	$‰ìEPZScﬁoˇãd
 (
EPZSCﬁocP¨ams
 * 
p
)

320 i‡(
p
)

322 
	`‰ì_mem3Dmv
 (
p
->
‰ame
);

323 i‡(
p
->
mb_ad≠tive_‰ame_fõld_Êag
)

325 
	`‰ì_mem3Dmv
 (
p
->
t›
);

326 
	`‰ì_mem3Dmv
 (
p
->
bŸ
);

329 
	`‰ì
 (
p
);

330 
p
 = 
NULL
;

332 
	}
}

341 
	$EPZSWödowPªdi˘‹Inô
 (
£¨ch_ønge
, 
EPZSSåu˘uª
 * 
¥edi˘‹
, 
mode
)

343 
pos
;

344 
£¨chpos
, 
fõld£¨chpos
;

345 
¥ednum
 = -1;

346 
i
;

347 
£¨ch_ønge_q≥l
 = 2;

348 
SPoöt
 *
poöt
 = 
¥edi˘‹
->point;

350 i‡(
mode
 == 0)

352 
pos
 = (Ë(
	`RoundLog2
 (
£¨ch_ønge
) - 2);Öos > -1;Öos--)

354 
£¨chpos
 = ((
£¨ch_ønge
 << 
£¨ch_ønge_q≥l
Ë>> 
pos
);

356 
i
 = 1; i >= -1; i -= 2)

358 
poöt
[++
¥ednum
].
mŸi⁄
.
mv_x
 = 
i
 * 
£¨chpos
;

359 
poöt
[
¥ednum
].
mŸi⁄
.
mv_y
 = 0;

360 
poöt
[++
¥ednum
].
mŸi⁄
.
mv_x
 = 
i
 * 
£¨chpos
;

361 
poöt
[
¥ednum
].
mŸi⁄
.
mv_y
 = 
i
 * 
£¨chpos
;

362 
poöt
[++
¥ednum
].
mŸi⁄
.
mv_x
 = 0;

363 
poöt
[
¥ednum
].
mŸi⁄
.
mv_y
 = 
i
 * 
£¨chpos
;

364 
poöt
[++
¥ednum
].
mŸi⁄
.
mv_x
 = -
i
 * 
£¨chpos
;

365 
poöt
[
¥ednum
].
mŸi⁄
.
mv_y
 = 
i
 * 
£¨chpos
;

371 
pos
 = (Ë(
	`RoundLog2
 (
£¨ch_ønge
) - 2);Öos > -1;Öos--)

373 
£¨chpos
 = ((
£¨ch_ønge
 << 
£¨ch_ønge_q≥l
Ë>> 
pos
);

375 
fõld£¨chpos
 = ((3 * 
£¨chpos
 + 1Ë<< 
£¨ch_ønge_q≥l
) >> 1;

376 
i
 = 1; i >= -1; i -= 2)

378 
poöt
[++
¥ednum
].
mŸi⁄
.
mv_x
 = 
i
 * 
£¨chpos
;

379 
poöt
[
¥ednum
].
mŸi⁄
.
mv_y
 = 0;

380 
poöt
[++
¥ednum
].
mŸi⁄
.
mv_x
 = 
i
 * 
£¨chpos
;

381 
poöt
[
¥ednum
].
mŸi⁄
.
mv_y
 = 
i
 * 
£¨chpos
;

382 
poöt
[++
¥ednum
].
mŸi⁄
.
mv_x
 = 0;

383 
poöt
[
¥ednum
].
mŸi⁄
.
mv_y
 = 
i
 * 
£¨chpos
;

384 
poöt
[++
¥ednum
].
mŸi⁄
.
mv_x
 = -
i
 * 
£¨chpos
;

385 
poöt
[
¥ednum
].
mŸi⁄
.
mv_y
 = 
i
 * 
£¨chpos
;

388 
i
 = 1; i >= -1; i -= 2)

390 
poöt
[++
¥ednum
].
mŸi⁄
.
mv_x
 = 
i
 * 
fõld£¨chpos
;

391 
poöt
[
¥ednum
].
mŸi⁄
.
mv_y
 = -
i
 * 
£¨chpos
;

392 
poöt
[++
¥ednum
].
mŸi⁄
.
mv_x
 = 
i
 * 
fõld£¨chpos
;

393 
poöt
[
¥ednum
].
mŸi⁄
.
mv_y
 = 0;

394 
poöt
[++
¥ednum
].
mŸi⁄
.
mv_x
 = 
i
 * 
fõld£¨chpos
;

395 
poöt
[
¥ednum
].
mŸi⁄
.
mv_y
 = 
i
 * 
£¨chpos
;

396 
poöt
[++
¥ednum
].
mŸi⁄
.
mv_x
 = 
i
 * 
£¨chpos
;

397 
poöt
[
¥ednum
].
mŸi⁄
.
mv_y
 = 
i
 * 
fõld£¨chpos
;

398 
poöt
[++
¥ednum
].
mŸi⁄
.
mv_x
 = 0;

399 
poöt
[
¥ednum
].
mŸi⁄
.
mv_y
 = 
i
 * 
fõld£¨chpos
;

400 
poöt
[++
¥ednum
].
mŸi⁄
.
mv_x
 = -
i
 * 
£¨chpos
;

401 
poöt
[
¥ednum
].
mŸi⁄
.
mv_y
 = 
i
 * 
fõld£¨chpos
;

406 
¥edi˘‹
->
£¨chPoöts
 = 
¥ednum
;

407 
	}
}

416 
	$EPZSSåu˘Inô
 (
Sli˚
 * 
cuºSli˚
)

418 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

419 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºSli˚
->p_Inp;

420 
EPZSP¨amëîs
 *
p_EPZS
 = 
cuºSli˚
->p_EPZS;

421 
max_li°_numbî
 = 
p_Vid
->
mb_aff_‰ame_Êag
 ? 6 : 2;

422 
≥l_îr‹_me
 = 1 << (
p_Vid
->
bôdïth_luma
 - 8);

423 
≥l_îr‹_me_¸
 = 1 << (
p_Vid
->
bôdïth_chroma
 - 8);

424 
i
, 
mem‹y_size
 = 0;

425 
chroma_weight
 =

426 
p_I≈
->
ChromaMEE«bÀ
 ? 
≥l_îr‹_me_¸
 *Ö_I≈->
ChromaMEWeight
 * (Ë(
p_Vid
->
width_¸
 *Ö_Vid->
height_¸
) /

427 (Ë(
p_Vid
->
width
 *Ö_Vid->
height
) : 0;

428 
£¨chÀvñs
 = 
	`RoundLog2
 (
p_I≈
->
£¨ch_ønge
[
p_Vid
->
võw_id
]) - 1;

429 
£¨ch¨øy
 =

430 
p_I≈
->
BiPªdMŸi⁄E°im©i⁄
 ? (2 * 
	`imax
 (p_I≈->
£¨ch_ønge
[
p_Vid
->
võw_id
],Ö_I≈->
BiPªdMESórchR™ge
[p_Vid->view_id]) +

431 1Ë<< 2 : (2 * 
p_I≈
->
£¨ch_ønge
[
p_Vid
->
võw_id
] + 1) << 2;

432 
p_EPZS
->
p_Vid
 =Ö_Vid;

433 
p_EPZS
->
BlkCou¡
 = 1;

440 
i
 = 0; i < 8; ++i)

442 #i‡(
MVC_EXTENSION_ENABLE
)

443 i‡–(
cuºSli˚
->
võw_id
Ë&& (
p_I≈
->
E«bÀEnhLayîEPZSSˇÀrs
) )

445 
p_EPZS
->
medthªs
[
i
] = 
p_I≈
->
EPZSMedThªsSˇÀ
[
cuºSli˚
->
võw_id
] * (
MED_THRES_BASE
[i] * 
≥l_îr‹_me
 + (Ë(MED_THRES_BASE[i] * 
chroma_weight
 + 0.5));

446 
p_EPZS
->
maxthªs
[
i
] = 
p_I≈
->
EPZSMaxThªsSˇÀ
[
cuºSli˚
->
võw_id
] * (
MAX_THRES_BASE
[i] * 
≥l_îr‹_me
 + (Ë(MAX_THRES_BASE[i] * 
chroma_weight
 + 0.5));

447 
p_EPZS
->
möthªs
[
i
] = 
p_I≈
->
EPZSMöThªsSˇÀ
[
cuºSli˚
->
võw_id
] * (
MIN_THRES_BASE
[i] * 
≥l_îr‹_me
 + (Ë(MIN_THRES_BASE[i] * 
chroma_weight
 + 0.5));

448 
p_EPZS
->
subthªs
[
i
] = 
p_I≈
->
EPZSSubPñThªsSˇÀ
[
cuºSli˚
->
võw_id
] * (
MED_THRES_BASE
[i] * 
≥l_îr‹_me
 + (Ë(MED_THRES_BASE[i] * 
chroma_weight
 + 0.5));

452 
p_EPZS
->
medthªs
[
i
] = 
p_I≈
->
EPZSMedThªsSˇÀ
[0] * (
MED_THRES_BASE
[i] * 
≥l_îr‹_me
 + (Ë(MED_THRES_BASE[i] * 
chroma_weight
 + 0.5));

453 
p_EPZS
->
maxthªs
[
i
] = 
p_I≈
->
EPZSMaxThªsSˇÀ
[0] * (
MAX_THRES_BASE
[i] * 
≥l_îr‹_me
 + (Ë(MAX_THRES_BASE[i] * 
chroma_weight
 + 0.5));

454 
p_EPZS
->
möthªs
[
i
] = 
p_I≈
->
EPZSMöThªsSˇÀ
[0] * (
MIN_THRES_BASE
[i] * 
≥l_îr‹_me
 + (Ë(MIN_THRES_BASE[i] * 
chroma_weight
 + 0.5));

455 
p_EPZS
->
subthªs
[
i
] = 
p_I≈
->
EPZSSubPñThªsSˇÀ
[0] * (
MED_THRES_BASE
[i] * 
≥l_îr‹_me
 + (Ë(MED_THRES_BASE[i] * 
chroma_weight
 + 0.5));

458 
p_EPZS
->
medthªs
[
i
] = 
p_I≈
->
EPZSMedThªsSˇÀ
 * (
MED_THRES_BASE
[i] * 
≥l_îr‹_me
 + (Ë(MED_THRES_BASE[i] * 
chroma_weight
 + 0.5));

459 
p_EPZS
->
maxthªs
[
i
] = 
p_I≈
->
EPZSMaxThªsSˇÀ
 * (
MAX_THRES_BASE
[i] * 
≥l_îr‹_me
 + (Ë(MAX_THRES_BASE[i] * 
chroma_weight
 + 0.5));

460 
p_EPZS
->
möthªs
[
i
] = 
p_I≈
->
EPZSMöThªsSˇÀ
 * (
MIN_THRES_BASE
[i] * 
≥l_îr‹_me
 + (Ë(MIN_THRES_BASE[i] * 
chroma_weight
 + 0.5));

461 
p_EPZS
->
subthªs
[
i
] = 
p_I≈
->
EPZSSubPñThªsSˇÀ
 * (
MED_THRES_BASE
[i] * 
≥l_îr‹_me
 + (Ë(MED_THRES_BASE[i] * 
chroma_weight
 + 0.5));

463 
	`up_sˇÀ
(&
p_EPZS
->
medthªs
[
i
]);

464 
	`up_sˇÀ
(&
p_EPZS
->
maxthªs
[
i
]);

465 
	`up_sˇÀ
(&
p_EPZS
->
möthªs
[
i
]);

466 
	`up_sˇÀ
(&
p_EPZS
->
subthªs
[
i
]);

472 
p_EPZS
->
wödow_¥edi˘‹
 = 
	`ÆlocEPZS∑âîn
 (
£¨chÀvñs
 * 8);

473 
p_EPZS
->
wödow_¥edi˘‹_ext
 = 
	`ÆlocEPZS∑âîn
 (
£¨chÀvñs
 * 20);

474 
	`EPZSWödowPªdi˘‹Inô
 ((Ë
p_I≈
->
£¨ch_ønge
[
p_Vid
->
võw_id
], 
p_EPZS
->
wödow_¥edi˘‹
, 0);

475 
	`EPZSWödowPªdi˘‹Inô
 ((Ë
p_I≈
->
£¨ch_ønge
[
p_Vid
->
võw_id
], 
p_EPZS
->
wödow_¥edi˘‹_ext
, 1);

479 #i‡(
MVC_EXTENSION_ENABLE
)

480 
p_EPZS
->
¥edi˘‹
 = 
	`ÆlocEPZS∑âîn
 (
£¨chÀvñs
 * 20 + 5 + 5 + 9 * (
p_I≈
->
EPZSTemp‹Æ
[0] |Ö_I≈->EPZSTemp‹Æ[1]Ë+ 3 * (p_I≈->
EPZSS∑tülMem
));

482 
p_EPZS
->
¥edi˘‹
 = 
	`ÆlocEPZS∑âîn
 (
£¨chÀvñs
 * 20 + 5 + 5 + 9 * (
p_I≈
->
EPZSTemp‹Æ
Ë+ 3 * (p_I≈->
EPZSS∑tülMem
));

489 
mem‹y_size
 +
	`gë_mem3Ddi°blk
 (&(
p_EPZS
->
di°‹ti⁄
), 
max_li°_numbî
, 7, (
p_Vid
->
width
 + 
MB_BLOCK_SIZE
)/ 
BLOCK_SIZE
);

490 i‡(
p_I≈
->
BiPªdMŸi⁄E°im©i⁄
)

491 
mem‹y_size
 +
	`gë_mem3Ddi°blk
 (&(
p_EPZS
->
bi_di°‹ti⁄
), 
max_li°_numbî
, 7, (
p_Vid
->
width
 + 
MB_BLOCK_SIZE
Ë/ 
BLOCK_SIZE
);

492 
mem‹y_size
 +
	`gë_mem3Ddi°blk
 (&(
p_EPZS
->
di°‹ti⁄_h≥l
), 
max_li°_numbî
, 7, (
p_Vid
->
width
 + 
MB_BLOCK_SIZE
)/ 
BLOCK_SIZE
);

493 
mem‹y_size
 +
	`gë_mem2Dsh‹t
 ((***Ë&(
p_EPZS
->
EPZSM≠
), 
£¨ch¨øy
, searcharray);

495 i‡(
p_I≈
->
EPZSS∑tülMem
)

497 #i‡
EPZSREF


498 
mem‹y_size
 +
	`gë_mem5Dmv
 (&(
p_EPZS
->
p_mŸi⁄
), 6, 
p_Vid
->
max_num_ª„ªn˚s
, 7, 4,Ö_Vid->
width
 / 
BLOCK_SIZE
);

500 
mem‹y_size
 +
	`gë_mem4Dmv
 (&(
p_EPZS
->
p_mŸi⁄
), 6, 7, 4, 
p_Vid
->
width
 / 
BLOCK_SIZE
);

504 #i‡(
MVC_EXTENSION_ENABLE
)

505 i‡–
p_I≈
->
EPZSTemp‹Æ
[
cuºSli˚
->
võw_id
] )

507 i‡(
p_I≈
->
EPZSTemp‹Æ
)

510 
p_EPZS
->
p_cﬁoˇãd
 = 
	`ÆlocEPZScﬁoˇãd
 (
p_Vid
->
width
,Ö_Vid->
height
,Ö_Vid->
a˘ive_•s
->
mb_ad≠tive_‰ame_fõld_Êag
);

513 
p_I≈
->
EPZSP©ã∫
)

516 
p_EPZS
->
£¨chP©ã∫
 = 
p_Vid
->
pmvÁ°
;

519 
p_EPZS
->
£¨chP©ã∫
 = 
p_Vid
->
sbdüm⁄d
;

522 
p_EPZS
->
£¨chP©ã∫
 = 
p_Vid
->
ldüm⁄d
;

525 
p_EPZS
->
£¨chP©ã∫
 = 
p_Vid
->
edüm⁄d
;

528 
p_EPZS
->
£¨chP©ã∫
 = 
p_Vid
->
squ¨e
;

532 
p_EPZS
->
£¨chP©ã∫
 = 
p_Vid
->
sdüm⁄d
;

536 
p_I≈
->
EPZSDuÆ
)

539 
p_EPZS
->
£¨chP©ã∫D
 = 
p_Vid
->
pmvÁ°
;

542 
p_EPZS
->
£¨chP©ã∫D
 = 
p_Vid
->
sbdüm⁄d
;

545 
p_EPZS
->
£¨chP©ã∫D
 = 
p_Vid
->
ldüm⁄d
;

548 
p_EPZS
->
£¨chP©ã∫D
 = 
p_Vid
->
edüm⁄d
;

551 
p_EPZS
->
£¨chP©ã∫D
 = 
p_Vid
->
squ¨e
;

555 
p_EPZS
->
£¨chP©ã∫D
 = 
p_Vid
->
sdüm⁄d
;

559  
mem‹y_size
;

560 
	}
}

569 
	$EPZSSåu˘Dñëe
 (
Sli˚
 * 
cuºSli˚
)

571 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºSli˚
->p_Inp;

572 
EPZSP¨amëîs
 *
p_EPZS
 = 
cuºSli˚
->p_EPZS;

573 #i‡(
MVC_EXTENSION_ENABLE
)

574 i‡(
p_I≈
->
EPZSTemp‹Æ
[
cuºSli˚
->
võw_id
])

576 i‡(
p_I≈
->
EPZSTemp‹Æ
)

578 
	`‰ìEPZScﬁoˇãd
 (
p_EPZS
->
p_cﬁoˇãd
);

581 
	`‰ì_mem2Dsh‹t
 ((**Ë
p_EPZS
->
EPZSM≠
);

582 
	`‰ì_mem3Ddi°blk
 (
p_EPZS
->
di°‹ti⁄
);

583 
	`‰ì_mem3Ddi°blk
 (
p_EPZS
->
di°‹ti⁄_h≥l
);

585 i‡(
p_I≈
->
BiPªdMŸi⁄E°im©i⁄
)

586 
	`‰ì_mem3Ddi°blk
 (
p_EPZS
->
bi_di°‹ti⁄
);

588 
	`‰ìEPZS∑âîn
 (
p_EPZS
->
wödow_¥edi˘‹_ext
);

589 
	`‰ìEPZS∑âîn
 (
p_EPZS
->
wödow_¥edi˘‹
);

590 
	`‰ìEPZS∑âîn
 (
p_EPZS
->
¥edi˘‹
);

592 i‡(
p_I≈
->
EPZSS∑tülMem
)

594 #i‡
EPZSREF


595 
	`‰ì_mem5Dmv
 (
p_EPZS
->
p_mŸi⁄
);

597 
	`‰ì_mem4Dmv
 (
p_EPZS
->
p_mŸi⁄
);

601 
	`‰ì
 (
cuºSli˚
->
p_EPZS
);

602 
cuºSli˚
->
p_EPZS
 = 
NULL
;

603 
	}
}

613 
	$EPZSSli˚Inô
 (
Sli˚
 * 
cuºSli˚
)

615 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

616 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºSli˚
->p_Inp;

617 
St‹abÀPi˘uª
 *
p_Pic
 = 
p_Vid
->
íc_pi˘uª
;

618 
EPZSCﬁocP¨ams
 *
p
 = 
cuºSli˚
->
p_EPZS
->
p_cﬁoˇãd
;

619 
St‹abÀPi˘uª
 ***
li°X
 = 
cuºSli˚
->listX;

620 
St‹abÀPi˘uª
 *
fs
, *
fs_t›
, *
fs_bŸtom
;

621 
St‹abÀPi˘uª
 *
fs1
, *
fs_t›1
, *
fs_bŸtom1
, *
fsx
;

622 
EPZSP¨amëîs
 *
p_EPZS
 = 
cuºSli˚
->p_EPZS;

623 
i
, 
j
, 
k
, 
jj
, 
jdiv
, 
loff£t
;

624 
¥esˇÀ
, 
iTRb
, 
iTRp
;

625 
li°
 = (
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
Ë? 
LIST_1
 : 
LIST_0
;

626 
ãmpmv_sˇÀ
[2];

627 
ïzs_sˇÀ
[2][6][
MAX_LIST_SIZE
];

628 
úef
;

629 
övmv_¥ecisi⁄
 = 8;

633 
j
 = 
LIST_0
; j < 2 + (
cuºSli˚
->
mb_aff_‰ame_Êag
 << 2); ++j)

635 
k
 = 0; k < 
cuºSli˚
->
li°Xsize
[
j
]; ++k)

637 
i
 = 0; i < 
cuºSli˚
->
li°Xsize
[
j
]; ++i)

639 i‡((
j
 >> 1) == 0)

641 
iTRb
 = 
	`iClù3
 (-128, 127, 
p_Pic
->
poc
 - 
li°X
[
j
][
i
]->poc);

642 
iTRp
 = 
	`iClù3
 (-128, 127, 
p_Pic
->
poc
 - 
li°X
[
j
][
k
]->poc);

644 i‡((
j
 >> 1) == 1)

646 
iTRb
 = 
	`iClù3
 (-128, 127, 
p_Pic
->
t›_poc
 - 
li°X
[
j
][
i
]->
poc
);

647 
iTRp
 = 
	`iClù3
 (-128, 127, 
p_Pic
->
t›_poc
 - 
li°X
[
j
][
k
]->
poc
);

651 
iTRb
 = 
	`iClù3
 (-128, 127, 
p_Pic
->
bŸtom_poc
 - 
li°X
[
j
][
i
]->
poc
);

652 
iTRp
 = 
	`iClù3
 (-128, 127, 
p_Pic
->
bŸtom_poc
 - 
li°X
[
j
][
k
]->
poc
);

655 i‡(
iTRp
 != 0)

657 
¥esˇÀ
 = (16384 + 
	`übs
 (
iTRp
 / 2)) / iTRp;

658 
p_EPZS
->
mv_sˇÀ
[
j
][
i
][
k
] = 
	`iClù3
 (-2048, 2047, 
	`rshi·_∫d_sf
 ((
iTRb
 * 
¥esˇÀ
), 6));

661 
p_EPZS
->
mv_sˇÀ
[
j
][
i
][
k
] = 256;

666 #i‡(
MVC_EXTENSION_ENABLE
)

667 i‡(
p_I≈
->
EPZSTemp‹Æ
[
cuºSli˚
->
võw_id
])

669 i‡(
p_I≈
->
EPZSTemp‹Æ
)

672 
MŸi⁄Ve˘‹
 **
MŸi⁄Ve˘‹0
 = 
p
->
‰ame
[
LIST_0
];

673 
MŸi⁄Ve˘‹
 **
MŸi⁄Ve˘‹1
 = 
p
->
‰ame
[
LIST_1
];

675 
fs_t›
 = 
fs_bŸtom
 = 
fs
 = 
li°X
[
li°
][0];

676 i‡(
cuºSli˚
->
li°Xsize
[
li°
] > 1)

677 
fs_t›1
 = 
fs_bŸtom1
 = 
fs1
 = 
li°X
[
li°
][1];

679 
fs_t›1
 = 
fs_bŸtom1
 = 
fs1
 = 
li°X
[
li°
][0];

680 
j
 = 0; j < 6; ++j)

682 
i
 = 0; i < 6; ++i)

684 
ïzs_sˇÀ
[0][
j
][
i
] = 256;

685 
ïzs_sˇÀ
[1][
j
][
i
] = 256;

689 
j
 = 0; j < 2 + (
cuºSli˚
->
mb_aff_‰ame_Êag
 << 2); j += 2)

691 
i
 = 0; i < 
cuºSli˚
->
li°Xsize
[
j
]; ++i)

693 i‡(
j
 == 0)

694 
iTRb
 = 
	`iClù3
 (-128, 127, 
p_Pic
->
poc
 - 
li°X
[
LIST_0
 + 
j
][
i
]->poc);

695 i‡(
j
 == 2)

696 
iTRb
 = 
	`iClù3
 (-128, 127, 
p_Pic
->
t›_poc
 - 
li°X
[
LIST_0
 + 
j
][
i
]->
poc
);

698 
iTRb
 = 
	`iClù3
 (-128, 127, 
p_Pic
->
bŸtom_poc
 - 
li°X
[
LIST_0
 + 
j
][
i
]->
poc
);

699 
iTRp
 = 
	`iClù3
 (-128, 127, 
li°X
[
li°
 + 
j
][0]->
poc
 -Üi°X[
LIST_0
 + j][
i
]->poc);

701 i‡(
iTRp
 != 0)

703 
¥esˇÀ
 = (16384 + 
	`übs
 (
iTRp
 / 2)) / iTRp;

704 
¥esˇÀ
 = 
	`iClù3
 (-2048, 2047, 
	`rshi·_∫d_sf
 ((
iTRb
 *Örescale), 6));

709 
¥esˇÀ
 = 256;

711 
ïzs_sˇÀ
[0][
j
][
i
] = 
	`rshi·_∫d_sf
 ((
p_EPZS
->
mv_sˇÀ
[j][0][i] * 
¥esˇÀ
), 8);

712 
ïzs_sˇÀ
[0][
j
 + 1][
i
] = 
¥esˇÀ
 - 256;

714 i‡(
cuºSli˚
->
li°Xsize
[
li°
 + 
j
] > 1)

716 
iTRp
 = 
	`iClù3
 (-128, 127, 
li°X
[
li°
 + 
j
][1]->
poc
 -Üi°X[
LIST_0
 + j][
i
]->poc);

717 i‡(
iTRp
 != 0)

719 
¥esˇÀ
 = (16384 + 
	`übs
 (
iTRp
 / 2)) / iTRp;

720 
¥esˇÀ
 = 
	`iClù3
 (-2048, 2047, 
	`rshi·_∫d_sf
 ((
iTRb
 *Örescale), 6));

724 
¥esˇÀ
 = 256;

726 
ïzs_sˇÀ
[1][
j
][
i
] = 
	`rshi·_∫d_sf
 ((
p_EPZS
->
mv_sˇÀ
[j][1][i] * 
¥esˇÀ
), 8);

727 
ïzs_sˇÀ
[1][
j
 + 1][
i
] = 
¥esˇÀ
 - 256;

731 
ïzs_sˇÀ
[1][
j
][
i
] =Épzs_scale[0][j][i];

732 
ïzs_sˇÀ
[1][
j
 + 1][
i
] =Épzs_scale[0][j + 1][i];

737 i‡(
cuºSli˚
->
mb_aff_‰ame_Êag
)

739 
fs_t›
 = 
li°X
[
li°
 + 2][0];

740 
fs_bŸtom
 = 
li°X
[
li°
 + 4][0];

742 i‡(
cuºSli˚
->
li°Xsize
[0] > 1)

744 
fs_t›1
 = 
li°X
[
li°
 + 2][1];

745 
fs_bŸtom1
 = 
li°X
[
li°
 + 4][1];

750 i‡(
cuºSli˚
->
°ru˘uª
 !
FRAME
)

752 i‡((
cuºSli˚
->
°ru˘uª
 !
fs
->°ru˘uªË&& (fs->
coded_‰ame
))

754 i‡(
cuºSli˚
->
°ru˘uª
 =
TOP_FIELD
)

756 
fs_t›
 = 
fs_bŸtom
 = 
fs
 = 
li°X
[
li°
][0]->
t›_fõld
;

757 
fs_t›1
 = 
fs_bŸtom1
 = 
fs1
 = 
li°X
[
li°
][0]->
bŸtom_fõld
;

761 
fs_t›
 = 
fs_bŸtom
 = 
fs
 = 
li°X
[
li°
][0]->
bŸtom_fõld
;

762 
fs_t›1
 = 
fs_bŸtom1
 = 
fs1
 = 
li°X
[
li°
][0]->
t›_fõld
;

768 i‡(!
cuºSli˚
->
a˘ive_•s
->
‰ame_mbs_⁄ly_Êag
)

770 i‡(
cuºSli˚
->
mb_aff_‰ame_Êag
)

772 
j
 = 0; j < 
fs
->
size_y
 >> 2; ++j)

774 
jj
 = 
j
 >> 1;

775 
jdiv
 = 
jj
 + 4 * (
j
 >> 3);

776 
i
 = 0; i < 
fs
->
size_x
 >> 2; ++i)

778 i‡(
fs
->
mv_öfo
[
j
][
i
].
fõld_‰ame
)

783 i‡(
	`übs
 (
p_Pic
->
poc
 - 
fs_bŸtom
->pocË> iab†’_Pic->po¯- 
fs_t›
->poc))

785 
ãmpmv_sˇÀ
[
LIST_0
] = 256;

786 
ãmpmv_sˇÀ
[
LIST_1
] = 0;

788 i‡(
fs
->
mv_öfo
[
jdiv
][
i
].
ªf_pic
[
LIST_0
] =
NULL
 && 
cuºSli˚
->
li°Xsize
[LIST_0] > 1)

790 
fsx
 = 
fs_t›1
;

791 
loff£t
 = 1;

795 
fsx
 = 
fs_t›
;

796 
loff£t
 = 0;

799 i‡(
fs
->
mv_öfo
[
jdiv
][
i
] .
ªf_pic
[
LIST_0
] !
NULL
)

801 
úef
 = 0; iª‡< 
	`imö
 (
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
], cuºSli˚->
li°Xsize
[LIST_0]); ++iref)

803 i‡(
cuºSli˚
->
li°X
[
LIST_0
][
úef
] =
fs
->
mv_öfo
[
jdiv
][
i
].
ªf_pic
[LIST_0])

805 
ãmpmv_sˇÀ
[
LIST_0
] = 
ïzs_sˇÀ
[
loff£t
][LIST_0][
úef
];

806 
ãmpmv_sˇÀ
[
LIST_1
] = 
ïzs_sˇÀ
[
loff£t
][LIST_1][
úef
];

811 
	`compuã_sˇÀd
 (&
MŸi⁄Ve˘‹0
[
j
][
i
], &
MŸi⁄Ve˘‹1
[j][i], 
ãmpmv_sˇÀ
, &
fsx
->
mv_öfo
[
jj
][i].
mv
[
LIST_0
], 
övmv_¥ecisi⁄
);

815 
MŸi⁄Ve˘‹0
[
j
][
i
] = 
zîo_mv
;

816 
MŸi⁄Ve˘‹1
[
j
][
i
] = 
zîo_mv
;

821 
ãmpmv_sˇÀ
[
LIST_0
] = 256;

822 
ãmpmv_sˇÀ
[
LIST_1
] = 0;

823 i‡(
fs
->
mv_öfo
[
jdiv
 + 4][
i
].
ªf_pic
[
LIST_0
] =
NULL
 && 
cuºSli˚
->
li°Xsize
[LIST_0] > 1)

825 
fsx
 = 
fs_bŸtom1
;

826 
loff£t
 = 1;

830 
fsx
 = 
fs_bŸtom
;

831 
loff£t
 = 0;

834 i‡(
fs
->
mv_öfo
[
jdiv
 + 4][
i
].
ªf_pic
[
LIST_0
] !
NULL
)

836 
úef
 = 0; iª‡< 
	`imö
 (
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
], cuºSli˚->
li°Xsize
[LIST_0]); ++iref)

838 i‡(
cuºSli˚
->
li°X
[
LIST_0
][
úef
] =
fs
->
mv_öfo
[
jdiv
 + 4][
i
].
ªf_pic
[LIST_0])

840 
ãmpmv_sˇÀ
[
LIST_0
] = 
ïzs_sˇÀ
[
loff£t
][LIST_0][
úef
];

841 
ãmpmv_sˇÀ
[
LIST_1
] = 
ïzs_sˇÀ
[
loff£t
][LIST_1][
úef
];

846 
	`compuã_sˇÀd
 (&
MŸi⁄Ve˘‹0
[
j
][
i
], &
MŸi⁄Ve˘‹1
[j][i], 
ãmpmv_sˇÀ
, &
fsx
->
mv_öfo
[
jj
][i].
mv
[
LIST_0
], 
övmv_¥ecisi⁄
);

850 
MŸi⁄Ve˘‹0
[
j
][
i
] = 
zîo_mv
;

851 
MŸi⁄Ve˘‹1
[
j
][
i
] = 
zîo_mv
;

857 
ãmpmv_sˇÀ
[
LIST_0
] = 256;

858 
ãmpmv_sˇÀ
[
LIST_1
] = 0;

860 i‡(
fs
->
mv_öfo
[
j
][
i
].
ªf_pic
[
LIST_0
] =
NULL
 && 
cuºSli˚
->
li°Xsize
[LIST_0] > 1)

862 
fsx
 = 
fs1
;

863 
loff£t
 = 1;

867 
fsx
 = 
fs
;

868 
loff£t
 = 0;

871 i‡(
fsx
->
mv_öfo
[
j
][
i
].
ªf_pic
[
LIST_0
] !
NULL
)

873 
úef
 = 0; iª‡< 
	`imö
 (
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
], cuºSli˚->
li°Xsize
[LIST_0]); ++iref)

875 i‡(
cuºSli˚
->
li°X
[
LIST_0
][
úef
] =
fsx
->
mv_öfo
[
j
][
i
].
ªf_pic
[LIST_0])

877 
ãmpmv_sˇÀ
[
LIST_0
] = 
ïzs_sˇÀ
[
loff£t
][LIST_0][
úef
];

878 
ãmpmv_sˇÀ
[
LIST_1
] = 
ïzs_sˇÀ
[
loff£t
][LIST_1][
úef
];

882 
	`compuã_sˇÀd
 (&
MŸi⁄Ve˘‹0
[
j
][
i
], &
MŸi⁄Ve˘‹1
[j][i], 
ãmpmv_sˇÀ
, &
fsx
->
mv_öfo
[j][i].
mv
[
LIST_0
], 
övmv_¥ecisi⁄
);

886 
MŸi⁄Ve˘‹0
[
j
][
i
] = 
zîo_mv
;

887 
MŸi⁄Ve˘‹1
[
j
][
i
] = 
zîo_mv
;

895 
j
 = 0; j < 
fs
->
size_y
 >> 2; ++j)

897 
jj
 = 
j
 >> 1;

898 
jdiv
 = 
jj
 + 4 * (
j
 >> 3);

899 
i
 = 0; i < 
fs
->
size_x
 >> 2; ++i)

901 
ãmpmv_sˇÀ
[
LIST_0
] = 256;

902 
ãmpmv_sˇÀ
[
LIST_1
] = 0;

903 i‡(
fs
->
mv_öfo
[
j
][
i
].
ªf_pic
[
LIST_0
] =
NULL
 && 
cuºSli˚
->
li°Xsize
[LIST_0] > 1)

905 
fsx
 = 
fs1
;

906 
loff£t
 = 1;

910 
fsx
 = 
fs
;

911 
loff£t
 = 0;

914 i‡(
fsx
->
mv_öfo
[
j
][
i
].
ªf_pic
[
LIST_0
] !
NULL
)

916 
úef
 = 0; iª‡< 
	`imö
 (
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
], cuºSli˚->
li°Xsize
[LIST_0]); ++iref)

918 i‡(
cuºSli˚
->
li°X
[
LIST_0
][
úef
] =
fsx
->
mv_öfo
[
j
][
i
].
ªf_pic
[LIST_0])

920 
ãmpmv_sˇÀ
[
LIST_0
] = 
ïzs_sˇÀ
[
loff£t
][LIST_0][
úef
];

921 
ãmpmv_sˇÀ
[
LIST_1
] = 
ïzs_sˇÀ
[
loff£t
][LIST_1][
úef
];

927 
	`compuã_sˇÀd
 (&
MŸi⁄Ve˘‹0
[
j
][
i
], &
MŸi⁄Ve˘‹1
[j][i], 
ãmpmv_sˇÀ
, &
fsx
->
mv_öfo
[j][i].
mv
[
LIST_0
], 
övmv_¥ecisi⁄
);

931 
MŸi⁄Ve˘‹0
[
j
][
i
] = 
zîo_mv
;

932 
MŸi⁄Ve˘‹1
[
j
][
i
] = 
zîo_mv
;

939 i‡(
cuºSli˚
->
°ru˘uª
 || cuºSli˚->
mb_aff_‰ame_Êag
)

941 
j
 = 0; j < 
fs
->
size_y
 >> 3; ++j)

943 
i
 = 0; i < 
fs
->
size_x
 >> 2; ++i)

945 i‡(!
cuºSli˚
->
mb_aff_‰ame_Êag
)

947 
ãmpmv_sˇÀ
[
LIST_0
] = 256;

948 
ãmpmv_sˇÀ
[
LIST_1
] = 0;

949 i‡(
fs
->
mv_öfo
[
j
][
i
].
ªf_pic
[
LIST_0
] =
NULL
 && 
cuºSli˚
->
li°Xsize
[LIST_0] > 1)

951 
fsx
 = 
fs1
;

952 
loff£t
 = 1;

956 
fsx
 = 
fs
;

957 
loff£t
 = 0;

960 i‡(
fsx
->
mv_öfo
[
j
][
i
].
ªf_pic
[
LIST_0
] !
NULL
)

962 
úef
 = 0; iª‡< 
	`imö
 (
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
], cuºSli˚->
li°Xsize
[LIST_0]); ++iref)

964 i‡(
cuºSli˚
->
li°X
[
LIST_0
][
úef
] =
fsx
->
mv_öfo
[
j
][
i
].
ªf_pic
[LIST_0])

966 
ãmpmv_sˇÀ
[
LIST_0
] = 
ïzs_sˇÀ
[
loff£t
][LIST_0][
úef
];

967 
ãmpmv_sˇÀ
[
LIST_1
] = 
ïzs_sˇÀ
[
loff£t
][LIST_1][
úef
];

971 
	`compuã_sˇÀd
 (&
MŸi⁄Ve˘‹0
[
j
][
i
], &
MŸi⁄Ve˘‹1
[j][i], 
ãmpmv_sˇÀ
, &
fsx
->
mv_öfo
[j][i].
mv
[
LIST_0
], 
övmv_¥ecisi⁄
);

975 
MŸi⁄Ve˘‹0
[
j
][
i
] = 
zîo_mv
;

976 
MŸi⁄Ve˘‹1
[
j
][
i
] = 
zîo_mv
;

981 
ãmpmv_sˇÀ
[
LIST_0
] = 256;

982 
ãmpmv_sˇÀ
[
LIST_1
] = 0;

983 i‡(
fs_bŸtom
->
mv_öfo
[
j
][
i
].
ªf_pic
[
LIST_0
] =
NULL
 && 
cuºSli˚
->
li°Xsize
[LIST_0] > 1)

985 
fsx
 = 
fs_bŸtom1
;

986 
loff£t
 = 1;

990 
fsx
 = 
fs_bŸtom
;

991 
loff£t
 = 0;

994 i‡(
fsx
->
mv_öfo
[
j
][
i
].
ªf_pic
[
LIST_0
] !
NULL
)

996 
úef
 = 0; iª‡< 
	`imö
 (2 * 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
], cuºSli˚->
li°Xsize
[LIST_0 + 4]); ++iref)

998 i‡(
cuºSli˚
->
li°X
[
LIST_0
 + 4][
úef
] =
fsx
->
mv_öfo
[
j
][
i
].
ªf_pic
[LIST_0])

1000 
ãmpmv_sˇÀ
[
LIST_0
] = 
ïzs_sˇÀ
[
loff£t
][LIST_0 + 4][
úef
];

1001 
ãmpmv_sˇÀ
[
LIST_1
] = 
ïzs_sˇÀ
[
loff£t
][LIST_1 + 4][
úef
];

1006 
	`compuã_sˇÀd
 (&
p
->
bŸ
[
LIST_0
][
j
][
i
], &p->bŸ[
LIST_1
][j][i], 
ãmpmv_sˇÀ
, &
fsx
->
mv_öfo
[j][i].
mv
[LIST_0], 
övmv_¥ecisi⁄
);

1010 
p
->
bŸ
[
LIST_0
][
j
][
i
] = 
zîo_mv
;

1011 
p
->
bŸ
[
LIST_1
][
j
][
i
] = 
zîo_mv
;

1014 i‡(!
fs
->
mv_öfo
[2 * 
j
][
i
].
fõld_‰ame
)

1016 
p
->
bŸ
[
LIST_0
][
j
][
i
].
mv_y
 = (p->bot[LIST_0][j][i].mv_y + 1) >> 1;

1017 
p
->
bŸ
[
LIST_1
][
j
][
i
].
mv_y
 = (p->bot[LIST_1][j][i].mv_y + 1) >> 1;

1020 
ãmpmv_sˇÀ
[
LIST_0
] = 256;

1021 
ãmpmv_sˇÀ
[
LIST_1
] = 0;

1022 i‡(
fs_t›
->
mv_öfo
[
j
][
i
].
ªf_pic
[
LIST_0
] =
NULL
 && 
cuºSli˚
->
li°Xsize
[LIST_0] > 1)

1024 
fsx
 = 
fs_t›1
;

1025 
loff£t
 = 1;

1029 
fsx
 = 
fs_t›
;

1030 
loff£t
 = 0;

1032 i‡(
fsx
->
mv_öfo
[
j
][
i
].
ªf_pic
[
LIST_0
] !
NULL
)

1034 
úef
 = 0; iª‡< 
	`imö
 (2 * 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
], cuºSli˚->
li°Xsize
[LIST_0 + 2]); ++iref)

1036 i‡(
cuºSli˚
->
li°X
[
LIST_0
 + 2][
úef
] =
fsx
->
mv_öfo
[
j
][
i
].
ªf_pic
[LIST_0])

1038 
ãmpmv_sˇÀ
[
LIST_0
] = 
ïzs_sˇÀ
[
loff£t
][LIST_0 + 2][
úef
];

1039 
ãmpmv_sˇÀ
[
LIST_1
] = 
ïzs_sˇÀ
[
loff£t
][LIST_1 + 2][
úef
];

1044 
	`compuã_sˇÀd
 (&
p
->
t›
[
LIST_0
][
j
][
i
], &p->t›[
LIST_1
][j][i], 
ãmpmv_sˇÀ
, &
fsx
->
mv_öfo
[j][i].
mv
[LIST_0], 
övmv_¥ecisi⁄
);

1048 
p
->
t›
[
LIST_0
][
j
][
i
] = 
zîo_mv
;

1049 
p
->
t›
[
LIST_1
][
j
][
i
] = 
zîo_mv
;

1052 i‡(!
fs
->
mv_öfo
[2 * 
j
][
i
].
fõld_‰ame
)

1054 
p
->
t›
[
LIST_0
][
j
][
i
].
mv_y
 = (p->top[LIST_0][j][i].mv_y + 1) >> 1;

1055 
p
->
t›
[
LIST_1
][
j
][
i
].
mv_y
 = (p->top[LIST_1][j][i].mv_y + 1) >> 1;

1064 i‡(!
cuºSli˚
->
°ru˘uª
)

1066 
j
 = 0; j < 
fs
->
size_y
 >> 2; ++j)

1068 
jj
 = 
j
 >> 1;

1069 
jdiv
 = (
j
 >> 1) + ((j >> 3) << 2);

1070 
i
 = 0; i < 
fs
->
size_x
 >> 2; ++i)

1072 i‡(
fs
->
mv_öfo
[
j
][
i
].
fõld_‰ame
)

1074 
ãmpmv_sˇÀ
[
LIST_0
] = 256;

1075 
ãmpmv_sˇÀ
[
LIST_1
] = 0;

1076 i‡(
fs
->
mv_öfo
[
jdiv
][
i
].
ªf_pic
[
LIST_0
] =
NULL
 && 
cuºSli˚
->
li°Xsize
[LIST_0] > 1)

1078 
fsx
 = 
fs1
;

1079 
loff£t
 = 1;

1083 
fsx
 = 
fs
;

1084 
loff£t
 = 0;

1087 i‡(
fsx
->
mv_öfo
[
jdiv
][
i
].
ªf_pic
[
LIST_0
] !
NULL
)

1089 
úef
 = 0; iª‡< 
	`imö
 (
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
], cuºSli˚->
li°Xsize
[LIST_0]); ++iref)

1091 i‡(
cuºSli˚
->
li°X
[
LIST_0
][
úef
] =
fsx
->
mv_öfo
[
jdiv
][
i
].
ªf_pic
[LIST_0])

1093 
ãmpmv_sˇÀ
[
LIST_0
] = 
ïzs_sˇÀ
[
loff£t
][LIST_0][
úef
];

1094 
ãmpmv_sˇÀ
[
LIST_1
] = 
ïzs_sˇÀ
[
loff£t
][LIST_1][
úef
];

1098 i‡(
	`übs
 (
p_Pic
->
poc
 - 
fsx
->
bŸtom_fõld
->pocË> iab†’_Pic->po¯- fsx->
t›_fõld
->poc))

1100 
	`compuã_sˇÀd
 (&
MŸi⁄Ve˘‹0
[
j
][
i
], &
MŸi⁄Ve˘‹1
[j][i], 
ãmpmv_sˇÀ
,

1101 &
fsx
->
t›_fõld
->
mv_öfo
[
jj
][
i
].
mv
[
LIST_0
], 
övmv_¥ecisi⁄
);

1105 
	`compuã_sˇÀd
 (&
MŸi⁄Ve˘‹0
[
j
][
i
], &
MŸi⁄Ve˘‹1
[j][i], 
ãmpmv_sˇÀ
,

1106 &
fsx
->
bŸtom_fõld
->
mv_öfo
[
jj
][
i
].
mv
[
LIST_0
], 
övmv_¥ecisi⁄
);

1111 
MŸi⁄Ve˘‹0
[
j
][
i
] = 
zîo_mv
;

1112 
MŸi⁄Ve˘‹1
[
j
][
i
] = 
zîo_mv
;

1121 
j
 = 0; j < 
fs
->
size_y
 >> 2; ++j)

1123 
i
 = 0; i < 
fs
->
size_x
 >> 2; ++i)

1125 
ãmpmv_sˇÀ
[
LIST_0
] = 256;

1126 
ãmpmv_sˇÀ
[
LIST_1
] = 0;

1127 i‡(
fs
->
mv_öfo
[
j
][
i
].
ªf_pic
[
LIST_0
] =
NULL
 && 
cuºSli˚
->
li°Xsize
[LIST_0] > 1)

1129 
fsx
 = 
fs1
;

1130 
loff£t
 = 1;

1134 
fsx
 = 
fs
;

1135 
loff£t
 = 0;

1138 i‡(
fsx
->
mv_öfo
[
j
][
i
].
ªf_pic
[
LIST_0
] !
NULL
 && (!
p_Vid
->
võw_id
 || ((fsx->
ªf_pic_«
[0]<0 || fsx->mv_öfo[j][i].
ªf_idx
[LIST_0] != fsx->ref_pic_na[0]))))

1140 
úef
 = 0; iª‡< 
	`imö
 (
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
], cuºSli˚->
li°Xsize
[LIST_0]); ++iref)

1142 i‡(
cuºSli˚
->
li°X
[
LIST_0
][
úef
] =
fsx
->
mv_öfo
[
j
][
i
].
ªf_pic
[LIST_0])

1144 
ãmpmv_sˇÀ
[
LIST_0
] = 
ïzs_sˇÀ
[
loff£t
][LIST_0][
úef
];

1145 
ãmpmv_sˇÀ
[
LIST_1
] = 
ïzs_sˇÀ
[
loff£t
][LIST_1][
úef
];

1149 
	`compuã_sˇÀd
 (&
MŸi⁄Ve˘‹0
[
j
][
i
], &
MŸi⁄Ve˘‹1
[j][i], 
ãmpmv_sˇÀ
, &
fsx
->
mv_öfo
[j][i].
mv
[
LIST_0
], 
övmv_¥ecisi⁄
);

1153 
MŸi⁄Ve˘‹0
[
j
][
i
] = 
zîo_mv
;

1154 
MŸi⁄Ve˘‹1
[
j
][
i
] = 
zîo_mv
;

1160 i‡(!
cuºSli˚
->
a˘ive_•s
->
‰ame_mbs_⁄ly_Êag
)

1162 
j
 = 0; j < 
fs
->
size_y
 >> 2; ++j)

1164 
i
 = 0; i < 
fs
->
size_x
 >> 2; ++i)

1166 i‡((!
cuºSli˚
->
mb_aff_‰ame_Êag
 && !cuºSli˚->
°ru˘uª
 && 
fs
->
mv_öfo
[
j
][
i
].
fõld_‰ame
)

1167 || (
cuºSli˚
->
mb_aff_‰ame_Êag
 && 
fs
->
mv_öfo
[
j
][
i
].
fõld_‰ame
))

1169 
MŸi⁄Ve˘‹0
[
j
][
i
].
mv_y
 *= 2;

1170 
MŸi⁄Ve˘‹1
[
j
][
i
].
mv_y
 *= 2;

1172 i‡(
cuºSli˚
->
°ru˘uª
 && !
fs
->
mv_öfo
[
j
][
i
].
fõld_‰ame
)

1174 
MŸi⁄Ve˘‹0
[
j
][
i
].
mv_y
 = (Ë
	`rshi·_∫d_sf
 (MotionVector0[j][i].mv_y, 1);

1175 
MŸi⁄Ve˘‹1
[
j
][
i
].
mv_y
 = (Ë
	`rshi·_∫d_sf
 (MotionVector1[j][i].mv_y, 1);

1182 
	}
}

1186 
	$is_block_avaûabÀ
 (
Ma¸oblock
 * 
cuºMB
, 
St‹abÀPi˘uª
 * 
ªf_pi˘uª
, 
MEBlock
 * 
mv_block
, 
block_avaûabÀ
[4])

1188 i‡((
mv_block
->
block_y
 << 2) > 0)

1190 i‡((
mv_block
->
block_x
 << 2) < 8)

1192 i‡((
mv_block
->
block_y
 << 2) == 8)

1194 
block_avaûabÀ
[0] = (
mv_block
->
blocksize_x
 !
MB_BLOCK_SIZE
Ë|| (
cuºMB
->
mb_x
 < (
ªf_pi˘uª
->
size_x
 >> 4) - 1);

1198 
block_avaûabÀ
[0] = ((
mv_block
->
block_x
 << 2Ë+ mv_block->
blocksize_x
 != 8)

1199 || (
cuºMB
->
mb_x
 < (
ªf_pi˘uª
->
size_x
 >> 4) - 1);

1204 
block_avaûabÀ
[0] = ((
mv_block
->
block_x
 << 2Ë+ mv_block->
blocksize_x
 !
MB_BLOCK_SIZE
Ë|| (
cuºMB
->
mb_x
 < (
ªf_pi˘uª
->
size_x
 >> 4) - 1);

1209 
block_avaûabÀ
[0] = ((
mv_block
->
block_x
 << 2Ë+ mv_block->
blocksize_x
 !
MB_BLOCK_SIZE
Ë|| (
cuºMB
->
mb_x
 < (
ªf_pi˘uª
->
size_x
 >> 4) - 1);

1212 
block_avaûabÀ
[1] = ((
mv_block
->
block_y
 << 2Ë+ mv_block->
blocksize_y
 !
MB_BLOCK_SIZE
Ë|| ((
cuºMB
->
mb_y
 < (
ªf_pi˘uª
->
size_y
 >> 4) - 1));

1213 
block_avaûabÀ
[2] = 
mv_block
->
block
[0].
avaûabÀ
;

1214 
block_avaûabÀ
[3] = 
mv_block
->
block
[1].
avaûabÀ
;

1215 
	}
}

1224 
	$EPZSBlockTy≥Pªdi˘‹sMB
 (
Sli˚
 * 
cuºSli˚
, 
MEBlock
 * 
mv_block
, 
SPoöt
 * 
poöt
, *
¥ednum
)

1226 
blockty≥
 = 
mv_block
->blocktype;

1227 
block_x
 = 
mv_block
->block_x;

1228 
block_y
 = 
mv_block
->block_y;

1229 
li°
 = 
mv_block
->list;

1230 
ªf
 = 
mv_block
->
ªf_idx
;

1231 
EPZSP¨amëîs
 *
p_EPZS
 = 
cuºSli˚
->p_EPZS;

1232 
MŸi⁄Ve˘‹
 ****
Æl_mv
 = 
cuºSli˚
->Æl_mv[
li°
];

1233 
MŸi⁄Ve˘‹
 *
cur_mv
 = &
poöt
[*
¥ednum
].
mŸi⁄
;

1235 i‡(
blockty≥
 != 1)

1237 *
cur_mv
 = 
Æl_mv
[
ªf
][
BLOCK_PARENT
[
blockty≥
]][
block_y
][
block_x
];

1240 *
¥ednum
 +(*((*Ë
cur_mv
) != 0);

1242 if(
BLOCK_PARENT
[
blockty≥
] !=1)

1244 
cur_mv
 = &
poöt
[*
¥ednum
].
mŸi⁄
;

1245 *
cur_mv
 = 
Æl_mv
[
ªf
][1][
block_y
][
block_x
];

1247 *
¥ednum
 +(*((*Ë
cur_mv
) != 0);

1251 i‡(
ªf
 > 0)

1253 
cur_mv
 = &
poöt
[*
¥ednum
].
mŸi⁄
;

1254 
	`sˇÀ_mv
 (
cur_mv
, 
p_EPZS
->
mv_sˇÀ
[
li°
][
ªf
][ª‡- 1], &
Æl_mv
[ª‡- 1][
blockty≥
][
block_y
][
block_x
], 8);

1256 *
¥ednum
 +(*((*Ë
cur_mv
) != 0);

1258 i‡(
ªf
 > 1)

1260 
cur_mv
 = &
poöt
[*
¥ednum
].
mŸi⁄
;

1261 
	`sˇÀ_mv
 (
cur_mv
, 
p_EPZS
->
mv_sˇÀ
[
li°
][
ªf
][0], &
Æl_mv
[0][
blockty≥
][
block_y
][
block_x
], 8);

1263 *
¥ednum
 +(*((*Ë
cur_mv
) != 0);

1266 
	}
}

1276 
	$EPZS_•©ül_¥edi˘‹s
 (
EPZSP¨amëîs
 * 
p_EPZS
, 
MEBlock
 *
mv_block
, 
li°
, 
li°_off£t
, 
ªf
, 
pic_mŸi⁄_∑øms
 **
mv_öfo
)

1278 
PixñPos
 * 
block
 = 
mv_block
->block;

1279 
ªfA
 = 0, 
ªfB
 = 0, 
ªfC
 = 0, 
ªfD
 = 0;

1280 
VideoP¨amëîs
 *
p_Vid
 = 
p_EPZS
->p_Vid;

1281 *
mŸ_sˇÀ
 = 
p_EPZS
->
mv_sˇÀ
[
li°
 + 
li°_off£t
][
ªf
];

1282 
SPoöt
 *
poöt
 = 
p_EPZS
->
¥edi˘‹
->point;

1285 (
poöt
++)->
mŸi⁄
 = 
zîo_mv
;

1288 i‡(!
p_Vid
->
mb_aff_‰ame_Êag
)

1290 
ªfA
 = 
block
[0].
avaûabÀ
 ? (Ë
mv_öfo
[block[0].
pos_y
][block[0].
pos_x
].
ªf_idx
[
li°
] : -1;

1291 
ªfB
 = 
block
[1].
avaûabÀ
 ? (Ë
mv_öfo
[block[1].
pos_y
][block[1].
pos_x
].
ªf_idx
[
li°
] : -1;

1292 
ªfC
 = 
block
[2].
avaûabÀ
 ? (Ë
mv_öfo
[block[2].
pos_y
][block[2].
pos_x
].
ªf_idx
[
li°
] : -1;

1293 
ªfD
 = 
block
[3].
avaûabÀ
 ? (Ë
mv_öfo
[block[3].
pos_y
][block[3].
pos_x
].
ªf_idx
[
li°
] : -1;

1296 i‡(
block
[0].
avaûabÀ
)

1298 
	`sˇÀ_mv
 (&
poöt
->
mŸi⁄
, 
mŸ_sˇÀ
[
ªfA
], &
mv_öfo
[
block
[0].
pos_y
][block[0].
pos_x
].
mv
[
li°
], 8);

1306 ++
poöt
;

1310 (
poöt
)->
mŸi⁄
.
mv_x
 = 12;

1311 (
poöt
++)->
mŸi⁄
.
mv_y
 = 0;

1314 i‡(
block
[1].
avaûabÀ
)

1316 
	`sˇÀ_mv
 (&
poöt
->
mŸi⁄
, 
mŸ_sˇÀ
[
ªfB
], &
mv_öfo
[
block
[1].
pos_y
][block[1].
pos_x
].
mv
[
li°
], 8);

1324 ++
poöt
;

1328 (
poöt
)->
mŸi⁄
.
mv_x
 = 0;

1329 (
poöt
++)->
mŸi⁄
.
mv_y
 = 12;

1333 i‡(
block
[2].
avaûabÀ
)

1335 
	`sˇÀ_mv
 (&
poöt
->
mŸi⁄
, 
mŸ_sˇÀ
[
ªfC
], &
mv_öfo
[
block
[2].
pos_y
][block[2].
pos_x
].
mv
[
li°
], 8);

1343 ++
poöt
;

1347 (
poöt
)->
mŸi⁄
.
mv_x
 = -12;

1348 (
poöt
++)->
mŸi⁄
.
mv_y
 = 0;

1352 i‡(
block
[3].
avaûabÀ
)

1354 
	`sˇÀ_mv
 (&
poöt
->
mŸi⁄
, 
mŸ_sˇÀ
[
ªfD
], &
mv_öfo
[
block
[3].
pos_y
][block[3].
pos_x
].
mv
[
li°
], 8);

1362 ++
poöt
;

1366 (
poöt
)->
mŸi⁄
.
mv_x
 = 0;

1367 (
poöt
++)->
mŸi⁄
.
mv_y
 = -12;

1373 i‡(
li°_off£t
)

1375 
ªfA
 = 
block
[0].
avaûabÀ
 ? 
p_Vid
->
mb_d©a
[block[0].
mb_addr
].
mb_fõld
 ? (Ë
mv_öfo
[block[0].
pos_y
][block[0].
pos_x
].
ªf_idx
[
li°
]

1376 : (Ë
mv_öfo
[
block
[0].
pos_y
][block[0].
pos_x
].
ªf_idx
[
li°
] * 2 : -1;

1377 
ªfB
 = 
block
[1].
avaûabÀ
 ? 
p_Vid
->
mb_d©a
[block[1].
mb_addr
].
mb_fõld
 ? (Ë
mv_öfo
[block[1].
pos_y
][block[1].
pos_x
].
ªf_idx
[
li°
]

1378 : (Ë
mv_öfo
[
block
[1].
pos_y
][block[1].
pos_x
].
ªf_idx
[
li°
] * 2 : -1;

1379 
ªfC
 = 
block
[2].
avaûabÀ
 ? 
p_Vid
->
mb_d©a
[block[2].
mb_addr
].
mb_fõld
 ? (Ë
mv_öfo
[block[2].
pos_y
][block[2].
pos_x
].
ªf_idx
[
li°
]

1380 : (Ë
mv_öfo
[
block
[2].
pos_y
][block[2].
pos_x
].
ªf_idx
[
li°
] * 2 : -1;

1381 
ªfD
 = 
block
[3].
avaûabÀ
 ? 
p_Vid
->
mb_d©a
[block[3].
mb_addr
].
mb_fõld
 ? (Ë
mv_öfo
[block[3].
pos_y
][block[3].
pos_x
].
ªf_idx
[
li°
]

1382 : (Ë
mv_öfo
[
block
[3].
pos_y
][block[3].
pos_x
].
ªf_idx
[
li°
] * 2 : -1;

1385 i‡(
block
[0].
avaûabÀ
)

1387 
	`sˇÀ_mv
 (&
poöt
->
mŸi⁄
, 
mŸ_sˇÀ
[
ªfA
], &
mv_öfo
[
block
[0].
pos_y
][block[0].
pos_x
].
mv
[
li°
], 8);

1388 i‡(!
p_Vid
->
mb_d©a
[
block
[0].
mb_addr
].
mb_fõld
)

1390 
poöt
->
mŸi⁄
.
mv_y
 <<= 1;

1391 ++
poöt
;

1395 (
poöt
)->
mŸi⁄
.
mv_x
 = 12;

1396 (
poöt
++)->
mŸi⁄
.
mv_y
 = 0;

1400 i‡(
block
[1].
avaûabÀ
)

1402 
	`sˇÀ_mv
 (&
poöt
->
mŸi⁄
, 
mŸ_sˇÀ
[
ªfB
], &
mv_öfo
[
block
[1].
pos_y
][block[1].
pos_x
].
mv
[
li°
], 8);

1403 i‡(!
p_Vid
->
mb_d©a
[
block
[1].
mb_addr
].
mb_fõld
)

1405 
poöt
->
mŸi⁄
.
mv_y
 <<= 1;

1406 ++
poöt
;

1410 (
poöt
)->
mŸi⁄
.
mv_x
 = 0;

1411 (
poöt
++)->
mŸi⁄
.
mv_y
 = 12;

1415 i‡(
block
[2].
avaûabÀ
)

1417 
	`sˇÀ_mv
 (&
poöt
->
mŸi⁄
, 
mŸ_sˇÀ
[
ªfC
], &
mv_öfo
[
block
[2].
pos_y
][block[2].
pos_x
].
mv
[
li°
], 8);

1418 i‡(!
p_Vid
->
mb_d©a
[
block
[2].
mb_addr
].
mb_fõld
)

1420 
poöt
->
mŸi⁄
.
mv_y
 <<= 1;

1421 ++
poöt
;

1425 (
poöt
)->
mŸi⁄
.
mv_x
 = -12;

1426 (
poöt
++)->
mŸi⁄
.
mv_y
 = 0;

1430 i‡(
block
[3].
avaûabÀ
)

1432 
	`sˇÀ_mv
 (&
poöt
->
mŸi⁄
, 
mŸ_sˇÀ
[
ªfD
], &
mv_öfo
[
block
[3].
pos_y
][block[3].
pos_x
].
mv
[
li°
], 8);

1433 i‡(!
p_Vid
->
mb_d©a
[
block
[3].
mb_addr
].
mb_fõld
)

1435 
poöt
->
mŸi⁄
.
mv_y
 <<= 1;

1436 ++
poöt
;

1440 (
poöt
)->
mŸi⁄
.
mv_x
 = 0;

1441 (
poöt
++)->
mŸi⁄
.
mv_y
 = -12;

1446 
ªfA
 = 
block
[0].
avaûabÀ


1447 ? 
p_Vid
->
mb_d©a
[
block
[0].
mb_addr
].
mb_fõld


1448 ? (Ë
mv_öfo
[
block
[0].
pos_y
][block[0].
pos_x
].
ªf_idx
[
li°
] >> 1 : () mv_info[block[0].pos_y][block[0].pos_x].ref_idx[list] : -1;

1449 
ªfB
 = 
block
[1].
avaûabÀ


1450 ? 
p_Vid
->
mb_d©a
[
block
[1].
mb_addr
].
mb_fõld


1451 ? (Ë
mv_öfo
[
block
[1].
pos_y
][block[1].
pos_x
].
ªf_idx
[
li°
] >> 1 : () mv_info[block[1].pos_y][block[1].pos_x].ref_idx[list] : -1;

1452 
ªfC
 = 
block
[2].
avaûabÀ


1453 ? 
p_Vid
->
mb_d©a
[
block
[2].
mb_addr
].
mb_fõld


1454 ? (Ë
mv_öfo
[
block
[2].
pos_y
][block[2].
pos_x
].
ªf_idx
[
li°
] >> 1 : () mv_info[block[2].pos_y][block[2].pos_x].ref_idx[list] : -1;

1455 
ªfD
 = 
block
[3].
avaûabÀ


1456 ? 
p_Vid
->
mb_d©a
[
block
[3].
mb_addr
].
mb_fõld


1457 ? (Ë
mv_öfo
[
block
[3].
pos_y
][block[3].
pos_x
].
ªf_idx
[
li°
] >> 1 : () mv_info[block[3].pos_y][block[3].pos_x].ref_idx[list] : -1;

1460 i‡(
block
[0].
avaûabÀ
)

1462 
	`sˇÀ_mv
 (&
poöt
->
mŸi⁄
, 
mŸ_sˇÀ
[
ªfA
], &
mv_öfo
[
block
[0].
pos_y
][block[0].
pos_x
].
mv
[
li°
], 8);

1463 i‡(
p_Vid
->
mb_d©a
[
block
[0].
mb_addr
].
mb_fõld
)

1464 
poöt
->
mŸi⁄
.
mv_y
 = (Ë
	`rshi·_∫d_sf
 (point->motion.mv_y, 1);

1465 ++
poöt
;

1469 (
poöt
)->
mŸi⁄
.
mv_x
 = 12;

1470 (
poöt
++)->
mŸi⁄
.
mv_y
 = 0;

1474 i‡(
block
[1].
avaûabÀ
)

1476 
	`sˇÀ_mv
 (&
poöt
->
mŸi⁄
, 
mŸ_sˇÀ
[
ªfB
], &
mv_öfo
[
block
[1].
pos_y
][block[1].
pos_x
].
mv
[
li°
], 8);

1477 i‡(
p_Vid
->
mb_d©a
[
block
[1].
mb_addr
].
mb_fõld
)

1478 
poöt
->
mŸi⁄
.
mv_y
 = (Ë
	`rshi·_∫d_sf
 (point->motion.mv_y, 1);

1479 ++
poöt
;

1483 (
poöt
)->
mŸi⁄
.
mv_x
 = 0;

1484 (
poöt
++)->
mŸi⁄
.
mv_y
 = 12;

1488 i‡(
block
[2].
avaûabÀ
)

1490 
	`sˇÀ_mv
 (&
poöt
->
mŸi⁄
, 
mŸ_sˇÀ
[
ªfC
], &
mv_öfo
[
block
[2].
pos_y
][block[2].
pos_x
].
mv
[
li°
], 8);

1491 i‡(
p_Vid
->
mb_d©a
[
block
[2].
mb_addr
].
mb_fõld
)

1492 
poöt
->
mŸi⁄
.
mv_y
 = (Ë
	`rshi·_∫d_sf
 (point->motion.mv_y, 1);

1493 ++
poöt
;

1497 (
poöt
)->
mŸi⁄
.
mv_x
 = -12;

1498 (
poöt
++)->
mŸi⁄
.
mv_y
 = 0;

1502 i‡(
block
[3].
avaûabÀ
)

1504 
	`sˇÀ_mv
 (&
poöt
->
mŸi⁄
, 
mŸ_sˇÀ
[
ªfD
], &
mv_öfo
[
block
[3].
pos_y
][block[3].
pos_x
].
mv
[
li°
], 8);

1505 i‡(
p_Vid
->
mb_d©a
[
block
[3].
mb_addr
].
mb_fõld
)

1506 
poöt
->
mŸi⁄
.
mv_y
 = (Ë
	`rshi·_∫d_sf
 (point->motion.mv_y, 1);

1507 ++
poöt
;

1511 (
poöt
)->
mŸi⁄
.
mv_x
 = 12;

1512 (
poöt
++)->
mŸi⁄
.
mv_y
 = 0;

1517  ((
ªfA
 =-1Ë+ (
ªfB
 =-1Ë+ ((
ªfC
 =-1Ë&& (
ªfD
 == -1)));

1518 
	}
}

1528 
	$EPZS_ãmp‹Æ_¥edi˘‹s
 (
Ma¸oblock
 *
cuºMB
,

1529 
St‹abÀPi˘uª
 *
ªf_pi˘uª
,

1530 
EPZSP¨amëîs
 * 
p_EPZS
,

1531 
MEBlock
 *
mv_block
,

1532 *
¥ednum
,

1533 
di°blk
 
°›Crôîi⁄
,

1534 
di°blk
 
mö_mco°
)

1536 
li°_off£t
 = 
cuºMB
->list_offset;

1537 
blocksh≠e_x
 = (
mv_block
->
blocksize_x
 >> 2);

1538 
blocksh≠e_y
 = (
mv_block
->
blocksize_y
 >> 2);

1539 
o_block_x
 = 
mv_block
->
pos_x2
;

1540 
o_block_y
 = 
mv_block
->
pos_y2
;

1541 
li°
 = 
mv_block
->list;

1542 
ªf
 = 
mv_block
->
ªf_idx
;

1544 
EPZSCﬁocP¨ams
 *
p_Cﬁoc
 = 
p_EPZS
->
p_cﬁoˇãd
;

1545 
SPoöt
 * 
poöt
 = 
p_EPZS
->
¥edi˘‹
->point;

1546 
mvSˇÀ
 = 
p_EPZS
->
mv_sˇÀ
[
li°
 + 
li°_off£t
][
ªf
][0];

1547 
MŸi⁄Ve˘‹
 **
cﬁ_mv
 = (
li°_off£t
 =0Ë? 
p_Cﬁoc
->
‰ame
[
li°
] : (li°_off£à=2Ë?Ö_Cﬁoc->
t›
[li°] :Ö_Cﬁoc->
bŸ
[list];

1548 
MŸi⁄Ve˘‹
 *
cur_mv
 = &
poöt
[*
¥ednum
].
mŸi⁄
;

1550 *
¥ednum
 +
	`add_¥edi˘‹
 (
cur_mv
, 
cﬁ_mv
[
o_block_y
][
o_block_x
], 
mvSˇÀ
, 8);

1551 i‡(
mö_mco°
 > 
°›Crôîi⁄
 && 
ªf
 < 2)

1553 
block_avaûabÀ
[4];

1554 
	`is_block_avaûabÀ
 (
cuºMB
, 
ªf_pi˘uª
, 
mv_block
, 
block_avaûabÀ
);

1556 i‡(
block_avaûabÀ
[2])

1558 *
¥ednum
 +
	`add_¥edi˘‹
 (&
poöt
[*¥ednum].
mŸi⁄
, 
cﬁ_mv
[
o_block_y
][
o_block_x
 - 1], 
mvSˇÀ
, 8);

1560 i‡(
block_avaûabÀ
[3])

1562 *
¥ednum
 +
	`add_¥edi˘‹
 (&
poöt
[*¥ednum].
mŸi⁄
, 
cﬁ_mv
[
o_block_y
 - 1][
o_block_x
 - 1], 
mvSˇÀ
, 8);

1566 i‡(
block_avaûabÀ
[1])

1568 *
¥ednum
 +
	`add_¥edi˘‹
 (&
poöt
[*¥ednum].
mŸi⁄
, 
cﬁ_mv
[
o_block_y
 + 
blocksh≠e_y
][
o_block_x
 - 1], 
mvSˇÀ
, 8);

1573 i‡(
block_avaûabÀ
[3])

1575 *
¥ednum
 +
	`add_¥edi˘‹
 (&
poöt
[*¥ednum].
mŸi⁄
, 
cﬁ_mv
[
o_block_y
 - 1][
o_block_x
], 
mvSˇÀ
, 8);

1579 i‡(
block_avaûabÀ
[0])

1581 *
¥ednum
 +
	`add_¥edi˘‹
 (&
poöt
[*¥ednum].
mŸi⁄
, 
cﬁ_mv
[
o_block_y
][
o_block_x
 + 
blocksh≠e_x
], 
mvSˇÀ
, 8);

1582 i‡(
block_avaûabÀ
[3])

1584 *
¥ednum
 +
	`add_¥edi˘‹
 (&
poöt
[*¥ednum].
mŸi⁄
, 
cﬁ_mv
[
o_block_y
 - 1][
o_block_x
 + 
blocksh≠e_x
], 
mvSˇÀ
, 8);

1587 i‡(
block_avaûabÀ
[1])

1589 *
¥ednum
 +
	`add_¥edi˘‹
 (&
poöt
[*¥ednum].
mŸi⁄
, 
cﬁ_mv
[
o_block_y
 + 
blocksh≠e_y
][
o_block_x
 + 
blocksh≠e_x
], 
mvSˇÀ
, 8);

1593 i‡(
block_avaûabÀ
[1])

1595 *
¥ednum
 +
	`add_¥edi˘‹
 (&
poöt
[*¥ednum].
mŸi⁄
, 
cﬁ_mv
[
o_block_y
 + 
blocksh≠e_y
][
o_block_x
], 
mvSˇÀ
, 8);

1598 
	}
}

1608 
	$EPZSBlockTy≥Pªdi˘‹s
 (
Sli˚
 * 
cuºSli˚
, 
MEBlock
 *
mv_block
, 
SPoöt
 * 
poöt
, *
¥ednum
)

1610 
blockty≥
 = 
mv_block
->blocktype;

1611 
block_x
 = 
mv_block
->block_x;

1612 
block_y
 = 
mv_block
->block_y;

1613 
li°
 = 
mv_block
->list;

1614 
ªf
 = 
mv_block
->
ªf_idx
;

1615 
MŸi⁄Ve˘‹
 ****
Æl_mv
 = 
cuºSli˚
->Æl_mv[
li°
];

1616 
MŸi⁄Ve˘‹
 *
cur_mv
 = &
poöt
[*
¥ednum
].
mŸi⁄
;

1618 *
cur_mv
 = 
Æl_mv
[
ªf
][
BLOCK_PARENT
[
blockty≥
]][
block_y
][
block_x
];

1621 *
¥ednum
 +(*((*Ë
cur_mv
) != 0);

1623 i‡((
ªf
 > 0Ë&& (
cuºSli˚
->
°ru˘uª
 !
FRAME
))

1625 
EPZSP¨amëîs
 *
p_EPZS
 = 
cuºSli˚
->p_EPZS;

1626 
cur_mv
 = &
poöt
[*
¥ednum
].
mŸi⁄
;

1627 
	`sˇÀ_mv
 (
cur_mv
, 
p_EPZS
->
mv_sˇÀ
[
li°
][
ªf
][ª‡- 1], &
Æl_mv
[ª‡- 1][
blockty≥
][
block_y
][
block_x
], 8);

1630 *
¥ednum
 +(*((*Ë
cur_mv
) != 0);

1631 i‡(
ªf
 > 1)

1633 
cur_mv
 = &
poöt
[*
¥ednum
].
mŸi⁄
;

1634 
	`sˇÀ_mv
 (
cur_mv
, 
p_EPZS
->
mv_sˇÀ
[
li°
][
ªf
][0], &
Æl_mv
[0][
blockty≥
][
block_y
][
block_x
], 8);

1636 *
¥ednum
 +(*((*Ë
cur_mv
) != 0);

1640 
cur_mv
 = &
poöt
[*
¥ednum
].
mŸi⁄
;

1641 *
cur_mv
 = 
Æl_mv
[
ªf
][1][
block_y
][
block_x
];

1644 *
¥ednum
 +(*((*Ë
cur_mv
) != 0);

1645 
	}
}

1654 
	$EPZSWödowPªdi˘‹s
 (
MŸi⁄Ve˘‹
 * 
mv
, 
EPZSSåu˘uª
 * 
¥edi˘‹
, *
¥ednum
, EPZSSåu˘uª * 
wödowPªd
)

1656 
pos
;

1657 
SPoöt
 *
wPoöt
 = &
wödowPªd
->
poöt
[0];

1658 
SPoöt
 *
pPoöt
 = &
¥edi˘‹
->
poöt
[(*
¥ednum
)];

1660 
pos
 = 0;Öo†< 
wödowPªd
->
£¨chPoöts
; ++pos)

1662 (
pPoöt
++)->
mŸi⁄
 = 
	`add_MVs
 ((
wPoöt
++)->mŸi⁄, 
mv
);

1664 *
¥ednum
 +
wödowPªd
->
£¨chPoöts
;

1665 
	}
}

1675 
	$EPZS_•©ül_mem‹y_¥edi˘‹s
 (
EPZSP¨amëîs
 * 
p_EPZS
,

1676 
MEBlock
 * 
mv_block
,

1677 
li°
,

1678 *
¥ednum
,

1679 
img_width
)

1682 
SPoöt
 *
poöt
 = 
p_EPZS
->
¥edi˘‹
->point;

1684 
blockty≥
 = 
mv_block
->blocktype - 1;

1686 
by
 = 
mv_block
->
block_y
;

1688 
bs_x
 = (
mv_block
->
blocksize_x
 >> 2);

1689 
bs_y
 = (
mv_block
->
blocksize_y
 >> 2);

1690 
pic_x
 = 
mv_block
->
pos_x2
;

1692 
ªf
 = 
mv_block
->
ªf_idx
;

1694 #i‡
EPZSREF


1695 
MŸi⁄Ve˘‹
 **
¥d_mv
 = 
p_EPZS
->
p_mŸi⁄
[
li°
][
ªf
][
blockty≥
];

1696 
MŸi⁄Ve˘‹
 *
cur_mv
 = &
poöt
[*
¥ednum
].
mŸi⁄
;

1699 i‡(
pic_x
 > 0)

1701 *
cur_mv
 = 
¥d_mv
[
by
][
pic_x
 - 
bs_x
];

1702 *
¥ednum
 +(*((*Ë
cur_mv
) != 0);

1703 
cur_mv
 = &
poöt
[*
¥ednum
].
mŸi⁄
;

1706 
by
 = (by > 0Ë? by - 
bs_y
 : 4 - bs_y;

1709 *
cur_mv
 = 
¥d_mv
[
by
][
pic_x
];

1710 *
¥ednum
 +(*((*Ë
cur_mv
) != 0);

1713 i‡(
pic_x
 + 
bs_x
 < 
img_width
)

1715 
cur_mv
 = &
poöt
[*
¥ednum
].
mŸi⁄
;

1716 *
cur_mv
 = 
¥d_mv
[
by
][
pic_x
 + 
bs_x
];

1717 *
¥ednum
 +(*((*Ë
cur_mv
) != 0);

1720 
mŸ_sˇÀ
 = 
p_EPZS
->
mv_sˇÀ
[
li°
][
ªf
][0];

1722 
MŸi⁄Ve˘‹
 **
¥d_mv
 = 
p_EPZS
->
p_mŸi⁄
[
li°
][
blockty≥
];

1725 
poöt
[*
¥ednum
].
mŸi⁄
.
mv_x
 = (
pic_x
 > 0)

1726 ? (Ë
	`rshi·_∫d_sf
 ((
mŸ_sˇÀ
 * 
¥d_mv
[
by
][
pic_x
 - 
bs_x
].
mv_x
), 8)

1728 
poöt
[*
¥ednum
].
mŸi⁄
.
mv_y
 = (
pic_x
 > 0)

1729 ? (Ë
	`rshi·_∫d_sf
 ((
mŸ_sˇÀ
 * 
¥d_mv
[
by
][
pic_x
 - 
bs_x
].
mv_y
), 8)

1731 *
¥ednum
 +((
poöt
[*¥ednum].
mŸi⁄
.
mv_x
 !0Ë|| (poöt[*¥ednum].mŸi⁄.
mv_y
 != 0));

1734 
poöt
[*
¥ednum
].
mŸi⁄
.
mv_x
 = (
by
 > 0)

1735 ? (Ë
	`rshi·_∫d_sf
 ((
mŸ_sˇÀ
 * 
¥d_mv
[
by
 - 
bs_y
][
pic_x
].
mv_x
), 8)

1736 : (Ë
	`rshi·_∫d_sf
 ((
mŸ_sˇÀ
 * 
¥d_mv
[4 - 
bs_y
][
pic_x
].
mv_x
), 8);

1737 
poöt
[*
¥ednum
].
mŸi⁄
.
mv_y
 = (
by
 > 0)

1738 ? (Ë
	`rshi·_∫d_sf
 ((
mŸ_sˇÀ
 * 
¥d_mv
[
by
 - 
bs_y
][
pic_x
].
mv_y
), 8)

1739 : (Ë
	`rshi·_∫d_sf
 ((
mŸ_sˇÀ
 * 
¥d_mv
[4 - 
bs_y
][
pic_x
].
mv_y
), 8);

1740 *
¥ednum
 +((
poöt
[*¥ednum].
mŸi⁄
.
mv_x
 !0Ë|| (poöt[*¥ednum].mŸi⁄.
mv_y
 != 0));

1743 
poöt
[*
¥ednum
].
mŸi⁄
.
mv_x
 = (
pic_x
 + 
bs_x
 < 
img_width
)

1744 ? (
by
 > 0)

1745 ? (Ë
	`rshi·_∫d_sf
 ((
mŸ_sˇÀ
 * 
¥d_mv
[
by
 - 
bs_y
][
pic_x
 + 
bs_x
].
mv_x
), 8)

1746 : (Ë
	`rshi·_∫d_sf
 ((
mŸ_sˇÀ
 * 
¥d_mv
[4 - 
bs_y
][
pic_x
 + 
bs_x
].
mv_x
), 8)

1748 
poöt
[*
¥ednum
].
mŸi⁄
.
mv_y
 = (
pic_x
 + 
bs_x
 < 
img_width
)

1749 ? (
by
 > 0)

1750 ? (Ë
	`rshi·_∫d_sf
 ((
mŸ_sˇÀ
 * 
¥d_mv
[
by
 - 
bs_y
][
pic_x
 + 
bs_x
].
mv_y
), 8)

1751 : (Ë
	`rshi·_∫d_sf
 ((
mŸ_sˇÀ
 * 
¥d_mv
[4 - 
bs_y
][
pic_x
 + 
bs_x
].
mv_y
), 8)

1753 *
¥ednum
 +((
poöt
[*¥ednum].
mŸi⁄
.
mv_x
 !0Ë|| (poöt[*¥ednum].mŸi⁄.
mv_y
 != 0));

1755 
	}
}

1763 
di°blk


1764 
	$EPZSDëîmöeSt›Crôîi⁄
 (
EPZSP¨amëîs
 * 
p_EPZS
, 
di°blk
 *
¥evSad
, 
MEBlock
 * 
mv_block
, di°blk 
œmbda_di°
)

1766 
blockty≥
 = 
mv_block
->blocktype;

1767 
blocksh≠e_x
 = (
mv_block
->
blocksize_x
 >> 2);

1768 
PixñPos
 *
block
 = 
mv_block
->block;

1769 
di°blk
 
ßdA
, 
ßdB
, 
ßdC
, 
°›Crôîi⁄
;

1770 
ßdA
 = 
block
[0].
avaûabÀ
 ? 
¥evSad
[-
blocksh≠e_x
] : 
DISTBLK_MAX
;

1771 
ßdB
 = 
block
[1].
avaûabÀ
 ? 
¥evSad
[0] : 
DISTBLK_MAX
;

1772 
ßdC
 = 
block
[2].
avaûabÀ
 ? 
¥evSad
[
blocksh≠e_x
] : 
DISTBLK_MAX
;

1774 
°›Crôîi⁄
 = 
	`di°blkmö
 (
ßdA
, di°blkmö (
ßdB
, 
ßdC
));

1775 
°›Crôîi⁄
 = 
	`di°blkmax
 (°›Crôîi⁄, 
p_EPZS
->
möthªs
[
blockty≥
]);

1776 
°›Crôîi⁄
 = 
	`di°blkmö
 (°›Crôîi⁄, 
p_EPZS
->
maxthªs
[
blockty≥
] + 
œmbda_di°
);

1777 
°›Crôîi⁄
 = (9 * 
	`di°blkmax
 (
p_EPZS
->
medthªs
[
blockty≥
] + 
œmbda_di°
, stopCriterion) + 2 *Ö_EPZS->medthres[blocktype]) >> 3;

1779  
°›Crôîi⁄
 + 
œmbda_di°
;

1780 
	}
}

1790 
	$EPZSOuçutSèts
 (
I≈utP¨amëîs
 * 
p_I≈
, 
FILE
 * 
°©
, 
°©s_fûe
)

1792 i‡(
°©s_fûe
 == 1)

1794 
	`Ârötf
 (
°©
, " EPZS P©ã∫ : %s\n", 
EPZS_PATTERN
[
p_I≈
->
EPZSP©ã∫
]);

1795 
	`Ârötf
 (
°©
, " EPZS DuÆ P©ã∫ : %s\n", 
EPZS_DUAL_PATTERN
[
p_I≈
->
EPZSDuÆ
]);

1796 
	`Ârötf
 (
°©
, " EPZS Fixed Pªdi˘‹† : %s\n", 
EPZS_FIXED_PREDICTORS
[
p_I≈
->
EPZSFixed
]);

1797 #i‡(
MVC_EXTENSION_ENABLE
)

1798 i‡(
p_I≈
->
num_of_võws
 == 2)

1800 
	`Ârötf
 (
°©
, " BL EPZS Temp‹Æ Pªdi˘‹† : %s\n", 
EPZS_OTHER_PREDICTORS
[
p_I≈
->
EPZSTemp‹Æ
[0]]);

1801 
	`Ârötf
 (
°©
, " EL EPZS Temp‹Æ Pªdi˘‹† : %s\n", 
EPZS_OTHER_PREDICTORS
[
p_I≈
->
EPZSTemp‹Æ
[1]]);

1805 
	`Ârötf
 (
°©
, " EPZS Temp‹Æ Pªdi˘‹† : %s\n", 
EPZS_OTHER_PREDICTORS
[
p_I≈
->
EPZSTemp‹Æ
[0]]);

1808 
	`Ârötf
 (
°©
, " EPZS Temp‹Æ Pªdi˘‹† : %s\n", 
EPZS_OTHER_PREDICTORS
[
p_I≈
->
EPZSTemp‹Æ
]);

1810 
	`Ârötf
 (
°©
, " EPZS S∑tü»Pªdi˘‹† : %s\n", 
EPZS_OTHER_PREDICTORS
[
p_I≈
->
EPZSS∑tülMem
]);

1811 #i‡(
MVC_EXTENSION_ENABLE
)

1812 i‡–(
p_I≈
->
num_of_võws
 =2Ë&& (p_I≈->
E«bÀEnhLayîEPZSSˇÀrs
) )

1814 
	`Ârötf
 (
°©
, " BL EPZS Thªshﬁd Mu…ùlõr† : (%d %d %d)\n", 
p_I≈
->
EPZSMedThªsSˇÀ
[0],Ö_I≈->
EPZSMöThªsSˇÀ
[0],Ö_I≈->
EPZSMaxThªsSˇÀ
[0]);

1815 
	`Ârötf
 (
°©
, " EL EPZS Thªshﬁd Mu…ùlõr† : (%d %d %d)\n", 
p_I≈
->
EPZSMedThªsSˇÀ
[1],Ö_I≈->
EPZSMöThªsSˇÀ
[1],Ö_I≈->
EPZSMaxThªsSˇÀ
[1]);

1819 
	`Ârötf
 (
°©
, " EPZS Thªshﬁd Mu…ùlõr† : (%d %d %d)\n", 
p_I≈
->
EPZSMedThªsSˇÀ
[0],Ö_I≈->
EPZSMöThªsSˇÀ
[0],Ö_I≈->
EPZSMaxThªsSˇÀ
[0]);

1822 
	`Ârötf
 (
°©
, " EPZS Thªshﬁd Mu…ùlõr† : (%d %d %d)\n", 
p_I≈
->
EPZSMedThªsSˇÀ
,Ö_I≈->
EPZSMöThªsSˇÀ
,Ö_I≈->
EPZSMaxThªsSˇÀ
);

1824 
	`Ârötf
 (
°©
, " EPZS Sub≥»ME : %s\n", 
EPZS_SUBPEL_METHOD
[
p_I≈
->
EPZSSubPñME
]);

1825 
	`Ârötf
 (
°©
, " EPZS Sub≥»ME BiPªd : %s\n", 
EPZS_SUBPEL_METHOD
[
p_I≈
->
EPZSSubPñMEBiPªd
]);

1829 
	`Ârötf
 (
°©
, " EPZS P©ã∫ : %s\n", 
EPZS_PATTERN
[
p_I≈
->
EPZSP©ã∫
]);

1830 
	`Ârötf
 (
°©
, " EPZS DuÆ P©ã∫ : %s\n", 
EPZS_DUAL_PATTERN
[
p_I≈
->
EPZSDuÆ
]);

1831 
	`Ârötf
 (
°©
, " EPZS Fixed Pªdi˘‹† : %s\n", 
EPZS_FIXED_PREDICTORS
[
p_I≈
->
EPZSFixed
]);

1832 #i‡(
MVC_EXTENSION_ENABLE
)

1833 i‡(
p_I≈
->
num_of_võws
 == 2)

1835 
	`Ârötf
 (
°©
, " BL EPZS Temp‹Æ Pªdi˘‹† : %s\n", 
EPZS_OTHER_PREDICTORS
[
p_I≈
->
EPZSTemp‹Æ
[0]]);

1836 
	`Ârötf
 (
°©
, " EL EPZS Temp‹Æ Pªdi˘‹† : %s\n", 
EPZS_OTHER_PREDICTORS
[
p_I≈
->
EPZSTemp‹Æ
[1]]);

1840 
	`Ârötf
 (
°©
, " EPZS Temp‹Æ Pªdi˘‹† : %s\n", 
EPZS_OTHER_PREDICTORS
[
p_I≈
->
EPZSTemp‹Æ
[0]]);

1843 
	`Ârötf
 (
°©
, " EPZS Temp‹Æ Pªdi˘‹† : %s\n", 
EPZS_OTHER_PREDICTORS
[
p_I≈
->
EPZSTemp‹Æ
]);

1845 
	`Ârötf
 (
°©
, " EPZS S∑tü»Pªdi˘‹† : %s\n", 
EPZS_OTHER_PREDICTORS
[
p_I≈
->
EPZSS∑tülMem
]);

1846 #i‡(
MVC_EXTENSION_ENABLE
)

1847 i‡–(
p_I≈
->
num_of_võws
 =2Ë&& (p_I≈->
E«bÀEnhLayîEPZSSˇÀrs
) )

1849 
	`Ârötf
 (
°©
, " BL EPZS Thªshﬁd Mu…ùlõr† : (%d %d %d)\n", 
p_I≈
->
EPZSMedThªsSˇÀ
[0],Ö_I≈->
EPZSMöThªsSˇÀ
[0],Ö_I≈->
EPZSMaxThªsSˇÀ
[0]);

1850 
	`Ârötf
 (
°©
, " EL EPZS Thªshﬁd Mu…ùlõr† : (%d %d %d)\n", 
p_I≈
->
EPZSMedThªsSˇÀ
[1],Ö_I≈->
EPZSMöThªsSˇÀ
[1],Ö_I≈->
EPZSMaxThªsSˇÀ
[1]);

1854 
	`Ârötf
 (
°©
, " EPZS Thªshﬁd Mu…ùlõr† : (%d %d %d)\n", 
p_I≈
->
EPZSMedThªsSˇÀ
[0],Ö_I≈->
EPZSMöThªsSˇÀ
[0],Ö_I≈->
EPZSMaxThªsSˇÀ
[0]);

1857 
	`Ârötf
 (
°©
, " EPZS Thªshﬁd Mu…ùlõr† : (%d %d %d)\n", 
p_I≈
->
EPZSMedThªsSˇÀ
,Ö_I≈->
EPZSMöThªsSˇÀ
,Ö_I≈->
EPZSMaxThªsSˇÀ
);

1859 
	`Ârötf
 (
°©
, " EPZS Sub≥»ME : %s\n", 
EPZS_SUBPEL_METHOD
[
p_I≈
->
EPZSSubPñME
]);

1860 
	`Ârötf
 (
°©
, " EPZS Sub≥»ME BiPªd : %s\n", 
EPZS_SUBPEL_METHOD
[
p_I≈
->
EPZSSubPñMEBiPªd
]);

1862 
	}
}

	@lencod/src/me_epzs_int.c

17 
	~"c⁄åibut‹s.h
"

19 
	~<limôs.h
>

21 
	~"globÆ.h
"

22 
	~"image.h
"

23 
	~"memÆloc.h
"

24 
	~"mb_ac˚ss.h
"

25 
	~"ªfbuf.h
"

26 
	~"ma¸oblock.h
"

27 
	~"me_di°‹ti⁄.h
"

28 
	~"me_ïzs.h
"

29 
	~"me_ïzs_comm⁄.h
"

30 
	~"mv_£¨ch.h
"

41 
di°blk


42 
	$EPZS_öãgî_mŸi⁄_e°im©i⁄
 (
Ma¸oblock
 * 
cuºMB
,

43 
MŸi⁄Ve˘‹
 * 
¥ed_mv
,

44 
MEBlock
 * 
mv_block
,

45 
di°blk
 
mö_mco°
,

46 
œmbda_Á˘‹


49 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

50 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

51 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

52 
EPZSP¨amëîs
 *
p_EPZS
 = 
cuºSli˚
->p_EPZS;

53 
PicMŸi⁄P¨ams
 **
mŸi⁄
 = 
p_Vid
->
íc_pi˘uª
->
mv_öfo
;

55 
blockty≥
 = 
mv_block
->blocktype;

57 
li°
 = 
mv_block
->list;

58 
cur_li°
 = 
li°
 + 
cuºMB
->
li°_off£t
;

59 
ªf
 = 
mv_block
->
ªf_idx
;

60 
MŸi⁄Ve˘‹
 *
mv
 = &
mv_block
->mv[
li°
];

61 
SórchWödow
 *
£¨chR™ge
 = &
mv_block
->searchRange;

62 
m≠Cíãr_x
 = 
£¨chR™ge
->
max_x
 - 
mv
->
mv_x
;

63 
m≠Cíãr_y
 = 
£¨chR™ge
->
max_y
 - 
mv
->
mv_y
;

64 
St‹abÀPi˘uª
 *
ªf_pi˘uª
 = 
cuºSli˚
->
li°X
[
cur_li°
][
ªf
];

66 
di°blk
 
œmbda_di°
 = 
	`weighãd_co°
(
œmbda_Á˘‹
, 2);

67 
di°blk
 
°›Crôîi⁄
 = 
p_EPZS
->
medthªs
[
blockty≥
] + 
œmbda_di°
;

68 
di°blk
 *
¥evSad
 = &
p_EPZS
->
di°‹ti⁄
[
cur_li°
][
blockty≥
 - 1][
mv_block
->
pos_x2
];

70 
MŸi⁄Ve˘‹
 *
p_mŸi⁄
 = 
NULL
;

72 
EPZSSåu˘uª
 *
£¨chP©ã∫F
 = 
p_EPZS
->
£¨chP©ã∫
;

73 
uöt16
 **
EPZSM≠
 = &
p_EPZS
->EPZSM≠[
m≠Cíãr_y
];

74 
uöt16
 *
EPZSPoöt
 = &
p_EPZS
->
EPZSM≠
[
£¨chR™ge
->
max_y
][£¨chR™ge->
max_x
];

76 
MŸi⁄Ve˘‹
 
˚¡î
 = 
	`∑d_MVs
 (*
mv
, 
mv_block
);

77 
MŸi⁄Ve˘‹
 
¥ed
 = 
	`∑d_MVs
 (*
¥ed_mv
, 
mv_block
);

78 
MŸi⁄Ve˘‹
 
tmp
 = *
mv
, 
ˇnd
 = 
˚¡î
;

80 ++
p_EPZS
->
BlkCou¡
;

81 i‡(
p_EPZS
->
BlkCou¡
 == 0)

82 ++
p_EPZS
->
BlkCou¡
;

84 i‡(
p_I≈
->
EPZSS∑tülMem
)

86 #i‡
EPZSREF


87 
p_mŸi⁄
 = &
p_EPZS
->p_mŸi⁄[
cur_li°
][
ªf
][
blockty≥
 - 1][
mv_block
->
block_y
][mv_block->
pos_x2
];

89 
p_mŸi⁄
 = &
p_EPZS
->p_mŸi⁄[
cur_li°
][
blockty≥
 - 1][
mv_block
->
block_y
][mv_block->
pos_x2
];

97 *
EPZSPoöt
 = 
p_EPZS
->
BlkCou¡
;

100 
mö_mco°
 = 
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd
, &
¥ed
);

103 
mö_mco°
 +
mv_block
->
	`compuãPªdFPñ
 (
ªf_pi˘uª
, mv_block, 
DISTBLK_MAX
 - mö_mco°, &
ˇnd
);

108 i‡((
ªf
 > 0 && 
cuºSli˚
->
°ru˘uª
 =
FRAME
) &&

109 ((*
¥evSad
 < 
	`di°blkmö
 (
p_EPZS
->
medthªs
[
blockty≥
] + 
œmbda_di°
, 
mö_mco°
)) || (*prevSad * 8 < min_mcost)))

111 #i‡
EPZSREF


112 i‡(
p_I≈
->
EPZSS∑tülMem
)

114 i‡(
p_I≈
->
EPZSS∑tülMem
 && 
ªf
 == 0)

117 *
p_mŸi⁄
 = 
tmp
;

119  
mö_mco°
;

124 i‡(
mö_mco°
 > 
°›Crôîi⁄
)

126 
SPoöt
 *
p_EPZS_poöt
 = 
p_EPZS
->
¥edi˘‹
->
poöt
;

127 
Boﬁón
 
checkMedün
 = 
FALSE
;

128 
di°blk
 
£c⁄d_mco°
 = 
DISTBLK_MAX
;

129 
di°blk
 
mco°
;

130 
¥ednum
 = 5;

131 
c⁄dôi⁄EPZS
;

132 
MŸi⁄Ve˘‹
 
tmp2
 = {0, 0}, 
tmv
;

133 
pos
;

134 
övÆid_ªfs
 = 0;

136 
°›Crôîi⁄
 = 
	`EPZSDëîmöeSt›Crôîi⁄
 (
p_EPZS
, 
¥evSad
, 
mv_block
, 
œmbda_di°
);

138 i‡(
mö_mco°
 < (
°›Crôîi⁄
 >> 1))

140 #i‡
EPZSREF


141 i‡(
p_I≈
->
EPZSS∑tülMem
)

143 i‡(
p_I≈
->
EPZSS∑tülMem
 && 
ªf
 == 0)

146 *
p_mŸi⁄
 = 
tmp
;

150 i‡((
ªf
 =0Ë|| (*
¥evSad
 > 
mö_mco°
))

151 *
¥evSad
 = 
mö_mco°
;

153  
mö_mco°
;

159 
övÆid_ªfs
 = 
	`EPZS_•©ül_¥edi˘‹s
 (
p_EPZS
, 
mv_block
,

160 
li°
, 
cuºMB
->
li°_off£t
, 
ªf
, 
mŸi⁄
);

162 i‡(
p_I≈
->
EPZSS∑tülMem
)

163 
	`EPZS_•©ül_mem‹y_¥edi˘‹s
 (
p_EPZS
, 
mv_block
, 
cur_li°
, &
¥ednum
, 
ªf_pi˘uª
->
size_x
 >> 2);

166 #i‡(
MVC_EXTENSION_ENABLE
)

167 i‡–
p_I≈
->
EPZSTemp‹Æ
[
cuºSli˚
->
võw_id
] )

170 i‡(
p_I≈
->
EPZSTemp‹Æ
)

173 
	`EPZS_ãmp‹Æ_¥edi˘‹s
 (
cuºMB
, 
ªf_pi˘uª
, 
p_EPZS
, 
mv_block
, &
¥ednum
, 
°›Crôîi⁄
, 
mö_mco°
);

189 
c⁄dôi⁄EPZS
 = (
p_I≈
->
EPZSFixed
 =3 && (
cuºMB
->
mb_x
 =0 || cuºMB->
mb_y
 == 0))

190 || ((
mö_mco°
 > 3 * 
°›Crôîi⁄
Ë&& ((
ªf
 < 2 && 
blockty≥
 < 4) || (ref < 1 && blocktype == 4)

191 || ((
cuºSli˚
->
°ru˘uª
 !
FRAME
 || 
cuºMB
->
li°_off£t
)

192 && 
ªf
 < 3))

193 && (
p_I≈
->
EPZSFixed
 > 1 || (p_I≈->EPZSFixed && 
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
)));

195 i‡(
c⁄dôi⁄EPZS
)

196 
	`EPZSWödowPªdi˘‹s
 (
mv
, 
p_EPZS
->
¥edi˘‹
, &
¥ednum
,

197 (
övÆid_ªfs
 > 2Ë&& (
ªf
 < 1 + (
cuºSli˚
->
°ru˘uª
 !
FRAME
 || 
cuºMB
->
li°_off£t
))

198 ? 
p_EPZS
->
wödow_¥edi˘‹_ext
 :Ö_EPZS->
wödow_¥edi˘‹
);

205 
c⁄dôi⁄EPZS
 = (
ªf
 =0 || (ª‡> 0 && 
mö_mco°
 > 2 * 
°›Crôîi⁄
));

207 i‡(
c⁄dôi⁄EPZS
 && 
cuºMB
->
mbAddrX
 !0 && 
p_I≈
->
EPZSBlockTy≥
)

208 
	`EPZSBlockTy≥Pªdi˘‹sMB
 (
cuºSli˚
, 
mv_block
, 
p_EPZS_poöt
, &
¥ednum
);

211 
pos
 = 0;Öo†< 
¥ednum
; ++pos)

213 
tmv
 = 
p_EPZS_poöt
[
pos
].
mŸi⁄
;

215 i‡((
	`übs
 (
tmv
.
mv_x
 - 
mv
->mv_xË- 
£¨chR™ge
->
max_x
 <0Ë&& (üb†—mv.
mv_y
 - mv->mv_yË- sórchR™ge->
max_y
 <= 0))

217 
EPZSPoöt
 = &
EPZSM≠
[
tmv
.
mv_y
][
m≠Cíãr_x
 +Åmv.
mv_x
];

218 i‡(*
EPZSPoöt
 !
p_EPZS
->
BlkCou¡
)

220 *
EPZSPoöt
 = 
p_EPZS
->
BlkCou¡
;

221 
ˇnd
 = 
	`∑d_MVs
 (
tmv
, 
mv_block
);

224 
mco°
 = 
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd
, &
¥ed
);

226 i‡(
mco°
 < 
£c⁄d_mco°
)

228 
mco°
 +
mv_block
->
	`compuãPªdFPñ
 (
ªf_pi˘uª
, mv_block, 
£c⁄d_mco°
 - mco°, &
ˇnd
);

231 i‡(
mco°
 < 
mö_mco°
)

233 
tmp2
 = 
tmp
;

234 
tmp
 = 
tmv
;

235 
£c⁄d_mco°
 = 
mö_mco°
;

236 
mö_mco°
 = 
mco°
;

237 
checkMedün
 = 
TRUE
;

240 i‡(
mco°
 < 
£c⁄d_mco°
)

242 
tmp2
 = 
tmv
;

243 
£c⁄d_mco°
 = 
mco°
;

244 
checkMedün
 = 
TRUE
;

251 i‡((
ªf
 > 0 && 
cuºSli˚
->
°ru˘uª
 =
FRAME
Ë&& (*
¥evSad
 * 3 < 
mö_mco°
))

253 #i‡
EPZSREF


254 i‡(
p_I≈
->
EPZSS∑tülMem
)

256 i‡(
p_I≈
->
EPZSS∑tülMem
 && 
ªf
 == 0)

259 *
p_mŸi⁄
 = 
tmp
;

262 *
mv
 = 
tmp
;

268  
mö_mco°
;

275 i‡(
mö_mco°
 > 
°›Crôîi⁄
)

277 c⁄° 
mv_ønge
 = 10;

278 
∑âînSt›
 = 0, 
poötNumbî
 = 0, 
checkPts
, 
√xtLa°
 = 0;

279 
tŸÆCheckPts
 = 0, 
mŸi⁄Dúe˘i⁄
 = 0;

282 i‡(
p_I≈
->
EPZSP©ã∫
 != 0)

284 i‡((
mö_mco°
 < 
°›Crôîi⁄
 + ((3 * 
p_EPZS
->
medthªs
[
blockty≥
]) >> 1)))

286 i‡((
tmp
.
mv_x
 =0 &&Åmp.
mv_y
 == 0)

287 || (
	`übs
 (
tmp
.
mv_x
 - 
mv
->mv_xË< (
mv_ønge
Ë&& iab†—mp.
mv_y
 - mv->mv_y) < (mv_range)))

288 
£¨chP©ã∫F
 = 
p_Vid
->
sdüm⁄d
;

290 
£¨chP©ã∫F
 = 
p_Vid
->
squ¨e
;

292 i‡(
ªf
 > 0 && 
blockty≥
 != 1)

293 
£¨chP©ã∫F
 = 
p_Vid
->
squ¨e
;

295 
£¨chP©ã∫F
 = 
p_EPZS
->
£¨chP©ã∫
;

299 
˚¡î
 = 
tmp
;

303 
tŸÆCheckPts
 = 
£¨chP©ã∫F
->
£¨chPoöts
;

306 
checkPts
 = 
tŸÆCheckPts
;

309 
tmv
 = 
	`add_MVs
 (
˚¡î
, &(
£¨chP©ã∫F
->
poöt
[
poötNumbî
].
mŸi⁄
));

311 i‡(((
	`übs
 (
tmv
.
mv_x
 - 
mv
->mv_xË- 
£¨chR™ge
->
max_x
Ë<0Ë&& ((üb†—mv.
mv_y
 - mv->mv_yË- sórchR™ge->
max_y
) <= 0))

313 
EPZSPoöt
 = &
EPZSM≠
[
tmv
.
mv_y
][
m≠Cíãr_x
 +Åmv.
mv_x
];

314 i‡(*
EPZSPoöt
 !
p_EPZS
->
BlkCou¡
)

316 *
EPZSPoöt
 = 
p_EPZS
->
BlkCou¡
;

317 
ˇnd
 = 
	`∑d_MVs
 (
tmv
, 
mv_block
);

319 
mco°
 = 
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd
, &
¥ed
);

321 i‡(
mco°
 < 
mö_mco°
)

323 
mco°
 +
mv_block
->
	`compuãPªdFPñ
 (
ªf_pi˘uª
, mv_block, 
mö_mco°
 - mco°, &
ˇnd
);

325 i‡(
mco°
 < 
mö_mco°
)

327 
tmp
 = 
tmv
;

328 
mö_mco°
 = 
mco°
;

329 
mŸi⁄Dúe˘i⁄
 = 
poötNumbî
;

334 ++
poötNumbî
;

335 i‡(
poötNumbî
 >
£¨chP©ã∫F
->
£¨chPoöts
)

336 
poötNumbî
 -
£¨chP©ã∫F
->
£¨chPoöts
;

337 
checkPts
--;

339 
checkPts
 > 0);

341 i‡(
√xtLa°
 || ((
tmp
.
mv_x
 =
˚¡î
.mv_xË&& (tmp.
mv_y
 == center.mv_y)))

343 
∑âînSt›
 = 
£¨chP©ã∫F
->
°›Sórch
;

344 
£¨chP©ã∫F
 = sórchP©ã∫F->
√xç©ã∫
;

345 
tŸÆCheckPts
 = 
£¨chP©ã∫F
->
£¨chPoöts
;

346 
√xtLa°
 = 
£¨chP©ã∫F
->nextLast;

347 
mŸi⁄Dúe˘i⁄
 = 0;

348 
poötNumbî
 = 0;

352 
tŸÆCheckPts
 = 
£¨chP©ã∫F
->
poöt
[
mŸi⁄Dúe˘i⁄
].
√xt_poöts
;

353 
poötNumbî
 = 
£¨chP©ã∫F
->
poöt
[
mŸi⁄Dúe˘i⁄
].
°¨t_nmbr
;

354 
˚¡î
 = 
tmp
;

357 
∑âînSt›
 != 1);

359 i‡((
ªf
 > 0Ë&& (
cuºSli˚
->
°ru˘uª
 =
FRAME
)

360 && ((4 * *
¥evSad
 < 
mö_mco°
Ë|| ((3 * *¥evSad < mö_mco°Ë&& (*¥evSad <
°›Crôîi⁄
))))

362 *
mv
 = 
tmp
;

363 #i‡
EPZSREF


364 i‡(
p_I≈
->
EPZSS∑tülMem
)

366 i‡(
p_I≈
->
EPZSS∑tülMem
 && 
ªf
 == 0)

369 *
p_mŸi⁄
 = 
tmp
;

372  
mö_mco°
;

376 
c⁄dôi⁄EPZS
 = (
checkMedün
 =
TRUE
)

377 && (
ªf
 =0 || (ª‡> 0 && 
mö_mco°
 < 2 * *
¥evSad
))

378 && (
mö_mco°
 > (–3 * 
°›Crôîi⁄
Ë>> 1)Ë&& (
p_I≈
->
EPZSDuÆ
 > 0);

380 i‡(!
c⁄dôi⁄EPZS
)

383 
poötNumbî
 = 0;

384 
∑âînSt›
 = 0;

385 
mŸi⁄Dúe˘i⁄
 = 0;

386 
√xtLa°
 = 0;

388 i‡((
tmp
.
mv_x
 =0 &&Åmp.
mv_y
 =0Ë|| (tmp.mv_x =
mv
->mv_x &&Åmp.mv_y == mv->mv_y))

390 i‡(
	`übs
 (
tmp
.
mv_x
 - 
mv
->mv_xË< (
mv_ønge
Ë&& iab†—mp.
mv_y
 - mv->mv_y) < (mv_range))

391 
£¨chP©ã∫F
 = 
p_Vid
->
sdüm⁄d
;

393 
£¨chP©ã∫F
 = 
p_Vid
->
squ¨e
;

396 
£¨chP©ã∫F
 = 
p_EPZS
->
£¨chP©ã∫D
;

399 
˚¡î
 = 
tmp2
;

400 
checkMedün
 = 
FALSE
;

405 i‡((
ªf
 =0Ë|| (*
¥evSad
 > 
mö_mco°
))

406 *
¥evSad
 = 
mö_mco°
;

407 #i‡
EPZSREF


408 i‡(
p_I≈
->
EPZSS∑tülMem
)

410 i‡(
p_I≈
->
EPZSS∑tülMem
 && 
ªf
 == 0)

413 *
p_mŸi⁄
 = 
tmp
;

418 *
mv
 = 
tmp
;

420  
mö_mco°
;

421 
	}
}

431 
di°blk


432 
	$EPZS_öãgî_subMB_mŸi⁄_e°im©i⁄
 (
Ma¸oblock
 * 
cuºMB
,

433 
MŸi⁄Ve˘‹
 * 
¥ed_mv
,

434 
MEBlock
 * 
mv_block
,

435 
di°blk
 
mö_mco°
,

436 
œmbda_Á˘‹


439 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

440 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

441 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

442 
EPZSP¨amëîs
 *
p_EPZS
 = 
cuºSli˚
->p_EPZS;

443 
PicMŸi⁄P¨ams
 **
mŸi⁄
 = 
p_Vid
->
íc_pi˘uª
->
mv_öfo
;

445 
blockty≥
 = 
mv_block
->blocktype;

446 
li°
 = 
mv_block
->list;

447 
cur_li°
 = 
li°
 + 
cuºMB
->
li°_off£t
;

448 
ªf
 = 
mv_block
->
ªf_idx
;

449 
St‹abÀPi˘uª
 *
ªf_pi˘uª
 = 
cuºSli˚
->
li°X
[
cur_li°
][
ªf
];

451 
MŸi⁄Ve˘‹
 *
mv
 = &
mv_block
->mv[
li°
];

452 
MŸi⁄Ve˘‹
 
˚¡î
 = 
	`∑d_MVs
 (*
mv
, 
mv_block
);

453 
MŸi⁄Ve˘‹
 
ˇnd
 = 
˚¡î
;

454 
MŸi⁄Ve˘‹
 
¥ed
 = 
	`∑d_MVs
 (*
¥ed_mv
, 
mv_block
);

455 
MŸi⁄Ve˘‹
 
tmp
 = *
mv
;

456 
SórchWödow
 *
£¨chR™ge
 = &
mv_block
->searchRange;

457 
m≠Cíãr_x
 = 
£¨chR™ge
->
max_x
 - 
mv
->
mv_x
;

458 
m≠Cíãr_y
 = 
£¨chR™ge
->
max_y
 - 
mv
->
mv_y
;

460 
pic_pix_x2
 = 
mv_block
->
pos_x2
;

461 
di°blk
 
œmbda_di°
 = 
	`weighãd_co°
(
œmbda_Á˘‹
,3);

462 
di°blk
 
°›Crôîi⁄
 = 
p_EPZS
->
medthªs
[
blockty≥
] + 
œmbda_di°
;

463 
di°blk
 *
¥evSad
 = &
p_EPZS
->
di°‹ti⁄
[
cur_li°
][
blockty≥
 - 1][
pic_pix_x2
];

464 
MŸi⁄Ve˘‹
 *
p_mŸi⁄
 = 
NULL
;

466 
EPZSSåu˘uª
 *
£¨chP©ã∫F
 = 
p_EPZS
->
£¨chP©ã∫
;

467 
uöt16
 **
EPZSM≠
 = &
p_EPZS
->EPZSM≠[
m≠Cíãr_y
];

469 ++
p_EPZS
->
BlkCou¡
;

470 i‡(
p_EPZS
->
BlkCou¡
 == 0)

471 ++
p_EPZS
->
BlkCou¡
;

473 i‡(
p_I≈
->
EPZSS∑tülMem
)

475 #i‡
EPZSREF


476 
p_mŸi⁄
 = &
p_EPZS
->p_mŸi⁄[
cur_li°
][
ªf
][
blockty≥
 - 1][
mv_block
->
block_y
][
pic_pix_x2
];

478 
p_mŸi⁄
 = &
p_EPZS
->p_mŸi⁄[
cur_li°
][
blockty≥
 - 1][
mv_block
->
block_y
][
pic_pix_x2
];

486 
p_EPZS
->
EPZSM≠
[
£¨chR™ge
->
max_y
][£¨chR™ge->
max_x
] =Ö_EPZS->
BlkCou¡
;

489 
mö_mco°
 = 
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd
, &
¥ed
);

492 
mö_mco°
 +
mv_block
->
	`compuãPªdFPñ
 (
ªf_pi˘uª
, mv_block, 
DISTBLK_MAX
-mö_mco°, &
ˇnd
);

496 i‡((
ªf
 > 0 && 
cuºSli˚
->
°ru˘uª
 =
FRAME
) &&

497 ((*
¥evSad
 < 
	`di°blkmö
 (
p_EPZS
->
medthªs
[
blockty≥
] + 
œmbda_di°
, 
mö_mco°
)) || (*prevSad * 6 < min_mcost)))

499 #i‡
EPZSREF


500 i‡(
p_I≈
->
EPZSS∑tülMem
)

502 i‡(
p_I≈
->
EPZSS∑tülMem
 && 
ªf
 == 0)

505 *
p_mŸi⁄
 = 
tmp
;

507  
mö_mco°
;

512 i‡(
mö_mco°
 > 
°›Crôîi⁄
)

514 
SPoöt
 *
p_EPZS_poöt
 = 
p_EPZS
->
¥edi˘‹
->
poöt
;

515 
Boﬁón
 
checkMedün
 = 
FALSE
;

516 
di°blk
 
£c⁄d_mco°
 = 
DISTBLK_MAX
;

517 
di°blk
 
mco°
;

518 
¥ednum
 = 5;

519 
c⁄dôi⁄EPZS
;

521 
MŸi⁄Ve˘‹
 
tmv
, 
tmp2
 = {0,0};

522 
pos
;

524 
°›Crôîi⁄
 = 
	`EPZSDëîmöeSt›Crôîi⁄
 (
p_EPZS
, 
¥evSad
, 
mv_block
, 
œmbda_di°
);

526 i‡(
mö_mco°
 < (
°›Crôîi⁄
 >> 1))

528 #i‡
EPZSREF


529 i‡(
p_I≈
->
EPZSS∑tülMem
)

531 i‡(
p_I≈
->
EPZSS∑tülMem
 && 
ªf
 == 0)

534 *
p_mŸi⁄
 = 
tmp
;

536  
mö_mco°
;

542 
	`EPZS_•©ül_¥edi˘‹s
 (
p_EPZS
, 
mv_block
, 
li°
, 
cuºMB
->
li°_off£t
, 
ªf
, 
mŸi⁄
);

544 i‡(
p_I≈
->
EPZSS∑tülMem
)

545 
	`EPZS_•©ül_mem‹y_¥edi˘‹s
 (
p_EPZS
, 
mv_block
, 
cur_li°
, &
¥ednum
, 
ªf_pi˘uª
->
size_x
 >> 2);

551 
c⁄dôi⁄EPZS
 = (
ªf
 =0 || (ª‡> 0 && 
mö_mco°
 > 2 * 
°›Crôîi⁄
));

553 i‡(
c⁄dôi⁄EPZS
 && 
cuºMB
->
mbAddrX
 !0 && 
p_I≈
->
EPZSBlockTy≥
)

554 
	`EPZSBlockTy≥Pªdi˘‹s
 (
cuºSli˚
, 
mv_block
, 
p_EPZS_poöt
, &
¥ednum
);

557 
pos
 = 0;Öo†< 
¥ednum
; ++pos)

559 
tmv
 = 
p_EPZS_poöt
[
pos
].
mŸi⁄
;

561 i‡((
	`übs
 (
tmv
.
mv_x
 - 
mv
->mv_xË- 
£¨chR™ge
->
max_x
 <0Ë&& (üb†—mv.
mv_y
 - mv->mv_yË- sórchR™ge->
max_y
 <= 0))

564 i‡(
EPZSM≠
[
tmv
.
mv_y
][
m≠Cíãr_x
 +Åmv.
mv_x
] !
p_EPZS
->
BlkCou¡
)

566 
EPZSM≠
[
tmv
.
mv_y
][
m≠Cíãr_x
 +Åmv.
mv_x
] = 
p_EPZS
->
BlkCou¡
;

568 
ˇnd
 = 
	`∑d_MVs
 (
tmv
, 
mv_block
);

571 
mco°
 = 
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd
, &
¥ed
);

573 i‡(
mco°
 < 
£c⁄d_mco°
)

575 
mco°
 +
mv_block
->
	`compuãPªdFPñ
 (
ªf_pi˘uª
, mv_block, 
£c⁄d_mco°
 - mco°, &
ˇnd
);

578 i‡(
mco°
 < 
mö_mco°
)

580 
tmp2
 = 
tmp
;

581 
tmp
 = 
tmv
;

582 
£c⁄d_mco°
 = 
mö_mco°
;

583 
mö_mco°
 = 
mco°
;

584 
checkMedün
 = 
TRUE
;

587 i‡(
mco°
 < 
£c⁄d_mco°
)

589 
tmp2
 = 
tmv
;

590 
£c⁄d_mco°
 = 
mco°
;

591 
checkMedün
 = 
TRUE
;

597 i‡((
ªf
 > 0 && 
cuºSli˚
->
°ru˘uª
 =
FRAME
Ë&& (*
¥evSad
 * 3 < 
mö_mco°
))

599 #i‡
EPZSREF


600 i‡(
p_I≈
->
EPZSS∑tülMem
)

602 i‡(
p_I≈
->
EPZSS∑tülMem
 && 
ªf
 == 0)

605 *
p_mŸi⁄
 = 
tmp
;

607  
mö_mco°
;

612 i‡(
mö_mco°
 < ((3 * 
°›Crôîi⁄
) >> 2))

614 #i‡
EPZSREF


615 i‡(
p_I≈
->
EPZSS∑tülMem
)

617 i‡(
p_I≈
->
EPZSS∑tülMem
 && 
ªf
 == 0)

620 *
p_mŸi⁄
 = 
tmp
;

622 *
mv
 = 
tmp
;

623  
mö_mco°
;

631 i‡(
mö_mco°
 > 
°›Crôîi⁄
)

633 
∑âînSt›
 = 0, 
poötNumbî
 = 0, 
checkPts
, 
√xtLa°
 = 0;

634 
tŸÆCheckPts
 = 0, 
mŸi⁄Dúe˘i⁄
 = 0;

635 c⁄° 
mv_ønge
 = 12;

638 i‡(
p_I≈
->
EPZSP©ã∫
 != 0)

640 i‡((
mö_mco°
 < 
°›Crôîi⁄
 + ((3 * 
p_EPZS
->
medthªs
[
blockty≥
]) >> 1)))

642 i‡((
blockty≥
 == 7)

643 || (
tmp
.
mv_x
 =0 &&Åmp.
mv_y
 =0Ë|| (
	`übs
 (tmp.mv_x - 
mv
->mv_xË< (
mv_ønge
) && iabs (tmp.mv_y - mv->mv_y) < (mv_range)))

644 
£¨chP©ã∫F
 = 
p_Vid
->
sdüm⁄d
;

646 
£¨chP©ã∫F
 = 
p_Vid
->
squ¨e
;

649 
£¨chP©ã∫F
 = 
p_Vid
->
squ¨e
;

653 
˚¡î
 = 
tmp
;

656 
tŸÆCheckPts
 = 
£¨chP©ã∫F
->
£¨chPoöts
;

659 
checkPts
 = 
tŸÆCheckPts
;

662 
tmv
 = 
	`add_MVs
 (
˚¡î
, &(
£¨chP©ã∫F
->
poöt
[
poötNumbî
].
mŸi⁄
));

664 i‡((
	`übs
 (
tmv
.
mv_x
 - 
mv
->mv_xË<
£¨chR™ge
->
max_x
Ë&& (üb†—mv.
mv_y
 - mv->mv_yË<£¨chR™ge->
max_y
))

666 i‡(
EPZSM≠
[
tmv
.
mv_y
][
m≠Cíãr_x
 +Åmv.
mv_x
] !
p_EPZS
->
BlkCou¡
)

668 
EPZSM≠
[
tmv
.
mv_y
][
m≠Cíãr_x
 +Åmv.
mv_x
] = 
p_EPZS
->
BlkCou¡
;

669 
ˇnd
 = 
	`∑d_MVs
(
tmv
, 
mv_block
);

671 
mco°
 = 
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd
, &
¥ed
);

672 i‡(
mco°
 < 
mö_mco°
)

675 
mco°
 +
mv_block
->
	`compuãPªdFPñ
 (
ªf_pi˘uª
, mv_block, 
mö_mco°
 - mco°, &
ˇnd
);

677 i‡(
mco°
 < 
mö_mco°
)

679 
tmp
 = 
tmv
;

680 
mö_mco°
 = 
mco°
;

681 
mŸi⁄Dúe˘i⁄
 = 
poötNumbî
;

686 ++
poötNumbî
;

687 i‡(
poötNumbî
 >
£¨chP©ã∫F
->
£¨chPoöts
)

688 
poötNumbî
 -
£¨chP©ã∫F
->
£¨chPoöts
;

689 
checkPts
--;

691 
checkPts
 > 0);

693 i‡(
√xtLa°
 || ((
tmp
.
mv_x
 =
˚¡î
.mv_xË&& (tmp.
mv_y
 == center.mv_y)))

695 
∑âînSt›
 = 
£¨chP©ã∫F
->
°›Sórch
;

696 
£¨chP©ã∫F
 = sórchP©ã∫F->
√xç©ã∫
;

697 
tŸÆCheckPts
 = 
£¨chP©ã∫F
->
£¨chPoöts
;

698 
√xtLa°
 = 
£¨chP©ã∫F
->nextLast;

699 
mŸi⁄Dúe˘i⁄
 = 0;

700 
poötNumbî
 = 0;

704 
tŸÆCheckPts
 = 
£¨chP©ã∫F
->
poöt
[
mŸi⁄Dúe˘i⁄
].
√xt_poöts
;

705 
poötNumbî
 = 
£¨chP©ã∫F
->
poöt
[
mŸi⁄Dúe˘i⁄
].
°¨t_nmbr
;

706 
˚¡î
 = 
tmp
;

709 
∑âînSt›
 != 1);

711 i‡((
ªf
 > 0Ë&& (
cuºSli˚
->
°ru˘uª
 =
FRAME
)

712 && ((4 * *
¥evSad
 < 
mö_mco°
Ë|| ((3 * *¥evSad < mö_mco°Ë&& (*¥evSad <
°›Crôîi⁄
))))

714 *
mv
 = 
tmp
;

715 #i‡
EPZSREF


716 i‡(
p_I≈
->
EPZSS∑tülMem
)

718 i‡(
p_I≈
->
EPZSS∑tülMem
 && 
ªf
 == 0)

721 *
p_mŸi⁄
 = 
tmp
;

724  
mö_mco°
;

728 
c⁄dôi⁄EPZS
 = (
checkMedün
 =
TRUE
Ë&& (
blockty≥
 != 7)

730 && (
ªf
 =0 || (ª‡> 0 && 
mö_mco°
 < 2 * *
¥evSad
))

731 && ((
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
)Ë&& (
mö_mco°
 > ((3 * 
°›Crôîi⁄
Ë>> 1)Ë&& (
p_I≈
->
EPZSDuÆ
 > 0);

733 i‡(!
c⁄dôi⁄EPZS
)

736 
poötNumbî
 = 0;

737 
∑âînSt›
 = 0;

738 
mŸi⁄Dúe˘i⁄
 = 0;

739 
√xtLa°
 = 0;

741 i‡((
tmp
.
mv_x
 =0 &&Åmp.
mv_y
 =0Ë|| (tmp.mv_x =
mv
->mv_x &&Åmp.mv_y == mv->mv_y))

743 i‡((
blockty≥
 =7Ë|| (
	`übs
 (
tmp
.
mv_x
 - 
mv
->mv_xË< (
mv_ønge
Ë&& iab†—mp.
mv_y
 - mv->mv_y) < (mv_range)))

744 
£¨chP©ã∫F
 = 
p_Vid
->
sdüm⁄d
;

746 
£¨chP©ã∫F
 = 
p_Vid
->
squ¨e
;

749 
£¨chP©ã∫F
 = 
p_EPZS
->
£¨chP©ã∫D
;

752 
˚¡î
 = 
tmp2
;

753 
checkMedün
 = 
FALSE
;

758 i‡((
ªf
 =0Ë|| (*
¥evSad
 > 
mö_mco°
))

759 *
¥evSad
 = 
mö_mco°
;

761 #i‡
EPZSREF


762 i‡(
p_I≈
->
EPZSS∑tülMem
)

764 i‡(
p_I≈
->
EPZSS∑tülMem
 && 
ªf
 == 0)

767 *
p_mŸi⁄
 = 
tmp
;

770 *
mv
 = 
tmp
;

772  
mö_mco°
;

773 
	}
}

784 
di°blk


785 
	$EPZS_öãgî_bùªd_mŸi⁄_e°im©i⁄
 (
Ma¸oblock
 * 
cuºMB
,

786 
li°
,

787 
MŸi⁄Ve˘‹
 * 
¥ed_mv1
,

788 
MŸi⁄Ve˘‹
 * 
¥ed_mv2
,

789 
MŸi⁄Ve˘‹
 * 
mv1
,

790 
MŸi⁄Ve˘‹
 * 
mv2
,

791 
MEBlock
 * 
mv_block
,

792 
£¨ch_ønge
,

793 
di°blk
 
mö_mco°
,

794 
œmbda_Á˘‹


797 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

798 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

799 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

800 
EPZSP¨amëîs
 *
p_EPZS
 = 
cuºSli˚
->p_EPZS;

801 
PicMŸi⁄P¨ams
 **
mŸi⁄
 = 
p_Vid
->
íc_pi˘uª
->
mv_öfo
;

803 
blockty≥
 = 
mv_block
->blocktype;

804 
ªf
 = 
mv_block
->
ªf_idx
;

806 
St‹abÀPi˘uª
 *
ªf_pi˘uª1
 = 
cuºSli˚
->
li°X
[
li°
 + 
cuºMB
->
li°_off£t
][
ªf
];

807 
St‹abÀPi˘uª
 *
ªf_pi˘uª2
 = 
cuºSli˚
->
li°X
[(
li°
 ^ 1Ë+ 
cuºMB
->
li°_off£t
][0];

809 
m≠Cíãr_x
 = 
£¨ch_ønge
 - 
mv1
->
mv_x
;

810 
m≠Cíãr_y
 = 
£¨ch_ønge
 - 
mv1
->
mv_y
;

811 
di°blk
 
œmbda_di°
 = 
	`weighãd_co°
(
œmbda_Á˘‹
, 4);

812 
di°blk
 
°›Crôîi⁄
 = 
p_EPZS
->
medthªs
[
blockty≥
] + 
œmbda_di°
;

813 
di°blk
 *
¥evSad
 = &
p_EPZS
->
bi_di°‹ti⁄
[
li°
 + 
cuºMB
->
li°_off£t
][
blockty≥
 - 1][
mv_block
->
pos_x2
];

814 
EPZSSåu˘uª
 *
£¨chP©ã∫F
 = 
p_EPZS
->
£¨chP©ã∫
;

815 
uöt16
 **
EPZSM≠
 = &
p_EPZS
->EPZSM≠[
m≠Cíãr_y
];

817 
MŸi⁄Ve˘‹
 
tmp
 = *
mv1
;

818 
MŸi⁄Ve˘‹
 
˚¡î1
 = 
	`∑d_MVs
 (*
mv1
, 
mv_block
);

819 
MŸi⁄Ve˘‹
 
˚¡î2
 = 
	`∑d_MVs
 (*
mv2
, 
mv_block
);

820 
MŸi⁄Ve˘‹
 
¥ed1
 = 
	`∑d_MVs
 (*
¥ed_mv1
, 
mv_block
);

821 
MŸi⁄Ve˘‹
 
¥ed2
 = 
	`∑d_MVs
 (*
¥ed_mv2
, 
mv_block
);

822 
MŸi⁄Ve˘‹
 
ˇnd1
 = 
˚¡î1
;

823 
MŸi⁄Ve˘‹
 
ˇnd2
 = 
˚¡î2
;

825 ++
p_EPZS
->
BlkCou¡
;

826 i‡(
p_EPZS
->
BlkCou¡
 == 0)

827 ++
p_EPZS
->
BlkCou¡
;

834 
p_EPZS
->
EPZSM≠
[
£¨ch_ønge
][£¨ch_ønge] =Ö_EPZS->
BlkCou¡
;

837 
mö_mco°
 = 
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd1
, &
¥ed1
);

838 
mö_mco°
 +
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd2
, &
¥ed2
);

841 
mö_mco°
 +
mv_block
->
	`compuãBiPªdFPñ
 (
ªf_pi˘uª1
, 
ªf_pi˘uª2
, mv_block, 
DISTBLK_MAX
-mö_mco°, &
ˇnd1
, &
ˇnd2
);

844 i‡(
mö_mco°
 > 
°›Crôîi⁄
)

846 
SPoöt
 *
p_EPZS_poöt
 = 
p_EPZS
->
¥edi˘‹
->
poöt
;

847 
Boﬁón
 
checkMedün
 = 
FALSE
;

848 
di°blk
 
£c⁄d_mco°
 = 
DISTBLK_MAX
;

849 
di°blk
 
mco°
;

850 
¥ednum
 = 5;

851 
MŸi⁄Ve˘‹
 
tmv
, 
tmp2
 = { 0, 0 };

852 
pos
;

854 
°›Crôîi⁄
 = 
	`EPZSDëîmöeSt›Crôîi⁄
 (
p_EPZS
, 
¥evSad
, 
mv_block
, 
œmbda_di°
);

860 
	`EPZS_•©ül_¥edi˘‹s
 (
p_EPZS
, 
mv_block
, 
li°
, 
cuºMB
->
li°_off£t
, 
ªf
, 
mŸi⁄
);

863 
pos
 = 0;Öo†< 
¥ednum
; ++pos)

865 
tmv
 = 
p_EPZS_poöt
[
pos
].
mŸi⁄
;

867 i‡(
	`übs
 (
tmv
.
mv_x
 - 
mv1
->mv_xË<
£¨ch_ønge
 && iab†—mv.
mv_y
 - mv1->mv_y) <= search_range)

869 i‡(
EPZSM≠
[
tmv
.
mv_y
][
m≠Cíãr_x
 +Åmv.
mv_x
] !
p_EPZS
->
BlkCou¡
)

871 
EPZSM≠
[
tmv
.
mv_y
][
m≠Cíãr_x
 +Åmv.
mv_x
] = 
p_EPZS
->
BlkCou¡
;

873 
ˇnd1
 = 
	`∑d_MVs
 (
tmv
, 
mv_block
);

876 
mco°
 = 
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd1
, &
¥ed1
);

877 
mco°
 +
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd2
, &
¥ed2
);

879 i‡(
mco°
 >
£c⁄d_mco°
)

882 
mco°
 +
mv_block
->
	`compuãBiPªdFPñ
 (
ªf_pi˘uª1
, 
ªf_pi˘uª2
, mv_block, 
£c⁄d_mco°
 - mco°, &
ˇnd1
, &
ˇnd2
);

885 i‡(
mco°
 < 
mö_mco°
)

887 
tmp2
 = 
tmp
;

888 
tmp
 = 
tmv
;

889 
£c⁄d_mco°
 = 
mö_mco°
;

890 
mö_mco°
 = 
mco°
;

891 
checkMedün
 = 
TRUE
;

894 i‡(
mco°
 < 
£c⁄d_mco°
)

896 
tmp2
 = 
tmv
;

897 
£c⁄d_mco°
 = 
mco°
;

898 
checkMedün
 = 
TRUE
;

908 i‡(
mö_mco°
 > 
°›Crôîi⁄
)

910 
c⁄dôi⁄EPZS
;

911 
∑âînSt›
 = 0, 
poötNumbî
 = 0, 
checkPts
, 
√xtLa°
 = 0;

912 
tŸÆCheckPts
 = 0, 
mŸi⁄Dúe˘i⁄
 = 0;

914 c⁄° 
mv_ønge
 = 12;

917 i‡(
p_I≈
->
EPZSP©ã∫
 != 0)

919 i‡((
mö_mco°
 < 
°›Crôîi⁄
 + ((4 * 
p_EPZS
->
medthªs
[
blockty≥
]) >> 1)))

921 i‡((
tmp
.
mv_x
 =0 &&Åmp.
mv_y
 =0Ë|| (
	`übs
 (tmp.mv_x - 
mv1
->mv_xË< (
mv_ønge
) && iabs (tmp.mv_y - mv1->mv_y) < (mv_range)))

922 
£¨chP©ã∫F
 = 
p_Vid
->
sdüm⁄d
;

924 
£¨chP©ã∫F
 = 
p_Vid
->
squ¨e
;

926 i‡(
blockty≥
 > 5 || (
ªf
 > 0 && blocktype != 1))

927 
£¨chP©ã∫F
 = 
p_Vid
->
squ¨e
;

929 
£¨chP©ã∫F
 = 
p_EPZS
->
£¨chP©ã∫
;

933 
˚¡î1
 = 
tmp
;

936 
tŸÆCheckPts
 = 
£¨chP©ã∫F
->
£¨chPoöts
;

939 
checkPts
 = 
tŸÆCheckPts
;

942 
tmv
 = 
	`add_MVs
 (
˚¡î1
, &(
£¨chP©ã∫F
->
poöt
[
poötNumbî
].
mŸi⁄
));

944 i‡((
	`übs
 (
tmv
.
mv_x
 - 
mv1
->mv_xË<
£¨ch_ønge
Ë&& (üb†—mv.
mv_y
 - mv1->mv_y) <= search_range))

946 i‡(
EPZSM≠
[
tmv
.
mv_y
][
m≠Cíãr_x
 +Åmv.
mv_x
] !
p_EPZS
->
BlkCou¡
)

948 
EPZSM≠
[
tmv
.
mv_y
][
m≠Cíãr_x
 +Åmv.
mv_x
] = 
p_EPZS
->
BlkCou¡
;

949 
ˇnd1
 = 
	`∑d_MVs
 (
tmv
, 
mv_block
);

951 
mco°
 = 
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd1
, &
¥ed1
);

952 
mco°
 +
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd2
, &
¥ed2
);

954 i‡(
mco°
 < 
mö_mco°
)

956 
mco°
 +
mv_block
->
	`compuãBiPªdFPñ
 (
ªf_pi˘uª1
, 
ªf_pi˘uª2
, mv_block, 
mö_mco°
 - mco°, &
ˇnd1
, &
ˇnd2
);

958 i‡(
mco°
 < 
mö_mco°
)

960 
tmp
 = 
tmv
;

961 
mö_mco°
 = 
mco°
;

962 
mŸi⁄Dúe˘i⁄
 = 
poötNumbî
;

967 ++
poötNumbî
;

968 i‡(
poötNumbî
 >
£¨chP©ã∫F
->
£¨chPoöts
)

969 
poötNumbî
 -
£¨chP©ã∫F
->
£¨chPoöts
;

970 
checkPts
--;

972 
checkPts
 > 0);

974 i‡(
√xtLa°
 || ((
tmp
.
mv_x
 =
˚¡î1
.mv_xË&& (tmp.
mv_y
 == center1.mv_y)))

976 
∑âînSt›
 = 
£¨chP©ã∫F
->
°›Sórch
;

977 
£¨chP©ã∫F
 = sórchP©ã∫F->
√xç©ã∫
;

978 
tŸÆCheckPts
 = 
£¨chP©ã∫F
->
£¨chPoöts
;

979 
√xtLa°
 = 
£¨chP©ã∫F
->nextLast;

980 
mŸi⁄Dúe˘i⁄
 = 0;

981 
poötNumbî
 = 0;

985 
tŸÆCheckPts
 = 
£¨chP©ã∫F
->
poöt
[
mŸi⁄Dúe˘i⁄
].
√xt_poöts
;

986 
poötNumbî
 = 
£¨chP©ã∫F
->
poöt
[
mŸi⁄Dúe˘i⁄
].
°¨t_nmbr
;

987 
˚¡î1
 = 
tmp
;

990 
∑âînSt›
 != 1);

993 
c⁄dôi⁄EPZS
 = (
checkMedün
 =
TRUE
Ë&& (
blockty≥
 < 5Ë&& (
mö_mco°
 > 
°›Crôîi⁄
Ë&& (
p_I≈
->
EPZSDuÆ
 > 0);

995 i‡(!
c⁄dôi⁄EPZS
)

998 
poötNumbî
 = 0;

999 
∑âînSt›
 = 0;

1000 
mŸi⁄Dúe˘i⁄
 = 0;

1001 
√xtLa°
 = 0;

1003 i‡((
tmp
.
mv_x
 =0 &&Åmp.
mv_y
 =0Ë|| (tmp.mv_x =
mv1
->mv_x &&Åmp.mv_y == mv1->mv_y))

1005 i‡(
	`übs
 (
tmp
.
mv_x
 - 
mv1
->mv_xË< (
mv_ønge
Ë&& iab†—mp.
mv_y
 - mv1->mv_y) < (mv_range))

1006 
£¨chP©ã∫F
 = 
p_Vid
->
sdüm⁄d
;

1008 
£¨chP©ã∫F
 = 
p_Vid
->
squ¨e
;

1011 
£¨chP©ã∫F
 = 
p_EPZS
->
£¨chP©ã∫D
;

1012 
tŸÆCheckPts
 = 
£¨chP©ã∫F
->
£¨chPoöts
;

1015 
˚¡î1
 = 
tmp2
;

1016 
checkMedün
 = 
FALSE
;

1021 i‡(
mv_block
->
ôî©i⁄_no
 == 0)

1023 *
¥evSad
 = 
mö_mco°
;

1026 *
mv1
 = 
tmp
;

1028  
mö_mco°
;

1029 
	}
}

	@lencod/src/me_epzs_sub.c

16 
	~"c⁄åibut‹s.h
"

18 
	~"globÆ.h
"

19 
	~"ªfbuf.h
"

20 
	~"me_ïzs.h
"

21 
	~"mv_£¨ch.h
"

29 
di°blk


30 
	$EPZS_sub_≥l_mŸi⁄_e°im©i⁄
 ( 
Ma¸oblock
 *
cuºMB
,

31 
MŸi⁄Ve˘‹
 *
¥ed
,

32 
MEBlock
 *
mv_block
,

33 
di°blk
 
mö_mco°
,

34 * 
œmbda


37 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

38 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

39 
EPZSP¨amëîs
 *
p_EPZS
 = 
cuºSli˚
->p_EPZS;

40 
pos
, 
be°_pos
 = 0, 
£c⁄d_pos
 = 0;

41 
di°blk
 
mco°
;

42 
di°blk
 
£c⁄d_mco°
 = 
DISTBLK_MAX
;

43 
max_pos2
 = ( (!
p_Vid
->
°¨t_me_ªföemít_hp
 || !p_Vid->
°¨t_me_ªföemít_qp
Ë? 
	`imax
(1, 
mv_block
->
£¨ch_pos2
) : mv_block->search_pos2);

45 
li°
 = 
mv_block
->list;

46 
cur_li°
 = 
li°
 + 
cuºMB
->
li°_off£t
;

47 
ªf
 = 
mv_block
->
ªf_idx
;

48 
St‹abÀPi˘uª
 *
ªf_pi˘uª
 = 
cuºSli˚
->
li°X
[
cur_li°
][
ªf
];

49 
MŸi⁄Ve˘‹
 *
mv
 = &
mv_block
->mv[
li°
];

50 
MŸi⁄Ve˘‹
 
ˇnd
;

51 
MŸi⁄Ve˘‹
 
∑dded_mv
 = 
	`∑d_MVs
 (*
mv
, 
mv_block
);

52 
MŸi⁄Ve˘‹
 
¥ed_mv
 = 
	`∑d_MVs
 (*
¥ed
, 
mv_block
);

54 
°¨t_pos
 = 5, 
íd_pos
 = 
max_pos2
;

55 
œmbda_Á˘‹
 = 
œmbda
[
H_PEL
];

56 
di°blk
 
œmbda_di°
 = 
	`weighãd_co°
(
œmbda_Á˘‹
, 2);

57 
di°blk
 
sub_thªshﬁd
 = 
p_EPZS
->
subthªs
[
mv_block
->
blockty≥
] + 
œmbda_di°
;

66 
be°_pos
 = 0, 
pos
 = 
p_Vid
->
°¨t_me_ªföemít_hp
;Öo†< 
	`imö
(5, 
max_pos2
); ++pos)

68 
ˇnd
 = 
	`add_MVs
(
£¨ch_poöt_hp
[
pos
], &
∑dded_mv
);

71 
mco°
 = 
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd
, &
¥ed_mv
);

72 i‡(
mco°
 < 
£c⁄d_mco°
)

74 
mco°
 +
mv_block
->
	`compuãPªdHPñ
(
ªf_pi˘uª
, mv_block, 
£c⁄d_mco°
 - mco°, &
ˇnd
);

76 i‡(
mco°
 < 
mö_mco°
)

78 
£c⁄d_mco°
 = 
mö_mco°
;

79 
£c⁄d_pos
 = 
be°_pos
;

80 
mö_mco°
 = 
mco°
;

81 
be°_pos
 = 
pos
;

83 i‡(
mco°
 < 
£c⁄d_mco°
)

85 
£c⁄d_mco°
 = 
mco°
;

86 
£c⁄d_pos
 = 
pos
;

91 i‡(
be°_pos
 ==0 && (
¥ed
->
mv_x
 =
mv
->mv_xË&& (¥ed->
mv_y
 =mv->mv_yË&& 
mö_mco°
 < 
sub_thªshﬁd
)

93  
mö_mco°
;

96 if(
mv_block
->
£¨ch_pos2
 >= 9)

98 i‡(
be°_pos
 !=0 || (
	`übs
(
¥ed
->
mv_x
 - 
mv
->mv_xË+ iabs’ªd->
mv_y
 - mv->mv_y)))

100 
°¨t_pos
 = 
√xt_°¨t_pos
[
be°_pos
][
£c⁄d_pos
];

101 
íd_pos
 = 
√xt_íd_pos
[
be°_pos
][
£c⁄d_pos
];

103 
pos
 = 
°¨t_pos
;Öo†< 
íd_pos
; ++pos)

105 
ˇnd
 = 
	`add_MVs
(
£¨ch_poöt_hp
[
pos
], &
∑dded_mv
);

108 
mco°
 = 
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd
, &
¥ed_mv
);

110 i‡(
mco°
 < 
mö_mco°
)

112 
mco°
 +
mv_block
->
	`compuãPªdHPñ
–
ªf_pi˘uª
, mv_block, 
mö_mco°
 - mco°, &
ˇnd
);

114 i‡(
mco°
 < 
mö_mco°
)

116 
mö_mco°
 = 
mco°
;

117 
be°_pos
 = 
pos
;

124 i‡(
be°_pos
)

126 
	`add_mvs
(
mv
, &
£¨ch_poöt_hp
[
be°_pos
]);

127 
∑dded_mv
 = 
	`∑d_MVs
 (*
mv
, 
mv_block
);

135 
íd_pos
 = (
mö_mco°
 < 
sub_thªshﬁd
) ? 1 : 5;

136 
£c⁄d_mco°
 = 
DISTBLK_MAX
;

138 i‡–!
p_Vid
->
°¨t_me_ªföemít_qp
 )

140 
be°_pos
 = -1;

141 
mö_mco°
 = 
DISTBLK_MAX
;

145 
be°_pos
 = 0;

147 
œmbda_Á˘‹
 = 
œmbda
[
Q_PEL
];

150 
pos
 = 
p_Vid
->
°¨t_me_ªföemít_qp
;Öo†< 
íd_pos
; ++pos)

152 
ˇnd
 = 
	`add_MVs
(
£¨ch_poöt_qp
[
pos
], &
∑dded_mv
);

155 
mco°
 = 
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd
, &
¥ed_mv
);

157 i‡(
mco°
 < 
£c⁄d_mco°
)

159 
mco°
 +
mv_block
->
	`compuãPªdQPñ
(
ªf_pi˘uª
, mv_block, 
£c⁄d_mco°
 - mco°, &
ˇnd
);

161 i‡(
mco°
 < 
mö_mco°
)

163 
£c⁄d_mco°
 = 
mö_mco°
;

164 
£c⁄d_pos
 = 
be°_pos
;

165 
mö_mco°
 = 
mco°
;

166 
be°_pos
 = 
pos
;

168 i‡(
mco°
 < 
£c⁄d_mco°
)

170 
£c⁄d_mco°
 = 
mco°
;

171 
£c⁄d_pos
 = 
pos
;

177 i‡–(
mö_mco°
 > 
sub_thªshﬁd
))

180 i‡(
be°_pos
 !=0 || (
	`übs
(
¥ed
->
mv_x
 - 
mv
->mv_xË+ iabs’ªd->
mv_y
 - mv->mv_y)))

182 
°¨t_pos
 = 
√xt_°¨t_pos
[
be°_pos
][
£c⁄d_pos
];

183 
íd_pos
 = 
√xt_íd_pos
[
be°_pos
][
£c⁄d_pos
];

185 
pos
 = 
°¨t_pos
;Öo†< 
íd_pos
; ++pos)

187 
ˇnd
 = 
	`add_MVs
(
£¨ch_poöt_qp
[
pos
], &
∑dded_mv
);

190 
mco°
 = 
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd
, &
¥ed_mv
);

192 i‡(
mco°
 < 
mö_mco°
)

194 
mco°
 +
mv_block
->
	`compuãPªdQPñ
(
ªf_pi˘uª
, mv_block, 
mö_mco°
 - mco°, &
ˇnd
);

196 i‡(
mco°
 < 
mö_mco°
)

198 
mö_mco°
 = 
mco°
;

199 
be°_pos
 = 
pos
;

206 i‡(
be°_pos
)

208 
	`add_mvs
(
mv
, &
£¨ch_poöt_qp
[
be°_pos
]);

212  
mö_mco°
;

213 
	}
}

222 
di°blk


223 
	$EPZS_sub_≥l_bùªd_mŸi⁄_e°im©i⁄
 (
Ma¸oblock
 *
cuºMB
,

224 
MEBlock
 *
mv_block
,

225 
li°
,

226 
MŸi⁄Ve˘‹
 *
¥ed1
,

227 
MŸi⁄Ve˘‹
 *
¥ed2
,

228 
MŸi⁄Ve˘‹
 *
mv1
,

229 
MŸi⁄Ve˘‹
 *
mv2
,

230 
di°blk
 
mö_mco°
,

231 * 
œmbda


234 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

235 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

236 
EPZSP¨amëîs
 *
p_EPZS
 = 
cuºSli˚
->p_EPZS;

238 
li°_off£t
 = 
p_Vid
->
mb_d©a
[
cuºMB
->
mbAddrX
].list_offset;

240 
pos
, 
be°_pos
 = 0, 
£c⁄d_pos
 = 0;

241 
di°blk
 
mco°
;

242 
di°blk
 
£c⁄d_mco°
 = 
DISTBLK_MAX
;

245 
°¨t_hp
 = (
mö_mco°
 =
DISTBLK_MAX
Ë? 0 : 
p_Vid
->
°¨t_me_ªföemít_hp
;

246 
max_pos2
 = ( (!
p_Vid
->
°¨t_me_ªföemít_hp
 || !p_Vid->
°¨t_me_ªföemít_qp
Ë? 
	`imax
(1, 
mv_block
->
£¨ch_pos2
) : mv_block->search_pos2);

248 
ªf
 = 
mv_block
->
ªf_idx
;

249 
St‹abÀPi˘uª
 *
ªf_pi˘uª1
 = 
cuºSli˚
->
li°X
[
li°
 + 
li°_off£t
][
ªf
];

250 
St‹abÀPi˘uª
 *
ªf_pi˘uª2
 = 
cuºSli˚
->
li°X
[(
li°
 ^ 1Ë+ 
li°_off£t
][0];

251 
MŸi⁄Ve˘‹
 
ˇnd
;

252 
MŸi⁄Ve˘‹
 
∑dded_mv1
 = 
	`∑d_MVs
 (*
mv1
, 
mv_block
);

253 
MŸi⁄Ve˘‹
 
∑dded_mv2
 = 
	`∑d_MVs
 (*
mv2
, 
mv_block
);

254 
MŸi⁄Ve˘‹
 
¥ed_mv1
 = 
	`∑d_MVs
 (*
¥ed1
, 
mv_block
);

255 
MŸi⁄Ve˘‹
 
¥ed_mv2
 = 
	`∑d_MVs
 (*
¥ed2
, 
mv_block
);

257 
°¨t_pos
 = 5, 
íd_pos
 = 
max_pos2
;

258 
œmbda_Á˘‹
 = 
œmbda
[
H_PEL
];

259 
di°blk
 
œmbda_di°
 = 
	`weighãd_co°
(
œmbda_Á˘‹
, 2);

260 
di°blk
 
sub_thªshﬁd
 = 
p_EPZS
->
subthªs
[
mv_block
->
blockty≥
] + 
œmbda_di°
;

262 
di°blk
 
mco°2
 = 
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
∑dded_mv2
, &
¥ed_mv2
);

263 
mö_mco°
 -
mco°2
;

272 
be°_pos
 = 0, 
pos
 = 
°¨t_hp
;Öos < 5; ++pos)

274 
ˇnd
 = 
	`add_MVs
(
£¨ch_poöt_hp
[
pos
], &
∑dded_mv1
);

277 
mco°
 = 
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd
, &
¥ed_mv1
);

279 i‡(
mco°
 < 
£c⁄d_mco°
)

281 
mco°
 +
mv_block
->
	`compuãBiPªdHPñ
(
ªf_pi˘uª1
, 
ªf_pi˘uª2
, mv_block, 
£c⁄d_mco°
 - mco°, &
ˇnd
, &
∑dded_mv2
);

283 i‡(
mco°
 < 
mö_mco°
)

285 
£c⁄d_mco°
 = 
mö_mco°
;

286 
£c⁄d_pos
 = 
be°_pos
;

287 
mö_mco°
 = 
mco°
;

288 
be°_pos
 = 
pos
;

290 i‡(
mco°
 < 
£c⁄d_mco°
)

292 
£c⁄d_mco°
 = 
mco°
;

293 
£c⁄d_pos
 = 
pos
;

298 i‡(
be°_pos
 ==0 && (
¥ed1
->
mv_x
 =
mv1
->mv_xË&& (¥ed1->
mv_y
 =mv1->mv_yË&& 
mö_mco°
 < 
sub_thªshﬁd
)

300  
mö_mco°
;

303 if(
mv_block
->
£¨ch_pos2
 >= 9)

305 i‡(
be°_pos
 !=0 || (
	`übs
(
¥ed1
->
mv_x
 - 
mv1
->mv_xË+ iabs’ªd1->
mv_y
 - mv1->mv_y)))

307 
°¨t_pos
 = 
√xt_°¨t_pos
[
be°_pos
][
£c⁄d_pos
];

308 
íd_pos
 = 
√xt_íd_pos
[
be°_pos
][
£c⁄d_pos
];

310 
pos
 = 
°¨t_pos
;Öo†< 
íd_pos
; ++pos)

312 
ˇnd
 = 
	`add_MVs
(
£¨ch_poöt_hp
[
pos
], &
∑dded_mv1
);

315 
mco°
 = 
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd
, &
¥ed_mv1
);

317 i‡(
mco°
 < 
mö_mco°
)

319 
mco°
 +
mv_block
->
	`compuãBiPªdHPñ
(
ªf_pi˘uª1
, 
ªf_pi˘uª2
, mv_block, 
mö_mco°
 - mco°, &
ˇnd
, &
∑dded_mv2
);

321 i‡(
mco°
 < 
mö_mco°
)

323 
mö_mco°
 = 
mco°
;

324 
be°_pos
 = 
pos
;

331 i‡(
be°_pos
)

333 
	`add_mvs
 (
mv1
, &
£¨ch_poöt_hp
[
be°_pos
]);

334 
∑dded_mv1
 = 
	`∑d_MVs
 (*
mv1
, 
mv_block
);

342 
íd_pos
 = (
mö_mco°
 < 
sub_thªshﬁd
) ? 1 : 5;

343 
£c⁄d_mco°
 = 
DISTBLK_MAX
;

345 i‡–!
p_Vid
->
°¨t_me_ªföemít_qp
 )

347 
be°_pos
 = -1;

348 
mö_mco°
 = 
DISTBLK_MAX
;

352 
be°_pos
 = 0;

353 
mö_mco°
 +
mco°2
;

355 
œmbda_Á˘‹
 = 
œmbda
[
Q_PEL
];

356 
mco°2
 = 
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
∑dded_mv2
, &
¥ed_mv2
);

357 
mö_mco°
 -
mco°2
;

360 
pos
 = 
p_Vid
->
°¨t_me_ªföemít_qp
;Öos < 5; ++pos)

362 
ˇnd
 = 
	`add_MVs
(
£¨ch_poöt_qp
[
pos
], &
∑dded_mv1
);

365 
mco°
 = 
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd
, &
¥ed_mv1
);

367 i‡(
mco°
 < 
£c⁄d_mco°
)

369 
mco°
 +
mv_block
->
	`compuãBiPªdQPñ
(
ªf_pi˘uª1
, 
ªf_pi˘uª2
, mv_block, 
£c⁄d_mco°
 - mco°, &
ˇnd
, &
∑dded_mv2
);

371 i‡(
mco°
 < 
mö_mco°
)

373 
£c⁄d_mco°
 = 
mö_mco°
;

374 
£c⁄d_pos
 = 
be°_pos
;

375 
mö_mco°
 = 
mco°
;

376 
be°_pos
 = 
pos
;

378 i‡(
mco°
 < 
£c⁄d_mco°
)

380 
£c⁄d_mco°
 = 
mco°
;

381 
£c⁄d_pos
 = 
pos
;

386 i‡–(
mö_mco°
 > 
sub_thªshﬁd
))

389 i‡(
be°_pos
 !=0 || (
	`übs
(
¥ed1
->
mv_x
 - 
mv1
->mv_xË+ iabs’ªd1->
mv_y
 - mv1->mv_y)))

391 
°¨t_pos
 = 
√xt_°¨t_pos
[
be°_pos
][
£c⁄d_pos
];

392 
íd_pos
 = 
√xt_íd_pos
[
be°_pos
][
£c⁄d_pos
];

394 
pos
 = 
°¨t_pos
;Öo†< 
íd_pos
; ++pos)

396 
ˇnd
 = 
	`add_MVs
(
£¨ch_poöt_qp
[
pos
], &
∑dded_mv1
);

399 
mco°
 = 
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd
, &
¥ed_mv1
);

401 i‡(
mco°
 < 
mö_mco°
)

403 
mco°
 +
mv_block
->
	`compuãBiPªdQPñ
(
ªf_pi˘uª1
, 
ªf_pi˘uª2
, mv_block, 
mö_mco°
 - mco°, &
ˇnd
, &
∑dded_mv2
);

405 i‡(
mco°
 < 
mö_mco°
)

407 
mö_mco°
 = 
mco°
;

408 
be°_pos
 = 
pos
;

415 i‡(
be°_pos
)

417 
	`add_mvs
(
mv1
, &
£¨ch_poöt_qp
[
be°_pos
]);

421  
mö_mco°
 + 
mco°2
;

422 
	}
}

	@lencod/src/me_fullfast.c

17 
	~"c⁄åibut‹s.h
"

18 
	~<limôs.h
>

20 
	~"globÆ.h
"

21 
	~"image.h
"

22 
	~"memÆloc.h
"

23 
	~"mb_ac˚ss.h
"

24 
	~"ªfbuf.h
"

26 
	~"me_di°‹ti⁄.h
"

27 
	~"me_fuŒ£¨ch.h
"

28 
	~"me_fuŒÁ°.h
"

29 
	~"c⁄f‹m™˚.h
"

30 
	~"mv_£¨ch.h
"

48 
	$öôülize_Á°_fuŒ_£¨ch
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

50 
i
, 
j
, 
k
, 
li°
;

51 
£¨ch_ønge
 = 
p_I≈
->
SórchMode
[0] =
FAST_FULL_SEARCH
 ?Ö_Inp->search_range[0] :Ö_Inp->search_range[1];

52 
max_pos
 = (2*
£¨ch_ønge
+1) * (2*search_range+1);

53 
MEFuŒFa°
 *
p_me_fÁ°
 = 
NULL
;

55 i‡((
p_Vid
->
p_fÁ°_me
 = 
	`ˇŒoc
 (1,  (
MEFuŒFa°
))Ë=
NULL
)

56 
	`no_mem_exô
 ("initialize_fast_full_search:Ö_Vid->p_ffast_me");

57 
p_me_fÁ°
 = 
p_Vid
->
p_fÁ°_me
;

59 i‡((
p_me_fÁ°
->
BlockSAD
 = (
di°≥l
*****)
	`mÆloc
 (2 * (di°≥l****))Ë=
NULL
)

60 
	`no_mem_exô
 ("initialize_fast_full_search:Ö_me_ffast->BlockSAD");

62 
li°
=0;Üist<2;list++)

64 i‡((
p_me_fÁ°
->
BlockSAD
[
li°
] = (
di°≥l
****)
	`mÆloc
 ((
p_Vid
->
max_num_ª„ªn˚s
Ë* (di°≥l***))Ë=
NULL
)

65 
	`no_mem_exô
 ("initialize_fast_full_search:Ö_me_ffast->BlockSAD");

66 
i
 = 0; i < 
p_Vid
->
max_num_ª„ªn˚s
; i++)

68 i‡((
p_me_fÁ°
->
BlockSAD
[
li°
][
i
] = (
di°≥l
***)
	`mÆloc
 (8 * (di°≥l**))Ë=
NULL
)

69 
	`no_mem_exô
 ("initialize_fast_full_search:Ö_me_ffast->BlockSAD");

70 
j
 = 1; j < 8; j++)

72 i‡((
p_me_fÁ°
->
BlockSAD
[
li°
][
i
][
j
] = (
di°≥l
**)
	`mÆloc
 (16 * (di°≥l*))Ë=
NULL
)

73 
	`no_mem_exô
 ("initialize_fast_full_search:Ö_me_ffast->BlockSAD");

74 
k
 = 0; k < 16; k++)

76 i‡((
p_me_fÁ°
->
BlockSAD
[
li°
][
i
][
j
][
k
] = (
di°≥l
*)
	`mÆloc
 (
max_pos
 * (di°≥l))Ë=
NULL
)

77 
	`no_mem_exô
 ("initialize_fast_full_search:Ö_me_ffast->BlockSAD");

83 i‡((
p_me_fÁ°
->
£¨ch_£tup_d⁄e
 = (**)
	`mÆloc
 (2*(*)))==
NULL
)

84 
	`no_mem_exô
 ("initialize_fast_full_search:Ö_me_ffast->search_setup_done");

85 i‡((
p_me_fÁ°
->
£¨ch_˚¡î
 = (
MŸi⁄Ve˘‹
**Ë
	`mÆloc
 (2 * (MŸi⁄Ve˘‹*)))==
NULL
)

86 
	`no_mem_exô
 ("initialize_fast_full_search:Ö_me_ffast->search_center");

87 i‡((
p_me_fÁ°
->
£¨ch_˚¡î_∑dded
 = (
MŸi⁄Ve˘‹
**Ë
	`mÆloc
 (2 * (MŸi⁄Ve˘‹*)))==
NULL
)

88 
	`no_mem_exô
 ("initialize_fast_full_search:Ö_me_ffast->search_center_padded");

90 i‡((
p_me_fÁ°
->
pos_00
 = (**)
	`mÆloc
 (2*(*)))==
NULL
)

91 
	`no_mem_exô
 ("initialize_fast_full_search:Ö_me_ffast->pos_00");

92 i‡((
p_me_fÁ°
->
max_£¨ch_ønge
 = (**)
	`mÆloc
 (2*(*)))==
NULL
)

93 
	`no_mem_exô
 ("initialize_fast_full_search:Ö_me_ffast->max_search_range");

95 
li°
=0;Üist<2;Üist++)

97 i‡((
p_me_fÁ°
->
£¨ch_£tup_d⁄e
[
li°
] = (*)
	`mÆloc
 ((
p_Vid
->
max_num_ª„ªn˚s
)*()))==
NULL
)

98 
	`no_mem_exô
 ("initialize_fast_full_search:Ö_me_ffast->search_setup_done");

99 i‡((
p_me_fÁ°
->
£¨ch_˚¡î
[
li°
] = (
MŸi⁄Ve˘‹
*Ë
	`mÆloc
 ((
p_Vid
->
max_num_ª„ªn˚s
Ë* (MŸi⁄Ve˘‹)))==
NULL
)

100 
	`no_mem_exô
 ("initialize_fast_full_search:Ö_me_ffast->search_center");

101 i‡((
p_me_fÁ°
->
£¨ch_˚¡î_∑dded
[
li°
] = (
MŸi⁄Ve˘‹
*Ë
	`mÆloc
 ((
p_Vid
->
max_num_ª„ªn˚s
Ë* (MŸi⁄Ve˘‹)))==
NULL
)

102 
	`no_mem_exô
 ("initialize_fast_full_search:Ö_me_ffast->search_center_padded");

105 i‡((
p_me_fÁ°
->
pos_00
[
li°
] = (*)
	`mÆloc
 ((
p_Vid
->
max_num_ª„ªn˚s
)*()))==
NULL
)

106 
	`no_mem_exô
 ("initialize_fast_full_search:Ö_me_ffast->pos_00");

107 i‡((
p_me_fÁ°
->
max_£¨ch_ønge
[
li°
] = (*)
	`mÆloc
 ((
p_Vid
->
max_num_ª„ªn˚s
)*()))==
NULL
)

108 
	`no_mem_exô
 ("initialize_fast_full_search:Ö_me_ffast->max_search_range");

112 i‡(
p_I≈
->
fuŒ_£¨ch
 == 2)

114 
li°
=0;list<2;list++)

115 
i
=0; i<
p_Vid
->
max_num_ª„ªn˚s
; i++)

116 
p_me_fÁ°
->
max_£¨ch_ønge
[
li°
][
i
] = 
£¨ch_ønge
;

120 
li°
=0;list<2;list++)

122 
p_me_fÁ°
->
max_£¨ch_ønge
[
li°
][0] = 
£¨ch_ønge
;

123 
i
=1; i< 
p_Vid
->
max_num_ª„ªn˚s
; i++Ë
p_me_fÁ°
->
max_£¨ch_ønge
[
li°
][i] = 
£¨ch_ønge
 / 2;

126 
	}
}

135 
	$˛ór_Á°_fuŒ_£¨ch
 (
VideoP¨amëîs
 *
p_Vid
)

137 
i
, 
j
, 
k
, 
li°
;

138 
MEFuŒFa°
 *
p_me_fÁ°
 = 
p_Vid
->
p_fÁ°_me
;

140 
li°
=0;Üist<2;Üist++)

142 
i
 = 0; i < 
p_Vid
->
max_num_ª„ªn˚s
; i++)

144 
j
 = 1; j < 8; j++)

146 
k
 = 0; k < 16; k++)

148 
	`‰ì
 (
p_me_fÁ°
->
BlockSAD
[
li°
][
i
][
j
][
k
]);

150 
	`‰ì
 (
p_me_fÁ°
->
BlockSAD
[
li°
][
i
][
j
]);

152 
	`‰ì
 (
p_me_fÁ°
->
BlockSAD
[
li°
][
i
]);

154 
	`‰ì
 (
p_me_fÁ°
->
BlockSAD
[
li°
]);

156 
	`‰ì
 (
p_me_fÁ°
->
BlockSAD
);

158 
li°
=0;Üist<2;Üist++)

160 
	`‰ì
 (
p_me_fÁ°
->
£¨ch_£tup_d⁄e
[
li°
]);

161 
	`‰ì
 (
p_me_fÁ°
->
£¨ch_˚¡î_∑dded
[
li°
]);

162 
	`‰ì
 (
p_me_fÁ°
->
£¨ch_˚¡î
[
li°
]);

163 
	`‰ì
 (
p_me_fÁ°
->
pos_00
[
li°
]);

164 
	`‰ì
 (
p_me_fÁ°
->
max_£¨ch_ønge
[
li°
]);

166 
	`‰ì
 (
p_me_fÁ°
->
£¨ch_£tup_d⁄e
);

167 
	`‰ì
 (
p_me_fÁ°
->
£¨ch_˚¡î_∑dded
);

168 
	`‰ì
 (
p_me_fÁ°
->
£¨ch_˚¡î
);

169 
	`‰ì
 (
p_me_fÁ°
->
pos_00
);

170 
	`‰ì
 (
p_me_fÁ°
->
max_£¨ch_ønge
);

171 
	`‰ì
 (
p_me_fÁ°
);

173 
	}
}

183 
	$ª£t_Á°_fuŒ_£¨ch
 (
VideoP¨amëîs
 *
p_Vid
)

185 
li°
;

186 
li°
=0;Üist<2;Üist++)

187 
	`mem£t
(&
p_Vid
->
p_fÁ°_me
->
£¨ch_£tup_d⁄e
 [
li°
][0], 0,Ö_Vid->
max_num_ª„ªn˚s
 * ());

188 
	}
}

196 
	$upd©e_fuŒ_£¨ch_œrge_blocks
 (
MEFuŒFa°
 *
p_fÁ°_me
, 
li°
, 
ªfödex
, 
max_pos
)

198 
	#ADD_UP_BLOCKS
(Ë
_o
=*
_bo
; 
_i
=*
_bi
; 
_j
=*
_bj
; 
pos
=0;pos<
max_pos
;pos++Ë_o[pos] = _i[pos] + _j[pos];

	)

199 
	#INCREMENT
(
öc
Ë
_bo
+=öc; 
_bi
+=öc; 
_bj
+=öc;

	)

200 
di°≥l
 *****
BlockSAD
 = 
p_fÁ°_me
->BlockSAD;

202 
pos
;

203 
di°≥l
 **
_bo
, **
_bi
, **
_bj
;

204 
di°≥l
 *
_o
, *
_i
, *
_j
;

207 
_bo
 = 
BlockSAD
[
li°
][
ªfödex
][6];

208 
_bi
 = 
BlockSAD
[
li°
][
ªfödex
][7];

209 
_bj
 = 
_bi
 + 4;

210 
	`ADD_UP_BLOCKS
(); 
	`INCREMENT
(1);

211 
	`ADD_UP_BLOCKS
(); 
	`INCREMENT
(1);

212 
	`ADD_UP_BLOCKS
(); 
	`INCREMENT
(1);

213 
	`ADD_UP_BLOCKS
(); 
	`INCREMENT
(5);

214 
	`ADD_UP_BLOCKS
(); 
	`INCREMENT
(1);

215 
	`ADD_UP_BLOCKS
(); 
	`INCREMENT
(1);

216 
	`ADD_UP_BLOCKS
(); 
	`INCREMENT
(1);

217 
	`ADD_UP_BLOCKS
();

220 
_bo
 = 
BlockSAD
[
li°
][
ªfödex
][5];

221 
_bi
 = 
BlockSAD
[
li°
][
ªfödex
][7];

222 
_bj
 = 
_bi
 + 1;

223 
	`ADD_UP_BLOCKS
(); 
	`INCREMENT
(2);

224 
	`ADD_UP_BLOCKS
(); 
	`INCREMENT
(2);

225 
	`ADD_UP_BLOCKS
(); 
	`INCREMENT
(2);

226 
	`ADD_UP_BLOCKS
(); 
	`INCREMENT
(2);

227 
	`ADD_UP_BLOCKS
(); 
	`INCREMENT
(2);

228 
	`ADD_UP_BLOCKS
(); 
	`INCREMENT
(2);

229 
	`ADD_UP_BLOCKS
(); 
	`INCREMENT
(2);

230 
	`ADD_UP_BLOCKS
();

233 
_bo
 = 
BlockSAD
[
li°
][
ªfödex
][4];

234 
_bi
 = 
BlockSAD
[
li°
][
ªfödex
][6];

235 
_bj
 = 
_bi
 + 1;

236 
	`ADD_UP_BLOCKS
(); 
	`INCREMENT
(2);

237 
	`ADD_UP_BLOCKS
(); 
	`INCREMENT
(6);

238 
	`ADD_UP_BLOCKS
(); 
	`INCREMENT
(2);

239 
	`ADD_UP_BLOCKS
();

242 
_bo
 = 
BlockSAD
[
li°
][
ªfödex
][3];

243 
_bi
 = 
BlockSAD
[
li°
][
ªfödex
][4];

244 
_bj
 = 
_bi
 + 8;

245 
	`ADD_UP_BLOCKS
(); 
	`INCREMENT
(2);

246 
	`ADD_UP_BLOCKS
();

249 
_bo
 = 
BlockSAD
[
li°
][
ªfödex
][2];

250 
_bi
 = 
BlockSAD
[
li°
][
ªfödex
][4];

251 
_bj
 = 
_bi
 + 2;

252 
	`ADD_UP_BLOCKS
(); 
	`INCREMENT
(8);

253 
	`ADD_UP_BLOCKS
();

256 
_bo
 = 
BlockSAD
[
li°
][
ªfödex
][1];

257 
_bi
 = 
BlockSAD
[
li°
][
ªfödex
][3];

258 
_bj
 = 
_bi
 + 2;

259 
	`ADD_UP_BLOCKS
();

260 
	}
}

269 
	$£tup_Á°_fuŒ_£¨ch
 (
Ma¸oblock
 *
cuºMB
, 
MEBlock
 *
mv_block
, 
li°
)

271 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

272 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

273 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºSli˚
->p_Inp;

274 (*
di°_mëhod
Ë(
x
Ë
p_I≈
->
MEEº‹Mëric
[0] ? 
übs2
 : 
übs
;

275 #i‡(
JM_MEM_DISTORTION
)

276 * 
img≥l_di°
 = 
p_I≈
->
MEEº‹Mëric
[0] ? 
p_Vid
->
img≥l_quad
 :Ö_Vid->
img≥l_abs
;

278 
MŸi⁄Ve˘‹
 
pmv
;

279 
img≥l
 
‹ig_≥ls
[768];

280 
img≥l
 *
§˝å
 = 
‹ig_≥ls
, *
ªÂå
;

281 
k
, 
x
, 
y
;

282 
MŸi⁄Ve˘‹
 
ˇnd
, 
off£t
;

283 
ªf_x
, 
ªf_y
, 
pos
, 
bödex
, 
blky
;

284 
di°blk
 
LöeSadBlk0
, 
LöeSadBlk1
, 
LöeSadBlk2
, 
LöeSadBlk3
;

285 
PixñPos
 
block
[4];

286 
MEFuŒFa°
 *
p_me_fÁ°
 = 
p_Vid
->
p_fÁ°_me
;

289 
ªf
 = 
mv_block
->
ªf_idx
;

290 
di°≥l
** 
block_ßd
 = 
p_me_fÁ°
->
BlockSAD
[
li°
][
ªf
][7];

291 
£¨ch_ønge
 = 
p_me_fÁ°
->
max_£¨ch_ønge
[
li°
][
ªf
];

292 
max_pos
 = (2*
£¨ch_ønge
+1) * (2*search_range+1);

294 
li°_off£t
 = 
p_Vid
->
mb_d©a
[
cuºMB
->
mbAddrX
].list_offset;

295 
≠∂y_weights
 = ( (
p_Vid
->
a˘ive_µs
->
weighãd_¥ed_Êag
 && (
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
 || (cuºSli˚->¶i˚_ty≥ =
SP_SLICE
))) ||

296 (
p_Vid
->
a˘ive_µs
->
weighãd_bùªd_idc
 && (
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
))Ë&& 
p_I≈
->
U£WeighãdRe„ªn˚ME
;

297 
weighãd_≥l
;

298 
St‹abÀPi˘uª
 *
ªf_pi˘uª
 = 
cuºSli˚
->
li°X
[
li°
+
li°_off£t
][
ªf
];

300 
wp_luma_round
 = 0;

301 
luma_log_weight_díom
 = 5;

302 
chroma_log_weight_díom
 = 5;

303 
wp_chroma_round
 = 0;

304 
weight_luma
 = 
mv_block
->weight_luma, 
weight_¸
[2];

305 
off£t_luma
 = 
mv_block
->off£t_luma, 
off£t_¸
[2];

306 
£¨ch_ønge
 <<= 2;

309 
	`gë_√ighb‹s
(
cuºMB
, 
block
, 0, 0, 16);

310 
cuºMB
->
	`GëMVPªdi˘‹
 (cuºMB, 
block
, &
pmv
, 
ªf
, 
p_Vid
->
íc_pi˘uª
->
mv_öfo
, 
li°
, 0, 0, 16, 16);

312 #i‡(
JM_INT_DIVIDE
)

313 
p_Vid
->
p_fÁ°_me
->
£¨ch_˚¡î
[
li°
][
ªf
].
mv_x
 = ((
pmv
.mv_x + 2) >> 2) * 4;

314 
p_Vid
->
p_fÁ°_me
->
£¨ch_˚¡î
[
li°
][
ªf
].
mv_y
 = ((
pmv
.mv_y + 2) >> 2) * 4;

316 
p_Vid
->
p_fÁ°_me
->
£¨ch_˚¡î
[
li°
][
ªf
].
mv_x
 = (
pmv
.mv_x / 4) * 4;

317 
p_Vid
->
p_fÁ°_me
->
£¨ch_˚¡î
[
li°
][
ªf
].
mv_y
 = (
pmv
.mv_y / 4) * 4;

319 i‡(!
p_I≈
->
rd›t
)

322 
p_Vid
->
p_fÁ°_me
->
£¨ch_˚¡î
[
li°
][
ªf
].
mv_x
 = (Ë
	`iClù3
(-
£¨ch_ønge
, search_range,Ö_Vid->p_ffast_me->search_center[list][ref].mv_x);

323 
p_Vid
->
p_fÁ°_me
->
£¨ch_˚¡î
[
li°
][
ªf
].
mv_y
 = (Ë
	`iClù3
(-
£¨ch_ønge
, search_range,Ö_Vid->p_ffast_me->search_center[list][ref].mv_y);

326 
p_Vid
->
p_fÁ°_me
->
£¨ch_˚¡î
[
li°
][
ªf
].
mv_x
 = (Ë
	`iClù3
’_Vid->
MaxHmvR
[4] + 
£¨ch_ønge
,Ö_Vid->MaxHmvR[5] - search_range,Ö_Vid->p_ffast_me->search_center[list][ref].mv_x);

327 
p_Vid
->
p_fÁ°_me
->
£¨ch_˚¡î
[
li°
][
ªf
].
mv_y
 = (Ë
	`iClù3
’_Vid->
MaxVmvR
[4] + 
£¨ch_ønge
,Ö_Vid->MaxVmvR[5] - search_range,Ö_Vid->p_ffast_me->search_center[list][ref].mv_y);

329 
p_Vid
->
p_fÁ°_me
->
£¨ch_˚¡î_∑dded
[
li°
][
ªf
] = 
	`∑d_MVs
’_Vid->p_fÁ°_me->
£¨ch_˚¡î
[li°][ªf], 
mv_block
);

331 
off£t
 = 
p_Vid
->
p_fÁ°_me
->
£¨ch_˚¡î_∑dded
[
li°
][
ªf
];

333 
y
 = 
cuºMB
->
›ix_y
; y < cuºMB->›ix_y + 
MB_BLOCK_SIZE
; y++)

335 
	`mem˝y
(
§˝å
, &
p_Vid
->
pCurImg
[
y
][
cuºMB
->
pix_x
], 
MB_BLOCK_SIZE
 * (
img≥l
));

336 
§˝å
 +
MB_BLOCK_SIZE
;

339 i‡–
mv_block
->
ChromaMEE«bÀ
)

341 
k
 = 1; k < 3; k++)

343 
y
 = 
cuºMB
->
›ix_c_y
; y < cuºMB->›ix_c_y + 
p_Vid
->
mb_¸_size_y
; y++)

345 
	`mem˝y
(
§˝å
, &
p_Vid
->
pImgOrg
[
k
][
y
][
cuºMB
->
pix_c_x
],Ö_Vid->
mb_¸_size_x
 * (
img≥l
));

346 
§˝å
 +
p_Vid
->
mb_¸_size_x
;

353 i‡(!
p_I≈
->
rd›t
)

355 
ªf_x
 = 
mv_block
->
pos_x_∑dded
 - 
off£t
.
mv_x
;

356 
ªf_y
 = 
mv_block
->
pos_y_∑dded
 - 
off£t
.
mv_y
;

358 
pos
 = 0;Öo†< 
max_pos
;Öos++)

360 i‡(
ªf_x
 =
p_Vid
->
•úÆ_q≥l_£¨ch
[
pos
].
mv_x
 && 
ªf_y
 =p_Vid->•úÆ_q≥l_£¨ch[pos].
mv_y
)

362 
p_me_fÁ°
->
pos_00
[
li°
][
ªf
] = 
pos
;

369 i‡(
≠∂y_weights
)

371 
weight_luma
 = 
cuºSli˚
->
wp_weight
[
li°
 + 
li°_off£t
][
ªf
][0];

372 
off£t_luma
 = 
cuºSli˚
->
wp_off£t
[
li°
 + 
li°_off£t
][
ªf
][0];

373 
wp_luma_round
 = 
cuºSli˚
->wp_luma_round;

374 
luma_log_weight_díom
 = 
cuºSli˚
->luma_log_weight_denom;

375 
chroma_log_weight_díom
 = 
cuºSli˚
->chroma_log_weight_denom;

376 
wp_chroma_round
 = 
cuºSli˚
->wp_chroma_round;

378 i‡(
mv_block
->
ChromaMEE«bÀ
)

380 
weight_¸
[0] = 
cuºSli˚
->
wp_weight
[
li°
 + 
li°_off£t
][
ªf
][1];

381 
weight_¸
[1] = 
cuºSli˚
->
wp_weight
[
li°
 + 
li°_off£t
][
ªf
][2];

382 
off£t_¸
[0] = 
cuºSli˚
->
wp_off£t
[
li°
 + 
li°_off£t
][
ªf
][1];

383 
off£t_¸
[1] = 
cuºSli˚
->
wp_off£t
[
li°
 + 
li°_off£t
][
ªf
][2];

386 
pos
 = 0;Öo†< 
max_pos
;Öos++)

388 
ˇnd
 = 
	`add_MVs
(
off£t
, &
p_Vid
->
•úÆ_q≥l_£¨ch
[
pos
]);

390 
§˝å
 = 
‹ig_≥ls
;

391 
bödex
 = 0;

393 
ªÂå
 = 
	`UMVLöe4X
 (
ªf_pi˘uª
, 
ˇnd
.
mv_y
, c™d.
mv_x
);

395 
blky
 = 0; blky < 4; blky++)

397 
LöeSadBlk0
 = 
LöeSadBlk1
 = 
LöeSadBlk2
 = 
LöeSadBlk3
 = 0;

399 
y
 = 0; y < 4; y++)

401 
weighãd_≥l
 = 
	`iClù1
–
p_Vid
->
max_img≥l_vÆue
, ((
weight_luma
 * *
ªÂå
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t_luma
);

402 
LöeSadBlk0
 +
	`di°_mëhod
 (
weighãd_≥l
 - *
§˝å
++);

403 
weighãd_≥l
 = 
	`iClù1
–
p_Vid
->
max_img≥l_vÆue
, ((
weight_luma
 * *
ªÂå
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t_luma
);

404 
LöeSadBlk0
 +
	`di°_mëhod
 (
weighãd_≥l
 - *
§˝å
++);

405 
weighãd_≥l
 = 
	`iClù1
–
p_Vid
->
max_img≥l_vÆue
, ((
weight_luma
 * *
ªÂå
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t_luma
);

406 
LöeSadBlk0
 +
	`di°_mëhod
 (
weighãd_≥l
 - *
§˝å
++);

407 
weighãd_≥l
 = 
	`iClù1
–
p_Vid
->
max_img≥l_vÆue
, ((
weight_luma
 * *
ªÂå
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t_luma
);

408 
LöeSadBlk0
 +
	`di°_mëhod
 (
weighãd_≥l
 - *
§˝å
++);

409 
weighãd_≥l
 = 
	`iClù1
–
p_Vid
->
max_img≥l_vÆue
, ((
weight_luma
 * *
ªÂå
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t_luma
);

410 
LöeSadBlk1
 +
	`di°_mëhod
 (
weighãd_≥l
 - *
§˝å
++);

411 
weighãd_≥l
 = 
	`iClù1
–
p_Vid
->
max_img≥l_vÆue
, ((
weight_luma
 * *
ªÂå
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t_luma
);

412 
LöeSadBlk1
 +
	`di°_mëhod
 (
weighãd_≥l
 - *
§˝å
++);

413 
weighãd_≥l
 = 
	`iClù1
–
p_Vid
->
max_img≥l_vÆue
, ((
weight_luma
 * *
ªÂå
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t_luma
);

414 
LöeSadBlk1
 +
	`di°_mëhod
 (
weighãd_≥l
 - *
§˝å
++);

415 
weighãd_≥l
 = 
	`iClù1
–
p_Vid
->
max_img≥l_vÆue
, ((
weight_luma
 * *
ªÂå
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t_luma
);

416 
LöeSadBlk1
 +
	`di°_mëhod
 (
weighãd_≥l
 - *
§˝å
++);

417 
weighãd_≥l
 = 
	`iClù1
–
p_Vid
->
max_img≥l_vÆue
, ((
weight_luma
 * *
ªÂå
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t_luma
);

418 
LöeSadBlk2
 +
	`di°_mëhod
 (
weighãd_≥l
 - *
§˝å
++);

419 
weighãd_≥l
 = 
	`iClù1
–
p_Vid
->
max_img≥l_vÆue
, ((
weight_luma
 * *
ªÂå
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t_luma
);

420 
LöeSadBlk2
 +
	`di°_mëhod
 (
weighãd_≥l
 - *
§˝å
++);

421 
weighãd_≥l
 = 
	`iClù1
–
p_Vid
->
max_img≥l_vÆue
, ((
weight_luma
 * *
ªÂå
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t_luma
);

422 
LöeSadBlk2
 +
	`di°_mëhod
 (
weighãd_≥l
 - *
§˝å
++);

423 
weighãd_≥l
 = 
	`iClù1
–
p_Vid
->
max_img≥l_vÆue
, ((
weight_luma
 * *
ªÂå
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t_luma
);

424 
LöeSadBlk2
 +
	`di°_mëhod
 (
weighãd_≥l
 - *
§˝å
++);

425 
weighãd_≥l
 = 
	`iClù1
–
p_Vid
->
max_img≥l_vÆue
, ((
weight_luma
 * *
ªÂå
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t_luma
);

426 
LöeSadBlk3
 +
	`di°_mëhod
 (
weighãd_≥l
 - *
§˝å
++);

427 
weighãd_≥l
 = 
	`iClù1
–
p_Vid
->
max_img≥l_vÆue
, ((
weight_luma
 * *
ªÂå
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t_luma
);

428 
LöeSadBlk3
 +
	`di°_mëhod
 (
weighãd_≥l
 - *
§˝å
++);

429 
weighãd_≥l
 = 
	`iClù1
–
p_Vid
->
max_img≥l_vÆue
, ((
weight_luma
 * *
ªÂå
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t_luma
);

430 
LöeSadBlk3
 +
	`di°_mëhod
 (
weighãd_≥l
 - *
§˝å
++);

431 
weighãd_≥l
 = 
	`iClù1
–
p_Vid
->
max_img≥l_vÆue
, ((
weight_luma
 * *
ªÂå
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t_luma
);

432 
LöeSadBlk3
 +
	`di°_mëhod
 (
weighãd_≥l
 - *
§˝å
++);

433 
ªÂå
 +
p_Vid
->
∑dded_size_x
 - 
MB_BLOCK_SIZE
;

435 
block_ßd
[
bödex
++][
pos
] = (
di°≥l
Ë
LöeSadBlk0
;

436 
block_ßd
[
bödex
++][
pos
] = (
di°≥l
Ë
LöeSadBlk1
;

437 
block_ßd
[
bödex
++][
pos
] = (
di°≥l
Ë
LöeSadBlk2
;

438 
block_ßd
[
bödex
++][
pos
] = (
di°≥l
Ë
LöeSadBlk3
;

441 i‡(
mv_block
->
ChromaMEE«bÀ
)

443 
max_img≥l_vÆue_uv
 = 
p_Vid
->
max_≥l_vÆue_comp
[1];

444 
k
 = 0; k < 2; k ++)

446 
bödex
 = 0;

448 
ªÂå
 = 
	`UMVLöe8X_chroma
 (
ªf_pi˘uª
, 
k
+1, 
ˇnd
.
mv_y
, c™d.
mv_x
);

449 
blky
 = 0; blky < 4; blky++)

451 
LöeSadBlk0
 = 
LöeSadBlk1
 = 
LöeSadBlk2
 = 
LöeSadBlk3
 = 0;

453 
y
 = 0; y < 
p_Vid
->
mb_¸_size_y
; y+=
BLOCK_SIZE
)

455 
x
 = 0; x < 
p_Vid
->
mb_¸_size_x
; x +
BLOCK_SIZE
)

457 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue_uv
, ((
weight_¸
[
k
] * *
ªÂå
++ + 
wp_chroma_round
Ë>> 
chroma_log_weight_díom
Ë+ 
off£t_¸
[k]);

458 
LöeSadBlk0
 +
	`di°_mëhod
 (
weighãd_≥l
 - *
§˝å
++);

460 
x
 = 0; x < 
p_Vid
->
mb_¸_size_x
; x +
BLOCK_SIZE
)

462 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue_uv
, ((
weight_¸
[
k
] * *
ªÂå
++ + 
wp_chroma_round
Ë>> 
chroma_log_weight_díom
Ë+ 
off£t_¸
[k]);

463 
LöeSadBlk1
 +
	`di°_mëhod
 (
weighãd_≥l
 - *
§˝å
++);

465 
x
 = 0; x < 
p_Vid
->
mb_¸_size_x
; x +
BLOCK_SIZE
)

467 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue_uv
, ((
weight_¸
[
k
] * *
ªÂå
++ + 
wp_chroma_round
Ë>> 
chroma_log_weight_díom
Ë+ 
off£t_¸
[k]);

468 
LöeSadBlk2
 +
	`di°_mëhod
 (
weighãd_≥l
 - *
§˝å
++);

470 
x
 = 0; x < 
p_Vid
->
mb_¸_size_x
; x +
BLOCK_SIZE
)

472 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue_uv
, ((
weight_¸
[
k
] * *
ªÂå
++ + 
wp_chroma_round
Ë>> 
chroma_log_weight_díom
Ë+ 
off£t_¸
[k]);

473 
LöeSadBlk3
 +
	`di°_mëhod
 (
weighãd_≥l
 - *
§˝å
++);

475 
ªÂå
 +
p_Vid
->
¸_∑dded_size_x
 -Ö_Vid->
mb_¸_size_x
;

477 
block_ßd
[
bödex
][
pos
] = block_ßd[bödex][pos] + ((
di°≥l
Ë
LöeSadBlk0
);

478 ++
bödex
;

479 
block_ßd
[
bödex
][
pos
] = block_ßd[bödex][pos] + ((
di°≥l
Ë
LöeSadBlk1
);

480 ++
bödex
;

481 
block_ßd
[
bödex
][
pos
] = block_ßd[bödex][pos] + ((
di°≥l
Ë
LöeSadBlk2
);

482 ++
bödex
;

483 
block_ßd
[
bödex
][
pos
] = block_ßd[bödex][pos] + ((
di°≥l
Ë
LöeSadBlk3
);

484 ++
bödex
;

492 
pos
 = 0;Öo†< 
max_pos
;Öos++)

494 
ˇnd
 = 
	`add_MVs
(
off£t
, &
p_Vid
->
•úÆ_q≥l_£¨ch
[
pos
]);

495 
§˝å
 = 
‹ig_≥ls
;

496 
bödex
 = 0;

498 
ªÂå
 = 
	`UMVLöe4X
 (
ªf_pi˘uª
, 
ˇnd
.
mv_y
, c™d.
mv_x
);

500 
blky
 = 0; blky < 4; blky++)

502 
LöeSadBlk0
 = 
LöeSadBlk1
 = 
LöeSadBlk2
 = 
LöeSadBlk3
 = 0;

504 
y
 = 0; y < 4; y++)

506 #i‡(
JM_MEM_DISTORTION
)

508 
LöeSadBlk0
 +
img≥l_di°
[ *
ªÂå
++ - *
§˝å
++ ];

509 
LöeSadBlk0
 +
img≥l_di°
[ *
ªÂå
++ - *
§˝å
++ ];

510 
LöeSadBlk0
 +
img≥l_di°
[ *
ªÂå
++ - *
§˝å
++ ];

511 
LöeSadBlk0
 +
img≥l_di°
[ *
ªÂå
++ - *
§˝å
++ ];

513 
LöeSadBlk1
 +
img≥l_di°
[ *
ªÂå
++ - *
§˝å
++ ];

514 
LöeSadBlk1
 +
img≥l_di°
[ *
ªÂå
++ - *
§˝å
++ ];

515 
LöeSadBlk1
 +
img≥l_di°
[ *
ªÂå
++ - *
§˝å
++ ];

516 
LöeSadBlk1
 +
img≥l_di°
[ *
ªÂå
++ - *
§˝å
++ ];

518 
LöeSadBlk2
 +
img≥l_di°
[ *
ªÂå
++ - *
§˝å
++ ];

519 
LöeSadBlk2
 +
img≥l_di°
[ *
ªÂå
++ - *
§˝å
++ ];

520 
LöeSadBlk2
 +
img≥l_di°
[ *
ªÂå
++ - *
§˝å
++ ];

521 
LöeSadBlk2
 +
img≥l_di°
[ *
ªÂå
++ - *
§˝å
++ ];

523 
LöeSadBlk3
 +
img≥l_di°
[ *
ªÂå
++ - *
§˝å
++ ];

524 
LöeSadBlk3
 +
img≥l_di°
[ *
ªÂå
++ - *
§˝å
++ ];

525 
LöeSadBlk3
 +
img≥l_di°
[ *
ªÂå
++ - *
§˝å
++ ];

526 
LöeSadBlk3
 +
img≥l_di°
[ *
ªÂå
++ - *
§˝å
++ ];

529 
LöeSadBlk0
 +
	`di°_mëhod
 (*
ªÂå
++ - *
§˝å
++);

530 
LöeSadBlk0
 +
	`di°_mëhod
 (*
ªÂå
++ - *
§˝å
++);

531 
LöeSadBlk0
 +
	`di°_mëhod
 (*
ªÂå
++ - *
§˝å
++);

532 
LöeSadBlk0
 +
	`di°_mëhod
 (*
ªÂå
++ - *
§˝å
++);

534 
LöeSadBlk1
 +
	`di°_mëhod
 (*
ªÂå
++ - *
§˝å
++);

535 
LöeSadBlk1
 +
	`di°_mëhod
 (*
ªÂå
++ - *
§˝å
++);

536 
LöeSadBlk1
 +
	`di°_mëhod
 (*
ªÂå
++ - *
§˝å
++);

537 
LöeSadBlk1
 +
	`di°_mëhod
 (*
ªÂå
++ - *
§˝å
++);

539 
LöeSadBlk2
 +
	`di°_mëhod
 (*
ªÂå
++ - *
§˝å
++);

540 
LöeSadBlk2
 +
	`di°_mëhod
 (*
ªÂå
++ - *
§˝å
++);

541 
LöeSadBlk2
 +
	`di°_mëhod
 (*
ªÂå
++ - *
§˝å
++);

542 
LöeSadBlk2
 +
	`di°_mëhod
 (*
ªÂå
++ - *
§˝å
++);

544 
LöeSadBlk3
 +
	`di°_mëhod
 (*
ªÂå
++ - *
§˝å
++);

545 
LöeSadBlk3
 +
	`di°_mëhod
 (*
ªÂå
++ - *
§˝å
++);

546 
LöeSadBlk3
 +
	`di°_mëhod
 (*
ªÂå
++ - *
§˝å
++);

547 
LöeSadBlk3
 +
	`di°_mëhod
 (*
ªÂå
++ - *
§˝å
++);

550 
ªÂå
 +
p_Vid
->
∑dded_size_x
 - 
MB_BLOCK_SIZE
;

552 
block_ßd
[
bödex
++][
pos
] = (
di°≥l
Ë
LöeSadBlk0
;

553 
block_ßd
[
bödex
++][
pos
] = (
di°≥l
Ë
LöeSadBlk1
;

554 
block_ßd
[
bödex
++][
pos
] = (
di°≥l
Ë
LöeSadBlk2
;

555 
block_ßd
[
bödex
++][
pos
] = (
di°≥l
Ë
LöeSadBlk3
;

558 i‡(
mv_block
->
ChromaMEE«bÀ
)

560 
k
 = 0; k < 2; k ++)

562 
bödex
 = 0;

564 
ªÂå
 = 
	`UMVLöe8X_chroma
 (
ªf_pi˘uª
, 
k
+1, 
ˇnd
.
mv_y
, c™d.
mv_x
);

565 
blky
 = 0; blky < 4; blky++)

567 
LöeSadBlk0
 = 
LöeSadBlk1
 = 
LöeSadBlk2
 = 
LöeSadBlk3
 = 0;

569 
y
 = 0; y < 
p_Vid
->
mb_¸_size_y
; y+=
BLOCK_SIZE
)

571 
x
 = 0; x < 
p_Vid
->
mb_¸_size_x
; x +
BLOCK_SIZE
)

573 
LöeSadBlk0
 +
	`di°_mëhod
 (*
ªÂå
++ - *
§˝å
++);

575 
x
 = 0; x < 
p_Vid
->
mb_¸_size_x
; x +
BLOCK_SIZE
)

577 
LöeSadBlk1
 +
	`di°_mëhod
 (*
ªÂå
++ - *
§˝å
++);

579 
x
 = 0; x < 
p_Vid
->
mb_¸_size_x
; x +
BLOCK_SIZE
)

581 
LöeSadBlk2
 +
	`di°_mëhod
 (*
ªÂå
++ - *
§˝å
++);

583 
x
 = 0; x < 
p_Vid
->
mb_¸_size_x
; x +
BLOCK_SIZE
)

585 
LöeSadBlk3
 +
	`di°_mëhod
 (*
ªÂå
++ - *
§˝å
++);

587 
ªÂå
 +
p_Vid
->
¸_∑dded_size_x
 -Ö_Vid->
mb_¸_size_x
;

589 
block_ßd
[
bödex
][
pos
] = block_ßd[bödex][pos] + ((
di°≥l
Ë
LöeSadBlk0
);

590 ++
bödex
;

591 
block_ßd
[
bödex
][
pos
] = block_ßd[bödex][pos] + ((
di°≥l
Ë
LöeSadBlk1
);

592 ++
bödex
;

593 
block_ßd
[
bödex
][
pos
] = block_ßd[bödex][pos] + ((
di°≥l
Ë
LöeSadBlk2
);

594 ++
bödex
;

595 
block_ßd
[
bödex
][
pos
] = block_ßd[bödex][pos] + ((
di°≥l
Ë
LöeSadBlk3
);

596 ++
bödex
;

604 
	`upd©e_fuŒ_£¨ch_œrge_blocks
 (
p_Vid
->
p_fÁ°_me
, 
li°
, 
ªf
, 
max_pos
);

607 
p_Vid
->
p_fÁ°_me
->
£¨ch_£tup_d⁄e
[
li°
][
ªf
] = 1;

608 
	}
}

617 
di°blk


618 
	$Á°_fuŒ_£¨ch_mŸi⁄_e°im©i⁄
 (
Ma¸oblock
 *
cuºMB
,

619 
MŸi⁄Ve˘‹
 *
¥ed_mv
,

620 
MEBlock
 *
mv_block
,

621 
di°blk
 
mö_mco°
,

622 
œmbda_Á˘‹


625 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

626 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

627 
MEFuŒFa°
 *
p_me_fÁ°
 = 
p_Vid
->
p_fÁ°_me
;

628 
di°blk
 
mco°
;

629 
pos
;

630 
£¨ch_ønge
 = 
	`imax
(
mv_block
->
£¨chR™ge
.
max_x
, mv_block->£¨chR™ge.
max_y
) >> 2;

631 
max_pos
 = (2*
£¨ch_ønge
+1)*(2*search_range+1);

632 
be°_pos
 = 0;

633 
block_ödex
;

634 
di°≥l
* 
block_ßd
;

635 
li°
 = 
mv_block
->list;

636 
ªf
 = 
mv_block
->
ªf_idx
;

637 
MŸi⁄Ve˘‹
 
ˇnd
 = {0, 0}, *
off£t
 = &
p_Vid
->
p_fÁ°_me
->
£¨ch_˚¡î
[
li°
][
ªf
];

638 
max_mvd
 = 
p_Vid
->max_mvd-1;

640 
block_ödex
 = (
mv_block
->
block_y
 << 2Ë+ (mv_block->
block_x
);

641 
block_ßd
 = 
p_me_fÁ°
->
BlockSAD
[
li°
][
ªf
][
mv_block
->
blockty≥
][
block_ödex
];

644 i‡(!
p_Vid
->
p_fÁ°_me
->
£¨ch_£tup_d⁄e
[
li°
][
ªf
])

646 
cuºMB
->
	`p_SëupFa°FuŒPñSórch
 (cuºMB, 
mv_block
, 
li°
);

650 i‡(!
p_I≈
->
rd›t
 && 
	`GëMaxMVD
(&
ˇnd
, 
¥ed_mv
)<
max_mvd
)

652 
mö_mco°
 = 
block_ßd
[
p_me_fÁ°
->
pos_00
[
li°
][
ªf
]];

653 
	`up_sˇÀ
(&
mö_mco°
);

654 
mö_mco°
 +
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd
, 
¥ed_mv
);

656 
be°_pos
 = 
p_me_fÁ°
->
pos_00
[
li°
][
ªf
];

660 
pos
=0;Öos<
max_pos
;Öos++, 
block_ßd
++)

662 
mco°
 = 
	`di°_sˇÀ
(*
block_ßd
);

663 
ˇnd
 = 
	`add_MVs
 (
p_Vid
->
•úÆ_q≥l_£¨ch
[
pos
], 
off£t
);

671 i‡(
mco°
 < 
mö_mco°
 && 
	`GëMaxMVD
(&
ˇnd
, 
¥ed_mv
)<
max_mvd
)

674 
mco°
 +
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd
, 
¥ed_mv
);

677 i‡(
mco°
 < 
mö_mco°
)

679 
mö_mco°
 = 
mco°
;

680 
be°_pos
 = 
pos
;

686 
mv_block
->
mv
[
li°
] = 
	`add_MVs
 (
p_Vid
->
•úÆ_q≥l_£¨ch
[
be°_pos
], 
off£t
);

688  
mö_mco°
;

689 
	}
}

	@lencod/src/me_fullfast_otf.c

13 
	~"c⁄åibut‹s.h
"

14 
	~<limôs.h
>

16 
	~"globÆ.h
"

17 
	~"image.h
"

18 
	~"memÆloc.h
"

19 
	~"mb_ac˚ss.h
"

21 
	~"me_di°‹ti⁄.h
"

22 
	~"gë_block_Ÿf.h
"

24 
	~"me_fuŒ£¨ch.h
"

25 
	~"me_fuŒÁ°.h
"

26 
	~"me_fuŒÁ°_Ÿf.h
"

27 
	~"c⁄f‹m™˚.h
"

28 
	~"mv_£¨ch.h
"

36 
	$SëupFa°FuŒPñSórch_Ÿf
 (
Ma¸oblock
 *
cuºMB
, 
MEBlock
 *
mv_block
, 
li°
)

38 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

39 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

40 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºSli˚
->p_Inp;

41 
DecodedPi˘uªBuf„r
 *
p_Dpb
 = 
p_Vid
->
p_Dpb_œyî
[p_Vid->
dpb_œyî_id
];

42 (*
di°_mëhod
Ë(
x
Ë
p_I≈
->
MEEº‹Mëric
[0 + (–
p_Vid
->
dpb_œyî_id
 >1 ) ? 3 : 0)] ? 
übs2
 : 
übs
;

43 #i‡(
JM_MEM_DISTORTION
)

44 * 
img≥l_di°
 = 
p_I≈
->
MEEº‹Mëric
[0 + 
p_Vid
->
œyî_off£t
] ?Ö_Vid->
img≥l_quad
 :Ö_Vid->
img≥l_abs
;

46 
MŸi⁄Ve˘‹
 
pmv
;

47 
img≥l
 
‹ig_≥ls
[768];

48 
img≥l
 
d©a
[
MB_PIXELS
] ;

49 
tmp_d©a
[ (
MB_BLOCK_SIZE
+5)*(MB_BLOCK_SIZE+5) ] ;

50 
img≥l
 *
§˝å
 = 
‹ig_≥ls
, *
ªÂå
 = 
d©a
 ;

51 
k
, 
x
, 
y
;

52 
MŸi⁄Ve˘‹
 
ˇnd
, 
off£t
;

53 
ªf_x
, 
ªf_y
, 
pos
, 
bödex
, 
blky
;

54 
di°blk
 
LöeSadBlk0
, 
LöeSadBlk1
, 
LöeSadBlk2
, 
LöeSadBlk3
;

55 
PixñPos
 
block
[4];

56 
MEFuŒFa°
 *
p_me_fÁ°
 = 
p_Vid
->
p_fÁ°_me
;

59 
ªf
 = 
mv_block
->
ªf_idx
;

60 
di°≥l
** 
block_ßd
 = 
p_me_fÁ°
->
BlockSAD
[
li°
][
ªf
][7];

61 
£¨ch_ønge
 = 
p_me_fÁ°
->
max_£¨ch_ønge
[
li°
][
ªf
];

62 
max_pos
 = (2*
£¨ch_ønge
+1) * (2*search_range+1);

64 
li°_off£t
 = 
p_Vid
->
mb_d©a
[
cuºMB
->
mbAddrX
].list_offset;

65 
≠∂y_weights
 = ( (
p_Vid
->
a˘ive_µs
->
weighãd_¥ed_Êag
 && (
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
 || (cuºSli˚->¶i˚_ty≥ =
SP_SLICE
))) ||

66 (
p_Vid
->
a˘ive_µs
->
weighãd_bùªd_idc
 && (
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
))Ë&& 
p_I≈
->
U£WeighãdRe„ªn˚ME
;

67 
weighãd_≥l
;

68 
St‹abÀPi˘uª
 *
ªf_pi˘uª
 = 
cuºSli˚
->
li°X
[
li°
+
li°_off£t
][
ªf
];

70 
wp_luma_round
 = 0;

71 
luma_log_weight_díom
 = 5;

72 
chroma_log_weight_díom
 = 5;

73 
wp_chroma_round
 = 0;

74 
weight_luma
 = 
mv_block
->weight_luma, 
weight_¸
[2];

75 
off£t_luma
 = 
mv_block
->off£t_luma, 
off£t_¸
[2];

76 
£¨ch_ønge
 <<= 2;

79 
	`gë_√ighb‹s
(
cuºMB
, 
block
, 0, 0, 16);

80 
cuºMB
->
	`GëMVPªdi˘‹
 (cuºMB, 
block
, &
pmv
, 
ªf
, 
p_Vid
->
íc_pi˘uª
->
mv_öfo
, 
li°
, 0, 0, 16, 16);

82 #i‡(
JM_INT_DIVIDE
)

83 
p_Vid
->
p_fÁ°_me
->
£¨ch_˚¡î
[
li°
][
ªf
].
mv_x
 = ((
pmv
.mv_x + 2) >> 2) * 4;

84 
p_Vid
->
p_fÁ°_me
->
£¨ch_˚¡î
[
li°
][
ªf
].
mv_y
 = ((
pmv
.mv_y + 2) >> 2) * 4;

86 
p_Vid
->
p_fÁ°_me
->
£¨ch_˚¡î
[
li°
][
ªf
].
mv_x
 = (
pmv
.mv_x / 4) * 4;

87 
p_Vid
->
p_fÁ°_me
->
£¨ch_˚¡î
[
li°
][
ªf
].
mv_y
 = (
pmv
.mv_y / 4) * 4;

89 i‡(!
p_I≈
->
rd›t
)

92 
p_Vid
->
p_fÁ°_me
->
£¨ch_˚¡î
[
li°
][
ªf
].
mv_x
 = (Ë
	`iClù3
(-
£¨ch_ønge
, search_range,Ö_Vid->p_ffast_me->search_center[list][ref].mv_x);

93 
p_Vid
->
p_fÁ°_me
->
£¨ch_˚¡î
[
li°
][
ªf
].
mv_y
 = (Ë
	`iClù3
(-
£¨ch_ønge
, search_range,Ö_Vid->p_ffast_me->search_center[list][ref].mv_y);

96 
p_Vid
->
p_fÁ°_me
->
£¨ch_˚¡î
[
li°
][
ªf
].
mv_x
 = (Ë
	`iClù3
’_Vid->
MaxHmvR
[4] + 
£¨ch_ønge
,Ö_Vid->MaxHmvR[5] - search_range,Ö_Vid->p_ffast_me->search_center[list][ref].mv_x);

97 
p_Vid
->
p_fÁ°_me
->
£¨ch_˚¡î
[
li°
][
ªf
].
mv_y
 = (Ë
	`iClù3
’_Vid->
MaxVmvR
[4] + 
£¨ch_ønge
,Ö_Vid->MaxVmvR[5] - search_range,Ö_Vid->p_ffast_me->search_center[list][ref].mv_y);

99 
p_Vid
->
p_fÁ°_me
->
£¨ch_˚¡î_∑dded
[
li°
][
ªf
] = 
	`∑d_MVs
’_Vid->p_fÁ°_me->
£¨ch_˚¡î
[li°][ªf], 
mv_block
);

101 
off£t
 = 
p_Vid
->
p_fÁ°_me
->
£¨ch_˚¡î_∑dded
[
li°
][
ªf
];

103 
y
 = 
cuºMB
->
›ix_y
; y < cuºMB->›ix_y + 
MB_BLOCK_SIZE
; y++)

105 
	`mem˝y
(
§˝å
, &
p_Vid
->
pCurImg
[
y
][
cuºMB
->
pix_x
], 
MB_BLOCK_SIZE
 * (
img≥l
));

106 
§˝å
 +
MB_BLOCK_SIZE
;

109 i‡–
mv_block
->
ChromaMEE«bÀ
)

111 
k
 = 1; k < 3; k++)

113 
y
 = 
cuºMB
->
›ix_c_y
; y < cuºMB->›ix_c_y + 
p_Vid
->
mb_¸_size_y
; y++)

115 
	`mem˝y
(
§˝å
, &
p_Vid
->
pImgOrg
[
k
][
y
][
cuºMB
->
pix_c_x
],Ö_Vid->
mb_¸_size_x
 * (
img≥l
));

116 
§˝å
 +
p_Vid
->
mb_¸_size_x
;

123 i‡(!
p_I≈
->
rd›t
)

125 
ªf_x
 = 
mv_block
->
pos_x_∑dded
 - 
off£t
.
mv_x
;

126 
ªf_y
 = 
mv_block
->
pos_y_∑dded
 - 
off£t
.
mv_y
;

128 
pos
 = 0;Öo†< 
max_pos
;Öos++)

130 i‡(
ªf_x
 =
p_Vid
->
•úÆ_q≥l_£¨ch
[
pos
].
mv_x
 && 
ªf_y
 =p_Vid->•úÆ_q≥l_£¨ch[pos].
mv_y
)

132 
p_me_fÁ°
->
pos_00
[
li°
][
ªf
] = 
pos
;

139 i‡(
≠∂y_weights
)

141 
weight_luma
 = 
cuºSli˚
->
wp_weight
[
li°
 + 
li°_off£t
][
ªf
][0];

142 
off£t_luma
 = 
cuºSli˚
->
wp_off£t
[
li°
 + 
li°_off£t
][
ªf
][0];

143 
wp_luma_round
 = 
cuºSli˚
->wp_luma_round;

144 
luma_log_weight_díom
 = 
cuºSli˚
->luma_log_weight_denom;

145 
chroma_log_weight_díom
 = 
cuºSli˚
->chroma_log_weight_denom;

146 
wp_chroma_round
 = 
cuºSli˚
->wp_chroma_round;

148 i‡(
mv_block
->
ChromaMEE«bÀ
)

150 
weight_¸
[0] = 
cuºSli˚
->
wp_weight
[
li°
 + 
li°_off£t
][
ªf
][1];

151 
weight_¸
[1] = 
cuºSli˚
->
wp_weight
[
li°
 + 
li°_off£t
][
ªf
][2];

152 
off£t_¸
[0] = 
cuºSli˚
->
wp_off£t
[
li°
 + 
li°_off£t
][
ªf
][1];

153 
off£t_¸
[1] = 
cuºSli˚
->
wp_off£t
[
li°
 + 
li°_off£t
][
ªf
][2];

156 
pos
 = 0;Öo†< 
max_pos
;Öos++)

158 
ˇnd
 = 
	`add_MVs
(
off£t
, &
p_Vid
->
•úÆ_q≥l_£¨ch
[
pos
]);

160 
§˝å
 = 
‹ig_≥ls
;

161 
bödex
 = 0;

162 
ªÂå
 = 
d©a
 ;

163 
p_Dpb
->
	`pf_gë_block_luma
 ( 
p_Vid
, 
ªÂå
, 
tmp_d©a
, 
ˇnd
.
mv_x
, c™d.
mv_y
, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE, 
ªf_pi˘uª
, 0 ) ;

165 
blky
 = 0; blky < 4; blky++)

167 
LöeSadBlk0
 = 
LöeSadBlk1
 = 
LöeSadBlk2
 = 
LöeSadBlk3
 = 0;

169 
y
 = 0; y < 4; y++)

171 
weighãd_≥l
 = 
	`iClù1
–
p_Vid
->
max_img≥l_vÆue
, ((
weight_luma
 * *
ªÂå
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t_luma
);

172 
LöeSadBlk0
 +
	`di°_mëhod
 (
weighãd_≥l
 - *
§˝å
++);

173 
weighãd_≥l
 = 
	`iClù1
–
p_Vid
->
max_img≥l_vÆue
, ((
weight_luma
 * *
ªÂå
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t_luma
);

174 
LöeSadBlk0
 +
	`di°_mëhod
 (
weighãd_≥l
 - *
§˝å
++);

175 
weighãd_≥l
 = 
	`iClù1
–
p_Vid
->
max_img≥l_vÆue
, ((
weight_luma
 * *
ªÂå
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t_luma
);

176 
LöeSadBlk0
 +
	`di°_mëhod
 (
weighãd_≥l
 - *
§˝å
++);

177 
weighãd_≥l
 = 
	`iClù1
–
p_Vid
->
max_img≥l_vÆue
, ((
weight_luma
 * *
ªÂå
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t_luma
);

178 
LöeSadBlk0
 +
	`di°_mëhod
 (
weighãd_≥l
 - *
§˝å
++);

179 
weighãd_≥l
 = 
	`iClù1
–
p_Vid
->
max_img≥l_vÆue
, ((
weight_luma
 * *
ªÂå
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t_luma
);

180 
LöeSadBlk1
 +
	`di°_mëhod
 (
weighãd_≥l
 - *
§˝å
++);

181 
weighãd_≥l
 = 
	`iClù1
–
p_Vid
->
max_img≥l_vÆue
, ((
weight_luma
 * *
ªÂå
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t_luma
);

182 
LöeSadBlk1
 +
	`di°_mëhod
 (
weighãd_≥l
 - *
§˝å
++);

183 
weighãd_≥l
 = 
	`iClù1
–
p_Vid
->
max_img≥l_vÆue
, ((
weight_luma
 * *
ªÂå
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t_luma
);

184 
LöeSadBlk1
 +
	`di°_mëhod
 (
weighãd_≥l
 - *
§˝å
++);

185 
weighãd_≥l
 = 
	`iClù1
–
p_Vid
->
max_img≥l_vÆue
, ((
weight_luma
 * *
ªÂå
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t_luma
);

186 
LöeSadBlk1
 +
	`di°_mëhod
 (
weighãd_≥l
 - *
§˝å
++);

187 
weighãd_≥l
 = 
	`iClù1
–
p_Vid
->
max_img≥l_vÆue
, ((
weight_luma
 * *
ªÂå
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t_luma
);

188 
LöeSadBlk2
 +
	`di°_mëhod
 (
weighãd_≥l
 - *
§˝å
++);

189 
weighãd_≥l
 = 
	`iClù1
–
p_Vid
->
max_img≥l_vÆue
, ((
weight_luma
 * *
ªÂå
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t_luma
);

190 
LöeSadBlk2
 +
	`di°_mëhod
 (
weighãd_≥l
 - *
§˝å
++);

191 
weighãd_≥l
 = 
	`iClù1
–
p_Vid
->
max_img≥l_vÆue
, ((
weight_luma
 * *
ªÂå
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t_luma
);

192 
LöeSadBlk2
 +
	`di°_mëhod
 (
weighãd_≥l
 - *
§˝å
++);

193 
weighãd_≥l
 = 
	`iClù1
–
p_Vid
->
max_img≥l_vÆue
, ((
weight_luma
 * *
ªÂå
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t_luma
);

194 
LöeSadBlk2
 +
	`di°_mëhod
 (
weighãd_≥l
 - *
§˝å
++);

195 
weighãd_≥l
 = 
	`iClù1
–
p_Vid
->
max_img≥l_vÆue
, ((
weight_luma
 * *
ªÂå
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t_luma
);

196 
LöeSadBlk3
 +
	`di°_mëhod
 (
weighãd_≥l
 - *
§˝å
++);

197 
weighãd_≥l
 = 
	`iClù1
–
p_Vid
->
max_img≥l_vÆue
, ((
weight_luma
 * *
ªÂå
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t_luma
);

198 
LöeSadBlk3
 +
	`di°_mëhod
 (
weighãd_≥l
 - *
§˝å
++);

199 
weighãd_≥l
 = 
	`iClù1
–
p_Vid
->
max_img≥l_vÆue
, ((
weight_luma
 * *
ªÂå
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t_luma
);

200 
LöeSadBlk3
 +
	`di°_mëhod
 (
weighãd_≥l
 - *
§˝å
++);

201 
weighãd_≥l
 = 
	`iClù1
–
p_Vid
->
max_img≥l_vÆue
, ((
weight_luma
 * *
ªÂå
++ + 
wp_luma_round
Ë>> 
luma_log_weight_díom
Ë+ 
off£t_luma
);

202 
LöeSadBlk3
 +
	`di°_mëhod
 (
weighãd_≥l
 - *
§˝å
++);

204 
block_ßd
[
bödex
++][
pos
] = (
di°≥l
Ë
LöeSadBlk0
;

205 
block_ßd
[
bödex
++][
pos
] = (
di°≥l
Ë
LöeSadBlk1
;

206 
block_ßd
[
bödex
++][
pos
] = (
di°≥l
Ë
LöeSadBlk2
;

207 
block_ßd
[
bödex
++][
pos
] = (
di°≥l
Ë
LöeSadBlk3
;

210 i‡(
mv_block
->
ChromaMEE«bÀ
)

212 
max_img≥l_vÆue_uv
 = 
p_Vid
->
max_≥l_vÆue_comp
[1];

214 
k
 = 0; k < 2; k ++)

216 
bödex
 = 0;

217 
ªÂå
 = 
d©a
 ;

218 
p_Dpb
->
pf_gë_block_chroma
[
OTF_ME
]–
p_Vid
, 
ªÂå
, 
tmp_d©a
, 
ˇnd
.
mv_x
, c™d.
mv_y
,Ö_Vid->
mb_¸_size_x
,Ö_Vid->
mb_¸_size_y
, 
ªf_pi˘uª
, 
k
+1 );

220 
blky
 = 0; blky < 4; blky++)

222 
LöeSadBlk0
 = 
LöeSadBlk1
 = 
LöeSadBlk2
 = 
LöeSadBlk3
 = 0;

224 
y
 = 0; y < 
p_Vid
->
mb_¸_size_y
; y+=
BLOCK_SIZE
)

226 
x
 = 0; x < 
p_Vid
->
mb_¸_size_x
; x +
BLOCK_SIZE
)

228 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue_uv
, ((
weight_¸
[
k
] * *
ªÂå
++ + 
wp_chroma_round
Ë>> 
chroma_log_weight_díom
Ë+ 
off£t_¸
[k]);

229 
LöeSadBlk0
 +
	`di°_mëhod
 (
weighãd_≥l
 - *
§˝å
++);

231 
x
 = 0; x < 
p_Vid
->
mb_¸_size_x
; x +
BLOCK_SIZE
)

233 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue_uv
, ((
weight_¸
[
k
] * *
ªÂå
++ + 
wp_chroma_round
Ë>> 
chroma_log_weight_díom
Ë+ 
off£t_¸
[k]);

234 
LöeSadBlk1
 +
	`di°_mëhod
 (
weighãd_≥l
 - *
§˝å
++);

236 
x
 = 0; x < 
p_Vid
->
mb_¸_size_x
; x +
BLOCK_SIZE
)

238 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue_uv
, ((
weight_¸
[
k
] * *
ªÂå
++ + 
wp_chroma_round
Ë>> 
chroma_log_weight_díom
Ë+ 
off£t_¸
[k]);

239 
LöeSadBlk2
 +
	`di°_mëhod
 (
weighãd_≥l
 - *
§˝å
++);

241 
x
 = 0; x < 
p_Vid
->
mb_¸_size_x
; x +
BLOCK_SIZE
)

243 
weighãd_≥l
 = 
	`iClù1
–
max_img≥l_vÆue_uv
, ((
weight_¸
[
k
] * *
ªÂå
++ + 
wp_chroma_round
Ë>> 
chroma_log_weight_díom
Ë+ 
off£t_¸
[k]);

244 
LöeSadBlk3
 +
	`di°_mëhod
 (
weighãd_≥l
 - *
§˝å
++);

247 
block_ßd
[
bödex
][
pos
] = block_ßd[bödex][pos] + ((
di°≥l
Ë
LöeSadBlk0
);

248 ++
bödex
;

249 
block_ßd
[
bödex
][
pos
] = block_ßd[bödex][pos] + ((
di°≥l
Ë
LöeSadBlk1
);

250 ++
bödex
;

251 
block_ßd
[
bödex
][
pos
] = block_ßd[bödex][pos] + ((
di°≥l
Ë
LöeSadBlk2
);

252 ++
bödex
;

253 
block_ßd
[
bödex
][
pos
] = block_ßd[bödex][pos] + ((
di°≥l
Ë
LöeSadBlk3
);

254 ++
bödex
;

262 
pos
 = 0;Öo†< 
max_pos
;Öos++)

264 
ˇnd
 = 
	`add_MVs
(
off£t
, &
p_Vid
->
•úÆ_q≥l_£¨ch
[
pos
]);

265 
§˝å
 = 
‹ig_≥ls
;

266 
bödex
 = 0;

268 
ªÂå
 = 
d©a
;

269 
p_Dpb
->
	`pf_gë_block_luma
–
p_Vid
, 
ªÂå
, 
tmp_d©a
, 
ˇnd
.
mv_x
, c™d.
mv_y
, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE, 
ªf_pi˘uª
, 0 ) ;

271 
blky
 = 0; blky < 4; blky++)

273 
LöeSadBlk0
 = 
LöeSadBlk1
 = 
LöeSadBlk2
 = 
LöeSadBlk3
 = 0;

275 
y
 = 0; y < 4; y++)

277 #i‡(
JM_MEM_DISTORTION
)

279 
LöeSadBlk0
 +
img≥l_di°
[ *
ªÂå
++ - *
§˝å
++ ];

280 
LöeSadBlk0
 +
img≥l_di°
[ *
ªÂå
++ - *
§˝å
++ ];

281 
LöeSadBlk0
 +
img≥l_di°
[ *
ªÂå
++ - *
§˝å
++ ];

282 
LöeSadBlk0
 +
img≥l_di°
[ *
ªÂå
++ - *
§˝å
++ ];

284 
LöeSadBlk1
 +
img≥l_di°
[ *
ªÂå
++ - *
§˝å
++ ];

285 
LöeSadBlk1
 +
img≥l_di°
[ *
ªÂå
++ - *
§˝å
++ ];

286 
LöeSadBlk1
 +
img≥l_di°
[ *
ªÂå
++ - *
§˝å
++ ];

287 
LöeSadBlk1
 +
img≥l_di°
[ *
ªÂå
++ - *
§˝å
++ ];

289 
LöeSadBlk2
 +
img≥l_di°
[ *
ªÂå
++ - *
§˝å
++ ];

290 
LöeSadBlk2
 +
img≥l_di°
[ *
ªÂå
++ - *
§˝å
++ ];

291 
LöeSadBlk2
 +
img≥l_di°
[ *
ªÂå
++ - *
§˝å
++ ];

292 
LöeSadBlk2
 +
img≥l_di°
[ *
ªÂå
++ - *
§˝å
++ ];

294 
LöeSadBlk3
 +
img≥l_di°
[ *
ªÂå
++ - *
§˝å
++ ];

295 
LöeSadBlk3
 +
img≥l_di°
[ *
ªÂå
++ - *
§˝å
++ ];

296 
LöeSadBlk3
 +
img≥l_di°
[ *
ªÂå
++ - *
§˝å
++ ];

297 
LöeSadBlk3
 +
img≥l_di°
[ *
ªÂå
++ - *
§˝å
++ ];

300 
LöeSadBlk0
 +
	`di°_mëhod
 (*
ªÂå
++ - *
§˝å
++);

301 
LöeSadBlk0
 +
	`di°_mëhod
 (*
ªÂå
++ - *
§˝å
++);

302 
LöeSadBlk0
 +
	`di°_mëhod
 (*
ªÂå
++ - *
§˝å
++);

303 
LöeSadBlk0
 +
	`di°_mëhod
 (*
ªÂå
++ - *
§˝å
++);

305 
LöeSadBlk1
 +
	`di°_mëhod
 (*
ªÂå
++ - *
§˝å
++);

306 
LöeSadBlk1
 +
	`di°_mëhod
 (*
ªÂå
++ - *
§˝å
++);

307 
LöeSadBlk1
 +
	`di°_mëhod
 (*
ªÂå
++ - *
§˝å
++);

308 
LöeSadBlk1
 +
	`di°_mëhod
 (*
ªÂå
++ - *
§˝å
++);

310 
LöeSadBlk2
 +
	`di°_mëhod
 (*
ªÂå
++ - *
§˝å
++);

311 
LöeSadBlk2
 +
	`di°_mëhod
 (*
ªÂå
++ - *
§˝å
++);

312 
LöeSadBlk2
 +
	`di°_mëhod
 (*
ªÂå
++ - *
§˝å
++);

313 
LöeSadBlk2
 +
	`di°_mëhod
 (*
ªÂå
++ - *
§˝å
++);

315 
LöeSadBlk3
 +
	`di°_mëhod
 (*
ªÂå
++ - *
§˝å
++);

316 
LöeSadBlk3
 +
	`di°_mëhod
 (*
ªÂå
++ - *
§˝å
++);

317 
LöeSadBlk3
 +
	`di°_mëhod
 (*
ªÂå
++ - *
§˝å
++);

318 
LöeSadBlk3
 +
	`di°_mëhod
 (*
ªÂå
++ - *
§˝å
++);

321 
block_ßd
[
bödex
++][
pos
] = (
di°≥l
Ë
LöeSadBlk0
;

322 
block_ßd
[
bödex
++][
pos
] = (
di°≥l
Ë
LöeSadBlk1
;

323 
block_ßd
[
bödex
++][
pos
] = (
di°≥l
Ë
LöeSadBlk2
;

324 
block_ßd
[
bödex
++][
pos
] = (
di°≥l
Ë
LöeSadBlk3
;

327 i‡(
mv_block
->
ChromaMEE«bÀ
)

329 
k
 = 0; k < 2; k ++)

331 
bödex
 = 0;

333 
ªÂå
 = 
d©a
 ;

334 
p_Dpb
->
pf_gë_block_chroma
[
OTF_ME
]–
p_Vid
, 
ªÂå
, 
tmp_d©a
, 
ˇnd
.
mv_x
, c™d.
mv_y
,Ö_Vid->
mb_¸_size_x
,Ö_Vid->
mb_¸_size_y
, 
ªf_pi˘uª
, 
k
+1 );

336 
blky
 = 0; blky < 4; blky++)

338 
LöeSadBlk0
 = 
LöeSadBlk1
 = 
LöeSadBlk2
 = 
LöeSadBlk3
 = 0;

340 
y
 = 0; y < 
p_Vid
->
mb_¸_size_y
; y+=
BLOCK_SIZE
)

342 
x
 = 0; x < 
p_Vid
->
mb_¸_size_x
; x +
BLOCK_SIZE
)

344 
LöeSadBlk0
 +
	`di°_mëhod
 (*
ªÂå
++ - *
§˝å
++);

346 
x
 = 0; x < 
p_Vid
->
mb_¸_size_x
; x +
BLOCK_SIZE
)

348 
LöeSadBlk1
 +
	`di°_mëhod
 (*
ªÂå
++ - *
§˝å
++);

350 
x
 = 0; x < 
p_Vid
->
mb_¸_size_x
; x +
BLOCK_SIZE
)

352 
LöeSadBlk2
 +
	`di°_mëhod
 (*
ªÂå
++ - *
§˝å
++);

354 
x
 = 0; x < 
p_Vid
->
mb_¸_size_x
; x +
BLOCK_SIZE
)

356 
LöeSadBlk3
 +
	`di°_mëhod
 (*
ªÂå
++ - *
§˝å
++);

359 
block_ßd
[
bödex
][
pos
] = block_ßd[bödex][pos] + ((
di°≥l
Ë
LöeSadBlk0
);

360 ++
bödex
;

361 
block_ßd
[
bödex
][
pos
] = block_ßd[bödex][pos] + ((
di°≥l
Ë
LöeSadBlk1
);

362 ++
bödex
;

363 
block_ßd
[
bödex
][
pos
] = block_ßd[bödex][pos] + ((
di°≥l
Ë
LöeSadBlk2
);

364 ++
bödex
;

365 
block_ßd
[
bödex
][
pos
] = block_ßd[bödex][pos] + ((
di°≥l
Ë
LöeSadBlk3
);

366 ++
bödex
;

374 
	`upd©e_fuŒ_£¨ch_œrge_blocks
 (
p_Vid
->
p_fÁ°_me
, 
li°
, 
ªf
, 
max_pos
);

377 
p_Vid
->
p_fÁ°_me
->
£¨ch_£tup_d⁄e
[
li°
][
ªf
] = 1;

378 
	}
}

	@lencod/src/me_fullsearch.c

18 
	~"c⁄åibut‹s.h
"

19 
	~<limôs.h
>

21 
	~"globÆ.h
"

22 
	~"image.h
"

23 
	~"memÆloc.h
"

24 
	~"mb_ac˚ss.h
"

25 
	~"ªfbuf.h
"

26 
	~"ma¸oblock.h
"

27 
	~"me_di°‹ti⁄.h
"

28 
	~"me_fuŒ£¨ch.h
"

29 
	~"mv_£¨ch.h
"

38 
di°blk


39 
	$fuŒ_£¨ch_mŸi⁄_e°im©i⁄
 (
Ma¸oblock
 *
cuºMB
 ,

40 
MŸi⁄Ve˘‹
 *
¥ed_mv
,

41 
MEBlock
 *
mv_block
,

42 
di°blk
 
mö_mco°
,

43 
œmbda_Á˘‹


46 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

47 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

48 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

49 
£¨ch_ønge
 = 
	`imö
(
mv_block
->
£¨chR™ge
.
max_x
, mv_block->£¨chR™ge.
max_y
)>> 2;

50 
di°blk
 
mco°
;

51 
pos
;

52 
MŸi⁄Ve˘‹
 
ˇnd
, 
˚¡î
, 
¥ed
;

53 
ªf
 = 
mv_block
->
ªf_idx
;

55 
St‹abÀPi˘uª
 *
ªf_pi˘uª
 = 
cuºSli˚
->
li°X
[
mv_block
->
li°
+
cuºMB
->
li°_off£t
][
ªf
];

57 
be°_pos
 = 0;

58 
max_pos
 = (2*
£¨ch_ønge
+1)*(2*search_range+1);

60 
MŸi⁄Ve˘‹
 *
mv
 = &
mv_block
->mv[(Ëmv_block->
li°
];

61 
check_f‹_00
 = (
mv_block
->
blockty≥
==1 && !
p_I≈
->
rd›t
 && 
cuºSli˚
->
¶i˚_ty≥
!=
B_SLICE
 && 
ªf
==0);

62 
˚¡î
.
mv_x
 = 
mv_block
->
pos_x_∑dded
 + 
mv
->mv_x;

63 
˚¡î
.
mv_y
 = 
mv_block
->
pos_y_∑dded
 + 
mv
->mv_y;

64 
¥ed
.
mv_x
 = 
mv_block
->
pos_x_∑dded
 + 
¥ed_mv
->mv_x;

65 
¥ed
.
mv_y
 = 
mv_block
->
pos_y_∑dded
 + 
¥ed_mv
->mv_y;

69 
pos
=0;Öos<
max_pos
;Öos++)

72 
ˇnd
.
mv_x
 = 
˚¡î
.mv_x + 
p_Vid
->
•úÆ_q≥l_£¨ch
[
pos
].mv_x;

73 
ˇnd
.
mv_y
 = 
˚¡î
.mv_y + 
p_Vid
->
•úÆ_q≥l_£¨ch
[
pos
].mv_y;

76 
mco°
 = 
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd
, &
¥ed
);

78 i‡(
check_f‹_00
 && 
ˇnd
.
mv_x
 =
mv_block
->
pos_x_∑dded
 && c™d.
mv_y
 =mv_block->
pos_y_∑dded
)

80 
di°blk
 
tmp
 = 
	`weighãd_co°
 (
œmbda_Á˘‹
, 16);

81 
mco°
 = mco° > 
tmp
? (mcost-tmp): 0;

83 i‡(
mco°
 >
mö_mco°
) ;

86 
mco°
 +
mv_block
->
	`compuãPªdFPñ
(
ªf_pi˘uª
, mv_block, 
mö_mco°
 - mco°, &
ˇnd
);

89 i‡(
mco°
 < 
mö_mco°
)

91 
be°_pos
 = 
pos
;

92 
mö_mco°
 = 
mco°
;

98 i‡(
be°_pos
)

100 
	`add_mvs
(
mv
, &
p_Vid
->
•úÆ_q≥l_£¨ch
[
be°_pos
]);

102  
mö_mco°
;

103 
	}
}

111 
di°blk


112 
	$fuŒ_£¨ch_bùªd_mŸi⁄_e°im©i⁄
 (
Ma¸oblock
 *
cuºMB
,

113 
li°
,

114 
MŸi⁄Ve˘‹
 *
¥ed_mv1
,

115 
MŸi⁄Ve˘‹
 *
¥ed_mv2
,

116 
MŸi⁄Ve˘‹
 *
mv1
,

117 
MŸi⁄Ve˘‹
 *
mv2
,

118 
MEBlock
 *
mv_block
,

119 
£¨ch_ønge
,

120 
di°blk
 
mö_mco°
,

121 
œmbda_Á˘‹


124 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

125 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

126 
ªf
 = 
mv_block
->
ªf_idx
;

127 
St‹abÀPi˘uª
 *
ªf_pi˘uª1
 = 
cuºSli˚
->
li°X
[
li°
 + 
cuºMB
->
li°_off£t
][
ªf
];

128 
St‹abÀPi˘uª
 *
ªf_pi˘uª2
 = 
cuºSli˚
->
li°X
[(
li°
 ^ 1Ë+ 
cuºMB
->
li°_off£t
][0];

129 
di°blk
 
mco°
;

130 
pos
;

132 
be°_pos
 = 0;

133 
max_pos
 = (2 * (
£¨ch_ønge
 >> 2) +1)*(2 * (search_range >> 2) + 1);

135 
MŸi⁄Ve˘‹
 
˚¡î1
, 
˚¡î2
, 
ˇnd
, 
¥ed1
, 
¥ed2
;

136 
¥ed1
.
mv_x
 = 
mv_block
->
pos_x_∑dded
 + 
¥ed_mv1
->mv_x;

137 
¥ed1
.
mv_y
 = 
mv_block
->
pos_y_∑dded
 + 
¥ed_mv1
->mv_y;

138 
¥ed2
.
mv_x
 = 
mv_block
->
pos_x_∑dded
 + 
¥ed_mv2
->mv_x;

139 
¥ed2
.
mv_y
 = 
mv_block
->
pos_y_∑dded
 + 
¥ed_mv2
->mv_y;

140 
˚¡î1
.
mv_x
 = 
mv_block
->
pos_x_∑dded
 + 
mv1
->mv_x;

141 
˚¡î1
.
mv_y
 = 
mv_block
->
pos_y_∑dded
 + 
mv1
->mv_y;

142 
˚¡î2
.
mv_x
 = 
mv_block
->
pos_x_∑dded
 + 
mv2
->mv_x;

143 
˚¡î2
.
mv_y
 = 
mv_block
->
pos_y_∑dded
 + 
mv2
->mv_y;

147 
pos
=0;Öos<
max_pos
;Öos++)

150 
ˇnd
.
mv_x
 = 
˚¡î1
.mv_x + 
p_Vid
->
•úÆ_q≥l_£¨ch
[
pos
].mv_x;

151 
ˇnd
.
mv_y
 = 
˚¡î1
.mv_y + 
p_Vid
->
•úÆ_q≥l_£¨ch
[
pos
].mv_y;

154 
mco°
 = 
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd
, &
¥ed1
);

155 
mco°
 +
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
˚¡î2
, &
¥ed2
);

157 i‡(
mco°
 >
mö_mco°
) ;

160 
mco°
 +
mv_block
->
	`compuãBiPªdFPñ
(
ªf_pi˘uª1
, 
ªf_pi˘uª2
, mv_block, 
mö_mco°
 - mcost,

161 &
ˇnd
, &
˚¡î2
);

164 i‡(
mco°
 < 
mö_mco°
)

166 
be°_pos
 = 
pos
;

167 
mö_mco°
 = 
mco°
;

172 i‡(
be°_pos
)

174 
	`add_mvs
(
mv1
, &
p_Vid
->
•úÆ_q≥l_£¨ch
[
be°_pos
]);

176  
mö_mco°
;

177 
	}
}

185 
di°blk


186 
	$sub_≥l_mŸi⁄_e°im©i⁄
 (
Ma¸oblock
 *
cuºMB
,

187 
MŸi⁄Ve˘‹
 *
¥ed
,

188 
MEBlock
 *
mv_block
,

189 
di°blk
 
mö_mco°
,

190 * 
œmbda


193 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

194 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

195 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

196 
di°blk
 
mco°
;

197 
pos
, 
be°_pos
;

199 
MŸi⁄Ve˘‹
 
ˇnd
;

200 
li°
 = 
mv_block
->list;

201 
cur_li°
 = 
li°
 + 
cuºMB
->
li°_off£t
;

202 
ªf
 = 
mv_block
->
ªf_idx
;

203 
St‹abÀPi˘uª
 *
ªf_pi˘uª
 = 
cuºSli˚
->
li°X
[
cur_li°
][
ªf
];

205 
MŸi⁄Ve˘‹
 *
mv
 = &
mv_block
->mv[
li°
];

207 
check_posôi⁄0
 = (!
p_I≈
->
rd›t
 && 
cuºSli˚
->
¶i˚_ty≥
 !
B_SLICE
 && 
ªf
==0 && 
mv_block
->
blockty≥
==1 && 
mv
->
mv_x
 =0 && mv->
mv_y
 ==0);

209 
max_pos2
 = ( !
p_Vid
->
°¨t_me_ªföemít_hp
 ? 
	`imax
(1, 
mv_block
->
£¨ch_pos2
) : mv_block->search_pos2);

210 
MŸi⁄Ve˘‹
 
cmv
;

212 
œmbda_Á˘‹
 = 
œmbda
[
H_PEL
];

221 
be°_pos
 = 0, 
pos
 = 
p_Vid
->
°¨t_me_ªföemít_hp
;Öo†< 
max_pos2
;Öos++)

223 
ˇnd
.
mv_x
 = 
mv
->mv_x + 
p_Vid
->
•úÆ_h≥l_£¨ch
[
pos
].mv_x;

224 
ˇnd
.
mv_y
 = 
mv
->mv_y + 
p_Vid
->
•úÆ_h≥l_£¨ch
[
pos
].mv_y;

227 
mco°
 = 
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd
, 
¥ed
);

230 i‡(
mco°
 >
mö_mco°
) ;

232 
cmv
 = 
	`∑d_MVs
(
ˇnd
, 
mv_block
);

234 
mco°
 +
mv_block
->
	`compuãPªdHPñ
–
ªf_pi˘uª
, mv_block, 
mö_mco°
 - mco°, &
cmv
);

236 i‡(
pos
==0 && 
check_posôi⁄0
)

238 
mco°
 -
	`weighãd_co°
 (
œmbda_Á˘‹
, 16);

241 i‡(
mco°
 < 
mö_mco°
)

243 
mö_mco°
 = 
mco°
;

244 
be°_pos
 = 
pos
;

247 i‡(
be°_pos
)

249 
mv
->
mv_x
 = mv->mv_x + 
p_Vid
->
•úÆ_h≥l_£¨ch
[
be°_pos
].mv_x;

250 
mv
->
mv_y
 = mv->mv_y + 
p_Vid
->
•úÆ_h≥l_£¨ch
[
be°_pos
].mv_y;

252 i‡–!
p_Vid
->
°¨t_me_ªföemít_qp
 )

253 
mö_mco°
 = 
DISTBLK_MAX
;

260 
œmbda_Á˘‹
 = 
œmbda
[
Q_PEL
];

263 
be°_pos
 = 0, 
pos
 = 
p_Vid
->
°¨t_me_ªföemít_qp
;Öo†< 
mv_block
->
£¨ch_pos4
;Öos++)

265 
ˇnd
.
mv_x
 = 
mv
->mv_x + 
p_Vid
->
•úÆ_£¨ch
[
pos
].mv_x;

266 
ˇnd
.
mv_y
 = 
mv
->mv_y + 
p_Vid
->
•úÆ_£¨ch
[
pos
].mv_y;

269 
mco°
 = 
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd
, 
¥ed
);

271 i‡(
mco°
 >
mö_mco°
) ;

273 
cmv
 = 
	`∑d_MVs
(
ˇnd
, 
mv_block
);

275 
mco°
 +
mv_block
->
	`compuãPªdQPñ
–
ªf_pi˘uª
, mv_block, 
mö_mco°
 - mco°, &
cmv
);

276 i‡(
mco°
 < 
mö_mco°
)

278 
mö_mco°
 = 
mco°
;

279 
be°_pos
 = 
pos
;

282 i‡(
be°_pos
)

284 
	`add_mvs
(
mv
, &
p_Vid
->
•úÆ_£¨ch
[
be°_pos
]);

288  
mö_mco°
;

289 
	}
}

298 
di°blk


299 
	$sub_≥l_bùªd_mŸi⁄_e°im©i⁄
 (
Ma¸oblock
 *
cuºMB
,

300 
MEBlock
 *
mv_block
,

301 
li°
,

302 
MŸi⁄Ve˘‹
 *
¥ed_mv1
,

303 
MŸi⁄Ve˘‹
 *
¥ed_mv2
,

304 
MŸi⁄Ve˘‹
 *
mv1
,

305 
MŸi⁄Ve˘‹
 *
mv2
,

306 
di°blk
 
mö_mco°
,

307 * 
œmbda


310 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

311 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

312 
li°_off£t
 = 
p_Vid
->
mb_d©a
[
cuºMB
->
mbAddrX
].list_offset;

313 
di°blk
 
mco°
;

314 
pos
, 
be°_pos
;

315 
MŸi⁄Ve˘‹
 
ˇnd
;

316 
°¨t_hp
 = (
mö_mco°
 =
DISTBLK_MAX
Ë? 0 : 
p_Vid
->
°¨t_me_ªföemít_hp
;

317 
max_pos2
 = ( !
p_Vid
->
°¨t_me_ªföemít_hp
 ? 
	`imax
(1, 
mv_block
->
£¨ch_pos2
) : mv_block->search_pos2);

319 
MŸi⁄Ve˘‹
 
cmv
, 
smv
 = 
	`∑d_MVs
(*
mv2
, 
mv_block
);

320 
ªf
 = 
mv_block
->
ªf_idx
;

322 
St‹abÀPi˘uª
 *
ªf_pi˘uª1
 = 
cuºSli˚
->
li°X
[
li°
 + 
li°_off£t
][
ªf
];

323 
St‹abÀPi˘uª
 *
ªf_pi˘uª2
 = 
cuºSli˚
->
li°X
[(
li°
 ^ 1Ë+ 
li°_off£t
][0];

325 
œmbda_Á˘‹
 = 
œmbda
[
H_PEL
];

334 
be°_pos
 = 0, 
pos
 = 
°¨t_hp
;Öo†< 
max_pos2
;Öos++)

336 
ˇnd
.
mv_x
 = 
mv1
->mv_x + 
p_Vid
->
•úÆ_h≥l_£¨ch
[
pos
].mv_x;

337 
ˇnd
.
mv_y
 = 
mv1
->mv_y + 
p_Vid
->
•úÆ_h≥l_£¨ch
[
pos
].mv_y;

340 
mco°
 = 
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd
, 
¥ed_mv1
);

341 
mco°
 +
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, 
mv2
, 
¥ed_mv2
);

343 i‡(
mco°
 >
mö_mco°
) ;

345 
cmv
 = 
	`∑d_MVs
(
ˇnd
, 
mv_block
);

346 
mco°
 +
mv_block
->
	`compuãBiPªdHPñ
(
ªf_pi˘uª1
, 
ªf_pi˘uª2
, mv_block, 
mö_mco°
 - mco°, &
cmv
, &
smv
);

348 i‡(
mco°
 < 
mö_mco°
)

350 
mö_mco°
 = 
mco°
;

351 
be°_pos
 = 
pos
;

355 i‡(
be°_pos
)

357 
	`add_mvs
(
mv1
, &
p_Vid
->
•úÆ_h≥l_£¨ch
[
be°_pos
]);

365 i‡–!
p_Vid
->
°¨t_me_ªföemít_qp
 )

366 
mö_mco°
 = 
DISTBLK_MAX
;

368 
œmbda_Á˘‹
 = 
œmbda
[
Q_PEL
];

371 
be°_pos
 = 0, 
pos
 = 
p_Vid
->
°¨t_me_ªföemít_qp
;Öo†< 
mv_block
->
£¨ch_pos4
;Öos++)

373 
ˇnd
.
mv_x
 = 
mv1
->mv_x + 
p_Vid
->
•úÆ_£¨ch
[
pos
].mv_x;

374 
ˇnd
.
mv_y
 = 
mv1
->mv_y + 
p_Vid
->
•úÆ_£¨ch
[
pos
].mv_y;

377 
mco°
 = 
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd
, 
¥ed_mv1
);

378 
mco°
 +
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, 
mv2
, 
¥ed_mv2
);

380 i‡(
mco°
 >
mö_mco°
) ;

382 
cmv
 = 
	`∑d_MVs
(
ˇnd
, 
mv_block
);

383 
mco°
 +
mv_block
->
	`compuãBiPªdQPñ
(
ªf_pi˘uª1
, 
ªf_pi˘uª2
, mv_block, 
mö_mco°
 - mco°, &
cmv
, &
smv
);

385 i‡(
mco°
 < 
mö_mco°
)

387 
mö_mco°
 = 
mco°
;

388 
be°_pos
 = 
pos
;

393 i‡(
be°_pos
)

395 
	`add_mvs
(
mv1
, &
p_Vid
->
•úÆ_£¨ch
[
be°_pos
]);

399  
mö_mco°
;

400 
	}
}

408 
di°blk


409 
	$fuŒ_sub_≥l_mŸi⁄_e°im©i⁄
 (
Ma¸oblock
 *
cuºMB
,

410 
MŸi⁄Ve˘‹
 *
¥ed
,

411 
MEBlock
 *
mv_block
,

412 
di°blk
 
mö_mco°
,

413 * 
œmbda


416 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

417 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

418 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

419 
di°blk
 
mco°
;

420 
pos
, 
be°_pos
;

422 
MŸi⁄Ve˘‹
 
ˇnd
;

423 
li°
 = 
mv_block
->list;

424 
cur_li°
 = 
li°
 + 
cuºMB
->
li°_off£t
;

425 
ªf
 = 
mv_block
->
ªf_idx
;

426 
St‹abÀPi˘uª
 *
ªf_pi˘uª
 = 
cuºSli˚
->
li°X
[
cur_li°
][
ªf
];

428 
MŸi⁄Ve˘‹
 *
mv
 = &
mv_block
->mv[
li°
];

430 
check_posôi⁄0
 = (!
p_I≈
->
rd›t
 && 
cuºSli˚
->
¶i˚_ty≥
 !
B_SLICE
 && 
ªf
==0 && 
mv_block
->
blockty≥
==1 && 
mv
->
mv_x
 =0 && mv->
mv_y
 ==0);

432 
MŸi⁄Ve˘‹
 
cmv
;

434 
œmbda_Á˘‹
 = 
œmbda
[
Q_PEL
];

437 
be°_pos
 = 0, 
pos
 = 0;Öos < 81;Öos++)

439 
ˇnd
.
mv_x
 = 
mv
->mv_x + 
p_Vid
->
•úÆ_£¨ch
[
pos
].mv_x;

440 
ˇnd
.
mv_y
 = 
mv
->mv_y + 
p_Vid
->
•úÆ_£¨ch
[
pos
].mv_y;

443 
mco°
 = 
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd
, 
¥ed
);

445 i‡(
mco°
 >
mö_mco°
) ;

447 
cmv
 = 
	`∑d_MVs
(
ˇnd
, 
mv_block
);

448 
mco°
 +
mv_block
->
	`compuãPªdQPñ
–
ªf_pi˘uª
, mv_block, 
mö_mco°
 - mco°, &
cmv
);

450 i‡(
pos
 =0 && 
check_posôi⁄0
)

452 
mco°
 -
	`weighãd_co°
 (
œmbda_Á˘‹
, 16);

455 i‡(
mco°
 < 
mö_mco°
)

457 
mö_mco°
 = 
mco°
;

458 
be°_pos
 = 
pos
;

462 i‡(
be°_pos
)

464 
	`add_mvs
(
mv
, &
p_Vid
->
•úÆ_£¨ch
[
be°_pos
]);

468  
mö_mco°
;

469 
	}
}

477 
di°blk


478 
	$fuŒ_sub_≥l_bùªd_mŸi⁄_e°im©i⁄
 (
Ma¸oblock
 *
cuºMB
,

479 
MEBlock
 *
mv_block
,

480 
li°
,

481 
MŸi⁄Ve˘‹
 *
¥ed_mv1
,

482 
MŸi⁄Ve˘‹
 *
¥ed_mv2
,

483 
MŸi⁄Ve˘‹
 *
mv1
,

484 
MŸi⁄Ve˘‹
 *
mv2
,

485 
di°blk
 
mö_mco°
,

486 * 
œmbda


489 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

490 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

491 
li°_off£t
 = 
p_Vid
->
mb_d©a
[
cuºMB
->
mbAddrX
].list_offset;

492 
di°blk
 
mco°
;

493 
pos
, 
be°_pos
;

494 
MŸi⁄Ve˘‹
 
ˇnd
;

496 
MŸi⁄Ve˘‹
 
cmv
, 
smv
 = 
	`∑d_MVs
(*
mv2
, 
mv_block
);

497 
ªf
 = 
mv_block
->
ªf_idx
;

499 
St‹abÀPi˘uª
 *
ªf_pi˘uª1
 = 
cuºSli˚
->
li°X
[
li°
 + 
li°_off£t
][
ªf
];

500 
St‹abÀPi˘uª
 *
ªf_pi˘uª2
 = 
cuºSli˚
->
li°X
[(
li°
 ^ 1Ë+ 
li°_off£t
][0];

502 
œmbda_Á˘‹
 = 
œmbda
[
Q_PEL
];

505 
be°_pos
 = 0, 
pos
 = 0;Öos < 81;Öos++)

507 
ˇnd
.
mv_x
 = 
mv1
->mv_x + 
p_Vid
->
•úÆ_£¨ch
[
pos
].mv_x;

508 
ˇnd
.
mv_y
 = 
mv1
->mv_y + 
p_Vid
->
•úÆ_£¨ch
[
pos
].mv_y;

511 
mco°
 = 
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd
, 
¥ed_mv1
);

512 
mco°
 +
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, 
mv2
, 
¥ed_mv2
);

514 i‡(
mco°
 >
mö_mco°
) ;

516 
cmv
 = 
	`∑d_MVs
(
ˇnd
, 
mv_block
);

517 
mco°
 +
mv_block
->
	`compuãBiPªdQPñ
(
ªf_pi˘uª1
, 
ªf_pi˘uª2
, mv_block, 
mö_mco°
 - mco°, &
cmv
, &
smv
);

519 i‡(
mco°
 < 
mö_mco°
)

521 
mö_mco°
 = 
mco°
;

522 
be°_pos
 = 
pos
;

526 i‡(
be°_pos
)

528 
	`add_mvs
(
mv1
, &
p_Vid
->
•úÆ_£¨ch
[
be°_pos
]);

532  
mö_mco°
;

533 
	}
}

	@lencod/src/me_umhex.c

26 
	~<limôs.h
>

28 
	~"globÆ.h
"

29 
	~"memÆloc.h
"

30 
	~"me_umhex.h
"

31 
	~"ªfbuf.h
"

32 
	~"mb_ac˚ss.h
"

33 
	~"image.h
"

34 
	~"íc_°©i°ics.h
"

35 
	~"ma¸oblock.h
"

36 
	~"me_di°‹ti⁄.h
"

37 
	~"mv_£¨ch.h
"

38 
	~"me_fuŒ£¨ch.h
"

40 
	#Q_BITS
 15

	)

41 
	#MIN_IMG_WIDTH
 176

	)

43 c⁄° 
MŸi⁄Ve˘‹
 
	gDüm⁄d
[4] = {{-4, 0}, {4, 0}, {0, -4}, {0, 4}};

44 c⁄° 
MŸi⁄Ve˘‹
 
	gHexag⁄
[6] = {{-8, 0}, {8, 0},{-4, -8}, {4, 8}, {-4, 8}, {4 , -8}};

46 c⁄° 
MŸi⁄Ve˘‹
 
	gTriRe˘
[9] = {{0, 0}, {-4, 0}, {-4, 4}, {0, 4}, {4, 4}, {4, 0}, {4, -4}, {0, -4},

48 c⁄° 
MŸi⁄Ve˘‹
 
	gDüm⁄dO˘ag⁄
[12] = {{-4, 0}, {4, 0}, {0, -4},{0, 4}, {-8, 4}, {-4, 8}, {4, 8}, {8, 4}, {8, -4}, {4, -8}, {-4, -8}, {-8, -4}};

50 c⁄° 
	gBig_Hexag⁄_X
[16] = {0,-8, -16,-16,-16, -16, -16, -8, 0, 8, 16, 16, 16, 16, 16, 8};

51 c⁄° 
	gBig_Hexag⁄_Y
[16] = {8, 12, 8, 4, 0, -4, -8, -12, -16, -12, -8, -4, 0, 4, 8, 12};

53 c⁄° 
	gMu…i_Ref_Thd
[8] = {0, 300, 120, 120, 60, 30, 30, 15};

54 c⁄° 
	gBig_Hexag⁄_Thd
[8] = {0, 3000, 1500, 1500, 800, 400, 400, 200};

55 c⁄° 
	gMedün_Pªd_Thd
[8] = {0, 750, 350, 350, 170, 80, 80, 40};

56 c⁄° 
	gThªshﬁd_DSR
[8] = {0, 2200, 1000, 1000, 500, 250, 250, 120};

59 
	$UMHEX_DeföeThªshﬁd
(
VideoP¨amëîs
 *
p_Vid
)

61 
UMHexSåu˘
 *
p_UMHex
 = 
p_Vid
->p_UMHex;

63 
p_UMHex
->
AÕhaFouπh_1
[1] = 0.01f;

64 
p_UMHex
->
AÕhaFouπh_1
[2] = 0.01f;

65 
p_UMHex
->
AÕhaFouπh_1
[3] = 0.01f;

66 
p_UMHex
->
AÕhaFouπh_1
[4] = 0.02f;

67 
p_UMHex
->
AÕhaFouπh_1
[5] = 0.03f;

68 
p_UMHex
->
AÕhaFouπh_1
[6] = 0.03f;

69 
p_UMHex
->
AÕhaFouπh_1
[7] = 0.04f;

71 
p_UMHex
->
AÕhaFouπh_2
[1] = 0.06f;

72 
p_UMHex
->
AÕhaFouπh_2
[2] = 0.07f;

73 
p_UMHex
->
AÕhaFouπh_2
[3] = 0.07f;

74 
p_UMHex
->
AÕhaFouπh_2
[4] = 0.08f;

75 
p_UMHex
->
AÕhaFouπh_2
[5] = 0.12f;

76 
p_UMHex
->
AÕhaFouπh_2
[6] = 0.11f;

77 
p_UMHex
->
AÕhaFouπh_2
[7] = 0.15f;

79 
p_UMHex
->
BlockTy≥_LUT
[0][0] = 7;

80 
p_UMHex
->
BlockTy≥_LUT
[0][1] = 6;

81 
p_UMHex
->
BlockTy≥_LUT
[1][0] = 5;

82 
p_UMHex
->
BlockTy≥_LUT
[1][1] = 4;

83 
p_UMHex
->
BlockTy≥_LUT
[1][3] = 3;

84 
p_UMHex
->
BlockTy≥_LUT
[3][1] = 2;

85 
p_UMHex
->
BlockTy≥_LUT
[3][3] = 1;

88 
	}
}

98 
	$UMHEX_DeföeThªshﬁdMB
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

100 
UMHexSåu˘
 *
p_UMHex
 = 
p_Vid
->p_UMHex;

101 
gb_qp_≥r
 = (
p_I≈
->
qp
[
P_SLICE
])/6;

102 
gb_qp_ªm
 = (
p_I≈
->
qp
[
P_SLICE
])%6;

104 
gb_q_bôs
 = 
Q_BITS
+
gb_qp_≥r
;

105 
gb_qp_c⁄°
,
Thªsh4x4
;

107 
Qu™tize_°ï
;

108 
i
;

110 
sˇÀ_Á˘‹
 = ()((1-
p_I≈
->
UMHexSˇÀ
*0.1)+p_I≈->UMHexSˇÀ*0.1*(
p_Vid
->
width
/
MIN_IMG_WIDTH
));

112 
QP_Á˘‹
 = ()((1.0-0.90*(
p_I≈
->
qp
[
P_SLICE
]/51.0f)));

113 
di°blk
 
dbSˇœr
 = 
	`di°_sˇÀ
(1);

115 
gb_qp_c⁄°
=(1<<
gb_q_bôs
)/6;

116 
Thªsh4x4
 = ((1<<
gb_q_bôs
Ë- 
gb_qp_c⁄°
)/
	`imax
(1, 
p_Vid
->
p_Qu™t
->
q_∑øms_4x4
[0][1][
gb_qp_ªm
][0][0].
SˇÀComp
);

117 
Qu™tize_°ï
 = 
Thªsh4x4
/(4*5.61f)*2.0f*
sˇÀ_Á˘‹
;

118 
p_UMHex
->
Bsize
[7]=(16*16)*
Qu™tize_°ï
*
dbSˇœr
;

120 
p_UMHex
->
Bsize
[6] =Ö_UMHex->Bsize[7]*4*
dbSˇœr
;

121 
p_UMHex
->
Bsize
[5] =Ö_UMHex->Bsize[7]*4*
dbSˇœr
;

122 
p_UMHex
->
Bsize
[4] =Ö_UMHex->Bsize[5]*4*
dbSˇœr
;

123 
p_UMHex
->
Bsize
[3] =Ö_UMHex->Bsize[4]*4*
dbSˇœr
;

124 
p_UMHex
->
Bsize
[2] =Ö_UMHex->Bsize[4]*4*
dbSˇœr
;

125 
p_UMHex
->
Bsize
[1] =Ö_UMHex->Bsize[2]*4*
dbSˇœr
;

127 
i
=1;i<8;i++)

130 
p_UMHex
->
Medün_Pªd_Thd_MB
[
i
] = (
di°blk
Ë(
Medün_Pªd_Thd
[i]* 
sˇÀ_Á˘‹
*
QP_Á˘‹
*
dbSˇœr
);

132 
p_UMHex
->
Big_Hexag⁄_Thd_MB
[
i
] = (
di°blk
Ë(
Big_Hexag⁄_Thd
[i]* 
sˇÀ_Á˘‹
*
QP_Á˘‹
*
dbSˇœr
);

134 
p_UMHex
->
Mu…i_Ref_Thd_MB
[
i
] = (
di°blk
Ë(
Mu…i_Ref_Thd
[i] * 
sˇÀ_Á˘‹
*
QP_Á˘‹
*
dbSˇœr
);

136 
p_UMHex
->
Thªshﬁd_DSR_MB
[
i
] = (
di°blk
Ë(
Thªshﬁd_DSR
[i] * 
sˇÀ_Á˘‹
*
QP_Á˘‹
*
dbSˇœr
);

138 
	}
}

146 
	$UMHEX_gë_mem
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

148 
UMHexSåu˘
 *
p_UMHex
 = 
p_Vid
->p_UMHex;

150 
mem‹y_size
 = 0;

151 
£¨ch_ønge
 = 
p_I≈
->
SórchMode
[0] =
UM_HEX
 ?Ö_Inp->search_range[0] :Ö_Inp->search_range[1];

153 i‡(
NULL
==(
p_UMHex
->
Êag_öåa
 = 
	`ˇŒoc
 ((
p_Vid
->
width
>>4)+1,(
byã
)))Ë
	`no_mem_exô
("UMHEX_get_mem:Ö_UMHex->flag_intra");

155 
mem‹y_size
 +
	`gë_mem2D
(&
p_UMHex
->
Mco°Sèã
, 2*
£¨ch_ønge
+1, 2*search_range+1);

157 
mem‹y_size
 +
	`gë_mem4Ddi°blk
(&(
p_UMHex
->
Á°me_ªf_co°
), 
p_Vid
->
max_num_ª„ªn˚s
, 9, 4, 4);

158 
mem‹y_size
 +
	`gë_mem3Ddi°blk
(&(
p_UMHex
->
Á°me_l0_co°
), 9, 
p_Vid
->
height
 >> 2,Ö_Vid->
width
 >> 2);

159 
mem‹y_size
 +
	`gë_mem3Ddi°blk
(&(
p_UMHex
->
Á°me_l1_co°
), 9, 
p_Vid
->
height
 >> 2,Ö_Vid->
width
 >> 2);

160 
mem‹y_size
 +
	`gë_mem2Ddi°blk
(&(
p_UMHex
->
Á°me_be°_co°
), 7, 
p_Vid
->
width
 >> 2);

162 
mem‹y_size
 +
	`gë_mem2D
(&
p_UMHex
->
SórchSèã
, 7, 7);

163 if(
p_I≈
->
BiPªdMŸi⁄E°im©i⁄
 == 1)

165 
mem‹y_size
 +
	`gë_mem3Ddi°blk
(&(
p_UMHex
->
Á°me_l0_co°_bùªd
), 9, 
p_Vid
->
height
 >> 2,Ö_Vid->
width
 >> 2);

166 
mem‹y_size
 +
	`gë_mem3Ddi°blk
(&(
p_UMHex
->
Á°me_l1_co°_bùªd
), 9, 
p_Vid
->
height
 >> 2,Ö_Vid->
width
 >> 2);

169  
mem‹y_size
;

170 
	}
}

178 
	$UMHEX_‰ì_mem
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

180 
UMHexSåu˘
 *
p_UMHex
 = 
p_Vid
->p_UMHex;

181 
	`‰ì_mem2D
(
p_UMHex
->
Mco°Sèã
);

183 
	`‰ì_mem4Ddi°blk
(
p_UMHex
->
Á°me_ªf_co°
);

184 
	`‰ì_mem3Ddi°blk
(
p_UMHex
->
Á°me_l0_co°
 );

185 
	`‰ì_mem3Ddi°blk
(
p_UMHex
->
Á°me_l1_co°
);

186 
	`‰ì_mem2Ddi°blk
(
p_UMHex
->
Á°me_be°_co°
);

188 
	`‰ì_mem2D
(
p_UMHex
->
SórchSèã
);

189 
	`‰ì
 (
p_UMHex
->
Êag_öåa
);

190 if(
p_I≈
->
BiPªdMŸi⁄E°im©i⁄
 == 1)

192 
	`‰ì_mem3Ddi°blk
(
p_UMHex
->
Á°me_l0_co°_bùªd
);

193 
	`‰ì_mem3Ddi°blk
(
p_UMHex
->
Á°me_l1_co°_bùªd
);

195 
	`‰ì
(
p_UMHex
);

196 
	}
}

228 
di°blk


229 
	$UMHEXI¡egîPñBlockMŸi⁄Sórch
 (
Ma¸oblock
 *
cuºMB
,

230 
MŸi⁄Ve˘‹
 *
¥ed_mv
,

231 
MEBlock
 *
mv_block
,

232 
di°blk
 
mö_mco°
,

233 
œmbda_Á˘‹


236 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

237 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

238 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

239 
UMHexSåu˘
 *
p_UMHex
 = 
p_Vid
->p_UMHex;

241 
blockty≥
 = 
mv_block
->blocktype;

242 
blocksize_x
 = 
mv_block
->blocksize_x;

243 
blocksize_y
 = 
mv_block
->blocksize_y;

244 
pic_pix_x2
 = 
mv_block
->
pos_x2
;

245 
block_x
 = 
mv_block
->block_x;

246 
block_y
 = 
mv_block
->block_y;

248 
li°
 = 
mv_block
->list;

249 
cur_li°
 = 
li°
 + 
cuºMB
->
li°_off£t
;

250 
ªf
 = 
mv_block
->
ªf_idx
;

251 
St‹abÀPi˘uª
 *
ªf_pi˘uª
 = 
cuºSli˚
->
li°X
[
cur_li°
][
ªf
];

253 
MŸi⁄Ve˘‹
 *
mv
 = &
mv_block
->mv[
li°
];

254 
MŸi⁄Ve˘‹
 
iMöNow
, 
ˇnd
, 
˚¡î
, 
¥ed
, 
be°
 = {0, 0};

256 
£¨ch_°ï
;

257 
pos
;

258 
di°blk
 
mco°
;

259 
di°blk
 *
SAD_¥edi˘i⁄
 = 
p_UMHex
->
Á°me_be°_co°
[
blockty≥
-1];

260 
i
, 
j
, 
m
;

261 
bëaFouπh_1
,
bëaFouπh_2
;

262 
ãmp_Big_Hexag⁄_X
[16];

263 
ãmp_Big_Hexag⁄_Y
[16];

264 
di°blk
 
ET_Thªd
 = 
p_UMHex
->
Medün_Pªd_Thd_MB
[
blockty≥
];

265 
£¨ch_ønge
 = 
mv_block
->
£¨chR™ge
.
max_x
 >> 2;

267 
pic_pix_x
 = 
mv_block
->
pos_x_∑dded
;

268 
pic_pix_y
 = 
mv_block
->
pos_y_∑dded
;

269 
¥ed
.
mv_x
 = 
pic_pix_x
 + 
¥ed_mv
->mv_x;

270 
¥ed
.
mv_y
 = 
pic_pix_y
 + 
¥ed_mv
->mv_y;

271 
˚¡î
.
mv_x
 = 
pic_pix_x
 + 
mv
->mv_x;

272 
˚¡î
.
mv_y
 = 
pic_pix_y
 + 
mv
->mv_y;

277 
	`mem£t
(
p_UMHex
->
Mco°Sèã
[0],0,(2*
p_I≈
->
£¨ch_ønge
[
p_Vid
->
võw_id
]+1)*(2*p_Inp->search_range[p_Vid->view_id]+1));

282 
ˇnd
 = 
˚¡î
;

283 
mco°
 = 
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd
, &
¥ed
);

285 
mco°
 +
mv_block
->
	`compuãPªdFPñ
(
ªf_pi˘uª
, mv_block, 
mö_mco°
 - mco°, &
ˇnd
);

287 
p_UMHex
->
Mco°Sèã
[
£¨ch_ønge
][search_range] = 1;

288 i‡(
mco°
 < 
mö_mco°
)

290 
mö_mco°
 = 
mco°
;

291 
be°
 = 
ˇnd
;

294 
iMöNow
 = 
be°
;

296 
m
 = 0; m < 4; m++)

298 
ˇnd
.
mv_x
 = 
iMöNow
.mv_x + 
Düm⁄d
[
m
].mv_x;

299 
ˇnd
.
mv_y
 = 
iMöNow
.mv_y + 
Düm⁄d
[
m
].mv_y;

300 
SEARCH_ONE_PIXEL


303 if(
˚¡î
.
mv_x
 !
pic_pix_x
 || cíãr.
mv_y
 !
pic_pix_y
)

305 
ˇnd
.
mv_x
 = 
pic_pix_x
 ;

306 
ˇnd
.
mv_y
 = 
pic_pix_y
 ;

307 
SEARCH_ONE_PIXEL


308 
iMöNow
 = 
be°
;

309 
m
 = 0; m < 4; m++)

311 
ˇnd
.
mv_x
 = 
iMöNow
.mv_x + 
Düm⁄d
[
m
].mv_x;

312 
ˇnd
.
mv_y
 = 
iMöNow
.mv_y + 
Düm⁄d
[
m
].mv_y;

313 
SEARCH_ONE_PIXEL


318 if(
ªf
>0 && 
cuºSli˚
->
°ru˘uª
 =
FRAME
 && 
mö_mco°
 > 
ET_Thªd
 && 
SAD_¥edi˘i⁄
[
pic_pix_x2
] < 
p_UMHex
->
Mu…i_Ref_Thd_MB
[
blockty≥
])

319 
ãrmö©e_°ï
;

322 if–
mö_mco°
 < 
ET_Thªd
)

324 
ãrmö©e_°ï
;

329 
	`UMHEX_£tup
(
cuºMB
, 
ªf
, 
mv_block
->
li°
, 
block_y
, 
block_x
, 
blockty≥
, 
cuºSli˚
->
Æl_mv
 );

330 
ET_Thªd
 = 
p_UMHex
->
Big_Hexag⁄_Thd_MB
[
blockty≥
];

333 i‡(
p_UMHex
->
¥ed_SAD
 == 0)

335 
bëaFouπh_1
=0;

336 
bëaFouπh_2
=0;

340 
bëaFouπh_1
 = 
p_UMHex
->
Bsize
[
blockty≥
]/((Ì_UMHex->
¥ed_SAD
 *Ö_UMHex->¥ed_SAD)-p_UMHex->
AÕhaFouπh_1
[blocktype];

341 
bëaFouπh_2
 = 
p_UMHex
->
Bsize
[
blockty≥
]/((Ì_UMHex->
¥ed_SAD
 *Ö_UMHex->¥ed_SAD)-p_UMHex->
AÕhaFouπh_2
[blocktype];

348 if(
blockty≥
>1)

350 
ˇnd
.
mv_x
 = (Ë(
pic_pix_x
 + (
p_UMHex
->
¥ed_MV_u∂ayî
[0] / 4) * 4);

351 
ˇnd
.
mv_y
 = (Ë(
pic_pix_y
 + (
p_UMHex
->
¥ed_MV_u∂ayî
[1] / 4) * 4);

352 
SEARCH_ONE_PIXEL


357 if(
p_UMHex
->
¥ed_MV_ªf_Êag
 == 1)

359 
ˇnd
.
mv_x
 = (Ë(
pic_pix_x
 + (
p_UMHex
->
¥ed_MV_ªf
[0] / 4) * 4);

360 
ˇnd
.
mv_y
 = (Ë(
pic_pix_y
 + (
p_UMHex
->
¥ed_MV_ªf
[1] / 4) * 4);

361 
SEARCH_ONE_PIXEL


364 
iMöNow
 = 
be°
;

365 
m
 = 0; m < 4; m++)

367 
ˇnd
.
mv_x
 = 
iMöNow
.mv_x + 
Düm⁄d
[
m
].mv_x;

368 
ˇnd
.
mv_y
 = 
iMöNow
.mv_y + 
Düm⁄d
[
m
].mv_y;

369 
SEARCH_ONE_PIXEL


373 
EARLY_TERMINATION


375 if(
blockty≥
>6)

376 
fouπh_1_°ï
;

378 
£c_°ï
;

380 
£c_°ï
:

381 
iMöNow
 = 
be°
;

383 
i
 = 4; i < 
£¨ch_ønge
 << 2; i+=8)

385 
£¨ch_°ï
 = 
i
;

386 
ˇnd
.
mv_x
 = (Ë(
iMöNow
.mv_x + 
£¨ch_°ï
);

387 
ˇnd
.
mv_y
 = 
iMöNow
.mv_y ;

388 
SEARCH_ONE_PIXEL


389 
ˇnd
.
mv_x
 = (Ë(
iMöNow
.mv_x - 
£¨ch_°ï
);

390 
ˇnd
.
mv_y
 = 
iMöNow
.mv_y ;

391 
SEARCH_ONE_PIXEL


393 
i
 = 4; i < (
£¨ch_ønge
 << 1);i+=8)

395 
£¨ch_°ï
 = 
i
;

396 
ˇnd
.
mv_x
 = 
iMöNow
.mv_x ;

397 
ˇnd
.
mv_y
 = (Ë(
iMöNow
.mv_y + 
£¨ch_°ï
);

398 
SEARCH_ONE_PIXEL


399 
ˇnd
.
mv_x
 = 
iMöNow
.mv_x ;

400 
ˇnd
.
mv_y
 = (Ë(
iMöNow
.mv_y - 
£¨ch_°ï
);

401 
SEARCH_ONE_PIXEL


406 
EARLY_TERMINATION


408 
iMöNow
 = 
be°
;

412 
pos
=1;pos<25;pos++)

414 
ˇnd
.
mv_x
 = 
iMöNow
.mv_x + 
p_Vid
->
•úÆ_q≥l_£¨ch
[
pos
].mv_x;

415 
ˇnd
.
mv_y
 = 
iMöNow
.mv_y + 
p_Vid
->
•úÆ_q≥l_£¨ch
[
pos
].mv_y;

416 
SEARCH_ONE_PIXEL


420 
EARLY_TERMINATION


423 
	`mem˝y
(
ãmp_Big_Hexag⁄_X
,
Big_Hexag⁄_X
,64);

424 
	`mem˝y
(
ãmp_Big_Hexag⁄_Y
,
Big_Hexag⁄_Y
,64);

425 
i
=1;i<=(
£¨ch_ønge
 >> 2); i++)

428 
m
 = 0; m < 16; m++)

430 
ˇnd
.
mv_x
 = (Ë(
iMöNow
.mv_x + 
ãmp_Big_Hexag⁄_X
[
m
]);

431 
ˇnd
.
mv_y
 = (Ë(
iMöNow
.mv_y + 
ãmp_Big_Hexag⁄_Y
[
m
]);

432 
ãmp_Big_Hexag⁄_X
[
m
] +
Big_Hexag⁄_X
[m];

433 
ãmp_Big_Hexag⁄_Y
[
m
] +
Big_Hexag⁄_Y
[m];

435 
SEARCH_ONE_PIXEL


438 if(
mö_mco°
 < 
ET_Thªd
)

440 
ãrmö©e_°ï
;

447 
fouπh_1_°ï
:

448 
i
 = 0; i < 
£¨ch_ønge
; i++)

450 
iMöNow
 = 
be°
;

451 
m
 = 0; m < 6; m++)

453 
ˇnd
.
mv_x
 = 
iMöNow
.mv_x + 
Hexag⁄
[
m
].mv_x;

454 
ˇnd
.
mv_y
 = 
iMöNow
.mv_y + 
Hexag⁄
[
m
].mv_y;

455 
SEARCH_ONE_PIXEL


458 i‡(
be°
.
mv_x
 =
iMöNow
.mv_x && be°.
mv_y
 == iMinNow.mv_y)

463 
fouπh_2_°ï
:

465 
i
 = 0; i < 
£¨ch_ønge
; i++)

467 
iMöNow
 = 
be°
;

468 
m
 = 0; m < 4; m++)

470 
ˇnd
.
mv_x
 = 
iMöNow
.mv_x + 
Düm⁄d
[
m
].mv_x;

471 
ˇnd
.
mv_y
 = 
iMöNow
.mv_y + 
Düm⁄d
[
m
].mv_y;

472 
SEARCH_ONE_PIXEL


474 if(
be°
.
mv_x
 =
iMöNow
.mv_x && be°.
mv_y
 == iMinNow.mv_y)

478 
ãrmö©e_°ï
:

482 
i
=0; i < (
blocksize_x
>>2); i++)

484 
j
=0; j < (
blocksize_y
>>2); j++)

486 if(
mv_block
->
li°
 == 0)

488 
p_UMHex
->
Á°me_ªf_co°
[
ªf
][
blockty≥
][
block_y
+
j
][
block_x
+
i
] = 
mö_mco°
;

489 i‡(
ªf
==0)

490 
p_UMHex
->
Á°me_l0_co°
[
blockty≥
][(
cuºMB
->
block_y
)+block_y+
j
][(cuºMB->
block_x
)+block_x+
i
] = 
mö_mco°
;

494 
p_UMHex
->
Á°me_l1_co°
[
blockty≥
][(
cuºMB
->
block_y
)+block_y+
j
][(cuºMB->
block_x
)+block_x+
i
] = 
mö_mco°
;

499 i‡((
ªf
==0Ë|| (
SAD_¥edi˘i⁄
[
pic_pix_x2
] > 
mö_mco°
))

500 
SAD_¥edi˘i⁄
[
pic_pix_x2
] = 
mö_mco°
;

502 
mv
->
mv_x
 = (Ë(
be°
.mv_x - 
pic_pix_x
);

503 
mv
->
mv_y
 = (Ë(
be°
.mv_y - 
pic_pix_y
);

504  
mö_mco°
;

505 
	}
}

508 
di°blk


509 
	$UMHEXSubPñBlockMŸi⁄Sórch
 (
Ma¸oblock
 *
cuºMB
,

510 
MŸi⁄Ve˘‹
 *
¥ed_mv
,

511 
MEBlock
 *
mv_block
,

512 
di°blk
 
mö_mco°
,

513 
œmbda_Á˘‹


516 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

517 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

518 
UMHexSåu˘
 *
p_UMHex
 = 
p_Vid
->p_UMHex;

519 c⁄° 
MŸi⁄Ve˘‹
 
Düm⁄dQ
[4] = {{-1, 0}, { 0, 1}, { 1, 0}, { 0, -1}};

520 
di°blk
 
mco°
;

521 
MŸi⁄Ve˘‹
 
ˇnd
, 
iMöNow
, 
cuºmv
 = {0, 0}, 
ˇnd_∑d
;

523 
li°
 = 
mv_block
->list;

524 
li°_off£t
 = 
cuºMB
->list_offset;

525 
ªf
 = 
mv_block
->
ªf_idx
;

526 
MŸi⁄Ve˘‹
 *
mv
 = &
mv_block
->mv[
li°
];

528 
St‹abÀPi˘uª
 *
ªf_pi˘uª
 = 
cuºSli˚
->
li°X
[
li°
+
li°_off£t
][
ªf
];

530 
dy«mic_£¨ch_ønge
 = 3, 
i
;

531 
m
;

532 
¥ed_‰ac_mv_x
,
¥ed_‰ac_mv_y
,
ab‹t_£¨ch
;

536 
¥ed_‰ac_mv_x
 = (
¥ed_mv
->
mv_x
 - 
mv
->mv_x) & 0x03;

537 
¥ed_‰ac_mv_y
 = (
¥ed_mv
->
mv_y
 - 
mv
->mv_y) & 0x03;

543 
	`mem£t
(
p_UMHex
->
SórchSèã
[0], 0,(2 * 
dy«mic_£¨ch_ønge
 + 1)*(2 * dynamic_search_range + 1));

545 if–!
p_Vid
->
°¨t_me_ªföemít_hp
 )

547 
p_UMHex
->
SórchSèã
[
dy«mic_£¨ch_ønge
][dynamic_search_range] = 1;

548 
ˇnd
 = *
mv
;

549 
mco°
 = 
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd
, 
¥ed_mv
);

550 
ˇnd_∑d
 = 
	`∑d_MVs
 (
ˇnd
, 
mv_block
);

551 
mco°
 +
mv_block
->
	`compuãPªdQPñ
–
ªf_pi˘uª
, mv_block, 
mö_mco°
 - mco°, &
ˇnd_∑d
);

553 i‡(
mco°
 < 
mö_mco°
)

555 
mö_mco°
 = 
mco°
;

556 
cuºmv
 = 
ˇnd
;

561 
p_UMHex
->
SórchSèã
[
dy«mic_£¨ch_ønge
][dynamic_search_range] = 1;

562 
cuºmv
 = *
mv
;

565 if(
¥ed_‰ac_mv_x
!=0 || 
¥ed_‰ac_mv_y
!=0)

567 
ˇnd
.
mv_x
 = (Ë(
mv
->mv_x + 
¥ed_‰ac_mv_x
);

568 
ˇnd
.
mv_y
 = (Ë(
mv
->mv_y + 
¥ed_‰ac_mv_y
);

569 
mco°
 = 
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd
, 
¥ed_mv
);

570 
p_UMHex
->
SórchSèã
[
ˇnd
.
mv_y
 -
mv
->mv_y + 
dy«mic_£¨ch_ønge
][ˇnd.
mv_x
 - mv->mv_x + dynamic_search_range] = 1;

571 
ˇnd_∑d
 = 
	`∑d_MVs
 (
ˇnd
, 
mv_block
);

573 
mco°
 +
mv_block
->
	`compuãPªdQPñ
–
ªf_pi˘uª
, mv_block, 
mö_mco°
 - mco°, &
ˇnd_∑d
);

575 i‡(
mco°
 < 
mö_mco°
)

577 
mö_mco°
 = 
mco°
;

578 
cuºmv
 = 
ˇnd
;

582 
iMöNow
 = 
cuºmv
;

584 
i
 = 0; i < 
dy«mic_£¨ch_ønge
; i++)

586 
ab‹t_£¨ch
=1;

587 
m
 = 0; m < 4; m++)

589 
ˇnd
.
mv_x
 = 
iMöNow
.mv_x + 
Düm⁄dQ
[
m
].mv_x;

590 
ˇnd
.
mv_y
 = 
iMöNow
.mv_y + 
Düm⁄dQ
[
m
].mv_y;

592 if(
	`übs
(
ˇnd
.
mv_x
 - 
mv
->mv_xË<
dy«mic_£¨ch_ønge
 && iabs(ˇnd.
mv_y
 - mv->mv_y) <= dynamic_search_range)

594 if(!
p_UMHex
->
SórchSèã
[
ˇnd
.
mv_y
 -
mv
->mv_y + 
dy«mic_£¨ch_ønge
][ˇnd.
mv_x
 -mv->mv_x + dynamic_search_range])

596 
p_UMHex
->
SórchSèã
[
ˇnd
.
mv_y
 -
mv
->mv_y + 
dy«mic_£¨ch_ønge
][ˇnd.
mv_x
 -mv->mv_x + dynamic_search_range] = 1;

597 
mco°
 = 
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd
, 
¥ed_mv
);

598 
ˇnd_∑d
 = 
	`∑d_MVs
 (
ˇnd
, 
mv_block
);

600 
mco°
 +
mv_block
->
	`compuãPªdQPñ
–
ªf_pi˘uª
, mv_block, 
mö_mco°
 - mco°, &
ˇnd_∑d
);

601 i‡(
mco°
 < 
mö_mco°
)

603 
mö_mco°
 = 
mco°
;

604 
cuºmv
 = 
ˇnd
;

605 
ab‹t_£¨ch
 = 0;

610 
iMöNow
 = 
cuºmv
;

611 if(
ab‹t_£¨ch
)

617 *
mv
 = 
cuºmv
;

620  
mö_mco°
;

621 
	}
}

623 
di°blk


624 
	$UMHEXSubPñBlockME
 (
Ma¸oblock
 *
cuºMB
,

625 
MŸi⁄Ve˘‹
 *
¥ed_mv
,

626 
MEBlock
 *
mv_block
,

627 
di°blk
 
mö_mco°
,

628 * 
œmbda


631 if(
mv_block
->
blockty≥
 >3)

633 
mö_mco°
 = 
	`UMHEXSubPñBlockMŸi⁄Sórch
 (
cuºMB
, 
¥ed_mv
, 
mv_block
, mö_mco°, 
œmbda
[
Q_PEL
]);

637 
mö_mco°
 = 
	`sub_≥l_mŸi⁄_e°im©i⁄
 (
cuºMB
, 
¥ed_mv
, 
mv_block
, mö_mco°, 
œmbda
);

640  
mö_mco°
;

641 
	}
}

655 
	$UMHEX_decide_öåabk_SAD
(
Ma¸oblock
 *
cuºMB
)

657 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

658 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

659 
UMHexSåu˘
 *
p_UMHex
 = 
p_Vid
->p_UMHex;

660 i‡(
cuºSli˚
->
¶i˚_ty≥
 !
I_SLICE
 && cuºSli˚->¶i˚_ty≥ !
SI_SLICE
)

662 i‡(
cuºMB
->
pix_x
 =0 && cuºMB->
pix_y
 == 0)

664 
p_UMHex
->
Êag_öåa_SAD
 = 0;

666 i‡(
cuºMB
->
pix_x
 == 0)

668 
p_UMHex
->
Êag_öåa_SAD
 =Ö_UMHex->
Êag_öåa
[(
cuºMB
->
pix_x
)>>4];

670 i‡(
cuºMB
->
pix_y
 == 0)

672 
p_UMHex
->
Êag_öåa_SAD
 =Ö_UMHex->
Êag_öåa
[((
cuºMB
->
pix_x
)>>4)-1];

676 
p_UMHex
->
Êag_öåa_SAD
 = (’_UMHex->
Êag_öåa
[(
cuºMB
->
pix_x
)>>4])||(p_UMHex->flag_intra[((currMB->pix_x)>>4)-1])||(p_UMHex->flag_intra[((currMB->pix_x)>>4)+1])) ;

680 
	}
}

682 
	$UMHEX_skù_öåabk_SAD
(
Ma¸oblock
 *
cuºMB
, 
ªf_max
)

684 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

685 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

686 
UMHexSåu˘
 *
p_UMHex
 = 
p_Vid
->p_UMHex;

687 
i
,
j
,
k
, 
ªf
;

688 i‡(
p_Vid
->
numbî
 > 0)

689 
p_UMHex
->
Êag_öåa
[(
cuºMB
->
pix_x
)>>4] = (cuºMB->
be°_mode
 == 9 || currMB->best_mode == 10) ? 1:0;

691 i‡(
cuºSli˚
->
¶i˚_ty≥
 !
I_SLICE
 && cuºSli˚->¶i˚_ty≥ !
SI_SLICE
 && (
cuºMB
->
be°_mode
 == 9 || currMB->best_mode == 10))

693 
k
=0; k < 9;k++)

695 
j
=0; j < 4; j++)

697 
i
=0; i < 4; i++)

699 
p_UMHex
->
Á°me_l0_co°
[
k
][
j
][
i
] = 0;

700 
p_UMHex
->
Á°me_l1_co°
[
k
][
j
][
i
] = 0;

702 
ªf
=0;Ñe‡< 
ªf_max
;ref++)

704 
p_UMHex
->
Á°me_ªf_co°
[
ªf
][
k
][
j
][
i
] = 0;

712 
	}
}

715 
	$UMHEX_£tup
(
Ma¸oblock
 *
cuºMB
, 
ªf
, 
li°
, 
block_y
, 
block_x
, 
blockty≥
, 
MŸi⁄Ve˘‹
 *****
Æl_mv
)

717 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

718 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

719 
UMHexSåu˘
 *
p_UMHex
 = 
p_Vid
->p_UMHex;

721 
N_B‰ame
=0;

722 
n_B‰ame
=0;

723 
ãmp_blockty≥
 = 0;

724 
ödiˇti⁄_blockty≥
[8]={0,0,1,1,2,4,4,5};

725 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

726 
N_B‰ame
 = 
p_I≈
->
NumbîBFømes
;

727 
n_B‰ame
 =(
N_B‰ame
Ë? (
p_Vid
->
p_Sèts
->
‰ame_˘r
[
B_SLICE
]%(N_Bframe+1)): 0;

732 i‡(
blockty≥
>1)

734 
ãmp_blockty≥
 = 
ödiˇti⁄_blockty≥
[
blockty≥
];

735 
p_UMHex
->
¥ed_MV_u∂ayî
[0] = 
Æl_mv
[
li°
][
ªf
][
ãmp_blockty≥
][
block_y
][
block_x
].
mv_x
;

736 
p_UMHex
->
¥ed_MV_u∂ayî
[1] = 
Æl_mv
[
li°
][
ªf
][
ãmp_blockty≥
][
block_y
][
block_x
].
mv_y
;

741 
p_UMHex
->
¥ed_MV_ªf_Êag
 = 0;

742 if(
li°
==0)

744 i‡(
p_Vid
->
fõld_pi˘uª
)

746 i‡–
ªf
 > 1)

748 
p_UMHex
->
¥ed_MV_ªf
[0] = 
Æl_mv
[0][
ªf
-2][
blockty≥
][
block_y
][
block_x
].
mv_x
;

749 
p_UMHex
->
¥ed_MV_ªf
[0] = ()’_UMHex->¥ed_MV_ªf[0]*((
ªf
>>1)+1)/()((ref>>1)));

750 
p_UMHex
->
¥ed_MV_ªf
[1] = 
Æl_mv
[0][
ªf
-2][
blockty≥
][
block_y
][
block_x
].
mv_y
;

751 
p_UMHex
->
¥ed_MV_ªf
[1] = ()’_UMHex->¥ed_MV_ªf[1]*((
ªf
>>1)+1)/()((ref>>1)));

752 
p_UMHex
->
¥ed_MV_ªf_Êag
 = 1;

754 i‡(
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
 && (
ªf
==0 ||Ñef==1) )

756 
p_UMHex
->
¥ed_MV_ªf
[0] =(Ë(
Æl_mv
[1][0][
blockty≥
][
block_y
][
block_x
].
mv_x
 * (-
n_B‰ame
)/(
N_B‰ame
-n_Bframe+1.0f));

757 
p_UMHex
->
¥ed_MV_ªf
[1] =(Ë(
Æl_mv
[1][0][
blockty≥
][
block_y
][
block_x
].
mv_y
 * (-
n_B‰ame
)/(
N_B‰ame
-n_Bframe+1.0f));

758 
p_UMHex
->
¥ed_MV_ªf_Êag
 = 1;

763 i‡–
ªf
 > 0)

765 
p_UMHex
->
¥ed_MV_ªf
[0] = 
Æl_mv
[0][
ªf
-1][
blockty≥
][
block_y
][
block_x
].
mv_x
;

766 
p_UMHex
->
¥ed_MV_ªf
[0] = ()’_UMHex->¥ed_MV_ªf[0]*(
ªf
+1)/()(ref));

767 
p_UMHex
->
¥ed_MV_ªf
[1] = 
Æl_mv
[0][
ªf
-1][
blockty≥
][
block_y
][
block_x
].
mv_y
;

768 
p_UMHex
->
¥ed_MV_ªf
[1] = ()’_UMHex->¥ed_MV_ªf[1]*(
ªf
+1)/()(ref));

769 
p_UMHex
->
¥ed_MV_ªf_Êag
 = 1;

771 i‡(
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
 && (
ªf
==0))

773 
p_UMHex
->
¥ed_MV_ªf
[0] =(Ë(
Æl_mv
[1][0][
blockty≥
][
block_y
][
block_x
].
mv_x
 * (-
n_B‰ame
)/(
N_B‰ame
-n_Bframe+1.0f));

774 
p_UMHex
->
¥ed_MV_ªf
[1] =(Ë(
Æl_mv
[1][0][
blockty≥
][
block_y
][
block_x
].
mv_y
 * (-
n_B‰ame
)/(
N_B‰ame
-n_Bframe+1.0f));

775 
p_UMHex
->
¥ed_MV_ªf_Êag
 = 1;

780 i‡(
li°
==0 && 
ªf
>0)

783 i‡(
p_UMHex
->
Êag_öåa_SAD
)

785 
p_UMHex
->
¥ed_SAD
 = 0;

789 i‡(
p_Vid
->
fõld_pi˘uª
)

791 i‡(
ªf
 > 1)

793 
p_UMHex
->
¥ed_SAD
 =Ö_UMHex->
Á°me_ªf_co°
[
ªf
-2][
blockty≥
][
block_y
][
block_x
];

797 
p_UMHex
->
¥ed_SAD
 =Ö_UMHex->
Á°me_ªf_co°
[0][
blockty≥
][
block_y
][
block_x
];

802 
p_UMHex
->
¥ed_SAD
 =Ö_UMHex->
Á°me_ªf_co°
[
ªf
-1][
blockty≥
][
block_y
][
block_x
];

807 i‡(
blockty≥
>1)

809 i‡(
p_UMHex
->
Êag_öåa_SAD
)

811 
p_UMHex
->
¥ed_SAD
 = 0;

815 
p_UMHex
->
¥ed_SAD
 = (
li°
==1Ë? (p_UMHex->
Á°me_l1_co°
[
ãmp_blockty≥
][(
cuºMB
->
block_y
)+block_y][(cuºMB->
block_x
)+block_x]Ë: (p_UMHex->
Á°me_l0_co°
[temp_blocktype][(currMB->block_y)+block_y][(currMB->block_x)+block_x]);

816 
p_UMHex
->
¥ed_SAD
 /= 2;

819 
p_UMHex
->
¥ed_SAD
 = 0 ;

821 
	}
}

838 
di°blk


839 
	$UMHEXBùªdI¡egîPñBlockMŸi⁄Sórch
 (
Ma¸oblock
 *
cuºMB
,

840 
li°
,

841 
MŸi⁄Ve˘‹
 *
¥ed_mv1
,

842 
MŸi⁄Ve˘‹
 *
¥ed_mv2
,

843 
MŸi⁄Ve˘‹
 *
mv1
,

844 
MŸi⁄Ve˘‹
 *
mv2
,

845 
MEBlock
 *
mv_block
,

846 
£¨ch_ønge
,

847 
di°blk
 
mö_mco°
,

848 
œmbda_Á˘‹


851 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

852 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

853 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

854 
UMHexSåu˘
 *
p_UMHex
 = 
p_Vid
->p_UMHex;

855 
ãmp_Big_Hexag⁄_X
[16];

856 
ãmp_Big_Hexag⁄_Y
[16];

858 
£¨ch_°ï
;

859 
i
,
m
,
j
;

860 
bëaFouπh_1
,
bëaFouπh_2
;

861 
pos
;

862 
di°blk
 
mco°
;

863 
blockty≥
 = 
mv_block
->blocktype;

864 
blocksize_x
 = 
mv_block
->blocksize_x;

865 
blocksize_y
 = 
mv_block
->blocksize_y;

867 
pic_pix_x
 = 
mv_block
->
pos_x_∑dded
;

868 
pic_pix_y
 = 
mv_block
->
pos_y_∑dded
;

870 
block_x
 = 
mv_block
->block_x;

871 
block_y
 = 
mv_block
->block_y;

872 
di°blk
 
ET_Thªd
 = 
p_UMHex
->
Medün_Pªd_Thd_MB
[
blockty≥
];

873 
ªf
 = 
mv_block
->
ªf_idx
;

875 
St‹abÀPi˘uª
 *
ªf_pi˘uª1
 = 
cuºSli˚
->
li°X
[
li°
 + 
cuºMB
->
li°_off£t
][
ªf
];

876 
St‹abÀPi˘uª
 *
ªf_pi˘uª2
 = 
cuºSli˚
->
li°X
[
li°
 =0 ? 1 + 
cuºMB
->
li°_off£t
: currMB->list_offset][ 0 ];

878 
MŸi⁄Ve˘‹
 
iMöNow
, 
be°
, 
ˇnd
;

880 
MŸi⁄Ve˘‹
 
¥ed1
 = 
	`∑d_MVs
(*
¥ed_mv1
, 
mv_block
);

881 
MŸi⁄Ve˘‹
 
¥ed2
 = 
	`∑d_MVs
(*
¥ed_mv2
, 
mv_block
);

882 
MŸi⁄Ve˘‹
 
˚¡î1
 = 
	`∑d_MVs
(*
mv1
, 
mv_block
);

883 
MŸi⁄Ve˘‹
 
˚¡î2
 = 
	`∑d_MVs
(*
mv2
, 
mv_block
);

886 
£¨ch_ønge
 >>= 2;

890 
	`mem£t
(
p_UMHex
->
Mco°Sèã
[0],0,(2*
£¨ch_ønge
+1)*(2*search_range+1));

893 
be°
 = 
ˇnd
 = 
˚¡î2
;

894 
mco°
 = 
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
˚¡î1
, &
¥ed1
);

895 
mco°
 +
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd
, &
¥ed2
);

896 
mco°
 +
mv_block
->
	`compuãBiPªdFPñ
(
ªf_pi˘uª1
, 
ªf_pi˘uª2
, mv_block, 
DISTBLK_MAX
-mco°, &
˚¡î1
, &
ˇnd
);

898 
p_UMHex
->
Mco°Sèã
[
£¨ch_ønge
][search_range] = 1;

900 i‡(
mco°
 < 
mö_mco°
)

902 
mö_mco°
 = 
mco°
;

903 
be°
 = 
ˇnd
;

906 
iMöNow
 = 
be°
;

907 
m
 = 0; m < 4; m++)

909 
ˇnd
.
mv_x
 = 
iMöNow
.mv_x + 
Düm⁄d
[
m
].mv_x;

910 
ˇnd
.
mv_y
 = 
iMöNow
.mv_y + 
Düm⁄d
[
m
].mv_y;

911 
SEARCH_ONE_PIXEL_BIPRED
;

914 if(
˚¡î2
.
mv_x
 !
pic_pix_x
 || cíãr2.
mv_y
 !
pic_pix_y
)

916 
ˇnd
.
mv_x
 = 
pic_pix_x
 ;

917 
ˇnd
.
mv_y
 = 
pic_pix_y
 ;

918 
SEARCH_ONE_PIXEL_BIPRED
;

920 
iMöNow
 = 
be°
;

922 
m
 = 0; m < 4; m++)

924 
ˇnd
.
mv_x
 = 
iMöNow
.mv_x + 
Düm⁄d
[
m
].mv_x;

925 
ˇnd
.
mv_y
 = 
iMöNow
.mv_y + 
Düm⁄d
[
m
].mv_y;

926 
SEARCH_ONE_PIXEL_BIPRED
;

931 if–
mö_mco°
 < 
ET_Thªd
)

933 
ãrmö©e_°ï
;

937 
N_B‰ame
=0;

938 
n_B‰ame
=0;

939 
MŸi⁄Ve˘‹
 *****
bùªd_mv
 = 
cuºSli˚
->bùªd_mv[
li°
];

940 
N_B‰ame
 = 
p_I≈
->
NumbîBFømes
;

941 
n_B‰ame
 = 
p_Vid
->
p_Sèts
->
‰ame_˘r
[
B_SLICE
]%(
N_B‰ame
+1);

950 if(
li°
==0)

952 i‡(
p_Vid
->
fõld_pi˘uª
)

954 
p_UMHex
->
¥ed_MV_ªf
[0] =(Ë(
bùªd_mv
[1][0][
blockty≥
][
block_y
][
block_x
].
mv_x
 * (-
n_B‰ame
)/(
N_B‰ame
-n_Bframe+1.0f));

955 
p_UMHex
->
¥ed_MV_ªf
[1] =(Ë(
bùªd_mv
[1][0][
blockty≥
][
block_y
][
block_x
].
mv_y
 * (-
n_B‰ame
)/(
N_B‰ame
-n_Bframe+1.0f));

959 
p_UMHex
->
¥ed_MV_ªf
[0] =(Ë(
bùªd_mv
[1][0][
blockty≥
][
block_y
][
block_x
].
mv_x
 * (-
n_B‰ame
)/(
N_B‰ame
-n_Bframe+1.0f));

960 
p_UMHex
->
¥ed_MV_ªf
[1] =(Ë(
bùªd_mv
[1][0][
blockty≥
][
block_y
][
block_x
].
mv_y
 * (-
n_B‰ame
)/(
N_B‰ame
-n_Bframe+1.0f));

964 
p_UMHex
->
¥ed_SAD
 =
	`di°blkmö
(di°blkmö’_UMHex->
SAD_a
,p_UMHex->
SAD_b
),p_UMHex->
SAD_c
);

965 
ET_Thªd
 = 
p_UMHex
->
Big_Hexag⁄_Thd_MB
[
blockty≥
];

968 i‡(
p_UMHex
->
¥ed_SAD
 == 0)

970 
bëaFouπh_1
=0;

971 
bëaFouπh_2
=0;

975 
bëaFouπh_1
 = 
p_UMHex
->
Bsize
[
blockty≥
]/’_UMHex->
¥ed_SAD
 *Ö_UMHex->¥ed_SAD)-p_UMHex->
AÕhaFouπh_1
[blocktype];

976 
bëaFouπh_2
 = 
p_UMHex
->
Bsize
[
blockty≥
]/’_UMHex->
¥ed_SAD
 *Ö_UMHex->¥ed_SAD)-p_UMHex->
AÕhaFouπh_2
[blocktype];

986 if(
li°
 == 0)

988 
ˇnd
.
mv_x
 = (Ë(
pic_pix_x
 + (
p_UMHex
->
¥ed_MV_ªf
[0] / 4) * 4);

989 
ˇnd
.
mv_y
 = (Ë(
pic_pix_y
 + (
p_UMHex
->
¥ed_MV_ªf
[1] / 4) * 4);

990 
SEARCH_ONE_PIXEL_BIPRED
;

995 
iMöNow
 = 
be°
;

996 
m
 = 0; m < 4; m++)

998 
ˇnd
.
mv_x
 = 
iMöNow
.mv_x + 
Düm⁄d
[
m
].mv_x;

999 
ˇnd
.
mv_y
 = 
iMöNow
.mv_y + 
Düm⁄d
[
m
].mv_y;

1000 
SEARCH_ONE_PIXEL_BIPRED
;

1004 
EARLY_TERMINATION
;

1008 
iMöNow
 = 
be°
;

1010 
i
 = 1; i < 
£¨ch_ønge
; i+=2)

1012 
£¨ch_°ï
 = 
i
;

1013 
ˇnd
.
mv_x
 = (Ë(
iMöNow
.mv_x + 
£¨ch_°ï
);

1014 
ˇnd
.
mv_y
 = 
iMöNow
.mv_y ;

1015 
SEARCH_ONE_PIXEL_BIPRED
;

1016 
ˇnd
.
mv_x
 = (Ë(
iMöNow
.mv_x - 
£¨ch_°ï
);

1017 
SEARCH_ONE_PIXEL_BIPRED
;

1020 
i
 = 1; i < (
£¨ch_ønge
 >> 1);i+=2)

1022 
£¨ch_°ï
 = 
i
;

1023 
ˇnd
.
mv_x
 = 
iMöNow
.mv_x ;

1024 
ˇnd
.
mv_y
 = (Ë(
iMöNow
.mv_y + 
£¨ch_°ï
);

1025 
SEARCH_ONE_PIXEL_BIPRED
;

1026 
ˇnd
.
mv_y
 = (Ë(
iMöNow
.mv_y - 
£¨ch_°ï
);

1027 
SEARCH_ONE_PIXEL_BIPRED
;

1030 
EARLY_TERMINATION
;

1033 
iMöNow
 = 
be°
;

1035 
pos
=1;pos<25;pos++)

1037 
ˇnd
.
mv_x
 = 
iMöNow
.mv_x + 
p_Vid
->
•úÆ_q≥l_£¨ch
[
pos
].mv_x;

1038 
ˇnd
.
mv_y
 = 
iMöNow
.mv_y + 
p_Vid
->
•úÆ_q≥l_£¨ch
[
pos
].mv_y;

1039 
SEARCH_ONE_PIXEL_BIPRED
;

1043 
EARLY_TERMINATION
;

1046 
	`mem˝y
(
ãmp_Big_Hexag⁄_X
,
Big_Hexag⁄_X
,64);

1047 
	`mem˝y
(
ãmp_Big_Hexag⁄_Y
,
Big_Hexag⁄_Y
,64);

1048 
i
=1;i<=(
p_I≈
->
£¨ch_ønge
[
p_Vid
->
võw_id
] >> 2); i++)

1051 
m
 = 0; m < 16; m++)

1053 
ˇnd
.
mv_x
 = (Ë(
iMöNow
.mv_x + 
ãmp_Big_Hexag⁄_X
[
m
]);

1054 
ˇnd
.
mv_y
 = (Ë(
iMöNow
.mv_y + 
ãmp_Big_Hexag⁄_Y
[
m
]);

1055 
ãmp_Big_Hexag⁄_X
[
m
] +
Big_Hexag⁄_X
[m];

1056 
ãmp_Big_Hexag⁄_Y
[
m
] +
Big_Hexag⁄_Y
[m];

1058 
SEARCH_ONE_PIXEL_BIPRED
;

1060 if(
mö_mco°
 < 
ET_Thªd
)

1062 
ãrmö©e_°ï
;

1067 
fouπh_1_°ï
:

1069 
i
=0; i < 
£¨ch_ønge
; i++)

1071 
iMöNow
 = 
be°
;

1072 
m
 = 0; m < 6; m++)

1074 
ˇnd
.
mv_x
 = 
iMöNow
.mv_x + 
Hexag⁄
[
m
].mv_x;

1075 
ˇnd
.
mv_y
 = 
iMöNow
.mv_y + 
Hexag⁄
[
m
].mv_y;

1076 
SEARCH_ONE_PIXEL_BIPRED
;

1078 if(
be°
.
mv_x
 =
iMöNow
.mv_x && be°.
mv_y
 == iMinNow.mv_y)

1081 
fouπh_2_°ï
:

1083 
i
 = 0; i < 
£¨ch_ønge
; i++)

1085 
iMöNow
 = 
be°
;

1086 
m
 = 0; m < 4; m++)

1088 
ˇnd
.
mv_x
 = 
iMöNow
.mv_x + 
Düm⁄d
[
m
].mv_x;

1089 
ˇnd
.
mv_y
 = 
iMöNow
.mv_y + 
Düm⁄d
[
m
].mv_y;

1090 
SEARCH_ONE_PIXEL_BIPRED
;

1092 if(
be°
.
mv_x
 =
iMöNow
.mv_x && be°.
mv_y
 == iMinNow.mv_y)

1096 
ãrmö©e_°ï
:

1097 
i
=0; i < (
blocksize_x
>>2); i++)

1099 
j
=0; j < (
blocksize_y
>>2); j++)

1101 if(
li°
 == 0)

1103 
p_UMHex
->
Á°me_l0_co°_bùªd
[
blockty≥
][(
cuºMB
->
block_y
)+block_y+
j
][(cuºMB->
block_x
)+block_x+
i
] = 
mö_mco°
;

1107 
p_UMHex
->
Á°me_l1_co°_bùªd
[
blockty≥
][(
cuºMB
->
block_y
)+block_y+
j
][(cuºMB->
block_x
)+block_x+
i
] = 
mö_mco°
;

1112 
mv1
->
mv_x
 = (Ë(
be°
.mv_x - 
pic_pix_x
);

1113 
mv1
->
mv_y
 = (Ë(
be°
.mv_y - 
pic_pix_y
);

1115  
mö_mco°
;

1116 
	}
}

1124 
	$UMHEXSëMŸi⁄Ve˘‹Pªdi˘‹
 (
Ma¸oblock
 *
cuºMB
,

1125 
MŸi⁄Ve˘‹
 *
pmv
,

1126 
pic_mŸi⁄_∑øms
 **
mv_öfo
,

1127 
ªf_‰ame
,

1128 
li°
,

1129 
mb_x
,

1130 
mb_y
,

1131 
blocksh≠e_x
,

1132 
blocksh≠e_y
,

1133 
MEBlock
 *
mv_block
)

1135 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1136 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

1137 
UMHexSåu˘
 *
p_UMHex
 = 
p_Vid
->p_UMHex;

1138 
mv_a
, 
mv_b
, 
mv_c
;

1139 
¥ed_vec
=0;

1140 
mvPªdTy≥
, 
rFømeL
, 
rFømeU
, 
rFømeUR
;

1141 
hv
;

1143 
PixñPos
 
block_a
, 
block_b
, 
block_c
, 
block_d
;

1146 
di°blk
 *** 
Á°me_l0_co°_Êag
 = (
p_UMHex
->
bùªd_Êag
 ?Ö_UMHex->
Á°me_l0_co°_bùªd
 :Ö_UMHex->
Á°me_l0_co°
);

1147 
di°blk
 *** 
Á°me_l1_co°_Êag
 = (
p_UMHex
->
bùªd_Êag
 ?Ö_UMHex->
Á°me_l1_co°_bùªd
 :Ö_UMHex->
Á°me_l1_co°
);

1150 
d§_ãmp_£¨ch_ønge
[2];

1151 
d§_mv_avaû
, 
d§_mv_max
, 
d§_mv_sum
, 
d§_smÆl_£¨ch_ønge
;

1152 *
mb_size
 = 
p_Vid
->mb_size[
IS_LUMA
];

1155 
p_UMHex
->
SAD_a
 = 0;

1156 
p_UMHex
->
SAD_b
 = 0;

1157 
p_UMHex
->
SAD_c
 = 0;

1158 
p_UMHex
->
SAD_d
 = 0;

1160 
	`gë4x4Neighbour
(
cuºMB
, 
mb_x
 - 1 , 
mb_y
 , 
mb_size
, &
block_a
);

1161 
	`gë4x4Neighbour
(
cuºMB
, 
mb_x
 , 
mb_y
 - 1, 
mb_size
, &
block_b
);

1162 
	`gë4x4Neighbour
(
cuºMB
, 
mb_x
 + 
blocksh≠e_x
, 
mb_y
 - 1, 
mb_size
, &
block_c
);

1163 
	`gë4x4Neighbour
(
cuºMB
, 
mb_x
 - 1 , 
mb_y
 - 1, 
mb_size
, &
block_d
);

1165 i‡(
mb_y
 > 0)

1167 i‡(
mb_x
 < 8)

1169 i‡(
mb_y
==8)

1171 i‡(
blocksh≠e_x
 =16Ë
block_c
.
avaûabÀ
 = 0;

1175 i‡(
mb_x
+
blocksh≠e_x
 =8Ë
block_c
.
avaûabÀ
 = 0;

1180 i‡(
mb_x
+
blocksh≠e_x
 =16Ë
block_c
.
avaûabÀ
 = 0;

1184 i‡(!
block_c
.
avaûabÀ
)

1186 
block_c
=
block_d
;

1189 
mvPªdTy≥
 = 
MVPRED_MEDIAN
;

1191 i‡(!
p_Vid
->
mb_aff_‰ame_Êag
)

1193 
rFømeL
 = 
block_a
.
avaûabÀ
 ? 
mv_öfo
[block_a.
pos_y
][block_a.
pos_x
].
ªf_idx
[
li°
] : -1;

1194 
rFømeU
 = 
block_b
.
avaûabÀ
 ? 
mv_öfo
[block_b.
pos_y
][block_b.
pos_x
].
ªf_idx
[
li°
] : -1;

1195 
rFømeUR
 = 
block_c
.
avaûabÀ
 ? 
mv_öfo
[block_c.
pos_y
][block_c.
pos_x
].
ªf_idx
[
li°
] : -1;

1199 i‡(
p_Vid
->
mb_d©a
[
cuºMB
->
mbAddrX
].
mb_fõld
)

1201 
rFømeL
 = 
block_a
.
avaûabÀ


1202 ? (
p_Vid
->
mb_d©a
[
block_a
.
mb_addr
].
mb_fõld


1203 ? 
mv_öfo
[
block_a
.
pos_y
][block_a.
pos_x
].
ªf_idx
[
li°
]

1204 : 
mv_öfo
[
block_a
.
pos_y
][block_a.
pos_x
].
ªf_idx
[
li°
] * 2) : -1;

1205 
rFømeU
 = 
block_b
.
avaûabÀ


1206 ? (
p_Vid
->
mb_d©a
[
block_b
.
mb_addr
].
mb_fõld


1207 ? 
mv_öfo
[
block_b
.
pos_y
][block_b.
pos_x
].
ªf_idx
[
li°
]

1208 : 
mv_öfo
[
block_b
.
pos_y
][block_b.
pos_x
].
ªf_idx
[
li°
] * 2) : -1;

1209 
rFømeUR
 = 
block_c
.
avaûabÀ


1210 ? (
p_Vid
->
mb_d©a
[
block_c
.
mb_addr
].
mb_fõld


1211 ? 
mv_öfo
[
block_c
.
pos_y
][block_c.
pos_x
].
ªf_idx
[
li°
]

1212 : 
mv_öfo
[
block_c
.
pos_y
][block_c.
pos_x
].
ªf_idx
[
li°
] * 2) : -1;

1216 
rFømeL
 = 
block_a
.
avaûabÀ


1217 ? (
p_Vid
->
mb_d©a
[
block_a
.
mb_addr
].
mb_fõld


1218 ? 
mv_öfo
[
block_a
.
pos_y
][block_a.
pos_x
].
ªf_idx
[
li°
] >>1

1219 : 
mv_öfo
[
block_a
.
pos_y
][block_a.
pos_x
].
ªf_idx
[
li°
]) : -1;

1220 
rFømeU
 = 
block_b
.
avaûabÀ
 ?

1221 
p_Vid
->
mb_d©a
[
block_b
.
mb_addr
].
mb_fõld
 ?

1222 
mv_öfo
[
block_b
.
pos_y
][block_b.
pos_x
].
ªf_idx
[
li°
] >>1:

1223 
mv_öfo
[
block_b
.
pos_y
][block_b.
pos_x
].
ªf_idx
[
li°
] :

1225 
rFømeUR
 = 
block_c
.
avaûabÀ
 ?

1226 
p_Vid
->
mb_d©a
[
block_c
.
mb_addr
].
mb_fõld
 ?

1227 
mv_öfo
[
block_c
.
pos_y
][block_c.
pos_x
].
ªf_idx
[
li°
] >>1:

1228 
mv_öfo
[
block_c
.
pos_y
][block_c.
pos_x
].
ªf_idx
[
li°
] :

1236 if(
rFømeL
 =
ªf_‰ame
 && 
rFømeU
 !ªf_‰amê&& 
rFømeUR
 !ªf_‰ameË
mvPªdTy≥
 = 
MVPRED_L
;

1237 if(
rFømeL
 !
ªf_‰ame
 && 
rFømeU
 =ªf_‰amê&& 
rFømeUR
 !ªf_‰ameË
mvPªdTy≥
 = 
MVPRED_U
;

1238 if(
rFømeL
 !
ªf_‰ame
 && 
rFømeU
 !ªf_‰amê&& 
rFømeUR
 =ªf_‰ameË
mvPªdTy≥
 = 
MVPRED_UR
;

1240 if(
blocksh≠e_x
 =8 && 
blocksh≠e_y
 == 16)

1242 if(
mb_x
 == 0)

1244 if(
rFømeL
 =
ªf_‰ame
)

1245 
mvPªdTy≥
 = 
MVPRED_L
;

1249 if–
rFømeUR
 =
ªf_‰ame
)

1250 
mvPªdTy≥
 = 
MVPRED_UR
;

1253 if(
blocksh≠e_x
 =16 && 
blocksh≠e_y
 == 8)

1255 if(
mb_y
 == 0)

1257 if(
rFømeU
 =
ªf_‰ame
)

1258 
mvPªdTy≥
 = 
MVPRED_U
;

1262 if(
rFømeL
 =
ªf_‰ame
)

1263 
mvPªdTy≥
 = 
MVPRED_L
;

1268 if((
p_I≈
->
UMHexDSR
 =1 ||Ö_I≈->
BiPªdMŸi⁄E°im©i⁄
 == 1))

1270 
p_UMHex
->
SAD_a
 = 
block_a
.
avaûabÀ
 ? ((
li°
==1Ë? (
Á°me_l1_co°_Êag
[p_UMHex->
UMHEX_blockty≥
][block_a.
pos_y
][block_a.
pos_x
]Ë: (
Á°me_l0_co°_Êag
[p_UMHex->UMHEX_blocktype][block_a.pos_y][block_a.pos_x])) : 0;

1271 
p_UMHex
->
SAD_b
 = 
block_b
.
avaûabÀ
 ? ((
li°
==1Ë? (
Á°me_l1_co°_Êag
[p_UMHex->
UMHEX_blockty≥
][block_b.
pos_y
][block_b.
pos_x
]Ë: (
Á°me_l0_co°_Êag
[p_UMHex->UMHEX_blocktype][block_b.pos_y][block_b.pos_x])) : 0;

1272 
p_UMHex
->
SAD_d
 = 
block_d
.
avaûabÀ
 ? ((
li°
==1Ë? (
Á°me_l1_co°_Êag
[p_UMHex->
UMHEX_blockty≥
][block_d.
pos_y
][block_d.
pos_x
]Ë: (
Á°me_l0_co°_Êag
[p_UMHex->UMHEX_blocktype][block_d.pos_y][block_d.pos_x])) : 0;

1273 
p_UMHex
->
SAD_c
 = 
block_c
.
avaûabÀ
 ? ((
li°
==1Ë? (
Á°me_l1_co°_Êag
[p_UMHex->
UMHEX_blockty≥
][block_c.
pos_y
][block_c.
pos_x
]Ë: (
Á°me_l0_co°_Êag
[p_UMHex->UMHEX_blockty≥][block_c.pos_y][block_c.pos_x])Ë:Ö_UMHex->
SAD_d
;

1275 
hv
=0; hv < 2; hv++)

1277 i‡(!
p_Vid
->
mb_aff_‰ame_Êag
 || 
hv
==0)

1279 
mv_a
 = 
block_a
.
avaûabÀ
 ? 
mv_öfo
[block_a.
pos_y
][block_a.
pos_x
].
mv
[
li°
].
mv_x
 : 0;

1280 
mv_b
 = 
block_b
.
avaûabÀ
 ? 
mv_öfo
[block_b.
pos_y
][block_b.
pos_x
].
mv
[
li°
].
mv_x
 : 0;

1281 
mv_c
 = 
block_c
.
avaûabÀ
 ? 
mv_öfo
[block_c.
pos_y
][block_c.
pos_x
].
mv
[
li°
].
mv_x
 : 0;

1285 i‡(
p_Vid
->
mb_d©a
[
cuºMB
->
mbAddrX
].
mb_fõld
)

1287 
mv_a
 = 
block_a
.
avaûabÀ
 ? 
p_Vid
->
mb_d©a
[block_a.
mb_addr
].
mb_fõld


1288 ? 
mv_öfo
[
block_a
.
pos_y
][block_a.
pos_x
].
mv
[
li°
].
mv_y


1289 : 
mv_öfo
[
block_a
.
pos_y
][block_a.
pos_x
].
mv
[
li°
].
mv_y
 / 2

1291 
mv_b
 = 
block_b
.
avaûabÀ
 ? 
p_Vid
->
mb_d©a
[block_b.
mb_addr
].
mb_fõld


1292 ? 
mv_öfo
[
block_b
.
pos_y
][block_b.
pos_x
].
mv
[
li°
].
mv_y


1293 : 
mv_öfo
[
block_b
.
pos_y
][block_b.
pos_x
].
mv
[
li°
].
mv_y
 / 2

1295 
mv_c
 = 
block_c
.
avaûabÀ
 ? 
p_Vid
->
mb_d©a
[block_c.
mb_addr
].
mb_fõld


1296 ? 
mv_öfo
[
block_c
.
pos_y
][block_c.
pos_x
].
mv
[
li°
].
mv_y


1297 : 
mv_öfo
[
block_c
.
pos_y
][block_c.
pos_x
].
mv
[
li°
].
mv_y
 / 2

1302 
mv_a
 = 
block_a
.
avaûabÀ
 ? 
p_Vid
->
mb_d©a
[block_a.
mb_addr
].
mb_fõld


1303 ? 
mv_öfo
[
block_a
.
pos_y
][block_a.
pos_x
].
mv
[
li°
].
mv_y
 * 2

1304 : 
mv_öfo
[
block_a
.
pos_y
][block_a.
pos_x
].
mv
[
li°
].
mv_y


1306 
mv_b
 = 
block_b
.
avaûabÀ
 ? 
p_Vid
->
mb_d©a
[block_b.
mb_addr
].
mb_fõld


1307 ? 
mv_öfo
[
block_b
.
pos_y
][block_b.
pos_x
].
mv
[
li°
].
mv_y
 * 2

1308 : 
mv_öfo
[
block_b
.
pos_y
][block_b.
pos_x
].
mv
[
li°
].
mv_y


1310 
mv_c
 = 
block_c
.
avaûabÀ
 ? 
p_Vid
->
mb_d©a
[block_c.
mb_addr
].
mb_fõld


1311 ? 
mv_öfo
[
block_c
.
pos_y
][block_c.
pos_x
].
mv
[
li°
].
mv_y
 * 2

1312 : 
mv_öfo
[
block_c
.
pos_y
][block_c.
pos_x
].
mv
[
li°
].
mv_y


1317 
mvPªdTy≥
)

1319 
MVPRED_MEDIAN
:

1320 if(!(
block_b
.
avaûabÀ
 || 
block_c
.available))

1322 
¥ed_vec
 = (Ë
mv_a
;

1326 
¥ed_vec
 = (Ë(
mv_a
+
mv_b
+
mv_c
-
	`imö
(mv_a,imö(mv_b,mv_c))-
	`imax
(mv_a,imax(mv_b,mv_c)));

1329 
MVPRED_L
:

1330 
¥ed_vec
 = (Ë
mv_a
;

1332 
MVPRED_U
:

1333 
¥ed_vec
 = (Ë
mv_b
;

1335 
MVPRED_UR
:

1336 
¥ed_vec
 = (Ë
mv_c
;

1342 i‡(
hv
 == 0)

1343 
pmv
->
mv_x
 = 
¥ed_vec
;

1344 
pmv
->
mv_y
 = 
¥ed_vec
;

1347 i‡(
p_I≈
->
UMHexDSR
)

1349 
d§_mv_avaû
=
block_a
.
avaûabÀ
+
block_b
.avaûabÀ+
block_c
.available;

1350 if(
d§_mv_avaû
 < 2)

1352 
d§_ãmp_£¨ch_ønge
[
hv
] = 
p_I≈
->
£¨ch_ønge
[
p_Vid
->
võw_id
];

1356 
d§_mv_max
 = 
	`imax
(
	`übs
(
mv_a
),imax(übs(
mv_b
),übs(
mv_c
)));

1357 
d§_mv_sum
 = (
	`übs
(
mv_a
)+übs(
mv_b
)+übs(
mv_c
));

1358 if(
d§_mv_sum
 =0Ë
d§_smÆl_£¨ch_ønge
 = (
p_I≈
->
£¨ch_ønge
[
p_Vid
->
võw_id
] + 4) >> 3;

1359 if(
d§_mv_sum
 > 3 ) 
d§_smÆl_£¨ch_ønge
 = (
p_I≈
->
£¨ch_ønge
[
p_Vid
->
võw_id
] + 2) >>2;

1360 
d§_smÆl_£¨ch_ønge
 = (3*
p_I≈
->
£¨ch_ønge
[
p_Vid
->
võw_id
] + 8) >> 4;

1361 
d§_ãmp_£¨ch_ønge
[
hv
]=
	`imö
(
p_I≈
->
£¨ch_ønge
[
p_Vid
->
võw_id
],
	`imax
(
d§_smÆl_£¨ch_ønge
,
d§_mv_max
<<1));

1362 if(
	`di°blkmax
(
p_UMHex
->
SAD_a
, di°blkmax’_UMHex->
SAD_b
,p_UMHex->
SAD_c
)Ë>Ö_UMHex->
Thªshﬁd_DSR_MB
[p_UMHex->
UMHEX_blockty≥
])

1363 
d§_ãmp_£¨ch_ønge
[
hv
] = 
p_I≈
->
£¨ch_ønge
[
p_Vid
->
võw_id
];

1369 i‡(
p_I≈
->
UMHexDSR
)

1371 
£¨ch_ønge
 = 
	`imax
(
d§_ãmp_£¨ch_ønge
[0],dsr_temp_search_range[1]);

1372 
£¨ch_ønge
 <<= 2;

1374 i‡(
p_I≈
->
fuŒ_£¨ch
 == 2)

1376 
mv_block
->
£¨chR™ge
.
mö_x
 = -
£¨ch_ønge
;

1377 
mv_block
->
£¨chR™ge
.
max_x
 = 
£¨ch_ønge
;

1378 
mv_block
->
£¨chR™ge
.
mö_y
 = -
£¨ch_ønge
;

1379 
mv_block
->
£¨chR™ge
.
max_y
 = 
£¨ch_ønge
;

1381 i‡(
p_I≈
->
fuŒ_£¨ch
 == 1)

1383 
sˇÀ
 = (
	`imö
(
ªf_‰ame
,1)+1);

1384 
mv_block
->
£¨chR™ge
.
mö_x
 = -
£¨ch_ønge
 / 
sˇÀ
;

1385 
mv_block
->
£¨chR™ge
.
max_x
 = 
£¨ch_ønge
 / 
sˇÀ
;

1386 
mv_block
->
£¨chR™ge
.
mö_y
 = -
£¨ch_ønge
 / 
sˇÀ
;

1387 
mv_block
->
£¨chR™ge
.
max_y
 = 
£¨ch_ønge
 / 
sˇÀ
;

1391 
sˇÀ
 = ((
	`imö
(
ªf_‰ame
,1)+1Ë* imö(2,
p_UMHex
->
BlockTy≥_LUT
[(
blocksh≠e_y
 >> 2Ë- 1][(
blocksh≠e_x
 >> 2) - 1]));

1392 
mv_block
->
£¨chR™ge
.
mö_x
 = -
£¨ch_ønge
 / 
sˇÀ
;

1393 
mv_block
->
£¨chR™ge
.
max_x
 = 
£¨ch_ønge
 / 
sˇÀ
;

1394 
mv_block
->
£¨chR™ge
.
mö_y
 = -
£¨ch_ønge
 / 
sˇÀ
;

1395 
mv_block
->
£¨chR™ge
.
max_y
 = 
£¨ch_ønge
 / 
sˇÀ
;

1398 
	}
}

1402 
di°blk


1403 
	$ModifõdUMHEXI¡egîPñBlockMŸi⁄Sórch
 (
Ma¸oblock
 *
cuºMB
,

1404 
MŸi⁄Ve˘‹
 *
¥ed_mv
,

1405 
MEBlock
 *
mv_block
,

1406 
di°blk
 
mö_mco°
,

1407 
œmbda_Á˘‹


1410 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1411 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1412 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

1413 
UMHexSåu˘
 *
p_UMHex
 = 
p_Vid
->p_UMHex;

1415 
blockty≥
 = 
mv_block
->blocktype;

1416 
blocksize_x
 = 
mv_block
->blocksize_x;

1417 
blocksize_y
 = 
mv_block
->blocksize_y;

1418 
pic_pix_x2
 = 
mv_block
->
pos_x2
;

1419 
block_x
 = 
mv_block
->block_x;

1420 
block_y
 = 
mv_block
->block_y;

1422 
li°
 = 
mv_block
->list;

1423 
cur_li°
 = 
li°
 + 
cuºMB
->
li°_off£t
;

1424 
ªf
 = 
mv_block
->
ªf_idx
;

1425 
St‹abÀPi˘uª
 *
ªf_pi˘uª
 = 
cuºSli˚
->
li°X
[
cur_li°
][
ªf
];

1427 
MŸi⁄Ve˘‹
 *
mv
 = &
mv_block
->mv[
li°
];

1428 
MŸi⁄Ve˘‹
 
iMöNow
, 
ˇnd
, 
˚¡î
, 
¥ed
, 
be°
 = {0, 0};

1430 
£¨ch_°ï
;

1431 
pos
;

1432 
di°blk
 
mco°
;

1433 
di°blk
 *
SAD_¥edi˘i⁄
 = 
p_UMHex
->
Á°me_be°_co°
[
blockty≥
-1];

1434 
i
, 
j
, 
m
;

1435 
bëaFouπh_1
,
bëaFouπh_2
;

1436 
ãmp_Big_Hexag⁄_X
[16];

1437 
ãmp_Big_Hexag⁄_Y
[16];

1438 
di°blk
 
ET_Thªd
 = 
p_UMHex
->
Medün_Pªd_Thd_MB
[
blockty≥
];

1439 
£¨ch_ønge
 = 
mv_block
->
£¨chR™ge
.
max_x
 >> 2;

1441 
pic_pix_x
 = 
mv_block
->
pos_x_∑dded
;

1442 
pic_pix_y
 = 
mv_block
->
pos_y_∑dded
;

1443 
¥ed
.
mv_x
 = 
pic_pix_x
 + 
¥ed_mv
->mv_x;

1444 
¥ed
.
mv_y
 = 
pic_pix_y
 + 
¥ed_mv
->mv_y;

1445 
˚¡î
.
mv_x
 = 
pic_pix_x
 + 
mv
->mv_x;

1446 
˚¡î
.
mv_y
 = 
pic_pix_y
 + 
mv
->mv_y;

1450 
L_CENTERBIASED
 , 
U_CENTERBIASED
, 
RU_CENTERBIASED
, 
LU_CENTERBIASED
;

1452 if(
cuºMB
->
mbAvaûA
)

1453 
L_CENTERBIASED
 = 
p_Vid
->
mb_d©a
[
cuºMB
->
mbAddrA
].
isCíãrBü£d
;

1455 
L_CENTERBIASED
 = 0;

1456 if(
cuºMB
->
mbAvaûB
)

1457 
U_CENTERBIASED
 = 
p_Vid
->
mb_d©a
[
cuºMB
->
mbAddrB
].
isCíãrBü£d
;

1459 
U_CENTERBIASED
 = 0;

1460 if(
cuºMB
->
mbAvaûC
)

1461 
RU_CENTERBIASED
 = 
p_Vid
->
mb_d©a
[
cuºMB
->
mbAddrC
].
isCíãrBü£d
;

1463 
RU_CENTERBIASED
 = 0;

1464 if(
cuºMB
->
mbAvaûD
)

1465 
LU_CENTERBIASED
 = 
p_Vid
->
mb_d©a
[
cuºMB
->
mbAddrD
].
isCíãrBü£d
;

1467 
LU_CENTERBIASED
 = 0;

1469 
˚¡îBü£d
 = 
L_CENTERBIASED
 + 
U_CENTERBIASED
 + 
RU_CENTERBIASED
 + 
LU_CENTERBIASED
;

1472 
	`mem£t
(
p_UMHex
->
Mco°Sèã
[0],0,(2*
p_I≈
->
£¨ch_ønge
[
p_Vid
->
võw_id
]+1)*(2*p_Inp->search_range[p_Vid->view_id]+1));

1477 
ˇnd
 = 
˚¡î
;

1478 
mco°
 = 
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd
, &
¥ed
);

1480 
mco°
 +
mv_block
->
	`compuãPªdFPñ
(
ªf_pi˘uª
, mv_block, 
mö_mco°
 - mco°, &
ˇnd
);

1482 
p_UMHex
->
Mco°Sèã
[
£¨ch_ønge
][search_range] = 1;

1483 i‡(
mco°
 < 
mö_mco°
)

1485 
mö_mco°
 = 
mco°
;

1486 
be°
 = 
ˇnd
;

1489 
iMöNow
 = 
be°
;

1491 
m
 = 0; m < 4; m++)

1493 
ˇnd
.
mv_x
 = 
iMöNow
.mv_x + 
Düm⁄d
[
m
].mv_x;

1494 
ˇnd
.
mv_y
 = 
iMöNow
.mv_y + 
Düm⁄d
[
m
].mv_y;

1495 
SEARCH_ONE_PIXEL


1498 if(
˚¡î
.
mv_x
 !
pic_pix_x
 || cíãr.
mv_y
 !
pic_pix_y
)

1500 
ˇnd
.
mv_x
 = 
pic_pix_x
 ;

1501 
ˇnd
.
mv_y
 = 
pic_pix_y
 ;

1502 
SEARCH_ONE_PIXEL


1503 
iMöNow
 = 
be°
;

1504 
m
 = 0; m < 4; m++)

1506 
ˇnd
.
mv_x
 = 
iMöNow
.mv_x + 
Düm⁄d
[
m
].mv_x;

1507 
ˇnd
.
mv_y
 = 
iMöNow
.mv_y + 
Düm⁄d
[
m
].mv_y;

1508 
SEARCH_ONE_PIXEL


1513 if(
ªf
>0 && 
cuºSli˚
->
°ru˘uª
 =
FRAME
 && 
mö_mco°
 > 
ET_Thªd
 && 
SAD_¥edi˘i⁄
[
pic_pix_x2
] < 
p_UMHex
->
Mu…i_Ref_Thd_MB
[
blockty≥
])

1514 
ãrmö©e_°ï
;

1517 if–
mö_mco°
 < 
ET_Thªd
)

1519 
ãrmö©e_°ï
;

1524 
	`UMHEX_£tup
(
cuºMB
, 
ªf
, 
mv_block
->
li°
, 
block_y
, 
block_x
, 
blockty≥
, 
cuºSli˚
->
Æl_mv
 );

1525 
ET_Thªd
 = 
p_UMHex
->
Big_Hexag⁄_Thd_MB
[
blockty≥
];

1528 i‡(
p_UMHex
->
¥ed_SAD
 == 0)

1530 
bëaFouπh_1
=0;

1531 
bëaFouπh_2
=0;

1535 
bëaFouπh_1
 = 
p_UMHex
->
Bsize
[
blockty≥
]/((Ì_UMHex->
¥ed_SAD
 *Ö_UMHex->¥ed_SAD)-p_UMHex->
AÕhaFouπh_1
[blocktype];

1536 
bëaFouπh_2
 = 
p_UMHex
->
Bsize
[
blockty≥
]/((Ì_UMHex->
¥ed_SAD
 *Ö_UMHex->¥ed_SAD)-p_UMHex->
AÕhaFouπh_2
[blocktype];

1543 if(
blockty≥
>1)

1545 
ˇnd
.
mv_x
 = (Ë(
pic_pix_x
 + (
p_UMHex
->
¥ed_MV_u∂ayî
[0] / 4) * 4);

1546 
ˇnd
.
mv_y
 = (Ë(
pic_pix_y
 + (
p_UMHex
->
¥ed_MV_u∂ayî
[1] / 4) * 4);

1547 
SEARCH_ONE_PIXEL


1552 if(
p_UMHex
->
¥ed_MV_ªf_Êag
 == 1)

1554 
ˇnd
.
mv_x
 = (Ë(
pic_pix_x
 + (
p_UMHex
->
¥ed_MV_ªf
[0] / 4) * 4);

1555 
ˇnd
.
mv_y
 = (Ë(
pic_pix_y
 + (
p_UMHex
->
¥ed_MV_ªf
[1] / 4) * 4);

1556 
SEARCH_ONE_PIXEL


1559 
iMöNow
 = 
be°
;

1560 
m
 = 0; m < 4; m++)

1562 
ˇnd
.
mv_x
 = 
iMöNow
.mv_x + 
Düm⁄d
[
m
].mv_x;

1563 
ˇnd
.
mv_y
 = 
iMöNow
.mv_y + 
Düm⁄d
[
m
].mv_y;

1564 
SEARCH_ONE_PIXEL


1568 
EARLY_TERMINATION


1570 if(
blockty≥
>6)

1571 
fouπh_1_°ï
;

1573 
£c_°ï
;

1575 
£c_°ï
:

1576 
iMöNow
 = 
be°
;

1578 
¸oss_°ï
 = 4;

1580 
i
 = 4; i < 
£¨ch_ønge
 << 2; i+=
¸oss_°ï
)

1582 
£¨ch_°ï
 = 
i
;

1583 
ˇnd
.
mv_x
 = (Ë(
iMöNow
.mv_x + 
£¨ch_°ï
);

1584 
ˇnd
.
mv_y
 = 
iMöNow
.mv_y ;

1585 
SEARCH_ONE_PIXEL


1586 
ˇnd
.
mv_x
 = (Ë(
iMöNow
.mv_x - 
£¨ch_°ï
);

1587 
ˇnd
.
mv_y
 = 
iMöNow
.mv_y ;

1588 
SEARCH_ONE_PIXEL


1589 
¸oss_°ï
 += 1;

1592 
¸oss_°ï
 = 4;

1594 
i
 = 4; i < (
£¨ch_ønge
 << 1);i+=
¸oss_°ï
)

1596 
£¨ch_°ï
 = 
i
;

1597 
ˇnd
.
mv_x
 = 
iMöNow
.mv_x ;

1598 
ˇnd
.
mv_y
 = (Ë(
iMöNow
.mv_y + 
£¨ch_°ï
);

1599 
SEARCH_ONE_PIXEL


1600 
ˇnd
.
mv_x
 = 
iMöNow
.mv_x ;

1601 
ˇnd
.
mv_y
 = (Ë(
iMöNow
.mv_y - 
£¨ch_°ï
);

1602 
SEARCH_ONE_PIXEL


1603 
¸oss_°ï
 += 2;

1607 
¸oss_°ï_x
 = 4;

1608 
¸oss_°ï_y
 = 4;

1609 
£¨ch_°ï_x
 = 0;

1610 
£¨ch_°ï_y
 = 0;

1611 
i
 =4, 
j
 = 4; i < (
£¨ch_ønge
 << 1); i+=
¸oss_°ï_x
, j+=
¸oss_°ï_y
)

1613 
£¨ch_°ï_x
 = 
i
;

1614 
£¨ch_°ï_y
 = 
j
;

1615 
ˇnd
.
mv_x
 = (Ë(
iMöNow
.mv_x + 
£¨ch_°ï_x
);

1616 
ˇnd
.
mv_y
 = (Ë(
iMöNow
.mv_y + 
£¨ch_°ï_y
);

1617 
SEARCH_ONE_PIXEL


1618 
ˇnd
.
mv_x
 = (Ë(
iMöNow
.mv_x + 
£¨ch_°ï_x
);

1619 
ˇnd
.
mv_y
 = (Ë(
iMöNow
.mv_y - 
£¨ch_°ï_y
);

1620 
SEARCH_ONE_PIXEL


1621 
ˇnd
.
mv_x
 = (Ë(
iMöNow
.mv_x - 
£¨ch_°ï_x
);

1622 
ˇnd
.
mv_y
 = (Ë(
iMöNow
.mv_y + 
£¨ch_°ï_y
);

1623 
SEARCH_ONE_PIXEL


1624 
ˇnd
.
mv_x
 = (Ë(
iMöNow
.mv_x - 
£¨ch_°ï_x
);

1625 
ˇnd
.
mv_y
 = (Ë(
iMöNow
.mv_y - 
£¨ch_°ï_y
);

1626 
SEARCH_ONE_PIXEL


1627 
¸oss_°ï_x
 += 2;

1628 
¸oss_°ï_y
 += 1;

1632 
EARLY_TERMINATION


1634 
iMöNow
 = 
be°
;

1640 if(
˚¡îBü£d
 =4 || cíãrBü£d =3 && 
LU_CENTERBIASED
 == 0)

1641 
pos
=1;pos<25;pos++)

1643 
ˇnd
.
mv_x
 = 
iMöNow
.mv_x + 
p_Vid
->
•úÆ_q≥l_£¨ch
[
pos
].mv_x;

1644 
ˇnd
.
mv_y
 = 
iMöNow
.mv_y + 
p_Vid
->
•úÆ_q≥l_£¨ch
[
pos
].mv_y;

1645 
SEARCH_ONE_PIXEL


1648 if(
˚¡îBü£d
 == 3 || centerBiased == 2)

1649 
pos
 =1;pos< 12;Öos++)

1651 
ˇnd
.
mv_x
 = 
iMöNow
.mv_x + 
Düm⁄dO˘ag⁄
[
pos
].mv_x;

1652 
ˇnd
.
mv_y
 = 
iMöNow
.mv_y + 
Düm⁄dO˘ag⁄
[
pos
].mv_y;

1653 
SEARCH_ONE_PIXEL


1656 
pos
 =1;Öos<9;Öos++)

1658 
ˇnd
.
mv_x
 = 
iMöNow
.mv_x + 
TriRe˘
[
pos
].mv_x;

1659 
ˇnd
.
mv_y
 = 
iMöNow
.mv_y + 
TriRe˘
[
pos
].mv_y;

1660 
SEARCH_ONE_PIXEL


1663 i‡((
mö_mco°
 - 
p_UMHex
->
¥ed_SAD
)<p_UMHex->¥ed_SAD * 
bëaFouπh_2
 || (mö_mco° -Ö_UMHex->¥ed_SADË<Ö_UMHex->¥ed_SAD * 
bëaFouπh_1
)

1665 
cuºMB
->
isCíãrBü£d
 = 1;

1667 
cuºMB
->
isCíãrBü£d
 = 0;

1669 
EARLY_TERMINATION


1672 
	`mem˝y
(
ãmp_Big_Hexag⁄_X
,
Big_Hexag⁄_X
,64);

1673 
	`mem˝y
(
ãmp_Big_Hexag⁄_Y
,
Big_Hexag⁄_Y
,64);

1674 
i
=1;i<=(
£¨ch_ønge
 >> 2); i++)

1677 
m
 = 0; m < 16; m++)

1679 
ˇnd
.
mv_x
 = (Ë(
iMöNow
.mv_x + 
ãmp_Big_Hexag⁄_X
[
m
]);

1680 
ˇnd
.
mv_y
 = (Ë(
iMöNow
.mv_y + 
ãmp_Big_Hexag⁄_Y
[
m
]);

1681 
ãmp_Big_Hexag⁄_X
[
m
] +
Big_Hexag⁄_X
[m];

1682 
ãmp_Big_Hexag⁄_Y
[
m
] +
Big_Hexag⁄_Y
[m];

1684 
SEARCH_ONE_PIXEL


1687 if(
mö_mco°
 < 
ET_Thªd
)

1689 
ãrmö©e_°ï
;

1696 
fouπh_1_°ï
:

1697 
i
 = 0; i < 
£¨ch_ønge
; i++)

1699 
iMöNow
 = 
be°
;

1700 
m
 = 0; m < 6; m++)

1702 
ˇnd
.
mv_x
 = 
iMöNow
.mv_x + 
Hexag⁄
[
m
].mv_x;

1703 
ˇnd
.
mv_y
 = 
iMöNow
.mv_y + 
Hexag⁄
[
m
].mv_y;

1704 
SEARCH_ONE_PIXEL


1707 i‡(
be°
.
mv_x
 =
iMöNow
.mv_x && be°.
mv_y
 == iMinNow.mv_y)

1712 
fouπh_2_°ï
:

1714 
i
 = 0; i < 
£¨ch_ønge
; i++)

1716 
iMöNow
 = 
be°
;

1717 
m
 = 0; m < 4; m++)

1719 
ˇnd
.
mv_x
 = 
iMöNow
.mv_x + 
Düm⁄d
[
m
].mv_x;

1720 
ˇnd
.
mv_y
 = 
iMöNow
.mv_y + 
Düm⁄d
[
m
].mv_y;

1721 
SEARCH_ONE_PIXEL


1723 if(
be°
.
mv_x
 =
iMöNow
.mv_x && be°.
mv_y
 == iMinNow.mv_y)

1727 
ãrmö©e_°ï
:

1731 
i
=0; i < (
blocksize_x
>>2); i++)

1733 
j
=0; j < (
blocksize_y
>>2); j++)

1735 if(
mv_block
->
li°
 == 0)

1737 
p_UMHex
->
Á°me_ªf_co°
[
ªf
][
blockty≥
][
block_y
+
j
][
block_x
+
i
] = 
mö_mco°
;

1738 i‡(
ªf
==0)

1739 
p_UMHex
->
Á°me_l0_co°
[
blockty≥
][(
cuºMB
->
block_y
)+block_y+
j
][(cuºMB->
block_x
)+block_x+
i
] = 
mö_mco°
;

1743 
p_UMHex
->
Á°me_l1_co°
[
blockty≥
][(
cuºMB
->
block_y
)+block_y+
j
][(cuºMB->
block_x
)+block_x+
i
] = 
mö_mco°
;

1748 i‡((
ªf
==0Ë|| (
SAD_¥edi˘i⁄
[
pic_pix_x2
] > 
mö_mco°
))

1749 
SAD_¥edi˘i⁄
[
pic_pix_x2
] = 
mö_mco°
;

1751 
mv
->
mv_x
 = (Ë(
be°
.mv_x - 
pic_pix_x
);

1752 
mv
->
mv_y
 = (Ë(
be°
.mv_y - 
pic_pix_y
);

1753  
mö_mco°
;

1754 
	}
}

1756 #unde‡
SEARCH_ONE_PIXEL


	@lencod/src/me_umhexsmp.c

26 
	~<limôs.h
>

28 
	~"globÆ.h
"

29 
	~"memÆloc.h
"

30 
	~"me_umhexsmp.h
"

31 
	~"ªfbuf.h
"

32 
	~"ma¸oblock.h
"

33 
	~"me_di°‹ti⁄.h
"

34 
	~"mv_£¨ch.h
"

37 c⁄° 
MŸi⁄Ve˘‹
 
	gDüm⁄d
[4] = {{-4, 0}, {4, 0}, {0, -4}, {0, 4}};

38 c⁄° 
MŸi⁄Ve˘‹
 
	gDüm⁄d_SubPñSórch
[4] = {{-1, 0}, {1, 0}, {0, -1}, {0, 1}};

39 c⁄° 
MŸi⁄Ve˘‹
 
	gHexag⁄
[6] = {{-8, 0}, {8, 0},{-4, -8}, {4, 8}, {-4, 8}, {4 , -8}};

40 c⁄° 
	gBig_Hexag⁄_X
[16] = {-16, 16, 0, 0,-16, 16,-16, 16,-16, 16,-16, 16,-8, 8,-8, 8};

41 c⁄° 
	gBig_Hexag⁄_Y
[16] = { 0, 0,-16, 16,-4, 4, 4,-4,-8, 8, 8,-8,-12, 12, 12,-12};

43 c⁄° 
	gblock_ty≥_shi·_Á˘‹
[8] = {0, 0, 1, 1, 2, 3, 3, 1};

46 #unde‡
SEARCH_ONE_PIXEL_BIPRED


47 #unde‡
SEARCH_ONE_PIXEL


48 
	#SEARCH_ONE_PIXEL
 \

	)

49 if((
übs
(
ˇnd
.
mv_x
 - 
˚¡î
.mv_x)>>2Ë<
£¨ch_ønge
 && \

50 (
übs
(
ˇnd
.
mv_y
 - 
˚¡î
.mv_y)>>2Ë<
£¨ch_ønge
) \

52 
mco°
 = 
mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd
, &
¥ed
); \

53 
	gmco°
 +
mv_block
->
compuãPªdFPñ
–
ªf_pi˘uª
, mv_block, 
mö_mco°
 - 
mco°
, &
ˇnd
); \

54 i‡(
	gmco°
 < 
	gmö_mco°
) \

56 
	gbe°
 = 
ˇnd
; \

57 
	gmö_mco°
 = 
mco°
; \

61 
	#SEARCH_ONE_PIXEL_BIPRED
 \

	)

62 i‡((
übs
(
ˇnd
.
mv_x
 - 
˚¡î2
.mv_x)>>2Ë<
£¨ch_ønge
 \

63 && (
übs
(
ˇnd
.
mv_y
 - 
˚¡î2
.mv_y)>>2Ë<
£¨ch_ønge
) \

65 
mco°
 = 
mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
˚¡î1
, &
¥ed1
); \

66 
	gmco°
 +
mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd
, &
¥ed2
); \

67 i‡(
	gmco°
 < 
	gmö_mco°
) \

69 
	gmco°
 +
mv_block
->
compuãBiPªdFPñ
(
ªf_pi˘uª1
, 
ªf_pi˘uª2
, \

70 
mv_block
, 
mö_mco°
 - 
mco°
, &
˚¡î1
, &
ˇnd
); \

71 i‡(
	gmco°
 < 
	gmö_mco°
) \

73 
	gbe°
 = 
ˇnd
; \

74 
	gmö_mco°
 = 
mco°
; \

87 
	$smpUMHEX_öô
(
VideoP¨amëîs
 *
p_Vid
)

89 
UMHexSMPSåu˘
 *
p_UMHexSMP
 = 
p_Vid
->p_UMHexSMP;

91 
p_UMHexSMP
->
SymmëriˇlCrossSórchThªshﬁd1
 = 
	`di°_sˇÀ
(800);

92 
p_UMHexSMP
->
SymmëriˇlCrossSórchThªshﬁd2
 = 
	`di°_sˇÀ
(7000);

93 
p_UMHexSMP
->
C⁄vîgeThªshﬁd
 = 
	`di°_sˇÀ
(1000);

94 
p_UMHexSMP
->
SubPñThªshﬁd1
 = 
	`di°_sˇÀ
(1000);

95 
p_UMHexSMP
->
SubPñThªshﬁd3
 = 
	`di°_sˇÀ
(400);

96 
	}
}

104 
	$smpUMHEX_gë_mem
(
VideoP¨amëîs
 *
p_Vid
)

106 
UMHexSMPSåu˘
 *
p_UMHexSMP
 = 
p_Vid
->p_UMHexSMP;

107 
mem‹y_size
 = 0;

108 i‡(
NULL
==(
p_UMHexSMP
->
Êag_öåa
 = 
	`ˇŒoc
((
p_Vid
->
width
>>4)+1, (
byã
))))

109 
	`no_mem_exô
("smpUMHEX_get_mem: flag_intra");

111 
mem‹y_size
 +
	`gë_mem3Ddi°blk
(&
p_UMHexSMP
->
l0_co°
, 9, 
p_Vid
->
height
 >> 2,Ö_Vid->
width
 >> 2);

112 
mem‹y_size
 +
	`gë_mem3Ddi°blk
(&
p_UMHexSMP
->
l1_co°
, 9, 
p_Vid
->
height
 >> 2,Ö_Vid->
width
 >> 2);

113 
mem‹y_size
 +
	`gë_mem2D
(&
p_UMHexSMP
->
SórchSèã
, 7, 7);

115  
mem‹y_size
;

116 
	}
}

124 
	$smpUMHEX_‰ì_mem
(
VideoP¨amëîs
 *
p_Vid
)

126 
UMHexSMPSåu˘
 *
p_UMHexSMP
 = 
p_Vid
->p_UMHexSMP;

127 
	`‰ì_mem3Ddi°blk
(
p_UMHexSMP
->
l0_co°
 );

128 
	`‰ì_mem3Ddi°blk
(
p_UMHexSMP
->
l1_co°
 );

129 
	`‰ì_mem2D
(
p_UMHexSMP
->
SórchSèã
);

131 
	`‰ì
 (
p_UMHexSMP
->
Êag_öåa
);

132 
	`‰ì
 (
p_UMHexSMP
);

133 
	}
}

142 
di°blk


143 
	$smpUMHEXI¡egîPñBlockMŸi⁄Sórch
 (
Ma¸oblock
 *
cuºMB
,

144 
MŸi⁄Ve˘‹
 *
¥ed_mv
,

145 
MEBlock
 *
mv_block
,

146 
di°blk
 
mö_mco°
,

147 
œmbda_Á˘‹


150 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

151 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

152 
UMHexSMPSåu˘
 *
p_UMHexSMP
 = 
p_Vid
->p_UMHexSMP;

153 
blockty≥
 = 
mv_block
->blocktype;

154 
blocksize_x
 = 
mv_block
->blocksize_x;

155 
blocksize_y
 = 
mv_block
->blocksize_y;

156 
pic_pix_x
 = 
mv_block
->
pos_x_∑dded
;

157 
pic_pix_y
 = 
mv_block
->
pos_y_∑dded
;

159 
li°
 = 
mv_block
->list;

160 
cur_li°
 = 
li°
 + 
cuºMB
->
li°_off£t
;

161 
ªf
 = 
mv_block
->
ªf_idx
;

162 
St‹abÀPi˘uª
 *
ªf_pi˘uª
 = 
cuºSli˚
->
li°X
[
cur_li°
][
ªf
];

163 
£¨ch_ønge
 = 
mv_block
->
£¨chR™ge
.
max_x
 >> 2;

165 
MŸi⁄Ve˘‹
 *
mv
 = &
mv_block
->mv[
li°
];

166 
MŸi⁄Ve˘‹
 
iMöNow
, 
ˇnd
, 
˚¡î
, 
¥ed
, 
be°
 = {0, 0};

168 
£¨ch_°ï
;

169 
di°blk
 
mco°
;

170 
uöt16
 
i
, 
j
, 
m
;

172 
pic_pix_x
 = 
mv_block
->
pos_x_∑dded
;

173 
pic_pix_y
 = 
mv_block
->
pos_y_∑dded
;

174 
¥ed
.
mv_x
 = 
pic_pix_x
 + 
¥ed_mv
->mv_x;

175 
¥ed
.
mv_y
 = 
pic_pix_y
 + 
¥ed_mv
->mv_y;

176 
˚¡î
.
mv_x
 = 
pic_pix_x
 + 
mv
->mv_x;

177 
˚¡î
.
mv_y
 = 
pic_pix_y
 + 
mv
->mv_y;

182 
ˇnd
 = 
˚¡î
;

183 
mco°
 = 
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd
, &
¥ed
);

185 
mco°
 +
mv_block
->
	`compuãPªdFPñ
(
ªf_pi˘uª
, mv_block, 
mö_mco°
 - mco°, &
ˇnd
);

187 i‡(
mco°
 < 
mö_mco°
)

189 
mö_mco°
 = 
mco°
;

190 
be°
 = 
ˇnd
;

193 
iMöNow
 = 
be°
;

196 i‡((0 !
¥ed_mv
->
mv_x
Ë|| (0 !¥ed_mv->
mv_y
))

198 
ˇnd
.
mv_x
 = 
pic_pix_x
;

199 
ˇnd
.
mv_y
 = 
pic_pix_y
;

200 
SEARCH_ONE_PIXEL
;

201 
iMöNow
 = 
be°
;

206 i‡(
mö_mco°
 < (
p_UMHexSMP
->
C⁄vîgeThªshﬁd
 >> 
block_ty≥_shi·_Á˘‹
[
blockty≥
]))

208 
m
 = 0; m < 4; m++)

210 
ˇnd
.
mv_x
 = 
iMöNow
.mv_x + 
Düm⁄d
[
m
].mv_x;

211 
ˇnd
.
mv_y
 = 
iMöNow
.mv_y + 
Düm⁄d
[
m
].mv_y;

212 
SEARCH_ONE_PIXEL
;

214 
mv
->
mv_x
 = (Ë(
be°
.mv_x - 
pic_pix_x
);

215 
mv
->
mv_y
 = (Ë(
be°
.mv_y - 
pic_pix_y
);

216  
mö_mco°
;

220 
iMöNow
 = 
be°
;

221 
m
 = 0; m < 4; m++)

223 
ˇnd
.
mv_x
 = 
iMöNow
.mv_x + 
Düm⁄d
[
m
].mv_x;

224 
ˇnd
.
mv_y
 = 
iMöNow
.mv_y + 
Düm⁄d
[
m
].mv_y;

225 
SEARCH_ONE_PIXEL
;

230 i‡–(
blockty≥
 == 1 &&

231 
mö_mco°
 > (
p_UMHexSMP
->
SymmëriˇlCrossSórchThªshﬁd1
 >> 
block_ty≥_shi·_Á˘‹
[
blockty≥
])) ||

232 (
mö_mco°
 > (
p_UMHexSMP
->
SymmëriˇlCrossSórchThªshﬁd2
>>
block_ty≥_shi·_Á˘‹
[
blockty≥
])) )

234 
iMöNow
 = 
be°
;

236 
i
 = 4; i <4 * 
£¨ch_ønge
 - 4; i+= 8)

238 
£¨ch_°ï
 = 
i
;

239 
ˇnd
.
mv_x
 = (Ë(
iMöNow
.mv_x + 
£¨ch_°ï
);

240 
ˇnd
.
mv_y
 = 
iMöNow
.mv_y;

241 
SEARCH_ONE_PIXEL
;

243 
ˇnd
.
mv_x
 = (Ë(
iMöNow
.mv_x - 
£¨ch_°ï
);

244 
SEARCH_ONE_PIXEL
;

246 
ˇnd
.
mv_x
 = 
iMöNow
.mv_x;

247 
ˇnd
.
mv_y
 = (Ë(
iMöNow
.mv_y + 
£¨ch_°ï
);

248 
SEARCH_ONE_PIXEL
;

250 
ˇnd
.
mv_y
 = (Ë(
iMöNow
.mv_y - 
£¨ch_°ï
);

251 
SEARCH_ONE_PIXEL
;

255 
iMöNow
 = 
be°
;

257 
m
 = 0; m < 6; m++)

259 
ˇnd
.
mv_x
 = 
iMöNow
.mv_x + 
Hexag⁄
[
m
].mv_x;

260 
ˇnd
.
mv_y
 = 
iMöNow
.mv_y + 
Hexag⁄
[
m
].mv_y;

261 
SEARCH_ONE_PIXEL
;

264 
iMöNow
 = 
be°
;

266 
i
 = 1; i <
£¨ch_ønge
 >> 2; i++)

268 
m
 = 0; m < 16; m++)

270 
ˇnd
.
mv_x
 = 
iMöNow
.mv_x + 
Big_Hexag⁄_X
[
m
]*
i
;

271 
ˇnd
.
mv_y
 = 
iMöNow
.mv_y + 
Big_Hexag⁄_Y
[
m
]*
i
;

272 
SEARCH_ONE_PIXEL
;

278 i‡(
blockty≥
 > 1)

280 
ˇnd
.
mv_x
 = 
pic_pix_x
 + (
p_UMHexSMP
->
¥ed_MV_u∂ayî_X
 / 4) * 4;

281 
ˇnd
.
mv_y
 = 
pic_pix_y
 + (
p_UMHexSMP
->
¥ed_MV_u∂ayî_Y
 / 4) * 4;

282 
SEARCH_ONE_PIXEL
;

285 if(
˚¡î
.
mv_x
 !
pic_pix_x
 || cíãr.
mv_y
 !
pic_pix_y
)

287 
ˇnd
.
mv_x
 = 
pic_pix_x
;

288 
ˇnd
.
mv_y
 = 
pic_pix_y
;

289 
SEARCH_ONE_PIXEL
;

291 
iMöNow
 = 
be°
;

293 
m
 = 0; m < 4; m++)

295 
ˇnd
.
mv_x
 = 
iMöNow
.mv_x + 
Düm⁄d
[
m
].mv_x;

296 
ˇnd
.
mv_y
 = 
iMöNow
.mv_y + 
Düm⁄d
[
m
].mv_y;

297 
SEARCH_ONE_PIXEL
;

303 i‡(
mö_mco°
 < (
p_UMHexSMP
->
C⁄vîgeThªshﬁd
 >> 
block_ty≥_shi·_Á˘‹
[
blockty≥
]))

305 
iMöNow
 = 
be°
;

307 
m
 = 0; m < 4; m++)

309 
ˇnd
.
mv_x
 = 
iMöNow
.mv_x + 
Düm⁄d
[
m
].mv_x;

310 
ˇnd
.
mv_y
 = 
iMöNow
.mv_y + 
Düm⁄d
[
m
].mv_y;

311 
SEARCH_ONE_PIXEL
;

313 
mv
->
mv_x
 = (Ë(
be°
.mv_x - 
pic_pix_x
);

314 
mv
->
mv_y
 = (Ë(
be°
.mv_y - 
pic_pix_y
);

315  
mö_mco°
;

319 
i
 = 0; i < 
£¨ch_ønge
; i++)

321 
iMöNow
 = 
be°
;

322 
m
 = 0; m < 6; m++)

324 
ˇnd
.
mv_x
 = 
iMöNow
.mv_x + 
Hexag⁄
[
m
].mv_x;

325 
ˇnd
.
mv_y
 = 
iMöNow
.mv_y + 
Hexag⁄
[
m
].mv_y;

326 
SEARCH_ONE_PIXEL
;

329 i‡(
be°
.
mv_x
 =
iMöNow
.mv_x && be°.
mv_y
 == iMinNow.mv_y)

336 
i
 = 0; i < 
£¨ch_ønge
; i++)

338 
iMöNow
 = 
be°
;

339 
m
 = 0; m < 4; m++)

341 
ˇnd
.
mv_x
 = 
iMöNow
.mv_x + 
Düm⁄d
[
m
].mv_x;

342 
ˇnd
.
mv_y
 = 
iMöNow
.mv_y + 
Düm⁄d
[
m
].mv_y;

343 
SEARCH_ONE_PIXEL
;

347 i‡(
be°
.
mv_x
 =
iMöNow
.mv_x && be°.
mv_y
 == iMinNow.mv_y)

353 
mv
->
mv_x
 = (Ë(
be°
.mv_x - 
pic_pix_x
);

354 
mv
->
mv_y
 = (Ë(
be°
.mv_y - 
pic_pix_y
);

356 
j
=(
mv_block
->
pos_y2
); j < (mv_block->pos_y2Ë+ (
blocksize_y
>>2); j++)

358 
i
=(
mv_block
->
pos_x2
); i < (mv_block->pos_x2Ë+ (
blocksize_x
>>2); i++)

360 if(
mv_block
->
li°
 == 0)

362 
p_UMHexSMP
->
l0_co°
[
blockty≥
][
j
][
i
] = 
mö_mco°
;

366 
p_UMHexSMP
->
l1_co°
[
blockty≥
][
j
][
i
] = 
mö_mco°
;

371  
mö_mco°
;

372 
	}
}

380 
di°blk


381 
	$smpUMHEXFuŒSubPñBlockMŸi⁄Sórch
 (
Ma¸oblock
 *
cuºMB
,

382 
MŸi⁄Ve˘‹
 *
¥ed_mv
,

383 
MEBlock
 *
mv_block
,

384 
di°blk
 
mö_mco°
,

385 
œmbda_Á˘‹


388 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

389 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

390 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

391 
UMHexSMPSåu˘
 *
p_UMHexSMP
 = 
p_Vid
->p_UMHexSMP;

392 
pos
, 
be°_pos
;

393 
di°blk
 
mco°
;

395 
MŸi⁄Ve˘‹
 
ˇnd
;

397 
blockty≥
 = 
mv_block
->blocktype;

398 
li°
 = 
mv_block
->list;

399 
li°_off£t
 = 
cuºMB
->list_offset;

400 
ªf
 = 
mv_block
->
ªf_idx
;

401 
MŸi⁄Ve˘‹
 *
mv
 = &
mv_block
->mv[
li°
];

403 
check_posôi⁄0
 = (!
p_I≈
->
rd›t
 && 
cuºSli˚
->
¶i˚_ty≥
!=
B_SLICE
 && 
ªf
==0 && 
blockty≥
==1 && 
mv
->
mv_x
==0 && mv->
mv_y
==0);

405 
max_pos2
 = ( !
p_Vid
->
°¨t_me_ªföemít_hp
 ? 
	`imax
(1, 
mv_block
->
£¨ch_pos2
) : mv_block->search_pos2);

406 
MŸi⁄Ve˘‹
 
cmv
;

408 
St‹abÀPi˘uª
 *
ªf_pi˘uª
 = 
cuºSli˚
->
li°X
[
li°
 + 
li°_off£t
][
ªf
];

418 
be°_pos
 = 0, 
pos
 = 
p_Vid
->
°¨t_me_ªföemít_hp
;Öo†< 
max_pos2
;Öos++)

420 
ˇnd
.
mv_x
 = 
mv
->mv_x + 
p_Vid
->
•úÆ_h≥l_£¨ch
[
pos
].mv_x;

421 
ˇnd
.
mv_y
 = 
mv
->mv_y + 
p_Vid
->
•úÆ_h≥l_£¨ch
[
pos
].mv_y;

424 
mco°
 = 
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd
, 
¥ed_mv
);

426 i‡(
mco°
 >
mö_mco°
) ;

428 
cmv
 = 
	`∑d_MVs
(
ˇnd
, 
mv_block
);

430 
mco°
 +
mv_block
->
	`compuãPªdQPñ
–
ªf_pi˘uª
, mv_block, 
mö_mco°
 - mco°, &
cmv
);

432 i‡(
pos
==0 && 
check_posôi⁄0
)

434 
di°blk
 
dbTmp
 = 
	`weighãd_co°
 (
œmbda_Á˘‹
, 16);

435 
mco°
 = (mco° > 
dbTmp
)? (mcost - dbTmp):0;

438 i‡(
mco°
 < 
mö_mco°
)

440 
mö_mco°
 = 
mco°
;

441 
be°_pos
 = 
pos
;

443 i‡(
mö_mco°
 < (
p_UMHexSMP
->
SubPñThªshﬁd3
 >> 
block_ty≥_shi·_Á˘‹
[
blockty≥
]))

449 i‡(
be°_pos
)

451 
	`add_mvs
(
mv
, &
p_Vid
->
•úÆ_h≥l_£¨ch
[
be°_pos
]);

454 i‡((
mv
->
mv_x
 =0Ë&& (mv->
mv_y
 =0Ë&& (
¥ed_mv
->mv_x == 0 &&Öred_mv->mv_y == 0) &&

455 (
mö_mco°
 < (
p_UMHexSMP
->
SubPñThªshﬁd1
 >> 
block_ty≥_shi·_Á˘‹
[
blockty≥
])) )

457 
be°_pos
 = 0;

458  
mö_mco°
;

460 i‡–!
p_Vid
->
°¨t_me_ªföemít_qp
 )

461 
mö_mco°
 = 
DISTBLK_MAX
;

469 
be°_pos
 = 0, 
pos
 = 
p_Vid
->
°¨t_me_ªföemít_qp
;Öo†< 
mv_block
->
£¨ch_pos4
;Öos++)

471 
ˇnd
.
mv_x
 = 
mv
->mv_x + 
p_Vid
->
•úÆ_£¨ch
[
pos
].mv_x;

472 
ˇnd
.
mv_y
 = 
mv
->mv_y + 
p_Vid
->
•úÆ_£¨ch
[
pos
].mv_y;

475 
mco°
 = 
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd
, 
¥ed_mv
);

477 i‡(
mco°
 >
mö_mco°
) ;

479 
cmv
 = 
	`∑d_MVs
(
ˇnd
, 
mv_block
);

481 
mco°
 +
mv_block
->
	`compuãPªdQPñ
–
ªf_pi˘uª
, mv_block, 
mö_mco°
 - mco°, &
cmv
);

483 i‡(
mco°
 < 
mö_mco°
)

485 
mö_mco°
 = 
mco°
;

486 
be°_pos
 = 
pos
;

488 i‡(
mö_mco°
 < (
p_UMHexSMP
->
SubPñThªshﬁd3
 >> 
block_ty≥_shi·_Á˘‹
[
blockty≥
]))

494 i‡(
be°_pos
)

496 
	`add_mvs
(
mv
, &
p_Vid
->
•úÆ_£¨ch
[
be°_pos
]);

500  
mö_mco°
;

501 
	}
}

510 
di°blk


511 
	$smpUMHEXSubPñBlockMŸi⁄Sórch
 (

512 
Ma¸oblock
 *
cuºMB
,

513 
MŸi⁄Ve˘‹
 *
¥ed_mv
,

514 
MEBlock
 *
mv_block
,

515 
di°blk
 
mö_mco°
,

516 
œmbda_Á˘‹


519 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

520 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

521 
UMHexSMPSåu˘
 *
p_UMHexSMP
 = 
p_Vid
->p_UMHexSMP;

522 
di°blk
 
mco°
;

523 
MŸi⁄Ve˘‹
 
ˇnd
, 
iMöNow
, 
cuºmv
 = {0, 0}, 
ˇnd_∑d
;

525 
blockty≥
 = 
mv_block
->blocktype;

526 
li°
 = 
mv_block
->list;

527 
li°_off£t
 = 
cuºMB
->list_offset;

528 
ªf
 = 
mv_block
->
ªf_idx
;

529 
MŸi⁄Ve˘‹
 *
mv
 = &
mv_block
->mv[
li°
];

531 
St‹abÀPi˘uª
 *
ªf_pi˘uª
 = 
cuºSli˚
->
li°X
[
li°
+
li°_off£t
][
ªf
];

533 
dy«mic_£¨ch_ønge
 = 3, 
i
, 
m
;

534 
¥ed_‰ac_mv_x
,
¥ed_‰ac_mv_y
,
ab‹t_£¨ch
;

535 
¥ed_‰ac_up_mv_x
, 
¥ed_‰ac_up_mv_y
;

537 
¥ed_‰ac_mv_x
 = (
¥ed_mv
->
mv_x
 - 
mv
->mv_x) %4;

538 
¥ed_‰ac_mv_y
 = (
¥ed_mv
->
mv_y
 - 
mv
->mv_y) %4;

540 
¥ed_‰ac_up_mv_x
 = (
p_UMHexSMP
->
¥ed_MV_u∂ayî_X
 - 
mv
->
mv_x
) & 0x03;

541 
¥ed_‰ac_up_mv_y
 = (
p_UMHexSMP
->
¥ed_MV_u∂ayî_Y
 - 
mv
->
mv_y
) & 0x03;

543 
	`mem£t
(
p_UMHexSMP
->
SórchSèã
[0], 0, (2 * 
dy«mic_£¨ch_ønge
 + 1)*(2 * dynamic_search_range + 1));

545 
p_UMHexSMP
->
SórchSèã
[
dy«mic_£¨ch_ønge
][dynamic_search_range] = 1;

546 if–!
p_Vid
->
°¨t_me_ªföemít_hp
 )

548 
ˇnd
.
mv_x
 = 
mv
->mv_x;

549 
ˇnd
.
mv_y
 = 
mv
->mv_y;

550 
mco°
 = 
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd
, 
¥ed_mv
);

551 
ˇnd_∑d
 = 
	`∑d_MVs
 (
ˇnd
, 
mv_block
);

553 
mco°
 +
mv_block
->
	`compuãPªdQPñ
–
ªf_pi˘uª
, mv_block, 
mö_mco°
 - mco°, &
ˇnd_∑d
);

554 i‡(
mco°
 < 
mö_mco°
)

556 
mö_mco°
 = 
mco°
;

557 
cuºmv
 = 
ˇnd
;

562 
cuºmv
 = *
mv
;

567 i‡–((
mv
->
mv_x
Ë=0Ë&& ((mv->
mv_y
) == 0) &&

568 (
¥ed_‰ac_mv_x
 =0 && 
¥ed_‰ac_up_mv_x
 == 0) &&

569 (
¥ed_‰ac_mv_y
 =0 && 
¥ed_‰ac_up_mv_y
 == 0) &&

570 (
mö_mco°
 < (
p_UMHexSMP
->
SubPñThªshﬁd1
 >> 
block_ty≥_shi·_Á˘‹
[
blockty≥
])) )

572 *
mv
 = 
cuºmv
;

573  
mö_mco°
;

576 if(
¥ed_‰ac_mv_x
 || 
¥ed_‰ac_mv_y
)

578 
ˇnd
.
mv_x
 = (Ë(
mv
->mv_x + 
¥ed_‰ac_mv_x
);

579 
ˇnd
.
mv_y
 = (Ë(
mv
->mv_y + 
¥ed_‰ac_mv_y
);

580 
p_UMHexSMP
->
SórchSèã
[
ˇnd
.
mv_y
 -
mv
->mv_y + 
dy«mic_£¨ch_ønge
][ˇnd.
mv_x
 - mv->mv_x + dynamic_search_range] = 1;

581 
mco°
 = 
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd
, 
¥ed_mv
);

583 
ˇnd_∑d
 = 
	`∑d_MVs
 (
ˇnd
, 
mv_block
);

584 
mco°
 +
mv_block
->
	`compuãPªdQPñ
–
ªf_pi˘uª
, mv_block, 
mö_mco°
 - mco°, &
ˇnd_∑d
);

586 i‡(
mco°
 < 
mö_mco°
)

588 
mö_mco°
 = 
mco°
;

589 
cuºmv
 = 
ˇnd
;

594 
i
 = 0; i < 
dy«mic_£¨ch_ønge
; i++)

596 
ab‹t_£¨ch
 = 1;

598 
iMöNow
 = 
cuºmv
;

600 
m
 = 0; m < 4; m++)

602 
ˇnd
.
mv_x
 = 
iMöNow
.mv_x + 
Düm⁄d_SubPñSórch
[
m
].mv_x;

603 
ˇnd
.
mv_y
 = 
iMöNow
.mv_y + 
Düm⁄d_SubPñSórch
[
m
].mv_y;

605 if(
	`übs
(
ˇnd
.
mv_x
 - 
mv
->mv_xË<
dy«mic_£¨ch_ønge
 && iabs(ˇnd.
mv_y
 - mv->mv_y) <= dynamic_search_range)

607 if(!
p_UMHexSMP
->
SórchSèã
[
ˇnd
.
mv_y
 - 
mv
->mv_y + 
dy«mic_£¨ch_ønge
][ˇnd.
mv_x
 - mv->mv_x + dynamic_search_range])

609 
p_UMHexSMP
->
SórchSèã
[
ˇnd
.
mv_y
 - 
mv
->mv_y + 
dy«mic_£¨ch_ønge
][ˇnd.
mv_x
 - mv->mv_x + dynamic_search_range] = 1;

610 
mco°
 = 
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd
, 
¥ed_mv
);

611 
ˇnd_∑d
 = 
	`∑d_MVs
 (
ˇnd
, 
mv_block
);

612 
mco°
 +
mv_block
->
	`compuãPªdQPñ
–
ªf_pi˘uª
, mv_block, 
mö_mco°
 - mco°, &
ˇnd_∑d
);

613 i‡(
mco°
 < 
mö_mco°
)

615 
mö_mco°
 = 
mco°
;

616 
cuºmv
 = 
ˇnd
;

617 
ab‹t_£¨ch
 = 0;

619 i‡(
mö_mco°
 < (
p_UMHexSMP
->
SubPñThªshﬁd3
 >> 
block_ty≥_shi·_Á˘‹
[
blockty≥
]))

621 *
mv
 = 
cuºmv
;

622  
mö_mco°
;

628 i‡(
ab‹t_£¨ch
)

634 *
mv
 = 
cuºmv
;

637  
mö_mco°
;

638 
	}
}

640 
di°blk


641 
	$smpUMHEXSubPñBlockME
 (
Ma¸oblock
 *
cuºMB
,

642 
MŸi⁄Ve˘‹
 *
¥ed_mv
,

643 
MEBlock
 *
mv_block
,

644 
di°blk
 
mö_mco°
,

645 * 
œmbda_Á˘‹
 )

647 if(
mv_block
->
blockty≥
 > 1)

649 
mö_mco°
 = 
	`smpUMHEXSubPñBlockMŸi⁄Sórch
 (
cuºMB
, 
¥ed_mv
, 
mv_block
, mö_mco°, 
œmbda_Á˘‹
[
Q_PEL
]);

653 
mö_mco°
 = 
	`smpUMHEXFuŒSubPñBlockMŸi⁄Sórch
 (
cuºMB
, 
¥ed_mv
, 
mv_block
, mö_mco°, 
œmbda_Á˘‹
[
Q_PEL
]);

656  
mö_mco°
;

657 
	}
}

666 
di°blk


667 
	$smpUMHEXBùªdI¡egîPñBlockMŸi⁄Sórch
 (
Ma¸oblock
 *
cuºMB
,

668 
li°
,

669 
MŸi⁄Ve˘‹
 *
¥ed_mv1
,

670 
MŸi⁄Ve˘‹
 *
¥ed_mv2
,

671 
MŸi⁄Ve˘‹
 *
mv1
,

672 
MŸi⁄Ve˘‹
 *
mv2
,

673 
MEBlock
 *
mv_block
,

674 
£¨ch_ønge
,

675 
di°blk
 
mö_mco°
,

676 
œmbda_Á˘‹


679 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

680 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

681 
UMHexSMPSåu˘
 *
p_UMHexSMP
 = 
p_Vid
->p_UMHexSMP;

683 
£¨ch_°ï
;

684 
i
, 
m
;

685 
di°blk
 
mco°
;

686 
blockty≥
 = 
mv_block
->blocktype;

688 
pic_pix_x
 = 
mv_block
->
pos_x_∑dded
;

689 
pic_pix_y
 = 
mv_block
->
pos_y_∑dded
;

690 
ªf
 = 
mv_block
->
ªf_idx
;

692 
St‹abÀPi˘uª
 *
ªf_pi˘uª1
 = 
cuºSli˚
->
li°X
[
li°
 + 
cuºMB
->
li°_off£t
][
ªf
];

693 
St‹abÀPi˘uª
 *
ªf_pi˘uª2
 = 
cuºSli˚
->
li°X
[
li°
 =0 ? 1 + 
cuºMB
->
li°_off£t
: currMB->list_offset][ 0 ];

695 
MŸi⁄Ve˘‹
 
iMöNow
, 
be°
, 
ˇnd
, 
¥ed1
, 
¥ed2
, 
˚¡î1
, 
˚¡î2
;

696 
£¨ch_ønge
 >>= 2;

698 
¥ed1
.
mv_x
 = 
mv_block
->
pos_x_∑dded
 + 
¥ed_mv1
->mv_x;

699 
¥ed1
.
mv_y
 = 
mv_block
->
pos_y_∑dded
 + 
¥ed_mv1
->mv_y;

700 
¥ed2
.
mv_x
 = 
mv_block
->
pos_x_∑dded
 + 
¥ed_mv2
->mv_x;

701 
¥ed2
.
mv_y
 = 
mv_block
->
pos_y_∑dded
 + 
¥ed_mv2
->mv_y;

703 
˚¡î2
.
mv_x
 = 
mv_block
->
pos_x_∑dded
 + 
mv1
->mv_x;

704 
˚¡î2
.
mv_y
 = 
mv_block
->
pos_y_∑dded
 + 
mv1
->mv_y;

705 
˚¡î1
.
mv_x
 = 
mv_block
->
pos_x_∑dded
 + 
mv2
->mv_x;

706 
˚¡î1
.
mv_y
 = 
mv_block
->
pos_y_∑dded
 + 
mv2
->mv_y;

709 
be°
 = 
ˇnd
 = 
˚¡î2
;

710 
mco°
 = 
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
˚¡î1
, &
¥ed1
);

711 
mco°
 +
	`mv_co°
 (
p_Vid
, 
œmbda_Á˘‹
, &
ˇnd
, &
¥ed2
);

712 
mco°
 +
mv_block
->
	`compuãBiPªdFPñ
(
ªf_pi˘uª1
, 
ªf_pi˘uª2
, mv_block,

713 
DISTBLK_MAX
, &
˚¡î1
, &
ˇnd
);

714 i‡(
mco°
 < 
mö_mco°
)

716 
mö_mco°
 = 
mco°
;

717 
be°
 = 
ˇnd
;

720 
iMöNow
 = 
be°
;

721 i‡(0 !
¥ed_mv1
->
mv_x
 || 0 !¥ed_mv1->
mv_y
 || 0 !
¥ed_mv2
->mv_x || 0 !=Öred_mv2->mv_y)

723 
ˇnd
.
mv_x
 = 
pic_pix_x
;

724 
ˇnd
.
mv_y
 = 
pic_pix_y
;

725 
SEARCH_ONE_PIXEL_BIPRED
;

730 i‡((
mö_mco°
<<3Ë< (
p_UMHexSMP
->
C⁄vîgeThªshﬁd
 >> (
block_ty≥_shi·_Á˘‹
[
blockty≥
])))

732 
m
 = 0; m < 4; m++)

734 
ˇnd
.
mv_x
 = 
iMöNow
.mv_x + 
Düm⁄d
[
m
].mv_x;

735 
ˇnd
.
mv_y
 = 
iMöNow
.mv_y + 
Düm⁄d
[
m
].mv_y;

736 
SEARCH_ONE_PIXEL_BIPRED
;

739 
mv1
->
mv_x
 = (Ë(
be°
.mv_x - 
pic_pix_x
);

740 
mv1
->
mv_y
 = (Ë(
be°
.mv_y - 
pic_pix_y
);

741  
mö_mco°
;

745 
m
 = 0; m < 4; m++)

747 
ˇnd
.
mv_x
 = 
iMöNow
.mv_x + 
Düm⁄d
[
m
].mv_x;

748 
ˇnd
.
mv_y
 = 
iMöNow
.mv_y + 
Düm⁄d
[
m
].mv_y;

749 
SEARCH_ONE_PIXEL_BIPRED
;

754 i‡((
blockty≥
 == 1 &&

755 (
mö_mco°
<<2Ë> (
p_UMHexSMP
->
SymmëriˇlCrossSórchThªshﬁd1
 >> 
block_ty≥_shi·_Á˘‹
[
blockty≥
])) ||

756 ((
mö_mco°
<<2Ë> (
p_UMHexSMP
->
SymmëriˇlCrossSórchThªshﬁd2
>>
block_ty≥_shi·_Á˘‹
[
blockty≥
])))

758 
iMöNow
.
mv_x
 = 
be°
.mv_x;

759 
iMöNow
.
mv_y
 = 
be°
.mv_y;

761 
i
 = 8; i <4 * 
£¨ch_ønge
; i+= 8)

763 
£¨ch_°ï
 = 
i
 - 4;

764 
ˇnd
.
mv_x
 = (Ë(
iMöNow
.mv_x + 
£¨ch_°ï
);

765 
ˇnd
.
mv_y
 = 
iMöNow
.mv_y;

766 
SEARCH_ONE_PIXEL_BIPRED
;

767 
ˇnd
.
mv_x
 = (Ë(
iMöNow
.mv_x - 
£¨ch_°ï
);

768 
SEARCH_ONE_PIXEL_BIPRED
;

770 
ˇnd
.
mv_x
 = 
iMöNow
.mv_x;

771 
ˇnd
.
mv_y
 = (Ë(
iMöNow
.mv_y + 
£¨ch_°ï
);

772 
SEARCH_ONE_PIXEL_BIPRED
;

773 
ˇnd
.
mv_y
 = (Ë(
iMöNow
.mv_y - 
£¨ch_°ï
);

774 
SEARCH_ONE_PIXEL_BIPRED
;

778 
iMöNow
.
mv_x
 = 
be°
.mv_x;

779 
iMöNow
.
mv_y
 = 
be°
.mv_y;

780 
m
 = 0; m < 6; m++)

782 
ˇnd
.
mv_x
 = 
iMöNow
.mv_x + 
Hexag⁄
[
m
].mv_x;

783 
ˇnd
.
mv_y
 = 
iMöNow
.mv_y + 
Hexag⁄
[
m
].mv_y;

784 
SEARCH_ONE_PIXEL_BIPRED
;

787 
iMöNow
 = 
be°
;

788 
i
 = 1; i <
£¨ch_ønge
 / 4; i++)

790 
m
 = 0; m < 16; m++)

792 
ˇnd
.
mv_x
 = (Ë(
iMöNow
.mv_x + 
Big_Hexag⁄_X
[
m
] * 
i
);

793 
ˇnd
.
mv_y
 = (Ë(
iMöNow
.mv_y + 
Big_Hexag⁄_Y
[
m
] * 
i
);

794 
SEARCH_ONE_PIXEL_BIPRED
;

800 i‡(
blockty≥
 > 1)

802 
ˇnd
.
mv_x
 = 
pic_pix_x
 + (
p_UMHexSMP
->
¥ed_MV_u∂ayî_X
 / 4) * 4;

803 
ˇnd
.
mv_y
 = 
pic_pix_y
 + (
p_UMHexSMP
->
¥ed_MV_u∂ayî_Y
 / 4) * 4;

804 
SEARCH_ONE_PIXEL_BIPRED
;

807 if(
˚¡î2
.
mv_x
 !
pic_pix_x
 || cíãr2.mv_x !
pic_pix_y
)

809 
ˇnd
.
mv_x
 = 
pic_pix_x
;

810 
ˇnd
.
mv_y
 = 
pic_pix_y
;

811 
SEARCH_ONE_PIXEL_BIPRED
;

813 
iMöNow
 = 
be°
;

815 
m
 = 0; m < 4; m++)

817 
ˇnd
.
mv_x
 = 
iMöNow
.mv_x + 
Düm⁄d
[
m
].mv_x;

818 
ˇnd
.
mv_y
 = 
iMöNow
.mv_y + 
Düm⁄d
[
m
].mv_y;

819 
SEARCH_ONE_PIXEL_BIPRED
;

825 i‡((
mö_mco°
<<2Ë< (
p_UMHexSMP
->
C⁄vîgeThªshﬁd
 >> 
block_ty≥_shi·_Á˘‹
[
blockty≥
]))

827 
iMöNow
 = 
be°
;

828 
m
 = 0; m < 4; m++)

830 
ˇnd
.
mv_x
 = 
iMöNow
.mv_x + 
Düm⁄d
[
m
].mv_x;

831 
ˇnd
.
mv_y
 = 
iMöNow
.mv_y + 
Düm⁄d
[
m
].mv_y;

832 
SEARCH_ONE_PIXEL_BIPRED
;

834 
mv1
->
mv_x
 = (Ë(
be°
.mv_x - 
pic_pix_x
);

835 
mv1
->
mv_y
 = (Ë(
be°
.mv_y - 
pic_pix_y
);

836  
mö_mco°
;

840 
i
 = 0; i < 
£¨ch_ønge
; i++)

842 
iMöNow
 = 
be°
;

843 
m
 = 0; m < 6; m++)

845 
ˇnd
.
mv_x
 = 
iMöNow
.mv_x + 
Hexag⁄
[
m
].mv_x;

846 
ˇnd
.
mv_y
 = 
iMöNow
.mv_y + 
Hexag⁄
[
m
].mv_y;

847 
SEARCH_ONE_PIXEL_BIPRED
;

850 i‡(
be°
.
mv_x
 =
iMöNow
.mv_x && be°.
mv_y
 == iMinNow.mv_y)

857 
i
 = 0; i < 
£¨ch_ønge
; i++)

859 
iMöNow
 = 
be°
;

860 
m
 = 0; m < 4; m++)

862 
ˇnd
.
mv_x
 = 
iMöNow
.mv_x + 
Düm⁄d
[
m
].mv_x;

863 
ˇnd
.
mv_y
 = 
iMöNow
.mv_y + 
Düm⁄d
[
m
].mv_y;

864 
SEARCH_ONE_PIXEL_BIPRED
;

868 i‡(
be°
.
mv_x
 =
iMöNow
.mv_x && be°.
mv_y
 == iMinNow.mv_y)

874 
mv1
->
mv_x
 = (Ë(
be°
.mv_x - 
pic_pix_x
);

875 
mv1
->
mv_y
 = (Ë(
be°
.mv_y - 
pic_pix_y
);

876  
mö_mco°
;

877 
	}
}

886 
	$smpUMHEX_decide_öåabk_SAD
(
Ma¸oblock
 *
cuºMB
)

888 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

889 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

890 
UMHexSMPSåu˘
 *
p_UMHexSMP
 = 
p_Vid
->p_UMHexSMP;

892 i‡(
cuºSli˚
->
¶i˚_ty≥
 !
I_SLICE
 && cuºSli˚->¶i˚_ty≥ !
SI_SLICE
)

894 i‡(
cuºMB
->
pix_x
 =0 && cuºMB->
pix_y
 == 0)

896 
p_UMHexSMP
->
Êag_öåa_SAD
 = 0;

898 i‡(
cuºMB
->
pix_x
 == 0)

900 
p_UMHexSMP
->
Êag_öåa_SAD
 =Ö_UMHexSMP->
Êag_öåa
[(
cuºMB
->
pix_x
)>>4];

902 i‡(
cuºMB
->
pix_y
 == 0)

904 
p_UMHexSMP
->
Êag_öåa_SAD
 =Ö_UMHexSMP->
Êag_öåa
[((
cuºMB
->
pix_x
)>>4)-1];

908 
p_UMHexSMP
->
Êag_öåa_SAD
 = (’_UMHexSMP->
Êag_öåa
[(
cuºMB
->
pix_x
)>>4])||

909 (
p_UMHexSMP
->
Êag_öåa
[((
cuºMB
->
pix_x
)>>4)-1])||

910 (
p_UMHexSMP
->
Êag_öåa
[((
cuºMB
->
pix_x
)>>4)+1])) ;

914 
	}
}

923 
	$smpUMHEX_skù_öåabk_SAD
(
Ma¸oblock
 *
cuºMB
)

925 
i
, 
j
, 
k
;

926 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

927 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

928 
UMHexSMPSåu˘
 *
p_UMHexSMP
 = 
p_Vid
->p_UMHexSMP;

930 i‡(
p_Vid
->
numbî
 > 0)

932 
p_UMHexSMP
->
Êag_öåa
[(
cuºMB
->
pix_x
)>>4] = (cuºMB->
be°_mode
 == 9 || currMB->best_mode == 10) ? 1 : 0;

935 i‡(
cuºSli˚
->
¶i˚_ty≥
 !
I_SLICE
 && cuºSli˚->¶i˚_ty≥ !
SI_SLICE
 && (
cuºMB
->
be°_mode
 == 9 || currMB->best_mode == 10))

937 
k
=0; k < 9;k++)

939 
j
=0; j < 4; j++)

941 
i
=0; i < 4; i++)

943 
p_UMHexSMP
->
l0_co°
[
k
][
j
][
i
] = 0;

944 
p_UMHexSMP
->
l1_co°
[
k
][
j
][
i
] = 0;

950 
	}
}

959 
	$smpUMHEX_£tup
(
Ma¸oblock
 *
cuºMB
,

960 
ªf
,

961 
li°
,

962 
block_y
,

963 
block_x
,

964 
blockty≥
,

965 
MŸi⁄Ve˘‹
 *****
Æl_mv
)

967 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

968 
UMHexSMPSåu˘
 *
p_UMHexSMP
 = 
p_Vid
->p_UMHexSMP;

970 i‡(
blockty≥
 > 6)

972 
p_UMHexSMP
->
¥ed_MV_u∂ayî_X
 = 
Æl_mv
[
li°
][
ªf
][5][
block_y
][
block_x
].
mv_x
;

973 
p_UMHexSMP
->
¥ed_MV_u∂ayî_Y
 = 
Æl_mv
[
li°
][
ªf
][5][
block_y
][
block_x
].
mv_y
;

975 i‡(
blockty≥
 > 4)

977 
p_UMHexSMP
->
¥ed_MV_u∂ayî_X
 = 
Æl_mv
[
li°
][
ªf
][4][
block_y
][
block_x
].
mv_x
;

978 
p_UMHexSMP
->
¥ed_MV_u∂ayî_Y
 = 
Æl_mv
[
li°
][
ªf
][4][
block_y
][
block_x
].
mv_y
;

980 i‡(
blockty≥
 == 4)

982 
p_UMHexSMP
->
¥ed_MV_u∂ayî_X
 = 
Æl_mv
[
li°
][
ªf
][2][
block_y
][
block_x
].
mv_x
;

983 
p_UMHexSMP
->
¥ed_MV_u∂ayî_Y
 = 
Æl_mv
[
li°
][
ªf
][2][
block_y
][
block_x
].
mv_y
;

985 i‡(
blockty≥
 > 1)

987 
p_UMHexSMP
->
¥ed_MV_u∂ayî_X
 = 
Æl_mv
[
li°
][
ªf
][1][
block_y
][
block_x
].
mv_x
;

988 
p_UMHexSMP
->
¥ed_MV_u∂ayî_Y
 = 
Æl_mv
[
li°
][
ªf
][1][
block_y
][
block_x
].
mv_y
;

991 i‡(
blockty≥
 > 1)

993 i‡(
blockty≥
 > 6)

995 
p_UMHexSMP
->
¥ed_SAD_u∂ayî
 = (
li°
==1) ?

996 (
p_UMHexSMP
->
l1_co°
[5][(
cuºMB
->
block_y
)+block_y][(cuºMB->
block_x
)+block_x])

997 : (
p_UMHexSMP
->
l0_co°
[5][(
cuºMB
->
block_y
)+block_y][(cuºMB->
block_x
)+block_x]);

998 
p_UMHexSMP
->
¥ed_SAD_u∂ayî
 /= 2;

1000 i‡(
blockty≥
 > 4)

1002 
p_UMHexSMP
->
¥ed_SAD_u∂ayî
 = (
li°
==1) ?

1003 (
p_UMHexSMP
->
l1_co°
[4][(
cuºMB
->
block_y
)+block_y][(cuºMB->
block_x
)+block_x])

1004 : (
p_UMHexSMP
->
l0_co°
[4][(
cuºMB
->
block_y
)+block_y][(cuºMB->
block_x
)+block_x]);

1005 
p_UMHexSMP
->
¥ed_SAD_u∂ayî
 /= 2;

1007 i‡(
blockty≥
 == 4)

1009 
p_UMHexSMP
->
¥ed_SAD_u∂ayî
 = (
li°
==1) ?

1010 (
p_UMHexSMP
->
l1_co°
[2][(
cuºMB
->
block_y
)+block_y][(cuºMB->
block_x
)+block_x])

1011 : (
p_UMHexSMP
->
l0_co°
[2][(
cuºMB
->
block_y
)+block_y][(cuºMB->
block_x
)+block_x]);

1012 
p_UMHexSMP
->
¥ed_SAD_u∂ayî
 /= 2;

1016 
p_UMHexSMP
->
¥ed_SAD_u∂ayî
 = (
li°
==1) ?

1017 (
p_UMHexSMP
->
l1_co°
[1][(
cuºMB
->
block_y
)+block_y][(cuºMB->
block_x
)+block_x])

1018 : (
p_UMHexSMP
->
l0_co°
[1][(
cuºMB
->
block_y
)+block_y][(cuºMB->
block_x
)+block_x]);

1019 
p_UMHexSMP
->
¥ed_SAD_u∂ayî
 /= 2;

1022 
p_UMHexSMP
->
¥ed_SAD_u∂ayî
 =Ö_UMHexSMP->
Êag_öåa_SAD
 ? 0 :Ö_UMHexSMP->pred_SAD_uplayer;

1024 
	}
}

	@lencod/src/mmco.c

15 
	~"c⁄åibut‹s.h
"

17 
	~<˘y≥.h
>

18 
	~<limôs.h
>

19 
	~"globÆ.h
"

21 
	~"image.h
"

22 
	~"«lucomm⁄.h
"

23 
	~"ªp‹t.h
"

26 
	$mmco_l⁄g_ãrm
(
VideoP¨amëîs
 *
p_Vid
, 
cuºít_pic_num
)

28 
DecRefPicM¨kög_t
 *
tmp_dΩm
,*
tmp_dΩm2
;

30 i‡–!
p_Vid
->
cuºítPi˘uª
->
idr_Êag
 )

32 i‡(
p_Vid
->
dec_ªf_pic_m¨kög_buf„r
!=
NULL
)

35 i‡(
NULL
==(
tmp_dΩm
=(
DecRefPicM¨kög_t
*)
	`ˇŒoc
 (1, (DecRefPicMarking_t))))

36 
	`no_mem_exô
("poc_based_ref_management:Åmp_drpm");

38 
tmp_dΩm
->
Next
=
NULL
;

40 
tmp_dΩm
->
mem‹y_m™agemít_c⁄åﬁ_›î©i⁄
 = 0;

42 i‡(
NULL
==(
tmp_dΩm2
=(
DecRefPicM¨kög_t
*)
	`ˇŒoc
 (1, (DecRefPicMarking_t))))

43 
	`no_mem_exô
("poc_based_ref_management:Åmp_drpm2");

44 
tmp_dΩm2
->
Next
=
tmp_dΩm
;

46 
tmp_dΩm2
->
mem‹y_m™agemít_c⁄åﬁ_›î©i⁄
 = 3;

47 
tmp_dΩm2
->
l⁄g_ãrm_‰ame_idx
 = 
cuºít_pic_num
;

48 
p_Vid
->
dec_ªf_pic_m¨kög_buf„r
 = 
tmp_dΩm2
;

52 
p_Vid
->
l⁄g_ãrm_ª„ªn˚_Êag
 = 
TRUE
;

54 
	}
}

56 #i‡
HM50_LIKE_MMCO


57 
	$hm50_ªf_m™agemít_‰ame_pic
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
cuºít_pic_num
)

59 
VideoP¨amëîs
 *
p_Vid
 = 
p_Dpb
->p_Vid;

60 
i
;

61 
pic_num
 = 0;

63 
èrgë_poc
=-1;

64 
DecRefPicM¨kög_t
 *
tmp_dΩm
,*
tmp_dΩm2
;

67 i‡–
p_Vid
->
p_I≈
->
NumbîBFømes
 != 7 ||

68 
p_Vid
->
p_I≈
->
num_ªf_‰ames
 != 4 ||

69 
p_Vid
->
p_I≈
->
B_Li°0_ªfs
[0] != 2 ||

70 
p_Vid
->
p_I≈
->
B_Li°1_ªfs
[0] != 2 )

75 #i‡
CRA


77 i‡–
p_Vid
->
p_I≈
->
u£CRA
 )

79 i‡––
p_Vid
->
cuºítSli˚
->
¶i˚_ty≥
 =
B_SLICE
 ||Ö_Vid->cuºítSli˚->¶i˚_ty≥ =
P_SLICE
 ) &&Ö_Vid->cuºítSli˚->
p_Dpb
->
ªf_‰ames_ö_buf„r
 >= 2 )

81 i‡––(
p_Vid
->
cuºítSli˚
->
ThisPOC
/2Ë- (p_Vid->
p_I≈
->
NumbîBFømes
+1ËË%Ö_Vid->p_I≈->
öåa_≥riod
 == 0 )

89 i‡(
p_Vid
->
dec_ªf_pic_m¨kög_buf„r
!=
NULL
)

92 i‡–
p_Vid
->
cuºítPi˘uª
->
idr_Êag
 )

95 i‡((
p_Dpb
->
ªf_‰ames_ö_buf„r
 +Ö_Dpb->
…ªf_‰ames_ö_buf„r
)==0)

98  
p_Vid
->
cuºítSli˚
->
ThisPOC
 / 2 % 8 )

101 
èrgë_poc
 = 
p_Vid
->
cuºítSli˚
->
ThisPOC
 - 32;

104 
èrgë_poc
 = 
p_Vid
->
cuºítSli˚
->
ThisPOC
 - 16;

107 
èrgë_poc
 = 
p_Vid
->
cuºítSli˚
->
ThisPOC
 - 8;

110 
èrgë_poc
 = 
p_Vid
->
cuºítSli˚
->
ThisPOC
 - 8;

113 
èrgë_poc
 = -1;

117 i‡–
èrgë_poc
 < 0 )

121 
i
 = 0; i < 
p_Dpb
->
u£d_size
; i++)

123 i‡(
p_Dpb
->
fs
[
i
]->
is_ª„ªn˚
 && (!’_Dpb->fs[i]->
is_l⁄g_ãrm
)Ë&&Ö_Dpb->fs[i]->
poc
 =
èrgë_poc
)

125 
pic_num
 = 
p_Dpb
->
fs
[
i
]->
‰ame
->pic_num;

129 i‡(
NULL
==(
tmp_dΩm
=(
DecRefPicM¨kög_t
*)
	`ˇŒoc
 (1, (DecRefPicMarking_t))))

130 
	`no_mem_exô
("poc_based_ref_management:Åmp_drpm");

131 
tmp_dΩm
->
Next
=
NULL
;

133 
tmp_dΩm
->
mem‹y_m™agemít_c⁄åﬁ_›î©i⁄
 = 0;

135 i‡(
NULL
==(
tmp_dΩm2
=(
DecRefPicM¨kög_t
*)
	`ˇŒoc
 (1, (DecRefPicMarking_t))))

136 
	`no_mem_exô
("poc_based_ref_management:Åmp_drpm2");

137 
tmp_dΩm2
->
Next
=
tmp_dΩm
;

139 
tmp_dΩm2
->
mem‹y_m™agemít_c⁄åﬁ_›î©i⁄
 = 1;

141 i‡–
p_Vid
->
num_of_œyîs
 == 1 )

142 
tmp_dΩm2
->
dif„ªn˚_of_pic_nums_möus1
 = 
cuºít_pic_num
 - 
pic_num
 - 1;

144 
tmp_dΩm2
->
dif„ªn˚_of_pic_nums_möus1
 = (
cuºít_pic_num
 - 
pic_num
)/2 - 1;

146 
p_Vid
->
dec_ªf_pic_m¨kög_buf„r
 = 
tmp_dΩm2
;

147 
	}
}

150 #i‡
CRA


151 
	$¸a_ªf_m™agemít_‰ame_pic
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
cuºít_pic_num
)

153 
VideoP¨amëîs
 *
p_Vid
 = 
p_Dpb
->p_Vid;

154 
i
;

155 
pic_num
 = 0;

158 
DecRefPicM¨kög_t
 *
tmp_dΩm
,*
tmp_dΩm2
;

160 
œ°_öåa_poc
 = 
p_Vid
->
cuºítSli˚
->
ThisPOC
 / 2 /Ö_Vid->
p_I≈
->
öåa_≥riod
 *Ö_Vid->p_Inp->intra_period * 2;

162 i‡(
p_Vid
->
dec_ªf_pic_m¨kög_buf„r
!=
NULL
)

165 i‡–
p_Vid
->
cuºítPi˘uª
->
idr_Êag
 )

168 i‡((
p_Dpb
->
ªf_‰ames_ö_buf„r
 +Ö_Dpb->
…ªf_‰ames_ö_buf„r
)==0)

171 i‡(
NULL
==(
tmp_dΩm
=(
DecRefPicM¨kög_t
*)
	`ˇŒoc
 (1, (DecRefPicMarking_t))))

172 
	`no_mem_exô
("poc_based_ref_management:Åmp_drpm");

173 
tmp_dΩm
->
Next
=
NULL
;

175 
tmp_dΩm
->
mem‹y_m™agemít_c⁄åﬁ_›î©i⁄
 = 0;

177 
i
 = 0; i < 
p_Dpb
->
u£d_size
; i++)

179 i‡(
p_Dpb
->
fs
[
i
]->
is_ª„ªn˚
 && (!’_Dpb->fs[i]->
is_l⁄g_ãrm
)Ë&&Ö_Dpb->fs[i]->
poc
 < 
œ°_öåa_poc
)

181 i‡(
NULL
==(
tmp_dΩm2
=(
DecRefPicM¨kög_t
*)
	`ˇŒoc
 (1, (DecRefPicMarking_t))))

182 
	`no_mem_exô
("poc_based_ref_management:Åmp_drpm2");

183 
tmp_dΩm2
->
Next
=
tmp_dΩm
;

184 
tmp_dΩm2
->
mem‹y_m™agemít_c⁄åﬁ_›î©i⁄
 = 1;

186 
pic_num
 = 
p_Dpb
->
fs
[
i
]->
‰ame
->pic_num;

188 i‡–
p_Vid
->
num_of_œyîs
 == 1 )

189 
tmp_dΩm2
->
dif„ªn˚_of_pic_nums_möus1
 = 
cuºít_pic_num
 - 
pic_num
 - 1;

191 
tmp_dΩm2
->
dif„ªn˚_of_pic_nums_möus1
 = (
cuºít_pic_num
 - 
pic_num
)/2 - 1;

193 i‡–
tmp_dΩm2
->
dif„ªn˚_of_pic_nums_möus1
 < 0 )

195 
tmp_dΩm2
->
dif„ªn˚_of_pic_nums_möus1
 +
p_Vid
->
cuºítSli˚
->
max_‰ame_num
;

197 i‡–
tmp_dΩm2
->
dif„ªn˚_of_pic_nums_möus1
 >(Ë
p_Vid
->
cuºítSli˚
->
max_‰ame_num
 )

199 
tmp_dΩm2
->
dif„ªn˚_of_pic_nums_möus1
 -
p_Vid
->
cuºítSli˚
->
max_‰ame_num
;

202 
tmp_dΩm
 = 
tmp_dΩm2
;

206 
p_Vid
->
dec_ªf_pic_m¨kög_buf„r
 = 
tmp_dΩm
;

207 
	}
}

210 #i‡
LD_REF_SETTING


211 
	$low_dñay_ªf_m™agemít_‰ame_pic
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
cuºít_pic_num
)

213 
VideoP¨amëîs
 *
p_Vid
 = 
p_Dpb
->p_Vid;

214 
i
;

215 
pic_num
 = 0;

217 
mö_poc
=
INT_MAX
;

218 
mö_poc_nŸ_4x
 = 
INT_MAX
;

219 
DecRefPicM¨kög_t
 *
tmp_dΩm
,*
tmp_dΩm2
;

221 #i‡
CRA


223 i‡–
p_Vid
->
p_I≈
->
u£CRA
 )

225 i‡––
p_Vid
->
cuºítSli˚
->
¶i˚_ty≥
 =
B_SLICE
 ||Ö_Vid->cuºítSli˚->¶i˚_ty≥ =
P_SLICE
 ) &&Ö_Vid->cuºítSli˚->
p_Dpb
->
ªf_‰ames_ö_buf„r
 >= 2 )

227 i‡––(
p_Vid
->
cuºítSli˚
->
ThisPOC
/2Ë- (p_Vid->
p_I≈
->
NumbîBFømes
+1ËË%Ö_Vid->p_I≈->
öåa_≥riod
 == 0 )

235 i‡(
p_Vid
->
dec_ªf_pic_m¨kög_buf„r
!=
NULL
)

238 i‡–
p_Vid
->
cuºítPi˘uª
->
idr_Êag
 )

241 i‡((
p_Dpb
->
ªf_‰ames_ö_buf„r
 +Ö_Dpb->
…ªf_‰ames_ö_buf„r
)==0)

244 
i
 = 0; i < 
p_Dpb
->
u£d_size
; i++)

246 i‡(
p_Dpb
->
fs
[
i
]->
is_ª„ªn˚
 && (!’_Dpb->fs[i]->
is_l⁄g_ãrm
)Ë&&Ö_Dpb->fs[i]->
poc
 < 
mö_poc
)

248 
mö_poc
 = 
p_Dpb
->
fs
[
i
]->
‰ame
->
poc
 ;

249 
pic_num
 = 
p_Dpb
->
fs
[
i
]->
‰ame
->pic_num;

252 
i
 = 0; i < 
p_Dpb
->
u£d_size
; i++)

254 i‡(
p_Dpb
->
fs
[
i
]->
is_ª„ªn˚
 && (!’_Dpb->fs[i]->
is_l⁄g_ãrm
)Ë&&Ö_Dpb->fs[i]->
poc
 < 
mö_poc_nŸ_4x
 && (p_Dpb->fs[i]->poc/2)%4!=0 )

256 
mö_poc_nŸ_4x
 = 
p_Dpb
->
fs
[
i
]->
‰ame
->
poc
 ;

257 
pic_num
 = 
p_Dpb
->
fs
[
i
]->
‰ame
->pic_num;

261 i‡(
NULL
==(
tmp_dΩm
=(
DecRefPicM¨kög_t
*)
	`ˇŒoc
 (1, (DecRefPicMarking_t))))

262 
	`no_mem_exô
("poc_based_ref_management:Åmp_drpm");

263 
tmp_dΩm
->
Next
=
NULL
;

265 
tmp_dΩm
->
mem‹y_m™agemít_c⁄åﬁ_›î©i⁄
 = 0;

267 i‡(
NULL
==(
tmp_dΩm2
=(
DecRefPicM¨kög_t
*)
	`ˇŒoc
 (1, (DecRefPicMarking_t))))

268 
	`no_mem_exô
("poc_based_ref_management:Åmp_drpm2");

269 
tmp_dΩm2
->
Next
=
tmp_dΩm
;

271 
tmp_dΩm2
->
mem‹y_m™agemít_c⁄åﬁ_›î©i⁄
 = 1;

273 i‡–
p_Vid
->
num_of_œyîs
 == 1 )

274 
tmp_dΩm2
->
dif„ªn˚_of_pic_nums_möus1
 = 
cuºít_pic_num
 - 
pic_num
 - 1;

276 
tmp_dΩm2
->
dif„ªn˚_of_pic_nums_möus1
 = (
cuºít_pic_num
 - 
pic_num
)/2 - 1;

278 
p_Vid
->
dec_ªf_pic_m¨kög_buf„r
 = 
tmp_dΩm2
;

279 
	}
}

289 
	$poc_ba£d_ªf_m™agemít_‰ame_pic
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
cuºít_pic_num
)

291 
VideoP¨amëîs
 *
p_Vid
 = 
p_Dpb
->p_Vid;

292 
i
;

293 
pic_num
 = 0;

295 
mö_poc
=
INT_MAX
;

296 
DecRefPicM¨kög_t
 *
tmp_dΩm
,*
tmp_dΩm2
;

298 #i‡
CRA


300 i‡–
p_Vid
->
p_I≈
->
u£CRA
 )

302 i‡––
p_Vid
->
cuºítSli˚
->
¶i˚_ty≥
 =
B_SLICE
 ||Ö_Vid->cuºítSli˚->¶i˚_ty≥ =
P_SLICE
 ) &&Ö_Vid->cuºítSli˚->
p_Dpb
->
ªf_‰ames_ö_buf„r
 >= 2 )

304 i‡––(
p_Vid
->
cuºítSli˚
->
ThisPOC
/2Ë- (p_Vid->
p_I≈
->
NumbîBFømes
+1ËË%Ö_Vid->p_I≈->
öåa_≥riod
 == 0 )

312 #i‡
HM50_LIKE_MMCO


313 i‡–
p_Vid
->
p_I≈
->
HM50RefSåu˘uª
 )

316 i‡–
p_Vid
->
p_I≈
->
NumbîBFømes
 != 7 ||

317 
p_Vid
->
p_I≈
->
num_ªf_‰ames
 != 4 ||

318 
p_Vid
->
p_I≈
->
B_Li°0_ªfs
[0] != 2 ||

319 
p_Vid
->
p_I≈
->
B_Li°1_ªfs
[0] != 2 )

326 i‡(
p_Vid
->
dec_ªf_pic_m¨kög_buf„r
!=
NULL
)

329 i‡–
p_Vid
->
cuºítPi˘uª
->
idr_Êag
 )

332 i‡((
p_Dpb
->
ªf_‰ames_ö_buf„r
 +Ö_Dpb->
…ªf_‰ames_ö_buf„r
)==0)

335 
i
 = 0; i < 
p_Dpb
->
u£d_size
; i++)

337 i‡(
p_Dpb
->
fs
[
i
]->
is_ª„ªn˚
 && (!’_Dpb->fs[i]->
is_l⁄g_ãrm
)Ë&&Ö_Dpb->fs[i]->
poc
 < 
mö_poc
)

339 
mö_poc
 = 
p_Dpb
->
fs
[
i
]->
‰ame
->
poc
 ;

340 
pic_num
 = 
p_Dpb
->
fs
[
i
]->
‰ame
->pic_num;

344 i‡(
NULL
==(
tmp_dΩm
=(
DecRefPicM¨kög_t
*)
	`ˇŒoc
 (1, (DecRefPicMarking_t))))

345 
	`no_mem_exô
("poc_based_ref_management:Åmp_drpm");

346 
tmp_dΩm
->
Next
=
NULL
;

348 
tmp_dΩm
->
mem‹y_m™agemít_c⁄åﬁ_›î©i⁄
 = 0;

350 i‡(
NULL
==(
tmp_dΩm2
=(
DecRefPicM¨kög_t
*)
	`ˇŒoc
 (1, (DecRefPicMarking_t))))

351 
	`no_mem_exô
("poc_based_ref_management:Åmp_drpm2");

352 
tmp_dΩm2
->
Next
=
tmp_dΩm
;

354 
tmp_dΩm2
->
mem‹y_m™agemít_c⁄åﬁ_›î©i⁄
 = 1;

355 
tmp_dΩm2
->
dif„ªn˚_of_pic_nums_möus1
 = 
cuºít_pic_num
 - 
pic_num
 - 1;

357 
p_Vid
->
dec_ªf_pic_m¨kög_buf„r
 = 
tmp_dΩm2
;

358 
	}
}

367 
	$poc_ba£d_ªf_m™agemít_fõld_pic
(
DecodedPi˘uªBuf„r
 *
p_Dpb
, 
cuºít_pic_num
)

369 
VideoP¨amëîs
 *
p_Vid
 = 
p_Dpb
->p_Vid;

370 
i
;

371 
pic_num1
 = 0, 
pic_num2
 = 0;

373 
mö_poc
=
INT_MAX
;

374 
DecRefPicM¨kög_t
 *
tmp_dΩm
,*
tmp_dΩm2
, *
tmp_dΩm3
;

376 i‡(
p_Vid
->
dec_ªf_pic_m¨kög_buf„r
!=
NULL
)

379 i‡–
p_Vid
->
cuºítPi˘uª
->
idr_Êag
 )

382 i‡((
p_Dpb
->
ªf_‰ames_ö_buf„r
 +Ö_Dpb->
…ªf_‰ames_ö_buf„r
)==0)

385 i‡–
p_Vid
->
°ru˘uª
 =
TOP_FIELD
 )

387 
i
=0; i<
p_Dpb
->
u£d_size
;i++)

389 i‡(
p_Dpb
->
fs
[
i
]->
is_ª„ªn˚
 && (!’_Dpb->fs[i]->
is_l⁄g_ãrm
)Ë&&Ö_Dpb->fs[i]->
poc
 < 
mö_poc
)

391 
mö_poc
 = 
p_Dpb
->
fs
[
i
]->
poc
;

392 
pic_num1
 = 
p_Dpb
->
fs
[
i
]->
t›_fõld
->
pic_num
;

393 
pic_num2
 = 
p_Dpb
->
fs
[
i
]->
bŸtom_fõld
->
pic_num
;

398 i‡(
NULL
==(
tmp_dΩm
=(
DecRefPicM¨kög_t
*)
	`ˇŒoc
 (1, (DecRefPicM¨kög_t)))Ë
	`no_mem_exô
("poc_based_ref_management_field_pic:Åmp_drpm");

399 
tmp_dΩm
->
Next
=
NULL
;

400 
tmp_dΩm
->
mem‹y_m™agemít_c⁄åﬁ_›î©i⁄
 = 0;

402 i‡–
p_Vid
->
°ru˘uª
 =
BOTTOM_FIELD
 )

404 
p_Vid
->
dec_ªf_pic_m¨kög_buf„r
 = 
tmp_dΩm
;

408 i‡(
NULL
==(
tmp_dΩm2
=(
DecRefPicM¨kög_t
*)
	`ˇŒoc
 (1, (DecRefPicM¨kög_t)))Ë
	`no_mem_exô
("poc_based_ref_management_field_pic:Åmp_drpm2");

409 
tmp_dΩm2
->
Next
=
tmp_dΩm
;

410 
tmp_dΩm2
->
mem‹y_m™agemít_c⁄åﬁ_›î©i⁄
 = 1;

411 
tmp_dΩm2
->
dif„ªn˚_of_pic_nums_möus1
 = 
cuºít_pic_num
 - 
pic_num1
 - 1;

413 i‡(
NULL
==(
tmp_dΩm3
=(
DecRefPicM¨kög_t
*)
	`ˇŒoc
 (1, (DecRefPicM¨kög_t)))Ë
	`no_mem_exô
("poc_based_ref_management_field_pic:Åmp_drpm3");

414 
tmp_dΩm3
->
Next
=
tmp_dΩm2
;

415 
tmp_dΩm3
->
mem‹y_m™agemít_c⁄åﬁ_›î©i⁄
 = 1;

416 
tmp_dΩm3
->
dif„ªn˚_of_pic_nums_möus1
 = 
cuºít_pic_num
 - 
pic_num2
 - 1;

418 
p_Vid
->
dec_ªf_pic_m¨kög_buf„r
 = 
tmp_dΩm3
;

419 
	}
}

429 
	$éyr_ba£d_ªf_m™agemít_‰ame_pic
(
VideoP¨amëîs
 *
p_Vid
, 
cuºít_pic_num
)

431 
i
, 
fú°
 = 1;

432 
DecRefPicM¨kög_t
 *
dΩm
 = 
NULL
, *
cuºít_dΩm
 = NULL, *
tmp_dΩm
 = NULL;

433 
decoded_pi˘uª_buf„r
 *
p_Dpb
 = 
p_Vid
->
p_Dpb_œyî
[0];

435 i‡(
p_Vid
->
dec_ªf_pic_m¨kög_buf„r
!=
NULL
)

438 i‡–
p_Vid
->
cuºítPi˘uª
->
idr_Êag
 )

441 i‡((
p_Dpb
->
ªf_‰ames_ö_buf„r
 +Ö_Dpb->
…ªf_‰ames_ö_buf„r
)==0)

444 
i
 = 0; i < 
p_Dpb
->
u£d_size
; i++)

446 i‡(
p_Dpb
->
fs
[
i
]->
is_ª„ªn˚
 && (!’_Dpb->fs[i]->
is_l⁄g_ãrm
)Ë&&Ö_Dpb->fs[i]->
‰ame
->
ãmp‹Æ_œyî
 > 
p_Vid
->
íc_pi˘uª
->temporal_layer)

448 i‡(
NULL
 =(
tmp_dΩm
=(
DecRefPicM¨kög_t
*)
	`ˇŒoc
 (1, (DecRefPicMarking_t))))

449 
	`no_mem_exô
("poc_based_ref_management:Åmp_drpm2");

450 
tmp_dΩm
->
mem‹y_m™agemít_c⁄åﬁ_›î©i⁄
 = 1;

451 
tmp_dΩm
->
dif„ªn˚_of_pic_nums_möus1
 = 
cuºít_pic_num
 - 
p_Dpb
->
fs
[
i
]->
‰ame
->
pic_num
 - 1;

453 i‡(
fú°
)

455 
dΩm
 = 
cuºít_dΩm
 = 
tmp_dΩm
;

456 
fú°
 = 0;

460 
cuºít_dΩm
->
Next
 = 
tmp_dΩm
;

461 
cuºít_dΩm
 = cuºít_dΩm->
Next
;

466 i‡(
fú°
)

469 i‡(
NULL
==(
tmp_dΩm
=(
DecRefPicM¨kög_t
*)
	`ˇŒoc
 (1, (DecRefPicMarking_t))))

470 
	`no_mem_exô
("poc_based_ref_management:Åmp_drpm");

471 
tmp_dΩm
->
Next
=
NULL
;

473 
tmp_dΩm
->
mem‹y_m™agemít_c⁄åﬁ_›î©i⁄
 = 0;

475 
cuºít_dΩm
->
Next
=
tmp_dΩm
;

477 
p_Vid
->
dec_ªf_pic_m¨kög_buf„r
 = 
dΩm
;

478 
	}
}

	@lencod/src/mode_decision.c

12 
	~<m©h.h
>

13 
	~<limôs.h
>

14 
	~<Êﬂt.h
>

16 
	~"globÆ.h
"

17 
	~"image.h
"

18 
	~"øã˘l.h
"

19 
	~"mode_decisi⁄.h
"

20 
	~"md_comm⁄.h
"

21 
	~"me_umhex.h
"

22 
	~"me_umhexsmp.h
"

23 
	~"ma¸oblock.h
"

24 
	~"rdoq.h
"

25 
	~"q_¨ound.h
"

26 
	~"¶i˚.h
"

27 
	~"c⁄f‹m™˚.h
"

28 
	~"rd›t.h
"

37 
	$ª£t_vÆid_modes
(
RD_PARAMS
 *
íc_mb
)

39 
	`mem£t
(
íc_mb
->
vÆid
, 0, 
MAXMODE
 * ());

40 
	}
}

49 
ölöe
 
	$check_f‹_SI16
(**
Ãec
, 
pix_x
, 
pix_y
)

51 
i
,
j
;

52 
i
 = 
pix_y
; i <Öix_y + 
MB_BLOCK_SIZE
; i++)

54 
j
 = 
pix_x
;j <Öix_x + 
MB_BLOCK_SIZE
; j++)

55 i‡(
Ãec
[
i
][
j
] != -16)

59 
	}
}

67 
	$íd_ícode_⁄e_ma¸oblock
(
Ma¸oblock
 *
cuºMB
)

69 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

70 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

71 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

73 
	`upd©e_qp_cbp
(
cuºMB
);

75 i‡–(
cuºSli˚
->
mb_aff_‰ame_Êag
)

76 && (
cuºMB
->
mbAddrX
 & 0x01)

77 && (
cuºMB
->
mb_ty≥
 ? 0:(((
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
)Ë? !cuºMB->
cbp
:1))

78 && ((
cuºMB
->
PªvMB
)->
mb_ty≥
 ? 0:(((
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
)Ë? !(cuºMB->PªvMB)->
cbp
:1))

79 && !(
	`fõld_Êag_ö„ªn˚
(
cuºMB
Ë=cuºMB->
mb_fõld
))

81 
cuºSli˚
->
rdd©a
->
mö_rdco°
 = 1e30;

84 
cuºSli˚
->
rdd©a
->
mö_rdco°
 = ()
cuºMB
->min_rdcost;

86 
cuºSli˚
->
rdd©a
->
mö_dco°
 = ()
cuºMB
->min_dcost;

87 
cuºSli˚
->
rdd©a
->
mö_øã
 = ()
cuºMB
->min_rate;

89 if(
p_I≈
->
SórchMode
[
p_Vid
->
võw_id
] =
UM_HEX
)

91 
	`UMHEX_skù_öåabk_SAD
(
cuºMB
, 
cuºSli˚
->
li°Xsize
[cuºMB->
li°_off£t
]);

93 if(
p_I≈
->
SórchMode
[
p_Vid
->
võw_id
] =
UM_HEX_SIMPLE
)

95 
	`smpUMHEX_skù_öåabk_SAD
(
cuºMB
);

99 if(
p_I≈
->
U£C⁄°øöedI¡øPªd
 && (
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
 || cuºSli˚->¶i˚_ty≥ =
B_SLICE
))

101 
p_Vid
->
öåa_block
[
cuºMB
->
mbAddrX
] = 
	`is_öåa
(currMB);

103 
	}
}

111 
	$öô_íc_mb_∑øms
(
Ma¸oblock
* 
cuºMB
, 
RD_PARAMS
 *
íc_mb
, 
öåa
)

113 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

114 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

115 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

116 #i‡(
MVC_EXTENSION_ENABLE
)

117 *
I¡îSórch
 = 
p_I≈
->I¡îSórch[(
p_Vid
->
num_of_œyîs
 > 1Ë? 
cuºSli˚
->
võw_id
 : 0][(cuºSli˚->
¶i˚_ty≥
 =
B_SLICE
)];

119 *
I¡îSórch
 = 
p_I≈
->I¡îSórch[0][(
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
)];

122 
l
,
k
;

124 
íc_mb
->
cuº_mb_fõld
 = (Ë((
cuºSli˚
->
mb_aff_‰ame_Êag
Ë&& (
cuºMB
->
mb_fõld
));

127 
íc_mb
->
vÆid
[
I8MB
] = (Ë((!
p_I≈
->
DißbÀI¡øInI¡î
[
p_Vid
->
võw_id
] || 
öåa
 )?Ö_I≈->
Tønsf‹m8x8Mode
 : 0);

128 
íc_mb
->
vÆid
[
I4MB
] = (Ë((!
p_I≈
->
DißbÀI¡øInI¡î
[
p_Vid
->
võw_id
] || 
öåa
 )? (’_I≈->
Tønsf‹m8x8Mode
 == 2) ? 0 : 1) : 0);

129 
íc_mb
->
vÆid
[
I4MB
] = (Ë((!
p_I≈
->
DißbÀI¡ø4x4
 ) ?Énc_mb->valid[I4MB] : 0);

130 
íc_mb
->
vÆid
[
I16MB
] = (Ë((!
p_I≈
->
DißbÀI¡øInI¡î
[
p_Vid
->
võw_id
] || 
öåa
 )? 1 : 0);

131 
íc_mb
->
vÆid
[
I16MB
] = (Ë((!
p_I≈
->
DißbÀI¡ø16x16
) ?Énc_mb->valid[I16MB] : 0);

132 
íc_mb
->
vÆid
[
IPCM
] = (Ë((!
p_I≈
->
DißbÀI¡øInI¡î
[
p_Vid
->
võw_id
] || 
öåa
 )? (p_I≈->
E«bÀIPCM
 > 0 ? 1:0) : 0);

133 
íc_mb
->
vÆid
[
SI4MB
] = 0;

137 
íc_mb
->
vÆid
[0] = (Ë(!
öåa
 && 
I¡îSórch
[0]);

138 
íc_mb
->
vÆid
[1] = (Ë(!
öåa
 && 
I¡îSórch
[1]);

139 
íc_mb
->
vÆid
[2] = (Ë(!
öåa
 && 
I¡îSórch
[2]);

140 
íc_mb
->
vÆid
[3] = (Ë(!
öåa
 && 
I¡îSórch
[3]);

141 
íc_mb
->
vÆid
[4] = (Ë(!
öåa
 && 
I¡îSórch
[4]);

142 
íc_mb
->
vÆid
[5] = (Ë(!
öåa
 && 
I¡îSórch
[5] && !(
p_I≈
->
Tønsf‹m8x8Mode
==2));

143 
íc_mb
->
vÆid
[6] = (Ë(!
öåa
 && 
I¡îSórch
[6] && !(
p_I≈
->
Tønsf‹m8x8Mode
==2));

144 
íc_mb
->
vÆid
[7] = (Ë(!
öåa
 && 
I¡îSórch
[7] && !(
p_I≈
->
Tønsf‹m8x8Mode
==2));

145 
íc_mb
->
vÆid
[
P8x8
] = () (enc_mb->valid[4] ||Énc_mb->valid[5] ||Énc_mb->valid[6] ||Énc_mb->valid[7]);

148 i‡(
cuºSli˚
->
U£RDOQu™t
 && 
p_I≈
->
RDOQ_CP_Mode
 && (
p_Vid
->
qp
 !p_Vid->
ma°îQP
) )

149 
	`RDOQ_upd©e_mode
(
cuºSli˚
, 
íc_mb
);

151 if(
cuºSli˚
->
¶i˚_ty≥
 =
SP_SLICE
 || cuºSli˚->¶i˚_ty≥ =
SI_SLICE
)

153 if(
cuºSli˚
->
¶i˚_ty≥
 =
SI_SLICE
)

155 
	`ª£t_vÆid_modes
(
íc_mb
);

156 if(
	`check_f‹_SI16
(
p_Vid
->
Ãec
, 
cuºMB
->
pix_x
, cuºMB->
pix_y
))

158 
íc_mb
->
vÆid
[
I16MB
] = 1;

162 
íc_mb
->
vÆid
[
I4MB
] = 1;

166 if(
p_Vid
->
•2_‰ame_ödiˇt‹
)

168 if(
	`check_f‹_SI16
(
p_Vid
->
Ãec
, 
cuºMB
->
pix_x
, cuºMB->
pix_y
))

170 
	`ª£t_vÆid_modes
(
íc_mb
);

171 
íc_mb
->
vÆid
[
I16MB
] = 1;

175 
íc_mb
->
vÆid
[
I8MB
] = 0;

176 
íc_mb
->
vÆid
[
IPCM
] = 0;

177 
íc_mb
->
vÆid
[0] = 0;

186 
íc_mb
->
œmbda_md
 = 
p_Vid
->œmbda_md[
cuºSli˚
->
¶i˚_ty≥
][p_Vid->
ma°îQP
];

188 
íc_mb
->
œmbda_mdÂ
 = 
	`LAMBDA_FACTOR
”nc_mb->
œmbda_md
);

191 
	`mem˝y
(
íc_mb
->
œmbda_me
, 
p_Vid
->œmbda_me[
cuºSli˚
->
¶i˚_ty≥
][p_Vid->
ma°îQP
], 3 * ());

192 
	`mem˝y
(
íc_mb
->
œmbda_mf
, 
p_Vid
->œmbda_mf[
cuºSli˚
->
¶i˚_ty≥
][p_Vid->
ma°îQP
], 3 * ());

194 i‡(!
cuºSli˚
->
mb_aff_‰ame_Êag
)

196 
l
 = 
LIST_0
;Ü < 
BI_PRED
;Ü++)

198 
k
 = 0; k < 
cuºSli˚
->
li°Xsize
[
l
]; k++)

200 if(
cuºSli˚
->
°ru˘uª
 !cuºSli˚->
li°X
[
l
][
k
]->structure)

202 i‡(
cuºSli˚
->
°ru˘uª
 =
TOP_FIELD
)

203 
cuºSli˚
->
li°X
[
l
][
k
]->
chroma_ve˘‹_adju°mít
 = -2;

204 i‡(
cuºSli˚
->
°ru˘uª
 =
BOTTOM_FIELD
)

205 
cuºSli˚
->
li°X
[
l
][
k
]->
chroma_ve˘‹_adju°mít
 = 2;

207 
cuºSli˚
->
li°X
[
l
][
k
]->
chroma_ve˘‹_adju°mít
= 0;

210 
cuºSli˚
->
li°X
[
l
][
k
]->
chroma_ve˘‹_adju°mít
= 0;

216 i‡(
íc_mb
->
cuº_mb_fõld
)

218 
l
 = 
cuºMB
->
li°_off£t
;Ü <cuºMB->li°_off£à+ 
LIST_1
;Ü++)

220 
k
 = 0; k < 
cuºSli˚
->
li°Xsize
[
l
]; k++)

222 
cuºSli˚
->
li°X
[
l
][
k
]->
chroma_ve˘‹_adju°mít
= 0;

223 if((
cuºMB
->
mbAddrX
 & 0x01Ë=0 && 
cuºSli˚
->
li°X
[
l
][
k
]->
°ru˘uª
 =
BOTTOM_FIELD
)

224 
cuºSli˚
->
li°X
[
l
][
k
]->
chroma_ve˘‹_adju°mít
 = -2;

225 if((
cuºMB
->
mbAddrX
 & 0x01Ë=1 && 
cuºSli˚
->
li°X
[
l
][
k
]->
°ru˘uª
 =
TOP_FIELD
)

226 
cuºSli˚
->
li°X
[
l
][
k
]->
chroma_ve˘‹_adju°mít
 = 2;

232 
l
 = 
cuºMB
->
li°_off£t
;Ü <cuºMB->li°_off£à+ 
LIST_1
;Ü++)

234 
k
 = 0; k < 
cuºSli˚
->
li°Xsize
[
l
]; k++)

235 
cuºSli˚
->
li°X
[
l
][
k
]->
chroma_ve˘‹_adju°mít
 = 0;

241 
cuºMB
->
c_ùªd_mode
 = 
DC_PRED_8
;

244 if(
p_I≈
->
SórchMode
[
p_Vid
->
võw_id
] =
UM_HEX
)

246 
	`UMHEX_decide_öåabk_SAD
(
cuºMB
);

247 
	`UMHEX_DeföeThªshﬁdMB
(
p_Vid
, 
p_I≈
);

249 i‡(
p_I≈
->
SórchMode
[
p_Vid
->
võw_id
] =
UM_HEX_SIMPLE
)

251 
	`smpUMHEX_decide_öåabk_SAD
(
cuºMB
);

254 
	}
}

256 
	$upd©e_mco°
(
Sli˚
 *
cuºSli˚
, 
ªf_œmbda
, 
ªf
, 
cur_li°
, 
di°blk
 
mco°
, di°blk *
bmco°
, *
be°_ªf
)

258 i‡(
mco°
 < *
bmco°
)

260 
mco°
 +
	`ªf_co°
(
cuºSli˚
, 
ªf_œmbda
, 
ªf
, 
cur_li°
);

262 i‡(
mco°
 < *
bmco°
)

264 *
bmco°
 = 
mco°
;

265 *
be°_ªf
 = ()
ªf
;

268 
	}
}

275 
	$li°_¥edi˘i⁄_co°
(
Ma¸oblock
 *
cuºMB
, 
li°
, 
block
, 
mode
, 
RD_PARAMS
 *
íc_mb
, 
di°blk
 
bmco°
[5], 
be°_ªf
[2])

277 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

278 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

279 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

281 
ªf
;

282 
cur_li°
 = 
li°
 < 
BI_PRED
 ? 
cuºMB
->
li°_off£t
 +Üist : currMB->list_offset;

283 
ªf_œmbda
 = (
p_I≈
->
rd›t
Ë? 
íc_mb
->
œmbda_mf
[
Q_PEL
] :Énc_mb->lambda_mf[Q_PEL] >> 2;

286 i‡(
li°
 < 
BI_PRED
)

288 
di°blk
 **
mŸi⁄_co°
 = 
p_Vid
->mŸi⁄_co°[
mode
][
li°
];

290 
•_ödiˇt‹
 = (
p_I≈
->
•2_‰ame_ödiˇt‹
 ||Ö_I≈->
•_ouçut_ödiˇt‹
);

292 i‡(!
p_Vid
->
checkªf
 || 
li°
)

294 i‡(
p_I≈
->
•2_‰ame_ödiˇt‹
 =0 &&Ö_I≈->
•_ouçut_ödiˇt‹
 == 0)

296 
ªf
 = 0;Ñe‡< 
cuºSli˚
->
li°Xsize
[
cur_li°
];Ñef++)

298 
	`upd©e_mco°
(
cuºSli˚
, 
ªf_œmbda
, 
ªf
, 
cur_li°
, 
mŸi⁄_co°
[ªf][
block
], &
bmco°
[
li°
], &
be°_ªf
[list]);

303 
ªf
 = 0;Ñe‡< 
cuºSli˚
->
li°Xsize
[
cur_li°
];Ñef++)

306 if((((
cuºSli˚
->
¶i˚_ty≥
 !
P_SLICE
 && cuºSli˚->¶i˚_ty≥ !
SP_SLICE
)Ë|| (
ªf
 == 0)))

308 
	`upd©e_mco°
(
cuºSli˚
, 
ªf_œmbda
, 
ªf
, 
cur_li°
, 
mŸi⁄_co°
[ªf][
block
], &
bmco°
[
li°
], &
be°_ªf
[list]);

315 
ªf
 = 0;Ñe‡< 
cuºSli˚
->
li°Xsize
[
cur_li°
];Ñef++)

317 i‡(
ªf
 =0 || (
p_I≈
->
Re°ri˘Ref
 && 
	`CheckRñübûôyOfRef
 (
cuºMB
, 
block
, 
li°
,Ñef, 
mode
)))

320 if–!(
•_ödiˇt‹
Ë|| (((
cuºSli˚
->
¶i˚_ty≥
 !
P_SLICE
 && cuºSli˚->¶i˚_ty≥ !
SP_SLICE
))|| (
ªf
 == 0)))

322 
	`upd©e_mco°
(
cuºSli˚
, 
ªf_œmbda
, 
ªf
, 
cur_li°
, 
mŸi⁄_co°
[ªf][
block
], &
bmco°
[
li°
], &
be°_ªf
[list]);

328 i‡(
li°
 =
BI_PRED
)

330 i‡(
p_Vid
->
a˘ive_µs
->
weighãd_bùªd_idc
 == 1)

332 
weight_sum
 = 
cuºSli˚
->
wbp_weight
[0][(Ë
be°_ªf
[
LIST_0
]][(Ëbe°_ªf[
LIST_1
]][0] +

333 
cuºSli˚
->
wbp_weight
[1][(Ë
be°_ªf
[
LIST_0
]][(Ëbe°_ªf[
LIST_1
]][0];

335 i‡(
weight_sum
 < -128 || weight_sum > 127)

337 
bmco°
[
li°
] = 
DISTBLK_MAX
;

341 
bmco°
[
li°
] = 
	`ªf_co°
(
cuºSli˚
, 
ªf_œmbda
, (Ë
be°_ªf
[
LIST_0
], 
cur_li°
) +

342 
	`ªf_co°
(
cuºSli˚
, 
ªf_œmbda
, (Ë
be°_ªf
[
LIST_1
], 
cur_li°
 + LIST_1);

343 
bmco°
[
li°
] +
	`BIDP¨tôi⁄Co°
 (
cuºMB
, 
mode
, 
block
, 
be°_ªf
, 
íc_mb
->
œmbda_mf
[
Q_PEL
]);

348 
bmco°
[
li°
] = 
	`ªf_co°
(
cuºSli˚
, 
ªf_œmbda
, (Ë
be°_ªf
[
LIST_0
], 
cur_li°
) +

349 
	`ªf_co°
(
cuºSli˚
, 
ªf_œmbda
, (Ë
be°_ªf
[
LIST_1
], 
cur_li°
 + LIST_1);

350 
bmco°
[
li°
] +
	`BIDP¨tôi⁄Co°
 (
cuºMB
, 
mode
, 
block
, 
be°_ªf
, 
íc_mb
->
œmbda_mf
[
Q_PEL
]);

355 i‡(
p_Vid
->
a˘ive_µs
->
weighãd_bùªd_idc
 == 1)

357 
weight_sum
 = 
cuºSli˚
->
wbp_weight
[0][0][0][0] + currSlice->wbp_weight[1][0][0][0];

359 i‡(
weight_sum
 < -128 || weight_sum > 127)

361 
bmco°
[
li°
] = 
DISTBLK_MAX
;

365 
bmco°
[
li°
] = 
	`ªf_co°
(
cuºSli˚
, 
ªf_œmbda
, 0, 
cur_li°
Ë+Ñef_co°(cuºSli˚,Ñef_œmbda, 0, cur_li° + 
LIST_1
);

366 
bmco°
[
li°
] +
	`BPªdP¨tôi⁄Co°
(
cuºMB
, 
mode
, 
block
, 0, 0, 
íc_mb
->
œmbda_mf
[
Q_PEL
], !(list&1));

371 
bmco°
[
li°
] = 
	`ªf_co°
(
cuºSli˚
, 
ªf_œmbda
, 0, 
cur_li°
Ë+Ñef_co°(cuºSli˚,Ñef_œmbda, 0, cur_li° + 
LIST_1
);

372 
bmco°
[
li°
] +
	`BPªdP¨tôi⁄Co°
(
cuºMB
, 
mode
, 
block
, 0, 0, 
íc_mb
->
œmbda_mf
[
Q_PEL
], !(list&1));

375 
	}
}

377 
ölöe
 
di°blk
 
	$compuã_ªf_co°
(
Sli˚
 *
cuºSli˚
, 
RD_PARAMS
 *
íc_mb
, 
ªf
, 
li°
)

379  
	`weighãd_co°
(
íc_mb
->
œmbda_mf
[
Q_PEL
],((
cuºSli˚
->
li°Xsize
[
li°
] <1)? 0 : cuºSli˚->
p_Vid
->
ªfbôs
[
ªf
]));

380 
	}
}

388 
	$dëîmöe_¥edi˘i⁄_li°
–
di°blk
 
bmco°
[5], 
Info8x8
 *
be°
, di°blk *
co°
)

390 
be°li°
;

391 *
co°
 +
	`di°blkmö¨øy
 ( 
bmco°
, 5, &
be°li°
);

393 i‡(
be°li°
 <
BI_PRED
)

395 
be°
->
pdú
 = (Ë
be°li°
;

396 
be°
->
bùªd
= 0;

400 
be°
->
pdú
 = 2;

401 
be°
->
bùªd
 = (Ë(
be°li°
 - 2);

402 
be°
->
ªf
[
LIST_0
] = 0;

403 
be°
->
ªf
[
LIST_1
] = 0;

405 
	}
}

414 
	$compuã_mode_RD_co°
(
Ma¸oblock
 *
cuºMB
,

415 
RD_PARAMS
 *
íc_mb
,

416 
mode
,

417 *
öãr_skù
)

419 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

420 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

421 
ãrmö©e_16x16
 = 0, 
ãrmö©e_å™s
 = 0, 
˘r16x16
 = 0;

422 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

423 
RDOPTSåu˘uª
 *
p_RDO
 = 
cuºSli˚
->p_RDO;

424 
b¶i˚
 = (
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
);

427 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = (
byã
Ë(
p_I≈
->
Tønsf‹m8x8Mode
==2

428 ? (
mode
 >= 1 && mode <= 3)

429 || (
mode
 =0 && 
b¶i˚
 && 
p_Vid
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
)

430 || ((
mode
 =
P8x8
Ë&& (
íc_mb
->
vÆid
[4]))

433 
cuºSli˚
->
	`£t_modes_™d_ªfs_f‹_blocks
 (
cuºMB
, (Ë
mode
);

437 
cuºSli˚
->
NoResidueDúe˘
 = 0;

439 i‡((
p_I≈
->
Fa°CrI¡øDecisi⁄
 ) || (
cuºMB
->
c_ùªd_mode
 =
DC_PRED_8
 || (
	`is_öåa
(currMB) )))

444 
ãrmö©e_16x16
 = 
	`b¶i˚_16x16_ãrmö©i⁄_c⁄åﬁ
(
p_I≈
, 
p_Vid
->
b8x8öfo
, &
˘r16x16
, 
mode
, 
b¶i˚
);

447 
RD_8x8DATA
 *
t8x8_d©a
 = 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 ? 
p_RDO
->
å8x8
 :Ö_RDO->
å4x4
;

449 i‡(
mode
 =
P8x8
 )

451 
p_Vid
->
b8x8öfo
->
be°
[
P8x8
][0] = 
t8x8_d©a
->
∑π
[0];

452 
p_Vid
->
b8x8öfo
->
be°
[
P8x8
][1] = 
t8x8_d©a
->
∑π
[1];

453 
p_Vid
->
b8x8öfo
->
be°
[
P8x8
][2] = 
t8x8_d©a
->
∑π
[2];

454 
p_Vid
->
b8x8öfo
->
be°
[
P8x8
][3] = 
t8x8_d©a
->
∑π
[3];

457 i‡(
	`CheckPªdi˘i⁄P¨ams
(
cuºMB
, 
p_Vid
->
b8x8öfo
, 
mode
Ë=
TRUE
)

459 i‡(
	`RDCo°_f‹_ma¸oblocks
 (
cuºMB
, 
íc_mb
->
œmbda_mdÂ
, 
mode
))

462 i‡(
p_I≈
->
RCE«bÀ
)

464 if(
mode
 =
P8x8
)

466 
	`rc_°‹e_diff
(
cuºSli˚
->
diffy
, &
p_Vid
->
pCurImg
[
cuºMB
->
›ix_y
], cuºMB->
pix_x
, 
t8x8_d©a
->
m¥8x8
);

469 
	`rc_°‹e_diff
(
cuºSli˚
->
diffy
, &
p_Vid
->
pCurImg
[
cuºMB
->
›ix_y
], cuºMB->
pix_x
, 
p_RDO
->
¥ed
);

472 
	`°‹e_ma¸oblock_∑ømëîs
 (
cuºMB
, 
mode
);

474 if(
p_I≈
->
rd›t
 =2 && 
mode
 =0 &&Ö_I≈->
E¨lySkùE«bÀ
)

477 if(
cuºMB
->
cbp
 == 0)

478 *
öãr_skù
 = 1;

484 
ãrmö©e_å™s
 = 
	`å™sf‹m_ãrmö©i⁄_c⁄åﬁ
(
cuºMB
, 
mode
);

486 }!
ãrmö©e_å™s
);

487 }!
ãrmö©e_16x16
);

491 i‡–(
b¶i˚
 && 
mode
 =0 && (*
öãr_skù
 =0Ë&& 
íc_mb
->
vÆid
[mode] && 
cuºMB
->
cbp
 && (cuºMB->cbp&15Ë!15 && !
p_I≈
->
nobskù


492 && !(
cuºMB
->
qp_sˇÀd
[0] =0 && 
p_Vid
->
a˘ive_•s
->
los¶ess_qµrime_Êag
==1) )

495 
cuºSli˚
->
NoResidueDúe˘
 = 1;

496 if(
mode
 =
P8x8
)

498 
RD_8x8DATA
 *
t8x8_d©a
 = 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 ? 
p_RDO
->
å8x8
 :Ö_RDO->
å4x4
;

499 
p_Vid
->
b8x8öfo
->
be°
[
P8x8
][0] = 
t8x8_d©a
->
∑π
[0];

500 
p_Vid
->
b8x8öfo
->
be°
[
P8x8
][1] = 
t8x8_d©a
->
∑π
[1];

501 
p_Vid
->
b8x8öfo
->
be°
[
P8x8
][2] = 
t8x8_d©a
->
∑π
[2];

502 
p_Vid
->
b8x8öfo
->
be°
[
P8x8
][3] = 
t8x8_d©a
->
∑π
[3];

503 if(
p_I≈
->
Tønsf‹m8x8Mode
 =1 && 
cuºMB
->
vÆid_8x8
 && cuºMB->
vÆid_4x4
)

505 
	`Re°‹eMV8x8
(
cuºSli˚
, (!
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
));

508 i‡(
	`CheckPªdi˘i⁄P¨ams
(
cuºMB
, 
p_Vid
->
b8x8öfo
, 
mode
Ë=
TRUE
)

510 i‡(
	`RDCo°_f‹_ma¸oblocks
 (
cuºMB
, 
íc_mb
->
œmbda_mdÂ
, 
mode
))

513 i‡(
p_I≈
->
RCE«bÀ
)

514 
	`rc_°‹e_diff
(
cuºSli˚
->
diffy
, &
p_Vid
->
pCurImg
[
cuºMB
->
›ix_y
], cuºMB->
pix_x
, 
p_RDO
->
¥ed
);

516 i‡(
p_Vid
->
Ad≠tiveRoundög
)

517 
	`ª£t_ad≠tive_roundög_dúe˘
(
p_Vid
);

519 
	`°‹e_ma¸oblock_∑ømëîs
 (
cuºMB
, 
mode
);

522 if(
mode
 =
P8x8
)

524 if(
p_I≈
->
Tønsf‹m8x8Mode
 =1 && 
cuºMB
->
vÆid_8x8
 && cuºMB->
vÆid_4x4
)

526 
	`Re°‹eMV8x8
(
cuºSli˚
, 0);

532 i‡(
p_Vid
->
Ad≠tiveRoundög
 && 
b¶i˚
 && 
mode
 <= 1)

534 i‡(
cuºMB
->
ãmp_å™sf‹m_size_8x8_Êag
)

535 
	`upd©e_ad≠tive_roundög_16x16
–
p_Vid
,Ö_Vid->
ARCofAdj8x8
, 
mode
);

537 
	`upd©e_ad≠tive_roundög_16x16
–
p_Vid
,Ö_Vid->
ARCofAdj4x4
, 
mode
);

540 
	}
}

542 
	$gë_öôül_mb16x16_co°
(
Ma¸oblock
* 
cuºMB
)

544 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

545 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

546 
RDOPTSåu˘uª
 *
p_RDO
 = 
cuºSli˚
->p_RDO;

547 i‡(
cuºMB
->
mb_À·
 && cuºMB->
mb_up
)

549 
p_Vid
->
mb16x16_co°
 = (p_Vid->
mb16x16_co°_‰ame
[
cuºMB
->
mbAddrX
 - 1] +

550 
p_Vid
->
mb16x16_co°_‰ame
[
cuºMB
->
mbAddrX
 - (p_Vid->
width
>>4)] + 1)/2.0;

552 i‡(
cuºMB
->
mb_À·
)

554 
p_Vid
->
mb16x16_co°
 =Ö_Vid->
mb16x16_co°_‰ame
[
cuºMB
->
mbAddrX
 - 1];

556 i‡(
cuºMB
->
mb_up
)

558 
p_Vid
->
mb16x16_co°
 =Ö_Vid->
mb16x16_co°_‰ame
[
cuºMB
->
mbAddrX
 - (p_Vid->
width
>>4)];

562 
p_Vid
->
mb16x16_co°
 = 
CALM_MF_FACTOR_THRESHOLD
;

565 
p_RDO
->
œmbda_mf_Á˘‹
 = 
p_Vid
->
mb16x16_co°
 < 
CALM_MF_FACTOR_THRESHOLD
 ? 1.0 : 
	`sqπ
’_Vid->mb16x16_co° / (CALM_MF_FACTOR_THRESHOLD *Ö_Vid->œmbda_mf_Á˘‹[
cuºSli˚
->
¶i˚_ty≥
][p_Vid->
qp
]));

566 
	}
}

568 
	$adju°_mb16x16_co°
(
Ma¸oblock
 *
cuºMB
, 
di°blk
 
co°
)

570 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

571 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

572 
RDOPTSåu˘uª
 *
p_RDO
 = 
cuºSli˚
->p_RDO;

574 
p_Vid
->
mb16x16_co°
 = (Ë
co°
;

575 
p_Vid
->
mb16x16_co°_‰ame
[
cuºMB
->
mbAddrX
] =Ö_Vid->
mb16x16_co°
;

576 #i‡
JCOST_CALC_SCALEUP


577 
p_RDO
->
œmbda_mf_Á˘‹
 = (
p_Vid
->
mb16x16_co°
 < 
CALM_MF_FACTOR_THRESHOLD
 * (1 << 
LAMBDA_ACCURACY_BITS
))

579 : 
	`sqπ
(
p_Vid
->
mb16x16_co°
 / (
CALM_MF_FACTOR_THRESHOLD
*(1<<
LAMBDA_ACCURACY_BITS
Ë*Ö_Vid->
œmbda_mf_Á˘‹
[
cuºSli˚
->
¶i˚_ty≥
][p_Vid->
qp
]));

581 
p_RDO
->
œmbda_mf_Á˘‹
 = (
p_Vid
->
mb16x16_co°
 < 
CALM_MF_FACTOR_THRESHOLD
)

583 : 
	`sqπ
(
p_Vid
->
mb16x16_co°
 / (
CALM_MF_FACTOR_THRESHOLD
 *Ö_Vid->
œmbda_mf_Á˘‹
[
cuºSli˚
->
¶i˚_ty≥
][p_Vid->
qp
]));

585 
	}
}

587 
	$upd©e_œmbda_co°s
(
Ma¸oblock
 *
cuºMB
, 
RD_PARAMS
 *
íc_mb
, 
œmbda_mf
[3])

589 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

590 
RDOPTSåu˘uª
 *
p_RDO
 = 
cuºMB
->
p_Sli˚
->p_RDO;

592 
MEPos
;

593 
MEPos
 = 0; MEPos < 3; MEPos ++)

595 
œmbda_mf
[
MEPos
] = 
p_I≈
->
CtxAd±LagøngeMu…
 =0 ? 
íc_mb
->œmbda_mf[MEPos] : ()”nc_mb->œmbda_mf[MEPos] * 
	`sqπ
(
p_RDO
->
œmbda_mf_Á˘‹
));

597 
	}
}

605 
	$imö¨øy
 ( 
¨r
[], 
size
, *
mööd
 )

607 
i
;

608 
möˇnd
 = 
¨r
[0];

609 *
mööd
 = 0;

610  
i
 = 1; i < 
size
; i++ )

612 i‡(
¨r
[
i
] < 
möˇnd
)

614 
möˇnd
 = 
¨r
[
i
];

615 *
mööd
 = 
i
;

618  
möˇnd
;

619 
	}
}

621 
di°blk
 
	$di°blkmö¨øy
 ( 
di°blk
 
¨r
[], 
size
, *
mööd
 )

623 
i
;

624 
di°blk
 
möˇnd
 = 
¨r
[0];

625 *
mööd
 = 0;

626  
i
 = 1; i < 
size
; i++ )

628 i‡(
¨r
[
i
] < 
möˇnd
)

630 
möˇnd
 = 
¨r
[
i
];

631 *
mööd
 = 
i
;

634  
möˇnd
;

635 
	}
}

643 
	$is_bùªd_íabÀd
(
VideoP¨amëîs
 *
p_Vid
, 
mode
)

645  
p_Vid
->
bùªd_íabÀd
[(
mode
 =
P8x8
) ? 4: mode];

646 
	}
}

654 
	$å™sf‹m_ãrmö©i⁄_c⁄åﬁ
(
Ma¸oblock
* 
cuºMB
, 
mode
)

656 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

657 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

658 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

664 i‡(
p_I≈
->
Tønsf‹m8x8Mode
 == 1)

667 i‡(
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 =
FALSE
 &&

668 ((
mode
 >1 && modê<3Ë|| ((
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
Ë&& modê=0 && 
p_Vid
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
Ë|| (modê=
P8x8
)))

673 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
TRUE
;

678 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
FALSE
;

686 
	}
}

694 
	$b¶i˚_16x16_ãrmö©i⁄_c⁄åﬁ
(
I≈utP¨amëîs
 *
p_I≈
, 
Block8x8Info
 *
b8x8öfo
, *
˘r16x16
, 
mode
, 
b¶i˚
)

696 
œ°check
 = 1;

698 i‡(
mode
 =1 && 
b¶i˚
)

700 
pdú
 = 0;

701 
i
;

702 
bùªd_me
 = 0;

704 *
˘r16x16
)

707 
pdú
 = 0;

708 
œ°check
 = 0;

711 
pdú
 = 1;

712 
œ°check
 = 0;

715 
pdú
 = 2;

716 i‡(
p_I≈
->
BiPªdMŸi⁄E°im©i⁄
)

718 
œ°check
 = 0;

722 
pdú
 = 2;

723 
bùªd_me
 = 1;

724 
œ°check
 = 0;

727 
pdú
 = 2;

728 
bùªd_me
 = 2;

731 
	`îr‹
("invalid 'ctr16x16' value", -1);

734 
i
 = 0; i< 4; i++)

736 
b8x8öfo
->
be°
[1][
i
].
bùªd
 = 
bùªd_me
;

737 
b8x8öfo
->
be°
[1][
i
].
pdú
 =Ödir;

739 (*
˘r16x16
)++;

741  
œ°check
;

742 
	}
}

750 
	$gë_bùªd_co°
(
Ma¸oblock
 *
cuºMB
, 
mode
, 
block
, 
i
, 
j
, 
Info8x8
 *
be°
, 
RD_PARAMS
 *
íc_mb
, 
di°blk
 
bmco°
[5])

752 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

753 
MŸi⁄Ve˘‹
 *
bi0_mv_l0
 = &
cuºSli˚
->
bùªd_mv
[0][
LIST_0
][0][
mode
][
j
][
i
];

754 
MŸi⁄Ve˘‹
 *
bi0_mv_l1
 = &
cuºSli˚
->
bùªd_mv
[0][
LIST_1
][0][
mode
][
j
][
i
];

755 
MŸi⁄Ve˘‹
 *
bi1_mv_l0
 = &
cuºSli˚
->
bùªd_mv
[1][
LIST_0
][0][
mode
][
j
][
i
];

756 
MŸi⁄Ve˘‹
 *
bi1_mv_l1
 = &
cuºSli˚
->
bùªd_mv
[1][
LIST_1
][0][
mode
][
j
][
i
];

757 
di°blk
 
MaxVÆ
 = 
DISTBLK_MAX
;

758 i‡(
be°
->
ªf
[0] == 0 && best->ref[1] == 0)

760 
MŸi⁄Ve˘‹
 *
sögÀ_mv_l0
 = &
cuºSli˚
->
Æl_mv
 [
LIST_0
][0][
mode
][
j
][
i
];

761 
MŸi⁄Ve˘‹
 *
sögÀ_mv_l1
 = &
cuºSli˚
->
Æl_mv
 [
LIST_1
][0][
mode
][
j
][
i
];

763 i‡((
sögÀ_mv_l0
->
mv_x
 !
bi0_mv_l0
->mv_xË|| (sögÀ_mv_l0->
mv_y
 != bi0_mv_l0->mv_y) ||

764 (
sögÀ_mv_l1
->
mv_x
 !
bi0_mv_l1
->mv_xË|| (sögÀ_mv_l1->
mv_y
 != bi0_mv_l1->mv_y))

765 
	`li°_¥edi˘i⁄_co°
(
cuºMB
, 
BI_PRED_L0
, 
block
, 
mode
, 
íc_mb
, 
bmco°
, 0);

767 
bmco°
[
BI_PRED_L0
] = 
MaxVÆ
;

769 i‡((
sögÀ_mv_l0
->
mv_x
 !
bi1_mv_l0
->mv_xË|| (sögÀ_mv_l0->
mv_y
 != bi1_mv_l0->mv_y) ||

770 (
sögÀ_mv_l1
->
mv_x
 !
bi1_mv_l1
->mv_xË|| (sögÀ_mv_l1->
mv_y
 != bi1_mv_l1->mv_y))

772 i‡((
bi0_mv_l0
->
mv_x
 !
bi1_mv_l0
->mv_xË|| (bi0_mv_l0->
mv_y
 != bi1_mv_l0->mv_y) ||

773 (
bi0_mv_l1
->
mv_x
 !
bi1_mv_l1
->mv_xË|| (bi0_mv_l1->
mv_y
 != bi1_mv_l1->mv_y))

774 
	`li°_¥edi˘i⁄_co°
(
cuºMB
, 
BI_PRED_L1
, 
block
, 
mode
, 
íc_mb
, 
bmco°
, 0);

776 
bmco°
[
BI_PRED_L1
] = 
MaxVÆ
;

779 
bmco°
[
BI_PRED_L1
] = 
MaxVÆ
;

783 
	`li°_¥edi˘i⁄_co°
(
cuºMB
, 
BI_PRED_L0
, 
block
, 
mode
, 
íc_mb
, 
bmco°
, 0);

784 i‡((
bi0_mv_l0
->
mv_x
 !
bi1_mv_l0
->mv_xË|| (bi0_mv_l0->
mv_y
 != bi1_mv_l0->mv_y) ||

785 (
bi0_mv_l1
->
mv_x
 !
bi1_mv_l1
->mv_xË|| (bi0_mv_l1->
mv_y
 != bi1_mv_l1->mv_y))

786 
	`li°_¥edi˘i⁄_co°
(
cuºMB
, 
BI_PRED_L1
, 
block
, 
mode
, 
íc_mb
, 
bmco°
, 0);

788 
bmco°
[
BI_PRED_L1
] = 
MaxVÆ
;

790 
	}
}

	@lencod/src/mode_decision_P8x8.c

12 
	~<m©h.h
>

13 
	~<limôs.h
>

14 
	~<Êﬂt.h
>

16 
	~"globÆ.h
"

17 
	~"image.h
"

18 
	~"mode_decisi⁄.h
"

19 
	~"ma¸oblock.h
"

20 
	~"îrdo.h
"

21 
	~"q_¨ound.h
"

22 
	~"md_comm⁄.h
"

23 
	~"rd›t.h
"

26 
	$c›y_∑π_öfo
(
Info8x8
 *
b8x8
, Info8x8 *
∑π
)

28 
b8x8
[0] = 
∑π
[0];

29 
b8x8
[1] = 
∑π
[1];

30 
b8x8
[2] = 
∑π
[2];

31 
b8x8
[3] = 
∑π
[3];

32 
	}
}

40 
	$subma¸oblock_mode_decisi⁄_p_¶i˚
(
Ma¸oblock
 *
cuºMB
,

41 
RD_PARAMS
 *
íc_mb
,

42 
RD_8x8DATA
 *
d©aTr
,

43 ****
cofACå
,

44 
block
,

45 
di°blk
 *
co°
)

47 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

48 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

49 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

50 
PicMŸi⁄P¨ams
 **
mŸi⁄
 = 
p_Vid
->
íc_pi˘uª
->
mv_öfo
;

51 
å™sf‹m8x8
 = 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
;

52 
öt64
 
cuº_cbp_blk
;

53 
j
, 
k
;

54 
ödex
;

55 
mode
;

56 
di°blk
 
mö_rdco°
, 
rdco°
 = 0;

57 
di°blk
 
mö_co°8x8
;

58 
di°blk
 
bmco°
[5] = {
DISTBLK_MAX
};

59 
˙t_n⁄z
 = 0;

60 
be°_˙t_n⁄z
 = 0;

61 
maxödex
 = (
å™sf‹m8x8
) ? 2 : 5;

62 
block_x
, 
block_y
;

63 
œmbda_mf
[3];

65 ****
Ádju°
 = 
å™sf‹m8x8
? 
p_Vid
->
ARCofAdj8x8
 :Ö_Vid->
ARCofAdj4x4
;

68 
j0
 = ((
block
>>1)<<3);

69 
j1
 = (
j0
>>2);

70 
i0
 = ((
block
&0x01)<<3);

71 
i1
 = (
i0
>>2);

73 
Boﬁón
 
vÆid_8x8
 = 
FALSE
;

74 
Boﬁón
 
°‹ed_°©e_8x8
 = 
FALSE
;

76 #ifde‡
BEST_NZ_COEFF


77 
be°_nz_c€ff
[2][2];

80 
Info8x8
 *
∑πôi⁄
 = &(
d©aTr
->
∑π
[
block
]);

81 
Info8x8
 
be°
 = 
	`öô_öfo_8x8_°ru˘
();

83 *
∑πôi⁄
 = 
be°
;

84 i‡(
å™sf‹m8x8
)

85 
cuºMB
->
vÆid_8x8
 = 
FALSE
;

87 
cuºMB
->
vÆid_4x4
 = 
FALSE
;

89 #ifde‡
BEST_NZ_COEFF


90 
j
 = 0; j <= 1; j++)

92 
i
 = 0; i <= 1; i++)

93 
be°_nz_c€ff
[
i
][
j
] = 
p_Vid
->
nz_c€ff
[
cuºMB
->
mbAddrX
][
i1
 + i][
j1
 + j] = 0;

97 if(
p_I≈
->
subMBCodögSèã
 == 2)

98 
cuºSli˚
->
	`°‹e_codög_°©e
(
cuºMB
, cuºSli˚->
p_RDO
->
cs_tmp
);

101 
mö_co°8x8
 = 
DISTBLK_MAX
, 
mö_rdco°
 = DISTBLK_MAX, 
ödex
 = 1; index < 
maxödex
; index++)

104 
mode
 = 
b8_mode_èbÀ
[
ödex
];

106 
be°
.
mode
 = () mode;

107 *
co°
 = 0;

109 i‡(
íc_mb
->
vÆid
[
mode
] && (!(
å™sf‹m8x8
 == 1 && mode > 4)) && (transform8x8 == 0 || mode != 0 ))

111 i‡(
å™sf‹m8x8
)

113 
cuºMB
->
vÆid_8x8
 = 
TRUE
;

116 
cuºMB
->
vÆid_4x4
 = 
TRUE
;

117 
vÆid_8x8
 = 
TRUE
;

118 
cuº_cbp_blk
 = 0;

121 
b_ªf
;

125 
	`mem˝y
(
œmbda_mf
, 
íc_mb
->lambda_mf, 3 * ());

127 i‡(
p_I≈
->
CtxAd±LagøngeMu…
 == 1)

129 
RDOPTSåu˘uª
 *
p_RDO
 = 
cuºSli˚
->p_RDO;

130 
œmbda_mf
[
F_PEL
] = ()÷ambda_mf[F_PEL] * 
p_RDO
->
œmbda_mf_Á˘‹
);

131 
œmbda_mf
[
H_PEL
] = ()÷ambda_mf[H_PEL] * 
p_RDO
->
œmbda_mf_Á˘‹
);

132 
œmbda_mf
[
Q_PEL
] = ()÷ambda_mf[Q_PEL] * 
p_RDO
->
œmbda_mf_Á˘‹
);

135 
	`SubP¨tôi⁄MŸi⁄Sórch
 (
cuºMB
, 
mode
, 
block
, 
œmbda_mf
);

138 
bmco°
[
LIST_0
] = 
DISTBLK_MAX
;

139 
	`li°_¥edi˘i⁄_co°
(
cuºMB
, 
LIST_0
, 
block
, 
mode
, 
íc_mb
, 
bmco°
, 
be°
.
ªf
);

142 
block_x
 = 
cuºMB
->block_x + (
block
 & 0x01)*2;

143 
block_y
 = 
cuºMB
->block_y + (
block
 & 0x02);

144 
b_ªf
 = 
be°
.
ªf
[
LIST_0
];

146 
mŸi⁄
[
block_y
 ][
block_x
 ].
ªf_pic
 [
LIST_0
] = 
cuºSli˚
->
li°X
[
cuºMB
->
li°_off£t
][
b_ªf
];

147 
mŸi⁄
[
block_y
 ][
block_x
 ].
mv
 [
LIST_0
] = 
cuºSli˚
->
Æl_mv
[LIST_0][
b_ªf
][
mode
][
j1
 ][
i1
 ];

148 
mŸi⁄
[
block_y
 ][
block_x
 ].
ªf_idx
 [
LIST_0
] = (Ë
b_ªf
;

149 
mŸi⁄
[
block_y
 ][
block_x
 + 1].
ªf_pic
 [
LIST_0
] = 
cuºSli˚
->
li°X
[
cuºMB
->
li°_off£t
][
b_ªf
];

150 
mŸi⁄
[
block_y
 ][
block_x
 + 1].
mv
 [
LIST_0
] = 
cuºSli˚
->
Æl_mv
[LIST_0][
b_ªf
][
mode
][
j1
 ][
i1
 + 1];

151 
mŸi⁄
[
block_y
 ][
block_x
 + 1].
ªf_idx
 [
LIST_0
] = (Ë
b_ªf
;

152 
mŸi⁄
[
block_y
 + 1][
block_x
 ].
ªf_pic
 [
LIST_0
] = 
cuºSli˚
->
li°X
[
cuºMB
->
li°_off£t
][
b_ªf
];

153 
mŸi⁄
[
block_y
 + 1][
block_x
 ].
mv
 [
LIST_0
] = 
cuºSli˚
->
Æl_mv
[LIST_0][
b_ªf
][
mode
][
j1
 + 1][
i1
 ];

154 
mŸi⁄
[
block_y
 + 1][
block_x
 ].
ªf_idx
 [
LIST_0
] = (Ë
b_ªf
;

155 
mŸi⁄
[
block_y
 + 1][
block_x
 + 1].
ªf_pic
 [
LIST_0
] = 
cuºSli˚
->
li°X
[
cuºMB
->
li°_off£t
][
b_ªf
];

156 
mŸi⁄
[
block_y
 + 1][
block_x
 + 1].
mv
 [
LIST_0
] = 
cuºSli˚
->
Æl_mv
[LIST_0][
b_ªf
][
mode
][
j1
 + 1][
i1
 + 1];

157 
mŸi⁄
[
block_y
 + 1][
block_x
 + 1].
ªf_idx
 [
LIST_0
] = (Ë
b_ªf
;

159 
be°
.
pdú
 = 0;

160 *
co°
 = 
bmco°
[
LIST_0
];

164 
rdco°
 = 
	`rdco°_f‹_8x8blocks
 (
cuºMB
, 
d©aTr
, &
˙t_n⁄z
, &
cuº_cbp_blk
, 
íc_mb
->
œmbda_mdÂ
, 
block
, (Ë
mode
, &
be°
, 
mö_rdco°
);

167 i‡(
rdco°
 < 
mö_rdco°
)

169 
mö_co°8x8
 = *
co°
;

170 
mö_rdco°
 = 
rdco°
;

171 *
∑πôi⁄
 = 
be°
;

172 
∑πôi⁄
->
mode
 = () mode;

173 
cuºMB
->
b8x8
[
block
].
mode
 = () mode;

175 #ifde‡
BEST_NZ_COEFF


176 i‡(
˙t_n⁄z
)

178 
i
 = 0; i <= 1; i++)

180 
be°_nz_c€ff
[
i
][0]
p_Vid
->
nz_c€ff
[
cuºMB
->
mbAddrX
][
i1
 + i][
j1
 ];

181 
be°_nz_c€ff
[
i
][1]
p_Vid
->
nz_c€ff
[
cuºMB
->
mbAddrX
][
i1
 + i][
j1
 + 1];

186 
i
 = 0; i <= 1; i++)

188 
be°_nz_c€ff
[
i
][0]= 0;

189 
be°_nz_c€ff
[
i
][1]= 0;

195 
be°_˙t_n⁄z
 = 
˙t_n⁄z
;

198 
d©aTr
->
cbp_blk8x8
 &(~(0x33 << (((
block
>>1)<<3)+((block & 0x01)<<1))));

199 
d©aTr
->
cbp_blk8x8
 |
cuº_cbp_blk
;

202 
	`mem˝y
(&
cofACå
[0][0][0][0],&
cuºSli˚
->
cofAC
[
block
][0][0][0], 4 * 2 * 65 * ());

204 if–
cuºSli˚
->
P444_joöed
 )

207 
	`mem˝y
(&
cofACå
[1][0][0][0],&
cuºSli˚
->
cofAC
[
block
 + 4][0][0][0], 4 * 2 * 65 * ());

208 
	`mem˝y
(&
cofACå
[2][0][0][0],&
cuºSli˚
->
cofAC
[
block
 + 8][0][0][0], 4 * 2 * 65 * ());

212 
	`c›y_image_d©a_8x8
(&
d©aTr
->
ªc_mbY8x8
[
j0
], &
p_Vid
->
íc_pi˘uª
->
imgY
[
cuºMB
->
pix_y
 + j0], 
i0
, cuºMB->
pix_x
 + i0);

213 
	`c›y_image_d©a_8x8
(&
d©aTr
->
m¥8x8
[
j0
], &
cuºSli˚
->
mb_¥ed
[0][j0], 
i0
, i0);

215 i‡(
p_I≈
->
rd›t
 == 3)

217 
	`îrdo_°‹e_be°_b8x8
(
cuºMB
, 
å™sf‹m8x8
, 
block
);

220 if(
cuºSli˚
->
¶i˚_ty≥
 =
SP_SLICE
)

222 
j
 = 
j0
; j < j0 + 
BLOCK_SIZE_8x8
; j++)

224 
	`mem˝y
(&
d©aTr
->
Ãec
[
j
][
i0
],&
p_Vid
->Ãec[
cuºMB
->
pix_y
 + j][cuºMB->
pix_x
 + i0], 
BLOCK_SIZE_8x8
 * ());

228 if(
cuºSli˚
->
P444_joöed
)

230 
	`c›y_image_d©a_8x8
(&
d©aTr
->
ªc_mb8x8_¸
[0][
j0
], &
p_Vid
->
íc_pi˘uª
->
imgUV
[0][
cuºMB
->
pix_y
 + j0], 
i0
, cuºMB->
pix_x
 + i0);

231 
	`c›y_image_d©a_8x8
(&
d©aTr
->
m¥8x8CbCr
[0][
j0
], &
cuºSli˚
->
mb_¥ed
[1][j0], 
i0
, i0);

233 
	`c›y_image_d©a_8x8
(&
d©aTr
->
ªc_mb8x8_¸
[1][
j0
], &
p_Vid
->
íc_pi˘uª
->
imgUV
[1][
cuºMB
->
pix_y
 + j0], 
i0
, cuºMB->
pix_x
 + i0);

234 
	`c›y_image_d©a_8x8
(&
d©aTr
->
m¥8x8CbCr
[1][
j0
], &
cuºSli˚
->
mb_¥ed
[2][j0], 
i0
, i0);

238 i‡(
block
 < 3)

240 
cuºSli˚
->
	`°‹e_codög_°©e
 (
cuºMB
, cuºSli˚->
p_RDO
->
cs_b8
);

241 
°‹ed_°©e_8x8
 = 
TRUE
;

246 i‡(
ödex
 !
maxödex
 - 1)

248 if(
p_I≈
->
subMBCodögSèã
 == 1)

249 
cuºSli˚
->
	`ª£t_codög_°©e
 (
cuºMB
, cuºSli˚->
p_RDO
->
cs_cm
);

250 if(
p_I≈
->
subMBCodögSèã
 == 2)

251 
cuºSli˚
->
	`ª£t_codög_°©e
 (
cuºMB
, cuºSli˚->
p_RDO
->
cs_tmp
);

256 i‡(
vÆid_8x8
 =
TRUE
)

258 #ifde‡
BEST_NZ_COEFF


259 
i
 = 0; i <= 1; i++)

261 
j
 = 0; j <= 1; j++)

262 
p_Vid
->
nz_c€ff
[
cuºMB
->
mbAddrX
][
i1
 + 
i
][
j1
 + 
j
] = 
be°_nz_c€ff
[i][j];

266 i‡(!
å™sf‹m8x8
)

268 i‡(
mö_co°8x8
 !
DISTBLK_MAX
)

269 
d©aTr
->
mb_p8x8_co°
 +
mö_co°8x8
;

271 
d©aTr
->
mb_p8x8_co°
 = 
DISTBLK_MAX
;

275 i‡(
be°_˙t_n⁄z
)

277 
d©aTr
->
cbp8x8
 |(1 << 
block
);

278 
d©aTr
->
˙t_n⁄z_8x8
 +
be°_˙t_n⁄z
;

281 i‡(!
å™sf‹m8x8
)

283 i‡(
block
 < 3)

286 
j0
 = 8*(
block
 >> 1);

287 
i0
 = 8*(
block
 & 0x01);

290 
	`c›y_image_d©a_8x8
(&
p_Vid
->
íc_pi˘uª
->
imgY
[
cuºMB
->
pix_y
 + 
j0
], &
d©aTr
->
ªc_mbY8x8
[j0], cuºMB->
pix_x
 + 
i0
, i0);

292 i‡(
p_I≈
->
rd›t
 == 3)

294 
	`îrdo_gë_be°_b8x8
(
cuºMB
, 
å™sf‹m8x8
, 
block
);

297 if(
cuºSli˚
->
¶i˚_ty≥
 =
SP_SLICE
)

299 
j
 = 
j0
; j < j0 + 
BLOCK_SIZE_8x8
; j++)

301 
	`mem˝y
(&
p_Vid
->
Ãec
[
cuºMB
->
pix_y
 + 
j
][cuºMB->
pix_x
], 
d©aTr
->Ãec[j], 2 * 
BLOCK_SIZE
 * ());

305 if(
cuºSli˚
->
P444_joöed
)

308 
k
=0; k<2; k++)

310 
	`c›y_image_d©a_8x8
(&
p_Vid
->
íc_pi˘uª
->
imgUV
[
k
][
cuºMB
->
pix_y
 + 
j0
], &
d©aTr
->
ªc_mb8x8_¸
[k][j0], cuºMB->
pix_x
 + 
i0
, i0);

318 
cuºSli˚
->
	`°‹e_8x8_mŸi⁄_ve˘‹s
(cuºSli˚, 0, 
block
, 
∑πôi⁄
);

322 
cuºSli˚
->
	`£t_ªf_™d_mŸi⁄_ve˘‹s
 (
cuºMB
, 
mŸi⁄
, 
∑πôi⁄
, 
block
);

326 i‡(
°‹ed_°©e_8x8
 =
TRUE
)

327 
cuºSli˚
->
	`ª£t_codög_°©e
 (
cuºMB
, cuºSli˚->
p_RDO
->
cs_b8
);

330 
cuºSli˚
->
	`ª£t_codög_°©e
 (
cuºMB
, cuºSli˚->
p_RDO
->
cs_cm
);

331 
	`upd©e_ad≠tive_roundög_8x8
(
p_Vid
, 
p_I≈
, 
d©aTr
, 
Ádju°
);

334 
	}
}

342 
	$subma¸oblock_mode_decisi⁄_b_¶i˚
(
Ma¸oblock
 *
cuºMB
,

343 
RD_PARAMS
 *
íc_mb
,

344 
RD_8x8DATA
 *
d©aTr
,

345 ****
cofACå
,

346 
block
,

347 
di°blk
 *
co°
)

349 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

350 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

351 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

352 
PicMŸi⁄P¨ams
 **
mŸi⁄
 = 
p_Vid
->
íc_pi˘uª
->
mv_öfo
;

353 
å™sf‹m8x8
 = 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
;

354 
maxödex
 = (
å™sf‹m8x8
) ? 2 : 5;

355 
öt64
 
cuº_cbp_blk
;

356 
k
;

357 
ödex
;

358 
mode
;

359 
di°blk
 
mö_rdco°
, 
rdco°
 = 0;

360 
di°blk
 
mö_co°8x8
;

361 
di°blk
 
bmco°
[5] = {
DISTBLK_MAX
};

362 
˙t_n⁄z
 = 0;

363 
be°_˙t_n⁄z
 = 0;

364 
block_x
, 
block_y
;

365 
œmbda_mf
[3];

367 ****
Ádju°
 = 
å™sf‹m8x8
? 
p_Vid
->
ARCofAdj8x8
 :Ö_Vid->
ARCofAdj4x4
;

370 
j0
 = ((
block
>>1)<<3);

371 
j1
 = (
j0
>>2);

372 
i0
 = ((
block
&0x01)<<3);

373 
i1
 = (
i0
>>2);

375 
Boﬁón
 
vÆid_8x8
 = 
FALSE
;

376 
Boﬁón
 
°‹ed_°©e_8x8
 = 
FALSE
;

378 #ifde‡
BEST_NZ_COEFF


379 
be°_nz_c€ff
[2][2];

383 
Info8x8
 *
∑πôi⁄
 = &(
d©aTr
->
∑π
[
block
]);

384 
Info8x8
 
be°
 = 
	`öô_öfo_8x8_°ru˘
();

385 *
∑πôi⁄
 = 
be°
;

386 i‡(
å™sf‹m8x8
)

387 
cuºMB
->
vÆid_8x8
 = 
FALSE
;

389 
cuºMB
->
vÆid_4x4
 = 
FALSE
;

391 #ifde‡
BEST_NZ_COEFF


392 
j
 = 0; j <= 1; j++)

394 
i
 = 0; i <= 1; i++)

395 
be°_nz_c€ff
[
i
][
j
] = 
p_Vid
->
nz_c€ff
[
cuºMB
->
mbAddrX
][
i1
 + i][
j1
 + j] = 0;

399 if(
p_I≈
->
subMBCodögSèã
 == 2)

400 
cuºSli˚
->
	`°‹e_codög_°©e
(
cuºMB
, cuºSli˚->
p_RDO
->
cs_tmp
);

403 
mö_co°8x8
 = 
DISTBLK_MAX
, 
mö_rdco°
 = DISTBLK_MAX, 
ödex
 = 0; index < 
maxödex
; index++)

406 
mode
 = 
b8_mode_èbÀ
[
ödex
];

408 
be°
.
mode
 = () mode;

409 *
co°
 = 0;

411 i‡(
íc_mb
->
vÆid
[
mode
] && (!(
å™sf‹m8x8
 =1 && modê> 4)Ë&& (å™sf‹m8x8 =0 || modê!0 || (modê=0 && 
p_Vid
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
)))

413 i‡(
å™sf‹m8x8
)

415 
cuºMB
->
vÆid_8x8
 = 
TRUE
;

418 
cuºMB
->
vÆid_4x4
 = 
TRUE
;

420 
vÆid_8x8
 = 
TRUE
;

421 
cuº_cbp_blk
 = 0;

423 i‡(
mode
==0)

425 
block_x
 = 
cuºMB
->block_x + (
block
 & 0x01)*2;

426 
block_y
 = 
cuºMB
->block_y + (
block
 & 0x02);

427 
be°
.
ªf
[
LIST_0
] = 
cuºSli˚
->
dúe˘_ªf_idx
[
block_y
][
block_x
][LIST_0];

428 
be°
.
ªf
[
LIST_1
] = 
cuºSli˚
->
dúe˘_ªf_idx
[
block_y
][
block_x
][LIST_1];

429 
be°
.
pdú
 = 
cuºSli˚
->
dúe˘_pdú
[
block_y
][
block_x
];

433 
b_ªf
;

437 
	`mem˝y
(
œmbda_mf
, 
íc_mb
->lambda_mf, 3 * ());

439 i‡(
p_I≈
->
CtxAd±LagøngeMu…
 == 1)

441 
RDOPTSåu˘uª
 *
p_RDO
 = 
cuºSli˚
->p_RDO;

442 
œmbda_mf
[
F_PEL
] = ()÷ambda_mf[F_PEL] * 
p_RDO
->
œmbda_mf_Á˘‹
);

443 
œmbda_mf
[
H_PEL
] = ()÷ambda_mf[H_PEL] * 
p_RDO
->
œmbda_mf_Á˘‹
);

444 
œmbda_mf
[
Q_PEL
] = ()÷ambda_mf[Q_PEL] * 
p_RDO
->
œmbda_mf_Á˘‹
);

447 
	`SubP¨tôi⁄MŸi⁄Sórch
 (
cuºMB
, 
mode
, 
block
, 
œmbda_mf
);

450 
bmco°
[
LIST_0
] = 
DISTBLK_MAX
;

451 
	`li°_¥edi˘i⁄_co°
(
cuºMB
, 
LIST_0
, 
block
, 
mode
, 
íc_mb
, 
bmco°
, 
be°
.
ªf
);

454 
block_x
 = 
cuºMB
->block_x + (
block
 & 0x01)*2;

455 
block_y
 = 
cuºMB
->block_y + (
block
 & 0x02);

456 
b_ªf
 = 
be°
.
ªf
[
LIST_0
];

458 
mŸi⁄
[
block_y
 ][
block_x
 ].
ªf_pic
 [
LIST_0
] = 
cuºSli˚
->
li°X
[
cuºMB
->
li°_off£t
][
b_ªf
];

459 
mŸi⁄
[
block_y
 ][
block_x
 ].
mv
 [
LIST_0
] = 
cuºSli˚
->
Æl_mv
[LIST_0][
b_ªf
][
mode
][
j1
 ][
i1
 ];

460 
mŸi⁄
[
block_y
 ][
block_x
 ].
ªf_idx
 [
LIST_0
] = (Ë
b_ªf
;

461 
mŸi⁄
[
block_y
 ][
block_x
 + 1].
ªf_pic
 [
LIST_0
] = 
cuºSli˚
->
li°X
[
cuºMB
->
li°_off£t
][
b_ªf
];

462 
mŸi⁄
[
block_y
 ][
block_x
 + 1].
mv
 [
LIST_0
] = 
cuºSli˚
->
Æl_mv
[LIST_0][
b_ªf
][
mode
][
j1
 ][
i1
 + 1];

463 
mŸi⁄
[
block_y
 ][
block_x
 + 1].
ªf_idx
 [
LIST_0
] = (Ë
b_ªf
;

464 
mŸi⁄
[
block_y
 + 1][
block_x
 ].
ªf_pic
 [
LIST_0
] = 
cuºSli˚
->
li°X
[
cuºMB
->
li°_off£t
][
b_ªf
];

465 
mŸi⁄
[
block_y
 + 1][
block_x
 ].
mv
 [
LIST_0
] = 
cuºSli˚
->
Æl_mv
[LIST_0][
b_ªf
][
mode
][
j1
 + 1][
i1
 ];

466 
mŸi⁄
[
block_y
 + 1][
block_x
 ].
ªf_idx
 [
LIST_0
] = (Ë
b_ªf
;

467 
mŸi⁄
[
block_y
 + 1][
block_x
 + 1].
ªf_pic
 [
LIST_0
] = 
cuºSli˚
->
li°X
[
cuºMB
->
li°_off£t
][
b_ªf
];

468 
mŸi⁄
[
block_y
 + 1][
block_x
 + 1].
mv
 [
LIST_0
] = 
cuºSli˚
->
Æl_mv
[LIST_0][
b_ªf
][
mode
][
j1
 + 1][
i1
 + 1];

469 
mŸi⁄
[
block_y
 + 1][
block_x
 + 1].
ªf_idx
 [
LIST_0
] = (Ë
b_ªf
;

472 
bmco°
[
LIST_1
] = 
DISTBLK_MAX
;

473 
bmco°
[
BI_PRED
] = 
DISTBLK_MAX
;

474 
	`li°_¥edi˘i⁄_co°
(
cuºMB
, 
LIST_1
, 
block
, 
mode
, 
íc_mb
, 
bmco°
, 
be°
.
ªf
);

477 
	`li°_¥edi˘i⁄_co°
(
cuºMB
, 
BI_PRED
, 
block
, 
mode
, 
íc_mb
, 
bmco°
, 
be°
.
ªf
);

480 i‡(
	`is_bùªd_íabÀd
(
p_Vid
, 
mode
))

482 
	`gë_bùªd_co°
(
cuºMB
, 
mode
, 
block
, 
i1
, 
j1
, &
be°
, 
íc_mb
, 
bmco°
);

486 
bmco°
[
BI_PRED_L0
] = 
DISTBLK_MAX
;

487 
bmco°
[
BI_PRED_L1
] = 
DISTBLK_MAX
;

491 
	`dëîmöe_¥edi˘i⁄_li°
(
bmco°
, &
be°
, 
co°
);

494 
k
 = 
LIST_0
; k <
LIST_1
; k++)

496 
mŸi⁄
[
block_y
 ][
block_x
 ].
ªf_idx
[
k
] = 
be°
.
ªf
[k];

497 
mŸi⁄
[
block_y
 ][
block_x
 + 1].
ªf_idx
[
k
] = 
be°
.
ªf
[k];

498 
mŸi⁄
[
block_y
 + 1][
block_x
 ].
ªf_idx
[
k
] = 
be°
.
ªf
[k];

499 
mŸi⁄
[
block_y
 + 1][
block_x
 + 1].
ªf_idx
[
k
] = 
be°
.
ªf
[k];

501 i‡(
be°
.
bùªd
)

503 
mŸi⁄
[
block_y
 ][
block_x
 ].
mv
[
k
] = 
cuºSli˚
->
bùªd_mv
[
be°
.
bùªd
 - 1][k][(Ëbe°.
ªf
[k]][
mode
][
j1
 ][
i1
 ];

504 
mŸi⁄
[
block_y
 ][
block_x
 + 1].
mv
[
k
] = 
cuºSli˚
->
bùªd_mv
[
be°
.
bùªd
 - 1][k][(Ëbe°.
ªf
[k]][
mode
][
j1
 ][
i1
 + 1];

505 
mŸi⁄
[
block_y
 + 1][
block_x
 ].
mv
[
k
] = 
cuºSli˚
->
bùªd_mv
[
be°
.
bùªd
 - 1][k][(Ëbe°.
ªf
[k]][
mode
][
j1
 + 1][
i1
 ];

506 
mŸi⁄
[
block_y
 + 1][
block_x
 + 1].
mv
[
k
] = 
cuºSli˚
->
bùªd_mv
[
be°
.
bùªd
 - 1][k][(Ëbe°.
ªf
[k]][
mode
][
j1
 + 1][
i1
 + 1];

510 
mŸi⁄
[
block_y
 ][
block_x
 ].
mv
[
k
] = 
cuºSli˚
->
Æl_mv
[k][(Ë
be°
.
ªf
[k]][
mode
][
j1
 ][
i1
 ];

511 
mŸi⁄
[
block_y
 ][
block_x
 + 1].
mv
[
k
] = 
cuºSli˚
->
Æl_mv
[k][(Ë
be°
.
ªf
[k]][
mode
][
j1
 ][
i1
 + 1];

512 
mŸi⁄
[
block_y
 + 1][
block_x
 ].
mv
[
k
] = 
cuºSli˚
->
Æl_mv
[k][(Ë
be°
.
ªf
[k]][
mode
][
j1
 + 1][
i1
 ];

513 
mŸi⁄
[
block_y
 + 1][
block_x
 + 1].
mv
[
k
] = 
cuºSli˚
->
Æl_mv
[k][(Ë
be°
.
ªf
[k]][
mode
][
j1
 + 1][
i1
 + 1];

519 
rdco°
 = 
	`rdco°_f‹_8x8blocks
 (
cuºMB
, 
d©aTr
, &
˙t_n⁄z
, &
cuº_cbp_blk
, 
íc_mb
->
œmbda_mdÂ
, 
block
, (Ë
mode
, &
be°
, 
mö_rdco°
);

522 i‡(
rdco°
 < 
mö_rdco°
)

524 
mö_co°8x8
 = *
co°
;

525 
mö_rdco°
 = 
rdco°
;

526 *
∑πôi⁄
 = 
be°
;

527 
∑πôi⁄
->
mode
 = () mode;

528 
cuºMB
->
b8x8
[
block
].
mode
 = () mode;

530 #ifde‡
BEST_NZ_COEFF


531 i‡(
˙t_n⁄z
)

533 
i
 = 0; i <= 1; i++)

535 
be°_nz_c€ff
[
i
][0]
p_Vid
->
nz_c€ff
[
cuºMB
->
mbAddrX
][
i1
 + i][
j1
 ];

536 
be°_nz_c€ff
[
i
][1]
p_Vid
->
nz_c€ff
[
cuºMB
->
mbAddrX
][
i1
 + i][
j1
 + 1];

541 
i
 = 0; i <= 1; i++)

543 
be°_nz_c€ff
[
i
][0]= 0;

544 
be°_nz_c€ff
[
i
][1]= 0;

550 
be°_˙t_n⁄z
 = 
˙t_n⁄z
;

553 
d©aTr
->
cbp_blk8x8
 &(~(0x33 << (((
block
>>1)<<3)+((block & 0x01)<<1))));

554 
d©aTr
->
cbp_blk8x8
 |
cuº_cbp_blk
;

557 
	`mem˝y
(&
cofACå
[0][0][0][0],&
cuºSli˚
->
cofAC
[
block
][0][0][0], 4 * 2 * 65 * ());

559 if–
cuºSli˚
->
P444_joöed
 )

562 
	`mem˝y
(&
cofACå
[1][0][0][0],&
cuºSli˚
->
cofAC
[
block
 + 4][0][0][0], 4 * 2 * 65 * ());

563 
	`mem˝y
(&
cofACå
[2][0][0][0],&
cuºSli˚
->
cofAC
[
block
 + 8][0][0][0], 4 * 2 * 65 * ());

567 
	`c›y_image_d©a_8x8
(&
d©aTr
->
ªc_mbY8x8
[
j0
], &
p_Vid
->
íc_pi˘uª
->
imgY
[
cuºMB
->
pix_y
 + j0], 
i0
, cuºMB->
pix_x
 + i0);

568 
	`c›y_image_d©a_8x8
(&
d©aTr
->
m¥8x8
[
j0
], &
cuºSli˚
->
mb_¥ed
[0][j0], 
i0
, i0);

570 i‡(
p_I≈
->
rd›t
 == 3)

572 
	`îrdo_°‹e_be°_b8x8
(
cuºMB
, 
å™sf‹m8x8
, 
block
);

575 if(
cuºSli˚
->
P444_joöed
)

577 
	`c›y_image_d©a_8x8
(&
d©aTr
->
ªc_mb8x8_¸
[0][
j0
], &
p_Vid
->
íc_pi˘uª
->
imgUV
[0][
cuºMB
->
pix_y
 + j0], 
i0
, cuºMB->
pix_x
 + i0);

578 
	`c›y_image_d©a_8x8
(&
d©aTr
->
m¥8x8CbCr
[0][
j0
], &
cuºSli˚
->
mb_¥ed
[1][j0], 
i0
, i0);

580 
	`c›y_image_d©a_8x8
(&
d©aTr
->
ªc_mb8x8_¸
[1][
j0
], &
p_Vid
->
íc_pi˘uª
->
imgUV
[1][
cuºMB
->
pix_y
 + j0], 
i0
, cuºMB->
pix_x
 + i0);

581 
	`c›y_image_d©a_8x8
(&
d©aTr
->
m¥8x8CbCr
[1][
j0
], &
cuºSli˚
->
mb_¥ed
[2][j0], 
i0
, i0);

585 i‡(
block
 < 3)

587 
cuºSli˚
->
	`°‹e_codög_°©e
 (
cuºMB
, cuºSli˚->
p_RDO
->
cs_b8
);

588 
°‹ed_°©e_8x8
 = 
TRUE
;

593 i‡(
ödex
 !
maxödex
 - 1)

595 if(
p_I≈
->
subMBCodögSèã
 == 1)

596 
cuºSli˚
->
	`ª£t_codög_°©e
 (
cuºMB
, cuºSli˚->
p_RDO
->
cs_cm
);

597 if(
p_I≈
->
subMBCodögSèã
 == 2)

598 
cuºSli˚
->
	`ª£t_codög_°©e
 (
cuºMB
, cuºSli˚->
p_RDO
->
cs_tmp
);

603 i‡(
vÆid_8x8
 =
TRUE
)

605 #ifde‡
BEST_NZ_COEFF


606 
i
 = 0; i <= 1; i++)

608 
j
 = 0; j <= 1; j++)

609 
p_Vid
->
nz_c€ff
[
cuºMB
->
mbAddrX
][
i1
 + 
i
][
j1
 + 
j
] = 
be°_nz_c€ff
[i][j];

613 i‡(!
å™sf‹m8x8
)

615 i‡(
mö_co°8x8
 !
DISTBLK_MAX
)

616 
d©aTr
->
mb_p8x8_co°
 +
mö_co°8x8
;

618 
d©aTr
->
mb_p8x8_co°
 = 
DISTBLK_MAX
;

622 i‡(
be°_˙t_n⁄z
)

624 
d©aTr
->
cbp8x8
 |(1 << 
block
);

625 
d©aTr
->
˙t_n⁄z_8x8
 +
be°_˙t_n⁄z
;

628 i‡(!
å™sf‹m8x8
)

630 i‡(
block
 < 3)

633 
j0
 = 8*(
block
 >> 1);

634 
i0
 = 8*(
block
 & 0x01);

637 
	`c›y_image_d©a_8x8
(&
p_Vid
->
íc_pi˘uª
->
imgY
[
cuºMB
->
pix_y
 + 
j0
], &
d©aTr
->
ªc_mbY8x8
[j0], cuºMB->
pix_x
 + 
i0
, i0);

639 i‡(
p_I≈
->
rd›t
 == 3)

641 
	`îrdo_gë_be°_b8x8
(
cuºMB
, 
å™sf‹m8x8
, 
block
);

644 if(
cuºSli˚
->
P444_joöed
)

647 
k
=0; k<2; k++)

649 
	`c›y_image_d©a_8x8
(&
p_Vid
->
íc_pi˘uª
->
imgUV
[
k
][
cuºMB
->
pix_y
 + 
j0
], &
d©aTr
->
ªc_mb8x8_¸
[k][j0], cuºMB->
pix_x
 + 
i0
, i0);

657 
cuºSli˚
->
	`°‹e_8x8_mŸi⁄_ve˘‹s
(cuºSli˚, 0, 
block
, 
∑πôi⁄
);

661 
cuºSli˚
->
	`£t_ªf_™d_mŸi⁄_ve˘‹s
 (
cuºMB
, 
mŸi⁄
, 
∑πôi⁄
, 
block
);

665 i‡(
°‹ed_°©e_8x8
 =
TRUE
)

666 
cuºSli˚
->
	`ª£t_codög_°©e
 (
cuºMB
, cuºSli˚->
p_RDO
->
cs_b8
);

669 
cuºSli˚
->
	`ª£t_codög_°©e
 (
cuºMB
, cuºSli˚->
p_RDO
->
cs_cm
);

670 
	`upd©e_ad≠tive_roundög_8x8
(
p_Vid
, 
p_I≈
, 
d©aTr
, 
Ádju°
);

673 
	}
}

681 
	$subma¸oblock_mode_decisi⁄_low
(
Ma¸oblock
 *
cuºMB
,

682 
RD_PARAMS
 *
íc_mb
,

683 
RD_8x8DATA
 *
d©aTr
,

684 ****
cofACå
,

685 *
have_dúe˘
,

686 
block
,

687 
di°blk
 *
co°_dúe˘
,

688 
di°blk
 *
co°
,

689 
di°blk
 *
co°8x8_dúe˘
,

690 
å™sf‹m8x8
)

692 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

693 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

694 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

695 
PicMŸi⁄P¨ams
 **
mŸi⁄
 = 
p_Vid
->
íc_pi˘uª
->
mv_öfo
;

697 
öt64
 
cuº_cbp_blk
;

699 
j0
, 
i0
;

700 
i
, 
j
;

701 
ödex
;

702 
mode
;

703 
di°blk
 
mö_co°8x8
;

704 
di°blk
 
dúe˘4x4_tmp
, 
dúe˘8x8_tmp
;

705 
di°blk
 
bmco°
[5] = {
DISTBLK_MAX
};

706 
˙t_n⁄z
 = 0;

707 
dummy
;

708 
be°_˙t_n⁄z
 = 0;

709 
maxödex
 = (
å™sf‹m8x8
) ? 2 : 5;

710 
block_x
, 
block_y
;

711 
œmbda_mf
[3];

713 ****
Ádju°
 = 
å™sf‹m8x8
? 
p_Vid
->
ARCofAdj8x8
 :Ö_Vid->
ARCofAdj4x4
;

714 
pdú
;

716 
Boﬁón
 
vÆid_8x8
 = 
FALSE
;

717 
Boﬁón
 
°‹ed_°©e_8x8
 = 
FALSE
;

719 #ifde‡
BEST_NZ_COEFF


720 
j1
, 
i1
;

721 
be°_nz_c€ff
[2][2];

724 
Info8x8
 
be°
 = 
	`öô_öfo_8x8_°ru˘
();

725 
d©aTr
->
∑π
[
block
].
mode
 = 0;

726 i‡(
å™sf‹m8x8
)

727 
cuºMB
->
vÆid_8x8
 = 
FALSE
;

729 
cuºMB
->
vÆid_4x4
 = 
FALSE
;

732 
j0
 = ((
block
>>1)<<3);

733 
i0
 = ((
block
&0x01)<<3);

735 #ifde‡
BEST_NZ_COEFF


736 
j1
 = (
j0
>>2);

737 
i1
 = (
i0
>>2);

738 
j
 = 0; j <= 1; j++)

740 
i
 = 0; i <= 1; i++)

741 
be°_nz_c€ff
[
i
][
j
] = 
p_Vid
->
nz_c€ff
[
cuºMB
->
mbAddrX
][
i1
 + i][
j1
 + j] = 0;

745 i‡(
å™sf‹m8x8
)

746 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
TRUE
;

749 
cuºSli˚
->
	`°‹e_codög_°©e
 (
cuºMB
, cuºSli˚->
p_RDO
->
cs_cm
);

752 
mö_co°8x8
 = 
DISTBLK_MAX
, 
ödex
 = (
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
 ? 0 : 1); index < 
maxödex
; index++)

754 
mode
 = 
b8_mode_èbÀ
[
ödex
];

755 
be°
.
mode
 = () mode;

756 *
co°
 = 0;

758 i‡(
íc_mb
->
vÆid
[
mode
] && (!(
å™sf‹m8x8
 =1 && modê> 4)Ë&& (å™sf‹m8x8 =0 || modê!0 || (modê=0 && 
p_Vid
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
)))

760 i‡(
å™sf‹m8x8
)

762 
cuºMB
->
vÆid_8x8
 = 
TRUE
;

765 
cuºMB
->
vÆid_4x4
 = 
TRUE
;

767 
vÆid_8x8
 = 
TRUE
;

768 
cuº_cbp_blk
 = 0;

770 i‡(
mode
==0)

773 
dúe˘4x4_tmp
 = 0;

774 
dúe˘8x8_tmp
 = 0;

775 
dúe˘4x4_tmp
 = 
	`GëDúe˘Co°8x8
 ( 
cuºMB
, 
block
, &
dúe˘8x8_tmp
);

776 i‡((
dúe˘4x4_tmp
==
DISTBLK_MAX
)||(*
co°_dúe˘
==DISTBLK_MAX))

778 *
co°_dúe˘
 = 
DISTBLK_MAX
;

779 i‡(
å™sf‹m8x8
)

780 *
co°8x8_dúe˘
 = 
DISTBLK_MAX
;

784 *
co°_dúe˘
 +
dúe˘4x4_tmp
;

785 i‡(
å™sf‹m8x8
)

786 *
co°8x8_dúe˘
 +
dúe˘8x8_tmp
;

788 (*
have_dúe˘
) ++;

790 i‡(
å™sf‹m8x8
)

792 
p_I≈
->
Tønsf‹m8x8Mode
)

795 if((
dúe˘8x8_tmp
 < 
dúe˘4x4_tmp
Ë|| !(
íc_mb
->
vÆid
[5] &&Énc_mb->valid[6] &&Énc_mb->valid[7]))

796 *
co°
 = 
dúe˘8x8_tmp
;

798 *
co°
 = 
dúe˘4x4_tmp
;

801 *
co°
 = 
dúe˘8x8_tmp
;

804 *
co°
 = 
dúe˘4x4_tmp
;

807 i‡(
p_I≈
->
Tønsf‹m8x8Mode
==2)

808 *
co°
 = 
DISTBLK_MAX
;

812 *
co°
 = 
dúe˘4x4_tmp
;

815 
block_x
 = 
cuºMB
->block_x + (
block
 & 0x01)*2;

816 
block_y
 = 
cuºMB
->block_y + (
block
 & 0x02);

817 
be°
.
ªf
[
LIST_0
] = 
cuºSli˚
->
dúe˘_ªf_idx
[
block_y
][
block_x
][LIST_0];

818 
be°
.
ªf
[
LIST_1
] = 
cuºSli˚
->
dúe˘_ªf_idx
[
block_y
][
block_x
][LIST_1];

819 
be°
.
pdú
 = 
cuºSli˚
->
dúe˘_pdú
[
block_y
][
block_x
];

823 
b_ªf
;

827 
	`mem˝y
(
œmbda_mf
, 
íc_mb
->lambda_mf, 3 * ());

828 i‡(
p_I≈
->
CtxAd±LagøngeMu…
 == 1)

830 
RDOPTSåu˘uª
 *
p_RDO
 = 
cuºSli˚
->p_RDO;

831 
œmbda_mf
[
F_PEL
] = ()÷ambda_mf[F_PEL] * 
p_RDO
->
œmbda_mf_Á˘‹
);

832 
œmbda_mf
[
H_PEL
] = ()÷ambda_mf[H_PEL] * 
p_RDO
->
œmbda_mf_Á˘‹
);

833 
œmbda_mf
[
Q_PEL
] = ()÷ambda_mf[Q_PEL] * 
p_RDO
->
œmbda_mf_Á˘‹
);

836 
	`SubP¨tôi⁄MŸi⁄Sórch
 (
cuºMB
, 
mode
, 
block
, 
œmbda_mf
);

839 
bmco°
[
LIST_0
] = 
DISTBLK_MAX
;

840 
	`li°_¥edi˘i⁄_co°
(
cuºMB
, 
LIST_0
, 
block
, 
mode
, 
íc_mb
, 
bmco°
, 
be°
.
ªf
);

843 
block_x
 = 
cuºMB
->block_x + (
block
 & 0x01)*2;

844 
block_y
 = 
cuºMB
->block_y + (
block
 & 0x02);

845 
b_ªf
 = 
be°
.
ªf
[
LIST_0
];

847 
j
 = 
block_y
; j< block_y + 2; j++)

849 
i
 = 
block_x
; i< block_x + 2; i++)

851 
mŸi⁄
[
j
][
i
].
ªf_pic
 [
LIST_0
] = 
cuºSli˚
->
li°X
[
cuºMB
->
li°_off£t
][
b_ªf
];

852 
mŸi⁄
[
j
][
i
].
ªf_idx
 [
LIST_0
] = (Ë
b_ªf
;

856 i‡(
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
)

859 
bmco°
[
LIST_1
] = 
DISTBLK_MAX
;

860 
bmco°
[
BI_PRED
] = 
DISTBLK_MAX
;

861 
	`li°_¥edi˘i⁄_co°
(
cuºMB
, 
LIST_1
, 
block
, 
mode
, 
íc_mb
, 
bmco°
, 
be°
.
ªf
);

864 
	`li°_¥edi˘i⁄_co°
(
cuºMB
, 
BI_PRED
, 
block
, 
mode
, 
íc_mb
, 
bmco°
, 
be°
.
ªf
);

867 i‡(
	`is_bùªd_íabÀd
(
p_Vid
, 
mode
))

869 
	`li°_¥edi˘i⁄_co°
(
cuºMB
, 
BI_PRED_L0
, 
block
, 
mode
, 
íc_mb
, 
bmco°
, 0);

870 
	`li°_¥edi˘i⁄_co°
(
cuºMB
, 
BI_PRED_L1
, 
block
, 
mode
, 
íc_mb
, 
bmco°
, 0);

874 
bmco°
[
BI_PRED_L0
] = 
DISTBLK_MAX
;

875 
bmco°
[
BI_PRED_L1
] = 
DISTBLK_MAX
;

879 
	`dëîmöe_¥edi˘i⁄_li°
(
bmco°
, &
be°
, 
co°
);

882 
j
 = 
block_y
; j< block_y + 2; j++)

884 
i
 = 
block_x
; i < block_x + 2; i++)

887 
mŸi⁄
[
j
][
i
].
ªf_idx
 [
LIST_0
] = (Ë
be°
.
ªf
[LIST_0];

888 
mŸi⁄
[
j
][
i
].
ªf_idx
 [
LIST_0
] = (Ë
be°
.
ªf
[
LIST_1
];

894 
be°
.
pdú
 = 0;

895 *
co°
 = 
bmco°
[
LIST_0
];

898 i‡(*
co°
 !
DISTBLK_MAX
)

899 *
co°
 +(
	`ªf_co°
(
cuºSli˚
, 
íc_mb
->
œmbda_mf
[
Q_PEL
], (Ë
	`B8Mode2VÆue
 (cuºSli˚, (Ë
mode
, 
be°
.
pdú
),

900 (
be°
.
pdú
 < 1 ? 
cuºMB
->
li°_off£t
 : cuºMB->li°_off£à+ 
LIST_1
)) - 1);

903 i‡(*
co°
 < 
mö_co°8x8
)

905 
mö_co°8x8
 = *
co°
;

907 
d©aTr
->
∑π
[
block
] = 
be°
;

908 
cuºMB
->
b8x8
[
block
].
mode
 = () mode;

910 #ifde‡
BEST_NZ_COEFF


911 i‡(
˙t_n⁄z
)

913 
be°_nz_c€ff
[0][0]
p_Vid
->
nz_c€ff
[
cuºMB
->
mbAddrX
][
i1
 ][
j1
 ];

914 
be°_nz_c€ff
[0][1]
p_Vid
->
nz_c€ff
[
cuºMB
->
mbAddrX
][
i1
 ][
j1
 + 1];

915 
be°_nz_c€ff
[1][0]
p_Vid
->
nz_c€ff
[
cuºMB
->
mbAddrX
][
i1
 + 1][
j1
 ];

916 
be°_nz_c€ff
[1][1]
p_Vid
->
nz_c€ff
[
cuºMB
->
mbAddrX
][
i1
 + 1][
j1
 + 1];

920 
be°_nz_c€ff
[0][0]= 0;

921 
be°_nz_c€ff
[0][1]= 0;

922 
be°_nz_c€ff
[1][0]= 0;

923 
be°_nz_c€ff
[1][1]= 0;

928 
be°_˙t_n⁄z
 = 
˙t_n⁄z
;

931 i‡(
block
 < 3)

933 
cuºSli˚
->
	`°‹e_codög_°©e
 (
cuºMB
, cuºSli˚->
p_RDO
->
cs_b8
);

934 
°‹ed_°©e_8x8
 = 
TRUE
;

939 
cuºSli˚
->
	`ª£t_codög_°©e
 (
cuºMB
, cuºSli˚->
p_RDO
->
cs_cm
);

943 i‡(
vÆid_8x8
 =
TRUE
)

945 
li°_mode
[2];

946 #ifde‡
BEST_NZ_COEFF


947 
i
 = 0; i <= 1; i++)

949 
j
 = 0; j <= 1; j++)

950 
p_Vid
->
nz_c€ff
[
cuºMB
->
mbAddrX
][
i1
 + 
i
][
j1
 + 
j
] = 
be°_nz_c€ff
[i][j];

954 i‡(!
å™sf‹m8x8
)

956 i‡(
mö_co°8x8
 !
DISTBLK_MAX
)

957 
d©aTr
->
mb_p8x8_co°
 +
mö_co°8x8
;

959 
d©aTr
->
mb_p8x8_co°
 = 
DISTBLK_MAX
;

963 i‡(
å™sf‹m8x8
)

965 i‡(
mö_co°8x8
 !
DISTBLK_MAX
)

966 
d©aTr
->
mb_p8x8_co°
 +
mö_co°8x8
;

968 
d©aTr
->
mb_p8x8_co°
 = 
DISTBLK_MAX
;

970 
mode
 = 
d©aTr
->
∑π
[
block
].mode;

971 
pdú
 = 
d©aTr
->
∑π
[
block
].pdir;

975 
mode
 = 
d©aTr
->
∑π
[
block
].mode;

976 
pdú
 = 
d©aTr
->
∑π
[
block
].pdir;

979 
cuº_cbp_blk
 = 0;

980 
cuºMB
->
b8x8
[
block
].
bùªd
 = 
d©aTr
->
∑π
[block].bipred;

981 
cuºMB
->
¨_mode
 = (Ë((
mode
 !0)? mode: 
P8x8
);

983 
li°_mode
[0] = (
pdú
 =0 ||Ödú =2 ? 
mode
 : 0);

984 
li°_mode
[1] = (
pdú
 =1 ||Ödú =2 ? 
mode
 : 0);

986 
be°_˙t_n⁄z
 = 
cuºSli˚
->
	`luma_ªsiduÆ_codög_8x8
 (
cuºMB
, &
dummy
, &
cuº_cbp_blk
, 
block
, 
pdú
, 
li°_mode
, 
d©aTr
->
∑π
[block].
ªf
);

988 i‡(
cuºSli˚
->
P444_joöed
)

990 
be°_˙t_n⁄z
 +
cuºSli˚
->
c€ff_co°_¸
[1] + currSlice->coeff_cost_cr[2];

993 
d©aTr
->
cbp_blk8x8
 &(~(0x33 << (((
block
>>1)<<3)+((block & 0x01)<<1))));

994 
d©aTr
->
cbp_blk8x8
 |
cuº_cbp_blk
;

997 
	`mem˝y
(
cofACå
[0][0][0],
cuºSli˚
->
cofAC
[
block
][0][0], 4 * 2 * 65 * ());

999 if(
cuºSli˚
->
P444_joöed
)

1002 
	`mem˝y
(
cofACå
[1][0][0],
cuºSli˚
->
cofAC
[
block
 + 4][0][0], 4 * 2 * 65 * ());

1003 
	`mem˝y
(
cofACå
[2][0][0],
cuºSli˚
->
cofAC
[
block
 + 8][0][0], 4 * 2 * 65 * ());

1008 
	`c›y_image_d©a_8x8
(&
d©aTr
->
ªc_mbY8x8
[
j0
], &
p_Vid
->
íc_pi˘uª
->
imgY
[
cuºMB
->
pix_y
 + j0], 
i0
, cuºMB->
pix_x
 + i0);

1009 
	`c›y_image_d©a_8x8
(&
d©aTr
->
m¥8x8
[
j0
], &
cuºSli˚
->
mb_¥ed
[0][j0], 
i0
, i0);

1013 if(
cuºSli˚
->
¶i˚_ty≥
 =
SP_SLICE
)

1015 
j
=
j0
; j < j0 + 
BLOCK_SIZE_8x8
; j++)

1017 
	`mem˝y
(&
d©aTr
->
Ãec
[
j
][
i0
],&
p_Vid
->Ãec[
cuºMB
->
pix_y
+j][cuºMB->
pix_x
+i0],
BLOCK_SIZE_8x8
 * ());

1020 if(
cuºSli˚
->
P444_joöed
)

1022 
	`c›y_image_d©a_8x8
(&
d©aTr
->
ªc_mb8x8_¸
[0][
j0
], &
p_Vid
->
íc_pi˘uª
->
imgUV
[0][
cuºMB
->
pix_y
 + j0], 
i0
, cuºMB->
pix_x
 + i0);

1023 
	`c›y_image_d©a_8x8
(&
d©aTr
->
m¥8x8CbCr
[0][
j0
], &
cuºSli˚
->
mb_¥ed
[1][j0], 
i0
, i0);

1024 
	`c›y_image_d©a_8x8
(&
d©aTr
->
ªc_mb8x8_¸
[1][
j0
], &
p_Vid
->
íc_pi˘uª
->
imgUV
[1][
cuºMB
->
pix_y
 + j0], 
i0
, cuºMB->
pix_x
 + i0);

1025 
	`c›y_image_d©a_8x8
(&
d©aTr
->
m¥8x8CbCr
[1][
j0
], &
cuºSli˚
->
mb_¥ed
[2][j0], 
i0
, i0);

1030 i‡(
be°_˙t_n⁄z
)

1032 
d©aTr
->
cbp8x8
 |(1 << 
block
);

1033 
d©aTr
->
˙t_n⁄z_8x8
 +
be°_˙t_n⁄z
;

1036 i‡(!
å™sf‹m8x8
)

1038 i‡(
block
 < 3)

1041 
j0
 = 8*(
block
 >> 1);

1042 
i0
 = 8*(
block
 & 0x01);

1044 
	`c›y_image_d©a_8x8
(&
p_Vid
->
íc_pi˘uª
->
imgY
[
cuºMB
->
pix_y
 + 
j0
], &
d©aTr
->
ªc_mbY8x8
[j0], cuºMB->
pix_x
 + 
i0
, i0);

1046 if(
cuºSli˚
->
¶i˚_ty≥
 =
SP_SLICE
)

1048 
j
 = 
j0
; j < j0 + 
BLOCK_SIZE_8x8
; j++)

1050 
	`mem˝y
(&
p_Vid
->
Ãec
[
cuºMB
->
pix_y
 + 
j
][cuºMB->
pix_x
], 
d©aTr
->Ãec[j], 2 * 
BLOCK_SIZE
 * ());

1054 if(
cuºSli˚
->
P444_joöed
)

1056 
	`c›y_image_d©a_8x8
(&
p_Vid
->
íc_pi˘uª
->
imgUV
[0][
cuºMB
->
pix_y
 + 
j0
], &
d©aTr
->
ªc_mb8x8_¸
[0][j0], cuºMB->
pix_x
 + 
i0
, i0);

1057 
	`c›y_image_d©a_8x8
(&
p_Vid
->
íc_pi˘uª
->
imgUV
[1][
cuºMB
->
pix_y
 + 
j0
], &
d©aTr
->
ªc_mb8x8_¸
[1][j0], cuºMB->
pix_x
 + 
i0
, i0);

1064 
cuºSli˚
->
	`°‹e_8x8_mŸi⁄_ve˘‹s
(cuºSli˚, 0, 
block
, &
d©aTr
->
∑π
[block]);

1068 
cuºSli˚
->
	`£t_ªf_™d_mŸi⁄_ve˘‹s
 (
cuºMB
, 
mŸi⁄
, &
d©aTr
->
∑π
[
block
], block);

1072 i‡(
°‹ed_°©e_8x8
 =
TRUE
)

1073 
cuºSli˚
->
	`ª£t_codög_°©e
 (
cuºMB
, cuºSli˚->
p_RDO
->
cs_b8
);

1076 
	`upd©e_ad≠tive_roundög_8x8
(
p_Vid
, 
p_I≈
, 
d©aTr
, 
Ádju°
);

1079 
	}
}

	@lencod/src/mv_direct.c

16 
	~"c⁄åibut‹s.h
"

18 
	~<m©h.h
>

19 
	~<limôs.h
>

20 
	~<time.h
>

22 
	~"globÆ.h
"

24 
	~"image.h
"

25 
	~"mv_£¨ch.h
"

26 
	~"ªfbuf.h
"

27 
	~"memÆloc.h
"

28 
	~"mb_ac˚ss.h
"

29 
	~"ma¸oblock.h
"

30 
	~"mc_¥edi˘i⁄.h
"

31 
	~"c⁄f‹m™˚.h
"

32 
	~"mode_decisi⁄.h
"

40 
	$Gë_Dúe˘_MV_Temp‹Æ
 (
Ma¸oblock
 *
cuºMB
)

42 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

43 
block_x
, 
block_y
, 
pic_block_x
, 
pic_block_y
, 
›ic_block_x
, 
›ic_block_y
;

44 
MŸi⁄Ve˘‹
 *****
Æl_mvs
;

45 
mv_sˇÀ
;

46 
ªfLi°
;

47 
ªf_idx
;

48 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

49 
li°_off£t
 = 
cuºMB
->list_offset;

51 
St‹abÀPi˘uª
 **
li°1
 = 
cuºSli˚
->
li°X
[
LIST_1
 + 
li°_off£t
];

53 
PicMŸi⁄P¨ams
 
cﬁoˇãd
;

56 
block_y
 = 0; block_y < 4; block_y++)

58 
pic_block_y
 = 
cuºMB
->
block_y
 + block_y;

59 
›ic_block_y
 = (
cuºMB
->
›ix_y
 >> 2Ë+ 
block_y
;

61 
block_x
 = 0; block_x < 4; block_x++)

63 
pic_block_x
 = 
cuºMB
->
block_x
 + block_x;

64 
›ic_block_x
 = (
cuºMB
->
pix_x
>>2Ë+ 
block_x
;

66 
Æl_mvs
 = 
cuºSli˚
->
Æl_mv
;

67 i‡(
p_Vid
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
)

69 if(
cuºMB
->
p_I≈
->
£∑øã_cﬁour_∂™e_Êag
 && cuºMB->
p_Vid
->
yuv_f‹m©
==
YUV444
)

70 
cﬁoˇãd
 = 
li°1
[0]->
JVmv_öfo
[
cuºMB
->
p_Sli˚
->
cﬁour_∂™e_id
][
	`RSD
(
›ic_block_y
)][RSD(
›ic_block_x
)];

72 
cﬁoˇãd
 = 
li°1
[0]->
mv_öfo
[
	`RSD
(
›ic_block_y
)][RSD(
›ic_block_x
)];

73 if(
cuºSli˚
->
mb_aff_‰ame_Êag
 && 
cuºMB
->
mb_fõld
 && cuºSli˚->
li°X
[
LIST_1
][0]->
coded_‰ame
)

75 
iPosBlkY
;

76 if(
cuºSli˚
->
li°X
[
LIST_1
][0]->
mŸi⁄
.
mb_fõld
[
cuºMB
->
mbAddrX
] )

77 
iPosBlkY
 = (
›ic_block_y
>>2)*8+4*(
cuºMB
->
mbAddrX
&1)+(opic_block_y&0x03);

79 
iPosBlkY
 = 
	`RSD
(
›ic_block_y
)*2;

81 if(
cﬁoˇãd
.
ªf_idx
[
LIST_0
]>=0)

82 
cﬁoˇãd
.
ªf_pic
[
LIST_0
] = 
li°1
[0]->
‰ame
->
mv_öfo
[
iPosBlkY
][
	`RSD
(
›ic_block_x
)].ref_pic[LIST_0];

83 if(
cﬁoˇãd
.
ªf_idx
[
LIST_1
]>=0)

84 
cﬁoˇãd
.
ªf_pic
[
LIST_1
] = 
li°1
[0]->
‰ame
->
mv_öfo
[
iPosBlkY
][
	`RSD
(
›ic_block_x
)].ref_pic[LIST_1];

89 if(
cuºMB
->
p_I≈
->
£∑øã_cﬁour_∂™e_Êag
 && cuºMB->
p_Vid
->
yuv_f‹m©
==
YUV444
)

90 
cﬁoˇãd
 = 
li°1
[0]->
JVmv_öfo
[
cuºMB
->
p_Sli˚
->
cﬁour_∂™e_id
][
›ic_block_y
][
›ic_block_x
];

92 
cﬁoˇãd
 = 
li°1
[0]->
mv_öfo
[
›ic_block_y
][
›ic_block_x
];

94 if(
cuºSli˚
->
mb_aff_‰ame_Êag
)

96 if(!
cuºMB
->
mb_fõld
 && ((
cuºSli˚
->
li°X
[
LIST_1
][0]->
coded_‰ame
 && cuºSli˚->li°X[LIST_1][0]->
mŸi⁄
.mb_fõld[cuºMB->
mbAddrX
]) ||

97 (!
cuºSli˚
->
li°X
[
LIST_1
][0]->
coded_‰ame
)))

99 i‡(
	`übs
(
p_Vid
->
íc_pi˘uª
->
poc
 - 
cuºSli˚
->
li°X
[
LIST_1
+4][0]->poc)> iabs(p_Vid->enc_picture->poc -currSlice->listX[LIST_1+2][0]->poc) )

101 i‡–
p_Vid
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
)

103 if(
cuºMB
->
p_I≈
->
£∑øã_cﬁour_∂™e_Êag
 && cuºMB->
p_Vid
->
yuv_f‹m©
==
YUV444
)

104 
cﬁoˇãd
 = 
cuºSli˚
->
li°X
[
LIST_1
+2][0]->
JVmv_öfo
[
cuºMB
->
p_Sli˚
->
cﬁour_∂™e_id
][
	`RSD
(
›ic_block_y
)>>1][RSD(
›ic_block_x
)];

106 
cﬁoˇãd
 = 
cuºSli˚
->
li°X
[
LIST_1
+2][0]->
mv_öfo
[
	`RSD
(
›ic_block_y
)>>1][RSD(
›ic_block_x
)];

110 if(
cuºMB
->
p_I≈
->
£∑øã_cﬁour_∂™e_Êag
 && cuºMB->
p_Vid
->
yuv_f‹m©
==
YUV444
)

111 
cﬁoˇãd
 = 
cuºSli˚
->
li°X
[
LIST_1
+2][0]->
JVmv_öfo
[
cuºMB
->
p_Sli˚
->
cﬁour_∂™e_id
][(
›ic_block_y
)>>1][(
›ic_block_x
)];

113 
cﬁoˇãd
 = 
cuºSli˚
->
li°X
[
LIST_1
+2][0]->
mv_öfo
[(
›ic_block_y
)>>1][
›ic_block_x
];

115 if(
cuºSli˚
->
li°X
[
LIST_1
][0]->
coded_‰ame
)

117 
iPosBlkY
 = (
	`RSD
(
›ic_block_y
)>>3)*8 + ((RSD(opic_block_y)>>1) & 0x03);

118 if(
cﬁoˇãd
.
ªf_idx
[
LIST_0
] >=0)

119 
cﬁoˇãd
.
ªf_pic
[
LIST_0
] = 
cuºSli˚
->
li°X
[
LIST_1
+2][0]->
‰ame
->
mv_öfo
[
iPosBlkY
][
	`RSD
(
›ic_block_x
)].ref_pic[LIST_0];

120 if(
cﬁoˇãd
.
ªf_idx
[
LIST_1
] >=0)

121 
cﬁoˇãd
.
ªf_pic
[
LIST_1
] = 
cuºSli˚
->
li°X
[LIST_1+2][0]->
‰ame
->
mv_öfo
[
iPosBlkY
][
	`RSD
(
›ic_block_x
)].ref_pic[LIST_1];

126 i‡(
p_Vid
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
 )

128 if(
cuºMB
->
p_I≈
->
£∑øã_cﬁour_∂™e_Êag
 && cuºMB->
p_Vid
->
yuv_f‹m©
==
YUV444
)

129 
cﬁoˇãd
 = 
cuºSli˚
->
li°X
[
LIST_1
+4][0]->
JVmv_öfo
[
cuºMB
->
p_Sli˚
->
cﬁour_∂™e_id
][
	`RSD
(
›ic_block_y
)>>1][RSD(
›ic_block_x
)];

131 
cﬁoˇãd
 = 
cuºSli˚
->
li°X
[
LIST_1
+4][0]->
mv_öfo
[
	`RSD
(
›ic_block_y
)>>1][RSD(
›ic_block_x
)];

136 if(
cuºMB
->
p_I≈
->
£∑øã_cﬁour_∂™e_Êag
 && cuºMB->
p_Vid
->
yuv_f‹m©
==
YUV444
)

137 
cﬁoˇãd
 = 
cuºSli˚
->
li°X
[
LIST_1
+4][0]->
JVmv_öfo
[
cuºMB
->
p_Sli˚
->
cﬁour_∂™e_id
][(
›ic_block_y
)>>1][
›ic_block_x
];

139 
cﬁoˇãd
 = 
cuºSli˚
->
li°X
[
LIST_1
+4][0]->
mv_öfo
[(
›ic_block_y
)>>1][
›ic_block_x
];

141 if(
cuºSli˚
->
li°X
[
LIST_1
][0]->
coded_‰ame
)

143 
iPosBlkY
 = (
	`RSD
(
›ic_block_y
)>>3)*8 + ((RSD(opic_block_y)>>1) & 0x03)+4;

144 if(
cﬁoˇãd
.
ªf_idx
[
LIST_0
] >=0)

145 
cﬁoˇãd
.
ªf_pic
[
LIST_0
] = 
cuºSli˚
->
li°X
[
LIST_1
+4][0]->
‰ame
->
mv_öfo
[
iPosBlkY
][
	`RSD
(
›ic_block_x
)].ref_pic[LIST_0];

146 if(
cﬁoˇãd
.
ªf_idx
[
LIST_1
] >=0)

147 
cﬁoˇãd
.
ªf_pic
[
LIST_1
] = 
cuºSli˚
->
li°X
[LIST_1+4][0]->
‰ame
->
mv_öfo
[
iPosBlkY
][
	`RSD
(
›ic_block_x
)].ref_pic[LIST_1];

152 if(!
p_Vid
->
a˘ive_•s
->
‰ame_mbs_⁄ly_Êag
 && !p_Vid->
°ru˘uª
 && !
cuºSli˚
->
li°X
[
LIST_1
][0]->
coded_‰ame
)

154 i‡(
	`übs
(
p_Vid
->
íc_pi˘uª
->
poc
 - 
li°1
[0]->
bŸtom_fõld
->poc)> iabs’_Vid->íc_pi˘uª->po¯-li°1[0]->
t›_fõld
->poc) )

156 
cﬁoˇãd
 = 
p_Vid
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
 ?

157 
li°1
[0]->
t›_fõld
->
mv_öfo
[
	`RSD
(
›ic_block_y
)>>1][RSD(
›ic_block_x
)] :Üist1[0]->top_field->mv_info[(opic_block_y)>>1][opic_block_x];

161 
cﬁoˇãd
 = 
p_Vid
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
 ?

162 
li°1
[0]->
bŸtom_fõld
->
mv_öfo
[
	`RSD
(
›ic_block_y
)>>1][RSD(
›ic_block_x
)] :Üist1[0]->bottom_field->mv_info[(opic_block_y)>>1][opic_block_x];

165 if(!
p_Vid
->
a˘ive_•s
->
‰ame_mbs_⁄ly_Êag
 &&Ö_Vid->
°ru˘uª
 && 
li°1
[0]->
coded_‰ame
)

167 
iPosBlkY
;

168 
cuºítmb
 = 2*(
li°1
[0]->
size_x
>>4Ë* (
›ic_block_y
 >> 2)+ (
›ic_block_x
>>2)*2 + ((opic_block_y>>1) & 0x01);

169 if(
p_Vid
->
°ru˘uª
!=
li°1
[0]->structure)

171 i‡(
p_Vid
->
°ru˘uª
 =
TOP_FIELD
)

173 
cﬁoˇãd
 = 
p_Vid
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
 ?

174 
li°1
[0]->
‰ame
->
t›_fõld
->
mv_öfo
[
	`RSD
(
›ic_block_y
)][RSD(
›ic_block_x
)] :Üist1[0]->frame->top_field->mv_info[opic_block_y][opic_block_x];

178 
cﬁoˇãd
 = 
p_Vid
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
 ?

179 
li°1
[0]->
‰ame
->
bŸtom_fõld
->
mv_öfo
[
	`RSD
(
›ic_block_y
)][RSD(
›ic_block_x
)] :Üist1[0]->frame->bottom_field->mv_info[opic_block_y][opic_block_x];

183 if(!
cuºSli˚
->
li°X
[
LIST_1
][0]->
‰ame
->
mb_aff_‰ame_Êag
 || !
li°1
[0]->‰ame->
mŸi⁄
.
mb_fõld
[
cuºítmb
])

184 
iPosBlkY
 = 2*(
	`RSD
(
›ic_block_y
));

186 
iPosBlkY
 = (
	`RSD
(
›ic_block_y
)>>2)*8 + (RSD(›ic_block_yË& 0x03)+4*(
p_Vid
->
°ru˘uª
 =
BOTTOM_FIELD
);

187 if(
cﬁoˇãd
.
ªf_idx
[
LIST_0
] >=0)

188 
cﬁoˇãd
.
ªf_pic
[
LIST_0
] = 
li°1
[0]->
‰ame
->
mv_öfo
[
iPosBlkY
][
	`RSD
(
›ic_block_x
)].ref_pic[LIST_0];

189 if(
cﬁoˇãd
.
ªf_idx
[
LIST_1
] >=0)

190 
cﬁoˇãd
.
ªf_pic
[
LIST_1
] = 
li°1
[0]->
‰ame
->
mv_öfo
[
iPosBlkY
][
	`RSD
(
›ic_block_x
)].ref_pic[LIST_1];

193 
ªfLi°
 = ((
cﬁoˇãd
.
ªf_idx
[
LIST_0
] =-1 || (
p_Vid
->
võw_id
 && cﬁoˇãd.ªf_idx[LIST_0]==
li°1
[0]->
ªf_pic_«
[0]))? 
LIST_1
 : LIST_0);

194 
ªf_idx
 = 
cﬁoˇãd
.ªf_idx[
ªfLi°
];

197 i‡(
ªf_idx
 =-1 || (
p_Vid
->
võw_id
 &&Ñef_idx==
li°1
[0]->
ªf_pic_«
[
ªfLi°
]))

199 
Æl_mvs
[
LIST_0
][0][0][
block_y
][
block_x
] = 
zîo_mv
;

200 
Æl_mvs
[
LIST_1
][0][0][
block_y
][
block_x
] = 
zîo_mv
;

201 
cuºSli˚
->
dúe˘_ªf_idx
[
pic_block_y
][
pic_block_x
][
LIST_0
] = 0;

202 
cuºSli˚
->
dúe˘_ªf_idx
[
pic_block_y
][
pic_block_x
][
LIST_1
] = 0;

203 
cuºSli˚
->
dúe˘_pdú
[
pic_block_y
][
pic_block_x
] = 2;

208 
m≠≥d_idx
=
INVALIDINDEX
;

209 
úef
;

210 if–(
cuºSli˚
->
mb_aff_‰ame_Êag
 && ( (
cuºMB
->
mb_fõld
 && 
cﬁoˇãd
.
ªf_pic
[
ªfLi°
]->
°ru˘uª
==
FRAME
) ||

211 (!
cuºMB
->
mb_fõld
 && 
cﬁoˇãd
.
ªf_pic
[
ªfLi°
]->
°ru˘uª
!=
FRAME
))) ||

212 (!
cuºSli˚
->
mb_aff_‰ame_Êag
 && ((
p_Vid
->
°ru˘uª
==
FRAME
 && 
cﬁoˇãd
.
ªf_pic
[
ªfLi°
]->structure!=FRAME)||

213 (
p_Vid
->
°ru˘uª
!=
FRAME
 && 
cﬁoˇãd
.
ªf_pic
[
ªfLi°
]->structure==FRAME))) )

216 
úef
 = 0; iª‡< 
	`imö
(
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
], cuºSli˚->
li°Xsize
[LIST_0 + 
li°_off£t
]); iref++)

218 i‡(
cuºSli˚
->
li°X
[
LIST_0
 + 
li°_off£t
][
úef
]->
t›_fõld
 =
cﬁoˇãd
.
ªf_pic
[
ªfLi°
] ||

219 
cuºSli˚
->
li°X
[
LIST_0
 + 
li°_off£t
][
úef
]->
bŸtom_fõld
 =
cﬁoˇãd
.
ªf_pic
[
ªfLi°
] ||

220 
cuºSli˚
->
li°X
[
LIST_0
 + 
li°_off£t
][
úef
]->
‰ame
 =
cﬁoˇãd
.
ªf_pic
[
ªfLi°
] )

222 i‡((
p_Vid
->
fõld_pi˘uª
==1Ë&& (
cuºSli˚
->
li°X
[
LIST_0
 + 
li°_off£t
][
úef
]->
°ru˘uª
 != currSlice->structure))

224 
m≠≥d_idx
=
INVALIDINDEX
;

228 
m≠≥d_idx
 = 
úef
;

233 
m≠≥d_idx
=
INVALIDINDEX
;

238 
úef
 = 0; iª‡< 
	`imö
(
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
], cuºSli˚->
li°Xsize
[LIST_0 + 
li°_off£t
]);iref++)

240 if(
cuºSli˚
->
li°X
[
LIST_0
 + 
li°_off£t
][
úef
] =
cﬁoˇãd
.
ªf_pic
[
ªfLi°
])

242 
m≠≥d_idx
 = 
úef
;

247 
m≠≥d_idx
=
INVALIDINDEX
;

252 i‡(
m≠≥d_idx
 !
INVALIDINDEX
)

254 
MŸi⁄Ve˘‹
 
mv
 = 
cﬁoˇãd
.mv[
ªfLi°
];

255 
mv_sˇÀ
 = 
cuºSli˚
->
mvsˇÀ
[
LIST_0
 + 
li°_off£t
][
m≠≥d_idx
];

257 if((
cuºSli˚
->
mb_aff_‰ame_Êag
 && !
cuºMB
->
mb_fõld
 && 
cﬁoˇãd
.
ªf_pic
[
ªfLi°
]->
°ru˘uª
!=
FRAME
) ||

258 (!
cuºSli˚
->
mb_aff_‰ame_Êag
 && 
p_Vid
->
°ru˘uª
==
FRAME
 && 
cﬁoˇãd
.
ªf_pic
[
ªfLi°
]->structure!=FRAME))

259 
mv
.
mv_y
 *= 2;

260 if((
cuºSli˚
->
mb_aff_‰ame_Êag
 && 
cuºMB
->
mb_fõld
 && 
cﬁoˇãd
.
ªf_pic
[
ªfLi°
]->
°ru˘uª
==
FRAME
) ||

261 (!
cuºSli˚
->
mb_aff_‰ame_Êag
 && 
p_Vid
->
°ru˘uª
!=
FRAME
 && 
cﬁoˇãd
.
ªf_pic
[
ªfLi°
]->structure==FRAME))

262 
mv
.
mv_y
 /= 2;

264 i‡(
mv_sˇÀ
==9999)

267 
Æl_mvs
[
LIST_0
][0][0][
block_y
][
block_x
] = 
mv
;

269 
Æl_mvs
[
LIST_1
][0][0][
block_y
][
block_x
] = 
zîo_mv
;

274 
Æl_mvs
[
LIST_0
][
m≠≥d_idx
][0][
block_y
][
block_x
].
mv_x
 = (Ë((
mv_sˇÀ
 * 
mv
.mv_x + 128) >> 8);

275 
Æl_mvs
[
LIST_0
][
m≠≥d_idx
][0][
block_y
][
block_x
].
mv_y
 = (Ë((
mv_sˇÀ
 * 
mv
.mv_y + 128) >> 8);

277 
Æl_mvs
[
LIST_1
][ 0][0][
block_y
][
block_x
].
mv_x
 = (Ë(((
mv_sˇÀ
 - 256Ë* 
mv
.mv_x + 128) >> 8);

278 
Æl_mvs
[
LIST_1
][ 0][0][
block_y
][
block_x
].
mv_y
 = (Ë(((
mv_sˇÀ
 - 256Ë* 
mv
.mv_y + 128) >> 8);

283 i‡–
	`out_of_bounds_mvs
(
p_Vid
, &
Æl_mvs
[
LIST_0
][
m≠≥d_idx
][0][
block_y
][
block_x
])|| out_of_bounds_mvs’_Vid, &Æl_mvs[
LIST_1
][0][0][block_y][block_x]))

285 
cuºSli˚
->
dúe˘_ªf_idx
[
pic_block_y
][
pic_block_x
][
LIST_0
] = -1;

286 
cuºSli˚
->
dúe˘_ªf_idx
[
pic_block_y
][
pic_block_x
][
LIST_1
] = -1;

287 
cuºSli˚
->
dúe˘_pdú
[
pic_block_y
][
pic_block_x
] = -1;

291 
cuºSli˚
->
dúe˘_ªf_idx
[
pic_block_y
][
pic_block_x
][
LIST_0
] = (Ë
m≠≥d_idx
;

292 
cuºSli˚
->
dúe˘_ªf_idx
[
pic_block_y
][
pic_block_x
][
LIST_1
] = 0;

293 
cuºSli˚
->
dúe˘_pdú
[
pic_block_y
][
pic_block_x
] = 2;

298 
cuºSli˚
->
dúe˘_ªf_idx
[
pic_block_y
][
pic_block_x
][
LIST_0
] = -1;

299 
cuºSli˚
->
dúe˘_ªf_idx
[
pic_block_y
][
pic_block_x
][
LIST_1
] = -1;

300 
cuºSli˚
->
dúe˘_pdú
[
pic_block_y
][
pic_block_x
] = -1;

304 i‡(
p_Vid
->
a˘ive_µs
->
weighãd_bùªd_idc
 =1 && 
cuºSli˚
->
dúe˘_pdú
[
pic_block_y
][
pic_block_x
] == 2)

306 
weight_sum
, 
i
;

307 
l0_ªfX
 = 
cuºSli˚
->
dúe˘_ªf_idx
[
pic_block_y
][
pic_block_x
][
LIST_0
];

308 
l1_ªfX
 = 
cuºSli˚
->
dúe˘_ªf_idx
[
pic_block_y
][
pic_block_x
][
LIST_1
];

309 
i
=0;i< (
p_Vid
->
a˘ive_•s
->
chroma_f‹m©_idc
 =
YUV400
 ? 1 : 3); i++)

311 
weight_sum
 = 
cuºSli˚
->
wbp_weight
[0][
l0_ªfX
][
l1_ªfX
][
i
] + currSlice->wbp_weight[1][l0_refX][l1_refX][i];

312 i‡(
weight_sum
 < -128 || weight_sum > 127)

314 
cuºSli˚
->
dúe˘_ªf_idx
[
pic_block_y
][
pic_block_x
][
LIST_0
] = -1;

315 
cuºSli˚
->
dúe˘_ªf_idx
[
pic_block_y
][
pic_block_x
][
LIST_1
] = -1;

316 
cuºSli˚
->
dúe˘_pdú
 [
pic_block_y
][
pic_block_x
] = -1;

323 
	}
}

325 
ölöe
 
	$£t_dúe˘_ª„ªn˚s
(c⁄° 
PixñPos
 *
mb
, *
l0_rFøme
, *
l1_rFøme
, 
PicMŸi⁄P¨ams
 **
mv_öfo
)

327 i‡(
mb
->
avaûabÀ
)

329 *
ªf_idx
 = 
mv_öfo
[
mb
->
pos_y
][mb->
pos_x
].ref_idx;

330 *
l0_rFøme
 = 
ªf_idx
[
LIST_0
];

331 *
l1_rFøme
 = 
ªf_idx
[
LIST_1
];

335 *
l0_rFøme
 = -1;

336 *
l1_rFøme
 = -1;

338 
	}
}

340 
	$£t_dúe˘_ª„ªn˚s_mb_fõld
(c⁄° 
PixñPos
 *
mb
, *
l0_rFøme
, *
l1_rFøme
, 
PicMŸi⁄P¨ams
 **
mv_öfo
, 
Ma¸oblock
 *
mb_d©a
)

342 i‡(
mb
->
avaûabÀ
)

344 *
ªf_idx
 = 
mv_öfo
[
mb
->
pos_y
][mb->
pos_x
].ref_idx;

345 i‡(
mb_d©a
[
mb
->
mb_addr
].
mb_fõld
)

347 *
l0_rFøme
 = 
ªf_idx
[
LIST_0
];

348 *
l1_rFøme
 = 
ªf_idx
[
LIST_1
];

352 *
l0_rFøme
 = (
ªf_idx
[
LIST_0
] < 0) ?Ñef_idx[LIST_0] :Ñef_idx[LIST_0] * 2;

353 *
l1_rFøme
 = (
ªf_idx
[
LIST_1
] < 0) ?Ñef_idx[LIST_1] :Ñef_idx[LIST_1] * 2;

358 *
l0_rFøme
 = -1;

359 *
l1_rFøme
 = -1;

361 
	}
}

363 
	$£t_dúe˘_ª„ªn˚s_mb_‰ame
(c⁄° 
PixñPos
 *
mb
, *
l0_rFøme
, *
l1_rFøme
, 
PicMŸi⁄P¨ams
 **
mv_öfo
, 
Ma¸oblock
 *
mb_d©a
)

365 i‡(
mb
->
avaûabÀ
)

367 *
ªf_idx
 = 
mv_öfo
[
mb
->
pos_y
][mb->
pos_x
].ref_idx;

368 i‡(
mb_d©a
[
mb
->
mb_addr
].
mb_fõld
)

370 *
l0_rFøme
 = (
ªf_idx
[
LIST_0
] >> 1);

371 *
l1_rFøme
 = (
ªf_idx
[
LIST_1
] >> 1);

375 *
l0_rFøme
 = 
ªf_idx
[
LIST_0
];

376 *
l1_rFøme
 = 
ªf_idx
[
LIST_1
];

381 *
l0_rFøme
 = -1;

382 *
l1_rFøme
 = -1;

384 
	}
}

386 
	$ã°_vÆid_dúe˘
(
Sli˚
 *
cuºSli˚
, 
£q_∑ømëî_£t_rb•_t
 *
a˘ive_•s
, *
dúe˘_ªf_idx
, 
l0_ªfX
, 
l1_ªfX
, 
pic_block_y
, 
pic_block_x
)

388 
weight_sum
, 
i
;

389 
Boﬁón
 
övÆid_wp
 = 
FALSE
;

390 
i
=0;i< (
a˘ive_•s
->
chroma_f‹m©_idc
 =
YUV400
 ? 1 : 3); i++)

392 
weight_sum
 = 
cuºSli˚
->
wbp_weight
[0][
l0_ªfX
][
l1_ªfX
][
i
] + currSlice->wbp_weight[1][l0_refX][l1_refX][i];

393 i‡(
weight_sum
 < -128 || weight_sum > 127)

395 
övÆid_wp
 = 
TRUE
;

399 i‡(
övÆid_wp
 =
FALSE
)

400 
cuºSli˚
->
dúe˘_pdú
[
pic_block_y
][
pic_block_x
] = 2;

403 
dúe˘_ªf_idx
[
LIST_0
] = -1;

404 
dúe˘_ªf_idx
[
LIST_1
] = -1;

405 
cuºSli˚
->
dúe˘_pdú
[
pic_block_y
][
pic_block_x
] = -1;

407 
	}
}

416 
	$gë_cﬁoˇãd_öfo
(
Ma¸oblock
 *
cuºMB
, 
St‹abÀPi˘uª
 *
li°1
, 
i
, 
j
)

418 i‡(
li°1
->
is_l⁄g_ãrm
)

422 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

423 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

424 if–(
cuºSli˚
->
mb_aff_‰ame_Êag
) ||

425 (!
p_Vid
->
a˘ive_•s
->
‰ame_mbs_⁄ly_Êag
 && ((!
cuºSli˚
->
°ru˘uª
 && !
li°1
->
coded_‰ame
) || (currSlice->structure!=list1->structure &&Üist1->coded_frame))))

427 
jj
 = 
	`RSD
(
j
);

428 
ii
 = 
	`RSD
(
i
);

429 
jdiv
 = (
jj
>>1);

430 
movög
;

431 
PicMŸi⁄P¨ams
 *
fs
 = &
li°1
->
mv_öfo
[
jj
][
ii
];

433 if(
cuºSli˚
->
°ru˘uª
 && cuºSli˚->°ru˘uª!=
li°1
->°ru˘uª &&Üi°1->
coded_‰ame
)

435 if(
cuºSli˚
->
°ru˘uª
 =
TOP_FIELD
)

436 
fs
 = 
li°1
->
t›_fõld
->
mv_öfo
[
jj
] + 
ii
;

438 
fs
 = 
li°1
->
bŸtom_fõld
->
mv_öfo
[
jj
] + 
ii
;

442 if–(
cuºSli˚
->
mb_aff_‰ame_Êag
 && ((!
cuºMB
->
mb_fõld
 && 
li°1
->
mŸi⁄
.mb_fõld[cuºMB->
mbAddrX
]) ||

443 (!
cuºMB
->
mb_fõld
 && !
li°1
->
coded_‰ame
)))

444 || (!
cuºSli˚
->
mb_aff_‰ame_Êag
))

446 i‡(
	`übs
(
p_Vid
->
íc_pi˘uª
->
poc
 - 
li°1
->
bŸtom_fõld
->poc)> iabs’_Vid->íc_pi˘uª->po¯-li°1->
t›_fõld
->poc) )

448 
fs
 = 
li°1
->
t›_fõld
->
mv_öfo
[
jdiv
] + 
ii
;

452 
fs
 = 
li°1
->
bŸtom_fõld
->
mv_öfo
[
jdiv
] + 
ii
;

456 
movög
 = !((((
fs
->
ªf_idx
[
LIST_0
] == 0)

457 && (
	`übs
(
fs
->
mv
[
LIST_0
].
mv_x
)>>1 == 0)

458 && (
	`übs
(
fs
->
mv
[
LIST_0
].
mv_y
)>>1 == 0)))

459 || ((
fs
->
ªf_idx
[
LIST_0
] == -1)

460 && (
fs
->
ªf_idx
[
LIST_1
] == 0)

461 && (
	`übs
(
fs
->
mv
[
LIST_1
].
mv_x
)>>1 == 0)

462 && (
	`übs
(
fs
->
mv
[
LIST_1
].
mv_y
)>>1 == 0)));

463  
movög
;

467 
PicMŸi⁄P¨ams
 *
fs
 = &
li°1
->
mv_öfo
[
	`RSD
(
j
)][RSD(
i
)];

468 
movög
;

469 if(
cuºMB
->
p_Vid
->
yuv_f‹m©
 =
YUV444
 && !
cuºSli˚
->
P444_joöed
)

470 
fs
 = &
li°1
->
JVmv_öfo
[()(
p_Vid
->
cﬁour_∂™e_id
)][
	`RSD
(
j
)][RSD(
i
)];

471 
movög
!((((
fs
->
ªf_idx
[
LIST_0
] == 0)

472 && (
	`übs
(
fs
->
mv
[
LIST_0
].
mv_x
)>>1 == 0)

473 && (
	`übs
(
fs
->
mv
[
LIST_0
].
mv_y
)>>1 == 0)))

474 || ((
fs
->
ªf_idx
[
LIST_0
] == -1)

475 && (
fs
->
ªf_idx
[
LIST_1
] == 0)

476 && (
	`übs
(
fs
->
mv
[
LIST_1
].
mv_x
)>>1 == 0)

477 && (
	`übs
(
fs
->
mv
[
LIST_1
].
mv_y
)>>1 == 0)));

479  
movög
;

482 
	}
}

490 
	$gë_cﬁoˇãd_öfo_4x4
(
Ma¸oblock
 *
cuºMB
, 
St‹abÀPi˘uª
 *
li°1
, 
i
, 
j
)

492 i‡(
li°1
->
is_l⁄g_ãrm
)

496 
PicMŸi⁄P¨ams
 *
fs
 = &
li°1
->
mv_öfo
[
j
][
i
];

498 
movög
 = !((((
fs
->
ªf_idx
[
LIST_0
] == 0)

499 && (
	`übs
(
fs
->
mv
[
LIST_0
].
mv_x
)>>1 == 0)

500 && (
	`übs
(
fs
->
mv
[
LIST_0
].
mv_y
)>>1 == 0)))

501 || ((
fs
->
ªf_idx
[
LIST_0
] == -1)

502 && (
fs
->
ªf_idx
[
LIST_1
] == 0)

503 && (
	`übs
(
fs
->
mv
[
LIST_1
].
mv_x
)>>1 == 0)

504 && (
	`übs
(
fs
->
mv
[
LIST_1
].
mv_y
)>>1 == 0)));

506  
movög
;

508 
	}
}

516 
	$Gë_Dúe˘_MV_S∑tül_N‹mÆ
 (
Ma¸oblock
 *
cuºMB
)

518 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

519 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

520 
PicMŸi⁄P¨ams
 **
mv_öfo
 = 
p_Vid
->
íc_pi˘uª
->mv_info;

521 
l0_ªfA
, 
l0_ªfB
, 
l0_ªfC
;

522 
l1_ªfA
, 
l1_ªfB
, 
l1_ªfC
;

523 
l0_ªfX
,
l1_ªfX
;

524 
MŸi⁄Ve˘‹
 
pmvfw
 = 
zîo_mv
, 
pmvbw
 = zero_mv;

526 
block_x
, 
block_y
, 
pic_block_x
, 
pic_block_y
, 
›ic_block_x
, 
›ic_block_y
;

527 
MŸi⁄Ve˘‹
 *****
Æl_mvs
;

528 *
dúe˘_ªf_idx
;

529 
St‹abÀPi˘uª
 **
li°1
 = 
cuºSli˚
->
li°X
[
LIST_1
];

531 
PixñPos
 
mb
[4];

532 
	`gë_√ighb‹s
(
cuºMB
, 
mb
, 0, 0, 16);

534 
	`£t_dúe˘_ª„ªn˚s
(&
mb
[0], &
l0_ªfA
, &
l1_ªfA
, 
mv_öfo
);

535 
	`£t_dúe˘_ª„ªn˚s
(&
mb
[1], &
l0_ªfB
, &
l1_ªfB
, 
mv_öfo
);

536 
	`£t_dúe˘_ª„ªn˚s
(&
mb
[2], &
l0_ªfC
, &
l1_ªfC
, 
mv_öfo
);

538 
l0_ªfX
 = (Ë
	`imö
(imö((Ë
l0_ªfA
, (Ë
l0_ªfB
), (Ë
l0_ªfC
);

539 
l1_ªfX
 = (Ë
	`imö
(imö((Ë
l1_ªfA
, (Ë
l1_ªfB
), (Ë
l1_ªfC
);

541 i‡(
l0_ªfX
 >= 0)

542 
cuºMB
->
	`GëMVPªdi˘‹
 (cuºMB, 
mb
, &
pmvfw
, 
l0_ªfX
, 
mv_öfo
, 
LIST_0
, 0, 0, 16, 16);

544 i‡(
l1_ªfX
 >= 0)

545 
cuºMB
->
	`GëMVPªdi˘‹
 (cuºMB, 
mb
, &
pmvbw
, 
l1_ªfX
, 
mv_öfo
, 
LIST_1
, 0, 0, 16, 16);

547 i‡(
l0_ªfX
 =-1 && 
l1_ªfX
 == -1)

549 
block_y
=0; block_y<4; block_y++)

551 
pic_block_y
 = 
cuºMB
->
block_y
 + block_y;

552 
block_x
=0; block_x<4; block_x++)

554 
pic_block_x
 = 
cuºMB
->
block_x
 + block_x;

555 
dúe˘_ªf_idx
 = 
cuºSli˚
->dúe˘_ªf_idx[
pic_block_y
][
pic_block_x
];

557 
cuºSli˚
->
Æl_mv
[
LIST_0
][0][0][
block_y
][
block_x
] = 
zîo_mv
;

558 
cuºSli˚
->
Æl_mv
[
LIST_1
][0][0][
block_y
][
block_x
] = 
zîo_mv
;

560 
dúe˘_ªf_idx
[
LIST_0
] = dúe˘_ªf_idx[
LIST_1
] = 0;

562 i‡(
p_Vid
->
a˘ive_µs
->
weighãd_bùªd_idc
 == 1)

563 
	`ã°_vÆid_dúe˘
(
cuºSli˚
, cuºSli˚->
a˘ive_•s
, 
dúe˘_ªf_idx
, 0, 0, 
pic_block_y
, 
pic_block_x
);

565 
cuºSli˚
->
dúe˘_pdú
[
pic_block_y
][
pic_block_x
] = 2;

569 i‡(
l0_ªfX
 =0 || 
l1_ªfX
 == 0)

571 (*
gë_cﬁoˇãd
)(
Ma¸oblock
 *
cuºMB
, 
St‹abÀPi˘uª
 *
li°1
, 
i
, 
j
) =

572 
p_Vid
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
 ? 
gë_cﬁoˇãd_öfo
 : 
gë_cﬁoˇãd_öfo_4x4
;

574 
is_movög_block
;

575 
block_y
 = 0; block_y < 4; block_y++)

577 
pic_block_y
 = 
cuºMB
->
block_y
 + block_y;

578 
›ic_block_y
 = (
cuºMB
->
›ix_y
 >> 2Ë+ 
block_y
;

580 
block_x
=0; block_x<4; block_x++)

582 
pic_block_x
 = 
cuºMB
->
block_x
 + block_x;

583 
dúe˘_ªf_idx
 = 
cuºSli˚
->dúe˘_ªf_idx[
pic_block_y
][
pic_block_x
];

584 
›ic_block_x
 = (
cuºMB
->
pix_x
 >> 2Ë+ 
block_x
;

586 
Æl_mvs
 = 
cuºSli˚
->
Æl_mv
;

587 
is_movög_block
 = (
	`gë_cﬁoˇãd
(
cuºMB
, 
li°1
[0], 
›ic_block_x
, 
›ic_block_y
) == 0);

589 i‡(
l0_ªfX
 < 0)

591 
Æl_mvs
[
LIST_0
][0][0][
block_y
][
block_x
] = 
zîo_mv
;

592 
dúe˘_ªf_idx
[
LIST_0
] = -1;

594 i‡((
l0_ªfX
 =0Ë&& 
is_movög_block
)

596 
Æl_mvs
[
LIST_0
][0][0][
block_y
][
block_x
] = 
zîo_mv
;

597 
dúe˘_ªf_idx
[
LIST_0
] = 0;

601 
Æl_mvs
[
LIST_0
][(Ë
l0_ªfX
][0][
block_y
][
block_x
] = 
pmvfw
;

602 
dúe˘_ªf_idx
[
LIST_0
] = ()
l0_ªfX
;

605 i‡(
l1_ªfX
 < 0)

607 
Æl_mvs
[
LIST_1
][0][0][
block_y
][
block_x
] = 
zîo_mv
;

608 
dúe˘_ªf_idx
[
LIST_1
] = -1;

610 if((
l1_ªfX
 =0Ë&& 
is_movög_block
)

612 
Æl_mvs
[
LIST_1
][0][0][
block_y
][
block_x
] = 
zîo_mv
;

613 
dúe˘_ªf_idx
[
LIST_1
] = 0;

617 
Æl_mvs
[
LIST_1
][(Ë
l1_ªfX
][0][
block_y
][
block_x
] = 
pmvbw
;

618 
dúe˘_ªf_idx
[
LIST_1
] = ()
l1_ªfX
;

621 i‡(
dúe˘_ªf_idx
[
LIST_1
] == -1)

622 
cuºSli˚
->
dúe˘_pdú
[
pic_block_y
][
pic_block_x
] = 0;

623 i‡(
dúe˘_ªf_idx
[
LIST_0
] == -1)

624 
cuºSli˚
->
dúe˘_pdú
[
pic_block_y
][
pic_block_x
] = 1;

625 i‡(
p_Vid
->
a˘ive_µs
->
weighãd_bùªd_idc
 == 1)

626 
	`ã°_vÆid_dúe˘
(
cuºSli˚
, cuºSli˚->
a˘ive_•s
, 
dúe˘_ªf_idx
, 
l0_ªfX
, 
l1_ªfX
, 
pic_block_y
, 
pic_block_x
);

628 
cuºSli˚
->
dúe˘_pdú
[
pic_block_y
][
pic_block_x
] = 2;

634 
block_y
=0; block_y<4; block_y++)

636 
pic_block_y
 = 
cuºMB
->
block_y
 + block_y;

638 
block_x
=0; block_x<4; block_x++)

640 
pic_block_x
 = 
cuºMB
->
block_x
 + block_x;

641 
dúe˘_ªf_idx
 = 
cuºSli˚
->dúe˘_ªf_idx[
pic_block_y
][
pic_block_x
];

643 
Æl_mvs
 = 
cuºSli˚
->
Æl_mv
;

645 i‡(
l0_ªfX
 > 0)

647 
Æl_mvs
[
LIST_0
][(Ë
l0_ªfX
][0][
block_y
][
block_x
] = 
pmvfw
;

648 
dúe˘_ªf_idx
[
LIST_0
]()
l0_ªfX
;

652 
Æl_mvs
[
LIST_0
][0][0][
block_y
][
block_x
] = 
zîo_mv
;

653 
dúe˘_ªf_idx
[
LIST_0
]=-1;

656 i‡(
l1_ªfX
 > 0)

658 
Æl_mvs
[
LIST_1
][(Ë
l1_ªfX
][0][
block_y
][
block_x
] = 
pmvbw
;

659 
dúe˘_ªf_idx
[
LIST_1
] = ()
l1_ªfX
;

663 
Æl_mvs
[
LIST_1
][0][0][
block_y
][
block_x
] = 
zîo_mv
;

664 
dúe˘_ªf_idx
[
LIST_1
] = -1;

667 i‡(
dúe˘_ªf_idx
[
LIST_1
] == -1)

668 
cuºSli˚
->
dúe˘_pdú
[
pic_block_y
][
pic_block_x
] = 0;

669 i‡(
dúe˘_ªf_idx
[
LIST_0
] == -1)

670 
cuºSli˚
->
dúe˘_pdú
[
pic_block_y
][
pic_block_x
] = 1;

671 i‡(
p_Vid
->
a˘ive_µs
->
weighãd_bùªd_idc
 == 1)

672 
	`ã°_vÆid_dúe˘
(
cuºSli˚
, cuºSli˚->
a˘ive_•s
, 
dúe˘_ªf_idx
, 
l0_ªfX
, 
l1_ªfX
, 
pic_block_y
, 
pic_block_x
);

674 
cuºSli˚
->
dúe˘_pdú
[
pic_block_y
][
pic_block_x
] = 2;

678 
	}
}

687 
	$Gë_Dúe˘_MV_S∑tül_MBAFF
 (
Ma¸oblock
 *
cuºMB
)

689 
l0_ªfA
, 
l0_ªfB
, 
l0_ªfC
;

690 
l1_ªfA
, 
l1_ªfB
, 
l1_ªfC
;

691 
l0_ªfX
,
l1_ªfX
;

692 
MŸi⁄Ve˘‹
 
pmvfw
 = 
zîo_mv
, 
pmvbw
 = zero_mv;

694 
block_x
, 
block_y
, 
pic_block_x
, 
pic_block_y
, 
›ic_block_x
, 
›ic_block_y
;

695 
MŸi⁄Ve˘‹
 *****
Æl_mvs
;

696 *
dúe˘_ªf_idx
;

697 
is_movög_block
;

698 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

699 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

700 
PicMŸi⁄P¨ams
 **
mv_öfo
 = 
p_Vid
->
íc_pi˘uª
->mv_info;

701 
St‹abÀPi˘uª
 **
li°1
 = 
cuºSli˚
->
li°X
[
LIST_1
 + 
cuºMB
->
li°_off£t
];

703 (*
gë_cﬁoˇãd
)(
Ma¸oblock
 *
cuºMB
, 
St‹abÀPi˘uª
 *
li°1
, 
i
, 
j
) =

704 
p_Vid
->
a˘ive_•s
->
dúe˘_8x8_ö„ªn˚_Êag
 ? 
gë_cﬁoˇãd_öfo
 : 
gë_cﬁoˇãd_öfo_4x4
;

706 
PixñPos
 
mb
[4];

707 
	`gë_√ighb‹s
(
cuºMB
, 
mb
, 0, 0, 16);

710 i‡(
cuºMB
->
mb_fõld
)

712 
	`£t_dúe˘_ª„ªn˚s_mb_fõld
(&
mb
[0], &
l0_ªfA
, &
l1_ªfA
, 
mv_öfo
, 
p_Vid
->
mb_d©a
);

713 
	`£t_dúe˘_ª„ªn˚s_mb_fõld
(&
mb
[1], &
l0_ªfB
, &
l1_ªfB
, 
mv_öfo
, 
p_Vid
->
mb_d©a
);

714 
	`£t_dúe˘_ª„ªn˚s_mb_fõld
(&
mb
[2], &
l0_ªfC
, &
l1_ªfC
, 
mv_öfo
, 
p_Vid
->
mb_d©a
);

718 
	`£t_dúe˘_ª„ªn˚s_mb_‰ame
(&
mb
[0], &
l0_ªfA
, &
l1_ªfA
, 
mv_öfo
, 
p_Vid
->
mb_d©a
);

719 
	`£t_dúe˘_ª„ªn˚s_mb_‰ame
(&
mb
[1], &
l0_ªfB
, &
l1_ªfB
, 
mv_öfo
, 
p_Vid
->
mb_d©a
);

720 
	`£t_dúe˘_ª„ªn˚s_mb_‰ame
(&
mb
[2], &
l0_ªfC
, &
l1_ªfC
, 
mv_öfo
, 
p_Vid
->
mb_d©a
);

723 
l0_ªfX
 = (Ë
	`imö
(imö((Ë
l0_ªfA
, (Ë
l0_ªfB
), (Ë
l0_ªfC
);

724 
l1_ªfX
 = (Ë
	`imö
(imö((Ë
l1_ªfA
, (Ë
l1_ªfB
), (Ë
l1_ªfC
);

726 i‡(
l0_ªfX
 >=0)

727 
cuºMB
->
	`GëMVPªdi˘‹
 (cuºMB, 
mb
, &
pmvfw
, 
l0_ªfX
, 
mv_öfo
, 
LIST_0
, 0, 0, 16, 16);

729 i‡(
l1_ªfX
 >=0)

730 
cuºMB
->
	`GëMVPªdi˘‹
 (cuºMB, 
mb
, &
pmvbw
, 
l1_ªfX
, 
mv_öfo
, 
LIST_1
, 0, 0, 16, 16);

732 
block_y
=0; block_y<4; block_y++)

734 
pic_block_y
 = 
cuºMB
->
block_y
 + block_y;

735 
›ic_block_y
 = (
cuºMB
->
›ix_y
 >> 2Ë+ 
block_y
;

737 
block_x
=0; block_x<4; block_x++)

739 
pic_block_x
 = 
cuºMB
->
block_x
 + block_x;

740 
dúe˘_ªf_idx
 = 
cuºSli˚
->dúe˘_ªf_idx[
pic_block_y
][
pic_block_x
];

741 
›ic_block_x
 = (
cuºMB
->
pix_x
 >> 2Ë+ 
block_x
;

742 
is_movög_block
 = (
	`gë_cﬁoˇãd
(
cuºMB
, 
li°1
[0], 
›ic_block_x
, 
›ic_block_y
) == 0);

744 
Æl_mvs
 = 
cuºSli˚
->
Æl_mv
;

746 i‡(
l0_ªfX
 >=0)

748 i‡(!
l0_ªfX
 && 
is_movög_block
)

750 
Æl_mvs
[
LIST_0
][0][0][
block_y
][
block_x
] = 
zîo_mv
;

751 
dúe˘_ªf_idx
[
LIST_0
] = 0;

755 
Æl_mvs
[
LIST_0
][(Ë
l0_ªfX
][0][
block_y
][
block_x
] = 
pmvfw
;

756 
dúe˘_ªf_idx
[
LIST_0
] = ()
l0_ªfX
;

761 
Æl_mvs
[
LIST_0
][0][0][
block_y
][
block_x
] = 
zîo_mv
;

762 
dúe˘_ªf_idx
[
LIST_0
] = -1;

765 i‡(
l1_ªfX
 >=0)

767 if(
l1_ªfX
==0 && 
is_movög_block
)

769 
Æl_mvs
[
LIST_1
][0][0][
block_y
][
block_x
] = 
zîo_mv
;

770 
dúe˘_ªf_idx
[
LIST_1
] = ()
l1_ªfX
;

774 
Æl_mvs
[
LIST_1
][(Ë
l1_ªfX
][0][
block_y
][
block_x
] = 
pmvbw
;

775 
dúe˘_ªf_idx
[
LIST_1
] = ()
l1_ªfX
;

780 
Æl_mvs
[
LIST_1
][0][0][
block_y
][
block_x
] = 
zîo_mv
;

781 
dúe˘_ªf_idx
[
LIST_1
] = -1;

787 i‡((
	`out_of_bounds_mvs
(
p_Vid
, &
Æl_mvs
[
LIST_0
][
l0_ªfX
 < 0? 0 :Ü0_ªfX][0][
block_y
][
block_x
])

788 || 
	`out_of_bounds_mvs
(
p_Vid
, &
Æl_mvs
[
LIST_1
][
l1_ªfX
 < 0? 0 :Ü1_ªfX][0][
block_y
][
block_x
])))

790 
dúe˘_ªf_idx
[
LIST_0
] = -1;

791 
dúe˘_ªf_idx
[
LIST_1
] = -1;

792 
cuºSli˚
->
dúe˘_pdú
 [
pic_block_y
][
pic_block_x
] = -1;

796 i‡(
l0_ªfX
 < 0 && 
l1_ªfX
 < 0)

798 
dúe˘_ªf_idx
[
LIST_0
] = dúe˘_ªf_idx[
LIST_1
] = 0;

799 
l0_ªfX
 = 0;

800 
l1_ªfX
 = 0;

803 i‡(
dúe˘_ªf_idx
[
LIST_1
] == -1)

804 
cuºSli˚
->
dúe˘_pdú
[
pic_block_y
][
pic_block_x
] = 0;

805 i‡(
dúe˘_ªf_idx
[
LIST_0
] == -1)

806 
cuºSli˚
->
dúe˘_pdú
[
pic_block_y
][
pic_block_x
] = 1;

807 i‡(
p_Vid
->
a˘ive_µs
->
weighãd_bùªd_idc
 == 1)

808 
	`ã°_vÆid_dúe˘
(
cuºSli˚
, cuºSli˚->
a˘ive_•s
, 
dúe˘_ªf_idx
, 
l0_ªfX
, 
l1_ªfX
, 
pic_block_y
, 
pic_block_x
);

810 
cuºSli˚
->
dúe˘_pdú
[
pic_block_y
][
pic_block_x
] = 2;

814 
	}
}

	@lencod/src/mv_search.c

24 
	~"c⁄åibut‹s.h
"

26 
	~<m©h.h
>

27 
	~<limôs.h
>

28 
	~<time.h
>

30 
	~"globÆ.h
"

32 
	~"image.h
"

33 
	~"mv_£¨ch.h
"

34 
	~"ªfbuf.h
"

35 
	~"memÆloc.h
"

36 
	~"mb_ac˚ss.h
"

37 
	~"ma¸oblock.h
"

38 
	~"mc_¥edi˘i⁄.h
"

39 
	~"c⁄f‹m™˚.h
"

40 
	~"mode_decisi⁄.h
"

43 
	~"me_di°‹ti⁄.h
"

44 
	~"me_di°‹ti⁄_Ÿf.h
"

47 
	~"me_ïzs.h
"

48 
	~"me_ïzs_öt.h
"

49 
	~"me_fuŒÁ°.h
"

50 
	~"me_fuŒÁ°_Ÿf.h
"

51 
	~"me_fuŒ£¨ch.h
"

52 
	~"me_umhex.h
"

53 
	~"me_umhexsmp.h
"

54 
	~"rdoq.h
"

57 c⁄° 
	gbx0
[5][4] = {{0,0,0,0}, {0,0,0,0}, {0,0,0,0}, {0,2,0,0}, {0,2,0,2}};

58 c⁄° 
	gby0
[5][4] = {{0,0,0,0}, {0,0,0,0}, {0,2,0,0}, {0,0,0,0}, {0,0,2,2}};

61 
di°blk
 
GëSkùCo°MB
 (
Ma¸oblock
 *
cuºMB
, 
œmbda
);

62 
di°blk
 
BiPªdBlockMŸi⁄Sórch
(
Ma¸oblock
 *
cuºMB
, 
MEBlock
 *, 
MŸi⁄Ve˘‹
*, , , *);

70 
	$gë_£¨ch_ønge
(
MEBlock
 *
mv_block
, 
I≈utP¨amëîs
 *
p_I≈
, 
ªf
, 
blockty≥
)

72 
SórchWödow
 *
£¨chR™ge
 = &
mv_block
->searchRange;

74 *
£¨chR™ge
 = 
mv_block
->
p_Vid
->searchRange;

76 i‡(
p_I≈
->
fuŒ_£¨ch
 == 1)

78 
sˇÀ
 = (
	`imö
(
ªf
, 1) + 1);

79 
£¨chR™ge
->
mö_x
 /
sˇÀ
;

80 
£¨chR™ge
->
max_x
 /
sˇÀ
;

81 
£¨chR™ge
->
mö_y
 /
sˇÀ
;

82 
£¨chR™ge
->
max_y
 /
sˇÀ
;

84 i‡(
p_I≈
->
fuŒ_£¨ch
 != 2)

86 
sˇÀ
 = ((
	`imö
(
ªf
, 1Ë+ 1Ë* imö(2, 
blockty≥
));

87 
£¨chR™ge
->
mö_x
 /
sˇÀ
;

88 
£¨chR™ge
->
max_x
 /
sˇÀ
;

89 
£¨chR™ge
->
mö_y
 /
sˇÀ
;

90 
£¨chR™ge
->
max_y
 /
sˇÀ
;

92 
	}
}

100 
ölöe
 
	$£t_me_∑ømëîs
–
PicMŸi⁄P¨ams
 **
mŸi⁄
, c⁄° 
MŸi⁄Ve˘‹
 *
Æl_mv
, 
li°
, 
ªf
, 
°ï_h
, 
°ï_v
, 
pic_block_y
, 
pic_block_x
)

102 
i
, 
j
;

105 
j
 = 
pic_block_y
; j <Öic_block_y + 
°ï_v
; j++)

107 
i
=
pic_block_x
; i<pic_block_x + 
°ï_h
; i++)

109 
mŸi⁄
[
j
][
i
].
mv
[
li°
] = *
Æl_mv
;

110 
mŸi⁄
[
j
][
i
].
ªf_idx
[
li°
] = 
ªf
;

113 
	}
}

121 
	$£t_ac˚ss_mëhod
(*
ac˚ss_mëhod
, 
MŸi⁄Ve˘‹
 *
blk
, 
mö_x
, 
mö_y
, 
max_x
, 
max_y
)

123 i‡–(
blk
->
mv_x
 > 
mö_x
Ë&& (blk->mv_x < 
max_x
Ë&& (blk->
mv_y
 > 
mö_y
Ë&& (blk->mv_y < 
max_y
))

125 *
ac˚ss_mëhod
 = 
FAST_ACCESS
;

129 *
ac˚ss_mëhod
 = 
UMV_ACCESS
;

131 
	}
}

139 
	$öô_ME_ígöe
(
Ma¸oblock
 *
cuºMB
)

141 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

142 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

143 
p_I≈
->
SórchMode
[
p_Vid
->
võw_id
])

145 
EPZS
:

146 
	`EPZS_£tup_ígöe
(
cuºMB
, 
p_I≈
);

148 
UM_HEX
:

149 
cuºMB
->
I¡PñME
 = 
UMHEXI¡egîPñBlockMŸi⁄Sórch
;

150 
cuºMB
->
BiPªdME
 = 
UMHEXBùªdI¡egîPñBlockMŸi⁄Sórch
;

151 
cuºMB
->
SubPñBiPªdME
 = 
sub_≥l_bùªd_mŸi⁄_e°im©i⁄
;

152 
cuºMB
->
SubPñME
 = 
UMHEXSubPñBlockME
;

154 
UM_HEX_SIMPLE
:

155 
cuºMB
->
I¡PñME
 = 
smpUMHEXI¡egîPñBlockMŸi⁄Sórch
;

156 
cuºMB
->
BiPªdME
 = 
smpUMHEXBùªdI¡egîPñBlockMŸi⁄Sórch
;

157 
cuºMB
->
SubPñBiPªdME
 = 
sub_≥l_bùªd_mŸi⁄_e°im©i⁄
;

158 
cuºMB
->
SubPñME
 = 
smpUMHEXSubPñBlockME
;

160 
FULL_SEARCH
:

161 
cuºMB
->
I¡PñME
 = 
fuŒ_£¨ch_mŸi⁄_e°im©i⁄
;

162 
cuºMB
->
BiPªdME
 = 
fuŒ_£¨ch_bùªd_mŸi⁄_e°im©i⁄
;

163 
cuºMB
->
SubPñBiPªdME
 = 
sub_≥l_bùªd_mŸi⁄_e°im©i⁄
;

164 
cuºMB
->
SubPñME
 = 
sub_≥l_mŸi⁄_e°im©i⁄
;

166 
FAST_FULL_SEARCH
:

168 
cuºMB
->
I¡PñME
 = 
Á°_fuŒ_£¨ch_mŸi⁄_e°im©i⁄
;

169 
cuºMB
->
BiPªdME
 = 
fuŒ_£¨ch_bùªd_mŸi⁄_e°im©i⁄
;

170 
cuºMB
->
SubPñBiPªdME
 = 
sub_≥l_bùªd_mŸi⁄_e°im©i⁄
;

171 
cuºMB
->
SubPñME
 = 
sub_≥l_mŸi⁄_e°im©i⁄
;

172 
cuºMB
->
p_SëupFa°FuŒPñSórch
 = (
p_I≈
->
OnTheFlyFø˘MCP
Ë? (
SëupFa°FuŒPñSórch_Ÿf
):(
£tup_Á°_fuŒ_£¨ch
);

175 
	}
}

183 
	$Pª∑ªMEP¨ams
(
Sli˚
 *
cuºSli˚
, 
MEBlock
 *
mv_block
, 
ChromaMEE«bÀ
, 
li°
, 
ªf
)

185 i‡(
mv_block
->
≠∂y_weights
)

187 
mv_block
->
weight_luma
 = 
cuºSli˚
->
wp_weight
[
li°
][
ªf
][0];

188 
mv_block
->
off£t_luma
 = 
cuºSli˚
->
wp_off£t
[
li°
][
ªf
][0];

190 i‡–
ChromaMEE«bÀ
)

192 
mv_block
->
weight_¸
[0] = 
cuºSli˚
->
wp_weight
[
li°
][
ªf
][1];

193 
mv_block
->
weight_¸
[1] = 
cuºSli˚
->
wp_weight
[
li°
][
ªf
][2];

194 
mv_block
->
off£t_¸
[0] = 
cuºSli˚
->
wp_off£t
[
li°
][
ªf
][1];

195 
mv_block
->
off£t_¸
[1] = 
cuºSli˚
->
wp_off£t
[
li°
][
ªf
][2];

198 
	}
}

206 
	$Pª∑ªBiPªdMEP¨ams
(
Sli˚
 *
cuºSli˚
, 
MEBlock
 *
mv_block
, 
ChromaMEE«bÀ
, 
li°
, 
li°_off£t
, 
ªf
)

208 i‡(
mv_block
->
≠∂y_weights
)

210 i‡(
li°
 =
LIST_0
)

212 
mv_block
->
weight1
 = 
cuºSli˚
->
wbp_weight
[
li°_off£t
 ][
ªf
][0][0];

213 
mv_block
->
weight2
 = 
cuºSli˚
->
wbp_weight
[
li°_off£t
 + 
LIST_1
][
ªf
][0][0];

214 
mv_block
->
off£tBi
 = (
cuºSli˚
->
wp_off£t
[
li°_off£t
 ][
ªf
][0] + cuºSli˚->wp_off£t[li°_off£à+ 
LIST_1
][ref][0] + 1)>>1;

216 i‡–
ChromaMEE«bÀ
)

218 
mv_block
->
weight1_¸
[0] = 
cuºSli˚
->
wbp_weight
[
li°_off£t
 ][
ªf
][0][1];

219 
mv_block
->
weight1_¸
[1] = 
cuºSli˚
->
wbp_weight
[
li°_off£t
 ][
ªf
][0][2];

220 
mv_block
->
weight2_¸
[0] = 
cuºSli˚
->
wbp_weight
[
li°_off£t
 + 
LIST_1
][
ªf
][0][1];

221 
mv_block
->
weight2_¸
[1] = 
cuºSli˚
->
wbp_weight
[
li°_off£t
 + 
LIST_1
][
ªf
][0][2];

223 
mv_block
->
off£tBi_¸
[0] = (
cuºSli˚
->
wp_off£t
[
li°_off£t
 ][
ªf
][1] + cuºSli˚->wp_off£t[li°_off£à+ 
LIST_1
][ref][1] + 1) >> 1;

224 
mv_block
->
off£tBi_¸
[1] = (
cuºSli˚
->
wp_off£t
[
li°_off£t
 ][
ªf
][2] + cuºSli˚->wp_off£t[li°_off£à+ 
LIST_1
][ref][2] + 1) >> 1;

229 
mv_block
->
weight1
 = 
cuºSli˚
->
wbp_weight
[
li°_off£t
 + 
LIST_1
][0 ][
ªf
][0];

230 
mv_block
->
weight2
 = 
cuºSli˚
->
wbp_weight
[
li°_off£t
 ][0 ][
ªf
][0];

231 
mv_block
->
off£tBi
 = (
cuºSli˚
->
wp_off£t
[
li°_off£t
 + 
LIST_1
][0][0] + currSlice->wp_offset[list_offset][0][0] + 1)>>1;

233 i‡–
ChromaMEE«bÀ
)

235 
mv_block
->
weight1_¸
[0] = 
cuºSli˚
->
wbp_weight
[
li°_off£t
 + 
LIST_1
][0 ][
ªf
][1];

236 
mv_block
->
weight1_¸
[1] = 
cuºSli˚
->
wbp_weight
[
li°_off£t
 + 
LIST_1
][0 ][
ªf
][2];

237 
mv_block
->
weight2_¸
[0] = 
cuºSli˚
->
wbp_weight
[
li°_off£t
 ][0 ][
ªf
][1];

238 
mv_block
->
weight2_¸
[1] = 
cuºSli˚
->
wbp_weight
[
li°_off£t
 ][0 ][
ªf
][2];

240 
mv_block
->
off£tBi_¸
[0] = (
cuºSli˚
->
wp_off£t
[
li°_off£t
 + 
LIST_1
][0 ][1] + currSlice->wp_offset[list_offset ][0 ][1] + 1) >> 1;

241 
mv_block
->
off£tBi_¸
[1] = (
cuºSli˚
->
wp_off£t
[
li°_off£t
 + 
LIST_1
][0 ][2] + currSlice->wp_offset[list_offset ][0 ][2] + 1) >> 1;

247 
mv_block
->
weight1
 = (Ë(1 << 
cuºSli˚
->
luma_log_weight_díom
);

248 
mv_block
->
weight2
 = (Ë(1 << 
cuºSli˚
->
luma_log_weight_díom
);

249 
mv_block
->
off£tBi
 = 0;

250 i‡–
ChromaMEE«bÀ
)

252 
mv_block
->
weight1_¸
[0] = 1<<
cuºSli˚
->
chroma_log_weight_díom
;

253 
mv_block
->
weight1_¸
[1] = 1<<
cuºSli˚
->
chroma_log_weight_díom
;

254 
mv_block
->
weight2_¸
[0] = 1<<
cuºSli˚
->
chroma_log_weight_díom
;

255 
mv_block
->
weight2_¸
[1] = 1<<
cuºSli˚
->
chroma_log_weight_díom
;

256 
mv_block
->
off£tBi_¸
[0] = 0;

257 
mv_block
->
off£tBi_¸
[1] = 0;

260 
	}
}

268 
	$gë_√ighb‹s
(
Ma¸oblock
 *
cuºMB
,

269 
PixñPos
 *
block
,

270 
mb_x
,

271 
mb_y
,

272 
blocksh≠e_x


275 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

276 *
mb_size
 = 
p_Vid
->mb_size[
IS_LUMA
];

278 
	`gë4x4Neighbour
(
cuºMB
, 
mb_x
 - 1, 
mb_y
 , 
mb_size
, &
block
[0]);

279 
	`gë4x4Neighbour
(
cuºMB
, 
mb_x
, 
mb_y
 - 1, 
mb_size
, &
block
[1]);

280 
	`gë4x4Neighbour
(
cuºMB
, 
mb_x
 + 
blocksh≠e_x
, 
mb_y
 - 1, 
mb_size
, &
block
[2]);

281 
	`gë4x4Neighbour
(
cuºMB
, 
mb_x
 - 1, 
mb_y
 - 1, 
mb_size
, &
block
[3]);

283 i‡(
mb_y
 > 0)

285 i‡(
mb_x
 < 8)

287 i‡(
mb_y
 == 8 )

289 i‡(
blocksh≠e_x
 =
MB_BLOCK_SIZE
)

290 
block
[2].
avaûabÀ
 = 0;

292 i‡(
mb_x
 + 
blocksh≠e_x
 == 8)

294 
block
[2].
avaûabÀ
 = 0;

297 i‡(
mb_x
 + 
blocksh≠e_x
 =
MB_BLOCK_SIZE
)

299 
block
[2].
avaûabÀ
 = 0;

303 i‡(!
block
[2].
avaûabÀ
)

305 
block
[2] = block[3];

307 
	}
}

315 
	$öô_mŸi⁄_£¨ch_moduÀ
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

317 
bôs
;

318 
i_mö
, 
i_max
,
k
;

319 
i
, 
l
;

320 
£¨ch_ønge_‹ig
 = 
p_I≈
->
SïVõwI¡îSórch
 ? 
	`imax
–p_I≈->
£¨ch_ønge
[0],Ö_Inp->search_range[1] ) :Ö_Inp->search_range[0];

321 
£¨ch_ønge
 = 
£¨ch_ønge_‹ig
;

322 
max_£¨ch_poöts
 = 
	`imax
(9, (2 * 
£¨ch_ønge
 + 1) * (2 * search_range + 1));

323 
max_ªf_bôs
 = 1 + 2 * ()
	`Êo‹
(
	`log
(
	`imax
(16, 
p_Vid
->
max_num_ª„ªn˚s
 + 1)) /Üog(2) + 1e-10);

324 
max_ªf
 = (1<<((
max_ªf_bôs
>>1)+1))-1;

325 
numbî_of_sub≥l_posôi⁄s
 = 4 * (2*
£¨ch_ønge
+3);

326 
max_mv_bôs
 = 3 + 2 * ()
	`˚û
 (
	`log
(
numbî_of_sub≥l_posôi⁄s
 + 1) /Üog(2) + 1e-10);

327 
max_mvd
 = 
p_I≈
->
U£MVLimôs
? 
	`imax
(4*imax’_I≈->
SëMVXLimô
,Ö_I≈->
SëMVYLimô
), ((1<<–
max_mv_bôs
 >>1) ) - 1)): ((1<<( max_mv_bits >>1)) - 1);

329 
p_Vid
->
max_mvd
 = max_mvd;

330 
p_Vid
->
img≥l_abs_ønge
 = (
	`imax
’_Vid->
max_≥l_vÆue_comp
[0],p_Vid->max_pel_value_comp[1]) + 1) * 64;

334 i‡((
p_Vid
->
•úÆ_£¨ch
 = (
MŸi⁄Ve˘‹
*)
	`ˇŒoc
(
max_£¨ch_poöts
, (MŸi⁄Ve˘‹))Ë=
NULL
)

335 
	`no_mem_exô
("init_motion_search_module:Ö_Vid->spiral_search");

336 i‡((
p_Vid
->
•úÆ_h≥l_£¨ch
 = (
MŸi⁄Ve˘‹
*)
	`ˇŒoc
(
max_£¨ch_poöts
, (MŸi⁄Ve˘‹))Ë=
NULL
)

337 
	`no_mem_exô
("init_motion_search_module:Ö_Vid->spiral_hpel_search");

338 i‡((
p_Vid
->
•úÆ_q≥l_£¨ch
 = (
MŸi⁄Ve˘‹
*)
	`ˇŒoc
(
max_£¨ch_poöts
, (MŸi⁄Ve˘‹))Ë=
NULL
)

339 
	`no_mem_exô
("init_motion_search_module:Ö_Vid->spiral_qpel_search");

342 i‡((
p_Vid
->
mvbôs
 = (*)
	`ˇŒoc
(2 * 
max_mvd
 + 1, ())Ë=
NULL
)

343 
	`no_mem_exô
("init_motion_search_module:Ö_Vid->mvbits");

345 i‡((
p_Vid
->
ªfbôs
 = (*)
	`ˇŒoc
(
max_ªf
, ())Ë=
NULL
)

346 
	`no_mem_exô
("init_motion_search_module:Ö_Vid->refbits");

348 #i‡(
JM_MEM_DISTORTION
)

349 i‡((
p_Vid
->
img≥l_abs
 = (*)
	`ˇŒoc
’_Vid->
img≥l_abs_ønge
, ())Ë=
NULL
)

350 
	`no_mem_exô
("init_motion_search_module:Ö_Vid->imgpel_abs");

351 i‡((
p_Vid
->
img≥l_quad
 = (*)
	`ˇŒoc
’_Vid->
img≥l_abs_ønge
, ())Ë=
NULL
)

352 
	`no_mem_exô
("init_motion_search_module:Ö_Vid->imgpel_quad");

353 
p_Vid
->
img≥l_abs
 +p_Vid->
img≥l_abs_ønge
 / 2;

354 
p_Vid
->
img≥l_quad
 +p_Vid->
img≥l_abs_ønge
 / 2;

357 i‡(
p_Vid
->
max_num_ª„ªn˚s
)

358 
	`gë_mem4Ddi°blk
 (&
p_Vid
->
mŸi⁄_co°
, 8, 2,Ö_Vid->
max_num_ª„ªn˚s
, 4);

361 
p_Vid
->
mvbôs
 +
max_mvd
;

366 
p_Vid
->
mvbôs
[0] = 1;

367 
bôs
 = 3; bô†<
max_mv_bôs
; bits += 2)

369 
i_max
 = (Ë(1 << (
bôs
 >> 1));

370 
i_mö
 = 
i_max
 >> 1;

372 
i
 = 
i_mö
; i < 
i_max
; i++)

373 
p_Vid
->
mvbôs
[-
i
] =Ö_Vid->mvbôs[i] = 
bôs
;

377 
p_Vid
->
ªfbôs
[0] = 1;

378 
bôs
=3; bôs<=
max_ªf_bôs
; bits+=2)

380 
i_max
 = (Ë(1 << ((
bôs
 >> 1) + 1)) - 1;

381 
i_mö
 = 
i_max
 >> 1;

383 
i
 = 
i_mö
; i < 
i_max
; i++)

384 
p_Vid
->
ªfbôs
[
i
] = 
bôs
;

387 #i‡(
JM_MEM_DISTORTION
)

389 
p_Vid
->
img≥l_abs
[0] = 0;

391 
i
=1; i<
p_Vid
->
img≥l_abs_ønge
 / 2; i++)

393 
p_Vid
->
img≥l_abs
[
i
] =Ö_Vid->imgpel_abs[-i] = i;

397 
p_Vid
->
img≥l_quad
[0] = 0;

399 
i
=1; i<
p_Vid
->
img≥l_abs_ønge
 / 2; i++)

401 
p_Vid
->
img≥l_quad
[
i
] =Ö_Vid->imgpel_quad[-i] = i * i;

406 
p_Vid
->
•úÆ_£¨ch
[0].
mv_x
 =Ö_Vid->•úÆ_£¨ch[0].
mv_y
 = 0;

407 
p_Vid
->
•úÆ_h≥l_£¨ch
[0].
mv_x
 =Ö_Vid->•úÆ_h≥l_£¨ch[0].
mv_y
 = 0;

408 
p_Vid
->
•úÆ_q≥l_£¨ch
[0].
mv_x
 =Ö_Vid->•úÆ_q≥l_£¨ch[0].
mv_y
 = 0;

410 
k
=1, 
l
=1;Ü <
	`imax
(1,
£¨ch_ønge
);Ü++)

412 
i
=-
l
+1; i<Ü; i++)

414 
p_Vid
->
•úÆ_£¨ch
[
k
].
mv_x
 = (Ë
i
;

415 
p_Vid
->
•úÆ_£¨ch
[
k
].
mv_y
 = (Ë-
l
;

416 
p_Vid
->
•úÆ_h≥l_£¨ch
[
k
].
mv_x
 = (Ë(
i
<<1);

417 
p_Vid
->
•úÆ_h≥l_£¨ch
[
k
].
mv_y
 = (Ë-(
l
<<1);

418 
p_Vid
->
•úÆ_q≥l_£¨ch
[
k
].
mv_x
 = (Ë(
i
<<2);

419 
p_Vid
->
•úÆ_q≥l_£¨ch
[
k
++].
mv_y
 = (Ë-(
l
<<2);

420 
p_Vid
->
•úÆ_£¨ch
[
k
].
mv_x
 = (Ë
i
;

421 
p_Vid
->
•úÆ_£¨ch
[
k
].
mv_y
 = (Ë
l
;

422 
p_Vid
->
•úÆ_h≥l_£¨ch
[
k
].
mv_x
 = (Ë(
i
<<1);

423 
p_Vid
->
•úÆ_h≥l_£¨ch
[
k
].
mv_y
 = (Ë(
l
<<1);

424 
p_Vid
->
•úÆ_q≥l_£¨ch
[
k
].
mv_x
 = (Ë(
i
<<2);

425 
p_Vid
->
•úÆ_q≥l_£¨ch
[
k
++].
mv_y
 = (Ë(
l
<<2);

427 
i
=-
l
; i<=l; i++)

429 
p_Vid
->
•úÆ_£¨ch
[
k
].
mv_x
 = (Ë-
l
;

430 
p_Vid
->
•úÆ_£¨ch
[
k
].
mv_y
 = (Ë
i
;

431 
p_Vid
->
•úÆ_h≥l_£¨ch
[
k
].
mv_x
 = (Ë-(
l
<<1);

432 
p_Vid
->
•úÆ_h≥l_£¨ch
[
k
].
mv_y
 = (Ë(
i
<<1);

433 
p_Vid
->
•úÆ_q≥l_£¨ch
[
k
].
mv_x
 = (Ë-(
l
<<2);

434 
p_Vid
->
•úÆ_q≥l_£¨ch
[
k
++].
mv_y
 = (Ë(
i
<<2);

435 
p_Vid
->
•úÆ_£¨ch
[
k
].
mv_x
 = (Ë
l
;

436 
p_Vid
->
•úÆ_£¨ch
[
k
].
mv_y
 = (Ë
i
;

437 
p_Vid
->
•úÆ_h≥l_£¨ch
[
k
].
mv_x
 = (Ë(
l
<<1);

438 
p_Vid
->
•úÆ_h≥l_£¨ch
[
k
].
mv_y
 = (Ë(
i
<<1);

439 
p_Vid
->
•úÆ_q≥l_£¨ch
[
k
].
mv_x
 = (Ë(
l
<<2);

440 
p_Vid
->
•úÆ_q≥l_£¨ch
[
k
++].
mv_y
 = (Ë(
i
<<2);

445 
p_Vid
->
°¨t_me_ªföemít_hp
 = (
p_I≈
->
ChromaMEE«bÀ
 =1 ||Ö_I≈->
MEEº‹Mëric
[
F_PEL
] !p_I≈->MEEº‹Mëric[
H_PEL
] ) ? 0 : 1;

446 
p_Vid
->
°¨t_me_ªföemít_qp
 = (
p_I≈
->
ChromaMEE«bÀ
 =1 ||Ö_I≈->
MEEº‹Mëric
[
H_PEL
] !p_I≈->MEEº‹Mëric[
Q_PEL
] ) ? 0 : 1;

448 
	`£À˘_di°‹ti⁄
(
p_Vid
, 
p_I≈
);

451 if–
p_I≈
->
OnTheFlyFø˘MCP
 )

453 
i
=0; i<3; i++)

455  
p_I≈
->
MEEº‹Mëric
[
i
])

457 
ERROR_SAD
:

458 
p_Vid
->
compuãUniPªd
[
i
] = 
compuãSAD_Ÿf
 ;

459 
p_Vid
->
compuãUniPªd
[
i
 + 3] = 
compuãSADWP_Ÿf
 ;

460 
p_Vid
->
compuãBiPªd1
[
i
] = 
compuãBiPªdSAD1_Ÿf
 ;

461 
p_Vid
->
compuãBiPªd2
[
i
] = 
compuãBiPªdSAD2_Ÿf
 ;

463 
ERROR_SSE
:

464 
p_Vid
->
compuãUniPªd
[
i
] = 
compuãSSE_Ÿf
;

465 
p_Vid
->
compuãUniPªd
[
i
 + 3] = 
compuãSSEWP_Ÿf
;

466 
p_Vid
->
compuãBiPªd1
[
i
] = 
compuãBiPªdSSE1_Ÿf
;

467 
p_Vid
->
compuãBiPªd2
[
i
] = 
compuãBiPªdSSE2_Ÿf
;

469 
ERROR_SATD
 :

471 
p_Vid
->
compuãUniPªd
[
i
] = 
compuãSATD_Ÿf
 ;

472 
p_Vid
->
compuãUniPªd
[
i
 + 3] = 
compuãSATDWP_Ÿf
 ;

473 
p_Vid
->
compuãBiPªd1
[
i
] = 
compuãBiPªdSATD1_Ÿf
 ;

474 
p_Vid
->
compuãBiPªd2
[
i
] = 
compuãBiPªdSATD2_Ÿf
 ;

481 
i
=0; i<3; i++)

483 
p_I≈
->
MEEº‹Mëric
[
i
])

485 
ERROR_SAD
:

486 
p_Vid
->
compuãUniPªd
[
i
] = 
compuãSAD
;

487 
p_Vid
->
compuãUniPªd
[
i
 + 3] = 
compuãSADWP
;

488 
p_Vid
->
compuãBiPªd1
[
i
] = 
compuãBiPªdSAD1
;

489 
p_Vid
->
compuãBiPªd2
[
i
] = 
compuãBiPªdSAD2
;

491 
ERROR_SSE
:

492 
p_Vid
->
compuãUniPªd
[
i
] = 
compuãSSE
;

493 
p_Vid
->
compuãUniPªd
[
i
 + 3] = 
compuãSSEWP
;

494 
p_Vid
->
compuãBiPªd1
[
i
] = 
compuãBiPªdSSE1
;

495 
p_Vid
->
compuãBiPªd2
[
i
] = 
compuãBiPªdSSE2
;

497 
ERROR_SATD
 :

499 
p_Vid
->
compuãUniPªd
[
i
] = 
compuãSATD
;

500 
p_Vid
->
compuãUniPªd
[
i
 + 3] = 
compuãSATDWP
;

501 
p_Vid
->
compuãBiPªd1
[
i
] = 
compuãBiPªdSATD1
;

502 
p_Vid
->
compuãBiPªd2
[
i
] = 
compuãBiPªdSATD2
;

507 i‡(!
p_I≈
->
I¡øProfûe
)

509 if(
p_I≈
->
SórchMode
[0] =
FAST_FULL_SEARCH
 ||Ö_Inp->SearchMode[1] == FAST_FULL_SEARCH)

510 
	`öôülize_Á°_fuŒ_£¨ch
 (
p_Vid
, 
p_I≈
);

512 i‡(
p_I≈
->
SórchMode
[0] =
UM_HEX
 ||Ö_Inp->SearchMode[1] == UM_HEX)

513 
	`UMHEX_DeföeThªshﬁd
(
p_Vid
);

515 
	}
}

524 
	$˛ór_mŸi⁄_£¨ch_moduÀ
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

529 
max_mvd
 = 
p_Vid
->max_mvd;

533 
p_Vid
->
mvbôs
 -
max_mvd
;

534 #i‡(
JM_MEM_DISTORTION
)

535 
p_Vid
->
img≥l_abs
 -p_Vid->
img≥l_abs_ønge
 / 2;

536 
p_Vid
->
img≥l_quad
 -p_Vid->
img≥l_abs_ønge
 / 2;

540 
	`‰ì
 (
p_Vid
->
•úÆ_£¨ch
);

541 
	`‰ì
 (
p_Vid
->
•úÆ_h≥l_£¨ch
);

542 
	`‰ì
 (
p_Vid
->
•úÆ_q≥l_£¨ch
);

543 
	`‰ì
 (
p_Vid
->
mvbôs
);

544 
	`‰ì
 (
p_Vid
->
ªfbôs
);

546 #i‡(
JM_MEM_DISTORTION
)

547 
	`‰ì
 (
p_Vid
->
img≥l_abs
);

548 
	`‰ì
 (
p_Vid
->
img≥l_quad
);

552 i‡(
p_Vid
->
mŸi⁄_co°
)

553 
	`‰ì_mem4Ddi°blk
 (
p_Vid
->
mŸi⁄_co°
);

555 i‡((
p_I≈
->
SórchMode
[0] =
FAST_FULL_SEARCH
 ||Ö_I≈->SórchMode[1] =FAST_FULL_SEARCHË&& (!p_I≈->
I¡øProfûe
) )

556 
	`˛ór_Á°_fuŒ_£¨ch
 (
p_Vid
);

557 
	}
}

559 
ölöe
 
	$mv_bô_co°
(
Ma¸oblock
 *
cuºMB
, 
MŸi⁄Ve˘‹
 **
Æl_mv
, 
cur_li°
, 
cur_ªf
, 
by
, 
bx
, 
°ï_v0
, 
°ï_v
, 
°ï_h0
, 
°ï_h
, 
mvd_bôs
)

561 
v
, 
h
;

562 
MŸi⁄Ve˘‹
 
¥edMV
;

563 
PixñPos
 
block
[4];

564 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

566 
v
=
by
; v<by + 
°ï_v0
; v+=
°ï_v
)

568 
h
=
bx
; h<bx + 
°ï_h0
; h+=
°ï_h
)

571 
	`gë_√ighb‹s
(
cuºMB
, 
block
, 
h
, 
v
, 
°ï_h
);

573 
cuºMB
->
	`GëMVPªdi˘‹
 (cuºMB, 
block
, &
¥edMV
, 
cur_ªf
, 
p_Vid
->
íc_pi˘uª
->
mv_öfo
, 
cur_li°
, 
h
, 
v
, 
°ï_h
, 
°ï_v
);

575 
mvd_bôs
 +
p_Vid
->
mvbôs
[ 
Æl_mv
[
v
>>2][
h
>>2].
mv_x
 - 
¥edMV
.mv_x ];

576 
mvd_bôs
 +
p_Vid
->
mvbôs
[ 
Æl_mv
[
v
>>2][
h
>>2].
mv_y
 - 
¥edMV
.mv_y ];

580  
mvd_bôs
;

581 
	}
}

589 
di°blk
 
	$BPªdP¨tôi⁄Co°
 (
Ma¸oblock
 *
cuºMB
,

590 
blockty≥
,

591 
block8x8
,

592 
ªf_l0
,

593 
ªf_l1
,

594 
œmbda_Á˘‹
,

595 
li°
)

597 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

598 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

599 
DecodedPi˘uªBuf„r
 *
p_Dpb
 = 
p_Vid
->
p_Dpb_œyî
[p_Vid->
dpb_œyî_id
];

600 
img≥l
 **
cur_img
 = 
p_Vid
->
pCurImg
;

602 
pic_pix_x
, 
pic_pix_y
;

603 
v
, 
h
;

604 
di°blk
 
mco°
;

606 
mvd_bôs
 = 0;

608 
∑πty≥
 = (Ë(
blockty≥
 < 4 ? blocktype : 4);

609 
°ï_h0
 = 
block_size
[ 
∑πty≥
][0];

610 
°ï_v0
 = 
block_size
[ 
∑πty≥
][1];

611 
°ï_h
 = 
block_size
[
blockty≥
][0];

612 
°ï_v
 = 
block_size
[
blockty≥
][1];

613 
by0_∑π
 = 
by0
[
∑πty≥
][
block8x8
] << 2;

614 
bx0_∑π
 = 
bx0
[
∑πty≥
][
block8x8
] << 2;

615 
block_size_x
 = 
block_size
[
blockty≥
][0];

616 
block_size_y
 = 
block_size
[
blockty≥
][1];

618 
MŸi⁄Ve˘‹
 **
Æl_mv_l0
 = 
cuºSli˚
->
bùªd_mv
[
li°
][
LIST_0
][
ªf_l0
][
blockty≥
];

619 
MŸi⁄Ve˘‹
 **
Æl_mv_l1
 = 
cuºSli˚
->
bùªd_mv
[
li°
][
LIST_1
][
ªf_l1
][
blockty≥
];

620 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_pred[0];

623 
mvd_bôs
 = 
	`mv_bô_co°
(
cuºMB
, 
Æl_mv_l0
, 
LIST_0
, 
ªf_l0
, 
by0_∑π
, 
bx0_∑π
, 
°ï_v0
, 
°ï_v
, 
°ï_h0
, 
°ï_h
, mvd_bits);

625 
mvd_bôs
 = 
	`mv_bô_co°
(
cuºMB
, 
Æl_mv_l1
, 
LIST_1
, 
ªf_l1
, 
by0_∑π
, 
bx0_∑π
, 
°ï_v0
, 
°ï_v
, 
°ï_h0
, 
°ï_h
, mvd_bits);

627 
mco°
 = 
	`weighãd_co°
 (
œmbda_Á˘‹
, 
mvd_bôs
);

630 
v
 = 
by0_∑π
; v < by0_∑π + 
°ï_v0
; v = (Ë(v + 
block_size_y
))

632 
h
 = 
bx0_∑π
; h < bx0_∑π + 
°ï_h0
; h = (Ë(h + 
block_size_x
))

634 
p_Dpb
->
	`pf_luma_¥edi˘i⁄_bi
 (
cuºMB
, 
h
, 
v
, 
block_size_x
, 
block_size_y
, 
blockty≥
, blockty≥, 
ªf_l0
, 
ªf_l1
, 
li°
);

639 i‡((!
cuºSli˚
->
p_I≈
->
Tønsf‹m8x8Mode
Ë|| (
blockty≥
>4))

641 
diff16
[16];

642 *
diff
;

644 
pic_pix_y
 = 
cuºMB
->
›ix_y
;

645 
pic_pix_x
 = 
cuºMB
->
pix_x
;

646 
v
 = 
by0_∑π
; v < by0_∑π + 
°ï_v0
; v += 4)

648 
h
 = 
bx0_∑π
; h < bx0_∑π + 
°ï_h0
; h += 4)

650 
diff
 = 
diff16
;

651 
	`ˇlcDif„ªn˚
(
cur_img
, 
pic_pix_x
+
h
, 
pic_pix_y
+
v
, 
mb_¥ed
, h, v, 4, 4, 
diff
);

652 
mco°
 +
p_Vid
->
	`di°‹ti⁄4x4
 (
diff16
, 
DISTBLK_MAX
);

658 
diff64
[64];

659 *
diff
;

661 
pic_pix_y
 = 
cuºMB
->
›ix_y
;

662 
pic_pix_x
 = 
cuºMB
->
pix_x
;

663 
v
 = 
by0_∑π
; v < by0_∑π + 
°ï_v0
; v += 8)

665 
h
 = 
bx0_∑π
; h < bx0_∑π + 
°ï_h0
; h += 8)

667 
diff
 = 
diff64
;

668 
	`ˇlcDif„ªn˚
(
cur_img
, 
pic_pix_x
+
h
, 
pic_pix_y
+
v
, 
mb_¥ed
, h, v, 8, 8, 
diff
);

669 
mco°
 +
p_Vid
->
	`di°‹ti⁄8x8
(
diff64
, 
DISTBLK_MAX
);

674  
mco°
;

675 
	}
}

677 
	$upd©e_mv_block
(
Ma¸oblock
 *
cuºMB
, 
MEBlock
 *
mv_block
, 
h
, 
v
)

679 
mv_block
->
block_x
 = (Ë
h
;

680 
mv_block
->
block_y
 = (Ë
v
;

681 
mv_block
->
pos_x
 = (Ë(
cuºMB
->
pix_x
 + (
h
 << 2));

682 
mv_block
->
pos_y
 = (Ë(
cuºMB
->
›ix_y
 + (
v
 << 2));

683 
mv_block
->
pos_x2
 = (Ë(mv_block->
pos_x
 >> 2);

684 
mv_block
->
pos_y2
 = (Ë(mv_block->
pos_y
 >> 2);

685 
mv_block
->
pos_x_∑dded
 = (Ë(mv_block->
pos_x
 << 2);

686 
mv_block
->
pos_y_∑dded
 = (Ë(mv_block->
pos_y
 << 2);

688 
mv_block
->
pos_¸_x
 = (Ë(mv_block->
pos_x
 >> 
cuºMB
->
p_Vid
->
shi·_¸_x
);

689 
mv_block
->
pos_¸_y
 = (Ë(mv_block->
pos_y
 >> 
cuºMB
->
p_Vid
->
shi·_¸_y
);

690 
	}
}

698 
	$öô_mv_block
(
Ma¸oblock
 *
cuºMB
, 
MEBlock
 *
mv_block
, 
blockty≥
, 
li°
, 
ªf_idx
, 
mb_x
, 
mb_y
)

700 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

701 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

702 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

703 
mv_block
->
blockty≥
 = blocktype;

704 
mv_block
->
blocksize_x
 = 
block_size
[
blockty≥
][0];

705 
mv_block
->
blocksize_y
 = 
block_size
[
blockty≥
][1];

707 
	`upd©e_mv_block
(
cuºMB
, 
mv_block
, 
mb_x
, 
mb_y
);

709 
mv_block
->
li°
 = ()Üist;

710 
mv_block
->
ªf_idx
 =Ñef_idx;

712 
mv_block
->
mv
[
LIST_0
].
mv_x
 = 0;

713 
mv_block
->
mv
[
LIST_0
].
mv_y
 = 0;

714 
mv_block
->
mv
[
LIST_1
].
mv_x
 = 0;

715 
mv_block
->
mv
[
LIST_1
].
mv_y
 = 0;

717 
mv_block
->
p_Vid
 =Ö_Vid;

718 
mv_block
->
p_Sli˚
 = 
cuºSli˚
;

719 
mv_block
->
co°
 = 
INT_MAX
;

720 
mv_block
->
£¨ch_pos2
 = 9;

721 
mv_block
->
£¨ch_pos4
 = 9;

723 i‡(
p_I≈
->
ChromaMEE«bÀ
)

724 
	`gë_mem2D≥l
(&
mv_block
->
‹ig_pic
, 3, mv_block->
blocksize_x
 * mv_block->
blocksize_y
);

726 
	`gë_mem2D≥l
(&
mv_block
->
‹ig_pic
, 1, mv_block->
blocksize_x
 * mv_block->
blocksize_y
);

728 
mv_block
->
ChromaMEE«bÀ
 = 
p_I≈
->ChromaMEEnable;

730 
mv_block
->
≠∂y_bi_weights
 = 
p_I≈
->
U£WeighãdRe„ªn˚ME
 && ((
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
Ë&& 
p_Vid
->
a˘ive_µs
->
weighãd_bùªd_idc
 != 0);

731 
mv_block
->
≠∂y_weights
 = 
p_I≈
->
U£WeighãdRe„ªn˚ME
 && ( 
cuºSli˚
->
weighãd_¥edi˘i⁄
 != 0 );

733 i‡(
p_I≈
->
ChromaMEE«bÀ
)

735 
mv_block
->
blocksize_¸_x
 = (Ë(mv_block->
blocksize_x
 >> 
p_Vid
->
shi·_¸_x
);

736 
mv_block
->
blocksize_¸_y
 = (Ë(mv_block->
blocksize_y
 >> 
p_Vid
->
shi·_¸_y
);

738 
mv_block
->
ChromaMEWeight
 = 
p_I≈
->ChromaMEWeight;

741 i‡(
mv_block
->
≠∂y_weights
)

744 i‡((
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
Ë&& (
p_Vid
->
a˘ive_µs
->
weighãd_bùªd_idc
 == 2))

746 
mv_block
->
compuãPªdFPñ
 = 
p_Vid
->
compuãUniPªd
[
F_PEL
];

747 
mv_block
->
compuãPªdHPñ
 = 
p_Vid
->
compuãUniPªd
[
H_PEL
];

748 
mv_block
->
compuãPªdQPñ
 = 
p_Vid
->
compuãUniPªd
[
Q_PEL
];

752 
mv_block
->
compuãPªdFPñ
 = 
p_Vid
->
compuãUniPªd
[
F_PEL
 + 3];

753 
mv_block
->
compuãPªdHPñ
 = 
p_Vid
->
compuãUniPªd
[
H_PEL
 + 3];

754 
mv_block
->
compuãPªdQPñ
 = 
p_Vid
->
compuãUniPªd
[
Q_PEL
 + 3];

756 
mv_block
->
compuãBiPªdFPñ
 = 
p_Vid
->
compuãBiPªd2
[
F_PEL
];

757 
mv_block
->
compuãBiPªdHPñ
 = 
p_Vid
->
compuãBiPªd2
[
H_PEL
];

758 
mv_block
->
compuãBiPªdQPñ
 = 
p_Vid
->
compuãBiPªd2
[
Q_PEL
];

762 
mv_block
->
compuãPªdFPñ
 = 
p_Vid
->
compuãUniPªd
[
F_PEL
];

763 
mv_block
->
compuãPªdHPñ
 = 
p_Vid
->
compuãUniPªd
[
H_PEL
];

764 
mv_block
->
compuãPªdQPñ
 = 
p_Vid
->
compuãUniPªd
[
Q_PEL
];

765 
mv_block
->
compuãBiPªdFPñ
 = 
p_Vid
->
compuãBiPªd1
[
F_PEL
];

766 
mv_block
->
compuãBiPªdHPñ
 = 
p_Vid
->
compuãBiPªd1
[
H_PEL
];

767 
mv_block
->
compuãBiPªdQPñ
 = 
p_Vid
->
compuãBiPªd1
[
Q_PEL
];

769 
	}
}

777 
	$‰ì_mv_block
(
MEBlock
 *
mv_block
)

779 i‡(
mv_block
->
‹ig_pic
)

781 
	`‰ì_mem2D≥l
(
mv_block
->
‹ig_pic
);

783 
	}
}

786 
	$gë_‹igöÆ_block
(
VideoP¨amëîs
 *
p_Vid
, 
MEBlock
 *
mv_block
)

791 
img≥l
 *
‹ig_pic_tmp
 = 
mv_block
->
‹ig_pic
[0];

792 
bsx
 = 
mv_block
->
blocksize_x
;

793 
pic_pix_x
 = 
mv_block
->
pos_x
;

794 
i
, 
j
;

795 
img≥l
 **
cur_img
 = &
p_Vid
->
pCurImg
[
mv_block
->
pos_y
];

797 
j
 = 0; j < 
mv_block
->
blocksize_y
; j++)

799 
	`mem˝y
(
‹ig_pic_tmp
,&
cur_img
[
j
][
pic_pix_x
], 
bsx
 * (
img≥l
));

800 
‹ig_pic_tmp
 +
bsx
;

803 i‡–
p_Vid
->
p_I≈
->
ChromaMEE«bÀ
 )

805 
bsx
 = 
mv_block
->
blocksize_¸_x
;

806 
pic_pix_x
 = 
mv_block
->
pos_¸_x
;

809  
i
 = 1; i<=2; i++)

811 
cur_img
 = &
p_Vid
->
pImgOrg
[
i
][
mv_block
->
pos_¸_y
];

812 
‹ig_pic_tmp
 = 
mv_block
->
‹ig_pic
[
i
];

813 
j
 = 0; j < 
mv_block
->
blocksize_¸_y
; j++)

815 
	`mem˝y
(
‹ig_pic_tmp
, &(
cur_img
[
j
][
pic_pix_x
]), 
bsx
 * (
img≥l
));

816 
‹ig_pic_tmp
 +
bsx
;

820 
	}
}

822 
	$CheckSórchR™ge
(
VideoP¨amëîs
 *
p_Vid
, 
MŸi⁄Ve˘‹
 *
pPªdMV
, MŸi⁄Ve˘‹ *
pSWC
, 
MEBlock
 *
mv_block
)

824 
iMaxMVD
 = 
p_Vid
->
max_mvd
 - 2;

825 
SórchWödow
 *
£¨chR™ge
 = &
mv_block
->searchRange;

826 
À·
 = 
pSWC
->
mv_x
 + 
£¨chR™ge
->
mö_x
;

827 
right
 = 
pSWC
->
mv_x
 + 
£¨chR™ge
->
max_x
;

828 
t›
 = 
pSWC
->
mv_y
 + 
£¨chR™ge
->
mö_y
;

829 
down
 = 
pSWC
->
mv_y
 + 
£¨chR™ge
->
max_y
;

831 
À·
 = 
	`iClù3
(
pPªdMV
->
mv_x
 - 
iMaxMVD
,ÖPredMV->mv_x + iMaxMVD,Üeft);

832 
right
 = 
	`iClù3
(
pPªdMV
->
mv_x
 - 
iMaxMVD
,ÖPredMV->mv_x + iMaxMVD,Ñight);

833 
t›
 = 
	`iClù3
(
pPªdMV
->
mv_y
 - 
iMaxMVD
,ÖPredMV->mv_y + iMaxMVD,Åop);

834 
down
 = 
	`iClù3
(
pPªdMV
->
mv_y
 - 
iMaxMVD
,ÖPredMV->mv_y + iMaxMVD, down);

836 if(
À·
<
right
 && 
t›
<
down
)

838 
pSWC
->
mv_x
 = (Ë((
À·
 + 
right
)>>1);

839 
pSWC
->
mv_y
 = (Ë((
t›
 + 
down
)>>1);

840 
£¨chR™ge
->
mö_x
 = 
À·
 - 
pSWC
->
mv_x
;

841 
£¨chR™ge
->
max_x
 = 
	`imö
(
pSWC
->
mv_x
-
À·
, 
right
-pSWC->mv_x);

842 
£¨chR™ge
->
mö_y
 = 
t›
 - 
pSWC
->
mv_y
;

843 
£¨chR™ge
->
max_y
 = 
	`imö
(
pSWC
->
mv_y
-
t›
, 
down
-pSWC->mv_y);

847 *
pSWC
 = *
pPªdMV
;

849 
	}
}

857 
di°blk


858 
	$BlockMŸi⁄Sórch
 (
Ma¸oblock
 *
cuºMB
,

859 
MEBlock
 *
mv_block
,

860 
mb_x
,

861 
mb_y
,

862 * 
œmbda_Á˘‹
)

866 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

867 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

868 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

870 
i
, 
j
;

871 
di°blk
 
max_vÆue
 = 
DISTBLK_MAX
;

872 
di°blk
 
mö_mco°
 = 
max_vÆue
;

873 
block_x
 = (
mb_x
>>2);

874 
block_y
 = (
mb_y
>>2);

876 
bsx
 = 
mv_block
->
blocksize_x
;

877 
bsy
 = 
mv_block
->
blocksize_y
;

879 
pic_pix_x
 = (Ë(
cuºMB
->
pix_x
 + 
mb_x
);

881 
blockty≥
 = 
mv_block
->blocktype;

882 
li°
 = 
mv_block
->list;

883 
ªf
 = 
mv_block
->
ªf_idx
;

884 
MŸi⁄Ve˘‹
 *
mv
 = &
mv_block
->mv[
li°
], 
¥ed
;

886 
MŸi⁄Ve˘‹
 **
Æl_mv
 = &
cuºSli˚
->Æl_mv[
li°
][
ªf
][
blockty≥
][
block_y
];

888 
di°blk
 *
¥evSad
 = (
p_I≈
->
SórchMode
[
p_Vid
->
võw_id
] =
EPZS
)? 
cuºSli˚
->
p_EPZS
->
di°‹ti⁄
[
li°
 + 
cuºMB
->
li°_off£t
][
blockty≥
 - 1]: 
NULL
;

890 
	`gë_√ighb‹s
(
cuºMB
, 
mv_block
->
block
, 
mb_x
, 
mb_y
, 
bsx
);

892 
	`Pª∑ªMEP¨ams
(
cuºSli˚
, 
mv_block
, 
p_I≈
->
ChromaMEE«bÀ
, 
li°
 + 
cuºMB
->
li°_off£t
, 
ªf
);

897 i‡(
blockty≥
 > 4)

898 
	`gë_‹igöÆ_block
(
p_Vid
, 
mv_block
);

903 i‡(
p_I≈
->
SórchMode
[
p_Vid
->
võw_id
] =
UM_HEX
)

905 
p_Vid
->
p_UMHex
->
UMHEX_blockty≥
 = 
blockty≥
;

906 
p_Vid
->
p_UMHex
->
bùªd_Êag
 = 0;

907 
	`UMHEXSëMŸi⁄Ve˘‹Pªdi˘‹
(
cuºMB
, &
¥ed
, 
p_Vid
->
íc_pi˘uª
->
mv_öfo
, 
ªf
, 
li°
, 
mb_x
, 
mb_y
, 
bsx
, 
bsy
, 
mv_block
);

909 i‡(
p_I≈
->
SórchMode
[
p_Vid
->
võw_id
] =
UM_HEX_SIMPLE
)

911 
	`smpUMHEX_£tup
(
cuºMB
, 
ªf
, 
li°
, 
block_y
, 
block_x
, 
blockty≥
, 
cuºSli˚
->
Æl_mv
 );

912 
cuºMB
->
	`GëMVPªdi˘‹
 (cuºMB, 
mv_block
->
block
, &
¥ed
, 
ªf
, 
p_Vid
->
íc_pi˘uª
->
mv_öfo
, 
li°
, 
mb_x
, 
mb_y
, 
bsx
, 
bsy
);

916 
cuºMB
->
	`GëMVPªdi˘‹
 (cuºMB, 
mv_block
->
block
, &
¥ed
, 
ªf
, 
p_Vid
->
íc_pi˘uª
->
mv_öfo
, 
li°
, 
mb_x
, 
mb_y
, 
bsx
, 
bsy
);

924 i‡(
p_I≈
->
EPZSSubPñGrid
)

926 *
mv
 = 
¥ed
;

930 #i‡(
JM_INT_DIVIDE
)

931 
mv
->
mv_x
 = (Ë(((
¥ed
.mv_x + 2) >> 2) * 4);

932 
mv
->
mv_y
 = (Ë(((
¥ed
.mv_y + 2) >> 2) * 4);

934 
mv
->
mv_x
 = (Ë((
¥ed
.mv_x / 4) * 4);

935 
mv
->
mv_y
 = (Ë((
¥ed
.mv_y / 4) * 4);

939 i‡(
p_I≈
->
DißbÀMEPªdi˘i⁄
 =
TRUE
)

941 
mv
->
mv_x
 = 0;

942 
mv
->
mv_y
 = 0;

945 i‡(!
p_I≈
->
rd›t
)

947 
MŸi⁄Ve˘‹
 
˚¡î
 = *
mv
;

949 
mv
->
mv_x
 = (Ë
	`iClù3
 (
mv_block
->
£¨chR™ge
.
mö_x
, mv_block->£¨chR™ge.
max_x
, mv->mv_x);

950 
mv
->
mv_y
 = (Ë
	`iClù3
 (
mv_block
->
£¨chR™ge
.
mö_y
, mv_block->£¨chR™ge.
max_y
, mv->mv_y);

952 if((
mv
->
mv_x
 !
˚¡î
.mv_xË|| (mv->
mv_y
 != center.mv_y))

953 
	`CheckSórchR™ge
(
p_Vid
, &
˚¡î
, 
mv
, 
mv_block
);

957 
	`˛ù_mv_ønge
(
p_Vid
, 0, 
mv
, 
Q_PEL
);

960 
mö_mco°
 = 
cuºMB
->
	`I¡PñME
 (cuºMB, &
¥ed
, 
mv_block
, mö_mco°, 
œmbda_Á˘‹
[
F_PEL
]);

965 
mv_block
->
ChromaMEE«bÀ
 = (
p_I≈
->ChromaMEE«bÀ =
ME_YUV_FP_SP
 ) ? 
TRUE
 : 
FALSE
;

967 i‡(!
p_I≈
->
DißbÀSub≥lME
[
p_Vid
->
võw_id
])

969 i‡(
p_I≈
->
SórchMode
[
p_Vid
->
võw_id
] !
EPZS
 || (
ªf
 =0 || 
cuºSli˚
->
°ru˘uª
 !
FRAME
 || (ª‡> 0 && 
mö_mco°
 < 3.5 * 
¥evSad
[
pic_pix_x
 >> 2])))

971 i‡–!
p_Vid
->
°¨t_me_ªföemít_hp
 )

973 
mö_mco°
 = 
max_vÆue
;

975 
mö_mco°
 = 
cuºMB
->
	`SubPñME
 (cuºMB, &
¥ed
, 
mv_block
, mö_mco°, 
œmbda_Á˘‹
);

981 
	`˛ù_mv_ønge
(
p_Vid
, 0, 
mv
, 
Q_PEL
);

983 i‡(!
p_I≈
->
rd›t
)

986 i‡(
blockty≥
 =1 && (
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
|| (cuºSli˚->¶i˚_ty≥ =
SP_SLICE
) ))

988 
di°blk
 
co°
;

989 
	`FödSkùModeMŸi⁄Ve˘‹
 (
cuºMB
);

991 
co°
 = 
	`GëSkùCo°MB
 (
cuºMB
, 
œmbda_Á˘‹
[
Q_PEL
]);

992 i‡(
co°
 < 
mö_mco°
)

994 
mö_mco°
 = 
co°
;

995 *
mv
 = 
cuºSli˚
->
Æl_mv
 [0][0][0][0][0];

1005 
i
=
block_x
; i < block_x + (
bsx
>>2); i++)

1007 
Æl_mv
[0][
i
] = *
mv
;

1011 
j
=1; j < (
bsy
>>2); j++)

1013 
	`mem˝y
(&
Æl_mv
[
j
][
block_x
], &Æl_mv[0][block_x], (
bsx
>>2Ë* (
MŸi⁄Ve˘‹
));

1018 i‡(
	`is_bùªd_íabÀd
(
p_Vid
, 
blockty≥
Ë&& (
ªf
 == 0))

1020 
	`BiPªdBlockMŸi⁄Sórch
(
cuºMB
, 
mv_block
, &
¥ed
, 
mb_x
, 
mb_y
, 
œmbda_Á˘‹
);

1023  
mö_mco°
;

1024 
	}
}

1033 
di°blk
 
	$BiPªdBlockMŸi⁄Sórch
(
Ma¸oblock
 *
cuºMB
,

1034 
MEBlock
 *
mv_block
,

1035 
MŸi⁄Ve˘‹
 *
¥ed_mv
,

1036 
mb_x
,

1037 
mb_y
,

1038 * 
œmbda_Á˘‹
)

1040 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1041 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

1042 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1043 
li°
 = 
mv_block
->list;

1044 
i
, 
j
;

1045 
bùªd_ty≥
 = 
li°
 ? 0 : 1;

1046 
MŸi⁄Ve˘‹
 ***** 
bùªd_mv
 = 
cuºSli˚
->bùªd_mv[
bùªd_ty≥
];

1047 
di°blk
 
mö_mco°bi
 = 
DISTBLK_MAX
;

1048 
MŸi⁄Ve˘‹
 *
mv
 = &
mv_block
->mv[
li°
];

1049 
MŸi⁄Ve˘‹
 
bimv
, 
ãmpmv
;

1050 
MŸi⁄Ve˘‹
 
¥ed_mv1
, 
¥ed_mv2
, 
¥ed_bi
;

1051 
MŸi⁄Ve˘‹
 *
bi_mv1
 = 
NULL
, *
bi_mv2
 = NULL;

1052 
ôîli°
 = (Ë
li°
;

1053 
block_x
 = (
mb_x
>>2);

1054 
block_y
 = (
mb_y
>>2);

1055 
blockty≥
 = 
mv_block
->blocktype;

1056 
bsx
 = 
mv_block
->
blocksize_x
;

1057 
bsy
 = 
mv_block
->
blocksize_y
;

1062 i‡(
p_I≈
->
SórchMode
[
p_Vid
->
võw_id
] =
UM_HEX
)

1064 
p_Vid
->
p_UMHex
->
bùªd_Êag
 = 1;

1065 
	`UMHEXSëMŸi⁄Ve˘‹Pªdi˘‹
(
cuºMB
, &
¥ed_bi
, 
p_Vid
->
íc_pi˘uª
->
mv_öfo
, 0, 
li°
 ^ 1, 
mb_x
, 
mb_y
, 
bsx
, 
bsy
, 
mv_block
);

1068 
cuºMB
->
	`GëMVPªdi˘‹
 (cuºMB, 
mv_block
->
block
, &
¥ed_bi
, 0, 
p_Vid
->
íc_pi˘uª
->
mv_öfo
, 
li°
 ^ 1, 
mb_x
, 
mb_y
, 
bsx
, 
bsy
);

1070 i‡((
p_I≈
->
SórchMode
[
p_Vid
->
võw_id
] !
EPZS
Ë|| (p_I≈->
EPZSSubPñGrid
 == 0))

1072 
mv
->
mv_x
 = ((mv->mv_x + 2) >> 2) * 4;

1073 
mv
->
mv_y
 = ((mv->mv_y + 2) >> 2) * 4;

1074 
bimv
.
mv_x
 = ((
¥ed_bi
.mv_x + 2) >> 2) * 4;

1075 
bimv
.
mv_y
 = ((
¥ed_bi
.mv_y + 2) >> 2) * 4;

1079 
bimv
 = 
¥ed_bi
;

1083 
mv_block
->
ôî©i⁄_no
 = 0; mv_block->ôî©i⁄_nÿ<
p_I≈
->
BiPªdMEReföemíts
; mv_block->iteration_no++)

1085 i‡(
mv_block
->
ôî©i⁄_no
 & 0x01)

1087 
¥ed_mv1
 = *
¥ed_mv
;

1088 
¥ed_mv2
 = 
¥ed_bi
;

1089 
bi_mv1
 = 
mv
;

1090 
bi_mv2
 = &
bimv
;

1091 
ôîli°
 = (Ë
li°
;

1095 
¥ed_mv1
 = 
¥ed_bi
;

1096 
¥ed_mv2
 = *
¥ed_mv
;

1097 
bi_mv1
 = &
bimv
;

1098 
bi_mv2
 = 
mv
;

1099 
ôîli°
 = (Ë(
li°
 ^ 1);

1102 
ãmpmv
 = *
bi_mv1
;

1104 
	`Pª∑ªBiPªdMEP¨ams
(
cuºSli˚
, 
mv_block
, mv_block->
ChromaMEE«bÀ
, 
ôîli°
, 
cuºMB
->
li°_off£t
, mv_block->
ªf_idx
);

1106 
mö_mco°bi
 = 
cuºMB
->
	`BiPªdME
 (cuºMB, 
ôîli°
,

1107 &
¥ed_mv1
, &
¥ed_mv2
, 
bi_mv1
, 
bi_mv2
, 
mv_block
,

1108 (
p_I≈
->
BiPªdMESórchR™ge
[
p_Vid
->
võw_id
] <<2)>>
mv_block
->
ôî©i⁄_no
, 
mö_mco°bi
, 
œmbda_Á˘‹
[
F_PEL
]);

1110 i‡(
mv_block
->
ôî©i⁄_no
 > 0 && (
ãmpmv
.
mv_x
 =
bi_mv1
->mv_xË&& (ãmpmv.
mv_y
 == bi_mv1->mv_y))

1116 i‡(!
p_I≈
->
DißbÀSub≥lME
[
p_Vid
->
võw_id
])

1118 i‡(
p_I≈
->
BiPªdMESubPñ
)

1120 i‡–!
p_Vid
->
°¨t_me_ªföemít_hp
 )

1121 
mö_mco°bi
 = 
DISTBLK_MAX
;

1122 
	`Pª∑ªBiPªdMEP¨ams
(
cuºSli˚
, 
mv_block
, mv_block->
ChromaMEE«bÀ
, 
ôîli°
, 
cuºMB
->
li°_off£t
, mv_block->
ªf_idx
);

1124 
mö_mco°bi
 = 
cuºMB
->
	`SubPñBiPªdME
 (cuºMB, 
mv_block
, 
ôîli°
, &
¥ed_mv1
, &
¥ed_mv2
, 
bi_mv1
, 
bi_mv2
, mö_mco°bi, 
œmbda_Á˘‹
);

1127 i‡(
p_I≈
->
BiPªdMESubPñ
==2)

1129 i‡–!
p_Vid
->
°¨t_me_ªföemít_qp
 )

1130 
mö_mco°bi
 = 
DISTBLK_MAX
;

1131 
	`Pª∑ªBiPªdMEP¨ams
(
cuºSli˚
, 
mv_block
, mv_block->
ChromaMEE«bÀ
, 
ôîli°
 ^ 1, 
cuºMB
->
li°_off£t
, mv_block->
ªf_idx
);

1133 
mö_mco°bi
 = 
cuºMB
->
	`SubPñBiPªdME
 (cuºMB, 
mv_block
, 
ôîli°
 ^ 1, &
¥ed_mv2
, &
¥ed_mv1
, 
bi_mv2
, 
bi_mv1
, mö_mco°bi, 
œmbda_Á˘‹
);

1137 
	`˛ù_mv_ønge
(
p_Vid
, 0, 
bi_mv1
, 
Q_PEL
);

1138 
	`˛ù_mv_ønge
(
p_Vid
, 0, 
bi_mv2
, 
Q_PEL
);

1140 
j
=
block_y
; j < block_y + (
bsy
>>2); j++)

1142 
i
=
block_x
 ; i < block_x + (
bsx
>>2); i++)

1144 
bùªd_mv
[
ôîli°
 ][(Ë
mv_block
->
ªf_idx
][
blockty≥
][
j
][
i
] = *
bi_mv1
;

1145 
bùªd_mv
[
ôîli°
 ^ 1][(Ë
mv_block
->
ªf_idx
][
blockty≥
][
j
][
i
] = *
bi_mv2
;

1150  
mö_mco°bi
;

1151 
	}
}

1159 
di°blk
 
	$BIDP¨tôi⁄Co°
 (
Ma¸oblock
 *
cuºMB
,

1160 
blockty≥
,

1161 
block8x8
,

1162 
cur_ªf
[2],

1163 
œmbda_Á˘‹
)

1165 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1166 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1167 
DecodedPi˘uªBuf„r
 *
p_Dpb
 = 
p_Vid
->
p_Dpb_œyî
[p_Vid->
dpb_œyî_id
];

1168 
img≥l
 **
cur_img
 = 
p_Vid
->
pCurImg
;

1170 
pic_pix_x
, 
pic_pix_y
;

1171 
v
, 
h
;

1172 
di°blk
 
mco°
;

1174 
mvd_bôs
 = 0;

1176 
∑πty≥
 = (
blockty≥
 < 4 ? blocktype : 4);

1177 
°ï_h0
 = 
block_size
[ 
∑πty≥
][0];

1178 
°ï_v0
 = 
block_size
[ 
∑πty≥
][1];

1179 
°ï_h
 = 
block_size
[
blockty≥
][0];

1180 
°ï_v
 = 
block_size
[
blockty≥
][1];

1181 
bx
 = 
bx0
[
∑πty≥
][
block8x8
] << 2;

1182 
by
 = 
by0
[
∑πty≥
][
block8x8
] << 2;

1183 
block_size_x
 = 
block_size
[
blockty≥
][0];

1184 
block_size_y
 = 
block_size
[
blockty≥
][1];

1186 
MŸi⁄Ve˘‹
 **
Æl_mv_l0
 = 
cuºSli˚
->
Æl_mv
 [
LIST_0
][(Ë
cur_ªf
[LIST_0]][
blockty≥
];

1187 
MŸi⁄Ve˘‹
 **
Æl_mv_l1
 = 
cuºSli˚
->
Æl_mv
 [
LIST_1
][(Ë
cur_ªf
[LIST_1]][
blockty≥
];

1188 
bùªd_me
 = 0;

1189 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_pred[0];

1190 
li°_mode
[2];

1191 
li°_mode
[0] = 
blockty≥
;

1192 
li°_mode
[1] = 
blockty≥
;

1197 
mvd_bôs
 = 
	`mv_bô_co°
(
cuºMB
, 
Æl_mv_l0
, 
LIST_0
, 
cur_ªf
[LIST_0], 
by
, 
bx
, 
°ï_v0
, 
°ï_v
, 
°ï_h0
, 
°ï_h
, mvd_bits);

1199 
mvd_bôs
 = 
	`mv_bô_co°
(
cuºMB
, 
Æl_mv_l1
, 
LIST_1
, 
cur_ªf
[LIST_1], 
by
, 
bx
, 
°ï_v0
, 
°ï_v
, 
°ï_h0
, 
°ï_h
, mvd_bits);

1201 
mco°
 = 
	`weighãd_co°
 (
œmbda_Á˘‹
, 
mvd_bôs
);

1204 
v
 = 
by
; v < by + 
°ï_v0
; v +
block_size_y
)

1206 
h
 = 
bx
; h < bx + 
°ï_h0
; h +
block_size_x
)

1208 
p_Dpb
->
	`pf_luma_¥edi˘i⁄
 (
cuºMB
, 
h
, 
v
, 
block_size_x
, 
block_size_y
, 2, 
li°_mode
, 
cur_ªf
, 
bùªd_me
);

1213 i‡((!
cuºSli˚
->
p_I≈
->
Tønsf‹m8x8Mode
Ë|| (
blockty≥
>4))

1215 
diff16
[16];

1216 *
diff
;

1218 
pic_pix_y
 = (Ë
cuºMB
->
›ix_y
;

1219 
pic_pix_x
 = (Ë
cuºMB
->
pix_x
;

1220 
v

by
; v < by + 
°ï_v0
; v +
BLOCK_SIZE
)

1222 
h
 = 
bx
; h < bx + 
°ï_h0
; h +
BLOCK_SIZE
)

1224 
diff
 = 
diff16
;

1225 
	`ˇlcDif„ªn˚
(
cur_img
, 
pic_pix_x
+
h
, 
pic_pix_y
+
v
, 
mb_¥ed
, h,v, 4, 4, 
diff
);

1226 
mco°
 +
p_Vid
->
	`di°‹ti⁄4x4
 (
diff16
, 
DISTBLK_MAX
);

1232 
diff64
[64];

1233 *
diff
;

1235 
pic_pix_y
 = (Ë
cuºMB
->
›ix_y
;

1236 
pic_pix_x
 = (Ë
cuºMB
->
pix_x
;

1237 
v

by
; v < by + 
°ï_v0
; v +
BLOCK_SIZE_8x8
)

1239 
h
 = 
bx
; h < bx + 
°ï_h0
; h +
BLOCK_SIZE_8x8
)

1241 
diff
 = 
diff64
;

1242 
	`ˇlcDif„ªn˚
(
cur_img
, 
pic_pix_x
+
h
, 
pic_pix_y
+
v
, 
mb_¥ed
, h, v, 8, 8, 
diff
);

1243 
mco°
 +
p_Vid
->
	`di°‹ti⁄8x8
(
diff64
, 
DISTBLK_MAX
);

1248  
mco°
;

1249 
	}
}

1257 
di°blk
 
	$GëSkùCo°MB
 (
Ma¸oblock
 *
cuºMB
, 
œmbda
)

1259 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1260 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1261 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

1262 
DecodedPi˘uªBuf„r
 *
p_Dpb
 = 
p_Vid
->
p_Dpb_œyî
[p_Vid->
dpb_œyî_id
];

1263 
di°blk
 
co°
 = 0;

1265 
block
;

1266 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_pred[0];

1267 
cur_ªf
[2] = {0, 0};

1268 
li°_mode
[2] = {0, 0};

1271 
p_Dpb
->
	`pf_luma_¥edi˘i⁄
 (
cuºMB
, 0, 0, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE, 0, 
li°_mode
, 
cur_ªf
, 0);

1273 i‡(
p_I≈
->
Tønsf‹m8x8Mode
 == 0)

1275 
diff16
[16];

1276 *
diff
;

1277 
block_y
, 
block_x
;

1278 
mb_x
, 
mb_y
;

1280 
pic_pix_y
 = 
cuºMB
->
›ix_y
;

1281 
pic_pix_x
 = 
cuºMB
->
pix_x
;

1283 
block
 = 0;block < 4; block++)

1285 
mb_y
 = (
block
 >> 1)<<3;

1286 
mb_x
 = (
block
 & 0x01)<<3;

1287 
block_y
 = 
mb_y
; block_y < mb_y + 8; block_y += 4)

1289 
block_x
 = 
mb_x
; block_x < mb_x + 8; block_x += 4)

1291 
diff
 = 
diff16
;

1293 
	`ˇlcDif„ªn˚
(
p_Vid
->
pCurImg
, 
pic_pix_x
+
block_x
, 
pic_pix_y
+
block_y
, 
mb_¥ed
, block_x, block_y, 4, 4, 
diff
);

1294 
co°
 +
p_Vid
->
	`di°‹ti⁄4x4
 (
diff16
, 
DISTBLK_MAX
);

1301 
diff64
[64];

1302 *
diff
;

1304 
mb_x
, 
mb_y
;

1306 
pic_pix_y
 = 
cuºMB
->
›ix_y
;

1307 
pic_pix_x
 = 
cuºMB
->
pix_x
;

1309 
block
 = 0;block < 4;block++)

1311 
mb_y
 = (
block
 >> 1)<<3;

1312 
mb_x
 = (
block
 & 0x01)<<3;

1315 
diff
 = 
diff64
;

1316 
	`ˇlcDif„ªn˚
(
p_Vid
->
pCurImg
, 
pic_pix_x
+
mb_x
, 
pic_pix_y
+
mb_y
, 
mb_¥ed
, mb_x, mb_y, 8, 8, 
diff
);

1317 
co°
 +
p_Vid
->
	`di°‹ti⁄8x8
 (
diff64
, 
DISTBLK_MAX
);

1322 
co°
 -
	`weight_co°
(
œmbda
, 8);

1324  
co°
;

1325 
	}
}

1333 
	$FödSkùModeMŸi⁄Ve˘‹
 (
Ma¸oblock
 *
cuºMB
)

1335 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1336 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1337 
PicMŸi⁄P¨ams
 **
mŸi⁄
 = 
p_Vid
->
íc_pi˘uª
->
mv_öfo
;

1338 
bx
, 
by
;

1339 
MŸi⁄Ve˘‹
 **
Æl_mv
 = 
cuºSli˚
->all_mv[0][0][0];

1341 
MŸi⁄Ve˘‹
 
pmv
;

1343 
zîoMŸi⁄Above
;

1344 
zîoMŸi⁄Le·
;

1345 
PixñPos
 
mb
[4];

1346 
a_mv_y
 = 0;

1347 
a_ªf_idx
 = 0;

1348 
b_mv_y
 = 0;

1349 
b_ªf_idx
 = 0;

1351 
	`gë_√ighb‹s
(
cuºMB
, 
mb
, 0, 0, 16);

1353 i‡(
mb
[0].
avaûabÀ
)

1355 
a_mv_y
 = 
mŸi⁄
[
mb
[0].
pos_y
][mb[0].
pos_x
].
mv
[
LIST_0
].
mv_y
;

1356 
a_ªf_idx
 = 
mŸi⁄
[
mb
[0].
pos_y
][mb[0].
pos_x
].
ªf_idx
[
LIST_0
];

1358 i‡(
cuºMB
->
mb_fõld
 && !
p_Vid
->
mb_d©a
[
mb
[0].
mb_addr
].mb_field)

1360 
a_mv_y
 /=2;

1361 
a_ªf_idx
 *=2;

1363 i‡(!
cuºMB
->
mb_fõld
 && 
p_Vid
->
mb_d©a
[
mb
[0].
mb_addr
].mb_field)

1365 
a_mv_y
 *= 2;

1366 
a_ªf_idx
 >>=1;

1370 i‡(
mb
[1].
avaûabÀ
)

1372 
b_mv_y
 = 
mŸi⁄
[
mb
[1].
pos_y
][mb[1].
pos_x
].
mv
[
LIST_0
].
mv_y
;

1373 
b_ªf_idx
 = 
mŸi⁄
[
mb
[1].
pos_y
][mb[1].
pos_x
].
ªf_idx
[
LIST_0
];

1375 i‡(
cuºMB
->
mb_fõld
 && !
p_Vid
->
mb_d©a
[
mb
[1].
mb_addr
].mb_field)

1377 
b_mv_y
 /=2;

1378 
b_ªf_idx
 *=2;

1380 i‡(!
cuºMB
->
mb_fõld
 && 
p_Vid
->
mb_d©a
[
mb
[1].
mb_addr
].mb_field)

1382 
b_mv_y
 *=2;

1383 
b_ªf_idx
 >>=1;

1387 
zîoMŸi⁄Le·
 = !
mb
[0].
avaûabÀ
 ? 1 : 
a_ªf_idx
==0 && 
mŸi⁄
[mb[0].
pos_y
][mb[0].
pos_x
].
mv
[
LIST_0
].
mv_x
 ==0 && 
a_mv_y
==0 ? 1 : 0;

1388 
zîoMŸi⁄Above
 = !
mb
[1].
avaûabÀ
 ? 1 : 
b_ªf_idx
==0 && 
mŸi⁄
[mb[1].
pos_y
][mb[1].
pos_x
].
mv
[
LIST_0
].
mv_x
 ==0 && 
b_mv_y
==0 ? 1 : 0;

1390 i‡(
zîoMŸi⁄Above
 || 
zîoMŸi⁄Le·
)

1392 
	`mem£t
(&
Æl_mv
 [0][0], 0, 16 * (
MŸi⁄Ve˘‹
));

1396 
cuºMB
->
	`GëMVPªdi˘‹
 (cuºMB, 
mb
, &
pmv
, 0, 
mŸi⁄
, 
LIST_0
, 0, 0, 16, 16);

1398 
by
 = 0;by < 4;by++)

1399 
bx
 = 0;bx < 4;bx++)

1401 
Æl_mv
 [
by
][
bx
] = 
pmv
;

1404 
	}
}

1412 
di°blk
 
	$GëDúe˘Co°8x8
 (
Ma¸oblock
 *
cuºMB
, 
block
, 
di°blk
 *
co°8x8
)

1414 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1415 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1416 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

1417 
DecodedPi˘uªBuf„r
 *
p_Dpb
 = 
p_Vid
->
p_Dpb_œyî
[p_Vid->
dpb_œyî_id
];

1418 
pic_pix_y
, 
pic_pix_x
, 
i
, 
j
;

1420 
di°blk
 
co°
 = 0;

1421 
mb_y
 = (
block
 >> 1)<<3;

1422 
mb_x
 = (
block
 & 0x01)<<3;

1423 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_pred[0];

1424 
li°_mode
[2] = {0, 0};

1427 
j
=(
cuºMB
->
›ix_y
 + 
mb_y
) >> 2; j < (currMB->opix_y + mb_y + 8) >> 2; j++)

1429 
i
=(
cuºMB
->
pix_x
 + 
mb_x
) >> 2; i < (currMB->pix_x + mb_x + 8) >> 2; i++)

1431 i‡(
cuºSli˚
->
dúe˘_pdú
[
j
][
i
] < 0)

1433 *
co°8x8
 = 
DISTBLK_MAX
;

1434  
DISTBLK_MAX
;

1440 
j
 = 
mb_y
; j < mb_y + 8; j += 4)

1442 
pic_pix_y
 = (
cuºMB
->
›ix_y
 + 
j
) >> 2;

1443 
i
 = 
mb_x
; i < mb_x + 8; i += 4)

1445 
pic_pix_x
 = (
cuºMB
->
pix_x
 + 
i
) >> 2;

1446 
p_Dpb
->
	`pf_luma_¥edi˘i⁄
 (
cuºMB
, 
i
, 
j
, 4, 4, 
cuºSli˚
->
dúe˘_pdú
[
pic_pix_y
][
pic_pix_x
],

1447 
li°_mode
, 
cuºSli˚
->
dúe˘_ªf_idx
[
pic_pix_y
][
pic_pix_x
], 0);

1451 if(
p_I≈
->
Tønsf‹m8x8Mode
)

1453 
diff16
[4][16];

1454 
diff64
[64];

1455 *
tmp64
 = 
diff64
;

1456 *
tmp16
[4];

1457 
ödex
;

1459 
tmp16
[0] = 
diff16
[0];

1460 
tmp16
[1] = 
diff16
[1];

1461 
tmp16
[2] = 
diff16
[2];

1462 
tmp16
[3] = 
diff16
[3];

1464 
pic_pix_y
 = 
cuºMB
->
›ix_y
;

1465 
pic_pix_x
 = 
cuºMB
->
pix_x
;

1468 
j
 = 
mb_y
; j < 8 + mb_y; j++)

1470 
i
 = 
mb_x
; i < 8 + mb_x; i++)

1472 
ödex
 = 2 * ((
j
 - 
mb_y
)> 3Ë+ ((
i
 - 
mb_x
)> 3);

1473 *
tmp64
++ = *(
tmp16
[
ödex
])++ = (Ë(
p_Vid
->
pCurImg
[
pic_pix_y
 + 
j
][
pic_pix_x
 + 
i
] - 
mb_¥ed
[j][i]);

1477 
co°
 +
p_Vid
->
	`di°‹ti⁄4x4
 (
diff16
[0], 
DISTBLK_MAX
);

1478 
co°
 +
p_Vid
->
	`di°‹ti⁄4x4
 (
diff16
[1], 
DISTBLK_MAX
);

1479 
co°
 +
p_Vid
->
	`di°‹ti⁄4x4
 (
diff16
[2], 
DISTBLK_MAX
);

1480 
co°
 +
p_Vid
->
	`di°‹ti⁄4x4
 (
diff16
[3], 
DISTBLK_MAX
);

1481 *
co°8x8
 +
p_Vid
->
	`di°‹ti⁄8x8
 (
diff64
, 
DISTBLK_MAX
);

1485 
block_y
, 
block_x
;

1486 
diff16
[16];

1487 *
diff
;

1489 
block_y
=
mb_y
; block_y < mb_y + 8; block_y += 4)

1491 
pic_pix_y
 = 
cuºMB
->
›ix_y
 + 
block_y
;

1493 
block_x
=
mb_x
; block_x<mb_x+8; block_x+=4)

1495 
pic_pix_x
 = 
cuºMB
->
pix_x
 + 
block_x
;

1496 
diff
 = 
diff16
;

1499 
	`ˇlcDif„ªn˚
(
p_Vid
->
pCurImg
, 
pic_pix_x
, 
pic_pix_y
, 
mb_¥ed
, 
block_x
, 
block_y
, 4, 4, 
diff
);

1500 
co°
 +
p_Vid
->
	`di°‹ti⁄4x4
 (
diff16
, 
DISTBLK_MAX
);

1505  
co°
;

1506 
	}
}

1516 
di°blk
 
	$GëDúe˘Co°MB
 (
Ma¸oblock
 *
cuºMB
)

1518 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1519 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºSli˚
->p_Inp;

1520 
i
;

1521 
di°blk
 
co°
 = 0;

1522 
di°blk
 
co°8x8
 = 0;

1523 
b¶i˚
 = 
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
;

1524 #i‡(
MVC_EXTENSION_ENABLE
)

1525 *
I¡îSórch
 = 
p_I≈
->I¡îSórch[(
cuºSli˚
->
p_Vid
->
num_of_œyîs
 > 1Ë? cuºSli˚->
võw_id
 : 0][
b¶i˚
];

1527 *
I¡îSórch
 = 
p_I≈
->I¡îSórch[0][
b¶i˚
];

1530 
i
=0; i<4; i++)

1532 
co°
 +
	`GëDúe˘Co°8x8
 (
cuºMB
, 
i
, &
co°8x8
);

1533 i‡(
co°8x8
 =
DISTBLK_MAX
)  DISTBLK_MAX;

1536 
p_I≈
->
Tønsf‹m8x8Mode
)

1539 if((
co°8x8
 < 
co°
)||

1540 !(
I¡îSórch
[5] &&

1541 
I¡îSórch
[6] &&

1542 
I¡îSórch
[7])

1545 
co°
 = 
co°8x8
;

1549 
co°
 = 
co°8x8
;

1555  
co°
;

1556 
	}
}

1564 
	$P¨tôi⁄MŸi⁄Sórch
 (
Ma¸oblock
 *
cuºMB
,

1565 
blockty≥
,

1566 
block8x8
,

1567 *
œmbda_Á˘‹
)

1569 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1570 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1572 #i‡
GET_METIME


1573 
TIME_T
 
me_time_°¨t
;

1574 
TIME_T
 
me_time_íd
;

1575 
öt64
 
me_tmp_time
;

1576 
	`gëtime
–&
me_time_°¨t
 );

1579 i‡(
cuºSli˚
->
rdoq_mŸi⁄_c›y
 == 1)

1581 
PicMŸi⁄P¨ams
 **
mŸi⁄
 = 
p_Vid
->
íc_pi˘uª
->
mv_öfo
;

1582 
by
 = 
by0
[
blockty≥
][
block8x8
];

1583 
bx
 = 
bx0
[
blockty≥
][
block8x8
];

1584 
°ï_h
 = (
∑π_size
[
blockty≥
][0]);

1585 
°ï_v
 = (
∑π_size
[
blockty≥
][1]);

1587 
pic_block_y
 = 
cuºMB
->
block_y
 + 
by
;

1588 
pic_block_x
 = 
cuºMB
->
block_x
 + 
bx
;

1589 
li°_off£t
 = 
cuºMB
->list_offset;

1590 
numli°s
 = (
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
) ? 2 : 1;

1591 
di°blk
 *
m_co°
;

1593 
li°
 = 
LIST_0
;

1594 
ªf
 = 0;

1597 
li°
 = 0;Üi° < 
numli°s
;Üist++)

1599 
ªf
=0;Ñe‡< 
cuºSli˚
->
li°Xsize
[
li°
+
li°_off£t
];Ñef++)

1601 
m_co°
 = &
p_Vid
->
mŸi⁄_co°
[
blockty≥
][
li°
][
ªf
][
block8x8
];

1604 
	`upd©eMV_mp
(
cuºMB
, 
m_co°
, 
ªf
, 
li°
, 
bx
, 
by
, 
blockty≥
, 
block8x8
);

1605 
	`£t_me_∑ømëîs
(
mŸi⁄
, &
cuºSli˚
->
Æl_mv
[
li°
][
ªf
][
blockty≥
][
by
][
bx
],Üi°, (Ëªf, 
°ï_h
, 
°ï_v
, 
pic_block_y
, 
pic_block_x
);

1611 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

1612 
by
 = 
by0
[
blockty≥
][
block8x8
];

1613 
bx
 = 
bx0
[
blockty≥
][
block8x8
];

1614 
°ï_h
 = (
∑π_size
[
blockty≥
][0]);

1615 
°ï_v
 = (
∑π_size
[
blockty≥
][1]);

1617 
pic_block_y
 = 
cuºMB
->
block_y
 + 
by
;

1618 
pic_block_x
 = 
cuºMB
->
block_x
 + 
bx
;

1619 
li°_off£t
 = 
cuºMB
->list_offset;

1620 
numli°s
 = (
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
) ? 2 : 1;

1621 
li°
 = 
LIST_0
;

1622 
ªf
 = 0;

1623 
MEBlock
 
mv_block
;

1624 
di°blk
 *
m_co°
;

1627 
PicMŸi⁄P¨ams
 **
mŸi⁄
 = 
p_Vid
->
íc_pi˘uª
->
mv_öfo
;

1630 
mv_block
.
ã°8x8
 = 
p_I≈
->
Tønsf‹m8x8Mode
;

1632 
	`öô_mv_block
(
cuºMB
, &
mv_block
, (Ë
blockty≥
, 
li°
, (Ë
ªf
, 
bx
, 
by
);

1634 i‡(
p_I≈
->
SórchMode
[
p_Vid
->
võw_id
] =
EPZS
)

1636 i‡(
p_I≈
->
EPZSSubPñGrid
)

1637 
cuºMB
->
I¡PñME
 = 
EPZS_öãgî_mŸi⁄_e°im©i⁄
;

1639 
cuºMB
->
I¡PñME
 = 
EPZS_mŸi⁄_e°im©i⁄
;

1642 
	`gë_‹igöÆ_block
(
p_Vid
, &
mv_block
);

1647 
li°
 = 0;Üi° < 
numli°s
;Üist++)

1650 
mv_block
.
li°
 = ()Üist;

1651 
ªf
=0;Ñe‡< 
cuºSli˚
->
li°Xsize
[
li°
+
li°_off£t
];Ñef++)

1653 
mv_block
.
ªf_idx
 = (Ë
ªf
;

1654 
m_co°
 = &
p_Vid
->
mŸi⁄_co°
[
blockty≥
][
li°
][
ªf
][
block8x8
];

1658 
	`gë_£¨ch_ønge
(&
mv_block
, 
p_I≈
, 
ªf
, 
blockty≥
);

1661 *
m_co°
 = 
	`BlockMŸi⁄Sórch
 (
cuºMB
, &
mv_block
, 
bx
<<2, 
by
<<2, 
œmbda_Á˘‹
);

1664 
	`£t_me_∑ømëîs
(
mŸi⁄
, &
cuºSli˚
->
Æl_mv
[
li°
][
ªf
][
blockty≥
][
by
][
bx
],Üi°, (Ëªf, 
°ï_h
, 
°ï_v
, 
pic_block_y
, 
pic_block_x
);

1669 
	`‰ì_mv_block
(&
mv_block
);

1672 #i‡
GET_METIME


1673 
	`gëtime
(&
me_time_íd
);

1674 
me_tmp_time
 = 
	`timediff
 (&
me_time_°¨t
, &
me_time_íd
);

1675 
p_Vid
->
me_tŸ_time
 +
me_tmp_time
;

1676 
p_Vid
->
me_time
 +
me_tmp_time
;

1678 
	}
}

1686 
	$SubP¨tôi⁄MŸi⁄Sórch
 (
Ma¸oblock
 *
cuºMB
,

1687 
blockty≥
,

1688 
block8x8
,

1689 *
œmbda_Á˘‹
)

1692 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1693 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1695 #i‡
GET_METIME


1696 
TIME_T
 
me_time_°¨t
;

1697 
TIME_T
 
me_time_íd
;

1698 
öt64
 
me_tmp_time
;

1699 
	`gëtime
–&
me_time_°¨t
 );

1702 i‡(
cuºSli˚
->
rdoq_mŸi⁄_c›y
 == 1)

1704 
∑πty≥
 = 4;

1705 
PicMŸi⁄P¨ams
 **
mŸi⁄
 = 
p_Vid
->
íc_pi˘uª
->
mv_öfo
;

1706 
by
 = 
by0
[
∑πty≥
][
block8x8
];

1707 
bx
 = 
bx0
[
∑πty≥
][
block8x8
];

1708 
°ï_h
 = (
∑π_size
[
blockty≥
][0]);

1709 
°ï_v
 = (
∑π_size
[
blockty≥
][1]);

1710 
li°_off£t
 = 
cuºMB
->list_offset;

1711 
numli°s
 = (
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
) ? 2 : 1;

1712 
di°blk
 *
m_co°
;

1713 
MŸi⁄Ve˘‹
 *
Æl_mv
;

1714 
li°
 = 
LIST_0
;

1715 
ªf
 = 0;

1717 
°ï_h0
 = (
∑π_size
[ 
∑πty≥
][0]);

1718 
°ï_v0
 = (
∑π_size
[ 
∑πty≥
][1]);

1720 
v
, 
h
;

1721 
pic_block_y
;

1724 
li°
 = 0;Üi° < 
numli°s
;Üist++)

1726 
ªf
=0;Ñe‡< 
cuºSli˚
->
li°Xsize
[
li°
+
li°_off£t
];Ñef++)

1728 
m_co°
 = &
p_Vid
->
mŸi⁄_co°
[
blockty≥
][
li°
][
ªf
][
block8x8
];

1731 
v
=
by
; v<by + 
°ï_v0
; v +
°ï_v
)

1733 
pic_block_y
 = 
cuºMB
->
block_y
 + 
v
;

1734 
h
=
bx
; h<bx+
°ï_h0
; h+=
°ï_h
)

1736 
Æl_mv
 = &
cuºSli˚
->Æl_mv[
li°
][
ªf
][
blockty≥
][
v
][
h
];

1738 
	`upd©eMV_mp
(
cuºMB
, 
m_co°
, 
ªf
, 
li°
, 
h
, 
v
, 
blockty≥
, 
block8x8
);

1741 
	`£t_me_∑ømëîs
(
mŸi⁄
, 
Æl_mv
, 
li°
, (Ë
ªf
, 
°ï_h
, 
°ï_v
, 
pic_block_y
, 
cuºMB
->
block_x
 + 
h
);

1749 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

1750 
PicMŸi⁄P¨ams
 **
mŸi⁄
 = 
p_Vid
->
íc_pi˘uª
->
mv_öfo
;

1751 
∑πty≥
 = 4;

1752 
by
 = 
by0
[
∑πty≥
][
block8x8
];

1753 
bx
 = 
bx0
[
∑πty≥
][
block8x8
];

1754 
°ï_h0
 = (
∑π_size
[ 
∑πty≥
][0]);

1755 
°ï_v0
 = (
∑π_size
[ 
∑πty≥
][1]);

1756 
°ï_h
 = (
∑π_size
[
blockty≥
][0]);

1757 
°ï_v
 = (
∑π_size
[
blockty≥
][1]);

1758 
li°_off£t
 = 
cuºMB
->list_offset;

1759 
numli°s
 = (
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
) ? 2 : 1;

1760 
MŸi⁄Ve˘‹
 *
Æl_mv
;

1761 
li°
 = 
LIST_0
;

1762 
ªf
 = 0;

1763 
MEBlock
 
mv_block
;

1764 
di°blk
 *
m_co°
;

1765 
di°blk
 
mco°
;

1766 
v
, 
h
;

1767 
pic_block_y
;

1770 
mv_block
.
ã°8x8
 = 
p_I≈
->
Tønsf‹m8x8Mode
 && 
blockty≥
 == 4;

1772 i‡(
p_I≈
->
SórchMode
[
p_Vid
->
võw_id
] =
EPZS
)

1774 i‡(
p_I≈
->
EPZSSubPñGrid
)

1776 i‡(
blockty≥
 > 4)

1777 
cuºMB
->
I¡PñME
 = 
EPZS_öãgî_subMB_mŸi⁄_e°im©i⁄
;

1779 
cuºMB
->
I¡PñME
 = 
EPZS_öãgî_mŸi⁄_e°im©i⁄
;

1783 i‡(
blockty≥
 > 4)

1784 
cuºMB
->
I¡PñME
 = 
EPZS_subMB_mŸi⁄_e°im©i⁄
;

1786 
cuºMB
->
I¡PñME
 = 
EPZS_mŸi⁄_e°im©i⁄
;

1790 
	`öô_mv_block
(
cuºMB
, &
mv_block
, (Ë
blockty≥
, 
li°
, (Ë
ªf
, 
bx
, 
by
);

1792 i‡(
blockty≥
 == 4)

1793 
	`gë_‹igöÆ_block
(
p_Vid
, &
mv_block
);

1796 
li°
=0;Üi°<
numli°s
;list++)

1798 
mv_block
.
li°
 = ()Üist;

1799 
ªf
=0;Ñe‡< 
cuºSli˚
->
li°Xsize
[
li°
+
li°_off£t
];Ñef++)

1801 
mv_block
.
ªf_idx
 = (Ë
ªf
;

1802 
m_co°
 = &
p_Vid
->
mŸi⁄_co°
[
blockty≥
][
li°
][
ªf
][
block8x8
];

1804 
	`gë_£¨ch_ønge
(&
mv_block
, 
p_I≈
, 
ªf
, 
blockty≥
);

1807 *
m_co°
 = 0;

1810 
v
=
by
; v<by + 
°ï_v0
; v +
°ï_v
)

1812 
pic_block_y
 = 
cuºMB
->
block_y
 + 
v
;

1814 
h
=
bx
; h<bx+
°ï_h0
; h+=
°ï_h
)

1816 
Æl_mv
 = &
cuºSli˚
->Æl_mv[
li°
][
ªf
][
blockty≥
][
v
][
h
];

1819 
	`upd©e_mv_block
(
cuºMB
, &
mv_block
, 
h
, 
v
);

1822 
	`gë_£¨ch_ønge
(&
mv_block
, 
p_I≈
, 
ªf
, 
blockty≥
);

1824 
mco°
 = 
	`BlockMŸi⁄Sórch
 (
cuºMB
, &
mv_block
, 
h
<<2, 
v
<<2, 
œmbda_Á˘‹
);

1826 *
m_co°
 +
mco°
;

1829 
	`£t_me_∑ømëîs
(
mŸi⁄
, 
Æl_mv
, 
li°
, (Ë
ªf
, 
°ï_h
, 
°ï_v
, 
pic_block_y
, 
cuºMB
->
block_x
 + 
h
);

1833 i‡((
p_I≈
->
Tønsf‹m8x8Mode
 =1Ë&&Ö_I≈->
RDOQ_CP_MV
 && (
blockty≥
 == 4))

1835 i‡(
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
)

1837 
cuºSli˚
->
tmp_mv8
[
li°
][
ªf
][
by
][
bx
] = cuºSli˚->
Æl_mv
[li°][ªf][
blockty≥
][by][bx];

1838 
cuºSli˚
->
mŸi⁄_co°8
[
li°
][
ªf
][
block8x8
] = *
m_co°
;

1842 
cuºSli˚
->
tmp_mv4
[
li°
][
ªf
][
by
][
bx
] = cuºSli˚->
Æl_mv
[li°][ªf][
blockty≥
][by][bx];

1843 
cuºSli˚
->
mŸi⁄_co°4
[
li°
][
ªf
][
block8x8
] = *
m_co°
;

1850 
	`‰ì_mv_block
(&
mv_block
);

1853 #i‡
GET_METIME


1854 
	`gëtime
(&
me_time_íd
);

1855 
me_tmp_time
 = 
	`timediff
 (&
me_time_°¨t
, &
me_time_íd
);

1856 
p_Vid
->
me_tŸ_time
 +
me_tmp_time
;

1857 
p_Vid
->
me_time
 +
me_tmp_time
;

1859 
	}
}

	@lencod/src/nal.c

18 
	~"c⁄åibut‹s.h
"

19 
	~"globÆ.h
"

20 
	~"íc_°©i°ics.h
"

21 
	~"bürõncode.h
"

22 
	~"«l.h
"

24 c⁄° 
	gMbWidthC
 [4]= { 0, 8, 8, 16};

25 c⁄° 
	gMbHeightC
 [4]= { 0, 8, 16, 16};

40 
	$SODBtoRBSP
(
Bô°ªam
 *
cuºSåóm
)

42 
cuºSåóm
->
byã_buf
 <<= 1;

43 
cuºSåóm
->
byã_buf
 |= 1;

44 
cuºSåóm
->
bôs_to_go
--;

45 
cuºSåóm
->
byã_buf
 <<cuºSåóm->
bôs_to_go
;

46 
cuºSåóm
->
°ªamBuf„r
[cuºSåóm->
byã_pos
++] = cuºSåóm->
byã_buf
;

47 
cuºSåóm
->
bôs_to_go
 = 8;

48 
cuºSåóm
->
byã_buf
 = 0;

49 
	}
}

74 
	$RBSPtoEBSP
(
byã
 *
NÆuBuf„r
, *
rb•
, 
rb•_size
)

76 
j
 = 0;

77 
cou¡
 = 0;

78 
i
;

80 
i
 = 0; i < 
rb•_size
; i++)

82 if(
cou¡
 =
ZEROBYTES_SHORTSTARTCODE
 && !(
rb•
[
i
] & 0xFC))

84 
NÆuBuf„r
[
j
] = 0x03;

85 
j
++;

86 
cou¡
 = 0;

88 
NÆuBuf„r
[
j
] = 
rb•
[
i
];

89 if(
rb•
[
i
] == 0x00)

90 
cou¡
++;

92 
cou¡
 = 0;

93 
j
++;

96  
j
;

97 
	}
}

116 
	$addCabacZîoW‹ds
(
VideoP¨amëîs
 *
p_Vid
, 
NALU_t
 *
«lu
, 
SètP¨amëîs
 *
cur_°©s
)

118 
£q_∑ømëî_£t_rb•_t
 *
a˘ive_•s
 = 
p_Vid
->active_sps;

120 
°uffög_byãs
 = 0;

121 
i
 = 0;

123 
byã
 *
buf
 = &
«lu
->buf[«lu->
Àn
];

125 
RawMbBôs
 = 256 * 
p_Vid
->
bôdïth_luma
 + 2 * 
MbWidthC
[
a˘ive_•s
->
chroma_f‹m©_idc
] * 
MbHeightC
[a˘ive_•s->chroma_f‹m©_idc] *Ö_Vid->
bôdïth_chroma
;

126 
mö_num_byãs
 = ((96 * 
	`gë_pic_bö_cou¡
(
p_Vid
)Ë- (
RawMbBôs
 * (Ì_Vid->
PicSizeInMbs
 *3) + 1023) / 1024;

128 i‡(
mö_num_byãs
 > 
p_Vid
->
byãs_ö_pi˘uª
)

130 
°uffög_byãs
 = 
mö_num_byãs
 - 
p_Vid
->
byãs_ö_pi˘uª
;

131 
	`¥ötf
 ("In£πög %d/%d cabac_zîo_w‹d sy¡axÉÀmíts/byã†(Cœu£ 7.4.2.10)\n", ((
°uffög_byãs
 + 2)/3), stuffing_bytes);

133 
i
 = 0; i < 
°uffög_byãs
; i+=3 )

135 *
buf
++ = 0x00;

136 *
buf
++ = 0x00;

137 *
buf
++ = 0x03;

139 
cur_°©s
->
bô_u£_°uffög_bôs
[
p_Vid
->
ty≥
] +(
i
<<3);

140 
«lu
->
Àn
 +
i
;

143  
i
;

144 
	}
}

	@lencod/src/nalu.c

15 
	~"globÆ.h
"

16 
	~"«lu.h
"

17 
	~"«l.h
"

44 
	$RBSPtoNALU
 (*
rb•
, 
NALU_t
 *
«lu
, 
rb•_size
, 
«l_unô_ty≥
, 
«l_ª„ªn˚_idc
, 
U£A¬exbL⁄gSèπcode
)

46 
Àn
;

48 
	`as£π
 (
«lu
 !
NULL
);

49 
	`as£π
 (
«l_ª„ªn˚_idc
 <=3 &&Çal_reference_idc >=0);

50 #i‡(
MVC_EXTENSION_ENABLE
)

51 
	`as£π
 (
«l_unô_ty≥
 > 0 &&ÇÆ_unô_ty≥ <
NALU_TYPE_SLC_EXT
);

53 
	`as£π
 (
«l_unô_ty≥
 > 0 &&ÇÆ_unô_ty≥ <
NALU_TYPE_FILL
);

55 
	`as£π
 (
rb•_size
 < 
MAXRBSPSIZE
);

57 
«lu
->
°¨tcodïªfix_Àn
 = 
U£A¬exbL⁄gSèπcode
 ? 4 : 3;

58 
«lu
->
f‹biddí_bô
 = 0;

59 
«lu
->
«l_ª„ªn˚_idc
 = (
NÆRefIdc
)Çal_reference_idc;

60 
«lu
->
«l_unô_ty≥
 = (
NÆuTy≥
)Çal_unit_type;

62 #i‡(
MVC_EXTENSION_ENABLE
)

63 if(
«l_unô_ty≥
==
NALU_TYPE_PREFIX
 ||ÇÆ_unô_ty≥==
NALU_TYPE_SLC_EXT
)

65 
«lu
->
svc_exãnsi⁄_Êag
 = 0;

67 
«lu
->
ª£rved_⁄e_bô
 = 1;

71 
«lu
->
svc_exãnsi⁄_Êag
 = 0;

75 
Àn
 = 
	`RBSPtoEBSP
 (
«lu
->
buf
, 
rb•
, 
rb•_size
);

76 
«lu
->
Àn
 =Üen;

78  
Àn
;

79 
	}
}

88 
	$Wrôe_AUD_NALU
–
VideoP¨amëîs
 *
p_Vid
 )

90 
RBSPÀn
 = 0;

91 
Àn
;

92 
byã
 
rb•
[
MAXRBSPSIZE
];

93 
NALU_t
 *
«lu
 = 
	`AŒocNALU
–
MAXNALUSIZE
 );

95  
p_Vid
->
ty≥
 )

97 
I_SLICE
:

98 
p_Vid
->
¥im¨y_pic_ty≥
 = 0;

100 
P_SLICE
:

101 
p_Vid
->
¥im¨y_pic_ty≥
 = 1;

103 
B_SLICE
:

104 
p_Vid
->
¥im¨y_pic_ty≥
 = 2;

107 
RBSPÀn
 = 1;

108 
rb•
[0] = (
byã
Ë(
p_Vid
->
¥im¨y_pic_ty≥
 << 5);

109 
rb•
[0] |= (1 << 4);

112 
	`RBSPtoNALU
–
rb•
, 
«lu
, 
RBSPÀn
, 
NALU_TYPE_AUD
, 
NALU_PRIORITY_DISPOSABLE
, 1 );

114 
Àn
 = 
p_Vid
->
	`WrôeNALU
–p_Vid, 
«lu
,Ö_Vid->
f_out
 );

116 
	`FªeNALU
–
«lu
 );

118  
Àn
;

119 
	}
}

128 
	$Wrôe_FûÀr_D©a_NALU
–
VideoP¨amëîs
 *
p_Vid
, 
num_byãs
 )

130 
RBSPÀn
 = 
num_byãs
 - 1;

131 
Àn
, 
byãs_wrôãn
 = 0;

132 
byã
 
rb•
[
MAXRBSPSIZE
];

133 
byã
 
fûÀr_byã
 = (byte)0xFF;

134 
byã
 
åaûög_byã
 = (byte)0x80;

135 
NALU_t
 *
«lu
 = 
	`AŒocNALU
–
MAXNALUSIZE
 );

137 
num_byãs
 = 
	`iClù3
–1, (
MAXRBSPSIZE
 - 2),Çum_bytes );

138 
	`as£π
–
num_byãs
 > 0 &&Çum_byã†< (
MAXRBSPSIZE
 - 1) );

140 
num_byãs
 = 
	`imax
( 2,Çum_bytes );

142 i‡–
RBSPÀn
 > 1 )

144  
byãs_wrôãn
 < (
RBSPÀn
 - 1) )

146 
rb•
[ 
byãs_wrôãn
++ ] = 
fûÀr_byã
;

149 
rb•
[ 
byãs_wrôãn
++ ] = 
åaûög_byã
;

150 
	`as£π
–
num_byãs
 =(
byãs_wrôãn
 + 1) );

153 
	`RBSPtoNALU
–
rb•
, 
«lu
, 
RBSPÀn
, 
NALU_TYPE_FILL
, 
NALU_PRIORITY_DISPOSABLE
, 1 );

155 
Àn
 = 
p_Vid
->
	`WrôeNALU
–p_Vid, 
«lu
,Ö_Vid->
f_out
 );

156 
p_Vid
->
byãs_ö_pi˘uª
 +(
«lu
->
Àn
 + 1);

158 
	`FªeNALU
–
«lu
 );

160  
Àn
;

161 
	}
}

	@lencod/src/output.c

15 
	~"c⁄åibut‹s.h
"

16 
	~"globÆ.h
"

17 
	~"image.h
"

18 
	~"öput.h
"

19 
	~"ouçut.h
"

45 
	$img2buf
 (
img≥l
** 
imgX
, * 
buf
, 
size_x
, 
size_y
, 
symbﬁ_size_ö_byãs
, 
¸›_À·
, 
¸›_right
, 
¸›_t›
, 
¸›_bŸtom
)

47 
i
,
j
;

49 
twidth
 = 
size_x
 - 
¸›_À·
 - 
¸›_right
;

50 
theight
 = 
size_y
 - 
¸›_t›
 - 
¸›_bŸtom
;

51 
size
 = 0;

52 
ui8
;

53 
uöt16
 
tmp16
, 
ui16
;

54 
tmp32
, 
ui32
;

56 i‡(–(Ë= (
img≥l
)Ë&& ( (Ë=
symbﬁ_size_ö_byãs
))

59 i‡(
¸›_À·
 =0 && 
¸›_t›
 =0 && 
¸›_right
 =0 && 
¸›_bŸtom
 == 0)

62 
j
=0; j<
theight
; j++)

63 
	`mem˝y
(
buf
+
j
*
twidth
, 
imgX
[j],Åwidth);

67 
i
=0;i<
theight
;i++)

69 
	`mem˝y
(
buf
 + (
i
*
twidth
), &(
imgX
[ò+ 
¸›_t›
][
¸›_À·
]),Åwidth);

75 i‡(
	`ã°Endün
())

78 
symbﬁ_size_ö_byãs
)

82 
i
=
¸›_t›
;i<
size_y
-
¸›_bŸtom
;i++)

83 
j
=
¸›_À·
;j<
size_x
-
¸›_right
;j++)

85 
ui8
 = (Ë(
imgX
[
i
][
j
]);

86 
buf
[(
j
-
¸›_À·
+((
i
-
¸›_t›
)*(
twidth
)))] = 
ui8
;

92 
i
=
¸›_t›
;i<
size_y
-
¸›_bŸtom
;i++)

93 
j
=
¸›_À·
;j<
size_x
-
¸›_right
;j++)

95 
tmp16
 = (
uöt16
Ë(
imgX
[
i
][
j
]);

96 
ui16
 = (
tmp16
 >> 8) | ((tmp16&0xFF)<<8);

97 
	`mem˝y
(
buf
+((
j
-
¸›_À·
+((
i
-
¸›_t›
)*(
twidth
)))*2),&(
ui16
), 2);

103 
i
=
¸›_t›
;i<
size_y
-
¸›_bŸtom
;i++)

104 
j
=
¸›_À·
;j<
size_x
-
¸›_right
;j++)

106 
tmp32
 = (Ë(
imgX
[
i
][
j
]);

107 
ui32
 = ((
tmp32
&0xFF00)<<8) | ((tmp32&0xFF)<<24) | ((tmp32&0xFF0000)>>8) | ((tmp32&0xFF000000)>>24);

108 
	`mem˝y
(
buf
+((
j
-
¸›_À·
+((
i
-
¸›_t›
)*(
twidth
)))*4),&(
ui32
), 4);

114 
	`îr‹
 ("writing onlyÅo formats of 8, 16 or 32 bitállowed on bigÉndianárchitecture", 500);

123 i‡( (
img≥l
Ë< 
symbﬁ_size_ö_byãs
)

126 
size
 =  (
img≥l
);

128 
	`mem£t
 (
buf
, 0, (
twidth
*
theight
*
symbﬁ_size_ö_byãs
));

132 
size
 = 
symbﬁ_size_ö_byãs
;

135 
i
=
¸›_t›
;i<
size_y
-
¸›_bŸtom
;i++)

137 
i_pos
 = (
i
-
¸›_t›
)*(
twidth
Ë- 
¸›_À·
;

138 
j
=
¸›_À·
;j<
size_x
-
¸›_right
;j++)

140 
	`mem˝y
(
buf
+((
j
 + 
i_pos
)*
symbﬁ_size_ö_byãs
),&(
imgX
[
i
][j]), 
size
);

145 
	}
}

159 
	$wrôe_pi˘uª
(
St‹abÀPi˘uª
 *
p
, 
FømeF‹m©
 *
ouçut
, 
p_out
)

161 
	`wrôe_out_pi˘uª
(
p
, 
ouçut
, 
p_out
);

162 
	}
}

176 
	$wrôe_out_pi˘uª
(
St‹abÀPi˘uª
 *
p
, 
FømeF‹m©
 *
ouçut
, 
p_out
)

178 
SubWidthC
 [4]= { 1, 2, 2, 1};

179 
SubHeightC
 [4]= { 1, 2, 1, 1};

181 
ªt
;

183 
¸›_À·
, 
¸›_right
, 
¸›_t›
, 
¸›_bŸtom
;

184 
symbﬁ_size_ö_byãs
 = 
ouçut
->
pic_unô_size_shi·3
;

185 
Boﬁón
 
rgb_ouçut
 = (BoﬁónË(
ouçut
->
cﬁ‹_modñ
 !
CM_YUV
 && ouçut->
yuv_f‹m©
 =
YUV444
);

186 *
buf
;

188 i‡(
p
->
n⁄_exi°ög
)

191 i‡(
p_out
 == -1)

194 i‡(
p
->
‰ame_¸›pög_Êag
)

196 
¸›_À·
 = 
SubWidthC
[
p
->
chroma_f‹m©_idc
] *Ö->
‰ame_¸›_À·_off£t
;

197 
¸›_right
 = 
SubWidthC
[
p
->
chroma_f‹m©_idc
] *Ö->
‰ame_¸›_right_off£t
;

198 
¸›_t›
 = 
SubHeightC
[
p
->
chroma_f‹m©_idc
]*–2 -Ö->
‰ame_mbs_⁄ly_Êag
 ) *Ö->
‰ame_¸›_t›_off£t
;

199 
¸›_bŸtom
 = 
SubHeightC
[
p
->
chroma_f‹m©_idc
]*–2 -Ö->
‰ame_mbs_⁄ly_Êag
 ) *Ö->
‰ame_¸›_bŸtom_off£t
;

203 
¸›_À·
 = 
¸›_right
 = 
¸›_t›
 = 
¸›_bŸtom
 = 0;

209 
buf
 = 
	`mÆloc
 (
p
->
size_x
 *Ö->
size_y
 * 
symbﬁ_size_ö_byãs
);

210 i‡(
NULL
==
buf
)

212 
	`no_mem_exô
("write_out_picture: buf");

215 if(
rgb_ouçut
)

217 
¸›_À·
 = 
p
->
‰ame_¸›_À·_off£t
;

218 
¸›_right
 = 
p
->
‰ame_¸›_right_off£t
;

219 
¸›_t›
 = ( 2 - 
p
->
‰ame_mbs_⁄ly_Êag
 ) *Ö->
‰ame_¸›_t›_off£t
;

220 
¸›_bŸtom
 = ( 2 - 
p
->
‰ame_mbs_⁄ly_Êag
 ) *Ö->
‰ame_¸›_bŸtom_off£t
;

222 
	`img2buf
 (
p
->
imgUV
[1], 
buf
,Ö->
size_x_¸
,Ö->
size_y_¸
, 
symbﬁ_size_ö_byãs
, 
¸›_À·
, 
¸›_right
, 
¸›_t›
, 
¸›_bŸtom
);

223 
ªt
 = 
	`wrôe
(
p_out
, 
buf
, (
p
->
size_y_¸
-
¸›_bŸtom
-
¸›_t›
)*’->
size_x_¸
-
¸›_right
-
¸›_À·
)*
symbﬁ_size_ö_byãs
);

224 i‡(
ªt
 !((
p
->
size_y_¸
-
¸›_bŸtom
-
¸›_t›
)*’->
size_x_¸
-
¸›_right
-
¸›_À·
)*
symbﬁ_size_ö_byãs
))

226 
	`îr‹
 ("write_out_picture:Érror writingÅo RGB output file.", 500);

229 i‡(
p
->
‰ame_¸›pög_Êag
)

231 
¸›_À·
 = 
SubWidthC
[
p
->
chroma_f‹m©_idc
] *Ö->
‰ame_¸›_À·_off£t
;

232 
¸›_right
 = 
SubWidthC
[
p
->
chroma_f‹m©_idc
] *Ö->
‰ame_¸›_right_off£t
;

233 
¸›_t›
 = 
SubHeightC
[
p
->
chroma_f‹m©_idc
]*–2 -Ö->
‰ame_mbs_⁄ly_Êag
 ) *Ö->
‰ame_¸›_t›_off£t
;

234 
¸›_bŸtom
 = 
SubHeightC
[
p
->
chroma_f‹m©_idc
]*–2 -Ö->
‰ame_mbs_⁄ly_Êag
 ) *Ö->
‰ame_¸›_bŸtom_off£t
;

238 
¸›_À·
 = 
¸›_right
 = 
¸›_t›
 = 
¸›_bŸtom
 = 0;

242 
	`img2buf
 (
p
->
imgY
, 
buf
,Ö->
size_x
,Ö->
size_y
, 
symbﬁ_size_ö_byãs
, 
¸›_À·
, 
¸›_right
, 
¸›_t›
, 
¸›_bŸtom
);

243 
ªt
 = 
	`wrôe
(
p_out
, 
buf
, (
p
->
size_y
-
¸›_bŸtom
-
¸›_t›
)*’->
size_x
-
¸›_right
-
¸›_À·
)*
symbﬁ_size_ö_byãs
);

244 i‡(
ªt
 !((
p
->
size_y
-
¸›_bŸtom
-
¸›_t›
)*’->
size_x
-
¸›_right
-
¸›_À·
)*
symbﬁ_size_ö_byãs
))

246 
	`îr‹
 ("write_out_picture:Érror writingÅo YUV output file.", 500);

249 i‡(
p
->
chroma_f‹m©_idc
 !
YUV400
)

251 
¸›_À·
 = 
p
->
‰ame_¸›_À·_off£t
;

252 
¸›_right
 = 
p
->
‰ame_¸›_right_off£t
;

253 
¸›_t›
 = ( 2 - 
p
->
‰ame_mbs_⁄ly_Êag
 ) *Ö->
‰ame_¸›_t›_off£t
;

254 
¸›_bŸtom
 = ( 2 - 
p
->
‰ame_mbs_⁄ly_Êag
 ) *Ö->
‰ame_¸›_bŸtom_off£t
;

256 
	`img2buf
 (
p
->
imgUV
[0], 
buf
,Ö->
size_x_¸
,Ö->
size_y_¸
, 
symbﬁ_size_ö_byãs
, 
¸›_À·
, 
¸›_right
, 
¸›_t›
, 
¸›_bŸtom
);

257 
ªt
 = 
	`wrôe
(
p_out
, 
buf
, (
p
->
size_y_¸
-
¸›_bŸtom
-
¸›_t›
)*’->
size_x_¸
-
¸›_right
-
¸›_À·
)* 
symbﬁ_size_ö_byãs
);

258 i‡(
ªt
 !((
p
->
size_y_¸
-
¸›_bŸtom
-
¸›_t›
)*’->
size_x_¸
-
¸›_right
-
¸›_À·
)* 
symbﬁ_size_ö_byãs
))

260 
	`îr‹
 ("write_out_picture:Érror writingÅo YUV output file.", 500);

263 i‡(!
rgb_ouçut
)

265 
	`img2buf
 (
p
->
imgUV
[1], 
buf
,Ö->
size_x_¸
,Ö->
size_y_¸
, 
symbﬁ_size_ö_byãs
, 
¸›_À·
, 
¸›_right
, 
¸›_t›
, 
¸›_bŸtom
);

266 
ªt
 = 
	`wrôe
(
p_out
, 
buf
, (
p
->
size_y_¸
-
¸›_bŸtom
-
¸›_t›
)*’->
size_x_¸
-
¸›_right
-
¸›_À·
)*
symbﬁ_size_ö_byãs
);

267 i‡(
ªt
 !((
p
->
size_y_¸
-
¸›_bŸtom
-
¸›_t›
)*’->
size_x_¸
-
¸›_right
-
¸›_À·
)*
symbﬁ_size_ö_byãs
))

269 
	`îr‹
 ("write_out_picture:Érror writingÅo YUV output file.", 500);

274 
	`‰ì
(
buf
);

277 
	}
}

285 
	$öô_out_buf„r
(
VideoP¨amëîs
 *
p_Vid
)

287 
p_Vid
->
out_buf„r
 = 
	`Æloc_‰ame_°‹e
();

288 
	}
}

296 
	$unöô_out_buf„r
(
VideoP¨amëîs
 *
p_Vid
)

298 
	`‰ì_‰ame_°‹e
(
p_Vid
,Ö_Vid->
out_buf„r
);

299 
p_Vid
->
out_buf„r
=
NULL
;

300 
	}
}

308 
	$˛ór_pi˘uª
(
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
p
)

310 
i
;

312 i‡(
p_Vid
->
bôdïth_luma
 == 8)

316 
i
=0;i<
p
->
size_y
;i++)

317 
	`mem£t
(
p
->
imgY
[
i
], 
p_Vid
->
dc_¥ed_vÆue_comp
[0],Ö->
size_x
*(
img≥l
));

321 
j
;

322 
i
=0;ò< 
p
->
size_y
; i++)

323 
j
=0;j < 
p
->
size_x
; j++)

324 
p
->
imgY
[
i
][
j
] = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[0];

327 i‡(
p_Vid
->
bôdïth_chroma
 == 8)

329 
i
=0;i<
p
->
size_y_¸
;i++)

330 
	`mem£t
(
p
->
imgUV
[0][
i
], 
p_Vid
->
dc_¥ed_vÆue_comp
[1],Ö->
size_x_¸
*(
img≥l
));

331 
i
=0;i<
p
->
size_y_¸
;i++)

332 
	`mem£t
(
p
->
imgUV
[1][
i
], 
p_Vid
->
dc_¥ed_vÆue_comp
[2],Ö->
size_x_¸
*(
img≥l
));

336 
k
, 
j
;

337 
k
 = 0; k < 2; k++)

339 
i
=0;i<
p
->
size_y_¸
;i++)

340 
j
=0;j < 
p
->
size_x_¸
; j++)

341 
p
->
imgUV
[
k
][
i
][
j
] = (
img≥l
Ë
p_Vid
->
dc_¥ed_vÆue_comp
[1];

344 
	}
}

361 
	$wrôe_u≈aúed_fõld
(
VideoP¨amëîs
 *
p_Vid
, 
FømeSt‹e
* 
fs
, 
FømeF‹m©
 *
ouçut
, 
p_out
)

363 
St‹abÀPi˘uª
 *
p
;

364 
	`as£π
 (
fs
->
is_u£d
<3);

365 if(
fs
->
is_u£d
 &1)

369 
p
 = 
fs
->
t›_fõld
;

370 
fs
->
bŸtom_fõld
 = 
	`Æloc_°‹abÀ_pi˘uª
(
p_Vid
, 
BOTTOM_FIELD
, 
p
->
size_x
,Ö->
size_y
,Ö->
size_x_¸
,Ö->
size_y_¸
);

371 
fs
->
bŸtom_fõld
->
chroma_f‹m©_idc
 = 
p
->chroma_format_idc;

372 
fs
->
bŸtom_fõld
->
chroma_mask_mv_x
 = 
p
->chroma_mask_mv_x;

373 
fs
->
bŸtom_fõld
->
chroma_mask_mv_y
 = 
p
->chroma_mask_mv_y;

374 
fs
->
bŸtom_fõld
->
chroma_shi·_x
 = 
p
->chroma_shift_x;

375 
fs
->
bŸtom_fõld
->
chroma_shi·_y
 = 
p
->chroma_shift_y;

377 
	`˛ór_pi˘uª
(
p_Vid
, 
fs
->
bŸtom_fõld
);

378 
	`dpb_comböe_fõld_yuv
(
p_Vid
, 
fs
);

379 
	`wrôe_pi˘uª
 (
fs
->
‰ame
, 
ouçut
, 
p_out
);

382 if(
fs
->
is_u£d
 &2)

386 
p
 = 
fs
->
bŸtom_fõld
;

387 
fs
->
t›_fõld
 = 
	`Æloc_°‹abÀ_pi˘uª
(
p_Vid
, 
TOP_FIELD
, 
p
->
size_x
,Ö->
size_y
,Ö->
size_x_¸
,Ö->
size_y_¸
);

388 
	`˛ór_pi˘uª
(
p_Vid
, 
fs
->
t›_fõld
);

389 
fs
->
t›_fõld
->
chroma_f‹m©_idc
 = 
p
->chroma_format_idc;

390 
fs
->
t›_fõld
->
chroma_mask_mv_x
 = 
p
->chroma_mask_mv_x;

391 
fs
->
t›_fõld
->
chroma_mask_mv_y
 = 
p
->chroma_mask_mv_y;

392 
fs
->
t›_fõld
->
chroma_shi·_x
 = 
p
->chroma_shift_x;

393 
fs
->
t›_fõld
->
chroma_shi·_y
 = 
p
->chroma_shift_y;

395 
	`˛ór_pi˘uª
(
p_Vid
, 
fs
->
t›_fõld
);

396 
fs
 ->
t›_fõld
->
‰ame_¸›pög_Êag
 = fs->
bŸtom_fõld
->frame_cropping_flag;

397 if(
fs
 ->
t›_fõld
->
‰ame_¸›pög_Êag
)

399 
fs
 ->
t›_fõld
->
‰ame_¸›_t›_off£t
 = fs->
bŸtom_fõld
->frame_crop_top_offset;

400 
fs
 ->
t›_fõld
->
‰ame_¸›_bŸtom_off£t
 = fs->
bŸtom_fõld
->frame_crop_bottom_offset;

401 
fs
 ->
t›_fõld
->
‰ame_¸›_À·_off£t
 = fs->
bŸtom_fõld
->frame_crop_left_offset;

402 
fs
 ->
t›_fõld
->
‰ame_¸›_right_off£t
 = fs->
bŸtom_fõld
->frame_crop_right_offset;

404 
	`dpb_comböe_fõld_yuv
(
p_Vid
, 
fs
);

405 
	`wrôe_pi˘uª
 (
fs
->
‰ame
, 
ouçut
, 
p_out
);

408 
fs
->
is_u£d
=3;

409 
	}
}

423 
	$Êush_dúe˘_ouçut
(
VideoP¨amëîs
 *
p_Vid
, 
FømeF‹m©
 *
ouçut
, 
p_out
)

425 
	`wrôe_u≈aúed_fõld
(
p_Vid
,Ö_Vid->
out_buf„r
, 
ouçut
, 
p_out
);

427 
	`‰ì_°‹abÀ_pi˘uª
(
p_Vid
,Ö_Vid->
out_buf„r
->
‰ame
);

428 
p_Vid
->
out_buf„r
->
‰ame
 = 
NULL
;

429 
	`‰ì_°‹abÀ_pi˘uª
(
p_Vid
,Ö_Vid->
out_buf„r
->
t›_fõld
);

430 
p_Vid
->
out_buf„r
->
t›_fõld
 = 
NULL
;

431 
	`‰ì_°‹abÀ_pi˘uª
(
p_Vid
,Ö_Vid->
out_buf„r
->
bŸtom_fõld
);

432 
p_Vid
->
out_buf„r
->
bŸtom_fõld
 = 
NULL
;

433 
p_Vid
->
out_buf„r
->
is_u£d
 = 0;

434 
	}
}

451 
	$wrôe_°‹ed_‰ame
–
VideoP¨amëîs
 *
p_Vid
, 
FømeSt‹e
 *
fs
, 
FømeF‹m©
 *
ouçut
, 
p_out
)

454 
	`Êush_dúe˘_ouçut
(
p_Vid
, 
ouçut
, 
p_out
);

456 i‡(
fs
->
is_u£d
<3)

458 
	`wrôe_u≈aúed_fõld
(
p_Vid
, 
fs
, 
ouçut
, 
p_out
);

462 
	`wrôe_pi˘uª
(
fs
->
‰ame
, 
ouçut
, 
p_out
);

465 
fs
->
is_ouçut
 = 1;

466 
	}
}

484 
	$dúe˘_ouçut
(
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
p
, 
FømeF‹m©
 *
ouçut
, 
p_out
)

486  
p
->
°ru˘uª
 )

488 
FRAME
:

491 
	`Êush_dúe˘_ouçut
(
p_Vid
, 
ouçut
, 
p_out
);

492 
	`wrôe_pi˘uª
 (
p
, 
ouçut
, 
p_out
);

493 
	`‰ì_°‹abÀ_pi˘uª
(
p_Vid
, 
p
);

496 
TOP_FIELD
:

497 i‡(
p_Vid
->
out_buf„r
->
is_u£d
 &1)

498 
	`Êush_dúe˘_ouçut
(
p_Vid
, 
ouçut
, 
p_out
);

499 
p_Vid
->
out_buf„r
->
t›_fõld
 = 
p
;

500 
p_Vid
->
out_buf„r
->
is_u£d
 |= 1;

502 
BOTTOM_FIELD
:

503 i‡(
p_Vid
->
out_buf„r
->
is_u£d
 &2)

504 
	`Êush_dúe˘_ouçut
(
p_Vid
, 
ouçut
, 
p_out
);

505 
p_Vid
->
out_buf„r
->
bŸtom_fõld
 = 
p
;

506 
p_Vid
->
out_buf„r
->
is_u£d
 |= 2;

509 
	`¥ötf
("invalidÖictureÅype\n");

513 i‡(
p_Vid
->
out_buf„r
->
is_u£d
 == 3)

516 
	`dpb_comböe_fõld_yuv
(
p_Vid
,Ö_Vid->
out_buf„r
);

517 
	`wrôe_pi˘uª
 (
p_Vid
->
out_buf„r
->
‰ame
, 
ouçut
, 
p_out
);

518 
	`‰ì_°‹abÀ_pi˘uª
(
p_Vid
,Ö_Vid->
out_buf„r
->
‰ame
);

519 
p_Vid
->
out_buf„r
->
‰ame
 = 
NULL
;

520 
	`‰ì_°‹abÀ_pi˘uª
(
p_Vid
,Ö_Vid->
out_buf„r
->
t›_fõld
);

521 
p_Vid
->
out_buf„r
->
t›_fõld
 = 
NULL
;

522 
	`‰ì_°‹abÀ_pi˘uª
(
p_Vid
,Ö_Vid->
out_buf„r
->
bŸtom_fõld
);

523 
p_Vid
->
out_buf„r
->
bŸtom_fõld
 = 
NULL
;

524 
p_Vid
->
out_buf„r
->
is_u£d
 = 0;

526 
	}
}

544 
	$dúe˘_ouçut_∑ff
(
VideoP¨amëîs
 *
p_Vid
, 
St‹abÀPi˘uª
 *
p
, 
FømeF‹m©
 *
ouçut
, 
p_out
)

546 
	`¥ötf
("Warning!!! Frame can't fit in DPB. Displayed out of sequence.\n");

547 
	`‰ì_°‹abÀ_pi˘uª
(
p_Vid
,Ö_Vid->
out_buf„r
->
‰ame
);

548 
p_Vid
->
out_buf„r
->
‰ame
 = 
NULL
;

549 
	`‰ì_°‹abÀ_pi˘uª
(
p_Vid
,Ö_Vid->
out_buf„r
->
t›_fõld
);

550 
p_Vid
->
out_buf„r
->
t›_fõld
 = 
NULL
;

551 
	`‰ì_°‹abÀ_pi˘uª
(
p_Vid
,Ö_Vid->
out_buf„r
->
bŸtom_fõld
);

552 
p_Vid
->
out_buf„r
->
bŸtom_fõld
 = 
NULL
;

553 
p_Vid
->
out_buf„r
->
is_u£d
 = 0;

555 
	`dúe˘_ouçut
(
p_Vid
, 
p
, 
ouçut
, 
p_out
);

556 
	}
}

	@lencod/src/parset.c

15 
	~<time.h
>

16 
	~<limôs.h
>

18 
	~"globÆ.h
"

20 
	~"c⁄åibut‹s.h
"

21 
	~"«l.h
"

22 
	~"mbuf„r.h
"

23 
	~"∑r£t.h
"

24 
	~"vlc.h
"

25 
	~"q_m©rix.h
"

28 
idítify_¥ofûe
(
I≈utP¨amëîs
 *
p_I≈
);

29 
idítify_Àvñ
(
I≈utP¨amëîs
 *
p_I≈
);

30 
Gíî©eVUI_∑ømëîs_rb•
(
£q_∑ømëî_£t_rb•_t
 *
•s
, 
Bô°ªam
 *
bô°ªam
);

32 c⁄° 
byã
 
	gZZ_SCAN
[16] =

37 c⁄° 
byã
 
	gZZ_SCAN8
[64] =

56 
	$gíî©e_∑ømëî_£ts
 (
VideoP¨amëîs
 *
p_Vid
)

58 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

59 
i
;

60 
£q_∑ømëî_£t_rb•_t
 *
•s
 = 
NULL
;

62 
•s
 = 
	`AŒocSPS
();

64 
i
=0; i<
MAXPPS
; i++)

66 
p_Vid
->
PicP¨Së
[
i
] = 
NULL
;

69 
	`Gíî©eSequí˚P¨amëîSë
(
•s
, 
p_Vid
, 0);

71 i‡(
p_I≈
->
Gíî©eMu…ùÀPPS
)

73 
p_Vid
->
PicP¨Së
[0] = 
	`AŒocPPS
();

74 
p_Vid
->
PicP¨Së
[1] = 
	`AŒocPPS
();

75 
p_Vid
->
PicP¨Së
[2] = 
	`AŒocPPS
();

77 i‡(
	`is_FREXT_¥ofûe
(
•s
->
¥ofûe_idc
))

79 
	`Gíî©ePi˘uªP¨amëîSë
–
p_Vid
->
PicP¨Së
[0], 
•s
,Ö_Vid, 
p_I≈
, 0, 0, 0,Ö_I≈->
cb_qp_ödex_off£t
,Ö_I≈->
¸_qp_ödex_off£t
);

80 
	`Gíî©ePi˘uªP¨amëîSë
–
p_Vid
->
PicP¨Së
[1], 
•s
,Ö_Vid, 
p_I≈
, 1, 1, 1,Ö_I≈->
cb_qp_ödex_off£t
,Ö_I≈->
¸_qp_ödex_off£t
);

81 
	`Gíî©ePi˘uªP¨amëîSë
–
p_Vid
->
PicP¨Së
[2], 
•s
,Ö_Vid, 
p_I≈
, 2, 1, 2,Ö_I≈->
cb_qp_ödex_off£t
,Ö_I≈->
¸_qp_ödex_off£t
);

85 
	`Gíî©ePi˘uªP¨amëîSë
–
p_Vid
->
PicP¨Së
[0], 
•s
,Ö_Vid, 
p_I≈
, 0, 0, 0,Ö_I≈->
chroma_qp_ödex_off£t
, 0);

86 
	`Gíî©ePi˘uªP¨amëîSë
–
p_Vid
->
PicP¨Së
[1], 
•s
,Ö_Vid, 
p_I≈
, 1, 1, 1,Ö_I≈->
chroma_qp_ödex_off£t
, 0);

87 
	`Gíî©ePi˘uªP¨amëîSë
–
p_Vid
->
PicP¨Së
[2], 
•s
,Ö_Vid, 
p_I≈
, 2, 1, 2,Ö_I≈->
chroma_qp_ödex_off£t
, 0);

92 
p_Vid
->
PicP¨Së
[0] = 
	`AŒocPPS
();

93 i‡(
	`is_FREXT_¥ofûe
(
•s
->
¥ofûe_idc
))

94 
	`Gíî©ePi˘uªP¨amëîSë
–
p_Vid
->
PicP¨Së
[0], 
•s
,Ö_Vid, 
p_I≈
, 0,Ö_I≈->
WeighãdPªdi˘i⁄
,Ö_I≈->
WeighãdBùªdi˘i⁄
,

95 
p_I≈
->
cb_qp_ödex_off£t
,Ö_I≈->
¸_qp_ödex_off£t
);

97 
	`Gíî©ePi˘uªP¨amëîSë
–
p_Vid
->
PicP¨Së
[0], 
•s
,Ö_Vid, 
p_I≈
, 0,Ö_I≈->
WeighãdPªdi˘i⁄
,Ö_I≈->
WeighãdBùªdi˘i⁄
,

98 
p_I≈
->
chroma_qp_ödex_off£t
, 0);

101 
p_Vid
->
a˘ive_•s
 = 
•s
;

102 
p_Vid
->
a˘ive_µs
 =Ö_Vid->
PicP¨Së
[0];

104 
p_Vid
->
•s
[0] = sps;

105 if(
p_Vid
->
num_of_œyîs
 == 2)

107 
p_Vid
->
•s
[1] = 
	`AŒocSPS
();

108 *(
p_Vid
->
•s
[1]) = *sps;

111 
p_Vid
->
•s
[1] = 
NULL
;

112 
	}
}

124 
	$FªeP¨amëîSës
 (
VideoP¨amëîs
 *
p_Vid
)

126 
i
;

127 
i
=0; i<
MAXPPS
; i++)

129 i‡–
NULL
 !
p_Vid
->
PicP¨Së
[
i
])

131 
	`FªePPS
(
p_Vid
->
PicP¨Së
[
i
]);

132 
p_Vid
->
PicP¨Së
[
i
] = 
NULL
;

135 
i
=0; i<
p_Vid
->
num_of_œyîs
; i++)

136 if(
p_Vid
->
•s
[
i
])

138 
	`FªeSPS
(
p_Vid
->
•s
[
i
]);

139 
p_Vid
->
•s
[
i
] = 
NULL
;

141 
p_Vid
->
a˘ive_•s
 = 
NULL
;

142 
	}
}

160 
NALU_t
 *
	$Gíî©eSeq_∑ømëî_£t_NALU
 (
VideoP¨amëîs
 *
p_Vid
)

162 
NALU_t
 *
n
 = 
	`AŒocNALU
(
MAXNALUSIZE
);

163 
RBSPÀn
 = 0;

164 
byã
 
rb•
[
MAXRBSPSIZE
];

166 #i‡(
MVC_EXTENSION_ENABLE
)

167 
RBSPÀn
 = 
	`Gíî©eSeq_∑ømëî_£t_rb•
 (
p_Vid
,Ö_Vid->
•s
[0] , 
rb•
, 0);

169 
RBSPÀn
 = 
	`Gíî©eSeq_∑ømëî_£t_rb•
 (
p_Vid
,Ö_Vid->
a˘ive_•s
, 
rb•
);

171 
	`RBSPtoNALU
 (
rb•
, 
n
, 
RBSPÀn
, 
NALU_TYPE_SPS
, 
NALU_PRIORITY_HIGHEST
, 1);

172 
n
->
°¨tcodïªfix_Àn
 = 4;

174  
n
;

175 
	}
}

177 #i‡(
MVC_EXTENSION_ENABLE
)

194 
NALU_t
 *
	$Gíî©eSub£tSeq_∑ømëî_£t_NALU
 (
VideoP¨amëîs
 *
p_Vid
)

196 
NALU_t
 *
n
 = 
	`AŒocNALU
(
MAXNALUSIZE
);

197 
RBSPÀn
 = 0;

198 
byã
 
rb•
[
MAXRBSPSIZE
];

200 
RBSPÀn
 = 
	`Gíî©eSeq_∑ømëî_£t_rb•
 (
p_Vid
,Ö_Vid->
•s
[1] , 
rb•
, 1);

201 
	`RBSPtoNALU
 (
rb•
, 
n
, 
RBSPÀn
, 
NALU_TYPE_SUB_SPS
, 
NALU_PRIORITY_HIGHEST
, 1);

202 
n
->
°¨tcodïªfix_Àn
 = 4;

204  
n
;

205 
	}
}

223 
NALU_t
 *
	$Gíî©ePic_∑ømëî_£t_NALU
(
VideoP¨amëîs
 *
p_Vid
, 
PPS_id
)

225 
NALU_t
 *
n
 = 
	`AŒocNALU
(
MAXNALUSIZE
);

226 
RBSPÀn
 = 0;

227 
byã
 
rb•
[
MAXRBSPSIZE
];

229 
RBSPÀn
 = 
	`Gíî©ePic_∑ømëî_£t_rb•
 (
p_Vid
,Ö_Vid->
PicP¨Së
[
PPS_id
], 
rb•
);

230 
	`RBSPtoNALU
 (
rb•
, 
n
, 
RBSPÀn
, 
NALU_TYPE_PPS
, 
NALU_PRIORITY_HIGHEST
, 1);

231 
n
->
°¨tcodïªfix_Àn
 = 4;

233  
n
;

234 
	}
}

257 
	$Gíî©eSequí˚P¨amëîSë
–
£q_∑ømëî_£t_rb•_t
 *
•s
,

258 
VideoP¨amëîs
 *
p_Vid
,

259 
SPS_id


262 c⁄° 
SubWidthC
 [4]= { 1, 2, 2, 1};

263 c⁄° 
SubHeightC
 [4]= { 1, 2, 1, 1};

264 
i
;

265 
n_SˇlögLi°
;

266 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

268 
‰ext_¥ofûe
 = ((
	`idítify_¥ofûe
(
p_I≈
)==
FREXT_HP
) ||

269 (
	`idítify_¥ofûe
(
p_I≈
)==
FREXT_Hi10P
) ||

270 (
	`idítify_¥ofûe
(
p_I≈
)==
FREXT_Hi422
) ||

271 (
	`idítify_¥ofûe
(
p_I≈
)==
FREXT_Hi444
) ||

272 (
	`idítify_¥ofûe
(
p_I≈
)==
FREXT_CAVLC444
)

273 #i‡(
MVC_EXTENSION_ENABLE
)

274 || (
	`idítify_¥ofûe
(
p_I≈
)==
MULTIVIEW_HIGH
)

275 || (
	`idítify_¥ofûe
(
p_I≈
)==
STEREO_HIGH
)

281 
	`as£π
 (
•s
 !
NULL
);

284 
•s
->
¥ofûe_idc
 = 
	`idítify_¥ofûe
(
p_I≈
);

285 
•s
->
Àvñ_idc
 = 
	`idítify_Àvñ
(
p_I≈
);

288 
•s
->
c⁄°øöed_£t0_Êag
 = 
FALSE
;

289 
•s
->
c⁄°øöed_£t1_Êag
 = 
FALSE
;

290 
•s
->
c⁄°øöed_£t2_Êag
 = 
FALSE
;

292 i‡–(
•s
->
Àvñ_idc
 =9Ë&& !
	`is_FREXT_¥ofûe
(•s->
¥ofûe_idc
) )

294 
•s
->
c⁄°øöed_£t3_Êag
 = 
TRUE
;

295 
•s
->
Àvñ_idc
 = 11;

297 i‡(
‰ext_¥ofûe
 && 
p_I≈
->
I¡øProfûe
)

299 
•s
->
c⁄°øöed_£t3_Êag
 = 
TRUE
;

303 
•s
->
c⁄°øöed_£t3_Êag
 = 
FALSE
;

307 
•s
->
£q_∑ømëî_£t_id
 = 
SPS_id
;

310 
•s
->
bô_dïth_luma_möus8
 = 
p_I≈
->
ouçut
.
bô_dïth
[0] - 8;

311 
•s
->
bô_dïth_chroma_möus8
 = 
p_I≈
->
ouçut
.
bô_dïth
[1] - 8;

312 
•s
->
los¶ess_qµrime_Êag
 = 
p_I≈
->
Los¶essCodög
 &

313 (
•s
->
¥ofûe_idc
==
FREXT_Hi444
 || sps->¥ofûe_idc==
FREXT_CAVLC444
);

320 
•s
->
log2_max_‰ame_num_möus4
 = 
p_Vid
->log2_max_frame_num_minus4;

321 
•s
->
log2_max_pic_‹dî_˙t_lsb_möus4
 = 
p_Vid
->log2_max_pic_order_cnt_lsb_minus4;

323 
•s
->
pic_‹dî_˙t_ty≥
 = 
p_I≈
->pic_order_cnt_type;

324 
•s
->
num_ªf_‰ames_ö_pic_‹dî_˙t_cy˛e
 = 
p_Vid
->num_ref_frames_in_pic_order_cnt_cycle;

325 
•s
->
dñè_pic_‹dî_Æways_zîo_Êag
 = 
p_Vid
->delta_pic_order_always_zero_flag;

326 
•s
->
off£t_f‹_n⁄_ªf_pic
 = 
p_Vid
->offset_for_non_ref_pic;

327 
•s
->
off£t_f‹_t›_to_bŸtom_fõld
 = 
p_Vid
->offset_for_top_to_bottom_field;

329 
i
=0; i<
p_Vid
->
num_ªf_‰ames_ö_pic_‹dî_˙t_cy˛e
; i++)

331 
•s
->
off£t_f‹_ªf_‰ame
[
i
] = 
p_Vid
->offset_for_ref_frame[i];

336 
•s
->
num_ªf_‰ames
 = (Ë
p_I≈
->num_ref_frames;

339 
•s
->
g≠s_ö_‰ame_num_vÆue_Ælowed_Êag
 = 
FALSE
;

341 
•s
->
‰ame_mbs_⁄ly_Êag
 = (
Boﬁón
Ë!(
p_I≈
->
PicI¡îœ˚
 ||Ö_I≈->
MbI¡îœ˚
);

344 
•s
->
pic_width_ö_mbs_möus1
 = (–
p_I≈
->
ouçut
.
width
[0] + 
p_Vid
->
auto_¸›_right
) >> 4) -1;

345 
•s
->
pic_height_ö_m≠_unôs_möus1
 = (((
p_I≈
->
ouçut
.
height
[0] + 
p_Vid
->
auto_¸›_bŸtom
Ë>> 4)/ (2 - sps->
‰ame_mbs_⁄ly_Êag
)) - 1;

348 
•s
->
mb_ad≠tive_‰ame_fõld_Êag
 = (
Boﬁón
Ë(
FRAME_CODING
 !
p_I≈
->
MbI¡îœ˚
);

349 
•s
->
dúe˘_8x8_ö„ªn˚_Êag
 = (
Boﬁón
Ë
p_I≈
->
dúe˘In„ªn˚Fœg
;

352 
•s
->
vui_∑ømëîs_¥e£¡_Êag
 = (
Boﬁón
Ë((
p_I≈
->
ouçut
.
cﬁ‹_modñ
 !
CM_YUV
 &&Ö_I≈->ouçut.
yuv_f‹m©
 =
YUV444
Ë||Ö_I≈->
E«bÀVUISuµ‹t
);

353 
•s
->
chroma_f‹m©_idc
 = 
p_I≈
->
ouçut
.
yuv_f‹m©
;

354 
•s
->
£∑øã_cﬁour_∂™e_Êag
 = ( sps->
chroma_f‹m©_idc
 =
YUV444
 ) ? 
p_I≈
->separate_colour_plane_flag : 0;

356 i‡–
•s
->
vui_∑ømëîs_¥e£¡_Êag
 )

357 
	`Gíî©eVUIP¨amëîs
(
•s
, 
p_I≈
);

360 if(
‰ext_¥ofûe
)

362 
•s
->
£q_sˇlög_m©rix_¥e£¡_Êag
 = (
Boﬁón
Ë(
p_I≈
->
SˇlögM©rixPª£¡Fœg
&1);

363 
n_SˇlögLi°
 = (
•s
->
chroma_f‹m©_idc
 !
YUV444
) ? 8 : 12;

364 
i
=0; i<
n_SˇlögLi°
; i++)

366 if(
i
<6)

367 
•s
->
£q_sˇlög_li°_¥e£¡_Êag
[
i
] = (
p_I≈
->
SˇlögLi°Pª£¡Fœg
[i]&1);

370 if(
p_I≈
->
Tønsf‹m8x8Mode
)

371 
•s
->
£q_sˇlög_li°_¥e£¡_Êag
[
i
] = (
p_I≈
->
SˇlögLi°Pª£¡Fœg
[i]&1);

373 
•s
->
£q_sˇlög_li°_¥e£¡_Êag
[
i
] = 0;

375 if–
•s
->
£q_sˇlög_m©rix_¥e£¡_Êag
 =
FALSE
 )

376 
•s
->
£q_sˇlög_li°_¥e£¡_Êag
[
i
] = 0;

381 
•s
->
£q_sˇlög_m©rix_¥e£¡_Êag
 = 
FALSE
;

382 
i
=0; i<12; i++)

383 
•s
->
£q_sˇlög_li°_¥e£¡_Êag
[
i
] = 0;

388 i‡(
p_Vid
->
auto_¸›_right
 ||Ö_Vid->
auto_¸›_bŸtom
)

390 
•s
->
‰ame_¸›pög_Êag
 = 
TRUE
;

391 
•s
->
‰ame_¸›_À·_off£t
=0;

392 
•s
->
‰ame_¸›_t›_off£t
=0;

393 
•s
->
‰ame_¸›_right_off£t
(
p_Vid
->
auto_¸›_right
 / 
SubWidthC
[•s->
chroma_f‹m©_idc
]);

394 
•s
->
‰ame_¸›_bŸtom_off£t
(
p_Vid
->
auto_¸›_bŸtom
 / (
SubHeightC
[•s->
chroma_f‹m©_idc
] * (2 - sps->
‰ame_mbs_⁄ly_Êag
)));

395 i‡(
p_Vid
->
auto_¸›_right
 % 
SubWidthC
[
•s
->
chroma_f‹m©_idc
])

397 
	`îr‹
("automatic frame cropping (width)ÇotÖossible",500);

399 i‡(
p_Vid
->
auto_¸›_bŸtom
 % (
SubHeightC
[
•s
->
chroma_f‹m©_idc
] * (2 - sps->
‰ame_mbs_⁄ly_Êag
)))

401 
	`îr‹
("automatic frame cropping (height)ÇotÖossible",500);

406 
•s
->
‰ame_¸›pög_Êag
 = 
FALSE
;

409 
	}
}

424 
	$Gíî©ePi˘uªP¨amëîSë
–
pic_∑ømëî_£t_rb•_t
 *
µs
,

425 
£q_∑ømëî_£t_rb•_t
 *
•s
,

426 
VideoP¨amëîs
 *
p_Vid
,

427 
I≈utP¨amëîs
 *
p_I≈
,

428 
PPS_id
,

429 
WeighãdPªdi˘i⁄
,

430 
WeighãdBùªdi˘i⁄
,

431 
cb_qp_ödex_off£t
,

432 
¸_qp_ödex_off£t


436 
i
;

437 
n_SˇlögLi°
;

438 
FømeSizeInM≠Unôs
 = 0;

440 
‰ext_¥ofûe
 = ((
	`idítify_¥ofûe
(
p_I≈
)==
FREXT_HP
) ||

441 (
	`idítify_¥ofûe
(
p_I≈
)==
FREXT_Hi10P
) ||

442 (
	`idítify_¥ofûe
(
p_I≈
)==
FREXT_Hi422
) ||

443 (
	`idítify_¥ofûe
(
p_I≈
)==
FREXT_Hi444
) ||

444 (
	`idítify_¥ofûe
(
p_I≈
)==
FREXT_CAVLC444
)

445 #i‡(
MVC_EXTENSION_ENABLE
)

446 || (
	`idítify_¥ofûe
(
p_I≈
)==
MULTIVIEW_HIGH
)

447 || (
	`idítify_¥ofûe
(
p_I≈
)==
STEREO_HIGH
)

455 
µs
->
£q_∑ømëî_£t_id
 = 
•s
->seq_parameter_set_id;

456 
µs
->
pic_∑ømëî_£t_id
 = 
PPS_id
;

457 
µs
->
íå›y_codög_mode_Êag
 = (
p_I≈
->
symbﬁ_mode
 =
CAVLC
 ? 
FALSE
 : 
TRUE
);

459 if(
‰ext_¥ofûe
)

461 
µs
->
å™sf‹m_8x8_mode_Êag
 = (
p_I≈
->
Tønsf‹m8x8Mode
 ? 
TRUE
:
FALSE
);

462 
µs
->
pic_sˇlög_m©rix_¥e£¡_Êag
 = (
Boﬁón
Ë((
p_I≈
->
SˇlögM©rixPª£¡Fœg
&2)>>1);

463 
n_SˇlögLi°
 = (
•s
->
chroma_f‹m©_idc
 !
YUV444
) ? 8 : 12;

464 
i
=0; i<
n_SˇlögLi°
; i++)

466 if(
i
<6)

467 
µs
->
pic_sˇlög_li°_¥e£¡_Êag
[
i
] = (
p_I≈
->
SˇlögLi°Pª£¡Fœg
[i]&2)>>1;

470 if(
µs
->
å™sf‹m_8x8_mode_Êag
)

471 
µs
->
pic_sˇlög_li°_¥e£¡_Êag
[
i
] = (
p_I≈
->
SˇlögLi°Pª£¡Fœg
[i]&2)>>1;

473 
µs
->
pic_sˇlög_li°_¥e£¡_Êag
[
i
] = 0;

475 if–
µs
->
pic_sˇlög_m©rix_¥e£¡_Êag
 =
FALSE
 )

476 
µs
->
pic_sˇlög_li°_¥e£¡_Êag
[
i
] = 0;

481 
µs
->
pic_sˇlög_m©rix_¥e£¡_Êag
 = 
FALSE
;

482 
i
=0; i<12; i++)

483 
µs
->
pic_sˇlög_li°_¥e£¡_Êag
[
i
] = 0;

485 
µs
->
å™sf‹m_8x8_mode_Êag
 = 
FALSE
;

486 
p_I≈
->
Tønsf‹m8x8Mode
 = 0;

490 
µs
->
bŸtom_fõld_pic_‹dî_ö_‰ame_¥e£¡_Êag
 = 
p_Vid
->bottom_field_pic_order_in_frame_present_flag;

493 
µs
->
num_¶i˚_groups_möus1
 = 
p_I≈
->num_slice_groups_minus1;

496 i‡(
µs
->
num_¶i˚_groups_möus1
 > 0)

498 i‡((
µs
->
¶i˚_group_id
 = 
	`ˇŒoc
 ((
•s
->
pic_height_ö_m≠_unôs_möus1
+1)*(•s->
pic_width_ö_mbs_möus1
+1), (
byã
))Ë=
NULL
)

499 
	`no_mem_exô
 ("GeneratePictureParameterSet: slice_group_id");

501 
p_I≈
->
¶i˚_group_m≠_ty≥
)

504 
µs
->
¶i˚_group_m≠_ty≥
 = 0;

505 
i
=0; i<=
µs
->
num_¶i˚_groups_möus1
; i++)

507 
µs
->
run_Àngth_möus1
[
i
]=
p_I≈
->run_length_minus1[i];

511 
µs
->
¶i˚_group_m≠_ty≥
 = 1;

515 
µs
->
¶i˚_group_m≠_ty≥
 = 2;

516 
FømeSizeInM≠Unôs
 = (
•s
->
pic_height_ö_m≠_unôs_möus1
Ë* (•s->
pic_width_ö_mbs_möus1
 + 1);

517 
i
=0; i<
µs
->
num_¶i˚_groups_möus1
; i++)

520 
µs
->
t›_À·
[
i
] = 
	`imö
 (
p_I≈
->t›_À·[i], 
FømeSizeInM≠Unôs
);

521 
µs
->
bŸtom_right
[
i
] = 
	`imö
 (
p_I≈
->bŸtom_right[i], 
FømeSizeInM≠Unôs
);

527 
µs
->
¶i˚_group_m≠_ty≥
 = 
p_I≈
->slice_group_map_type;

528 
µs
->
¶i˚_group_ch™ge_dúe˘i⁄_Êag
 = (
Boﬁón
Ë
p_I≈
->slice_group_change_direction_flag;

529 
µs
->
¶i˚_group_ch™ge_øã_möus1
 = 
p_I≈
->slice_group_change_rate_minus1;

532 
µs
->
¶i˚_group_m≠_ty≥
 = 6;

533 
µs
->
pic_size_ö_m≠_unôs_möus1
 =

534 (((
p_I≈
->
ouçut
.
height
[0] + 
p_Vid
->
auto_¸›_bŸtom
)/
MB_BLOCK_SIZE
)/(2-
•s
->
‰ame_mbs_⁄ly_Êag
))

535 *((
p_I≈
->
ouçut
.
width
[0] + 
p_Vid
->
auto_¸›_right
)/
MB_BLOCK_SIZE
) -1;

537 
i
=0;i<=
µs
->
pic_size_ö_m≠_unôs_möus1
; i++)

538 
µs
->
¶i˚_group_id
[
i
] = 
p_I≈
->slice_group_id[i];

542 
	`¥ötf
 ("Parset.c: slice_group_map_type invalid, default\n");

543 
	`as£π
 (0==1);

548 
µs
->
num_ªf_idx_l0_deÁu…_a˘ive_möus1
 = 
•s
->
‰ame_mbs_⁄ly_Êag
 ? (•s->
num_ªf_‰ames
 - 1) : (2 * sps->num_ref_frames - 1) ;

549 
µs
->
num_ªf_idx_l1_deÁu…_a˘ive_möus1
 = 
•s
->
‰ame_mbs_⁄ly_Êag
 ? (•s->
num_ªf_‰ames
 - 1) : (2 * sps->num_ref_frames - 1) ;

551 
µs
->
weighãd_¥ed_Êag
 = (
byã
Ë
WeighãdPªdi˘i⁄
;

552 
µs
->
weighãd_bùªd_idc
 = (
byã
Ë
WeighãdBùªdi˘i⁄
;

554 
µs
->
pic_öô_qp_möus26
 = 0;

555 
µs
->
pic_öô_qs_möus26
 = 0;

557 
µs
->
chroma_qp_ödex_off£t
 = 
cb_qp_ödex_off£t
;

558 i‡(
‰ext_¥ofûe
)

560 
µs
->
cb_qp_ödex_off£t
 = cb_qp_index_offset;

561 
µs
->
¸_qp_ödex_off£t
 = cr_qp_index_offset;

564 
µs
->
cb_qp_ödex_off£t
 =Öps->
¸_qp_ödex_off£t
 =Öps->
chroma_qp_ödex_off£t
;

566 
µs
->
deblockög_fûãr_c⁄åﬁ_¥e£¡_Êag
 = (
Boﬁón
Ë((
p_I≈
->
DFSídP¨amëîs
 !0Ë|| (p_I≈->
RDPi˘uªDeblockög
 != 0));

568 
µs
->
c⁄°øöed_öåa_¥ed_Êag
 = (
Boﬁón
Ë
p_I≈
->
U£C⁄°øöedI¡øPªd
;

571 
µs
->
ªdund™t_pic_˙t_¥e£¡_Êag
 = (
Boﬁón
Ë
p_I≈
->
ªdund™t_pic_Êag
;

572 
	}
}

595 
	$Sˇlög_Li°
(*
sˇlögLi°öput
, *
sˇlögLi°
, 
sizeOfSˇlögLi°
, *
U£DeÁu…SˇlögM©rix
, 
Bô°ªam
 *
bô°ªam
)

597 
j
, 
sˇnj
;

598 
Àn
=0;

599 
dñè_sˇÀ
, 
œ°SˇÀ
, 
√xtSˇÀ
;

601 
œ°SˇÀ
 = 8;

602 
√xtSˇÀ
 = 8;

604 
j
=0; j<
sizeOfSˇlögLi°
; j++)

606 
sˇnj
 = (
sizeOfSˇlögLi°
==16Ë? 
ZZ_SCAN
[
j
]:
ZZ_SCAN8
[j];

608 if(
√xtSˇÀ
!=0)

610 
dñè_sˇÀ
 = 
sˇlögLi°öput
[
sˇnj
]-
œ°SˇÀ
;

611 if(
dñè_sˇÀ
>127)

612 
dñè_sˇÀ
=delta_scale-256;

613 if(
dñè_sˇÀ
<-128)

614 
dñè_sˇÀ
=delta_scale+256;

616 
Àn
+=
	`wrôe_£_v
 (" : dñè_¶ ", 
dñè_sˇÀ
, 
bô°ªam
);

617 
√xtSˇÀ
 = 
sˇlögLi°öput
[
sˇnj
];

618 *
U£DeÁu…SˇlögM©rix
|=(
sˇnj
==0 && 
√xtSˇÀ
==0);

621 
sˇlögLi°
[
sˇnj
] = (Ë((
√xtSˇÀ
==0Ë? 
œ°SˇÀ
:nextScale);

622 
œ°SˇÀ
 = 
sˇlögLi°
[
sˇnj
];

625  
Àn
;

626 
	}
}

648 #i‡(
MVC_EXTENSION_ENABLE
)

649 
	$Gíî©eSeq_∑ømëî_£t_rb•
 (
VideoP¨amëîs
 *
p_Vid
, 
£q_∑ømëî_£t_rb•_t
 *
•s
, 
byã
 *
rb•
, 
Is_Sub£t
)

651 
	$Gíî©eSeq_∑ømëî_£t_rb•
 (
VideoP¨amëîs
 *
p_Vid
, 
£q_∑ømëî_£t_rb•_t
 *
•s
, 
byã
 *
rb•
)

654 
Bô°ªam
 *
bô°ªam
;

655 
Àn
 = 0, 
LíInByãs
;

656 
i
;

657 
n_SˇlögLi°
;

659 
	`as£π
 (
rb•
 !
NULL
);

661 i‡((
bô°ªam
=
	`ˇŒoc
(1, (
Bô°ªam
)))==
NULL
Ë
	`no_mem_exô
("SeqParameterSet:bitstream");

664 
bô°ªam
->
°ªamBuf„r
 = 
rb•
;

665 
bô°ªam
->
bôs_to_go
 = 8;

667 #i‡(
MVC_EXTENSION_ENABLE
)

668 if(
p_Vid
->
p_I≈
->
num_of_võws
==2)

670 if(
Is_Sub£t
==1)

672 
	`as£π
(
•s
->
¥ofûe_idc
==
MULTIVIEW_HIGH
 || sps->¥ofûe_idc==
STEREO_HIGH
);

673 
Àn
+=
	`wrôe_u_v
 (8, "SPS:Örofûe_idc", 
•s
->
¥ofûe_idc
, 
bô°ªam
);

676 
Àn
+=
	`wrôe_u_v
 (8, "SPS:Örofûe_idc", 100, 
bô°ªam
);

680 
Àn
+=
	`wrôe_u_v
 (8, "SPS:Örofûe_idc", 
•s
->
¥ofûe_idc
, 
bô°ªam
);

682 
Àn
+=
	`wrôe_u_1
 ("SPS: c⁄°øöed_£t0_Êag", 
•s
->
c⁄°øöed_£t0_Êag
, 
bô°ªam
);

683 
Àn
+=
	`wrôe_u_1
 ("SPS: c⁄°øöed_£t1_Êag", 
•s
->
c⁄°øöed_£t1_Êag
, 
bô°ªam
);

684 
Àn
+=
	`wrôe_u_1
 ("SPS: c⁄°øöed_£t2_Êag", 
•s
->
c⁄°øöed_£t2_Êag
, 
bô°ªam
);

685 
Àn
+=
	`wrôe_u_1
 ("SPS: c⁄°øöed_£t3_Êag", 
•s
->
c⁄°øöed_£t3_Êag
, 
bô°ªam
);

686 
Àn
+=
	`wrôe_u_v
 (4, "SPS:Ñe£rved_zîo_4bôs", 0, 
bô°ªam
);

688 
Àn
+=
	`wrôe_u_v
 (8, "SPS:Üevñ_idc", 
•s
->
Àvñ_idc
, 
bô°ªam
);

690 
Àn
+=
	`wrôe_ue_v
 ("SPS: seq_∑ømëî_£t_id", 
•s
->
£q_∑ømëî_£t_id
, 
bô°ªam
);

693 if–
	`is_FREXT_¥ofûe
(
•s
->
¥ofûe_idc
) )

695 
Àn
+=
	`wrôe_ue_v
 ("SPS: chroma_f‹m©_idc", 
•s
->
chroma_f‹m©_idc
, 
bô°ªam
);

696 if(
•s
->
chroma_f‹m©_idc
 =
YUV444
)

697 
Àn
+=
	`wrôe_u_1
 ("SPS: sï¨©e_cﬁour_∂™e_Êag", 
•s
->
£∑øã_cﬁour_∂™e_Êag
, 
bô°ªam
);

698 
Àn
+=
	`wrôe_ue_v
 ("SPS: bô_dïth_luma_möus8", 
•s
->
bô_dïth_luma_möus8
, 
bô°ªam
);

699 
Àn
+=
	`wrôe_ue_v
 ("SPS: bô_dïth_chroma_möus8", 
•s
->
bô_dïth_chroma_möus8
, 
bô°ªam
);

701 
Àn
+=
	`wrôe_u_1
 ("SPS:Üos¶ess_qµrime_y_zîo_Êag", 
•s
->
los¶ess_qµrime_Êag
, 
bô°ªam
);

704 
Àn
+=
	`wrôe_u_1
 ("SPS: seq_sˇlög_m©rix_¥e£¡_Êag", 
•s
->
£q_sˇlög_m©rix_¥e£¡_Êag
, 
bô°ªam
);

706 if(
•s
->
£q_sˇlög_m©rix_¥e£¡_Êag
)

708 
SˇÀP¨amëîs
 *
p_QSˇÀ
 = 
p_Vid
->p_QScale;

709 
n_SˇlögLi°
 = (
•s
->
chroma_f‹m©_idc
 !
YUV444
) ? 8 : 12;

710 
i
=0; i<
n_SˇlögLi°
; i++)

712 
Àn
+=
	`wrôe_u_1
 ("SPS: seq_sˇlög_li°_¥e£¡_Êag", 
•s
->
£q_sˇlög_li°_¥e£¡_Êag
[
i
], 
bô°ªam
);

713 if(
•s
->
£q_sˇlög_li°_¥e£¡_Êag
[
i
])

715 if(
i
<6)

716 
Àn
+=
	`Sˇlög_Li°
(
p_QSˇÀ
->
SˇlögLi°4x4öput
[
i
],Ö_QSˇÀ->
SˇlögLi°4x4
[i], 16, &p_QSˇÀ->
U£DeÁu…SˇlögM©rix4x4Fœg
[i], 
bô°ªam
);

718 
Àn
+=
	`Sˇlög_Li°
(
p_QSˇÀ
->
SˇlögLi°8x8öput
[
i
-6],Ö_QSˇÀ->
SˇlögLi°8x8
[i-6], 64, &p_QSˇÀ->
U£DeÁu…SˇlögM©rix8x8Fœg
[i-6], 
bô°ªam
);

724 
Àn
+=
	`wrôe_ue_v
 ("SPS:Üog2_max_‰ame_num_möus4", 
•s
->
log2_max_‰ame_num_möus4
, 
bô°ªam
);

725 
Àn
+=
	`wrôe_ue_v
 ("SPS:Öic_‹dî_˙t_ty≥", 
•s
->
pic_‹dî_˙t_ty≥
, 
bô°ªam
);

727 i‡(
•s
->
pic_‹dî_˙t_ty≥
 == 0)

728 
Àn
+=
	`wrôe_ue_v
 ("SPS:Üog2_max_pic_‹dî_˙t_lsb_möus4", 
•s
->
log2_max_pic_‹dî_˙t_lsb_möus4
, 
bô°ªam
);

729 i‡(
•s
->
pic_‹dî_˙t_ty≥
 == 1)

731 
Àn
+=
	`wrôe_u_1
 ("SPS: dñè_pic_‹dî_Æways_zîo_Êag", 
•s
->
dñè_pic_‹dî_Æways_zîo_Êag
, 
bô°ªam
);

732 
Àn
+=
	`wrôe_£_v
 ("SPS: off£t_f‹_n⁄_ªf_pic", 
•s
->
off£t_f‹_n⁄_ªf_pic
, 
bô°ªam
);

733 
Àn
+=
	`wrôe_£_v
 ("SPS: off£t_f‹_t›_to_bŸtom_fõld", 
•s
->
off£t_f‹_t›_to_bŸtom_fõld
, 
bô°ªam
);

734 
Àn
+=
	`wrôe_ue_v
 ("SPS:Çum_ªf_‰ames_ö_pic_‹dî_˙t_cy˛e", 
•s
->
num_ªf_‰ames_ö_pic_‹dî_˙t_cy˛e
, 
bô°ªam
);

735 
i
=0; i<
•s
->
num_ªf_‰ames_ö_pic_‹dî_˙t_cy˛e
; i++)

736 
Àn
+=
	`wrôe_£_v
 ("SPS: off£t_f‹_ªf_‰ame", 
•s
->
off£t_f‹_ªf_‰ame
[
i
], 
bô°ªam
);

738 
Àn
+=
	`wrôe_ue_v
 ("SPS:Çum_ªf_‰ames", 
•s
->
num_ªf_‰ames
, 
bô°ªam
);

739 
Àn
+=
	`wrôe_u_1
 ("SPS: g≠s_ö_‰ame_num_vÆue_Ælowed_Êag", 
•s
->
g≠s_ö_‰ame_num_vÆue_Ælowed_Êag
, 
bô°ªam
);

740 
Àn
+=
	`wrôe_ue_v
 ("SPS:Öic_width_ö_mbs_möus1", 
•s
->
pic_width_ö_mbs_möus1
, 
bô°ªam
);

741 
Àn
+=
	`wrôe_ue_v
 ("SPS:Öic_height_ö_m≠_unôs_möus1", 
•s
->
pic_height_ö_m≠_unôs_möus1
, 
bô°ªam
);

742 
Àn
+=
	`wrôe_u_1
 ("SPS: føme_mbs_⁄ly_Êag", 
•s
->
‰ame_mbs_⁄ly_Êag
, 
bô°ªam
);

743 i‡(!
•s
->
‰ame_mbs_⁄ly_Êag
)

745 
Àn
+=
	`wrôe_u_1
 ("SPS: mb_ad≠tive_‰ame_fõld_Êag", 
•s
->
mb_ad≠tive_‰ame_fõld_Êag
, 
bô°ªam
);

747 
Àn
+=
	`wrôe_u_1
 ("SPS: dúe˘_8x8_ö„ªn˚_Êag", 
•s
->
dúe˘_8x8_ö„ªn˚_Êag
, 
bô°ªam
);

749 
Àn
+=
	`wrôe_u_1
 ("SPS: føme_¸›pög_Êag", 
•s
->
‰ame_¸›pög_Êag
, 
bô°ªam
);

750 i‡(
•s
->
‰ame_¸›pög_Êag
)

752 
Àn
+=
	`wrôe_ue_v
 ("SPS: føme_¸›_À·_off£t", 
•s
->
‰ame_¸›_À·_off£t
, 
bô°ªam
);

753 
Àn
+=
	`wrôe_ue_v
 ("SPS: føme_¸›_right_off£t", 
•s
->
‰ame_¸›_right_off£t
, 
bô°ªam
);

754 
Àn
+=
	`wrôe_ue_v
 ("SPS: føme_¸›_t›_off£t", 
•s
->
‰ame_¸›_t›_off£t
, 
bô°ªam
);

755 
Àn
+=
	`wrôe_ue_v
 ("SPS: føme_¸›_bŸtom_off£t", 
•s
->
‰ame_¸›_bŸtom_off£t
, 
bô°ªam
);

758 
Àn
+=
	`wrôe_u_1
 ("SPS: vui_∑ømëîs_¥e£¡_Êag", 
•s
->
vui_∑ømëîs_¥e£¡_Êag
, 
bô°ªam
);

760 i‡(
•s
->
vui_∑ømëîs_¥e£¡_Êag
)

761 
Àn
+=
	`Gíî©eVUI_∑ømëîs_rb•
(
•s
, 
bô°ªam
);

763 #i‡(
MVC_EXTENSION_ENABLE
)

764 if(
Is_Sub£t
==1)

767 
Àn
+=
	`wrôe_u_1
 ("SPS: bô_equÆ_to_⁄e", 1, 
bô°ªam
);

771 
Àn
+=
	`wrôe_ue_v
 ("SPS:Çum_võws_möus1", 1, 
bô°ªam
);

772 i‡–
p_Vid
->
p_I≈
->
MVCFlùVõws
 )

774 
Àn
+=
	`wrôe_ue_v
 ("SPS: võw_id[ 0 ]", 1, 
bô°ªam
);

775 
Àn
+=
	`wrôe_ue_v
 ("SPS: võw_id[ 1 ]", 0, 
bô°ªam
);

777 
Àn
+=
	`wrôe_ue_v
 ("SPS:Çum_™ch‹_ªfs_l0[ 1 ]", 1, 
bô°ªam
);

778 
Àn
+=
	`wrôe_ue_v
 ("SPS:ánch‹_ªf_l0[ 1 ][ 0 ]", 1, 
bô°ªam
);

779 
Àn
+=
	`wrôe_ue_v
 ("SPS:Çum_™ch‹_ªfs_l1[ 1 ]", 1, 
bô°ªam
);

780 
Àn
+=
	`wrôe_ue_v
 ("SPS:ánch‹_ªf_l1[ 1 ][ 0 ]", 1, 
bô°ªam
);

782 
Àn
+=
	`wrôe_ue_v
 ("SPS:Çum_n⁄_™ch‹_ªfs_l0[ 1 ]", 1, 
bô°ªam
);

783 
Àn
+=
	`wrôe_ue_v
 ("SPS:Ç⁄_™ch‹_ªf_l0[ 1 ][ 0 ]", 1, 
bô°ªam
);

784 
Àn
+=
	`wrôe_ue_v
 ("SPS:Çum_n⁄_™ch‹_ªfs_l1[ 1 ]", 1, 
bô°ªam
);

785 
Àn
+=
	`wrôe_ue_v
 ("SPS:Ç⁄_™ch‹_ªf_l1[ 1 ][ 0 ]", 1, 
bô°ªam
);

789 
Àn
+=
	`wrôe_ue_v
 ("SPS: võw_id[ 0 ]", 0, 
bô°ªam
);

790 
Àn
+=
	`wrôe_ue_v
 ("SPS: võw_id[ 1 ]", 1, 
bô°ªam
);

792 
Àn
+=
	`wrôe_ue_v
 ("SPS:Çum_™ch‹_ªfs_l0[ 1 ]", 1, 
bô°ªam
);

793 
Àn
+=
	`wrôe_ue_v
 ("SPS:ánch‹_ªf_l0[ 1 ][ 0 ]", 0, 
bô°ªam
);

794 
Àn
+=
	`wrôe_ue_v
 ("SPS:Çum_™ch‹_ªfs_l1[ 1 ]", 1, 
bô°ªam
);

795 
Àn
+=
	`wrôe_ue_v
 ("SPS:ánch‹_ªf_l1[ 1 ][ 0 ]", 0, 
bô°ªam
);

797 
Àn
+=
	`wrôe_ue_v
 ("SPS:Çum_n⁄_™ch‹_ªfs_l0[ 1 ]", 1, 
bô°ªam
);

798 
Àn
+=
	`wrôe_ue_v
 ("SPS:Ç⁄_™ch‹_ªf_l0[ 1 ][ 0 ]", 0, 
bô°ªam
);

799 
Àn
+=
	`wrôe_ue_v
 ("SPS:Çum_n⁄_™ch‹_ªfs_l1[ 1 ]", 1, 
bô°ªam
);

800 
Àn
+=
	`wrôe_ue_v
 ("SPS:Ç⁄_™ch‹_ªf_l1[ 1 ][ 0 ]", 0, 
bô°ªam
);

803 
Àn
+=
	`wrôe_ue_v
 ("SPS:Çum_Àvñ_vÆues_sig«Œed_möus1", 0, 
bô°ªam
);

804 
Àn
+=
	`wrôe_u_v
 (8, "SPS:Üevñ_idc[ 0 ]", 
•s
->
Àvñ_idc
, 
bô°ªam
);

805 
Àn
+=
	`wrôe_ue_v
 ("SPS:Çum_≠∂iˇbÀ_›s_möus1[ 0 ]", 0, 
bô°ªam
);

806 
Àn
+=
	`wrôe_u_v
 (3, "SPS:áµliˇbÀ_›_ãmp‹Æ_id[ 0 ][ 0 ]", 0, 
bô°ªam
);

807 
Àn
+=
	`wrôe_ue_v
 ("SPS:áµliˇbÀ_›_num_èrgë_võws_möus1[ 0 ][ 0 ]", 0, 
bô°ªam
);

808 
Àn
+=
	`wrôe_ue_v
 ("SPS:áµliˇbÀ_›_èrgë_võw_id[ 0 ][ 0 ][ 0 ]", 0, 
bô°ªam
);

809 
Àn
+=
	`wrôe_ue_v
 ("SPS:áµliˇbÀ_›_num_võws_möus1[ 0 ][ 0 ]", 0, 
bô°ªam
);

812 
Àn
+=
	`wrôe_u_1
 ("SPS: mvc_vui_∑ømëîs_¥e£¡_Êag", 
•s
->
vui_∑ømëîs_¥e£¡_Êag
, 
bô°ªam
);

814 if(
•s
->
vui_∑ømëîs_¥e£¡_Êag
)

816 
Àn
+=
	`wrôe_ue_v
 ( "SPS: vui_mvc_num_›s_möus1", 0, 
bô°ªam
);

817 
Àn
+=
	`wrôe_u_v
 ( 3, "SPS: vui_mvc_ãmp‹Æ_id[ 0 ]", 0, 
bô°ªam
);

818 
Àn
+=
	`wrôe_ue_v
 ( "SPS: vui_mvc_num_èrgë_ouçut_võws_möus1[ 0 ]", 0, 
bô°ªam
);

819 
Àn
+=
	`wrôe_ue_v
 ( "SPS: vui_mvc_võw_id[ 0 ][ 0 ]", 0, 
bô°ªam
);

820 
Àn
+=
	`wrôe_u_1
 ( "SPS: vui_mvc_timög_öfo_¥e£¡_Êag[ 0 ]", 
•s
->
vui_∑ømëîs_¥e£¡_Êag
, 
bô°ªam
);

821 
Àn
+=
	`wrôe_u_v
 (32, "SPS: vui_mvc_num_unôs_ö_tick[ 0 ]", 
•s
->
vui_£q_∑ømëîs
.
num_unôs_ö_tick
, 
bô°ªam
);

822 
Àn
+=
	`wrôe_u_v
 (32, "SPS: vui_mvc_time_sˇÀ[ 0 ]", 
•s
->
vui_£q_∑ømëîs
.
time_sˇÀ
, 
bô°ªam
);

823 
Àn
+=
	`wrôe_u_1
 ( "SPS: vui_mvc_fixed_‰ame_øã_Êag[ 0 ]", 
•s
->
vui_£q_∑ømëîs
.
fixed_‰ame_øã_Êag
, 
bô°ªam
);

824 
Àn
+=
	`wrôe_u_1
 ( "SPS: vui_mvc_«l_hrd_∑ømëîs_¥e£¡_Êag[ 0 ]", 
•s
->
vui_£q_∑ømëîs
.
«l_hrd_∑ømëîs_¥e£¡_Êag
, 
bô°ªam
);

825 if(
•s
->
vui_£q_∑ømëîs
.
«l_hrd_∑ømëîs_¥e£¡_Êag
)

827 
Àn
 +
	`WrôeHRDP¨amëîs
(
•s
, 
bô°ªam
);

829 
Àn
+=
	`wrôe_u_1
 ("SPS: vui_mvc_v˛_hrd_∑ømëîs_¥e£¡_Êag[ 0 ]", 
•s
->
vui_£q_∑ømëîs
.
v˛_hrd_∑ømëîs_¥e£¡_Êag
, 
bô°ªam
);

830 i‡–
•s
->
vui_£q_∑ømëîs
.
v˛_hrd_∑ømëîs_¥e£¡_Êag
 )

832 
Àn
 +
	`WrôeHRDP¨amëîs
(
•s
, 
bô°ªam
);

834 i‡–
•s
->
vui_£q_∑ømëîs
.
«l_hrd_∑ømëîs_¥e£¡_Êag
 || sps->vui_£q_∑ømëîs.
v˛_hrd_∑ømëîs_¥e£¡_Êag
 )

836 
Àn
+=
	`wrôe_u_1
 ("SPS: vui_mvc_low_dñay_hrd_Êag[ 0 ]", 
•s
->
vui_£q_∑ømëîs
.
low_dñay_hrd_Êag
, 
bô°ªam
 );

838 
Àn
+=
	`wrôe_u_1
 ("SPS: vui_mvc_pic_°ru˘_¥e£¡_Êag[ 0 ]", 
•s
->
vui_£q_∑ømëîs
.
pic_°ru˘_¥e£¡_Êag
, 
bô°ªam
);

842 
Àn
+=
	`wrôe_u_1
 ("SPS:áddôi⁄Æ_exãnsi⁄2_Êag", 0, 
bô°ªam
);

846 
	`SODBtoRBSP
(
bô°ªam
);

848 
LíInByãs
=
bô°ªam
->
byã_pos
;

850 
	`‰ì
 (
bô°ªam
);

852  
LíInByãs
;

853 
	}
}

877 
	$Gíî©ePic_∑ømëî_£t_rb•
 (
VideoP¨amëîs
 *
p_Vid
, 
pic_∑ømëî_£t_rb•_t
 *
µs
, 
byã
 *
rb•
)

879 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

880 
Bô°ªam
 *
bô°ªam
;

881 
Àn
 = 0, 
LíInByãs
;

882 
i
;

883 
¥ofûe_idc
;

885 
	`as£π
 (
rb•
 !
NULL
);

887 i‡((
bô°ªam
=
	`ˇŒoc
(1, (
Bô°ªam
)))==
NULL
Ë
	`no_mem_exô
("PicParameterSet:bitstream");

890 
bô°ªam
->
°ªamBuf„r
 = 
rb•
;

891 
bô°ªam
->
bôs_to_go
 = 8;

893 
µs
->
bŸtom_fõld_pic_‹dî_ö_‰ame_¥e£¡_Êag
 = 
p_Vid
->bottom_field_pic_order_in_frame_present_flag;

895 
Àn
 +
	`wrôe_ue_v
 ("PPS:Öic_∑ømëî_£t_id", 
µs
->
pic_∑ømëî_£t_id
, 
bô°ªam
);

896 
Àn
 +
	`wrôe_ue_v
 ("PPS: seq_∑ømëî_£t_id", 
µs
->
£q_∑ømëî_£t_id
, 
bô°ªam
);

897 
Àn
 +
	`wrôe_u_1
 ("PPS:É¡r›y_codög_mode_Êag", 
µs
->
íå›y_codög_mode_Êag
, 
bô°ªam
);

898 
Àn
 +
	`wrôe_u_1
 ("PPS: bŸtom_fõld_pic_‹dî_ö_‰ame_¥e£¡_Êag", 
µs
->
bŸtom_fõld_pic_‹dî_ö_‰ame_¥e£¡_Êag
, 
bô°ªam
);

899 
Àn
 +
	`wrôe_ue_v
 ("PPS:Çum_¶i˚_groups_möus1", 
µs
->
num_¶i˚_groups_möus1
, 
bô°ªam
);

902 if(
µs
->
num_¶i˚_groups_möus1
 > 0 )

904 
Àn
 +
	`wrôe_ue_v
 ("PPS: sli˚_group_m≠_ty≥", 
µs
->
¶i˚_group_m≠_ty≥
, 
bô°ªam
);

905 i‡(
µs
->
¶i˚_group_m≠_ty≥
 == 0)

906 
i
=0; i<=
µs
->
num_¶i˚_groups_möus1
; i++)

907 
Àn
 +
	`wrôe_ue_v
 ("PPS:Ñun_Àngth_möus1[i]", 
µs
->
run_Àngth_möus1
[
i
], 
bô°ªam
);

908 i‡(
µs
->
¶i˚_group_m≠_ty≥
==2)

910 
i
=0; i<
µs
->
num_¶i˚_groups_möus1
; i++)

912 
Àn
 +
	`wrôe_ue_v
 ("PPS:Å›_À·[i]", 
µs
->
t›_À·
[
i
], 
bô°ªam
);

913 
Àn
 +
	`wrôe_ue_v
 ("PPS: bŸtom_right[i]", 
µs
->
bŸtom_right
[
i
], 
bô°ªam
);

916 i‡(
µs
->
¶i˚_group_m≠_ty≥
 == 3 ||

917 
µs
->
¶i˚_group_m≠_ty≥
 == 4 ||

918 
µs
->
¶i˚_group_m≠_ty≥
 == 5)

920 
Àn
 +
	`wrôe_u_1
 ("PPS: sli˚_group_ch™ge_dúe˘i⁄_Êag", 
µs
->
¶i˚_group_ch™ge_dúe˘i⁄_Êag
, 
bô°ªam
);

921 
Àn
 +
	`wrôe_ue_v
 ("PPS: sli˚_group_ch™ge_øã_möus1", 
µs
->
¶i˚_group_ch™ge_øã_möus1
, 
bô°ªam
);

923 i‡(
µs
->
¶i˚_group_m≠_ty≥
 == 6)

925 
NumbîBôsPîSli˚GroupId
 = 0;

927 i‡(
µs
->
num_¶i˚_groups_möus1
>=4)

928 
NumbîBôsPîSli˚GroupId
=3;

929 i‡(
µs
->
num_¶i˚_groups_möus1
>=2)

930 
NumbîBôsPîSli˚GroupId
=2;

931 i‡(
µs
->
num_¶i˚_groups_möus1
>=1)

932 
NumbîBôsPîSli˚GroupId
=1;

934 
Àn
 +
	`wrôe_ue_v
 ("PPS:Öic_size_ö_m≠_unôs_möus1", 
µs
->
pic_size_ö_m≠_unôs_möus1
, 
bô°ªam
);

935 
i
 = 0; i <
µs
->
pic_size_ö_m≠_unôs_möus1
; i++)

936 
Àn
 +
	`wrôe_u_v
 (
NumbîBôsPîSli˚GroupId
, "PPS: >¶i˚_group_id[i]", 
µs
->
¶i˚_group_id
[
i
], 
bô°ªam
);

941 
Àn
 +
	`wrôe_ue_v
 ("PPS:Çum_ªf_idx_l0_deÁu…_a˘ive_möus1", 
µs
->
num_ªf_idx_l0_deÁu…_a˘ive_möus1
, 
bô°ªam
);

942 
Àn
 +
	`wrôe_ue_v
 ("PPS:Çum_ªf_idx_l1_deÁu…_a˘ive_möus1", 
µs
->
num_ªf_idx_l1_deÁu…_a˘ive_möus1
, 
bô°ªam
);

943 
Àn
 +
	`wrôe_u_1
 ("PPS: weighãd_¥ed_Êag", 
µs
->
weighãd_¥ed_Êag
, 
bô°ªam
);

944 
Àn
 +
	`wrôe_u_v
 (2, "PPS: weighãd_bùªd_idc", 
µs
->
weighãd_bùªd_idc
, 
bô°ªam
);

945 
Àn
 +
	`wrôe_£_v
 ("PPS:Öic_öô_qp_möus26", 
µs
->
pic_öô_qp_möus26
, 
bô°ªam
);

946 
Àn
 +
	`wrôe_£_v
 ("PPS:Öic_öô_qs_möus26", 
µs
->
pic_öô_qs_möus26
, 
bô°ªam
);

948 
¥ofûe_idc
 = 
	`idítify_¥ofûe
(
p_I≈
);

949 if–
	`is_FREXT_¥ofûe
(
¥ofûe_idc
) )

950 
Àn
 +
	`wrôe_£_v
 ("PPS: chroma_qp_ödex_off£t", 
µs
->
cb_qp_ödex_off£t
, 
bô°ªam
);

952 
Àn
 +
	`wrôe_£_v
 ("PPS: chroma_qp_ödex_off£t", 
µs
->
chroma_qp_ödex_off£t
, 
bô°ªam
);

954 
Àn
 +
	`wrôe_u_1
 ("PPS: deblockög_fûãr_c⁄åﬁ_¥e£¡_Êag", 
µs
->
deblockög_fûãr_c⁄åﬁ_¥e£¡_Êag
, 
bô°ªam
);

955 
Àn
 +
	`wrôe_u_1
 ("PPS: c⁄°øöed_öåa_¥ed_Êag", 
µs
->
c⁄°øöed_öåa_¥ed_Êag
, 
bô°ªam
);

956 
Àn
 +
	`wrôe_u_1
 ("PPS:Ñedund™t_pic_˙t_¥e£¡_Êag", 
µs
->
ªdund™t_pic_˙t_¥e£¡_Êag
, 
bô°ªam
);

959 if–
	`is_FREXT_¥ofûe
(
¥ofûe_idc
) )

961 
Àn
 +
	`wrôe_u_1
 ("PPS:Åønsf‹m_8x8_mode_Êag", 
µs
->
å™sf‹m_8x8_mode_Êag
, 
bô°ªam
);

962 
Àn
 +
	`wrôe_u_1
 ("PPS:Öic_sˇlög_m©rix_¥e£¡_Êag", 
µs
->
pic_sˇlög_m©rix_¥e£¡_Êag
, 
bô°ªam
);

964 if(
µs
->
pic_sˇlög_m©rix_¥e£¡_Êag
)

966 
SˇÀP¨amëîs
 *
p_QSˇÀ
 = 
p_Vid
->p_QScale;

967 
n_SˇlögLi°
 = 6 + ((
p_Vid
->
a˘ive_•s
->
chroma_f‹m©_idc
 !3Ë? 2 : 6Ë* 
µs
->
å™sf‹m_8x8_mode_Êag
;

969 
i
=0; i<
n_SˇlögLi°
; i++)

971 
Àn
 +
	`wrôe_u_1
 ("PPS:Öic_sˇlög_li°_¥e£¡_Êag", 
µs
->
pic_sˇlög_li°_¥e£¡_Êag
[
i
], 
bô°ªam
);

973 if(
µs
->
pic_sˇlög_li°_¥e£¡_Êag
[
i
])

975 if(
i
 < 6)

976 
Àn
 +
	`Sˇlög_Li°
(
p_QSˇÀ
->
SˇlögLi°4x4öput
[
i
],Ö_QSˇÀ->
SˇlögLi°4x4
[i], 16, &p_QSˇÀ->
U£DeÁu…SˇlögM©rix4x4Fœg
[i], 
bô°ªam
);

978 
Àn
 +
	`Sˇlög_Li°
(
p_QSˇÀ
->
SˇlögLi°8x8öput
[
i
-6],Ö_QSˇÀ->
SˇlögLi°8x8
[i-6], 64, &p_QSˇÀ->
U£DeÁu…SˇlögM©rix8x8Fœg
[i-6], 
bô°ªam
);

982 
Àn
 +
	`wrôe_£_v
 ("PPS: sec⁄d_chroma_qp_ödex_off£t", 
µs
->
¸_qp_ödex_off£t
, 
bô°ªam
);

985 
	`SODBtoRBSP
(
bô°ªam
);

987 
LíInByãs
 = 
bô°ªam
->
byã_pos
;

990 
	`‰ì
 (
bô°ªam
);

992  
LíInByãs
;

993 
	}
}

1015 
	$idítify_¥ofûe
(
I≈utP¨amëîs
 *
p_I≈
)

1017  
p_I≈
->
ProfûeIDC
;

1018 
	}
}

1033 
	$idítify_Àvñ
(
I≈utP¨amëîs
 *
p_I≈
)

1035  
p_I≈
->
LevñIDC
;

1036 
	}
}

1048 
	$Gíî©eVUI_∑ømëîs_rb•
(
£q_∑ømëî_£t_rb•_t
 *
•s
, 
Bô°ªam
 *
bô°ªam
)

1050 
Àn
=0;

1051 
vui_£q_∑ømëîs_t
 *
vui_£q_∑ømëîs
 = &(
•s
->vui_seq_parameters);

1053 
Àn
+=
	`wrôe_u_1
 ("VUI:á•e˘_øtio_öfo_¥e£¡_Êag", 
vui_£q_∑ømëîs
->
a•e˘_øtio_öfo_¥e£¡_Êag
, 
bô°ªam
);

1054 i‡(
vui_£q_∑ømëîs
->
a•e˘_øtio_öfo_¥e£¡_Êag
)

1056 
Àn
+=
	`wrôe_u_v
 (8,"VUI:á•e˘_øtio_idc", 
vui_£q_∑ømëîs
->
a•e˘_øtio_idc
, 
bô°ªam
);

1057 i‡(
vui_£q_∑ømëîs
->
a•e˘_øtio_idc
 == 255)

1059 
Àn
+=
	`wrôe_u_v
 (16,"VUI: s¨_width", 
vui_£q_∑ømëîs
->
ßr_width
, 
bô°ªam
);

1060 
Àn
+=
	`wrôe_u_v
 (16,"VUI: s¨_height", 
vui_£q_∑ømëîs
->
ßr_height
, 
bô°ªam
);

1064 
Àn
+=
	`wrôe_u_1
 ("VUI: ovîsˇn_öfo_¥e£¡_Êag", 
vui_£q_∑ømëîs
->
ovîsˇn_öfo_¥e£¡_Êag
, 
bô°ªam
);

1065 i‡(
vui_£q_∑ømëîs
->
ovîsˇn_öfo_¥e£¡_Êag
)

1067 
Àn
+=
	`wrôe_u_1
 ("VUI: ovîsˇn_≠¥›rüã_Êag", 
vui_£q_∑ømëîs
->
ovîsˇn_≠¥›rüã_Êag
, 
bô°ªam
);

1070 
Àn
+=
	`wrôe_u_1
 ("VUI: video_sig«l_ty≥_¥e£¡_Êag", 
vui_£q_∑ømëîs
->
video_sig«l_ty≥_¥e£¡_Êag
, 
bô°ªam
);

1071 i‡(
vui_£q_∑ømëîs
->
video_sig«l_ty≥_¥e£¡_Êag
)

1073 
Àn
+=
	`wrôe_u_v
 (3,"VUI: video_f‹m©", 
vui_£q_∑ømëîs
->
video_f‹m©
, 
bô°ªam
);

1074 
Àn
+=
	`wrôe_u_1
 ("VUI: video_fuŒ_ønge_Êag", 
vui_£q_∑ømëîs
->
video_fuŒ_ønge_Êag
, 
bô°ªam
);

1075 
Àn
+=
	`wrôe_u_1
 ("VUI: cﬁour_des¸ùti⁄_¥e£¡_Êag", 
vui_£q_∑ømëîs
->
cﬁour_des¸ùti⁄_¥e£¡_Êag
, 
bô°ªam
);

1076 i‡(
vui_£q_∑ømëîs
->
cﬁour_des¸ùti⁄_¥e£¡_Êag
)

1078 
Àn
+=
	`wrôe_u_v
 (8,"VUI: cﬁour_¥im¨õs", 
vui_£q_∑ømëîs
->
cﬁour_¥im¨õs
, 
bô°ªam
);

1079 
Àn
+=
	`wrôe_u_v
 (8,"VUI:Åøns„r_ch¨a˘îi°ics", 
vui_£q_∑ømëîs
->
å™s„r_ch¨a˘îi°ics
, 
bô°ªam
);

1080 
Àn
+=
	`wrôe_u_v
 (8,"VUI: m©rix_c€fficõ¡s", 
vui_£q_∑ømëîs
->
m©rix_c€fficõ¡s
, 
bô°ªam
);

1084 
Àn
+=
	`wrôe_u_1
 ("VUI: chroma_loc_öfo_¥e£¡_Êag", 
vui_£q_∑ømëîs
->
chroma_loˇti⁄_öfo_¥e£¡_Êag
, 
bô°ªam
);

1085 i‡(
vui_£q_∑ømëîs
->
chroma_loˇti⁄_öfo_¥e£¡_Êag
)

1087 
Àn
+=
	`wrôe_ue_v
 ("VUI: chroma_ßm∂e_loc_ty≥_t›_fõld", 
vui_£q_∑ømëîs
->
chroma_ßm∂e_loc_ty≥_t›_fõld
, 
bô°ªam
);

1088 
Àn
+=
	`wrôe_ue_v
 ("VUI: chroma_ßm∂e_loc_ty≥_bŸtom_fõld", 
vui_£q_∑ømëîs
->
chroma_ßm∂e_loc_ty≥_bŸtom_fõld
, 
bô°ªam
);

1091 
Àn
+=
	`wrôe_u_1
 ("VUI:Åimög_öfo_¥e£¡_Êag", 
vui_£q_∑ømëîs
->
timög_öfo_¥e£¡_Êag
, 
bô°ªam
);

1093 i‡(
vui_£q_∑ømëîs
->
timög_öfo_¥e£¡_Êag
)

1095 
Àn
+=
	`wrôe_u_v
 (32,"VUI:Çum_unôs_ö_tick", 
vui_£q_∑ømëîs
->
num_unôs_ö_tick
, 
bô°ªam
);

1096 
Àn
+=
	`wrôe_u_v
 (32,"VUI:Åime_sˇÀ", 
vui_£q_∑ømëîs
->
time_sˇÀ
, 
bô°ªam
);

1097 
Àn
+=
	`wrôe_u_1
 ("VUI: fixed_‰ame_øã_Êag", 
vui_£q_∑ømëîs
->
fixed_‰ame_øã_Êag
, 
bô°ªam
);

1101 
Àn
+=
	`wrôe_u_1
 ("VUI:ÇÆ_hrd_∑ømëîs_¥e£¡_Êag", 
vui_£q_∑ømëîs
->
«l_hrd_∑ømëîs_¥e£¡_Êag
, 
bô°ªam
);

1102 i‡–
vui_£q_∑ømëîs
->
«l_hrd_∑ømëîs_¥e£¡_Êag
 )

1104 
Àn
 +
	`WrôeHRDP¨amëîs
(
•s
, 
bô°ªam
);

1107 
Àn
+=
	`wrôe_u_1
 ("VUI: v˛_hrd_∑ømëîs_¥e£¡_Êag", 
vui_£q_∑ømëîs
->
v˛_hrd_∑ømëîs_¥e£¡_Êag
, 
bô°ªam
);

1108 i‡–
vui_£q_∑ømëîs
->
v˛_hrd_∑ømëîs_¥e£¡_Êag
 )

1110 
Àn
 +
	`WrôeHRDP¨amëîs
(
•s
, 
bô°ªam
);

1112 i‡–
vui_£q_∑ømëîs
->
«l_hrd_∑ømëîs_¥e£¡_Êag
 || vui_£q_∑ømëîs->
v˛_hrd_∑ømëîs_¥e£¡_Êag
 )

1114 
Àn
+=
	`wrôe_u_1
 ("VUI:Üow_dñay_hrd_Êag", 
vui_£q_∑ømëîs
->
low_dñay_hrd_Êag
, 
bô°ªam
 );

1116 
Àn
+=
	`wrôe_u_1
 ("VUI:Öic_°ru˘_¥e£¡_Êag", 
vui_£q_∑ømëîs
->
pic_°ru˘_¥e£¡_Êag
, 
bô°ªam
);

1118 
Àn
+=
	`wrôe_u_1
 ("VUI: bô°ªam_ª°ri˘i⁄_Êag", 
vui_£q_∑ømëîs
->
bô°ªam_ª°ri˘i⁄_Êag
, 
bô°ªam
);

1119 i‡(
vui_£q_∑ømëîs
->
bô°ªam_ª°ri˘i⁄_Êag
)

1121 
Àn
+=
	`wrôe_u_1
 ("VUI: mŸi⁄_ve˘‹s_ovî_pic_bound¨õs_Êag", 
vui_£q_∑ømëîs
->
mŸi⁄_ve˘‹s_ovî_pic_bound¨õs_Êag
, 
bô°ªam
);

1122 
Àn
+=
	`wrôe_ue_v
 ("VUI: max_byãs_≥r_pic_díom", 
vui_£q_∑ømëîs
->
max_byãs_≥r_pic_díom
, 
bô°ªam
);

1123 
Àn
+=
	`wrôe_ue_v
 ("VUI: max_bôs_≥r_mb_díom", 
vui_£q_∑ømëîs
->
max_bôs_≥r_mb_díom
, 
bô°ªam
);

1124 
Àn
+=
	`wrôe_ue_v
 ("VUI:Üog2_max_mv_Àngth_h‹iz⁄èl", 
vui_£q_∑ømëîs
->
log2_max_mv_Àngth_h‹iz⁄èl
, 
bô°ªam
);

1125 
Àn
+=
	`wrôe_ue_v
 ("VUI:Üog2_max_mv_Àngth_vîtiˇl", 
vui_£q_∑ømëîs
->
log2_max_mv_Àngth_vîtiˇl
, 
bô°ªam
);

1126 
Àn
+=
	`wrôe_ue_v
 ("VUI:Çum_ª‹dî_‰ames", 
vui_£q_∑ømëîs
->
num_ª‹dî_‰ames
, 
bô°ªam
);

1127 
Àn
+=
	`wrôe_ue_v
 ("VUI: max_dec_‰ame_buf„rög", 
vui_£q_∑ømëîs
->
max_dec_‰ame_buf„rög
, 
bô°ªam
);

1130  
Àn
;

1131 
	}
}

1143 
NALU_t
 *
	$Gíî©eSEImesßge_NALU
(
I≈utP¨amëîs
 *
p_I≈
)

1145 
NALU_t
 *
n
 = 
	`AŒocNALU
(
MAXNALUSIZE
);

1146 
RBSPÀn
 = 0;

1147 
byã
 
rb•
[
MAXRBSPSIZE
];

1149 
RBSPÀn
 = 
	`Gíî©eSEImesßge_rb•
 (
p_I≈
, 
NORMAL_SEI
, 
rb•
);

1150 
	`RBSPtoNALU
 (
rb•
, 
n
, 
RBSPÀn
, 
NALU_TYPE_SEI
, 
NALU_PRIORITY_DISPOSABLE
, 1);

1151 
n
->
°¨tcodïªfix_Àn
 = 4;

1153  
n
;

1154 
	}
}

1169 
	$Gíî©eSEImesßge_rb•
 (
I≈utP¨amëîs
 *
p_I≈
, 
id
, 
byã
 *
rb•
)

1171 
Bô°ªam
 *
bô°ªam
;

1173 
Àn
 = 0, 
LíInByãs
;

1174 
	`as£π
 (
rb•
 !
NULL
);

1176 i‡((
bô°ªam
=
	`ˇŒoc
(1, (
Bô°ªam
)))==
NULL
)

1177 
	`no_mem_exô
("SeqParameterSet:bitstream");

1180 
bô°ªam
->
°ªamBuf„r
 = 
rb•
;

1181 
bô°ªam
->
bôs_to_go
 = 8;

1184 
£i_mesßge
[500] = "";

1185 
uuid_mesßge
[9] = "Random";

1186 
i
, 
mesßge_size
 = (Ë
	`°æí
(
p_I≈
->
SEIMesßgeText
);

1187 
TIME_T
 
°¨t_time
;

1188 
	`gëtime
(&
°¨t_time
);

1190 i‡(
mesßge_size
 == 0)

1192 
mesßge_size
 = 13;

1193 
	`°∫˝y
(
£i_mesßge
,"Em±y Mesßge",
mesßge_size
);

1196 
	`°∫˝y
(
£i_mesßge
,
p_I≈
->
SEIMesßgeText
,
mesßge_size
);

1198 
Àn
+=
	`wrôe_u_v
 (8,"SEI:Üa°_∑ylﬂd_ty≥_byã", 5, 
bô°ªam
);

1199 
mesßge_size
 += 17;

1200 
mesßge_size
 > 254)

1202 
Àn
+=
	`wrôe_u_v
 (8,"SEI: ff_byã",255, 
bô°ªam
);

1203 
mesßge_size
 -= 255;

1205 
Àn
+=
	`wrôe_u_v
 (8,"SEI:Üa°_∑ylﬂd_size_byã",
mesßge_size
, 
bô°ªam
);

1208 #ifde‡
_WIN32


1209 
Àn
+=
	`wrôe_u_v
 (32,"SEI: uuid_iso_õc_11578",(Ë
°¨t_time
.
HighP¨t
, 
bô°ªam
);

1210 
Àn
+=
	`wrôe_u_v
 (32,"SEI: uuid_iso_õc_11578",(Ë
°¨t_time
.
QuadP¨t
, 
bô°ªam
);

1212 
Àn
+=
	`wrôe_u_v
 (32,"SEI: uuid_iso_õc_11578",(Ë
°¨t_time
.
tv_£c
, 
bô°ªam
);

1213 
Àn
+=
	`wrôe_u_v
 (32,"SEI: uuid_iso_õc_11578",(Ë
°¨t_time
.
tv_u£c
, 
bô°ªam
);

1215 
Àn
+=
	`wrôe_u_v
 (32,"SEI: uuid_iso_õc_11578",(Ë(
uuid_mesßge
[0] << 24Ë+ (uuid_mesßge[1] << 16Ë+ (uuid_mesßge[2] << 8Ë+ (uuid_mesßge[3] << 0), 
bô°ªam
);

1216 
Àn
+=
	`wrôe_u_v
 (32,"SEI: uuid_iso_õc_11578",(Ë(
uuid_mesßge
[4] << 24Ë+ (uuid_mesßge[5] << 16Ë+ (uuid_mesßge[6] << 8Ë+ (uuid_mesßge[7] << 0), 
bô°ªam
);

1217 
i
 = 0; i < 
	`°æí
(
£i_mesßge
); i++)

1218 
Àn
+=
	`wrôe_u_v
 (8,"SEI: u£r_d©a_∑ylﬂd_byã",
£i_mesßge
[
i
], 
bô°ªam
);

1220 
Àn
+=
	`wrôe_u_v
 (8,"SEI: u£r_d©a_∑ylﬂd_byã", 0, 
bô°ªam
);

1222 
	`SODBtoRBSP
(
bô°ªam
);

1224 
LíInByãs
=
bô°ªam
->
byã_pos
;

1226 
	`‰ì
(
bô°ªam
);

1227  
LíInByãs
;

1228 
	}
}

1243 
	$WrôeHRDP¨amëîs
(
£q_∑ømëî_£t_rb•_t
 *
•s
, 
Bô°ªam
 *
bô°ªam
)

1246 
Àn
 = 0;

1247 
SchedSñIdx
 = 0;

1248 
hrd_∑ømëîs_t
 *
hrd
 = &(
•s
->
vui_£q_∑ømëîs
.
«l_hrd_∑ømëîs
);

1250 
Àn
+=
	`wrôe_ue_v
 ("VUI: cpb_˙t_möus1", 
hrd
->
˝b_˙t_möus1
, 
bô°ªam
);

1251 
Àn
+=
	`wrôe_u_v
 (4, "VUI: bô_øã_sˇÀ", 
hrd
->
bô_øã_sˇÀ
, 
bô°ªam
);

1252 
Àn
+=
	`wrôe_u_v
 (4, "VUI: cpb_size_sˇÀ", 
hrd
->
˝b_size_sˇÀ
, 
bô°ªam
);

1254  
SchedSñIdx
 = 0; SchedSñIdx <(
hrd
->
˝b_˙t_möus1
); SchedSelIdx++ )

1256 
Àn
+=
	`wrôe_ue_v
 ("VUI: bô_øã_vÆue_möus1", 
hrd
->
bô_øã_vÆue_möus1
[
SchedSñIdx
], 
bô°ªam
);

1257 
Àn
+=
	`wrôe_ue_v
 ("VUI: cpb_size_vÆue_möus1", 
hrd
->
˝b_size_vÆue_möus1
[
SchedSñIdx
], 
bô°ªam
);

1258 
Àn
+=
	`wrôe_u_1
 ("VUI: cbr_Êag", 
hrd
->
cbr_Êag
[
SchedSñIdx
], 
bô°ªam
);

1261 
Àn
+=
	`wrôe_u_v
 (5, "VUI: inôül_˝b_ªmovÆ_dñay_Àngth_möus1", 
hrd
->
öôül_˝b_ªmovÆ_dñay_Àngth_möus1
, 
bô°ªam
);

1262 
Àn
+=
	`wrôe_u_v
 (5, "VUI: cpb_ªmovÆ_dñay_Àngth_möus1", 
hrd
->
˝b_ªmovÆ_dñay_Àngth_möus1
, 
bô°ªam
);

1263 
Àn
+=
	`wrôe_u_v
 (5, "VUI: dpb_ouçut_dñay_Àngth_möus1", 
hrd
->
dpb_ouçut_dñay_Àngth_möus1
, 
bô°ªam
);

1264 
Àn
+=
	`wrôe_u_v
 (5, "VUI:Åime_off£t_Àngth", 
hrd
->
time_off£t_Àngth
, 
bô°ªam
);

1266  
Àn
;

1267 
	}
}

1277 
	$gëMaxDpbSize
(
£q_∑ømëî_£t_rb•_t
 *
a˘ive_•s
)

1279 
pic_size
 = (
a˘ive_•s
->
pic_width_ö_mbs_möus1
 + 1Ë* (a˘ive_•s->
pic_height_ö_m≠_unôs_möus1
 + 1Ë* (a˘ive_•s->
‰ame_mbs_⁄ly_Êag
?1:2) * 384;

1281 
size
 = 0;

1283 
a˘ive_•s
->
Àvñ_idc
)

1286 
size
 = 152064;

1289 
size
 = 152064;

1292 i‡(!
	`is_FREXT_¥ofûe
(
a˘ive_•s
->
¥ofûe_idc
Ë&& (a˘ive_•s->
c⁄°øöed_£t3_Êag
 == 1))

1293 
size
 = 152064;

1295 
size
 = 345600;

1298 
size
 = 912384;

1301 
size
 = 912384;

1304 
size
 = 912384;

1307 
size
 = 1824768;

1310 
size
 = 3110400;

1313 
size
 = 3110400;

1316 
size
 = 6912000;

1319 
size
 = 7864320;

1322 
size
 = 12582912;

1325 
size
 = 12582912;

1328 
size
 = 13369344;

1331 
size
 = 42393600;

1334 
size
 = 70778880;

1337 
size
 = 70778880;

1340 
	`îr‹
 ("undefinedÜevel", 500);

1344 
size
 /
pic_size
;

1345 
size
 = 
	`imö
( size, 16);

1347  
size
;

1348 
	}
}

1363 
	$Gíî©eVUIP¨amëîs
(
£q_∑ømëî_£t_rb•_t
 *
•s
, 
I≈utP¨amëîs
 *
p_I≈
)

1365 
SchedSñIdx
;

1366 
hrd_∑ømëîs_t
 *
«l_hrd
 = &(
•s
->
vui_£q_∑ømëîs
.
«l_hrd_∑ømëîs
);

1367 
hrd_∑ømëîs_t
 *
v˛_hrd
 = &(
•s
->
vui_£q_∑ømëîs
.
v˛_hrd_∑ømëîs
);

1368 
vui_£q_∑ømëîs_t
 *
vui
 = &(
•s
->
vui_£q_∑ømëîs
);

1369 
VUIP¨amëîs
 *
iVui
 = &
p_I≈
->
VUI
;

1371 
vui
->
a•e˘_øtio_öfo_¥e£¡_Êag
 = (
Boﬁón
Ë
iVui
->aspect_ratio_info_present_flag;

1372 
vui
->
a•e˘_øtio_idc
 = (Ë
iVui
->aspect_ratio_idc;

1373 
vui
->
ßr_width
 = (Ë
iVui
->sar_width;

1374 
vui
->
ßr_height
 = (Ë
iVui
->sar_height;

1375 
vui
->
ovîsˇn_öfo_¥e£¡_Êag
 = (
Boﬁón
Ë
iVui
->overscan_info_present_flag;

1376 
vui
->
ovîsˇn_≠¥›rüã_Êag
 = (
Boﬁón
Ë
iVui
->overscan_appropriate_flag;

1377 
vui
->
video_sig«l_ty≥_¥e£¡_Êag
 = (
Boﬁón
Ë
iVui
->video_signal_type_present_flag;

1378 
vui
->
video_f‹m©
 = (Ë
iVui
->video_format;

1379 
vui
->
video_fuŒ_ønge_Êag
 = (
Boﬁón
Ë
iVui
->video_full_range_flag;

1380 
vui
->
cﬁour_des¸ùti⁄_¥e£¡_Êag
 = (
Boﬁón
Ë
iVui
->colour_description_present_flag;

1381 
vui
->
cﬁour_¥im¨õs
 = (Ë
iVui
->colour_primaries;

1382 
vui
->
å™s„r_ch¨a˘îi°ics
 = (Ë
iVui
->transfer_characteristics;

1383 
vui
->
m©rix_c€fficõ¡s
 = (Ë
iVui
->matrix_coefficients;

1384 
vui
->
chroma_loˇti⁄_öfo_¥e£¡_Êag
 = (
Boﬁón
Ë
iVui
->chroma_location_info_present_flag;

1385 
vui
->
chroma_ßm∂e_loc_ty≥_t›_fõld
 = (Ë
iVui
->chroma_sample_loc_type_top_field;

1386 
vui
->
chroma_ßm∂e_loc_ty≥_bŸtom_fõld
 = (Ë
iVui
->chroma_sample_loc_type_bottom_field;

1387 
vui
->
timög_öfo_¥e£¡_Êag
 = (
Boﬁón
Ë
iVui
->timing_info_present_flag;

1388 
vui
->
num_unôs_ö_tick
 = (Ë
iVui
->num_units_in_tick;

1389 
vui
->
time_sˇÀ
 = (Ë
iVui
->time_scale;

1390 
vui
->
fixed_‰ame_øã_Êag
 = (
Boﬁón
Ë
iVui
->fixed_frame_rate_flag;

1393 
vui
->
«l_hrd_∑ømëîs_¥e£¡_Êag
 = (
Boﬁón
Ë
iVui
->nal_hrd_parameters_present_flag;

1394 
«l_hrd
->
˝b_˙t_möus1
 = (Ë
iVui
->
«l_˝b_˙t_möus1
;

1395 
«l_hrd
->
bô_øã_sˇÀ
 = (Ë
iVui
->
«l_bô_øã_sˇÀ
;

1396 
«l_hrd
->
˝b_size_sˇÀ
 = (Ë
iVui
->
«l_˝b_size_sˇÀ
;

1397  
SchedSñIdx
 = 0; SchedSñIdx <
«l_hrd
->
˝b_˙t_möus1
; SchedSelIdx++ )

1399 
«l_hrd
->
bô_øã_vÆue_möus1
[
SchedSñIdx
] = (Ë
iVui
->
«l_bô_øã_vÆue_möus1
;

1400 
«l_hrd
->
˝b_size_vÆue_möus1
[
SchedSñIdx
] = (Ë
iVui
->
«l_˝b_size_vÆue_möus1
;

1401 
«l_hrd
->
cbr_Êag
[
SchedSñIdx
] = (Ë
iVui
->
«l_vbr_cbr_Êag
;

1403 
«l_hrd
->
öôül_˝b_ªmovÆ_dñay_Àngth_möus1
 = (Ë
iVui
->
«l_öôül_˝b_ªmovÆ_dñay_Àngth_möus1
;

1404 
«l_hrd
->
˝b_ªmovÆ_dñay_Àngth_möus1
 = (Ë
iVui
->
«l_˝b_ªmovÆ_dñay_Àngth_möus1
;

1405 
«l_hrd
->
dpb_ouçut_dñay_Àngth_möus1
 = (Ë
iVui
->
«l_dpb_ouçut_dñay_Àngth_möus1
;

1406 
«l_hrd
->
time_off£t_Àngth
 = (Ë
iVui
->
«l_time_off£t_Àngth
;

1409 
vui
->
v˛_hrd_∑ømëîs_¥e£¡_Êag
 = (
Boﬁón
Ë
iVui
->vcl_hrd_parameters_present_flag;

1410 
v˛_hrd
->
˝b_˙t_möus1
 = (Ë
iVui
->
v˛_˝b_˙t_möus1
;

1411 
v˛_hrd
->
bô_øã_sˇÀ
 = (Ë
iVui
->
v˛_bô_øã_sˇÀ
;

1412 
v˛_hrd
->
˝b_size_sˇÀ
 = (Ë
iVui
->
v˛_˝b_size_sˇÀ
;

1413  
SchedSñIdx
 = 0; SchedSñIdx <
v˛_hrd
->
˝b_˙t_möus1
; SchedSelIdx++ )

1415 
v˛_hrd
->
bô_øã_vÆue_möus1
[
SchedSñIdx
] = (Ë
iVui
->
v˛_bô_øã_vÆue_möus1
;

1416 
v˛_hrd
->
˝b_size_vÆue_möus1
[
SchedSñIdx
] = (Ë
iVui
->
v˛_˝b_size_vÆue_möus1
;

1417 
v˛_hrd
->
cbr_Êag
[
SchedSñIdx
] = (Ë
iVui
->
v˛_vbr_cbr_Êag
;

1419 
v˛_hrd
->
öôül_˝b_ªmovÆ_dñay_Àngth_möus1
 = (Ë
iVui
->
v˛_öôül_˝b_ªmovÆ_dñay_Àngth_möus1
;

1420 
v˛_hrd
->
˝b_ªmovÆ_dñay_Àngth_möus1
 = (Ë
iVui
->
v˛_˝b_ªmovÆ_dñay_Àngth_möus1
;

1421 
v˛_hrd
->
dpb_ouçut_dñay_Àngth_möus1
 = (Ë
iVui
->
v˛_dpb_ouçut_dñay_Àngth_möus1
;

1422 
v˛_hrd
->
time_off£t_Àngth
 = (Ë
iVui
->
v˛_time_off£t_Àngth
;

1424 
vui
->
low_dñay_hrd_Êag
 = (
Boﬁón
Ë
iVui
->low_delay_hrd_flag;

1425 
vui
->
pic_°ru˘_¥e£¡_Êag
 = (
Boﬁón
Ë
iVui
->pic_struct_present_flag;

1426 
vui
->
bô°ªam_ª°ri˘i⁄_Êag
 = (
Boﬁón
Ë
iVui
->bitstream_restriction_flag;

1427 
vui
->
mŸi⁄_ve˘‹s_ovî_pic_bound¨õs_Êag
 = (
Boﬁón
Ë
iVui
->motion_vectors_over_pic_boundaries_flag;

1428 
vui
->
max_byãs_≥r_pic_díom
 = (Ë
iVui
->max_bytes_per_pic_denom;

1429 
vui
->
max_bôs_≥r_mb_díom
 = (Ë
iVui
->max_bits_per_mb_denom;

1430 
vui
->
log2_max_mv_Àngth_h‹iz⁄èl
 = (Ë
iVui
->log2_max_mv_length_horizontal;

1431 
vui
->
log2_max_mv_Àngth_vîtiˇl
 = (Ë
iVui
->log2_max_mv_length_vertical;

1432 
vui
->
max_dec_‰ame_buf„rög
 = (Ë
	`imö
–
iVui
->max_dec_‰ame_buf„rög, 
	`gëMaxDpbSize
(
•s
) );

1433 
vui
->
num_ª‹dî_‰ames
 = (Ë
	`imö
–
iVui
->num_ª‹dî_‰ames, ()vui->
max_dec_‰ame_buf„rög
 );

1436 i‡(
p_I≈
->
ouçut
.
cﬁ‹_modñ
 !
CM_YUV
 &&Ö_I≈->ouçut.
yuv_f‹m©
 =
YUV444
)

1438 
	`¥ötf
 ("VUI: writing Sequence Parameter VUIÅo signal RGB format\n");

1440 
vui
->
a•e˘_øtio_öfo_¥e£¡_Êag
 = 
FALSE
;

1441 
vui
->
ovîsˇn_öfo_¥e£¡_Êag
 = 
FALSE
;

1442 
vui
->
video_sig«l_ty≥_¥e£¡_Êag
 = 
TRUE
;

1443 
vui
->
video_f‹m©
 = 2;

1444 
vui
->
video_fuŒ_ønge_Êag
 = 
TRUE
;

1445 
vui
->
cﬁour_des¸ùti⁄_¥e£¡_Êag
 = 
TRUE
;

1446 
vui
->
cﬁour_¥im¨õs
 = 2;

1447 
vui
->
å™s„r_ch¨a˘îi°ics
 = 2;

1448 
vui
->
m©rix_c€fficõ¡s
 = 0;

1449 
vui
->
chroma_loˇti⁄_öfo_¥e£¡_Êag
 = 
FALSE
;

1450 
vui
->
timög_öfo_¥e£¡_Êag
 = 
FALSE
;

1451 
vui
->
«l_hrd_∑ømëîs_¥e£¡_Êag
 = 
FALSE
;

1452 
vui
->
v˛_hrd_∑ømëîs_¥e£¡_Êag
 = 
FALSE
;

1453 
vui
->
pic_°ru˘_¥e£¡_Êag
 = 
FALSE
;

1454 
vui
->
bô°ªam_ª°ri˘i⁄_Êag
 = 
FALSE
;

1456 
	}
}

	@lencod/src/pred_struct.c

17 
	~"¥ed_°ru˘.h
"

18 
	~"ex∂icô_£q.h
"

20 
	#DEBUG_PRED_STRUCT
 0

	)

22 
ölöe
 
p›_¥ed_°ru˘_‰m
–
PªdSåu˘Frm
 *
p_d°
, 
¶i˚_ty≥
, 
«l_ªf_idc
, 
di•_off£t
, 
œyî
, 
¶i˚_qp_off
,

23 
øndom_ac˚ss
, 
ãmp‹Æ_œyî
 );

24 
öô_g›_°ru˘
–
I≈utP¨amëîs
 *
p_I≈
, 
SeqSåu˘uª
 *
p_£q_°ru˘
, 
is_idr
, *
mem‹y_size
 );

25 
‰ì_g›_°ru˘
–
SeqSåu˘uª
 *
p_£q_°ru˘
 );

26 
öô_¥ed_°ru˘
–
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
SeqSåu˘uª
 *
p_£q_°ru˘
, *
mem‹y_size
 );

27 
‰ì_¥ed_°ru˘
–
SeqSåu˘uª
 *
p_£q_°ru˘
 );

28 
PicSåu˘uª
 * 
Æloc_pic_°ru˘
–
num_¶i˚s
, *
mem‹y_size
 );

29 
‰ì_pic_°ru˘
–
PicSåu˘uª
 *
p_pic
 );

30 
FømeUnôSåu˘
 * 
Æloc_‰ame_buf„r
–
I≈utP¨amëîs
 *
p_I≈
, 
num_‰ames
, 
num_¶i˚s
, *
mem‹y_size
 );

31 
‰ì_‰ame_buf„r
–
FømeUnôSåu˘
 *
p_‰m_°ru˘
, 
num_‰ames
 );

33 
ønd_acc_ã°_ønge
–
cuº_‰ame
, 
off£t
, 
idr_≥riod
 );

34 
ölöe
 
check_powî_of_two
–
numbî
 );

35 
e°ablish_øndom_ac˚ss
–
I≈utP¨amëîs
 *
p_I≈
, 
SeqSåu˘uª
 *
p_£q_°ru˘
, 
cuº_‰ame
, 
avaû_‰ames
, 
sim
 );

36 
e°ablish_öåa
–
I≈utP¨amëîs
 *
p_I≈
, 
SeqSåu˘uª
 *
p_£q_°ru˘
, 
cuº_‰ame
, 
avaû_‰ames
, 
sim
 );

37 
e°ablish_•
–
I≈utP¨amëîs
 *
p_I≈
, 
SeqSåu˘uª
 *
p_£q_°ru˘
, 
cuº_‰ame
, 
avaû_‰ames
, 
sim
 );

38 
gë_fixed_‰ame
–
I≈utP¨amëîs
 *
p_I≈
, 
SeqSåu˘uª
 *
p_£q_°ru˘
, 
cuº_‰ame
, 
avaû_‰ames
 );

39 
gë_¥d_ödex
–
I≈utP¨amëîs
 *
p_I≈
, 
SeqSåu˘uª
 *
p_£q_°ru˘
, 
num_‰ames
 );

40 
gë_idr_ödex
–
I≈utP¨amëîs
 *
p_I≈
, 
SeqSåu˘uª
 *
p_£q_°ru˘
, 
num_‰ames
 );

41 
gë_öåa_ödex
–
I≈utP¨amëîs
 *
p_I≈
, 
SeqSåu˘uª
 *
p_£q_°ru˘
, 
num_‰ames
 );

42 
p›uœã_‰ame
–
I≈utP¨amëîs
 *
p_I≈
, 
SeqSåu˘uª
 *
p_£q_°ru˘
, 
FømeUnôSåu˘
 *
p_‰m_°ru˘
, 
PªdSåu˘Atom
 *
p_cur_¥d
,

43 
cuº_‰ame
, 
¥ed_‰ame
, 
idx
, 
num_¶i˚s
, 
no_∫d_acc
 );

44 
upd©e_‰ame_ödi˚s
–
SeqSåu˘uª
 *
p_£q_°ru˘
, 
FømeUnôSåu˘
 *
p_‰m_°ru˘
, 
cuº_‰ame
, 
¥ed_‰ame
 );

45 
p›uœã_ªg_¥ed_°ru˘_©om
–
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
SeqSåu˘uª
 *
p_£q_°ru˘
,

46 
cuº_‰ame
, 
¥oc_‰ames
, *
ãrmö©e_p›
 );

47 
p›uœã_∫d_acc_¥ed_°ru˘_©om
–
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
SeqSåu˘uª
 *
p_£q_°ru˘
,

48 
cuº_‰ame
, 
¥oc_‰ames
, *
ãrmö©e_p›
, 
is_idr
, 
no_∫d_acc
 );

49 #i‡(
MVC_EXTENSION_ENABLE
)

50 
c›y_‰ame_mvc
–
I≈utP¨amëîs
 *
p_I≈
, 
FømeUnôSåu˘
 *
p_§c
, FømeUnôSåu˘ *
p_d°
, 
num_¶i˚s
, 
võw_id
 );

66 
	$gë_poc_ty≥_zîo
–
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
FømeUnôSåu˘
 *
p_‰m_°ru˘
 )

68 
FømeUnôSåu˘
 *
p_cur
 = 
p_‰m_°ru˘
;

69 
œ°_di•_‹dî
;

71 i‡–
p_Vid
->
œ°_idr_code_‹dî
 >Ö_Vid->
œ°_mmco_5_code_‹dî
 )

73 
œ°_di•_‹dî
 = 
p_Vid
->
œ°_idr_di•_‹dî
;

77 
œ°_di•_‹dî
 = 
p_Vid
->
œ°_mmco_5_di•_‹dî
;

80 i‡–
p_cur
->
idr_Êag
 )

82 
p_Vid
->
t›poc
 = 0;

86 
p_Vid
->
t›poc
 = (
p_cur
->
‰ame_no
 - 
œ°_di•_‹dî
) << 1;

89 
p_Vid
->
t›poc
 = (1 + 
p_I≈
->
‰ame_skù
) *Ö_Vid->toppoc;

91 i‡–
p_I≈
->
PicI¡îœ˚
 =
FRAME_CODING
 &&Ö_I≈->
MbI¡îœ˚
 == FRAME_CODING )

93 
p_Vid
->
bŸtompoc
 =Ö_Vid->
t›poc
;

97 
p_Vid
->
bŸtompoc
 =Ö_Vid->
t›poc
 + 1;

100 
p_Vid
->
‰amïoc
 = 
	`imö
–p_Vid->
t›poc
,Ö_Vid->
bŸtompoc
 );

101 
	}
}

116 
	$gë_poc_ty≥_⁄e
–
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
FømeUnôSåu˘
 *
p_‰m_°ru˘
 )

118 
FømeUnôSåu˘
 *
p_cur
 = 
p_‰m_°ru˘
;

119 
i
;

120 
AbsFømeNum
;

121 
Ex≥˘edDñèPîPicOrdîC¡Cy˛e
;

122 
PicOrdîC¡Cy˛eC¡
;

123 
FømeNumInPicOrdîC¡Cy˛e
;

124 
Ex≥˘edPicOrdîC¡
;

125 
CodögP¨amëîs
 *
p_EncodeP¨
 = 
p_Vid
->p_EncodeP¨[p_Vid->
dpb_œyî_id
];

128 
	`gë_poc_ty≥_zîo
–
p_Vid
, 
p_I≈
, 
p_‰m_°ru˘
 );

133 i‡–
p_cur
->
idr_Êag
 )

135 
p_Vid
->
FømeNumOff£t
 = 0;

136 
p_Vid
->
dñè_pic_‹dî_˙t
[0] = 0;

140 i‡–
p_Vid
->
œ°_has_mmco_5
 )

142 
p_EncodeP¨
->
¥evFømeNumOff£t
 = 0;

143 
p_EncodeP¨
->
¥evFømeNum
 = 0;

145 i‡–
p_Vid
->
‰ame_num
 < 
p_EncodeP¨
->
¥evFømeNum
 )

147 
p_Vid
->
FømeNumOff£t
 = 
p_EncodeP¨
->
¥evFømeNumOff£t
 +Ö_Vid->
max_‰ame_num
;

151 
p_Vid
->
FømeNumOff£t
 = 
p_EncodeP¨
->
¥evFømeNumOff£t
;

156 i‡–
p_Vid
->
num_ªf_‰ames_ö_pic_‹dî_˙t_cy˛e
 )

158 
AbsFømeNum
 = 
p_Vid
->
FømeNumOff£t
 +Ö_Vid->
‰ame_num
;

162 
AbsFømeNum
=0;

164 i‡–!(
p_cur
->
«l_ªf_idc
Ë&& 
AbsFømeNum
 > 0 )

166 
AbsFømeNum
--;

170 
Ex≥˘edDñèPîPicOrdîC¡Cy˛e
=0;

171 i‡–
p_Vid
->
num_ªf_‰ames_ö_pic_‹dî_˙t_cy˛e
 )

173  
i
 = 0; i < (Ë
p_Vid
->
num_ªf_‰ames_ö_pic_‹dî_˙t_cy˛e
; i++ )

175 
Ex≥˘edDñèPîPicOrdîC¡Cy˛e
 +
p_Vid
->
off£t_f‹_ªf_‰ame
[
i
];

179 i‡–
AbsFømeNum
 )

181 
PicOrdîC¡Cy˛eC¡
 = (
AbsFømeNum
 - 1Ë/ 
p_Vid
->
num_ªf_‰ames_ö_pic_‹dî_˙t_cy˛e
;

182 
FømeNumInPicOrdîC¡Cy˛e
 = (
AbsFømeNum
 - 1Ë% 
p_Vid
->
num_ªf_‰ames_ö_pic_‹dî_˙t_cy˛e
;

184 
Ex≥˘edPicOrdîC¡
 = 
PicOrdîC¡Cy˛eC¡
 * 
Ex≥˘edDñèPîPicOrdîC¡Cy˛e
;

185  
i
 = 0; i <()
FømeNumInPicOrdîC¡Cy˛e
; i++ )

187 
Ex≥˘edPicOrdîC¡
 +
p_Vid
->
off£t_f‹_ªf_‰ame
[
i
];

192 
Ex≥˘edPicOrdîC¡
 = 0;

195 i‡–!(
p_cur
->
«l_ªf_idc
) )

197 
Ex≥˘edPicOrdîC¡
 +
p_Vid
->
off£t_f‹_n⁄_ªf_pic
;

200 
p_Vid
->
dñè_pic_‹dî_˙t
[0] =Ö_Vid->
t›poc
 - 
Ex≥˘edPicOrdîC¡
;

201 
p_Vid
->
dñè_pic_‹dî_˙t
[1] = 0;

204 
p_Vid
->
¥evFømeNum
 = 
p_EncodeP¨
->¥evFømeNum =Ö_Vid->
‰ame_num
;

205 
p_Vid
->
¥evFømeNumOff£t
 = 
p_EncodeP¨
->¥evFømeNumOff£àp_Vid->
FømeNumOff£t
;

206 
	}
}

218 
	$öô_poc
(
VideoP¨amëîs
 *
p_Vid
)

220 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

222 
p_Vid
->
pic_‹dî_˙t_ty≥
 = 
p_I≈
->pic_order_cnt_type;

223 i‡((
p_I≈
->
PicI¡îœ˚
 =
FRAME_CODING
Ë&& (p_I≈->
MbI¡îœ˚
 == FRAME_CODING))

225 
p_Vid
->
bŸtom_fõld_pic_‹dî_ö_‰ame_¥e£¡_Êag
 = 
FALSE
;

229 
p_Vid
->
bŸtom_fõld_pic_‹dî_ö_‰ame_¥e£¡_Êag
 = 
TRUE
;

233 i‡((
p_I≈
->
PicI¡îœ˚
==
FRAME_CODING
Ë&& (p_I≈->
MbI¡îœ˚
==FRAME_CODING))

235 
p_Vid
->
dñè_pic_‹dî_˙t_bŸtom
 = 0;

239 
p_Vid
->
dñè_pic_‹dî_˙t_bŸtom
 = 1;

244 
p_Vid
->
dñè_pic_‹dî_Æways_zîo_Êag
 = 
FALSE
;

245 
p_Vid
->
num_ªf_‰ames_ö_pic_‹dî_˙t_cy˛e
 = 1;

248 i‡(
p_I≈
->
BRefPi˘uªs
 == 1)

250 
p_Vid
->
off£t_f‹_n⁄_ªf_pic
 = 0;

251 
p_Vid
->
off£t_f‹_ªf_‰ame
[0] = 2;

255 
p_Vid
->
off£t_f‹_n⁄_ªf_pic
 = -2*(
p_I≈
->
NumbîBFømes
);

256 
p_Vid
->
off£t_f‹_ªf_‰ame
[0] = 2*(
p_I≈
->
NumbîBFømes
 + 1);

259 i‡((
p_I≈
->
PicI¡îœ˚
==
FRAME_CODING
Ë&& (p_I≈->
MbI¡îœ˚
==FRAME_CODING))

261 
p_Vid
->
off£t_f‹_t›_to_bŸtom_fõld
 = 0;

265 
p_Vid
->
off£t_f‹_t›_to_bŸtom_fõld
 = 1;

267 
	}
}

282 
PicSåu˘uª
 * 
	$Æloc_pic_°ru˘
–
num_¶i˚s
, *
mem‹y_size
 )

284 
PicSåu˘uª
 *
p_pic
 = (PicSåu˘uª *)
	`mÆloc
( ( PicStructure ) );

285 i‡–
p_pic
 =
NULL
 )

287 
	`Ârötf
(
°dîr
, "\nNotÉnough memory orÉrror during memoryállocation:álloc_pic_struct()");

288 
	`exô
(1);

290 *
mem‹y_size
 +–
PicSåu˘uª
 );

292 
p_pic
->
num_¶i˚s
 =Çum_slices;

293 
p_pic
->
p_Sli˚
 = (
Sli˚Såu˘uª
 *)
	`mÆloc
–
num_¶i˚s
 * ( SliceStructure ) );

294 i‡–
p_pic
->
p_Sli˚
 =
NULL
 )

296 
	`Ârötf
(
°dîr
, "\nNotÉnough memory orÉrror during memoryállocation:álloc_pic_struct()");

297 
	`exô
(1);

299 *
mem‹y_size
 +(
num_¶i˚s
 * –
Sli˚Såu˘uª
 ));

301  
p_pic
;

302 
	}
}

313 
	$‰ì_pic_°ru˘
–
PicSåu˘uª
 *
p_pic
 )

315 i‡–
p_pic
 !
NULL
 )

317 i‡–
p_pic
->
p_Sli˚
 !
NULL
 )

319 
	`‰ì
–
p_pic
->
p_Sli˚
 );

320 
p_pic
->
p_Sli˚
 = 
NULL
;

322 
	`‰ì
–
p_pic
 );

324 
	}
}

343 
FømeUnôSåu˘
 * 
	$Æloc_‰ame_buf„r
–
I≈utP¨amëîs
 *
p_I≈
, 
num_‰ames
, 
num_¶i˚s
, *
mem‹y_size
 )

345 
idx
;

348 
FømeUnôSåu˘
 *
p_‰m_°ru˘
 = (FømeUnôSåu˘ *)
	`mÆloc
–
num_‰ames
 * ( FrameUnitStruct ) );

349 
FømeUnôSåu˘
 *
p_‰m_tmp
;

351 i‡–
p_‰m_°ru˘
 =
NULL
 )

353 
	`Ârötf
(
°dîr
, "\nNotÉnough memory orÉrror during memoryállocation:álloc_frame_buffer()");

354 
	`exô
(1);

356 *
mem‹y_size
 +
num_‰ames
 * –
FømeUnôSåu˘
 );

358  
idx
 = 0; idx < 
num_‰ames
; idx++ )

360 
p_‰m_tmp
 = 
p_‰m_°ru˘
 + 
idx
;

362  
p_I≈
->
PicI¡îœ˚
 )

365 
FRAME_CODING
:

366 
p_‰m_tmp
->
fõld_pic_Êag
 = 0;

367 
p_‰m_tmp
->
p_t›_Êd_pic
 = 
NULL
;

368 
p_‰m_tmp
->
p_bŸ_Êd_pic
 = 
NULL
;

369 
p_‰m_tmp
->
p_‰ame_pic
 = 
	`Æloc_pic_°ru˘
–
num_¶i˚s
, 
mem‹y_size
 );

371 
FIELD_CODING
:

372 
p_‰m_tmp
->
fõld_pic_Êag
 = 1;

373 
p_‰m_tmp
->
p_t›_Êd_pic
 = 
	`Æloc_pic_°ru˘
–
num_¶i˚s
, 
mem‹y_size
 );

374 
p_‰m_tmp
->
p_bŸ_Êd_pic
 = 
	`Æloc_pic_°ru˘
–
num_¶i˚s
, 
mem‹y_size
 );

375 
p_‰m_tmp
->
p_‰ame_pic
 = 
NULL
;

377 
ADAPTIVE_CODING
:

378 
p_‰m_tmp
->
p_t›_Êd_pic
 = 
	`Æloc_pic_°ru˘
–
num_¶i˚s
, 
mem‹y_size
 );

379 
p_‰m_tmp
->
p_bŸ_Êd_pic
 = 
	`Æloc_pic_°ru˘
–
num_¶i˚s
, 
mem‹y_size
 );

380 
p_‰m_tmp
->
p_‰ame_pic
 = 
	`Æloc_pic_°ru˘
–
num_¶i˚s
, 
mem‹y_size
 );

385  
p_‰m_°ru˘
;

386 
	}
}

399 
	$‰ì_‰ame_buf„r
–
FømeUnôSåu˘
 *
p_‰m_°ru˘
, 
num_‰ames
 )

401 
idx
;

402 
FømeUnôSåu˘
 *
p_‰m_tmp
;

404 i‡–
p_‰m_°ru˘
 !
NULL
 )

406  
idx
 = 0; idx < 
num_‰ames
; idx++ )

408 
p_‰m_tmp
 = 
p_‰m_°ru˘
 + 
idx
;

410 
	`‰ì_pic_°ru˘
–
p_‰m_tmp
->
p_t›_Êd_pic
 );

411 
p_‰m_tmp
->
p_t›_Êd_pic
 = 
NULL
;

413 
	`‰ì_pic_°ru˘
–
p_‰m_tmp
->
p_bŸ_Êd_pic
 );

414 
p_‰m_tmp
->
p_bŸ_Êd_pic
 = 
NULL
;

416 
	`‰ì_pic_°ru˘
–
p_‰m_tmp
->
p_‰ame_pic
 );

417 
p_‰m_tmp
->
p_‰ame_pic
 = 
NULL
;

420 
	`‰ì
–
p_‰m_°ru˘
 );

422 
	}
}

439 
SeqSåu˘uª
 * 
	$öô_£q_°ru˘uª
–
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, *
mem‹y_size
 )

441 #i‡(
MVC_EXTENSION_ENABLE
)

442 
°¨t
, 
íd
;

444 
SeqSåu˘uª
 *
p_£q_°ru˘
 = (SeqSåu˘uª *)
	`mÆloc
( ( SeqStructure ) );

445 
‰ames_to_p›
;

447 i‡–
p_£q_°ru˘
 =
NULL
 )

449 
	`Ârötf
(
°dîr
, "\nNotÉnough memory orÉrror during memoryállocation: init_seq_structure()");

450 
	`exô
(1);

454 
p_I≈
->
FrmSåu˘Buf„rLígth
 = 
	`imax
–p_I≈->FrmSåu˘Buf„rLígth, imax–p_I≈->
idr_≥riod
,Ö_I≈->
öåa_≥riod
 ) +Ö_I≈->
NumbîBFømes
 +Ö_I≈->
öåa_dñay
 + 2 );

455 
p_Vid
->
‰m_°ru˘_buf„r
 = 
p_I≈
->
FrmSåu˘Buf„rLígth
;

456 
p_Vid
->
‰m_°ru˘_buf„r
 = 
	`imö
–p_Vid->‰m_°ru˘_buf„r, 
p_I≈
->
no_‰ames
 );

457 
p_I≈
->
FrmSåu˘Buf„rLígth
 = 
	`imö
–p_I≈->FrmSåu˘Buf„rLígth,Ö_I≈->
no_‰ames
 );

459 
p_I≈
->
FrmSåu˘Buf„rLígth
 =Ö_I≈->
no_‰ames
;

460 
p_Vid
->
‰m_°ru˘_buf„r
 = 
p_I≈
->
no_‰ames
;

462 *
mem‹y_size
 +–
SeqSåu˘uª
 );

464 
p_£q_°ru˘
->
max_num_¶i˚s
 = (
p_I≈
->
¶i˚_mode
 =1Ë? 
	`imax
(1, 
p_Vid
->
FømeSizeInMbs
 /Ö_I≈->
¶i˚_¨gumít
) : 1;

465 
p_£q_°ru˘
->
num_‰ames
 = 
p_Vid
->
‰m_°ru˘_buf„r
;

466 
p_£q_°ru˘
->
p_‰m
 = 
	`Æloc_‰ame_buf„r
–
p_I≈
,Ö_£q_°ru˘->
num_‰ames
,Ö_£q_°ru˘->
max_num_¶i˚s
, 
mem‹y_size
 );

467 
p_£q_°ru˘
->
œ°_øndom_ac˚ss_‰ame
 = 0;

468 
p_£q_°ru˘
->
œ°_idr_‰ame
 = 0;

469 
p_£q_°ru˘
->
œ°_öåa_‰ame
 = 0;

470 
p_£q_°ru˘
->
œ°_mmco_5_‰ame
 = -1;

471 
p_£q_°ru˘
->
cuº_num_to_p›uœã
 = 
p_Vid
->
‰m_°ru˘_buf„r
;

472 
p_£q_°ru˘
->
p›_°¨t_‰ame
 = 0;

473 
p_£q_°ru˘
->
œ°_ønd_ac˚ss_di•
 = 0;

474 
p_£q_°ru˘
->
œ°_idr_di•
 = 0;

475 
p_£q_°ru˘
->
œ°_öåa_di•
 = 0;

476 
p_£q_°ru˘
->
œ°_bl_‰m_di•oßbÀ
 = 0;

477 
p_£q_°ru˘
->
œ°_•_‰ame
 = 0;

478 
p_£q_°ru˘
->
œ°_•_di•
 = 0;

479 
p_£q_°ru˘
->
p›_Êag
 = 0;

481 #i‡(
MVC_EXTENSION_ENABLE
)

482 
p_£q_°ru˘
->
num_‰ames_mvc
 =Ö_£q_°ru˘->
num_‰ames
 * 
p_I≈
->
num_of_võws
;

483 
p_£q_°ru˘
->
p_‰m_mvc
 = 
	`Æloc_‰ame_buf„r
–
p_I≈
,Ö_£q_°ru˘->
num_‰ames_mvc
,Ö_£q_°ru˘->
max_num_¶i˚s
, 
mem‹y_size
 );

487 
	`öô_¥ed_°ru˘
–
p_Vid
, 
p_I≈
, 
p_£q_°ru˘
, 
mem‹y_size
 );

488 
	`öô_g›_°ru˘
 ( 
p_I≈
, 
p_£q_°ru˘
, 1, 
mem‹y_size
 );

489 
	`öô_g›_°ru˘
 ( 
p_I≈
, 
p_£q_°ru˘
, 0, 
mem‹y_size
 );

491 
‰ames_to_p›
 = 
p_Vid
->
‰m_°ru˘_buf„r
;

494 #i‡(
MVC_EXTENSION_ENABLE
)

495 
°¨t
 = 
p_£q_°ru˘
->
p›_°¨t_‰ame
;

496 
	`p›uœã_‰m_°ru˘
–
p_Vid
, 
p_I≈
, 
p_£q_°ru˘
, 
‰ames_to_p›
,Ö_I≈->
no_‰ames
 );

498 i‡–
p_I≈
->
num_of_võws
 > 1 )

500 
	`as£π
–
p_I≈
->
num_of_võws
 < 4 );

501 
íd
 = 
p_£q_°ru˘
->
p›_°¨t_‰ame
;

502 
	`p›uœã_‰m_°ru˘_mvc
–
p_Vid
, 
p_I≈
, 
p_£q_°ru˘
, 
°¨t
, 
íd
 );

505 
	`p›uœã_‰m_°ru˘
–
p_Vid
, 
p_I≈
, 
p_£q_°ru˘
, 
‰ames_to_p›
,Ö_I≈->
no_‰ames
 );

508  
p_£q_°ru˘
;

509 
	}
}

520 
	$‰ì_£q_°ru˘uª
–
SeqSåu˘uª
 *
p_£q_°ru˘
 )

522 
	`‰ì_‰ame_buf„r
–
p_£q_°ru˘
->
p_‰m
,Ö_£q_°ru˘->
num_‰ames
 );

523 
p_£q_°ru˘
->
p_‰m
 = 
NULL
;

524 #i‡(
MVC_EXTENSION_ENABLE
)

525 
	`‰ì_‰ame_buf„r
–
p_£q_°ru˘
->
p_‰m_mvc
,Ö_£q_°ru˘->
num_‰ames_mvc
 );

526 
p_£q_°ru˘
->
p_‰m_mvc
 = 
NULL
;

528 
	`‰ì_g›_°ru˘
–
p_£q_°ru˘
 );

529 
p_£q_°ru˘
->
p_g›
 = 
NULL
;

530 
	`‰ì_¥ed_°ru˘
–
p_£q_°ru˘
 );

531 
p_£q_°ru˘
->
p_¥d
 = 
NULL
;

533 i‡–
p_£q_°ru˘
 !
NULL
 )

535 
	`‰ì
–
p_£q_°ru˘
 );

537 
	}
}

559 
	$e°ablish_øndom_ac˚ss
–
I≈utP¨amëîs
 *
p_I≈
, 
SeqSåu˘uª
 *
p_£q_°ru˘
, 
cuº_‰ame
, 
avaû_‰ames
, 
sim
 )

561 
dñè
;

562 
is_øndom_ac˚ss
 = 0;

564 i‡–!
cuº_‰ame
 )

566 i‡–!(
p_I≈
->
Pª„rDi•Ordî
) )

568 
is_øndom_ac˚ss
 = 1;

572 
idx
;

573 
PªdSåu˘Atom
 *
p_cur_g›
;

577  
idx
 = (
p_£q_°ru˘
->
num_g›s
 - 1); idx >= 0; idx-- )

579 
p_cur_g›
 = 
p_£q_°ru˘
->
p_g›
 + 
idx
;

581 i‡–
sim
 )

583 i‡–(
cuº_‰ame
 + 
p_cur_g›
->
Àngth
Ë<
p_I≈
->
no_‰ames
 )

585 
is_øndom_ac˚ss
 = 1 + 
idx
;

591 i‡–
p_cur_g›
->
Àngth
 <
avaû_‰ames
 )

593 
is_øndom_ac˚ss
 = 1 + 
idx
;

600 i‡–
p_I≈
->
idr_≥riod
 )

602 i‡–!(
p_I≈
->
Pª„rDi•Ordî
) )

604  
p_I≈
->
ad≠tive_idr_≥riod
 )

608 i‡–
cuº_‰ame
 % 
p_I≈
->
idr_≥riod
 == 0 )

610 
is_øndom_ac˚ss
 = 1;

614 
dñè
 = 
cuº_‰ame
 - 
p_£q_°ru˘
->
œ°_øndom_ac˚ss_‰ame
;

615 i‡–
dñè
 >
p_I≈
->
idr_≥riod
 && dñè >p_I≈->
MöIDRDi°™˚
 )

617 
is_øndom_ac˚ss
 = 1;

621 
dñè
 = 
cuº_‰ame
 - 
	`imax
–
p_£q_°ru˘
->
œ°_øndom_ac˚ss_‰ame
,Ö_£q_°ru˘->
œ°_öåa_‰ame
);

622 i‡–
dñè
 >
p_I≈
->
idr_≥riod
 && dñè >p_I≈->
MöIDRDi°™˚
 )

624 
is_øndom_ac˚ss
 = 1;

631 
idx
;

632 
off£t
;

633 
PªdSåu˘Atom
 *
p_cur_g›
;

637  
idx
 = (
p_£q_°ru˘
->
num_g›s
 - 1); idx >= 0; idx-- )

639 
p_cur_g›
 = 
p_£q_°ru˘
->
p_g›
 + 
idx
;

641 i‡–
sim
 )

643 i‡–(
cuº_‰ame
 + 
p_cur_g›
->
Àngth
Ë> 
p_I≈
->
no_‰ames
 )

650 i‡–
p_cur_g›
->
Àngth
 > 
avaû_‰ames
 )

656 
off£t
 = 
p_cur_g›
->
p_‰m
[0].
di•_off£t
;

659  
p_I≈
->
ad≠tive_idr_≥riod
 )

663 i‡–!
cuº_‰ame
 || (cuº_‰amê+ 
off£t
 - 
p_I≈
->
öåa_dñay
Ë%Ö_I≈->
idr_≥riod
 == 0 )

665 
is_øndom_ac˚ss
 = 1 + 
idx
;

669 
dñè
 = (
cuº_‰ame
 + 
off£t
Ë- 
p_£q_°ru˘
->
œ°_ønd_ac˚ss_di•
;

670 i‡–!
cuº_‰ame
 || (
dñè
 >
p_I≈
->
idr_≥riod
 && dñè >p_I≈->
MöIDRDi°™˚
) )

672 
is_øndom_ac˚ss
 = 1 + 
idx
;

676 
dñè
 = (
cuº_‰ame
 + 
off£t
Ë- 
	`imax
–
p_£q_°ru˘
->
œ°_ønd_ac˚ss_di•
,Ö_£q_°ru˘->
œ°_öåa_di•
);

677 i‡–!
cuº_‰ame
 || (
dñè
 >
p_I≈
->
idr_≥riod
 && dñè >p_I≈->
MöIDRDi°™˚
) )

679 
is_øndom_ac˚ss
 = 1 + 
idx
;

683 i‡–
is_øndom_ac˚ss
 )

692  
is_øndom_ac˚ss
;

693 
	}
}

702 
	$ønd_acc_ã°_ønge
–
cuº_‰ame
, 
off£t
, 
idr_≥riod
 )

704 
idx
;

705 
no_∫d_acc
 = 1;

707 i‡–
idr_≥riod
 > 0 )

709  
idx
 = 
cuº_‰ame
; idx <(cuº_‰amê+ 
off£t
); idx++ )

711 i‡–
idx
 % 
idr_≥riod
 == 0 )

713 
no_∫d_acc
 = 0;

719  
no_∫d_acc
;

720 
	}
}

740 
	$e°ablish_öåa
–
I≈utP¨amëîs
 *
p_I≈
, 
SeqSåu˘uª
 *
p_£q_°ru˘
, 
cuº_‰ame
, 
avaû_‰ames
, 
sim
 )

742 
is_öåa
 = 0;

744 i‡–!
cuº_‰ame
 )

746 
is_öåa
 = 1;

748 i‡–
p_I≈
->
öåa_≥riod
 )

750 i‡–!(
p_I≈
->
Pª„rDi•Ordî
) )

752  
p_I≈
->
ad≠tive_öåa_≥riod
 )

756 i‡–
cuº_‰ame
 % 
p_I≈
->
öåa_≥riod
 == 0 )

758 
is_öåa
 = 1;

762 i‡–(
cuº_‰ame
 - 
	`imax
–
p_£q_°ru˘
->
œ°_idr_‰ame
,Ö_£q_°ru˘->
œ°_öåa_‰ame
)Ë% 
p_I≈
->
öåa_≥riod
 == 0 )

764 
is_öåa
 = 1;

771 
idx
;

772 
off£t
;

773 
PªdSåu˘Atom
 *
p_cur_g›
;

777  
idx
 = (
p_£q_°ru˘
->
num_öåa_g›s
 - 1); idx >= 0; idx-- )

779 
p_cur_g›
 = 
p_£q_°ru˘
->
p_öåa_g›
 + 
idx
;

781 i‡–
sim
 )

783 i‡–(
cuº_‰ame
 + 
p_cur_g›
->
Àngth
Ë> 
p_I≈
->
no_‰ames
 )

790 i‡–
p_cur_g›
->
Àngth
 > 
avaû_‰ames
 )

796 
off£t
 = 
p_cur_g›
->
p_‰m
[0].
di•_off£t
;

799  
p_I≈
->
ad≠tive_öåa_≥riod
 )

806 i‡–(
cuº_‰ame
 + 
off£t
Ë% 
p_I≈
->
öåa_≥riod
 =0 && 
	`ønd_acc_ã°_ønge
–cuº_‰ame, off£t,Ö_I≈->
idr_≥riod
 ) )

808 
is_öåa
 = 1 + 
idx
;

813 i‡–((
cuº_‰ame
 + 
off£t
Ë- 
	`imax
–
p_£q_°ru˘
->
œ°_idr_di•
,Ö_£q_°ru˘->
œ°_öåa_di•
)Ë% 
p_I≈
->
öåa_≥riod
 == 0

814 && 
	`ønd_acc_ã°_ønge
–
cuº_‰ame
 - 
	`imax
–
p_£q_°ru˘
->
œ°_idr_di•
,Ö_£q_°ru˘->
œ°_öåa_di•
), 
off£t
, 
p_I≈
->
idr_≥riod
 ) )

816 
is_öåa
 = 1 + 
idx
;

820 i‡–
is_öåa
 )

829  
is_öåa
;

830 
	}
}

850 
	$e°ablish_•
–
I≈utP¨amëîs
 *
p_I≈
, 
SeqSåu˘uª
 *
p_£q_°ru˘
, 
cuº_‰ame
, 
avaû_‰ames
, 
sim
 )

852 
is_•
 = 0;

854 i‡–
p_I≈
->
•_≥riodicôy
 )

856 i‡–!(
p_I≈
->
Pª„rDi•Ordî
) )

858 i‡–(
cuº_‰ame
 - 
p_£q_°ru˘
->
œ°_•_‰ame
Ë% 
p_I≈
->
•_≥riodicôy
 == 0 )

860 
is_•
 = 1;

865 
idx
;

866 
off£t
;

867 
PªdSåu˘Atom
 *
p_cur_g›
;

871  
idx
 = (
p_£q_°ru˘
->
num_g›s
 - 1); idx >= 0; idx-- )

873 
p_cur_g›
 = 
p_£q_°ru˘
->
p_g›
 + 
idx
;

875 i‡–
sim
 )

877 i‡–(
cuº_‰ame
 + 
p_cur_g›
->
Àngth
Ë> 
p_I≈
->
no_‰ames
 )

884 i‡–
p_cur_g›
->
Àngth
 > 
avaû_‰ames
 )

891 
off£t
 = 
p_cur_g›
->
p_‰m
[0].
di•_off£t
;

894 i‡–(
cuº_‰ame
 + 
off£t
 - 
p_£q_°ru˘
->
œ°_•_di•
Ë% 
p_I≈
->
•_≥riodicôy
 == 0 )

896 
is_•
 = 1 + 
idx
;

903  
is_•
;

904 
	}
}

923 
	$gë_fixed_‰ame
–
I≈utP¨amëîs
 *
p_I≈
, 
SeqSåu˘uª
 *
p_£q_°ru˘
, 
cuº_‰ame
, 
avaû_‰ames
 )

925 
idx
 = 0;

926 
is_∫d_acc
 = 0;

927 
is_öåa
 = 0;

928 
is_•
 = 0;

930  
idx
 < 
avaû_‰ames
 )

932 
is_∫d_acc
 = 
	`e°ablish_øndom_ac˚ss
–
p_I≈
, 
p_£q_°ru˘
, 
cuº_‰ame
 + 
idx
, 
avaû_‰ames
 - idx, 1 );

933 
is_öåa
 = 
	`e°ablish_öåa
–
p_I≈
, 
p_£q_°ru˘
, 
cuº_‰ame
 + 
idx
, 
avaû_‰ames
 - idx, 1 );

934 
is_•
 = 
	`e°ablish_•
–
p_I≈
, 
p_£q_°ru˘
, 
cuº_‰ame
 + 
idx
, 
avaû_‰ames
 - idx, 1 );

936 i‡–
is_∫d_acc
 || 
is_öåa
 || 
is_•
 )

938  
idx
;

940 
idx
++;

944 
	}
}

964 
	$gë_fixed_‰ame_f‹_¥d
–
I≈utP¨amëîs
 *
p_I≈
, 
SeqSåu˘uª
 *
p_£q_°ru˘
, 
cuº_‰ame
, 
avaû_‰ames
 )

966 
idx
 = 0;

967 
is_∫d_acc
 = 0;

968 
is_öåa
 = 0;

969 
is_•
 = 0;

970 
PªdSåu˘Atom
 *
p_l⁄ge°_¥d
 = 
p_£q_°ru˘
->
p_¥d
 +Ö_£q_°ru˘->
num_¥ds
 - 1;

972  
idx
 < 
avaû_‰ames
 )

975 
is_∫d_acc
 = 
	`e°ablish_øndom_ac˚ss
–
p_I≈
, 
p_£q_°ru˘
, 
cuº_‰ame
 + 
idx
, 
avaû_‰ames
 - idx, 1 );

976 i‡–
is_∫d_acc
 )

978 i‡–
p_I≈
->
Pª„rDi•Ordî
 && !’_I≈->
E«bÀIDRGOP
) )

980 
g›_Àngth
;

981 
PªdSåu˘Atom
 *
p_cuº_g›
;

984 i‡–
is_∫d_acc
 > 1 )

986 
p_cuº_g›
 = 
p_£q_°ru˘
->
p_g›
 + 
is_∫d_acc
 - 1;

987 
g›_Àngth
 = 
p_cuº_g›
->
Àngth
;

991 
g›_Àngth
 = 1;

995 i‡–(
idx
 % 
p_l⁄ge°_¥d
->
Àngth
) <Ö_longest_prd->length )

997 
p_£q_°ru˘
->
p›_Êag
 = 
POP_IDR
;

998  ( 
	`imö
–
p_l⁄ge°_¥d
->
Àngth
, 
idx
 + 
g›_Àngth
 - 1 ) );

1002  
idx
;

1007  
idx
;

1011 
is_öåa
 = 
	`e°ablish_öåa
–
p_I≈
, 
p_£q_°ru˘
, 
cuº_‰ame
 + 
idx
, 
avaû_‰ames
 - idx, 1 );

1012 i‡–
is_öåa
 )

1014 i‡–
p_I≈
->
Pª„rDi•Ordî
 )

1016 
g›_Àngth
;

1017 
PªdSåu˘Atom
 *
p_cuº_g›
;

1020 i‡–
is_öåa
 > 1 )

1022 
p_cuº_g›
 = 
p_£q_°ru˘
->
p_öåa_g›
 + 
is_öåa
 - 1;

1023 
g›_Àngth
 = 
p_cuº_g›
->
Àngth
;

1027 
g›_Àngth
 = 1;

1031 i‡–(
idx
 % 
p_l⁄ge°_¥d
->
Àngth
) <Ö_longest_prd->length )

1033 
p_£q_°ru˘
->
p›_Êag
 = 
POP_INTRA
;

1034  ( 
	`imö
–
p_l⁄ge°_¥d
->
Àngth
, 
idx
 + 
g›_Àngth
 - 1 ) );

1038  
idx
;

1043  
idx
;

1047 
is_•
 = 
	`e°ablish_•
–
p_I≈
, 
p_£q_°ru˘
, 
cuº_‰ame
 + 
idx
, 
avaû_‰ames
 - idx, 1 );

1048 i‡–
is_•
 )

1050 i‡–
p_I≈
->
Pª„rDi•Ordî
 && !’_I≈->
E«bÀIDRGOP
) )

1052 
g›_Àngth
;

1053 
PªdSåu˘Atom
 *
p_cuº_g›
;

1056 i‡–
is_•
 > 1 )

1058 
p_cuº_g›
 = 
p_£q_°ru˘
->
p_g›
 + 
is_•
 - 1;

1059 
g›_Àngth
 = 
p_cuº_g›
->
Àngth
;

1063 
g›_Àngth
 = 1;

1067 i‡–(
idx
 % 
p_l⁄ge°_¥d
->
Àngth
) <Ö_longest_prd->length )

1069 
p_£q_°ru˘
->
p›_Êag
 = 
POP_SP
;

1070  ( 
	`imö
–
p_l⁄ge°_¥d
->
Àngth
, 
idx
 + 
g›_Àngth
 - 1 ) );

1074  
idx
;

1079  
idx
;

1082 
idx
++;

1086 
	}
}

1099 
ölöe
 
	$check_powî_of_two
–
numbî
 )

1101  (((~((~
numbî
) + 1)) &Çumber ) == 0) ? 1 : 0;

1102 
	}
}

1119 
	$gë_¥d_ödex
–
I≈utP¨amëîs
 *
p_I≈
, 
SeqSåu˘uª
 *
p_£q_°ru˘
, 
num_‰ames
 )

1121 
cuº_¥d
;

1122 
PªdSåu˘Atom
 *
p_cur_¥d
;

1125  
cuº_¥d
 = (
p_£q_°ru˘
->
num_¥ds
 - 1); curr_prd >= 0; curr_prd-- )

1127 
p_cur_¥d
 = 
p_£q_°ru˘
->
p_¥d
 + 
cuº_¥d
;

1128 i‡–
p_I≈
->
Pª„rPowîOfTwo
 && 
cuº_¥d
 !(
p_£q_°ru˘
->
num_¥ds
 - 1Ë&& !
	`check_powî_of_two
–
p_cur_¥d
->
Àngth
 ) )

1132 i‡–
p_cur_¥d
->
Àngth
 <
num_‰ames
 )

1134  
cuº_¥d
;

1138 
	}
}

1155 
	$gë_idr_ödex
–
I≈utP¨amëîs
 *
p_I≈
, 
SeqSåu˘uª
 *
p_£q_°ru˘
, 
num_‰ames
 )

1157 
cuº_g›
;

1158 
PªdSåu˘Atom
 *
p_cur_g›
;

1161  
cuº_g›
 = (
p_£q_°ru˘
->
num_g›s
 - 1); curr_gop >= 0; curr_gop-- )

1163 
p_cur_g›
 = 
p_£q_°ru˘
->
p_g›
 + 
cuº_g›
;

1164 i‡–
p_I≈
->
Pª„rPowîOfTwo
 && 
cuº_g›
 !(
p_£q_°ru˘
->
num_g›s
 - 1Ë&& !
	`check_powî_of_two
–
p_cur_g›
->
Àngth
 ) )

1168 i‡–
p_cur_g›
->
Àngth
 <
num_‰ames
 )

1170  
cuº_g›
;

1174 
	}
}

1191 
	$gë_öåa_ödex
–
I≈utP¨amëîs
 *
p_I≈
, 
SeqSåu˘uª
 *
p_£q_°ru˘
, 
num_‰ames
 )

1193 
cuº_g›
;

1194 
PªdSåu˘Atom
 *
p_cur_g›
;

1197  
cuº_g›
 = (
p_£q_°ru˘
->
num_öåa_g›s
 - 1); curr_gop >= 0; curr_gop-- )

1199 
p_cur_g›
 = 
p_£q_°ru˘
->
p_öåa_g›
 + 
cuº_g›
;

1200 i‡–
p_I≈
->
Pª„rPowîOfTwo
 && 
cuº_g›
 !(
p_£q_°ru˘
->
num_öåa_g›s
 - 1Ë&& !
	`check_powî_of_two
–
p_cur_g›
->
Àngth
 ) )

1204 i‡–
p_cur_g›
->
Àngth
 <
num_‰ames
 )

1206  
cuº_g›
;

1210 
	}
}

1221 
ölöe
 
	$p›_¥ed_°ru˘_‰m
–
PªdSåu˘Frm
 *
p_d°
, 
¶i˚_ty≥
, 
«l_ªf_idc
, 
di•_off£t
, 
œyî
, 
¶i˚_qp_off
,

1222 
øndom_ac˚ss
, 
ãmp‹Æ_œyî
 )

1224 
p_d°
->
¶i˚_ty≥
 = slice_type;

1225 
p_d°
->
«l_ªf_idc
 =Çal_ref_idc;

1226 
p_d°
->
di•_off£t
 = disp_offset;

1227 
p_d°
->
œyî
 =Üayer;

1228 
p_d°
->
¶i˚_qp_off
 = slice_qp_off;

1229 
p_d°
->
øndom_ac˚ss
 =Ñandom_access;

1230 
p_d°
->
ãmp‹Æ_œyî
 =Åemporal_layer;

1231 
	}
}

1250 
	$öô_g›_°ru˘
–
I≈utP¨amëîs
 *
p_I≈
, 
SeqSåu˘uª
 *
p_£q_°ru˘
, 
is_idr
, *
mem‹y_size
 )

1252 
idx
;

1253 
Àngth
;

1254 
PªdSåu˘Atom
 *
p_cur_g›
, *
p_cur_¥d
, *
p_cur_¥d_èû
 = 
NULL
, *
p_g›
;

1255 
PªdSåu˘Frm
 *
p_d°
, *
p_§c
;

1257 i‡–
is_idr
 )

1260 i‡–
p_I≈
->
idr_≥riod
 =1 ||Ö_I≈->
öåa_≥riod
 == 1 )

1262 
p_£q_°ru˘
->
num_g›s
 = 1;

1264 i‡–
p_I≈
->
öåa_dñay
 && !p_I≈->
E«bÀIDRGOP
 )

1266 
p_£q_°ru˘
->
num_g›s
 = 3;

1268 i‡–
p_I≈
->
öåa_dñay
 || !p_I≈->
E«bÀIDRGOP
 )

1270 
p_£q_°ru˘
->
num_g›s
 = !
p_I≈
->
E«bÀIDRGOP
 ?Ö_£q_°ru˘->
num_¥ds
 : 2;

1274 
p_£q_°ru˘
->
num_g›s
 = !
p_I≈
->
E«bÀIDRGOP
 ?Ö_£q_°ru˘->
num_¥ds
 : 1;

1278 i‡–
p_I≈
->
idr_≥riod
 )

1280 
	`as£π
–
p_I≈
->
öåa_dñay
 <Ö_I≈->
idr_≥riod
 );

1283 
p_£q_°ru˘
->
p_g›
 = (
PªdSåu˘Atom
 *)
	`mÆloc
–p_£q_°ru˘->
num_g›s
 * ( PredStructAtom ) );

1284 *
mem‹y_size
 +–
p_£q_°ru˘
->
num_g›s
 * –
PªdSåu˘Atom
 ) );

1286 
p_g›
 = 
p_£q_°ru˘
->p_gop;

1291 i‡–
p_I≈
->
öåa_≥riod
 == 1 )

1293 
p_£q_°ru˘
->
num_öåa_g›s
 = 1;

1295 i‡–
p_I≈
->
öåa_dñay
 )

1297 
p_£q_°ru˘
->
num_öåa_g›s
 = 3;

1301 
p_£q_°ru˘
->
num_öåa_g›s
 =Ö_£q_°ru˘->
num_¥ds
;

1305 i‡–
p_I≈
->
öåa_≥riod
 )

1307 
	`as£π
–
p_I≈
->
öåa_dñay
 <Ö_I≈->
öåa_≥riod
 );

1310 
p_£q_°ru˘
->
p_öåa_g›
 = (
PªdSåu˘Atom
 *)
	`mÆloc
–p_£q_°ru˘->
num_öåa_g›s
 * ( PredStructAtom ) );

1311 *
mem‹y_size
 +–
p_£q_°ru˘
->
num_öåa_g›s
 * –
PªdSåu˘Atom
 ) );

1313 
p_g›
 = 
p_£q_°ru˘
->
p_öåa_g›
;

1317 
Àngth
 = 1;

1318 
p_cur_g›
 = 
p_g›
;

1319 
p_cur_g›
->
Àngth
 =Üength;

1320 
p_cur_g›
->
p_‰m
 = (
PªdSåu˘Frm
 *)
	`mÆloc
–
Àngth
 * ( PredStructFrm ) );

1321 *
mem‹y_size
 +
Àngth
 * –
PªdSåu˘Frm
 );

1324 
p_cur_g›
 = 
p_g›
;

1325 
p_d°
 = 
p_cur_g›
->
p_‰m
 + 0;

1326 
	`p›_¥ed_°ru˘_‰m
–
p_d°
, 
I_SLICE
, 
NALU_PRIORITY_HIGHEST
, 0, 0, 0, 1, 0 );

1329 i‡–
p_I≈
->
öåa_dñay
 &&Ö_I≈->
öåa_≥riod
 !1 &&Ö_I≈->
idr_≥riod
 != 1 )

1331 
¥oc_‰ames
 = 0;

1332 
°¨t_‰ame
 = 
p_I≈
->
öåa_dñay
 - 1;

1333 
idr_idx
 = 0;

1334 
cuº_¥d
;

1337 
Àngth
 = 
p_I≈
->
öåa_dñay
 + 1;

1338 
p_cur_g›
 = 
p_g›
 + 1;

1339 
p_cur_g›
->
Àngth
 =Üength;

1340 
p_cur_g›
->
g›_Àvñs
 = 1;

1341 
p_cur_g›
->
p_‰m
 = (
PªdSåu˘Frm
 *)
	`mÆloc
–
Àngth
 * ( PredStructFrm ) );

1342 *
mem‹y_size
 +
Àngth
 * –
PªdSåu˘Frm
 );

1345 
p_cur_g›
 = 
p_g›
 + 1;

1346 
p_d°
 = 
p_cur_g›
->
p_‰m
 + 
idr_idx
;

1347 
	`p›_¥ed_°ru˘_‰m
–
p_d°
, 
I_SLICE
, 
NALU_PRIORITY_HIGHEST
, 
p_I≈
->
öåa_dñay
, 0, 0, 1, 0 );

1349 
idr_idx
++;

1351  
¥oc_‰ames
 < 
p_I≈
->
öåa_dñay
 )

1354 
cuº_¥d
 = 
	`gë_¥d_ödex
–
p_I≈
, 
p_£q_°ru˘
,Ö_I≈->
öåa_dñay
 - 
¥oc_‰ames
 );

1355 
p_cur_¥d
 = 
p_£q_°ru˘
->
p_¥d
 + 
cuº_¥d
;

1357 
p_cur_g›
->
g›_Àvñs
 = 
p_cur_¥d
->gop_levels;

1359  
idx
 = 0; idx < 
p_cur_¥d
->
Àngth
; idx++, 
idr_idx
++, 
¥oc_‰ames
++ )

1361 
p_d°
 = 
p_cur_g›
->
p_‰m
 + 
idr_idx
;

1362 
p_§c
 = 
p_cur_¥d
->
p_‰m
 + 
idx
;

1364 
	`p›_¥ed_°ru˘_‰m
–
p_d°
, 
p_§c
->
¶i˚_ty≥
,Ö_§c->
«l_ªf_idc
, 
°¨t_‰ame
 -Ö_§c->
di•_off£t
,Ö_§c->
œyî
,

1365 
p_§c
->
¶i˚_qp_off
, 0,Ö_§c->
ãmp‹Æ_œyî
 );

1368 
°¨t_‰ame
 -
p_cur_¥d
->
Àngth
;

1372 i‡–!
p_I≈
->
E«bÀIDRGOP
 || !
is_idr
 )

1374 
¥oc_‰ames
 = 0;

1375 
°¨t_‰ame
 = 
p_I≈
->
öåa_dñay
 - 1;

1376 
idr_idx
 = 0;

1379 
p_cur_¥d_èû
 = 
p_£q_°ru˘
->
p_¥d
 +Ö_£q_°ru˘->
num_¥ds
 - 1;

1382 
Àngth
 = 
p_I≈
->
öåa_dñay
 + 1 + (
p_cur_¥d_èû
->length - 1);

1383 
p_cur_g›
 = 
p_g›
 + 2;

1384 
p_cur_g›
->
Àngth
 =Üength;

1385 
p_cur_g›
->
g›_Àvñs
 = 1;

1386 
p_cur_g›
->
p_‰m
 = (
PªdSåu˘Frm
 *)
	`mÆloc
–
Àngth
 * ( PredStructFrm ) );

1387 *
mem‹y_size
 +
Àngth
 * –
PªdSåu˘Frm
 );

1388 
idr_idx
 = 0;

1391 
p_cur_g›
 = 
p_g›
 + 2;

1392 
p_d°
 = 
p_cur_g›
->
p_‰m
 + 
idr_idx
;

1393 
	`p›_¥ed_°ru˘_‰m
–
p_d°
, 
I_SLICE
, 
NALU_PRIORITY_HIGHEST
, 
p_I≈
->
öåa_dñay
, 0, 0, 1, 0 );

1395 
idr_idx
++;

1397  
¥oc_‰ames
 < 
p_I≈
->
öåa_dñay
 )

1400 
cuº_¥d
 = 
	`gë_¥d_ödex
–
p_I≈
, 
p_£q_°ru˘
,Ö_I≈->
öåa_dñay
 - 
¥oc_‰ames
 );

1401 
p_cur_¥d
 = 
p_£q_°ru˘
->
p_¥d
 + 
cuº_¥d
;

1403 
p_cur_g›
->
g›_Àvñs
 = 
p_cur_¥d
->gop_levels;

1405  
idx
 = 0; idx < 
p_cur_¥d
->
Àngth
; idx++, 
idr_idx
++, 
¥oc_‰ames
++ )

1407 
p_d°
 = 
p_cur_g›
->
p_‰m
 + 
idr_idx
;

1408 
p_§c
 = 
p_cur_¥d
->
p_‰m
 + 
idx
;

1410 
	`p›_¥ed_°ru˘_‰m
–
p_d°
, 
p_§c
->
¶i˚_ty≥
,Ö_§c->
«l_ªf_idc
, 
°¨t_‰ame
 -Ö_§c->
di•_off£t
,

1411 
p_§c
->
œyî
,Ö_§c->
¶i˚_qp_off
, 0,Ö_§c->
ãmp‹Æ_œyî
 );

1414 
°¨t_‰ame
 -
p_cur_¥d
->
Àngth
;

1418  
idr_idx
 = 0; idr_idx < (
p_I≈
->
öåa_dñay
 + 1); idr_idx++ )

1420 
p_cur_g›
->
p_‰m
[
idr_idx
].
di•_off£t
 +(
p_cur_¥d_èû
->
Àngth
 - 1);

1422 
p_cur_g›
->
g›_Àvñs
 = 
	`imax
–p_cur_g›->g›_Àvñs, 
p_cur_¥d_èû
->gop_levels );

1424  
idx
 = 1; idx < 
p_cur_¥d_èû
->
Àngth
; idx++, 
idr_idx
++ )

1426 
p_d°
 = 
p_cur_g›
->
p_‰m
 + 
idr_idx
;

1427 
p_§c
 = 
p_cur_¥d_èû
->
p_‰m
 + 
idx
;

1429 
	`p›_¥ed_°ru˘_‰m
–
p_d°
, 
p_§c
->
¶i˚_ty≥
,Ö_§c->
«l_ªf_idc
,Ö_§c->
di•_off£t
,

1430 
p_§c
->
œyî
,Ö_§c->
¶i˚_qp_off
, 0,Ö_§c->
ãmp‹Æ_œyî
 );

1434 i‡–!(
p_I≈
->
öåa_dñay
Ë&& ((!p_I≈->
E«bÀIDRGOP
 || !
is_idr
Ë&&Ö_I≈->
öåa_≥riod
 !1 &&Ö_I≈->
idr_≥riod
 != 1) )

1436 
g›_idx
;

1437 
idr_idx
 = 0;

1439  
g›_idx
 = 1; g›_idx < 
p_£q_°ru˘
->
num_¥ds
; gop_idx++ )

1442 
p_cur_¥d
 = 
p_£q_°ru˘
->
p_¥d
 + 
g›_idx
;

1445 
Àngth
 = 
p_cur_¥d
->length;

1446 
p_cur_g›
 = 
p_g›
 + 
g›_idx
;

1447 
p_cur_g›
->
Àngth
 =Üength;

1448 
p_cur_g›
->
p_‰m
 = (
PªdSåu˘Frm
 *)
	`mÆloc
–
Àngth
 * ( PredStructFrm ) );

1449 *
mem‹y_size
 +
Àngth
 * –
PªdSåu˘Frm
 );

1450 
idr_idx
 = 0;

1453 
p_cur_g›
->
g›_Àvñs
 = 
p_cur_¥d
->gop_levels;

1454 
p_d°
 = 
p_cur_g›
->
p_‰m
 + 
idr_idx
;

1455 
	`p›_¥ed_°ru˘_‰m
–
p_d°
, 
I_SLICE
, 
NALU_PRIORITY_HIGHEST
, 
p_cur_¥d
->
p_‰m
[0].
di•_off£t
, 0, 0, 1, 0 );

1456 
idr_idx
++;

1459  
idx
 = 1; idx < 
p_cur_¥d
->
Àngth
; idx++, 
idr_idx
++ )

1461 
p_d°
 = 
p_cur_g›
->
p_‰m
 + 
idr_idx
;

1462 
p_§c
 = 
p_cur_¥d
->
p_‰m
 + 
idx
;

1464 
	`p›_¥ed_°ru˘_‰m
–
p_d°
, 
p_§c
->
¶i˚_ty≥
,Ö_§c->
«l_ªf_idc
,Ö_§c->
di•_off£t
,

1465 
p_§c
->
œyî
,Ö_§c->
¶i˚_qp_off
, 0,Ö_§c->
ãmp‹Æ_œyî
 );

1469 
	}
}

1486 
	$öô_¥ed_°ru˘
–
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
SeqSåu˘uª
 *
p_£q_°ru˘
, *
mem‹y_size
 )

1488 
cuº_¥d
, 
idx
;

1489 
‰m
, 
sum
, 
œyî
, 
‹dî
;

1490 
Àngth
, 
Àngth2
, 
¥ed_mode
;

1491 
PªdSåu˘Atom
 *
p_cur_¥d
;

1492 
PªdSåu˘Frm
 *
p_d°
;

1494 
p_£q_°ru˘
->
num_¥ds
 = (
p_I≈
->
idr_≥riod
 =1 ||Ö_I≈->
öåa_≥riod
 =1Ë? 1 : (p_I≈->
NumbîBFømes
 + 1);

1496 
p_£q_°ru˘
->
p_¥d
 = (
PªdSåu˘Atom
 *)
	`mÆloc
–p_£q_°ru˘->
num_¥ds
 * ( PredStructAtom ) );

1497 *
mem‹y_size
 +
p_£q_°ru˘
->
num_¥ds
 * –
PªdSåu˘Atom
 );

1500  
cuº_¥d
 = (
p_£q_°ru˘
->
num_¥ds
 - 1); curr_prd >= 0; curr_prd-- )

1503 
Àngth
 = 
cuº_¥d
 + 1;

1505 
p_cur_¥d
 = 
p_£q_°ru˘
->
p_¥d
 + 
cuº_¥d
;

1506 
p_cur_¥d
->
Àngth
 =Üength;

1507 
p_cur_¥d
->
p_‰m
 = (
PªdSåu˘Frm
 *)
	`mÆloc
–
Àngth
 * ( PredStructFrm ) );

1508 *
mem‹y_size
 +
Àngth
 * –
PªdSåu˘Frm
 );

1512  
cuº_¥d
 = (
p_£q_°ru˘
->
num_¥ds
 - 1); curr_prd >= 0; curr_prd-- )

1515 
Àngth
 = 
cuº_¥d
 + 1;

1517  
p_I≈
->
HõørchiˇlCodög
 )

1521 
¥ed_mode
 = 0;

1524 
¥ed_mode
 = 1;

1528 
¥ed_mode
 = 
	`check_powî_of_two
–
Àngth
 ) ? 2 : (Üength > 4 ? 1 : 0 );

1532 i‡–
p_I≈
->
LowDñay
 )

1534 
¥ed_mode
 = 3;

1538 
¥ed_mode
 = (
Àngth
 =(
p_I≈
->
NumbîBFømes
 + 1)Ë? 3 : (
	`check_powî_of_two
(Üength ) ? 2 : (Üength > 4 ? 1 : 0 ));

1543 
p_cur_¥d
 = 
p_£q_°ru˘
->
p_¥d
 + 
cuº_¥d
;

1544 
p_cur_¥d
->
g›_Àvñs
 = 0;

1545  
¥ed_mode
 )

1549 
p_d°
 = 
p_cur_¥d
->
p_‰m
 + 0;

1551 
p_d°
->
¶i˚_ty≥
 = ( 
p_I≈
->
BRefPi˘uªs
 =2 ) ? 
B_SLICE
 : 
P_SLICE
;

1552 
p_d°
->
«l_ªf_idc
 = 
NALU_PRIORITY_HIGH
;

1553 
p_d°
->
di•_off£t
 = 
Àngth
 - 1;

1554 
p_d°
->
œyî
 = 0;

1555 
p_d°
->
¶i˚_qp_off
 = ( 
p_I≈
->
BRefPi˘uªs
 =2 ) ? (p_I≈->
qp
[
P_SLICE
] -Ö_I≈->qp[
B_SLICE
]) : 0;

1556 
p_d°
->
øndom_ac˚ss
 = 0;

1557 
p_d°
->
ãmp‹Æ_œyî
 = 0;

1559  
idx
 = 1; idx < 
Àngth
; idx++ )

1561 
p_d°
 = 
p_cur_¥d
->
p_‰m
 + 
idx
;

1563 
p_d°
->
¶i˚_ty≥
 = ( 
p_I≈
->
PRïœ˚BSli˚
 ) ? 
P_SLICE
 : 
B_SLICE
;

1564 
p_d°
->
«l_ªf_idc
 = ( 
p_I≈
->
BRefPi˘uªs
 =1 &&Ö_d°->
¶i˚_ty≥
 =
B_SLICE
 ) ? 
NALU_PRIORITY_LOW
 : 
NALU_PRIORITY_DISPOSABLE
;

1565 
p_d°
->
di•_off£t
 = 
idx
 - 1;

1566 
p_d°
->
œyî
 = 2;

1567 
p_d°
->
¶i˚_qp_off
 = ( 
p_I≈
->
PRïœ˚BSli˚
 ) ? (p_I≈->
qp
[
B_SLICE
] -Ö_I≈->qp[
P_SLICE
]Ë: (p_d°->
«l_ªf_idc
 ?Ö_I≈->
qpBRSOff£t
 : 0);

1568 
p_d°
->
øndom_ac˚ss
 = 0;

1569 
p_d°
->
ãmp‹Æ_œyî
 = 0;

1571 i‡–
Àngth
 > 1 )

1573 
p_cur_¥d
->
g›_Àvñs
 = 1;

1577 
Àngth2
 = ((
Àngth
 - 1) >> 1) + 1;

1579 
p_d°
 = 
p_cur_¥d
->
p_‰m
 + 0;

1581 
p_d°
->
¶i˚_ty≥
 = ( 
p_I≈
->
BRefPi˘uªs
 =2 ) ? 
B_SLICE
 : 
P_SLICE
;

1582 
p_d°
->
«l_ªf_idc
 = 
NALU_PRIORITY_HIGH
;

1583 
p_d°
->
di•_off£t
 = 
Àngth
 - 1;

1584 
p_d°
->
œyî
 = 0;

1585 
p_d°
->
¶i˚_qp_off
 = ( 
p_I≈
->
BRefPi˘uªs
 =2 ) ? (p_I≈->
qp
[
B_SLICE
] -Ö_I≈->qp[
P_SLICE
]) : 0;

1586 
p_d°
->
øndom_ac˚ss
 = 0;

1587 
p_d°
->
ãmp‹Æ_œyî
 = 0;

1589  
idx
 = 1; idx < 
Àngth2
; idx++ )

1591 
p_d°
 = 
p_cur_¥d
->
p_‰m
 + 
idx
;

1593 
p_d°
->
¶i˚_ty≥
 = ( 
p_I≈
->
PRïœ˚BSli˚
 ) ? 
P_SLICE
 : 
B_SLICE
;

1594 
p_d°
->
«l_ªf_idc
 = 
NALU_PRIORITY_LOW
;

1595 
p_d°
->
di•_off£t
 = 2*(
idx
 - 1) + 1;

1596 
p_d°
->
œyî
 = 1;

1597 
p_d°
->
¶i˚_qp_off
 =Ö_d°->
¶i˚_ty≥
 =
B_SLICE
 ?

1598 (
p_I≈
->
HõørchyLevñQPE«bÀ
 ? -1:Ö_I≈->
qpBRSOff£t
) : (p_Inp->HierarchyLevelQPEnable ? 1 : 0);

1599 
p_d°
->
øndom_ac˚ss
 = 0;

1600 
p_d°
->
ãmp‹Æ_œyî
 = 0;

1602  
idx
 = 
Àngth2
; idx < 
Àngth
; idx++ )

1604 
p_d°
 = 
p_cur_¥d
->
p_‰m
 + 
idx
;

1606 
p_d°
->
¶i˚_ty≥
 = ( 
p_I≈
->
PRïœ˚BSli˚
 ) ? 
P_SLICE
 : 
B_SLICE
;

1607 
p_d°
->
«l_ªf_idc
 = 
NALU_PRIORITY_DISPOSABLE
;

1608 
p_d°
->
di•_off£t
 = (
idx
 - 
Àngth2
) * 2;

1609 
p_d°
->
œyî
 = 2;

1610 
p_d°
->
¶i˚_qp_off
 =Ö_d°->
¶i˚_ty≥
 =
B_SLICE
 ? 0 : 2;

1611 
p_d°
->
øndom_ac˚ss
 = 0;

1612 
p_d°
->
ãmp‹Æ_œyî
 = 0;

1614 i‡–
Àngth
 > 1 )

1616 
p_cur_¥d
->
g›_Àvñs
 = 2;

1620 
p_d°
 = 
p_cur_¥d
->
p_‰m
 + 0;

1622 
p_d°
->
¶i˚_ty≥
 = ( 
p_I≈
->
BRefPi˘uªs
 =2 ) ? 
B_SLICE
 : 
P_SLICE
;

1623 
p_d°
->
«l_ªf_idc
 = 
NALU_PRIORITY_HIGH
;

1624 
p_d°
->
di•_off£t
 = 
Àngth
 - 1;

1625 
p_d°
->
œyî
 = 0;

1626 
p_d°
->
¶i˚_qp_off
 = ( 
p_I≈
->
BRefPi˘uªs
 =2 ) ? (p_I≈->
qp
[
B_SLICE
] -Ö_I≈->qp[
P_SLICE
]) : 0;

1627 
p_d°
->
øndom_ac˚ss
 = 0;

1628 
p_d°
->
ãmp‹Æ_œyî
 = 0;

1630 i‡–
Àngth
 > 3 )

1632 
GOPÀvñs
 = 1;

1635 (
Àngth
 >> 
GOPÀvñs
) > 1)

1637 
GOPÀvñs
 ++;

1639 
p_cur_¥d
->
g›_Àvñs
 = 
GOPÀvñs
;

1642  
œyî
 = 1, 
‹dî
 = 1, 
sum
 = 0, 
‰m
 = 1; sum < (
Àngth
 - 1); frm = (frm << 1), sum += frm,Üayer++ )

1645  
idx
 = 0; idx < 
‰m
; idx++, 
‹dî
++ )

1647 
p_d°
 = 
p_cur_¥d
->
p_‰m
 + 
‹dî
;

1649 
p_d°
->
¶i˚_ty≥
 = ( 
p_I≈
->
PRïœ˚BSli˚
 ) ? 
P_SLICE
 : 
B_SLICE
;

1650 
p_d°
->
«l_ªf_idc
 = (
‰m
 =(
Àngth
 >> 1)Ë? 
NALU_PRIORITY_DISPOSABLE
 : 
NALU_PRIORITY_LOW
;

1651 
p_d°
->
di•_off£t
 = ((
Àngth
 - 1Ë>> 
œyî
Ë+ 
idx
 * (length >> (layer - 1));

1652 
p_d°
->
œyî
 =Üayer;

1653 
p_d°
->
¶i˚_qp_off
 =Ö_d°->
¶i˚_ty≥
 =
B_SLICE
 ?

1654 (
p_I≈
->
HõørchyLevñQPE«bÀ
 ? (-
GOPÀvñs
 + 
œyî
): (
p_d°
->
«l_ªf_idc
 !
NALU_PRIORITY_DISPOSABLE
 ?Ö_I≈->
qpBRSOff£t
 : 0)) : (p_Inp->HierarchyLevelQPEnable ?Üayer : 0);

1655 
p_d°
->
øndom_ac˚ss
 = 0;

1656 
p_d°
->
ãmp‹Æ_œyî
 = 0;

1662  
idx
 = 1; idx < 
Àngth
; idx++ )

1664 
p_d°
 = 
p_cur_¥d
->
p_‰m
 + 
idx
;

1666 
p_d°
->
¶i˚_ty≥
 = ( 
p_I≈
->
PRïœ˚BSli˚
 ) ? 
P_SLICE
 : 
B_SLICE
;

1667 
p_d°
->
«l_ªf_idc
 = 
NALU_PRIORITY_DISPOSABLE
;

1668 
p_d°
->
di•_off£t
 = 
idx
 - 1;

1669 
p_d°
->
œyî
 = 2;

1670 
p_d°
->
¶i˚_qp_off
 = 0;

1671 
p_d°
->
øndom_ac˚ss
 = 0;

1672 
p_d°
->
ãmp‹Æ_œyî
 = 0;

1674 i‡–
Àngth
 > 1 )

1676 
p_cur_¥d
->
g›_Àvñs
 = 1;

1682 
max_œyî
 = 0;

1684 i‡–
p_I≈
->
LowDñay
 )

1686  
idx
 = 0; idx < (
Àngth
 - 1); idx++ )

1688 
p_d°
 = 
p_cur_¥d
->
p_‰m
 + 
idx
;

1690 
p_d°
->
¶i˚_ty≥
 = 
p_Vid
->
g›_°ru˘uª
[
idx
].slice_type;

1691 
p_d°
->
«l_ªf_idc
 = 
p_Vid
->
g›_°ru˘uª
[
idx
].
ª„ªn˚_idc
;

1692 
p_d°
->
di•_off£t
 = 
p_Vid
->
g›_°ru˘uª
[
idx
].
di•œy_no
;

1693 
p_d°
->
œyî
 = ((
p_Vid
->
g›_°ru˘uª
[
idx
].
hõørchy_œyî
 == 1) ? 0 : 1) + 1;

1694 
p_d°
->
¶i˚_qp_off
 = 
p_Vid
->
g›_°ru˘uª
[
idx
].slice_qp_off;

1695 
p_d°
->
øndom_ac˚ss
 = 0;

1697 
p_d°
->
ãmp‹Æ_œyî
 = 
p_Vid
->
g›_°ru˘uª
[
idx
].temporal_layer;

1699 i‡–
p_Vid
->
g›_°ru˘uª
[
idx
 - 1].
hõørchy_œyî
 > 
max_œyî
 )

1701 
max_œyî
 = 
p_Vid
->
g›_°ru˘uª
[
idx
 - 1].
hõørchy_œyî
;

1704 
p_d°
 = 
p_cur_¥d
->
p_‰m
 + 
idx
;

1705 
p_d°
->
¶i˚_ty≥
 = ( 
p_I≈
->
BRefPi˘uªs
 =2 ) ? 
B_SLICE
 : 
P_SLICE
;

1706 
p_d°
->
«l_ªf_idc
 = 
NALU_PRIORITY_HIGH
;

1707 
p_d°
->
di•_off£t
 = 
Àngth
 - 1;

1708 
p_d°
->
œyî
 = 0;

1709 
p_d°
->
¶i˚_qp_off
 = ( 
p_I≈
->
BRefPi˘uªs
 =2 ) ? (p_I≈->
qp
[
B_SLICE
] -Ö_I≈->qp[
P_SLICE
]) : 0;

1710 
p_d°
->
øndom_ac˚ss
 = 0;

1712 
p_d°
->
ãmp‹Æ_œyî
 = 0;

1716 
p_d°
 = 
p_cur_¥d
->
p_‰m
 + 0;

1718 
p_d°
->
¶i˚_ty≥
 = ( 
p_I≈
->
BRefPi˘uªs
 =2 ) ? 
B_SLICE
 : 
P_SLICE
;

1719 
p_d°
->
«l_ªf_idc
 = 
NALU_PRIORITY_HIGH
;

1720 
p_d°
->
di•_off£t
 = 
Àngth
 - 1;

1721 
p_d°
->
œyî
 = 0;

1722 
p_d°
->
¶i˚_qp_off
 = ( 
p_I≈
->
BRefPi˘uªs
 =2 ) ? (p_I≈->
qp
[
B_SLICE
] -Ö_I≈->qp[
P_SLICE
]) : 0;

1723 
p_d°
->
øndom_ac˚ss
 = 0;

1724 
p_d°
->
ãmp‹Æ_œyî
 = 0;

1726  
idx
 = 1; idx < 
Àngth
; idx++ )

1728 
p_d°
 = 
p_cur_¥d
->
p_‰m
 + 
idx
;

1730 
p_d°
->
¶i˚_ty≥
 = 
p_Vid
->
g›_°ru˘uª
[
idx
 - 1].slice_type;

1731 
p_d°
->
«l_ªf_idc
 = 
p_Vid
->
g›_°ru˘uª
[
idx
 - 1].
ª„ªn˚_idc
;

1732 
p_d°
->
di•_off£t
 = 
p_Vid
->
g›_°ru˘uª
[
idx
 - 1].
di•œy_no
;

1733 
p_d°
->
œyî
 = ((
p_Vid
->
g›_°ru˘uª
[
idx
 - 1].
hõørchy_œyî
 == 1) ? 0 : 1) + 1;

1734 
p_d°
->
¶i˚_qp_off
 = 
p_Vid
->
g›_°ru˘uª
[
idx
 - 1].slice_qp_off;

1735 
p_d°
->
øndom_ac˚ss
 = 0;

1736 
p_d°
->
ãmp‹Æ_œyî
 = 0;

1738 i‡–
p_Vid
->
g›_°ru˘uª
[
idx
 - 1].
hõørchy_œyî
 > 
max_œyî
 )

1740 
max_œyî
 = 
p_Vid
->
g›_°ru˘uª
[
idx
 - 1].
hõørchy_œyî
;

1744 
p_cur_¥d
->
g›_Àvñs
 = 
max_œyî
 + 1;

1749 
	}
}

1766 
	$p›uœã_‰m_°ru˘
–
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
SeqSåu˘uª
 *
p_£q_°ru˘
, 
num_to_p›uœã
, 
öô_‰ames_to_code
 )

1769 
cuº_‰ame
;

1770 
¥oc_‰ames
;

1771 
is_idr
;

1772 
is_öåa
;

1773 
is_•
;

1774 
ãrmö©e_p›
 = 0;

1776 
p_£q_°ru˘
->
cuº_num_to_p›uœã
 = 
	`imö
–
num_to_p›uœã
, 
öô_‰ames_to_code
 -Ö_£q_°ru˘->
p›_°¨t_‰ame
 );

1777 
cuº_‰ame
 = 
p_£q_°ru˘
->
p›_°¨t_‰ame
;

1778 
¥oc_‰ames
 = 0;

1780  
¥oc_‰ames
 < 
p_£q_°ru˘
->
cuº_num_to_p›uœã
 )

1782 
is_idr
 = 0;

1783 
is_öåa
 = 0;

1784 
is_•
 = 0;

1789 
is_idr
 = 
	`e°ablish_øndom_ac˚ss
–
p_I≈
, 
p_£q_°ru˘
, 
cuº_‰ame
,Ö_£q_°ru˘->
cuº_num_to_p›uœã
 - 
¥oc_‰ames
, 0 );

1790 i‡–
is_idr
 && 
p_£q_°ru˘
->
p›_Êag
 !
POP_INTRA
 &&Ö_£q_°ru˘->p›_Êag !
POP_SP
 )

1793 
g›_‰ame
 = 
	`p›uœã_∫d_acc_¥ed_°ru˘_©om
–
p_Vid
, 
p_I≈
, 
p_£q_°ru˘
, 
cuº_‰ame
, 
¥oc_‰ames
, &
ãrmö©e_p›
, 
is_idr
, 0 );

1795 
cuº_‰ame
 +
g›_‰ame
;

1796 
¥oc_‰ames
 +
g›_‰ame
;

1797 i‡–
ãrmö©e_p›
 )

1799 
ãrmö©e_p›
 = 0;

1805 
is_öåa
 = 
	`e°ablish_öåa
–
p_I≈
, 
p_£q_°ru˘
, 
cuº_‰ame
,Ö_£q_°ru˘->
cuº_num_to_p›uœã
 - 
¥oc_‰ames
, 0 );

1806 i‡–
is_öåa
 && 
p_£q_°ru˘
->
p›_Êag
 !
POP_SP
 )

1809 
g›_‰ame
 = 
	`p›uœã_∫d_acc_¥ed_°ru˘_©om
–
p_Vid
, 
p_I≈
, 
p_£q_°ru˘
, 
cuº_‰ame
, 
¥oc_‰ames
, &
ãrmö©e_p›
, 
is_öåa
, 1 );

1811 
¥oc_‰ames
 +
g›_‰ame
;

1812 
cuº_‰ame
 +
g›_‰ame
;

1813 i‡–
ãrmö©e_p›
 )

1815 
ãrmö©e_p›
 = 0;

1821 
is_•
 = 
	`e°ablish_•
–
p_I≈
, 
p_£q_°ru˘
, 
cuº_‰ame
,Ö_£q_°ru˘->
cuº_num_to_p›uœã
 - 
¥oc_‰ames
, 0 );

1822 i‡–
is_•
 )

1825 
g›_‰ame
 = 
	`p›uœã_∫d_acc_¥ed_°ru˘_©om
–
p_Vid
, 
p_I≈
, 
p_£q_°ru˘
, 
cuº_‰ame
, 
¥oc_‰ames
, &
ãrmö©e_p›
, 
is_•
, 2 );

1827 
¥oc_‰ames
 +
g›_‰ame
;

1828 
cuº_‰ame
 +
g›_‰ame
;

1829 i‡–
ãrmö©e_p›
 )

1831 
ãrmö©e_p›
 = 0;

1838 i‡–!
is_idr
 && !
is_öåa
 && !
is_•
 )

1840 
¥ed_‰ame
 = 
	`p›uœã_ªg_¥ed_°ru˘_©om
–
p_Vid
, 
p_I≈
, 
p_£q_°ru˘
, 
cuº_‰ame
, 
¥oc_‰ames
, &
ãrmö©e_p›
 );

1842 
cuº_‰ame
 +
¥ed_‰ame
;

1843 
¥oc_‰ames
 +
¥ed_‰ame
;

1844 i‡–
ãrmö©e_p›
 )

1846 
ãrmö©e_p›
 = 0;

1852 
p_£q_°ru˘
->
p›_°¨t_‰ame
 = 
cuº_‰ame
;

1853 
	}
}

1872 
	$p›uœã_ªg_pic
–
I≈utP¨amëîs
 *
p_I≈
, 
PicSåu˘uª
 *
p_pic
, 
FømeUnôSåu˘
 *
p_‰m_°ru˘
, 
num_¶i˚s
, 
is_bŸ_Êd
 )

1874 
¶i˚
;

1875 
¶i˚_ty≥
 = (
is_bŸ_Êd
 && 
p_‰m_°ru˘
->
ty≥
 =
I_SLICE
Ë? ( 
p_I≈
->
I¡øBŸtom
 ? I_SLICE : (p_I≈->
BRefPi˘uªs
 =2 ? 
B_SLICE
 : 
P_SLICE
) ) :Ö_frm_struct->type;

1876 
deblock
 = 
p_I≈
->
DFSídP¨amëîs
 ?

1877 (!(
p_I≈
->
DFDißbÀIdc
[
p_‰m_°ru˘
->
«l_ªf_idc
][p_‰m_°ru˘->
ty≥
])) : 1;

1878 
weighãd_¥ed
 = (
¶i˚_ty≥
 =
P_SLICE
) ?

1879 
p_I≈
->
WeighãdPªdi˘i⁄
 : ((
¶i˚_ty≥
 =
B_SLICE
) ?

1880 
p_I≈
->
WeighãdBùªdi˘i⁄
 : 0);

1881 
Sli˚Såu˘uª
 *
p_Sli˚
;

1884 
p_pic
->
idr_Êag
 = !
is_bŸ_Êd
 ? 
p_‰m_°ru˘
->idr_flag : 0;

1885 
p_pic
->
øndom_ac˚ss
 = !
is_bŸ_Êd
 ? 
p_‰m_°ru˘
->random_access : 0;

1886 
p_pic
->
«l_ªf_idc
 = 
p_‰m_°ru˘
->nal_ref_idc;

1887 
p_pic
->
num_¶i˚s
 =Çum_slices;

1889  
¶i˚
 = 0; sli˚ < 
p_pic
->
num_¶i˚s
; slice++ )

1892 
p_Sli˚
 = 
p_pic
->p_Sli˚ + 
¶i˚
;

1894 
p_Sli˚
->
ty≥
 = 
¶i˚_ty≥
;

1895 
p_Sli˚
->
deblock
 = deblock;

1896 
p_Sli˚
->
weighãd_¥ed
 = weighted_pred;

1897 
p_Sli˚
->
num_ªfs
 = 
p_‰m_°ru˘
->num_refs;

1898 
p_Sli˚
->
qp
 = 
p_‰m_°ru˘
->qp;

1900 
	}
}

1928 
	$p›uœã_‰ame
–
I≈utP¨amëîs
 *
p_I≈
, 
SeqSåu˘uª
 *
p_£q_°ru˘
, 
FømeUnôSåu˘
 *
p_‰m_°ru˘
, 
PªdSåu˘Atom
 *
p_cur_¥d
,

1929 
cuº_‰ame
, 
¥ed_‰ame
, 
idx
, 
num_¶i˚s
, 
no_∫d_acc
 )

1931 
PªdSåu˘Frm
 *
p_§c
 = 
p_cur_¥d
->
p_‰m
 + 
idx
;

1934 
p_‰m_°ru˘
->
ty≥
 = 
p_§c
->
¶i˚_ty≥
;

1935 
p_‰m_°ru˘
->
øndom_ac˚ss
 = 
p_§c
->random_access;

1936 
p_‰m_°ru˘
->
num_ªfs
 = 
p_I≈
->
num_ªf_‰ames
;

1937 
p_‰m_°ru˘
->
œyî
 = 
p_§c
->layer;

1938 
p_‰m_°ru˘
->
mod_qp
 = 
p_§c
->
¶i˚_qp_off
;

1939 
p_‰m_°ru˘
->
fõld_pic_Êag
 = 0;

1940 
p_‰m_°ru˘
->
‰ame_no
 = 
cuº_‰ame
 + 
¥ed_‰ame
 + 
p_§c
->
di•_off£t
;

1942 
p_‰m_°ru˘
->
ãmp‹Æ_œyî
 = 
p_§c
->temporal_layer;

1944 i‡–!(
cuº_‰ame
 + 
¥ed_‰ame
 + 
idx
) )

1947 
p_‰m_°ru˘
->
ty≥
 = 
I_SLICE
;

1948 
p_‰m_°ru˘
->
idr_Êag
 = 1;

1949 
p_‰m_°ru˘
->
«l_ªf_idc
 = 
NALU_PRIORITY_HIGHEST
;

1952 i‡–
p_I≈
->
Di•oßbÀP
 && 
p_‰m_°ru˘
->
ty≥
 !
I_SLICE
 && !p_‰m_°ru˘->
œyî
 )

1954 i‡–!(
p_£q_°ru˘
->
œ°_bl_‰m_di•oßbÀ
) )

1956 
p_‰m_°ru˘
->
«l_ªf_idc
 = 
NALU_PRIORITY_DISPOSABLE
;

1957 
p_‰m_°ru˘
->
mod_qp
 +
p_I≈
->
Di•PQPOff£t
;

1961 
p_‰m_°ru˘
->
«l_ªf_idc
 = 
p_§c
->nal_ref_idc;

1963 
p_‰m_°ru˘
->
idr_Êag
 = (
p_§c
->
«l_ªf_idc
 =
NALU_PRIORITY_HIGHEST
) ? 1 : 0;

1965 i‡–
no_∫d_acc
 =1 && !
idx
 )

1967 
p_‰m_°ru˘
->
idr_Êag
 = 0;

1968 
p_‰m_°ru˘
->
«l_ªf_idc
 = 
NALU_PRIORITY_HIGH
;

1969 
p_‰m_°ru˘
->
øndom_ac˚ss
 = 
p_I≈
->
E«bÀO≥nGOP
 ? 1 : 0;

1971 i‡–
no_∫d_acc
 =2 && !
idx
 )

1973 
p_‰m_°ru˘
->
ty≥
 = 
p_I≈
->
si_‰ame_ödiˇt‹
 ? 
SI_SLICE
 : 
SP_SLICE
;

1974 
p_‰m_°ru˘
->
idr_Êag
 = 0;

1975 
p_‰m_°ru˘
->
«l_ªf_idc
 = 
NALU_PRIORITY_HIGH
;

1976 
p_‰m_°ru˘
->
øndom_ac˚ss
 = 0;

1980 
p_‰m_°ru˘
->
idr_Êag
 = (
p_§c
->
«l_ªf_idc
 =
NALU_PRIORITY_HIGHEST
) ? 1 : 0;

1981 
p_‰m_°ru˘
->
«l_ªf_idc
 = 
p_§c
->nal_ref_idc;

1984 
p_‰m_°ru˘
->
qp
 =Ö_‰m_°ru˘->
mod_qp
 + 
p_I≈
->qp[p_‰m_°ru˘->
ty≥
];

1985 #i‡(
DEBUG_PRED_STRUCT
)

1986 
	`Ârötf
–
°dîr
, "\n\¿FømêP›uœti⁄ Sèt†f‹ Fømê%5d i¿codög ordî", 
cuº_‰ame
 + 
¥ed_‰ame
 + 
idx
 );

1987  
p_‰m_°ru˘
->
ty≥
 )

1990 
I_SLICE
:

1991 
	`Ârötf
–
°dîr
, "\n Slice Type: I_SLICE " );

1993 
P_SLICE
:

1994 
	`Ârötf
–
°dîr
, "\n Slice Type: P_SLICE " );

1996 
B_SLICE
:

1997 
	`Ârötf
–
°dîr
, "\n Slice Type: B_SLICE " );

1999 
SP_SLICE
:

2000 
	`Ârötf
–
°dîr
, "\n Slice Type: SP_SLICE " );

2002 
SI_SLICE
:

2003 
	`Ârötf
–
°dîr
, "\n Slice Type: SI_SLICE " );

2006 
	`Ârötf
–
°dîr
, "\¿IDRÖi˘uª: %d ", 
p_‰m_°ru˘
->
idr_Êag
 );

2007  
p_‰m_°ru˘
->
«l_ªf_idc
 )

2010 
NALU_PRIORITY_HIGHEST
:

2011 
	`Ârötf
–
°dîr
, "\n NAL_reference_idc: NALU_PRIORITY_HIGHEST ");

2013 
NALU_PRIORITY_HIGH
:

2014 
	`Ârötf
–
°dîr
, "\n NAL_reference_idc: NALU_PRIORITY_HIGH ");

2016 
NALU_PRIORITY_LOW
:

2017 
	`Ârötf
–
°dîr
, "\n NAL_reference_idc: NALU_PRIORITY_LOW ");

2019 
NALU_PRIORITY_DISPOSABLE
:

2020 
	`Ârötf
–
°dîr
, "\n NAL_reference_idc: NALU_PRIORITY_DISPOSABLE ");

2023 
	`Ârötf
–
°dîr
, "\¿R™dom Ac˚ss: %d ", 
p_‰m_°ru˘
->
øndom_ac˚ss
 );

2024 
	`Ârötf
–
°dîr
, "\¿Numbî o‡Re„ªn˚s: %2d ", 
p_‰m_°ru˘
->
num_ªfs
 );

2025 
	`Ârötf
–
°dîr
, "\¿Hõørchy Layî: %d ", 
p_‰m_°ru˘
->
œyî
 );

2026 
	`Ârötf
–
°dîr
, "\¿QP Modifõr: %2d ", 
p_‰m_°ru˘
->
qp
 );

2027 
	`Ârötf
–
°dîr
, "\¿Fõld Codög: %d ", 
p_‰m_°ru˘
->
fõld_pic_Êag
 );

2028 
	`Ârötf
–
°dîr
, "\¿Di•œy Ordî: %5d ", 
p_‰m_°ru˘
->
‰ame_no
 );

2032 
p_‰m_°ru˘
->
p_©om
 = 
p_cur_¥d
;

2033 
p_‰m_°ru˘
->
©om_idx
 = 
idx
;

2034 #i‡(
MVC_EXTENSION_ENABLE
)

2035 
p_‰m_°ru˘
->
võw_id
 = 0;

2039  
p_I≈
->
PicI¡îœ˚
 )

2042 
FRAME_CODING
:

2044 
	`p›uœã_ªg_pic
–
p_I≈
, 
p_‰m_°ru˘
->
p_‰ame_pic
,Ö_‰m_°ru˘, 
num_¶i˚s
, 0 );

2046 
FIELD_CODING
:

2048 
	`p›uœã_ªg_pic
–
p_I≈
, 
p_‰m_°ru˘
->
p_t›_Êd_pic
,Ö_‰m_°ru˘, 
num_¶i˚s
, 0 );

2050 
	`p›uœã_ªg_pic
–
p_I≈
, 
p_‰m_°ru˘
->
p_bŸ_Êd_pic
,Ö_‰m_°ru˘, 
num_¶i˚s
, 1 );

2052 
ADAPTIVE_CODING
:

2054 
	`p›uœã_ªg_pic
–
p_I≈
, 
p_‰m_°ru˘
->
p_‰ame_pic
,Ö_‰m_°ru˘, 
num_¶i˚s
, 0 );

2056 
	`p›uœã_ªg_pic
–
p_I≈
, 
p_‰m_°ru˘
->
p_t›_Êd_pic
,Ö_‰m_°ru˘, 
num_¶i˚s
, 0 );

2058 
	`p›uœã_ªg_pic
–
p_I≈
, 
p_‰m_°ru˘
->
p_bŸ_Êd_pic
,Ö_‰m_°ru˘, 
num_¶i˚s
, 1 );

2061 
	}
}

2078 
	$upd©e_‰ame_ödi˚s
–
SeqSåu˘uª
 *
p_£q_°ru˘
, 
FømeUnôSåu˘
 *
p_‰m_°ru˘
, 
cuº_‰ame
, 
¥ed_‰ame
 )

2080 i‡–
p_‰m_°ru˘
->
idr_Êag
 )

2083 
p_£q_°ru˘
->
œ°_öåa_‰ame
 = 
cuº_‰ame
 + 
¥ed_‰ame
;

2084 
p_£q_°ru˘
->
œ°_idr_‰ame
 = 
cuº_‰ame
 + 
¥ed_‰ame
;

2085 
p_£q_°ru˘
->
œ°_øndom_ac˚ss_‰ame
 = 
cuº_‰ame
 + 
¥ed_‰ame
;

2087 
p_£q_°ru˘
->
œ°_öåa_di•
 = 
p_‰m_°ru˘
->
‰ame_no
;

2088 
p_£q_°ru˘
->
œ°_idr_‰ame
 = 
p_‰m_°ru˘
->
‰ame_no
;

2089 
p_£q_°ru˘
->
œ°_ønd_ac˚ss_di•
 = 
p_‰m_°ru˘
->
‰ame_no
;

2092 
p_£q_°ru˘
->
œ°_•_‰ame
 = 
cuº_‰ame
 + 
¥ed_‰ame
;

2094 
p_£q_°ru˘
->
œ°_•_di•
 = 
p_‰m_°ru˘
->
‰ame_no
;

2096 i‡–
p_‰m_°ru˘
->
ty≥
 =
I_SLICE
 )

2099 
p_£q_°ru˘
->
œ°_öåa_‰ame
 = 
cuº_‰ame
 + 
¥ed_‰ame
;

2101 
p_£q_°ru˘
->
œ°_öåa_di•
 = 
p_‰m_°ru˘
->
‰ame_no
;

2102 i‡–
p_‰m_°ru˘
->
øndom_ac˚ss
 )

2105 
p_£q_°ru˘
->
œ°_øndom_ac˚ss_‰ame
 = 
cuº_‰ame
 + 
¥ed_‰ame
;

2107 
p_£q_°ru˘
->
œ°_ønd_ac˚ss_di•
 = 
p_‰m_°ru˘
->
‰ame_no
;

2110 i‡–
p_‰m_°ru˘
->
ty≥
 =
SP_SLICE
 ||Ö_‰m_°ru˘->ty≥ =
SI_SLICE
 )

2113 
p_£q_°ru˘
->
œ°_•_‰ame
 = 
cuº_‰ame
 + 
¥ed_‰ame
;

2115 
p_£q_°ru˘
->
œ°_•_di•
 = 
p_‰m_°ru˘
->
‰ame_no
;

2117 i‡–
p_‰m_°ru˘
->
œyî
 == 0 )

2119 i‡–
p_‰m_°ru˘
->
«l_ªf_idc
 =
NALU_PRIORITY_DISPOSABLE
 )

2121 
p_£q_°ru˘
->
œ°_bl_‰m_di•oßbÀ
 = 1;

2125 
p_£q_°ru˘
->
œ°_bl_‰m_di•oßbÀ
 = 0;

2128 
	}
}

2151 
	$p›uœã_ªg_¥ed_°ru˘_©om
–
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
SeqSåu˘uª
 *
p_£q_°ru˘
,

2152 
cuº_‰ame
, 
¥oc_‰ames
, *
ãrmö©e_p›
 )

2154 
idx
;

2155 
fixed_idx
;

2156 
avaû_‰ames
;

2157 
¥ed_‰ame
 = 0;

2158 
¥ed_idx
;

2160 
FømeUnôSåu˘
 *
p_‰m_°ru˘
;

2161 
PªdSåu˘Atom
 *
p_cur_¥d
;

2166 i‡–!(
p_I≈
->
öåa_dñay
) )

2168 
fixed_idx
 = 
	`gë_fixed_‰ame_f‹_¥d
–
p_I≈
, 
p_£q_°ru˘
, 
cuº_‰ame
,Ö_£q_°ru˘->
cuº_num_to_p›uœã
 - 
¥oc_‰ames
 );

2173 
fixed_idx
 = 
	`gë_fixed_‰ame
–
p_I≈
, 
p_£q_°ru˘
, 
cuº_‰ame
,Ö_£q_°ru˘->
cuº_num_to_p›uœã
 - 
¥oc_‰ames
 );

2175 i‡–
fixed_idx
 == -1 )

2177 
avaû_‰ames
 = 
p_£q_°ru˘
->
cuº_num_to_p›uœã
 - 
¥oc_‰ames
;

2181 
avaû_‰ames
 = 
fixed_idx
;

2184 i‡–!
avaû_‰ames
 )

2186 *
ãrmö©e_p›
 = 1;

2190  
¥ed_‰ame
 < 
avaû_‰ames
 )

2192 
¥ed_idx
 = 
	`gë_¥d_ödex
–
p_I≈
, 
p_£q_°ru˘
, 
avaû_‰ames
 - 
¥ed_‰ame
 );

2195 i‡–
fixed_idx
 =-1 && (
cuº_‰ame
 + 
avaû_‰ames
Ë< 
p_I≈
->
no_‰ames
 )

2197 i‡–(
p_£q_°ru˘
->
num_¥ds
 - 1Ë!
¥ed_idx
 )

2199 *
ãrmö©e_p›
 = 1;

2204 
p_cur_¥d
 = 
p_£q_°ru˘
->
p_¥d
 + 
¥ed_idx
;

2208  
idx
 = 0; idx < 
p_cur_¥d
->
Àngth
; idx++ )

2211 
p_‰m_°ru˘
 = 
p_£q_°ru˘
->
p_‰m
 + ((
cuº_‰ame
 + 
¥ed_‰ame
 + 
idx
Ë% 
p_Vid
->
‰m_°ru˘_buf„r
);

2214 
	`p›uœã_‰ame
–
p_I≈
, 
p_£q_°ru˘
, 
p_‰m_°ru˘
, 
p_cur_¥d
, 
cuº_‰ame
, 
¥ed_‰ame
, 
idx
,Ö_£q_°ru˘->
max_num_¶i˚s
, 0 );

2217 
	`upd©e_‰ame_ödi˚s
–
p_£q_°ru˘
, 
p_‰m_°ru˘
, 
cuº_‰ame
, 
¥ed_‰ame
 + 
idx
 );

2219 
¥ed_‰ame
 +
idx
;

2221  
¥ed_‰ame
;

2222 
	}
}

2250 
	$p›uœã_∫d_acc_¥ed_°ru˘_©om
–
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
SeqSåu˘uª
 *
p_£q_°ru˘
,

2251 
cuº_‰ame
, 
¥oc_‰ames
, *
ãrmö©e_p›
, 
is_idr
, 
no_∫d_acc
 )

2254 
idx
;

2255 
fixed_idx
;

2256 
avaû_‰ames
;

2257 
g›_‰ame
 = 0;

2258 
g›_idx
;

2259 
num_g›s
;

2261 
FømeUnôSåu˘
 *
p_‰m_°ru˘
;

2262 
PªdSåu˘Atom
 *
p_cur_g›
;

2263 
PªdSåu˘Atom
 *
p_g›
;

2264 (*
gë_ønd_acc_ödex
)–
I≈utP¨amëîs
 *, 
SeqSåu˘uª
 *, );

2266 i‡–
no_∫d_acc
 == 1 )

2268 
p_g›
 = 
p_£q_°ru˘
->
p_öåa_g›
;

2269 
num_g›s
 = 
p_£q_°ru˘
->
num_öåa_g›s
;

2270 
gë_ønd_acc_ödex
 = 
gë_öåa_ödex
;

2274 
p_g›
 = 
p_£q_°ru˘
->p_gop;

2275 
num_g›s
 = 
p_£q_°ru˘
->num_gops;

2276 
gë_ønd_acc_ödex
 = 
gë_idr_ödex
;

2282 
fixed_idx
 = 
	`gë_fixed_‰ame
–
p_I≈
, 
p_£q_°ru˘
, 
cuº_‰ame
 + 1,Ö_£q_°ru˘->
cuº_num_to_p›uœã
 - 
¥oc_‰ames
 - 1 );

2283 i‡–
fixed_idx
 == -1 )

2285 
avaû_‰ames
 = 
p_£q_°ru˘
->
cuº_num_to_p›uœã
 - 
¥oc_‰ames
;

2289 
avaû_‰ames
 = 
fixed_idx
 + 1;

2294 i‡–!
cuº_‰ame
 && !(
p_I≈
->
E«bÀIDRGOP
Ë&& !’_I≈->
öåa_dñay
) )

2296 
g›_idx
 = 0;

2298 i‡–!
cuº_‰ame
 && !(
p_I≈
->
E«bÀIDRGOP
Ë&&Ö_I≈->
öåa_dñay
 )

2300 
g›_idx
 = 1;

2304 i‡–!(
p_I≈
->
Pª„rDi•Ordî
) )

2307 
g›_idx
 = 
	`gë_ønd_acc_ödex
–
p_I≈
, 
p_£q_°ru˘
, 
avaû_‰ames
 );

2312 
g›_idx
 = 
is_idr
 - 1;

2315 i‡–
fixed_idx
 =-1 && (
cuº_‰ame
 + 
avaû_‰ames
Ë< 
p_I≈
->
no_‰ames
 )

2317 i‡–(
num_g›s
 - 1Ë!
g›_idx
 && !
p_£q_°ru˘
->
p›_Êag
 )

2319 *
ãrmö©e_p›
 = 1;

2326 i‡–
p_£q_°ru˘
->
p›_Êag
 )

2328 
p_£q_°ru˘
->
p›_Êag
 = 0;

2332 
p_cur_g›
 = 
p_g›
 + 
g›_idx
;

2334  
idx
 = 0; idx < 
p_cur_g›
->
Àngth
; idx++ )

2337 
p_‰m_°ru˘
 = 
p_£q_°ru˘
->
p_‰m
 + ((
cuº_‰ame
 + 
g›_‰ame
 + 
idx
Ë% 
p_Vid
->
‰m_°ru˘_buf„r
);

2340 
	`p›uœã_‰ame
–
p_I≈
, 
p_£q_°ru˘
, 
p_‰m_°ru˘
, 
p_cur_g›
, 
cuº_‰ame
, 
g›_‰ame
, 
idx
,Ö_£q_°ru˘->
max_num_¶i˚s
, 
no_∫d_acc
 );

2343 
	`upd©e_‰ame_ödi˚s
–
p_£q_°ru˘
, 
p_‰m_°ru˘
, 
cuº_‰ame
, 
g›_‰ame
 + 
idx
 );

2345 
g›_‰ame
 +
idx
;

2347  
g›_‰ame
;

2348 
	}
}

2359 
	$‰ì_g›_°ru˘
–
SeqSåu˘uª
 *
p_£q_°ru˘
 )

2361 
idx
;

2362 
PªdSåu˘Atom
 *
p_cur_g›
;

2365  
idx
 = 0; idx < 
p_£q_°ru˘
->
num_g›s
; idx++ )

2367 
p_cur_g›
 = 
p_£q_°ru˘
->
p_g›
 + 
idx
;

2368 
	`‰ì
–
p_cur_g›
->
p_‰m
 );

2370 
	`‰ì
–
p_£q_°ru˘
->
p_g›
 );

2372  
idx
 = 0; idx < 
p_£q_°ru˘
->
num_öåa_g›s
; idx++ )

2374 
p_cur_g›
 = 
p_£q_°ru˘
->
p_öåa_g›
 + 
idx
;

2375 
	`‰ì
–
p_cur_g›
->
p_‰m
 );

2377 
	`‰ì
–
p_£q_°ru˘
->
p_öåa_g›
 );

2378 
	}
}

2389 
	$‰ì_¥ed_°ru˘
–
SeqSåu˘uª
 *
p_£q_°ru˘
 )

2391 
idx
;

2392 
PªdSåu˘Atom
 *
p_cur_¥d
;

2395  
idx
 = 0; idx < 
p_£q_°ru˘
->
num_¥ds
; idx++ )

2397 
p_cur_¥d
 = 
p_£q_°ru˘
->
p_¥d
 + 
idx
;

2398 
	`‰ì
–
p_cur_¥d
->
p_‰m
 );

2400 
	`‰ì
–
p_£q_°ru˘
->
p_¥d
 );

2401 
	}
}

2418 
	$p›uœã_‰ame_ex∂icô
–
ExpFømeInfo
 *
öfo
, 
I≈utP¨amëîs
 *
p_I≈
, 
FømeUnôSåu˘
 *
p_‰m_°ru˘
, 
num_¶i˚s
 )

2421 
p_‰m_°ru˘
->
idr_Êag
 = 
öfo
->
is_idr
;

2422 
p_‰m_°ru˘
->
«l_ªf_idc
 = 
öfo
->
ª„ªn˚_idc
;

2423 
p_‰m_°ru˘
->
ty≥
 = 
öfo
->
¶i˚_ty≥
;

2424 
p_‰m_°ru˘
->
øndom_ac˚ss
 = 
öfo
->
is_idr
;

2425 
p_‰m_°ru˘
->
num_ªfs
 = 
p_I≈
->
num_ªf_‰ames
;

2426 
p_‰m_°ru˘
->
œyî
 = 
öfo
->
ª„ªn˚_idc
 ? 0 : 1;

2427 
p_‰m_°ru˘
->
mod_qp
 = 0;

2428 
p_‰m_°ru˘
->
fõld_pic_Êag
 = 0;

2429 
p_‰m_°ru˘
->
‰ame_no
 = 
öfo
->
£q_numbî
;

2430 
p_‰m_°ru˘
->
qp
 =Ö_‰m_°ru˘->
mod_qp
 + 
p_I≈
->qp[p_‰m_°ru˘->
ty≥
];

2433  
p_I≈
->
PicI¡îœ˚
 )

2436 
FRAME_CODING
:

2438 
	`p›uœã_ªg_pic
–
p_I≈
, 
p_‰m_°ru˘
->
p_‰ame_pic
,Ö_‰m_°ru˘, 
num_¶i˚s
, 0 );

2440 
FIELD_CODING
:

2442 
	`p›uœã_ªg_pic
–
p_I≈
, 
p_‰m_°ru˘
->
p_t›_Êd_pic
,Ö_‰m_°ru˘, 
num_¶i˚s
, 0 );

2444 
	`p›uœã_ªg_pic
–
p_I≈
, 
p_‰m_°ru˘
->
p_bŸ_Êd_pic
,Ö_‰m_°ru˘, 
num_¶i˚s
, 1 );

2446 
ADAPTIVE_CODING
:

2448 
	`p›uœã_ªg_pic
–
p_I≈
, 
p_‰m_°ru˘
->
p_‰ame_pic
,Ö_‰m_°ru˘, 
num_¶i˚s
, 0 );

2450 
	`p›uœã_ªg_pic
–
p_I≈
, 
p_‰m_°ru˘
->
p_t›_Êd_pic
,Ö_‰m_°ru˘, 
num_¶i˚s
, 0 );

2452 
	`p›uœã_ªg_pic
–
p_I≈
, 
p_‰m_°ru˘
->
p_bŸ_Êd_pic
,Ö_‰m_°ru˘, 
num_¶i˚s
, 1 );

2455 
	}
}

2472 
	$p›uœã_‰ame_¶i˚_ty≥
–
I≈utP¨amëîs
 *
p_I≈
, 
FømeUnôSåu˘
 *
p_‰m_°ru˘
, 
¶i˚_ty≥
, 
num_¶i˚s
 )

2474 
p_‰m_°ru˘
->
ty≥
 = 
¶i˚_ty≥
;

2477 
	`p›uœã_ªg_pic
–
p_I≈
, 
p_‰m_°ru˘
->
p_‰ame_pic
,Ö_‰m_°ru˘, 
num_¶i˚s
, 0 );

2478 
	}
}

2480 #i‡(
MVC_EXTENSION_ENABLE
)

2498 
	$p›uœã_‰m_°ru˘_mvc
–
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
SeqSåu˘uª
 *
p_£q_°ru˘
, 
°¨t
, 
íd
 )

2500 
võw_id
;

2501 
idx
;

2502 
FømeUnôSåu˘
 *
p_cuº_‰m
, *
p_‰m
 = 
p_£q_°ru˘
->p_frm;

2503 
FømeUnôSåu˘
 *
p_cuº_‰m_mvc
, *
p_‰m_mvc
 = 
p_£q_°ru˘
->p_frm_mvc;

2505 i‡–
p_I≈
->
num_of_võws
 == 2 )

2507  
idx
 = 
°¨t
; idx < 
íd
; idx++ )

2509 
p_cuº_‰m
 = 
p_‰m
 + (
idx
 % 
p_Vid
->
‰m_°ru˘_buf„r
);

2512 
p_cuº_‰m_mvc
 = 
p_‰m_mvc
 + ((
idx
 << 1Ë% 
p_£q_°ru˘
->
num_‰ames_mvc
);

2513 
	`c›y_‰ame_mvc
–
p_I≈
, 
p_cuº_‰m
, 
p_cuº_‰m_mvc
, 
p_£q_°ru˘
->
max_num_¶i˚s
, 0 );

2515 
p_cuº_‰m_mvc
 = 
p_‰m_mvc
 + (((
idx
 << 1Ë+ 1Ë% 
p_£q_°ru˘
->
num_‰ames_mvc
);

2516 
	`c›y_‰ame_mvc
–
p_I≈
, 
p_cuº_‰m
, 
p_cuº_‰m_mvc
, 
p_£q_°ru˘
->
max_num_¶i˚s
, 1 );

2521 
	`as£π
–
p_I≈
->
num_of_võws
 > 2 );

2522  
idx
 = 
°¨t
; idx < 
íd
; idx++ )

2524 
p_cuº_‰m
 = 
p_‰m
 + (
idx
 % 
p_Vid
->
‰m_°ru˘_buf„r
);

2526  
võw_id
 = 0; võw_id < 
p_I≈
->
num_of_võws
; view_id++ )

2529 
p_cuº_‰m_mvc
 = 
p_‰m_mvc
 + (((
idx
 * 
p_I≈
->
num_of_võws
Ë+ 
võw_id
Ë% 
p_£q_°ru˘
->
num_‰ames_mvc
);

2530 
	`c›y_‰ame_mvc
–
p_I≈
, 
p_cuº_‰m
, 
p_cuº_‰m_mvc
, 
p_£q_°ru˘
->
max_num_¶i˚s
, 
võw_id
 );

2534 
	}
}

2555 
	$c›y_‰ame_mvc
–
I≈utP¨amëîs
 *
p_I≈
, 
FømeUnôSåu˘
 *
p_§c
, FømeUnôSåu˘ *
p_d°
, 
num_¶i˚s
, 
võw_id
 )

2558 
p_d°
->
ty≥
 = 
võw_id
 ? 
p_I≈
->
MVCI¡îVõwF‹˚B
 !0? 
B_SLICE
 : (
p_§c
->ty≥ =
I_SLICE
 ? (p_I≈->
BRefPi˘uªs
 =2 ? B_SLICE : 
P_SLICE
) :Ö_src->type) :Ö_src->type;

2559 
p_d°
->
øndom_ac˚ss
 = 
p_§c
->random_access;

2560 
p_d°
->
num_ªfs
 = 
p_§c
->num_refs;

2561 
p_d°
->
œyî
 = 
p_§c
->layer;

2562 
p_d°
->
mod_qp
 = 
p_§c
->mod_qp;

2563 
p_d°
->
fõld_pic_Êag
 = 
p_§c
->field_pic_flag;

2564 
p_d°
->
‰ame_no
 = 
p_§c
->frame_no;

2565 
p_d°
->
idr_Êag
 = 
võw_id
 ? 0 : 
p_§c
->idr_flag;

2566 
p_d°
->
«l_ªf_idc
 = 
võw_id
 ? (
p_§c
->
idr_Êag
 ? 
NALU_PRIORITY_HIGH
 :Ö_src->nal_ref_idc) :Ö_src->nal_ref_idc;

2567 
p_d°
->
qp
 = 
p_§c
->qp;

2568 
p_d°
->
p_©om
 = 
p_§c
->p_atom;

2569 
p_d°
->
©om_idx
 = 
p_§c
->atom_idx;

2570 
p_d°
->
võw_id
 = view_id;

2573  
p_I≈
->
PicI¡îœ˚
 )

2576 
FRAME_CODING
:

2578 
	`p›uœã_ªg_pic
–
p_I≈
, 
p_d°
->
p_‰ame_pic
,Ö_d°, 
num_¶i˚s
, 0 );

2580 
FIELD_CODING
:

2582 
	`p›uœã_ªg_pic
–
p_I≈
, 
p_d°
->
p_t›_Êd_pic
,Ö_d°, 
num_¶i˚s
, 0 );

2584 
	`p›uœã_ªg_pic
–
p_I≈
, 
p_d°
->
p_bŸ_Êd_pic
,Ö_d°, 
num_¶i˚s
, 1 );

2586 
ADAPTIVE_CODING
:

2588 
	`p›uœã_ªg_pic
–
p_I≈
, 
p_d°
->
p_‰ame_pic
,Ö_d°, 
num_¶i˚s
, 0 );

2590 
	`p›uœã_ªg_pic
–
p_I≈
, 
p_d°
->
p_t›_Êd_pic
,Ö_d°, 
num_¶i˚s
, 0 );

2592 
	`p›uœã_ªg_pic
–
p_I≈
, 
p_d°
->
p_bŸ_Êd_pic
,Ö_d°, 
num_¶i˚s
, 1 );

2595 
	}
}

	@lencod/src/q_around.c

15 
	~"globÆ.h
"

16 
	~"memÆloc.h
"

17 
	~"q_off£ts.h
"

18 
	~"q_¨ound.h
"

20 c⁄° 
	gAd≠tRndCrPos
[2][5] =

27 c⁄° 
	gAd≠tRndPos
[4][5] =

43 
	$°‹e_ad≠tive_roundög_4x4
 (
VideoP¨amëîs
 *
p_Vid
, ****
ARCofAdj
, 
mode
, 
block_y
, 
block_x
)

45 
j
;

47 
j
 = 
block_y
; j < block_y + 4; j++)

48 
	`mem˝y
(&
ARCofAdj
[0][
DUMMY
][
j
][
block_x
], &ARCofAdj[0][
mode
][j][block_x], 
BLOCK_SIZE
 * ());

50 i‡(
p_Vid
->
P444_joöed
)

52 
j
 = 
block_y
; j < block_y + 4; j++)

54 
	`mem˝y
(&
ARCofAdj
[1][
DUMMY
][
j
][
block_x
],&ARCofAdj[1][
mode
][j][block_x], 
BLOCK_SIZE
 * ());

56 
j
 = 
block_y
; j < block_y + 4; j++)

58 
	`mem˝y
(&
ARCofAdj
[2][
DUMMY
][
j
][
block_x
],&ARCofAdj[2][
mode
][j][block_x], 
BLOCK_SIZE
 * ());

61 
	}
}

70 
	$upd©e_ad≠tive_roundög_4x4
 (
VideoP¨amëîs
 *
p_Vid
, ****
ARCofAdj
 , 
mode
, 
block_y
, 
block_x
)

72 
j
;

74 
j
 = 
block_y
; j < block_y + 
BLOCK_SIZE
; j++)

75 
	`mem˝y
 (&
ARCofAdj
[0][
mode
][
j
][
block_x
],&ARCofAdj[0][
DUMMY
][j][block_x], 
BLOCK_SIZE
 * ());

77 i‡(
p_Vid
->
P444_joöed
)

79 
j
 = 0; j < 
block_y
 + 
BLOCK_SIZE
; j++)

81 
	`mem˝y
 (&
ARCofAdj
[1][
mode
][
j
][
block_x
], &ARCofAdj[1][
DUMMY
][j][block_x], 
BLOCK_SIZE
 * ());

83 
j
 = 0; j < 
block_y
 + 
BLOCK_SIZE
; j++)

85 
	`mem˝y
 (&
ARCofAdj
[2][
mode
][
j
][
block_x
], &ARCofAdj[2][
DUMMY
][j][block_x], 
BLOCK_SIZE
 * ());

88 
	}
}

96 
	$°‹e_ad≠tive_roundög_16x16
 (
VideoP¨amëîs
 *
p_Vid
, ****
ARCofAdj
, 
mode
)

98 
	`mem˝y
(&
ARCofAdj
[0][
DUMMY
][0][0], &ARCofAdj[0][
mode
][0][0], 
MB_PIXELS
 * ());

99 i‡(
p_Vid
->
P444_joöed
)

101 
	`mem˝y
(&
ARCofAdj
[1][
DUMMY
][0][0], &ARCofAdj[1][
mode
][0][0], 
MB_PIXELS
 * ());

102 
	`mem˝y
(&
ARCofAdj
[2][
DUMMY
][0][0], &ARCofAdj[2][
mode
][0][0], 
MB_PIXELS
 * ());

104 
	}
}

113 
	$upd©e_ad≠tive_roundög_16x16
(
VideoP¨amëîs
 *
p_Vid
, ****
ARCofAdj
 , 
mode
)

115 
	`mem˝y
 (&
ARCofAdj
[0][
mode
][0][0],&ARCofAdj[0][
DUMMY
][0][0], 
MB_PIXELS
 * ());

116 i‡(
p_Vid
->
P444_joöed
)

118 
	`mem˝y
 (&
ARCofAdj
[1][
mode
][0][0], &ARCofAdj[1][
DUMMY
][0][0], 
MB_PIXELS
 * ());

119 
	`mem˝y
 (&
ARCofAdj
[2][
mode
][0][0], &ARCofAdj[2][
DUMMY
][0][0], 
MB_PIXELS
 * ());

121 
	}
}

132 
	$upd©e_off£t_∑øms
(
Ma¸oblock
 *
cuºMB
, 
mode
, 
byã
 
luma_å™sf‹m_size_8x8_Êag
)

134 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

135 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

136 
is_öãr
 = (
mode
 !
I4MB
)&&(modê!
I16MB
Ë&& (modê!
I8MB
);

137 
luma_pos
 = 
Ad≠tRndPos
[(
is_öãr
<<1Ë+ 
luma_å™sf‹m_size_8x8_Êag
][
p_Vid
->
ty≥
];

138 
i
,
j
;

139 
qp
 = 
cuºMB
->q∞+ 
p_Vid
->
bôdïth_luma_qp_sˇÀ
;

140 
cur_qp
 = 
p_I≈
->
Ad≠tRoundögFixed
 ? 0 : 
qp
;

141 
ãmp
 = 0;

142 
Qu™tP¨amëîs
 *
p_Qu™t
 = 
p_Vid
->p_Quant;

143 
off£tR™ge
 = 1 << (
Off£tBôs
 - 1);

144 
blk_mask
 = 0x03 + (
luma_å™sf‹m_size_8x8_Êag
<<2);

145 
blk_shi·
 = 2 + 
luma_å™sf‹m_size_8x8_Êag
;

146 **
off£tLi°
 = 
luma_å™sf‹m_size_8x8_Êag
 ? 
p_Qu™t
->
Off£tLi°8x8
[
cur_qp
] :Ö_Qu™t->
Off£tLi°4x4
[cur_qp];

147 *
cur_off£t_li°
 = 
off£tLi°
[
luma_pos
];

149 **
fAdju°
 = 
luma_å™sf‹m_size_8x8_Êag
 ? 
p_Vid
->
ARCofAdj8x8
[0][
mode
] :Ö_Vid->
ARCofAdj4x4
[0][mode];

151 i‡(
mode
 =
IPCM
) ;

153 if–(
p_Vid
->
a˘ive_•s
->
chroma_f‹m©_idc
 =
YUV444
Ë&& (
p_I≈
->
£∑øã_cﬁour_∂™e_Êag
 != 0) )

155 if–
luma_å™sf‹m_size_8x8_Êag
 )

156 
luma_pos
 +5 * 
p_Vid
->
cﬁour_∂™e_id
;

158 
luma_pos
 +
p_Vid
->
cﬁour_∂™e_id
;

159 
cur_off£t_li°
 = 
off£tLi°
[
luma_pos
];

162 
j
=0; j < 
MB_BLOCK_SIZE
; j++)

164 
j_pos
 = ((
j
 & 
blk_mask
)<<
blk_shi·
);

165 
i
=0; i < 
MB_BLOCK_SIZE
; i++)

167 
ãmp
 = 
j_pos
 + (
i
 & 
blk_mask
);

168 
cur_off£t_li°
[
ãmp
] = (Ë
	`iClù3
(0, 
off£tR™ge
, cur_off£t_li°[ãmp] + (Ë
fAdju°
[
j
][
i
]);

172 if(
p_Vid
->
P444_joöed
)

174 **
fAdju°CbCr
;

175 
uv
;

177 
uv
 = 0; uv < 2; uv++)

179 
luma_pos
 = 
Ad≠tRndPos
[(
is_öãr
<<1Ë+ 
luma_å™sf‹m_size_8x8_Êag
][
p_Vid
->
ty≥
];

180 
fAdju°CbCr
 = 
luma_å™sf‹m_size_8x8_Êag
 ? 
p_Vid
->
ARCofAdj8x8
[
uv
 + 1][
mode
] :Ö_Vid->
ARCofAdj4x4
[uv + 1][mode];

181 if(
luma_å™sf‹m_size_8x8_Êag
 )

182 
luma_pos
 +5 * (
uv
+1);

184 
luma_pos
 +(
uv
+1);

185 
cur_off£t_li°
 = 
off£tLi°
[
luma_pos
];

186 
j
=0; j < 
MB_BLOCK_SIZE
; j++)

188 
j_pos
 = ((
j
 & 
blk_mask
)<<
blk_shi·
);

189 
i
=0; i < 
MB_BLOCK_SIZE
; i++)

191 
ãmp
 = 
j_pos
 + (
i
 & 
blk_mask
);

192 
cur_off£t_li°
[
ãmp
] = (Ë
	`iClù3
(0, 
off£tR™ge
, cur_off£t_li°[ãmp] + (Ë
fAdju°CbCr
[
j
][
i
]);

198 i‡((
p_I≈
->
Ad≠tRndChroma
Ë&& (
p_Vid
->
yuv_f‹m©
 =
YUV420
 ||Ö_Vid->yuv_f‹m© =
YUV422
 ))

200 
u_pos
 = 
Ad≠tRndCrPos
[
is_öãr
][
p_Vid
->
ty≥
];

201 
v_pos
 = 
u_pos
 + 1;

202 
k
, 
jpos
, 
uv
 = 1;

204 
k
 = 
u_pos
; k <
v_pos
; k++)

206 **
fAdju°Chroma
 = (
luma_å™sf‹m_size_8x8_Êag
 && 
mode
 =
P8x8
 )? 
p_Vid
->
ARCofAdj4x4
[
uv
][4] :Ö_Vid->ARCofAdj4x4[uv][mode];

207 
uv
++;

208 
cur_off£t_li°
 = 
p_Qu™t
->
Off£tLi°4x4
[
cur_qp
][
k
];

210 
j
 = 0; j < 
p_Vid
->
mb_¸_size_y
; j++)

212 
jpos
 = ((
j
 & 0x03)<<2);

213 
i
 = 0; i < 
p_Vid
->
mb_¸_size_x
; i++)

215 
ãmp
 = 
jpos
 + (
i
 & 0x03);

216 
cur_off£t_li°
[
ãmp
] = (Ë
	`iClù3
(0, 
off£tR™ge
, cur_off£t_li°[ãmp] + (Ë
fAdju°Chroma
[
j
][
i
]);

221 
	}
}

230 
	$ª£t_ad≠tive_roundög
(
VideoP¨amëîs
 *
p_Vid
)

232 
max∂™e
;

233 
max∂™e
 = (
p_Vid
->
yuv_f‹m©
 =
YUV400
)? 1 : 3;

234 
	`mem£t
(&
p_Vid
->
ARCofAdj4x4
[0][0][0][0], 0, 
max∂™e
 * 
MAXMODE
 * 
MB_PIXELS
 *  ());

235 i‡(
p_Vid
->
p_I≈
->
Tønsf‹m8x8Mode
)

237 
max∂™e
 = (
p_Vid
->
yuv_f‹m©
 =
YUV400
)? 1 : (p_Vid->
P444_joöed
 ? 3 : 1);

238 
	`mem£t
(&
p_Vid
->
ARCofAdj8x8
[0][0][0][0], 0, 
max∂™e
 * 
MAXMODE
 * 
MB_PIXELS
 *  ());

240 
	}
}

248 
	$ª£t_ad≠tive_roundög_dúe˘
(
VideoP¨amëîs
 *
p_Vid
)

250 
max∂™e
, 
∂
;

251 
max∂™e
 = (
p_Vid
->
yuv_f‹m©
 =
YUV400
)? 1 : 3;

252 
∂
 = 0;Ö»< 
max∂™e
;Öl++)

253 
	`mem£t
(&
p_Vid
->
ARCofAdj4x4
[
∂
][
DUMMY
][0][0], 0, 
MB_PIXELS
 *  ());

255 i‡(
p_Vid
->
p_I≈
->
Tønsf‹m8x8Mode
)

257 
max∂™e
 = (
p_Vid
->
yuv_f‹m©
 =
YUV400
)? 1 : (p_Vid->
P444_joöed
 ? 3 : 1);

258 
∂
 = 0;Ö»< 
max∂™e
;Öl++)

259 
	`mem£t
(&
p_Vid
->
ARCofAdj8x8
[
∂
][
DUMMY
][0][0], 0, 
MB_PIXELS
 *  ());

262 
	}
}

270 
	$upd©e_ad≠tive_roundög_8x8
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
RD_8x8DATA
* 
d©aTr
, **** 
ARCofAdj
)

272 
b8
, 
∂
, 
∂™e
, 
j0
, 
i0
, 
j
;

274 i‡(
p_I≈
->
Ad≠tiveRoundög
)

276 
∂™e
 = (
p_Vid
->
P444_joöed
) ? 3 : 1;

277 
∂
 = 0;Ö»< 
∂™e
;Öl++)

279 
b8
 = 0; b8 < 4; b8++)

281 
j0
 = 8*(
b8
 >> 1);

282 
i0
 = 8*(
b8
 & 0x01);

283 i‡(
d©aTr
->
∑π
[
b8
].
mode
 > 0)

285 
j
 = 
j0
; j < j0 + 
BLOCK_SIZE_8x8
; j++)

287 
	`mem˝y
(&
ARCofAdj
[
∂
][
P8x8
][
j
][
i0
], &ARCofAdj[∂][(Ë
d©aTr
->
∑π
[
b8
].
mode
][j][i0], 
BLOCK_SIZE_8x8
 * ());

293 
	}
}

	@lencod/src/q_matrix.c

12 
	~"globÆ.h
"

13 
	~"memÆloc.h
"

14 
	~"q_m©rix.h
"

16 *
GëC⁄figFûeC⁄ã¡
 (*
Fûíame
, 
îr‹_ty≥
);

18 
	#MAX_ITEMS_TO_PARSE
 1000

	)

20 c⁄° 
	gqu™t_c€f
[6][4][4] = {

29 c⁄° 
	gdequ™t_c€f
[6][4][4] = {

38 c⁄° 
	gqu™t_c€f8
[6][8][8] =

104 c⁄° 
	gdequ™t_c€f8
[6][8][8] =

169 
	gm©rix4x4_check
[6] = {0, 0, 0, 0, 0, 0};

170 
	gm©rix8x8_check
[6] = {0, 0, 0, 0, 0, 0};

172 c⁄° 
	gM©rixTy≥4x4
[6][20] =

182 c⁄° 
	gM©rixTy≥8x8
[6][20] =

193 c⁄° 
	gQu™t_öåa_deÁu…
[16] =

201 c⁄° 
	gQu™t_öãr_deÁu…
[16] =

209 c⁄° 
	gQu™t8_öåa_deÁu…
[64] =

221 c⁄° 
	gQu™t8_öãr_deÁu…
[64] =

247 
	$CheckP¨amëîName
 (*
s
, *
ty≥
)

249 
i
 = 0;

251 *
ty≥
 = 0;

252 (
M©rixTy≥4x4
[
i
] !
NULL
) && (i<6))

254 i‡(0==
	`°rcmp
 (
M©rixTy≥4x4
[
i
], 
s
))

255  
i
;

257 
i
++;

260 
i
 = 0;

261 *
ty≥
 = 1;

262 (
M©rixTy≥8x8
[
i
] !
NULL
) && (i<6))

264 i‡(0==
	`°rcmp
 (
M©rixTy≥8x8
[
i
], 
s
))

265  
i
;

267 
i
++;

271 
	}
}

285 
	$P¨£M©rix
 (
VideoP¨amëîs
 *
p_Vid
, *
buf
, 
bufsize
)

287 
SˇÀP¨amëîs
 *
p_QSˇÀ
 = 
p_Vid
->p_QScale;

288 *
ôems
[
MAX_ITEMS_TO_PARSE
] = {
NULL
};

289 
M≠Idx
;

290 
ôem
 = 0;

291 
InSåög
 = 0, 
InIãm
 = 0;

292 *
p
 = 
buf
;

293 *
bu„nd
 = &
buf
[
bufsize
];

294 
I¡C⁄ã¡
;

295 
i
, 
j
, 
ønge
, 
ty≥
, 
˙t
;

296 *
SˇlögLi°
;

298 
p
 < 
bu„nd
)

300 *
p
)

303 
p
++;

306 *
p
 = '\0';

307 *
p
 !'\n' &&Ö < 
bu„nd
)

308 
p
++;

309 
InSåög
 = 0;

310 
InIãm
 = 0;

313 
InIãm
 = 0;

314 
InSåög
 = 0;

315 *
p
++='\0';

319 i‡(
InSåög
)

320 
p
++;

323 *
p
++ = '\0';

324 
InIãm
 = 0;

329 *
p
++ = '\0';

330 i‡(!
InSåög
)

332 
ôems
[
ôem
++] = 
p
;

333 
InIãm
 = ~InItem;

336 
InIãm
 = 0;

337 
InSåög
 = ~InString;

341 
p
++;

342 
InIãm
 = 0;

346 i‡(!
InIãm
)

348 
ôems
[
ôem
++] = 
p
;

349 
InIãm
 = ~InItem;

351 
p
++;

355 
ôem
--;

357 
i
=0; i<
ôem
; i+=
˙t
)

359 
˙t
=0;

360 i‡(0 > (
M≠Idx
 = 
	`CheckP¨amëîName
 (
ôems
[
i
+
˙t
], &
ty≥
)))

362 
	`¢¥ötf
 (
îr‹ãxt
, 
ET_SIZE
, " P¨sögÉº‹ i¿qu™tiz©i⁄ m©rix c⁄fig fûe: P¨amëî Namê'%s'ÇŸÑecognized.", 
ôems
[
i
+
˙t
]);

363 
	`îr‹
 (
îr‹ãxt
, 300);

365 
˙t
++;

366 i‡(
	`°rcmp
 ("=", 
ôems
[
i
+
˙t
]))

368 
	`¢¥ötf
 (
îr‹ãxt
, 
ET_SIZE
, " ParsingÉrror in quantization matrix config file: '='ÉxpectedásÅhe secondÅoken inÉach item.");

369 
	`îr‹
 (
îr‹ãxt
, 300);

371 
˙t
++;

373 i‡(!
ty≥
)

375 
ønge
 = 16;

376 
SˇlögLi°
 = 
p_QSˇÀ
->
SˇlögLi°4x4öput
[
M≠Idx
];

377 
m©rix4x4_check
[
M≠Idx
] = 1;

381 
ønge
 = 64;

382 
SˇlögLi°
 = 
p_QSˇÀ
->
SˇlögLi°8x8öput
[
M≠Idx
];

383 
m©rix8x8_check
[
M≠Idx
] = 1;

386 
j
=0; j<
ønge
; j++)

388 i‡(1 !
	`ssˇnf
 (
ôems
[
i
+
˙t
+
j
], "%d", &
I¡C⁄ã¡
))

390 
	`¢¥ötf
 (
îr‹ãxt
, 
ET_SIZE
, " P¨sögÉº‹ i¿qu™tiz©i⁄ m©rix fûe: Ex≥˘edÇumîiˇ»vÆuêf‹ P¨amëî o‡%s, found '%s'.", 
ôems
[
i
], iãms[i+
˙t
+
j
]);

391 
	`îr‹
 (
îr‹ãxt
, 300);

394 
SˇlögLi°
[
j
] = ()
I¡C⁄ã¡
;

396 
˙t
+=
j
;

397 
	`¥ötf
 (".");

399 
	}
}

408 
	$P©chM©rix
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

410 
SˇÀP¨amëîs
 *
p_QSˇÀ
 = 
p_Vid
->p_QScale;

411 *
SˇlögLi°
;

412 
i
, 
˙t
, 
Áû
;

414 
i
=0; i<6; i++)

416 if(
p_I≈
->
SˇlögLi°Pª£¡Fœg
[
i
])

418 
SˇlögLi°
 = 
p_QSˇÀ
->
SˇlögLi°4x4öput
[
i
];

419 if(
m©rix4x4_check
[
i
])

421 
Áû
=0;

422 
˙t
=0; cnt<16; cnt++)

424 if(
SˇlögLi°
[
˙t
]<0 || ScalingList[cnt]>255)

426 
Áû
=1;

431 if(
Áû
)

433 
	`¥ötf
("\n%†vÆuêex˚edÑ™ge. (VÆuêmu° bê1Åÿ255)\n", 
M©rixTy≥4x4
[
i
]);

434 
	`¥ötf
("Setting default values forÅhis matrix.");

435 if(
i
>2)

436 
	`mem˝y
(
SˇlögLi°
, 
Qu™t_öãr_deÁu…
, ()*16);

438 
	`mem˝y
(
SˇlögLi°
, 
Qu™t_öåa_deÁu…
, ()*16);

443 
	`¥ötf
("\n%†m©rix deföôi⁄ÇŸ found. Sëtög deÁu… vÆues.", 
M©rixTy≥4x4
[
i
]);

444 if(
i
>2)

445 
	`mem˝y
(
SˇlögLi°
, 
Qu™t_öãr_deÁu…
, ()*16);

447 
	`mem˝y
(
SˇlögLi°
, 
Qu™t_öåa_deÁu…
, ()*16);

451 if(
p_I≈
->
SˇlögLi°Pª£¡Fœg
[
i
+6])

453 
SˇlögLi°
 = 
p_QSˇÀ
->
SˇlögLi°8x8öput
[
i
];

454 if(
m©rix8x8_check
[
i
])

456 
Áû
=0;

457 
˙t
=0; cnt<64; cnt++)

459 if(
SˇlögLi°
[
˙t
]<0 || ScalingList[cnt]>255)

461 
Áû
=1;

466 if(
Áû
)

468 
	`¥ötf
("\n%†vÆuêex˚edÑ™ge. (VÆuêmu° bê1Åÿ255)\n", 
M©rixTy≥8x8
[
i
]);

469 
	`¥ötf
("Setting default values forÅhis matrix.");

470 if(
i
==1 || i==3 || i==5)

471 
	`mem˝y
(
SˇlögLi°
, 
Qu™t8_öãr_deÁu…
, ()*64);

473 
	`mem˝y
(
SˇlögLi°
, 
Qu™t8_öåa_deÁu…
, ()*64);

478 
	`¥ötf
("\n%†m©rix deföôi⁄ÇŸ found. Sëtög deÁu… vÆues.", 
M©rixTy≥8x8
[
i
]);

479 if(
i
==1 || i==3 || i==5)

480 
	`mem˝y
(
SˇlögLi°
, 
Qu™t8_öãr_deÁu…
, ()*64);

482 
	`mem˝y
(
SˇlögLi°
, 
Qu™t8_öåa_deÁu…
, ()*64);

486 
	}
}

494 
	$Æloˇã_QM©rix
 (
Qu™tP¨amëîs
 *
p_Qu™t
, 
I≈utP¨amëîs
 *
p_I≈
)

496 
max_bôdïth
 = 
	`imax
(
p_I≈
->
ouçut
.
bô_dïth
[0],Ö_Inp->output.bit_depth[1]);

497 
max_qp
 = (3 + 6*(
max_bôdïth
));

499 
bôdïth_qp_sˇÀ
 = 6*(
p_I≈
->
ouçut
.
bô_dïth
[0] - 8);

500 
i
;

502 
	`gë_mem5Dqu™t
(&
p_Qu™t
->
q_∑øms_4x4
, 3, 2, 
max_qp
 + 1, 4, 4);

503 
	`gë_mem5Dqu™t
(&
p_Qu™t
->
q_∑øms_8x8
, 3, 2, 
max_qp
 + 1, 8, 8);

505 i‡((
p_Qu™t
->
qp_≥r_m©rix
 = (*)
	`mÆloc
((
MAX_QP
 + 1 + 
bôdïth_qp_sˇÀ
)*())Ë=
NULL
)

506 
	`no_mem_exô
("allocate_QMatrix:Ö_Quant->qp_per_matrix");

507 i‡((
p_Qu™t
->
qp_ªm_m©rix
 = (*)
	`mÆloc
((
MAX_QP
 + 1 + 
bôdïth_qp_sˇÀ
)*())Ë=
NULL
)

508 
	`no_mem_exô
("allocate_QMatrix:Ö_Quant->qp_per_matrix");

510 
i
 = 0; i < 
MAX_QP
 + 
bôdïth_qp_sˇÀ
 + 1; i++)

512 
p_Qu™t
->
qp_≥r_m©rix
[
i
] = i / 6;

513 
p_Qu™t
->
qp_ªm_m©rix
[
i
] = i % 6;

515 
	}
}

523 
	$‰ì_QM©rix
 (
Qu™tP¨amëîs
 *
p_Qu™t
)

525 
	`‰ì_mem5Dqu™t
(
p_Qu™t
->
q_∑øms_4x4
);

526 
	`‰ì_mem5Dqu™t
(
p_Qu™t
->
q_∑øms_8x8
);

528 
	`‰ì
(
p_Qu™t
->
qp_ªm_m©rix
);

529 
	`‰ì
(
p_Qu™t
->
qp_≥r_m©rix
);

530 
	}
}

539 
	$öô_qm©rix
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

541 
Qu™tP¨amëîs
 *
p_Qu™t
 = 
p_Vid
->p_Quant;

542 
SˇÀP¨amëîs
 *
p_QSˇÀ
 = 
p_Vid
->p_QScale;

543 *
c⁄ã¡
;

545 
	`Æloˇã_QM©rix
 (
p_Qu™t
, 
p_I≈
);

547 if(
p_I≈
->
SˇlögM©rixPª£¡Fœg
)

549 
	`¥ötf
 ("P¨sög QM©rix fûê%†", 
p_I≈
->
Qm©rixFûe
);

550 
c⁄ã¡
 = 
	`GëC⁄figFûeC⁄ã¡
(
p_I≈
->
Qm©rixFûe
, 0);

551 if(
c⁄ã¡
!='\0')

552 
	`P¨£M©rix
(
p_Vid
, 
c⁄ã¡
, (Ë
	`°æí
 (content));

554 
	`¥ötf
("\nEº‹: %s\nPro˚edög wôh deÁu… vÆue†f‹áŒ m©ri˚s.", 
îr‹ãxt
);

556 
	`P©chM©rix
(
p_Vid
, 
p_I≈
);

557 
	`¥ötf
("\n");

559 
	`mem£t
(
p_QSˇÀ
->
U£DeÁu…SˇlögM©rix4x4Fœg
, 0, 6 * ());

560 
	`mem£t
(
p_QSˇÀ
->
U£DeÁu…SˇlögM©rix8x8Fœg
, 0, 6 * ());

562 
	`‰ì
(
c⁄ã¡
);

564 
	}
}

566 
£t_deÁu…_qu™t4x4
(
LevñQu™tP¨ams
 **
q_∑øms_4x4
, c⁄° (*
qu™t
)[4], c⁄° (*
dequ™t
)[4])

568 
	gi
, 
	gj
;

569 
	gj
=0; j<4; j++)

571 
	gi
=0; i<4; i++)

573 
	gq_∑øms_4x4
[
j
][
i
].
	gSˇÀComp
 = 
qu™t
[j][i];

574 
	gq_∑øms_4x4
[
j
][
i
].
	gInvSˇÀComp
 = 
dequ™t
[j][i]<<4;

591 
	$CÆcuœãQu™t4x4P¨am
(
VideoP¨amëîs
 *
p_Vid
)

593 
Qu™tP¨amëîs
 *
p_Qu™t
 = 
p_Vid
->p_Quant;

594 
SˇÀP¨amëîs
 *
p_QSˇÀ
 = 
p_Vid
->p_QScale;

596 
pic_∑ømëî_£t_rb•_t
 *
a˘ive_µs
 = 
p_Vid
->active_pps;

597 
£q_∑ømëî_£t_rb•_t
 *
a˘ive_•s
 = 
p_Vid
->active_sps;

599 
i
, 
j
, 
k
, 
ãmp
;

600 
k_mod
;

601 
¥e£¡
[6];

602 
no_q_m©rix
=
FALSE
;

604 
max_bôdïth
 = 
	`imax
(
p_Vid
->
bôdïth_luma
,Ö_Vid->
bôdïth_chroma
);

605 
max_qp
 = (3 + 6*(
max_bôdïth
));

608 if(!
a˘ive_•s
->
£q_sˇlög_m©rix_¥e£¡_Êag
 && !
a˘ive_µs
->
pic_sˇlög_m©rix_¥e£¡_Êag
)

609 
no_q_m©rix
=
TRUE
;

612 
	`mem£t
(
¥e£¡
, 0, 6 * ());

614 if(
a˘ive_•s
->
£q_sˇlög_m©rix_¥e£¡_Êag
)

615 
i
=0; i<6; i++)

616 
¥e£¡
[
i
] = 
a˘ive_•s
->
£q_sˇlög_li°_¥e£¡_Êag
[i];

618 if(
a˘ive_µs
->
pic_sˇlög_m©rix_¥e£¡_Êag
)

619 
i
=0; i<6; i++)

621 if((
i
==0) || (i==3))

622 
¥e£¡
[
i
] |
a˘ive_µs
->
pic_sˇlög_li°_¥e£¡_Êag
[i];

624 
¥e£¡
[
i
] = 
a˘ive_µs
->
pic_sˇlög_li°_¥e£¡_Êag
[i];

628 if(
no_q_m©rix
==
TRUE
)

630 
k_mod
=0; k_mod<
max_qp
; k_mod++)

632 
k
 = 
k_mod
 % 6;

633 
	`£t_deÁu…_qu™t4x4
(
p_Qu™t
->
q_∑øms_4x4
[0][0][
k_mod
], 
qu™t_c€f
[
k
], 
dequ™t_c€f
[k]);

634 
	`£t_deÁu…_qu™t4x4
(
p_Qu™t
->
q_∑øms_4x4
[0][1][
k_mod
], 
qu™t_c€f
[
k
], 
dequ™t_c€f
[k]);

635 
	`£t_deÁu…_qu™t4x4
(
p_Qu™t
->
q_∑øms_4x4
[1][0][
k_mod
], 
qu™t_c€f
[
k
], 
dequ™t_c€f
[k]);

636 
	`£t_deÁu…_qu™t4x4
(
p_Qu™t
->
q_∑øms_4x4
[1][1][
k_mod
], 
qu™t_c€f
[
k
], 
dequ™t_c€f
[k]);

637 
	`£t_deÁu…_qu™t4x4
(
p_Qu™t
->
q_∑øms_4x4
[2][0][
k_mod
], 
qu™t_c€f
[
k
], 
dequ™t_c€f
[k]);

638 
	`£t_deÁu…_qu™t4x4
(
p_Qu™t
->
q_∑øms_4x4
[2][1][
k_mod
], 
qu™t_c€f
[
k
], 
dequ™t_c€f
[k]);

643 
k_mod
=0; k_mod<
max_qp
; k_mod++)

645 
k
 = 
k_mod
 % 6;

646 
j
=0; j<4; j++)

648 
i
=0; i<4; i++)

650 
ãmp
 = (
j
<<2)+
i
;

651 if((!
¥e£¡
[0]Ë|| 
p_QSˇÀ
->
U£DeÁu…SˇlögM©rix4x4Fœg
[0])

653 
p_Qu™t
->
q_∑øms_4x4
[0][1][
k_mod
][
j
][
i
].
SˇÀComp
 = (
qu™t_c€f
[
k
][j][i]<<4)/
Qu™t_öåa_deÁu…
[
ãmp
];

654 
p_Qu™t
->
q_∑øms_4x4
[0][1][
k_mod
][
j
][
i
].
InvSˇÀComp
 = 
dequ™t_c€f
[
k
][j][i]*
Qu™t_öåa_deÁu…
[
ãmp
];

658 
p_Qu™t
->
q_∑øms_4x4
[0][1][
k_mod
][
j
][
i
].
SˇÀComp
 = (
qu™t_c€f
[
k
][j][i]<<4)/
p_QSˇÀ
->
SˇlögLi°4x4
[0][
ãmp
];

659 
p_Qu™t
->
q_∑øms_4x4
[0][1][
k_mod
][
j
][
i
].
InvSˇÀComp
 = 
dequ™t_c€f
[
k
][j][i]*
p_QSˇÀ
->
SˇlögLi°4x4
[0][
ãmp
];

662 if(!
¥e£¡
[1])

664 
p_Qu™t
->
q_∑øms_4x4
[1][1][
k_mod
][
j
][
i
].
SˇÀComp
 =Ö_Quant->q_params_4x4[0][1][k_mod][j][i].ScaleComp;

665 
p_Qu™t
->
q_∑øms_4x4
[1][1][
k_mod
][
j
][
i
].
InvSˇÀComp
 =Ö_Quant->q_params_4x4[0][1][k_mod][j][i].InvScaleComp;

669 
p_Qu™t
->
q_∑øms_4x4
[1][1][
k_mod
][
j
][
i
].
SˇÀComp
 = (
qu™t_c€f
[
k
][j][i]<<4)/(
p_QSˇÀ
->
U£DeÁu…SˇlögM©rix4x4Fœg
[1] ? 
Qu™t_öåa_deÁu…
[
ãmp
]:p_QSˇÀ->
SˇlögLi°4x4
[1][temp]);

670 
p_Qu™t
->
q_∑øms_4x4
[1][1][
k_mod
][
j
][
i
].
InvSˇÀComp
 = 
dequ™t_c€f
[
k
][j][i]*(
p_QSˇÀ
->
U£DeÁu…SˇlögM©rix4x4Fœg
[1] ? 
Qu™t_öåa_deÁu…
[
ãmp
]:p_QSˇÀ->
SˇlögLi°4x4
[1][temp]);

673 if(!
¥e£¡
[2])

675 
p_Qu™t
->
q_∑øms_4x4
[2][1][
k_mod
][
j
][
i
].
SˇÀComp
 =Ö_Quant->q_params_4x4[1][1][k_mod][j][i].ScaleComp;

676 
p_Qu™t
->
q_∑øms_4x4
[2][1][
k_mod
][
j
][
i
].
InvSˇÀComp
 =Ö_Quant->q_params_4x4[1][1][k_mod][j][i].InvScaleComp;

680 
p_Qu™t
->
q_∑øms_4x4
[2][1][
k_mod
][
j
][
i
].
SˇÀComp
 = (
qu™t_c€f
[
k
][j][i]<<4)/(
p_QSˇÀ
->
U£DeÁu…SˇlögM©rix4x4Fœg
[2] ? 
Qu™t_öåa_deÁu…
[
ãmp
]:p_QSˇÀ->
SˇlögLi°4x4
[2][temp]);

681 
p_Qu™t
->
q_∑øms_4x4
[2][1][
k_mod
][
j
][
i
].
InvSˇÀComp
 = 
dequ™t_c€f
[
k
][j][i]*(
p_QSˇÀ
->
U£DeÁu…SˇlögM©rix4x4Fœg
[2] ? 
Qu™t_öåa_deÁu…
[
ãmp
]:p_QSˇÀ->
SˇlögLi°4x4
[2][temp]);

684 if((!
¥e£¡
[3]Ë|| 
p_QSˇÀ
->
U£DeÁu…SˇlögM©rix4x4Fœg
[3])

686 
p_Qu™t
->
q_∑øms_4x4
[0][0][
k_mod
][
j
][
i
].
SˇÀComp
 = (
qu™t_c€f
[
k
][j][i]<<4)/
Qu™t_öãr_deÁu…
[
ãmp
];

687 
p_Qu™t
->
q_∑øms_4x4
[0][0][
k_mod
][
j
][
i
].
InvSˇÀComp
 = 
dequ™t_c€f
[
k
][j][i]*
Qu™t_öãr_deÁu…
[
ãmp
];

691 
p_Qu™t
->
q_∑øms_4x4
[0][0][
k_mod
][
j
][
i
].
SˇÀComp
 = (
qu™t_c€f
[
k
][j][i]<<4)/
p_QSˇÀ
->
SˇlögLi°4x4
[3][
ãmp
];

692 
p_Qu™t
->
q_∑øms_4x4
[0][0][
k_mod
][
j
][
i
].
InvSˇÀComp
 = 
dequ™t_c€f
[
k
][j][i]*
p_QSˇÀ
->
SˇlögLi°4x4
[3][
ãmp
];

695 if(!
¥e£¡
[4])

697 
p_Qu™t
->
q_∑øms_4x4
[1][0][
k_mod
][
j
][
i
].
SˇÀComp
 =Ö_Quant->q_params_4x4[0][0][k_mod][j][i].ScaleComp;

698 
p_Qu™t
->
q_∑øms_4x4
[1][0][
k_mod
][
j
][
i
].
InvSˇÀComp
 =Ö_Quant->q_params_4x4[0][0][k_mod][j][i].InvScaleComp;

702 
p_Qu™t
->
q_∑øms_4x4
[1][0][
k_mod
][
j
][
i
].
SˇÀComp
 = (
qu™t_c€f
[
k
][j][i]<<4)/(
p_QSˇÀ
->
U£DeÁu…SˇlögM©rix4x4Fœg
[4] ? 
Qu™t_öãr_deÁu…
[
ãmp
]:p_QSˇÀ->
SˇlögLi°4x4
[4][temp]);

703 
p_Qu™t
->
q_∑øms_4x4
[1][0][
k_mod
][
j
][
i
].
InvSˇÀComp
 = 
dequ™t_c€f
[
k
][j][i]*(
p_QSˇÀ
->
U£DeÁu…SˇlögM©rix4x4Fœg
[4] ? 
Qu™t_öãr_deÁu…
[
ãmp
]:p_QSˇÀ->
SˇlögLi°4x4
[4][temp]);

706 if(!
¥e£¡
[5])

708 
p_Qu™t
->
q_∑øms_4x4
[2][0][
k_mod
][
j
][
i
].
SˇÀComp
 =Ö_Quant->q_params_4x4[1][0][k_mod][j][i].ScaleComp;

709 
p_Qu™t
->
q_∑øms_4x4
[2][0][
k_mod
][
j
][
i
].
InvSˇÀComp
 =Ö_Quant->q_params_4x4[1][0][k_mod][j][i].InvScaleComp;

713 
p_Qu™t
->
q_∑øms_4x4
[2][0][
k_mod
][
j
][
i
].
SˇÀComp
 = (
qu™t_c€f
[
k
][j][i]<<4)/(
p_QSˇÀ
->
U£DeÁu…SˇlögM©rix4x4Fœg
[5] ? 
Qu™t_öãr_deÁu…
[
ãmp
]:p_QSˇÀ->
SˇlögLi°4x4
[5][temp]);

714 
p_Qu™t
->
q_∑øms_4x4
[2][0][
k_mod
][
j
][
i
].
InvSˇÀComp
 = 
dequ™t_c€f
[
k
][j][i]*(
p_QSˇÀ
->
U£DeÁu…SˇlögM©rix4x4Fœg
[5] ? 
Qu™t_öãr_deÁu…
[
ãmp
]:p_QSˇÀ->
SˇlögLi°4x4
[5][temp]);

720 
	}
}

729 
	$CÆcuœãQu™t8x8P¨am
(
VideoP¨amëîs
 *
p_Vid
)

731 
Qu™tP¨amëîs
 *
p_Qu™t
 = 
p_Vid
->p_Quant;

732 
SˇÀP¨amëîs
 *
p_QSˇÀ
 = 
p_Vid
->p_QScale;

734 
pic_∑ømëî_£t_rb•_t
 *
a˘ive_µs
 = 
p_Vid
->active_pps;

735 
£q_∑ømëî_£t_rb•_t
 *
a˘ive_•s
 = 
p_Vid
->active_sps;

737 
i
, 
j
, 
k
, 
ãmp
;

738 
k_mod
;

739 
n_SˇlögLi°8x8
;

740 
¥e£¡
[6];

741 
no_q_m©rix
=
FALSE
;

742 
max_bôdïth
 = 
	`imax
(
p_Vid
->
bôdïth_luma
,Ö_Vid->
bôdïth_chroma
);

743 
max_qp
 = (3 + 6*(
max_bôdïth
));

747 
n_SˇlögLi°8x8
 = ( 
a˘ive_•s
->
chroma_f‹m©_idc
 != 3 ) ? 2 : 6;

749 if(!
a˘ive_•s
->
£q_sˇlög_m©rix_¥e£¡_Êag
 && !
a˘ive_µs
->
pic_sˇlög_m©rix_¥e£¡_Êag
)

750 
no_q_m©rix
=
TRUE
;

753 
	`mem£t
(
¥e£¡
, 0, ()*
n_SˇlögLi°8x8
);

755 if(
a˘ive_•s
->
£q_sˇlög_m©rix_¥e£¡_Êag
)

757 
i
=0; i<
n_SˇlögLi°8x8
; i++)

758 
¥e£¡
[
i
] = 
a˘ive_•s
->
£q_sˇlög_li°_¥e£¡_Êag
[i+6];

761 if(
a˘ive_µs
->
pic_sˇlög_m©rix_¥e£¡_Êag
)

763 
i
=0; i<
n_SˇlögLi°8x8
; i++)

765 if–
i
==0 || i==1 )

766 
¥e£¡
[
i
] |
a˘ive_µs
->
pic_sˇlög_li°_¥e£¡_Êag
[i+6];

768 
¥e£¡
[
i
] = 
a˘ive_µs
->
pic_sˇlög_li°_¥e£¡_Êag
[i+6];

773 if(
no_q_m©rix
==
TRUE
)

775 
k
 = 0; k < 
max_qp
; k++)

777 
k_mod
 = 
k
 %6;

778 
j
=0; j<8; j++)

780 
i
=0; i<8; i++)

783 
p_Qu™t
->
q_∑øms_8x8
[0][1][
k
][
j
][
i
].
SˇÀComp
 = 
qu™t_c€f8
[
k_mod
][j][i];

784 
p_Qu™t
->
q_∑øms_8x8
[0][1][
k
][
j
][
i
].
InvSˇÀComp
 = 
dequ™t_c€f8
[
k_mod
][j][i]<<4;

787 
p_Qu™t
->
q_∑øms_8x8
[0][0][
k
][
j
][
i
].
SˇÀComp
 = 
qu™t_c€f8
[
k_mod
][j][i];

788 
p_Qu™t
->
q_∑øms_8x8
[0][0][
k
][
j
][
i
].
InvSˇÀComp
 = 
dequ™t_c€f8
[
k_mod
][j][i]<<4;

790 if–
n_SˇlögLi°8x8
 > 2 )

793 
p_Qu™t
->
q_∑øms_8x8
[1][1][
k
][
j
][
i
].
SˇÀComp
 = 
qu™t_c€f8
[
k_mod
][j][i];

794 
p_Qu™t
->
q_∑øms_8x8
[1][1][
k
][
j
][
i
].
InvSˇÀComp
 = 
dequ™t_c€f8
[
k_mod
][j][i]<<4;

797 
p_Qu™t
->
q_∑øms_8x8
[2][1][
k
][
j
][
i
].
SˇÀComp
 = 
qu™t_c€f8
[
k_mod
][j][i];

798 
p_Qu™t
->
q_∑øms_8x8
[2][1][
k
][
j
][
i
].
InvSˇÀComp
 = 
dequ™t_c€f8
[
k_mod
][j][i]<<4;

801 
p_Qu™t
->
q_∑øms_8x8
[1][0][
k
][
j
][
i
].
SˇÀComp
 = 
qu™t_c€f8
[
k_mod
][j][i];

802 
p_Qu™t
->
q_∑øms_8x8
[1][0][
k
][
j
][
i
].
InvSˇÀComp
 = 
dequ™t_c€f8
[
k_mod
][j][i]<<4;

805 
p_Qu™t
->
q_∑øms_8x8
[2][0][
k
][
j
][
i
].
SˇÀComp
 = 
qu™t_c€f8
[
k_mod
][j][i];

806 
p_Qu™t
->
q_∑øms_8x8
[2][0][
k
][
j
][
i
].
InvSˇÀComp
 = 
dequ™t_c€f8
[
k_mod
][j][i]<<4;

815 
k
 = 0; k < 
max_qp
; k++)

817 
k_mod
 = 
k
 %6;

818 
j
=0; j<8; j++)

820 
i
=0; i<8; i++)

822 
ãmp
 = (
j
<<3)+
i
;

823 if((!
¥e£¡
[0]Ë|| 
p_QSˇÀ
->
U£DeÁu…SˇlögM©rix8x8Fœg
[0])

825 
p_Qu™t
->
q_∑øms_8x8
[0][1][
k
][
j
][
i
].
SˇÀComp
 = (
qu™t_c€f8
[
k_mod
][j][i]<<4)/
Qu™t8_öåa_deÁu…
[
ãmp
];

826 
p_Qu™t
->
q_∑øms_8x8
[0][1][
k
][
j
][
i
].
InvSˇÀComp
 = 
dequ™t_c€f8
[
k_mod
][j][i]*
Qu™t8_öåa_deÁu…
[
ãmp
];

830 
p_Qu™t
->
q_∑øms_8x8
[0][1][
k
][
j
][
i
].
SˇÀComp
 = (
qu™t_c€f8
[
k_mod
][j][i]<<4)/
p_QSˇÀ
->
SˇlögLi°8x8
[0][
ãmp
];

831 
p_Qu™t
->
q_∑øms_8x8
[0][1][
k
][
j
][
i
].
InvSˇÀComp
 = 
dequ™t_c€f8
[
k_mod
][j][i]*
p_QSˇÀ
->
SˇlögLi°8x8
[0][
ãmp
];

834 if((!
¥e£¡
[1]Ë|| 
p_QSˇÀ
->
U£DeÁu…SˇlögM©rix8x8Fœg
[1])

836 
p_Qu™t
->
q_∑øms_8x8
[0][0][
k
][
j
][
i
].
SˇÀComp
 = (
qu™t_c€f8
[
k_mod
][j][i]<<4)/
Qu™t8_öãr_deÁu…
[
ãmp
];

837 
p_Qu™t
->
q_∑øms_8x8
[0][0][
k
][
j
][
i
].
InvSˇÀComp
 = 
dequ™t_c€f8
[
k_mod
][j][i]*
Qu™t8_öãr_deÁu…
[
ãmp
];

841 
p_Qu™t
->
q_∑øms_8x8
[0][0][
k
][
j
][
i
].
SˇÀComp
 = (
qu™t_c€f8
[
k_mod
][j][i]<<4)/
p_QSˇÀ
->
SˇlögLi°8x8
[1][
ãmp
];

842 
p_Qu™t
->
q_∑øms_8x8
[0][0][
k
][
j
][
i
].
InvSˇÀComp
 = 
dequ™t_c€f8
[
k_mod
][j][i]*
p_QSˇÀ
->
SˇlögLi°8x8
[1][
ãmp
];

845 if–
n_SˇlögLi°8x8
 > 2 )

849 if(!
¥e£¡
[2])

851 
p_Qu™t
->
q_∑øms_8x8
[1][1][
k
][
j
][
i
].
SˇÀComp
 =Ö_Quant->q_params_8x8[0][1][k][j][i].ScaleComp;

852 
p_Qu™t
->
q_∑øms_8x8
[1][1][
k
][
j
][
i
].
InvSˇÀComp
 =Ö_Quant->q_params_8x8[0][1][k][j][i].InvScaleComp;

856 
p_Qu™t
->
q_∑øms_8x8
[1][1][
k
][
j
][
i
].
SˇÀComp
 = (
qu™t_c€f8
[
k_mod
][j][i]<<4)/(
p_QSˇÀ
->
U£DeÁu…SˇlögM©rix8x8Fœg
[2] ? 
Qu™t8_öåa_deÁu…
[
ãmp
]:p_QSˇÀ->
SˇlögLi°8x8
[2][temp]);

857 
p_Qu™t
->
q_∑øms_8x8
[1][1][
k
][
j
][
i
].
InvSˇÀComp
 = 
dequ™t_c€f8
[
k_mod
][j][i]*(
p_QSˇÀ
->
U£DeÁu…SˇlögM©rix8x8Fœg
[2] ? 
Qu™t8_öåa_deÁu…
[
ãmp
]:p_QSˇÀ->
SˇlögLi°8x8
[2][temp]);

861 if(!
¥e£¡
[3])

863 
p_Qu™t
->
q_∑øms_8x8
[1][0][
k
][
j
][
i
].
SˇÀComp
 =Ö_Quant->q_params_8x8[0][0][k][j][i].ScaleComp;

864 
p_Qu™t
->
q_∑øms_8x8
[1][0][
k
][
j
][
i
].
InvSˇÀComp
 =Ö_Quant->q_params_8x8[0][0][k][j][i].InvScaleComp;

868 
p_Qu™t
->
q_∑øms_8x8
[1][0][
k
][
j
][
i
].
SˇÀComp
 = (
qu™t_c€f8
[
k_mod
][j][i]<<4)/(
p_QSˇÀ
->
U£DeÁu…SˇlögM©rix8x8Fœg
[3] ? 
Qu™t8_öãr_deÁu…
[
ãmp
]:p_QSˇÀ->
SˇlögLi°8x8
[3][temp]);

869 
p_Qu™t
->
q_∑øms_8x8
[1][0][
k
][
j
][
i
].
InvSˇÀComp
 = 
dequ™t_c€f8
[
k_mod
][j][i]*(
p_QSˇÀ
->
U£DeÁu…SˇlögM©rix8x8Fœg
[3] ? 
Qu™t8_öãr_deÁu…
[
ãmp
]:p_QSˇÀ->
SˇlögLi°8x8
[3][temp]);

873 if(!
¥e£¡
[4])

875 
p_Qu™t
->
q_∑øms_8x8
[2][1][
k
][
j
][
i
].
SˇÀComp
 =Ö_Quant->q_params_8x8[1][1][k][j][i].ScaleComp;

876 
p_Qu™t
->
q_∑øms_8x8
[2][1][
k
][
j
][
i
].
InvSˇÀComp
 =Ö_Quant->q_params_8x8[1][1][k][j][i].InvScaleComp;

880 
p_Qu™t
->
q_∑øms_8x8
[2][1][
k
][
j
][
i
].
SˇÀComp
 = (
qu™t_c€f8
[
k_mod
][j][i]<<4)/(
p_QSˇÀ
->
U£DeÁu…SˇlögM©rix8x8Fœg
[4] ? 
Qu™t8_öåa_deÁu…
[
ãmp
]:p_QSˇÀ->
SˇlögLi°8x8
[4][temp]);

881 
p_Qu™t
->
q_∑øms_8x8
[2][1][
k
][
j
][
i
].
InvSˇÀComp
 = 
dequ™t_c€f8
[
k_mod
][j][i]*(
p_QSˇÀ
->
U£DeÁu…SˇlögM©rix8x8Fœg
[4] ? 
Qu™t8_öåa_deÁu…
[
ãmp
]:p_QSˇÀ->
SˇlögLi°8x8
[4][temp]);

885 if(!
¥e£¡
[5])

887 
p_Qu™t
->
q_∑øms_8x8
[2][0][
k
][
j
][
i
].
SˇÀComp
 =Ö_Quant->q_params_8x8[1][0][k][j][i].ScaleComp;

888 
p_Qu™t
->
q_∑øms_8x8
[2][0][
k
][
j
][
i
].
InvSˇÀComp
 =Ö_Quant->q_params_8x8[1][0][k][j][i].InvScaleComp;

892 
p_Qu™t
->
q_∑øms_8x8
[2][0][
k
][
j
][
i
].
SˇÀComp
 = (
qu™t_c€f8
[
k_mod
][j][i]<<4)/(
p_QSˇÀ
->
U£DeÁu…SˇlögM©rix8x8Fœg
[5] ? 
Qu™t8_öãr_deÁu…
[
ãmp
]:p_QSˇÀ->
SˇlögLi°8x8
[5][temp]);

893 
p_Qu™t
->
q_∑øms_8x8
[2][0][
k
][
j
][
i
].
InvSˇÀComp
 = 
dequ™t_c€f8
[
k_mod
][j][i] * (
p_QSˇÀ
->
U£DeÁu…SˇlögM©rix8x8Fœg
[5] ? 
Qu™t8_öãr_deÁu…
[
ãmp
]:p_QSˇÀ->
SˇlögLi°8x8
[5][temp]);

900 
	}
}

	@lencod/src/q_offsets.c

12 
	~"globÆ.h
"

13 
	~"memÆloc.h
"

14 
	~"q_m©rix.h
"

15 
	~"q_off£ts.h
"

17 *
GëC⁄figFûeC⁄ã¡
 (*
Fûíame
, 
îr‹_ty≥
);

19 
	#MAX_ITEMS_TO_PARSE
 2000

	)

21 
	goff£t4x4_check
[15] = { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 };

22 
	goff£t8x8_check
[15] = { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 };

24 c⁄° 
	gOff£tTy≥4x4
[15][24] = {

42 c⁄° 
	gOff£tTy≥8x8
[15][24] = {

60 c⁄° 
	gOff£t_öåa_deÁu…_öåa
[16] = {

67 c⁄° 
	gOff£t_öåa_deÁu…_chroma
[16] = {

75 c⁄° 
	gOff£t_öåa_deÁu…_öãr
[16] = {

82 c⁄° 
	gOff£t_öãr_deÁu…
[16] = {

89 c⁄° 
	gOff£t8_öåa_deÁu…_öåa
[64] = {

100 c⁄° 
	gOff£t8_öåa_deÁu…_chroma
[64] = {

111 c⁄° 
	gOff£t8_öåa_deÁu…_öãr
[64] = {

122 c⁄° 
	gOff£t8_öãr_deÁu…
[64] = {

135 
InôOff£tP¨am
 (
Qu™tP¨amëîs
 *
p_Qu™t
, 
I≈utP¨amëîs
 *
p_I≈
);

142 
	$Æloˇã_QOff£ts
 (
Qu™tP¨amëîs
 *
p_Qu™t
, 
I≈utP¨amëîs
 *
p_I≈
)

144 
max_bôdïth
 = 
	`imax
(
p_I≈
->
ouçut
.
bô_dïth
[0],Ö_Inp->output.bit_depth[1]);

145 
max_qp
 = (3 + 6*(
max_bôdïth
));

148 i‡(
p_I≈
->
Ad≠tRoundögFixed
)

150 
	`gë_mem3Dsh‹t
(&
p_Qu™t
->
Off£tLi°4x4
, 1, 25, 16);

151 
	`gë_mem3Dsh‹t
(&
p_Qu™t
->
Off£tLi°8x8
, 1, 15, 64);

155 
	`gë_mem3Dsh‹t
(&
p_Qu™t
->
Off£tLi°4x4
, 
max_qp
 + 1, 25, 16);

156 
	`gë_mem3Dsh‹t
(&
p_Qu™t
->
Off£tLi°8x8
, 
max_qp
 + 1, 15, 64);

159 
	`gë_mem2Dsh‹t
(&
p_Qu™t
->
Off£tLi°4x4öput
, 25, 16);

160 
	`gë_mem2Dsh‹t
(&
p_Qu™t
->
Off£tLi°8x8öput
, 15, 64);

161 
	}
}

163 
ölöe
 
	$upd©e_q_off£t4x4
(
LevñQu™tP¨ams
 **
q_∑øms
, *
off£tLi°
, 
q_bôs
)

165 
i
, 
j
;

166 *
p_li°
 = &
off£tLi°
[0];

167 
j
 = 0; j < 4; j++)

169 
i
 = 0; i < 4; i++)

171 
q_∑øms
[
j
][
i
].
Off£tComp
 = (Ë*
p_li°
++ << 
q_bôs
;

174 
	}
}

176 
ölöe
 
	$upd©e_q_off£t8x8
(
LevñQu™tP¨ams
 **
q_∑øms
, *
off£tLi°
, 
q_bôs
)

178 
i
, 
j
;

179 *
p_li°
;

180 
j
 = 0; j < 8; j++)

182 
p_li°
 = &
off£tLi°
[
j
 << 3];

183 
i
 = 0; i < 8; i++)

185 
q_∑øms
[
j
][
i
].
Off£tComp
 = (Ë*
p_li°
++ << 
q_bôs
;

188 
	}
}

196 
	$‰ì_QOff£ts
 (
Qu™tP¨amëîs
 *
p_Qu™t
, 
I≈utP¨amëîs
 *
p_I≈
)

198 
	`‰ì_mem3Dsh‹t
(
p_Qu™t
->
Off£tLi°8x8
);

199 
	`‰ì_mem3Dsh‹t
(
p_Qu™t
->
Off£tLi°4x4
);

200 
	`‰ì_mem2Dsh‹t
(
p_Qu™t
->
Off£tLi°8x8öput
);

201 
	`‰ì_mem2Dsh‹t
(
p_Qu™t
->
Off£tLi°4x4öput
);

202 
	}
}

219 
	$CheckOff£tP¨amëîName
 (*
s
, *
ty≥
)

221 
i
 = 0;

223 *
ty≥
 = 0;

224 (
Off£tTy≥4x4
[
i
] !
NULL
) && (i < 15))

226 i‡(0 =
	`°rcmp
 (
Off£tTy≥4x4
[
i
], 
s
))

227  
i
;

229 
i
++;

232 
i
 = 0;

233 *
ty≥
 = 1;

234 (
Off£tTy≥8x8
[
i
] !
NULL
) && (i < 15))

236 i‡(0 =
	`°rcmp
 (
Off£tTy≥8x8
[
i
], 
s
))

237  
i
;

239 
i
++;

243 
	}
}

257 
	$P¨£QOff£tM©rix
 (
Qu™tP¨amëîs
 *
p_Qu™t
, *
buf
, 
bufsize
)

259 *
ôems
[
MAX_ITEMS_TO_PARSE
] = {
NULL
};

260 
M≠Idx
;

261 
ôem
 = 0;

262 
InSåög
 = 0, 
InIãm
 = 0;

263 *
p
 = 
buf
;

264 *
bu„nd
 = &
buf
[
bufsize
];

265 
I¡C⁄ã¡
;

266 
i
, 
j
, 
ønge
, 
ty≥
, 
˙t
;

267 *
Off£tLi°
;

269 
p
 < 
bu„nd
)

271 *
p
)

277 *
p
 = '\0';

278 (*
p
 !'\n' && *∞!'\r'Ë&&Ö < 
bu„nd
)

279 
p
++;

280 
InSåög
 = 0;

281 
InIãm
 = 0;

285 
InIãm
 = 0;

286 
InSåög
 = 0;

287 *
p
++ = '\0';

291 i‡(
InSåög
)

292 
p
++;

295 *
p
++ = '\0';

296 
InIãm
 = 0;

301 *
p
++ = '\0';

302 i‡(!
InSåög
)

304 
ôems
[
ôem
++] = 
p
;

305 
InIãm
 = ~InItem;

308 
InIãm
 = 0;

309 
InSåög
 = ~InString;

313 
p
++;

314 
InIãm
 = 0;

318 i‡(!
InIãm
)

320 
ôems
[
ôem
++] = 
p
;

321 
InIãm
 = ~InItem;

323 
p
++;

327 
ôem
--;

329 
i
 = 0; i < 
ôem
; i +
˙t
)

331 
˙t
 = 0;

332 i‡(0 > (
M≠Idx
 = 
	`CheckOff£tP¨amëîName
 (
ôems
[
i
 + 
˙t
], &
ty≥
)))

334 
	`¢¥ötf
 (
îr‹ãxt
, 
ET_SIZE
,

336 
ôems
[
i
 + 
˙t
]);

337 
	`îr‹
 (
îr‹ãxt
, 300);

339 
˙t
++;

340 i‡(
	`°rcmp
 ("=", 
ôems
[
i
 + 
˙t
]))

342 
	`¢¥ötf
 (
îr‹ãxt
, 
ET_SIZE
,

344 
	`îr‹
 (
îr‹ãxt
, 300);

346 
˙t
++;

348 i‡(!
ty≥
)

350 
ønge
 = 16;

351 
Off£tLi°
 = 
p_Qu™t
->
Off£tLi°4x4öput
[
M≠Idx
];

352 
off£t4x4_check
[
M≠Idx
] = 1;

356 
ønge
 = 64;

357 
Off£tLi°
 = 
p_Qu™t
->
Off£tLi°8x8öput
[
M≠Idx
];

358 
off£t8x8_check
[
M≠Idx
] = 1;

361 
j
 = 0; j < 
ønge
; j++)

363 i‡(1 !
	`ssˇnf
 (
ôems
[
i
 + 
˙t
 + 
j
], "%d", &
I¡C⁄ã¡
))

365 
	`¢¥ötf
 (
îr‹ãxt
, 
ET_SIZE
,

367 
ôems
[
i
], iãms[ò+ 
˙t
 + 
j
]);

368 
	`îr‹
 (
îr‹ãxt
, 300);

371 
Off£tLi°
[
j
] = (Ë
I¡C⁄ã¡
;

373 
˙t
 +
j
;

374 
	`¥ötf
 (".");

376 
	}
}

385 
	$öô_qoff£t
 (
VideoP¨amëîs
 *
p_Vid
)

387 *
c⁄ã¡
;

388 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

390 
	`Æloˇã_QOff£ts
 (
p_Vid
->
p_Qu™t
, 
p_I≈
);

392 i‡(
p_I≈
->
Off£tM©rixPª£¡Fœg
)

394 
	`¥ötf
 ("Parsing Quantization Offset Matrix file %s ",

395 
p_I≈
->
QOff£tM©rixFûe
);

396 
c⁄ã¡
 = 
	`GëC⁄figFûeC⁄ã¡
 (
p_I≈
->
QOff£tM©rixFûe
, 0);

397 i‡(
c⁄ã¡
 != '\0')

398 
	`P¨£QOff£tM©rix
 (
p_Vid
->
p_Qu™t
, 
c⁄ã¡
, (Ë
	`°æí
 (content));

401 
	`¥ötf
 ("\nEº‹: %s\nPro˚edög wôh deÁu… vÆue†f‹áŒ m©ri˚s.", 
îr‹ãxt
);

402 
p_I≈
->
Off£tM©rixPª£¡Fœg
 = 0;

405 
	`¥ötf
 ("\n");

407 
	`‰ì
 (
c⁄ã¡
);

410 
	`InôOff£tP¨am
 (
p_Vid
->
p_Qu™t
, 
p_I≈
);

411 
	}
}

426 
	$InôOff£tP¨am
 (
Qu™tP¨amëîs
 *
p_Qu™t
, 
I≈utP¨amëîs
 *
p_I≈
)

428 
i
, 
k
;

429 
max_qp_luma
 = (4 + 6*(
p_I≈
->
ouçut
.
bô_dïth
[0]));

430 
max_qp_¸
 = (4 + 6*(
p_I≈
->
ouçut
.
bô_dïth
[1]));

432 
i
 = 0; i < (
p_I≈
->
Ad≠tRoundögFixed
 ? 1 : 
	`imax
(
max_qp_luma
, 
max_qp_¸
)); i++)

434 i‡(
p_I≈
->
Off£tM©rixPª£¡Fœg
)

436 
	`mem˝y
(&(
p_Qu™t
->
Off£tLi°4x4
[
i
][0][0]),&’_Qu™t->
Off£tLi°4x4öput
[0][0]), 400 * ());

437 
	`mem˝y
(&(
p_Qu™t
->
Off£tLi°8x8
[
i
][0][0]),&’_Qu™t->
Off£tLi°8x8öput
[0][0]), 960 * ());

442 
	`mem˝y
(&(
p_Qu™t
->
Off£tLi°4x4
[
i
][0][0]),&(
Off£t_öåa_deÁu…_öåa
[0]), 16 * ());

443 
k
 = 1; k < 3; k++)

444 
	`mem˝y
(&(
p_Qu™t
->
Off£tLi°4x4
[
i
][
k
][0]),&(
Off£t_öåa_deÁu…_chroma
[0]), 16 * ());

445 
k
 = 3; k < 9; k++)

446 
	`mem˝y
(&(
p_Qu™t
->
Off£tLi°4x4
[
i
][
k
][0]),&(
Off£t_öåa_deÁu…_öãr
[0]), 16 * ());

447 
k
 = 9; k < 25; k++)

448 
	`mem˝y
(&(
p_Qu™t
->
Off£tLi°4x4
[
i
][
k
][0]),&(
Off£t_öãr_deÁu…
[0]), 16 * ());

451 
	`mem˝y
(&(
p_Qu™t
->
Off£tLi°8x8
[
i
][0][0]),&(
Off£t8_öåa_deÁu…_öåa
[0]), 64 * ());

452 
k
 = 1; k < 3; k++)

453 
	`mem˝y
(&(
p_Qu™t
->
Off£tLi°8x8
[
i
][
k
][0]),&(
Off£t8_öåa_deÁu…_öãr
[0]), 64 * ());

454 
k
 = 3; k < 5; k++)

455 
	`mem˝y
(&(
p_Qu™t
->
Off£tLi°8x8
[
i
][
k
][0]),&(
Off£t8_öãr_deÁu…
[0]), 64 * ());

458 
	`mem˝y
(&(
p_Qu™t
->
Off£tLi°8x8
[
i
][5][0]),&(
Off£t8_öåa_deÁu…_chroma
[0]), 64 * ());

459 
k
 = 6; k < 8; k++)

460 
	`mem˝y
(&(
p_Qu™t
->
Off£tLi°8x8
[
i
][
k
][0]),&(
Off£t8_öåa_deÁu…_öãr
[0]), 64 * ());

461 
k
 = 8; k < 10; k++)

462 
	`mem˝y
(&(
p_Qu™t
->
Off£tLi°8x8
[
i
][
k
][0]),&(
Off£t8_öãr_deÁu…
[0]), 64 * ());

465 
	`mem˝y
(&(
p_Qu™t
->
Off£tLi°8x8
[
i
][10][0]),&(
Off£t8_öåa_deÁu…_chroma
[0]), 64 * ());

466 
k
 = 11; k < 13; k++)

467 
	`mem˝y
(&(
p_Qu™t
->
Off£tLi°8x8
[
i
][
k
][0]),&(
Off£t8_öåa_deÁu…_öãr
[0]), 64 * ());

468 
k
 = 13; k < 15; k++)

469 
	`mem˝y
(&(
p_Qu™t
->
Off£tLi°8x8
[
i
][
k
][0]),&(
Off£t8_öãr_deÁu…
[0]), 64 * ());

472 
	}
}

487 
	$CÆcuœãOff£t4x4P¨am
 (
VideoP¨amëîs
 *
p_Vid
)

489 
Qu™tP¨amëîs
 *
p_Qu™t
 = 
p_Vid
->p_Quant;

490 
k
;

491 
qp_≥r
, 
qp
;

492 
img_ty≥
 = ((
p_Vid
->
ty≥
 =
SI_SLICE
Ë? 
I_SLICE
 : (p_Vid->ty≥ =
SP_SLICE
 ? 
P_SLICE
 :Ö_Vid->type));

494 
max_qp_sˇÀ
 = 
	`imax
(
p_Vid
->
bôdïth_luma_qp_sˇÀ
,Ö_Vid->
bôdïth_chroma_qp_sˇÀ
);

495 
max_qp
 = 51 + 
max_qp_sˇÀ
;

496 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

498 
p_Vid
->
Ad≠tRndWeight
 = 
p_I≈
->
Ad≠tRndWFa˘‹
 [p_Vid->
«l_ª„ªn˚_idc
 !0][
img_ty≥
];

499 
p_Vid
->
Ad≠tRndCrWeight
 = 
p_I≈
->
Ad≠tRndCrWFa˘‹
[p_Vid->
«l_ª„ªn˚_idc
 !0][
img_ty≥
];

501 i‡(
img_ty≥
 =
I_SLICE
 )

503 
qp
 = 0; q∞< 
max_qp
 + 1; qp++)

505 
k
 = 
p_Qu™t
->
qp_≥r_m©rix
 [
qp
];

506 
qp_≥r
 = 
Q_BITS
 + 
k
 - 
Off£tBôs
;

507 
k
 = 
p_I≈
->
Ad≠tRoundögFixed
 ? 0 : 
qp
;

510 
	`upd©e_q_off£t4x4
(
p_Qu™t
->
q_∑øms_4x4
[0][1][
qp
],Ö_Qu™t->
Off£tLi°4x4
[
k
][ 0], 
qp_≥r
);

512 
	`upd©e_q_off£t4x4
(
p_Qu™t
->
q_∑øms_4x4
[1][1][
qp
],Ö_Qu™t->
Off£tLi°4x4
[
k
][ 1], 
qp_≥r
);

514 
	`upd©e_q_off£t4x4
(
p_Qu™t
->
q_∑øms_4x4
[2][1][
qp
],Ö_Qu™t->
Off£tLi°4x4
[
k
][ 2], 
qp_≥r
);

517 i‡(
img_ty≥
 =
B_SLICE
)

519 
qp
 = 0; q∞< 
max_qp
 + 1; qp++)

521 
k
 = 
p_Qu™t
->
qp_≥r_m©rix
 [
qp
];

522 
qp_≥r
 = 
Q_BITS
 + 
k
 - 
Off£tBôs
;

523 
k
 = 
p_I≈
->
Ad≠tRoundögFixed
 ? 0 : 
qp
;

526 
	`upd©e_q_off£t4x4
(
p_Qu™t
->
q_∑øms_4x4
[0][0][
qp
],Ö_Qu™t->
Off£tLi°4x4
[
k
][12], 
qp_≥r
);

528 
	`upd©e_q_off£t4x4
(
p_Qu™t
->
q_∑øms_4x4
[0][1][
qp
],Ö_Qu™t->
Off£tLi°4x4
[
k
][ 6], 
qp_≥r
);

530 
	`upd©e_q_off£t4x4
(
p_Qu™t
->
q_∑øms_4x4
[1][0][
qp
],Ö_Qu™t->
Off£tLi°4x4
[
k
][13], 
qp_≥r
);

532 
	`upd©e_q_off£t4x4
(
p_Qu™t
->
q_∑øms_4x4
[1][1][
qp
],Ö_Qu™t->
Off£tLi°4x4
[
k
][ 7], 
qp_≥r
);

534 
	`upd©e_q_off£t4x4
(
p_Qu™t
->
q_∑øms_4x4
[2][0][
qp
],Ö_Qu™t->
Off£tLi°4x4
[
k
][14], 
qp_≥r
);

536 
	`upd©e_q_off£t4x4
(
p_Qu™t
->
q_∑øms_4x4
[2][1][
qp
],Ö_Qu™t->
Off£tLi°4x4
[
k
][ 8], 
qp_≥r
);

541 
qp
 = 0; q∞< 
max_qp
 + 1; qp++)

543 
k
 = 
p_Qu™t
->
qp_≥r_m©rix
 [
qp
];

544 
qp_≥r
 = 
Q_BITS
 + 
k
 - 
Off£tBôs
;

545 
k
 = 
p_I≈
->
Ad≠tRoundögFixed
 ? 0 : 
qp
;

548 
	`upd©e_q_off£t4x4
(
p_Qu™t
->
q_∑øms_4x4
[0][0][
qp
],Ö_Qu™t->
Off£tLi°4x4
[
k
][ 9], 
qp_≥r
);

550 
	`upd©e_q_off£t4x4
(
p_Qu™t
->
q_∑øms_4x4
[0][1][
qp
],Ö_Qu™t->
Off£tLi°4x4
[
k
][ 3], 
qp_≥r
);

552 
	`upd©e_q_off£t4x4
(
p_Qu™t
->
q_∑øms_4x4
[1][0][
qp
],Ö_Qu™t->
Off£tLi°4x4
[
k
][10], 
qp_≥r
);

554 
	`upd©e_q_off£t4x4
(
p_Qu™t
->
q_∑øms_4x4
[1][1][
qp
],Ö_Qu™t->
Off£tLi°4x4
[
k
][ 4], 
qp_≥r
);

556 
	`upd©e_q_off£t4x4
(
p_Qu™t
->
q_∑øms_4x4
[2][0][
qp
],Ö_Qu™t->
Off£tLi°4x4
[
k
][11], 
qp_≥r
);

558 
	`upd©e_q_off£t4x4
(
p_Qu™t
->
q_∑øms_4x4
[2][1][
qp
],Ö_Qu™t->
Off£tLi°4x4
[
k
][ 5], 
qp_≥r
);

561 
	}
}

570 
	$CÆcuœãOff£t8x8P¨am
 (
VideoP¨amëîs
 *
p_Vid
)

572 
Qu™tP¨amëîs
 *
p_Qu™t
 = 
p_Vid
->p_Quant;

573 
k
;

574 
q_bôs
, 
qp
;

576 
max_qp_sˇÀ
 = 
	`imax
(
p_Vid
->
bôdïth_luma_qp_sˇÀ
,Ö_Vid->
bôdïth_chroma_qp_sˇÀ
);

577 
max_qp
 = 51 + 
max_qp_sˇÀ
;

578 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

580 i‡(
p_Vid
->
ty≥
 =
I_SLICE
 ||Ö_Vid->ty≥ =
SI_SLICE
 )

582 
qp
 = 0; q∞< 
max_qp
 + 1; qp++)

584 
q_bôs
 = 
Q_BITS_8
 + 
p_Qu™t
->
qp_≥r_m©rix
[
qp
] - 
Off£tBôs
;

585 
k
 = 
p_I≈
->
Ad≠tRoundögFixed
 ? 0 : 
qp
;

587 
	`upd©e_q_off£t8x8
(
p_Qu™t
->
q_∑øms_8x8
[0][1][
qp
],Ö_Qu™t->
Off£tLi°8x8
[
k
][0], 
q_bôs
);

589 
	`upd©e_q_off£t8x8
(
p_Qu™t
->
q_∑øms_8x8
[1][1][
qp
],Ö_Qu™t->
Off£tLi°8x8
[
k
][5], 
q_bôs
);

591 
	`upd©e_q_off£t8x8
(
p_Qu™t
->
q_∑øms_8x8
[2][1][
qp
],Ö_Qu™t->
Off£tLi°8x8
[
k
][10], 
q_bôs
);

594 i‡((
p_Vid
->
ty≥
 =
P_SLICE
Ë|| (p_Vid->ty≥ =
SP_SLICE
))

596 
qp
 = 0; q∞< 
max_qp
 + 1; qp++)

598 
q_bôs
 = 
Q_BITS_8
 + 
p_Qu™t
->
qp_≥r_m©rix
[
qp
] - 
Off£tBôs
;

599 
k
 = 
p_I≈
->
Ad≠tRoundögFixed
 ? 0 : 
qp
;

602 
	`upd©e_q_off£t8x8
(
p_Qu™t
->
q_∑øms_8x8
[0][0][
qp
],Ö_Qu™t->
Off£tLi°8x8
[
k
][3], 
q_bôs
);

604 
	`upd©e_q_off£t8x8
(
p_Qu™t
->
q_∑øms_8x8
[0][1][
qp
],Ö_Qu™t->
Off£tLi°8x8
[
k
][1], 
q_bôs
);

606 
	`upd©e_q_off£t8x8
(
p_Qu™t
->
q_∑øms_8x8
[1][0][
qp
],Ö_Qu™t->
Off£tLi°8x8
[
k
][8], 
q_bôs
);

608 
	`upd©e_q_off£t8x8
(
p_Qu™t
->
q_∑øms_8x8
[1][1][
qp
],Ö_Qu™t->
Off£tLi°8x8
[
k
][6], 
q_bôs
);

610 
	`upd©e_q_off£t8x8
(
p_Qu™t
->
q_∑øms_8x8
[2][0][
qp
],Ö_Qu™t->
Off£tLi°8x8
[
k
][13], 
q_bôs
);

612 
	`upd©e_q_off£t8x8
(
p_Qu™t
->
q_∑øms_8x8
[2][1][
qp
],Ö_Qu™t->
Off£tLi°8x8
[
k
][11], 
q_bôs
);

617 
qp
 = 0; q∞< 
max_qp
 + 1; qp++)

619 
q_bôs
 = 
Q_BITS_8
 + 
p_Qu™t
->
qp_≥r_m©rix
[
qp
] - 
Off£tBôs
;

620 
k
 = 
p_I≈
->
Ad≠tRoundögFixed
 ? 0 : 
qp
;

623 
	`upd©e_q_off£t8x8
(
p_Qu™t
->
q_∑øms_8x8
[0][0][
qp
],Ö_Qu™t->
Off£tLi°8x8
[
k
][4], 
q_bôs
);

625 
	`upd©e_q_off£t8x8
(
p_Qu™t
->
q_∑øms_8x8
[0][1][
qp
],Ö_Qu™t->
Off£tLi°8x8
[
k
][2], 
q_bôs
);

627 
	`upd©e_q_off£t8x8
(
p_Qu™t
->
q_∑øms_8x8
[1][0][
qp
],Ö_Qu™t->
Off£tLi°8x8
[
k
][9], 
q_bôs
);

629 
	`upd©e_q_off£t8x8
(
p_Qu™t
->
q_∑øms_8x8
[1][1][
qp
],Ö_Qu™t->
Off£tLi°8x8
[
k
][7], 
q_bôs
);

631 
	`upd©e_q_off£t8x8
(
p_Qu™t
->
q_∑øms_8x8
[2][0][
qp
],Ö_Qu™t->
Off£tLi°8x8
[
k
][14], 
q_bôs
);

633 
	`upd©e_q_off£t8x8
(
p_Qu™t
->
q_∑øms_8x8
[2][1][
qp
],Ö_Qu™t->
Off£tLi°8x8
[
k
][12], 
q_bôs
);

636 
	}
}

	@lencod/src/quant4x4.c

16 
	~"c⁄åibut‹s.h
"

17 
	~"globÆ.h
"

18 
	~"qu™t4x4.h
"

27 
	$öô_qu™t_4x4
(
Sli˚
 *
cuºSli˚
)

29 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

30 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºSli˚
->p_Inp;

32 i‡(
cuºSli˚
->
U£RDOQu™t
 == 1)

34 
cuºSli˚
->
qu™t_4x4
 = 
qu™t_4x4_åñlis
;

35 i‡(
p_I≈
->
RDOQ_DC
 == 1)

36 
cuºSli˚
->
qu™t_dc4x4
 = 
qu™t_dc4x4_åñlis
;

38 
cuºSli˚
->
qu™t_dc4x4
 = 
qu™t_dc4x4_n‹mÆ
;

39 
cuºSli˚
->
qu™t_ac4x4
 = 
qu™t_ac4x4_åñlis
;

40 i‡(
cuºSli˚
->
symbﬁ_mode
 =
CAVLC
)

42 
cuºSli˚
->
rdoq_4x4
 = 
rdoq_4x4_CAVLC
;

43 
cuºSli˚
->
rdoq_dc
 = 
rdoq_dc_CAVLC
;

44 
cuºSli˚
->
rdoq_ac4x4
 = 
rdoq_ac4x4_CAVLC
;

48 
cuºSli˚
->
rdoq_4x4
 = 
rdoq_4x4_CABAC
;

49 
cuºSli˚
->
rdoq_dc
 = 
rdoq_dc_CABAC
;

50 
cuºSli˚
->
rdoq_ac4x4
 = 
rdoq_ac4x4_CABAC
;

53 i‡(
p_Vid
->
Ad≠tiveRoundög
)

55 
cuºSli˚
->
qu™t_4x4
 = 
qu™t_4x4_¨ound
;

56 
cuºSli˚
->
qu™t_dc4x4
 = 
qu™t_dc4x4_n‹mÆ
;

57 
cuºSli˚
->
qu™t_ac4x4
 = 
qu™t_ac4x4_¨ound
;

61 
cuºSli˚
->
qu™t_4x4
 = 
qu™t_4x4_n‹mÆ
;

62 
cuºSli˚
->
qu™t_dc4x4
 = 
qu™t_dc4x4_n‹mÆ
;

63 
cuºSli˚
->
qu™t_ac4x4
 = 
qu™t_ac4x4_n‹mÆ
;

65 
	}
}

	@lencod/src/quant4x4_2step.c

16 
	~"c⁄åibut‹s.h
"

18 
	~<m©h.h
>

20 
	~"globÆ.h
"

22 
	~"image.h
"

23 
	~"mb_ac˚ss.h
"

24 
	~"vlc.h
"

25 
	~"å™sf‹m.h
"

26 
	~"mc_¥edi˘i⁄.h
"

27 
	~"q_off£ts.h
"

28 
	~"q_m©rix.h
"

29 
	~"qu™t4x4.h
"

38 
	$qu™t_4x4_2°ï
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qu™t_mëhods
 *
q_mëhod
)

40 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

41 
Qu™tP¨amëîs
 *
p_Qu™t
 = 
p_Vid
->p_Quant;

42 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

43 
Boﬁón
 
is_ˇvlc
 = (BoﬁónË(
cuºSli˚
->
symbﬁ_mode
 =
CAVLC
);

45 
block_x
 = 
q_mëhod
->block_x;

46 
qp
 = 
q_mëhod
->qp;

47 * 
ACL
 = &
q_mëhod
->
ACLevñ
[0];

48 * 
ACR
 = &
q_mëhod
->
ACRun
[0];

49 
LevñQu™tP¨ams
 **
q_∑øms_4x4
 = 
q_mëhod
->
q_∑øms
;

50 c⁄° 
	`byã
 (*
pos_sˇn
)[2] = 
q_mëhod
->pos_scan;

51 c⁄° 
byã
 *
c_co°
 = 
q_mëhod
->c_cost;

52 *
c€ff_co°
 = 
q_mëhod
->coeff_cost;

55 
LevñQu™tP¨ams
 *
q_∑øms
 = 
NULL
;

56 
i
,
j
, 
c€ff_˘r
;

58 *
m7
;

59 
sˇÀd_c€ff
;

61 
Àvñ
, 
run
 = 0;

62 
n⁄zîo
 = 
FALSE
;

63 
qp_≥r
 = 
p_Qu™t
->
qp_≥r_m©rix
[
qp
];

64 
q_bôs
 = 
Q_BITS
 + 
qp_≥r
;

65 c⁄° 
byã
 *
p_sˇn
 = &
pos_sˇn
[0][0];

68 
c€ff_˘r
 = 0; coeff_ctr < 16; ++coeff_ctr)

70 
i
 = *
p_sˇn
++;

71 
j
 = *
p_sˇn
++;

73 
m7
 = &
tblock
[
j
][
block_x
 + 
i
];

75 i‡(*
m7
 != 0)

77 
q_∑øms
 = &
q_∑øms_4x4
[
j
][
i
];

78 
sˇÀd_c€ff
 = 
	`übs
 (*
m7
Ë* 
q_∑øms
->
SˇÀComp
;

79 
Àvñ
 = (
sˇÀd_c€ff
 + 
q_∑øms
->
Off£tComp
Ë>> 
q_bôs
;

81 i‡(
Àvñ
 != 0)

83 i‡(
is_ˇvlc
)

84 
Àvñ
 = 
	`imö
÷evñ, 
CAVLC_LEVEL_LIMIT
);

86 *
c€ff_co°
 +(
Àvñ
 > 1Ë? 
MAX_VALUE
 : 
c_co°
[
run
];

88 
Àvñ
 = 
	`isig«b
÷evñ, *
m7
);

89 *
m7
 = 
	`rshi·_∫d_sf
(((
Àvñ
 * 
q_∑øms
->
InvSˇÀComp
Ë<< 
qp_≥r
), 4);

93 *
ACL
++ = 
Àvñ
;

94 *
ACR
++ = 
run
;

96 
run
 = 0;

97 
n⁄zîo
 = 
TRUE
;

101 *
m7
 = 0;

102 ++
run
;

107 ++
run
;

111 *
ACL
 = 0;

113  
n⁄zîo
;

114 
	}
}

116 
	$qu™t_ac4x4_2°ï
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qu™t_mëhods
 *
q_mëhod
)

118 
block_x
 = 
q_mëhod
->block_x;

120 
qp
 = 
q_mëhod
->qp;

121 * 
ACL
 = &
q_mëhod
->
ACLevñ
[0];

122 * 
ACR
 = &
q_mëhod
->
ACRun
[0];

123 
LevñQu™tP¨ams
 **
q_∑øms_4x4
 = 
q_mëhod
->
q_∑øms
;

124 c⁄° 
	`byã
 (*
pos_sˇn
)[2] = 
q_mëhod
->pos_scan;

125 c⁄° 
byã
 *
c_co°
 = 
q_mëhod
->c_cost;

126 *
c€ff_co°
 = 
q_mëhod
->coeff_cost;

128 
Boﬁón
 
is_ˇvlc
 = (BoﬁónË(
cuºMB
->
p_Sli˚
->
symbﬁ_mode
 =
CAVLC
);

129 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

130 
Qu™tP¨amëîs
 *
p_Qu™t
 = 
p_Vid
->p_Quant;

131 
LevñQu™tP¨ams
 *
q_∑øms
 = 
NULL
;

133 
i
,
j
, 
c€ff_˘r
;

135 *
m7
;

136 
sˇÀd_c€ff
;

138 
Àvñ
, 
run
 = 0;

139 
n⁄zîo
 = 
FALSE
;

140 
qp_≥r
 = 
p_Qu™t
->
qp_≥r_m©rix
[
qp
];

141 
q_bôs
 = 
Q_BITS
 + 
qp_≥r
;

142 c⁄° 
byã
 *
p_sˇn1
 = &
pos_sˇn
[1][0];

143 c⁄° 
byã
 *
p_sˇn
 = &
pos_sˇn
[1][0];

144 
ãmp_block
[16][16];

146 
qp_≥r2
 = 
p_Qu™t
->
qp_≥r_m©rix
[51];

147 
q_bôs2
 = 
Q_BITS
 + 
qp_≥r2
;

148 
c€ff
;

152 
c€ff_˘r
 = 1; coeff_ctr < 16; ++coeff_ctr)

154 
i
 = *
p_sˇn1
++;

155 
j
 = *
p_sˇn1
++;

157 
c€ff
 = 
tblock
[
j
][
block_x
 + 
i
];

158 
m7
 = &
ãmp_block
[
j
][
block_x
 + 
i
];

159 i‡(
c€ff
 != 0)

161 
q_∑øms
 = &
q_∑øms_4x4
[
j
][
i
];

162 
sˇÀd_c€ff
 = 
	`übs
 (
c€ff
);

163 
Àvñ
 = (
sˇÀd_c€ff
 * 
q_∑øms
->
SˇÀComp
Ë>> 
q_bôs2
;

166 i‡(
Àvñ
 != 0)

168 i‡(
is_ˇvlc
)

169 
Àvñ
 = 
	`imö
÷evñ, 
CAVLC_LEVEL_LIMIT
);

171 
Àvñ
 = 
	`isig«b
÷evñ, 
c€ff
);

172 *
m7
 = (
Àvñ
 << 
q_bôs2
Ë/ 
q_∑øms
->
SˇÀComp
;

177 *
m7
 = 0;

181 *
m7
 = 0;

185 
c€ff_˘r
 = 1; coeff_ctr < 16; ++coeff_ctr)

187 
i
 = *
p_sˇn
++;

188 
j
 = *
p_sˇn
++;

190 
c€ff
 = 
ãmp_block
[
j
][
block_x
 + 
i
];

191 
m7
 = &
tblock
[
j
][
block_x
 + 
i
];

192 i‡(*
m7
 != 0)

194 
q_∑øms
 = &
q_∑øms_4x4
[
j
][
i
];

195 
sˇÀd_c€ff
 = 
	`übs
 (
c€ff
Ë* 
q_∑øms
->
SˇÀComp
;

196 
Àvñ
 = (
sˇÀd_c€ff
 + 
q_∑øms
->
Off£tComp
Ë>> 
q_bôs
;

198 i‡(
Àvñ
 != 0)

200 i‡(
is_ˇvlc
)

201 
Àvñ
 = 
	`imö
÷evñ, 
CAVLC_LEVEL_LIMIT
);

203 *
c€ff_co°
 +(
Àvñ
 > 1Ë? 
MAX_VALUE
 : 
c_co°
[
run
];

205 
Àvñ
 = 
	`isig«b
÷evñ, 
c€ff
);

206 *
m7
 = 
	`rshi·_∫d_sf
(((
Àvñ
 * 
q_∑øms
->
InvSˇÀComp
Ë<< 
qp_≥r
), 4);

210 *
ACL
++ = 
Àvñ
;

211 *
ACR
++ = 
run
;

213 
run
 = 0;

214 
n⁄zîo
 = 
TRUE
;

218 *
m7
 = 0;

219 ++
run
;

224 *
m7
 = 0;

225 ++
run
;

229 *
ACL
 = 0;

231  
n⁄zîo
;

232 
	}
}

241 
qu™t_dc4x4_2°ï
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qp
, * 
DCLevñ
, * 
DCRun
,

242 
LevñQu™tP¨ams
 *
q_∑øms_4x4
, c⁄° 
byã
 (*
pos_sˇn
)[2])

244 
Qu™tP¨amëîs
 *
	gp_Qu™t
 = 
cuºMB
->
p_Vid
->
p_Qu™t
;

245 
Boﬁón
 
	gis_ˇvlc
 = (BoﬁónË(
cuºMB
->
p_Sli˚
->
symbﬁ_mode
 =
CAVLC
);

246 
	gi
,
	gj
, 
	gc€ff_˘r
;

248 *
	gm7
;

249 
	gsˇÀd_c€ff
;

251 
	gÀvñ
, 
	grun
 = 0;

252 
	gn⁄zîo
 = 
FALSE
;

253 
	gqp_≥r
 = 
p_Qu™t
->
qp_≥r_m©rix
[
qp
];

254 
	gq_bôs
 = 
Q_BITS
 + 
qp_≥r
 + 1;

255 c⁄° 
byã
 *
	gp_sˇn
 = &
pos_sˇn
[0][0];

256 * 
	gDCL
 = &
DCLevñ
[0];

257 * 
	gDCR
 = &
DCRun
[0];

260 
	gc€ff_˘r
 = 0; coeff_ctr < 16; ++coeff_ctr)

262 
	gi
 = *
p_sˇn
++;

263 
	gj
 = *
p_sˇn
++;

265 
	gm7
 = &
tblock
[
j
][
i
];

267 i‡(*
	gm7
 != 0)

269 
sˇÀd_c€ff
 = 
übs
 (*
m7
Ë* 
q_∑øms_4x4
->
SˇÀComp
;

270 
	gÀvñ
 = (
sˇÀd_c€ff
 + (
q_∑øms_4x4
->
Off£tComp
 << 1ËË>> 
q_bôs
;

272 i‡(
	gÀvñ
 != 0)

274 i‡(
is_ˇvlc
)

275 
Àvñ
 = 
imö
÷evñ, 
CAVLC_LEVEL_LIMIT
);

277 
	gÀvñ
 = 
isig«b
(
Àvñ
, *
m7
);

278 *
	gm7
 = 
Àvñ
;

279 *
	gDCL
++ = 
Àvñ
;

280 *
	gDCR
++ = 
run
;

282 
	grun
 = 0;

283 
	gn⁄zîo
 = 
TRUE
;

287 ++
	grun
;

288 *
	gm7
 = 0;

293 ++
	grun
;

297 *
	gDCL
 = 0;

299  
	gn⁄zîo
;

	@lencod/src/quant4x4_around.c

17 
	~"c⁄åibut‹s.h
"

19 
	~<m©h.h
>

21 
	~"globÆ.h
"

23 
	~"image.h
"

24 
	~"mb_ac˚ss.h
"

25 
	~"vlc.h
"

26 
	~"å™sf‹m.h
"

27 
	~"mc_¥edi˘i⁄.h
"

28 
	~"q_off£ts.h
"

29 
	~"q_m©rix.h
"

30 
	~"qu™t4x4.h
"

40 
	$qu™t_4x4_¨ound
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qu™t_mëhods
 *
q_mëhod
)

42 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

43 
Qu™tP¨amëîs
 *
p_Qu™t
 = 
p_Vid
->p_Quant;

44 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

45 
Boﬁón
 
is_ˇvlc
 = (BoﬁónË(
cuºSli˚
->
symbﬁ_mode
 =
CAVLC
);

47 
Ad≠tRndWeight
 = 
p_Vid
->AdaptRndWeight;

49 
block_x
 = 
q_mëhod
->block_x;

50 
qp
 = 
q_mëhod
->qp;

51 * 
ACL
 = &
q_mëhod
->
ACLevñ
[0];

52 * 
ACR
 = &
q_mëhod
->
ACRun
[0];

53 
LevñQu™tP¨ams
 **
q_∑øms_4x4
 = 
q_mëhod
->
q_∑øms
;

54 c⁄° 
	`byã
 (*
pos_sˇn
)[2] = 
q_mëhod
->pos_scan;

55 c⁄° 
byã
 *
c_co°
 = 
q_mëhod
->c_cost;

56 *
c€ff_co°
 = 
q_mëhod
->coeff_cost;

59 
LevñQu™tP¨ams
 *
q_∑øms
 = 
NULL
;

60 **
Ádju°4x4
 = 
q_mëhod
->
Ádju°
;

62 
i
,
j
, 
c€ff_˘r
;

64 *
m7
;

65 
sˇÀd_c€ff
;

67 
Àvñ
, 
run
 = 0;

68 
n⁄zîo
 = 
FALSE
;

69 
qp_≥r
 = 
p_Qu™t
->
qp_≥r_m©rix
[
qp
];

70 
q_bôs
 = 
Q_BITS
 + 
qp_≥r
;

71 c⁄° 
byã
 *
p_sˇn
 = &
pos_sˇn
[0][0];

73 * 
∑dju°4x4
;

76 
c€ff_˘r
 = 0; coeff_ctr < 16; ++coeff_ctr)

78 
i
 = *
p_sˇn
++;

79 
j
 = *
p_sˇn
++;

81 
∑dju°4x4
 = &
Ádju°4x4
[
j
][
block_x
 + 
i
];

82 
m7
 = &
tblock
[
j
][
block_x
 + 
i
];

84 i‡(*
m7
 != 0)

86 
q_∑øms
 = &
q_∑øms_4x4
[
j
][
i
];

87 
sˇÀd_c€ff
 = 
	`übs
 (*
m7
Ë* 
q_∑øms
->
SˇÀComp
;

88 
Àvñ
 = (
sˇÀd_c€ff
 + 
q_∑øms
->
Off£tComp
Ë>> 
q_bôs
;

90 i‡(
Àvñ
 != 0)

92 i‡(
is_ˇvlc
)

93 
Àvñ
 = 
	`imö
÷evñ, 
CAVLC_LEVEL_LIMIT
);

95 *
∑dju°4x4
 = 
	`rshi·_∫d_sf
((
Ad≠tRndWeight
 * (
sˇÀd_c€ff
 - (
Àvñ
 << 
q_bôs
))), q_bits + 1);

97 *
c€ff_co°
 +(
Àvñ
 > 1Ë? 
MAX_VALUE
 : 
c_co°
[
run
];

99 
Àvñ
 = 
	`isig«b
÷evñ, *
m7
);

100 *
m7
 = 
	`rshi·_∫d_sf
(((
Àvñ
 * 
q_∑øms
->
InvSˇÀComp
Ë<< 
qp_≥r
), 4);

104 *
ACL
++ = 
Àvñ
;

105 *
ACR
++ = 
run
;

107 
run
 = 0;

108 
n⁄zîo
 = 
TRUE
;

112 *
∑dju°4x4
 = 0;

113 *
m7
 = 0;

114 ++
run
;

119 *
∑dju°4x4
 = 0;

120 ++
run
;

124 *
ACL
 = 0;

126  
n⁄zîo
;

127 
	}
}

129 
	$qu™t_ac4x4_¨ound
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qu™t_mëhods
 *
q_mëhod
)

131 
block_x
 = 
q_mëhod
->block_x;

133 
qp
 = 
q_mëhod
->qp;

134 * 
ACL
 = &
q_mëhod
->
ACLevñ
[0];

135 * 
ACR
 = &
q_mëhod
->
ACRun
[0];

136 
LevñQu™tP¨ams
 **
q_∑øms_4x4
 = 
q_mëhod
->
q_∑øms
;

137 **
Ádju°4x4
 = 
q_mëhod
->
Ádju°
;

138 c⁄° 
	`byã
 (*
pos_sˇn
)[2] = 
q_mëhod
->pos_scan;

139 c⁄° 
byã
 *
c_co°
 = 
q_mëhod
->c_cost;

140 *
c€ff_co°
 = 
q_mëhod
->coeff_cost;

142 
Boﬁón
 
is_ˇvlc
 = (BoﬁónË(
cuºMB
->
p_Sli˚
->
symbﬁ_mode
 =
CAVLC
);

143 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

144 
Qu™tP¨amëîs
 *
p_Qu™t
 = 
p_Vid
->p_Quant;

145 
Ad≠tRndWeight
 = 
p_Vid
->AdaptRndWeight;

146 
LevñQu™tP¨ams
 *
q_∑øms
 = 
NULL
;

148 
i
,
j
, 
c€ff_˘r
;

150 *
m7
;

151 
sˇÀd_c€ff
;

153 
Àvñ
, 
run
 = 0;

154 
n⁄zîo
 = 
FALSE
;

155 
qp_≥r
 = 
p_Qu™t
->
qp_≥r_m©rix
[
qp
];

156 
q_bôs
 = 
Q_BITS
 + 
qp_≥r
;

157 c⁄° 
byã
 *
p_sˇn
 = &
pos_sˇn
[1][0];

158 * 
∑dju°4x4
;

161 
c€ff_˘r
 = 1; coeff_ctr < 16; ++coeff_ctr)

163 
i
 = *
p_sˇn
++;

164 
j
 = *
p_sˇn
++;

166 
∑dju°4x4
 = &
Ádju°4x4
[
j
][
block_x
 + 
i
];

167 
m7
 = &
tblock
[
j
][
block_x
 + 
i
];

168 i‡(*
m7
 != 0)

170 
q_∑øms
 = &
q_∑øms_4x4
[
j
][
i
];

171 
sˇÀd_c€ff
 = 
	`übs
 (*
m7
Ë* 
q_∑øms
->
SˇÀComp
;

172 
Àvñ
 = (
sˇÀd_c€ff
 + 
q_∑øms
->
Off£tComp
Ë>> 
q_bôs
;

174 i‡(
Àvñ
 != 0)

176 i‡(
is_ˇvlc
)

177 
Àvñ
 = 
	`imö
÷evñ, 
CAVLC_LEVEL_LIMIT
);

179 *
∑dju°4x4
 = 
	`rshi·_∫d_sf
((
Ad≠tRndWeight
 * (
sˇÀd_c€ff
 - (
Àvñ
 << 
q_bôs
))), (q_bits + 1));

181 *
c€ff_co°
 +(
Àvñ
 > 1Ë? 
MAX_VALUE
 : 
c_co°
[
run
];

183 
Àvñ
 = 
	`isig«b
÷evñ, *
m7
);

184 *
m7
 = 
	`rshi·_∫d_sf
(((
Àvñ
 * 
q_∑øms
->
InvSˇÀComp
Ë<< 
qp_≥r
), 4);

188 *
ACL
++ = 
Àvñ
;

189 *
ACR
++ = 
run
;

191 
run
 = 0;

192 
n⁄zîo
 = 
TRUE
;

196 *
∑dju°4x4
 = 0;

197 *
m7
 = 0;

198 ++
run
;

203 *
∑dju°4x4
 = 0;

204 ++
run
;

208 *
ACL
 = 0;

210  
n⁄zîo
;

211 
	}
}

220 
qu™t_dc4x4_¨ound
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qp
, * 
DCLevñ
, * 
DCRun
,

221 
LevñQu™tP¨ams
 *
q_∑øms_4x4
, c⁄° 
byã
 (*
pos_sˇn
)[2])

223 
Qu™tP¨amëîs
 *
	gp_Qu™t
 = 
cuºMB
->
p_Vid
->
p_Qu™t
;

224 
Boﬁón
 
	gis_ˇvlc
 = (BoﬁónË(
cuºMB
->
p_Sli˚
->
symbﬁ_mode
 =
CAVLC
);

225 
	gi
,
	gj
, 
	gc€ff_˘r
;

227 *
	gm7
;

228 
	gsˇÀd_c€ff
;

230 
	gÀvñ
, 
	grun
 = 0;

231 
	gn⁄zîo
 = 
FALSE
;

232 
	gqp_≥r
 = 
p_Qu™t
->
qp_≥r_m©rix
[
qp
];

233 
	gq_bôs
 = 
Q_BITS
 + 
qp_≥r
 + 1;

234 c⁄° 
byã
 *
	gp_sˇn
 = &
pos_sˇn
[0][0];

235 * 
	gDCL
 = &
DCLevñ
[0];

236 * 
	gDCR
 = &
DCRun
[0];

239 
	gc€ff_˘r
 = 0; coeff_ctr < 16; ++coeff_ctr)

241 
	gi
 = *
p_sˇn
++;

242 
	gj
 = *
p_sˇn
++;

244 
	gm7
 = &
tblock
[
j
][
i
];

246 i‡(*
	gm7
 != 0)

248 
sˇÀd_c€ff
 = 
übs
 (*
m7
Ë* 
q_∑øms_4x4
->
SˇÀComp
;

249 
	gÀvñ
 = (
sˇÀd_c€ff
 + (
q_∑øms_4x4
->
Off£tComp
 << 1ËË>> 
q_bôs
;

251 i‡(
	gÀvñ
 != 0)

253 i‡(
is_ˇvlc
)

254 
Àvñ
 = 
imö
÷evñ, 
CAVLC_LEVEL_LIMIT
);

256 
	gÀvñ
 = 
isig«b
(
Àvñ
, *
m7
);

257 *
	gm7
 = 
Àvñ
;

258 *
	gDCL
++ = 
Àvñ
;

259 *
	gDCR
++ = 
run
;

261 
	grun
 = 0;

262 
	gn⁄zîo
 = 
TRUE
;

266 ++
	grun
;

267 *
	gm7
 = 0;

272 ++
	grun
;

276 *
	gDCL
 = 0;

278  
	gn⁄zîo
;

	@lencod/src/quant4x4_normal.c

17 
	~"c⁄åibut‹s.h
"

19 
	~<m©h.h
>

21 
	~"globÆ.h
"

23 
	~"image.h
"

24 
	~"mb_ac˚ss.h
"

25 
	~"vlc.h
"

26 
	~"å™sf‹m.h
"

27 
	~"mc_¥edi˘i⁄.h
"

28 
	~"q_off£ts.h
"

29 
	~"q_m©rix.h
"

30 
	~"qu™t4x4.h
"

39 
	$qu™t_4x4_n‹mÆ
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qu™t_mëhods
 *
q_mëhod
)

41 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

42 
Qu™tP¨amëîs
 *
p_Qu™t
 = 
p_Vid
->p_Quant;

43 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

44 
Boﬁón
 
is_ˇvlc
 = (BoﬁónË(
cuºSli˚
->
symbﬁ_mode
 =
CAVLC
);

46 
block_x
 = 
q_mëhod
->block_x;

47 
qp
 = 
q_mëhod
->qp;

48 * 
ACL
 = &
q_mëhod
->
ACLevñ
[0];

49 * 
ACR
 = &
q_mëhod
->
ACRun
[0];

50 
LevñQu™tP¨ams
 **
q_∑øms_4x4
 = 
q_mëhod
->
q_∑øms
;

51 c⁄° 
	`byã
 (*
pos_sˇn
)[2] = 
q_mëhod
->pos_scan;

52 c⁄° 
byã
 *
c_co°
 = 
q_mëhod
->c_cost;

53 *
c€ff_co°
 = 
q_mëhod
->coeff_cost;

56 
LevñQu™tP¨ams
 *
q_∑øms
 = 
NULL
;

57 
i
,
j
, 
c€ff_˘r
;

59 *
m7
;

60 
sˇÀd_c€ff
;

62 
Àvñ
, 
run
 = 0;

63 
n⁄zîo
 = 
FALSE
;

64 
qp_≥r
 = 
p_Qu™t
->
qp_≥r_m©rix
[
qp
];

65 
q_bôs
 = 
Q_BITS
 + 
qp_≥r
;

66 c⁄° 
byã
 *
p_sˇn
 = &
pos_sˇn
[0][0];

69 
c€ff_˘r
 = 0; coeff_ctr < 16; ++coeff_ctr)

71 
i
 = *
p_sˇn
++;

72 
j
 = *
p_sˇn
++;

74 
m7
 = &
tblock
[
j
][
block_x
 + 
i
];

76 i‡(*
m7
 != 0)

78 
q_∑øms
 = &
q_∑øms_4x4
[
j
][
i
];

79 
sˇÀd_c€ff
 = 
	`übs
 (*
m7
Ë* 
q_∑øms
->
SˇÀComp
;

80 
Àvñ
 = (
sˇÀd_c€ff
 + 
q_∑øms
->
Off£tComp
Ë>> 
q_bôs
;

82 i‡(
Àvñ
 != 0)

84 i‡(
is_ˇvlc
)

85 
Àvñ
 = 
	`imö
÷evñ, 
CAVLC_LEVEL_LIMIT
);

87 *
c€ff_co°
 +(
Àvñ
 > 1Ë? 
MAX_VALUE
 : 
c_co°
[
run
];

89 
Àvñ
 = 
	`isig«b
÷evñ, *
m7
);

90 *
m7
 = 
	`rshi·_∫d_sf
(((
Àvñ
 * 
q_∑øms
->
InvSˇÀComp
Ë<< 
qp_≥r
), 4);

94 *
ACL
++ = 
Àvñ
;

95 *
ACR
++ = 
run
;

97 
run
 = 0;

98 
n⁄zîo
 = 
TRUE
;

102 *
m7
 = 0;

103 ++
run
;

108 ++
run
;

112 *
ACL
 = 0;

114  
n⁄zîo
;

115 
	}
}

117 
	$qu™t_ac4x4_n‹mÆ
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qu™t_mëhods
 *
q_mëhod
)

119 
block_x
 = 
q_mëhod
->block_x;

121 
qp
 = 
q_mëhod
->qp;

122 * 
ACL
 = &
q_mëhod
->
ACLevñ
[0];

123 * 
ACR
 = &
q_mëhod
->
ACRun
[0];

124 
LevñQu™tP¨ams
 **
q_∑øms_4x4
 = 
q_mëhod
->
q_∑øms
;

125 c⁄° 
	`byã
 (*
pos_sˇn
)[2] = 
q_mëhod
->pos_scan;

126 c⁄° 
byã
 *
c_co°
 = 
q_mëhod
->c_cost;

127 *
c€ff_co°
 = 
q_mëhod
->coeff_cost;

129 
Boﬁón
 
is_ˇvlc
 = (BoﬁónË(
cuºMB
->
p_Sli˚
->
symbﬁ_mode
 =
CAVLC
);

130 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

131 
Qu™tP¨amëîs
 *
p_Qu™t
 = 
p_Vid
->p_Quant;

132 
LevñQu™tP¨ams
 *
q_∑øms
 = 
NULL
;

134 
i
,
j
, 
c€ff_˘r
;

136 *
m7
;

137 
sˇÀd_c€ff
;

139 
Àvñ
, 
run
 = 0;

140 
n⁄zîo
 = 
FALSE
;

141 
qp_≥r
 = 
p_Qu™t
->
qp_≥r_m©rix
[
qp
];

142 
q_bôs
 = 
Q_BITS
 + 
qp_≥r
;

143 c⁄° 
byã
 *
p_sˇn
 = &
pos_sˇn
[1][0];

146 
c€ff_˘r
 = 1; coeff_ctr < 16; ++coeff_ctr)

148 
i
 = *
p_sˇn
++;

149 
j
 = *
p_sˇn
++;

151 
m7
 = &
tblock
[
j
][
block_x
 + 
i
];

152 i‡(*
m7
 != 0)

154 
q_∑øms
 = &
q_∑øms_4x4
[
j
][
i
];

155 
sˇÀd_c€ff
 = 
	`übs
 (*
m7
Ë* 
q_∑øms
->
SˇÀComp
;

156 
Àvñ
 = (
sˇÀd_c€ff
 + 
q_∑øms
->
Off£tComp
Ë>> 
q_bôs
;

158 i‡(
Àvñ
 != 0)

160 i‡(
is_ˇvlc
)

161 
Àvñ
 = 
	`imö
÷evñ, 
CAVLC_LEVEL_LIMIT
);

163 *
c€ff_co°
 +(
Àvñ
 > 1Ë? 
MAX_VALUE
 : 
c_co°
[
run
];

165 
Àvñ
 = 
	`isig«b
÷evñ, *
m7
);

166 *
m7
 = 
	`rshi·_∫d_sf
(((
Àvñ
 * 
q_∑øms
->
InvSˇÀComp
Ë<< 
qp_≥r
), 4);

170 *
ACL
++ = 
Àvñ
;

171 *
ACR
++ = 
run
;

173 
run
 = 0;

174 
n⁄zîo
 = 
TRUE
;

178 *
m7
 = 0;

179 ++
run
;

184 ++
run
;

188 *
ACL
 = 0;

190  
n⁄zîo
;

191 
	}
}

200 
qu™t_dc4x4_n‹mÆ
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qp
, * 
DCLevñ
, * 
DCRun
,

201 
LevñQu™tP¨ams
 *
q_∑øms_4x4
, c⁄° 
byã
 (*
pos_sˇn
)[2])

203 
Qu™tP¨amëîs
 *
	gp_Qu™t
 = 
cuºMB
->
p_Vid
->
p_Qu™t
;

204 
Boﬁón
 
	gis_ˇvlc
 = (BoﬁónË(
cuºMB
->
p_Sli˚
->
symbﬁ_mode
 =
CAVLC
);

205 
	gi
,
	gj
, 
	gc€ff_˘r
;

207 *
	gm7
;

208 
	gsˇÀd_c€ff
;

210 
	gÀvñ
, 
	grun
 = 0;

211 
	gn⁄zîo
 = 
FALSE
;

212 
	gqp_≥r
 = 
p_Qu™t
->
qp_≥r_m©rix
[
qp
];

213 
	gq_bôs
 = 
Q_BITS
 + 
qp_≥r
 + 1;

214 c⁄° 
byã
 *
	gp_sˇn
 = &
pos_sˇn
[0][0];

215 * 
	gDCL
 = &
DCLevñ
[0];

216 * 
	gDCR
 = &
DCRun
[0];

219 
	gc€ff_˘r
 = 0; coeff_ctr < 16; ++coeff_ctr)

221 
	gi
 = *
p_sˇn
++;

222 
	gj
 = *
p_sˇn
++;

224 
	gm7
 = &
tblock
[
j
][
i
];

226 i‡(*
	gm7
 != 0)

228 
sˇÀd_c€ff
 = 
übs
 (*
m7
Ë* 
q_∑øms_4x4
->
SˇÀComp
;

229 
	gÀvñ
 = (
sˇÀd_c€ff
 + (
q_∑øms_4x4
->
Off£tComp
 << 1ËË>> 
q_bôs
;

231 i‡(
	gÀvñ
 != 0)

233 i‡(
is_ˇvlc
)

234 
Àvñ
 = 
imö
÷evñ, 
CAVLC_LEVEL_LIMIT
);

236 
	gÀvñ
 = 
isig«b
(
Àvñ
, *
m7
);

237 *
	gm7
 = 
Àvñ
;

238 *
	gDCL
++ = 
Àvñ
;

239 *
	gDCR
++ = 
run
;

241 
	grun
 = 0;

242 
	gn⁄zîo
 = 
TRUE
;

246 ++
	grun
;

247 *
	gm7
 = 0;

252 ++
	grun
;

256 *
	gDCL
 = 0;

258  
	gn⁄zîo
;

	@lencod/src/quant4x4_trellis.c

18 
	~"c⁄åibut‹s.h
"

20 
	~<m©h.h
>

22 
	~"globÆ.h
"

24 
	~"image.h
"

25 
	~"mb_ac˚ss.h
"

26 
	~"vlc.h
"

27 
	~"å™sf‹m.h
"

28 
	~"mc_¥edi˘i⁄.h
"

29 
	~"q_off£ts.h
"

30 
	~"q_m©rix.h
"

31 
	~"qu™t4x4.h
"

32 
	~"rdoq.h
"

41 
	$qu™t_4x4_åñlis
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qu™t_mëhods
 *
q_mëhod
)

43 
block_x
 = 
q_mëhod
->block_x;

45 * 
ACL
 = &
q_mëhod
->
ACLevñ
[0];

46 * 
ACR
 = &
q_mëhod
->
ACRun
[0];

47 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

48 
Qu™tP¨amëîs
 *
p_Qu™t
 = 
cuºMB
->
p_Vid
->p_Quant;

49 
qp
 = 
q_mëhod
->qp;

50 
LevñQu™tP¨ams
 **
q_∑øms_4x4
 = 
q_mëhod
->
q_∑øms
;

51 c⁄° 
	`byã
 (*
pos_sˇn
)[2] = 
q_mëhod
->pos_scan;

52 c⁄° 
byã
 *
c_co°
 = 
q_mëhod
->c_cost;

53 *
c€ff_co°
 = 
q_mëhod
->coeff_cost;

55 
Boﬁón
 
is_ˇvlc
 = (BoﬁónË(
cuºSli˚
->
symbﬁ_mode
 =
CAVLC
);

57 
i
,
j
, 
c€ff_˘r
;

59 *
m7
;

61 
Àvñ
, 
run
 = 0;

62 
n⁄zîo
 = 
FALSE
;

63 
qp_≥r
 = 
p_Qu™t
->
qp_≥r_m©rix
[
qp
];

64 c⁄° 
byã
 *
p_sˇn
 = &
pos_sˇn
[0][0];

66 
ÀvñTªŒis
[16];

68 
cuºSli˚
->
	`rdoq_4x4
(
cuºMB
, 
tblock
, 
q_mëhod
, 
ÀvñTªŒis
);

71 
c€ff_˘r
 = 0; coeff_ctr < 16; ++coeff_ctr)

73 
i
 = *
p_sˇn
++;

74 
j
 = *
p_sˇn
++;

76 
m7
 = &
tblock
[
j
][
block_x
 + 
i
];

78 i‡(*
m7
 != 0)

84 
Àvñ
 = 
ÀvñTªŒis
[
c€ff_˘r
];

86 i‡(
Àvñ
 != 0)

88 i‡(
is_ˇvlc
)

89 
Àvñ
 = 
	`imö
÷evñ, 
CAVLC_LEVEL_LIMIT
);

91 *
c€ff_co°
 +(
Àvñ
 > 1Ë? 
MAX_VALUE
 : 
c_co°
[
run
];

93 
Àvñ
 = 
	`isig«b
÷evñ, *
m7
);

94 *
m7
 = 
	`rshi·_∫d_sf
(((
Àvñ
 * 
q_∑øms_4x4
[
j
][
i
].
InvSˇÀComp
Ë<< 
qp_≥r
), 4);

95 *
ACL
++ = 
Àvñ
;

96 *
ACR
++ = 
run
;

98 
run
 = 0;

99 
n⁄zîo
 = 
TRUE
;

103 *
m7
 = 0;

104 ++
run
;

109 ++
run
;

113 *
ACL
 = 0;

115  
n⁄zîo
;

116 
	}
}

126 
	$rdoq_4x4_CAVLC
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qu™t_mëhods
 *
q_mëhod
, 
ÀvñTªŒis
[])

128 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

129 
block_x
 = 
q_mëhod
->block_x;

130 
block_y
 = 
q_mëhod
->block_y;

131 
LevñQu™tP¨ams
 **
q_∑øms_4x4
 = 
q_mëhod
->
q_∑øms
;

132 c⁄° 
	`byã
 (*
pos_sˇn
)[2] = 
q_mëhod
->pos_scan;

133 c⁄° 
byã
 *
p_sˇn
 = &
pos_sˇn
[0][0];

134 
qp
 = 
q_mëhod
->qp;

135 
Qu™tP¨amëîs
 *
p_Qu™t
 = 
cuºMB
->
p_Vid
->p_Quant;

136 
qp_≥r
 = 
p_Qu™t
->
qp_≥r_m©rix
[
qp
];

137 
qp_ªm
 = 
p_Qu™t
->
qp_ªm_m©rix
[
qp
];

139 
ÀvñD©aSåu˘
 
ÀvñD©a
[16];

140 
œmbda_md
 = 
p_Vid
->
œmbda_rdoq
[p_Vid->
ty≥
][p_Vid->
ma°îQP
];

142 
ty≥
 = 
LUMA_4x4
;

143 
pos_x
 = 
block_x
 >> 
BLOCK_SHIFT
;

144 
pos_y
 = 
block_y
 >> 
BLOCK_SHIFT
;

145 
b8
 = 2*(
pos_y
 >> 1Ë+ (
pos_x
 >> 1);

146 
b4
 = 2*(
pos_y
 & 0x01Ë+ (
pos_x
 & 0x01);

148 
	`öô_åñlis_d©a_4x4_CAVLC
(
cuºMB
, 
tblock
, 
block_x
, 
qp_≥r
, 
qp_ªm
, 
q_∑øms_4x4
, 
p_sˇn
, &
ÀvñD©a
[0], 
ty≥
);

149 
	`e°_RunLevñ_CAVLC
(
cuºMB
, 
ÀvñD©a
, 
ÀvñTªŒis
, 
LUMA
, 
b8
, 
b4
, 16, 
œmbda_md
);

150 
	}
}

159 
	$rdoq_4x4_CABAC
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qu™t_mëhods
 *
q_mëhod
, 
ÀvñTªŒis
[])

161 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

163 c⁄° 
	`byã
 (*
pos_sˇn
)[2] = 
q_mëhod
->pos_scan;

164 c⁄° 
byã
 *
p_sˇn
 = &
pos_sˇn
[0][0];

166 
ÀvñD©aSåu˘
 
ÀvñD©a
[16];

167 
kSèπ
=0, 
kSt›
=0, 
noC€ff
 = 0, 
e°Bôs
;

169 
œmbda_md
 = 
p_Vid
->
œmbda_rdoq
[p_Vid->
ty≥
][p_Vid->
ma°îQP
];

171 
noC€ff
 = 
	`öô_åñlis_d©a_4x4_CABAC
(
cuºMB
, 
tblock
, 
q_mëhod
, 
p_sˇn
, &
ÀvñD©a
[0], &
kSèπ
, &
kSt›
, 
LUMA_4x4
);

172 
e°Bôs
 = 
	`e°_wrôe_™d_°‹e_CBP_block_bô
(
cuºMB
, 
LUMA_4x4
);

173 
	`e°_wrôeRunLevñ_CABAC
(
cuºMB
, 
ÀvñD©a
, 
ÀvñTªŒis
, 
LUMA_4x4
, 
œmbda_md
, 
kSèπ
, 
kSt›
, 
noC€ff
, 
e°Bôs
);

174 
	}
}

183 
	$qu™t_ac4x4_åñlis
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qu™t_mëhods
 *
q_mëhod
)

185 
block_x
 = 
q_mëhod
->block_x;

187 * 
ACLevñ
 = 
q_mëhod
->ACLevel;

188 * 
ACRun
 = 
q_mëhod
->ACRun;

189 
qp
 = 
q_mëhod
->qp;

190 
LevñQu™tP¨ams
 **
q_∑øms_4x4
 = 
q_mëhod
->
q_∑øms
;

191 c⁄° 
	`byã
 (*
pos_sˇn
)[2] = 
q_mëhod
->pos_scan;

192 c⁄° 
byã
 *
c_co°
 = 
q_mëhod
->c_cost;

193 *
c€ff_co°
 = 
q_mëhod
->coeff_cost;

195 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

196 
Qu™tP¨amëîs
 *
p_Qu™t
 = 
cuºMB
->
p_Vid
->p_Quant;

197 
Boﬁón
 
is_ˇvlc
 = (BoﬁónË(
cuºSli˚
->
symbﬁ_mode
 =
CAVLC
);

198 
i
,
j
, 
c€ff_˘r
;

200 *
m7
;

201 
Àvñ
, 
run
 = 0;

202 
n⁄zîo
 = 
FALSE
;

203 
qp_≥r
 = 
p_Qu™t
->
qp_≥r_m©rix
[
qp
];

204 c⁄° 
byã
 *
p_sˇn
 = &
pos_sˇn
[1][0];

205 * 
ACL
 = &
ACLevñ
[0];

206 * 
ACR
 = &
ACRun
[0];

208 
ÀvñTªŒis
[16];

210 
cuºSli˚
->
	`rdoq_ac4x4
(
cuºMB
, 
tblock
, 
q_mëhod
, 
ÀvñTªŒis
);

213 
c€ff_˘r
 = 1; coeff_ctr < 16; coeff_ctr++)

215 
i
 = *
p_sˇn
++;

216 
j
 = *
p_sˇn
++;

218 
m7
 = &
tblock
[
j
][
block_x
 + 
i
];

219 i‡(*
m7
 != 0)

225 
Àvñ
=
ÀvñTªŒis
[
c€ff_˘r
 - 1];

227 i‡(
Àvñ
 != 0)

229 i‡(
is_ˇvlc
)

230 
Àvñ
 = 
	`imö
÷evñ, 
CAVLC_LEVEL_LIMIT
);

232 *
c€ff_co°
 +(
Àvñ
 > 1Ë? 
MAX_VALUE
 : 
c_co°
[
run
];

234 
Àvñ
 = 
	`isig«b
÷evñ, *
m7
);

235 *
m7
 = 
	`rshi·_∫d_sf
(((
Àvñ
 * 
q_∑øms_4x4
[
j
][
i
].
InvSˇÀComp
Ë<< 
qp_≥r
), 4);

239 *
ACL
++ = 
Àvñ
;

240 *
ACR
++ = 
run
;

242 
run
 = 0;

243 
n⁄zîo
 = 
TRUE
;

247 
run
++;

248 *
m7
 = 0;

253 
run
++;

257 *
ACL
 = 0;

259  
n⁄zîo
;

260 
	}
}

270 
	$rdoq_ac4x4_CAVLC
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qu™t_mëhods
 *
q_mëhod
, 
ÀvñTªŒis
[])

272 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

273 
block_x
 = 
q_mëhod
->block_x;

274 
block_y
 = 
q_mëhod
->block_y;

275 
LevñQu™tP¨ams
 **
q_∑øms_4x4
 = 
q_mëhod
->
q_∑øms
;

276 c⁄° 
	`byã
 (*
pos_sˇn
)[2] = 
q_mëhod
->pos_scan;

277 
qp
 = 
q_mëhod
->qp;

278 
ty≥
 = 
q_mëhod
->type;

279 
Qu™tP¨amëîs
 *
p_Qu™t
 = 
p_Vid
->p_Quant;

280 
qp_≥r
 = 
p_Qu™t
->
qp_≥r_m©rix
[
qp
];

281 
qp_ªm
 = 
p_Qu™t
->
qp_ªm_m©rix
[
qp
];

283 c⁄° 
byã
 *
p_sˇn
 = &
pos_sˇn
[1][0];

284 
ÀvñD©aSåu˘
 
ÀvñD©a
[16];

285 
œmbda_md
 = 
p_Vid
->
œmbda_rdoq
[p_Vid->
ty≥
][p_Vid->
ma°îQP
];

287 
pos_x
 = 
block_x
 >> 
BLOCK_SHIFT
;

288 
pos_y
 = 
block_y
 >> 
BLOCK_SHIFT
;

289 
b8
 = 2*(
pos_y
 >> 1Ë+ (
pos_x
 >> 1);

290 
b4
 = 2*(
pos_y
 & 0x01Ë+ (
pos_x
 & 0x01);

291 
block_ty≥
 = ( (
ty≥
 =
CHROMA_AC
Ë? CHROMA_AC : 
LUMA_INTRA16x16AC
);

293 
	`öô_åñlis_d©a_4x4_CAVLC
(
cuºMB
, 
tblock
, 
block_x
, 
qp_≥r
, 
qp_ªm
, 
q_∑øms_4x4
, 
p_sˇn
, &
ÀvñD©a
[0], 
ty≥
);

294 
	`e°_RunLevñ_CAVLC
(
cuºMB
, 
ÀvñD©a
, 
ÀvñTªŒis
, 
block_ty≥
, 
b8
, 
b4
, 15, 
œmbda_md
);

295 
	}
}

304 
	$rdoq_ac4x4_CABAC
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qu™t_mëhods
 *
q_mëhod
, 
ÀvñTªŒis
[])

306 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

308 c⁄° 
	`byã
 (*
pos_sˇn
)[2] = 
q_mëhod
->pos_scan;

309 
ty≥
 = 
q_mëhod
->type;

311 c⁄° 
byã
 *
p_sˇn
 = &
pos_sˇn
[1][0];

312 
ÀvñD©aSåu˘
 
ÀvñD©a
[16];

313 
œmbda_md
 = 
p_Vid
->
œmbda_rdoq
[p_Vid->
ty≥
][p_Vid->
ma°îQP
];

314 
kSèπ
 = 0, 
kSt›
 = 0, 
noC€ff
 = 0, 
e°Bôs
;

316 
noC€ff
 = 
	`öô_åñlis_d©a_4x4_CABAC
(
cuºMB
, 
tblock
, 
q_mëhod
, 
p_sˇn
, &
ÀvñD©a
[0], &
kSèπ
, &
kSt›
, 
ty≥
);

317 
e°Bôs
 = 
	`e°_wrôe_™d_°‹e_CBP_block_bô
(
cuºMB
, 
ty≥
);

318 
	`e°_wrôeRunLevñ_CABAC
(
cuºMB
, 
ÀvñD©a
, 
ÀvñTªŒis
, 
ty≥
, 
œmbda_md
, 
kSèπ
, 
kSt›
, 
noC€ff
, 
e°Bôs
);

319 
	}
}

328 
qu™t_dc4x4_åñlis
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qp
, * 
DCLevñ
, * 
DCRun
,

329 
LevñQu™tP¨ams
 *
q_∑øms_4x4
, c⁄° 
byã
 (*
pos_sˇn
)[2])

331 
Sli˚
 *
	gcuºSli˚
 = 
cuºMB
->
p_Sli˚
;

332 
Qu™tP¨amëîs
 *
	gp_Qu™t
 = 
cuºMB
->
p_Vid
->
p_Qu™t
;

333 
Boﬁón
 
	gis_ˇvlc
 = (BoﬁónË(
cuºSli˚
->
symbﬁ_mode
 =
CAVLC
);

334 
	gi
,
	gj
, 
	gc€ff_˘r
;

336 *
	gm7
;

338 
	gÀvñ
, 
	grun
 = 0;

339 
	gn⁄zîo
 = 
FALSE
;

340 
	gqp_≥r
 = 
p_Qu™t
->
qp_≥r_m©rix
[
qp
];

341 
	gqp_ªm
 = 
p_Qu™t
->
qp_ªm_m©rix
[
qp
];

342 c⁄° 
byã
 *
	gp_sˇn
 = &
pos_sˇn
[0][0];

343 * 
	gDCL
 = &
DCLevñ
[0];

344 * 
	gDCR
 = &
DCRun
[0];

346 
	gÀvñTªŒis
[16];

348 
	gcuºSli˚
->
rdoq_dc
(
cuºMB
, 
tblock
, 
qp_≥r
, 
qp_ªm
, 
q_∑øms_4x4
, 
pos_sˇn
, 
ÀvñTªŒis
, 
LUMA_16DC
);

351 
	gc€ff_˘r
 = 0; coeff_ctr < 16; coeff_ctr++)

353 
	gi
 = *
p_sˇn
++;

354 
	gj
 = *
p_sˇn
++;

356 
	gm7
 = &
tblock
[
j
][
i
];

358 i‡(*
	gm7
 != 0)

360 
Àvñ
 = 
ÀvñTªŒis
[
c€ff_˘r
];

362 i‡(
	gÀvñ
 != 0)

364 i‡(
is_ˇvlc
)

365 
Àvñ
 = 
imö
÷evñ, 
CAVLC_LEVEL_LIMIT
);

367 
	gÀvñ
 = 
isig«b
(
Àvñ
, *
m7
);

368 *
	gm7
 = 
Àvñ
;

369 *
	gDCL
++ = 
Àvñ
;

370 *
	gDCR
++ = 
run
;

372 
	grun
 = 0;

373 
	gn⁄zîo
 = 
TRUE
;

377 
	grun
++;

378 *
	gm7
 = 0;

383 
	grun
++;

387 *
	gDCL
 = 0;

389  
	gn⁄zîo
;

400 
rdoq_dc_CAVLC
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qp_≥r
, 
qp_ªm
, 
LevñQu™tP¨ams
 *
q_∑øms_4x4
,

401 c⁄° 
byã
 (*
pos_sˇn
)[2], 
ÀvñTªŒis
[], 
ty≥
)

403 
VideoP¨amëîs
 *
	gp_Vid
 = 
cuºMB
->
p_Vid
;

404 c⁄° 
byã
 *
	gp_sˇn
 = &
pos_sˇn
[0][0];

405 
ÀvñD©aSåu˘
 
	gÀvñD©a
[16];

406 
	gœmbda_md
 = 
p_Vid
->
œmbda_rdoq
[p_Vid->
ty≥
][p_Vid->
ma°îQP
];

408 
öô_åñlis_d©a_DC_CAVLC
(
cuºMB
, 
tblock
, 
qp_≥r
, 
qp_ªm
, 
q_∑øms_4x4
, 
p_sˇn
, &
ÀvñD©a
[0]);

409 
e°_RunLevñ_CAVLC
(
cuºMB
, 
ÀvñD©a
, 
ÀvñTªŒis
, 
LUMA_INTRA16x16DC
, 0, 0, 16, 
œmbda_md
);

421 
rdoq_dc_CABAC
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qp_≥r
, 
qp_ªm
, 
LevñQu™tP¨ams
 *
q_∑øms_4x4
, c⁄° 
byã
 (*
pos_sˇn
)[2], 
ÀvñTªŒis
[], 
ty≥
)

423 
VideoP¨amëîs
 *
	gp_Vid
 = 
cuºMB
->
p_Vid
;

424 c⁄° 
byã
 *
	gp_sˇn
 = &
pos_sˇn
[0][0];

425 
ÀvñD©aSåu˘
 
	gÀvñD©a
[16];

426 
	gœmbda_md
 = 
p_Vid
->
œmbda_rdoq
[p_Vid->
ty≥
][p_Vid->
ma°îQP
];

427 
	gkSèπ
 = 0, 
	gkSt›
 = 0, 
	gnoC€ff
 = 0, 
	ge°Bôs
;

429 
	gnoC€ff
 = 
öô_åñlis_d©a_DC_CABAC
(
cuºMB
, 
tblock
, 
qp_≥r
, 
qp_ªm
, 
q_∑øms_4x4
, 
p_sˇn
, &
ÀvñD©a
[0], &
kSèπ
, &
kSt›
);

430 
	ge°Bôs
 = 
e°_wrôe_™d_°‹e_CBP_block_bô
(
cuºMB
, 
ty≥
);

431 
e°_wrôeRunLevñ_CABAC
(
cuºMB
, 
ÀvñD©a
, 
ÀvñTªŒis
, 
ty≥
, 
œmbda_md
, 
kSèπ
, 
kSt›
, 
noC€ff
, 
e°Bôs
);

	@lencod/src/quant8x8.c

16 
	~"c⁄åibut‹s.h
"

18 
	~<m©h.h
>

20 
	~"globÆ.h
"

21 
	~"qu™t8x8.h
"

31 
	$öô_qu™t_8x8
(
Sli˚
 *
cuºSli˚
)

33 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

35 i‡(
cuºSli˚
->
U£RDOQu™t
 == 1)

37 
cuºSli˚
->
qu™t_8x8
 = 
qu™t_8x8_åñlis
;

38 
cuºSli˚
->
qu™t_8x8ˇvlc
 = 
qu™t_8x8ˇvlc_åñlis
;

40 i‡(
p_Vid
->
Ad≠tiveRoundög
)

42 
cuºSli˚
->
qu™t_8x8
 = 
qu™t_8x8_¨ound
;

43 
cuºSli˚
->
qu™t_8x8ˇvlc
 = 
qu™t_8x8ˇvlc_¨ound
;

47 
cuºSli˚
->
qu™t_8x8
 = 
qu™t_8x8_n‹mÆ
;

48 
cuºSli˚
->
qu™t_8x8ˇvlc
 = 
qu™t_8x8ˇvlc_n‹mÆ
;

50 
	}
}

	@lencod/src/quant8x8_around.c

16 
	~"c⁄åibut‹s.h
"

18 
	~<m©h.h
>

20 
	~"globÆ.h
"

22 
	~"image.h
"

23 
	~"mb_ac˚ss.h
"

24 
	~"vlc.h
"

25 
	~"å™sf‹m.h
"

26 
	~"mc_¥edi˘i⁄.h
"

27 
	~"q_off£ts.h
"

28 
	~"q_m©rix.h
"

29 
	~"qu™t8x8.h
"

43 
	$qu™t_8x8_¨ound
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qu™t_mëhods
 *
q_mëhod
)

45 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

46 
Qu™tP¨amëîs
 *
p_Qu™t
 = 
p_Vid
->p_Quant;

47 
Ad≠tRndWeight
 = 
p_Vid
->AdaptRndWeight;

49 
block_x
 = 
q_mëhod
->block_x;

51 
qp
 = 
q_mëhod
->qp;

52 * 
ACLevñ
 = 
q_mëhod
->ACLevel;

53 * 
ACRun
 = 
q_mëhod
->ACRun;

54 
LevñQu™tP¨ams
 **
q_∑øms_8x8
 = 
q_mëhod
->
q_∑øms
;

55 
LevñQu™tP¨ams
 *
q_∑øms
 = 
NULL
;

57 **
Ádju°8x8
 = 
q_mëhod
->
Ádju°
;

58 c⁄° 
	`byã
 (*
pos_sˇn
)[2] = 
q_mëhod
->pos_scan;

59 c⁄° 
byã
 *
c_co°
 = 
q_mëhod
->c_cost;

60 *
c€ff_co°
 = 
q_mëhod
->coeff_cost;

62 
i
,
j
, 
c€ff_˘r
;

64 *
m7
;

65 
sˇÀd_c€ff
;

67 
Àvñ
, 
run
 = 0;

68 
n⁄zîo
 = 
FALSE
;

69 
qp_≥r
 = 
p_Qu™t
->
qp_≥r_m©rix
[
qp
];

70 
q_bôs
 = 
Q_BITS_8
 + 
qp_≥r
;

71 c⁄° 
byã
 *
p_sˇn
 = &
pos_sˇn
[0][0];

72 * 
ACL
 = &
ACLevñ
[0];

73 * 
ACR
 = &
ACRun
[0];

74 * 
∑dju°8x8
;

77 
c€ff_˘r
 = 0; coeff_ctr < 64; ++coeff_ctr)

79 
i
 = *
p_sˇn
++;

80 
j
 = *
p_sˇn
++;

82 
∑dju°8x8
 = &
Ádju°8x8
[
j
][
block_x
 + 
i
];

83 
m7
 = &
tblock
[
j
][
block_x
 + 
i
];

84 i‡(*
m7
 != 0)

86 
q_∑øms
 = &
q_∑øms_8x8
[
j
][
i
];

87 
sˇÀd_c€ff
 = 
	`übs
 (*
m7
Ë* 
q_∑øms
->
SˇÀComp
;

88 
Àvñ
 = (
sˇÀd_c€ff
 + 
q_∑øms
->
Off£tComp
Ë>> 
q_bôs
;

90 i‡(
Àvñ
 != 0)

92 *
∑dju°8x8
 = 
	`rshi·_∫d_sf
((
Ad≠tRndWeight
 * (
sˇÀd_c€ff
 - (
Àvñ
 << 
q_bôs
))), (q_bits + 1));

94 
n⁄zîo
 = 
TRUE
;

96 *
c€ff_co°
 +(
Àvñ
 > 1Ë? 
MAX_VALUE
 : 
c_co°
[
run
];

98 
Àvñ
 = 
	`isig«b
÷evñ, *
m7
);

99 *
m7
 = 
	`rshi·_∫d_sf
(((
Àvñ
 * 
q_∑øms
->
InvSˇÀComp
Ë<< 
qp_≥r
), 6);

100 *
ACL
++ = 
Àvñ
;

101 *
ACR
++ = 
run
;

103 
run
 = 0;

107 *
∑dju°8x8
 = 0;

108 ++
run
;

109 *
m7
 = 0;

114 *
∑dju°8x8
 = 0;

115 ++
run
;

119 *
ACL
 = 0;

121  
n⁄zîo
;

122 
	}
}

136 
	$qu™t_8x8ˇvlc_¨ound
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qu™t_mëhods
 *
q_mëhod
, *** 
cofAC
)

138 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

139 
Qu™tP¨amëîs
 *
p_Qu™t
 = 
p_Vid
->p_Quant;

140 
Ad≠tRndWeight
 = 
p_Vid
->AdaptRndWeight;

141 
block_x
 = 
q_mëhod
->block_x;

143 
qp
 = 
q_mëhod
->qp;

144 
LevñQu™tP¨ams
 **
q_∑øms_8x8
 = 
q_mëhod
->
q_∑øms
;

145 **
Ádju°8x8
 = 
q_mëhod
->
Ádju°
;

146 c⁄° 
	`byã
 (*
pos_sˇn
)[2] = 
q_mëhod
->pos_scan;

147 c⁄° 
byã
 *
c_co°
 = 
q_mëhod
->c_cost;

148 *
c€ff_co°
 = 
q_mëhod
->coeff_cost;

150 
i
,
j
, 
k
, 
c€ff_˘r
;

152 *
m7
;

153 
sˇÀd_c€ff
;

155 
Àvñ
, 
runs
[4] = { 0 };

156 
n⁄zîo
 = 
FALSE
;

157 
qp_≥r
 = 
p_Qu™t
->
qp_≥r_m©rix
[
qp
];

158 
q_bôs
 = 
Q_BITS_8
 + 
qp_≥r
;

159 c⁄° 
byã
 *
p_sˇn
 = &
pos_sˇn
[0][0];

160 * 
ACL
[4];

161 * 
ACR
[4];

162 * 
∑dju°8x8
;

164 
k
 = 0; k < 4; ++k)

166 
ACL
[
k
] = &
cofAC
[k][0][0];

167 
ACR
[
k
] = &
cofAC
[k][1][0];

171 
k
 = 0; k < 4; ++k)

173 
c€ff_˘r
 = 0; coeff_ctr < 16; ++coeff_ctr)

175 
i
 = *
p_sˇn
++;

176 
j
 = *
p_sˇn
++;

178 
∑dju°8x8
 = &
Ádju°8x8
[
j
][
block_x
 + 
i
];

179 
m7
 = &
tblock
[
j
][
block_x
 + 
i
];

180 i‡(*
m7
 != 0)

182 
sˇÀd_c€ff
 = 
	`übs
 (*
m7
Ë* 
q_∑øms_8x8
[
j
][
i
].
SˇÀComp
;

183 
Àvñ
 = (
sˇÀd_c€ff
 + 
q_∑øms_8x8
[
j
][
i
].
Off£tComp
Ë>> 
q_bôs
;

185 i‡(
Àvñ
 != 0)

187 
Àvñ
 = 
	`imö
÷evñ, 
CAVLC_LEVEL_LIMIT
);

189 *
∑dju°8x8
 = 
	`rshi·_∫d_sf
((
Ad≠tRndWeight
 * (
sˇÀd_c€ff
 - (
Àvñ
 << 
q_bôs
))), (q_bits + 1));

191 
n⁄zîo
=
TRUE
;

193 *
c€ff_co°
 +(
Àvñ
 > 1Ë? 
MAX_VALUE
 : 
c_co°
[
runs
[
k
]];

195 
Àvñ
 = 
	`isig«b
÷evñ, *
m7
);

196 *
m7
 = 
	`rshi·_∫d_sf
(((
Àvñ
 * 
q_∑øms_8x8
[
j
][
i
].
InvSˇÀComp
Ë<< 
qp_≥r
), 6);

198 *(
ACL
[
k
])++ = 
Àvñ
;

199 *(
ACR
[
k
])++ = 
runs
[k];

201 
runs
[
k
] = 0;

205 *
∑dju°8x8
 = 0;

206 *
m7
 = 0;

207 ++
runs
[
k
];

212 *
∑dju°8x8
 = 0;

213 ++
runs
[
k
];

218 
k
 = 0; k < 4; ++k)

219 *(
ACL
[
k
]) = 0;

221  
n⁄zîo
;

222 
	}
}

	@lencod/src/quant8x8_normal.c

16 
	~"c⁄åibut‹s.h
"

18 
	~<m©h.h
>

20 
	~"globÆ.h
"

22 
	~"image.h
"

23 
	~"mb_ac˚ss.h
"

24 
	~"vlc.h
"

25 
	~"å™sf‹m.h
"

26 
	~"mc_¥edi˘i⁄.h
"

27 
	~"q_off£ts.h
"

28 
	~"q_m©rix.h
"

29 
	~"qu™t8x8.h
"

43 
	$qu™t_8x8_n‹mÆ
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qu™t_mëhods
 *
q_mëhod
)

45 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

46 
Qu™tP¨amëîs
 *
p_Qu™t
 = 
p_Vid
->p_Quant;

47 
block_x
 = 
q_mëhod
->block_x;

48 * 
ACLevñ
 = 
q_mëhod
->ACLevel;

49 * 
ACRun
 = 
q_mëhod
->ACRun;

50 
qp
 = 
q_mëhod
->qp;

51 
LevñQu™tP¨ams
 **
q_∑øms_8x8
 = 
q_mëhod
->
q_∑øms
;

52 c⁄° 
	`byã
 (*
pos_sˇn
)[2] = 
q_mëhod
->pos_scan;

53 c⁄° 
byã
 *
c_co°
 = 
q_mëhod
->c_cost;

54 *
c€ff_co°
 = 
q_mëhod
->coeff_cost;

56 
i
,
j
, 
c€ff_˘r
;

58 *
m7
;

59 
sˇÀd_c€ff
;

61 
Àvñ
, 
run
 = 0;

62 
n⁄zîo
 = 
FALSE
;

63 
qp_≥r
 = 
p_Qu™t
->
qp_≥r_m©rix
[
qp
];

64 
q_bôs
 = 
Q_BITS_8
 + 
qp_≥r
;

65 c⁄° 
byã
 *
p_sˇn
 = &
pos_sˇn
[0][0];

66 * 
ACL
 = &
ACLevñ
[0];

67 * 
ACR
 = &
ACRun
[0];

70 
c€ff_˘r
 = 0; coeff_ctr < 64; coeff_ctr++)

72 
i
 = *
p_sˇn
++;

73 
j
 = *
p_sˇn
++;

75 
m7
 = &
tblock
[
j
][
block_x
 + 
i
];

76 i‡(*
m7
 != 0)

78 
sˇÀd_c€ff
 = 
	`übs
 (*
m7
Ë* 
q_∑øms_8x8
[
j
][
i
].
SˇÀComp
;

79 
Àvñ
 = (
sˇÀd_c€ff
 + 
q_∑øms_8x8
[
j
][
i
].
Off£tComp
Ë>> 
q_bôs
;

81 i‡(
Àvñ
 != 0)

83 
n⁄zîo
 = 
TRUE
;

85 *
c€ff_co°
 +(
Àvñ
 > 1Ë? 
MAX_VALUE
 : 
c_co°
[
run
];

87 
Àvñ
 = 
	`isig«b
÷evñ, *
m7
);

88 *
m7
 = 
	`rshi·_∫d_sf
(((
Àvñ
 * 
q_∑øms_8x8
[
j
][
i
].
InvSˇÀComp
Ë<< 
qp_≥r
), 6);

89 *
ACL
++ = 
Àvñ
;

90 *
ACR
++ = 
run
;

92 
run
 = 0;

96 
run
++;

97 *
m7
 = 0;

102 
run
++;

106 *
ACL
 = 0;

108  
n⁄zîo
;

109 
	}
}

123 
	$qu™t_8x8ˇvlc_n‹mÆ
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qu™t_mëhods
 *
q_mëhod
, *** 
cofAC
)

125 
Qu™tP¨amëîs
 *
p_Qu™t
 = 
cuºMB
->
p_Vid
->p_Quant;

126 
block_x
 = 
q_mëhod
->block_x;

128 
qp
 = 
q_mëhod
->qp;

129 
LevñQu™tP¨ams
 **
q_∑øms_8x8
 = 
q_mëhod
->
q_∑øms
;

130 c⁄° 
	`byã
 (*
pos_sˇn
)[2] = 
q_mëhod
->pos_scan;

131 c⁄° 
byã
 *
c_co°
 = 
q_mëhod
->c_cost;

132 *
c€ff_co°
 = 
q_mëhod
->coeff_cost;

135 
i
,
j
, 
k
, 
c€ff_˘r
;

137 *
m7
;

138 
sˇÀd_c€ff
;

140 
Àvñ
, 
runs
[4] = { 0 };

141 
n⁄zîo
 = 
FALSE
;

142 
qp_≥r
 = 
p_Qu™t
->
qp_≥r_m©rix
[
qp
];

143 
q_bôs
 = 
Q_BITS_8
 + 
qp_≥r
;

144 c⁄° 
byã
 *
p_sˇn
 = &
pos_sˇn
[0][0];

145 * 
ACL
[4];

146 * 
ACR
[4];

148 
k
 = 0; k < 4; k++)

150 
ACL
[
k
] = &
cofAC
[k][0][0];

151 
ACR
[
k
] = &
cofAC
[k][1][0];

155 
k
 = 0; k < 4; k++)

157 
c€ff_˘r
 = 0; coeff_ctr < 16; coeff_ctr++)

159 
i
 = *
p_sˇn
++;

160 
j
 = *
p_sˇn
++;

162 
m7
 = &
tblock
[
j
][
block_x
 + 
i
];

163 i‡(*
m7
 != 0)

165 
sˇÀd_c€ff
 = 
	`übs
 (*
m7
Ë* 
q_∑øms_8x8
[
j
][
i
].
SˇÀComp
;

166 
Àvñ
 = (
sˇÀd_c€ff
 + 
q_∑øms_8x8
[
j
][
i
].
Off£tComp
Ë>> 
q_bôs
;

168 i‡(
Àvñ
 != 0)

170 
Àvñ
 = 
	`imö
÷evñ, 
CAVLC_LEVEL_LIMIT
);

172 
n⁄zîo
=
TRUE
;

174 *
c€ff_co°
 +(
Àvñ
 > 1Ë? 
MAX_VALUE
 : 
c_co°
[
runs
[
k
]];

176 
Àvñ
 = 
	`isig«b
÷evñ, *
m7
);

177 *
m7
 = 
	`rshi·_∫d_sf
(((
Àvñ
 * 
q_∑øms_8x8
[
j
][
i
].
InvSˇÀComp
Ë<< 
qp_≥r
), 6);

179 *(
ACL
[
k
])++ = 
Àvñ
;

180 *(
ACR
[
k
])++ = 
runs
[k];

182 
runs
[
k
] = 0;

186 
runs
[
k
]++;

187 *
m7
 = 0;

192 
runs
[
k
]++;

197 
k
 = 0; k < 4; k++)

198 *(
ACL
[
k
]) = 0;

200  
n⁄zîo
;

201 
	}
}

	@lencod/src/quant8x8_trellis.c

15 
	~"c⁄åibut‹s.h
"

17 
	~<m©h.h
>

19 
	~"globÆ.h
"

20 
	~"image.h
"

21 
	~"mb_ac˚ss.h
"

22 
	~"vlc.h
"

23 
	~"å™sf‹m.h
"

24 
	~"mc_¥edi˘i⁄.h
"

25 
	~"q_off£ts.h
"

26 
	~"q_m©rix.h
"

27 
	~"qu™t8x8.h
"

28 
	~"rdoq.h
"

38 
	$rdoq_8x8_CABAC
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
block_x
,
qp_≥r
, 
qp_ªm
,

39 
LevñQu™tP¨ams
 **
q_∑øms_8x8
, c⁄° 
byã
 *
p_sˇn
, 
ÀvñTªŒis
[64])

41 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

42 
ÀvñD©aSåu˘
 
ÀvñD©a
[64];

43 
œmbda_md
 = 0.0;

44 
kSèπ
 = 0, 
kSt›
 = 0, 
noC€ff
 = 0;

46 
œmbda_md
 = 
p_Vid
->
œmbda_rdoq
[p_Vid->
ty≥
][p_Vid->
ma°îQP
];

48 
noC€ff
 = 
	`öô_åñlis_d©a_8x8_CABAC
(
cuºMB
, 
tblock
, 
block_x
, 
qp_≥r
, 
qp_ªm
, 
q_∑øms_8x8
, 
p_sˇn
, &
ÀvñD©a
[0], &
kSèπ
, &
kSt›
);

49 
	`e°_wrôeRunLevñ_CABAC
(
cuºMB
, 
ÀvñD©a
, 
ÀvñTªŒis
, 
LUMA_8x8
, 
œmbda_md
, 
kSèπ
, 
kSt›
, 
noC€ff
, 0);

50 
	}
}

60 
	$rdoq_8x8_CAVLC
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
block_y
, 
block_x
, 
qp_≥r
, 
qp_ªm
,

61 
LevñQu™tP¨ams
 **
q_∑øms_8x8
, c⁄° 
byã
 *
p_sˇn
, 
ÀvñTªŒis
[4][16])

63 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

64 
k
;

65 
ÀvñD©aSåu˘
 
ÀvñD©a
[4][16];

66 
œmbda_md
 = 0.0;

68 
b8
 = ((
block_y
 >> 3Ë<< 1Ë+ (
block_x
 >> 3);

70 
œmbda_md
 = 
p_Vid
->
œmbda_rdoq
[p_Vid->
ty≥
][p_Vid->
ma°îQP
];

72 
	`öô_åñlis_d©a_8x8_CAVLC
 (
cuºMB
, 
tblock
, 
block_x
, 
qp_≥r
, 
qp_ªm
, 
q_∑øms_8x8
, 
p_sˇn
, 
ÀvñD©a
);

74 
k
 = 0; k < 4; k++)

75 
	`e°_RunLevñ_CAVLC
(
cuºMB
, 
ÀvñD©a
[
k
], 
ÀvñTªŒis
[k], 
LUMA
, 
b8
, k, 16, 
œmbda_md
);

76 
	}
}

90 
	$qu™t_8x8_åñlis
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qu™t_mëhods
 *
q_mëhod
)

92 
Qu™tP¨amëîs
 *
p_Qu™t
 = 
cuºMB
->
p_Vid
->p_Quant;

93 
block_x
 = 
q_mëhod
->block_x;

94 
qp
 = 
q_mëhod
->qp;

95 * 
ACLevñ
 = 
q_mëhod
->ACLevel;

96 * 
ACRun
 = 
q_mëhod
->ACRun;

97 
LevñQu™tP¨ams
 **
q_∑øms_8x8
 = 
q_mëhod
->
q_∑øms
;

98 c⁄° 
	`byã
 (*
pos_sˇn
)[2] = 
q_mëhod
->pos_scan;

99 c⁄° 
byã
 *
c_co°
 = 
q_mëhod
->c_cost;

100 *
c€ff_co°
 = 
q_mëhod
->coeff_cost;

102 
i
,
j
, 
c€ff_˘r
;

104 *
m7
;

105 
Àvñ
, 
run
 = 0;

106 
n⁄zîo
 = 
FALSE
;

107 
qp_≥r
 = 
p_Qu™t
->
qp_≥r_m©rix
[
qp
];

108 
qp_ªm
 = 
p_Qu™t
->
qp_ªm_m©rix
[
qp
];

109 c⁄° 
byã
 *
p_sˇn
 = &
pos_sˇn
[0][0];

110 * 
ACL
 = &
ACLevñ
[0];

111 * 
ACR
 = &
ACRun
[0];

112 
ÀvñTªŒis
[64];

114 
	`rdoq_8x8_CABAC
(
cuºMB
, 
tblock
, 
block_x
, 
qp_≥r
, 
qp_ªm
, 
q_∑øms_8x8
, 
p_sˇn
, 
ÀvñTªŒis
);

117 
c€ff_˘r
 = 0; coeff_ctr < 64; coeff_ctr++)

119 
i
 = *
p_sˇn
++;

120 
j
 = *
p_sˇn
++;

122 
m7
 = &
tblock
[
j
][
block_x
 + 
i
];

123 i‡(*
m7
 != 0)

125 
Àvñ
 = 
ÀvñTªŒis
[
c€ff_˘r
];

127 i‡(
Àvñ
 != 0)

129 
n⁄zîo
 = 
TRUE
;

131 *
c€ff_co°
 +(
Àvñ
 > 1Ë? 
MAX_VALUE
 : 
c_co°
[
run
];

133 
Àvñ
 = 
	`isig«b
÷evñ, *
m7
);

134 *
m7
 = 
	`rshi·_∫d_sf
(((
Àvñ
 * 
q_∑øms_8x8
[
j
][
i
].
InvSˇÀComp
Ë<< 
qp_≥r
), 6);

135 *
ACL
++ = 
Àvñ
;

136 *
ACR
++ = 
run
;

138 
run
 = 0;

142 
run
++;

143 *
m7
 = 0;

148 
run
++;

152 *
ACL
 = 0;

154  
n⁄zîo
;

155 
	}
}

169 
	$qu™t_8x8ˇvlc_åñlis
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qu™t_mëhods
 *
q_mëhod
, *** 
cofAC
)

171 
Qu™tP¨amëîs
 *
p_Qu™t
 = 
cuºMB
->
p_Vid
->p_Quant;

172 
block_x
 = 
q_mëhod
->block_x;

173 
block_y
 = 
q_mëhod
->block_y;

174 
qp
 = 
q_mëhod
->qp;

175 
LevñQu™tP¨ams
 **
q_∑øms_8x8
 = 
q_mëhod
->
q_∑øms
;

176 c⁄° 
	`byã
 (*
pos_sˇn
)[2] = 
q_mëhod
->pos_scan;

177 c⁄° 
byã
 *
c_co°
 = 
q_mëhod
->c_cost;

178 *
c€ff_co°
 = 
q_mëhod
->coeff_cost;

180 
i
,
j
, 
k
, 
c€ff_˘r
;

182 *
m7
;

183 
Àvñ
, 
runs
[4] = { 0 };

184 
n⁄zîo
 = 
FALSE
;

185 
qp_≥r
 = 
p_Qu™t
->
qp_≥r_m©rix
[
qp
];

186 
qp_ªm
 = 
p_Qu™t
->
qp_ªm_m©rix
[
qp
];

187 c⁄° 
byã
 *
p_sˇn
 = &
pos_sˇn
[0][0];

188 * 
ACL
[4];

189 * 
ACR
[4];

191 
ÀvñTªŒis
[4][16];

193 
	`rdoq_8x8_CAVLC
(
cuºMB
, 
tblock
, 
block_y
, 
block_x
, 
qp_≥r
, 
qp_ªm
, 
q_∑øms_8x8
, 
p_sˇn
, 
ÀvñTªŒis
);

195 
k
 = 0; k < 4; k++)

197 
ACL
[
k
] = &
cofAC
[k][0][0];

198 
ACR
[
k
] = &
cofAC
[k][1][0];

202 
k
 = 0; k < 4; k++)

204 
c€ff_˘r
 = 0; coeff_ctr < 16; coeff_ctr++)

206 
i
 = *
p_sˇn
++;

207 
j
 = *
p_sˇn
++;

209 
m7
 = &
tblock
[
j
][
block_x
 + 
i
];

211 i‡(
m7
 != 0)

213 
Àvñ
 = 
ÀvñTªŒis
[
k
][
c€ff_˘r
];

215 i‡(
Àvñ
 != 0)

217 
n⁄zîo
=
TRUE
;

219 *
c€ff_co°
 +(
Àvñ
 > 1Ë? 
MAX_VALUE
 : 
c_co°
[
runs
[
k
]];

221 
Àvñ
 = 
	`isig«b
÷evñ, *
m7
);

222 *
m7
 = 
	`rshi·_∫d_sf
(((
Àvñ
 * 
q_∑øms_8x8
[
j
][
i
].
InvSˇÀComp
Ë<< 
qp_≥r
), 6);

224 *(
ACL
[
k
])++ = 
Àvñ
;

225 *(
ACR
[
k
])++ = 
runs
[k];

227 
runs
[
k
] = 0;

231 
runs
[
k
]++;

232 *
m7
 = 0;

237 
runs
[
k
]++;

242 
k
 = 0; k < 4; k++)

243 *(
ACL
[
k
]) = 0;

245  
n⁄zîo
;

246 
	}
}

	@lencod/src/quantChroma.c

16 
	~"c⁄åibut‹s.h
"

18 
	~"globÆ.h
"

19 
	~"qu™t4x4.h
"

20 
	~"qu™tChroma.h
"

29 
	$öô_qu™t_Chroma
(
Sli˚
 *
cuºSli˚
)

31 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

32 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºSli˚
->p_Inp;

34 i‡(
p_I≈
->
U£RDOQu™t
 =1 &&Ö_I≈->
RDOQ_CR
 == 1)

36 
cuºSli˚
->
qu™t_ac4x4¸
 = 
qu™t_ac4x4_åñlis
;

37 i‡(
p_I≈
->
RDOQ_DC_CR
)

39 i‡(
p_Vid
->
yuv_f‹m©
 =
YUV422
)

40 
cuºSli˚
->
qu™t_dc_¸
 = 
qu™t_dc4x2_åñlis
;

42 
cuºSli˚
->
qu™t_dc_¸
 = 
qu™t_dc2x2_åñlis
;

46 i‡(
p_Vid
->
yuv_f‹m©
 =
YUV422
)

47 
cuºSli˚
->
qu™t_dc_¸
 = 
qu™t_dc4x2_n‹mÆ
;

49 
cuºSli˚
->
qu™t_dc_¸
 = 
qu™t_dc2x2_n‹mÆ
;

51 i‡(
cuºSli˚
->
symbﬁ_mode
 =
CABAC
)

52 
cuºSli˚
->
rdoq_dc_¸
 = 
rdoq_dc_¸_CABAC
;

54 
cuºSli˚
->
rdoq_dc_¸
 = 
rdoq_dc_¸_CAVLC
;

56 i‡(
p_I≈
->
U£RDOQu™t
 =1 || (!(
cuºSli˚
->
p_Vid
)->
Ad≠tiveRoundög
))

58 
cuºSli˚
->
qu™t_ac4x4¸
 = 
qu™t_ac4x4_n‹mÆ
;

59 i‡(
p_Vid
->
yuv_f‹m©
 =
YUV422
)

60 
cuºSli˚
->
qu™t_dc_¸
 = 
qu™t_dc4x2_n‹mÆ
;

62 
cuºSli˚
->
qu™t_dc_¸
 = 
qu™t_dc2x2_n‹mÆ
;

66 
cuºSli˚
->
qu™t_ac4x4¸
 = 
qu™t_ac4x4_¨ound
;

67 i‡(
p_Vid
->
yuv_f‹m©
 =
YUV422
)

68 
cuºSli˚
->
qu™t_dc_¸
 = 
qu™t_dc4x2_¨ound
;

70 
cuºSli˚
->
qu™t_dc_¸
 = 
qu™t_dc2x2_¨ound
;

72 
	}
}

	@lencod/src/quantChroma_2step.c

16 
	~"c⁄åibut‹s.h
"

18 
	~<m©h.h
>

20 
	~"globÆ.h
"

21 
	~"q_m©rix.h
"

22 
	~"qu™t4x4.h
"

23 
	~"qu™tChroma.h
"

37 
qu™t_dc2x2_2°ï
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qp
, * 
DCLevñ
, * 
DCRun
,

38 
LevñQu™tP¨ams
 *
q_∑øms_4x4
, **
Ádju°
, c⁄° 
byã
 (*
pos_sˇn
)[2])

40 
Qu™tP¨amëîs
 *
	gp_Qu™t
 = 
cuºMB
->
p_Vid
->
p_Qu™t
;

41 
Boﬁón
 
	gis_ˇvlc
 = (BoﬁónË(
cuºMB
->
p_Sli˚
->
symbﬁ_mode
 =
CAVLC
);

42 
	gc€ff_˘r
;

44 *
	gm7
;

45 
	gsˇÀd_c€ff
;

47 
	gÀvñ
, 
	grun
 = 0;

48 
	gn⁄zîo
 = 
FALSE
;

49 
	gqp_≥r
 = 
p_Qu™t
->
qp_≥r_m©rix
[
qp
];

50 
	gq_bôs
 = 
Q_BITS
 + 
qp_≥r
 + 1;

52 * 
	gDCL
 = &
DCLevñ
[0];

53 * 
	gDCR
 = &
DCRun
[0];

55 
	gm7
 = *
tblock
;

58 
	gc€ff_˘r
=0; coeff_ctr < 4; coeff_ctr++)

62 i‡(*
	gm7
)

64 
	gsˇÀd_c€ff
 = 
übs
 (*
m7
Ë* 
q_∑øms_4x4
->
SˇÀComp
;

65 
	gÀvñ
 = (
sˇÀd_c€ff
 + (
q_∑øms_4x4
->
Off£tComp
 << 1ËË>> 
q_bôs
;

67 i‡(
	gÀvñ
 != 0)

69 i‡(
is_ˇvlc
)

70 
Àvñ
 = 
imö
÷evñ, 
CAVLC_LEVEL_LIMIT
);

72 
	gÀvñ
 = 
isig«b
(
Àvñ
, *
m7
);

74 *
	gm7
++ = ((
Àvñ
 * 
q_∑øms_4x4
->
InvSˇÀComp
Ë<< 
qp_≥r
);

76 *
	gDCL
++ = 
Àvñ
;

77 *
	gDCR
++ = 
run
;

78 
	grun
 = 0;

79 
	gn⁄zîo
 = 
TRUE
;

83 
	grun
++;

84 *
	gm7
++ = 0;

89 
	grun
++;

90 
	gm7
++;

94 *
	gDCL
 = 0;

96  
	gn⁄zîo
;

110 
qu™t_dc4x2_2°ï
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qp
, * 
DCLevñ
, * 
DCRun
,

111 
LevñQu™tP¨ams
 *
q_∑øms_4x4
, **
Ádju°
, c⁄° 
byã
 (*
pos_sˇn
)[2])

113 
Qu™tP¨amëîs
 *
	gp_Qu™t
 = 
cuºMB
->
p_Vid
->
p_Qu™t
;

114 
Boﬁón
 
	gis_ˇvlc
 = (BoﬁónË(
cuºMB
->
p_Sli˚
->
symbﬁ_mode
 =
CAVLC
);

115 
	gi
,
	gj
, 
	gc€ff_˘r
;

117 *
	gm7
;

118 
	gsˇÀd_c€ff
;

120 
	gÀvñ
, 
	grun
 = 0;

121 
	gn⁄zîo
 = 
FALSE
;

122 
	gqp_≥r
 = 
p_Qu™t
->
qp_≥r_m©rix
[
qp
];

123 
	gq_bôs
 = 
Q_BITS
 + 
qp_≥r
 + 1;

124 c⁄° 
byã
 *
	gp_sˇn
 = &
pos_sˇn
[0][0];

125 * 
	gDCL
 = &
DCLevñ
[0];

126 * 
	gDCR
 = &
DCRun
[0];

129 
	gc€ff_˘r
 = 0; coeff_ctr < 8; coeff_ctr++)

131 
	gj
 = *
p_sˇn
++;

132 
	gi
 = *
p_sˇn
++;

134 
	gm7
 = &
tblock
[
j
][
i
];

136 i‡(*
	gm7
 != 0)

138 
sˇÀd_c€ff
 = 
übs
 (*
m7
Ë* 
q_∑øms_4x4
->
SˇÀComp
;

139 
	gÀvñ
 = (
sˇÀd_c€ff
 + (
q_∑øms_4x4
->
Off£tComp
 << 1ËË>> 
q_bôs
;

141 i‡(
	gÀvñ
 != 0)

143 i‡(
is_ˇvlc
)

144 
Àvñ
 = 
imö
÷evñ, 
CAVLC_LEVEL_LIMIT
);

145 
	gÀvñ
 = 
isig«b
(
Àvñ
, *
m7
);

147 *
	gm7
 = ((
Àvñ
 * 
q_∑øms_4x4
->
InvSˇÀComp
Ë<< 
qp_≥r
);

149 *
	gDCL
++ = 
Àvñ
;

150 *
	gDCR
++ = 
run
;

152 
	grun
 = 0;

153 
	gn⁄zîo
 = 
TRUE
;

157 
	grun
++;

158 *
	gm7
 = 0;

163 
	grun
++;

167 *
	gDCL
 = 0;

169  
	gn⁄zîo
;

	@lencod/src/quantChroma_around.c

16 
	~"c⁄åibut‹s.h
"

18 
	~<m©h.h
>

20 
	~"globÆ.h
"

21 
	~"q_m©rix.h
"

22 
	~"qu™t4x4.h
"

23 
	~"qu™tChroma.h
"

37 
qu™t_dc2x2_¨ound
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qp
, * 
DCLevñ
, * 
DCRun
,

38 
LevñQu™tP¨ams
 *
q_∑øms_4x4
, **
Ádju°
, c⁄° 
byã
 (*
pos_sˇn
)[2])

40 
Qu™tP¨amëîs
 *
	gp_Qu™t
 = 
cuºMB
->
p_Vid
->
p_Qu™t
;

41 
Boﬁón
 
	gis_ˇvlc
 = (BoﬁónË(
cuºMB
->
p_Sli˚
->
symbﬁ_mode
 =
CAVLC
);

42 
	gc€ff_˘r
;

44 *
	gm7
;

45 
	gsˇÀd_c€ff
;

47 
	gÀvñ
, 
	grun
 = 0;

48 
	gn⁄zîo
 = 
FALSE
;

49 
	gqp_≥r
 = 
p_Qu™t
->
qp_≥r_m©rix
[
qp
];

50 
	gq_bôs
 = 
Q_BITS
 + 
qp_≥r
 + 1;

52 * 
	gDCL
 = &
DCLevñ
[0];

53 * 
	gDCR
 = &
DCRun
[0];

55 
	gm7
 = *
tblock
;

58 
	gc€ff_˘r
=0; coeff_ctr < 4; ++coeff_ctr)

62 i‡(*
	gm7
)

64 
	gsˇÀd_c€ff
 = 
übs
 (*
m7
Ë* 
q_∑øms_4x4
->
SˇÀComp
;

65 
	gÀvñ
 = (
sˇÀd_c€ff
 + (
q_∑øms_4x4
->
Off£tComp
 << 1ËË>> 
q_bôs
;

67 i‡(
	gÀvñ
 != 0)

69 i‡(
is_ˇvlc
)

70 
Àvñ
 = 
imö
÷evñ, 
CAVLC_LEVEL_LIMIT
);

72 
	gÀvñ
 = 
isig«b
(
Àvñ
, *
m7
);

74 *
	gm7
++ = ((
Àvñ
 * 
q_∑øms_4x4
->
InvSˇÀComp
Ë<< 
qp_≥r
);

76 *
	gDCL
++ = 
Àvñ
;

77 *
	gDCR
++ = 
run
;

79 
	grun
 = 0;

80 
	gn⁄zîo
 = 
TRUE
;

84 ++
	grun
;

85 *
	gm7
++ = 0;

90 ++
	grun
;

91 ++
	gm7
;

95 *
	gDCL
 = 0;

97  
	gn⁄zîo
;

111 
qu™t_dc4x2_¨ound
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qp
, * 
DCLevñ
, * 
DCRun
,

112 
LevñQu™tP¨ams
 *
q_∑øms_4x4
, **
Ádju°
, c⁄° 
byã
 (*
pos_sˇn
)[2])

114 
Qu™tP¨amëîs
 *
	gp_Qu™t
 = 
cuºMB
->
p_Vid
->
p_Qu™t
;

115 
Boﬁón
 
	gis_ˇvlc
 = (BoﬁónË(
cuºMB
->
p_Sli˚
->
symbﬁ_mode
 =
CAVLC
);

116 
	gi
,
	gj
, 
	gc€ff_˘r
;

118 *
	gm7
;

119 
	gsˇÀd_c€ff
;

121 
	gÀvñ
, 
	grun
 = 0;

122 
	gn⁄zîo
 = 
FALSE
;

123 
	gqp_≥r
 = 
p_Qu™t
->
qp_≥r_m©rix
[
qp
];

124 
	gq_bôs
 = 
Q_BITS
 + 
qp_≥r
 + 1;

125 c⁄° 
byã
 *
	gp_sˇn
 = &
pos_sˇn
[0][0];

126 * 
	gDCL
 = &
DCLevñ
[0];

127 * 
	gDCR
 = &
DCRun
[0];

130 
	gc€ff_˘r
 = 0; coeff_ctr < 8; ++coeff_ctr)

132 
	gj
 = *
p_sˇn
++;

133 
	gi
 = *
p_sˇn
++;

135 
	gm7
 = &
tblock
[
j
][
i
];

137 i‡(*
	gm7
 != 0)

139 
sˇÀd_c€ff
 = 
übs
 (*
m7
Ë* 
q_∑øms_4x4
->
SˇÀComp
;

140 
	gÀvñ
 = (
sˇÀd_c€ff
 + (
q_∑øms_4x4
->
Off£tComp
 << 1ËË>> 
q_bôs
;

142 i‡(
	gÀvñ
 != 0)

144 i‡(
is_ˇvlc
)

145 
Àvñ
 = 
imö
÷evñ, 
CAVLC_LEVEL_LIMIT
);

146 
	gÀvñ
 = 
isig«b
(
Àvñ
, *
m7
);

148 *
	gm7
 = ((
Àvñ
 * 
q_∑øms_4x4
->
InvSˇÀComp
Ë<< 
qp_≥r
);

150 *
	gDCL
++ = 
Àvñ
;

151 *
	gDCR
++ = 
run
;

153 
	grun
 = 0;

154 
	gn⁄zîo
 = 
TRUE
;

158 ++
	grun
;

159 *
	gm7
 = 0;

164 ++
	grun
;

168 *
	gDCL
 = 0;

170  
	gn⁄zîo
;

	@lencod/src/quantChroma_normal.c

16 
	~"c⁄åibut‹s.h
"

18 
	~<m©h.h
>

20 
	~"globÆ.h
"

21 
	~"q_m©rix.h
"

22 
	~"qu™t4x4.h
"

23 
	~"qu™tChroma.h
"

37 
qu™t_dc2x2_n‹mÆ
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qp
, * 
DCLevñ
, * 
DCRun
,

38 
LevñQu™tP¨ams
 *
q_∑øms_4x4
, **
Ádju°
, c⁄° 
byã
 (*
pos_sˇn
)[2])

40 
Qu™tP¨amëîs
 *
	gp_Qu™t
 = 
cuºMB
->
p_Vid
->
p_Qu™t
;

41 
Boﬁón
 
	gis_ˇvlc
 = (BoﬁónË(
cuºMB
->
p_Sli˚
->
symbﬁ_mode
 =
CAVLC
);

42 
	gc€ff_˘r
;

44 *
	gm7
;

45 
	gsˇÀd_c€ff
;

47 
	gÀvñ
, 
	grun
 = 0;

48 
	gn⁄zîo
 = 
FALSE
;

49 
	gqp_≥r
 = 
p_Qu™t
->
qp_≥r_m©rix
[
qp
];

50 
	gq_bôs
 = 
Q_BITS
 + 
qp_≥r
 + 1;

52 * 
	gDCL
 = &
DCLevñ
[0];

53 * 
	gDCR
 = &
DCRun
[0];

55 
	gm7
 = *
tblock
;

58 
	gc€ff_˘r
=0; coeff_ctr < 4; coeff_ctr++)

62 i‡(*
	gm7
)

64 
	gsˇÀd_c€ff
 = 
übs
 (*
m7
Ë* 
q_∑øms_4x4
->
SˇÀComp
;

65 
	gÀvñ
 = (
sˇÀd_c€ff
 + (
q_∑øms_4x4
->
Off£tComp
 << 1ËË>> 
q_bôs
;

67 i‡(
	gÀvñ
 != 0)

69 i‡(
is_ˇvlc
)

70 
Àvñ
 = 
imö
÷evñ, 
CAVLC_LEVEL_LIMIT
);

72 
	gÀvñ
 = 
isig«b
(
Àvñ
, *
m7
);

74 *
	gm7
++ = ((
Àvñ
 * 
q_∑øms_4x4
->
InvSˇÀComp
Ë<< 
qp_≥r
);

76 *
	gDCL
++ = 
Àvñ
;

77 *
	gDCR
++ = 
run
;

78 
	grun
 = 0;

79 
	gn⁄zîo
 = 
TRUE
;

83 
	grun
++;

84 *
	gm7
++ = 0;

89 
	grun
++;

90 
	gm7
++;

94 *
	gDCL
 = 0;

96  
	gn⁄zîo
;

110 
qu™t_dc4x2_n‹mÆ
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qp
, * 
DCLevñ
, * 
DCRun
,

111 
LevñQu™tP¨ams
 *
q_∑øms_4x4
, **
Ádju°
, c⁄° 
byã
 (*
pos_sˇn
)[2])

113 
Qu™tP¨amëîs
 *
	gp_Qu™t
 = 
cuºMB
->
p_Vid
->
p_Qu™t
;

114 
Boﬁón
 
	gis_ˇvlc
 = (BoﬁónË(
cuºMB
->
p_Sli˚
->
symbﬁ_mode
 =
CAVLC
);

115 
	gi
,
	gj
, 
	gc€ff_˘r
;

117 *
	gm7
;

118 
	gsˇÀd_c€ff
;

120 
	gÀvñ
, 
	grun
 = 0;

121 
	gn⁄zîo
 = 
FALSE
;

122 
	gqp_≥r
 = 
p_Qu™t
->
qp_≥r_m©rix
[
qp
];

123 
	gq_bôs
 = 
Q_BITS
 + 
qp_≥r
 + 1;

124 c⁄° 
byã
 *
	gp_sˇn
 = &
pos_sˇn
[0][0];

125 * 
	gDCL
 = &
DCLevñ
[0];

126 * 
	gDCR
 = &
DCRun
[0];

129 
	gc€ff_˘r
 = 0; coeff_ctr < 8; coeff_ctr++)

131 
	gj
 = *
p_sˇn
++;

132 
	gi
 = *
p_sˇn
++;

134 
	gm7
 = &
tblock
[
j
][
i
];

136 i‡(*
	gm7
 != 0)

138 
sˇÀd_c€ff
 = 
übs
 (*
m7
Ë* 
q_∑øms_4x4
->
SˇÀComp
;

139 
	gÀvñ
 = (
sˇÀd_c€ff
 + (
q_∑øms_4x4
->
Off£tComp
 << 1ËË>> 
q_bôs
;

141 i‡(
	gÀvñ
 != 0)

143 i‡(
is_ˇvlc
)

144 
Àvñ
 = 
imö
÷evñ, 
CAVLC_LEVEL_LIMIT
);

145 
	gÀvñ
 = 
isig«b
(
Àvñ
, *
m7
);

147 *
	gm7
 = ((
Àvñ
 * 
q_∑øms_4x4
->
InvSˇÀComp
Ë<< 
qp_≥r
);

149 *
	gDCL
++ = 
Àvñ
;

150 *
	gDCR
++ = 
run
;

152 
	grun
 = 0;

153 
	gn⁄zîo
 = 
TRUE
;

157 
	grun
++;

158 *
	gm7
 = 0;

163 
	grun
++;

167 *
	gDCL
 = 0;

169  
	gn⁄zîo
;

	@lencod/src/quantChroma_trellis.c

16 
	~"c⁄åibut‹s.h
"

18 
	~<m©h.h
>

20 
	~"globÆ.h
"

21 
	~"q_m©rix.h
"

22 
	~"qu™t4x4.h
"

23 
	~"qu™tChroma.h
"

24 
	~"rdoq.h
"

37 
qu™t_dc2x2_åñlis
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qp
, * 
DCLevñ
, * 
DCRun
,

38 
LevñQu™tP¨ams
 *
q_∑øms_4x4
, **
Ádju°
, c⁄° 
byã
 (*
pos_sˇn
)[2])

40 
Sli˚
 *
	gcuºSli˚
 = 
cuºMB
->
p_Sli˚
;

41 
Qu™tP¨amëîs
 *
	gp_Qu™t
 = 
cuºMB
->
p_Vid
->
p_Qu™t
;

42 
Boﬁón
 
	gis_ˇvlc
 = (BoﬁónË(
cuºSli˚
->
symbﬁ_mode
 =
CAVLC
);

43 
	gc€ff_˘r
;

45 *
	gm7
;

47 
	gÀvñ
, 
	grun
 = 0;

48 
	gn⁄zîo
 = 
FALSE
;

49 
	gqp_≥r
 = 
p_Qu™t
->
qp_≥r_m©rix
[
qp
];

50 
	gqp_ªm
 = 
p_Qu™t
->
qp_ªm_m©rix
[
qp
];

52 * 
	gDCL
 = &
DCLevñ
[0];

53 * 
	gDCR
 = &
DCRun
[0];

55 
	gÀvñTªŒis
[16];

57 
	gcuºSli˚
->
rdoq_dc_¸
(
cuºMB
, 
tblock
,
qp_≥r
,
qp_ªm
, 
q_∑øms_4x4
, 
pos_sˇn
, 
ÀvñTªŒis
, 
CHROMA_DC
);

59 
	gm7
 = *
tblock
;

62 
	gc€ff_˘r
=0; coeff_ctr < 4; coeff_ctr++)

66 i‡(*
	gm7
)

68 
	gÀvñ
 = 
ÀvñTªŒis
[
c€ff_˘r
];

70 i‡(
	gÀvñ
 != 0)

72 i‡(
is_ˇvlc
)

73 
Àvñ
 = 
imö
÷evñ, 
CAVLC_LEVEL_LIMIT
);

75 
	gÀvñ
 = 
isig«b
(
Àvñ
, *
m7
);

77 *
	gm7
++ = ((
Àvñ
 * 
q_∑øms_4x4
->
InvSˇÀComp
Ë<< 
qp_≥r
);

79 *
	gDCL
++ = 
Àvñ
;

80 *
	gDCR
++ = 
run
;

82 
	grun
 = 0;

83 
	gn⁄zîo
 = 
TRUE
;

87 
	grun
++;

88 *
	gm7
++ = 0;

93 
	grun
++;

94 
	gm7
++;

98 *
	gDCL
 = 0;

100  
	gn⁄zîo
;

114 
qu™t_dc4x2_åñlis
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qp
, * 
DCLevñ
, * 
DCRun
,

115 
LevñQu™tP¨ams
 *
q_∑øms_4x4
, **
Ádju°
, c⁄° 
byã
 (*
pos_sˇn
)[2])

117 
Sli˚
 *
	gcuºSli˚
 = 
cuºMB
->
p_Sli˚
;

118 
Qu™tP¨amëîs
 *
	gp_Qu™t
 = 
cuºMB
->
p_Vid
->
p_Qu™t
;

119 
Boﬁón
 
	gis_ˇvlc
 = (BoﬁónË(
cuºSli˚
->
symbﬁ_mode
 =
CAVLC
);

120 
	gi
,
	gj
, 
	gc€ff_˘r
;

122 *
	gm7
;

124 
	gÀvñ
, 
	grun
 = 0;

125 
	gn⁄zîo
 = 
FALSE
;

126 
	gqp_≥r
 = 
p_Qu™t
->
qp_≥r_m©rix
[
qp
];

127 
	gqp_ªm
 = 
p_Qu™t
->
qp_ªm_m©rix
[
qp
];

128 c⁄° 
byã
 *
	gp_sˇn
 = &
pos_sˇn
[0][0];

129 * 
	gDCL
 = &
DCLevñ
[0];

130 * 
	gDCR
 = &
DCRun
[0];

132 
	gÀvñTªŒis
[16];

134 
	gcuºSli˚
->
rdoq_dc_¸
(
cuºMB
, 
tblock
,
qp_≥r
,
qp_ªm
, 
q_∑øms_4x4
,
pos_sˇn
, 
ÀvñTªŒis
, 
CHROMA_DC_2x4
);

136 
	gc€ff_˘r
=0; coeff_ctr < 8; coeff_ctr++)

138 
	gj
 = *
p_sˇn
++;

139 
	gi
 = *
p_sˇn
++;

141 
	gm7
 = &
tblock
[
j
][
i
];

143 i‡(*
	gm7
 != 0)

145 
Àvñ
 = 
ÀvñTªŒis
[
c€ff_˘r
];

147 i‡(
	gÀvñ
 != 0)

149 i‡(
is_ˇvlc
)

150 
Àvñ
 = 
imö
÷evñ, 
CAVLC_LEVEL_LIMIT
);

151 
	gÀvñ
 = 
isig«b
(
Àvñ
, *
m7
);

153 *
	gm7
 = ((
Àvñ
 * 
q_∑øms_4x4
->
InvSˇÀComp
Ë<< 
qp_≥r
);

155 *
	gDCL
++ = 
Àvñ
;

156 *
	gDCR
++ = 
run
;

158 
	grun
 = 0;

159 
	gn⁄zîo
 = 
TRUE
;

163 
	grun
++;

164 *
	gm7
 = 0;

169 
	grun
++;

173 *
	gDCL
 = 0;

175  
	gn⁄zîo
;

186 
rdoq_dc_¸_CAVLC
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qp_≥r
, 
qp_ªm
, 
LevñQu™tP¨ams
 *
q_∑øms_4x4
, c⁄° 
byã
 (*
pos_sˇn
)[2], 
ÀvñTªŒis
[], 
ty≥
)

188 
VideoP¨amëîs
 *
	gp_Vid
 = 
cuºMB
->
p_Vid
;

190 c⁄° 
byã
 *
	gp_sˇn
 = &
pos_sˇn
[0][0];

191 
ÀvñD©aSåu˘
 
	gÀvñD©a
[16];

192 
	gœmbda_md
 = 0.0;

194 
	gœmbda_md
 = 
p_Vid
->
œmbda_rdoq
[p_Vid->
ty≥
][p_Vid->
ma°îQP
];

196 
öô_åñlis_d©a_DC_¸_CAVLC
(
cuºMB
, 
tblock
, 
qp_≥r
, 
qp_ªm
, 
q_∑øms_4x4
, 
p_sˇn
, &
ÀvñD©a
[0]);

197 
e°_RunLevñ_CAVLC
(
cuºMB
, 
ÀvñD©a
, 
ÀvñTªŒis
, 
CHROMA_DC
, 0, 0, 
p_Vid
->
num_cdc_c€ff
, 
œmbda_md
);

208 
rdoq_dc_¸_CABAC
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qp_≥r
, 
qp_ªm
, 
LevñQu™tP¨ams
 *
q_∑øms_4x4
, c⁄° 
byã
 (*
pos_sˇn
)[2], 
ÀvñTªŒis
[], 
ty≥
)

210 
VideoP¨amëîs
 *
	gp_Vid
 = 
cuºMB
->
p_Vid
;

211 c⁄° 
byã
 *
	gp_sˇn
 = &
pos_sˇn
[0][0];

212 
ÀvñD©aSåu˘
 
	gÀvñD©a
[16];

213 
	gœmbda_md
 = 0.0;

214 
	gkSèπ
=0, 
	gkSt›
=0, 
	gnoC€ff
 = 0, 
	ge°Bôs
;

216 
	gœmbda_md
 = 
p_Vid
->
œmbda_rdoq
[p_Vid->
ty≥
][p_Vid->
ma°îQP
];

218 
	gnoC€ff
 = 
öô_åñlis_d©a_DC_¸_CABAC
(
cuºMB
, 
tblock
, 
qp_≥r
, 
qp_ªm
, 
q_∑øms_4x4
, 
p_sˇn
, &
ÀvñD©a
[0], &
kSèπ
, &
kSt›
);

219 
	ge°Bôs
 = 
e°_wrôe_™d_°‹e_CBP_block_bô
(
cuºMB
, 
ty≥
);

220 
e°_wrôeRunLevñ_CABAC
(
cuºMB
, 
ÀvñD©a
, 
ÀvñTªŒis
, 
ty≥
, 
œmbda_md
, 
kSèπ
, 
kSt›
, 
noC€ff
, 
e°Bôs
);

	@lencod/src/ratectl.c

19 
	~<m©h.h
>

20 
	~<limôs.h
>

22 
	~"globÆ.h
"

23 
	~"øã˘l.h
"

32 
	$rc_°‹e_mad
(
Ma¸oblock
 *
cuºMB
)

34 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

35 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

36 
RCGíîic
 *
p_gí
 = 
p_Vid
->
p_rc_gí
;

38 
p_gí
->
MADofMB
[
cuºMB
->
mbAddrX
] = 
	`CompuãMBMAD
(cuºMB->
p_Sli˚
->
diffy
);

40 if(
p_I≈
->
basicunô
 < 
p_Vid
->
FømeSizeInMbs
)

42 
p_gí
->
TŸÆMADBasicUnô
 +p_gí->
MADofMB
[
cuºMB
->
mbAddrX
];

44 
	}
}

53 
	$QP2Q°ï
–
QP
 )

55 
i
;

56 
Q°ï
;

57 c⁄° 
QP2QSTEP
[6] = { 0.625, 0.6875, 0.8125, 0.875, 1.0, 1.125 };

59 
Q°ï
 = 
QP2QSTEP
[
QP
 % 6];

60  
i
=0; i<(
QP
/6); i++)

61 
Q°ï
 *= 2;

63  
Q°ï
;

64 
	}
}

74 
	$Q°ï2QP
–
Q°ï
, 
qp_off£t
 )

76 
q_≥r
 = 0, 
q_ªm
 = 0;

78 if–
Q°ï
 < 
	`QP2Q°ï
(
MIN_QP
))

79  
MIN_QP
;

80 i‡(
Q°ï
 > 
	`QP2Q°ï
(
MAX_QP
 + 
qp_off£t
) )

81  (
MAX_QP
 + 
qp_off£t
);

83  
Q°ï
 > 
	`QP2Q°ï
(5) )

85 
Q°ï
 /= 2.0;

86 
q_≥r
++;

89 i‡(
Q°ï
 <= 0.65625)

92 
q_ªm
 = 0;

94 i‡(
Q°ï
 <= 0.75)

97 
q_ªm
 = 1;

99 i‡(
Q°ï
 <= 0.84375)

102 
q_ªm
 = 2;

104 i‡(
Q°ï
 <= 0.9375)

107 
q_ªm
 = 3;

109 i‡(
Q°ï
 <= 1.0625)

112 
q_ªm
 = 4;

117 
q_ªm
 = 5;

120  (
q_≥r
 * 6 + 
q_ªm
);

121 
	}
}

133 
	$CompuãMBMAD
(
diffy
[16][16])

135 
k
, 
l
, 
sum
 = 0;

137 
k
 = 0; k < 16; k++)

138 
l
 = 0;Ü < 16;Ü++)

139 
sum
 +
	`übs
(
diffy
[
k
][
l
]);

141  
sum
;

142 
	}
}

151 
	$CompuãFømeMAD
(
VideoP¨amëîs
 *
p_Vid
)

153 
öt64
 
TŸÆMAD
 = 0;

154 
i
;

155 
i
 = 0; i < 
p_Vid
->
FømeSizeInMbs
; i++)

156 
TŸÆMAD
 +
p_Vid
->
p_rc_gí
->
MADofMB
[
i
];

157  ()
TŸÆMAD
 / (256.0 * ()
p_Vid
->
FømeSizeInMbs
);

158 
	}
}

168 
	$rc_c›y_gíîic
–
VideoP¨amëîs
 *
p_Vid
, 
RCGíîic
 *
d°
, RCGíîi¯*
§c
 )

171 *
tmpMADofMB
 = 
d°
->
MADofMB
;

176 
	`mem˝y
–(*)
d°
, (*)
§c
, (
RCGíîic
) );

179 
d°
->
MADofMB
 = 
tmpMADofMB
;

182 
	`mem˝y
–(*)
d°
->
MADofMB
, (*)
§c
->MADofMB, 
p_Vid
->
FømeSizeInMbs
 *  () );

183 
	}
}

192 
	$rc_Æloc_gíîic
–
VideoP¨amëîs
 *
p_Vid
, 
RCGíîic
 **
p_quad
 )

194 *
p_quad
 = (
RCGíîic
 *Ë
	`mÆloc
 ( ( RCGeneric ) );

195 i‡(
NULL
 =*
p_quad
)

197 
	`no_mem_exô
("rc_alloc_generic:Ñc_alloc_generic");

199 (*
p_quad
)->
MADofMB
 = (*Ë
	`ˇŒoc
 (
p_Vid
->
FømeSizeInMbs
,  ());

200 i‡(
NULL
 =(*
p_quad
)->
MADofMB
)

202 
	`no_mem_exô
("rc_alloc_generic: (*p_quad)->MADofMB");

204 (*
p_quad
)->
FõldFøme
 = 1;

205 
	}
}

215 
	$rc_‰ì_gíîic
(
RCGíîic
 **
p_quad
)

217 i‡(
NULL
!=(*
p_quad
)->
MADofMB
)

219 
	`‰ì
 ((*
p_quad
)->
MADofMB
);

220 (*
p_quad
)->
MADofMB
 = 
NULL
;

222 i‡(
NULL
!=(*
p_quad
))

224 
	`‰ì
 ((*
p_quad
));

225 (*
p_quad
Ë
NULL
;

227 
	}
}

236 
	$rc_öô_g›_∑øms
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

238 
≈
, 
nb
;

239 
RCQuadøtic
 *
p_quad
 = 
p_Vid
->
p_rc_quad
;

240 
RCGíîic
 *
p_gí
 = 
p_Vid
->
p_rc_gí
;

242  
p_I≈
->
RCUpd©eMode
 )

244 
RC_MODE_1
:

245 
RC_MODE_3
:

246 i‡–!(
p_Vid
->
cuº_‰m_idx
) )

249 
≈
 = (Ë(
p_I≈
->
no_‰ames
 +Ö_I≈->
NumbîBFømes
) / (1 +Ö_Inp->NumberBFrames) - 1 + 1;

251 
nb
 = 
≈
 * 
p_I≈
->
NumbîBFømes
;

253 
	`rc_öô_GOP
(
p_Vid
, 
p_I≈
, 
p_quad
, 
p_gí
, 
≈
, 
nb
);

256 
RC_MODE_0
:

257 
RC_MODE_2
:

258 i‡(
p_I≈
->
idr_≥riod
 == 0)

260 i‡–!(
p_Vid
->
cuº_‰m_idx
) )

263 
≈
 = (Ë(
p_I≈
->
no_‰ames
 +Ö_I≈->
NumbîBFømes
) / (1 +Ö_Inp->NumberBFrames) - 1 + 1;

265 
nb
 = 
≈
 * 
p_I≈
->
NumbîBFømes
;

266 
	`rc_öô_GOP
(
p_Vid
, 
p_I≈
, 
p_quad
, 
p_gí
, 
≈
, 
nb
);

269 i‡–
p_Vid
->
p_cuº_‰m_°ru˘
->
idr_Êag
 )

271 
M
 = 
p_I≈
->
NumbîBFømes
 + 1;

272 
n
 = 
p_I≈
->
idr_≥riod
;

275 i‡((
p_Vid
->
cuº_‰m_idx
 / 
p_I≈
->
idr_≥riod
Ë>’_I≈->
no_‰ames
 /Ö_Inp->idr_period))

277 
n
 = 
p_I≈
->
no_‰ames
 - 
p_Vid
->
cuº_‰m_idx
;

281 
≈
 = (
p_Vid
->
cuº_‰m_idx
 =0Ë? 1 + ((
n
 - 2Ë/ 
M
) : (n - 1) / M;

283 
nb
 = 
n
 - 
≈
 - 1;

284 
	`rc_öô_GOP
(
p_Vid
, 
p_I≈
, 
p_quad
, 
p_gí
, 
≈
, 
nb
);

290 
	}
}

300 
	$rc_öô_‰ame
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

302  
p_I≈
->
RCUpd©eMode
 )

304 
RC_MODE_0
: 
RC_MODE_1
: 
RC_MODE_2
: 
RC_MODE_3
:

307 if–(
p_I≈
->
MbI¡îœ˚
Ë&& (p_I≈->
basicunô
 < 
p_Vid
->
FømeSizeInMbs
Ë&& (p_Vid->
ty≥
 =
P_SLICE
 || (p_I≈->
RCUpd©eMode
 =
RC_MODE_1
 &&Ö_Vid->
numbî
) ) )

308 
p_Vid
->
BasicUnô
 = 
p_I≈
->
basicunô
 << 1;

310 
p_Vid
->
BasicUnô
 = 
p_I≈
->
basicunô
;

312 i‡–
p_I≈
->
RDPi˘uªDecisi⁄
 )

314 
	`rc_c›y_quadøtic
–
p_Vid
, 
p_I≈
,Ö_Vid->
p_rc_quad_öô
,Ö_Vid->
p_rc_quad
 );

315 
	`rc_c›y_gíîic
–
p_Vid
,Ö_Vid->
p_rc_gí_öô
,Ö_Vid->
p_rc_gí
 );

317 
p_Vid
->
	`rc_öô_pi˘_±r
’_Vid, 
p_I≈
,Ö_Vid->
p_rc_quad
,Ö_Vid->
p_rc_gí
, 1,0,1, 1.0F);

319 if–
p_Vid
->
a˘ive_•s
->
‰ame_mbs_⁄ly_Êag
)

320 
p_Vid
->
p_rc_gí
->
T›FõldFœg
=0;

322 
p_Vid
->
p_cuº_‰m_°ru˘
->
qp
 =Ö_Vid->q∞p_Vid->
	`upd©eQP
’_Vid, 
p_I≈
,Ö_Vid->
p_rc_quad
,Ö_Vid->
p_rc_gí
, 0Ë-Ö_Vid->p_rc_quad->
bôdïth_qp_sˇÀ
;

327 
	}
}

337 
	$rc_öô_£quí˚
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

339  
p_I≈
->
RCUpd©eMode
 )

341 
RC_MODE_0
: 
RC_MODE_1
: 
RC_MODE_2
: 
RC_MODE_3
:

342 
	`rc_öô_£q
(
p_Vid
, 
p_I≈
,Ö_Vid->
p_rc_quad
,Ö_Vid->
p_rc_gí
);

347 
	}
}

349 
	$rc_°‹e_¶i˚_hódî_bôs
–
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
Àn
 )

351 
p_I≈
->
RCUpd©eMode
)

353 
RC_MODE_0
: 
RC_MODE_1
: 
RC_MODE_2
: 
RC_MODE_3
:

354 
p_Vid
->
p_rc_gí
->
NumbîofHódîBôs
 +=
Àn
;

357 if(
p_Vid
->
BasicUnô
 <Ö_Vid->
FømeSizeInMbs
)

358 
p_Vid
->
p_rc_gí
->
NumbîofBasicUnôHódîBôs
 +=
Àn
;

363 
	}
}

372 
	$rc_°‹e_diff
(
diffy
[16][16], 
img≥l
 **
p_curImg
, 
˝ix_x
,img≥»**
¥edi˘i⁄
)

374 
i
, 
j
;

375 *
iD°
;

376 
img≥l
 *
Src1
, *
Src2
;

378 
j
 = 0; j < 
MB_BLOCK_SIZE
; j++)

380 
iD°
 = 
diffy
[
j
];

381 
Src1
 = &
p_curImg
[
j
][
˝ix_x
];

382 
Src2
 = 
¥edi˘i⁄
[
j
];

383 
i
 = 0; i < 
MB_BLOCK_SIZE
; i++)

385 
iD°
[
i
] = 
Src1
[i] - 
Src2
[i];

388 
	}
}

390 
	$rc_°‹e_diff_16b
(
diffy
[16][16], 
img≥l
 **
p_curImg
, 
˝ix_x
,img≥»**
¥edi˘i⁄
)

392 
i
, 
j
;

393 *
iD°
;

394 
uöt16
 *
Src1
, *
Src2
;

396 
j
 = 0; j < 
MB_BLOCK_SIZE
; j++)

398 
iD°
 = 
diffy
[
j
];

399 
Src1
 = (
uöt16
*)(
p_curImg
[
j
]Ë+
˝ix_x
;

400 
Src2
 = (
uöt16
*)(
¥edi˘i⁄
[
j
]);

401 
i
 = 0; i < 
MB_BLOCK_SIZE
; i++)

403 
iD°
[
i
] = 
Src1
[i] - 
Src2
[i];

406 
	}
}

	@lencod/src/rc_quadratic.c

20 
	~<m©h.h
>

21 
	~<limôs.h
>

23 
	~"globÆ.h
"

24 
	~"øã˘l.h
"

27 c⁄° 
	gTHETA
 = 1.3636F;

28 c⁄° 
	gOMEGA
 = 0.9F;

29 c⁄° 
	gMINVALUE
 = 4.0F;

37 
	$rc_Æloc_quadøtic
–
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
RCQuadøtic
 **
p_quad
 )

39 
rcBufSize
 = 
p_Vid
->
FømeSizeInMbs
 / 
p_I≈
->
basicunô
;

41 
RCQuadøtic
 *
Õrc
;

43 (*
p_quad
Ë(
RCQuadøtic
 *Ë
	`mÆloc
 ( ( RCQuadratic ) );

44 i‡(
NULL
==(*
p_quad
))

46 
	`no_mem_exô
("rc_alloc_quadratic: (*p_quad)");

48 
Õrc
 = *
p_quad
;

50 
Õrc
->
PªviousFømeMAD
 = 1.0;

51 
Õrc
->
CuºítFømeMAD
 = 1.0;

52 
Õrc
->
P¥ev_bôs
 = 0;

53 
Õrc
->
T¨gë
 = 0;

54 
Õrc
->
T¨gëFõld
 = 0;

55 
Õrc
->
LowîBound
 = 0;

56 
Õrc
->
UµîBound1
 = 
INT_MAX
;

57 
Õrc
->
UµîBound2
 = 
INT_MAX
;

58 
Õrc
->
Wp
 = 0.0;

59 
Õrc
->
Wb
 = 0.0;

60 
Õrc
->
AveWb
 = 0.0;

61 
Õrc
->
PAveFømeQP
 = 
p_I≈
->
qp
[
I_SLICE
] + 
p_Vid
->
bôdïth_luma_qp_sˇÀ
;

62 
Õrc
->
m_Qc
 =Ü¥c->
PAveFømeQP
;

63 
Õrc
->
FõldQPBuf„r
 =Ü¥c->
PAveFømeQP
;

64 
Õrc
->
FømeQPBuf„r
 =Ü¥c->
PAveFømeQP
;

65 
Õrc
->
PAvîageQp
 =Ü¥c->
PAveFømeQP
;

66 
Õrc
->
MyInôülQp
 =Ü¥c->
PAveFømeQP
;

67 
Õrc
->
AveWb
 = 0.0;

69 
Õrc
->
BUPFMAD
 = (*Ë
	`ˇŒoc
 ((
rcBufSize
),  ());

70 i‡(
NULL
==
Õrc
->
BUPFMAD
)

72 
	`no_mem_exô
("rc_alloc_quadratic:Üprc->BUPFMAD");

75 
Õrc
->
BUCFMAD
 = (*Ë
	`ˇŒoc
 ((
rcBufSize
),  ());

76 i‡(
NULL
==
Õrc
->
BUCFMAD
)

78 
	`no_mem_exô
("rc_alloc_quadratic:Üprc->BUCFMAD");

81 
Õrc
->
FCBUCFMAD
 = (*Ë
	`ˇŒoc
 ((
rcBufSize
),  ());

82 i‡(
NULL
==
Õrc
->
FCBUCFMAD
)

84 
	`no_mem_exô
("rc_alloc_quadratic:Üprc->FCBUCFMAD");

87 
Õrc
->
FCBUPFMAD
 = (*Ë
	`ˇŒoc
 ((
rcBufSize
),  ());

88 i‡(
NULL
==
Õrc
->
FCBUPFMAD
)

90 
	`no_mem_exô
("rc_alloc_quadratic:Üprc->FCBUPFMAD");

92 
	}
}

101 
	$rc_c›y_quadøtic
–
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
RCQuadøtic
 *
d°
, RCQuadøti¯*
§c
 )

103 
rcBufSize
 = 
p_Vid
->
FømeSizeInMbs
 / 
p_I≈
->
basicunô
;

105 *
tmpBUPFMAD
 = 
d°
->
BUPFMAD
;

106 *
tmpBUCFMAD
 = 
d°
->
BUCFMAD
;

107 *
tmpFCBUPFMAD
 = 
d°
->
FCBUPFMAD
;

108 *
tmpFCBUCFMAD
 = 
d°
->
FCBUCFMAD
;

111 
	`mem˝y
–(*)
d°
, (*)
§c
, (
RCQuadøtic
) );

114 
d°
->
BUPFMAD
 = 
tmpBUPFMAD
;

115 
d°
->
BUCFMAD
 = 
tmpBUCFMAD
;

116 
d°
->
FCBUPFMAD
 = 
tmpFCBUPFMAD
;

117 
d°
->
FCBUCFMAD
 = 
tmpFCBUCFMAD
;

120 
	`mem˝y
–(*)
d°
->
BUPFMAD
, (*)
§c
->BUPFMAD, (
rcBufSize
) *  () );

121 
	`mem˝y
–(*)
d°
->
BUCFMAD
, (*)
§c
->BUCFMAD, (
rcBufSize
) *  () );

122 
	`mem˝y
–(*)
d°
->
FCBUPFMAD
, (*)
§c
->FCBUPFMAD, (
rcBufSize
) *  () );

123 
	`mem˝y
–(*)
d°
->
FCBUCFMAD
, (*)
§c
->FCBUCFMAD, (
rcBufSize
) *  () );

124 
	}
}

133 
	$rc_‰ì_quadøtic
(
RCQuadøtic
 **
p_quad
)

135 i‡(
NULL
!=(*
p_quad
)->
BUPFMAD
)

137 
	`‰ì
 ((*
p_quad
)->
BUPFMAD
);

138 (*
p_quad
)->
BUPFMAD
 = 
NULL
;

140 i‡(
NULL
!=(*
p_quad
)->
BUCFMAD
)

142 
	`‰ì
 ((*
p_quad
)->
BUCFMAD
);

143 (*
p_quad
)->
BUCFMAD
 = 
NULL
;

145 i‡(
NULL
!=(*
p_quad
)->
FCBUCFMAD
)

147 
	`‰ì
 ((*
p_quad
)->
FCBUCFMAD
);

148 (*
p_quad
)->
FCBUCFMAD
 = 
NULL
;

150 i‡(
NULL
!=(*
p_quad
)->
FCBUPFMAD
)

152 
	`‰ì
 ((*
p_quad
)->
FCBUPFMAD
);

153 (*
p_quad
)->
FCBUPFMAD
 = 
NULL
;

155 i‡(
NULL
!=(*
p_quad
))

157 
	`‰ì
 ((*
p_quad
));

158 (*
p_quad
Ë
NULL
;

160 
	}
}

170 
	$rc_öô_£q
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
RCQuadøtic
 *
p_quad
, 
RCGíîic
 *
p_gí
)

172 
L1
,
L2
,
L3
,
bµ
;

173 
qp
, 
i
;

175  
p_I≈
->
RCUpd©eMode
 )

177 
RC_MODE_0
:

178 
p_Vid
->
upd©eQP
 = 
upd©eQPRC0
;

180 
RC_MODE_1
:

181 
p_Vid
->
upd©eQP
 = 
upd©eQPRC1
;

183 
RC_MODE_2
:

184 
p_Vid
->
upd©eQP
 = 
upd©eQPRC2
;

186 
RC_MODE_3
:

187 
p_Vid
->
upd©eQP
 = 
upd©eQPRC3
;

190 
p_Vid
->
upd©eQP
 = 
upd©eQPRC0
;

194 
p_Vid
->
rc_upd©e_pi˘_‰ame_±r
 = 
rc_upd©e_pi˘_‰ame
;

195 
p_Vid
->
rc_upd©e_pi˘uª_±r
 = 
rc_upd©e_pi˘uª
;

196 
p_Vid
->
rc_öô_pi˘_±r
 = 
rc_öô_pi˘
;

198 
p_quad
->
Xp
=0;

199 
p_quad
->
Xb
=0;

201 
p_quad
->
bô_øã
 = (Ë
p_I≈
->bit_rate;

202 
p_quad
->
‰ame_øã
 = 
p_Vid
->
‰amî©e
;

203 
p_quad
->
PªvBôR©e
 =Ö_quad->
bô_øã
;

206 if(
p_I≈
->
basicunô
 > 
p_Vid
->
FømeSizeInMbs
)

207 
p_I≈
->
basicunô
 = 
p_Vid
->
FømeSizeInMbs
;

208 if(
p_I≈
->
basicunô
 < 
p_Vid
->
FømeSizeInMbs
)

209 
p_quad
->
TŸÆNumbîofBasicUnô
 = 
p_Vid
->
FømeSizeInMbs
/
p_I≈
->
basicunô
;

211 
p_quad
->
TŸÆNumbîofBasicUnô
 = 1;

214 
p_gí
->
CuºítBuf„rFuŒ√ss
 = 0;

215 
p_quad
->
GOPT¨gëBuf„rLevñ
 = (Ë
p_gí
->
CuºítBuf„rFuŒ√ss
;

218 
p_quad
->
m_wödowSize
 = 0;

219 
p_quad
->
MADm_wödowSize
 = 0;

220 
p_gí
->
NumbîofCodedBFøme
 = 0;

221 
p_quad
->
NumbîofCodedPFøme
 = 0;

222 
p_gí
->
NumbîofGOP
 = 0;

224 
p_gí
->
RemaöögBôs
 = 0;

226 if(
p_I≈
->
NumbîBFømes
>0)

228 
p_quad
->
GAMMAP
=0.25;

229 
p_quad
->
BETAP
=0.9;

233 
p_quad
->
GAMMAP
=0.5;

234 
p_quad
->
BETAP
=0.5;

238 
p_quad
->
PPªHódî
=0;

240 
p_quad
->
Pm_X1
 =Ö_quad->
bô_øã
 * 1.0;

241 
p_quad
->
Pm_X2
 = 0.0;

243 
p_quad
->
PMADPi˘uªC1
 = 1.0;

244 
p_quad
->
PMADPi˘uªC2
 = 0.0;

247 
i
=0;i<21;i++)

249 
p_quad
->
Pm_rgQp
[
i
] = 0;

250 
p_quad
->
Pm_rgRp
[
i
] = 0.0;

251 
p_quad
->
PPi˘uªMAD
[
i
] = 0.0;

255 
p_quad
->
PMaxQpCh™ge
 = 
p_I≈
->
RCMaxQPCh™ge
;

258 
p_quad
->
PAveHódîBôs1
 = 0;

259 
p_quad
->
PAveHódîBôs3
 = 0;

260 
p_quad
->
DDqu™t
 = (p_quad->
TŸÆNumbîofBasicUnô
>=9 ? 1 : 2);

262 
p_quad
->
MBPîRow
 = 
p_Vid
->
PicWidthInMbs
;

265 
p_gí
->
FõldC⁄åﬁ
=0;

267 i‡(
p_I≈
->
SeöôülQP
==0)

270 
bµ
 = 1.0*
p_quad
->
bô_øã
 /’_quad->
‰ame_øã
*
p_Vid
->
size
);

272 i‡(
p_Vid
->
width
 == 176)

274 
L1
 = 0.1;

275 
L2
 = 0.3;

276 
L3
 = 0.6;

278 i‡(
p_Vid
->
width
 == 352)

280 
L1
 = 0.2;

281 
L2
 = 0.6;

282 
L3
 = 1.2;

286 
L1
 = 0.6;

287 
L2
 = 1.4;

288 
L3
 = 2.4;

290 i‡(
bµ
<
L1
)

291 
qp
 = 35;

292 if(
bµ
<=
L2
)

293 
qp
 = 25;

294 if(
bµ
<=
L3
)

295 
qp
 = 20;

297 
qp
 = 10;

298 
p_I≈
->
SeöôülQP
 = 
qp
;

302 
p_quad
->
bôdïth_qp_sˇÀ
 = 
p_Vid
->
bôdïth_luma_qp_sˇÀ
;

303 
	}
}

312 
	$rc_öô_GOP
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
RCQuadøtic
 *
p_quad
, 
RCGíîic
 *
p_gí
, 
≈
, 
nb
)

315 
GOPDqu™t
;

316 
öt64
 
AŒoˇãdBôs
;

319  
p_I≈
->
RCUpd©eMode
 )

321 
RC_MODE_3
:

323 
sum
 = 0, 
tmp
, 
Àvñ
, 
Àvñs
 = 0, 
num_‰ames
[
RC_MAX_TEMPORAL_LEVELS
];

324 
numî
, 
díom
;

325 
g›
 = 
p_I≈
->
NumbîBFømes
 + 1;

326 
i_≥riod
 = 
p_I≈
->
öåa_≥riod
 =0 ?Ö_I≈->
idr_≥riod
 : (p_I≈->idr_≥riod =0 ?Ö_I≈->öåa_≥riod : 
	`imö
(p_Inp->intra_period,Ö_Inp->idr_period) );

328 
	`mem£t
–
num_‰ames
, 0, 
RC_MAX_TEMPORAL_LEVELS
 * () );

330 i‡–
p_I≈
->
NumbîBFømes
 )

332 i‡–
p_I≈
->
HõørchiˇlCodög
 == 1 )

334 
Àvñs
 = 2;

335 
num_‰ames
[0] = 
p_I≈
->
NumbîBFømes
 >> 1;

336 
num_‰ames
[1] = (
p_I≈
->
NumbîBFømes
 -Çum_frames[0]) >= 0 ? (p_Inp->NumberBFrames -Çum_frames[0]) : 0;

338 i‡–
p_I≈
->
HõørchiˇlCodög
 == 2 )

341 
tmp
 = 
g›
;

342  
tmp
 )

344 
sum
 +
tmp
 & 1;

345 
tmp
 >>= 1;

347 
	`as£π
–
sum
 == 1 );

350 
Àvñs
 = 0;

351 
tmp
 = 
g›
;

352  
tmp
 > 1 )

354 
tmp
 >>= 1;

355 
num_‰ames
[
Àvñs
] = 1 <<Üevels;

356 
Àvñs
++;

358 
	`as£π
–
Àvñs
 >1 &&Üevñ†<
RC_MAX_TEMPORAL_LEVELS
 );

360 i‡–
p_I≈
->
HõørchiˇlCodög
 == 3 )

362 
	`Ârötf
(
°dîr
, "\n RCUpdateMode=3ánd HierarchicalCoding == 3áre currentlyÇot supported");

363 
	`exô
(1);

367 
Àvñs
 = 1;

368 
num_‰ames
[0] = 
p_I≈
->
NumbîBFømes
;

370 
p_gí
->
ãmp‹Æ_Àvñs
 = 
Àvñs
;

374  
Àvñ
 = 0;Üevñ < 
RC_MAX_TEMPORAL_LEVELS
;Üevel++ )

376 
p_I≈
->
RCBSli˚BôR©io
[
Àvñ
] = 0.0F;

378 
p_gí
->
ãmp‹Æ_Àvñs
 = 0;

381 
numî
 = ()(–(!
i_≥riod
 ? 1 : i_≥riodË* 
g›
Ë* (()
p_I≈
->
bô_øã
 /Ö_I≈->
sour˚
.
‰ame_øã
));

382 
díom
 = 0.0F;

384  
Àvñ
 = 0;Üevñ < 
Àvñs
;Üevel++ )

386 
díom
 +()(
num_‰ames
[
Àvñ
] * 
p_I≈
->
RCBSli˚BôR©io
[level]);

387 
p_gí
->
hõrNb
[
Àvñ
] = 
num_‰ames
[Àvñ] * 
≈
;

389 
díom
 += 1.0F;

390 i‡–
i_≥riod
 >= 1 )

392 
díom
 *()
i_≥riod
;

393 
díom
 +()
p_I≈
->
RCISli˚BôR©io
 - 1.0F;

397 
p_gí
->
RCPSli˚Bôs
 = (Ë
	`Êo‹
–
numî
 / 
díom
 + 0.5F );

398 
p_gí
->
RCISli˚Bôs
 = 
i_≥riod
 ? ()(
p_I≈
->
RCISli˚BôR©io
 *Ö_gí->
RCPSli˚Bôs
 + 0.5) : 0;

400  
Àvñ
 = 0;Üevñ < 
Àvñs
;Üevel++ )

402 
p_gí
->
RCBSli˚Bôs
[
Àvñ
] = ()
	`Êo‹
(
p_I≈
->
RCBSli˚BôR©io
[Àvñ] *Ö_gí->
RCPSli˚Bôs
 + 0.5);

405 
p_gí
->
NISli˚
 = 
i_≥riod
 ? ( 
p_I≈
->
no_‰ames
 / i_period ) : 0;

406 
p_gí
->
NPSli˚
 = (
p_I≈
->
no_‰ames
 / (1 +Ö_I≈->
NumbîBFømes
)Ë-Ö_gí->
NISli˚
;

419 
p_quad
->
LowîBound
 = ()(
p_gí
->
RemaöögBôs
 +Ö_quad->
bô_øã
 /Ö_quad->
‰ame_øã
);

420 
p_quad
->
UµîBound1
 = ()(
p_gí
->
RemaöögBôs
 + (p_quad->
bô_øã
 * 2.048));

423 
AŒoˇãdBôs
 = (
öt64
Ë
	`Êo‹
((1 + 
≈
 + 
nb
Ë* 
p_quad
->
bô_øã
 /Ö_quad->
‰ame_øã
 + 0.5);

424 
p_gí
->
RemaöögBôs
 +
AŒoˇãdBôs
;

425 
p_quad
->
Np
 = 
≈
;

426 
p_quad
->
Nb
 = 
nb
;

428 
p_quad
->
GOPOvîdue
=
FALSE
;

432 i‡–!
p_I≈
->
PicI¡îœ˚
 &&Ö_I≈->
MbI¡îœ˚
 &&Ö_I≈->
basicunô
 =
p_Vid
->
FømeSizeInMbs
 )

433 
p_gí
->
NoGønuœrFõldRC
 = 0;

435 
p_gí
->
NoGønuœrFõldRC
 = 1;

438 
p_quad
->
TŸÆPFøme
=
≈
;

439 
p_gí
->
NumbîofGOP
++;

440 if(
p_gí
->
NumbîofGOP
==1)

442 
p_quad
->
MyInôülQp
 = 
p_I≈
->
SeöôülQP
 +Ö_quad->
bôdïth_qp_sˇÀ
;

443 
p_quad
->
CuºLa°QP
 =Ö_quad->
MyInôülQp
 - 1;

444 
p_quad
->
QPLa°GOP
 =Ö_quad->
MyInôülQp
;

446 
p_quad
->
PAveFømeQP
 =Ö_quad->
MyInôülQp
;

447 
p_quad
->
m_Qc
 =Ö_quad->
PAveFømeQP
;

448 
p_quad
->
FõldQPBuf„r
 =Ö_quad->
PAveFømeQP
;

449 
p_quad
->
FømeQPBuf„r
 =Ö_quad->
PAveFømeQP
;

450 
p_quad
->
PAvîageQp
 =Ö_quad->
PAveFømeQP
;

455 if–
p_I≈
->
PicI¡îœ˚
 =
ADAPTIVE_CODING
 ||Ö_I≈->
MbI¡îœ˚
 )

457 i‡(
p_gí
->
FõldFøme
 == 1)

459 
p_quad
->
TŸÆQpf‹PPi˘uª
 +p_quad->
FømeQPBuf„r
;

460 
p_quad
->
QPLa°PFøme
 =Ö_quad->
FømeQPBuf„r
;

464 
p_quad
->
TŸÆQpf‹PPi˘uª
 +p_quad->
FõldQPBuf„r
;

465 
p_quad
->
QPLa°PFøme
 =Ö_quad->
FõldQPBuf„r
;

469 
p_quad
->
PAvîageQp
=()(1.0 *Ö_quad->
TŸÆQpf‹PPi˘uª
 /Ö_quad->
NumbîofPPi˘uª
+0.5);

471 
GOPDqu™t
=()((1.0*(
≈
+
nb
+1)/15.0) + 0.5);

472 if(
GOPDqu™t
>2)

473 
GOPDqu™t
=2;

475 
p_quad
->
PAvîageQp
 -
GOPDqu™t
;

477 i‡(
p_quad
->
PAvîageQp
 > (p_quad->
QPLa°PFøme
 - 2))

478 
p_quad
->
PAvîageQp
--;

481 
p_quad
->
PAvîageQp
 = 
	`iClù3
’_quad->
QPLa°GOP
 - 2,Ö_quad->QPLastGOP + 2,Ö_quad->PAverageQp);

483 
p_quad
->
PAvîageQp
 = 
	`iClù3
(
p_Vid
->
RCMöQP
 +Ö_quad->
bôdïth_qp_sˇÀ
,Ö_Vid->
RCMaxQP
 +Ö_quad->bitdepth_qp_scale,Ö_quad->PAverageQp);

485 
p_quad
->
MyInôülQp
 =Ö_quad->
PAvîageQp
;

486 
p_quad
->
Pm_Qp
 =Ö_quad->
PAvîageQp
;

487 
p_quad
->
PAveFømeQP
 =Ö_quad->
PAvîageQp
;

488 
p_quad
->
QPLa°GOP
 =Ö_quad->
MyInôülQp
;

489 
p_quad
->
PªvLa°QP
 =Ö_quad->
CuºLa°QP
;

490 
p_quad
->
CuºLa°QP
 =Ö_quad->
MyInôülQp
 - 1;

493 
p_quad
->
TŸÆQpf‹PPi˘uª
=0;

494 
p_quad
->
NumbîofPPi˘uª
=0;

495 
p_quad
->
NumbîofBFømes
=0;

496 
	}
}

506 
	$rc_öô_pi˘
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
RCQuadøtic
 *
p_quad
, 
RCGíîic
 *
p_gí
, 
fõldpic
,
t›fõld
,
èrgëcompuèti⁄
, 
mu…
)

508 
tmp_T
;

511 if(
p_I≈
->
MbI¡îœ˚
)

512 
p_quad
->
TŸÆNumbîofBasicUnô
 = 
p_Vid
->
FømeSizeInMbs
 /Ö_Vid->
BasicUnô
;

514 
p_quad
->
TŸÆNumbîofBasicUnô
 = 
p_Vid
->
FømeSizeInMbs
 / 
p_I≈
->
basicunô
;

516 
p_Vid
->
NumbîofCodedMa¸oBlocks
 = 0;

521 if(
p_I≈
->
ch™√l_ty≥
==1)

523 if(
p_quad
->
NumbîofCodedPFøme
==58)

524 
p_quad
->
bô_øã
 *= 1.5;

525 if(
p_quad
->
NumbîofCodedPFøme
==59)

526 
p_quad
->
PªvBôR©e
 =Ö_quad->
bô_øã
;

530 if((
fõldpic
||
t›fõld
Ë&& 
èrgëcompuèti⁄
)

532 i‡–
p_Vid
->
ty≥
 =
P_SLICE
 || (
p_I≈
->
RCUpd©eMode
 =
RC_MODE_1
 && (p_Vid->
numbî
 !=0)) )

536 if(
p_quad
->
PªvBôR©e
!ı_quad->
bô_øã
)

537 
p_gí
->
RemaöögBôs
 +=(Ë
	`Êo‹
((
p_quad
->
bô_øã
-p_quad->
PªvBôR©e
)*’_quad->
Np
 +Ö_quad->
Nb
)/p_quad->
‰ame_øã
+0.5);

541 if(
p_Vid
->
BasicUnô
 =p_Vid->
FømeSizeInMbs
)

543 if(
p_quad
->
NumbîofPPi˘uª
==1)

545 
p_quad
->
T¨gëBuf„rLevñ
 = (Ë
p_gí
->
CuºítBuf„rFuŒ√ss
;

546 
p_quad
->
DñèP
 = (
p_gí
->
CuºítBuf„rFuŒ√ss
 -Ö_quad->
GOPT¨gëBuf„rLevñ
Ë/ (p_quad->
TŸÆPFøme
-1);

547 
p_quad
->
T¨gëBuf„rLevñ
 -p_quad->
DñèP
;

549 if(
p_quad
->
NumbîofPPi˘uª
>1)

550 
p_quad
->
T¨gëBuf„rLevñ
 -p_quad->
DñèP
;

555 if(
p_quad
->
NumbîofCodedPFøme
>0)

558 if(((
p_I≈
->
PicI¡îœ˚
==
ADAPTIVE_CODING
)||’_I≈->
MbI¡îœ˚
))&&(
p_gí
->
FõldC⁄åﬁ
==1))

559 
	`mem˝y
((*)
p_quad
->
FCBUPFMAD
,(*Ì_quad->
FCBUCFMAD
,Ö_quad->
TŸÆNumbîofBasicUnô
 * ());

561 
	`mem˝y
((*)
p_quad
->
BUPFMAD
,(*Ì_quad->
BUCFMAD
,Ö_quad->
TŸÆNumbîofBasicUnô
 * ());

564 if(
p_gí
->
NumbîofGOP
==1)

566 if(
p_quad
->
NumbîofPPi˘uª
==1)

568 
p_quad
->
T¨gëBuf„rLevñ
 = (Ë
p_gí
->
CuºítBuf„rFuŒ√ss
;

569 
p_quad
->
DñèP
 = (
p_gí
->
CuºítBuf„rFuŒ√ss
 -Ö_quad->
GOPT¨gëBuf„rLevñ
)/’_quad->
TŸÆPFøme
 - 1);

570 
p_quad
->
T¨gëBuf„rLevñ
 -p_quad->
DñèP
;

572 if(
p_quad
->
NumbîofPPi˘uª
>1)

573 
p_quad
->
T¨gëBuf„rLevñ
 -p_quad->
DñèP
;

575 if(
p_gí
->
NumbîofGOP
>1)

577 if(
p_quad
->
NumbîofPPi˘uª
==0)

579 
p_quad
->
T¨gëBuf„rLevñ
 = (Ë
p_gí
->
CuºítBuf„rFuŒ√ss
;

580 
p_quad
->
DñèP
 = (
p_gí
->
CuºítBuf„rFuŒ√ss
 -Ö_quad->
GOPT¨gëBuf„rLevñ
Ë/Ö_quad->
TŸÆPFøme
;

581 
p_quad
->
T¨gëBuf„rLevñ
 -p_quad->
DñèP
;

583 if(
p_quad
->
NumbîofPPi˘uª
>0)

584 
p_quad
->
T¨gëBuf„rLevñ
 -p_quad->
DñèP
;

588 if(
p_quad
->
NumbîofCodedPFøme
==1)

589 
p_quad
->
AveWp
 =Ö_quad->
Wp
;

591 if((
p_quad
->
NumbîofCodedPFøme
<8)&&(p_quad->NumberofCodedPFrame>1))

592 
p_quad
->
AveWp
 = (p_quad->AveW∞+Ö_quad->
Wp
 * (p_quad->
NumbîofCodedPFøme
-1))/p_quad->NumberofCodedPFrame;

593 if(
p_quad
->
NumbîofCodedPFøme
>1)

594 
p_quad
->
AveWp
 = (p_quad->
Wp
 + 7 *Ö_quad->AveWp) / 8;

597 if(
p_I≈
->
NumbîBFømes
>0)

600 
p_quad
->
T¨gëBuf„rLevñ
 +’_quad->
AveWp
 * (
p_I≈
->
NumbîBFømes
 + 1)*p_quad->
bô_øã
\

601 /(
p_quad
->
‰ame_øã
*’_quad->
AveWp
+p_quad->
AveWb
*
p_I≈
->
NumbîBFømes
))-p_quad->
bô_øã
/p_quad->frame_rate);

604 i‡–
p_Vid
->
ty≥
 =
B_SLICE
 )

607 if(
p_quad
->
PªvBôR©e
 !p_quad->
bô_øã
)

608 
p_gí
->
RemaöögBôs
 +=(Ë
	`Êo‹
((
p_quad
->
bô_øã
-p_quad->
PªvBôR©e
Ë* (p_quad->
Np
 +Ö_quad->
Nb
Ë/Ö_quad->
‰ame_øã
+0.5);

609 if(
p_gí
->
NumbîofCodedBFøme
 == 1)

611 if(
p_quad
->
NumbîofCodedPFøme
 == 1)

613 
p_quad
->
AveWp
 =Ö_quad->
Wp
;

615 
p_quad
->
AveWb
 =Ö_quad->
Wb
;

617 if(
p_gí
->
NumbîofCodedBFøme
 > 1)

620 if(
p_gí
->
NumbîofCodedBFøme
<8)

621 
p_quad
->
AveWb
 = (p_quad->AveWb +Ö_quad->
Wb
*(
p_gí
->
NumbîofCodedBFøme
-1)) /Ö_gen->NumberofCodedBFrame;

623 
p_quad
->
AveWb
 = (p_quad->
Wb
 + 7 *Ö_quad->AveWb) / 8;

627 if–
p_Vid
->
ty≥
 =
P_SLICE
 || ( (p_Vid->
numbî
 !0Ë&& (
p_I≈
->
RCUpd©eMode
 =
RC_MODE_1
 ||Ö_I≈->RCUpd©eModê=
RC_MODE_3
 ) ) )

630 if(
p_Vid
->
BasicUnô
 =p_Vid->
FømeSizeInMbs
 || (
p_I≈
->
RCUpd©eMode
 =
RC_MODE_3
) )

632 if(
p_quad
->
NumbîofCodedPFøme
>0)

634 i‡(
p_I≈
->
RCUpd©eMode
 =
RC_MODE_3
)

636 
Àvñ_idx
 = (
p_Vid
->
ty≥
 =
B_SLICE
 && 
p_I≈
->
HõørchiˇlCodög
Ë? (p_Vid->
p_cuº_‰m_°ru˘
->
œyî
 - 1) : 0;

637 
bôøã
 = (
p_Vid
->
ty≥
 =
B_SLICE
Ë? 
p_gí
->
RCBSli˚Bôs
[ 
Àvñ_idx
 ]

638 : ( 
p_Vid
->
ty≥
 =
P_SLICE
 ? 
p_gí
->
RCPSli˚Bôs
 :Ö_gí->
RCISli˚Bôs
 );

639 
Àvñ
, 
díom
 = 
p_gí
->
NISli˚
 *Ö_gí->
RCISli˚Bôs
 +Ö_gí->
NPSli˚
 *Ö_gí->
RCPSli˚Bôs
;

641 i‡–
p_I≈
->
HõørchiˇlCodög
 )

643  
Àvñ
 = 0;Üevñ < 
p_gí
->
ãmp‹Æ_Àvñs
;Üevel++ )

644 
díom
 +
p_gí
->
hõrNb
[ 
Àvñ
 ] *Ö_gí->
RCBSli˚Bôs
[Üevel ];

648 
díom
 +
p_gí
->
hõrNb
[0] *Ö_gí->
RCBSli˚Bôs
[0];

651 
p_quad
->
T¨gë
 = (Ë
	`Êo‹
–()(1.0 * 
bôøã
 * 
p_gí
->
RemaöögBôs
Ë/ ()
díom
 + 0.5F );

653 
tmp_T
 = 
	`imax
(0, (Ë
	`Êo‹
–()
bôøã
 - 
p_quad
->
GAMMAP
 * (
p_gí
->
CuºítBuf„rFuŒ√ss
-p_quad->
T¨gëBuf„rLevñ
) + 0.5) );

656  
p_Vid
->
ty≥
 )

658 
B_SLICE
:

659 
p_quad
->
T¨gë
 = (Ë
	`Êo‹
–(Ì_quad->T¨gë / 
p_I≈
->
RCBovîPR©io
 + 0.5F);

661 
I_SLICE
:

662 
p_quad
->
T¨gë
 = (Ë
	`Êo‹
–(Ì_quad->T¨gë / (
p_I≈
->
RCIovîPR©io
 * 4.0) + 0.5F);

664 
P_SLICE
:

671 
p_quad
->
T¨gë
 = (Ë
	`Êo‹
–p_quad->
Wp
 * 
p_gí
->
RemaöögBôs
 / (p_quad->
Np
 *Ö_quad->W∞+Ö_quad->
Nb
 *Ö_quad->
Wb
) + 0.5);

672 
tmp_T
 = 
	`imax
(0, (Ë
	`Êo‹
(
p_quad
->
bô_øã
 /Ö_quad->
‰ame_øã
 -Ö_quad->
GAMMAP
 * (
p_gí
->
CuºítBuf„rFuŒ√ss
-p_quad->
T¨gëBuf„rLevñ
) + 0.5));

673 
p_quad
->
T¨gë
 = (Ë
	`Êo‹
’_quad->
BETAP
 * (p_quad->T¨gë - 
tmp_T
) +Åmp_T + 0.5);

680 if(((
p_gí
->
NumbîofGOP
 =1)&&(
p_quad
->
NumbîofCodedPFøme
>0))

681 || (
p_gí
->
NumbîofGOP
 > 1))

683 
p_quad
->
T¨gë
 = (Ë(
	`Êo‹
–p_quad->
Wp
 * 
p_gí
->
RemaöögBôs
 / (p_quad->
Np
 *Ö_quad->W∞+Ö_quad->
Nb
 *Ö_quad->
Wb
) + 0.5));

684 
tmp_T
 = 
	`imax
(0, (Ë(
	`Êo‹
(
p_quad
->
bô_øã
 /Ö_quad->
‰ame_øã
 -Ö_quad->
GAMMAP
 * (
p_gí
->
CuºítBuf„rFuŒ√ss
-p_quad->
T¨gëBuf„rLevñ
) + 0.5)));

685 
p_quad
->
T¨gë
 = (Ë(
	`Êo‹
’_quad->
BETAP
 * (p_quad->T¨gë - 
tmp_T
) +Åmp_T + 0.5));

688 
p_quad
->
T¨gë
 = ()(
mu…
 *Ö_quad->Target);

691 i‡–
p_I≈
->
RCUpd©eMode
 !
RC_MODE_3
 || 
p_Vid
->
ty≥
 =
P_SLICE
 )

692 
p_quad
->
T¨gë
 = 
	`iClù3
’_quad->
LowîBound
,Ö_quad->
UµîBound2
,Ö_quad->Target);

693 if((
t›fõld
Ë|| (
fõldpic
 && ((
p_I≈
->
PicI¡îœ˚
==
ADAPTIVE_CODING
)||’_I≈->
MbI¡îœ˚
))))

694 
p_quad
->
T¨gëFõld
ı_quad->
T¨gë
;

698 if(
fõldpic
 || 
t›fõld
)

701 
p_gí
->
NumbîofHódîBôs
 = 0;

702 
p_gí
->
NumbîofTextuªBôs
 = 0;

705 if(
p_Vid
->
BasicUnô
 <Ö_Vid->
FømeSizeInMbs
)

707 
p_quad
->
TŸÆFømeQP
 = 0;

708 
p_gí
->
NumbîofBasicUnôHódîBôs
 = 0;

709 
p_gí
->
NumbîofBasicUnôTextuªBôs
 = 0;

710 
p_gí
->
TŸÆMADBasicUnô
 = 0;

711 if(
p_gí
->
FõldC⁄åﬁ
==0)

712 
p_quad
->
NumbîofBasicUnô
 =Ö_quad->
TŸÆNumbîofBasicUnô
;

714 
p_quad
->
NumbîofBasicUnô
 =Ö_quad->
TŸÆNumbîofBasicUnô
 >> 1;

718 if––
p_Vid
->
ty≥
==
P_SLICE
 || (
p_I≈
->
RCUpd©eMode
 =
RC_MODE_1
 && (p_Vid->
numbî
 !0)ËË&&Ö_Vid->
BasicUnô
 <Ö_Vid->
FømeSizeInMbs
 && 
p_gí
->
FõldC⁄åﬁ
 == 1 )

721 if(
t›fõld
)

723 
p_quad
->
bôs_t›fõld
=0;

724 
p_quad
->
T¨gë
=()’_quad->
T¨gëFõld
*0.6);

729 
p_quad
->
T¨gë
ı_quad->
T¨gëFõld
-p_quad->
bôs_t›fõld
;

730 
p_gí
->
NumbîofBasicUnôHódîBôs
=0;

731 
p_gí
->
NumbîofBasicUnôTextuªBôs
=0;

732 
p_gí
->
TŸÆMADBasicUnô
=0;

733 
p_quad
->
NumbîofBasicUnô
ı_quad->
TŸÆNumbîofBasicUnô
 >> 1;

736 
	}
}

756 
	$rc_upd©e_pi˘
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
RCQuadøtic
 *
p_quad
, 
RCGíîic
 *
p_gí
, 
nbôs
)

758 
dñè_bôs
 = (
nbôs
 - ()
	`Êo‹
(
p_quad
->
bô_øã
 /Ö_quad->
‰ame_øã
 + 0.5F) );

760 
p_gí
->
RemaöögBôs
 -
nbôs
;

761 
p_gí
->
CuºítBuf„rFuŒ√ss
 +
dñè_bôs
;

764 
p_quad
->
LowîBound
 -(Ë
dñè_bôs
;

765 
p_quad
->
UµîBound1
 -(Ë
dñè_bôs
;

766 
p_quad
->
UµîBound2
 = ()(
OMEGA
 *Ö_quad->
UµîBound1
);

769 if–
p_Vid
->
ty≥
==
P_SLICE
 || (
p_I≈
->
RCUpd©eMode
 =
RC_MODE_1
 &&Ö_Vid->
cuº_‰m_idx
) )

771 
	`upd©eRCModñ
(
p_Vid
, 
p_I≈
, 
p_quad
, 
p_gí
);

772 i‡–
p_I≈
->
RCUpd©eMode
 =
RC_MODE_3
 )

773 
p_quad
->
PªviousWhﬁeFømeMAD
 = 
	`CompuãFømeMAD
(
p_Vid
);

775 
	}
}

792 
	$rc_upd©e_pi˘uª
–
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
bôs
 )

794 
	`rc_upd©e_pi˘
(
p_Vid
, 
p_I≈
,Ö_Vid->
p_rc_quad
,Ö_Vid->
p_rc_gí
, 
bôs
);

795 
	}
}

797 
	$upd©eCom∂exôy
–
VideoP¨amëîs
 *
p_Vid
, 
RCQuadøtic
 *
p_quad
, 
RCGíîic
 *
p_gí
, 
Boﬁón
 
is_upd©ed
, 
nbôs
 )

799 
Avem_Qc
;

802 if(
p_Vid
->
BasicUnô
 =p_Vid->
FømeSizeInMbs
)

803  ((Ë
	`Êo‹
(
nbôs
 * 
p_quad
->
m_Qc
 + 0.5));

807 if–
is_upd©ed
 )

809 if–
p_gí
->
NoGønuœrFõldRC
 =0 ||Ö_gí->
FõldC⁄åﬁ
 == 0 )

811 
Avem_Qc
 = ()
p_quad
->
TŸÆFømeQP
 / (Ì_quad->
TŸÆNumbîofBasicUnô
;

812  (()
	`Êo‹
(
nbôs
 * 
Avem_Qc
 + 0.5));

815 if–
p_Vid
->
ty≥
 =
B_SLICE
 )

816  ((Ë
	`Êo‹
(
nbôs
 * 
p_quad
->
m_Qc
 + 0.5));

819 
	}
}

821 
	$upd©eP∑øms
–
RCQuadøtic
 *
p_quad
, 
RCGíîic
 *
p_gí
, 
com∂exôy
 )

823 
p_quad
->
Xp
 = 
com∂exôy
;

824 
p_quad
->
Np
--;

825 
p_quad
->
Wp
 =Ö_quad->
Xp
;

826 
p_quad
->
Pm_Hp
 = 
p_gí
->
NumbîofHódîBôs
;

827 
p_quad
->
NumbîofCodedPFøme
++;

828 
p_quad
->
NumbîofPPi˘uª
++;

829 
	}
}

831 
	$upd©eB∑øms
–
RCQuadøtic
 *
p_quad
, 
RCGíîic
 *
p_gí
, 
com∂exôy
 )

833 
p_quad
->
Xb
 = 
com∂exôy
;

834 
p_quad
->
Nb
--;

835 
p_quad
->
Wb
 =Ö_quad->
Xb
 / 
THETA
;

836 
p_quad
->
NumbîofBFømes
++;

837 
p_gí
->
NumbîofCodedBFøme
++;

838 
	}
}

857 
	$rc_upd©e_pi˘_‰ame
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
RCQuadøtic
 *
p_quad
, 
RCGíîic
 *
p_gí
, 
nbôs
)

860 
com∂exôy
 = 0;

862  
p_I≈
->
RCUpd©eMode
 )

864 
RC_MODE_0
:

865 
RC_MODE_2
:

867 
com∂exôy
 = 
	`upd©eCom∂exôy
–
p_Vid
, 
p_quad
, 
p_gí
, (
Boﬁón
Ë’_Vid->
ty≥
 =
P_SLICE
), 
nbôs
 );

868 i‡–
p_Vid
->
ty≥
 =
P_SLICE
 )

870 if–
p_gí
->
NoGønuœrFõldRC
 =0 ||Ö_gí->
FõldC⁄åﬁ
 == 0 )

871 
	`upd©eP∑øms
–
p_quad
, 
p_gí
, 
com∂exôy
 );

873 
p_gí
->
NoGønuœrFõldRC
 = 0;

875 i‡–
p_Vid
->
ty≥
 =
B_SLICE
 )

876 
	`upd©eB∑øms
–
p_quad
, 
p_gí
, 
com∂exôy
 );

878 
RC_MODE_1
:

879 
com∂exôy
 = 
	`upd©eCom∂exôy
–
p_Vid
, 
p_quad
, 
p_gí
, (
Boﬁón
Ë’_Vid->
numbî
 !0), 
nbôs
 );

880 i‡–
p_Vid
->
numbî
 != 0 )

882 if–
p_gí
->
NoGønuœrFõldRC
 =0 ||Ö_gí->
FõldC⁄åﬁ
 == 0 )

883 
	`upd©eP∑øms
–
p_quad
, 
p_gí
, 
com∂exôy
 );

885 
p_gí
->
NoGønuœrFõldRC
 = 0;

888 
RC_MODE_3
:

889 
com∂exôy
 = 
	`upd©eCom∂exôy
–
p_Vid
, 
p_quad
, 
p_gí
, (
Boﬁón
Ë’_Vid->
ty≥
 =
P_SLICE
), 
nbôs
 );

890 i‡(
p_Vid
->
ty≥
 =
I_SLICE
 && (p_Vid->
numbî
 != 0))

891 
p_gí
->
NISli˚
--;

893 i‡–
p_Vid
->
ty≥
 =
P_SLICE
 )

895 if–
p_gí
->
NoGønuœrFõldRC
 =0 ||Ö_gí->
FõldC⁄åﬁ
 == 0 )

897 
	`upd©eP∑øms
–
p_quad
, 
p_gí
, 
com∂exôy
 );

898 
p_gí
->
NPSli˚
--;

901 
p_gí
->
NoGønuœrFõldRC
 = 0;

903 i‡–
p_Vid
->
ty≥
 =
B_SLICE
 )

905 
	`upd©eB∑øms
–
p_quad
, 
p_gí
, 
com∂exôy
 );

906 
p_gí
->
hõrNb
[ 
p_I≈
->
HõørchiˇlCodög
 ? (
p_Vid
->
p_cuº_‰m_°ru˘
->
œyî
 - 1) : 0 ]--;

910 
	}
}

920 
	$upd©eRCModñ
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
RCQuadøtic
 *
p_quad
, 
RCGíîic
 *
p_gí
)

922 
n_wödowSize
;

923 
i
;

924 
°d
 = 0.0, 
thªshﬁd
;

925 
m_Nc
 = 
p_quad
->
NumbîofCodedPFøme
;

926 
Boﬁón
 
MADModñFœg
 = 
FALSE
;

927 
Boﬁón
 
m_rgReje˘ed
[
RC_MODEL_HISTORY
];

928 
îr‹
 [
RC_MODEL_HISTORY
];

930 if–
p_Vid
->
ty≥
 =
P_SLICE
 || (
p_I≈
->
RCUpd©eMode
 =
RC_MODE_1
 && (p_Vid->
numbî
 != 0)) )

933 if(
p_Vid
->
BasicUnô
 =p_Vid->
FømeSizeInMbs
)

935 
p_quad
->
CuºítFømeMAD
 = 
	`CompuãFømeMAD
(
p_Vid
);

936 
m_Nc
=
p_quad
->
NumbîofCodedPFøme
;

942 
p_quad
->
CuºítFømeMAD
 = (Ë((
p_gí
->
TŸÆMADBasicUnô
 >> 8)/
p_Vid
->
BasicUnô
);

943 
p_gí
->
TŸÆMADBasicUnô
=0;

946 
p_quad
->
CodedBasicUnô
ı_quad->
TŸÆNumbîofBasicUnô
-p_quad->
NumbîofBasicUnô
;

947 if(
p_quad
->
CodedBasicUnô
 > 0)

949 
p_quad
->
PAveHódîBôs1
=()(()’_quad->PAveHódîBôs1*’_quad->
CodedBasicUnô
-1)+

950 
p_gí
->
NumbîofBasicUnôHódîBôs
)/
p_quad
->
CodedBasicUnô
+0.5);

951 if(
p_quad
->
PAveHódîBôs3
 == 0)

952 
p_quad
->
PAveHódîBôs2
 =Ö_quad->
PAveHódîBôs1
;

955 
p_quad
->
PAveHódîBôs2
 = ()(()’_quad->
PAveHódîBôs1
 *Ö_quad->
CodedBasicUnô
+

956 
p_quad
->
PAveHódîBôs3
 *Ö_quad->
NumbîofBasicUnô
)/p_quad->
TŸÆNumbîofBasicUnô
+0.5);

960 i‡((
p_quad
->
NumbîofBasicUnô
 >p_quad->
TŸÆNumbîofBasicUnô
) || (p_quad->NumberofBasicUnit<0))

962 
	`Ârötf
(
°dîr
, "Write into invalid memory in updateRCModelát frame %d,Ö_quad->NumberofBasicUnit %d\n",

963 
p_Vid
->
‰amïoc
, 
p_quad
->
NumbîofBasicUnô
);

967 if(((
p_I≈
->
PicI¡îœ˚
 =
ADAPTIVE_CODING
Ë|| (p_I≈->
MbI¡îœ˚
)Ë&& (
p_gí
->
FõldC⁄åﬁ
 == 1))

968 
p_quad
->
FCBUCFMAD
[p_quad->
TŸÆNumbîofBasicUnô
-1-p_quad->
NumbîofBasicUnô
]ı_quad->
CuºítFømeMAD
;

970 
p_quad
->
BUCFMAD
[p_quad->
TŸÆNumbîofBasicUnô
-1-p_quad->
NumbîofBasicUnô
]ı_quad->
CuºítFømeMAD
;

972 if(
p_quad
->
NumbîofBasicUnô
 != 0)

973 
m_Nc
 = 
p_quad
->
NumbîofCodedPFøme
 *Ö_quad->
TŸÆNumbîofBasicUnô
 +Ö_quad->
CodedBasicUnô
;

975 
m_Nc
 = (
p_quad
->
NumbîofCodedPFøme
-1Ë*Ö_quad->
TŸÆNumbîofBasicUnô
 +Ö_quad->
CodedBasicUnô
;

978 if(
m_Nc
 > 1)

979 
MADModñFœg
=
TRUE
;

981 
p_quad
->
PPªHódî
 = 
p_gí
->
NumbîofHódîBôs
;

982 
i
 = (
RC_MODEL_HISTORY
-2); i > 0; i--)

984 
p_quad
->
Pm_rgQp
[
i
] =Ö_quad->Pm_rgQp[i - 1];

985 
p_quad
->
m_rgQp
[
i
] =Ö_quad->
Pm_rgQp
[i];

986 
p_quad
->
Pm_rgRp
[
i
] =Ö_quad->Pm_rgRp[i - 1];

987 
p_quad
->
m_rgRp
[
i
] =Ö_quad->
Pm_rgRp
[i];

989 
p_quad
->
Pm_rgQp
[0] = 
	`QP2Q°ï
’_quad->
m_Qc
);

991 if(
p_Vid
->
BasicUnô
 =p_Vid->
FømeSizeInMbs
)

992 
p_quad
->
Pm_rgRp
[0] = 
p_gí
->
NumbîofTextuªBôs
*1.0/p_quad->
CuºítFømeMAD
;

995 
p_quad
->
Pm_rgRp
[0] = 
p_gí
->
NumbîofBasicUnôTextuªBôs
*1.0/p_quad->
CuºítFømeMAD
;

997 
p_quad
->
m_rgQp
[0] =Ö_quad->
Pm_rgQp
[0];

998 
p_quad
->
m_rgRp
[0] =Ö_quad->
Pm_rgRp
[0];

999 
p_quad
->
m_X1
 =Ö_quad->
Pm_X1
;

1000 
p_quad
->
m_X2
 =Ö_quad->
Pm_X2
;

1003 
n_wödowSize
 = (
p_quad
->
CuºítFømeMAD
>p_quad->
PªviousFømeMAD
)

1004 ? ()(
p_quad
->
PªviousFømeMAD
/p_quad->
CuºítFømeMAD
 * (
RC_MODEL_HISTORY
-1) )

1005 : ()(
p_quad
->
CuºítFømeMAD
/p_quad->
PªviousFømeMAD
 *(
RC_MODEL_HISTORY
-1));

1006 
n_wödowSize
=
	`iClù3
(1, 
m_Nc
,Ç_windowSize);

1007 
n_wödowSize
=
	`imö
“_wödowSize,
p_quad
->
m_wödowSize
+1);

1008 
n_wödowSize
=
	`imö
“_wödowSize,(
RC_MODEL_HISTORY
-1));

1011 
p_quad
->
m_wödowSize
=
n_wödowSize
;

1013 
i
 = 0; i < (
RC_MODEL_HISTORY
-1); i++)

1015 
m_rgReje˘ed
[
i
] = 
FALSE
;

1019 
	`RCModñE°im©‹
 (
p_Vid
, 
p_I≈
, 
p_quad
, 
n_wödowSize
, 
m_rgReje˘ed
);

1021 
n_wödowSize
 = 
p_quad
->
m_wödowSize
;

1024 
i
 = 0; i < (Ë
n_wödowSize
; i++)

1026 
îr‹
[
i
] = 
p_quad
->
m_X1
 /Ö_quad->
m_rgQp
[i] +Ö_quad->
m_X2
 / (p_quad->m_rgQp[i] *Ö_quad->m_rgQp[i]Ë-Ö_quad->
m_rgRp
[i];

1027 
°d
 +
îr‹
[
i
] *Érror[i];

1029 
thªshﬁd
 = (
n_wödowSize
 =2Ë? 0 : 
	`sqπ
 (
°d
 /Ç_windowSize);

1030 
i
 = 0; i < (Ë
n_wödowSize
; i++)

1032 i‡(
	`Ábs
(
îr‹
[
i
]Ë> 
thªshﬁd
)

1033 
m_rgReje˘ed
[
i
] = 
TRUE
;

1036 
m_rgReje˘ed
[0] = 
FALSE
;

1039 
	`RCModñE°im©‹
 (
p_Vid
, 
p_I≈
, 
p_quad
, 
n_wödowSize
, 
m_rgReje˘ed
);

1041 if–
MADModñFœg
 )

1042 
	`upd©eMADModñ
(
p_Vid
, 
p_I≈
, 
p_quad
, 
p_gí
);

1043 if–
p_Vid
->
ty≥
 =
P_SLICE
 || (
p_I≈
->
RCUpd©eMode
 =
RC_MODE_1
 && (p_Vid->
numbî
 != 0)) )

1044 
p_quad
->
PPi˘uªMAD
[0] =Ö_quad->
CuºítFømeMAD
;

1046 
	}
}

1055 
	$RCModñE°im©‹
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
RCQuadøtic
 *
p_quad
, 
n_wödowSize
, 
Boﬁón
 *
m_rgReje˘ed
)

1057 
n_ªÆSize
 = 
n_wödowSize
;

1058 
i
;

1059 
⁄eSam∂eQ
 = 0;

1060 
a00
 = 0.0, 
a01
 = 0.0, 
a10
 = 0.0, 
a11
 = 0.0, 
b0
 = 0.0, 
b1
 = 0.0;

1061 
M©rixVÆue
;

1062 
Boﬁón
 
e°im©eX2
 = 
FALSE
;

1064 
i
 = 0; i < 
n_wödowSize
; i++)

1066 i‡(
m_rgReje˘ed
[
i
])

1067 
n_ªÆSize
--;

1071 
p_quad
->
m_X1
 =Ö_quad->
m_X2
 = 0.0;

1073 
i
 = 0; i < 
n_wödowSize
; i++)

1075 i‡(!
m_rgReje˘ed
[
i
])

1076 
⁄eSam∂eQ
 = 
p_quad
->
m_rgQp
[
i
];

1078 
i
 = 0; i < 
n_wödowSize
; i++)

1080 i‡((
p_quad
->
m_rgQp
[
i
] !
⁄eSam∂eQ
Ë&& !
m_rgReje˘ed
[i])

1081 
e°im©eX2
 = 
TRUE
;

1082 i‡(!
m_rgReje˘ed
[
i
])

1083 
p_quad
->
m_X1
 +’_quad->
m_rgQp
[
i
] *Ö_quad->
m_rgRp
[i]Ë/ 
n_ªÆSize
;

1087 i‡((
n_ªÆSize
 >1Ë&& 
e°im©eX2
)

1089 
i
 = 0; i < 
n_wödowSize
; i++)

1091 i‡(!
m_rgReje˘ed
[
i
])

1093 
a00
 =á00 + 1.0;

1094 
a01
 +1.0 / 
p_quad
->
m_rgQp
[
i
];

1095 
a10
 = 
a01
;

1096 
a11
 +1.0 / (
p_quad
->
m_rgQp
[
i
] *Ö_quad->m_rgQp[i]);

1097 
b0
 +
p_quad
->
m_rgQp
[
i
] *Ö_quad->
m_rgRp
[i];

1098 
b1
 +
p_quad
->
m_rgRp
[
i
];

1102 
M©rixVÆue
=
a00
*
a11
-
a01
*
a10
;

1103 if(
	`Ábs
(
M©rixVÆue
) > 0.000001)

1105 
p_quad
->
m_X1
 = (
b0
 * 
a11
 - 
b1
 * 
a01
Ë/ 
M©rixVÆue
;

1106 
p_quad
->
m_X2
 = (
b1
 * 
a00
 - 
b0
 * 
a10
Ë/ 
M©rixVÆue
;

1110 
p_quad
->
m_X1
 = 
b0
 / 
a00
;

1111 
p_quad
->
m_X2
 = 0.0;

1114 if–
p_Vid
->
ty≥
 =
P_SLICE
 || (
p_I≈
->
RCUpd©eMode
 =
RC_MODE_1
 && (p_Vid->
numbî
 != 0)) )

1116 
p_quad
->
Pm_X1
 =Ö_quad->
m_X1
;

1117 
p_quad
->
Pm_X2
 =Ö_quad->
m_X2
;

1119 
	}
}

1128 
	$upd©eMADModñ
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
RCQuadøtic
 *
p_quad
, 
RCGíîic
 *
p_gí
)

1130 
n_wödowSize
;

1131 
i
;

1132 
°d
 = 0.0, 
thªshﬁd
;

1133 
m_Nc
 = 
p_quad
->
NumbîofCodedPFøme
;

1134 
Boﬁón
 
Pi˘uªReje˘ed
[
RC_MODEL_HISTORY
];

1135 
îr‹
 [
RC_MODEL_HISTORY
];

1137 if(
p_quad
->
NumbîofCodedPFøme
>0)

1141 if(
p_Vid
->
BasicUnô
 =p_Vid->
FømeSizeInMbs
)

1142 
m_Nc
 = 
p_quad
->
NumbîofCodedPFøme
;

1144 
m_Nc
=
p_quad
->
NumbîofCodedPFøme
*p_quad->
TŸÆNumbîofBasicUnô
+p_quad->
CodedBasicUnô
;

1146 
i
 = (
RC_MODEL_HISTORY
-2); i > 0; i--)

1148 
p_quad
->
PPi˘uªMAD
[
i
] =Ö_quad->PPictureMAD[i - 1];

1149 
p_quad
->
Pi˘uªMAD
[
i
] =Ö_quad->
PPi˘uªMAD
[i];

1150 
p_quad
->
Re„ªn˚MAD
[
i
] =Ö_quad->ReferenceMAD[i-1];

1152 
p_quad
->
PPi˘uªMAD
[0] =Ö_quad->
CuºítFømeMAD
;

1153 
p_quad
->
Pi˘uªMAD
[0] =Ö_quad->
PPi˘uªMAD
[0];

1155 if(
p_Vid
->
BasicUnô
 =p_Vid->
FømeSizeInMbs
)

1156 
p_quad
->
Re„ªn˚MAD
[0]ı_quad->
Pi˘uªMAD
[1];

1159 if(((
p_I≈
->
PicI¡îœ˚
==
ADAPTIVE_CODING
)||’_I≈->
MbI¡îœ˚
)Ë&&(
p_gí
->
FõldC⁄åﬁ
==1))

1160 
p_quad
->
Re„ªn˚MAD
[0]ı_quad->
FCBUPFMAD
[p_quad->
TŸÆNumbîofBasicUnô
-1-p_quad->
NumbîofBasicUnô
];

1162 
p_quad
->
Re„ªn˚MAD
[0]ı_quad->
BUPFMAD
[p_quad->
TŸÆNumbîofBasicUnô
-1-p_quad->
NumbîofBasicUnô
];

1164 
p_quad
->
MADPi˘uªC1
 =Ö_quad->
PMADPi˘uªC1
;

1165 
p_quad
->
MADPi˘uªC2
 =Ö_quad->
PMADPi˘uªC2
;

1168 
n_wödowSize
 = (
p_quad
->
CuºítFømeMAD
 >Ö_quad->
PªviousFømeMAD
)

1169 ? (Ë(()(
RC_MODEL_HISTORY
-1Ë* 
p_quad
->
PªviousFømeMAD
 /Ö_quad->
CuºítFømeMAD
)

1170 : (Ë(()(
RC_MODEL_HISTORY
-1Ë* 
p_quad
->
CuºítFømeMAD
 /Ö_quad->
PªviousFømeMAD
);

1171 
n_wödowSize
 = 
	`iClù3
(1, (
m_Nc
-1),Ç_windowSize);

1172 
n_wödowSize
=
	`imö
“_wödowSize, imö(20, 
p_quad
->
MADm_wödowSize
 + 1));

1175 
p_quad
->
MADm_wödowSize
=
n_wödowSize
;

1177 
i
 = 0; i < (
RC_MODEL_HISTORY
-1); i++)

1179 
Pi˘uªReje˘ed
[
i
] = 
FALSE
;

1183 if–
p_Vid
->
ty≥
 =
P_SLICE
 || (
p_I≈
->
RCUpd©eMode
 =
RC_MODE_1
 && (p_Vid->
numbî
 != 0)) )

1184 
p_quad
->
PªviousFømeMAD
ı_quad->
CuºítFømeMAD
;

1187 
	`MADModñE°im©‹
 (
p_Vid
, 
p_I≈
, 
p_quad
, 
n_wödowSize
, 
Pi˘uªReje˘ed
);

1190 
i
 = 0; i < 
n_wödowSize
; i++)

1192 
îr‹
[
i
] = 
p_quad
->
MADPi˘uªC1
 *Ö_quad->
Re„ªn˚MAD
[i] +Ö_quad->
MADPi˘uªC2
 -Ö_quad->
Pi˘uªMAD
[i];

1193 
°d
 +(
îr‹
[
i
] *Érror[i]);

1196 
thªshﬁd
 = (
n_wödowSize
 =2Ë? 0 : 
	`sqπ
 (
°d
 /Ç_windowSize);

1197 
i
 = 0; i < 
n_wödowSize
; i++)

1199 i‡(
	`Ábs
(
îr‹
[
i
]Ë> 
thªshﬁd
)

1200 
Pi˘uªReje˘ed
[
i
] = 
TRUE
;

1203 
Pi˘uªReje˘ed
[0] = 
FALSE
;

1206 
	`MADModñE°im©‹
 (
p_Vid
, 
p_I≈
, 
p_quad
, 
n_wödowSize
, 
Pi˘uªReje˘ed
);

1208 
	}
}

1218 
	$MADModñE°im©‹
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
RCQuadøtic
 *
p_quad
, 
n_wödowSize
, 
Boﬁón
 *
Pi˘uªReje˘ed
)

1220 
n_ªÆSize
 = 
n_wödowSize
;

1221 
i
;

1222 
⁄eSam∂eQ
 = 0.0;

1223 
a00
 = 0.0, 
a01
 = 0.0, 
a10
 = 0.0, 
a11
 = 0.0, 
b0
 = 0.0, 
b1
 = 0.0;

1224 
M©rixVÆue
;

1225 
Boﬁón
 
e°im©eX2
 = 
FALSE
;

1227 
i
 = 0; i < 
n_wödowSize
; i++)

1229 i‡(
Pi˘uªReje˘ed
[
i
])

1230 
n_ªÆSize
--;

1234 
p_quad
->
MADPi˘uªC1
 =Ö_quad->
MADPi˘uªC2
 = 0.0;

1236 
i
 = 0; i < 
n_wödowSize
; i++)

1238 i‡(!
Pi˘uªReje˘ed
[
i
])

1239 
⁄eSam∂eQ
 = 
p_quad
->
Pi˘uªMAD
[
i
];

1242 
i
 = 0; i < 
n_wödowSize
; i++)

1244 i‡((
p_quad
->
Pi˘uªMAD
[
i
] !
⁄eSam∂eQ
Ë&& !
Pi˘uªReje˘ed
[i])

1245 
e°im©eX2
 = 
TRUE
;

1246 i‡(!
Pi˘uªReje˘ed
[
i
])

1247 
p_quad
->
MADPi˘uªC1
 +p_quad->
Pi˘uªMAD
[
i
] / (p_quad->
Re„ªn˚MAD
[i]*
n_ªÆSize
);

1251 i‡((
n_ªÆSize
 >1Ë&& 
e°im©eX2
)

1253 
i
 = 0; i < 
n_wödowSize
; i++)

1255 i‡(!
Pi˘uªReje˘ed
[
i
])

1257 
a00
 =á00 + 1.0;

1258 
a01
 +
p_quad
->
Re„ªn˚MAD
[
i
];

1259 
a10
 = 
a01
;

1260 
a11
 +
p_quad
->
Re„ªn˚MAD
[
i
] *Ö_quad->ReferenceMAD[i];

1261 
b0
 +
p_quad
->
Pi˘uªMAD
[
i
];

1262 
b1
 +
p_quad
->
Pi˘uªMAD
[
i
] *Ö_quad->
Re„ªn˚MAD
[i];

1266 
M©rixVÆue
 = 
a00
 * 
a11
 - 
a01
 * 
a10
;

1267 if(
	`Ábs
(
M©rixVÆue
) > 0.000001)

1269 
p_quad
->
MADPi˘uªC2
 = (
b0
 * 
a11
 - 
b1
 * 
a01
Ë/ 
M©rixVÆue
;

1270 
p_quad
->
MADPi˘uªC1
 = (
b1
 * 
a00
 - 
b0
 * 
a10
Ë/ 
M©rixVÆue
;

1274 
p_quad
->
MADPi˘uªC1
 = 
b0
/
a01
;

1275 
p_quad
->
MADPi˘uªC2
 = 0.0;

1278 if–
p_Vid
->
ty≥
 =
P_SLICE
 || (
p_I≈
->
RCUpd©eMode
 =
RC_MODE_1
 && (p_Vid->
numbî
 != 0)) )

1280 
p_quad
->
PMADPi˘uªC1
 =Ö_quad->
MADPi˘uªC1
;

1281 
p_quad
->
PMADPi˘uªC2
 =Ö_quad->
MADPi˘uªC2
;

1283 
	}
}

1292 
	$upd©eQPRC0
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
RCQuadøtic
 *
p_quad
, 
RCGíîic
 *
p_gí
, 
t›fõld
)

1294 
m_Bôs
;

1295 
BFømeNumbî
;

1296 
SãpSize
;

1297 
SumofBasicUnô
;

1298 
MaxQpCh™ge
, 
m_Qp
, 
m_Hp
;

1301 if–
p_Vid
->
BasicUnô
 =p_Vid->
FømeSizeInMbs
 )

1307 if((
t›fõld
Ë|| (
p_gí
->
FõldC⁄åﬁ
==0))

1309 i‡(
p_Vid
->
ty≥
==
I_SLICE
)

1311 
p_quad
->
m_Qc
 =Ö_quad->
MyInôülQp
;

1312  
p_quad
->
m_Qc
;

1314 if(
p_Vid
->
ty≥
 =
B_SLICE
)

1316 if(
p_I≈
->
NumbîBFømes
==1)

1318 if((
p_I≈
->
PicI¡îœ˚
==
ADAPTIVE_CODING
)||’_I≈->
MbI¡îœ˚
))

1319 
	`upd©eQPI¡îœ˚
–
p_quad
, 
p_gí
 );

1321 
p_quad
->
m_Qc
 = 
	`imö
’_quad->
PªvLa°QP
,Ö_quad->
CuºLa°QP
) + 2;

1322 
p_quad
->
m_Qc
 = 
	`imax
’_quad->m_Qc, imax’_quad->
PªvLa°QP
,Ö_quad->
CuºLa°QP
));

1323 
p_quad
->
m_Qc
 = 
	`imax
’_quad->m_Qc,Ö_quad->
CuºLa°QP
 + 1);

1324 
p_quad
->
m_Qc
 = 
	`iClù3
(
p_Vid
->
RCMöQP
 +Ö_quad->
bôdïth_qp_sˇÀ
,Ö_Vid->
RCMaxQP
 +Ö_quad->bitdepth_qp_scale,Ö_quad->m_Qc);

1328 
BFømeNumbî
 = (
p_quad
->
NumbîofBFømes
 + 1Ë% 
p_I≈
->
NumbîBFømes
;

1329 if(
BFømeNumbî
==0)

1330 
BFømeNumbî
 = 
p_I≈
->
NumbîBFømes
;

1333 if(
BFømeNumbî
==1)

1335 if((
p_I≈
->
PicI¡îœ˚
==
ADAPTIVE_CODING
)||’_I≈->
MbI¡îœ˚
))

1336 
	`upd©eQPI¡îœ˚
–
p_quad
, 
p_gí
 );

1339 if((
p_quad
->
CuºLa°QP
-p_quad->
PªvLa°QP
)<=(-2*
p_I≈
->
NumbîBFømes
-3))

1340 
SãpSize
=-3;

1341 if((
p_quad
->
CuºLa°QP
-p_quad->
PªvLa°QP
)==(-2*
p_I≈
->
NumbîBFømes
-2))

1342 
SãpSize
=-2;

1343 if((
p_quad
->
CuºLa°QP
-p_quad->
PªvLa°QP
)==(-2*
p_I≈
->
NumbîBFømes
-1))

1344 
SãpSize
=-1;

1345 if((
p_quad
->
CuºLa°QP
-p_quad->
PªvLa°QP
)==(-2*
p_I≈
->
NumbîBFømes
))

1346 
SãpSize
=0;

1347 if((
p_quad
->
CuºLa°QP
-p_quad->
PªvLa°QP
)==(-2*
p_I≈
->
NumbîBFømes
+1))

1348 
SãpSize
=1;

1350 
SãpSize
=2;

1352 
p_quad
->
m_Qc
 =Ö_quad->
PªvLa°QP
 + 
SãpSize
;

1353 
p_quad
->
m_Qc
 +
	`iClù3
–-2 * (
BFømeNumbî
 - 1), 2*(BFrameNumber-1),

1354 (
BFømeNumbî
-1)*(
p_quad
->
CuºLa°QP
-p_quad->
PªvLa°QP
)/(
p_I≈
->
NumbîBFømes
-1));

1355 
p_quad
->
m_Qc
 = 
	`iClù3
(
p_Vid
->
RCMöQP
 +Ö_quad->
bôdïth_qp_sˇÀ
,Ö_Vid->
RCMaxQP
 +Ö_quad->bitdepth_qp_scale,Ö_quad->m_Qc);

1357  
p_quad
->
m_Qc
;

1359 if–
p_Vid
->
ty≥
 =
P_SLICE
 && 
p_quad
->
NumbîofPPi˘uª
 == 0 )

1361 
p_quad
->
m_Qc
ı_quad->
MyInôülQp
;

1363 if(
p_gí
->
FõldC⁄åﬁ
==0)

1364 
	`upd©eQPN⁄PicAFF
–
p_Vid
->
a˘ive_•s
, 
p_quad
 );

1365  
p_quad
->
m_Qc
;

1370 if––
p_I≈
->
PicI¡îœ˚
 =
ADAPTIVE_CODING
 ||Ö_I≈->
MbI¡îœ˚
 ) && 
p_gí
->
FõldC⁄åﬁ
 == 0 )

1371 
	`upd©eQPI¡îœ˚BU
–
p_quad
, 
p_gí
 );

1373 
p_quad
->
m_X1
 =Ö_quad->
Pm_X1
;

1374 
p_quad
->
m_X2
 =Ö_quad->
Pm_X2
;

1375 
p_quad
->
MADPi˘uªC1
 =Ö_quad->
PMADPi˘uªC1
;

1376 
p_quad
->
MADPi˘uªC2
 =Ö_quad->
PMADPi˘uªC2
;

1377 
p_quad
->
PªviousPi˘uªMAD
 =Ö_quad->
PPi˘uªMAD
[0];

1379 
MaxQpCh™ge
 = 
p_quad
->
PMaxQpCh™ge
;

1380 
m_Qp
 = 
p_quad
->
Pm_Qp
;

1381 
m_Hp
 = 
p_quad
->
PPªHódî
;

1384 
p_quad
->
CuºítFømeMAD
 =Ö_quad->
MADPi˘uªC1
*p_quad->
PªviousPi˘uªMAD
 +Ö_quad->
MADPi˘uªC2
;

1387 if(
p_quad
->
T¨gë
 < 0)

1389 
p_quad
->
m_Qc
=
m_Qp
+
MaxQpCh™ge
;

1390 
p_quad
->
m_Qc
 = 
	`iClù3
(
p_Vid
->
RCMöQP
 +Ö_quad->
bôdïth_qp_sˇÀ
,Ö_Vid->
RCMaxQP
 +Ö_quad->bitdepth_qp_scale,Ö_quad->m_Qc);

1394 
m_Bôs
 = 
p_quad
->
T¨gë
-
m_Hp
;

1395 
m_Bôs
 = 
	`imax
(m_Bôs, ()(
p_quad
->
bô_øã
/(
MINVALUE
*p_quad->
‰ame_øã
)));

1397 
	`upd©eModñQPFøme
–
p_quad
, 
m_Bôs
 );

1399 
p_quad
->
m_Qc
 = 
	`iClù3
(
p_Vid
->
RCMöQP
 +Ö_quad->
bôdïth_qp_sˇÀ
,Ö_Vid->
RCMaxQP
 +Ö_quad->bitdepth_qp_scale,Ö_quad->m_Qc);

1400 
p_quad
->
m_Qc
 = 
	`iClù3
(
m_Qp
-
MaxQpCh™ge
, m_Qp+MaxQpChange,Ö_quad->m_Qc);

1403 if–
p_gí
->
FõldC⁄åﬁ
 == 0 )

1404 
	`upd©eQPN⁄PicAFF
–
p_Vid
->
a˘ive_•s
, 
p_quad
 );

1406  
p_quad
->
m_Qc
;

1412 if–
p_Vid
->
ty≥
 =
P_SLICE
 && 
p_gí
->
NoGønuœrFõldRC
 == 0 )

1413 
	`upd©eBŸtomFõld
–
p_I≈
, 
p_quad
 );

1414  
p_quad
->
m_Qc
;

1421 i‡(
p_Vid
->
ty≥
 =
I_SLICE
)

1423 
p_quad
->
m_Qc
 =Ö_quad->
MyInôülQp
;

1424  
p_quad
->
m_Qc
;

1426 if–
p_Vid
->
ty≥
 =
B_SLICE
 )

1429 if((
t›fõld
)||(
p_gí
->
FõldC⁄åﬁ
==0))

1431 if(
p_I≈
->
NumbîBFømes
==1)

1434 if((
p_I≈
->
PicI¡îœ˚
==
ADAPTIVE_CODING
)||’_I≈->
MbI¡îœ˚
))

1435 
	`upd©eQPI¡îœ˚
–
p_quad
, 
p_gí
 );

1437 if(
p_quad
->
PªvLa°QP
=ı_quad->
CuºLa°QP
)

1438 
p_quad
->
m_Qc
ı_quad->
PªvLa°QP
+2;

1440 
p_quad
->
m_Qc
 = (’_quad->
PªvLa°QP
+p_quad->
CuºLa°QP
) >> 1) + 1;

1441 
p_quad
->
m_Qc
 = 
	`iClù3
(
p_Vid
->
RCMöQP
 +Ö_quad->
bôdïth_qp_sˇÀ
,Ö_Vid->
RCMaxQP
 +Ö_quad->bitdepth_qp_scale,Ö_quad->m_Qc);

1445 
BFømeNumbî
=(
p_quad
->
NumbîofBFømes
+1)%
p_I≈
->
NumbîBFømes
;

1446 if(
BFømeNumbî
==0)

1447 
BFømeNumbî
=
p_I≈
->
NumbîBFømes
;

1450 if(
BFømeNumbî
==1)

1452 if((
p_I≈
->
PicI¡îœ˚
==
ADAPTIVE_CODING
)||’_I≈->
MbI¡îœ˚
))

1453 
	`upd©eQPI¡îœ˚
–
p_quad
, 
p_gí
 );

1456 if((
p_quad
->
CuºLa°QP
-p_quad->
PªvLa°QP
)<=(-2*
p_I≈
->
NumbîBFømes
-3))

1457 
SãpSize
=-3;

1458 if((
p_quad
->
CuºLa°QP
-p_quad->
PªvLa°QP
)==(-2*
p_I≈
->
NumbîBFømes
-2))

1459 
SãpSize
=-2;

1460 if((
p_quad
->
CuºLa°QP
-p_quad->
PªvLa°QP
)==(-2*
p_I≈
->
NumbîBFømes
-1))

1461 
SãpSize
=-1;

1462 if((
p_quad
->
CuºLa°QP
-p_quad->
PªvLa°QP
)==(-2*
p_I≈
->
NumbîBFømes
))

1463 
SãpSize
=0;

1464 if((
p_quad
->
CuºLa°QP
-p_quad->
PªvLa°QP
)==(-2*
p_I≈
->
NumbîBFømes
+1))

1465 
SãpSize
=1;

1467 
SãpSize
=2;

1468 
p_quad
->
m_Qc
ı_quad->
PªvLa°QP
+
SãpSize
;

1469 
p_quad
->
m_Qc
 +=

1470 
	`iClù3
–-2*(
BFømeNumbî
-1), 2*(BFømeNumbî-1), (BFømeNumbî-1)*(
p_quad
->
CuºLa°QP
-p_quad->
PªvLa°QP
)/(
p_I≈
->
NumbîBFømes
-1) );

1471 
p_quad
->
m_Qc
 = 
	`iClù3
(
p_Vid
->
RCMöQP
 +Ö_quad->
bôdïth_qp_sˇÀ
,Ö_Vid->
RCMaxQP
 +Ö_quad->bitdepth_qp_scale,Ö_quad->m_Qc);

1473  
p_quad
->
m_Qc
;

1478  
p_quad
->
m_Qc
;

1481 if–
p_Vid
->
ty≥
 =
P_SLICE
 )

1483 if–(
p_gí
->
NumbîofGOP
 =1Ë&& (
p_quad
->
NumbîofPPi˘uª
 == 0) )

1485 if((
p_gí
->
FõldC⁄åﬁ
==0)||(’_gí->FõldC⁄åﬁ==1Ë&& (p_gí->
NoGønuœrFõldRC
==0)))

1486  
	`upd©eFú°P
–
p_Vid
, 
p_I≈
, 
p_quad
, 
p_gí
, 
t›fõld
 );

1490 
p_quad
->
m_X1
ı_quad->
Pm_X1
;

1491 
p_quad
->
m_X2
ı_quad->
Pm_X2
;

1492 
p_quad
->
MADPi˘uªC1
ı_quad->
PMADPi˘uªC1
;

1493 
p_quad
->
MADPi˘uªC2
ı_quad->
PMADPi˘uªC2
;

1495 
m_Qp
=
p_quad
->
Pm_Qp
;

1497 if(
p_gí
->
FõldC⁄åﬁ
==0)

1498 
SumofBasicUnô
=
p_quad
->
TŸÆNumbîofBasicUnô
;

1500 
SumofBasicUnô
=
p_quad
->
TŸÆNumbîofBasicUnô
>>1;

1503 if(
p_quad
->
NumbîofBasicUnô
==
SumofBasicUnô
)

1504  
	`upd©eFú°BU
–
p_Vid
, 
p_I≈
, 
p_quad
, 
p_gí
, 
t›fõld
 );

1508 
p_quad
->
T¨gë
 -(
p_gí
->
NumbîofBasicUnôHódîBôs
 +Ö_gí->
NumbîofBasicUnôTextuªBôs
);

1509 
p_gí
->
NumbîofBasicUnôHódîBôs
 = 0;

1510 
p_gí
->
NumbîofBasicUnôTextuªBôs
 = 0;

1511 if(
p_quad
->
T¨gë
<0)

1512  
	`upd©eNeg©iveT¨gë
–
p_Vid
, 
p_I≈
, 
p_quad
, 
p_gí
, 
t›fõld
, 
m_Qp
 );

1516 
	`¥edi˘CuºPicMAD
–
p_I≈
, 
p_quad
, 
p_gí
 );

1519 
	`upd©eModñQPBU
–
p_Vid
, 
p_I≈
, 
p_quad
, 
m_Qp
 );

1521 
p_quad
->
TŸÆFømeQP
 +ı_quad->
m_Qc
;

1522 
p_quad
->
Pm_Qp
ı_quad->
m_Qc
;

1523 
p_quad
->
NumbîofBasicUnô
--;

1524 if–
p_quad
->
NumbîofBasicUnô
 =0 && 
p_Vid
->
ty≥
 =
P_SLICE
 )

1525 
	`upd©eLa°BU
–
p_Vid
, 
p_I≈
, 
p_quad
, 
p_gí
, 
t›fõld
 );

1527  
p_quad
->
m_Qc
;

1533  
p_quad
->
m_Qc
;

1534 
	}
}

1543 
	$upd©eQPRC1
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
RCQuadøtic
 *
p_quad
, 
RCGíîic
 *
p_gí
, 
t›fõld
)

1545 
m_Bôs
;

1546 
SumofBasicUnô
;

1547 
MaxQpCh™ge
, 
m_Qp
, 
m_Hp
;

1550 if–
p_Vid
->
BasicUnô
 =p_Vid->
FømeSizeInMbs
 )

1556 if((
t›fõld
Ë|| (
p_gí
->
FõldC⁄åﬁ
==0))

1558 i‡(
p_Vid
->
numbî
 == 0)

1560 
p_quad
->
m_Qc
 =Ö_quad->
MyInôülQp
;

1561  
p_quad
->
m_Qc
;

1563 if–
p_quad
->
NumbîofPPi˘uª
 =0 && (
p_Vid
->
numbî
 != 0))

1565 
p_quad
->
m_Qc
ı_quad->
MyInôülQp
;

1567 if(
p_gí
->
FõldC⁄åﬁ
==0)

1568 
	`upd©eQPN⁄PicAFF
–
p_Vid
->
a˘ive_•s
, 
p_quad
 );

1569  
p_quad
->
m_Qc
;

1574 if––
p_I≈
->
PicI¡îœ˚
 =
ADAPTIVE_CODING
 ||Ö_I≈->
MbI¡îœ˚
 ) && 
p_gí
->
FõldC⁄åﬁ
 == 0 )

1575 
	`upd©eQPI¡îœ˚BU
–
p_quad
, 
p_gí
 );

1577 
p_quad
->
m_X1
 =Ö_quad->
Pm_X1
;

1578 
p_quad
->
m_X2
 =Ö_quad->
Pm_X2
;

1579 
p_quad
->
MADPi˘uªC1
 =Ö_quad->
PMADPi˘uªC1
;

1580 
p_quad
->
MADPi˘uªC2
 =Ö_quad->
PMADPi˘uªC2
;

1581 
p_quad
->
PªviousPi˘uªMAD
 =Ö_quad->
PPi˘uªMAD
[0];

1583 
MaxQpCh™ge
 = 
p_quad
->
PMaxQpCh™ge
;

1584 
m_Qp
 = 
p_quad
->
Pm_Qp
;

1585 
m_Hp
 = 
p_quad
->
PPªHódî
;

1588 
p_quad
->
CuºítFømeMAD
ı_quad->
MADPi˘uªC1
*p_quad->
PªviousPi˘uªMAD
 +Ö_quad->
MADPi˘uªC2
;

1591 if(
p_quad
->
T¨gë
 < 0)

1593 
p_quad
->
m_Qc
=
m_Qp
+
MaxQpCh™ge
;

1594 
p_quad
->
m_Qc
 = 
	`iClù3
(
p_Vid
->
RCMöQP
 +Ö_quad->
bôdïth_qp_sˇÀ
,Ö_Vid->
RCMaxQP
 +Ö_quad->bitdepth_qp_scale,Ö_quad->m_Qc);

1598 
m_Bôs
 = 
p_quad
->
T¨gë
-
m_Hp
;

1599 
m_Bôs
 = 
	`imax
(m_Bôs, ()(
p_quad
->
bô_øã
/(
MINVALUE
*p_quad->
‰ame_øã
)));

1601 
	`upd©eModñQPFøme
–
p_quad
, 
m_Bôs
 );

1603 
p_quad
->
m_Qc
 = 
	`iClù3
(
p_Vid
->
RCMöQP
 +Ö_quad->
bôdïth_qp_sˇÀ
,Ö_Vid->
RCMaxQP
 +Ö_quad->bitdepth_qp_scale,Ö_quad->m_Qc);

1604 
p_quad
->
m_Qc
 = 
	`iClù3
(
m_Qp
-
MaxQpCh™ge
, m_Qp+MaxQpChange,Ö_quad->m_Qc);

1607 if–
p_gí
->
FõldC⁄åﬁ
 == 0 )

1608 
	`upd©eQPN⁄PicAFF
–
p_Vid
->
a˘ive_•s
, 
p_quad
 );

1610  
p_quad
->
m_Qc
;

1616 if–
p_gí
->
NoGønuœrFõldRC
 == 0 )

1617 
	`upd©eBŸtomFõld
–
p_I≈
, 
p_quad
 );

1618  
p_quad
->
m_Qc
;

1625 i‡(
p_Vid
->
numbî
 == 0)

1627 
p_quad
->
m_Qc
 =Ö_quad->
MyInôülQp
;

1628  
p_quad
->
m_Qc
;

1632 if((
p_gí
->
NumbîofGOP
==1)&&(
p_quad
->
NumbîofPPi˘uª
==0))

1634 if((
p_gí
->
FõldC⁄åﬁ
==0)||(’_gí->FõldC⁄åﬁ==1Ë&& (p_gí->
NoGønuœrFõldRC
==0)))

1635  
	`upd©eFú°P
–
p_Vid
, 
p_I≈
, 
p_quad
, 
p_gí
, 
t›fõld
 );

1639 
p_quad
->
m_X1
ı_quad->
Pm_X1
;

1640 
p_quad
->
m_X2
ı_quad->
Pm_X2
;

1641 
p_quad
->
MADPi˘uªC1
ı_quad->
PMADPi˘uªC1
;

1642 
p_quad
->
MADPi˘uªC2
ı_quad->
PMADPi˘uªC2
;

1644 
m_Qp
=
p_quad
->
Pm_Qp
;

1646 if(
p_gí
->
FõldC⁄åﬁ
==0)

1647 
SumofBasicUnô
=
p_quad
->
TŸÆNumbîofBasicUnô
;

1649 
SumofBasicUnô
=
p_quad
->
TŸÆNumbîofBasicUnô
>>1;

1652 if(
p_quad
->
NumbîofBasicUnô
==
SumofBasicUnô
)

1653  
	`upd©eFú°BU
–
p_Vid
, 
p_I≈
, 
p_quad
, 
p_gí
, 
t›fõld
 );

1657 
p_quad
->
T¨gë
 -(
p_gí
->
NumbîofBasicUnôHódîBôs
 +Ö_gí->
NumbîofBasicUnôTextuªBôs
);

1658 
p_gí
->
NumbîofBasicUnôHódîBôs
 = 0;

1659 
p_gí
->
NumbîofBasicUnôTextuªBôs
 = 0;

1660 if(
p_quad
->
T¨gë
<0)

1661  
	`upd©eNeg©iveT¨gë
–
p_Vid
, 
p_I≈
, 
p_quad
, 
p_gí
, 
t›fõld
, 
m_Qp
 );

1665 
	`¥edi˘CuºPicMAD
–
p_I≈
, 
p_quad
, 
p_gí
 );

1668 
	`upd©eModñQPBU
–
p_Vid
, 
p_I≈
, 
p_quad
, 
m_Qp
 );

1670 
p_quad
->
TŸÆFømeQP
 +ı_quad->
m_Qc
;

1671 
p_quad
->
Pm_Qp
ı_quad->
m_Qc
;

1672 
p_quad
->
NumbîofBasicUnô
--;

1673 if((
p_quad
->
NumbîofBasicUnô
==0Ë&& (
p_Vid
->
numbî
 != 0))

1674 
	`upd©eLa°BU
–
p_Vid
, 
p_I≈
, 
p_quad
, 
p_gí
, 
t›fõld
 );

1676  
p_quad
->
m_Qc
;

1682  
p_quad
->
m_Qc
;

1683 
	}
}

1692 
	$upd©eQPRC2
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
RCQuadøtic
 *
p_quad
, 
RCGíîic
 *
p_gí
, 
t›fõld
)

1694 
m_Bôs
;

1695 
SumofBasicUnô
;

1696 
MaxQpCh™ge
, 
m_Qp
, 
m_Hp
;

1699 if–
p_Vid
->
BasicUnô
 =p_Vid->
FømeSizeInMbs
 )

1705 if((
t›fõld
Ë|| (
p_gí
->
FõldC⁄åﬁ
==0))

1707 i‡(
p_Vid
->
numbî
 == 0)

1709 
p_quad
->
m_Qc
 =Ö_quad->
MyInôülQp
;

1710  
p_quad
->
m_Qc
;

1712 i‡(
p_Vid
->
ty≥
==
I_SLICE
)

1714 if((
p_I≈
->
PicI¡îœ˚
==
ADAPTIVE_CODING
)||’_I≈->
MbI¡îœ˚
))

1715 
	`upd©eQPI¡îœ˚
–
p_quad
, 
p_gí
 );

1717 i‡–
p_Vid
->
p_cuº_‰m_°ru˘
->
idr_Êag
 )

1718 
p_quad
->
m_Qc
 =Ö_quad->
MyInôülQp
;

1720 
p_quad
->
m_Qc
 =Ö_quad->
CuºLa°QP
;

1722  
p_quad
->
m_Qc
;

1724 if(
p_Vid
->
ty≥
 =
B_SLICE
)

1726 
¥evQP
 = 
	`imax
(
p_quad
->
PªvLa°QP
,Ö_quad->
CuºLa°QP
);

1729 if((
p_I≈
->
PicI¡îœ˚
==
ADAPTIVE_CODING
)||’_I≈->
MbI¡îœ˚
))

1730 
	`upd©eQPI¡îœ˚
–
p_quad
, 
p_gí
 );

1732 i‡(
p_I≈
->
HõørchiˇlCodög
)

1734 
p_quad
->
m_Qc
 = 
¥evQP
 + 
p_Vid
->
p_cuº_‰m_°ru˘
->
œyî
;

1737 
p_quad
->
m_Qc
 = 
¥evQP
 + 2 - 
p_Vid
->
«l_ª„ªn˚_idc
;

1738 
p_quad
->
m_Qc
 = 
	`iClù3
(
p_Vid
->
RCMöQP
 +Ö_quad->
bôdïth_qp_sˇÀ
,Ö_Vid->
RCMaxQP
 +Ö_quad->bitdepth_qp_scale,Ö_quad->m_Qc);

1740  
p_quad
->
m_Qc
;

1742 if–
p_Vid
->
ty≥
 =
P_SLICE
 && 
p_quad
->
NumbîofPPi˘uª
 == 0 )

1744 
p_quad
->
m_Qc
ı_quad->
MyInôülQp
;

1746 if(
p_gí
->
FõldC⁄åﬁ
==0)

1747 
	`upd©eQPN⁄PicAFF
–
p_Vid
->
a˘ive_•s
, 
p_quad
 );

1748  
p_quad
->
m_Qc
;

1753 if––
p_I≈
->
PicI¡îœ˚
 =
ADAPTIVE_CODING
 ||Ö_I≈->
MbI¡îœ˚
 ) && 
p_gí
->
FõldC⁄åﬁ
 == 0 )

1754 
	`upd©eQPI¡îœ˚BU
–
p_quad
, 
p_gí
 );

1756 
p_quad
->
m_X1
 =Ö_quad->
Pm_X1
;

1757 
p_quad
->
m_X2
 =Ö_quad->
Pm_X2
;

1758 
p_quad
->
MADPi˘uªC1
 =Ö_quad->
PMADPi˘uªC1
;

1759 
p_quad
->
MADPi˘uªC2
 =Ö_quad->
PMADPi˘uªC2
;

1760 
p_quad
->
PªviousPi˘uªMAD
 =Ö_quad->
PPi˘uªMAD
[0];

1762 
MaxQpCh™ge
 = 
p_quad
->
PMaxQpCh™ge
;

1763 
m_Qp
 = 
p_quad
->
Pm_Qp
;

1764 
m_Hp
 = 
p_quad
->
PPªHódî
;

1767 
p_quad
->
CuºítFømeMAD
ı_quad->
MADPi˘uªC1
*p_quad->
PªviousPi˘uªMAD
 +Ö_quad->
MADPi˘uªC2
;

1770 if(
p_quad
->
T¨gë
 < 0)

1772 
p_quad
->
m_Qc
=
m_Qp
+
MaxQpCh™ge
;

1773 
p_quad
->
m_Qc
 = 
	`iClù3
(
p_Vid
->
RCMöQP
 +Ö_quad->
bôdïth_qp_sˇÀ
,Ö_Vid->
RCMaxQP
 +Ö_quad->bitdepth_qp_scale,Ö_quad->m_Qc);

1777 
m_Bôs
 = 
p_quad
->
T¨gë
-
m_Hp
;

1778 
m_Bôs
 = 
	`imax
(m_Bôs, ()(
p_quad
->
bô_øã
/(
MINVALUE
*p_quad->
‰ame_øã
)));

1780 
	`upd©eModñQPFøme
–
p_quad
, 
m_Bôs
 );

1782 
p_quad
->
m_Qc
 = 
	`iClù3
(
p_Vid
->
RCMöQP
 +Ö_quad->
bôdïth_qp_sˇÀ
,Ö_Vid->
RCMaxQP
 +Ö_quad->bitdepth_qp_scale,Ö_quad->m_Qc);

1783 
p_quad
->
m_Qc
 = 
	`iClù3
(
m_Qp
-
MaxQpCh™ge
, m_Qp+MaxQpChange,Ö_quad->m_Qc);

1786 if–
p_gí
->
FõldC⁄åﬁ
 == 0 )

1787 
	`upd©eQPN⁄PicAFF
–
p_Vid
->
a˘ive_•s
, 
p_quad
 );

1789  
p_quad
->
m_Qc
;

1795 if–
p_Vid
->
ty≥
==
P_SLICE
 && 
p_gí
->
NoGønuœrFõldRC
 == 0 )

1796 
	`upd©eBŸtomFõld
–
p_I≈
, 
p_quad
 );

1797  
p_quad
->
m_Qc
;

1804 i‡(
p_Vid
->
numbî
 == 0)

1806 
p_quad
->
m_Qc
 =Ö_quad->
MyInôülQp
;

1807  
p_quad
->
m_Qc
;

1809 i‡(
p_Vid
->
ty≥
==
I_SLICE
)

1812 if((
p_I≈
->
PicI¡îœ˚
==
ADAPTIVE_CODING
)||’_I≈->
MbI¡îœ˚
))

1813 
	`upd©eQPI¡îœ˚
–
p_quad
, 
p_gí
 );

1815 
p_quad
->
m_Qc
 =Ö_quad->
PªvLa°QP
;

1816 
p_quad
->
PªvLa°QP
 =Ö_quad->
CuºLa°QP
;

1817 
p_quad
->
CuºLa°QP
 =Ö_quad->
PªvLa°QP
;

1818 
p_quad
->
PAveFømeQP
 =Ö_quad->
CuºLa°QP
;

1820  
p_quad
->
m_Qc
;

1822 if(
p_Vid
->
ty≥
 =
B_SLICE
)

1824 
¥evQP
 = 
	`imax
(
p_quad
->
PªvLa°QP
,Ö_quad->
CuºLa°QP
);

1825 if((
p_I≈
->
PicI¡îœ˚
==
ADAPTIVE_CODING
)||’_I≈->
MbI¡îœ˚
))

1826 
	`upd©eQPI¡îœ˚
–
p_quad
, 
p_gí
 );

1828 i‡(
p_I≈
->
HõørchiˇlCodög
)

1830 
p_quad
->
m_Qc
 = 
¥evQP
 + 
p_Vid
->
p_cuº_‰m_°ru˘
->
œyî
;

1833 
p_quad
->
m_Qc
 = 
¥evQP
 + 2 - 
p_Vid
->
«l_ª„ªn˚_idc
;

1835 
p_quad
->
m_Qc
 = 
	`iClù3
(
p_Vid
->
RCMöQP
 +Ö_quad->
bôdïth_qp_sˇÀ
,Ö_Vid->
RCMaxQP
 +Ö_quad->bitdepth_qp_scale,Ö_quad->m_Qc);

1837  
p_quad
->
m_Qc
;

1840 if–
p_Vid
->
ty≥
 =
P_SLICE
 )

1842 if((
p_gí
->
NumbîofGOP
==1)&&(
p_quad
->
NumbîofPPi˘uª
==0))

1844 if((
p_gí
->
FõldC⁄åﬁ
==0)||(’_gí->FõldC⁄åﬁ==1Ë&& (p_gí->
NoGønuœrFõldRC
==0)))

1845  
	`upd©eFú°P
–
p_Vid
, 
p_I≈
, 
p_quad
, 
p_gí
, 
t›fõld
 );

1849 
p_quad
->
m_X1
ı_quad->
Pm_X1
;

1850 
p_quad
->
m_X2
ı_quad->
Pm_X2
;

1851 
p_quad
->
MADPi˘uªC1
ı_quad->
PMADPi˘uªC1
;

1852 
p_quad
->
MADPi˘uªC2
ı_quad->
PMADPi˘uªC2
;

1854 
m_Qp
=
p_quad
->
Pm_Qp
;

1856 if(
p_gí
->
FõldC⁄åﬁ
==0)

1857 
SumofBasicUnô
=
p_quad
->
TŸÆNumbîofBasicUnô
;

1859 
SumofBasicUnô
=
p_quad
->
TŸÆNumbîofBasicUnô
>>1;

1862 if(
p_quad
->
NumbîofBasicUnô
==
SumofBasicUnô
)

1863  
	`upd©eFú°BU
–
p_Vid
, 
p_I≈
, 
p_quad
, 
p_gí
, 
t›fõld
 );

1867 
p_quad
->
T¨gë
 -(
p_gí
->
NumbîofBasicUnôHódîBôs
 +Ö_gí->
NumbîofBasicUnôTextuªBôs
);

1868 
p_gí
->
NumbîofBasicUnôHódîBôs
 = 0;

1869 
p_gí
->
NumbîofBasicUnôTextuªBôs
 = 0;

1870 if(
p_quad
->
T¨gë
<0)

1871  
	`upd©eNeg©iveT¨gë
–
p_Vid
, 
p_I≈
, 
p_quad
, 
p_gí
, 
t›fõld
, 
m_Qp
 );

1875 
	`¥edi˘CuºPicMAD
–
p_I≈
, 
p_quad
, 
p_gí
 );

1878 
	`upd©eModñQPBU
–
p_Vid
, 
p_I≈
, 
p_quad
, 
m_Qp
 );

1880 
p_quad
->
TŸÆFømeQP
 +ı_quad->
m_Qc
;

1881 
p_quad
->
Pm_Qp
ı_quad->
m_Qc
;

1882 
p_quad
->
NumbîofBasicUnô
--;

1883 if((
p_quad
->
NumbîofBasicUnô
==0Ë&& 
p_Vid
->
ty≥
 =
P_SLICE
 )

1884 
	`upd©eLa°BU
–
p_Vid
, 
p_I≈
, 
p_quad
, 
p_gí
, 
t›fõld
 );

1886  
p_quad
->
m_Qc
;

1892  
p_quad
->
m_Qc
;

1893 
	}
}

1902 
	$upd©eQPRC3
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
RCQuadøtic
 *
p_quad
, 
RCGíîic
 *
p_gí
, 
t›fõld
)

1904 
m_Bôs
;

1905 
SumofBasicUnô
;

1906 
MaxQpCh™ge
, 
m_Qp
, 
m_Hp
;

1909 if–
p_Vid
->
BasicUnô
 =p_Vid->
FømeSizeInMbs
 ||Ö_Vid->
ty≥
 !
P_SLICE
 )

1915 if((
t›fõld
Ë|| (
p_gí
->
FõldC⁄åﬁ
==0))

1917 i‡(
p_Vid
->
numbî
 == 0)

1919 if((
p_I≈
->
PicI¡îœ˚
 =
ADAPTIVE_CODING
Ë|| (p_I≈->
MbI¡îœ˚
))

1920 
	`upd©eQPI¡îœ˚
–
p_quad
, 
p_gí
 );

1921 
p_quad
->
m_Qc
 =Ö_quad->
MyInôülQp
;

1922  
p_quad
->
m_Qc
;

1924 if–
p_Vid
->
ty≥
 =
P_SLICE
 && 
p_quad
->
NumbîofPPi˘uª
 == 0 )

1926 
p_quad
->
m_Qc
ı_quad->
MyInôülQp
;

1928 if(
p_gí
->
FõldC⁄åﬁ
==0)

1929 
	`upd©eQPN⁄PicAFF
–
p_Vid
->
a˘ive_•s
, 
p_quad
 );

1930  
p_quad
->
m_Qc
;

1934 if––(
p_Vid
->
ty≥
 =
B_SLICE
 && (p_Vid->
p_cuº_‰m_°ru˘
->
œyî
 &&Ö_Vid->p_cuº_‰m_°ru˘->
©om_idx
 =1)Ë||Ö_Vid->ty≥ =
I_SLICE
Ë&& ((
p_I≈
->
PicI¡îœ˚
 =
ADAPTIVE_CODING
Ë|| (p_I≈->
MbI¡îœ˚
)) )

1935 
	`upd©eQPI¡îœ˚
–
p_quad
, 
p_gí
 );

1937 if–
p_Vid
->
ty≥
 =
P_SLICE
 && ( 
p_I≈
->
PicI¡îœ˚
 =
ADAPTIVE_CODING
 ||Ö_I≈->
MbI¡îœ˚
 ) && 
p_gí
->
FõldC⁄åﬁ
 == 0 )

1938 
	`upd©eQPI¡îœ˚BU
–
p_quad
, 
p_gí
 );

1940 
p_quad
->
m_X1
 =Ö_quad->
Pm_X1
;

1941 
p_quad
->
m_X2
 =Ö_quad->
Pm_X2
;

1942 
p_quad
->
MADPi˘uªC1
 =Ö_quad->
PMADPi˘uªC1
;

1943 
p_quad
->
MADPi˘uªC2
 =Ö_quad->
PMADPi˘uªC2
;

1944 
p_quad
->
PªviousPi˘uªMAD
 =Ö_quad->
PPi˘uªMAD
[0];

1946 
MaxQpCh™ge
 = 
p_quad
->
PMaxQpCh™ge
;

1947 
m_Qp
 = 
p_quad
->
Pm_Qp
;

1948 
m_Hp
 = 
p_quad
->
PPªHódî
;

1950 i‡–
p_Vid
->
BasicUnô
 <Ö_Vid->
FømeSizeInMbs
 &&Ö_Vid->
ty≥
 !
P_SLICE
 )

1955 
p_quad
->
PªviousPi˘uªMAD
 =Ö_quad->
PªviousWhﬁeFømeMAD
;

1957 i‡–
p_Vid
->
ty≥
 =
I_SLICE
 )

1958 
m_Hp
 = 0;

1961 
p_quad
->
CuºítFømeMAD
ı_quad->
MADPi˘uªC1
*p_quad->
PªviousPi˘uªMAD
 +Ö_quad->
MADPi˘uªC2
;

1964 if(
p_quad
->
T¨gë
 < 0)

1966 
p_quad
->
m_Qc
=
m_Qp
+
MaxQpCh™ge
;

1967 
p_quad
->
m_Qc
 = 
	`iClù3
(
p_Vid
->
RCMöQP
 +Ö_quad->
bôdïth_qp_sˇÀ
,Ö_Vid->
RCMaxQP
 +Ö_quad->bitdepth_qp_scale,Ö_quad->m_Qc);

1971 i‡–
p_Vid
->
ty≥
 !
P_SLICE
 )

1973 i‡–
p_Vid
->
BasicUnô
 <Ö_Vid->
FømeSizeInMbs
 )

1974 
m_Bôs
 =(
p_quad
->
T¨gë
-
m_Hp
)/p_quad->
TŸÆNumbîofBasicUnô
;

1976 
m_Bôs
 =
p_quad
->
T¨gë
-
m_Hp
;

1979 
m_Bôs
 = 
p_quad
->
T¨gë
-
m_Hp
;

1980 
m_Bôs
 = 
	`imax
(m_Bôs, ()(
p_quad
->
bô_øã
/(
MINVALUE
*p_quad->
‰ame_øã
)));

1982 
	`upd©eModñQPFøme
–
p_quad
, 
m_Bôs
 );

1984 
p_quad
->
m_Qc
 = 
	`iClù3
(
p_Vid
->
RCMöQP
 +Ö_quad->
bôdïth_qp_sˇÀ
,Ö_Vid->
RCMaxQP
 +Ö_quad->bitdepth_qp_scale,Ö_quad->m_Qc);

1985 i‡–
p_Vid
->
ty≥
 =
P_SLICE
 )

1986 
p_quad
->
m_Qc
 = 
	`iClù3
(
m_Qp
-
MaxQpCh™ge
, m_Qp+MaxQpChange,Ö_quad->m_Qc);

1989 if–
p_Vid
->
ty≥
 =
P_SLICE
 && 
p_gí
->
FõldC⁄åﬁ
 == 0 )

1990 
	`upd©eQPN⁄PicAFF
–
p_Vid
->
a˘ive_•s
, 
p_quad
 );

1992 i‡–
p_Vid
->
ty≥
 =
B_SLICE
 )

1995 
¥evqp
 = ((
p_quad
->
PªvLa°QP
+p_quad->
CuºLa°QP
) >> 1) + 1;

1996 i‡–
p_I≈
->
HõørchiˇlCodög
 && 
p_Vid
->
p_cuº_‰m_°ru˘
->
œyî
)

1997 
p_quad
->
m_Qc
 -(
p_Vid
->
p_cuº_‰m_°ru˘
->
p_©om
->
g›_Àvñs
 -Ö_Vid->p_cuº_‰m_°ru˘->
œyî
);

1999 
p_quad
->
m_Qc
 = 
	`iClù3
(
¥evqp
 - (
p_I≈
->
HõørchiˇlCodög
 ? 0 : 5),Örevqp + 5,Ö_quad->m_Qc);

2000 
p_quad
->
m_Qc
 = 
	`iClù3
(
p_Vid
->
RCMöQP
 +Ö_quad->
bôdïth_qp_sˇÀ
,Ö_Vid->
RCMaxQP
 +Ö_quad->bitdepth_qp_scale,Ö_quad->m_Qc);

2002  
p_quad
->
m_Qc
;

2008 if–
p_Vid
->
ty≥
==
P_SLICE
 && 
p_gí
->
NoGønuœrFõldRC
 == 0 )

2009 
	`upd©eBŸtomFõld
–
p_I≈
, 
p_quad
 );

2010  
p_quad
->
m_Qc
;

2017 i‡(
p_Vid
->
numbî
 == 0)

2019 if((
p_I≈
->
PicI¡îœ˚
 =
ADAPTIVE_CODING
Ë|| (p_I≈->
MbI¡îœ˚
))

2020 
	`upd©eQPI¡îœ˚
–
p_quad
, 
p_gí
 );

2021 
p_quad
->
m_Qc
 =Ö_quad->
MyInôülQp
;

2022  
p_quad
->
m_Qc
;

2024 if–
p_Vid
->
ty≥
 =
P_SLICE
 )

2026 if((
p_gí
->
NumbîofGOP
==1)&&(
p_quad
->
NumbîofPPi˘uª
==0))

2028 if((
p_gí
->
FõldC⁄åﬁ
==0)||(’_gí->FõldC⁄åﬁ==1Ë&& (p_gí->
NoGønuœrFõldRC
==0)))

2029  
	`upd©eFú°P
–
p_Vid
, 
p_I≈
, 
p_quad
, 
p_gí
, 
t›fõld
 );

2033 if––(
p_Vid
->
ty≥
 =
B_SLICE
 && (p_Vid->
p_cuº_‰m_°ru˘
->
œyî
 &&Ö_Vid->p_cuº_‰m_°ru˘->
©om_idx
 =1)Ë||Ö_Vid->ty≥ =
I_SLICE
Ë&& ((
p_I≈
->
PicI¡îœ˚
 =
ADAPTIVE_CODING
Ë|| (p_I≈->
MbI¡îœ˚
)) )

2034 
	`upd©eQPI¡îœ˚
–
p_quad
, 
p_gí
 );

2035 
p_quad
->
m_X1
ı_quad->
Pm_X1
;

2036 
p_quad
->
m_X2
ı_quad->
Pm_X2
;

2037 
p_quad
->
MADPi˘uªC1
ı_quad->
PMADPi˘uªC1
;

2038 
p_quad
->
MADPi˘uªC2
ı_quad->
PMADPi˘uªC2
;

2040 
m_Qp
=
p_quad
->
Pm_Qp
;

2042 if(
p_gí
->
FõldC⁄åﬁ
==0)

2043 
SumofBasicUnô
=
p_quad
->
TŸÆNumbîofBasicUnô
;

2045 
SumofBasicUnô
=
p_quad
->
TŸÆNumbîofBasicUnô
>>1;

2048 if(
p_quad
->
NumbîofBasicUnô
==
SumofBasicUnô
)

2049  
	`upd©eFú°BU
–
p_Vid
, 
p_I≈
, 
p_quad
, 
p_gí
, 
t›fõld
 );

2053 
p_quad
->
T¨gë
 -(
p_gí
->
NumbîofBasicUnôHódîBôs
 +Ö_gí->
NumbîofBasicUnôTextuªBôs
);

2054 
p_gí
->
NumbîofBasicUnôHódîBôs
 = 0;

2055 
p_gí
->
NumbîofBasicUnôTextuªBôs
 = 0;

2056 if(
p_quad
->
T¨gë
<0)

2057  
	`upd©eNeg©iveT¨gë
–
p_Vid
, 
p_I≈
, 
p_quad
, 
p_gí
, 
t›fõld
, 
m_Qp
 );

2061 
	`¥edi˘CuºPicMAD
–
p_I≈
, 
p_quad
, 
p_gí
 );

2064 
	`upd©eModñQPBU
–
p_Vid
, 
p_I≈
, 
p_quad
, 
m_Qp
 );

2066 
p_quad
->
TŸÆFømeQP
 +ı_quad->
m_Qc
;

2067 
p_quad
->
Pm_Qp
ı_quad->
m_Qc
;

2068 
p_quad
->
NumbîofBasicUnô
--;

2069 if((
p_quad
->
NumbîofBasicUnô
==0Ë&& 
p_Vid
->
ty≥
 =
P_SLICE
 )

2070 
	`upd©eLa°BU
–
p_Vid
, 
p_I≈
, 
p_quad
, 
p_gí
, 
t›fõld
 );

2072  
p_quad
->
m_Qc
;

2078  
p_quad
->
m_Qc
;

2079 
	}
}

2088 
	$upd©eQPI¡îœ˚
–
RCQuadøtic
 *
p_quad
, 
RCGíîic
 *
p_gí
 )

2090 if(
p_gí
->
FõldC⁄åﬁ
==0)

2093 if(
p_gí
->
FõldFøme
==1)

2095 
p_quad
->
PªvLa°QP
ı_quad->
CuºLa°QP
;

2096 
p_quad
->
CuºLa°QP
ı_quad->
FømeQPBuf„r
;

2101 
p_quad
->
PªvLa°QP
ı_quad->
CuºLa°QP
;

2102 
p_quad
->
CuºLa°QP
ı_quad->
FõldQPBuf„r
;

2105 
	}
}

2114 
	$upd©eQPN⁄PicAFF
–
£q_∑ømëî_£t_rb•_t
 *
a˘ive_•s
, 
RCQuadøtic
 *
p_quad
 )

2116 if(
a˘ive_•s
->
‰ame_mbs_⁄ly_Êag
)

2118 
p_quad
->
TŸÆQpf‹PPi˘uª
 +ı_quad->
m_Qc
;

2119 
p_quad
->
PªvLa°QP
ı_quad->
CuºLa°QP
;

2120 
p_quad
->
CuºLa°QP
ı_quad->
m_Qc
;

2121 
p_quad
->
Pm_Qp
ı_quad->
m_Qc
;

2125 
p_quad
->
FømeQPBuf„r
ı_quad->
m_Qc
;

2126 
	}
}

2134 
	$upd©eBŸtomFõld
–
I≈utP¨amëîs
 *
p_I≈
, 
RCQuadøtic
 *
p_quad
 )

2137 if(
p_I≈
->
PicI¡îœ˚
==
FIELD_CODING
)

2139 
p_quad
->
TŸÆQpf‹PPi˘uª
 +ı_quad->
m_Qc
;

2140 
p_quad
->
PªvLa°QP
ı_quad->
CuºLa°QP
+1;

2141 
p_quad
->
CuºLa°QP
ı_quad->
m_Qc
;

2142 
p_quad
->
Pm_Qp
ı_quad->
m_Qc
;

2146 
p_quad
->
FõldQPBuf„r
ı_quad->
m_Qc
;

2147 
	}
}

2155 
	$upd©eFú°P
–
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
RCQuadøtic
 *
p_quad
, 
RCGíîic
 *
p_gí
, 
t›fõld
 )

2159 
p_quad
->
m_Qc
ı_quad->
MyInôülQp
;

2160 
p_gí
->
NumbîofBasicUnôHódîBôs
=0;

2161 
p_gí
->
NumbîofBasicUnôTextuªBôs
=0;

2162 
p_quad
->
NumbîofBasicUnô
--;

2164 if((!
t›fõld
)&&(
p_quad
->
NumbîofBasicUnô
==0))

2167 if((
p_Vid
->
a˘ive_•s
->
‰ame_mbs_⁄ly_Êag
)||(
p_I≈
->
PicI¡îœ˚
==
FIELD_CODING
))

2169 
p_quad
->
TŸÆQpf‹PPi˘uª
 +ı_quad->
m_Qc
;

2170 
p_quad
->
PªvLa°QP
ı_quad->
CuºLa°QP
;

2171 
p_quad
->
CuºLa°QP
ı_quad->
m_Qc
;

2172 
p_quad
->
PAveFømeQP
ı_quad->
m_Qc
;

2173 
p_quad
->
PAveHódîBôs3
ı_quad->
PAveHódîBôs2
;

2176 if((
p_I≈
->
PicI¡îœ˚
==
ADAPTIVE_CODING
)||’_I≈->
MbI¡îœ˚
))

2178 if(
p_gí
->
FõldC⁄åﬁ
==0)

2180 
p_quad
->
FømeQPBuf„r
ı_quad->
m_Qc
;

2181 
p_quad
->
FømeAveHódîBôs
ı_quad->
PAveHódîBôs2
;

2185 
p_quad
->
FõldQPBuf„r
ı_quad->
m_Qc
;

2186 
p_quad
->
FõldAveHódîBôs
ı_quad->
PAveHódîBôs2
;

2190 
p_quad
->
Pm_Qp
ı_quad->
m_Qc
;

2191 
p_quad
->
TŸÆFømeQP
 +ı_quad->
m_Qc
;

2192  
p_quad
->
m_Qc
;

2193 
	}
}

2201 
	$upd©eNeg©iveT¨gë
–
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
RCQuadøtic
 *
p_quad
, 
RCGíîic
 *
p_gí
, 
t›fõld
, 
m_Qp
 )

2203 
PAvîageQP
;

2205 if(
p_quad
->
GOPOvîdue
==
TRUE
)

2206 
p_quad
->
m_Qc
=
m_Qp
+2;

2208 
p_quad
->
m_Qc
=
m_Qp
+p_quad->
DDqu™t
;

2210 
p_quad
->
m_Qc
 = 
	`imö
’_quad->m_Qc, 
p_Vid
->
RCMaxQP
 +Ö_quad->
bôdïth_qp_sˇÀ
);

2211 if(
p_I≈
->
basicunô
>=
p_quad
->
MBPîRow
)

2212 
p_quad
->
m_Qc
 = 
	`imö
’_quad->m_Qc,Ö_quad->
PAveFømeQP
 + 6);

2214 
p_quad
->
m_Qc
 = 
	`imö
’_quad->m_Qc,Ö_quad->
PAveFømeQP
 + 3);

2216 
p_quad
->
TŸÆFømeQP
 +ı_quad->
m_Qc
;

2217 
p_quad
->
NumbîofBasicUnô
--;

2218 if(
p_quad
->
NumbîofBasicUnô
==0)

2220 if((!
t›fõld
)||(
p_gí
->
FõldC⁄åﬁ
==0))

2223 if((
p_Vid
->
a˘ive_•s
->
‰ame_mbs_⁄ly_Êag
)||(
p_I≈
->
PicI¡îœ˚
==
FIELD_CODING
))

2225 
PAvîageQP
=()(()
p_quad
->
TŸÆFømeQP
/(Ì_quad->
TŸÆNumbîofBasicUnô
+0.5);

2226 i‡(
p_quad
->
NumbîofPPi˘uª
 =(
p_I≈
->
öåa_≥riod
 - 2))

2227 
p_quad
->
QPLa°PFøme
 = 
PAvîageQP
;

2229 
p_quad
->
TŸÆQpf‹PPi˘uª
 +=
PAvîageQP
;

2230 if(
p_quad
->
GOPOvîdue
==
TRUE
)

2232 
p_quad
->
PªvLa°QP
ı_quad->
CuºLa°QP
+1;

2233 
p_quad
->
CuºLa°QP
=
PAvîageQP
;

2237 if((
p_quad
->
NumbîofPPi˘uª
==0)&&(
p_gí
->
NumbîofGOP
>1))

2239 
p_quad
->
PªvLa°QP
ı_quad->
CuºLa°QP
;

2240 
p_quad
->
CuºLa°QP
=
PAvîageQP
;

2242 if(
p_quad
->
NumbîofPPi˘uª
>0)

2244 
p_quad
->
PªvLa°QP
ı_quad->
CuºLa°QP
+1;

2245 
p_quad
->
CuºLa°QP
=
PAvîageQP
;

2248 
p_quad
->
PAveFømeQP
=
PAvîageQP
;

2249 
p_quad
->
PAveHódîBôs3
ı_quad->
PAveHódîBôs2
;

2252 if((
p_I≈
->
PicI¡îœ˚
==
ADAPTIVE_CODING
)||’_I≈->
MbI¡îœ˚
))

2254 if(
p_gí
->
FõldC⁄åﬁ
==0)

2256 
PAvîageQP
=()(()
p_quad
->
TŸÆFømeQP
/(Ì_quad->
TŸÆNumbîofBasicUnô
+0.5);

2257 
p_quad
->
FømeQPBuf„r
=
PAvîageQP
;

2258 
p_quad
->
FømeAveHódîBôs
ı_quad->
PAveHódîBôs2
;

2262 
PAvîageQP
=()(()
p_quad
->
TŸÆFømeQP
/(Ì_quad->
TŸÆNumbîofBasicUnô
+0.5);

2263 
p_quad
->
FõldQPBuf„r
=
PAvîageQP
;

2264 
p_quad
->
FõldAveHódîBôs
ı_quad->
PAveHódîBôs2
;

2269 if(
p_quad
->
GOPOvîdue
==
TRUE
)

2270 
p_quad
->
Pm_Qp
ı_quad->
PAveFømeQP
;

2272 
p_quad
->
Pm_Qp
ı_quad->
m_Qc
;

2274  
p_quad
->
m_Qc
;

2275 
	}
}

2283 
	$upd©eFú°BU
–
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
RCQuadøtic
 *
p_quad
, 
RCGíîic
 *
p_gí
, 
t›fõld
 )

2286 if(((
p_I≈
->
PicI¡îœ˚
==
ADAPTIVE_CODING
)||’_I≈->
MbI¡îœ˚
))&&(
p_gí
->
FõldC⁄åﬁ
==0))

2289 if(
p_gí
->
FõldFøme
==1)

2291 if(
p_quad
->
NumbîofPPi˘uª
>0)

2292 
p_quad
->
TŸÆQpf‹PPi˘uª
 +ı_quad->
FømeQPBuf„r
;

2293 
p_quad
->
PAveFømeQP
ı_quad->
FømeQPBuf„r
;

2294 
p_quad
->
PAveHódîBôs3
ı_quad->
FømeAveHódîBôs
;

2299 if(
p_quad
->
NumbîofPPi˘uª
>0)

2300 
p_quad
->
TŸÆQpf‹PPi˘uª
 +ı_quad->
FõldQPBuf„r
;

2301 
p_quad
->
PAveFømeQP
ı_quad->
FõldQPBuf„r
;

2302 
p_quad
->
PAveHódîBôs3
ı_quad->
FõldAveHódîBôs
;

2306 if(
p_quad
->
T¨gë
<=0)

2308 
p_quad
->
m_Qc
 =Ö_quad->
PAveFømeQP
 + 2;

2309 if(
p_quad
->
m_Qc
 > (
p_Vid
->
RCMaxQP
 +Ö_quad->
bôdïth_qp_sˇÀ
))

2310 
p_quad
->
m_Qc
 = 
p_Vid
->
RCMaxQP
 +Ö_quad->
bôdïth_qp_sˇÀ
;

2312 if(
t›fõld
||(
p_gí
->
FõldC⁄åﬁ
==0))

2313 
p_quad
->
GOPOvîdue
=
TRUE
;

2317 
p_quad
->
m_Qc
ı_quad->
PAveFømeQP
;

2319 
p_quad
->
TŸÆFømeQP
 +ı_quad->
m_Qc
;

2320 
p_quad
->
NumbîofBasicUnô
--;

2321 
p_quad
->
Pm_Qp
 =Ö_quad->
PAveFømeQP
;

2323  
p_quad
->
m_Qc
;

2324 
	}
}

2332 
	$upd©eLa°BU
–
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
RCQuadøtic
 *
p_quad
, 
RCGíîic
 *
p_gí
, 
t›fõld
 )

2334 
PAvîageQP
;

2336 if((!
t›fõld
)||(
p_gí
->
FõldC⁄åﬁ
==0))

2339 if((
p_Vid
->
a˘ive_•s
->
‰ame_mbs_⁄ly_Êag
)||(
p_I≈
->
PicI¡îœ˚
==
FIELD_CODING
))

2341 
PAvîageQP
=()(()
p_quad
->
TŸÆFømeQP
/(Ëp_quad->
TŸÆNumbîofBasicUnô
+0.5);

2342 i‡(
p_quad
->
NumbîofPPi˘uª
 =(
p_I≈
->
öåa_≥riod
 - 2))

2343 
p_quad
->
QPLa°PFøme
 = 
PAvîageQP
;

2345 
p_quad
->
TŸÆQpf‹PPi˘uª
 +=
PAvîageQP
;

2346 
p_quad
->
PªvLa°QP
ı_quad->
CuºLa°QP
;

2347 
p_quad
->
CuºLa°QP
=
PAvîageQP
;

2348 
p_quad
->
PAveFømeQP
=
PAvîageQP
;

2349 
p_quad
->
PAveHódîBôs3
ı_quad->
PAveHódîBôs2
;

2351 if((
p_I≈
->
PicI¡îœ˚
==
ADAPTIVE_CODING
)||’_I≈->
MbI¡îœ˚
))

2353 if(
p_gí
->
FõldC⁄åﬁ
==0)

2355 
PAvîageQP
=()((Ë
p_quad
->
TŸÆFømeQP
/(Ì_quad->
TŸÆNumbîofBasicUnô
+0.5);

2356 
p_quad
->
FømeQPBuf„r
=
PAvîageQP
;

2357 
p_quad
->
FømeAveHódîBôs
ı_quad->
PAveHódîBôs2
;

2361 
PAvîageQP
=()((Ë
p_quad
->
TŸÆFømeQP
/(Ëp_quad->
TŸÆNumbîofBasicUnô
+0.5);

2362 
p_quad
->
FõldQPBuf„r
=
PAvîageQP
;

2363 
p_quad
->
FõldAveHódîBôs
ı_quad->
PAveHódîBôs2
;

2367 
	}
}

2375 
	$¥edi˘CuºPicMAD
–
I≈utP¨amëîs
 *
p_I≈
, 
RCQuadøtic
 *
p_quad
, 
RCGíîic
 *
p_gí
 )

2377 
i
;

2378 if(((
p_I≈
->
PicI¡îœ˚
==
ADAPTIVE_CODING
)||’_I≈->
MbI¡îœ˚
))&&(
p_gí
->
FõldC⁄åﬁ
==1))

2380 
p_quad
->
CuºítFømeMAD
ı_quad->
MADPi˘uªC1
*p_quad->
FCBUPFMAD
[p_quad->
TŸÆNumbîofBasicUnô
-p_quad->
NumbîofBasicUnô
]+p_quad->
MADPi˘uªC2
;

2381 
p_quad
->
TŸÆBUMAD
=0;

2382 
i
=
p_quad
->
TŸÆNumbîofBasicUnô
-1; i>=’_quad->TŸÆNumbîofBasicUnô-p_quad->
NumbîofBasicUnô
);i--)

2384 
p_quad
->
CuºítBUMAD
ı_quad->
MADPi˘uªC1
*p_quad->
FCBUPFMAD
[
i
]+p_quad->
MADPi˘uªC2
;

2385 
p_quad
->
TŸÆBUMAD
 +ı_quad->
CuºítBUMAD
*p_quad->CurrentBUMAD;

2390 
p_quad
->
CuºítFømeMAD
ı_quad->
MADPi˘uªC1
*p_quad->
BUPFMAD
[p_quad->
TŸÆNumbîofBasicUnô
-p_quad->
NumbîofBasicUnô
]+p_quad->
MADPi˘uªC2
;

2391 
p_quad
->
TŸÆBUMAD
=0;

2392 
i
=
p_quad
->
TŸÆNumbîofBasicUnô
-1; i>=’_quad->TŸÆNumbîofBasicUnô-p_quad->
NumbîofBasicUnô
);i--)

2394 
p_quad
->
CuºítBUMAD
ı_quad->
MADPi˘uªC1
*p_quad->
BUPFMAD
[
i
]+p_quad->
MADPi˘uªC2
;

2395 
p_quad
->
TŸÆBUMAD
 +ı_quad->
CuºítBUMAD
*p_quad->CurrentBUMAD;

2398 
	}
}

2406 
	$upd©eModñQPBU
–
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
RCQuadøtic
 *
p_quad
, 
m_Qp
 )

2408 
dtmp
, 
m_Q°ï
;

2409 
m_Bôs
;

2411 
m_Bôs
 =()(
p_quad
->
T¨gë
 *Ö_quad->
CuºítFømeMAD
 *Ö_quad->CuºítFømeMAD /Ö_quad->
TŸÆBUMAD
);

2413 
m_Bôs
 -=
p_quad
->
PAveHódîBôs2
;

2415 
m_Bôs
=
	`imax
(m_Bôs,()(
p_quad
->
bô_øã
/(
MINVALUE
*p_quad->
‰ame_øã
*p_quad->
TŸÆNumbîofBasicUnô
)));

2417 
dtmp
 = 
p_quad
->
CuºítFømeMAD
 *Ö_quad->CuºítFømeMAD *Ö_quad->
m_X1
 *Ö_quad->m_X1 \

2418 + 4 * 
p_quad
->
m_X2
 *Ö_quad->
CuºítFømeMAD
 * 
m_Bôs
;

2419 i‡((
p_quad
->
m_X2
 =0.0Ë|| (
dtmp
 < 0Ë|| ((
	`sqπ
 (dtmpË-Ö_quad->
m_X1
 *Ö_quad->
CuºítFømeMAD
) <= 0.0))

2420 
m_Q°ï
 = ()(
p_quad
->
m_X1
 *Ö_quad->
CuºítFømeMAD
 / (Ë
m_Bôs
);

2422 
m_Q°ï
 = (Ë((2 * 
p_quad
->
m_X2
 *Ö_quad->
CuºítFømeMAD
Ë/ (
	`sqπ
 (
dtmp
Ë-Ö_quad->
m_X1
 *Ö_quad->CurrentFrameMAD));

2424 
p_quad
->
m_Qc
 = 
	`Q°ï2QP
(
m_Q°ï
,Ö_quad->
bôdïth_qp_sˇÀ
);

2425 
p_quad
->
m_Qc
 = 
	`imö
(
m_Qp
+p_quad->
DDqu™t
,Ö_quad->m_Qc);

2427 if(
p_I≈
->
basicunô
>=
p_quad
->
MBPîRow
)

2428 
p_quad
->
m_Qc
 = 
	`imö
’_quad->
PAveFømeQP
+6,Ö_quad->m_Qc);

2430 
p_quad
->
m_Qc
 = 
	`imö
’_quad->
PAveFømeQP
+3,Ö_quad->m_Qc);

2432 
p_quad
->
m_Qc
 = 
	`iClù3
(
m_Qp
-p_quad->
DDqu™t
, 
p_Vid
->
RCMaxQP
 +Ö_quad->
bôdïth_qp_sˇÀ
,Ö_quad->m_Qc);

2433 if(
p_I≈
->
basicunô
>=
p_quad
->
MBPîRow
)

2434 
p_quad
->
m_Qc
 = 
	`imax
’_quad->
PAveFømeQP
-6,Ö_quad->m_Qc);

2436 
p_quad
->
m_Qc
 = 
	`imax
’_quad->
PAveFømeQP
-3,Ö_quad->m_Qc);

2438 
p_quad
->
m_Qc
 = 
	`imax
(
p_Vid
->
RCMöQP
 +Ö_quad->
bôdïth_qp_sˇÀ
,Ö_quad->m_Qc);

2439 
	}
}

2447 
	$upd©eQPI¡îœ˚BU
–
RCQuadøtic
 *
p_quad
, 
RCGíîic
 *
p_gí
 )

2450 if(
p_gí
->
FõldFøme
==1)

2452 
p_quad
->
TŸÆQpf‹PPi˘uª
 +ı_quad->
FømeQPBuf„r
;

2453 
p_quad
->
Pm_Qp
ı_quad->
FømeQPBuf„r
;

2458 
p_quad
->
TŸÆQpf‹PPi˘uª
 +ı_quad->
FõldQPBuf„r
;

2459 
p_quad
->
Pm_Qp
ı_quad->
FõldQPBuf„r
;

2461 
	}
}

2469 
	$upd©eModñQPFøme
–
RCQuadøtic
 *
p_quad
, 
m_Bôs
 )

2471 
dtmp
, 
m_Q°ï
;

2473 
dtmp
 = 
p_quad
->
CuºítFømeMAD
 *Ö_quad->
m_X1
 *Ö_quad->CurrentFrameMAD *Ö_quad->m_X1

2474 + 4 * 
p_quad
->
m_X2
 *Ö_quad->
CuºítFømeMAD
 * 
m_Bôs
;

2475 i‡((
p_quad
->
m_X2
 =0.0Ë|| (
dtmp
 < 0Ë|| ((
	`sqπ
 (dtmpË-Ö_quad->
m_X1
 *Ö_quad->
CuºítFømeMAD
) <= 0.0))

2476 
m_Q°ï
 = (Ë(
p_quad
->
m_X1
 *Ö_quad->
CuºítFømeMAD
 / (Ë
m_Bôs
);

2478 
m_Q°ï
 = (Ë((2 * 
p_quad
->
m_X2
 *Ö_quad->
CuºítFømeMAD
Ë/ (
	`sqπ
 (
dtmp
Ë-Ö_quad->
m_X1
 *Ö_quad->CurrentFrameMAD));

2480 
p_quad
->
m_Qc
 = 
	`Q°ï2QP
(
m_Q°ï
,Ö_quad->
bôdïth_qp_sˇÀ
);

2481 
	}
}

2489 
	$rc_h™dÀ_mb
–
Ma¸oblock
 *
cuºMB
, 
¥ev_mb
 )

2491 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

2492 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

2493 
Ma¸oblock
 *
¥evMB
 = 
cuºMB
->
PªvMB
;

2494 
mb_qp
 = 
p_Vid
->
qp
;

2495 
RCGíîic
 *
p_gí
 = 
p_Vid
->
p_rc_gí
;

2496 
RCQuadøtic
 *
p_quad
 = 
p_Vid
->
p_rc_quad
;

2498 i‡(
¥ev_mb
 > -1)

2500 i‡–
p_I≈
->
MbI¡îœ˚
 =
ADAPTIVE_CODING
 && !
p_Vid
->
bŸ_MB
 && 
cuºMB
->
mb_fõld
 )

2501 
mb_qp
 = 
¥evMB
->
qp
;

2505 i‡(
p_I≈
->
basicunô
 !
p_Vid
->
FømeSizeInMbs
)

2508 i‡–((
p_Vid
->
ty≥
 =
I_SLICE
 ||Ö_Vid->ty≥ =
B_SLICE
Ë&& 
p_I≈
->
RCUpd©eMode
 !
RC_MODE_1
 ) || !’_Vid->
numbî
) )

2510  
mb_qp
;

2512 i‡–
p_Vid
->
ty≥
 =
P_SLICE
 || 
p_I≈
->
RCUpd©eMode
 =
RC_MODE_1
 )

2514 i‡(!
p_Vid
->
wrôe_ma¸oblock
)

2516 i‡(
¥ev_mb
 > -1)

2518 i‡(!((
p_I≈
->
MbI¡îœ˚
Ë&& 
p_Vid
->
bŸ_MB
))

2520 i‡(
¥evMB
->
¥ev_cbp
 != 1)

2522 
mb_qp
 = 
¥evMB
->
¥ev_qp
;

2530 i‡(!
p_Vid
->
wrôe_ma¸oblock
)

2532 if(!((
p_I≈
->
MbI¡îœ˚
Ë&& 
p_Vid
->
bŸ_MB
))

2534 if(
p_I≈
->
RCUpd©eMode
 <
MAX_RC_MODE
 && (
p_Vid
->
NumbîofCodedMa¸oBlocks
 > 0Ë&& (p_Vid->NumbîofCodedMa¸oBlock†%Ö_Vid->
BasicUnô
 == 0))

2536 
	`upd©eRCModñ
(
p_Vid
, 
p_I≈
, 
p_quad
, 
p_gí
);

2538 if(
p_Vid
->
a˘ive_•s
->
‰ame_mbs_⁄ly_Êag
)

2540 
p_Vid
->
BasicUnôQP
 =Ö_Vid->
	`upd©eQP
’_Vid, 
p_I≈
, 
p_quad
, 
p_gí
,Ö_gí->
T›FõldFœg
Ë-Ö_quad->
bôdïth_qp_sˇÀ
;

2543 if(
p_I≈
->
MbI¡îœ˚
 || (’_I≈->
PicI¡îœ˚
!=
FRAME_CODING
Ë&& (
p_gí
->
NoGønuœrFõldRC
==0)))

2545 
p_Vid
->
BasicUnôQP
 =Ö_Vid->
	`upd©eQP
’_Vid, 
p_I≈
, 
p_quad
, 
p_gí
,Ö_gí->
T›FõldFœg
Ë-Ö_quad->
bôdïth_qp_sˇÀ
;

2549 if(
p_Vid
->
cuºít_mb_ƒ
==0)

2550 
p_Vid
->
BasicUnôQP
 = 
mb_qp
;

2553 
mb_qp
 = 
p_Vid
->
BasicUnôQP
;

2554 
mb_qp
 = 
	`iClù3
(
MIN_QP
 - 
p_Vid
->
bôdïth_luma_qp_sˇÀ
, 
MAX_QP
, mb_qp);

2559  
mb_qp
;

2560 
	}
}

2568 
	$rc_öô_t›_fõld
 ( 
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
 )

2570 
RCGíîic
 *
p_gí
 = 
p_Vid
->
p_rc_gí
;

2571 
RCQuadøtic
 *
p_quad
 = 
p_Vid
->
p_rc_quad
;

2573 
p_Vid
->
BasicUnô
 = 
p_I≈
->
basicunô
;

2574 
p_gí
->
T›FõldFœg
 = 1;

2575 
p_Vid
->
	`rc_öô_pi˘_±r
’_Vid, 
p_I≈
, 
p_quad
, 
p_gí
, 0, 1, (p_I≈->
PicI¡îœ˚
 =
FIELD_CODING
), 1.0F);

2576 
p_Vid
->
p_cuº_‰m_°ru˘
->
qp
 =Ö_Vid->q∞p_Vid->
	`upd©eQP
’_Vid, 
p_I≈
, 
p_quad
, 
p_gí
, 1Ë-Ö_quad->
bôdïth_qp_sˇÀ
;

2577 
	}
}

2585 
	$rc_öô_bŸtom_fõld
 ( 
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
T›FõldBôs
 )

2587 
RCGíîic
 *
p_gí
 = 
p_Vid
->
p_rc_gí
;

2588 
RCQuadøtic
 *
p_quad
 = 
p_Vid
->
p_rc_quad
;

2590 
p_quad
->
bôs_t›fõld
 = 
T›FõldBôs
;

2591 
p_gí
->
T›FõldFœg
 = 0;

2592 
p_Vid
->
	`rc_öô_pi˘_±r
’_Vid, 
p_I≈
, 
p_quad
, 
p_gí
, 0,0,0, 1.0F);

2593 
p_Vid
->
p_cuº_‰m_°ru˘
->
qp
 =Ö_Vid->q∞p_Vid->
	`upd©eQP
’_Vid, 
p_I≈
, 
p_quad
, 
p_gí
, 0Ë-Ö_quad->
bôdïth_qp_sˇÀ
;

2594 
	}
}

2602 
	$rc_öô_‰ame_rdpic
–
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
øãR©io
 )

2604 
RCGíîic
 *
p_gí
 = 
p_Vid
->
p_rc_gí
;

2605 
RCGíîic
 *
p_gí_öô
 = 
p_Vid
->
p_rc_gí_öô
;

2606 
RCQuadøtic
 *
p_quad
 = 
p_Vid
->
p_rc_quad
;

2607 
RCQuadøtic
 *
p_quad_öô
 = 
p_Vid
->
p_rc_quad_öô
;

2609 
p_I≈
->
RCUpd©eMode
)

2611 
RC_MODE_0
: 
RC_MODE_1
: 
RC_MODE_2
: 
RC_MODE_3
:

2613 
	`rc_c›y_quadøtic
–
p_Vid
, 
p_I≈
, 
p_quad
, 
p_quad_öô
 );

2614 
	`rc_c›y_gíîic
–
p_Vid
, 
p_gí
, 
p_gí_öô
 );

2615 
p_Vid
->
	`rc_öô_pi˘_±r
’_Vid, 
p_I≈
, 
p_quad
, 
p_gí
, 1, 0, 1, 
øãR©io
 );

2616 
p_Vid
->
p_cuº_‰m_°ru˘
->
qp
 =Ö_Vid->q∞p_Vid->
	`upd©eQP
’_Vid, 
p_I≈
, 
p_quad
, 
p_gí
, 0Ë-Ö_quad->
bôdïth_qp_sˇÀ
;

2621 
	}
}

2629 
	$rc_Æloˇã_mem‹y
–
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
 )

2631 
p_I≈
->
RCUpd©eMode
)

2633 
RC_MODE_0
:

2634 
RC_MODE_1
:

2635 
RC_MODE_2
:

2636 
RC_MODE_3
:

2637 
	`rc_Æloc_gíîic
–
p_Vid
, &p_Vid->
p_rc_gí
 );

2638 
	`rc_Æloc_quadøtic
–
p_Vid
, 
p_I≈
, &p_Vid->
p_rc_quad
 );

2640 i‡–
p_I≈
->
RDPi˘uªDecisi⁄
 ||Ö_I≈->
MbI¡îœ˚
 =
ADAPTIVE_CODING
 ||Ö_I≈->
PicI¡îœ˚
 == ADAPTIVE_CODING )

2642 
	`rc_Æloc_gíîic
–
p_Vid
, &p_Vid->
p_rc_gí_öô
 );

2643 
	`rc_Æloc_quadøtic
–
p_Vid
, 
p_I≈
, &p_Vid->
p_rc_quad_öô
 );

2644 
	`rc_Æloc_gíîic
–
p_Vid
, &p_Vid->
p_rc_gí_be°
 );

2645 
	`rc_Æloc_quadøtic
–
p_Vid
, 
p_I≈
, &p_Vid->
p_rc_quad_be°
 );

2651 
	}
}

2659 
	$rc_‰ì_mem‹y
–
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
 )

2661 
p_I≈
->
RCUpd©eMode
)

2663 
RC_MODE_0
:

2664 
RC_MODE_1
:

2665 
RC_MODE_2
:

2666 
RC_MODE_3
:

2667 
	`rc_‰ì_gíîic
–&
p_Vid
->
p_rc_gí
 );

2668 
	`rc_‰ì_quadøtic
–&
p_Vid
->
p_rc_quad
 );

2670 i‡–
p_I≈
->
RDPi˘uªDecisi⁄
 ||Ö_I≈->
MbI¡îœ˚
 =
ADAPTIVE_CODING
 ||Ö_I≈->
PicI¡îœ˚
 == ADAPTIVE_CODING )

2672 
	`rc_‰ì_gíîic
–&
p_Vid
->
p_rc_gí_öô
 );

2673 
	`rc_‰ì_quadøtic
–&
p_Vid
->
p_rc_quad_öô
 );

2674 
	`rc_‰ì_gíîic
–&
p_Vid
->
p_rc_gí_be°
 );

2675 
	`rc_‰ì_quadøtic
–&
p_Vid
->
p_rc_quad_be°
 );

2681 
	}
}

2689 
	$rc_upd©e_mb_°©s
(
Ma¸oblock
 *
cuºMB
)

2691 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

2692 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

2693 
BôCou¡î
 *
mbBôs
 = &
cuºMB
->
bôs
;

2694 
RCGíîic
 *
p_gí
 = 
p_Vid
->
p_rc_gí
;

2697 
p_Vid
->
NumbîofMBHódîBôs
 = 
mbBôs
->
mb_mode
 + mbBôs->
mb_öãr


2698 + 
mbBôs
->
mb_cbp
 + mbBôs->
mb_dñè_qu™t
;

2699 
p_Vid
->
NumbîofMBTextuªBôs
 = 
mbBôs
->
mb_y_c€ff
 + mbBôs->
mb_uv_c€ff
;

2701 
p_I≈
->
RCUpd©eMode
)

2703 
RC_MODE_0
: 
RC_MODE_1
: 
RC_MODE_2
: 
RC_MODE_3
:

2704 
p_gí
->
NumbîofTextuªBôs
 +
p_Vid
->
NumbîofMBTextuªBôs
;

2705 
p_gí
->
NumbîofHódîBôs
 +
p_Vid
->
NumbîofMBHódîBôs
;

2707 if(
p_Vid
->
BasicUnô
 <Ö_Vid->
FømeSizeInMbs
)

2709 
p_gí
->
NumbîofBasicUnôHódîBôs
 +
p_Vid
->
NumbîofMBHódîBôs
;

2710 
p_gí
->
NumbîofBasicUnôTextuªBôs
 +
p_Vid
->
NumbîofMBTextuªBôs
;

2716 
	}
}

2724 
	$rc_ßve_°©e
–
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
 )

2726 
p_I≈
->
RCUpd©eMode
)

2728 
RC_MODE_0
: 
RC_MODE_1
: 
RC_MODE_2
: 
RC_MODE_3
:

2729 
	`rc_c›y_quadøtic
–
p_Vid
, 
p_I≈
,Ö_Vid->
p_rc_quad_be°
,Ö_Vid->
p_rc_quad
 );

2730 
	`rc_c›y_gíîic
–
p_Vid
,Ö_Vid->
p_rc_gí_be°
,Ö_Vid->
p_rc_gí
 );

2735 
	}
}

2743 
	$rc_ª°‹e_°©e
–
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
 )

2745 
p_I≈
->
RCUpd©eMode
)

2747 
RC_MODE_0
: 
RC_MODE_1
: 
RC_MODE_2
: 
RC_MODE_3
:

2748 
	`rc_c›y_quadøtic
–
p_Vid
, 
p_I≈
,Ö_Vid->
p_rc_quad
,Ö_Vid->
p_rc_quad_be°
 );

2749 
	`rc_c›y_gíîic
–
p_Vid
,Ö_Vid->
p_rc_gí
,Ö_Vid->
p_rc_gí_be°
 );

2754 
	}
}

	@lencod/src/rd_intra_jm.c

18 
	~<limôs.h
>

20 
	~"globÆ.h
"

22 
	~"image.h
"

23 
	~"ma¸oblock.h
"

24 
	~"mb_ac˚ss.h
"

25 
	~"rd›t_codög_°©e.h
"

26 
	~"mode_decisi⁄.h
"

27 
	~"rd›t.h
"

28 
	~"rd_öåa_jm.h
"

29 
	~"q_¨ound.h
"

30 
	~"öåa4x4.h
"

31 
	~"öåa8x8.h
"

32 
	~"md_comm⁄.h
"

33 
	~"å™sf‹m8x8.h
"

34 
	~"md_di°‹ti⁄.h
"

35 
	~"ñemíts.h
"

36 
	~"symbﬁ.h
"

37 
	~"öåa16x16.h
"

38 
	~"öåa4x4.h
"

39 
	~"öåa8x8.h
"

41 
MBTy≥2VÆue
 (
Ma¸oblock
* 
cuºMB
);

49 
	$mode_decisi⁄_f‹_I4x4_blocks_JM_High
 (
Ma¸oblock
 *
cuºMB
, 
b8
, 
b4
, 
œmbda
, 
di°blk
* 
mö_co°
)

51 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

52 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

53 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

54 
RDOPTSåu˘uª
 *
p_RDO
 = 
cuºSli˚
->p_RDO;

56 
ùmode
, 
be°_ùmode
 = 0, 
y
;

57 
avaûabÀ_mode
;

58 
c_nz
, 
n⁄zîo
 = 0;

59 * 
ACLevñ
 = 
cuºSli˚
->
cofAC
[
b8
][
b4
][0];

60 * 
ACRun
 = 
cuºSli˚
->
cofAC
[
b8
][
b4
][1];

61 
di°blk
 
rdco°
 = 0;

62 
di°blk
 
mö_rdco°
 = 
DISTBLK_MAX
;

63 
block_x
 = ((
b8
 & 0x01Ë<< 3Ë+ ((
b4
 & 0x01) << 2);

64 
block_y
 = ((
b8
 >> 1Ë<< 3Ë+ ((
b4
 >> 1) << 2);

65 
pic_pix_x
 = 
cuºMB
->
pix_x
 + 
block_x
;

66 
pic_pix_y
 = 
cuºMB
->
pix_y
 + 
block_y
;

67 
pic_›ix_x
 = 
cuºMB
->
pix_x
 + 
block_x
;

68 
pic_›ix_y
 = 
cuºMB
->
›ix_y
 + 
block_y
;

69 
pic_block_x
 = 
pic_pix_x
 >> 2;

70 
pic_block_y
 = 
pic_pix_y
 >> 2;

72 
À·_avaûabÀ
, 
up_avaûabÀ
, 
Æl_avaûabÀ
;

73 *
mb_size
 = 
p_Vid
->mb_size[
IS_LUMA
];

75 
upMode
, 
À·Mode
;

76 
mo°ProbabÀMode
;

78 
PixñPos
 
À·_block
, 
t›_block
;

80 
Ãec4x4
[4][4];

81 
be°_nz_c€ff
 = 0;

82 
block_x4
 = 
block_x
>>2;

83 
block_y4
 = 
block_y
>>2;

85 #ifde‡
BEST_NZ_COEFF


86 
be°_coded_block_Êag
 = 0;

87 
bô_pos
 = 1 + ((((
b8
>>1)<<1)+(
b4
>>1))<<2) + (((b8&1)<<1)+(b4&1));

88 
öt64
 
cbp_bôs
;

90 i‡(
b8
==0 && 
b4
==0)

91 
cbp_bôs
 = 0;

94 
	`gë4x4Neighbour
(
cuºMB
, 
block_x
 - 1, 
block_y
 , 
mb_size
, &
À·_block
);

95 
	`gë4x4Neighbour
(
cuºMB
, 
block_x
, 
block_y
 - 1, 
mb_size
, &
t›_block
 );

98 i‡(
p_I≈
->
U£C⁄°øöedI¡øPªd
)

100 
À·_block
.
avaûabÀ
 =Üe·_block.avaûabÀ ? 
p_Vid
->
öåa_block
[À·_block.
mb_addr
] : 0;

101 
t›_block
.
avaûabÀ
 =Å›_block.avaûabÀ ? 
p_Vid
->
öåa_block
[t›_block.
mb_addr
] : 0;

104 
upMode
 = 
t›_block
.
avaûabÀ
 ? 
p_Vid
->
ùªdmode
[t›_block.
pos_y
 ][t›_block.
pos_x
 ] : () -1;

105 
À·Mode
 = 
À·_block
.
avaûabÀ
 ? 
p_Vid
->
ùªdmode
[À·_block.
pos_y
][À·_block.
pos_x
] : () -1;

107 
mo°ProbabÀMode
 = (
upMode
 < 0 || 
À·Mode
 < 0Ë? 
DC_PRED
 : upMode <ÜeftMode ? upMode :ÜeftMode;

108 *
mö_co°
 = 
DISTBLK_MAX
;

110 
cuºMB
->
ùmode_DPCM
 = 
NO_INTRA_PMODE
;

114 
cuºSli˚
->
	`£t_öå≠ªd_4x4
(
cuºMB
, 
PLANE_Y
, 
pic_pix_x
, 
pic_pix_y
, &
À·_avaûabÀ
, &
up_avaûabÀ
, &
Æl_avaûabÀ
);

117 
ùmode
 = 0; ipmodê< 
NO_INTRA_PMODE
; ipmode++)

119 
avaûabÀ_mode
 = (
Æl_avaûabÀ
Ë|| (
ùmode
==
DC_PRED
) ||

120 (
up_avaûabÀ
 && (
ùmode
==
VERT_PRED
||ùmode==
VERT_LEFT_PRED
||ùmode==
DIAG_DOWN_LEFT_PRED
)) ||

121 (
À·_avaûabÀ
 && (
ùmode
==
HOR_PRED
||ùmode==
HOR_UP_PRED
));

123 i‡(
	`vÆid_öåa_mode
(
cuºSli˚
, 
ùmode
) == 0)

126 if–
avaûabÀ_mode
)

129 
	`gë_öå≠ªd_4x4
(
cuºMB
, 
PLANE_Y
, 
ùmode
, 
block_x
, 
block_y
, 
À·_avaûabÀ
, 
up_avaûabÀ
);

132 
	`gíî©e_¥ed_îr‹_4x4
(&
p_Vid
->
pCurImg
[
pic_›ix_y
], 
cuºSli˚
->
m¥_4x4
[0][
ùmode
], &cuºSli˚->
mb_¥ed
[0][
block_y
], &cuºSli˚->
mb_‹es
[0][block_y], 
pic_›ix_x
, 
block_x
);

135 #ifde‡
BEST_NZ_COEFF


136 
cuºMB
->
cbp_bôs
[0] = cbp_bits;

139 
rdco°
 = 
cuºSli˚
->
	`rdco°_f‹_4x4_öåa_blocks
 (
cuºMB
, &
c_nz
, 
b8
, 
b4
, 
ùmode
, 
œmbda
, 
mo°ProbabÀMode
, 
mö_rdco°
);

140 i‡((
rdco°
 < 
mö_rdco°
Ë|| (rdco° =mö_rdco° && 
ùmode
 =
mo°ProbabÀMode
))

143 
	`mem˝y
(
p_RDO
->
cofAC4x4
[0], 
ACLevñ
, 18 * ());

144 
	`mem˝y
(
p_RDO
->
cofAC4x4
[1], 
ACRun
, 18 * ());

147 
	`c›y_4x4block
(
p_RDO
->
ªc4x4
[
PLANE_Y
], &
p_Vid
->
íc_pi˘uª
->
imgY
[
pic_pix_y
], 0, 
pic_pix_x
);

150 if(
cuºSli˚
->
¶i˚_ty≥
 =
SP_SLICE
 && !cuºSli˚->
•2_‰ame_ödiˇt‹
)

152 
y
=0; y<4; y++)

154 
	`mem˝y
(
Ãec4x4
[
y
],&
p_Vid
->
Ãec
[
pic_pix_y
+y][
pic_pix_x
], 
BLOCK_SIZE
 * ());

159 
n⁄zîo
 = 
c_nz
;

162 *
mö_co°
 = 
rdco°
;

163 
mö_rdco°
 = 
rdco°
;

164 
be°_ùmode
 = 
ùmode
;

166 
be°_nz_c€ff
 = 
p_Vid
->
nz_c€ff
 [
cuºMB
->
mbAddrX
][
block_x4
][
block_y4
];

167 #ifde‡
BEST_NZ_COEFF


168 
be°_coded_block_Êag
 = ()((
cuºMB
->
cbp_bôs
[0] >> 
bô_pos
)&(
öt64
)(1));

170 i‡(
p_Vid
->
Ad≠tiveRoundög
)

172 
	`°‹e_ad≠tive_roundög_4x4
 (
p_Vid
,Ö_Vid->
ARCofAdj4x4
, 
I4MB
, 
block_y
, 
block_x
);

177 #i‡
INTRA_RDCOSTCALC_NNZ


178 
p_Vid
->
nz_c€ff
 [
cuºMB
->
mbAddrX
][
block_x4
][
block_y4
] = 
be°_nz_c€ff
;

180 #ifde‡
BEST_NZ_COEFF


181 
cbp_bôs
 &(~(
öt64
)(1<<
bô_pos
));

182 
cbp_bôs
 |(
öt64
)(
be°_coded_block_Êag
<<
bô_pos
);

186 
p_Vid
->
ùªdmode
[
pic_block_y
][
pic_block_x
] = (Ë
be°_ùmode
;

187 
cuºMB
->
öåa_¥ed_modes
[4*
b8
+
b4
] =

188 (Ë(
mo°ProbabÀMode
 =
be°_ùmode
 ? -1 : (best_ipmode < mostProbableMode ? best_ipmode : best_ipmode-1));

191 
	`mem˝y
 (
ACLevñ
, 
p_RDO
->
cofAC4x4
[0], 18 * ());

192 
	`mem˝y
 (
ACRun
, 
p_RDO
->
cofAC4x4
[1], 18 * ());

195 
	`c›y_4x4block
(&
p_Vid
->
íc_pi˘uª
->
imgY
[
pic_pix_y
], 
p_RDO
->
ªc4x4
[
PLANE_Y
], 
pic_pix_x
, 0);

196 
	`c›y_4x4block
(&
cuºSli˚
->
mb_¥ed
[0][
block_y
], cuºSli˚->
m¥_4x4
[0][
be°_ùmode
], 
block_x
, 0);

199 if(
cuºSli˚
->
¶i˚_ty≥
 =
SP_SLICE
 && !cuºSli˚->
•2_‰ame_ödiˇt‹
)

201 
y
=0; y<
BLOCK_SIZE
; y++)

203 
	`mem˝y
 (&
p_Vid
->
Ãec
[
pic_pix_y
+
y
][
pic_pix_x
], 
Ãec4x4
[y], 
BLOCK_SIZE
 * ());

207 i‡(
p_Vid
->
Ad≠tiveRoundög
)

209 
	`upd©e_ad≠tive_roundög_4x4
 (
p_Vid
,p_Vid->
ARCofAdj4x4
, 
I4MB
, 
block_y
, 
block_x
);

212  
n⁄zîo
;

213 
	}
}

221 
	$mode_decisi⁄_f‹_I8x8_blocks_JM_High
 (
Ma¸oblock
 *
cuºMB
, 
b8
, 
œmbda
, 
di°blk
 *
mö_co°
)

223 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

224 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

225 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

226 
RDOPTSåu˘uª
 *
p_RDO
 = 
cuºSli˚
->p_RDO;

228 
ùmode
, 
be°_ùmode
 = 0, 
j
;

229 
c_nz
, 
n⁄zîo
 = 0;

230 
di°blk
 
rdco°
 = 0;

231 
di°blk
 
mö_rdco°
 = 
DISTBLK_MAX
;

232 
block_x
 = (
b8
 & 0x01) << 3;

233 
block_y
 = (
b8
 >> 1) << 3;

234 
pic_pix_x
 = 
cuºMB
->
pix_x
 + 
block_x
;

235 
pic_pix_y
 = 
cuºMB
->
pix_y
 + 
block_y
;

236 
pic_›ix_x
 = 
cuºMB
->
pix_x
 + 
block_x
;

237 
pic_›ix_y
 = 
cuºMB
->
›ix_y
 + 
block_y
;

238 
pic_block_x
 = 
pic_pix_x
 >> 2;

239 
pic_block_y
 = 
pic_pix_y
 >> 2;

240 
mb_block_y
 = (
cuºMB
->
block_y
Ë+ ((
b8
 >> 1) << 1);

241 
mb_block_x
 = (
cuºMB
->
block_x
Ë+ ((
b8
 & 0x01) << 1);

242 *
p_AC8x8
 = 
p_RDO
->
c€fAC8x8öåa
[
b8
][0][0][0];

243 *
cofAC
 = 
cuºSli˚
->cofAC[
b8
][0][0];

245 
À·_avaûabÀ
, 
up_avaûabÀ
, 
Æl_avaûabÀ
;

246 **
mb_‹es
 = 
cuºSli˚
->mb_ores[0];

247 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_pred[0];

249 
upMode
, 
À·Mode
;

250 
mo°ProbabÀMode
;

252 
PixñPos
 
À·_block
, 
t›_block
;

254 *
mb_size
 = 
p_Vid
->mb_size[
IS_LUMA
];

256 
	`gë4x4Neighbour
(
cuºMB
, 
block_x
 - 1, 
block_y
 , 
mb_size
, &
À·_block
);

257 
	`gë4x4Neighbour
(
cuºMB
, 
block_x
, 
block_y
 - 1, 
mb_size
, &
t›_block
 );

260 i‡(
p_I≈
->
U£C⁄°øöedI¡øPªd
)

262 
À·_block
.
avaûabÀ
 =Üe·_block.avaûabÀ ? 
p_Vid
->
öåa_block
 [À·_block.
mb_addr
] : 0;

263 
t›_block
.
avaûabÀ
 =Å›_block.avaûabÀ ? 
p_Vid
->
öåa_block
 [t›_block.
mb_addr
 ] : 0;

266 if(
b8
 >> 1)

267 
upMode
 = 
t›_block
.
avaûabÀ
 ? 
p_Vid
->
ùªdmode8x8
[t›_block.
pos_y
 ][t›_block.
pos_x
 ] : () -1;

269 
upMode
 = 
t›_block
.
avaûabÀ
 ? 
p_Vid
->
ùªdmode
 [t›_block.
pos_y
 ][t›_block.
pos_x
 ] : () -1;

271 if(
b8
 & 0x01)

272 
À·Mode
 = 
À·_block
.
avaûabÀ
 ? 
p_Vid
->
ùªdmode8x8
[À·_block.
pos_y
][À·_block.
pos_x
] : () -1;

274 
À·Mode
 = 
À·_block
.
avaûabÀ
 ? 
p_Vid
->
ùªdmode
[À·_block.
pos_y
][À·_block.
pos_x
] : () -1;

276 
mo°ProbabÀMode
 = (
upMode
 < 0 || 
À·Mode
 < 0Ë? 
DC_PRED
 : upMode <ÜeftMode ? upMode :ÜeftMode;

277 *
mö_co°
 = 
DISTBLK_MAX
;

278 
cuºMB
->
ùmode_DPCM
 = 
NO_INTRA_PMODE
;

281 
cuºSli˚
->
	`£t_öå≠ªd_8x8
(
cuºMB
, 
PLANE_Y
, 
pic_pix_x
, 
pic_pix_y
, &
À·_avaûabÀ
, &
up_avaûabÀ
, &
Æl_avaûabÀ
);

284 
ùmode
 = 0; ipmodê< 
NO_INTRA_PMODE
; ipmode++)

286 if–(
ùmode
==
DC_PRED
) ||

287 ((
ùmode
==
VERT_PRED
||ùmode==
VERT_LEFT_PRED
||ùmode==
DIAG_DOWN_LEFT_PRED
Ë&& 
up_avaûabÀ
 ) ||

288 ((
ùmode
==
HOR_PRED
||ùmode==
HOR_UP_PRED
Ë&& 
À·_avaûabÀ
 ) ||

289 (
Æl_avaûabÀ
) )

291 
	`gë_öå≠ªd_8x8
(
cuºMB
, 
PLANE_Y
, 
ùmode
, 
À·_avaûabÀ
, 
up_avaûabÀ
);

293 
	`gíî©e_¥ed_îr‹_8x8
(&
p_Vid
->
pCurImg
[
pic_›ix_y
], 
cuºSli˚
->
m¥_8x8
[0][
ùmode
], &
mb_¥ed
[
block_y
], &
mb_‹es
[block_y], 
pic_›ix_x
, 
block_x
);

295 
cuºMB
->
ùmode_DPCM
 = (Ë
ùmode
;

299 
rdco°
 = 
cuºSli˚
->
	`rdco°_f‹_8x8_öåa_blocks
 (
cuºMB
, &
c_nz
, 
b8
, 
ùmode
, 
œmbda
, 
mö_rdco°
, 
mo°ProbabÀMode
);

300 i‡((
rdco°
 < 
mö_rdco°
Ë|| (rdco° =mö_rdco° && 
ùmode
 =
mo°ProbabÀMode
))

303 
	`mem˝y
(
p_AC8x8
, 
cofAC
, 4 * 2 * 65 * ());

306 
	`c›y_image_d©a_8x8
(
p_RDO
->
ªc8x8
[
PLANE_Y
], &
p_Vid
->
íc_pi˘uª
->
imgY
[
pic_pix_y
], 0, 
pic_pix_x
);

308 i‡(
p_Vid
->
Ad≠tiveRoundög
)

310 
j
 = 
block_y
; j < block_y + 8; j++)

311 
	`mem˝y
(&
p_Vid
->
ARCofAdj8x8
[0][
DUMMY
][
j
][
block_x
],&p_Vid->ARCofAdj8x8[0][
I8MB
][j][block_x], 8 * ());

315 
n⁄zîo
 = 
c_nz
;

318 *
mö_co°
 = 
rdco°
;

319 
mö_rdco°
 = 
rdco°
;

320 
be°_ùmode
 = 
ùmode
;

326 
p_Vid
->
ùªdmode8x8
[
pic_block_y
][
pic_block_x
] = (Ë
be°_ùmode
;

327 
cuºMB
->
ùmode_DPCM
 = (Ë
be°_ùmode
;

329 
cuºMB
->
öåa_¥ed_modes8x8
[4*
b8
] = (Ë((
mo°ProbabÀMode
 =
be°_ùmode
)

331 : (
be°_ùmode
 < 
mo°ProbabÀMode
 ? best_ipmode : best_ipmode - 1));

333 
	`mem£t
(&
p_Vid
->
ùªdmode8x8
[
mb_block_y
 ][
mb_block_x
], 
be°_ùmode
, 2 * ());

334 
	`mem£t
(&
p_Vid
->
ùªdmode8x8
[
mb_block_y
 + 1][
mb_block_x
], 
be°_ùmode
, 2 * ());

337 
	`mem˝y
(
cofAC
, 
p_AC8x8
, 4 * 2 * 65 * ());

339 i‡(
p_Vid
->
Ad≠tiveRoundög
)

341 
j
=
block_y
; j< block_y + 8; j++)

342 
	`mem˝y
(&
p_Vid
->
ARCofAdj8x8
[0][
I8MB
][
j
][
block_x
], &p_Vid->ARCofAdj8x8[0][
DUMMY
][j][block_x], 8 * ());

346 
	`c›y_image_d©a_8x8
(&
p_Vid
->
íc_pi˘uª
->
imgY
[
pic_pix_y
], 
p_RDO
->
ªc8x8
[0], 
pic_pix_x
, 0);

347 
	`c›y_image_d©a_8x8
(&
mb_¥ed
[
block_y
], 
cuºSli˚
->
m¥_8x8
[0][
be°_ùmode
], 
block_x
, 0);

349  
n⁄zîo
;

350 
	}
}

358 
	$Mode_Decisi⁄_f‹_I¡øSubMBlocks
(
Ma¸oblock
 *
cuºMB
, 
b8
, 
œmbda
, 
di°blk
 *
co°
, 
n⁄_zîo
[3])

360 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

361 
b4
;

362 
di°blk
 
co°4x4
;

363 
cuºMB
->
¸_cbp
[0] = 0;

364 
cuºMB
->
¸_cbp
[1] = 0;

365 
cuºMB
->
¸_cbp
[2] = 0;

367 
	`mem£t
(
n⁄_zîo
, 0, 3 * ());

368 *
co°
 = 
	`weighãd_co°
(
œmbda
, 6);

369 
b4
=0; b4<4; b4++)

371 
n⁄_zîo
[0] |
cuºSli˚
->
	`mode_decisi⁄_f‹_I4x4_blocks
 (
cuºMB
, 
b8
, 
b4
, 
œmbda
, &
co°4x4
);

372 
n⁄_zîo
[1] |
cuºMB
->
¸_cbp
[1];

373 
n⁄_zîo
[2] |
cuºMB
->
¸_cbp
[2];

374 *
co°
 +
co°4x4
;

377  
n⁄_zîo
[0];

378 
	}
}

386 
	$mode_decisi⁄_f‹_I4x4_MB
 (
Ma¸oblock
 *
cuºMB
, 
œmbda
, 
di°blk
* 
co°
)

388 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

389 
cbp
=0, 
b8
;

390 
di°blk
 
co°8x8
;

391 
n⁄_zîo
[3] = {0, 0, 0};

393 
cuºSli˚
->
cmp_cbp
[1] = currSlice->cmp_cbp[2] = 0;

395 *
co°
=0, 
b8
=0; b8<4; b8++)

397 i‡(
	`Mode_Decisi⁄_f‹_I¡øSubMBlocks
 (
cuºMB
, 
b8
, 
œmbda
, &
co°8x8
, 
n⁄_zîo
))

399 
cbp
 |(1<<
b8
);

401 *
co°
 +
co°8x8
;

402 i‡(
n⁄_zîo
[1])

404 
cuºSli˚
->
cmp_cbp
[1] |(1<<
b8
);

405 
cbp
 |
cuºSli˚
->
cmp_cbp
[1];

406 
cuºSli˚
->
cmp_cbp
[1] = 
cbp
;

407 
cuºSli˚
->
cmp_cbp
[2] = 
cbp
;

409 i‡(
n⁄_zîo
[2])

411 
cuºSli˚
->
cmp_cbp
[2] |(1<<
b8
);

412 
cbp
 |
cuºSli˚
->
cmp_cbp
[2];

413 
cuºSli˚
->
cmp_cbp
[1] = 
cbp
;

414 
cuºSli˚
->
cmp_cbp
[2] = 
cbp
;

417  
cbp
;

418 
	}
}

420 
	$föd_be°_mode_I16x16_MB
 (
Ma¸oblock
 *
cuºMB
, 
œmbda
, 
di°blk
 
mö_co°
)

422 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

423 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
FALSE
;

424  (Ë
cuºSli˚
->
	`föd_ßd_16x16
 (
cuºMB
);

425 
	}
}

433 
	$mode_decisi⁄_f‹_I16x16_MB
 (
Ma¸oblock
* 
cuºMB
, 
œmbda
)

435 
	`föd_be°_mode_I16x16_MB
 (
cuºMB
, 
œmbda
, 
DISTBLK_MAX
);

436  
cuºMB
->
	`ªsiduÆ_å™sf‹m_qu™t_luma_16x16
 (cuºMB, 
PLANE_Y
);

437 
	}
}

445 
	$mode_decisi⁄_f‹_I16x16_MB_RDO
 (
Ma¸oblock
* 
cuºMB
, 
œmbda
)

447 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

448 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

449 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

451 
Sy¡axEÀmít
 
£
;

452 c⁄° * 
∑πM≠
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
∑πôi⁄_mode
];

453 
D©aP¨tôi⁄
* 
d©aP¨t
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_MBTYPE
]]);

455 
di°blk
 
mö_rdco°
 = 
DISTBLK_MAX
, 
rdco°
;

456 
di°blk
 
di°‹ti⁄Y
;

457 
øã
;

458 
i
,
k
;

459 
b8
, 
b4
;

462 
up_avaû
, 
À·_avaû
, 
À·_up_avaû
;

464 
be°_mode
 = 0, 
be°_cbp
 = 0;

465 
be°CofAC
[4][4][2][65];

466 
be°CofDC
[2][18];

467 
img≥l
 
be°Rec
[
MB_BLOCK_SIZE
][MB_BLOCK_SIZE];

469 
cuºMB
->
mb_ty≥
 = 
I16MB
;

471 
cuºSli˚
->
	`£t_öå≠ªd_16x16
(
cuºMB
, 
PLANE_Y
, &
À·_avaû
, &
up_avaû
, &
À·_up_avaû
);

473 
k
 = 0;k < 4; k++)

475 i‡(
p_I≈
->
I¡øDißbÀI¡îO∆y
 =0 || (
cuºSli˚
->
¶i˚_ty≥
 !
I_SLICE
 && cuºSli˚->¶i˚_ty≥ !
SI_SLICE
))

477 i‡(
p_I≈
->
I¡ø16x16P¨DißbÀ
 && (
k
==
VERT_PRED_16
||k==
HOR_PRED_16
))

480 i‡(
p_I≈
->
I¡ø16x16Pœ√DißbÀ
 && 
k
==
PLANE_16
)

484 i‡((
k
==0 && !
up_avaû
Ë|| (k==1 && !
À·_avaû
Ë|| (k==3 && (!À·_avaû || !up_avaû || !
À·_up_avaû
)))

487 
	`gë_öå≠ªd_16x16
(
cuºMB
, 
PLANE_Y
, 
k
, 
À·_avaû
, 
up_avaû
);

489 
cuºMB
->
i16mode
 = (Ë
k
;

490 
cuºMB
->
cbp
 = cuºMB->
	`ªsiduÆ_å™sf‹m_qu™t_luma_16x16
(cuºMB, 
PLANE_Y
);

491 
di°‹ti⁄Y
 = 
	`compuã_SSE16x16_thªs
(&
p_Vid
->
pCurImg
[
cuºMB
->
›ix_y
], &p_Vid->
íc_pi˘uª
->
p_cuº_img
[cuºMB->
pix_y
], cuºMB->
pix_x
, cuºMB->pix_x, 
mö_rdco°
);

493 i‡(
di°‹ti⁄Y
 < 
mö_rdco°
 - 
	`weighãd_co°
(
œmbda
, 4))

495 
cuºSli˚
->
	`°‹e_codög_°©e
 (
cuºMB
, cuºSli˚->
p_RDO
->
cs_tmp
);

496 
cuºMB
->
i16off£t
 = 
	`I16Off£t
 (cuºMB->
cbp
, cuºMB->
i16mode
);

497 
£
.
vÆue1
 = 
	`MBTy≥2VÆue
 (
cuºMB
);

498 
£
.
vÆue2
 = 0;

499 
£
.
ty≥
 = 
SE_MBTYPE
;

501 
cuºSli˚
->
	`wrôeMB_ty≥Info
 (
cuºMB
, &
£
, 
d©aP¨t
);

503 
øã
 = 
£
.
Àn
;

504 i‡(
di°‹ti⁄Y
 + 
	`weighãd_co°
(
œmbda
, 
øã
Ë< 
mö_rdco°
)

506 
øã
 +
cuºSli˚
->
	`wrôeC€ff16x16
 (
cuºMB
, 
PLANE_Y
);

507 
cuºSli˚
->
	`ª£t_codög_°©e
 (
cuºMB
, cuºSli˚->
p_RDO
->
cs_tmp
);

509 
rdco°
 = 
di°‹ti⁄Y
 + 
	`weighãd_co°
(
œmbda
, 
øã
);

511 if(
rdco°
 < 
mö_rdco°
)

513 
mö_rdco°
 = 
rdco°
;

514 
be°_mode
 = 
k
;

515 
be°_cbp
 = 
cuºMB
->
cbp
;

516 
b8
 = 0; b8 < 4; b8++)

518 
b4
 = 0; b4 < 4; b4++)

520 
	`mem˝y
(
be°CofAC
[
b8
][
b4
][0], 
cuºSli˚
->
cofAC
[b8][b4][0], () * 65);

521 
	`mem˝y
(
be°CofAC
[
b8
][
b4
][1], 
cuºSli˚
->
cofAC
[b8][b4][1], () * 65);

525 
	`mem˝y
(
be°CofDC
[0], 
cuºSli˚
->
cofDC
[0][0], ()*18);

526 
	`mem˝y
(
be°CofDC
[1], 
cuºSli˚
->
cofDC
[0][1], ()*18);

528 
i
 = 0; i < 
MB_BLOCK_SIZE
; i++)

529 
	`mem˝y
(
be°Rec
[
i
], &
p_Vid
->
íc_pi˘uª
->
p_cuº_img
[
cuºMB
->
pix_y
 + i][cuºMB->
pix_x
], (
img≥l
)*
MB_BLOCK_SIZE
);

534 
cuºSli˚
->
	`ª£t_codög_°©e
 (
cuºMB
, cuºSli˚->
p_RDO
->
cs_tmp
);

539 
cuºMB
->
i16mode
 = (Ë
be°_mode
;

540 
cuºMB
->
cbp
 = 
be°_cbp
;

541 
cuºMB
->
i16off£t
 = 
	`I16Off£t
 (cuºMB->
cbp
, cuºMB->
i16mode
);

543 
b8
 = 0; b8 < 4; b8++)

545 
b4
 = 0; b4 < 4; b4++)

547 
	`mem˝y
(
cuºSli˚
->
cofAC
[
b8
][
b4
][0], 
be°CofAC
[b8][b4][0], ()*65);

548 
	`mem˝y
(
cuºSli˚
->
cofAC
[
b8
][
b4
][1], 
be°CofAC
[b8][b4][1], ()*65);

552 
	`mem˝y
(
cuºSli˚
->
cofDC
[0][0], 
be°CofDC
[0], ()*18);

553 
	`mem˝y
(
cuºSli˚
->
cofDC
[0][1], 
be°CofDC
[1], ()*18);

555 
i
 = 0; i < 
MB_BLOCK_SIZE
; i++)

557 
	`mem˝y
(&
p_Vid
->
íc_pi˘uª
->
p_cuº_img
[
cuºMB
->
pix_y
+
i
][cuºMB->
pix_x
], 
be°Rec
[i], 
MB_BLOCK_SIZE
*(
img≥l
));

560  
cuºMB
->
cbp
;

561 
	}
}

	@lencod/src/rd_intra_jm444.c

18 
	~<limôs.h
>

20 
	~"globÆ.h
"

22 
	~"image.h
"

23 
	~"ma¸oblock.h
"

24 
	~"mb_ac˚ss.h
"

25 
	~"rd›t_codög_°©e.h
"

26 
	~"mode_decisi⁄.h
"

27 
	~"rd›t.h
"

28 
	~"rd_öåa_jm.h
"

29 
	~"q_¨ound.h
"

30 
	~"öåa4x4.h
"

31 
	~"rd_öåa_jm.h
"

32 
	~"blk_¥edi˘i⁄.h
"

40 
	$mode_decisi⁄_f‹_I4x4_blocks_JM_High444
 (
Ma¸oblock
 *
cuºMB
, 
b8
, 
b4
, 
œmbda
, 
di°blk
* 
mö_co°
)

42 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

43 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

44 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

45 
RDOPTSåu˘uª
 *
p_RDO
 = 
cuºSli˚
->p_RDO;

47 
ùmode
, 
be°_ùmode
 = 0, 
y
, 
dummy
;

48 
c_nz
, 
n⁄zîo
 = 0;

49 * 
ACLevñ
 = 
cuºSli˚
->
cofAC
[
b8
][
b4
][0];

50 * 
ACRun
 = 
cuºSli˚
->
cofAC
[
b8
][
b4
][1];

51 
uv
;

52 
di°blk
 
rdco°
 = 0;

53 
di°blk
 
mö_rdco°
 = 
DISTBLK_MAX
;

54 
block_x
 = ((
b8
 & 0x01Ë<< 3Ë+ ((
b4
 & 0x01) << 2);

55 
block_y
 = ((
b8
 >> 1Ë<< 3Ë+ ((
b4
 >> 1) << 2);

56 
pic_pix_x
 = 
cuºMB
->
pix_x
 + 
block_x
;

57 
pic_pix_y
 = 
cuºMB
->
pix_y
 + 
block_y
;

58 
pic_›ix_x
 = 
cuºMB
->
pix_x
 + 
block_x
;

59 
pic_›ix_y
 = 
cuºMB
->
›ix_y
 + 
block_y
;

60 
pic_block_x
 = 
pic_pix_x
 >> 2;

61 
pic_block_y
 = 
pic_pix_y
 >> 2;

63 
À·_avaûabÀ
, 
up_avaûabÀ
, 
Æl_avaûabÀ
;

64 *
mb_size
 = 
p_Vid
->mb_size[
IS_LUMA
];

66 
upMode
, 
À·Mode
;

67 
mo°ProbabÀMode
;

69 
PixñPos
 
À·_block
, 
t›_block
;

71 
Ãec4x4
[4][4];

72 
be°_nz_c€ff
 = 0;

73 
block_x4
 = 
block_x
>>2;

74 
block_y4
 = 
block_y
>>2;

76 #ifde‡
BEST_NZ_COEFF


77 
be°_coded_block_Êag
 = 0;

78 
bô_pos
 = 1 + ((((
b8
>>1)<<1)+(
b4
>>1))<<2) + (((b8&1)<<1)+(b4&1));

79 
öt64
 
cbp_bôs
;

81 i‡(
b8
==0 && 
b4
==0)

82 
cbp_bôs
 = 0;

85 
	`gë4x4Neighbour
(
cuºMB
, 
block_x
 - 1, 
block_y
 , 
mb_size
, &
À·_block
);

86 
	`gë4x4Neighbour
(
cuºMB
, 
block_x
, 
block_y
 - 1, 
mb_size
, &
t›_block
 );

89 i‡(
p_I≈
->
U£C⁄°øöedI¡øPªd
)

91 
À·_block
.
avaûabÀ
 =Üe·_block.avaûabÀ ? 
p_Vid
->
öåa_block
[À·_block.
mb_addr
] : 0;

92 
t›_block
.
avaûabÀ
 =Å›_block.avaûabÀ ? 
p_Vid
->
öåa_block
[t›_block.
mb_addr
] : 0;

95 
upMode
 = 
t›_block
.
avaûabÀ
 ? 
p_Vid
->
ùªdmode
[t›_block.
pos_y
 ][t›_block.
pos_x
 ] : -1;

96 
À·Mode
 = 
À·_block
.
avaûabÀ
 ? 
p_Vid
->
ùªdmode
[À·_block.
pos_y
][À·_block.
pos_x
] : -1;

98 
mo°ProbabÀMode
 = (
upMode
 < 0 || 
À·Mode
 < 0Ë? 
DC_PRED
 : upMode <ÜeftMode ? upMode :ÜeftMode;

99 *
mö_co°
 = 
DISTBLK_MAX
;

100 
cuºMB
->
ùmode_DPCM
 = 
NO_INTRA_PMODE
;

104 
cuºSli˚
->
	`£t_öå≠ªd_4x4
(
cuºMB
, 
PLANE_Y
, 
pic_pix_x
, 
pic_pix_y
, &
À·_avaûabÀ
, &
up_avaûabÀ
, &
Æl_avaûabÀ
);

106 i‡(
cuºSli˚
->
P444_joöed
)

108 
	`£À˘_∂™e
(
p_Vid
, 
PLANE_U
);

109 
cuºSli˚
->
	`£t_öå≠ªd_4x4
(
cuºMB
, 
PLANE_U
, 
pic_pix_x
, 
pic_pix_y
, &
À·_avaûabÀ
, &
up_avaûabÀ
, &
Æl_avaûabÀ
);

110 
	`£À˘_∂™e
(
p_Vid
, 
PLANE_V
);

111 
cuºSli˚
->
	`£t_öå≠ªd_4x4
(
cuºMB
, 
PLANE_V
, 
pic_pix_x
, 
pic_pix_y
, &
À·_avaûabÀ
, &
up_avaûabÀ
, &
Æl_avaûabÀ
);

112 
	`£À˘_∂™e
(
p_Vid
, 
PLANE_Y
);

116 
ùmode
 = 0; ipmodê< 
NO_INTRA_PMODE
; ipmode++)

118 
avaûabÀ_mode
 = (
Æl_avaûabÀ
Ë|| (
ùmode
==
DC_PRED
) ||

119 (
up_avaûabÀ
 && (
ùmode
==
VERT_PRED
||ùmode==
VERT_LEFT_PRED
||ùmode==
DIAG_DOWN_LEFT_PRED
)) ||

120 (
À·_avaûabÀ
 && (
ùmode
==
HOR_PRED
||ùmode==
HOR_UP_PRED
));

122 i‡(
	`vÆid_öåa_mode
(
cuºSli˚
, 
ùmode
) == 0)

125 if–
avaûabÀ_mode
)

128 
	`gë_öå≠ªd_4x4
(
cuºMB
, 
PLANE_Y
, 
ùmode
, 
block_x
, 
block_y
, 
À·_avaûabÀ
, 
up_avaûabÀ
);

131 
	`gíî©e_¥ed_îr‹_4x4
(&
p_Vid
->
pCurImg
[
pic_›ix_y
], 
cuºSli˚
->
m¥_4x4
[0][
ùmode
], &cuºSli˚->
mb_¥ed
[0][
block_y
], &cuºSli˚->
mb_‹es
[0][block_y], 
pic_›ix_x
, 
block_x
);

133 i‡(
p_Vid
->
yuv_f‹m©
 =
YUV444
)

135 
cuºMB
->
ùmode_DPCM
 = (Ë
ùmode
;

136 i‡(
p_I≈
->
£∑øã_cﬁour_∂™e_Êag
 == 0)

139 
	`gë_öå≠ªd_4x4
(
cuºMB
, 
PLANE_U
, 
ùmode
, 
block_x
, 
block_y
, 
À·_avaûabÀ
, 
up_avaûabÀ
);

140 
	`gíî©e_¥ed_îr‹_4x4
(&
p_Vid
->
pImgOrg
[1][
pic_›ix_y
], 
cuºSli˚
->
m¥_4x4
[1][
ùmode
], &cuºSli˚->
mb_¥ed
[1][
block_y
], &cuºSli˚->
mb_‹es
[1][block_y], 
pic_›ix_x
, 
block_x
);

142 
	`gë_öå≠ªd_4x4
(
cuºMB
, 
PLANE_V
, 
ùmode
, 
block_x
, 
block_y
, 
À·_avaûabÀ
, 
up_avaûabÀ
);

143 
	`gíî©e_¥ed_îr‹_4x4
(&
p_Vid
->
pImgOrg
[2][
pic_›ix_y
], 
cuºSli˚
->
m¥_4x4
[2][
ùmode
], &cuºSli˚->
mb_¥ed
[2][
block_y
], &cuºSli˚->
mb_‹es
[2][block_y], 
pic_›ix_x
, 
block_x
);

148 #ifde‡
BEST_NZ_COEFF


149 
cuºMB
->
cbp_bôs
[0] = cbp_bits;

152 
rdco°
 = 
cuºSli˚
->
	`rdco°_f‹_4x4_öåa_blocks
 (
cuºMB
, &
c_nz
, 
b8
, 
b4
, 
ùmode
, 
œmbda
, 
mo°ProbabÀMode
, 
mö_rdco°
);

153 i‡((
rdco°
 < 
mö_rdco°
Ë|| (rdco° =mö_rdco° && 
ùmode
 =
mo°ProbabÀMode
))

156 
	`mem˝y
(
p_RDO
->
cofAC4x4
[0], 
ACLevñ
, 18 * ());

157 
	`mem˝y
(
p_RDO
->
cofAC4x4
[1], 
ACRun
, 18 * ());

160 
	`c›y_4x4block
(
p_RDO
->
ªc4x4
[
PLANE_Y
], &
p_Vid
->
íc_pi˘uª
->
imgY
[
pic_pix_y
], 0, 
pic_pix_x
);

163 if(
cuºSli˚
->
¶i˚_ty≥
 =
SP_SLICE
 && !cuºSli˚->
•2_‰ame_ödiˇt‹
)

165 
y
=0; y<4; y++)

167 
	`mem˝y
(
Ãec4x4
[
y
],&
p_Vid
->
Ãec
[
pic_pix_y
+y][
pic_pix_x
], 
BLOCK_SIZE
 * ());

171 if(
cuºSli˚
->
P444_joöed
)

174 
uv
=0; uv < 2; uv++)

176 
	`mem˝y
(
p_RDO
->
cofAC4x4CbCr
[
uv
][0],
cuºSli˚
->
cofAC
[
b8
+4+uv*4][
b4
][0], 18 * ());

177 
	`mem˝y
(
p_RDO
->
cofAC4x4CbCr
[
uv
][1],
cuºSli˚
->
cofAC
[
b8
+4+uv*4][
b4
][1], 18 * ());

178 
cuºMB
->
¸_cbp
[
uv
 + 1] = cuºMB->
c_nzCbCr
[uv + 1];

181 
	`c›y_4x4block
(
p_RDO
->
ªc4x4
[
uv
 + 1], &
p_Vid
->
íc_pi˘uª
->
imgUV
[uv][
pic_pix_y
], 0, 
pic_pix_x
);

185 
n⁄zîo
 = 
c_nz
;

188 *
mö_co°
 = 
rdco°
;

189 
mö_rdco°
 = 
rdco°
;

190 
be°_ùmode
 = 
ùmode
;

192 
be°_nz_c€ff
 = 
p_Vid
->
nz_c€ff
 [
cuºMB
->
mbAddrX
][
block_x4
][
block_y4
];

193 #ifde‡
BEST_NZ_COEFF


194 
be°_coded_block_Êag
 = ()((
cuºMB
->
cbp_bôs
[0] >> 
bô_pos
)&(
öt64
)(1));

196 i‡(
p_Vid
->
Ad≠tiveRoundög
)

198 
	`°‹e_ad≠tive_roundög_4x4
 (
p_Vid
,Ö_Vid->
ARCofAdj4x4
, 
I4MB
, 
block_y
, 
block_x
);

203 #i‡
INTRA_RDCOSTCALC_NNZ


204 
p_Vid
->
nz_c€ff
 [
cuºMB
->
mbAddrX
][
block_x4
][
block_y4
] = 
be°_nz_c€ff
;

206 #ifde‡
BEST_NZ_COEFF


207 
cbp_bôs
 &(~(
öt64
)(1<<
bô_pos
));

208 
cbp_bôs
 |(
öt64
)(
be°_coded_block_Êag
<<
bô_pos
);

212 
p_Vid
->
ùªdmode
[
pic_block_y
][
pic_block_x
] = (Ë
be°_ùmode
;

213 
cuºMB
->
öåa_¥ed_modes
[4*
b8
+
b4
] =

214 (Ë(
mo°ProbabÀMode
 =
be°_ùmode
 ? -1 : (best_ipmode < mostProbableMode ? best_ipmode : best_ipmode-1));

216 if(
cuºSli˚
->
P444_joöed
)

218 
Cﬁ‹Pœ√
 
k
;

219 
k
 = 
PLANE_U
; k <
PLANE_V
; k++)

221 
	`£À˘_∂™e
(
p_Vid
, 
k
);

223 
	`c›y_4x4block
(&
cuºSli˚
->
mb_¥ed
[
k
][
block_y
], cuºSli˚->
m¥_4x4
[k][
be°_ùmode
], 
block_x
, 0);

233 
	`compuã_ªsidue
(&(
p_Vid
->
pImgOrg
[
k
][
cuºMB
->
pix_y
+
block_y
]), &
cuºSli˚
->
mb_¥ed
[k][block_y], &cuºSli˚->
mb_‹es
[k][block_y], 
block_x
, cuºMB->
pix_x
+block_x, 4, 4);

234 
cuºMB
->
¸_cbp
[
k
] = cuºMB->
	`ªsiduÆ_å™sf‹m_qu™t_luma_4x4
(cuºMB, k, 
block_x
,
block_y
,&
dummy
,1);

236 
	`£À˘_∂™e
(
p_Vid
, 
PLANE_Y
);

240 
	`mem˝y
 (
ACLevñ
, 
p_RDO
->
cofAC4x4
[0], 18 * ());

241 
	`mem˝y
 (
ACRun
, 
p_RDO
->
cofAC4x4
[1], 18 * ());

244 
	`c›y_4x4block
(&
p_Vid
->
íc_pi˘uª
->
imgY
[
pic_pix_y
], 
p_RDO
->
ªc4x4
[
PLANE_Y
], 
pic_pix_x
, 0);

245 
	`c›y_4x4block
(&
cuºSli˚
->
mb_¥ed
[0][
block_y
], cuºSli˚->
m¥_4x4
[0][
be°_ùmode
], 
block_x
, 0);

248 if(
cuºSli˚
->
¶i˚_ty≥
 =
SP_SLICE
 && !
p_Vid
->
•2_‰ame_ödiˇt‹
)

250 
y
=0; y<
BLOCK_SIZE
; y++)

252 
	`mem˝y
 (&
p_Vid
->
Ãec
[
pic_pix_y
+
y
][
pic_pix_x
], 
Ãec4x4
[y], 
BLOCK_SIZE
 * ());

255 i‡(
cuºSli˚
->
P444_joöed
)

257 
uv
=0; uv < 2; uv++ )

260 
	`mem˝y
(
cuºSli˚
->
cofAC
[
b8
+4+
uv
*4][
b4
][0], 
p_RDO
->
cofAC4x4CbCr
[uv][0], 18 * ());

261 
	`mem˝y
(
cuºSli˚
->
cofAC
[
b8
+4+
uv
*4][
b4
][1], 
p_RDO
->
cofAC4x4CbCr
[uv][1], 18 * ());

263 
	`c›y_4x4block
(&
p_Vid
->
íc_pi˘uª
->
imgUV
[
uv
][
pic_pix_y
], 
p_RDO
->
ªc4x4
[uv + 1], 
pic_pix_x
, 0);

264 
	`c›y_4x4block
(&
cuºSli˚
->
mb_¥ed
[
uv
 + 1][
block_y
], cuºSli˚->
m¥_4x4
[uv + 1][
be°_ùmode
], 
block_x
, 0);

268 i‡(
p_Vid
->
Ad≠tiveRoundög
)

270 
	`upd©e_ad≠tive_roundög_4x4
 (
p_Vid
,p_Vid->
ARCofAdj4x4
, 
I4MB
, 
block_y
, 
block_x
);

273  
n⁄zîo
;

274 
	}
}

282 
	$mode_decisi⁄_f‹_I4x4_blocks_JM_Low444
 (
Ma¸oblock
 *
cuºMB
, 
b8
, 
b4
, 
œmbda
, 
di°blk
* 
mö_co°
)

284 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

285 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

286 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

288 
ùmode
, 
be°_ùmode
 = 0, 
dummy
;

289 
di°blk
 
co°
;

290 
n⁄zîo
 = 0;

292 
block_x
 = ((
b8
 & 0x01Ë<< 3Ë+ ((
b4
 & 0x01) << 2);

293 
block_y
 = ((
b8
 >> 1Ë<< 3Ë+ ((
b4
 >> 1) << 2);

294 
pic_pix_x
 = 
cuºMB
->
pix_x
 + 
block_x
;

295 
pic_pix_y
 = 
cuºMB
->
pix_y
 + 
block_y
;

296 
pic_›ix_x
 = 
cuºMB
->
pix_x
 + 
block_x
;

297 
pic_›ix_y
 = 
cuºMB
->
›ix_y
 + 
block_y
;

298 
pic_block_x
 = 
pic_pix_x
 >> 2;

299 
pic_block_y
 = 
pic_pix_y
 >> 2;

301 
À·_avaûabÀ
, 
up_avaûabÀ
, 
Æl_avaûabÀ
;

303 
upMode
, 
À·Mode
;

304 
mo°ProbabÀMode
;

306 
PixñPos
 
À·_block
;

307 
PixñPos
 
t›_block
;

309 
di°blk
 
fixedco°
 = 
	`weighãd_co°
(
œmbda
, 4);

310 *
mb_size
 = 
p_Vid
->mb_size[
IS_LUMA
];

311 
be°_nz_c€ff
 = 0;

312 
block_x4
 = 
block_x
>>2;

313 
block_y4
 = 
block_y
>>2;

315 #ifde‡
BEST_NZ_COEFF


316 
be°_coded_block_Êag
 = 0;

317 
bô_pos
 = 1 + ((((
b8
>>1)<<1)+(
b4
>>1))<<2) + (((b8&1)<<1)+(b4&1));

318 
öt64
 
cbp_bôs
;

320 i‡(
b8
==0 && 
b4
==0)

321 
cbp_bôs
 = 0;

324 
	`gë4x4Neighbour
(
cuºMB
, 
block_x
 - 1, 
block_y
 , 
mb_size
, &
À·_block
);

325 
	`gë4x4Neighbour
(
cuºMB
, 
block_x
, 
block_y
 - 1, 
mb_size
, &
t›_block
 );

328 i‡(
p_I≈
->
U£C⁄°øöedI¡øPªd
)

330 
À·_block
.
avaûabÀ
 =Üe·_block.avaûabÀ ? 
p_Vid
->
öåa_block
[À·_block.
mb_addr
] : 0;

331 
t›_block
.
avaûabÀ
 =Å›_block.avaûabÀ ? 
p_Vid
->
öåa_block
[t›_block.
mb_addr
] : 0;

334 
upMode
 = 
t›_block
.
avaûabÀ
 ? 
p_Vid
->
ùªdmode
[t›_block.
pos_y
 ][t›_block.
pos_x
 ] : -1;

335 
À·Mode
 = 
À·_block
.
avaûabÀ
 ? 
p_Vid
->
ùªdmode
[À·_block.
pos_y
][À·_block.
pos_x
] : -1;

337 
mo°ProbabÀMode
 = (
upMode
 < 0 || 
À·Mode
 < 0Ë? 
DC_PRED
 : upMode <ÜeftMode ? upMode :ÜeftMode;

338 *
mö_co°
 = 
DISTBLK_MAX
;

339 
cuºMB
->
ùmode_DPCM
 = 
NO_INTRA_PMODE
;

343 
cuºSli˚
->
	`£t_öå≠ªd_4x4
(
cuºMB
, 
PLANE_Y
, 
pic_pix_x
, 
pic_pix_y
, &
À·_avaûabÀ
, &
up_avaûabÀ
, &
Æl_avaûabÀ
);

345 i‡(
cuºSli˚
->
P444_joöed
)

347 
	`£À˘_∂™e
(
p_Vid
, 
PLANE_U
);

348 
cuºSli˚
->
	`£t_öå≠ªd_4x4
(
cuºMB
, 
PLANE_U
, 
pic_pix_x
, 
pic_pix_y
, &
À·_avaûabÀ
, &
up_avaûabÀ
, &
Æl_avaûabÀ
);

349 
	`£À˘_∂™e
(
p_Vid
, 
PLANE_V
);

350 
cuºSli˚
->
	`£t_öå≠ªd_4x4
(
cuºMB
, 
PLANE_V
, 
pic_pix_x
, 
pic_pix_y
, &
À·_avaûabÀ
, &
up_avaûabÀ
, &
Æl_avaûabÀ
);

351 
	`£À˘_∂™e
(
p_Vid
, 
PLANE_Y
);

355 
ùmode
 = 0; ipmodê< 
NO_INTRA_PMODE
; ipmode++)

357 
avaûabÀ_mode
 = (
Æl_avaûabÀ
Ë|| (
ùmode
==
DC_PRED
) ||

358 (
up_avaûabÀ
 && (
ùmode
==
VERT_PRED
||ùmode==
VERT_LEFT_PRED
||ùmode==
DIAG_DOWN_LEFT_PRED
)) ||

359 (
À·_avaûabÀ
 && (
ùmode
==
HOR_PRED
||ùmode==
HOR_UP_PRED
));

361 i‡(
	`vÆid_öåa_mode
(
cuºSli˚
, 
ùmode
) == 0)

364 if–
avaûabÀ_mode
)

369 
	`gë_öå≠ªd_4x4
(
cuºMB
, 
PLANE_Y
, 
ùmode
, 
block_x
, 
block_y
, 
À·_avaûabÀ
, 
up_avaûabÀ
);

370 
co°
 = (
ùmode
 =
mo°ProbabÀMode
Ë? 0 : 
fixedco°
;

371 
co°
 +
cuºSli˚
->
	`compuã_co°4x4
(
p_Vid
, &p_Vid->
pCurImg
[
pic_›ix_y
], cuºSli˚->
m¥_4x4
[0][
ùmode
], 
pic_›ix_x
, *
mö_co°
 - cost);

372 i‡(
cuºSli˚
->
P444_joöed
)

374 
	`gë_öå≠ªd_4x4
(
cuºMB
, 
PLANE_U
, 
ùmode
, 
block_x
, 
block_y
, 
À·_avaûabÀ
, 
up_avaûabÀ
);

375 
co°
 +
cuºSli˚
->
	`compuã_co°4x4
(
p_Vid
, &p_Vid->
pImgOrg
[1][
pic_›ix_y
], cuºSli˚->
m¥_4x4
[1][
ùmode
], 
pic_›ix_x
, *
mö_co°
 - cost);

376 
	`gë_öå≠ªd_4x4
(
cuºMB
, 
PLANE_V
, 
ùmode
, 
block_x
, 
block_y
, 
À·_avaûabÀ
, 
up_avaûabÀ
);

377 
co°
 +
cuºSli˚
->
	`compuã_co°4x4
(
p_Vid
, &p_Vid->
pImgOrg
[2][
pic_›ix_y
], cuºSli˚->
m¥_4x4
[2][
ùmode
], 
pic_›ix_x
, *
mö_co°
 - cost);

380 i‡(
co°
 < *
mö_co°
)

382 
be°_ùmode
 = 
ùmode
;

383 *
mö_co°
 = 
co°
;

388 #i‡
INTRA_RDCOSTCALC_NNZ


389 
p_Vid
->
nz_c€ff
 [
cuºMB
->
mbAddrX
][
block_x4
][
block_y4
] = 
be°_nz_c€ff
;

391 #ifde‡
BEST_NZ_COEFF


392 
cbp_bôs
 &(~(
öt64
)(1<<
bô_pos
));

393 
cbp_bôs
 |(
öt64
)(
be°_coded_block_Êag
<<
bô_pos
);

396 
p_Vid
->
ùªdmode
[
pic_block_y
][
pic_block_x
] = (Ë
be°_ùmode
;

397 
cuºMB
->
öåa_¥ed_modes
[4*
b8
+
b4
] =

398 (Ë(
mo°ProbabÀMode
 =
be°_ùmode
 ? -1 : (best_ipmode < mostProbableMode ? best_ipmode : best_ipmode-1));

401 
	`gíî©e_¥ed_îr‹_4x4
(&
p_Vid
->
pCurImg
[
pic_›ix_y
], 
cuºSli˚
->
m¥_4x4
[0][
be°_ùmode
], &cuºSli˚->
mb_¥ed
[0][
block_y
], &cuºSli˚->
mb_‹es
[0][block_y], 
pic_›ix_x
, 
block_x
);

403 
cuºMB
->
ùmode_DPCM
 = (Ë
be°_ùmode
;

405 
	`£À˘_å™sf‹m
(
cuºMB
);

406 
n⁄zîo
 = 
cuºMB
->
¸_cbp
[0] = cuºMB->
	`ªsiduÆ_å™sf‹m_qu™t_luma_4x4
 (cuºMB, 
PLANE_Y
, 
block_x
, 
block_y
, &
dummy
, 1);

408 i‡(
cuºSli˚
->
P444_joöed
)

410 
Cﬁ‹Pœ√
 
k
;

411 
k
 = 
PLANE_U
; k <
PLANE_V
; k++)

413 
	`£À˘_∂™e
(
p_Vid
, 
k
);

424 
	`c›y_4x4block
(&
cuºSli˚
->
mb_¥ed
[
k
][
block_y
], cuºSli˚->
m¥_4x4
[k][
be°_ùmode
], 
block_x
, 0);

425 
	`compuã_ªsidue
(&(
p_Vid
->
pImgOrg
[
k
][
pic_›ix_y
]), &
cuºSli˚
->
mb_¥ed
[k][
block_y
], &cuºSli˚->
mb_‹es
[k][block_y], 
block_x
, 
pic_›ix_x
, 4, 4);

426 
cuºMB
->
¸_cbp
[
k
] = cuºMB->
	`ªsiduÆ_å™sf‹m_qu™t_luma_4x4
 (cuºMB, k, 
block_x
, 
block_y
, &
dummy
, 1);

428 
	`£À˘_∂™e
(
p_Vid
, 
PLANE_Y
);

431  
n⁄zîo
;

432 
	}
}

440 
	$mode_decisi⁄_f‹_I16x16_MB_444
 (
Ma¸oblock
* 
cuºMB
, 
œmbda
)

442 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

443 
cbp
;

444 
	`föd_be°_mode_I16x16_MB
(
cuºMB
, 
œmbda
, 
DISTBLK_MAX
);

446 i‡(!
cuºSli˚
->
P444_joöed
)

448 
cbp
 = 
cuºMB
->
	`ªsiduÆ_å™sf‹m_qu™t_luma_16x16
 (cuºMB, 
PLANE_Y
);

452 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

454 
cbp
 = 
cuºMB
->
	`ªsiduÆ_å™sf‹m_qu™t_luma_16x16
 (cuºMB, 
PLANE_Y
);

455 
	`£À˘_∂™e
(
p_Vid
, 
PLANE_U
);

456 
cuºSli˚
->
cmp_cbp
[1] = 
cuºMB
->
	`ªsiduÆ_å™sf‹m_qu™t_luma_16x16
 (cuºMB, 
PLANE_U
);

457 
	`£À˘_∂™e
(
p_Vid
, 
PLANE_V
);

458 
cuºSli˚
->
cmp_cbp
[2] = 
cuºMB
->
	`ªsiduÆ_å™sf‹m_qu™t_luma_16x16
 (cuºMB, 
PLANE_V
);

459 
	`£À˘_∂™e
(
p_Vid
, 
PLANE_Y
);

461 
cbp
 |(
cuºSli˚
->
cmp_cbp
[1] | currSlice->cmp_cbp[2]);

462 
cuºSli˚
->
cmp_cbp
[1] = 
cbp
;

463 
cuºSli˚
->
cmp_cbp
[2] = 
cbp
;

466  
cbp
;

467 
	}
}

	@lencod/src/rd_intra_jm_low.c

18 
	~<limôs.h
>

20 
	~"globÆ.h
"

22 
	~"image.h
"

23 
	~"ma¸oblock.h
"

24 
	~"mb_ac˚ss.h
"

25 
	~"rd›t_codög_°©e.h
"

26 
	~"mode_decisi⁄.h
"

27 
	~"rd›t.h
"

28 
	~"rd_öåa_jm.h
"

29 
	~"q_¨ound.h
"

30 
	~"öåa4x4.h
"

31 
	~"öåa8x8.h
"

39 
	$mode_decisi⁄_f‹_I4x4_blocks_JM_Low
 (
Ma¸oblock
 *
cuºMB
, 
b8
, 
b4
, 
œmbda
, 
di°blk
* 
mö_co°
)

41 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

42 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

43 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

45 
ùmode
, 
be°_ùmode
 = 0, 
dummy
;

46 
n⁄zîo
 = 0;

47 
di°blk
 
co°
;

48 
block_x
 = ((
b8
 & 0x01Ë<< 3Ë+ ((
b4
 & 0x01) << 2);

49 
block_y
 = ((
b8
 >> 1Ë<< 3Ë+ ((
b4
 >> 1) << 2);

50 
pic_pix_x
 = 
cuºMB
->
pix_x
 + 
block_x
;

51 
pic_pix_y
 = 
cuºMB
->
pix_y
 + 
block_y
;

52 
pic_›ix_y
 = 
cuºMB
->
›ix_y
 + 
block_y
;

54 
À·_avaûabÀ
, 
up_avaûabÀ
, 
Æl_avaûabÀ
;

55 *
mb_size
 = 
p_Vid
->mb_size[
IS_LUMA
];

57 
upMode
, 
À·Mode
;

58 
mo°ProbabÀMode
;

60 
PixñPos
 
À·_block
, 
t›_block
;

62 
di°blk
 
fixedco°
 = 
	`weighãd_co°
(
œmbda
, 4);

63 
di°blk
 
⁄eco°
 = 
	`weighãd_co°
(
œmbda
, 1);

65 
be°_nz_c€ff
 = 0;

66 
block_x4
 = 
block_x
>>2;

67 
block_y4
 = 
block_y
>>2;

68 
img≥l
 ***
m¥4x4
 = 
cuºSli˚
->
m¥_4x4
[0];

69 
img≥l
 **
cur_img
 = &
p_Vid
->
pCurImg
[
pic_›ix_y
];

71 #ifde‡
BEST_NZ_COEFF


72 
be°_coded_block_Êag
 = 0;

73 
bô_pos
 = 1 + ((((
b8
>>1)<<1)+(
b4
>>1))<<2) + (((b8&1)<<1)+(b4&1));

74 
öt64
 
cbp_bôs
;

76 i‡(
b8
==0 && 
b4
==0)

77 
cbp_bôs
 = 0;

80 
	`gë4x4Neighbour
(
cuºMB
, 
block_x
 - 1, 
block_y
 , 
mb_size
, &
À·_block
);

81 
	`gë4x4Neighbour
(
cuºMB
, 
block_x
, 
block_y
 - 1, 
mb_size
, &
t›_block
 );

84 i‡(
p_I≈
->
U£C⁄°øöedI¡øPªd
)

86 
À·_block
.
avaûabÀ
 =Üe·_block.avaûabÀ ? 
p_Vid
->
öåa_block
[À·_block.
mb_addr
] : 0;

87 
t›_block
.
avaûabÀ
 =Å›_block.avaûabÀ ? 
p_Vid
->
öåa_block
[t›_block.
mb_addr
] : 0;

90 
upMode
 = 
t›_block
.
avaûabÀ
 ? 
p_Vid
->
ùªdmode
[t›_block.
pos_y
 ][t›_block.
pos_x
 ] : () -1;

91 
À·Mode
 = 
À·_block
.
avaûabÀ
 ? 
p_Vid
->
ùªdmode
[À·_block.
pos_y
][À·_block.
pos_x
] : () -1;

93 
mo°ProbabÀMode
 = (
upMode
 < 0 || 
À·Mode
 < 0Ë? 
DC_PRED
 : upMode <ÜeftMode ? upMode :ÜeftMode;

94 *
mö_co°
 = 
DISTBLK_MAX
;

96 
cuºMB
->
ùmode_DPCM
 = 
NO_INTRA_PMODE
;

100 
cuºSli˚
->
	`£t_öå≠ªd_4x4
(
cuºMB
, 
PLANE_Y
, 
pic_pix_x
, 
pic_pix_y
, &
À·_avaûabÀ
, &
up_avaûabÀ
, &
Æl_avaûabÀ
);

103 
ùmode
 = 0; ipmodê< 
NO_INTRA_PMODE
; ipmode++)

105 
avaûabÀ_mode
 = (
Æl_avaûabÀ
Ë|| (
ùmode
==
DC_PRED
) ||

106 (
up_avaûabÀ
 && (
ùmode
==
VERT_PRED
||ùmode==
VERT_LEFT_PRED
||ùmode==
DIAG_DOWN_LEFT_PRED
)) ||

107 (
À·_avaûabÀ
 && (
ùmode
==
HOR_PRED
||ùmode==
HOR_UP_PRED
));

109 if–
	`vÆid_öåa_mode
(
cuºSli˚
, 
ùmode
Ë!0 && 
avaûabÀ_mode
)

112 
	`gë_öå≠ªd_4x4
(
cuºMB
, 
PLANE_Y
, 
ùmode
, 
block_x
, 
block_y
, 
À·_avaûabÀ
, 
up_avaûabÀ
);

114 
co°
 = (
ùmode
 =
mo°ProbabÀMode
Ë? 
⁄eco°
 : 
fixedco°
;

115 i‡(
co°
 < *
mö_co°
)

117 
co°
 +
cuºSli˚
->
	`compuã_co°4x4
(
p_Vid
, 
cur_img
, 
m¥4x4
[
ùmode
], 
pic_pix_x
, *
mö_co°
 - cost);

119 i‡(
co°
 < *
mö_co°
)

121 
be°_ùmode
 = 
ùmode
;

122 *
mö_co°
 = 
co°
;

128 #i‡
INTRA_RDCOSTCALC_NNZ


129 
p_Vid
->
nz_c€ff
 [
cuºMB
->
mbAddrX
][
block_x4
][
block_y4
] = 
be°_nz_c€ff
;

131 #ifde‡
BEST_NZ_COEFF


132 
cbp_bôs
 &(~(
öt64
)(1<<
bô_pos
));

133 
cbp_bôs
 |(
öt64
)(
be°_coded_block_Êag
<<
bô_pos
);

137 
p_Vid
->
ùªdmode
[
pic_pix_y
 >> 2][
pic_pix_x
 >> 2] = (Ë
be°_ùmode
;

138 
cuºMB
->
öåa_¥ed_modes
[4*
b8
+
b4
] = (Ë(
mo°ProbabÀMode
 =
be°_ùmode
 ? -1 : (best_ipmode < mostProbableMode ? best_ipmode : best_ipmode - 1));

141 
	`gíî©e_¥ed_îr‹_4x4
(
cur_img
, 
m¥4x4
[
be°_ùmode
], &
cuºSli˚
->
mb_¥ed
[0][
block_y
], &cuºSli˚->
mb_‹es
[0][block_y], 
pic_pix_x
, 
block_x
);

143 
cuºMB
->
ùmode_DPCM
 = (Ë
be°_ùmode
;

145 
	`£À˘_å™sf‹m
(
cuºMB
);

147 i‡(
cuºMB
->
mb_ty≥
 =
I4MB
)

148 
n⁄zîo
 = 
cuºMB
->
¸_cbp
[0] = 
	`ªsiduÆ_å™sf‹m_qu™t_luma_4x4
 (cuºMB, 
PLANE_Y
, 
block_x
, 
block_y
, &
dummy
, 1);

150 
n⁄zîo
 = 
cuºMB
->
¸_cbp
[0] = cuºMB->
	`ªsiduÆ_å™sf‹m_qu™t_luma_4x4
 (cuºMB, 
PLANE_Y
, 
block_x
, 
block_y
, &
dummy
, 1);

152  
n⁄zîo
;

153 
	}
}

162 
	$mode_decisi⁄_f‹_I8x8_blocks_JM_Low
 (
Ma¸oblock
 *
cuºMB
, 
b8
, 
œmbda
, 
di°blk
 *
mö_co°
)

164 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

165 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

166 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

168 
ùmode
, 
be°_ùmode
 = 0, 
j
, 
dummy
;

169 
di°blk
 
co°
;

170 
n⁄zîo
 = 0;

171 
block_x
 = (
b8
 & 0x01) << 3;

172 
block_y
 = (
b8
 >> 1) << 3;

173 
pic_pix_x
 = 
cuºMB
->
pix_x
 + 
block_x
;

174 
pic_pix_y
 = 
cuºMB
->
pix_y
 + 
block_y
;

175 
pic_›ix_y
 = 
cuºMB
->
›ix_y
 + 
block_y
;

176 
mb_block_y
 = (
cuºMB
->
block_y
) + (block_y >> 2);

177 
mb_block_x
 = (
cuºMB
->
block_x
) + (block_x >> 2);

179 
À·_avaûabÀ
, 
up_avaûabÀ
, 
Æl_avaûabÀ
;

180 **
mb_‹es
 = 
cuºSli˚
->mb_ores[0];

181 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_pred[0];

182 *
mb_size
 = 
p_Vid
->mb_size[
IS_LUMA
];

184 
upMode
;

185 
À·Mode
;

186 
mo°ProbabÀMode
;

187 
fixedco°
 = (Ë
	`weighãd_co°
(
œmbda
, 4);

188 
m¥obco°
 = (Ë
	`weighãd_co°
(
œmbda
, 1);

190 
PixñPos
 
À·_block
, 
t›_block
;

192 
	`gë4x4Neighbour
(
cuºMB
, 
block_x
 - 1, 
block_y
 , 
mb_size
, &
À·_block
);

193 
	`gë4x4Neighbour
(
cuºMB
, 
block_x
, 
block_y
 - 1, 
mb_size
, &
t›_block
 );

195 i‡(
p_I≈
->
U£C⁄°øöedI¡øPªd
)

197 
t›_block
.
avaûabÀ
 =Å›_block.avaûabÀ ? 
p_Vid
->
öåa_block
 [t›_block.
mb_addr
] : 0;

198 
À·_block
.
avaûabÀ
 =Üe·_block.avaûabÀ ? 
p_Vid
->
öåa_block
 [À·_block.
mb_addr
] : 0;

201 if(
b8
 >> 1)

202 
upMode
 = 
t›_block
.
avaûabÀ
 ? 
p_Vid
->
ùªdmode8x8
[t›_block.
pos_y
 ][t›_block.
pos_x
 ] : -1;

204 
upMode
 = 
t›_block
.
avaûabÀ
 ? 
p_Vid
->
ùªdmode
 [t›_block.
pos_y
 ][t›_block.
pos_x
 ] : -1;

206 if(
b8
 & 0x01)

207 
À·Mode
 = 
À·_block
.
avaûabÀ
 ? 
p_Vid
->
ùªdmode8x8
[À·_block.
pos_y
][À·_block.
pos_x
] : -1;

209 
À·Mode
 = 
À·_block
.
avaûabÀ
 ? 
p_Vid
->
ùªdmode
[À·_block.
pos_y
][À·_block.
pos_x
] : -1;

211 
mo°ProbabÀMode
 = (
upMode
 < 0 || 
À·Mode
 < 0Ë? 
DC_PRED
 : upMode <ÜeftMode ? upMode :ÜeftMode;

212 *
mö_co°
 = 
DISTBLK_MAX
;

213 
cuºMB
->
ùmode_DPCM
 = 
NO_INTRA_PMODE
;

216 
cuºSli˚
->
	`£t_öå≠ªd_8x8
(
cuºMB
, 
PLANE_Y
, 
pic_pix_x
, 
pic_pix_y
, &
À·_avaûabÀ
, &
up_avaûabÀ
, &
Æl_avaûabÀ
);

219 
ùmode
 = 
mo°ProbabÀMode
;

221 if–(
ùmode
==
DC_PRED
) ||

222 ((
ùmode
==
VERT_PRED
||ùmode==
VERT_LEFT_PRED
||ùmode==
DIAG_DOWN_LEFT_PRED
Ë&& 
up_avaûabÀ
 ) ||

223 ((
ùmode
==
HOR_PRED
||ùmode==
HOR_UP_PRED
Ë&& 
À·_avaûabÀ
 ) ||

224 (
Æl_avaûabÀ
) )

226 
	`gë_öå≠ªd_8x8
(
cuºMB
, 
PLANE_Y
, 
ùmode
, 
À·_avaûabÀ
, 
up_avaûabÀ
);

227 
co°
 = 
m¥obco°
;

228 
co°
 +
cuºSli˚
->
	`compuã_co°8x8
(
p_Vid
, &p_Vid->
pImgOrg
[0][
pic_›ix_y
], cuºSli˚->
m¥_8x8
[0][
ùmode
], 
pic_pix_x
, *
mö_co°
 - cost);

229 
be°_ùmode
 = 
mo°ProbabÀMode
;

230 *
mö_co°
 = 
co°
;

235 
ùmode
 = 0; ipmodê< 
NO_INTRA_PMODE
; ipmode++)

237 i‡(
ùmode
 !
mo°ProbabÀMode
)

239 if–(
ùmode
==
DC_PRED
) ||

240 ((
ùmode
==
VERT_PRED
||ùmode==
VERT_LEFT_PRED
||ùmode==
DIAG_DOWN_LEFT_PRED
Ë&& 
up_avaûabÀ
 ) ||

241 ((
ùmode
==
HOR_PRED
||ùmode==
HOR_UP_PRED
Ë&& 
À·_avaûabÀ
 ) ||

242 (
Æl_avaûabÀ
) )

244 
	`gë_öå≠ªd_8x8
(
cuºMB
, 
PLANE_Y
, 
ùmode
, 
À·_avaûabÀ
, 
up_avaûabÀ
);

245 
co°
 = 
fixedco°
;

247 i‡(
co°
 < *
mö_co°
)

249 
co°
 +
cuºSli˚
->
	`compuã_co°8x8
(
p_Vid
, &p_Vid->
pImgOrg
[0][
pic_›ix_y
], cuºSli˚->
m¥_8x8
[0][
ùmode
], 
pic_pix_x
, *
mö_co°
 - cost);

250 i‡(
co°
 < *
mö_co°
)

252 
be°_ùmode
 = 
ùmode
;

253 *
mö_co°
 = 
co°
;

261 
p_Vid
->
ùªdmode8x8
[
pic_pix_y
 >> 2][
pic_pix_x
 >> 2] = (Ë
be°_ùmode
;

262 
cuºMB
->
ùmode_DPCM
 = (Ë
be°_ùmode
;

264 
cuºMB
->
öåa_¥ed_modes8x8
[4*
b8
] = ()((
mo°ProbabÀMode
 =
be°_ùmode
)

266 : (
be°_ùmode
 < 
mo°ProbabÀMode
 ? best_ipmode : best_ipmode-1));

268 
j
 = 
mb_block_y
; j < mb_block_y + 2; j++)

269 
	`mem£t
(&
p_Vid
->
ùªdmode8x8
[
j
][
mb_block_x
], 
be°_ùmode
, 2 * ());

272 
	`gíî©e_¥ed_îr‹_8x8
(&
p_Vid
->
pCurImg
[
pic_›ix_y
], 
cuºSli˚
->
m¥_8x8
[0][
be°_ùmode
], &
mb_¥ed
[
block_y
], &
mb_‹es
[block_y], 
pic_pix_x
, 
block_x
);

273 
cuºMB
->
ùmode_DPCM
 = (Ë
be°_ùmode
;

275 
n⁄zîo
 = 
cuºMB
->
	`ªsiduÆ_å™sf‹m_qu™t_luma_8x8
 (cuºMB, 
PLANE_Y
, 
b8
, &
dummy
, 1);

276  
n⁄zîo
;

277 
	}
}

	@lencod/src/rdopt.c

18 
	~<m©h.h
>

19 
	~<limôs.h
>

21 
	~"globÆ.h
"

23 
	~"rd›t.h
"

24 
	~"q_¨ound.h
"

25 
	~"rd›t_codög_°©e.h
"

26 
	~"memÆloc.h
"

27 
	~"mb_ac˚ss.h
"

28 
	~"ñemíts.h
"

29 
	~"öå¨e‰esh.h
"

30 
	~"image.h
"

31 
	~"å™sf‹m8x8.h
"

32 
	~"ˇbac.h
"

33 
	~"bürõncode.h
"

34 
	~"¶i˚.h
"

35 
	~"vlc.h
"

36 
	~"øã˘l.h
"

37 
	~"mode_decisi⁄.h
"

38 
	~"rd_öåa_jm.h
"

39 
	~"rd_öåa_jm444.h
"

40 
	~"ma¸oblock.h
"

41 
	~"q_off£ts.h
"

42 
	~"c⁄f‹m™˚.h
"

43 
	~"îrdo.h
"

44 
	~"mv_£¨ch.h
"

45 
	~"md_comm⁄.h
"

46 
	~"md_di°‹ti⁄.h
"

47 
	~"öåa16x16.h
"

49 
	#FASTMODE
 1

	)

51 
£t_°‹ed_ma¸oblock_∑ømëîs
 (
Ma¸oblock
 *
cuºMB
);

52 
£t_°‹ed_ma¸oblock_∑ømëîs_•
 (
Ma¸oblock
 *
cuºMB
);

53 
£t_°‹ed_ma¸oblock_∑ømëîs_m∑ss
(
Ma¸oblock
 *
cuºMB
);

54 
£t_ªf_™d_mŸi⁄_ve˘‹s_P_¶i˚
 (
Ma¸oblock
 *
cuºMB
, 
PicMŸi⁄P¨ams
 **
mŸi⁄
, 
Info8x8
 *
¥ed
, );

55 
£t_ªf_™d_mŸi⁄_ve˘‹s_B_¶i˚
 (
Ma¸oblock
 *
cuºMB
, 
PicMŸi⁄P¨ams
 **
mŸi⁄
, 
Info8x8
 *
¥ed
, );

57 
di°blk
 
compuã_ßd4x4_co°
 (
VideoP¨amëîs
 *
p_Vid
, 
img≥l
 **
cur_img
, img≥»**
¥d_img
, 
pic_›ix_x
, di°blk 
mö_co°
);

58 
di°blk
 
compuã_s£4x4_co°
 (
VideoP¨amëîs
 *
p_Vid
, 
img≥l
 **
cur_img
, img≥»**
¥d_img
, 
pic_›ix_x
, di°blk 
mö_co°
);

59 
di°blk
 
compuã_ßtd4x4_co°
(
VideoP¨amëîs
 *
p_Vid
, 
img≥l
 **
cur_img
, img≥»**
¥d_img
, 
pic_›ix_x
, di°blk 
mö_co°
);

60 
di°blk
 
compuã_comp4x4_co°
(
VideoP¨amëîs
 *
p_Vid
, 
img≥l
 **
cur_img
, img≥»**
¥d_img
, 
pic_›ix_x
, di°blk 
mö_co°
);

62 
di°blk
 
rdco°_f‹_4x4_öåa_blocks
 (
Ma¸oblock
 *
cuºMB
, * 
n⁄zîo
, 
b8
, 
b4
, 
ùmode
, 
œmbda
, 
mo°ProbabÀMode
, di°blk 
mö_rdco°
);

63 
di°blk
 
rdco°_f‹_4x4_öåa_blocks_444
 (
Ma¸oblock
 *
cuºMB
, * 
n⁄zîo
, 
b8
, 
b4
, 
ùmode
, 
œmbda
, 
mo°ProbabÀMode
, di°blk 
mö_rdco°
);

65 
ölöe
 
	$c›y_mŸi⁄_ve˘‹s_MB
 (
Sli˚
 *
cuºSli˚
, 
RD_DATA
 *
rd›t
)

67 
	`mem˝y
(&
cuºSli˚
->
Æl_mv
 [
LIST_0
][0][0][0][0], &
rd›t
->Æl_mv [LIST_0][0][0][0][0], 288 * cuºSli˚->
max_num_ª„ªn˚s
 * (
MŸi⁄Ve˘‹
));

68 
	}
}

70 
Info8x8
 
	$öô_öfo_8x8_°ru˘
()

72 
Info8x8
 
i8x8
;

73 
i8x8
.
mode
 = 0;

74 
i8x8
.
pdú
 = 0;

75 
i8x8
.
ªf
[
LIST_0
] = 0;

76 
i8x8
.
ªf
[
LIST_1
] = -1;

77 
i8x8
.
bùªd
 = 0;

79  
i8x8
;

80 
	}
}

82 
	$Æloc_rd8x8d©a
 (
RD_8x8DATA
 *
rd_d©a
)

84 
	`gë_mem2Döt
(&
rd_d©a
->
Ãec
, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE);

85 
	`gë_mem2D≥l
(&
rd_d©a
->
m¥8x8
, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE);

86 
	`gë_mem3D≥l
(&
rd_d©a
->
m¥8x8CbCr
, 2, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE);

87 
	`gë_mem2D≥l
(&
rd_d©a
->
ªc_mbY8x8
, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE);

88 
	`gë_mem3D≥l
(&
rd_d©a
->
ªc_mb8x8_¸
, 2, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE);

89 
	}
}

91 
	$‰ì_rd8x8d©a
 (
RD_8x8DATA
 *
rd_d©a
)

93 
	`‰ì_mem3D≥l
(
rd_d©a
->
ªc_mb8x8_¸
);

94 
	`‰ì_mem2D≥l
(
rd_d©a
->
ªc_mbY8x8
);

95 
	`‰ì_mem3D≥l
(
rd_d©a
->
m¥8x8CbCr
);

96 
	`‰ì_mem2D≥l
(
rd_d©a
->
m¥8x8
);

97 
	`‰ì_mem2Döt
(
rd_d©a
->
Ãec
);

98 
	}
}

106 
	$˛ór_rd›t
 (
Sli˚
 *
cuºSli˚
)

108 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

109 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºSli˚
->p_Inp;

110 
RDOPTSåu˘uª
 *
p_RDO
 = 
cuºSli˚
->p_RDO;

112 
	`‰ì_mem_DCc€ff
 (
p_RDO
->
cofDC
);

113 
	`‰ì_mem_ACc€ff
 (
p_RDO
->
cofAC
);

114 
	`‰ì_mem_ACc€ff
 (
p_RDO
->
cofAC4x4öã∫
);

115 
	`‰ì_mem_ACc€ff_√w
(
p_RDO
->
c€fAC8x8
);

116 
	`‰ì_mem_ACc€ff_√w
(
p_RDO
->
c€fAC8x8öåa
);

118 i‡(
p_I≈
->
Tønsf‹m8x8Mode
)

120 
	`‰ì_mem_ACc€ff_√w
(
p_RDO
->
cofAC8x8ts
);

123 i‡(
p_Vid
->
P444_joöed
)

125 
	`‰ì_mem_ACc€ff_√w
(
p_RDO
->
cofAC4x4CbCröã∫
);

129 
	`‰ì_rd8x8d©a
(
p_RDO
->
å4x4
);

130 
	`‰ì
(
p_RDO
->
å4x4
);

131 
	`‰ì_rd8x8d©a
(
p_RDO
->
å8x8
);

132 
	`‰ì
(
p_RDO
->
å8x8
);

134 
	`‰ì_mem4Dmv
(
p_RDO
->
Æl_mv8x8
);

136 
	`‰ì_mem3D≥l
(
p_RDO
->
ªc4x4
);

137 
	`‰ì_mem3D≥l
(
p_RDO
->
ªc8x8
);

138 
	`‰ì_mem2D≥l
(
p_RDO
->
¥ed
);

139 
	`‰ì_mem3D≥l
(
p_RDO
->
ªc_mb
);

141 i‡(
p_I≈
->
ProfûeIDC
 =
EXTENDED
)

143 
	`‰ì_mem2Döt
(
p_RDO
->
Ãec_ªc
);

144 
	`‰ì_mem3Döt
(
p_RDO
->
Ãec_ªc_uv
);

147 
	`‰ì_mem2D
((
byã
 **Ë
p_RDO
->
l0_ªf‰ame
);

148 
	`‰ì_mem2D
((
byã
 **Ë
p_RDO
->
l1_ªf‰ame
);

151 
	`dñëe_codög_°©e
 (
p_RDO
->
cs_mb
);

152 
	`dñëe_codög_°©e
 (
p_RDO
->
cs_b8
);

153 
	`dñëe_codög_°©e
 (
p_RDO
->
cs_cm
);

154 
	`dñëe_codög_°©e
 (
p_RDO
->
cs_tmp
);

155 
	}
}

157 
	$£tupDi°Co°
(
Sli˚
 *
cuºSli˚
, 
I≈utP¨amëîs
 *
p_I≈
)

159 
p_I≈
->
ModeDecisi⁄Mëric
)

161 
ERROR_SAD
:

162 
cuºSli˚
->
compuã_co°4x4
 = 
compuã_ßd4x4_co°
;

163 
cuºSli˚
->
compuã_co°8x8
 = 
compuã_ßd8x8_co°
;

164 
cuºSli˚
->
di°I16x16
 = 
di°I16x16_ßd
;

166 
ERROR_SSE
:

167 
cuºSli˚
->
compuã_co°4x4
 = 
compuã_s£4x4_co°
;

168 
cuºSli˚
->
compuã_co°8x8
 = 
compuã_s£8x8_co°
;

169 
cuºSli˚
->
di°I16x16
 = 
di°I16x16_s£
;

171 
ERROR_SATD
:

172 
cuºSli˚
->
compuã_co°4x4
 = 
compuã_ßtd4x4_co°
;

173 
cuºSli˚
->
compuã_co°8x8
 = 
compuã_ßtd8x8_co°
;

174 
cuºSli˚
->
di°I16x16
 = 
di°I16x16_ßtd
;

177 
cuºSli˚
->
compuã_co°4x4
 = 
compuã_comp4x4_co°
;

178 
cuºSli˚
->
compuã_co°8x8
 = 
compuã_comp8x8_co°
;

179 
cuºSli˚
->
di°I16x16
 = 
di°I16x16_ßtd
;

182 
	}
}

191 
	$öô_rd›t
 (
Sli˚
 *
cuºSli˚
)

193 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

194 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºSli˚
->p_Inp;

195 
RDOPTSåu˘uª
 *
p_RDO
 = 
cuºSli˚
->p_RDO;

197 
	`gë_mem_DCc€ff
 (&
p_RDO
->
cofDC
);

198 
	`gë_mem_ACc€ff
 (
p_Vid
, &
p_RDO
->
cofAC
);

199 
	`gë_mem_ACc€ff
 (
p_Vid
, &
p_RDO
->
cofAC4x4öã∫
);

200 
p_RDO
->
cofAC4x4
 =Ö_RDO->
cofAC4x4öã∫
[0][0];

201 
	`gë_mem_ACc€ff_√w
(&
p_RDO
->
c€fAC8x8
, 3);

202 
	`gë_mem_ACc€ff_√w
(&
p_RDO
->
c€fAC8x8öåa
, 3);

204 i‡(
p_I≈
->
Tønsf‹m8x8Mode
)

206 
	`gë_mem_ACc€ff_√w
(&
p_RDO
->
cofAC8x8ts
, 3);

209 i‡(((
p_RDO
->
å4x4
Ë(
RD_8x8DATA
 *Ë
	`ˇŒoc
(1, (RD_8x8DATA)))==
NULL
)

210 
	`no_mem_exô
("init_rdopt:Ö_RDO->tr4x4");

211 
	`Æloc_rd8x8d©a
(
p_RDO
->
å4x4
);

212 i‡(((
p_RDO
->
å8x8
Ë(
RD_8x8DATA
 *Ë
	`ˇŒoc
(1, (RD_8x8DATA)))==
NULL
)

213 
	`no_mem_exô
("init_rdopt:Ö_RDO->tr4x4");

214 
	`Æloc_rd8x8d©a
(
p_RDO
->
å8x8
);

216 
	`gë_mem2D≥l
(&
p_RDO
->
¥ed
, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE);

217 
	`gë_mem3D≥l
(&
p_RDO
->
ªc8x8
, 3, 
BLOCK_SIZE_8x8
, BLOCK_SIZE_8x8);

218 
	`gë_mem3D≥l
(&
p_RDO
->
ªc4x4
, 3, 
BLOCK_SIZE
, BLOCK_SIZE);

219 
	`gë_mem3D≥l
(&
p_RDO
->
ªc_mb
, 3, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE);

221 i‡(
p_I≈
->
ProfûeIDC
 =
EXTENDED
)

223 
	`gë_mem2Döt
(&
p_RDO
->
Ãec_ªc
, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE);

224 
	`gë_mem3Döt
(&
p_RDO
->
Ãec_ªc_uv
, 2, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE);

227 
	`gë_mem2D
((
byã
 ***Ë&
p_RDO
->
l0_ªf‰ame
, 4, 4);

228 
	`gë_mem2D
((
byã
 ***Ë&
p_RDO
->
l1_ªf‰ame
, 4, 4);

230 
	`gë_mem4Dmv
(&
p_RDO
->
Æl_mv8x8
, 2, 2, 4, 4);

232 i‡(
p_Vid
->
P444_joöed
)

234 
	`gë_mem_ACc€ff_√w
(&
p_RDO
->
cofAC4x4CbCröã∫
, 2);

236 
p_RDO
->
cofAC4x4CbCr
[0] =Ö_RDO->
cofAC4x4CbCröã∫
[0][0][0];

237 
p_RDO
->
cofAC4x4CbCr
[1] =Ö_RDO->
cofAC4x4CbCröã∫
[0][1][0];

240 
cuºSli˚
->
£t_œgøngün_mu…ùlõrs
 = 
p_I≈
->
rd›t
 =0 ? 
SëLagøngünMu…ùlõrsOff
 : 
SëLagøngünMu…ùlõrsOn
;

242 
p_I≈
->
rd›t
)

245 
cuºSli˚
->
ícode_⁄e_ma¸oblock
 = 
ícode_⁄e_ma¸oblock_low
;

249 
cuºSli˚
->
ícode_⁄e_ma¸oblock
 = 
ícode_⁄e_ma¸oblock_high
;

252 
cuºSli˚
->
ícode_⁄e_ma¸oblock
 = 
ícode_⁄e_ma¸oblock_highÁ°
;

255 
cuºSli˚
->
ícode_⁄e_ma¸oblock
 = 
ícode_⁄e_ma¸oblock_highloss
;

259 i‡(
cuºSli˚
->
mb_aff_‰ame_Êag
 || (cuºSli˚->
U£RDOQu™t
 && cuºSli˚->
RDOQ_QP_Num
 > 1))

260 
cuºSli˚
->
£t_°‹ed_mb_∑ømëîs
 = 
£t_°‹ed_ma¸oblock_∑ømëîs_m∑ss
;

263 i‡(
cuºSli˚
->
¶i˚_ty≥
 =
SP_SLICE
 || cuºSli˚->¶i˚_ty≥ =
SI_SLICE
)

264 
cuºSli˚
->
£t_°‹ed_mb_∑ømëîs
 = 
£t_°‹ed_ma¸oblock_∑ømëîs_•
;

266 
cuºSli˚
->
£t_°‹ed_mb_∑ømëîs
 = 
£t_°‹ed_ma¸oblock_∑ømëîs
;

270 
p_RDO
->
cs_mb
 = 
	`¸óã_codög_°©e
 (
p_I≈
);

271 
p_RDO
->
cs_b8
 = 
	`¸óã_codög_°©e
 (
p_I≈
);

272 
p_RDO
->
cs_cm
 = 
	`¸óã_codög_°©e
 (
p_I≈
);

273 
p_RDO
->
cs_tmp
 = 
	`¸óã_codög_°©e
 (
p_I≈
);

274 i‡(
p_I≈
->
CtxAd±LagøngeMu…
 == 1)

276 
p_Vid
->
mb16x16_co°
 = 
CALM_MF_FACTOR_THRESHOLD
;

277 
p_RDO
->
œmbda_mf_Á˘‹
 = 1.0;

280 
cuºSli˚
->
rdco°_f‹_4x4_öåa_blocks
 = (
p_Vid
->
yuv_f‹m©
 =
YUV444
Ë? 
rdco°_f‹_4x4_öåa_blocks_444
 :Ñdcost_for_4x4_intra_blocks;

281 
cuºSli˚
->
rdco°_f‹_8x8_öåa_blocks
 = (
p_Vid
->
yuv_f‹m©
 =
YUV444
Ë? 
rdco°_f‹_8x8_öåa_blocks_444
 :Ñdcost_for_8x8_intra_blocks;

283 i‡(
cuºSli˚
->
mb_aff_‰ame_Êag
)

284 
cuºSli˚
->
öåa_chroma_RD_decisi⁄
 = 
öåa_chroma_RD_decisi⁄_mbaff
;

286 
cuºSli˚
->
öåa_chroma_RD_decisi⁄
 = intra_chroma_RD_decision;

287 i‡(
p_I≈
->
rd›t
 == 0)

289 
cuºSli˚
->
mode_decisi⁄_f‹_I8x8_blocks
 = (
p_Vid
->
yuv_f‹m©
 =
YUV444
Ë? 
mode_decisi⁄_f‹_I8x8_blocks_JM_Low444
 : 
mode_decisi⁄_f‹_I8x8_blocks_JM_Low
;

290 
cuºSli˚
->
mode_decisi⁄_f‹_I4x4_blocks
 = (
p_Vid
->
yuv_f‹m©
 =
YUV444
Ë? 
mode_decisi⁄_f‹_I4x4_blocks_JM_Low444
 : 
mode_decisi⁄_f‹_I4x4_blocks_JM_Low
;

294 
cuºSli˚
->
mode_decisi⁄_f‹_I8x8_blocks
 = (
p_Vid
->
yuv_f‹m©
 =
YUV444
Ë? 
mode_decisi⁄_f‹_I8x8_blocks_JM_High444
 : 
mode_decisi⁄_f‹_I8x8_blocks_JM_High
;

295 
cuºSli˚
->
mode_decisi⁄_f‹_I4x4_blocks
 = (
p_Vid
->
yuv_f‹m©
 =
YUV444
Ë? 
mode_decisi⁄_f‹_I4x4_blocks_JM_High444
 : 
mode_decisi⁄_f‹_I4x4_blocks_JM_High
;

298 
cuºSli˚
->
föd_ßd_16x16
 = 
föd_ßd_16x16_JM
;

300 i‡(
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
)

301 
cuºSli˚
->
£t_ªf_™d_mŸi⁄_ve˘‹s
 = 
£t_ªf_™d_mŸi⁄_ve˘‹s_B_¶i˚
;

303 
cuºSli˚
->
£t_ªf_™d_mŸi⁄_ve˘‹s
 = 
£t_ªf_™d_mŸi⁄_ve˘‹s_P_¶i˚
;

305 
	`£tupDi°‹ti⁄
(
cuºSli˚
);

306 
	`£tupDi°Co°
 (
cuºSli˚
, 
p_I≈
);

307 
	}
}

320 
	$Upd©ePixñM≠
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

322 
mx
,
my
,
y
,
x
,
i
,
j
;

323 i‡(
p_Vid
->
ty≥
==
I_SLICE
)

325 
	`mem£t
(
p_Vid
->
pixñ_m≠
, 1,Ö_Vid->
height
 *Ö_Vid->
width
 * (
byã
));

329 
my
=0; my<
p_Vid
->
height
 >> 3; my++)

331 
mx
=0; mx<
p_Vid
->
width
 >> 3; mx++)

333 
j
 = 
my
*8 + 8;

334 
i
 = 
mx
*8 + 8;

335 i‡(
p_Vid
->
ª‰esh_m≠
[
my
][
mx
])

337 
y
=
my
*8; y<
j
; y++)

338 
	`mem£t
(&
p_Vid
->
pixñ_m≠
[
y
][
mx
*8], 1, 8 * (
byã
));

342 
y
=
my
*8; y<
j
; y++)

344 
x
=
mx
*8; x<
i
; x++)

346 
p_Vid
->
pixñ_m≠
[
y
][
x
] = (
byã
Ë
	`imö
’_Vid->pixñ_m≠[y][x] + 1, 
p_I≈
->
num_ªf_‰ames
+1);

353 
	}
}

373 
	$CheckRñübûôyOfRef
 (
Ma¸oblock
 *
cuºMB
, 
block
, 
li°_idx
, 
ªf
, 
mode
)

375 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

376 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

378 
y
,
x
, 
block_y
, 
block_x
, 
dy
, 
dx
, 
y_pos
, 
x_pos
, 
yy
, 
xx
, 
¥es_x
, 
¥es_y
;

379 
maxﬁd_x
 = 
p_Vid
->
width
 - 1;

380 
maxﬁd_y
 = 
p_Vid
->
height
 - 1;

381 
ªf_‰ame
 = 
ªf
 + 1;

383 
by0
 = (
mode
>=4?2*(
block
 >> 1):mode==2?2*block:0);

384 
by1
 = 
by0
 + (
mode
>=4||mode==2?2:4);

385 
bx0
 = (
mode
>=4?2*(
block
 & 0x01):mode==3?2*block:0);

386 
bx1
 = 
bx0
 + (
mode
>=4||mode==3?2:4);

388 
block_y
=
by0
; block_y<
by1
; block_y++)

390 
block_x
=
bx0
; block_x<
bx1
; block_x++)

392 
y_pos
 = 
cuºSli˚
->
Æl_mv
[
li°_idx
][
ªf
][
mode
][
block_y
][
block_x
].
mv_y
;

393 
y_pos
 +(
cuºMB
->
block_y
 + block_yË* 
BLOCK_SIZE
 * 4;

394 
x_pos
 = 
cuºSli˚
->
Æl_mv
[
li°_idx
][
ªf
][
mode
][
block_y
][
block_x
].
mv_x
;

395 
x_pos
 +(
cuºMB
->
block_x
 + block_xË* 
BLOCK_SIZE
 * 4;

401 
dy
 = 
y_pos
 & 3;

402 
dx
 = 
x_pos
 & 3;

404 
y_pos
 = (y_po†- 
dy
) >> 2;

405 
x_pos
 = (x_po†- 
dx
) >> 2;

407 i‡(
dy
==0 && 
dx
==0)

409 
y
=
y_pos
 ; y < y_po†+ 
BLOCK_SIZE
 ; y++)

410 
x
=
x_pos
 ; x < x_po†+ 
BLOCK_SIZE
 ; x++)

411 i‡(
p_Vid
->
pixñ_m≠
[
	`iClù3
(0,
maxﬁd_y
,
y
)][iClù3(0,
maxﬁd_x
,
x
)] < 
ªf_‰ame
)

416 i‡(
dy
 == 0)

418 
y
 = 
y_pos
 ; y < y_po†+ 
BLOCK_SIZE
 ; y++)

420 
¥es_y
 = 
	`iClù3
(0, 
maxﬁd_y
, 
y
);

421 
x
 = 
x_pos
 ; x < x_po†+ 
BLOCK_SIZE
 ; x++)

423 
xx
 = -2 ; xx < 4 ; xx++)

425 
¥es_x
 = 
	`iClù3
(0, 
maxﬁd_x
, 
x
 + 
xx
);

426 i‡(
p_Vid
->
pixñ_m≠
[
¥es_y
][
¥es_x
] < 
ªf_‰ame
)

432 i‡(
dx
 == 0)

434 
y
 = 
y_pos
 ; y < y_po†+ 
BLOCK_SIZE
 ; y++)

435 
x
 = 
x_pos
 ; x < x_po†+ 
BLOCK_SIZE
 ; x++)

437 
¥es_x
 = 
	`iClù3
(0,
maxﬁd_x
,
x
);

438 
yy
=-2;yy<4;yy++)

440 
¥es_y
 = 
	`iClù3
(0,
maxﬁd_y
, 
yy
 + 
y
);

441 i‡(
p_Vid
->
pixñ_m≠
[
¥es_y
][
¥es_x
] < 
ªf_‰ame
)

446 i‡(
dx
 == 2)

448 
y
 = 
y_pos
 ; y < y_po†+ 
BLOCK_SIZE
 ; y++)

449 
x
 = 
x_pos
 ; x < x_po†+ 
BLOCK_SIZE
 ; x++)

451 
yy
=-2;yy<4;yy++)

453 
¥es_y
 = 
	`iClù3
(0,
maxﬁd_y
, 
yy
 + 
y
);

454 
xx
=-2;xx<4;xx++)

456 
¥es_x
 = 
	`iClù3
(0,
maxﬁd_x
, 
xx
 + 
x
);

457 i‡(
p_Vid
->
pixñ_m≠
[
¥es_y
][
¥es_x
] < 
ªf_‰ame
)

463 i‡(
dy
 == 2)

465 
y
 = 
y_pos
 ; y < y_po†+ 
BLOCK_SIZE
 ; y++)

466 
x
 = 
x_pos
 ; x < x_po†+ 
BLOCK_SIZE
 ; x++)

468 
xx
=-2;xx<4;xx++)

470 
¥es_x
 = 
	`iClù3
(0,
maxﬁd_x
, 
xx
 + 
x
);

471 
yy
=-2;yy<4;yy++)

473 
¥es_y
 = 
	`iClù3
(0,
maxﬁd_y
, 
yy
 + 
y
);

474 i‡(
p_Vid
->
pixñ_m≠
[
¥es_y
][
¥es_x
] < 
ªf_‰ame
)

482 
y
 = 
y_pos
 ; y < y_po†+ 
BLOCK_SIZE
 ; y++)

484 
x
 = 
x_pos
 ; x < x_po†+ 
BLOCK_SIZE
 ; x++)

486 
¥es_y
 = 
dy
 =1 ? 
y
 : y + 1;

487 
¥es_y
 = 
	`iClù3
(0,
maxﬁd_y
,pres_y);

489 
xx
 = -2; xx < 4; xx++)

491 
¥es_x
 = 
	`iClù3
(0,
maxﬁd_x
,
xx
 + 
x
);

492 i‡(
p_Vid
->
pixñ_m≠
[
¥es_y
][
¥es_x
] < 
ªf_‰ame
)

496 
¥es_x
 = 
dx
 =1 ? 
x
 : x + 1;

497 
¥es_x
 = 
	`iClù3
(0,
maxﬁd_x
,pres_x);

499 
yy
=-2;yy<4;yy++)

501 
¥es_y
 = 
	`iClù3
(0,
maxﬁd_y
, 
yy
 + 
y
);

502 i‡(
p_Vid
->
pixñ_m≠
[
¥es_y
][
¥es_x
] < 
ªf_‰ame
)

512 
	}
}

520 
di°blk
 
	$rdco°_f‹_4x4_öåa_blocks
 (
Ma¸oblock
 *
cuºMB
,

521 * 
n⁄zîo
,

522 
b8
,

523 
b4
,

524 
ùmode
,

525 
œmbda
,

526 
mo°ProbabÀMode
,

527 
di°blk
 
mö_rdco°
)

529 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

530 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

531 
di°blk
 
rdco°
;

532 
dummy
 = 0, 
øã
;

533 
di°blk
 
di°‹ti⁄
 = 0;

534 
block_x
 = ((
b8
 & 0x01Ë<< 3Ë+ ((
b4
 & 0x01) << 2);

535 
block_y
 = ((
b8
 >> 1Ë<< 3Ë+ ((
b4
 >> 1) << 2);

536 
pic_pix_x
 = 
cuºMB
->
pix_x
 + 
block_x
;

537 
pic_pix_y
 = 
cuºMB
->
pix_y
 + 
block_y
;

538 
pic_›ix_y
 = 
cuºMB
->
›ix_y
 + 
block_y
;

540 
Sy¡axEÀmít
 
£
;

541 c⁄° *
∑πM≠
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
∑πôi⁄_mode
];

543 
D©aP¨tôi⁄
 *
d©aP¨t
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_INTRAPREDMODE
]]);

548 
cuºMB
->
ùmode_DPCM
 = (Ë
ùmode
;

549 *
n⁄zîo
 = 
cuºMB
->
	`ªsiduÆ_å™sf‹m_qu™t_luma_4x4
 (cuºMB, 
PLANE_Y
, 
block_x
, 
block_y
, &
dummy
, 1);

552 
di°‹ti⁄
 +
	`compuã_SSE4x4
(&
p_Vid
->
pCurImg
[
pic_›ix_y
], &p_Vid->
íc_pi˘uª
->
imgY
[
pic_pix_y
], 
pic_pix_x
,Öic_pix_x);

553 #i‡
INTRA_RDCOSTCALC_ET


555 i‡(
di°‹ti⁄
 >
mö_rdco°
)

557  (
di°‹ti⁄
);

560 
cuºMB
->
ùmode_DPCM
 = 
NO_INTRA_PMODE
;

563 
£
.
vÆue1
 = (
mo°ProbabÀMode
 =
ùmode
) ? -1 : ipmode < mostProbableMode ? ipmode : ipmode - 1;

566 
£
.
c⁄ãxt
 = (
b8
 << 2Ë+ 
b4
;

567 
£
.
ty≥
 = 
SE_INTRAPREDMODE
;

570 
cuºSli˚
->
	`wrôeI¡øPªdMode
 (&
£
, 
d©aP¨t
);

571 
øã
 = 
£
.
Àn
;

574 i‡(
cuºSli˚
->
symbﬁ_mode
 =
CAVLC
)

576 
øã
 +
cuºSli˚
->
	`wrôeC€ff4x4_CAVLC
 (
cuºMB
, 
LUMA
, 
b8
, 
b4
, 0);

580 
øã
 +
	`wrôeC€ff4x4_CABAC
 (
cuºMB
, 
PLANE_Y
, 
b8
, 
b4
, 1);

583 
rdco°
 = 
di°‹ti⁄
 + 
	`weighãd_co°
(
œmbda
, 
øã
);

585 
cuºSli˚
->
	`ª£t_codög_°©e
 (
cuºMB
, cuºSli˚->
p_RDO
->
cs_cm
);

587  
rdco°
;

588 
	}
}

597 
di°blk
 
	$rdco°_f‹_4x4_öåa_blocks_444
 (
Ma¸oblock
 *
cuºMB
,

598 * 
n⁄zîo
,

599 
b8
,

600 
b4
,

601 
ùmode
,

602 
œmbda
,

603 
mo°ProbabÀMode
,

604 
di°blk
 
mö_rdco°
)

606 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

607 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

608 
di°blk
 
rdco°
;

609 
dummy
 = 0, 
øã
;

610 
di°blk
 
di°‹ti⁄
 = 0;

611 
block_x
 = ((
b8
 & 0x01Ë<< 3Ë+ ((
b4
 & 0x01) << 2);

612 
block_y
 = ((
b8
 >> 1Ë<< 3Ë+ ((
b4
 >> 1) << 2);

613 
pic_pix_x
 = 
cuºMB
->
pix_x
 + 
block_x
;

614 
pic_pix_y
 = 
cuºMB
->
pix_y
 + 
block_y
;

615 
pic_›ix_y
 = 
cuºMB
->
›ix_y
 + 
block_y
;

617 
Sy¡axEÀmít
 
£
;

618 c⁄° *
∑πM≠
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
∑πôi⁄_mode
];

619 
D©aP¨tôi⁄
 *
d©aP¨t
;

620 
Cﬁ‹Pœ√
 
k
;

624 *
n⁄zîo
 = 
cuºMB
->
	`ªsiduÆ_å™sf‹m_qu™t_luma_4x4
 (cuºMB, 
PLANE_Y
, 
block_x
, 
block_y
, &
dummy
, 1);

627 
di°‹ti⁄
 +
	`compuã_SSE4x4
(&
p_Vid
->
pCurImg
[
pic_›ix_y
], &p_Vid->
íc_pi˘uª
->
imgY
[
pic_pix_y
], 
pic_pix_x
,Öic_pix_x);

629 if(
p_Vid
->
P444_joöed
)

631 
k
 = 
PLANE_U
; k <
PLANE_V
; k++)

633 
	`£À˘_∂™e
(
p_Vid
, 
k
);

634 
cuºMB
->
c_nzCbCr
[
k
] = cuºMB->
	`ªsiduÆ_å™sf‹m_qu™t_luma_4x4
(cuºMB, k, 
block_x
, 
block_y
, &
dummy
, 1);

635 
di°‹ti⁄
 +
	`compuã_SSE4x4
(&
p_Vid
->
pCurImg
[
pic_›ix_y
], &p_Vid->
íc_pi˘uª
->
p_cuº_img
[
pic_pix_y
], 
pic_pix_x
,Öic_pix_x);

637 
	`£À˘_∂™e
(
p_Vid
, 
PLANE_Y
);

639 
cuºMB
->
ùmode_DPCM
 = 
NO_INTRA_PMODE
;

642 
£
.
vÆue1
 = (
mo°ProbabÀMode
 =
ùmode
) ? -1 : ipmode < mostProbableMode ? ipmode : ipmode - 1;

645 
£
.
c⁄ãxt
 = (
b8
 << 2Ë+ 
b4
;

646 
£
.
ty≥
 = 
SE_INTRAPREDMODE
;

649 
d©aP¨t
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_INTRAPREDMODE
]]);

651 
cuºSli˚
->
	`wrôeI¡øPªdMode
 (&
£
, 
d©aP¨t
);

652 
øã
 = 
£
.
Àn
;

655 i‡(
cuºSli˚
->
symbﬁ_mode
 =
CAVLC
)

657 
øã
 +
cuºSli˚
->
	`wrôeC€ff4x4_CAVLC
 (
cuºMB
, 
LUMA
, 
b8
, 
b4
, 0);

658 if(
p_Vid
->
P444_joöed
)

660 
øã
 +
cuºSli˚
->
	`wrôeC€ff4x4_CAVLC
 (
cuºMB
, 
CB
, 
b8
, 
b4
, 0);

661 
øã
 +
cuºSli˚
->
	`wrôeC€ff4x4_CAVLC
 (
cuºMB
, 
CR
, 
b8
, 
b4
, 0);

666 
øã
 +
	`wrôeC€ff4x4_CABAC
 (
cuºMB
, 
PLANE_Y
, 
b8
, 
b4
, 1);

667 if(
p_Vid
->
P444_joöed
)

669 
øã
 +
	`wrôeC€ff4x4_CABAC
 (
cuºMB
, 
PLANE_U
, 
b8
, 
b4
, 1);

670 
øã
 +
	`wrôeC€ff4x4_CABAC
 (
cuºMB
, 
PLANE_V
, 
b8
, 
b4
, 1);

673 
rdco°
 = 
di°‹ti⁄
 + 
	`weight_co°
(
œmbda
,
øã
);

674 
cuºSli˚
->
	`ª£t_codög_°©e
 (
cuºMB
, cuºSli˚->
p_RDO
->
cs_cm
);

676  
rdco°
;

677 
	}
}

685 
di°blk
 
	$rdco°_f‹_8x8blocks
 (
Ma¸oblock
 *
cuºMB
,

686 
RD_8x8DATA
 *
d©aTr
,

687 * 
˙t_n⁄z
,

688 
öt64
* 
cbp_blk
,

689 
œmbda
,

690 
block
,

691 
mode
,

692 
Info8x8
 *
∑π
,

693 
di°blk
 
mö_rdco°
)

695 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

696 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

697 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

698 
pic_∑ømëî_£t_rb•_t
 *
a˘ive_µs
 = 
p_Vid
->active_pps;

699 
øã
=0;

700 
di°blk
 
di°‹ti⁄
=0;

702 
dummy
 = 0, 
møã
;

703 
li°_mode
[2];

704 
cbp
 = 0;

705 
∑x
 = 8*(
block
 & 0x01);

706 
∑y
 = 8*(
block
 >> 1);

707 
i0
 = 
∑x
 >> 2;

708 
j0
 = 
∑y
 >> 2;

709 
dúe˘
 = (
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
 && 
mode
==0);

710 
b8vÆue
 = 
	`B8Mode2VÆue
 (
cuºSli˚
, (Ë
mode
, 
∑π
->
pdú
);

712 
Sy¡axEÀmít
 
£
;

713 
D©aP¨tôi⁄
 *
d©aP¨t
;

714 c⁄° *
∑πM≠
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
∑πôi⁄_mode
];

716 
EncodögEnvú⁄mítPå
 
ìp_dp
;

718 
pdú
 = 
∑π
->pdir;

719 
l0_ªf
 = 
∑π
->
ªf
[
LIST_0
];

720 
l1_ªf
 = 
∑π
->
ªf
[
LIST_1
];

725 
cuºMB
->
b8x8
[
block
].
bùªd
 = 
∑π
->bipred;

726 
cuºMB
->
¨_mode
 = (Ë((
mode
 !0)? mode: 
P8x8
);

729 i‡(
dúe˘
)

731 
p_dú
 = 
cuºSli˚
->
dúe˘_pdú
[
cuºMB
->
block_y
 + 
j0
][cuºMB->
block_x
 + 
i0
];

732 i‡(
p_dú
 < 0)

733  (
DISTBLK_MAX
);

736 
li°_mode
[2] = {0, 0};

737 *
˙t_n⁄z
 = 
cuºSli˚
->
	`luma_ªsiduÆ_codög_8x8
 (
cuºMB
, &
cbp
, 
cbp_blk
, 
block
, (Ë
p_dú
, 
li°_mode
,

738 
cuºSli˚
->
dúe˘_ªf_idx
[
cuºMB
->
block_y
+
j0
][cuºMB->
block_x
+
i0
]);

743 i‡(
pdú
 =2 && 
a˘ive_µs
->
weighãd_bùªd_idc
 == 1)

746 
weight_sum
 = (
a˘ive_µs
->
weighãd_bùªd_idc
 =1)? 
cuºSli˚
->
wbp_weight
[0][
l0_ªf
][
l1_ªf
][0] + currSlice->wbp_weight[1][l0_ref][l1_ref][0] : 0;

747 i‡(
weight_sum
 < -128 || weight_sum > 127)

749  (
DISTBLK_MAX
);

753 
li°_mode
[0] = (
pdú
==0||pdú==2 ? 
mode
 : 0);

754 
li°_mode
[1] = (
pdú
==1||pdú==2 ? 
mode
 : 0);

755 *
˙t_n⁄z
 = 
cuºSli˚
->
	`luma_ªsiduÆ_codög_8x8
 (
cuºMB
, &
cbp
, 
cbp_blk
, 
block
, 
pdú
, 
li°_mode
, 
∑π
->
ªf
);

758 if(
p_Vid
->
P444_joöed
)

760 *
˙t_n⁄z
 +–
cuºSli˚
->
c€ff_co°_¸
[1] + currSlice->coeff_cost_cr[2] );

764 i‡(
p_I≈
->
rd›t
==3)

767 
di°‹ti⁄
 = 
p_Vid
->
	`e°im©e_di°‹ti⁄
(
cuºMB
, 
block
, 8, 
mode
, 
pdú
, 
mö_rdco°
);

771 
di°‹ti⁄
 +
	`compuã_SSE8x8
(&
p_Vid
->
pCurImg
[
cuºMB
->
›ix_y
 + 
∑y
], &p_Vid->
íc_pi˘uª
->
imgY
[cuºMB->
pix_y
 +Öay], cuºMB->
pix_x
 + 
∑x
, currMB->pix_x +Öax);

774 i‡(
p_Vid
->
P444_joöed
)

776 
di°‹ti⁄
 +
	`compuã_SSE8x8
(&
p_Vid
->
pImgOrg
[1][
cuºMB
->
›ix_y
 + 
∑y
], &p_Vid->
íc_pi˘uª
->
imgUV
[0][cuºMB->
pix_y
 +Öay], cuºMB->
pix_x
 + 
∑x
, currMB->pix_x +Öax);

777 
di°‹ti⁄
 +
	`compuã_SSE8x8
(&
p_Vid
->
pImgOrg
[2][
cuºMB
->
›ix_y
 + 
∑y
], &p_Vid->
íc_pi˘uª
->
imgUV
[1][cuºMB->
pix_y
 +Öay], cuºMB->
pix_x
 + 
∑x
, currMB->pix_x +Öax);

781 i‡(
di°‹ti⁄
 >
mö_rdco°
)

782  (
di°‹ti⁄
);

785 if(
p_Vid
->
P444_joöed
)

787 
cbp
 |
cuºSli˚
->
cmp_cbp
[1];

788 
cbp
 |
cuºSli˚
->
cmp_cbp
[2];

790 
cuºSli˚
->
cmp_cbp
[1] = 
cbp
;

791 
cuºSli˚
->
cmp_cbp
[2] = 
cbp
;

798 i‡(
cuºSli˚
->
symbﬁ_mode
 =
CAVLC
)

800 
	`ue_löfo
 (
b8vÆue
, 
dummy
, &
møã
, &dummy);

801 
øã
 +
møã
;

805 
£
.
vÆue1
 = 
b8vÆue
;

806 
£
.
ty≥
 = 
SE_MBTYPE
;

807 
d©aP¨t
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
£
.
ty≥
]]);

808 
cuºSli˚
->
	`wrôeB8_ty≥Info
(&
£
, 
d©aP¨t
);

809 
øã
 +
£
.
Àn
;

813 i‡(!
dúe˘
)

815 i‡((
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
] > 1 ) && (
pdú
==0 ||Ödir==2))

816 
øã
 +
	`wrôeRe„ªn˚Føme
 (
cuºMB
, 
i0
, 
j0
, 
LIST_0
, 
l0_ªf
);

818 i‡((
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_1
] > 1 && cuºSli˚->
¶i˚_ty≥
 =
B_SLICE
 ) && (
pdú
==1 ||Ödir==2))

820 
øã
 +
	`wrôeRe„ªn˚Føme
 (
cuºMB
, 
i0
, 
j0
, 
LIST_1
, 
l1_ªf
);

823 i‡(
pdú
==0 ||Ödir==2)

825 
øã
 +
	`wrôeMŸi⁄Ve˘‹8x8
 (
cuºMB
, 
i0
, 
j0
, i0 + 2, j0 + 2, 
l0_ªf
, 
LIST_0
, 
mode
, cuºMB->
b8x8
[
block
].
bùªd
);

827 i‡(
pdú
==1 ||Ödir==2)

829 
øã
 +
	`wrôeMŸi⁄Ve˘‹8x8
 (
cuºMB
, 
i0
, 
j0
, i0 + 2, j0 + 2, 
l1_ªf
, 
LIST_1
, 
mode
, cuºMB->
b8x8
[
block
].
bùªd
);

834 i‡(!
cuºSli˚
->
symbﬁ_mode
 =
CAVLC
)

836 
d©aP¨t
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_CBP
]]);

837 
ìp_dp
 = &(
d©aP¨t
->
ì_ˇbac
);

838 
møã
 = 
	`¨õnco_bôs_wrôãn
 (
ìp_dp
);

839 
	`wrôeCBP_BIT_CABAC
 (
cuºMB
, 
block
, ((*
˙t_n⁄z
>0)?1:0), 
d©aTr
->
cbp8x8
, 
ìp_dp
, 
cuºSli˚
->
ãx_˘x
);

840 
møã
 = 
	`¨õnco_bôs_wrôãn
 (
ìp_dp
) - mrate;

841 
øã
 +
møã
;

845 i‡(*
˙t_n⁄z
)

847 
øã
 +
	`wrôeC€ff8x8
 ( 
cuºMB
, 
PLANE_Y
, 
block
, 
mode
, cuºMB->
luma_å™sf‹m_size_8x8_Êag
);

850 if(
p_Vid
->
P444_joöed
)

852 
øã
 +
	`wrôeC€ff8x8
–
cuºMB
, 
PLANE_U
, 
block
, 
mode
, cuºMB->
luma_å™sf‹m_size_8x8_Êag
 );

853 
øã
 +
	`wrôeC€ff8x8
–
cuºMB
, 
PLANE_V
, 
block
, 
mode
, cuºMB->
luma_å™sf‹m_size_8x8_Êag
 );

855  (
di°‹ti⁄
 + 
	`weight_co°
(
œmbda
, 
øã
));

856 
	}
}

865 
	$I16Off£t
 (
cbp
, 
i16mode
)

867  (Ë((
cbp
 & 15 ? 13 : 1Ë+ 
i16mode
 + ((cbp & 0x30) >> 2));

868 
	}
}

877 
	$£t_modes_™d_ªfs_f‹_blocks_i_¶i˚
(
Ma¸oblock
 *
cuºMB
, 
mode
)

879 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

881 
i
,
j
;

882 
Block8x8Info
 *
b8x8öfo
 = 
p_Vid
->b8x8info;

883 
PicMŸi⁄P¨ams
 **
mŸi⁄
 = 
p_Vid
->
íc_pi˘uª
->
mv_öfo
;

886 
cuºMB
->
mb_ty≥
 = 
mode
;

887 
cuºMB
->
¨_mode
 = 
mode
;

889  
i
 = 0; i < 4; i++)

891 
cuºMB
->
b8x8
[
i
] = 
b8x8öfo
->
be°
[
mode
][i];

895 
mode
)

897 
I4MB
:

898 
i
=0;i<4;i++)

900 
cuºMB
->
b8x8
[
i
].
mode
 = 
IBLOCK
;

901 
cuºMB
->
b8x8
[
i
].
pdú
 = -1;

904 
I16MB
:

906 
cuºMB
->
b8x8
[0].
mode
 = 0;

907 
cuºMB
->
b8x8
[1].
mode
 = 0;

908 
cuºMB
->
b8x8
[2].
mode
 = 0;

909 
cuºMB
->
b8x8
[3].
mode
 = 0;

910 
i
=0;i<4;i++)

912 
cuºMB
->
b8x8
[
i
].
pdú
 = -1;

915 
I8MB
:

916 
i
=0;i<4;i++)

918 
cuºMB
->
b8x8
[
i
].
mode
 = 
I8MB
;

919 
cuºMB
->
b8x8
[
i
].
pdú
 = -1;

922 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
TRUE
;

924 
IPCM
:

925 
i
=0;i<4;i++)

927 
cuºMB
->
b8x8
[
i
].
mode
 = 
IPCM
;

928 
cuºMB
->
b8x8
[
i
].
pdú
 = -1;

930 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
FALSE
;

933 
	`¥ötf
 ("Unsupported mode in set_modes_and_refs_for_blocks!\n");

934 
	`exô
 (1);

938 
j
 = 
cuºMB
->
block_y
; j < currMB->block_y + 4; j++)

940 
i
 = 
cuºMB
->
block_x
; i < currMB->block_x + 4;i++)

942 
mŸi⁄
[
j
][
i
].
ªf_pic
 [
LIST_0
] = 
NULL
;

943 
mŸi⁄
[
j
][
i
].
ªf_idx
 [
LIST_0
] = -1;

946 
	}
}

955 
	$£t_modes_™d_ªfs_f‹_blocks_p_¶i˚
(
Ma¸oblock
 *
cuºMB
, 
mode
)

957 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

958 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

960 
i
,
j
,
k
;

962 
Block8x8Info
 *
b8x8öfo
 = 
p_Vid
->b8x8info;

963 
PicMŸi⁄P¨ams
 **
mŸi⁄
 = 
p_Vid
->
íc_pi˘uª
->
mv_öfo
;

966 
cuºMB
->
mb_ty≥
 = 
mode
;

968  
i
 = 0; i < 4; i++)

970 
cuºMB
->
b8x8
[
i
] = 
b8x8öfo
->
be°
[
mode
][i];

973 
cuºMB
->
¨_mode
 = 
mode
;

976 
mode
)

979 
cuºMB
->
b8x8
[0].
mode
 = 0;

980 
cuºMB
->
b8x8
[1].
mode
 = 0;

981 
cuºMB
->
b8x8
[2].
mode
 = 0;

982 
cuºMB
->
b8x8
[3].
mode
 = 0;

983 
cuºMB
->
b8x8
[0].
pdú
 = 0;

984 
cuºMB
->
b8x8
[1].
pdú
 = 0;

985 
cuºMB
->
b8x8
[2].
pdú
 = 0;

986 
cuºMB
->
b8x8
[3].
pdú
 = 0;

991 
i
=0;i<4;i++)

993 
cuºMB
->
b8x8
[
i
].
mode
 = () mode;

996 
P8x8
:

998 
I4MB
:

999 
i
=0;i<4;i++)

1001 
cuºMB
->
b8x8
[
i
].
mode
 = 
IBLOCK
;

1002 
cuºMB
->
b8x8
[
i
].
pdú
 = -1;

1005 
I16MB
:

1007 
cuºMB
->
b8x8
[0].
mode
 = 0;

1008 
cuºMB
->
b8x8
[1].
mode
 = 0;

1009 
cuºMB
->
b8x8
[2].
mode
 = 0;

1010 
cuºMB
->
b8x8
[3].
mode
 = 0;

1011 
i
=0;i<4;i++)

1013 
cuºMB
->
b8x8
[
i
].
pdú
 = -1;

1016 
I8MB
:

1017 
i
=0;i<4;i++)

1019 
cuºMB
->
b8x8
[
i
].
mode
 = 
I8MB
;

1020 
cuºMB
->
b8x8
[
i
].
pdú
 = -1;

1023 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
TRUE
;

1025 
IPCM
:

1026 
i
=0;i<4;i++)

1028 
cuºMB
->
b8x8
[
i
].
mode
 = 
IPCM
;

1029 
cuºMB
->
b8x8
[
i
].
pdú
 = -1;

1031 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
FALSE
;

1034 
	`¥ötf
 ("Unsupported mode in set_modes_and_refs_for_blocks!\n");

1035 
	`exô
 (1);

1039 i‡(
mode
==0 || mode==
I4MB
 || mode==
I16MB
 || mode==
I8MB
 || modê=
IPCM
 || modê=
SI4MB
)

1041 i‡(!
mode
)

1043 
j
 = 
cuºMB
->
block_y
; j < currMB->block_y + 4; j++)

1044 
i
 = 
cuºMB
->
block_x
; i < currMB->block_x + 4; i++)

1045 
mŸi⁄
[
j
][
i
].
ªf_idx
[
LIST_0
] = 0;

1049 
j
 = 
cuºMB
->
block_y
; j < currMB->block_y + 4; j++)

1050 
i
 = 
cuºMB
->
block_x
; i < currMB->block_x + 4; i++)

1051 
mŸi⁄
[
j
][
i
].
ªf_idx
[
LIST_0
] = -1;

1056 i‡(
mode
 == 1)

1058 
cuºef
 = 
b8x8öfo
->
be°
[
mode
][0].
pdú
 =0 ? b8x8öfo->be°[mode][0].
ªf
[
LIST_0
] : -1;

1059 
j
 = 
cuºMB
->
block_y
; j < currMB->block_y + 4; j++)

1061 
i
 = 
cuºMB
->
block_x
; i < currMB->block_x + 4;i++)

1063 
mŸi⁄
[
j
][
i
].
ªf_pic
 [
LIST_0
] = 
cuºSli˚
->
li°X
[LIST_0 + 
cuºMB
->
li°_off£t
][
cuºef
];

1064 
mŸi⁄
[
j
][
i
].
ªf_idx
 [
LIST_0
] = (Ë
cuºef
;

1068 i‡(
mode
 == 2)

1070 
cuºef
 = 
b8x8öfo
->
be°
[
mode
][0].
pdú
 =0 ? b8x8öfo->be°[mode][0].
ªf
[
LIST_0
] : -1;

1071 
j
 = 
cuºMB
->
block_y
; j < currMB->block_y + 2; j++)

1073 
i
 = 
cuºMB
->
block_x
; i < currMB->block_x + 4;i++)

1075 
mŸi⁄
[
j
][
i
].
ªf_pic
 [
LIST_0
] = 
cuºSli˚
->
li°X
[LIST_0 + 
cuºMB
->
li°_off£t
][
cuºef
];

1076 
mŸi⁄
[
j
][
i
].
ªf_idx
 [
LIST_0
] = (Ë
cuºef
;

1079 
cuºef
 = 
b8x8öfo
->
be°
[
mode
][2].
pdú
 =0 ? b8x8öfo->be°[mode][2].
ªf
[
LIST_0
] : -1;

1080 
j
 = 
cuºMB
->
block_y
 + 2; j < currMB->block_y + 4; j++)

1082 
i
 = 
cuºMB
->
block_x
; i < currMB->block_x + 4;i++)

1084 
mŸi⁄
[
j
][
i
].
ªf_pic
 [
LIST_0
] = 
cuºSli˚
->
li°X
[LIST_0 + 
cuºMB
->
li°_off£t
][
cuºef
];

1085 
mŸi⁄
[
j
][
i
].
ªf_idx
 [
LIST_0
] = (Ë
cuºef
;

1089 i‡(
mode
 == 3)

1091 
cuºef
 = (
b8x8öfo
->
be°
[
mode
][0].
pdú
 =0Ë? b8x8öfo->be°[mode][0].
ªf
[
LIST_0
] : -1;

1092 
j
 = 
cuºMB
->
block_y
; j < currMB->block_y + 4; j++)

1094 
i
 = 
cuºMB
->
block_x
; i < currMB->block_x + 2;i++)

1096 
mŸi⁄
[
j
][
i
].
ªf_pic
 [
LIST_0
] = 
cuºSli˚
->
li°X
[LIST_0 + 
cuºMB
->
li°_off£t
][
cuºef
];

1097 
mŸi⁄
[
j
][
i
].
ªf_idx
 [
LIST_0
] = (Ë
cuºef
;

1100 
cuºef
 = (
b8x8öfo
->
be°
[
mode
][1].
pdú
 =0Ë? b8x8öfo->be°[mode][1].
ªf
[
LIST_0
] : -1;

1101 
j
 = 
cuºMB
->
block_y
; j < currMB->block_y + 4; j++)

1103 
i
 = 
cuºMB
->
block_x
 + 2; i < currMB->block_x + 4;i++)

1105 
mŸi⁄
[
j
][
i
].
ªf_pic
 [
LIST_0
] = 
cuºSli˚
->
li°X
[LIST_0 + 
cuºMB
->
li°_off£t
][
cuºef
];

1106 
mŸi⁄
[
j
][
i
].
ªf_idx
 [
LIST_0
] = (Ë
cuºef
;

1112 
block_x
, 
block_y
;

1113 
cuºef
;

1114 
j
 = 0; j < 4; j++)

1116 
block_x
 = 
cuºMB
->block_x;

1117 
block_y
 = 
cuºMB
->block_y + 
j
;

1118 
k
 = 2*(
j
 >> 1);

1119 
cuºef
 = 
b8x8öfo
->
be°
[
mode
][
k
++].
ªf
[
LIST_0
];

1120 
mŸi⁄
[
block_y
][
block_x
].
ªf_pic
 [
LIST_0
] = 
cuºSli˚
->
li°X
[LIST_0 + 
cuºMB
->
li°_off£t
][
cuºef
];

1121 
mŸi⁄
[
block_y
][
block_x
++].
ªf_idx
[
LIST_0
] = (Ë
cuºef
;

1122 
mŸi⁄
[
block_y
][
block_x
].
ªf_pic
 [
LIST_0
] = 
cuºSli˚
->
li°X
[LIST_0 + 
cuºMB
->
li°_off£t
][
cuºef
];

1123 
mŸi⁄
[
block_y
][
block_x
++].
ªf_idx
[
LIST_0
] = (Ë
cuºef
;

1124 
cuºef
 = 
b8x8öfo
->
be°
[
mode
][
k
].
ªf
[
LIST_0
];

1125 
mŸi⁄
[
block_y
][
block_x
].
ªf_pic
 [
LIST_0
] = 
cuºSli˚
->
li°X
[LIST_0 + 
cuºMB
->
li°_off£t
][
cuºef
];

1126 
mŸi⁄
[
block_y
][
block_x
++].
ªf_idx
[
LIST_0
] = (Ë
cuºef
;

1127 
mŸi⁄
[
block_y
][
block_x
].
ªf_pic
 [
LIST_0
] = 
cuºSli˚
->
li°X
[LIST_0 + 
cuºMB
->
li°_off£t
][
cuºef
];

1128 
mŸi⁄
[
block_y
][
block_x
].
ªf_idx
[
LIST_0
] = (Ë
cuºef
;

1132 
	}
}

1141 
	$£t_modes_™d_ªfs_f‹_blocks_b_¶i˚
(
Ma¸oblock
 *
cuºMB
, 
mode
)

1143 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1144 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1146 
i
,
j
,
k
;

1147 
block_x
, 
block_y
, 
block8x8
, 
block4x4
;

1148 
cur_ªf
;

1149 
˛i°
;

1150 
cuºef
, 
be°ªf
;

1151 
Block8x8Info
 *
b8x8öfo
 = 
p_Vid
->b8x8info;

1152 
PicMŸi⁄P¨ams
 **
mŸi⁄
 = 
p_Vid
->
íc_pi˘uª
->
mv_öfo
;

1155 
cuºMB
->
mb_ty≥
 = 
mode
;

1156 
cuºMB
->
¨_mode
 = 
mode
;

1158  
i
 = 0; i < 4; i++)

1160 
cuºMB
->
b8x8
[
i
] = 
b8x8öfo
->
be°
[
mode
][i];

1164 
mode
)

1167 
cuºMB
->
b8x8
[0].
mode
 = 0;

1168 
cuºMB
->
b8x8
[1].
mode
 = 0;

1169 
cuºMB
->
b8x8
[2].
mode
 = 0;

1170 
cuºMB
->
b8x8
[3].
mode
 = 0;

1172 
cuºMB
->
b8x8
[0].
pdú
 = 
cuºSli˚
->
dúe˘_pdú
[cuºMB->
block_y
 ][cuºMB->
block_x
 ];

1173 
cuºMB
->
b8x8
[1].
pdú
 = 
cuºSli˚
->
dúe˘_pdú
[cuºMB->
block_y
 ][cuºMB->
block_x
 + 2];

1174 
cuºMB
->
b8x8
[2].
pdú
 = 
cuºSli˚
->
dúe˘_pdú
[cuºMB->
block_y
 + 2][cuºMB->
block_x
 ];

1175 
cuºMB
->
b8x8
[3].
pdú
 = 
cuºSli˚
->
dúe˘_pdú
[cuºMB->
block_y
 + 2][cuºMB->
block_x
 + 2];

1180 
i
=0;i<4;i++)

1182 
cuºMB
->
b8x8
[
i
].
mode
 = () mode;

1185 
P8x8
:

1187 
I4MB
:

1188 
i
=0;i<4;i++)

1190 
cuºMB
->
b8x8
[
i
].
mode
 = 
IBLOCK
;

1191 
cuºMB
->
b8x8
[
i
].
pdú
 = -1;

1194 
I16MB
:

1195 
i
=0;i<4;i++)

1197 
cuºMB
->
b8x8
[
i
].
mode
 = 0;

1198 
cuºMB
->
b8x8
[
i
].
pdú
 = -1;

1201 
I8MB
:

1202 
i
=0;i<4;i++)

1204 
cuºMB
->
b8x8
[
i
].
mode
 = 
I8MB
;

1205 
cuºMB
->
b8x8
[
i
].
pdú
 = -1;

1208 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
TRUE
;

1210 
IPCM
:

1211 
i
=0;i<4;i++)

1213 
cuºMB
->
b8x8
[
i
].
mode
 = 
IPCM
;

1214 
cuºMB
->
b8x8
[
i
].
pdú
 = -1;

1216 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
FALSE
;

1219 
	`¥ötf
 ("Unsupported mode in set_modes_and_refs_for_blocks!\n");

1220 
	`exô
 (1);

1223 
	#IS_FW
 ((
b8x8öfo
->
be°
[
mode
][
k
].
pdú
==0 || b8x8öfo->be°[mode][k].pdú==2Ë&& (mode!=
P8x8
 || b8x8öfo->be°[mode][k].mode!=0))

	)

1224 
	#IS_BW
 ((
b8x8öfo
->
be°
[
mode
][
k
].
pdú
==1 || b8x8öfo->be°[mode][k].pdú==2Ë&& (mode!=
P8x8
 || b8x8öfo->be°[mode][k].mode!=0))

	)

1227 i‡(
mode
 == 0)

1229 
˛i°
 = 
LIST_0
; cli° <
LIST_1
; clist++)

1231 
j
 = 
cuºMB
->
block_y
; j < currMB->block_y + 4; j++)

1233 
i
 = 
cuºMB
->
block_x
; i < currMB->block_x + 4; i++)

1234 
mŸi⁄
[
j
][
i
].
ªf_idx
[
˛i°
] = 
cuºSli˚
->
dúe˘_ªf_idx
[j][i][clist];

1238 i‡(
mode
==
I4MB
 || mode==
I16MB
 || mode==
I8MB
 || modê=
IPCM
)

1240 
˛i°
 = 
LIST_0
; cli° <
LIST_1
; clist++)

1242 
j
 = 
cuºMB
->
block_y
; j < currMB->block_y + 4; j++)

1244 
i
 = 
cuºMB
->
block_x
; i < currMB->block_x + 4; i++)

1245 
mŸi⁄
[
j
][
i
].
ªf_idx
[
˛i°
] = -1;

1249 i‡(
mode
 == 1 || mode == 2 || mode == 3)

1251 
block8x8
 = 0; block8x8 < 4; block8x8++)

1253 
˛i°
 = 
LIST_0
; cli° <
LIST_1
; clist++)

1255 
be°ªf
 = 
b8x8öfo
->
be°
[
mode
][
block8x8
].
ªf
[
˛i°
];

1257 i‡–
b8x8öfo
->
be°
[
mode
][
block8x8
].
pdú
 == 2)

1259 
cuºef
 = (
b8x8öfo
->
be°
[
mode
][
block8x8
].
bùªd
Ë? 0 : 
be°ªf
;

1263 
cuºef
 = (
˛i°
 =
b8x8öfo
->
be°
[
mode
][
block8x8
].
pdú
Ë? 
be°ªf
 : -1;

1266 
block4x4
 = 0; block4x4 < 4; block4x4++)

1268 
block_x
 = 
cuºMB
->block_x + 2 * (
block8x8
 & 0x01Ë+ (
block4x4
 & 0x01);

1269 
block_y
 = 
cuºMB
->block_y + 2 * (
block8x8
 >> 1Ë+ (
block4x4
 >> 1);

1270 
mŸi⁄
[
block_y
][
block_x
].
ªf_idx
[
˛i°
] = 
cuºef
;

1277 
j
 = 0; j < 4; j++)

1279 
block_y
 = 
cuºMB
->block_y + 
j
;

1280 
i
 = 0; i < 4; i++)

1282 
block_x
 = 
cuºMB
->block_x + 
i
;

1283 
k
 = 2*(
j
 >> 1Ë+ (
i
 >> 1);

1285 if(
b8x8öfo
->
be°
[
mode
][
k
].mode==0)

1287 
mŸi⁄
[
block_y
][
block_x
].
ªf_idx
[
LIST_0
] = 
cuºSli˚
->
dúe˘_ªf_idx
[block_y][block_x][LIST_0];

1288 
mŸi⁄
[
block_y
][
block_x
].
ªf_idx
[
LIST_1
] = 
cuºSli˚
->
dúe˘_ªf_idx
[block_y][block_x][LIST_1];

1292 
mŸi⁄
[
block_y
][
block_x
].
ªf_idx
[
LIST_0
] = (
IS_FW
 ? 
b8x8öfo
->
be°
[
mode
][
k
].
ªf
[LIST_0] : -1);

1293 
mŸi⁄
[
block_y
][
block_x
].
ªf_idx
[
LIST_1
] = (
IS_BW
 ? 
b8x8öfo
->
be°
[
mode
][
k
].
ªf
[LIST_1] : -1);

1299 
˛i°
 = 
LIST_0
; cli° <
LIST_1
; clist++)

1301 
St‹abÀPi˘uª
 **
ªf_pic
 = 
cuºSli˚
->
li°X
[
˛i°
 + 
cuºMB
->
li°_off£t
];

1302 
j
 = 
cuºMB
->
block_y
; j < currMB->block_y + 4; j++)

1304 
i
 = 
cuºMB
->
block_x
; i < currMB->block_x + 4;i++)

1306 
cur_ªf
 = (Ë
mŸi⁄
[
j
][
i
].
ªf_idx
[
˛i°
];

1307 
mŸi⁄
[
j
][
i
].
ªf_pic
 [
˛i°
] = (
cur_ªf
 < 0 ? 
NULL
 :Ñef_pic[cur_ref]);

1312 #unde‡
IS_FW


1313 #unde‡
IS_BW


1314 
	}
}

1323 
	$£t_c€ff_™d_ªc⁄_8x8_p_¶i˚
 (
Ma¸oblock
* 
cuºMB
)

1325 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1326 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

1327 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1328 
RDOPTSåu˘uª
 *
p_RDO
 = 
cuºSli˚
->p_RDO;

1330 
PicMŸi⁄P¨ams
 **
mŸi⁄
 = 
p_Vid
->
íc_pi˘uª
->
mv_öfo
;

1331 
block
, 
k
, 
j
, 
i
, 
uv
;

1332 
cur_ªf
;

1336 i‡(
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 && (cuºMB->
vÆid_8x8
))

1339 
	`mem˝y
(
cuºMB
->
b8x8
, 
p_RDO
->
å8x8
->
∑π
, 4 * (
Info8x8
));

1341 
j
 = 0; j < 4; j++)

1343 
i
 = 0; i < 4; i++)

1345 
k
 = 2*(
j
 >> 1)+(
i
 >> 1);

1346 
mŸi⁄
[
cuºMB
->
block_y
+
j
][cuºMB->
block_x
+
i
].
ªf_idx
[
LIST_0
] = 
p_RDO
->
å8x8
->
∑π
[
k
].
ªf
[LIST_0];

1350 
j
 = 
cuºMB
->
block_y
;j<cuºMB->block_y + 
BLOCK_MULTIPLE
;j++)

1352 
i
 = 
cuºMB
->
block_x
;i<cuºMB->block_x + 
BLOCK_MULTIPLE
;i++)

1354 
cur_ªf
 = (Ë
mŸi⁄
[
j
][
i
].
ªf_idx
[
LIST_0
];

1355 
mŸi⁄
[
j
][
i
].
ªf_pic
[
LIST_0
] =(
cur_ªf
 >0 ? 
cuºSli˚
->
li°X
[LIST_0 + 
cuºMB
->
li°_off£t
][cur_ªf] : 
NULL
);

1362 
	`St‹eMV8x8
(
cuºSli˚
, 1);

1364 
	`Re°‹eMV8x8
(
cuºSli˚
, 0);

1369 
block
 = 0; block<4; block++)

1371 
	`mem˝y
 (
cuºSli˚
->
cofAC
[
block
][0][0],
p_RDO
->
cofAC8x8ts
[block][0][0][0], 4 * 2 * 65 * ());

1374 i‡(
p_Vid
->
P444_joöed
)

1376 
uv
=0; uv<2; uv++)

1378 
block
 = 0; block<4; block++)

1380 
	`mem˝y
 (
cuºSli˚
->
cofAC
[4+
block
+
uv
*4][0][0],
p_RDO
->
cofAC8x8ts
[block][uv + 1][0][0], 4 * 2 * 65 * ());

1386 i‡(
p_RDO
->
å8x8
->
˙t_n⁄z_8x8
 <
_LUMA_8x8_COEFF_COST_
 &&

1387 ((
cuºMB
->
qp_sˇÀd
[0])!=0 || 
p_Vid
->
a˘ive_•s
->
los¶ess_qµrime_Êag
==0) &&

1388 (
cuºSli˚
->
¶i˚_ty≥
 !
SP_SLICE
))

1390 
cuºMB
->
cbp
 = 0;

1391 
cuºMB
->
cbp_blk
 = 0;

1393 
	`c›y_image_d©a_16x16
(&
p_Vid
->
íc_pi˘uª
->
imgY
[
cuºMB
->
pix_y
], 
p_RDO
->
å8x8
->
m¥8x8
, cuºMB->
pix_x
, 0);

1395 if(
p_I≈
->
rd›t
 == 3)

1397 
p_Vid
->
p_decs
->
ªc_ty≥
 = 0;

1400 if(
cuºSli˚
->
¶i˚_ty≥
 =
SP_SLICE
 && !
p_Vid
->
•2_‰ame_ödiˇt‹
)

1402 
j
 = 0; j < 
MB_BLOCK_SIZE
; j++)

1404 
	`mem˝y
(&
p_Vid
->
Ãec
[
cuºMB
->
pix_y
+
j
][cuºMB->
pix_x
],
p_RDO
->
å8x8
->Ãec[j], 
MB_BLOCK_SIZE
 * ());

1410 if(
p_Vid
->
P444_joöed
)

1412 
cuºSli˚
->
cmp_cbp
[1] = currSlice->cmp_cbp[2] = 0;

1413 
	`c›y_image_d©a_16x16
(&
p_Vid
->
íc_pi˘uª
->
imgUV
[0][
cuºMB
->
pix_y
], 
p_RDO
->
å8x8
->
m¥8x8CbCr
[0], cuºMB->
pix_x
, 0);

1414 
	`c›y_image_d©a_16x16
(&
p_Vid
->
íc_pi˘uª
->
imgUV
[1][
cuºMB
->
pix_y
], 
p_RDO
->
å8x8
->
m¥8x8CbCr
[1], cuºMB->
pix_x
, 0);

1416 
uv
=0; uv<2; uv++)

1418 
block
 = 0; block<4; block++)

1420 
	`mem£t
–
cuºSli˚
->
cofAC
[4+
block
+
uv
*4][0][0], 0, 4 * 2 * 65 * ());

1427 
cuºMB
->
cbp
 = 
p_RDO
->
å8x8
->
cbp8x8
;

1428 
cuºMB
->
cbp_blk
 = 
p_RDO
->
å8x8
->
cbp_blk8x8
;

1430 
	`c›y_image_d©a_16x16
(&
p_Vid
->
íc_pi˘uª
->
imgY
[
cuºMB
->
pix_y
], 
p_RDO
->
å8x8
->
ªc_mbY8x8
, cuºMB->
pix_x
, 0);

1432 i‡(
p_I≈
->
rd›t
 == 3)

1434 
p_Vid
->
p_decs
->
ªc_ty≥
 = 1;

1437 if(
cuºSli˚
->
¶i˚_ty≥
 =
SP_SLICE
 && !
p_Vid
->
•2_‰ame_ödiˇt‹
)

1439 
j
 = 0; j < 
MB_BLOCK_SIZE
; j++)

1441 
	`mem˝y
 (&
p_Vid
->
Ãec
[
cuºMB
->
pix_y
+
j
][cuºMB->
pix_x
],
p_RDO
->
å8x8
->Ãec[j], 
MB_BLOCK_SIZE
 * ());

1445 i‡(
p_Vid
->
P444_joöed
)

1447 
cuºSli˚
->
cmp_cbp
[1] = cuºSli˚->cmp_cbp[2] = 
p_RDO
->
å8x8
->
cbp8x8
;

1448 
	`c›y_image_d©a_16x16
(&
p_Vid
->
íc_pi˘uª
->
imgUV
[0][
cuºMB
->
pix_y
], 
p_RDO
->
å8x8
->
ªc_mb8x8_¸
[0], cuºMB->
pix_x
, 0);

1449 
	`c›y_image_d©a_16x16
(&
p_Vid
->
íc_pi˘uª
->
imgUV
[1][
cuºMB
->
pix_y
], 
p_RDO
->
å8x8
->
ªc_mb8x8_¸
[1], cuºMB->
pix_x
, 0);

1452 i‡(
p_I≈
->
rd›t
 == 3)

1454 
	`îrdo_gë_be°_P8x8
(
cuºMB
, 1);

1462 
block
 = 0; block < 4; block ++)

1464 
	`mem˝y
 (
cuºSli˚
->
cofAC
[
block
][0][0],
p_RDO
->
c€fAC8x8
[block][0][0][0], 4 * 2 * 65 * ());

1467 i‡(
cuºSli˚
->
P444_joöed
)

1469 
block
 = 0; block<4; block++)

1471 
	`mem˝y
 (
cuºSli˚
->
cofAC
[
block
+4][0][0],
p_RDO
->
c€fAC8x8
[block][1][0][0], 4 * 2 * 65 * ());

1472 
	`mem˝y
 (
cuºSli˚
->
cofAC
[
block
+8][0][0],
p_RDO
->
c€fAC8x8
[block][2][0][0], 4 * 2 * 65 * ());

1476 i‡(((
p_I≈
->
di°hªs
 && 
p_RDO
->
å4x4
->
˙t_n⁄z_8x8
 <0Ë|| (p_RDO->å4x4->˙t_n⁄z_8x8 <5)Ë&& 
cuºSli˚
->
¶i˚_ty≥
 !
SP_SLICE
 &&

1477 ((
cuºMB
->
qp_sˇÀd
[0])!=0 || 
p_Vid
->
a˘ive_•s
->
los¶ess_qµrime_Êag
==0))

1479 
cuºMB
->
cbp
 = 0;

1480 
cuºMB
->
cbp_blk
 = 0;

1482 
	`c›y_image_d©a_16x16
(&
p_Vid
->
íc_pi˘uª
->
imgY
[
cuºMB
->
pix_y
], 
p_RDO
->
å4x4
->
m¥8x8
, cuºMB->
pix_x
, 0);

1484 if(
p_I≈
->
rd›t
 == 3)

1486 
p_Vid
->
p_decs
->
ªc_ty≥
 = 0;

1489 if(
cuºSli˚
->
¶i˚_ty≥
 =
SP_SLICE
 && !
p_Vid
->
•2_‰ame_ödiˇt‹
)

1491 
j
 = 0; j < 
MB_BLOCK_SIZE
; j++)

1493 
	`mem˝y
 (&
p_Vid
->
Ãec
[
cuºMB
->
pix_y
+
j
][cuºMB->
pix_x
],
p_RDO
->
å4x4
->Ãec[j], 
MB_BLOCK_SIZE
 * ());

1499 i‡(
cuºSli˚
->
P444_joöed
)

1501 
cuºSli˚
->
cmp_cbp
[1] = currSlice->cmp_cbp[2] = 0;

1503 
	`c›y_image_d©a_16x16
(&
p_Vid
->
íc_pi˘uª
->
imgUV
[0][
cuºMB
->
pix_y
], 
p_RDO
->
å4x4
->
m¥8x8CbCr
[0], cuºMB->
pix_x
, 0);

1504 
	`c›y_image_d©a_16x16
(&
p_Vid
->
íc_pi˘uª
->
imgUV
[1][
cuºMB
->
pix_y
], 
p_RDO
->
å4x4
->
m¥8x8CbCr
[1], cuºMB->
pix_x
, 0);

1506 
uv
=0; uv<2; uv++)

1508 
block
 = 0; block<4; block++)

1510 
	`mem£t
–
cuºSli˚
->
cofAC
[4+
block
+
uv
*4][0][0], 0, 4 * 2 * 65 * ());

1517 
cuºMB
->
cbp
 = 
p_RDO
->
å4x4
->
cbp8x8
;

1518 
cuºMB
->
cbp_blk
 = 
p_RDO
->
å4x4
->
cbp_blk8x8
;

1520 
	`c›y_image_d©a_16x16
(&
p_Vid
->
íc_pi˘uª
->
imgY
[
cuºMB
->
pix_y
], 
p_RDO
->
å4x4
->
ªc_mbY8x8
, cuºMB->
pix_x
, 0);

1522 if(
p_I≈
->
rd›t
 == 3)

1524 
p_Vid
->
p_decs
->
ªc_ty≥
 = 1;

1527 if(
cuºSli˚
->
¶i˚_ty≥
 =
SP_SLICE
 && !
p_Vid
->
•2_‰ame_ödiˇt‹
)

1529 
j
 = 0; j < 
MB_BLOCK_SIZE
; j++)

1531 
	`mem˝y
 (&
p_Vid
->
Ãec
[
cuºMB
->
pix_y
+
j
][cuºMB->
pix_x
],
p_RDO
->
å4x4
->Ãec[j], 
MB_BLOCK_SIZE
 * ());

1534 i‡(
cuºSli˚
->
P444_joöed
)

1536 
cuºSli˚
->
cmp_cbp
[1] = cuºSli˚->cmp_cbp[2] = 
p_RDO
->
å4x4
->
cbp8x8
;

1537 
	`c›y_image_d©a_16x16
(&
p_Vid
->
íc_pi˘uª
->
imgUV
[0][
cuºMB
->
pix_y
], 
p_RDO
->
å4x4
->
ªc_mb8x8_¸
[0], cuºMB->
pix_x
, 0);

1538 
	`c›y_image_d©a_16x16
(&
p_Vid
->
íc_pi˘uª
->
imgUV
[1][
cuºMB
->
pix_y
], 
p_RDO
->
å4x4
->
ªc_mb8x8_¸
[1], cuºMB->
pix_x
, 0);

1541 i‡(
p_I≈
->
rd›t
 == 3)

1543 
	`îrdo_gë_be°_P8x8
(
cuºMB
, 0);

1546 
	}
}

1555 
	$£t_c€ff_™d_ªc⁄_8x8_b_¶i˚
 (
Ma¸oblock
* 
cuºMB
)

1557 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1558 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

1559 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1560 
RDOPTSåu˘uª
 *
p_RDO
 = 
cuºSli˚
->p_RDO;

1562 
PicMŸi⁄P¨ams
 **
mŸi⁄
 = 
p_Vid
->
íc_pi˘uª
->
mv_öfo
;

1563 
block
, 
k
, 
j
, 
i
, 
uv
;

1564 
cur_ªf
;

1568 i‡(
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 && (cuºMB->
vÆid_8x8
))

1571 
	`mem˝y
(
cuºMB
->
b8x8
, 
p_RDO
->
å8x8
->
∑π
, 4 * (
Info8x8
));

1573 
j
 = 0;j<4;j++)

1575 
i
 = 0;i<4;i++)

1577 
k
 = 2*(
j
 >> 1)+(
i
 >> 1);

1578 
mŸi⁄
[
cuºMB
->
block_y
+
j
][cuºMB->
block_x
+
i
].
ªf_idx
[
LIST_0
] = ((cuºMB->
b8x8
[
k
].
pdú
 & 0x01Ë=0Ë? 
p_RDO
->
å8x8
->
∑π
[k].
ªf
[LIST_0] : - 1;

1579 
mŸi⁄
[
cuºMB
->
block_y
+
j
][cuºMB->
block_x
+
i
].
ªf_idx
[
LIST_1
] = (cuºMB->
b8x8
[
k
].
pdú
 > 0Ë? 
p_RDO
->
å8x8
->
∑π
[k].
ªf
[LIST_1] : - 1;

1583 
j
 = 
cuºMB
->
block_y
;j<cuºMB->block_y + 
BLOCK_MULTIPLE
;j++)

1585 
i
 = 
cuºMB
->
block_x
;i<cuºMB->block_x + 
BLOCK_MULTIPLE
;i++)

1587 
cur_ªf
 = (Ë
mŸi⁄
[
j
][
i
].
ªf_idx
[
LIST_0
];

1588 
mŸi⁄
[
j
][
i
].
ªf_pic
[
LIST_0
] =(
cur_ªf
 >0 ? 
cuºSli˚
->
li°X
[LIST_0 + 
cuºMB
->
li°_off£t
][cur_ªf] : 
NULL
);

1592 
j
 = 
cuºMB
->
block_y
;j<cuºMB->block_y + 
BLOCK_MULTIPLE
;j++)

1594 
i
 = 
cuºMB
->
block_x
;i<cuºMB->block_x + 
BLOCK_MULTIPLE
;i++)

1596 
cur_ªf
 = (Ë
mŸi⁄
[
j
][
i
].
ªf_idx
[
LIST_1
];

1597 
mŸi⁄
[
j
][
i
].
ªf_pic
[
LIST_1
] =(
cur_ªf
 >0 ? 
cuºSli˚
->
li°X
[LIST_1 + 
cuºMB
->
li°_off£t
][cur_ªf] : 
NULL
);

1603 
	`St‹eMV8x8
(
cuºSli˚
, 1);

1605 
	`Re°‹eMV8x8
(
cuºSli˚
, 0);

1610 
block
 = 0; block<4; block++)

1612 
	`mem˝y
 (
cuºSli˚
->
cofAC
[
block
][0][0],
p_RDO
->
cofAC8x8ts
[block][0][0][0], 4 * 2 * 65 * ());

1615 i‡(
p_Vid
->
P444_joöed
)

1617 
uv
=0; uv<2; uv++)

1619 
block
 = 0; block<4; block++)

1621 
	`mem˝y
 (
cuºSli˚
->
cofAC
[4+
block
+
uv
*4][0][0],
p_RDO
->
cofAC8x8ts
[block][uv + 1][0][0], 4 * 2 * 65 * ());

1627 i‡(
p_RDO
->
å8x8
->
˙t_n⁄z_8x8
 <
_LUMA_8x8_COEFF_COST_
 &&

1628 ((
cuºMB
->
qp_sˇÀd
[0])!=0 || 
p_Vid
->
a˘ive_•s
->
los¶ess_qµrime_Êag
==0))

1630 
cuºMB
->
cbp
 = 0;

1631 
cuºMB
->
cbp_blk
 = 0;

1633 
	`c›y_image_d©a_16x16
(&
p_Vid
->
íc_pi˘uª
->
imgY
[
cuºMB
->
pix_y
], 
p_RDO
->
å8x8
->
m¥8x8
, cuºMB->
pix_x
, 0);

1635 if(
p_I≈
->
rd›t
 == 3)

1637 
p_Vid
->
p_decs
->
ªc_ty≥
 = 0;

1643 if(
p_Vid
->
P444_joöed
)

1645 
cuºSli˚
->
cmp_cbp
[1] = currSlice->cmp_cbp[2] = 0;

1646 
	`c›y_image_d©a_16x16
(&
p_Vid
->
íc_pi˘uª
->
imgUV
[0][
cuºMB
->
pix_y
], 
p_RDO
->
å8x8
->
m¥8x8CbCr
[0], cuºMB->
pix_x
, 0);

1647 
	`c›y_image_d©a_16x16
(&
p_Vid
->
íc_pi˘uª
->
imgUV
[1][
cuºMB
->
pix_y
], 
p_RDO
->
å8x8
->
m¥8x8CbCr
[1], cuºMB->
pix_x
, 0);

1649 
uv
=0; uv<2; uv++)

1651 
block
 = 0; block<4; block++)

1653 
	`mem£t
–
cuºSli˚
->
cofAC
[4+
block
+
uv
*4][0][0], 0, 4 * 2 * 65 * ());

1660 
cuºMB
->
cbp
 = 
p_RDO
->
å8x8
->
cbp8x8
;

1661 
cuºMB
->
cbp_blk
 = 
p_RDO
->
å8x8
->
cbp_blk8x8
;

1663 
	`c›y_image_d©a_16x16
(&
p_Vid
->
íc_pi˘uª
->
imgY
[
cuºMB
->
pix_y
], 
p_RDO
->
å8x8
->
ªc_mbY8x8
, cuºMB->
pix_x
, 0);

1665 if(
p_I≈
->
rd›t
 == 3)

1667 
p_Vid
->
p_decs
->
ªc_ty≥
 = 1;

1671 i‡(
p_Vid
->
P444_joöed
)

1673 
cuºSli˚
->
cmp_cbp
[1] = cuºSli˚->cmp_cbp[2] = 
p_RDO
->
å8x8
->
cbp8x8
;

1674 
	`c›y_image_d©a_16x16
(&
p_Vid
->
íc_pi˘uª
->
imgUV
[0][
cuºMB
->
pix_y
], 
p_RDO
->
å8x8
->
ªc_mb8x8_¸
[0], cuºMB->
pix_x
, 0);

1675 
	`c›y_image_d©a_16x16
(&
p_Vid
->
íc_pi˘uª
->
imgUV
[1][
cuºMB
->
pix_y
], 
p_RDO
->
å8x8
->
ªc_mb8x8_¸
[1], cuºMB->
pix_x
, 0);

1678 i‡(
p_I≈
->
rd›t
 == 3)

1680 
	`îrdo_gë_be°_P8x8
(
cuºMB
, 1);

1685 i‡(
cuºMB
->
vÆid_8x8
)

1687 
	`St‹eMV8x8
(
cuºSli˚
, 1);

1693 
block
 = 0; block < 4; block ++)

1695 
	`mem˝y
 (
cuºSli˚
->
cofAC
[
block
][0][0],
p_RDO
->
c€fAC8x8
[block][0][0][0], 4 * 2 * 65 * ());

1698 i‡(
cuºSli˚
->
P444_joöed
)

1700 
block
 = 0; block<4; block++)

1702 
	`mem˝y
 (
cuºSli˚
->
cofAC
[
block
+4][0][0],
p_RDO
->
c€fAC8x8
[block][1][0][0], 4 * 2 * 65 * ());

1703 
	`mem˝y
 (
cuºSli˚
->
cofAC
[
block
+8][0][0],
p_RDO
->
c€fAC8x8
[block][2][0][0], 4 * 2 * 65 * ());

1707 i‡(((
p_I≈
->
di°hªs
 && 
p_RDO
->
å4x4
->
˙t_n⁄z_8x8
 <= 0) || (p_RDO->tr4x4->cnt_nonz_8x8 <= 5)) &&

1708 ((
cuºMB
->
qp_sˇÀd
[0])!=0 || 
p_Vid
->
a˘ive_•s
->
los¶ess_qµrime_Êag
==0))

1710 
cuºMB
->
cbp
 = 0;

1711 
cuºMB
->
cbp_blk
 = 0;

1713 
	`c›y_image_d©a_16x16
(&
p_Vid
->
íc_pi˘uª
->
imgY
[
cuºMB
->
pix_y
], 
p_RDO
->
å4x4
->
m¥8x8
, cuºMB->
pix_x
, 0);

1715 if(
p_I≈
->
rd›t
 == 3)

1717 
p_Vid
->
p_decs
->
ªc_ty≥
 = 0;

1720 i‡(
cuºSli˚
->
P444_joöed
)

1722 
cuºSli˚
->
cmp_cbp
[1] = currSlice->cmp_cbp[2] = 0;

1724 
	`c›y_image_d©a_16x16
(&
p_Vid
->
íc_pi˘uª
->
imgUV
[0][
cuºMB
->
pix_y
], 
p_RDO
->
å4x4
->
m¥8x8CbCr
[0], cuºMB->
pix_x
, 0);

1725 
	`c›y_image_d©a_16x16
(&
p_Vid
->
íc_pi˘uª
->
imgUV
[1][
cuºMB
->
pix_y
], 
p_RDO
->
å4x4
->
m¥8x8CbCr
[1], cuºMB->
pix_x
, 0);

1727 
uv
=0; uv<2; uv++)

1729 
block
 = 0; block<4; block++)

1731 
	`mem£t
–
cuºSli˚
->
cofAC
[4+
block
+
uv
*4][0][0], 0, 4 * 2 * 65 * ());

1738 
cuºMB
->
cbp
 = 
p_RDO
->
å4x4
->
cbp8x8
;

1739 
cuºMB
->
cbp_blk
 = 
p_RDO
->
å4x4
->
cbp_blk8x8
;

1741 
	`c›y_image_d©a_16x16
(&
p_Vid
->
íc_pi˘uª
->
imgY
[
cuºMB
->
pix_y
], 
p_RDO
->
å4x4
->
ªc_mbY8x8
, cuºMB->
pix_x
, 0);

1743 if(
p_I≈
->
rd›t
 == 3)

1745 
p_Vid
->
p_decs
->
ªc_ty≥
 = 1;

1748 i‡(
cuºSli˚
->
P444_joöed
)

1750 
cuºSli˚
->
cmp_cbp
[1] = cuºSli˚->cmp_cbp[2] = 
p_RDO
->
å4x4
->
cbp8x8
;

1751 
	`c›y_image_d©a_16x16
(&
p_Vid
->
íc_pi˘uª
->
imgUV
[0][
cuºMB
->
pix_y
], 
p_RDO
->
å4x4
->
ªc_mb8x8_¸
[0], cuºMB->
pix_x
, 0);

1752 
	`c›y_image_d©a_16x16
(&
p_Vid
->
íc_pi˘uª
->
imgUV
[1][
cuºMB
->
pix_y
], 
p_RDO
->
å4x4
->
ªc_mb8x8_¸
[1], cuºMB->
pix_x
, 0);

1755 i‡(
p_I≈
->
rd›t
 == 3)

1757 
	`îrdo_gë_be°_P8x8
(
cuºMB
, 0);

1760 
	}
}

1768 
	$ª°‹e_nz_c€ff
(
Ma¸oblock
 *
cuºMB
)

1770 #ifde‡
BEST_NZ_COEFF


1771 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1772 
i
, 
j
;

1773 **
nz_c€ff
 = 
p_Vid
->nz_c€ff[
cuºMB
->
mbAddrX
];

1774 
j
=0;j<4;j++)

1775 
i
=0; i<(4+
p_Vid
->
num_blk8x8_uv
); i++)

1776 
nz_c€ff
[
j
][
i
] = 
p_Vid
->
gØiMBAFF_NZC€ff
[j][i];

1778 
	}
}

1781 
	$¥ï¨e_ùcm_mode
(
Ma¸oblock
 *
cuºMB
)

1783 
i
, 
j
;

1784 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1785 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

1787 
	`c›y_image_d©a_16x16
(&
p_Vid
->
íc_pi˘uª
->
imgY
[
cuºMB
->
pix_y
], &p_Vid->
pCurImg
[cuºMB->
›ix_y
], cuºMB->
pix_x
, currMB->pix_x);

1790 i‡((
p_Vid
->
yuv_f‹m©
 !
YUV400
Ë&& (
p_I≈
->
£∑øã_cﬁour_∂™e_Êag
 == 0))

1792 
	`c›y_image_d©a
(&
p_Vid
->
íc_pi˘uª
->
imgUV
[0][
cuºMB
->
pix_c_y
], &p_Vid->
pImgOrg
[1][cuºMB->
›ix_c_y
], cuºMB->
pix_c_x
, cuºMB->pix_c_x,Ö_Vid->
mb_¸_size_x
,Ö_Vid->
mb_¸_size_y
);

1793 
	`c›y_image_d©a
(&
p_Vid
->
íc_pi˘uª
->
imgUV
[1][
cuºMB
->
pix_c_y
], &p_Vid->
pImgOrg
[2][cuºMB->
›ix_c_y
], cuºMB->
pix_c_x
, cuºMB->pix_c_x,Ö_Vid->
mb_¸_size_x
,Ö_Vid->
mb_¸_size_y
);

1796 
j
=0;j<4;j++)

1797 
i
=0; i<(4+
p_Vid
->
num_blk8x8_uv
); i++)

1798 
p_Vid
->
nz_c€ff
[
cuºMB
->
mbAddrX
][
j
][
i
] = 16;

1799 
	}
}

1807 
	$RDCo°_f‹_ma¸oblocks
 (
Ma¸oblock
 *
cuºMB
,

1808 
œmbda
,

1809 
mode
)

1811 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

1812 
RDOPTSåu˘uª
 *
p_RDO
 = 
cuºSli˚
->p_RDO;

1813 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

1814 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

1816 
£q_∑ømëî_£t_rb•_t
 *
a˘ive_•s
 = 
p_Vid
->active_sps;

1818 
øã
 = 0, 
c€ff_øã
 = 0;

1819 
di°blk
 
di°‹ti⁄
 = 0;

1820 
Ma¸oblock
 *
¥evMB
 = 
cuºMB
->
PªvMB
;

1821 
tmp_cc
;

1823 
u£_of_cc
 = (
cuºSli˚
->
¶i˚_ty≥
 !
I_SLICE
 && cuºSli˚->¶i˚_ty≥ !
SI_SLICE
 && cuºSli˚->
symbﬁ_mode
 =
CAVLC
);

1824 
cc_øã
, 
dummy
;

1826 
di°blk
 
rdco°
;

1827 
di°blk
 
dummy_d
;

1828 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_pred[0];

1829 
img≥l
 ***
cuº_m¥_16x16
 = 
cuºSli˚
->
m¥_16x16
[0];

1832 i‡((
cuºSli˚
->
mb_aff_‰ame_Êag
Ë&& (!
cuºMB
->
mb_fõld
Ë&& (cuºSli˚->
¶i˚_ty≥
 =
P_SLICE
Ë&& (
mode
==0) )

1834 i‡(
	`out_of_bounds_mvs
(
p_Vid
, &
cuºSli˚
->
Æl_mv
[
LIST_0
][0][0][0][0]))

1838 i‡(
mode
 =
P8x8
)

1840 if((
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 && !cuºMB->
vÆid_8x8
Ë|| (!cuºMB->luma_å™sf‹m_size_8x8_Êag && !cuºMB->
vÆid_4x4
))

1847 
cuºSli˚
->
	`£t_modes_™d_ªfs_f‹_blocks
 (
cuºMB
, 
mode
);

1851 
cuºSli˚
->
	`£t_mŸi⁄_ve˘‹s_mb
 (
cuºMB
);

1856 i‡(
mode
 < 
P8x8
)

1858 
cuºSli˚
->
	`luma_ªsiduÆ_codög
(
cuºMB
);

1860 i‡(
mode
 =
P8x8
)

1862 
cuºSli˚
->
	`£t_c€ff_™d_ªc⁄_8x8
 (
cuºMB
);

1864 i‡(
mode
==
I4MB
)

1866 
cuºMB
->
cbp
 = 
	`mode_decisi⁄_f‹_I4x4_MB
 (cuºMB, 
œmbda
, &
dummy_d
);

1868 i‡(
mode
==
I16MB
)

1870 
cuºMB
->
cbp
 = 
cuºSli˚
->
	`mode_decisi⁄_f‹_I16x16_MB
 (cuºMB, 
œmbda
);

1872 if(
mode
==
I8MB
)

1874 
cuºMB
->
cbp
 = 
	`mode_decisi⁄_f‹_I8x8_MB
(cuºMB, 
œmbda
, &
dummy_d
);

1876 if(
mode
==
IPCM
)

1878 
	`¥ï¨e_ùcm_mode
(
cuºMB
);

1888 i‡(
p_I≈
->
RCE«bÀ
)

1890 i‡(
mode
 =
I16MB
)

1891 
	`mem˝y
(
p_RDO
->
¥ed
[0], 
cuº_m¥_16x16
[ (Ë
cuºMB
->
i16mode
][0], 
MB_PIXELS
 * (
img≥l
));

1893 
	`mem˝y
(
p_RDO
->
¥ed
[0], 
mb_¥ed
[0], 
MB_PIXELS
 * (
img≥l
));

1896 
cuºMB
->
i16off£t
 = 0;

1897 
dummy
 = 0;

1899 i‡(((
p_Vid
->
yuv_f‹m©
 !
YUV400
Ë&& (
a˘ive_•s
->
chroma_f‹m©_idc
 !
YUV444
)Ë&& (
mode
 !
IPCM
))

1900 
cuºSli˚
->
	`chroma_ªsiduÆ_codög
 (
cuºMB
);

1902 i‡(
mode
==
I16MB
)

1903 
cuºMB
->
i16off£t
 = 
	`I16Off£t
 (cuºMB->
cbp
, cuºMB->
i16mode
);

1909 i‡(
p_I≈
->
rd›t
 == 3)

1911 
di°‹ti⁄
 = 
p_Vid
->
	`e°im©e_di°‹ti⁄
(
cuºMB
, 0, 16, 
mode
, 0, cuºMB->
mö_rdco°
);

1918 
di°‹ti⁄
 = 
cuºSli˚
->
	`gëDi°‹ti⁄
(
cuºMB
);

1920 i‡(
di°‹ti⁄
 > 
cuºMB
->
mö_rdco°
)

1924 i‡(
cuºMB
->
qp_sˇÀd
[0] =0 && 
p_Vid
->
a˘ive_•s
->
los¶ess_qµrime_Êag
 =1 && 
di°‹ti⁄
 != 0)

1929 
cuºSli˚
->
	`°‹e_codög_°©e
 (
cuºMB
, cuºSli˚->
p_RDO
->
cs_cm
);

1935 i‡(
u£_of_cc
)

1937 i‡(
cuºMB
->
mb_ty≥
!=0 || (
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
 && cuºMB->
cbp
!=0))

1940 
tmp_cc
 = 
p_Vid
->
cod_cou¡î
;

1942 
øã
 = 
cuºSli˚
->
	`wrôe_MB_œyî
 (
cuºMB
, 1, &
c€ff_øã
);

1944 
	`ue_löfo
 (
tmp_cc
, 
dummy
, &
cc_øã
, &dummy);

1945 
øã
 -
cc_øã
;

1946 
p_Vid
->
cod_cou¡î
 = 
tmp_cc
;

1951 
	`ue_löfo
 (
p_Vid
->
cod_cou¡î
 + 1, 
dummy
, &
øã
, &dummy);

1952 
	`ue_löfo
 (
p_Vid
->
cod_cou¡î
 , 
dummy
, &
cc_øã
, &dummy);

1953 
øã
 -
cc_øã
;

1958 
øã
 = 
cuºSli˚
->
	`wrôe_MB_œyî
 (
cuºMB
, 1, &
c€ff_øã
);

1963 
cuºSli˚
->
	`ª£t_codög_°©e
 (
cuºMB
, cuºSli˚->
p_RDO
->
cs_cm
);

1965 i‡(
p_I≈
->
F‹˚TrueR©eRDO
 == 1)

1966 
rdco°
 = 
di°‹ti⁄
 + 
	`weight_co°
(
œmbda
, 
øã
);

1967 i‡(
p_I≈
->
F‹˚TrueR©eRDO
 == 2)

1968 
rdco°
 = 
di°‹ti⁄
 + 
	`weight_co°
(
œmbda
, (
øã
 + 
	`is_öåa
(
cuºMB
)));

1970 
rdco°
 = 
di°‹ti⁄
 + (
øã
>0? (
	`weight_co°
(
œmbda
,Ñate)): (weight_cost(lambda, 1)/2));

1972 #i‡
JCOST_OVERFLOWCHECK


1973 if(
rdco°
 < 
di°‹ti⁄
)

1975 
	`¥ötf
("œmbda: %d,Ñ©e: %d,Éº‹: %s: %d\n", 
œmbda
, 
øã
, 
__FILE__
, 
__LINE__
);

1976 
	`exô
(-1);

1981 i‡((
cuºSli˚
->
¶i˚_ty≥
 !
I_SLICE
Ë&& (
p_I≈
->
BüsSkùRDO
 =1Ë&& (
mode
 =1Ë&& (
cuºMB
->
be°_mode
 =0Ë&& (cuºMB->
mö_dco°
 > 4 * 
di°‹ti⁄
Ë&& (cuºMB->mö_dco° > ((64 * (256 + 2 * 
p_Vid
->
mb_¸_size_y
 *Ö_Vid->
mb_¸_size_x
)Ë<< 
LAMBDA_ACCURACY_BITS
)))

1983 
cuºMB
->
mö_rdco°
 = 
rdco°
 + 1;

1986 i‡((
rdco°
 >
cuºMB
->
mö_rdco°
) ||

1987 ((
cuºMB
->
qp_sˇÀd
[0]Ë=0 && 
p_Vid
->
a˘ive_•s
->
los¶ess_qµrime_Êag
 =1 && 
di°‹ti⁄
 != 0))

1989 #i‡
FASTMODE


1993 if((
cuºSli˚
->
¶i˚_ty≥
 !
P_SLICE
 || 
mode
 !0 || 
rdco°
 !
cuºMB
->
mö_rdco°
Ë|| 
	`is_FREXT_¥ofûe
(
p_I≈
->
ProfûeIDC
))

1999 i‡((
cuºSli˚
->
mb_aff_‰ame_Êag
Ë&& (
mode
 ? 0: ((cuºSli˚->
¶i˚_ty≥
 =
B_SLICE
Ë? !
cuºMB
->
cbp
:1)))

2001 i‡(
cuºMB
->
mbAddrX
 & 0x01)

2003 i‡(
¥evMB
->
mb_ty≥
 ? 0:((
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
Ë? !¥evMB->
cbp
:1))

2005 i‡(!(
	`fõld_Êag_ö„ªn˚
(
cuºMB
Ë=cuºMB->
mb_fõld
))

2013 
cuºMB
->
mö_rdco°
 = 
rdco°
;

2014 
cuºMB
->
mö_dco°
 = 
di°‹ti⁄
;

2015 
cuºMB
->
mö_øã
 = 
	`weight_co°
(
œmbda
, 
c€ff_øã
);

2016 
cuºMB
->
mö_bôs
 = 
øã
;

2018 #ifde‡
BEST_NZ_COEFF


2019 
j
=0;j<4;j++)

2020 
	`mem˝y
(&
p_Vid
->
gØiMBAFF_NZC€ff
[
j
][0], &p_Vid->
nz_c€ff
[
cuºMB
->
mbAddrX
][j][0], (4 +Ö_Vid->
num_blk8x8_uv
) * ());

2024 
	}
}

2032 
	$öô_md_be°
(
Be°Mode
 *
be°
)

2034 
be°
->
cbp
 = 0;

2035 
be°
->
co°
 = 
DISTBLK_MAX
;

2036 
be°
->
rdco°
 = 1e20;

2037 
be°
->
dco°
 = 1e20;

2038 
be°
->
øã
 = 1e20;

2039 
be°
->
c_imode
 = 0;

2040 
be°
->
i16off£t
 = 0;

2041 
be°
->
mode
 = 10;

2042 
	}
}

2050 
	$°‹e_ma¸oblock_∑ømëîs
 (
Ma¸oblock
 *
cuºMB
, 
mode
)

2052 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

2053 
RDOPTSåu˘uª
 *
p_RDO
 = 
cuºSli˚
->p_RDO;

2054 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

2055 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

2056 
PicMŸi⁄P¨ams
 **
mŸi⁄
 = 
p_Vid
->
íc_pi˘uª
->
mv_öfo
;

2058 
i
, 
j
, ****
i4p
, ***
i3p
;

2061 
cuºMB
->
be°_mode
 = (Ë
mode
;

2062 
cuºMB
->
be°_c_imode
 = cuºMB->
c_ùªd_mode
;

2063 
cuºMB
->
be°_i16off£t
 = cuºMB->
i16off£t
;

2064 
cuºMB
->
be°_i16mode
 = cuºMB->
i16mode
;

2065 
cuºMB
->
be°_cbp
 = cuºMB->
cbp
;

2067 
	`mem˝y
(
cuºSli˚
->
p_RDO
->
be°8x8
, 
cuºMB
->
b8x8
, 
BLOCK_MULTIPLE
 * (
Info8x8
));

2069 
	`mem˝y
(
cuºSli˚
->
b4_öåa_¥ed_modes
, 
cuºMB
->
öåa_¥ed_modes
, 
MB_BLOCK_PARTITIONS
 * ());

2070 
	`mem˝y
(
cuºSli˚
->
b8_öåa_¥ed_modes8x8
,
cuºMB
->
öåa_¥ed_modes8x8
, 
MB_BLOCK_PARTITIONS
 * ());

2072 
j
 = 0 ; j < 
BLOCK_MULTIPLE
; j++)

2074 
	`mem˝y
(&
cuºSli˚
->
b4_ùªdmode
[
j
 * 
BLOCK_MULTIPLE
],&
p_Vid
->
ùªdmode
 [
cuºMB
->
block_y
 + j][cuºMB->
block_x
],BLOCK_MULTIPLE * ());

2075 
	`mem˝y
(&
cuºSli˚
->
b8_ùªdmode8x8
[
j
][0], &
p_Vid
->
ùªdmode8x8
[
cuºMB
->
block_y
 + j][cuºMB->
block_x
],
BLOCK_MULTIPLE
 * ());

2078 
	`c›y_image_d©a_16x16
(
p_RDO
->
ªc_mb
[0], &
p_Vid
->
íc_pi˘uª
->
imgY
[
cuºMB
->
pix_y
], 0, cuºMB->
pix_x
);

2080 if((
cuºSli˚
->
¶i˚_ty≥
 =
SP_SLICE
Ë&& 
p_Vid
->
•2_‰ame_ödiˇt‹
==0)

2082 
j
 = 0; j < 
MB_BLOCK_SIZE
; j++)

2084 
	`mem˝y
(
p_RDO
->
Ãec_ªc
[
j
], &
p_Vid
->
Ãec
[
cuºMB
->
pix_y
+j][cuºMB->
pix_x
], 
MB_BLOCK_SIZE
 * ());

2089 i‡(
p_Vid
->
Ad≠tiveRoundög
 && (
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
Ë&& 
mode
 <= 1)

2091 i‡(
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
)

2092 
	`°‹e_ad≠tive_roundög_16x16
–
p_Vid
,Ö_Vid->
ARCofAdj8x8
, 
mode
);

2094 
	`°‹e_ad≠tive_roundög_16x16
–
p_Vid
,Ö_Vid->
ARCofAdj4x4
, 
mode
);

2097 i‡(
p_Vid
->
yuv_f‹m©
 !
YUV400
)

2099 
k
;

2100 
k
 = 0; k < 2; k++)

2102 
	`c›y_image_d©a
(
p_RDO
->
ªc_mb
[
k
 + 1], &
p_Vid
->
íc_pi˘uª
->
imgUV
[k][
cuºMB
->
pix_c_y
], 0, cuºMB->
pix_c_x
,Ö_Vid->
mb_¸_size_x
,Ö_Vid->
mb_¸_size_y
);

2105 if((
cuºSli˚
->
¶i˚_ty≥
 =
SP_SLICE
Ë&& 
p_Vid
->
•2_‰ame_ödiˇt‹
==0)

2108 
k
 = 0; k < 2; k++)

2110 
j
 = 0; j<
p_Vid
->
mb_¸_size_y
; j++)

2112 
	`mem˝y
(
p_RDO
->
Ãec_ªc_uv
[
k
][
j
],&
p_Vid
->
Ãec_uv
[k][
cuºMB
->
pix_c_y
 + j][cuºMB->
pix_c_x
],Ö_Vid->
mb_¸_size_x
 * ());

2119 i‡(
p_I≈
->
rd›t
 == 3)

2121 
	`îrdo_°‹e_be°_MB
(
cuºMB
);

2125 i‡(
mode
 || 
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
)

2127 
i4p
 = 
p_RDO
->
cofAC
;

2128 
p_RDO
->
cofAC
 = 
cuºSli˚
->cofAC;

2129 
cuºSli˚
->
cofAC
 = 
i4p
;

2130 
i3p
 = 
p_RDO
->
cofDC
;

2131 
p_RDO
->
cofDC
 = 
cuºSli˚
->cofDC;

2132 
cuºSli˚
->
cofDC
 = 
i3p
;

2133 
p_RDO
->
cbp
 = 
cuºMB
->cbp;

2134 
cuºSli˚
->
cuº_cbp
[0] = cuºSli˚->
cmp_cbp
[1];

2135 
cuºSli˚
->
cuº_cbp
[1] = cuºSli˚->
cmp_cbp
[2];

2137 
cuºSli˚
->
cur_cbp_blk
[0] = 
cuºMB
->
cbp_blk
;

2141 
cuºSli˚
->
cur_cbp_blk
[0] = 
p_RDO
->
cbp
 = 0;

2142 
cuºSli˚
->
cmp_cbp
[1] = currSlice->cmp_cbp[2] = 0;

2146 
cuºMB
->
ãmp_å™sf‹m_size_8x8_Êag
 = cuºMB->
luma_å™sf‹m_size_8x8_Êag
;

2148 i‡(
cuºSli˚
->
¶i˚_ty≥
 !
B_SLICE
)

2150 
j
 = 0; j < 4; j++)

2152 
i
 = 0; i < 4; i++)

2154 
p_RDO
->
l0_ªf‰ame
[
j
][
i
] = 
mŸi⁄
[
cuºMB
->
block_y
 + j][cuºMB->
block_x
 + i].
ªf_idx
[
LIST_0
];

2160 
j
 = 0; j < 4; j++)

2162 
i
 = 0; i < 4; i++)

2164 
p_RDO
->
l0_ªf‰ame
[
j
][
i
] = 
mŸi⁄
[
cuºMB
->
block_y
 + j][cuºMB->
block_x
 + i].
ªf_idx
[
LIST_0
];

2165 
p_RDO
->
l1_ªf‰ame
[
j
][
i
] = 
mŸi⁄
[
cuºMB
->
block_y
 + j][cuºMB->
block_x
 + i].
ªf_idx
[
LIST_1
];

2169 
	}
}

2177 
	$£t_°‹ed_ma¸oblock_∑ømëîs_m∑ss
 (
Ma¸oblock
 *
cuºMB
)

2179 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

2180 
RDOPTSåu˘uª
 *
p_RDO
 = 
cuºSli˚
->p_RDO;

2181 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

2182 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

2184 
img≥l
 **
imgY
 = 
p_Vid
->
íc_pi˘uª
->imgY;

2185 
img≥l
 ***
imgUV
 = 
p_Vid
->
íc_pi˘uª
->imgUV;

2187 
mode
 = 
cuºMB
->
be°_mode
;

2188 
i
, 
j
, 
k
, ****
i4p
, ***
i3p
;

2189 
block_x
, 
block_y
;

2190 **
ùªdmodes
 = 
p_Vid
->
ùªdmode
;

2192 
PicMŸi⁄P¨ams
 **
mŸi⁄
 = 
p_Vid
->
íc_pi˘uª
->
mv_öfo
;

2197 
	`c›y_image_d©a_16x16
(&
imgY
[
cuºMB
->
pix_y
], 
p_RDO
->
ªc_mb
[0], cuºMB->
pix_x
, 0);

2200 
	`c›y_image_d©a_16x16
(
cuºSli˚
->
rdd©a
->
ªc_mb
[0], 
p_RDO
->rec_mb[0], 0, 0);

2202 if((
cuºSli˚
->
¶i˚_ty≥
 =
SP_SLICE
Ë&& 
p_Vid
->
•2_‰ame_ödiˇt‹
==0)

2204 
j
 = 0; j < 
MB_BLOCK_SIZE
; j++)

2205 
	`mem˝y
(&
p_Vid
->
Ãec
[
cuºMB
->
pix_y
+
j
][cuºMB->
pix_x
], 
p_RDO
->
Ãec_ªc
[j], 
MB_BLOCK_SIZE
 * ());

2208 i‡(
p_Vid
->
Ad≠tiveRoundög
)

2210 
	`upd©e_off£t_∑øms
(
cuºMB
, 
mode
, cuºMB->
ãmp_å™sf‹m_size_8x8_Êag
);

2213 i‡(
p_Vid
->
yuv_f‹m©
 !
YUV400
)

2215 
k
 = 0; k < 2; k++)

2217 
	`c›y_image_d©a
(&
imgUV
[
k
][
cuºMB
->
pix_c_y
], 
p_RDO
->
ªc_mb
[k + 1], cuºMB->
pix_c_x
, 0, 
p_Vid
->
mb_¸_size_x
,Ö_Vid->
mb_¸_size_y
);

2221 
	`c›y_image_d©a
(
cuºSli˚
->
rdd©a
->
ªc_mb
[1], 
p_RDO
->ªc_mb[1], 0, 0, 
p_Vid
->
mb_¸_size_x
,Ö_Vid->
mb_¸_size_y
);

2222 
	`c›y_image_d©a
(
cuºSli˚
->
rdd©a
->
ªc_mb
[2], 
p_RDO
->ªc_mb[2], 0, 0, 
p_Vid
->
mb_¸_size_x
,Ö_Vid->
mb_¸_size_y
);

2224 if((
cuºSli˚
->
¶i˚_ty≥
 =
SP_SLICE
Ë&& !
p_Vid
->
•2_‰ame_ödiˇt‹
)

2226 
k
 = 0; k < 2; k++)

2228 
j
 = 0; j<
p_Vid
->
mb_¸_size_y
; j++)

2230 
	`mem˝y
(&
p_Vid
->
Ãec_uv
[
k
][
cuºMB
->
pix_c_y
 + 
j
][cuºMB->
pix_c_x
], 
p_RDO
->
Ãec_ªc_uv
[k][j],Ö_Vid->
mb_¸_size_x
 * ());

2237 
i4p
 = 
p_RDO
->
cofAC
;

2238 
p_RDO
->
cofAC
 = 
cuºSli˚
->cofAC;

2239 
cuºSli˚
->
cofAC
 = 
i4p
;

2241 
i3p
 = 
p_RDO
->
cofDC
;

2242 
p_RDO
->
cofDC
 = 
cuºSli˚
->cofDC;

2243 
cuºSli˚
->
cofDC
 = 
i3p
;

2244 
cuºMB
->
cbp
 = 
p_RDO
->cbp;

2245 
cuºMB
->
cbp_blk
 = 
cuºSli˚
->
cur_cbp_blk
[0];

2246 
cuºMB
->
cbp
 |
cuºSli˚
->
cuº_cbp
[0];

2247 
cuºMB
->
cbp
 |
cuºSli˚
->
cuº_cbp
[1];

2248 
cuºSli˚
->
cmp_cbp
[1] = 
cuºMB
->
cbp
;

2249 
cuºSli˚
->
cmp_cbp
[2] = 
cuºMB
->
cbp
;

2252 
cuºMB
->
mb_ty≥
 = (Ë
mode
;

2254 
	`mem˝y
(
cuºMB
->
b8x8
, 
cuºSli˚
->
p_RDO
->
be°8x8
, 
BLOCK_MULTIPLE
 * (
Info8x8
));

2257 
cuºSli˚
->
rdd©a
->
mode
 = mode;

2258 
cuºSli˚
->
rdd©a
->
i16off£t
 = 
cuºMB
->i16offset;

2259 
cuºSli˚
->
rdd©a
->
i16mode
 = 
cuºMB
->i16mode;

2260 
cuºSli˚
->
rdd©a
->
cbp
 = 
p_RDO
->cbp;

2261 
cuºSli˚
->
rdd©a
->
cbp_blk
 = cuºSli˚->
cur_cbp_blk
[0];

2262 
cuºSli˚
->
rdd©a
->
mb_ty≥
 = (Ë
mode
;

2264 
cuºSli˚
->
rdd©a
->
¥ev_qp
 = 
cuºMB
->prev_qp;

2265 
cuºSli˚
->
rdd©a
->
¥ev_dqp
 = 
cuºMB
->prev_dqp;

2266 
cuºSli˚
->
rdd©a
->
qp
 = 
cuºMB
->qp;

2267 
cuºSli˚
->
rdd©a
->
¥ev_cbp
 = 
cuºMB
->prev_cbp;

2269 
	`mem˝y
(
cuºSli˚
->
rdd©a
->
cofAC
[0][0][0], cuºSli˚->cofAC[0][0][0], (4+
p_Vid
->
num_blk8x8_uv
) * 4 * 2 * 65 * ());

2270 
	`mem˝y
(
cuºSli˚
->
rdd©a
->
cofDC
[0][0], currSlice->cofDC[0][0], 3 * 2 * 18 * ());

2272 
	`mem˝y
(
cuºSli˚
->
rdd©a
->
b8x8
, cuºSli˚->
p_RDO
->
be°8x8
, 
BLOCK_MULTIPLE
 * (
Info8x8
));

2275 i‡(
mode
 =
P8x8
 && !
cuºMB
->
ãmp_å™sf‹m_size_8x8_Êag
 && 
p_I≈
->
Tønsf‹m8x8Mode
 && (cuºMB->
vÆid_8x8
 =
TRUE
))

2277 
	`Re°‹eMV8x8
(
cuºSli˚
, 1);

2281 i‡(
p_Vid
->
P444_joöed
)

2283 i‡(((
cuºMB
->
cbp
 =0Ë&& 
cuºSli˚
->
cmp_cbp
[1] =0 && cuºSli˚->cmp_cbp[2] =0Ë&& (cuºMB->
mb_ty≥
 !
I4MB
 && cuºMB->mb_ty≥ !
I8MB
))

2284 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
FALSE
;

2286 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = cuºMB->
ãmp_å™sf‹m_size_8x8_Êag
;

2291 i‡(((
cuºMB
->
cbp
 & 15Ë=0Ë&& (cuºMB->
mb_ty≥
 !
I4MB
 && cuºMB->mb_ty≥ !
I8MB
))

2292 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
FALSE
;

2294 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = cuºMB->
ãmp_å™sf‹m_size_8x8_Êag
;

2297 
cuºSli˚
->
rdd©a
->
luma_å™sf‹m_size_8x8_Êag
 = 
cuºMB
->luma_transform_size_8x8_flag;

2299 i‡(
p_I≈
->
rd›t
 == 3)

2301 
	`îrdo_gë_be°_MB
(
cuºMB
);

2305 
j
 = 0; j < 4; j++)

2307 
block_y
 = 
cuºMB
->block_y + 
j
;

2308 
i
 = 0; i < 4; i++)

2310 
block_x
 = 
cuºMB
->block_x + 
i
;

2311 
k
 = 2*(
j
 >> 1)+(
i
 >> 1);

2314 i‡((
cuºMB
->
b8x8
[
k
].
pdú
 =1Ë|| 
	`is_öåa
(currMB))

2316 
mŸi⁄
[
block_y
][
block_x
].
ªf_idx
 [
LIST_0
] = -1;

2317 
mŸi⁄
[
block_y
][
block_x
].
mv
 [
LIST_0
] = 
zîo_mv
;

2318 
mŸi⁄
[
block_y
][
block_x
].
ªf_pic
 [
LIST_0
] = 
NULL
;

2321 
cuºSli˚
->
rdd©a
->
ªÁr
[
LIST_0
][
j
][
i
] = -1;

2325 i‡(
cuºMB
->
b8x8
[
k
].
bùªd
 && (cuºMB->b8x8[k].
pdú
 =2Ë&& 
	`is_bùªd_íabÀd
(
p_Vid
, cuºMB->
mb_ty≥
))

2327 
mŸi⁄
[
block_y
][
block_x
].
ªf_idx
 [
LIST_0
] = 0;

2328 
mŸi⁄
[
block_y
][
block_x
].
ªf_pic
 [
LIST_0
] = 
cuºSli˚
->
li°X
[LIST_0 + 
cuºMB
->
li°_off£t
][0];

2329 
mŸi⁄
[
block_y
][
block_x
].
mv
 [
LIST_0
] = 
cuºSli˚
->
bùªd_mv
[
cuºMB
->
b8x8
[
k
].
bùªd
 - 1][LIST_0][0][(ËcuºMB->b8x8[k].
mode
][
j
][
i
];

2332 
cuºSli˚
->
rdd©a
->
ªÁr
[
LIST_0
][
j
][
i
] = 0;

2336 
cur_ªf
 = 
p_RDO
->
l0_ªf‰ame
[
j
][
i
];

2337 
mŸi⁄
[
block_y
][
block_x
].
ªf_idx
 [
LIST_0
] = 
cur_ªf
;

2338 if(
cur_ªf
 >=0)

2340 
mŸi⁄
[
block_y
][
block_x
].
ªf_pic
 [
LIST_0
] = 
cuºSli˚
->
li°X
[LIST_0 + 
cuºMB
->
li°_off£t
][()
cur_ªf
];

2341 
mŸi⁄
[
block_y
][
block_x
].
mv
 [
LIST_0
] = 
cuºSli˚
->
Æl_mv
[LIST_0][()
cur_ªf
][(Ë
cuºMB
->
b8x8
[
k
].
mode
][
j
][
i
];

2344 
cuºSli˚
->
rdd©a
->
ªÁr
[
LIST_0
][
j
][
i
] = 
cur_ªf
;

2349 i‡((
cuºMB
->
b8x8
[
k
].
pdú
 =0Ë|| 
	`is_öåa
(currMB))

2351 
mŸi⁄
[
block_y
][
block_x
].
ªf_idx
 [
LIST_1
] = -1;

2352 
mŸi⁄
[
block_y
][
block_x
].
ªf_pic
 [
LIST_1
] = 
NULL
;

2353 
mŸi⁄
[
block_y
][
block_x
].
mv
 [
LIST_1
] = 
zîo_mv
;

2356 
cuºSli˚
->
rdd©a
->
ªÁr
[
LIST_1
][
j
][
i
] = -1;

2361 i‡(
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
)

2363 
j
=0; j<4; j++)

2365 
block_y
 = 
cuºMB
->block_y + 
j
;

2366 
i
=0; i<4; i++)

2368 
block_x
 = 
cuºMB
->block_x + 
i
;

2369 
k
 = 2*(
j
 >> 1)+(
i
 >> 1);

2372 i‡(
	`is_öåa
(
cuºMB
)||(cuºMB->
b8x8
[
k
].
pdú
 == 0))

2374 
mŸi⁄
[
block_y
][
block_x
].
ªf_idx
 [
LIST_1
] = -1;

2375 
mŸi⁄
[
block_y
][
block_x
].
ªf_pic
 [
LIST_1
] = 
NULL
;

2376 
mŸi⁄
[
block_y
][
block_x
].
mv
 [
LIST_1
] = 
zîo_mv
;

2379 
cuºSli˚
->
rdd©a
->
ªÁr
[
LIST_1
][
j
][
i
] = -1;

2383 i‡(
cuºMB
->
b8x8
[
k
].
bùªd
 && (cuºMB->b8x8[k].
pdú
 =2Ë&& 
	`is_bùªd_íabÀd
(
p_Vid
, cuºMB->
mb_ty≥
))

2385 
mŸi⁄
[
block_y
][
block_x
].
ªf_idx
 [
LIST_1
] = 0;

2386 
mŸi⁄
[
block_y
][
block_x
].
ªf_pic
 [
LIST_1
] = 
cuºSli˚
->
li°X
[LIST_1 + 
cuºMB
->
li°_off£t
][0];

2387 
mŸi⁄
[
block_y
][
block_x
].
mv
 [
LIST_1
] = 
cuºSli˚
->
bùªd_mv
[
cuºMB
->
b8x8
[
k
].
bùªd
 - 1][LIST_1][0][(ËcuºMB->b8x8[k].
mode
][
j
][
i
];

2390 
cuºSli˚
->
rdd©a
->
ªÁr
[
LIST_1
][
j
][
i
] = 0;

2394 
mŸi⁄
[
block_y
][
block_x
].
ªf_idx
 [
LIST_1
] = 
p_RDO
->
l1_ªf‰ame
[
j
][
i
];

2395 
mŸi⁄
[
block_y
][
block_x
].
ªf_pic
 [
LIST_1
] = 
cuºSli˚
->
li°X
[LIST_1 + 
cuºMB
->
li°_off£t
][()
p_RDO
->
l1_ªf‰ame
[
j
][
i
]];

2396 
mŸi⁄
[
block_y
][
block_x
].
mv
 [
LIST_1
] = 
cuºSli˚
->
Æl_mv
[LIST_1][()
p_RDO
->
l1_ªf‰ame
[
j
][
i
]][(Ë
cuºMB
->
b8x8
[
k
].
mode
][j][i];

2399 
cuºSli˚
->
rdd©a
->
ªÁr
[
LIST_1
][
j
][
i
] = 
p_RDO
->
l1_ªf‰ame
[j][i];

2407 
cuºMB
->
c_ùªd_mode
 = cuºMB->
be°_c_imode
;

2408 
cuºMB
->
i16off£t
 = cuºMB->
be°_i16off£t
;

2409 
cuºMB
->
i16mode
 = cuºMB->
be°_i16mode
;

2410 
cuºMB
->
cbp
 = cuºMB->
be°_cbp
;

2412 if(
cuºMB
->
mb_ty≥
 =
I8MB
)

2414 
	`mem˝y
(
cuºMB
->
öåa_¥ed_modes8x8
,
cuºSli˚
->
b8_öåa_¥ed_modes8x8
, 
MB_BLOCK_PARTITIONS
 * ());

2415 
	`mem˝y
(
cuºMB
->
öåa_¥ed_modes
 ,
cuºSli˚
->
b8_öåa_¥ed_modes8x8
, 
MB_BLOCK_PARTITIONS
 * ());

2416 
j
 = 0; j < 
BLOCK_MULTIPLE
; j++)

2418 
	`mem˝y
(&
p_Vid
->
ùªdmode
 [
cuºMB
->
block_y
+
j
][cuºMB->
block_x
], 
cuºSli˚
->
b8_ùªdmode8x8
[j], 
BLOCK_MULTIPLE
 * ());

2419 
	`mem˝y
(&
p_Vid
->
ùªdmode8x8
[
cuºMB
->
block_y
+
j
][cuºMB->
block_x
], 
cuºSli˚
->
b8_ùªdmode8x8
[j], 
BLOCK_MULTIPLE
 * ());

2422 i‡(
mode
!=
I4MB
 && mode!=
I8MB
)

2424 
	`mem£t
(
cuºMB
->
öåa_¥ed_modes
,
DC_PRED
, 
MB_BLOCK_PARTITIONS
 * ());

2425 
j
 = 
cuºMB
->
block_y
; j < cuºMB->block_y + 
BLOCK_MULTIPLE
; j++)

2426 
	`mem£t
(&
p_Vid
->
ùªdmode
[
j
][
cuºMB
->
block_x
], 
DC_PRED
, 
BLOCK_MULTIPLE
 * ());

2429 i‡(
mode
 =
I4MB
)

2431 
	`mem˝y
(
cuºMB
->
öåa_¥ed_modes
,
cuºSli˚
->
b4_öåa_¥ed_modes
, 
MB_BLOCK_PARTITIONS
 * ());

2432 
j
 = 0; j < 
BLOCK_MULTIPLE
; j++)

2433 
	`mem˝y
(&
p_Vid
->
ùªdmode
[
cuºMB
->
block_y
 + 
j
][cuºMB->
block_x
],&
cuºSli˚
->
b4_ùªdmode
[
BLOCK_MULTIPLE
 * j], BLOCK_MULTIPLE * ());

2437 
cuºSli˚
->
rdd©a
->
c_ùªd_mode
 = 
cuºMB
->c_ipred_mode;

2438 
cuºSli˚
->
rdd©a
->
i16off£t
 = 
cuºMB
->i16offset;

2439 
cuºSli˚
->
rdd©a
->
i16mode
 = 
cuºMB
->i16mode;

2440 
cuºSli˚
->
rdd©a
->
cbp
 = 
cuºMB
->cbp;

2441 
cuºSli˚
->
rdd©a
->
cbp_blk
 = 
cuºMB
->cbp_blk;

2442 
	`mem˝y
(
cuºSli˚
->
rdd©a
->
öåa_¥ed_modes
,
cuºMB
->öåa_¥ed_modes, 
MB_BLOCK_PARTITIONS
 * ());

2443 
	`mem˝y
(
cuºSli˚
->
rdd©a
->
öåa_¥ed_modes8x8
,
cuºMB
->öåa_¥ed_modes8x8, 
MB_BLOCK_PARTITIONS
 * ());

2444 
j
 = 
cuºMB
->
block_y
; j < cuºMB->block_y + 
BLOCK_MULTIPLE
; j++)

2445 
	`mem˝y
(&
cuºSli˚
->
rdd©a
->
ùªdmode
[
j
][
cuºMB
->
block_x
],&
ùªdmodes
[j][cuºMB->block_x], 
BLOCK_MULTIPLE
 * ());

2448 
cuºSli˚
->
	`£t_mŸi⁄_ve˘‹s_mb
 (
cuºMB
);

2449 
	}
}

2457 
	$£t_°‹ed_ma¸oblock_∑ømëîs
 (
Ma¸oblock
 *
cuºMB
)

2459 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

2460 
RDOPTSåu˘uª
 *
p_RDO
 = 
cuºSli˚
->p_RDO;

2461 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

2462 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

2464 
img≥l
 **
imgY
 = 
p_Vid
->
íc_pi˘uª
->imgY;

2465 
img≥l
 ***
imgUV
 = 
p_Vid
->
íc_pi˘uª
->imgUV;

2467 
mode
 = 
cuºMB
->
be°_mode
;

2468 
i
, 
j
, 
k
, ****
i4p
, ***
i3p
;

2469 
block_x
, 
block_y
;

2471 
PicMŸi⁄P¨ams
 **
mŸi⁄
 = 
p_Vid
->
íc_pi˘uª
->
mv_öfo
;

2476 
	`c›y_image_d©a_16x16
(&
imgY
[
cuºMB
->
pix_y
], 
p_RDO
->
ªc_mb
[0], cuºMB->
pix_x
, 0);

2478 i‡(
p_Vid
->
Ad≠tiveRoundög
)

2480 
	`upd©e_off£t_∑øms
(
cuºMB
, 
mode
, cuºMB->
ãmp_å™sf‹m_size_8x8_Êag
);

2483 i‡(
p_Vid
->
yuv_f‹m©
 !
YUV400
)

2485 
k
 = 0; k < 2; k++)

2487 
	`c›y_image_d©a
(&
imgUV
[
k
][
cuºMB
->
pix_c_y
], 
p_RDO
->
ªc_mb
[k + 1], cuºMB->
pix_c_x
, 0, 
p_Vid
->
mb_¸_size_x
,Ö_Vid->
mb_¸_size_y
);

2492 
i4p
 = 
p_RDO
->
cofAC
;

2493 
p_RDO
->
cofAC
 = 
cuºSli˚
->cofAC;

2494 
cuºSli˚
->
cofAC
 = 
i4p
;

2496 
i3p
 = 
p_RDO
->
cofDC
;

2497 
p_RDO
->
cofDC
 = 
cuºSli˚
->cofDC;

2498 
cuºSli˚
->
cofDC
 = 
i3p
;

2499 
cuºMB
->
cbp
 = 
p_RDO
->cbp;

2500 
cuºMB
->
cbp_blk
 = 
cuºSli˚
->
cur_cbp_blk
[0];

2501 
cuºMB
->
cbp
 |
cuºSli˚
->
cuº_cbp
[0];

2502 
cuºMB
->
cbp
 |
cuºSli˚
->
cuº_cbp
[1];

2503 
cuºSli˚
->
cmp_cbp
[1] = 
cuºMB
->
cbp
;

2504 
cuºSli˚
->
cmp_cbp
[2] = 
cuºMB
->
cbp
;

2507 
cuºMB
->
mb_ty≥
 = (Ë
mode
;

2509 
	`mem˝y
(
cuºMB
->
b8x8
, 
cuºSli˚
->
p_RDO
->
be°8x8
, 
BLOCK_MULTIPLE
 * (
Info8x8
));

2513 i‡(
mode
 =
P8x8
 && !
cuºMB
->
ãmp_å™sf‹m_size_8x8_Êag
 && 
p_I≈
->
Tønsf‹m8x8Mode
 && (cuºMB->
vÆid_8x8
 =
TRUE
))

2515 
	`Re°‹eMV8x8
(
cuºSli˚
, 1);

2519 i‡(
p_Vid
->
P444_joöed
)

2521 i‡(((
cuºMB
->
cbp
 =0Ë&& 
cuºSli˚
->
cmp_cbp
[1] =0 && cuºSli˚->cmp_cbp[2] =0Ë&& (cuºMB->
mb_ty≥
 !
I4MB
 && cuºMB->mb_ty≥ !
I8MB
))

2522 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
FALSE
;

2524 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = cuºMB->
ãmp_å™sf‹m_size_8x8_Êag
;

2529 i‡(((
cuºMB
->
cbp
 & 15Ë=0Ë&& (cuºMB->
mb_ty≥
 !
I4MB
 && cuºMB->mb_ty≥ !
I8MB
))

2530 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
FALSE
;

2532 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = cuºMB->
ãmp_å™sf‹m_size_8x8_Êag
;

2535 
cuºSli˚
->
rdd©a
->
luma_å™sf‹m_size_8x8_Êag
 = 
cuºMB
->luma_transform_size_8x8_flag;

2537 i‡(
p_I≈
->
rd›t
 == 3)

2539 
	`îrdo_gë_be°_MB
(
cuºMB
);

2543 
j
 = 0; j < 4; j++)

2545 
block_y
 = 
cuºMB
->block_y + 
j
;

2546 
i
 = 0; i < 4; i++)

2548 
block_x
 = 
cuºMB
->block_x + 
i
;

2549 
k
 = 2*(
j
 >> 1)+(
i
 >> 1);

2552 i‡((
cuºMB
->
b8x8
[
k
].
pdú
 =1Ë|| 
	`is_öåa
(currMB))

2554 
mŸi⁄
[
block_y
][
block_x
].
ªf_idx
 [
LIST_0
] = -1;

2555 
mŸi⁄
[
block_y
][
block_x
].
ªf_pic
 [
LIST_0
] = 
NULL
;

2556 
mŸi⁄
[
block_y
][
block_x
].
mv
 [
LIST_0
] = 
zîo_mv
;

2560 i‡(
cuºMB
->
b8x8
[
k
].
bùªd
 && (cuºMB->b8x8[k].
pdú
 =2Ë&& 
	`is_bùªd_íabÀd
(
p_Vid
, cuºMB->
mb_ty≥
))

2562 
mŸi⁄
[
block_y
][
block_x
].
ªf_idx
 [
LIST_0
] = 0;

2563 
mŸi⁄
[
block_y
][
block_x
].
ªf_pic
 [
LIST_0
] = 
cuºSli˚
->
li°X
[LIST_0 + 
cuºMB
->
li°_off£t
][0];

2564 
mŸi⁄
[
block_y
][
block_x
].
mv
 [
LIST_0
] = 
cuºSli˚
->
bùªd_mv
[
cuºMB
->
b8x8
[
k
].
bùªd
 - 1][LIST_0][0][(ËcuºMB->b8x8[k].
mode
][
j
][
i
];

2568 
cur_ªf
 = 
p_RDO
->
l0_ªf‰ame
[
j
][
i
];

2569 
mŸi⁄
[
block_y
][
block_x
].
ªf_idx
 [
LIST_0
] = 
cur_ªf
;

2570 
mŸi⁄
[
block_y
][
block_x
].
ªf_pic
 [
LIST_0
] = 
cuºSli˚
->
li°X
[LIST_0 + 
cuºMB
->
li°_off£t
][()
cur_ªf
];

2571 
mŸi⁄
[
block_y
][
block_x
].
mv
 [
LIST_0
] = 
cuºSli˚
->
Æl_mv
[LIST_0][()
cur_ªf
][(Ë
cuºMB
->
b8x8
[
k
].
mode
][
j
][
i
];

2576 i‡((
cuºMB
->
b8x8
[
k
].
pdú
 =0Ë|| 
	`is_öåa
(currMB))

2578 
mŸi⁄
[
block_y
][
block_x
].
ªf_idx
 [
LIST_1
] = -1;

2579 
mŸi⁄
[
block_y
][
block_x
].
ªf_pic
 [
LIST_1
] = 
NULL
;

2580 
mŸi⁄
[
block_y
][
block_x
].
mv
 [
LIST_1
] = 
zîo_mv
;

2585 i‡(
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
)

2587 
j
=0; j<4; j++)

2589 
block_y
 = 
cuºMB
->block_y + 
j
;

2590 
i
=0; i<4; i++)

2592 
block_x
 = 
cuºMB
->block_x + 
i
;

2593 
k
 = 2*(
j
 >> 1)+(
i
 >> 1);

2596 i‡(
	`is_öåa
(
cuºMB
)||(cuºMB->
b8x8
[
k
].
pdú
 == 0))

2598 
mŸi⁄
[
block_y
][
block_x
].
ªf_idx
 [
LIST_1
] = -1;

2599 
mŸi⁄
[
block_y
][
block_x
].
ªf_pic
 [
LIST_1
] = 
NULL
;

2600 
mŸi⁄
[
block_y
][
block_x
].
mv
 [
LIST_1
] = 
zîo_mv
;

2604 i‡(
cuºMB
->
b8x8
[
k
].
bùªd
 && (cuºMB->b8x8[k].
pdú
 =2Ë&& 
	`is_bùªd_íabÀd
(
p_Vid
, cuºMB->
mb_ty≥
))

2606 
mŸi⁄
[
block_y
][
block_x
].
ªf_idx
 [
LIST_1
] = 0;

2607 
mŸi⁄
[
block_y
][
block_x
].
ªf_pic
 [
LIST_1
] = 
cuºSli˚
->
li°X
[LIST_1 + 
cuºMB
->
li°_off£t
][0];

2608 
mŸi⁄
[
block_y
][
block_x
].
mv
 [
LIST_1
] = 
cuºSli˚
->
bùªd_mv
[
cuºMB
->
b8x8
[
k
].
bùªd
 - 1][LIST_1][0][(ËcuºMB->b8x8[k].
mode
][
j
][
i
];

2612 
mŸi⁄
[
block_y
][
block_x
].
ªf_idx
 [
LIST_1
] = 
p_RDO
->
l1_ªf‰ame
[
j
][
i
];

2613 
mŸi⁄
[
block_y
][
block_x
].
ªf_pic
 [
LIST_1
] = 
cuºSli˚
->
li°X
[LIST_1 + 
cuºMB
->
li°_off£t
][()
p_RDO
->
l1_ªf‰ame
[
j
][
i
]];

2614 
mŸi⁄
[
block_y
][
block_x
].
mv
 [
LIST_1
] = 
cuºSli˚
->
Æl_mv
[LIST_1][()
p_RDO
->
l1_ªf‰ame
[
j
][
i
]][(Ë
cuºMB
->
b8x8
[
k
].
mode
][j][i];

2622 
cuºMB
->
c_ùªd_mode
 = cuºMB->
be°_c_imode
;

2623 
cuºMB
->
i16off£t
 = cuºMB->
be°_i16off£t
;

2624 
cuºMB
->
i16mode
 = cuºMB->
be°_i16mode
;

2625 
cuºMB
->
cbp
 = cuºMB->
be°_cbp
;

2627 if(
cuºMB
->
mb_ty≥
 =
I8MB
)

2629 
	`mem˝y
(
cuºMB
->
öåa_¥ed_modes8x8
,
cuºSli˚
->
b8_öåa_¥ed_modes8x8
, 
MB_BLOCK_PARTITIONS
 * ());

2630 
	`mem˝y
(
cuºMB
->
öåa_¥ed_modes
 ,
cuºSli˚
->
b8_öåa_¥ed_modes8x8
, 
MB_BLOCK_PARTITIONS
 * ());

2631 
j
 = 0; j < 
BLOCK_MULTIPLE
; j++)

2633 
	`mem˝y
(&
p_Vid
->
ùªdmode
 [
cuºMB
->
block_y
+
j
][cuºMB->
block_x
], 
cuºSli˚
->
b8_ùªdmode8x8
[j], 
BLOCK_MULTIPLE
 * ());

2634 
	`mem˝y
(&
p_Vid
->
ùªdmode8x8
[
cuºMB
->
block_y
+
j
][cuºMB->
block_x
], 
cuºSli˚
->
b8_ùªdmode8x8
[j], 
BLOCK_MULTIPLE
 * ());

2637 i‡(
mode
!=
I4MB
 && mode!=
I8MB
)

2639 
	`mem£t
(
cuºMB
->
öåa_¥ed_modes
,
DC_PRED
, 
MB_BLOCK_PARTITIONS
 * ());

2640 
j
 = 
cuºMB
->
block_y
; j < cuºMB->block_y + 
BLOCK_MULTIPLE
; j++)

2641 
	`mem£t
(&
p_Vid
->
ùªdmode
[
j
][
cuºMB
->
block_x
], 
DC_PRED
, 
BLOCK_MULTIPLE
 * ());

2644 i‡(
mode
 =
I4MB
)

2646 
	`mem˝y
(
cuºMB
->
öåa_¥ed_modes
,
cuºSli˚
->
b4_öåa_¥ed_modes
, 
MB_BLOCK_PARTITIONS
 * ());

2647 
j
 = 0; j < 
BLOCK_MULTIPLE
; j++)

2648 
	`mem˝y
(&
p_Vid
->
ùªdmode
[
cuºMB
->
block_y
 + 
j
][cuºMB->
block_x
],&
cuºSli˚
->
b4_ùªdmode
[
BLOCK_MULTIPLE
 * j], BLOCK_MULTIPLE * ());

2652 
cuºSli˚
->
	`£t_mŸi⁄_ve˘‹s_mb
 (
cuºMB
);

2653 
	}
}

2662 
	$£t_°‹ed_ma¸oblock_∑ømëîs_•
 (
Ma¸oblock
 *
cuºMB
)

2664 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

2665 
RDOPTSåu˘uª
 *
p_RDO
 = 
cuºSli˚
->p_RDO;

2666 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

2667 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

2669 
img≥l
 **
imgY
 = 
p_Vid
->
íc_pi˘uª
->imgY;

2670 
img≥l
 ***
imgUV
 = 
p_Vid
->
íc_pi˘uª
->imgUV;

2672 
mode
 = 
cuºMB
->
be°_mode
;

2673 
i
, 
j
, 
k
, ****
i4p
, ***
i3p
;

2674 
block_x
, 
block_y
;

2675 
PicMŸi⁄P¨ams
 **
mŸi⁄
 = 
p_Vid
->
íc_pi˘uª
->
mv_öfo
;

2680 
	`c›y_image_d©a_16x16
(&
imgY
[
cuºMB
->
pix_y
], 
p_RDO
->
ªc_mb
[0], cuºMB->
pix_x
, 0);

2682 if((
cuºSli˚
->
¶i˚_ty≥
 =
SP_SLICE
Ë&& 
p_Vid
->
•2_‰ame_ödiˇt‹
==0)

2684 
j
 = 0; j < 
MB_BLOCK_SIZE
; j++)

2685 
	`mem˝y
(&
p_Vid
->
Ãec
[
cuºMB
->
pix_y
+
j
][cuºMB->
pix_x
], 
p_RDO
->
Ãec_ªc
[j], 
MB_BLOCK_SIZE
 * ());

2688 i‡(
p_Vid
->
Ad≠tiveRoundög
)

2690 
	`upd©e_off£t_∑øms
(
cuºMB
, 
mode
, cuºMB->
ãmp_å™sf‹m_size_8x8_Êag
);

2693 i‡(
p_Vid
->
yuv_f‹m©
 !
YUV400
)

2695 
k
 = 0; k < 2; k++)

2697 
	`c›y_image_d©a
(&
imgUV
[
k
][
cuºMB
->
pix_c_y
], 
p_RDO
->
ªc_mb
[k + 1], cuºMB->
pix_c_x
, 0, 
p_Vid
->
mb_¸_size_x
,Ö_Vid->
mb_¸_size_y
);

2700 if((
cuºSli˚
->
¶i˚_ty≥
 =
SP_SLICE
Ë&& !
p_Vid
->
•2_‰ame_ödiˇt‹
)

2702 
k
 = 0; k < 2; k++)

2704 
j
 = 0; j<
p_Vid
->
mb_¸_size_y
; j++)

2706 
	`mem˝y
(&
p_Vid
->
Ãec_uv
[
k
][
cuºMB
->
pix_c_y
 + 
j
][cuºMB->
pix_c_x
], 
p_RDO
->
Ãec_ªc_uv
[k][j],Ö_Vid->
mb_¸_size_x
 * ());

2713 
i4p
 = 
p_RDO
->
cofAC
;

2714 
p_RDO
->
cofAC
 = 
cuºSli˚
->cofAC;

2715 
cuºSli˚
->
cofAC
 = 
i4p
;

2717 
i3p
 = 
p_RDO
->
cofDC
;

2718 
p_RDO
->
cofDC
 = 
cuºSli˚
->cofDC;

2719 
cuºSli˚
->
cofDC
 = 
i3p
;

2720 
cuºMB
->
cbp
 = 
p_RDO
->cbp;

2721 
cuºMB
->
cbp_blk
 = 
cuºSli˚
->
cur_cbp_blk
[0];

2722 
cuºMB
->
cbp
 |
cuºSli˚
->
cuº_cbp
[0];

2723 
cuºMB
->
cbp
 |
cuºSli˚
->
cuº_cbp
[1];

2724 
cuºSli˚
->
cmp_cbp
[1] = 
cuºMB
->
cbp
;

2725 
cuºSli˚
->
cmp_cbp
[2] = 
cuºMB
->
cbp
;

2728 
cuºMB
->
mb_ty≥
 = (Ë
mode
;

2730 
	`mem˝y
(
cuºMB
->
b8x8
, 
cuºSli˚
->
p_RDO
->
be°8x8
, 
BLOCK_MULTIPLE
 * (
Info8x8
));

2733 i‡(
mode
 =
P8x8
 && !
cuºMB
->
ãmp_å™sf‹m_size_8x8_Êag
 && 
p_I≈
->
Tønsf‹m8x8Mode
 && (cuºMB->
vÆid_8x8
 =
TRUE
))

2735 
	`Re°‹eMV8x8
(
cuºSli˚
, 1);

2739 i‡(
p_Vid
->
P444_joöed
)

2741 i‡(((
cuºMB
->
cbp
 =0Ë&& 
cuºSli˚
->
cmp_cbp
[1] =0 && cuºSli˚->cmp_cbp[2] =0Ë&& (cuºMB->
mb_ty≥
 !
I4MB
 && cuºMB->mb_ty≥ !
I8MB
))

2742 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
FALSE
;

2744 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = cuºMB->
ãmp_å™sf‹m_size_8x8_Êag
;

2749 i‡(((
cuºMB
->
cbp
 & 15Ë=0Ë&& (cuºMB->
mb_ty≥
 !
I4MB
 && cuºMB->mb_ty≥ !
I8MB
))

2750 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
FALSE
;

2752 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = cuºMB->
ãmp_å™sf‹m_size_8x8_Êag
;

2755 
cuºSli˚
->
rdd©a
->
luma_å™sf‹m_size_8x8_Êag
 = 
cuºMB
->luma_transform_size_8x8_flag;

2757 i‡(
p_I≈
->
rd›t
 == 3)

2759 
	`îrdo_gë_be°_MB
(
cuºMB
);

2763 
j
 = 0; j < 4; j++)

2765 
block_y
 = 
cuºMB
->block_y + 
j
;

2766 
i
 = 0; i < 4; i++)

2768 
block_x
 = 
cuºMB
->block_x + 
i
;

2769 
k
 = 2*(
j
 >> 1)+(
i
 >> 1);

2772 i‡((
cuºMB
->
b8x8
[
k
].
pdú
 =1Ë|| 
	`is_öåa
(currMB))

2774 
mŸi⁄
[
block_y
][
block_x
].
ªf_idx
 [
LIST_0
] = -1;

2775 
mŸi⁄
[
block_y
][
block_x
].
ªf_pic
 [
LIST_0
] = 
NULL
;

2776 
mŸi⁄
[
block_y
][
block_x
].
mv
 [
LIST_0
] = 
zîo_mv
;

2780 i‡(
cuºMB
->
b8x8
[
k
].
bùªd
 && (cuºMB->b8x8[k].
pdú
 =2Ë&& 
	`is_bùªd_íabÀd
(
p_Vid
, cuºMB->
mb_ty≥
))

2782 
mŸi⁄
[
block_y
][
block_x
].
ªf_idx
 [
LIST_0
] = 0;

2783 
mŸi⁄
[
block_y
][
block_x
].
ªf_pic
 [
LIST_0
] = 
cuºSli˚
->
li°X
[LIST_0 + 
cuºMB
->
li°_off£t
][0];

2784 
mŸi⁄
[
block_y
][
block_x
].
mv
 [
LIST_0
] = 
cuºSli˚
->
bùªd_mv
[
cuºMB
->
b8x8
[
k
].
bùªd
 - 1][LIST_0][0][(ËcuºMB->b8x8[k].
mode
][
j
][
i
];

2788 
cur_ªf
 = 
p_RDO
->
l0_ªf‰ame
[
j
][
i
];

2789 
mŸi⁄
[
block_y
][
block_x
].
ªf_idx
 [
LIST_0
] = 
cur_ªf
;

2790 
mŸi⁄
[
block_y
][
block_x
].
ªf_pic
 [
LIST_0
] = 
cuºSli˚
->
li°X
[LIST_0 + 
cuºMB
->
li°_off£t
][()
cur_ªf
];

2791 
mŸi⁄
[
block_y
][
block_x
].
mv
 [
LIST_0
] = 
cuºSli˚
->
Æl_mv
[LIST_0][()
cur_ªf
][(Ë
cuºMB
->
b8x8
[
k
].
mode
][
j
][
i
];

2796 i‡((
cuºMB
->
b8x8
[
k
].
pdú
 =0Ë|| 
	`is_öåa
(currMB))

2798 
mŸi⁄
[
block_y
][
block_x
].
ªf_idx
 [
LIST_1
] = -1;

2799 
mŸi⁄
[
block_y
][
block_x
].
ªf_pic
 [
LIST_1
] = 
NULL
;

2800 
mŸi⁄
[
block_y
][
block_x
].
mv
 [
LIST_1
] = 
zîo_mv
;

2805 i‡(
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
)

2807 
j
=0; j<4; j++)

2809 
block_y
 = 
cuºMB
->block_y + 
j
;

2810 
i
=0; i<4; i++)

2812 
block_x
 = 
cuºMB
->block_x + 
i
;

2813 
k
 = 2*(
j
 >> 1)+(
i
 >> 1);

2816 i‡(
	`is_öåa
(
cuºMB
)||(cuºMB->
b8x8
[
k
].
pdú
 == 0))

2818 
mŸi⁄
[
block_y
][
block_x
].
ªf_idx
 [
LIST_1
] = -1;

2819 
mŸi⁄
[
block_y
][
block_x
].
ªf_pic
 [
LIST_1
] = 
NULL
;

2820 
mŸi⁄
[
block_y
][
block_x
].
mv
 [
LIST_1
] = 
zîo_mv
;

2824 i‡(
cuºMB
->
b8x8
[
k
].
bùªd
 && (cuºMB->b8x8[k].
pdú
 =2Ë&& 
	`is_bùªd_íabÀd
(
p_Vid
, cuºMB->
mb_ty≥
))

2826 
mŸi⁄
[
block_y
][
block_x
].
ªf_idx
 [
LIST_1
] = 0;

2827 
mŸi⁄
[
block_y
][
block_x
].
ªf_pic
 [
LIST_1
] = 
cuºSli˚
->
li°X
[LIST_1 + 
cuºMB
->
li°_off£t
][0];

2828 
mŸi⁄
[
block_y
][
block_x
].
mv
 [
LIST_1
] = 
cuºSli˚
->
bùªd_mv
[
cuºMB
->
b8x8
[
k
].
bùªd
 - 1][LIST_1][0][(ËcuºMB->b8x8[k].
mode
][
j
][
i
];

2832 
mŸi⁄
[
block_y
][
block_x
].
ªf_idx
 [
LIST_1
] = 
p_RDO
->
l1_ªf‰ame
[
j
][
i
];

2833 
mŸi⁄
[
block_y
][
block_x
].
ªf_pic
 [
LIST_1
] = 
cuºSli˚
->
li°X
[LIST_1 + 
cuºMB
->
li°_off£t
][()
p_RDO
->
l1_ªf‰ame
[
j
][
i
]];

2834 
mŸi⁄
[
block_y
][
block_x
].
mv
 [
LIST_1
] = 
cuºSli˚
->
Æl_mv
[LIST_1][()
p_RDO
->
l1_ªf‰ame
[
j
][
i
]][(Ë
cuºMB
->
b8x8
[
k
].
mode
][j][i];

2842 
cuºMB
->
c_ùªd_mode
 = cuºMB->
be°_c_imode
;

2843 
cuºMB
->
i16off£t
 = cuºMB->
be°_i16off£t
;

2844 
cuºMB
->
i16mode
 = cuºMB->
be°_i16mode
;

2845 
cuºMB
->
cbp
 = cuºMB->
be°_cbp
;

2847 if(
cuºMB
->
mb_ty≥
 =
I8MB
)

2849 
	`mem˝y
(
cuºMB
->
öåa_¥ed_modes8x8
,
cuºSli˚
->
b8_öåa_¥ed_modes8x8
, 
MB_BLOCK_PARTITIONS
 * ());

2850 
	`mem˝y
(
cuºMB
->
öåa_¥ed_modes
 ,
cuºSli˚
->
b8_öåa_¥ed_modes8x8
, 
MB_BLOCK_PARTITIONS
 * ());

2851 
j
 = 0; j < 
BLOCK_MULTIPLE
; j++)

2853 
	`mem˝y
(&
p_Vid
->
ùªdmode
 [
cuºMB
->
block_y
+
j
][cuºMB->
block_x
], 
cuºSli˚
->
b8_ùªdmode8x8
[j], 
BLOCK_MULTIPLE
 * ());

2854 
	`mem˝y
(&
p_Vid
->
ùªdmode8x8
[
cuºMB
->
block_y
+
j
][cuºMB->
block_x
], 
cuºSli˚
->
b8_ùªdmode8x8
[j], 
BLOCK_MULTIPLE
 * ());

2857 i‡(
mode
!=
I4MB
 && mode!=
I8MB
)

2859 
	`mem£t
(
cuºMB
->
öåa_¥ed_modes
,
DC_PRED
, 
MB_BLOCK_PARTITIONS
 * ());

2860 
j
 = 
cuºMB
->
block_y
; j < cuºMB->block_y + 
BLOCK_MULTIPLE
; j++)

2861 
	`mem£t
(&
p_Vid
->
ùªdmode
[
j
][
cuºMB
->
block_x
], 
DC_PRED
, 
BLOCK_MULTIPLE
 * ());

2864 i‡(
mode
 =
I4MB
)

2866 
	`mem˝y
(
cuºMB
->
öåa_¥ed_modes
,
cuºSli˚
->
b4_öåa_¥ed_modes
, 
MB_BLOCK_PARTITIONS
 * ());

2867 
j
 = 0; j < 
BLOCK_MULTIPLE
; j++)

2868 
	`mem˝y
(&
p_Vid
->
ùªdmode
[
cuºMB
->
block_y
 + 
j
][cuºMB->
block_x
],&
cuºSli˚
->
b4_ùªdmode
[
BLOCK_MULTIPLE
 * j], BLOCK_MULTIPLE * ());

2872 
cuºSli˚
->
	`£t_mŸi⁄_ve˘‹s_mb
 (
cuºMB
);

2873 
	}
}

2882 
	$£t_ªf_™d_mŸi⁄_ve˘‹s_P_¶i˚
 (
Ma¸oblock
 *
cuºMB
, 
PicMŸi⁄P¨ams
 **
mŸi⁄
, 
Info8x8
 *
∑π
, 
block
)

2884 
mode
 = 
∑π
->mode;

2885 
j
 = 0, 
i
;

2886 
pmode
 = (
mode
==1||mode==2||mode==3 ? mode : 4);

2887 
j0
 = ((
block
 >> 1)<<1);

2888 
i0
 = ((
block
 & 0x01)<<1);

2889 
i1
 = 
i0
 + 
∑π_size
[
pmode
][0];

2890 
j1
 = 
j0
 + 
∑π_size
[
pmode
][1];

2891 
PicMŸi⁄P¨ams
 *
mv
 = 
NULL
;

2893 i‡(
∑π
->
pdú
 < 0)

2895 
j
 = 
cuºMB
->
block_y
 + 
j0
; j < cuºMB->block_y + 
j1
; j++)

2897 
i
 = 
cuºMB
->
block_x
 + 
i0
; i < cuºMB->block_x + 
i1
; i++)

2899 
mv
 = &
mŸi⁄
[
j
][
i
];

2900 
mv
->
ªf_pic
[
LIST_0
] = 
NULL
;

2901 
mv
->
ªf_pic
[
LIST_1
] = 
NULL
;

2902 
mv
->mv [
LIST_0
] = 
zîo_mv
;

2903 
mv
->mv [
LIST_1
] = 
zîo_mv
;

2904 
mv
->
ªf_idx
[
LIST_0
] = -1;

2905 
mv
->
ªf_idx
[
LIST_1
] = -1;

2912 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

2913 
block_y
;

2914 
fwªf
 = 
∑π
->
ªf
[
LIST_0
];

2915 
j
 = 
j0
; j < 
j1
; j++)

2917 
block_y
 = 
cuºMB
->block_y + 
j
;

2918 
i
 = 
i0
; i < 
i1
; i++)

2920 
mv
 = &
mŸi⁄
[
block_y
][
cuºMB
->
block_x
 + 
i
];

2921 
mv
->
ªf_pic
[
LIST_0
] = 
cuºSli˚
->
li°X
[LIST_0+
cuºMB
->
li°_off£t
][
fwªf
];;

2922 
mv
->mv [
LIST_0
] = 
cuºSli˚
->
Æl_mv
[LIST_0][
fwªf
][
mode
][
j
][
i
];

2923 
mv
->
ªf_idx
[
LIST_0
] = (Ë
fwªf
;

2928 
	}
}

2937 
	$£t_ªf_™d_mŸi⁄_ve˘‹s_B_¶i˚
 (
Ma¸oblock
 *
cuºMB
, 
PicMŸi⁄P¨ams
 **
mŸi⁄
, 
Info8x8
 *
∑π
, 
block
)

2939 
mode
 = 
∑π
->mode;

2940 
i
, 
j
=0;

2941 
pmode
 = (
mode
==1||mode==2||mode==3 ? mode : 4);

2942 
j0
 = ((
block
 >> 1)<<1);

2943 
i0
 = ((
block
 & 0x01)<<1);

2944 
i1
 = 
i0
 + 
∑π_size
[
pmode
][0];

2945 
j1
 = 
j0
 + 
∑π_size
[
pmode
][1];

2946 
PicMŸi⁄P¨ams
 *
mv
 = 
NULL
;

2948 i‡(
∑π
->
pdú
 < 0)

2950 
j
 = 
cuºMB
->
block_y
 + 
j0
; j < cuºMB->block_y + 
j1
; j++)

2952 
i
 = 
cuºMB
->
block_x
 + 
i0
; i < cuºMB->block_x + 
i1
; i++)

2954 
mv
 = &
mŸi⁄
[
j
][
i
];

2955 
mv
->
ªf_pic
[
LIST_0
] = 
NULL
;

2956 
mv
->
ªf_pic
[
LIST_1
] = 
NULL
;

2957 
mv
->mv [
LIST_0
] = 
zîo_mv
;

2958 
mv
->mv [
LIST_1
] = 
zîo_mv
;

2959 
mv
->
ªf_idx
[
LIST_0
] = -1;

2960 
mv
->
ªf_idx
[
LIST_1
] = -1;

2967 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

2968 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

2970 
block_x
, 
block_y
;

2972 i‡((
∑π
->
pdú
 == 0 ||Öart->pdir == 2))

2974 i‡(
∑π
->
bùªd
 && (∑π->
pdú
 =2Ë&& 
	`is_bùªd_íabÀd
(
p_Vid
, 
mode
))

2976 
j
=
j0
; j<
j1
; j++)

2978 
block_y
 = 
cuºMB
->block_y + 
j
;

2979 
i
=
i0
; i<
i1
; i++)

2981 
block_x
 = 
cuºMB
->block_x + 
i
;

2983 
mŸi⁄
[
block_y
][
block_x
].
mv
 [
LIST_0
] = 
cuºSli˚
->
bùªd_mv
[
∑π
->
bùªd
 - 1][LIST_0][0][
mode
][
j
][
i
];

2984 
mŸi⁄
[
block_y
][
block_x
].
ªf_idx
 [
LIST_0
] = 0;

2985 
mŸi⁄
[
block_y
][
block_x
].
ªf_pic
 [
LIST_0
] = 
cuºSli˚
->
li°X
[LIST_0 + 
cuºMB
->
li°_off£t
][0];

2991 i‡(
mode
==0)

2993 
fwªf
;

2994 
j
=
j0
; j<
j1
; j++)

2996 
block_y
 = 
cuºMB
->block_y + 
j
;

2997 
i
=
i0
; i<
i1
; i++)

2999 
block_x
 = 
cuºMB
->block_x + 
i
;

3000 
fwªf
 = 
cuºSli˚
->
dúe˘_ªf_idx
[
block_y
][
block_x
][
LIST_0
];

3001 
mŸi⁄
[
block_y
][
block_x
].
ªf_pic
[
LIST_0
] = 
cuºSli˚
->
li°X
[LIST_0 + 
cuºMB
->
li°_off£t
][
fwªf
];

3002 
mŸi⁄
[
block_y
][
block_x
].
mv
 [
LIST_0
] = 
cuºSli˚
->
Æl_mv
[LIST_0][
fwªf
][
mode
][
j
][
i
];

3003 
mŸi⁄
[
block_y
][
block_x
].
ªf_idx
[
LIST_0
] = (Ë
fwªf
;

3009 
fwªf
 = 
∑π
->
ªf
[
LIST_0
];

3010 
j
=
j0
; j<
j1
; j++)

3012 
block_y
 = 
cuºMB
->block_y + 
j
;

3013 
i
 = 
i0
; i < 
i1
; i++)

3015 
block_x
 = 
cuºMB
->block_x + 
i
;

3016 
mŸi⁄
[
block_y
][
block_x
].
ªf_pic
[
LIST_0
] = 
cuºSli˚
->
li°X
[LIST_0+
cuºMB
->
li°_off£t
][
fwªf
];

3017 
mŸi⁄
[
block_y
][
block_x
].
mv
 [
LIST_0
] = 
cuºSli˚
->
Æl_mv
[LIST_0][
fwªf
][
mode
][
j
][
i
];

3018 
mŸi⁄
[
block_y
][
block_x
].
ªf_idx
[
LIST_0
] = (Ë
fwªf
;

3026 
j
=
cuºMB
->
block_y
 + 
j0
; j < cuºMB->block_y + 
j1
; j++)

3028 
i
 = 
cuºMB
->
block_x
 + 
i0
; i < cuºMB->block_x + 
i1
; i++)

3030 
mŸi⁄
[
j
][
i
].
ªf_pic
 [
LIST_0
] = 
NULL
;

3031 
mŸi⁄
[
j
][
i
].
mv
 [
LIST_0
] = 
zîo_mv
;

3032 
mŸi⁄
[
j
][
i
].
ªf_idx
 [
LIST_0
] = -1;

3038 i‡((
∑π
->
pdú
==1 ||Öart->pdir==2))

3040 i‡(
∑π
->
bùªd
 && (∑π->
pdú
 =2Ë&& 
	`is_bùªd_íabÀd
(
p_Vid
, 
mode
))

3042 
j
=
j0
; j<
j1
; j++)

3044 
block_y
 = 
cuºMB
->block_y + 
j
;

3046 
i
=
i0
; i<
i1
; i++)

3048 
block_x
 = 
cuºMB
->block_x + 
i
;

3050 
mŸi⁄
[
block_y
][
block_x
].
mv
 [
LIST_1
] = 
cuºSli˚
->
bùªd_mv
[
∑π
->
bùªd
 - 1][LIST_1][0][
mode
][
j
][
i
];

3051 
mŸi⁄
[
block_y
][
block_x
].
ªf_idx
 [
LIST_1
] = 0;

3052 
mŸi⁄
[
block_y
][
block_x
].
ªf_pic
 [
LIST_1
] = 
cuºSli˚
->
li°X
[LIST_1+
cuºMB
->
li°_off£t
][0];

3058 i‡(
mode
==0)

3060 
bwªf
 = 
∑π
->
ªf
[
LIST_1
];

3061 
j
=
j0
; j<
j1
; j++)

3063 
block_y
 = 
cuºMB
->block_y + 
j
;

3065 
i
 = 
i0
; i < 
i1
; i++)

3067 
block_x
 = 
cuºMB
->block_x + 
i
;

3068 i‡(
bwªf
 !
cuºSli˚
->
dúe˘_ªf_idx
[
block_y
][
block_x
][
LIST_1
])

3069 
	`¥ötf
("error\n");

3070 
mŸi⁄
[
block_y
][
block_x
].
ªf_pic
 [
LIST_1
] = 
cuºSli˚
->
li°X
[LIST_1+
cuºMB
->
li°_off£t
][
bwªf
];

3071 
mŸi⁄
[
block_y
][
block_x
].
mv
 [
LIST_1
] = 
cuºSli˚
->
Æl_mv
[LIST_1][
bwªf
][
mode
][
j
][
i
];

3072 
mŸi⁄
[
block_y
][
block_x
].
ªf_idx
 [
LIST_1
] = (Ë
bwªf
;

3079 
bwªf
 = 
∑π
->
ªf
[
LIST_1
];

3080 
j
=
j0
; j<
j1
; j++)

3082 
block_y
 = 
cuºMB
->block_y + 
j
;

3083 
i
 = 
i0
; i < 
i1
; i++)

3085 
block_x
 = 
cuºMB
->block_x + 
i
;

3087 
mŸi⁄
[
block_y
][
block_x
].
ªf_pic
 [
LIST_1
] = 
cuºSli˚
->
li°X
[LIST_1+
cuºMB
->
li°_off£t
][
bwªf
];

3088 
mŸi⁄
[
block_y
][
block_x
].
mv
 [
LIST_1
] = 
cuºSli˚
->
Æl_mv
[LIST_1][
bwªf
][
mode
][
j
][
i
];

3089 
mŸi⁄
[
block_y
][
block_x
].
ªf_idx
 [
LIST_1
] = (Ë
bwªf
;

3097 
block_y
 = 
cuºMB
->block_y + 
j0
; block_y < cuºMB->block_y + 
j1
; block_y++)

3099 
block_x
 = 
cuºMB
->block_x + 
i0
; block_x < cuºMB->block_x + 
i1
; block_x++)

3101 
mŸi⁄
[
block_y
][
block_x
].
ªf_pic
[
LIST_1
] = 
NULL
;

3102 
mŸi⁄
[
block_y
][
block_x
].
mv
 [
LIST_1
] = 
zîo_mv
;

3103 
mŸi⁄
[
block_y
][
block_x
].
ªf_idx
[
LIST_1
] = -1;

3108 
	}
}

3118 
byã
 
	$fõld_Êag_ö„ªn˚
(
Ma¸oblock
 *
cuºMB
)

3120 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

3121 
byã
 
mb_fõld
;

3123 i‡(
cuºMB
->
mbAvaûA
)

3125 
mb_fõld
 = 
p_Vid
->
mb_d©a
[
cuºMB
->
mbAddrA
].mb_field;

3130 i‡(
cuºMB
->
mbAvaûB
)

3131 
mb_fõld
 = 
p_Vid
->
mb_d©a
[
cuºMB
->
mbAddrB
].mb_field;

3133 
mb_fõld
 = 0;

3136  
mb_fõld
;

3137 
	}
}

3146 
	$St‹eMVBlock8x8
(
Sli˚
 *
cuºSli˚
, 
dú
, 
block8x8
, 
mode
, 
Info8x8
 *
B8x8Info
)

3148 
RDOPTSåu˘uª
 *
p_RDO
 = 
cuºSli˚
->p_RDO;

3149 
i0
 = (
block8x8
 & 0x01) << 1;

3150 
j0
 = (
block8x8
 >> 1) << 1;

3151 
j1
 = 
j0
 + 1;

3153 
MŸi⁄Ve˘‹
 *****
Æl_mv
 = 
cuºSli˚
->all_mv;

3154 
MŸi⁄Ve˘‹
 **
lc_l0_mv8x8
 = 
p_RDO
->
Æl_mv8x8
[
dú
][
LIST_0
];

3155 
MŸi⁄Ve˘‹
 **
lc_l1_mv8x8
 = 
p_RDO
->
Æl_mv8x8
[
dú
][
LIST_1
];

3157 i‡(
cuºSli˚
->
¶i˚_ty≥
 !
B_SLICE
 )

3159 i‡(
B8x8Info
->
pdú
 >= 0)

3161 
l0_ªf
 = 
B8x8Info
->
ªf
[
LIST_0
];

3162 
	`mem˝y
(&
lc_l0_mv8x8
[
j0
][
i0
], &
Æl_mv
[
LIST_0
][
l0_ªf
][
mode
][j0][i0], 2 * (
MŸi⁄Ve˘‹
));

3163 
	`mem˝y
(&
lc_l0_mv8x8
[
j1
][
i0
], &
Æl_mv
[
LIST_0
][
l0_ªf
][
mode
][j1][i0], 2 * (
MŸi⁄Ve˘‹
));

3168 
bùªd_me
 = 
B8x8Info
->
bùªd
;

3169 
pdú8
 = 
B8x8Info
->
pdú
;

3171 i‡(
pdú8
 == 0)

3173 
l0_ªf
 = 
B8x8Info
->
ªf
[
LIST_0
];

3174 
	`mem˝y
(&
lc_l0_mv8x8
[
j0
][
i0
], &
Æl_mv
[
LIST_0
][
l0_ªf
][
mode
][j0][i0], 2 * (
MŸi⁄Ve˘‹
));

3175 
	`mem˝y
(&
lc_l0_mv8x8
[
j1
][
i0
], &
Æl_mv
[
LIST_0
][
l0_ªf
][
mode
][j1][i0], 2 * (
MŸi⁄Ve˘‹
));

3177 i‡(
pdú8
 == 1)

3179 
l1_ªf
 = 
B8x8Info
->
ªf
[
LIST_1
];

3180 
	`mem˝y
(&
lc_l1_mv8x8
[
j0
][
i0
], &
Æl_mv
[
LIST_1
][
l1_ªf
][
mode
][j0][i0], 2 * (
MŸi⁄Ve˘‹
));

3181 
	`mem˝y
(&
lc_l1_mv8x8
[
j1
][
i0
], &
Æl_mv
[
LIST_1
][
l1_ªf
][
mode
][j1][i0], 2 * (
MŸi⁄Ve˘‹
));

3183 i‡(
pdú8
==2)

3185 
l0_ªf
 = 
B8x8Info
->
ªf
[
LIST_0
];

3186 
l1_ªf
 = 
B8x8Info
->
ªf
[
LIST_1
];

3187 i‡(
bùªd_me
)

3189 
Æl_mv
 = 
cuºSli˚
->
bùªd_mv
[
bùªd_me
 - 1];

3192 
	`mem˝y
(&
lc_l0_mv8x8
[
j0
][
i0
], &
Æl_mv
[
LIST_0
][
l0_ªf
][
mode
][j0][i0], 2 * (
MŸi⁄Ve˘‹
));

3193 
	`mem˝y
(&
lc_l0_mv8x8
[
j1
][
i0
], &
Æl_mv
[
LIST_0
][
l0_ªf
][
mode
][j1][i0], 2 * (
MŸi⁄Ve˘‹
));

3194 
	`mem˝y
(&
lc_l1_mv8x8
[
j0
][
i0
], &
Æl_mv
[
LIST_1
][
l1_ªf
][
mode
][j0][i0], 2 * (
MŸi⁄Ve˘‹
));

3195 
	`mem˝y
(&
lc_l1_mv8x8
[
j1
][
i0
], &
Æl_mv
[
LIST_1
][
l1_ªf
][
mode
][j1][i0], 2 * (
MŸi⁄Ve˘‹
));

3199 
	`îr‹
("invalid direction mode", 255);

3202 
	}
}

3210 
	$St‹eMV8x8
(
Sli˚
 *
cuºSli˚
, 
dú
)

3212 
RDOPTSåu˘uª
 *
p_RDO
 = 
cuºSli˚
->p_RDO;

3213 
block8x8
;

3215 
block8x8
=0; block8x8<4; block8x8++)

3216 
	`St‹eMVBlock8x8
(
cuºSli˚
, 
dú
, 
block8x8
, 
p_RDO
->
å8x8
->
∑π
[block8x8].
mode
, &p_RDO->tr8x8->part[block8x8]);

3217 
	}
}

3225 
	$Re°‹eMVBlock8x8
(
Sli˚
 *
cuºSli˚
, 
dú
, 
block8x8
, 
RD_8x8DATA
 *
å
)

3227 
RDOPTSåu˘uª
 *
p_RDO
 = 
cuºSli˚
->p_RDO;

3228 
MŸi⁄Ve˘‹
 *****
Æl_mv
 = 
cuºSli˚
->all_mv;

3229 
MŸi⁄Ve˘‹
 **
lc_l0_mv8x8
 = 
p_RDO
->
Æl_mv8x8
[
dú
][
LIST_0
];

3230 
MŸi⁄Ve˘‹
 **
lc_l1_mv8x8
 = 
p_RDO
->
Æl_mv8x8
[
dú
][
LIST_1
];

3232 
pdú8
 = 
å
->
∑π
[
block8x8
].
pdú
;

3233 
mode
 = 
å
->
∑π
[
block8x8
].mode;

3234 
l0_ªf
 = 
å
->
∑π
[
block8x8
].
ªf
[
LIST_0
];

3235 
l1_ªf
 = 
å
->
∑π
[
block8x8
].
ªf
[
LIST_1
];

3236 
bùªd_me
 = 
å
->
∑π
[
block8x8
].
bùªd
;

3238 
i0
 = (
block8x8
 & 0x01) << 1;

3239 
j0
 = (
block8x8
 >> 1) << 1;

3240 
j1
 = 
j0
 + 1;

3242 i‡(
cuºSli˚
->
¶i˚_ty≥
 !
B_SLICE
)

3244 i‡(
pdú8
>=0)

3246 
	`mem˝y
(&
Æl_mv
[
LIST_0
][
l0_ªf
][4][
j0
][
i0
], &
lc_l0_mv8x8
[j0][i0], 2 * (
MŸi⁄Ve˘‹
));

3247 
	`mem˝y
(&
Æl_mv
[
LIST_0
][
l0_ªf
][4][
j1
][
i0
], &
lc_l0_mv8x8
[j1][i0], 2 * (
MŸi⁄Ve˘‹
));

3252 i‡(
pdú8
==0)

3254 
	`mem˝y
(&
Æl_mv
[
LIST_0
][
l0_ªf
][
mode
][
j0
][
i0
], &
lc_l0_mv8x8
[j0][i0], 2 * (
MŸi⁄Ve˘‹
));

3255 
	`mem˝y
(&
Æl_mv
[
LIST_0
][
l0_ªf
][
mode
][
j1
][
i0
], &
lc_l0_mv8x8
[j1][i0], 2 * (
MŸi⁄Ve˘‹
));

3257 i‡(
pdú8
==1)

3259 
	`mem˝y
(&
Æl_mv
[
LIST_1
][
l1_ªf
][
mode
][
j0
][
i0
], &
lc_l1_mv8x8
[j0][i0], 2 * (
MŸi⁄Ve˘‹
));

3260 
	`mem˝y
(&
Æl_mv
[
LIST_1
][
l1_ªf
][
mode
][
j1
][
i0
], &
lc_l1_mv8x8
[j1][i0], 2 * (
MŸi⁄Ve˘‹
));

3262 i‡(
pdú8
==2)

3264 if(
bùªd_me
)

3266 
Æl_mv
 = 
cuºSli˚
->
bùªd_mv
[
bùªd_me
 - 1];

3269 
	`mem˝y
(&
Æl_mv
[
LIST_0
][
l0_ªf
][
mode
][
j0
][
i0
], &
lc_l0_mv8x8
[j0][i0], 2 * (
MŸi⁄Ve˘‹
));

3270 
	`mem˝y
(&
Æl_mv
[
LIST_0
][
l0_ªf
][
mode
][
j1
][
i0
], &
lc_l0_mv8x8
[j1][i0], 2 * (
MŸi⁄Ve˘‹
));

3271 
	`mem˝y
(&
Æl_mv
[
LIST_1
][
l1_ªf
][
mode
][
j0
][
i0
], &
lc_l1_mv8x8
[j0][i0], 2 * (
MŸi⁄Ve˘‹
));

3272 
	`mem˝y
(&
Æl_mv
[
LIST_1
][
l1_ªf
][
mode
][
j1
][
i0
], &
lc_l1_mv8x8
[j1][i0], 2 * (
MŸi⁄Ve˘‹
));

3276 
	`îr‹
("invalid direction mode", 255);

3279 
	}
}

3287 
	$Re°‹eMV8x8
(
Sli˚
 *
cuºSli˚
, 
dú
)

3289 
RDOPTSåu˘uª
 *
p_RDO
 = 
cuºSli˚
->p_RDO;

3290 
block8x8
;

3292 
block8x8
=0; block8x8<4; block8x8++)

3293 
	`Re°‹eMVBlock8x8
(
cuºSli˚
, 
dú
, 
block8x8
, 
p_RDO
->
å8x8
);

3294 
	}
}

3303 
	$St‹eNewMŸi⁄Ve˘‹sBlock8x8
(
Sli˚
 *
cuºSli˚
, 
dú
, 
block8x8
, 
Info8x8
 *
B8x8Info
)

3305 
RDOPTSåu˘uª
 *
p_RDO
 = 
cuºSli˚
->p_RDO;

3306 
mode
 = 
B8x8Info
->mode;

3307 
i0
 = (
block8x8
 & 0x01) << 1;

3308 
j0
 = (
block8x8
 >> 1) << 1;

3309 
j1
 = 
j0
 + 1;

3311 
MŸi⁄Ve˘‹
 ****
Æl_mv_l0
 = 
cuºSli˚
->
Æl_mv
[
LIST_0
];

3312 
MŸi⁄Ve˘‹
 ****
Æl_mv_l1
 = 
cuºSli˚
->
Æl_mv
[
LIST_1
];

3313 
MŸi⁄Ve˘‹
 **
lc_l0_mv8x8
 = &
p_RDO
->
Æl_mv8x8
[
dú
][
LIST_0
][
j0
];

3314 
MŸi⁄Ve˘‹
 **
lc_l1_mv8x8
 = &
p_RDO
->
Æl_mv8x8
[
dú
][
LIST_1
][
j0
];

3317 i‡(
B8x8Info
->
pdú
 < 0)

3319 
	`mem£t
(&
lc_l0_mv8x8
[0][
i0
], 0, 2 * (
MŸi⁄Ve˘‹
));

3320 
	`mem£t
(&
lc_l0_mv8x8
[1][
i0
], 0, 2 * (
MŸi⁄Ve˘‹
));

3321 
	`mem£t
(&
lc_l1_mv8x8
[0][
i0
], 0, 2 * (
MŸi⁄Ve˘‹
));

3322 
	`mem£t
(&
lc_l1_mv8x8
[1][
i0
], 0, 2 * (
MŸi⁄Ve˘‹
));

3326 i‡(
cuºSli˚
->
¶i˚_ty≥
 !
B_SLICE
)

3328 
l0_ªf
 = 
B8x8Info
->
ªf
[
LIST_0
];

3329 
	`mem˝y
(&
lc_l0_mv8x8
[0][
i0
], &
Æl_mv_l0
[
l0_ªf
][
mode
][
j0
][i0], 2 * (
MŸi⁄Ve˘‹
));

3330 
	`mem˝y
(&
lc_l0_mv8x8
[1][
i0
], &
Æl_mv_l0
[
l0_ªf
][
mode
][
j1
][i0], 2 * (
MŸi⁄Ve˘‹
));

3331 
	`mem£t
(&
lc_l1_mv8x8
[0][
i0
], 0, 2 * (
MŸi⁄Ve˘‹
));

3332 
	`mem£t
(&
lc_l1_mv8x8
[1][
i0
], 0, 2 * (
MŸi⁄Ve˘‹
));

3337 
bùªd_me
 = 
B8x8Info
->
bùªd
;

3338 
pdú8
 = 
B8x8Info
->
pdú
;

3339 i‡(
bùªd_me
)

3341 
Æl_mv_l0
 = 
cuºSli˚
->
bùªd_mv
[
bùªd_me
 - 1][
LIST_0
];

3342 
Æl_mv_l1
 = 
cuºSli˚
->
bùªd_mv
[
bùªd_me
 - 1][
LIST_1
];

3345 i‡((
pdú8
==0 ||Ödir8==2))

3347 
l0_ªf
 = 
B8x8Info
->
ªf
[
LIST_0
];

3348 
	`mem˝y
(&
lc_l0_mv8x8
[0][
i0
], &
Æl_mv_l0
[
l0_ªf
][
mode
][
j0
][i0], 2 * (
MŸi⁄Ve˘‹
));

3349 
	`mem˝y
(&
lc_l0_mv8x8
[1][
i0
], &
Æl_mv_l0
[
l0_ªf
][
mode
][
j1
][i0], 2 * (
MŸi⁄Ve˘‹
));

3353 
	`mem£t
(&
lc_l0_mv8x8
[0][
i0
], 0, 2 * (
MŸi⁄Ve˘‹
));

3354 
	`mem£t
(&
lc_l0_mv8x8
[1][
i0
], 0, 2 * (
MŸi⁄Ve˘‹
));

3357 i‡((
pdú8
==1 ||Ödir8==2))

3359 
l1_ªf
 = 
B8x8Info
->
ªf
[
LIST_1
];

3360 
	`mem˝y
(&
lc_l1_mv8x8
[0][
i0
], &
Æl_mv_l1
[
l1_ªf
][
mode
][
j0
][i0], 2 * (
MŸi⁄Ve˘‹
));

3361 
	`mem˝y
(&
lc_l1_mv8x8
[1][
i0
], &
Æl_mv_l1
[
l1_ªf
][
mode
][
j1
][i0], 2 * (
MŸi⁄Ve˘‹
));

3365 
	`mem£t
(&
lc_l1_mv8x8
[0][
i0
], 0, 2 * (
MŸi⁄Ve˘‹
));

3366 
	`mem£t
(&
lc_l1_mv8x8
[1][
i0
], 0, 2 * (
MŸi⁄Ve˘‹
));

3369 
	}
}

3378 
	$°‹e_8x8_mŸi⁄_ve˘‹s_p_¶i˚
(
Sli˚
 *
cuºSli˚
, 
dú
, 
block8x8
, 
Info8x8
 *
B8x8Info
)

3380 
RDOPTSåu˘uª
 *
p_RDO
 = 
cuºSli˚
->p_RDO;

3382 
i0
 = (
block8x8
 & 0x01) << 1;

3383 
j0
 = (
block8x8
 >> 1) << 1;

3385 
MŸi⁄Ve˘‹
 **
lc_l0_mv8x8
 = &
p_RDO
->
Æl_mv8x8
[
dú
][
LIST_0
][
j0
];

3386 
MŸi⁄Ve˘‹
 **
lc_l1_mv8x8
 = &
p_RDO
->
Æl_mv8x8
[
dú
][
LIST_1
][
j0
];

3388 i‡(
B8x8Info
->
pdú
 < 0)

3390 
	`mem£t
(&
lc_l0_mv8x8
[0][
i0
], 0, 2 * (
MŸi⁄Ve˘‹
));

3391 
	`mem£t
(&
lc_l0_mv8x8
[1][
i0
], 0, 2 * (
MŸi⁄Ve˘‹
));

3392 
	`mem£t
(&
lc_l1_mv8x8
[0][
i0
], 0, 2 * (
MŸi⁄Ve˘‹
));

3393 
	`mem£t
(&
lc_l1_mv8x8
[1][
i0
], 0, 2 * (
MŸi⁄Ve˘‹
));

3397 
j1
 = 
j0
 + 1;

3398 
MŸi⁄Ve˘‹
 **
Æl_mv_l0
 = 
cuºSli˚
->
Æl_mv
[
LIST_0
][(Ë
B8x8Info
->
ªf
[LIST_0]][()B8x8Info->
mode
];

3399 
	`mem˝y
(&
lc_l0_mv8x8
[0][
i0
], &
Æl_mv_l0
[
j0
][i0], 2 * (
MŸi⁄Ve˘‹
));

3400 
	`mem˝y
(&
lc_l0_mv8x8
[1][
i0
], &
Æl_mv_l0
[
j1
][i0], 2 * (
MŸi⁄Ve˘‹
));

3401 
	`mem£t
(&
lc_l1_mv8x8
[0][
i0
], 0, 2 * (
MŸi⁄Ve˘‹
));

3402 
	`mem£t
(&
lc_l1_mv8x8
[1][
i0
], 0, 2 * (
MŸi⁄Ve˘‹
));

3404 
	}
}

3413 
	$°‹e_8x8_mŸi⁄_ve˘‹s_b_¶i˚
(
Sli˚
 *
cuºSli˚
, 
dú
, 
block8x8
, 
Info8x8
 *
B8x8Info
)

3415 
RDOPTSåu˘uª
 *
p_RDO
 = 
cuºSli˚
->p_RDO;

3416 
i0
 = (
block8x8
 & 0x01) << 1;

3417 
j0
 = (
block8x8
 >> 1) << 1;

3419 
MŸi⁄Ve˘‹
 **
lc_l0_mv8x8
 = &
p_RDO
->
Æl_mv8x8
[
dú
][
LIST_0
][
j0
];

3420 
MŸi⁄Ve˘‹
 **
lc_l1_mv8x8
 = &
p_RDO
->
Æl_mv8x8
[
dú
][
LIST_1
][
j0
];

3422 i‡(
B8x8Info
->
pdú
 < 0)

3424 
	`mem£t
(&
lc_l0_mv8x8
[0][
i0
], 0, 2 * (
MŸi⁄Ve˘‹
));

3425 
	`mem£t
(&
lc_l0_mv8x8
[1][
i0
], 0, 2 * (
MŸi⁄Ve˘‹
));

3426 
	`mem£t
(&
lc_l1_mv8x8
[0][
i0
], 0, 2 * (
MŸi⁄Ve˘‹
));

3427 
	`mem£t
(&
lc_l1_mv8x8
[1][
i0
], 0, 2 * (
MŸi⁄Ve˘‹
));

3431 
mode
 = 
B8x8Info
->mode;

3432 
j1
 = 
j0
 + 1;

3433 
MŸi⁄Ve˘‹
 ****
Æl_mv_l0
 = 
cuºSli˚
->
Æl_mv
[
LIST_0
];

3434 
MŸi⁄Ve˘‹
 ****
Æl_mv_l1
 = 
cuºSli˚
->
Æl_mv
[
LIST_1
];

3436 
bùªd_me
 = 
B8x8Info
->
bùªd
;

3437 
pdú8
 = 
B8x8Info
->
pdú
;

3438 i‡(
bùªd_me
)

3440 
Æl_mv_l0
 = 
cuºSli˚
->
bùªd_mv
[
bùªd_me
 - 1][
LIST_0
];

3441 
Æl_mv_l1
 = 
cuºSli˚
->
bùªd_mv
[
bùªd_me
 - 1][
LIST_1
];

3444 i‡((
pdú8
==0 ||Ödir8==2))

3446 
l0_ªf
 = 
B8x8Info
->
ªf
[
LIST_0
];

3447 
	`mem˝y
(&
lc_l0_mv8x8
[0][
i0
], &
Æl_mv_l0
[
l0_ªf
][
mode
][
j0
][i0], 2 * (
MŸi⁄Ve˘‹
));

3448 
	`mem˝y
(&
lc_l0_mv8x8
[1][
i0
], &
Æl_mv_l0
[
l0_ªf
][
mode
][
j1
][i0], 2 * (
MŸi⁄Ve˘‹
));

3452 
	`mem£t
(&
lc_l0_mv8x8
[0][
i0
], 0, 2 * (
MŸi⁄Ve˘‹
));

3453 
	`mem£t
(&
lc_l0_mv8x8
[1][
i0
], 0, 2 * (
MŸi⁄Ve˘‹
));

3456 i‡((
pdú8
==1 ||Ödir8==2))

3458 
l1_ªf
 = 
B8x8Info
->
ªf
[
LIST_1
];

3459 
	`mem˝y
(&
lc_l1_mv8x8
[0][
i0
], &
Æl_mv_l1
[
l1_ªf
][
mode
][
j0
][i0], 2 * (
MŸi⁄Ve˘‹
));

3460 
	`mem˝y
(&
lc_l1_mv8x8
[1][
i0
], &
Æl_mv_l1
[
l1_ªf
][
mode
][
j1
][i0], 2 * (
MŸi⁄Ve˘‹
));

3464 
	`mem£t
(&
lc_l1_mv8x8
[0][
i0
], 0, 2 * (
MŸi⁄Ve˘‹
));

3465 
	`mem£t
(&
lc_l1_mv8x8
[1][
i0
], 0, 2 * (
MŸi⁄Ve˘‹
));

3468 
	}
}

3477 
	$£t_mbaff_∑ømëîs
(
Ma¸oblock
 *
cuºMB
)

3479 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

3480 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

3481 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

3483 
j
, 
i
;

3484 
mode
 = 
cuºMB
->
be°_mode
;

3485 **
ùªdmodes
 = 
p_Vid
->
ùªdmode
;

3486 
PicMŸi⁄P¨ams
 **
mŸi⁄
 = 
p_Vid
->
íc_pi˘uª
->
mv_öfo
;

3487 
RD_DATA
 *
rd›t
 = 
cuºSli˚
->
rdd©a
;

3491 
	`c›y_image_d©a_16x16
(
rd›t
->
ªc_mb
[0], &
p_Vid
->
íc_pi˘uª
->
imgY
[
cuºMB
->
pix_y
], 0, cuºMB->
pix_x
);

3493 i‡(
p_Vid
->
yuv_f‹m©
 !
YUV400
)

3495 
	`c›y_image_d©a
(
rd›t
->
ªc_mb
[1], &
p_Vid
->
íc_pi˘uª
->
imgUV
[0][
cuºMB
->
pix_c_y
], 0, cuºMB->
pix_c_x
,Ö_Vid->
mb_¸_size_x
,Ö_Vid->
mb_¸_size_y
);

3496 
	`c›y_image_d©a
(
rd›t
->
ªc_mb
[2], &
p_Vid
->
íc_pi˘uª
->
imgUV
[1][
cuºMB
->
pix_c_y
], 0, cuºMB->
pix_c_x
,Ö_Vid->
mb_¸_size_x
,Ö_Vid->
mb_¸_size_y
);

3500 
rd›t
->
mode
 = mode;

3501 
rd›t
->
i16off£t
 = 
cuºMB
->i16offset;

3502 
rd›t
->
i16mode
 = 
cuºMB
->i16mode;

3503 
rd›t
->
cbp
 = 
cuºMB
->cbp;

3504 
rd›t
->
cbp_blk
 = 
cuºMB
->cbp_blk;

3505 
rd›t
->
mb_ty≥
 = 
cuºMB
->mb_type;

3507 
rd›t
->
luma_å™sf‹m_size_8x8_Êag
 = 
cuºMB
->luma_transform_size_8x8_flag;

3509 if(
rd›t
->
mb_ty≥
 =0 && 
mode
 != 0)

3511 
mode
=0;

3512 
rd›t
->
mode
=0;

3515 
	`mem˝y
(
rd›t
->
cofAC
[0][0][0], 
cuºSli˚
->cofAC[0][0][0], (4+
p_Vid
->
num_blk8x8_uv
) * 4 * 2 * 65 * ());

3516 
	`mem˝y
(
rd›t
->
cofDC
[0][0], 
cuºSli˚
->cofDC[0][0], 3 * 2 * 18 * ());

3518 
	`mem˝y
(
rd›t
->
b8x8
, 
cuºMB
->b8x8, 
BLOCK_MULTIPLE
 * (
Info8x8
));

3521 i‡(
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
)

3523 i‡(
p_I≈
->
BiPªdMEReföemíts
 == 1)

3525 
k
;

3526 
j
 = 0; j < 
BLOCK_MULTIPLE
; j++)

3528 
i
 = 0; i < 
BLOCK_MULTIPLE
; i++)

3530 
k
 = 2*(
j
 >> 1)+(
i
 >> 1);

3531 i‡(
cuºMB
->
b8x8
[
k
].
bùªd
 == 0)

3533 
rd›t
->
ªÁr
[
LIST_0
][
j
][
i
] = 
mŸi⁄
[
cuºMB
->
block_y
 + j][cuºMB->
block_x
 + i].
ªf_idx
[LIST_0];

3534 
rd›t
->
ªÁr
[
LIST_1
][
j
][
i
] = 
mŸi⁄
[
cuºMB
->
block_y
 + j][cuºMB->
block_x
 + i].
ªf_idx
[LIST_1];

3538 
rd›t
->
ªÁr
[
LIST_0
][
j
][
i
] = 0;

3539 
rd›t
->
ªÁr
[
LIST_1
][
j
][
i
] = 0;

3546 
j
 = 0; j < 
BLOCK_MULTIPLE
; j++)

3548 
i
 = 0; i < 
BLOCK_MULTIPLE
; i++)

3550 
rd›t
->
ªÁr
[
LIST_0
][
j
][
i
] = 
mŸi⁄
[
cuºMB
->
block_y
 + j][cuºMB->
block_x
 + i].
ªf_idx
[LIST_0];

3551 
rd›t
->
ªÁr
[
LIST_1
][
j
][
i
] = 
mŸi⁄
[
cuºMB
->
block_y
 + j][cuºMB->
block_x
 + i].
ªf_idx
[LIST_1];

3558 
j
 = 0; j < 
BLOCK_MULTIPLE
; j++)

3560 
i
 = 0; i < 
BLOCK_MULTIPLE
; i++)

3562 
rd›t
->
ªÁr
[
LIST_0
][
j
][
i
] = 
mŸi⁄
[
cuºMB
->
block_y
 + j][cuºMB->
block_x
 + i].
ªf_idx
[LIST_0];

3568 
	`mem˝y
(
rd›t
->
öåa_¥ed_modes
, 
cuºMB
->öåa_¥ed_modes, 
MB_BLOCK_PARTITIONS
 * ());

3569 
	`mem˝y
(
rd›t
->
öåa_¥ed_modes8x8
,
cuºMB
->öåa_¥ed_modes8x8, 
MB_BLOCK_PARTITIONS
 * ());

3570 
j
 = 
cuºMB
->
block_y
; j < currMB->block_y + 4; j++)

3572 
	`mem˝y
(&
rd›t
->
ùªdmode
[
j
][
cuºMB
->
block_x
],&
ùªdmodes
[j][cuºMB->block_x], 
BLOCK_MULTIPLE
 * ());

3574 
	}
}

3577 
	$assign_íc_pi˘uª_∑øms
 (
Ma¸oblock
 *
cuºMB
, 
mode
, 
Info8x8
 *
be°
, 
block
)

3579 
i
,
j
;

3580 
block_y
, 
block_x
;

3581 
li°
;

3582 
MŸi⁄Ve˘‹
 **
cuº_mv
 = 
NULL
;

3583 
li°_off£t
 = 
cuºMB
->list_offset;

3584 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

3585 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

3586 
PicMŸi⁄P¨ams
 **
mŸi⁄
 = 
p_Vid
->
íc_pi˘uª
->
mv_öfo
;

3587 
maxli°
 = (
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
) ? 1: 0;

3588 
St‹abÀPi˘uª
 *
li°X
 = 
NULL
;

3590 
°¨t_x
 = 0, 
°¨t_y
 = 0, 
íd_x
 = 
BLOCK_MULTIPLE
, 
íd_y
 = BLOCK_MULTIPLE;

3592 
mode
)

3595 
°¨t_x
 = 0;

3596 
°¨t_y
 = 0;

3597 
íd_x
 = 
BLOCK_MULTIPLE
;

3598 
íd_y
 = 
BLOCK_MULTIPLE
;

3601 
°¨t_x
 = 0;

3602 
°¨t_y
 = 
block
;

3603 
íd_x
 = 
BLOCK_MULTIPLE
;

3604 
íd_y
 = 
block
 + 2;

3607 
°¨t_x
 = 
block
;

3608 
°¨t_y
 = 0;

3609 
íd_x
 = 
block
 + 2;

3610 
íd_y
 = 
BLOCK_MULTIPLE
;

3614 
°¨t_x
 = ((
block
>>1) & 0x01)* 2;

3615 
°¨t_y
 = ((
block
>>1) & 0x02);

3616 
íd_x
 = 
°¨t_x
 + 2;

3617 
íd_y
 = 
°¨t_y
 + 2;

3621 
li°
 = 0;Üi° <
maxli°
;Üist++)

3623 i‡((
be°
->
pdú
 !2Ë&& (be°->pdú !
li°
))

3625 
j
 = 
cuºMB
->
block_y
 + 
°¨t_y
; j < cuºMB->block_y + 
íd_y
; j++)

3627 
i
 = 
cuºMB
->
block_x
 + 
°¨t_x
; i < cuºMB->block_x + 
íd_x
; i++)

3629 
mŸi⁄
[
j
][
i
].
ªf_pic
[
li°
] = 
NULL
;

3630 
mŸi⁄
[
j
][
i
].
mv
[
li°
] = 
zîo_mv
;

3631 
mŸi⁄
[
j
][
i
].
ªf_idx
[
li°
] = - 1;

3637 
be°
->
bùªd
)

3641 
be°ªf
 = 
be°
->
ªf
[
li°
];

3642 
cuº_mv
 = 
cuºSli˚
->
Æl_mv
[
li°
][
be°ªf
][
mode
];

3643 
li°X
 = 
cuºSli˚
->li°X[
li°
 + 
li°_off£t
][
be°ªf
];

3647 
cuº_mv
 = 
cuºSli˚
->
bùªd_mv
[0][
li°
][0][
mode
] ;

3648 
li°X
 = 
cuºSli˚
->li°X[
li°
 + 
li°_off£t
][0];

3651 
cuº_mv
 = 
cuºSli˚
->
bùªd_mv
[1][
li°
][0][
mode
] ;

3652 
li°X
 = 
cuºSli˚
->li°X[
li°
 + 
li°_off£t
][0];

3658 
j
 = 
°¨t_y
; j < 
íd_y
; j++)

3660 
block_y
 = 
cuºMB
->block_y + 
j
;

3661 
i
 = 
°¨t_x
; i < 
íd_x
; i++)

3663 
block_x
 = 
cuºMB
->block_x + 
i
;

3664 
mŸi⁄
[
block_y
][
block_x
].
ªf_pic
 [
li°
] = 
li°X
;

3665 
mŸi⁄
[
block_y
][
block_x
].
mv
 [
li°
] = 
cuº_mv
[
j
][
i
];

3670 
	}
}

3678 
	$£t_block8x8_öfo
(
Block8x8Info
 *
b8x8öfo
, 
mode
, 
block
, 
Info8x8
 *
be°
)

3681 i‡(
mode
==3)

3683 
b8x8öfo
->
be°
[3][
block
 ] = *best;

3684 
b8x8öfo
->
be°
[3][
block
+2] = *best;

3686 i‡(
mode
==2)

3688 
b8x8öfo
->
be°
[2][2*
block
 ] = *best;

3689 
b8x8öfo
->
be°
[2][2*
block
 + 1] = *best;

3691 i‡(
mode
==1)

3693 
b8x8öfo
->
be°
[1][0] = *best;

3694 
b8x8öfo
->
be°
[1][1] = *best;

3695 
b8x8öfo
->
be°
[1][2] = *best;

3696 
b8x8öfo
->
be°
[1][3] = *best;

3701 
b8x8öfo
->
be°
[
mode
][
block
] = *best;

3703 
	}
}

3711 
	$£t_subblock8x8_öfo
(
Block8x8Info
 *
b8x8öfo
,
mode
, 
block
, 
RD_8x8DATA
 *
å
)

3713 
b8x8öfo
->
be°
 [
mode
][
block
] = 
å
->
∑π
[block];

3714 
	}
}

3718 
	$upd©e_ª‰esh_m≠
(
Ma¸oblock
 *
cuºMB
, 
öåa
, 
öåa1
)

3720 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

3721 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

3723 i‡(
p_I≈
->
Re°ri˘Ref
==1)

3726 i‡(
p_I≈
->
rd›t
<2)

3728 
p_Vid
->
ª‰esh_m≠
[2*
cuºMB
->
mb_y
 ][2*cuºMB->
mb_x
 ] = (
byã
Ë(
öåa
 ? 1 : 0);

3729 
p_Vid
->
ª‰esh_m≠
[2*
cuºMB
->
mb_y
 ][2*cuºMB->
mb_x
+1] = (
byã
Ë(
öåa
 ? 1 : 0);

3730 
p_Vid
->
ª‰esh_m≠
[2*
cuºMB
->
mb_y
 + 1][2*cuºMB->
mb_x
 ] = (
byã
Ë(
öåa
 ? 1 : 0);

3731 
p_Vid
->
ª‰esh_m≠
[2*
cuºMB
->
mb_y
 + 1][2*cuºMB->
mb_x
+1] = (
byã
Ë(
öåa
 ? 1 : 0);

3733 i‡(
p_I≈
->
rd›t
 == 3)

3735 
p_Vid
->
ª‰esh_m≠
[2*
cuºMB
->
mb_y
 ][2*cuºMB->
mb_x
 ] = (
byã
Ë(
öåa1
==0 && (cuºMB->
mb_ty≥
==
I16MB
 || cuºMB->mb_ty≥==
I4MB
) ? 1 : 0);

3736 
p_Vid
->
ª‰esh_m≠
[2*
cuºMB
->
mb_y
 ][2*cuºMB->
mb_x
+1] = (
byã
Ë(
öåa1
==0 && (cuºMB->
mb_ty≥
==
I16MB
 || cuºMB->mb_ty≥==
I4MB
) ? 1 : 0);

3737 
p_Vid
->
ª‰esh_m≠
[2*
cuºMB
->
mb_y
 + 1][2*cuºMB->
mb_x
 ] = (
byã
Ë(
öåa1
==0 && (cuºMB->
mb_ty≥
==
I16MB
 || cuºMB->mb_ty≥==
I4MB
) ? 1 : 0);

3738 
p_Vid
->
ª‰esh_m≠
[2*
cuºMB
->
mb_y
 + 1][2*cuºMB->
mb_x
+1] = (
byã
Ë(
öåa1
==0 && (cuºMB->
mb_ty≥
==
I16MB
 || cuºMB->mb_ty≥==
I4MB
) ? 1 : 0);

3741 i‡(
p_I≈
->
Re°ri˘Ref
==2)

3743 
p_Vid
->
ª‰esh_m≠
[2*
cuºMB
->
mb_y
 ][2*cuºMB->
mb_x
 ] = (
byã
Ë(cuºMB->
mb_ty≥
==
I16MB
 || cuºMB->mb_ty≥==
I4MB
 ? 1 : 0);

3744 
p_Vid
->
ª‰esh_m≠
[2*
cuºMB
->
mb_y
 ][2*cuºMB->
mb_x
+1] = (
byã
Ë(cuºMB->
mb_ty≥
==
I16MB
 || cuºMB->mb_ty≥==
I4MB
 ? 1 : 0);

3745 
p_Vid
->
ª‰esh_m≠
[2*
cuºMB
->
mb_y
 + 1][2*cuºMB->
mb_x
 ] = (
byã
Ë(cuºMB->
mb_ty≥
==
I16MB
 || cuºMB->mb_ty≥==
I4MB
 ? 1 : 0);

3746 
p_Vid
->
ª‰esh_m≠
[2*
cuºMB
->
mb_y
 + 1][2*cuºMB->
mb_x
+1] = (
byã
Ë(cuºMB->
mb_ty≥
==
I16MB
 || cuºMB->mb_ty≥==
I4MB
 ? 1 : 0);

3748 
	}
}

3750 
	$vÆid_öåa_mode
(
Sli˚
 *
cuºSli˚
, 
ùmode
)

3752 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºSli˚
->p_Inp;

3754 i‡(
p_I≈
->
I¡øDißbÀI¡îO∆y
==0 || (
cuºSli˚
->
¶i˚_ty≥
 !
I_SLICE
 && cuºSli˚->¶i˚_ty≥ !
SI_SLICE
))

3756 i‡(
p_I≈
->
I¡ø4x4P¨DißbÀ
 && (
ùmode
==
VERT_PRED
||ùmode==
HOR_PRED
))

3759 i‡(
p_I≈
->
I¡ø4x4DügDißbÀ
 && (
ùmode
==
DIAG_DOWN_LEFT_PRED
||ùmode==
DIAG_DOWN_RIGHT_PRED
))

3762 i‡(
p_I≈
->
I¡ø4x4DúDißbÀ
 && 
ùmode
>=
VERT_RIGHT_PRED
)

3766 
	}
}

3768 
di°blk
 
	$compuã_ßd4x4_co°
(
VideoP¨amëîs
 *
p_Vid
, 
img≥l
 **
cur_img
, img≥»**
¥d_img
, 
pic_›ix_x
, 
di°blk
 
mö_co°
)

3770 
img≥l
 *
cur_löe
, *
¥d_löe
;

3771 
i32Co°
 = 0;

3772 
imö_co°
 = 
	`di°_down
(
mö_co°
);

3774 
j
;

3775 
j
 = 0; j < 
BLOCK_SIZE
; j++)

3777 
cur_löe
 = &
cur_img
[
j
][
pic_›ix_x
];

3778 
¥d_löe
 = 
¥d_img
[
j
];

3780 
i32Co°
 +
	`übs
(
cur_löe
[0] - 
¥d_löe
[0]);

3781 
i32Co°
 +
	`übs
(
cur_löe
[1] - 
¥d_löe
[1]);

3782 
i32Co°
 +
	`übs
(
cur_löe
[2] - 
¥d_löe
[2]);

3783 
i32Co°
 +
	`übs
(
cur_löe
[3] - 
¥d_löe
[3]);

3785 i‡(
i32Co°
 > 
imö_co°
)

3787 (
mö_co°
);

3790  
	`di°_sˇÀ
(
i32Co°
);

3791 
	}
}

3793 
di°blk
 
	$compuã_s£4x4_co°
(
VideoP¨amëîs
 *
p_Vid
, 
img≥l
 **
cur_img
, img≥»**
¥d_img
, 
pic_›ix_x
, 
di°blk
 
mö_co°
)

3795 
j
, 
i
;

3796 
img≥l
 *
cur_löe
, *
¥d_löe
;

3797 
i32Co°
 = 0;

3798 
imö_co°
 = 
	`di°_down
(
mö_co°
);

3799 
j
 = 0; j < 
BLOCK_SIZE
; j++)

3801 
cur_löe
 = &
cur_img
[
j
][
pic_›ix_x
];

3802 
¥d_löe
 = 
¥d_img
[
j
];

3803 
i
 = 0; i < 
BLOCK_SIZE
; i++)

3805 
i32Co°
 +
	`übs2
(*
cur_löe
++ - *
¥d_löe
++);

3808 i‡(
i32Co°
 > 
imö_co°
)

3810 (
mö_co°
);

3813  
	`di°_sˇÀ
(
i32Co°
);

3814 
	}
}

3816 
di°blk
 
	$compuã_ßtd4x4_co°
(
VideoP¨amëîs
 *
p_Vid
, 
img≥l
 **
cur_img
, img≥»**
¥d_img
, 
pic_›ix_x
, 
di°blk
 
mö_co°
)

3818 
j
, 
i
;

3819 
img≥l
 *
cur_löe
, *
¥d_löe
;

3820 
diff
[16];

3822 *
d
 = &
diff
[0];

3824 
j
 = 0; j < 
BLOCK_SIZE
; j++)

3826 
cur_löe
 = &
cur_img
[
j
][
pic_›ix_x
];

3827 
¥d_löe
 = 
¥d_img
[
j
];

3829 
i
 = 0; i < 
BLOCK_SIZE
; i++)

3831 *
d
++ = *
cur_löe
++ - *
¥d_löe
++;

3835  
	`di°_sˇÀ
(
	`Hadam¨dSAD4x4
 (
diff
));

3836 
	}
}

3838 
di°blk
 
	$compuã_comp4x4_co°
(
VideoP¨amëîs
 *
p_Vid
, 
img≥l
 **
cur_img
, img≥»**
¥d_img
, 
pic_›ix_x
, 
di°blk
 
mö_co°
)

3840 
j
, 
i
;

3841 
img≥l
 *
cur_löe
, *
¥d_löe
;

3842 
diff
[16];

3844 *
d
 = &
diff
[0];

3846 
j
 = 0; j < 
BLOCK_SIZE
; j++)

3848 
cur_löe
 = &
cur_img
[
j
][
pic_›ix_x
];

3849 
¥d_löe
 = 
¥d_img
[
j
];

3851 
i
 = 0; i < 
BLOCK_SIZE
; i++)

3853 *
d
++ = *
cur_löe
++ - *
¥d_löe
++;

3856 (
p_Vid
->
	`di°‹ti⁄4x4
 (
diff
, 
mö_co°
));

3857 
	}
}

3861 
	$upd©e_qp_cbp_tmp
(
Ma¸oblock
 *
cuºMB
, 
cbp
)

3863 i‡(((
cbp
!=0 || 
cuºMB
->
be°_mode
==
I16MB
Ë&& (cuºMB->be°_mode!=
IPCM
) ))

3864 
cuºMB
->
¥ev_cbp
 = 1;

3865 i‡((
cbp
==0Ë|| (
cuºMB
->
be°_mode
==
IPCM
))

3867 
cuºMB
->
¥ev_cbp
 = 0;

3868 
cuºMB
->
qp
 = cuºMB->
¥ev_qp
;

3869 
cuºMB
->
p_Vid
->
qp
 = currMB->qp;

3870 
	`upd©e_qp
(
cuºMB
);

3872 
	}
}

3881 
	$upd©e_qp_cbp
(
Ma¸oblock
 *
cuºMB
)

3883 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

3884 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

3887 i‡((
cuºMB
->
cbp
!=0 || cuºMB->
be°_mode
 =
I16MB
Ë&& (cuºMB->be°_modê!
IPCM
))

3888 
cuºMB
->
¥ev_cbp
 = 1;

3891 
cuºMB
->
¥ev_cbp
 = 0;

3892 
cuºMB
->
qp
 = cuºMB->
¥ev_qp
;

3893 
p_Vid
->
qp
 = 
cuºMB
->qp;

3894 
	`upd©e_qp
(
cuºMB
);

3897 i‡(
p_I≈
->
MbI¡îœ˚
)

3899 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

3901 
cuºSli˚
->
rdd©a
->
qp
 = 
cuºMB
->qp;

3902 
cuºSli˚
->
rdd©a
->
¥ev_cbp
 = 
cuºMB
->prev_cbp;

3904 
	}
}

3911 
	$c›y_rd›t_d©a
 (
Ma¸oblock
 *
cuºMB
)

3913 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

3914 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

3915 
PicMŸi⁄P¨ams
 **
mŸi⁄
 = 
p_Vid
->
íc_pi˘uª
->
mv_öfo
;

3916 
i
, 
j
;

3917 
RD_DATA
 *
rd›t
 = 
cuºSli˚
->
rdd©a
;

3919 
mode
;

3920 
b8mode
, 
b8pdú
;

3921 
block_y
;

3923 
li°_off£t
 = 
cuºMB
->list_offset;

3925 
mode
 = 
rd›t
->mode;

3926 
cuºMB
->
mb_ty≥
 = 
rd›t
->mb_type;

3927 
cuºMB
->
cbp
 = 
rd›t
->cbp;

3928 
cuºMB
->
cbp_blk
 = 
rd›t
->cbp_blk;

3929 
cuºMB
->
i16off£t
 = 
rd›t
->i16offset;

3930 
cuºMB
->
i16mode
 = 
rd›t
->i16mode;

3932 
cuºMB
->
¥ev_qp
 = 
rd›t
->prev_qp;

3933 
cuºMB
->
¥ev_dqp
 = 
rd›t
->prev_dqp;

3934 
cuºMB
->
¥ev_cbp
 = 
rd›t
->prev_cbp;

3935 
cuºMB
->
qp
 = 
rd›t
->qp;

3936 
	`upd©e_qp
 (
cuºMB
);

3938 
cuºMB
->
c_ùªd_mode
 = 
rd›t
->c_ipred_mode;

3940 
	`mem˝y
(
cuºSli˚
->
cofAC
[0][0][0],
rd›t
->cofAC[0][0][0], (4 + 
p_Vid
->
num_blk8x8_uv
) * 4 * 2 * 65 * ());

3941 
	`mem˝y
(
cuºSli˚
->
cofDC
[0][0],
rd›t
->cofDC[0][0], 3 * 2 * 18 * ());

3943 
j
 = 0; j < 
BLOCK_MULTIPLE
; j++)

3945 
block_y
 = 
cuºMB
->block_y + 
j
;

3946 
i
 = 0; i < 
BLOCK_MULTIPLE
; i++)

3948 
mŸi⁄
[
block_y
][
cuºMB
->
block_x
 + 
i
].
ªf_idx
 [
LIST_0
] = 
rd›t
->
ªÁr
[LIST_0][
j
][i];

3949 
mŸi⁄
[
block_y
][
cuºMB
->
block_x
 + 
i
].
ªf_pic
 [
LIST_0
] = 
rd›t
->
ªÁr
[LIST_0][
j
][i] < 0 ? 
NULL
 :

3950 
cuºSli˚
->
li°X
[
LIST_0
 + 
li°_off£t
][()
rd›t
->
ªÁr
[LIST_0][
j
][
i
]];

3954 i‡(
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
)

3956 
j
 = 0; j < 
BLOCK_MULTIPLE
; j++)

3958 
block_y
 = 
cuºMB
->block_y + 
j
;

3959 
i
 = 0; i < 
BLOCK_MULTIPLE
; i++)

3961 
mŸi⁄
[
block_y
][
cuºMB
->
block_x
 + 
i
].
ªf_idx
 [
LIST_1
] = 
rd›t
->
ªÁr
[LIST_1][
j
][i];

3962 
mŸi⁄
[
block_y
][
cuºMB
->
block_x
 + 
i
].
ªf_pic
 [
LIST_1
] = 
rd›t
->
ªÁr
[LIST_1][
j
][i] < 0 ? 
NULL
 :

3963 
cuºSli˚
->
li°X
[
LIST_1
 + 
li°_off£t
][(Ë
rd›t
->
ªÁr
[LIST_1][
j
][
i
]];

3970 
	`c›y_image_d©a_16x16
(&
p_Vid
->
íc_pi˘uª
->
imgY
[
cuºMB
->
pix_y
], 
rd›t
->
ªc_mb
[0], cuºMB->
pix_x
, 0);

3972 i‡(
p_Vid
->
yuv_f‹m©
 !
YUV400
)

3974 
	`c›y_image_d©a
(&
p_Vid
->
íc_pi˘uª
->
imgUV
[0][
cuºMB
->
pix_c_y
], 
rd›t
->
ªc_mb
[1], cuºMB->
pix_c_x
, 0,Ö_Vid->
mb_¸_size_x
,Ö_Vid->
mb_¸_size_y
);

3975 
	`c›y_image_d©a
(&
p_Vid
->
íc_pi˘uª
->
imgUV
[1][
cuºMB
->
pix_c_y
], 
rd›t
->
ªc_mb
[2], cuºMB->
pix_c_x
, 0,Ö_Vid->
mb_¸_size_x
,Ö_Vid->
mb_¸_size_y
);

3979 
	`mem˝y
(
cuºMB
->
b8x8
, 
rd›t
->b8x8, 
BLOCK_MULTIPLE
 * (
Info8x8
));

3981 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 = 
rd›t
->luma_transform_size_8x8_flag;

3984 i‡(
mode
 =
P8x8
)

3986 
	`mem˝y
(
cuºMB
->
öåa_¥ed_modes
,
rd›t
->öåa_¥ed_modes, 
MB_BLOCK_PARTITIONS
 * ());

3987 
j
 = 
cuºMB
->
block_y
; j < cuºMB->block_y + 
BLOCK_MULTIPLE
; j++)

3988 
	`mem˝y
(&
p_Vid
->
ùªdmode
[
j
][
cuºMB
->
block_x
],&
rd›t
->ùªdmode[j][cuºMB->block_x], 
BLOCK_MULTIPLE
 * ());

3990 i‡(
mode
 !
I4MB
 && modê!
I8MB
)

3992 
	`mem£t
(
cuºMB
->
öåa_¥ed_modes
,
DC_PRED
, 
MB_BLOCK_PARTITIONS
 * ());

3993 
j
 = 
cuºMB
->
block_y
; j < cuºMB->block_y + 
BLOCK_MULTIPLE
; j++)

3994 
	`mem£t
(&
p_Vid
->
ùªdmode
[
j
][
cuºMB
->
block_x
],
DC_PRED
, 
BLOCK_MULTIPLE
 * ());

3996 i‡(
mode
 =
I4MB
 || modê=
I8MB
)

3998 
	`mem˝y
(
cuºMB
->
öåa_¥ed_modes
,
rd›t
->öåa_¥ed_modes, 
MB_BLOCK_PARTITIONS
 * ());

3999 
	`mem˝y
(
cuºMB
->
öåa_¥ed_modes8x8
,
rd›t
->öåa_¥ed_modes8x8, 
MB_BLOCK_PARTITIONS
 * ());

4000 
j
 = 
cuºMB
->
block_y
; j < cuºMB->block_y + 
BLOCK_MULTIPLE
; j++)

4002 
	`mem˝y
(&
p_Vid
->
ùªdmode
[
j
][
cuºMB
->
block_x
],&
rd›t
->ùªdmode[j][cuºMB->block_x], 
BLOCK_MULTIPLE
 * ());

4006 i‡(
cuºSli˚
->
mb_aff_‰ame_Êag
 || (cuºSli˚->
U£RDOQu™t
 && cuºSli˚->
RDOQ_QP_Num
 > 1))

4009 i‡(
cuºSli˚
->
¶i˚_ty≥
 !
I_SLICE
 && cuºSli˚->¶i˚_ty≥ !
SI_SLICE
)

4010 
	`c›y_mŸi⁄_ve˘‹s_MB
 (
cuºSli˚
, 
rd›t
);

4012 i‡(!
	`is_öåa
(
cuºMB
))

4014 
cuºMB
->
b8x8
[0].
bùªd
 = 0;

4015 
cuºMB
->
b8x8
[1].
bùªd
 = 0;

4016 
cuºMB
->
b8x8
[2].
bùªd
 = 0;

4017 
cuºMB
->
b8x8
[3].
bùªd
 = 0;

4019 
j
 = 0; j < 4; j++)

4021 
i
 = 0; i < 4; i++)

4023 
b8mode
 = 
cuºMB
->
b8x8
[(
i
 >> 1Ë+ 2 * (
j
 >> 1)].
mode
;

4024 
b8pdú
 = 
cuºMB
->
b8x8
[(
i
 >> 1Ë+ 2 * (
j
 >> 1)].
pdú
;

4026 i‡(
b8pdú
!=1)

4028 
mŸi⁄
[
j
+
cuºMB
->
block_y
][
i
+cuºMB->
block_x
].
mv
[
LIST_0
] = 
rd›t
->
Æl_mv
[LIST_0][(Ïd›t->
ªÁr
[LIST_0][j][i]][
b8mode
][j][i];

4032 
mŸi⁄
[
j
+
cuºMB
->
block_y
][
i
+cuºMB->
block_x
].
mv
[
LIST_0
] = 
zîo_mv
;

4034 i‡(
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
)

4036 i‡(
b8pdú
!=0)

4038 
mŸi⁄
[
j
+
cuºMB
->
block_y
][
i
+cuºMB->
block_x
].
mv
[
LIST_1
] = 
rd›t
->
Æl_mv
[LIST_1][(Ïd›t->
ªÁr
[LIST_1][j][i]][
b8mode
][j][i];

4042 
mŸi⁄
[
j
+
cuºMB
->
block_y
][
i
+cuºMB->
block_x
].
mv
[
LIST_1
] = 
zîo_mv
;

4051 i‡(
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
)

4053 
j
 = 
cuºMB
->
block_y
; j < currMB->block_y + 4; j++)

4055 
i
 = 
cuºMB
->
block_x
; i < currMB->block_x + 4; i++)

4057 
mŸi⁄
[
j
][
i
].
mv
[
LIST_0
] = 
zîo_mv
;

4058 
mŸi⁄
[
j
][
i
].
mv
[
LIST_1
] = 
zîo_mv
;

4064 
j
 = 
cuºMB
->
block_y
; j < currMB->block_y + 4; j++)

4066 
i
 = 
cuºMB
->
block_x
; i < currMB->block_x + 4; i++)

4068 
mŸi⁄
[
j
][
i
].
mv
[
LIST_0
] = 
zîo_mv
;

4074 
	}
}

	@lencod/src/rdopt_coding_state.c

17 
	~"globÆ.h
"

19 
	~"rd›t_codög_°©e.h
"

20 
	~"ˇbac.h
"

21 
	~"memÆloc.h
"

29 
	$dñëe_codög_°©e
 (
CSobj
 *
cs
)

31 i‡(
cs
 !
NULL
)

34 i‡(
cs
->
í˚nv
 !
NULL
)

36 
	`‰ì
 (
cs
->
í˚nv
);

37 
cs
->
í˚nv
 = 
NULL
;

39 i‡(
cs
->
bô°ªam
 !
NULL
)

41 
	`‰ì
 (
cs
->
bô°ªam
);

42 
cs
->
bô°ªam
 = 
NULL
;

46 
	`dñëe_c⁄ãxts_MŸi⁄Info
 (
cs
->
mŸ_˘x
);

47 
	`dñëe_c⁄ãxts_TextuªInfo
 (
cs
->
ãx_˘x
);

49 i‡(
cs
->
cbp_bôs_8x8
 !
NULL
)

51 
	`‰ì
 (
cs
->
cbp_bôs_8x8
);

52 
cs
->
cbp_bôs_8x8
 = 
NULL
;

56 
	`‰ì
 (
cs
);

57 
cs
=
NULL
;

59 
	}
}

68 
CSobj
 *
	$¸óã_codög_°©e
 (
I≈utP¨amëîs
 *
p_I≈
)

70 
CSobj
 *
cs
;

73 i‡((
cs
 = (
CSobj
 *Ë
	`ˇŒoc
 (1, (CSobj))Ë=
NULL
)

74 
	`no_mem_exô
("init_coding_state: cs");

77 
cs
->
no_∑π
 = 
p_I≈
->
∑πôi⁄_mode
 == 0 ? 1 : 3;

78 i‡(
p_I≈
->
symbﬁ_mode
 =
CABAC
)

80 i‡((
cs
->
í˚nv
 = (
EncodögEnvú⁄mít
*Ë
	`ˇŒoc
 (cs->
no_∑π
, (EncodögEnvú⁄mít))Ë=
NULL
)

81 
	`no_mem_exô
("init_coding_state: cs->encenv");

83 i‡((
cs
->
bô°ªam
 = (
Bô°ªam
*Ë
	`ˇŒoc
 (cs->
no_∑π
, (Bô°ªam))Ë=
NULL
)

84 
	`no_mem_exô
("init_coding_state: cs->bitstream");

86 
cs
->
mŸ_˘x
 = 
	`¸óã_c⁄ãxts_MŸi⁄Info
 ();

87 
cs
->
ãx_˘x
 = 
	`¸óã_c⁄ãxts_TextuªInfo
();

92 
cs
->
í˚nv
 = 
NULL
;

93 i‡((
cs
->
bô°ªam
 = (
Bô°ªam
*Ë
	`ˇŒoc
 (cs->
no_∑π
, (Bô°ªam))Ë=
NULL
)

94 
	`no_mem_exô
("init_coding_state: cs->bitstream");

96 
cs
->
mŸ_˘x
 = 
NULL
;

97 
cs
->
ãx_˘x
 = 
NULL
;

100 i‡(
p_I≈
->
ProfûeIDC
 == 244)

102 i‡((
cs
->
cbp_bôs_8x8
 = (
öt64
 *Ë
	`ˇŒoc
 (3, (öt64))Ë=
NULL
)

103 
	`no_mem_exô
("init_coding_state: cs->cbp_bits_8x8");

106 
cs
->
cbp_bôs_8x8
 = 
NULL
;

108  
cs
;

109 
	}
}

117 
	$°‹e_codög_°©e_n‹do
 (
Ma¸oblock
 *
cuºMB
, 
CSobj
 *
cs
)

119 
	}
}

128 
	$°‹e_codög_°©e_ˇvlc
 (
Ma¸oblock
 *
cuºMB
, 
CSobj
 *
cs
)

130 
i
;

131 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

132 
i_œ°
 = 
cuºSli˚
->
idr_Êag
? 1 : 
cs
->
no_∑π
;

135 
i
 = 0; i < 
i_œ°
; i++)

137 
cs
->
bô°ªam
[
i
] = *
cuºSli˚
->
∑πAº
[i].bitstream;

141 
cs
->
bôs
 = 
cuºMB
->bits;

144 i‡(
cuºMB
->
mb_ty≥
 <
P8x8
)

145 
	`mem˝y
 (
cs
->
mvd
, 
cuºMB
->mvd, 
BLOCK_CONTEXT
 * ());

146 
	`mem˝y
 (
cs
->
cbp_bôs
, 
cuºMB
->cbp_bôs, 3 * (
öt64
));

148 i‡(
cuºSli˚
->
P444_joöed
)

149 
	`mem˝y
 (
cs
->
cbp_bôs_8x8
, 
cuºMB
->cbp_bôs_8x8, 3 * (
öt64
));

150 
	}
}

158 
	$°‹e_codög_°©e_ˇbac
 (
Ma¸oblock
 *
cuºMB
, 
CSobj
 *
cs
)

160 
i
;

161 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

162 
i_œ°
 = 
cuºSli˚
->
idr_Êag
? 1:
cs
->
no_∑π
;

163 
D©aP¨tôi⁄
 *
∑πAº
 = &
cuºSli˚
->partArr[0];

167 
i
 = 0; i < 
i_œ°
; i++)

169 
cs
->
bô°ªam
[
i
] = *
∑πAº
->bitstream;

170 
cs
->
í˚nv
[
i
] = (
∑πAº
++)->
ì_ˇbac
;

174 *
cs
->
mŸ_˘x
 = *
cuºSli˚
->mot_ctx;

175 *
cs
->
ãx_˘x
 = *
cuºSli˚
->tex_ctx;

178 
cs
->
bôs
 = 
cuºMB
->bits;

181 i‡(
cuºMB
->
mb_ty≥
 <
P8x8
)

182 
	`mem˝y
 (
cs
->
mvd
, 
cuºMB
->mvd, 
BLOCK_CONTEXT
 * ());

183 
	`mem˝y
 (
cs
->
cbp_bôs
, 
cuºMB
->cbp_bôs, 3 * (
öt64
));

185 i‡(
cuºSli˚
->
P444_joöed
)

186 
	`mem˝y
 (
cs
->
cbp_bôs_8x8
, 
cuºMB
->cbp_bôs_8x8, 3 * (
öt64
));

187 
	}
}

195 
	$ª£t_codög_°©e_n‹do
 (
Ma¸oblock
 *
cuºMB
, 
CSobj
 *
cs
)

197 
	}
}

205 
	$ª£t_codög_°©e_ˇvlc
 (
Ma¸oblock
 *
cuºMB
, 
CSobj
 *
cs
)

207 
i
;

208 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

209 
i_œ°
 = 
cuºSli˚
->
idr_Êag
? 1:
cs
->
no_∑π
;

213 
i
 = 0; i < 
i_œ°
; i++)

216 *
cuºSli˚
->
∑πAº
[
i
].
bô°ªam
 = 
cs
->bitstream[i];

220 
cuºMB
->
bôs
 = 
cs
->bits;

223 i‡(
cuºMB
->
mb_ty≥
 <
P8x8
)

224 
	`mem˝y
 (
cuºMB
->
mvd
, 
cs
->mvd, 
BLOCK_CONTEXT
 * ());

225 
	`mem˝y
 (
cuºMB
->
cbp_bôs
, 
cs
->cbp_bôs, 3 * (
öt64
));

226 if(
cuºSli˚
->
P444_joöed
)

227 
	`mem˝y
 (
cuºMB
->
cbp_bôs_8x8
, 
cs
->cbp_bôs_8x8, 3 * (
öt64
));

228 
	}
}

237 
	$ª£t_codög_°©e_ˇbac
 (
Ma¸oblock
 *
cuºMB
, 
CSobj
 *
cs
)

239 
i
;

240 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

241 
i_œ°
 = 
cuºSli˚
->
idr_Êag
? 1:
cs
->
no_∑π
;

242 
D©aP¨tôi⁄
 *
∑πAº
 = &
cuºSli˚
->partArr[0];

246 
i
 = 0; i < 
i_œ°
; i++)

249 *
∑πAº
->
bô°ªam
 = 
cs
->bô°ªam[
i
];

250 (
∑πAº
++)->
ì_ˇbac
 = 
cs
->
í˚nv
[
i
];

254 *
cuºSli˚
->
mŸ_˘x
 = *
cs
->mot_ctx;

255 *
cuºSli˚
->
ãx_˘x
 = *
cs
->tex_ctx;

258 
cuºMB
->
bôs
 = 
cs
->bits;

261 i‡(
cuºMB
->
mb_ty≥
 <
P8x8
)

262 
	`mem˝y
 (
cuºMB
->
mvd
, 
cs
->mvd, 
BLOCK_CONTEXT
 * ());

264 
	`mem˝y
 (
cuºMB
->
cbp_bôs
, 
cs
->cbp_bôs, 3 * (
öt64
));

266 if(
cuºSli˚
->
P444_joöed
)

267 
	`mem˝y
 (
cuºMB
->
cbp_bôs_8x8
, 
cs
->cbp_bôs_8x8, 3 * (
öt64
));

268 
	}
}

279 
	$öô_codög_°©e_mëhods
(
Sli˚
 *
cuºSli˚
)

281 i‡(
cuºSli˚
->
p_I≈
->
rd›t
 == 0)

283 
cuºSli˚
->
ª£t_codög_°©e
 = 
ª£t_codög_°©e_n‹do
;

284 
cuºSli˚
->
°‹e_codög_°©e
 = 
°‹e_codög_°©e_n‹do
;

288 i‡(
cuºSli˚
->
symbﬁ_mode
 =
CABAC
)

290 
cuºSli˚
->
ª£t_codög_°©e
 = 
ª£t_codög_°©e_ˇbac
;

291 
cuºSli˚
->
°‹e_codög_°©e
 = 
°‹e_codög_°©e_ˇbac
;

295 
cuºSli˚
->
ª£t_codög_°©e
 = 
ª£t_codög_°©e_ˇvlc
;

296 
cuºSli˚
->
°‹e_codög_°©e
 = 
°‹e_codög_°©e_ˇvlc
;

299 
	}
}

	@lencod/src/rdoq.c

10 
	~"c⁄åibut‹s.h
"

12 
	~<m©h.h
>

13 
	~<Êﬂt.h
>

15 
	~"globÆ.h
"

16 
	~"image.h
"

17 
	~"fmo.h
"

18 
	~"ma¸oblock.h
"

19 
	~"mb_ac˚ss.h
"

20 
	~"rd›t.h
"

21 
	~"rdoq.h
"

22 
	~"mv_£¨ch.h
"

24 
	#RDOQ_BASE
 0

	)

33 
	$öô_rdoq_¶i˚
(
Sli˚
 *
cuºSli˚
)

37 
cuºSli˚
->
n‹m_Á˘‹_4x4
 = 
	`pow
(2, (2 * 
DQ_BITS
 + 19));

38 
cuºSli˚
->
n‹m_Á˘‹_8x8
 = 
	`pow
(2, (2 * 
Q_BITS_8
 + 9));

39 
	}
}

46 
	$öô_åñlis_d©a_DC_¸_CAVLC
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qp_≥r
, 
qp_ªm
,

47 
LevñQu™tP¨ams
 *
q_∑øms
, c⁄° 
byã
 *
p_sˇn
,

48 
ÀvñD©aSåu˘
 *
d©aLevñ
)

50 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

51 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

52 
i
, 
j
, 
c€ff_˘r
, 
íd_c€ff_˘r
 = 
p_Vid
->
num_cdc_c€ff
;

53 *
m7
;

54 
q_bôs
 = 
Q_BITS
 + 
qp_≥r
 + 1;

55 
q_off£t
 = ( 1 << (
q_bôs
 - 1) );

56 
îr
;

57 
sˇÀd_c€ff
, 
Àvñ
, 
lowîI¡
, 
k
;

58 
e°Eº
 = (Ë
e°Eº4x4
[
qp_ªm
][0][0] / 
cuºSli˚
->
n‹m_Á˘‹_4x4
;

60 
c€ff_˘r
 = 0; c€ff_˘∏< 
íd_c€ff_˘r
; coeff_ctr++)

62 
j
 = *
p_sˇn
++;

63 
i
 = *
p_sˇn
++;

65 
m7
 = &
tblock
[
j
][
i
];

66 i‡(*
m7
 == 0)

68 
d©aLevñ
->
Àvñ
[0] = 0;

69 
d©aLevñ
->
ÀvñDoubÀ
 = 0;

70 
d©aLevñ
->
îrLevñ
[0] = 0.0;

71 
d©aLevñ
->
noLevñs
 = 1;

72 
îr
 = 0.0;

73 
d©aLevñ
->
¥e_Àvñ
 = 0;

74 
d©aLevñ
->
sign
 = 0;

78 
sˇÀd_c€ff
 = 
	`übs
 (*
m7
Ë* 
q_∑øms
->
SˇÀComp
;

79 
d©aLevñ
->
ÀvñDoubÀ
 = 
sˇÀd_c€ff
;

80 
Àvñ
 = (
sˇÀd_c€ff
 >> 
q_bôs
);

82 
lowîI¡
 = ((
sˇÀd_c€ff
 - (
Àvñ
 << 
q_bôs
)Ë< 
q_off£t
 )? 1 : 0;

83 
d©aLevñ
->
Àvñ
[0] = 0;

84 i‡(
Àvñ
 =0 && 
lowîI¡
 == 1)

86 
d©aLevñ
->
noLevñs
 = 1;

88 i‡(
Àvñ
 =0 && 
lowîI¡
 == 0)

90 
d©aLevñ
->
Àvñ
[1] =Üevel + 1;

91 
d©aLevñ
->
noLevñs
 = 2;

93 i‡(
Àvñ
 > 0 && 
lowîI¡
 == 1)

95 
d©aLevñ
->
Àvñ
[1] =Üevel;

96 
d©aLevñ
->
noLevñs
 = 2;

100 
d©aLevñ
->
Àvñ
[1] =Üevel;

101 
d©aLevñ
->
Àvñ
[2] =Üevel + 1;

102 
d©aLevñ
->
noLevñs
 = 3;

105 
k
 = 0; k < 
d©aLevñ
->
noLevñs
; k++)

107 
îr
 = ()(
d©aLevñ
->
Àvñ
[
k
] << 
q_bôs
Ë- ()
sˇÀd_c€ff
;

108 
d©aLevñ
->
îrLevñ
[
k
] = (
îr
 *Éº * 
e°Eº
);

111 if(
d©aLevñ
->
noLevñs
 == 1)

112 
d©aLevñ
->
¥e_Àvñ
 = 0;

114 
d©aLevñ
->
¥e_Àvñ
 = (
	`übs
 (*
m7
Ë* 
q_∑øms
->
SˇÀComp
 + q_∑øms->
Off£tComp
Ë>> 
q_bôs
;

115 
d©aLevñ
->
sign
 = 
	`isign
(*
m7
);

117 
d©aLevñ
++;

120 
	}
}

129 
	$öô_åñlis_d©a_DC_¸_CABAC
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qp_≥r
, 
qp_ªm
,

130 
LevñQu™tP¨ams
 *
q_∑øms
, c⁄° 
byã
 *
p_sˇn
,

131 
ÀvñD©aSåu˘
 *
d©aLevñ
, * 
kSèπ
, * 
kSt›
)

133 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

134 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

135 
noC€ff
 = 0;

136 
i
, 
j
, 
c€ff_˘r
, 
íd_c€ff_˘r
 = 
p_Vid
->
num_cdc_c€ff
;

137 *
m7
;

138 
q_bôs
 = 
Q_BITS
 + 
qp_≥r
 + 1;

139 
q_off£t
 = ( 1 << (
q_bôs
 - 1) );

140 
îr
;

141 
sˇÀd_c€ff
, 
Àvñ
, 
lowîI¡
, 
k
;

142 
e°Eº
 = (Ë
e°Eº4x4
[
qp_ªm
][0][0] / 
cuºSli˚
->
n‹m_Á˘‹_4x4
;

144 
c€ff_˘r
 = 0; c€ff_˘∏< 
íd_c€ff_˘r
; coeff_ctr++)

146 
j
 = *
p_sˇn
++;

147 
i
 = *
p_sˇn
++;

149 
m7
 = &
tblock
[
j
][
i
];

150 i‡(*
m7
 == 0)

152 
d©aLevñ
->
Àvñ
[0] = 0;

153 
d©aLevñ
->
ÀvñDoubÀ
 = 0;

154 
d©aLevñ
->
îrLevñ
[0] = 0.0;

155 
d©aLevñ
->
noLevñs
 = 1;

156 
îr
 = 0.0;

160 
sˇÀd_c€ff
 = 
	`übs
 (*
m7
Ë* 
q_∑øms
->
SˇÀComp
;

161 
d©aLevñ
->
ÀvñDoubÀ
 = 
sˇÀd_c€ff
;

162 
Àvñ
 = (
sˇÀd_c€ff
 >> 
q_bôs
);

164 
lowîI¡
=–(
sˇÀd_c€ff
 - (
Àvñ
 << 
q_bôs
)Ë< 
q_off£t
 )? 1 : 0;

165 
d©aLevñ
->
Àvñ
[0] = 0;

166 i‡(
Àvñ
 == 0)

168 i‡(
lowîI¡
 == 1)

170 
d©aLevñ
->
noLevñs
 = 1;

174 
d©aLevñ
->
Àvñ
[1] =Üevel + 1;

175 
d©aLevñ
->
noLevñs
 = 2;

176 *
kSt›
 = 
c€ff_˘r
;

177 
noC€ff
++;

180 i‡(
lowîI¡
 == 1)

182 
d©aLevñ
->
Àvñ
[1] =Üevel;

183 
d©aLevñ
->
noLevñs
 = 2;

184 *
kSt›
 = 
c€ff_˘r
;

185 
noC€ff
++;

189 
d©aLevñ
->
Àvñ
[1] =Üevel;

190 
d©aLevñ
->
Àvñ
[2] =Üevel + 1;

191 
d©aLevñ
->
noLevñs
 = 3;

192 *
kSt›
 = 
c€ff_˘r
;

193 *
kSèπ
 = 
c€ff_˘r
;

194 
noC€ff
++;

197 
k
 = 0; k < 
d©aLevñ
->
noLevñs
; k++)

199 
îr
 = ()(
d©aLevñ
->
Àvñ
[
k
] << 
q_bôs
Ë- ()
sˇÀd_c€ff
;

200 
d©aLevñ
->
îrLevñ
[
k
] = (
îr
 *Éº * 
e°Eº
);

203 
d©aLevñ
++;

205  (
noC€ff
);

206 
	}
}

208 
	$gë_dQP_èbÀ
(
Sli˚
 *
cuºSli˚
)

210 
qp_off£t
 = (
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
Ë? (cuºSli˚->
RDOQ_QP_Num
 / 3): (currSlice->RDOQ_QP_Num >> 1);

211 
dñèQPC¡
, 
dñèQP
;

213 
	`mem£t
(
cuºSli˚
->
dñèQPTabÀ
, 0, ()*9);

215 
dñèQPC¡
 = 0; dñèQPC¡ < 
cuºSli˚
->
RDOQ_QP_Num
; deltaQPCnt++)

217 i‡(
dñèQPC¡
 == 0)

218 
dñèQP
 = 0;

221 i‡(
dñèQPC¡
 <
qp_off£t
)

222 
dñèQP
 = 
dñèQPC¡
 - 1 - 
qp_off£t
;

224 
dñèQP
 = 
dñèQPC¡
 - 
qp_off£t
;

226 
cuºSli˚
->
dñèQPTabÀ
[
dñèQPC¡
] = 
dñèQP
;

228 
	}
}

230 
	$åñlis_mp
(
Ma¸oblock
 *
cuºMB
)

232 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

233 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

234 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

236 
ma°îQP
 = 0, 
dñèQP
;

237 #i‡
RDOQ_BASE


238 
qp_À·
, 
qp_up
;

239 c⁄° 
dñèQPTabB
[] = {0, 1, -1, 2, 3, -2, 4, 5, -3};

240 c⁄° 
dñèQPTabP
[] = {0, -1, 1, -2, 2, -3, 3, -4, 4};

241 
qp_™ch‹
;

243 
dñèQPC¡
;

245 
ma°îQP
 = 
p_Vid
->ma°îQP =Ö_Vid->
qp
;

247 
cuºSli˚
->
rdoq_mŸi⁄_c›y
 = 0;

249 
cuºSli˚
->
rdd©a_åñlis_be°
.
mö_rdco°
 = 1e30;

251 i‡(
p_I≈
->
symbﬁ_mode
 =
CABAC
)

253 
	`e°RunLevñ_CABAC
(
cuºMB
, 
LUMA_4x4
);

254 
	`e°RunLevñ_CABAC
(
cuºMB
, 
LUMA_16AC
);

255 
	`e°RunLevñ_CABAC
(
cuºMB
, 
LUMA_16DC
);

256 i‡(
p_I≈
->
Tønsf‹m8x8Mode
)

257 
	`e°RunLevñ_CABAC
(
cuºMB
, 
LUMA_8x8
);

259 i‡(
p_Vid
->
yuv_f‹m©
 !
YUV400
)

261 
	`e°RunLevñ_CABAC
(
cuºMB
, 
CHROMA_AC
);

262 i‡(
p_Vid
->
yuv_f‹m©
 =
YUV420
)

263 
	`e°RunLevñ_CABAC
(
cuºMB
, 
CHROMA_DC
);

265 
	`e°RunLevñ_CABAC
(
cuºMB
, 
CHROMA_DC_2x4
);

269 #i‡
RDOQ_BASE


270 
qp_À·
 = (
cuºMB
->
mb_À·
Ë? cuºMB->mb_À·->
qp
 : 
p_Vid
->
ma°îQP
;

271 
qp_up
 = (
cuºMB
->
mb_up
Ë? cuºMB->mb_up->
qp
 : 
p_Vid
->
ma°îQP
;

272 
qp_™ch‹
 = (
qp_À·
 + 
qp_up
 + 1)>>1;

275 
dñèQPC¡
=0; dñèQPC¡ < 
cuºSli˚
->
RDOQ_QP_Num
; deltaQPCnt++)

277 
cuºSli˚
->
rdd©a
 = &cuºSli˚->
rdd©a_åñlis_cuº
;

278 
cuºSli˚
->
rdd©a
->
mö_dco°
 = 1e30;

279 #i‡
RDOQ_BASE


280 i‡(
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
)

281 
dñèQP
 = 
dñèQPTabB
[
dñèQPC¡
];

283 
dñèQP
 = 
dñèQPTabP
[
dñèQPC¡
];

288 
dñèQP
 = 
cuºSli˚
->
dñèQPTabÀ
[
dñèQPC¡
];

291 
p_Vid
->
qp
 = 
	`iClù3
(-p_Vid->
bôdïth_luma_qp_sˇÀ
, 51, 
ma°îQP
 + 
dñèQP
);

292 
dñèQP
 = 
p_Vid
->
qp
 - 
ma°îQP
;

295 #i‡
RDOQ_BASE


296 if(
dñèQP
 !0 && !(
p_Vid
->
qp
 - 
qp_™ch‹
 >-2 &&Ö_Vid->q∞- qp_™ch‹ <1Ë&& 
cuºMB
->
mb_À·
 && cuºMB->
mb_up
 && 
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
)

298 if(
dñèQP
 !0 && !(
p_Vid
->
qp
 - 
qp_™ch‹
 >-1 &&Ö_Vid->q∞- qp_™ch‹ <2Ë&& 
cuºMB
->
mb_À·
 && cuºMB->
mb_up
 && 
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
)

302 
	`ª£t_ma¸oblock
(
cuºMB
);

303 
cuºMB
->
qp
 = (Ë
p_Vid
->qp;

304 
	`upd©e_qp
 (
cuºMB
);

306 
cuºSli˚
->
	`ícode_⁄e_ma¸oblock
 (
cuºMB
);

307 
	`íd_ícode_⁄e_ma¸oblock
(
cuºMB
);

310 i‡–
cuºSli˚
->
rdd©a_åñlis_cuº
.
mö_rdco°
 < cuºSli˚->
rdd©a_åñlis_be°
.min_rdcost)

311 
	`c›y_rdd©a_åñlis
(
cuºMB
, &
cuºSli˚
->
rdd©a_åñlis_be°
, cuºSli˚->
rdd©a
);

313 i‡(
p_I≈
->
RDOQ_CP_MV
)

314 
cuºSli˚
->
rdoq_mŸi⁄_c›y
 = 1;

316 #i‡(!
RDOQ_BASE
)

317 i‡(
p_I≈
->
RDOQ_Fa°
 == 1)

319 i‡((
p_Vid
->
qp
 - 
cuºSli˚
->
rdd©a_åñlis_be°
.qp > 1))

321 i‡((
cuºSli˚
->
rdd©a_åñlis_cuº
.
cbp
 =0Ë&& (cuºSli˚->rdd©a_åñlis_cuº.
mb_ty≥
 != 0))

323 i‡((
cuºSli˚
->
rdd©a_åñlis_be°
.
mb_ty≥
 =0Ë&& (cuºSli˚->rdd©a_åñlis_be°.
cbp
 == 0))

329 
	`ª£t_ma¸oblock
(
cuºMB
);

330 
cuºSli˚
->
rdd©a
 = &cuºSli˚->
rdd©a_åñlis_be°
;

332 
	`c›y_rd›t_d©a
 (
cuºMB
);

333 
	`wrôe_ma¸oblock
 (
cuºMB
, 1);

334 
p_Vid
->
qp
 = 
ma°îQP
;

335 
	}
}

337 
	$åñlis_•
(
Ma¸oblock
 *
cuºMB
)

339 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

340 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

341 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

343 
p_Vid
->
ma°îQP
 =Ö_Vid->
qp
;

345 i‡(
cuºSli˚
->
symbﬁ_mode
 =
CABAC
)

347 
	`e°RunLevñ_CABAC
(
cuºMB
, 
LUMA_4x4
);

348 
	`e°RunLevñ_CABAC
(
cuºMB
, 
LUMA_16AC
);

350 
	`e°RunLevñ_CABAC
(
cuºMB
, 
LUMA_16DC
);

351 i‡(
p_I≈
->
Tønsf‹m8x8Mode
)

352 
	`e°RunLevñ_CABAC
(
cuºMB
, 
LUMA_8x8
);

354 i‡(
p_Vid
->
yuv_f‹m©
 !
YUV400
)

356 
	`e°RunLevñ_CABAC
(
cuºMB
, 
CHROMA_AC
);

358 i‡(
p_Vid
->
yuv_f‹m©
 =
YUV420
)

359 
	`e°RunLevñ_CABAC
(
cuºMB
, 
CHROMA_DC
);

361 
	`e°RunLevñ_CABAC
(
cuºMB
, 
CHROMA_DC_2x4
);

365 
cuºSli˚
->
	`ícode_⁄e_ma¸oblock
 (
cuºMB
);

366 
	`íd_ícode_⁄e_ma¸oblock
(
cuºMB
);

368 
	`wrôe_ma¸oblock
 (
cuºMB
, 1);

369 
	}
}

371 
	$åñlis_codög
(
Ma¸oblock
 *
cuºMB
)

373 i‡(
cuºMB
->
p_Sli˚
->
RDOQ_QP_Num
 > 1)

375 
	`åñlis_mp
(
cuºMB
);

379 
	`åñlis_•
(
cuºMB
);

381 
	}
}

383 
	$RDOQ_upd©e_mode
(
Sli˚
 *
cuºSli˚
, 
RD_PARAMS
 *
íc_mb
)

385 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºSli˚
->p_Inp;

386 #i‡(
MVC_EXTENSION_ENABLE
)

387 *
I¡îSórch
 = 
p_I≈
->I¡îSórch[(
cuºSli˚
->
p_Vid
->
num_of_œyîs
 > 1Ë? cuºSli˚->
võw_id
 : 0][(cuºSli˚->
¶i˚_ty≥
 =
B_SLICE
)];

389 *
I¡îSórch
 = 
p_I≈
->I¡îSórch[0][(
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
)];

392 
mb_ty≥
 = 
cuºSli˚
->
rdd©a_åñlis_be°
.mb_type;

393 
i
;

394 
i
=0; i<
MAXMODE
; i++)

395 
íc_mb
->
vÆid
[
i
] = 0;

397 
íc_mb
->
vÆid
[
mb_ty≥
] = 1;

399 if(
mb_ty≥
 =
P8x8
)

401 
íc_mb
->
vÆid
[4] = (Ë(
I¡îSórch
[4]);

402 
íc_mb
->
vÆid
[5] = (Ë(
I¡îSórch
[5] && !(
p_I≈
->
Tønsf‹m8x8Mode
==2));

403 
íc_mb
->
vÆid
[6] = (Ë(
I¡îSórch
[6] && !(
p_I≈
->
Tønsf‹m8x8Mode
==2));

404 
íc_mb
->
vÆid
[7] = (Ë(
I¡îSórch
[7] && !(
p_I≈
->
Tønsf‹m8x8Mode
==2));

406 
	}
}

408 
	$c›y_rdd©a_åñlis
 (
Ma¸oblock
 *
cuºMB
, 
RD_DATA
 *
de°
, RD_DATA *
§c
)

410 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

411 
j
;

413 
de°
->
mö_rdco°
 = 
§c
->min_rdcost;

414 
de°
->
mö_dco°
 = 
§c
->min_dcost;

415 
de°
->
mö_øã
 = 
§c
->min_rate;

417 
	`mem˝y
(&
de°
->
ªc_mb
[0][0][0],&
§c
->ªc_mb[0][0][0], 
MB_PIXELS
 * (
img≥l
));

419 i‡(
p_Vid
->
yuv_f‹m©
 !
YUV400
)

421 
	`mem˝y
(&
de°
->
ªc_mb
[1][0][0],&
§c
->ªc_mb[1][0][0], 2 * 
MB_PIXELS
 * (
img≥l
));

424 
	`mem˝y
(&
de°
->
cofAC
[0][0][0][0], &
§c
->cofAC[0][0][0][0], (4 + 
p_Vid
->
num_blk8x8_uv
) * 4 * 2 * 65 * ());

425 
	`mem˝y
(&
de°
->
cofDC
[0][0][0], &
§c
->cofDC[0][0][0], 3 * 2 * 18 * ());

427 
de°
->
mb_ty≥
 = 
§c
->mb_type;

429 
	`mem˝y
(
de°
->
b8x8
, 
§c
->b8x8, 
BLOCK_MULTIPLE
 * (
Info8x8
));

431 
de°
->
cbp
 = 
§c
->cbp;

432 
de°
->
mode
 = 
§c
->mode;

433 
de°
->
i16off£t
 = 
§c
->i16offset;

434 
de°
->
i16mode
 = 
§c
->i16mode;

435 
de°
->
c_ùªd_mode
 = 
§c
->c_ipred_mode;

436 
de°
->
luma_å™sf‹m_size_8x8_Êag
 = 
§c
->luma_transform_size_8x8_flag;

437 
de°
->
NoMbP¨tLessTh™8x8Fœg
 = 
§c
->NoMbPartLessThan8x8Flag;

438 
de°
->
qp
 = 
§c
->qp;

440 
de°
->
¥ev_qp
 = 
§c
->prev_qp;

441 
de°
->
¥ev_dqp
 = 
§c
->prev_dqp;

442 
de°
->
¥ev_cbp
 = 
§c
->prev_cbp;

443 
de°
->
cbp_blk
 = 
§c
->cbp_blk;

446 i‡(
p_Vid
->
ty≥
 !
I_SLICE
 &&Ö_Vid->ty≥ !
SI_SLICE
)

449 
	`mem˝y
(&
de°
->
Æl_mv
 [0][0][0][0][0], &
§c
->Æl_mv [0][0][0][0][0], 
p_Vid
->
max_num_ª„ªn˚s
 * 288 * (
MŸi⁄Ve˘‹
));

452 
	`mem˝y
(
de°
->
öåa_¥ed_modes
,
§c
->öåa_¥ed_modes, 
MB_BLOCK_PARTITIONS
 * ());

453 
	`mem˝y
(
de°
->
öåa_¥ed_modes8x8
,
§c
->öåa_¥ed_modes8x8, 
MB_BLOCK_PARTITIONS
 * ());

454 
j
 = 
cuºMB
->
block_y
; j < cuºMB->block_y + 
BLOCK_MULTIPLE
; j++)

455 
	`mem˝y
(&
de°
->
ùªdmode
[
j
][
cuºMB
->
block_x
],&
§c
->ùªdmode[j][cuºMB->block_x], 
BLOCK_MULTIPLE
 * ());

457 
	`mem˝y
(&
de°
->
ªÁr
[
LIST_0
][0][0], &
§c
->ªÁr[LIST_0][0][0], 2 * 
BLOCK_MULTIPLE
 * BLOCK_MULTIPLE * ());

459 
	}
}

461 
	$upd©eMV_mp
(
Ma¸oblock
 *
cuºMB
, 
di°blk
 *
m_co°
, 
ªf
, 
li°
, 
h
, 
v
, 
blockty≥
, 
block8x8
)

463 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

464 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

466 
i
, 
j
;

467 
bsx
 = 
block_size
[
blockty≥
][0] >> 2;

468 
bsy
 = 
block_size
[
blockty≥
][1] >> 2;

469 
MŸi⁄Ve˘‹
 
Æl_mv
;

471 i‡–(
p_I≈
->
Tønsf‹m8x8Mode
 =1Ë&& (
blockty≥
 =4Ë&& 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
)

473 
Æl_mv
 = 
cuºSli˚
->
tmp_mv8
[
li°
][
ªf
][
v
][
h
];

474 *
m_co°
 = 
cuºSli˚
->
mŸi⁄_co°8
[
li°
][
ªf
][
block8x8
];

476 i‡–(
p_I≈
->
Tønsf‹m8x8Mode
 =1Ë&& (
blockty≥
 =4Ë&& 
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 == 0)

478 
Æl_mv
 = 
cuºSli˚
->
tmp_mv4
[
li°
][
ªf
][
v
][
h
];

479 *
m_co°
 = 
cuºSli˚
->
mŸi⁄_co°4
[
li°
][
ªf
][
block8x8
];

483 
Æl_mv
 = 
cuºSli˚
->
rdd©a_åñlis_be°
.Æl_mv[
li°
][
ªf
][
blockty≥
][
v
][
h
];

486 
j
 = 0; j < 
bsy
; j++)

488 
i
 = 0; i < 
bsx
; i++)

490 
cuºSli˚
->
Æl_mv
[
li°
][
ªf
][
blockty≥
][
v
+
j
][
h
+
i
] =áll_mv;

493 
	}
}

	@lencod/src/rdoq_cabac.c

10 
	~"c⁄åibut‹s.h
"

12 
	~<m©h.h
>

13 
	~<Êﬂt.h
>

15 
	~"globÆ.h
"

16 
	~"ˇbac.h
"

17 
	~"image.h
"

18 
	~"fmo.h
"

19 
	~"ma¸oblock.h
"

20 
	~"mb_ac˚ss.h
"

21 
	~"rdoq.h
"

23 
	#RDOQ_SQ
 0

	)

25 c⁄° 
	gíå›yBôs
[128]=

46 
	$büri_no_bôs
(sig√d 
symbﬁ
, 
BiC⁄ãxtTy≥På
 
bi_˘
 )

48 
˘x_°©e
, 
e°Bôs
;

50 
symbﬁ
 = () (symbol != 0);

52 
˘x_°©e
 = (
symbﬁ
 =
bi_˘
->
MPS
Ë? 64 + bi_˘->
°©e
 : 63 - bi_ct->state;

53 
e°Bôs
 = 
íå›yBôs
[127 - 
˘x_°©e
];

55 (
e°Bôs
);

56 
	}
}

58 
	$büri_°©e
(sig√d 
symbﬁ
, 
BiC⁄ãxtTy≥På
 
bi_˘
 )

60 
˘x_°©e
;

62 
symbﬁ
 = () (symbol != 0);

63 
˘x_°©e
 = (
symbﬁ
 =
bi_˘
->
MPS
Ë? 64 + bi_˘->
°©e
 : 63 - bi_ct->state;

65 (
˘x_°©e
);

66 
	}
}

74 
	$e°_CBP_block_bô
 (
Ma¸oblock
* 
cuºMB
, 
ty≥
)

76 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

77 
e°BôsCabacSåu˘
 *
ˇbacE°Bôs
 = &
cuºSli˚
->
e°BôsCabac
[
ty≥
];

78 
˘x
;

80 
˘x
=0; ctx<=3; ctx++)

82 
ˇbacE°Bôs
->
blockCbpBôs
[
˘x
][0]=
	`büri_no_bôs
(0, 
cuºSli˚
->
ãx_˘x
->
bcbp_c⁄ãxts
[
ty≥2˘x_bcbp
[
ty≥
]]+ctx);

84 
ˇbacE°Bôs
->
blockCbpBôs
[
˘x
][1]=
	`büri_no_bôs
(1, 
cuºSli˚
->
ãx_˘x
->
bcbp_c⁄ãxts
[
ty≥2˘x_bcbp
[
ty≥
]]+ctx);

86 
	}
}

94 
	$e°_signifiˇn˚_m≠
(
Ma¸oblock
* 
cuºMB
, 
ty≥
)

96 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

97 
k
;

98 
k1
 = 
maxpos
[
ty≥
]-1;

99 #i‡
ENABLE_FIELD_CTX


100 
Êd
 = ( 
cuºSli˚
->
°ru˘uª
!=
FRAME
 || 
cuºMB
->
mb_fõld
 );

102 
Êd
 = 0;

104 
BiC⁄ãxtTy≥På
 
m≠_˘x
 = 
cuºSli˚
->
ãx_˘x
->
m≠_c⁄ãxts
 [
Êd
][
ty≥2˘x_m≠
 [
ty≥
]];

105 
BiC⁄ãxtTy≥På
 
œ°_˘x
 = 
cuºSli˚
->
ãx_˘x
->
œ°_c⁄ãxts
[
Êd
][
ty≥2˘x_œ°
[
ty≥
]];

106 c⁄° 
byã
 *
pos2˘xm≠
 = 
Êd
 ? 
pos2˘x_m≠_öt
 [
ty≥
] : 
pos2˘x_m≠
[type];

107 c⁄° 
byã
 *
pos2˘xœ°
 = 
pos2˘x_œ°
[
ty≥
];

109 
e°BôsCabacSåu˘
 *
ˇbacE°Bôs
 = &
cuºSli˚
->
e°BôsCabac
[
ty≥
];

111 
k
 = 0; k < 
k1
; k++)

113 
ˇbacE°Bôs
->
signifiˇ¡Bôs
[
pos2˘xm≠
[
k
]][0] = 
	`büri_no_bôs
 (0, 
m≠_˘x
 +Öos2ctxmap[k]);

115 
ˇbacE°Bôs
->
signifiˇ¡Bôs
[
pos2˘xm≠
[
k
]][1] = 
	`büri_no_bôs
 (1, 
m≠_˘x
 +Öos2ctxmap[k]);

117 
ˇbacE°Bôs
->
œ°Bôs
[
pos2˘xœ°
[
k
]][0] = 
	`büri_no_bôs
(0, 
œ°_˘x
+pos2ctxlast[k]);

119 
ˇbacE°Bôs
->
œ°Bôs
[
pos2˘xœ°
[
k
]][1] = 
	`büri_no_bôs
(1, 
œ°_˘x
+pos2ctxlast[k]);

122 
ˇbacE°Bôs
->
signifiˇ¡Bôs
[
pos2˘xm≠
[
k1
]][0]=0;

123 
ˇbacE°Bôs
->
signifiˇ¡Bôs
[
pos2˘xm≠
[
k1
]][1]=0;

124 
ˇbacE°Bôs
->
œ°Bôs
[
pos2˘xœ°
[
k1
]][0]=0;

125 
ˇbacE°Bôs
->
œ°Bôs
[
pos2˘xœ°
[
k1
]][1]=0;

126 
	}
}

134 
	$e°_signifiˇ¡_c€fficõ¡s
 (
Ma¸oblock
* 
cuºMB
, 
ty≥
)

136 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

137 
˘x
;

138 
maxCtx
 = 
	`imö
(4, 
max_c2
[
ty≥
]);

139 
e°BôsCabacSåu˘
 *
ˇbacE°Bôs
 = &
cuºSli˚
->
e°BôsCabac
[
ty≥
];

141 
˘x
=0; ctx<=4; ctx++){

142 
ˇbacE°Bôs
->
gª©îO√Bôs
[0][
˘x
][0]=

143 
	`büri_no_bôs
 (0, 
cuºSli˚
->
ãx_˘x
->
⁄e_c⁄ãxts
[
ty≥2˘x_⁄e
[
ty≥
]] + 
˘x
);

145 
ˇbacE°Bôs
->
gª©îO√Bôs
[0][
˘x
][1]=

146 
	`büri_no_bôs
 (1, 
cuºSli˚
->
ãx_˘x
->
⁄e_c⁄ãxts
[
ty≥2˘x_⁄e
[
ty≥
]] + 
˘x
);

149 
˘x
=0; ctx<=
maxCtx
; ctx++){

150 
ˇbacE°Bôs
->
gª©îO√Bôs
[1][
˘x
][0]=

151 
	`büri_no_bôs
(0, 
cuºSli˚
->
ãx_˘x
->
abs_c⁄ãxts
[
ty≥2˘x_abs
[
ty≥
]] + 
˘x
);

153 
ˇbacE°Bôs
->
gª©îO√Sèã
[
˘x
]=
	`büri_°©e
(0, 
cuºSli˚
->
ãx_˘x
->
abs_c⁄ãxts
[
ty≥2˘x_abs
[
ty≥
]] + ctx);

155 
ˇbacE°Bôs
->
gª©îO√Bôs
[1][
˘x
][1]=

156 
	`büri_no_bôs
(1, 
cuºSli˚
->
ãx_˘x
->
abs_c⁄ãxts
[
ty≥2˘x_abs
[
ty≥
]] + 
˘x
);

158 
	}
}

166 
	$e°_u«ry_exp_gﬁomb_Àvñ_ícode
(
Ma¸oblock
 *
cuºMB
, 
symbﬁ
, 
˘x
, 
ty≥
)

168 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

169 
e°BôsCabacSåu˘
 *
ˇbacE°Bôs
 = &
cuºSli˚
->
e°BôsCabac
[
ty≥
];

170 
l
 = 
symbﬁ
, 
k
 = 1;

171 
exp_°¨t
 = 13;

172 
e°Bôs
;

174 i‡(
symbﬁ
==0)

176 
e°Bôs
 = 
ˇbacE°Bôs
->
gª©îO√Bôs
[1][
˘x
][0];

177  (
e°Bôs
);

181 
e°Bôs
 = 
ˇbacE°Bôs
->
gª©îO√Bôs
[1][
˘x
][1];

183 ((--
l
)>0Ë&& (++
k
 <
exp_°¨t
))

185 
e°Bôs
 +
ˇbacE°Bôs
->
gª©îO√Bôs
[1][
˘x
][1];

188 i‡(
symbﬁ
 < 
exp_°¨t
)

190 
e°Bôs
 +
ˇbacE°Bôs
->
gª©îO√Bôs
[1][
˘x
][0];

194 
e°Bôs
 +
	`e°_exp_gﬁomb_ícode_eq_¥ob
(
symbﬁ
 - 
exp_°¨t
);

197 (
e°Bôs
);

198 
	}
}

200 
	$¥eˇlcuœã_u«ry_exp_gﬁomb_Àvñ
(
VideoP¨amëîs
 *
p_Vid
)

202 
°©e
, 
˘x_°©e0
, 
˘x_°©e1
, 
e°Bôs0
, 
e°Bôs1
, 
symbﬁ
;

204 
°©e
=0; state<=63; state++)

207 
˘x_°©e0
 = 64 + 
°©e
;

208 
e°Bôs0
 = 
íå›yBôs
[127-
˘x_°©e0
];

209 
˘x_°©e1
 = 63 - 
°©e
;

210 
e°Bôs1
 = 
íå›yBôs
[127-
˘x_°©e1
];

212 
symbﬁ
 = 0; symbﬁ < 
MAX_PREC_COEFF
; symbol++)

214 
p_Vid
->
¥eˇlcU«ryLevñTab
[
˘x_°©e0
][
symbﬁ
] = 
	`e°_u«ry_exp_gﬁomb_Àvñ_bôs
(symbﬁ, 
e°Bôs0
, 
e°Bôs1
);

217 
p_Vid
->
¥eˇlcU«ryLevñTab
[
˘x_°©e1
][
symbﬁ
] =
	`e°_u«ry_exp_gﬁomb_Àvñ_bôs
(symbﬁ, 
e°Bôs1
, 
e°Bôs0
);

220 
	}
}

222 
	$e°_u«ry_exp_gﬁomb_Àvñ_bôs
(
symbﬁ
, 
bôs0
, 
bôs1
)

224 
l
,
k
;

225 
exp_°¨t
 = 13;

226 
e°Bôs
;

228 i‡(
symbﬁ
 == 0)

230  (
bôs0
);

234 
e°Bôs
 = 
bôs1
;

235 
l
 = 
symbﬁ
;

236 
k
 = 1;

237 ((--
l
)>0Ë&& (++
k
 <
exp_°¨t
))

239 
e°Bôs
 +
bôs1
;

241 i‡(
symbﬁ
 < 
exp_°¨t
)

243 
e°Bôs
 +
bôs0
;

247 
e°Bôs
 +
	`e°_exp_gﬁomb_ícode_eq_¥ob
(
symbﬁ
 - 
exp_°¨t
);

250 (
e°Bôs
);

251 
	}
}

259 
	$e°_exp_gﬁomb_ícode_eq_¥ob
(
symbﬁ
)

261 
k
 = 0, 
e°Bôs
 = 0;

265 i‡(
symbﬁ
 >()(1<<
k
))

267 
e°Bôs
++;

268 
symbﬁ
 -(1 << 
k
);

269 
k
++;

273 
e°Bôs
 +(
k
 + 1);

277 (
e°Bôs
);

278 
	}
}

286 
	$e°RunLevñ_CABAC
 (
Ma¸oblock
 *
cuºMB
, 
c⁄ãxt
)

288 
	`e°_CBP_block_bô
 (
cuºMB
, 
c⁄ãxt
);

290 
	`e°_signifiˇn˚_m≠
 (
cuºMB
, 
c⁄ãxt
);

292 
	`e°_signifiˇ¡_c€fficõ¡s
 (
cuºMB
, 
c⁄ãxt
);

293 
	}
}

302 
	$e°_wrôe_™d_°‹e_CBP_block_bô
(
Ma¸oblock
* 
cuºMB
, 
ty≥
)

304 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

305 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

306 
e°BôsCabacSåu˘
 *
ˇbacE°Bôs
 = &
cuºSli˚
->
e°BôsCabac
[
ty≥
];

308 
y_ac
 = (
ty≥
==
LUMA_16AC
 ||Åy≥==
LUMA_8x8
 ||Åy≥==
LUMA_8x4
 ||Åy≥==
LUMA_4x8
 ||Åy≥==
LUMA_4x4


309 || 
ty≥
==
CB_16AC
 ||Åy≥==
CB_8x8
 ||Åy≥==
CB_8x4
 ||Åy≥==
CB_4x8
 ||Åy≥==
CB_4x4


310 || 
ty≥
==
CR_16AC
 ||Åy≥==
CR_8x8
 ||Åy≥==
CR_8x4
 ||Åy≥==
CR_4x8
 ||Åy≥==
CR_4x4
);

311 
y_dc
 = (
ty≥
==
LUMA_16DC
 ||Åy≥==
CB_16DC
 ||Åy≥==
CR_16DC
);

312 
u_ac
 = (
ty≥
==
CHROMA_AC
 && !
p_Vid
->
is_v_block
);

313 
v_ac
 = (
ty≥
==
CHROMA_AC
 && 
p_Vid
->
is_v_block
);

314 
chroma_dc
 = (
ty≥
==
CHROMA_DC
 ||Åy≥==
CHROMA_DC_2x4
 ||Åy≥==
CHROMA_DC_4x4
);

315 
u_dc
 = (
chroma_dc
 && !
p_Vid
->
is_v_block
);

316 
v_dc
 = (
chroma_dc
 && 
p_Vid
->
is_v_block
);

317 
j
 = (
y_ac
 || 
u_ac
 || 
v_ac
 ? 
cuºMB
->
subblock_y
 : 0);

318 
i
 = (
y_ac
 || 
u_ac
 || 
v_ac
 ? 
cuºMB
->
subblock_x
 : 0);

319 
bô
;

320 
deÁu…_bô
 = (
	`is_öåa
(
cuºMB
) ? 1 : 0);

321 
uµî_bô
 = 
deÁu…_bô
;

322 
À·_bô
 = 
deÁu…_bô
;

323 
˘x
, 
e°Bôs
 = 0;

325 
bô_pos_a
 = 0;

326 
bô_pos_b
 = 0;

328 
PixñPos
 
block_a
, 
block_b
;

330 i‡(
y_ac
 || 
y_dc
)

332 
	`gë4x4Neighbour
(
cuºMB
, 
i
 - 1, 
j
 , 
p_Vid
->
mb_size
[
IS_LUMA
], &
block_a
);

333 
	`gë4x4Neighbour
(
cuºMB
, 
i
, 
j
 -1, 
p_Vid
->
mb_size
[
IS_LUMA
], &
block_b
);

334 i‡(
y_ac
)

336 i‡(
block_a
.
avaûabÀ
)

337 
bô_pos_a
 = 4*
block_a
.
y
 + block_a.
x
;

338 i‡(
block_b
.
avaûabÀ
)

339 
bô_pos_b
 = 4*
block_b
.
y
 + block_b.
x
;

344 
	`gë4x4Neighbour
(
cuºMB
, 
i
 - 1, 
j
 , 
p_Vid
->
mb_size
[
IS_CHROMA
], &
block_a
);

345 
	`gë4x4Neighbour
(
cuºMB
, 
i
, 
j
 - 1, 
p_Vid
->
mb_size
[
IS_CHROMA
], &
block_b
);

346 i‡(
u_ac
||
v_ac
)

348 i‡(
block_a
.
avaûabÀ
)

349 
bô_pos_a
 = (
block_a
.
y
 << 2Ë+ block_a.
x
;

350 i‡(
block_b
.
avaûabÀ
)

351 
bô_pos_b
 = (
block_b
.
y
 << 2Ë+ block_b.
x
;

355 
bô
 = (
y_dc
 ? 0 : 
y_ac
 ? 1 : 
u_dc
 ? 17 : 
v_dc
 ? 18 : 
u_ac
 ? 19 : 35);

357 i‡(
p_Vid
->
íc_pi˘uª
->
chroma_f‹m©_idc
!=
YUV444
 || (
cuºMB
->
p_I≈
->
£∑øã_cﬁour_∂™e_Êag
 != 0))

359 i‡(
ty≥
!=
LUMA_8x8
)

361 i‡(
block_b
.
avaûabÀ
)

363 if(
p_Vid
->
mb_d©a
[
block_b
.
mb_addr
].
mb_ty≥
==
IPCM
)

364 
uµî_bô
 = 1;

366 
uµî_bô
 = 
	`gë_bô
(
p_Vid
->
mb_d©a
[
block_b
.
mb_addr
].
cbp_bôs
[0], 
bô
 + 
bô_pos_b
);

369 i‡(
block_a
.
avaûabÀ
)

371 if(
p_Vid
->
mb_d©a
[
block_a
.
mb_addr
].
mb_ty≥
==
IPCM
)

372 
À·_bô
 = 1;

374 
À·_bô
 = 
	`gë_bô
(
p_Vid
->
mb_d©a
[
block_a
.
mb_addr
].
cbp_bôs
[0], 
bô
 + 
bô_pos_a
);

377 
˘x
 = 2*
uµî_bô
+
À·_bô
;

379 
e°Bôs
 = 
ˇbacE°Bôs
->
blockCbpBôs
[
˘x
][0] - cabacEstBits->blockCbpBits[ctx][1];

384 i‡(
block_b
.
avaûabÀ
)

386 if(
p_Vid
->
mb_d©a
[
block_b
.
mb_addr
].
mb_ty≥
 =
IPCM
)

387 
uµî_bô
=1;

390 if(
ty≥
==
LUMA_8x8
)

391 
uµî_bô
 = 
	`gë_bô
(
p_Vid
->
mb_d©a
[
block_b
.
mb_addr
].
cbp_bôs_8x8
[0], 
bô
 + 
bô_pos_b
);

392 i‡(
ty≥
==
CB_8x8
)

393 
uµî_bô
 = 
	`gë_bô
(
p_Vid
->
mb_d©a
[
block_b
.
mb_addr
].
cbp_bôs_8x8
[1], 
bô
 + 
bô_pos_b
);

394 i‡(
ty≥
==
CR_8x8
)

395 
uµî_bô
 = 
	`gë_bô
(
p_Vid
->
mb_d©a
[
block_b
.
mb_addr
].
cbp_bôs_8x8
[2], 
bô
 + 
bô_pos_b
);

396 i‡((
ty≥
==
CB_4x4
)||—y≥==
CB_4x8
)||—y≥==
CB_8x4
)||—y≥==
CB_16AC
)||—y≥==
CB_16DC
))

397 
uµî_bô
 = 
	`gë_bô
(
p_Vid
->
mb_d©a
[
block_b
.
mb_addr
].
cbp_bôs
[1], 
bô
 + 
bô_pos_b
);

398 i‡((
ty≥
==
CR_4x4
)||—y≥==
CR_4x8
)||—y≥==
CR_8x4
)||—y≥==
CR_16AC
)||—y≥==
CR_16DC
))

399 
uµî_bô
 = 
	`gë_bô
(
p_Vid
->
mb_d©a
[
block_b
.
mb_addr
].
cbp_bôs
[2], 
bô
 + 
bô_pos_b
);

401 
uµî_bô
 = 
	`gë_bô
(
p_Vid
->
mb_d©a
[
block_b
.
mb_addr
].
cbp_bôs
[0], 
bô
 + 
bô_pos_b
);

405 i‡(
block_a
.
avaûabÀ
)

407 if(
p_Vid
->
mb_d©a
[
block_a
.
mb_addr
].
mb_ty≥
==
IPCM
)

408 
À·_bô
 = 1;

411 if(
ty≥
==
LUMA_8x8
)

412 
À·_bô
 = 
	`gë_bô
(
p_Vid
->
mb_d©a
[
block_a
.
mb_addr
].
cbp_bôs_8x8
[0],
bô
 + 
bô_pos_a
);

413 i‡(
ty≥
==
CB_8x8
)

414 
À·_bô
 = 
	`gë_bô
(
p_Vid
->
mb_d©a
[
block_a
.
mb_addr
].
cbp_bôs_8x8
[1],
bô
 + 
bô_pos_a
);

415 i‡(
ty≥
==
CR_8x8
)

416 
À·_bô
 = 
	`gë_bô
(
p_Vid
->
mb_d©a
[
block_a
.
mb_addr
].
cbp_bôs_8x8
[2],
bô
 + 
bô_pos_a
);

417 i‡((
ty≥
==
CB_4x4
)||—y≥==
CB_4x8
)||—y≥==
CB_8x4
)||—y≥==
CB_16AC
)||—y≥==
CB_16DC
))

418 
À·_bô
 = 
	`gë_bô
(
p_Vid
->
mb_d©a
[
block_a
.
mb_addr
].
cbp_bôs
[1], 
bô
 + 
bô_pos_a
);

419 i‡((
ty≥
==
CR_4x4
)||—y≥==
CR_4x8
)||—y≥==
CR_8x4
)||—y≥==
CR_16AC
)||—y≥==
CR_16DC
))

420 
À·_bô
 = 
	`gë_bô
(
p_Vid
->
mb_d©a
[
block_a
.
mb_addr
].
cbp_bôs
[2], 
bô
 + 
bô_pos_a
);

422 
À·_bô
 = 
	`gë_bô
(
p_Vid
->
mb_d©a
[
block_a
.
mb_addr
].
cbp_bôs
[0], 
bô
 + 
bô_pos_a
);

426 
˘x
 = 2*
uµî_bô
+
À·_bô
;

429 
e°Bôs
 = 
ˇbacE°Bôs
->
blockCbpBôs
[
˘x
][0] - cabacEstBits->blockCbpBits[ctx][1];

432 (
e°Bôs
);

433 
	}
}

440 
	$e°_wrôeRunLevñ_CABAC
(
Ma¸oblock
 *
cuºMB
, 
ÀvñD©aSåu˘
 
ÀvñD©a
[], 
ÀvñTabMö
[], 
ty≥
, 
œmbda
, 
kInô
, 
kSt›
,

441 
noC€ff
, 
e°CBP
)

443 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

444 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

445 
e°BôsCabacSåu˘
 *
ˇbacE°Bôs
 = &
cuºSli˚
->
e°BôsCabac
[
ty≥
];

446 
k
, 
i
;

447 
e°Bôs
;

448 
œgr
, 
œgrMö
=0, 
œgrTabMö
, 
œgrTab
;

449 
c1
 = 1, 
c2
 = 0, 
c1Tab
[3], 
c2Tab
[3];

450 
iBe°
, 
ÀvñTab
[64];

451 
˘x
, 
gª©î_⁄e
, 
œ°
, 
maxK
 = 
maxpos
[
ty≥
];

452 
œgrAcc
, 
œgrLa°Mö
=0, 
œgrLa°
;

453 
kBe°
=0, 
kSèπ
, 
fú°
;

454 
ÀvñD©aSåu˘
 *
d©aLevñ
;

455 *
œ°_bôs
, *
signifiˇ¡_bôs
;

457 
	`mem£t
(
ÀvñTabMö
, 0, (
maxK
 + 1) * ());

459 i‡(
noC€ff
 > 0)

461 i‡(
noC€ff
 > 1)

463 
kSèπ
 = 
kInô
; 
kBe°
 = 0; 
fú°
 = 1;

464 
œgrAcc
 = 0.0;

466 
k
 = 
kSèπ
; k <
kSt›
; k++)

468 
œgrAcc
 +
ÀvñD©a
[
k
].
îrLevñ
[0];

471 i‡(
ÀvñD©a
[
kSèπ
].
noLevñs
 > 2)

473 
œ°_bôs
 = 
ˇbacE°Bôs
->
œ°Bôs
[
pos2˘x_œ°
[
ty≥
][
kSèπ
]];

474 
œgrAcc
 -
ÀvñD©a
[
kSèπ
].
îrLevñ
[0];

475 
œgrLa°Mö
 = 
œmbda
 * (
œ°_bôs
[1] -Üa°_bôs[0]Ë+ 
œgrAcc
;

477 
kBe°
 = 
kSèπ
;

478 
kSèπ
++;

479 
fú°
 = 0;

482 
k
 = 
kSèπ
; k <
kSt›
; k++)

484 
d©aLevñ
 = &
ÀvñD©a
[
k
];

485 
signifiˇ¡_bôs
 = 
ˇbacE°Bôs
->
signifiˇ¡Bôs
[
pos2˘x_m≠
[
ty≥
][
k
]];

486 
œgrMö
 = 
d©aLevñ
->
îrLevñ
[0] + 
œmbda
 * 
signifiˇ¡_bôs
[0];

487 
œgrAcc
 -
d©aLevñ
->
îrLevñ
[0];

489 i‡(
d©aLevñ
->
noLevñs
 > 1)

491 
œ°_bôs
 = 
ˇbacE°Bôs
->
œ°Bôs
[
pos2˘x_œ°
[
ty≥
][
k
]];

492 
e°Bôs
 = 
SIGN_BITS
 + 
signifiˇ¡_bôs
[1] + 
ˇbacE°Bôs
->
gª©îO√Bôs
[0][4][0];

494 
œgr
 = 
d©aLevñ
->
îrLevñ
[1] + 
œmbda
 * (
e°Bôs
);

496 
œgrLa°
 = 
œgr
 + 
œmbda
 * 
œ°_bôs
[1] + 
œgrAcc
;

497 
œgr
 =Üag∏+ 
œmbda
 * 
œ°_bôs
[0];

499 
œgrMö
 = (
œgr
 <ÜagrMin) ?Üagr :ÜagrMin;

501 i‡((
œgrLa°
 < 
œgrLa°Mö
Ë|| (
fú°
 == 1))

503 
kBe°
 = 
k
;

504 
fú°
 = 0;

505 
œgrLa°Mö
 = 
œgrLa°
;

508 
œgrAcc
 +
œgrMö
;

510 
kSèπ
 = 
kBe°
;

514 
kSèπ
 = 
kSt›
;

517 
œgrTabMö
 = 0.0;

518 
k
 = 0; k <
kSèπ
; k++)

520 
œgrTabMö
 +
ÀvñD©a
[
k
].
îrLevñ
[0];

523 
œgrTab
 = 0.0;

527 
œgrTabMö
 +(
œmbda
*
e°CBP
);

528 
iBe°
 = 0; 
fú°
 = 1;

529 
k
 = 
kSèπ
; k >= 0; k--)

531 
signifiˇ¡_bôs
 = 
ˇbacE°Bôs
->
signifiˇ¡Bôs
[
pos2˘x_m≠
[
ty≥
][
k
]];

532 
œ°_bôs
 = 
ˇbacE°Bôs
->
œ°Bôs
[
pos2˘x_œ°
[
ty≥
][
k
]];

533 
d©aLevñ
 = &
ÀvñD©a
[
k
];

534 
œ°
 = (
k
 =
kSèπ
);

536 i‡(!
œ°
)

538 
œgrMö
 = 
d©aLevñ
->
îrLevñ
[0] + 
œmbda
 * 
signifiˇ¡_bôs
[0];

539 
iBe°
 = 0;

540 
fú°
 = 0;

543 
i
 = 1; i < 
d©aLevñ
->
noLevñs
; i++)

545 
e°Bôs
 = 
SIGN_BITS
 + 
signifiˇ¡_bôs
[1];

546 
e°Bôs
 +
œ°_bôs
[
œ°
];

549 
gª©î_⁄e
 = (
d©aLevñ
->
Àvñ
[
i
] > 1);

551 
c1Tab
[
i
] = 
c1
;

552 
c2Tab
[
i
] = 
c2
;

554 
˘x
 = 
	`imö
(
c1Tab
[
i
], 4);

555 
e°Bôs
 +
ˇbacE°Bôs
->
gª©îO√Bôs
[0][
˘x
][
gª©î_⁄e
];

558 i‡(
gª©î_⁄e
)

560 
˘x
 = 
	`imö
(
c2Tab
[
i
], 
max_c2
[
ty≥
]);

561 i‡–(
d©aLevñ
->
Àvñ
[
i
] - 2Ë< 
MAX_PREC_COEFF
)

563 
e°Bôs
 +
p_Vid
->
¥eˇlcU«ryLevñTab
[
ˇbacE°Bôs
->
gª©îO√Sèã
[
˘x
]][
d©aLevñ
->
Àvñ
[
i
] - 2];

567 
e°Bôs
 +
	`e°_u«ry_exp_gﬁomb_Àvñ_ícode
(
cuºMB
, 
d©aLevñ
->
Àvñ
[
i
] - 2, 
˘x
, 
ty≥
);

570 
c1Tab
[
i
] = 0;

571 
c2Tab
[
i
]++;

573 i‡(
c1Tab
[
i
])

575 
c1Tab
[
i
]++;

578 
œgr
 = 
d©aLevñ
->
îrLevñ
[
i
] + 
œmbda
 * 
e°Bôs
;

579 i‡((
œgr
 < 
œgrMö
Ë|| (
fú°
 == 1))

581 
iBe°
 = 
i
;

582 
œgrMö
=
œgr
;

583 
fú°
 = 0;

587 i‡(
iBe°
 > 0)

589 
c1
 = 
c1Tab
[
iBe°
];

590 
c2
 = 
c2Tab
[
iBe°
];

593 
ÀvñTab
[
k
] = 
d©aLevñ
->
Àvñ
[
iBe°
];

594 
œgrTab
 +
œgrMö
;

598 i‡(
œgrTab
 < 
œgrTabMö
)

600 
	`mem˝y
(
ÀvñTabMö
, 
ÀvñTab
, (
kSèπ
 + 1) * ());

603 
	}
}

612 
	$öô_åñlis_d©a_4x4_CABAC
(
Ma¸oblock
 *
cuºMB
, **
tblock
,

613 
qu™t_mëhods
 *
q_mëhod
, c⁄° 
byã
 *
p_sˇn
,

614 
ÀvñD©aSåu˘
 *
d©aLevñ
, * 
kSèπ
, * 
kSt›
, 
ty≥
)

616 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

617 
LevñQu™tP¨ams
 **
q_∑øms_4x4
 = 
q_mëhod
->
q_∑øms
;

618 
Qu™tP¨amëîs
 *
p_Qu™t
 = 
p_Vid
->p_Quant;

619 
qp
 = 
q_mëhod
->qp;

620 
qp_≥r
 = 
p_Qu™t
->
qp_≥r_m©rix
[
qp
];

621 
qp_ªm
 = 
p_Qu™t
->
qp_ªm_m©rix
[
qp
];

622 
block_x
 = 
q_mëhod
->block_x;

624 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

625 
noC€ff
 = 0;

626 
i
, 
j
, 
c€ff_˘r
;

627 *
m7
;

628 
íd_c€ff_˘r
 = ( ( 
ty≥
 =
LUMA_4x4
 ) ? 16 : 15 );

629 
q_bôs
 = 
Q_BITS
 + 
qp_≥r
;

630 
q_off£t
 = ( 1 << (
q_bôs
 - 1) );

631 
sˇÀd_c€ff
, 
Àvñ
, 
lowîI¡
, 
k
;

632 
îr
, 
e°Eº
;

634 
c€ff_˘r
 = 0; c€ff_˘∏< 
íd_c€ff_˘r
; coeff_ctr++)

636 
i
 = *
p_sˇn
++;

637 
j
 = *
p_sˇn
++;

639 
m7
 = &
tblock
[
j
][
block_x
 + 
i
];

641 i‡(*
m7
 == 0)

643 
d©aLevñ
->
Àvñ
[0] = 0;

644 
d©aLevñ
->
ÀvñDoubÀ
 = 0;

645 
d©aLevñ
->
îrLevñ
[0] = 0.0;

646 
d©aLevñ
->
noLevñs
 = 1;

651 
e°Eº
 = ((Ë
e°Eº4x4
[
qp_ªm
][
j
][
i
]Ë/ 
cuºSli˚
->
n‹m_Á˘‹_4x4
;

653 
sˇÀd_c€ff
 = 
	`übs
(*
m7
Ë* 
q_∑øms_4x4
[
j
][
i
].
SˇÀComp
;

654 
d©aLevñ
->
ÀvñDoubÀ
 = 
sˇÀd_c€ff
;

655 
Àvñ
 = (
sˇÀd_c€ff
 >> 
q_bôs
);

657 
lowîI¡
 = ((
sˇÀd_c€ff
 - (
Àvñ
 << 
q_bôs
)Ë< 
q_off£t
 )? 1 : 0;

659 #i‡
RDOQ_SQ


660 
d©aLevñ
->
Àvñ
[0] = 
	`max
(0,Üevel - 1);

662 
d©aLevñ
->
Àvñ
[0] = 0;

664 i‡(
Àvñ
 == 0)

666 i‡(
lowîI¡
 == 1)

668 
d©aLevñ
->
noLevñs
 = 1;

672 
d©aLevñ
->
Àvñ
[1] = 1;

673 
d©aLevñ
->
noLevñs
 = 2;

674 *
kSt›
 = 
c€ff_˘r
;

675 
noC€ff
++;

678 i‡(
lowîI¡
 == 1)

680 
d©aLevñ
->
Àvñ
[1] =Üevel;

681 
d©aLevñ
->
noLevñs
 = 2;

682 *
kSt›
 = 
c€ff_˘r
;

683 
noC€ff
++;

687 
d©aLevñ
->
Àvñ
[1] =Üevel;

688 
d©aLevñ
->
Àvñ
[2] =Üevel + 1;

689 
d©aLevñ
->
noLevñs
 = 3;

690 *
kSt›
 = 
c€ff_˘r
;

691 *
kSèπ
 = 
c€ff_˘r
;

692 
noC€ff
++;

695 
k
 = 0; k < 
d©aLevñ
->
noLevñs
; k++)

697 
îr
 = ()(
d©aLevñ
->
Àvñ
[
k
] << 
q_bôs
Ë- ()
sˇÀd_c€ff
;

698 
d©aLevñ
->
îrLevñ
[
k
] = (
îr
 *Éº * 
e°Eº
);

702 
d©aLevñ
++;

704  (
noC€ff
);

705 
	}
}

713 
	$öô_åñlis_d©a_8x8_CABAC
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
block_x
, 
qp_≥r
, 
qp_ªm
, 
LevñQu™tP¨ams
 **
q_∑øms
, c⁄° 
byã
 *
p_sˇn
,

714 
ÀvñD©aSåu˘
 *
d©aLevñ
, * 
kSèπ
, * 
kSt›
)

716 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

717 
noC€ff
 = 0;

718 *
m7
;

719 
i
, 
j
, 
c€ff_˘r
, 
íd_c€ff_˘r
 = 64;

720 
q_bôs
 = 
Q_BITS_8
 + 
qp_≥r
;

721 
q_off£t
 = ( 1 << (
q_bôs
 - 1) );

722 
îr
, 
e°Eº
;

723 
Àvñ
, 
lowîI¡
, 
k
;

724 
sˇÀd_c€ff
;

726 
c€ff_˘r
 = 0; c€ff_˘∏< 
íd_c€ff_˘r
; coeff_ctr++)

728 
i
 = *
p_sˇn
++;

729 
j
 = *
p_sˇn
++;

731 
m7
 = &
tblock
[
j
][
block_x
 + 
i
];

733 i‡(*
m7
 == 0)

735 
d©aLevñ
->
Àvñ
[0] = 0;

736 
d©aLevñ
->
ÀvñDoubÀ
 = 0;

737 
d©aLevñ
->
îrLevñ
[0] = 0.0;

738 
d©aLevñ
->
noLevñs
 = 1;

743 
e°Eº
 = (Ë
e°Eº8x8
[
qp_ªm
][
j
][
i
] / 
cuºSli˚
->
n‹m_Á˘‹_8x8
;

745 
sˇÀd_c€ff
 = 
	`übs
(*
m7
Ë* 
q_∑øms
[
j
][
i
].
SˇÀComp
;

746 
d©aLevñ
->
ÀvñDoubÀ
 = 
sˇÀd_c€ff
;

747 
Àvñ
 = (
sˇÀd_c€ff
 >> 
q_bôs
);

749 
lowîI¡
 = ((
sˇÀd_c€ff
 - (
Àvñ
 << 
q_bôs
)Ë< 
q_off£t
 )? 1 : 0;

751 #i‡
RDOQ_SQ


752 
d©aLevñ
->
Àvñ
[0] = 
	`max
(0,Üevel - 1);

754 
d©aLevñ
->
Àvñ
[0] = 0;

756 i‡(
Àvñ
 == 0)

758 i‡(
lowîI¡
 == 1)

760 
d©aLevñ
->
noLevñs
 = 1;

764 
d©aLevñ
->
Àvñ
[1] = 1;

765 
d©aLevñ
->
noLevñs
 = 2;

766 *
kSt›
 = 
c€ff_˘r
;

767 
noC€ff
++;

770 i‡(
lowîI¡
 == 1)

772 
d©aLevñ
->
Àvñ
[1] =Üevel;

773 
d©aLevñ
->
noLevñs
 = 2;

774 *
kSt›
 = 
c€ff_˘r
;

775 
noC€ff
++;

779 
d©aLevñ
->
Àvñ
[1] =Üevel;

780 
d©aLevñ
->
Àvñ
[2] =Üevel + 1;

781 
d©aLevñ
->
noLevñs
 = 3;

782 *
kSt›
 = 
c€ff_˘r
;

783 *
kSèπ
 = 
c€ff_˘r
;

784 
noC€ff
++;

787 
k
 = 0; k < 
d©aLevñ
->
noLevñs
; k++)

789 
îr
 = ()(
d©aLevñ
->
Àvñ
[
k
] << 
q_bôs
Ë- ()
sˇÀd_c€ff
;

790 
d©aLevñ
->
îrLevñ
[
k
] = (
îr
 *Éº * 
e°Eº
);

794 
d©aLevñ
++;

796  (
noC€ff
);

797 
	}
}

805 
	$öô_åñlis_d©a_DC_CABAC
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qp_≥r
, 
qp_ªm
,

806 
LevñQu™tP¨ams
 *
q_∑øms
, c⁄° 
byã
 *
p_sˇn
,

807 
ÀvñD©aSåu˘
 *
d©aLevñ
, * 
kSèπ
, * 
kSt›
)

809 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

810 
noC€ff
 = 0;

811 
i
, 
j
, 
c€ff_˘r
, 
íd_c€ff_˘r
 = 16;

812 
q_bôs
 = 
Q_BITS
 + 
qp_≥r
 + 1;

813 
q_off£t
 = ( 1 << (
q_bôs
 - 1) );

814 
sˇÀd_c€ff
, 
Àvñ
, 
lowîI¡
, 
k
;

815 *
m7
;

816 
îr
, 
e°Eº
 = (Ë
e°Eº4x4
[
qp_ªm
][0][0] / 
cuºSli˚
->
n‹m_Á˘‹_4x4
;

818 
c€ff_˘r
 = 0; c€ff_˘∏< 
íd_c€ff_˘r
; coeff_ctr++)

820 
i
 = *
p_sˇn
++;

821 
j
 = *
p_sˇn
++;

822 
m7
 = &
tblock
[
j
][
i
];

824 i‡(*
m7
 == 0)

826 
d©aLevñ
->
Àvñ
[0] = 0;

827 
d©aLevñ
->
ÀvñDoubÀ
 = 0;

828 
d©aLevñ
->
îrLevñ
[0] = 0.0;

829 
d©aLevñ
->
noLevñs
 = 1;

834 
sˇÀd_c€ff
 = 
	`übs
(*
m7
Ë* 
q_∑øms
->
SˇÀComp
;

835 
d©aLevñ
->
ÀvñDoubÀ
 = 
sˇÀd_c€ff
;

836 
Àvñ
 = (
sˇÀd_c€ff
 >> 
q_bôs
);

838 
lowîI¡
=–(
sˇÀd_c€ff
 - (
Àvñ
<<
q_bôs
)Ë< 
q_off£t
 )? 1 : 0;

840 #i‡
RDOQ_SQ


841 
d©aLevñ
->
Àvñ
[0] = 
	`max
(0,Üevel - 1);

843 
d©aLevñ
->
Àvñ
[0] = 0;

845 i‡(
Àvñ
 == 0)

847 i‡(
lowîI¡
 == 1)

849 
d©aLevñ
->
noLevñs
 = 1;

853 
d©aLevñ
->
Àvñ
[1] = 1;

854 
d©aLevñ
->
noLevñs
 = 2;

855 *
kSt›
 = 
c€ff_˘r
;

856 
noC€ff
++;

859 i‡(
lowîI¡
 == 1)

861 
d©aLevñ
->
Àvñ
[1] =Üevel;

862 
d©aLevñ
->
noLevñs
 = 2;

863 *
kSt›
 = 
c€ff_˘r
;

864 
noC€ff
++;

868 
d©aLevñ
->
Àvñ
[1] =Üevel;

869 
d©aLevñ
->
Àvñ
[2] =Üevel + 1;

870 
d©aLevñ
->
noLevñs
 = 3;

871 *
kSt›
 = 
c€ff_˘r
;

872 *
kSèπ
 = 
c€ff_˘r
;

873 
noC€ff
++;

876 
k
 = 0; k < 
d©aLevñ
->
noLevñs
; k++)

878 
îr
 = ()(
d©aLevñ
->
Àvñ
[
k
] << 
q_bôs
Ë- ()
sˇÀd_c€ff
;

879 
d©aLevñ
->
îrLevñ
[
k
] = (
îr
 *Éº * 
e°Eº
);

882 
d©aLevñ
++;

884  (
noC€ff
);

885 
	}
}

	@lencod/src/rdoq_cavlc.c

10 
	~"c⁄åibut‹s.h
"

12 
	~<m©h.h
>

13 
	~<Êﬂt.h
>

15 
	~"globÆ.h
"

16 
	~"image.h
"

17 
	~"fmo.h
"

18 
	~"ma¸oblock.h
"

19 
	~"mb_ac˚ss.h
"

20 
	~"rdoq.h
"

21 
	~"block.h
"

29 
	$e°Sy¡axEÀmít_Levñ_VLC1
(
Sy¡axEÀmít
 *
£
)

31 
Àvñ
 = 
£
->
vÆue1
;

32 
sign
 = (
Àvñ
 < 0 ? 1 : 0);

33 
Àvabs
 = 
	`übs
(
Àvñ
);

35 i‡(
Àvabs
 < 8)

37 
£
->
Àn
 = 
Àvabs
 * 2 + 
sign
 - 1;

39 i‡(
Àvabs
 < 16)

42 
£
->
Àn
 = 19;

47 
£
->
Àn
 = 28;

50  (
£
->
Àn
);

51 
	}
}

61 
	$e°Sy¡axEÀmít_Levñ_VLCN
(
Sy¡axEÀmít
 *
£
, 
vlc
)

63 
Àvñ
 = 
£
->
vÆue1
;

64 
Àvabs
 = 
	`übs
(
Àvñ
) - 1;

66 
shi·
 = 
vlc
 - 1;

67 
esˇ≥
 = (15 << 
shi·
);

69 i‡(
Àvabs
 < 
esˇ≥
)

71 
£
->
Àn
 = ((
Àvabs
Ë>> 
shi·
Ë+ 1 + 
vlc
;

75 
£
->
Àn
 = 28;

78  (
£
->
Àn
);

79 
	}
}

81 
	$cmp
(c⁄° *
¨g1
, c⁄° *
¨g2
)

83 if(((
ÀvñD©aSåu˘
 *)
¨g2
)->
ÀvñDoubÀ
 !(÷evñD©aSåu˘ *)
¨g1
)->levelDouble)

84  (((
ÀvñD©aSåu˘
 *)
¨g2
)->
ÀvñDoubÀ
 - (÷evñD©aSåu˘ *)
¨g1
)->levelDouble);

86  (((
ÀvñD©aSåu˘
 *)
¨g1
)->
c€ff_˘r
 - (÷evñD©aSåu˘ *)
¨g2
)->coeff_ctr);

87 
	}
}

95 
	$e°_CAVLC_bôs
 (
VideoP¨amëîs
 *
p_Vid
, 
Àvñ_to_íc
[16], 
sign_to_íc
[16], 
¬z
, 
block_ty≥
)

97 
no_bôs
 = 0;

98 
Sy¡axEÀmít
 
£
;

100 
c€ff_˘r
, 
sˇn_pos
 = 0;

101 
k
, 
Àvñ
 = 1, 
run
 = -1, 
vl˙um
;

102 
numc€ff
 = 0, 
œ°c€ff
 = 0, 
numåaûög⁄es
 = 0;

103 
num⁄es
 = 0, 
tŸzîos
 = 0, 
zîo¶e·
, 
numc€f
;

104 
numc€ff_vlc
;

105 
Àvñ_two_‹_highî
;

106 
max_c€ff_num
 = 0, 
cdc
 = (
block_ty≥
 =
CHROMA_DC
 ? 1 : 0);

107 
yuv
 = 
p_Vid
->
yuv_f‹m©
 - 1;

108 c⁄° 
öcVlc
[] = {0, 3, 6, 12, 24, 48, 32768};

110 
pLevñ
[16] = {0};

111 
pRun
[16] = {0};

113 c⁄° 
Tokí_À¡ab
[3][4][17] =

135 c⁄° 
TŸÆzîos_À¡ab
[
TOTRUN_NUM
][16] =

153 c⁄° 
Run_À¡ab
[
TOTRUN_NUM
][16] =

163 c⁄° 
Tokí_À¡ab_cdc
[3][4][17] =

181 c⁄° 
TŸÆzîos_À¡ab_cdc
[3][
TOTRUN_NUM
][16] =

213 
max_c€ff_num
 = ( (
block_ty≥
 =
CHROMA_DC
Ë? 
p_Vid
->
num_cdc_c€ff
 :

214 –(
block_ty≥
 =
LUMA_INTRA16x16AC
 || block_ty≥ =
CB_INTRA16x16AC
 || block_ty≥ =
CR_INTRA16x16AC
 || block_ty≥ =
CHROMA_AC
) ? 15 : 16) );

217 
c€ff_˘r
 = 0; c€ff_˘∏< 
max_c€ff_num
; coeff_ctr++)

219 
run
++;

220 
Àvñ
 = 
Àvñ_to_íc
[
c€ff_˘r
];

221 i‡(
Àvñ
 != 0)

223 
pLevñ
[
sˇn_pos
] = 
	`isig«b
(
Àvñ
, 
sign_to_íc
[
c€ff_˘r
]);

224 
pRun
 [
sˇn_pos
] = 
run
;

225 ++
sˇn_pos
;

226 
run
 = -1;

230 
Àvñ
 = 1;

231 
k
 = 0; (k < 
max_c€ff_num
Ë&& 
Àvñ
 != 0; k++)

233 
Àvñ
 = 
pLevñ
[
k
];

234 
run
 = 
pRun
[
k
];

236 i‡(
Àvñ
)

238 
tŸzîos
 +
run
;

239 i‡(
	`übs
(
Àvñ
) == 1)

241 
num⁄es
 ++;

242 
numåaûög⁄es
 ++;

243 
numåaûög⁄es
 = 
	`imö
(numtrailingones, 3);

247 
numåaûög⁄es
 = 0;

249 
numc€ff
 ++;

250 
œ°c€ff
 = 
k
;

254 i‡(!
cdc
)

256 
numc€ff_vlc
 = (
¬z
 < 2) ? 0 : ((nnz < 4) ? 1 : ((nnz < 8) ? 2 : 3));

262 
numc€ff_vlc
 = 0;

265 
£
.
vÆue1
 = 
numc€ff
;

266 
£
.
vÆue2
 = 
numåaûög⁄es
;

267 
£
.
Àn
 = 
numc€ff_vlc
;

269 i‡(!
cdc
)

271 i‡(
£
.
Àn
 == 3)

272 
no_bôs
 += 6;

274 
no_bôs
 +
Tokí_À¡ab
[
£
.
Àn
][£.
vÆue2
][£.
vÆue1
];

277 
no_bôs
 +
Tokí_À¡ab_cdc
[
yuv
][
£
.
vÆue2
][£.
vÆue1
];

279 i‡(!
numc€ff
)

280  
no_bôs
;

283 i‡(
numåaûög⁄es
)

284 
no_bôs
 +
numåaûög⁄es
;

287 
Àvñ_two_‹_highî
 = (
numc€ff
 > 3 && 
numåaûög⁄es
 == 3) ? 0 : 1;

289 
vl˙um
 = (
numc€ff
 > 10 && 
numåaûög⁄es
 < 3) ? 1 : 0;

291 
k
 = 
œ°c€ff
 - 
numåaûög⁄es
; k >= 0; k--)

293 
Àvñ
 = 
pLevñ
[
k
];

295 
£
.
vÆue1
 = 
Àvñ
;

297 i‡(
Àvñ_two_‹_highî
)

299 
Àvñ_two_‹_highî
 = 0;

300 i‡(
£
.
vÆue1
 > 0)

301 
£
.
vÆue1
 --;

303 
£
.
vÆue1
 ++;

307 i‡(
vl˙um
 == 0)

308 
	`e°Sy¡axEÀmít_Levñ_VLC1
(&
£
);

310 
	`e°Sy¡axEÀmít_Levñ_VLCN
(&
£
, 
vl˙um
);

313 i‡(
	`übs
(
Àvñ
Ë> 
öcVlc
[
vl˙um
])

314 
vl˙um
++;

316 i‡((
k
 =
œ°c€ff
 - 
numåaûög⁄es
Ë&& 
	`übs
(
Àvñ
) > 3)

317 
vl˙um
 = 2;

319 
no_bôs
 +
£
.
Àn
;

323 i‡(
numc€ff
 < 
max_c€ff_num
)

325 
£
.
vÆue1
 = 
tŸzîos
;

327 
vl˙um
 = 
numc€ff
-1;

329 
£
.
Àn
 = 
vl˙um
;

331 i‡(!
cdc
)

332 
no_bôs
 +
TŸÆzîos_À¡ab
[
£
.
Àn
][£.
vÆue1
];

334 
no_bôs
 +
TŸÆzîos_À¡ab_cdc
[
yuv
][
£
.
Àn
][£.
vÆue1
];

338 
zîo¶e·
 = 
tŸzîos
;

339 
numc€f
 = 
numc€ff
;

340 
k
 = 
œ°c€ff
; k >= 0; k--)

342 
run
 = 
pRun
[
k
];

344 
£
.
vÆue1
 = 
run
;

348 i‡((!
zîo¶e·
Ë|| (
numc€ff
 <= 1 ))

351 i‡(
numc€f
 > 1 && 
zîo¶e·
)

353 
vl˙um
 = 
	`imö
(
zîo¶e·
 - 1, 
RUNBEFORE_NUM_M1
);

354 
£
.
Àn
 = 
vl˙um
;

355 
no_bôs
 +
Run_À¡ab
[
£
.
Àn
][£.
vÆue1
];

356 
zîo¶e·
 -
run
;

357 
numc€f
 --;

362  
no_bôs
;

363 
	}
}

372 
	$e°_RunLevñ_CAVLC
(
Ma¸oblock
 *
cuºMB
, 
ÀvñD©aSåu˘
 *
ÀvñD©a
, *
ÀvñTªŒis
, 
block_ty≥
,

373 
b8
, 
b4
, 
c€ff_num
, 
œmbda
)

375 
k
, 
œ°n⁄zîo
 = -1, 
c€ff_˘r
;

376 
Àvñ_to_íc
[16] = {0}, 
sign_to_íc
[16] = {0};

377 
c°©
, 
be°c°©
 = 0;

378 
nz_c€ff
=0;

379 
œgr
, 
œgrAcc
 = 0, 
möœgr
 = 0;

380 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

382 
subblock_x
 = ((
b8
 & 0x1Ë=0Ë? (((
b4
 & 0x1) == 0) ? 0 : 1) : (((b4 & 0x1) == 0) ? 2 : 3);

384 
subblock_y
 = (
b8
 < 2Ë? ((
b4
 < 2) ? 0 : 1) :((b4 < 2) ? 2 : 3);

386 
¬z
;

387 
ÀvñD©aSåu˘
 *
d©aLevñ
 = &
ÀvñD©a
[0];

389 i‡(
block_ty≥
 !
CHROMA_AC
)

390 
¬z
 = 
	`¥edi˘_¬z
(
cuºMB
, 
LUMA
, 
subblock_x
, 
subblock_y
);

392 
¬z
 = 
	`¥edi˘_¬z_chroma
(
cuºMB
, cuºMB->
subblock_x
 >> 2, (cuºMB->
subblock_y
 >> 2) + 4);

394 
c€ff_˘r
=0;c€ff_˘∏< 
c€ff_num
;coeff_ctr++)

396 
ÀvñTªŒis
[
c€ff_˘r
] = 0;

398 
k
=0; k < 
d©aLevñ
->
noLevñs
; k++)

400 
d©aLevñ
->
îrLevñ
[
k
] /= 32768;

403 
œgrAcc
 +
d©aLevñ
->
îrLevñ
[d©aLevñ->
noLevñs
 - 1];

405 
Àvñ_to_íc
[
c€ff_˘r
] = 
d©aLevñ
->
¥e_Àvñ
;

406 
sign_to_íc
[
c€ff_˘r
] = 
d©aLevñ
->
sign
;

408 if(
d©aLevñ
->
noLevñs
 > 1)

410 
d©aLevñ
->
c€ff_˘r
 = coeff_ctr;

411 
œ°n⁄zîo
 = 
c€ff_˘r
;

414 
d©aLevñ
->
c€ff_˘r
 = -1;

415 
d©aLevñ
++;

418 if(
œ°n⁄zîo
 != -1)

421 
	`qs‹t
(
ÀvñD©a
, 
œ°n⁄zîo
 + 1, (
ÀvñD©aSåu˘
), 
cmp
);

422 
d©aLevñ
 = &
ÀvñD©a
[
œ°n⁄zîo
];

424 
c€ff_˘r
 = 
œ°n⁄zîo
; coeff_ctr >= 0; coeff_ctr--)

426 if(
d©aLevñ
->
noLevñs
 == 1)

428 
d©aLevñ
--;

432 
œgrAcc
 -
d©aLevñ
->
îrLevñ
[d©aLevñ->
noLevñs
-1];

433 
c°©
=0; c°©<
d©aLevñ
->
noLevñs
; cstat++)

435 
Àvñ_to_íc
[
d©aLevñ
->
c€ff_˘r
] = d©aLevñ->
Àvñ
[
c°©
];

436 
œgr
 = 
œgrAcc
 + 
d©aLevñ
->
îrLevñ
[
c°©
];

437 
œgr
 +
œmbda
 * 
	`e°_CAVLC_bôs
–
p_Vid
, 
Àvñ_to_íc
, 
sign_to_íc
, 
¬z
, 
block_ty≥
);

438 if(
c°©
==0 || 
œgr
<
möœgr
)

440 
möœgr
 = 
œgr
;

441 
be°c°©
 = 
c°©
;

445 
œgrAcc
 +
d©aLevñ
->
îrLevñ
[
be°c°©
];

446 
Àvñ_to_íc
[
d©aLevñ
->
c€ff_˘r
] = d©aLevñ->
Àvñ
[
be°c°©
];

447 
d©aLevñ
--;

450 
c€ff_˘r
 = 0; c€ff_˘∏<
œ°n⁄zîo
; coeff_ctr++)

452 
ÀvñTªŒis
[
c€ff_˘r
] = 
Àvñ_to_íc
[coeff_ctr];

453 i‡(
Àvñ_to_íc
[
c€ff_˘r
] != 0)

454 
nz_c€ff
++;

458 
p_Vid
->
nz_c€ff
 [p_Vid->
cuºít_mb_ƒ
 ][
subblock_x
][
subblock_y
] =Çz_coeff;

459 
	}
}

467 
	$öô_åñlis_d©a_4x4_CAVLC
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
block_x
, 
qp_≥r
, 
qp_ªm
, 
LevñQu™tP¨ams
 **
q_∑øms
,

468 c⁄° 
byã
 *
p_sˇn
, 
ÀvñD©aSåu˘
 *
d©aLevñ
, 
ty≥
)

470 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

471 
i
, 
j
, 
c€ff_˘r
;

472 *
m7
;

473 
íd_c€ff_˘r
 = ( ( 
ty≥
 =
LUMA_4x4
 ) ? 16 : 15 );

474 
q_bôs
 = 
Q_BITS
 + 
qp_≥r
;

475 
q_off£t
 = ( 1 << (
q_bôs
 - 1) );

476 
sˇÀd_c€ff
, 
Àvñ
, 
lowîI¡
, 
k
;

477 
îr
, 
e°Eº
;

480 
c€ff_˘r
 = 0; c€ff_˘∏< 
íd_c€ff_˘r
; coeff_ctr++)

482 
i
 = *
p_sˇn
++;

483 
j
 = *
p_sˇn
++;

485 
m7
 = &
tblock
[
j
][
block_x
 + 
i
];

487 i‡(*
m7
 == 0)

489 
d©aLevñ
->
ÀvñDoubÀ
 = 0;

490 
d©aLevñ
->
Àvñ
[0] = 0;

491 
d©aLevñ
->
noLevñs
 = 1;

492 
îr
 = 0.0;

493 
d©aLevñ
->
îrLevñ
[0] = 0.0;

494 
d©aLevñ
->
¥e_Àvñ
 = 0;

495 
d©aLevñ
->
sign
 = 0;

499 
e°Eº
 = ((Ë
e°Eº4x4
[
qp_ªm
][
j
][
i
]Ë/ 
cuºSli˚
->
n‹m_Á˘‹_4x4
;

501 
sˇÀd_c€ff
 = 
	`übs
(*
m7
Ë* 
q_∑øms
[
j
][
i
].
SˇÀComp
;

502 
d©aLevñ
->
ÀvñDoubÀ
 = 
sˇÀd_c€ff
;

503 
Àvñ
 = (
sˇÀd_c€ff
 >> 
q_bôs
);

505 
lowîI¡
 = ((
sˇÀd_c€ff
 - (
Àvñ
 << 
q_bôs
)Ë< 
q_off£t
 )? 1 : 0;

507 
d©aLevñ
->
Àvñ
[0] = 0;

508 i‡(
Àvñ
 =0 && 
lowîI¡
 == 1)

510 
d©aLevñ
->
noLevñs
 = 1;

512 i‡(
Àvñ
 =0 && 
lowîI¡
 == 0)

514 
d©aLevñ
->
Àvñ
[1] = 1;

515 
d©aLevñ
->
noLevñs
 = 2;

517 i‡(
Àvñ
 > 0 && 
lowîI¡
 == 1)

519 
d©aLevñ
->
Àvñ
[1] =Üevel;

520 
d©aLevñ
->
noLevñs
 = 2;

524 
d©aLevñ
->
Àvñ
[1] =Üevel;

525 
d©aLevñ
->
Àvñ
[2] =Üevel + 1;

526 
d©aLevñ
->
noLevñs
 = 3;

529 
k
 = 0; k < 
d©aLevñ
->
noLevñs
; k++)

531 
îr
 = ()(
d©aLevñ
->
Àvñ
[
k
] << 
q_bôs
Ë- ()
sˇÀd_c€ff
;

532 
d©aLevñ
->
îrLevñ
[
k
] = (
îr
 *Éº * 
e°Eº
);

535 if(
d©aLevñ
->
noLevñs
 == 1)

536 
d©aLevñ
->
¥e_Àvñ
 = 0;

538 
d©aLevñ
->
¥e_Àvñ
 = (
	`übs
 (*
m7
Ë* 
q_∑øms
[
j
][
i
].
SˇÀComp
 + q_∑øms[j][i].
Off£tComp
Ë>> 
q_bôs
;

539 
d©aLevñ
->
sign
 = 
	`isign
(*
m7
);

541 
d©aLevñ
++;

543 
	}
}

551 
	$öô_åñlis_d©a_DC_CAVLC
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
qp_≥r
, 
qp_ªm
,

552 
LevñQu™tP¨ams
 *
q_∑øms
, c⁄° 
byã
 *
p_sˇn
,

553 
ÀvñD©aSåu˘
 *
d©aLevñ
)

555 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

556 
i
, 
j
, 
c€ff_˘r
, 
íd_c€ff_˘r
 = 16;

557 
q_bôs
 = 
Q_BITS
 + 
qp_≥r
 + 1;

558 
q_off£t
 = ( 1 << (
q_bôs
 - 1) );

559 
sˇÀd_c€ff
, 
Àvñ
, 
lowîI¡
, 
k
;

560 *
m7
;

561 
îr
, 
e°Eº
 = (Ë
e°Eº4x4
[
qp_ªm
][0][0] / 
cuºSli˚
->
n‹m_Á˘‹_4x4
;

563 
c€ff_˘r
 = 0; c€ff_˘∏< 
íd_c€ff_˘r
; coeff_ctr++)

565 
i
 = *
p_sˇn
++;

566 
j
 = *
p_sˇn
++;

567 
m7
 = &
tblock
[
j
][
i
];

569 i‡(*
m7
 == 0)

571 
d©aLevñ
->
ÀvñDoubÀ
 = 0;

572 
d©aLevñ
->
Àvñ
[0] = 0;

573 
d©aLevñ
->
noLevñs
 = 1;

574 
îr
 = 0.0;

575 
d©aLevñ
->
îrLevñ
[0] = 0.0;

576 
d©aLevñ
->
¥e_Àvñ
 = 0;

577 
d©aLevñ
->
sign
 = 0;

581 
sˇÀd_c€ff
 = 
	`übs
(*
m7
Ë* 
q_∑øms
->
SˇÀComp
;

582 
d©aLevñ
->
ÀvñDoubÀ
 = 
sˇÀd_c€ff
;

583 
Àvñ
 = (
sˇÀd_c€ff
 >> 
q_bôs
);

585 
lowîI¡
=–(
sˇÀd_c€ff
 - (
Àvñ
<<
q_bôs
)Ë< 
q_off£t
 )? 1 : 0;

587 
d©aLevñ
->
Àvñ
[0] = 0;

588 i‡(
Àvñ
 =0 && 
lowîI¡
 == 1)

590 
d©aLevñ
->
noLevñs
 = 1;

592 i‡(
Àvñ
 =0 && 
lowîI¡
 == 0)

594 
d©aLevñ
->
Àvñ
[1] = 1;

595 
d©aLevñ
->
noLevñs
 = 2;

597 i‡(
Àvñ
 > 0 && 
lowîI¡
 == 1)

599 
d©aLevñ
->
Àvñ
[1] =Üevel;

600 
d©aLevñ
->
noLevñs
 = 2;

604 
d©aLevñ
->
Àvñ
[1] =Üevel;

605 
d©aLevñ
->
Àvñ
[2] =Üevel + 1;

606 
d©aLevñ
->
noLevñs
 = 3;

609 
k
 = 0; k < 
d©aLevñ
->
noLevñs
; k++)

611 
îr
 = ()(
d©aLevñ
->
Àvñ
[
k
] << 
q_bôs
Ë- ()
sˇÀd_c€ff
;

612 
d©aLevñ
->
îrLevñ
[
k
] = (
îr
 *Éº * 
e°Eº
);

615 if(
d©aLevñ
->
noLevñs
 == 1)

616 
d©aLevñ
->
¥e_Àvñ
 = 0;

618 
d©aLevñ
->
¥e_Àvñ
 = (
	`übs
 (*
m7
Ë* 
q_∑øms
->
SˇÀComp
 + q_∑øms->
Off£tComp
Ë>> 
q_bôs
;

619 
d©aLevñ
->
sign
 = 
	`isign
(*
m7
);

621 
d©aLevñ
++;

623 
	}
}

631 
	$öô_åñlis_d©a_8x8_CAVLC
(
Ma¸oblock
 *
cuºMB
, **
tblock
, 
block_x
, 
qp_≥r
, 
qp_ªm
, 
LevñQu™tP¨ams
 **
q_∑øms
,

632 c⁄° 
byã
 *
p_sˇn
, 
ÀvñD©aSåu˘
 
ÀvñD©a
[4][16])

634 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

635 
i
, 
j
, 
block
, 
c€ff_˘r
;

636 *
m7
;

637 
q_bôs
 = 
Q_BITS_8
 + 
qp_≥r
;

638 
q_off£t
 = ( 1 << (
q_bôs
 - 1) );

639 
îr
, 
e°Eº
;

640 
sˇÀd_c€ff
, 
Àvñ
, 
lowîI¡
, 
k
;

642 
ÀvñD©aSåu˘
 *
d©aLevñ
 = &
ÀvñD©a
[0][0];

644 
c€ff_˘r
 = 0; coeff_ctr < 16; coeff_ctr++)

646 
block
 = 0; block < 4; block++)

648 
i
 = *
p_sˇn
++;

649 
j
 = *
p_sˇn
++;

651 
m7
 = &
tblock
[
j
][
block_x
 + 
i
];

653 
d©aLevñ
 = &
ÀvñD©a
[
block
][
c€ff_˘r
];

654 i‡(*
m7
 == 0)

656 
d©aLevñ
->
ÀvñDoubÀ
 = 0;

657 
d©aLevñ
->
Àvñ
[0] = 0;

658 
d©aLevñ
->
noLevñs
 = 1;

659 
îr
 = 0.0;

660 
d©aLevñ
->
îrLevñ
[0] = 0.0;

661 
d©aLevñ
->
¥e_Àvñ
 = 0;

662 
d©aLevñ
->
sign
 = 0;

666 
e°Eº
 = (Ë
e°Eº8x8
[
qp_ªm
][
j
][
i
] / 
cuºSli˚
->
n‹m_Á˘‹_8x8
;

668 
sˇÀd_c€ff
 = 
	`übs
(*
m7
Ë* 
q_∑øms
[
j
][
i
].
SˇÀComp
;

669 
d©aLevñ
->
ÀvñDoubÀ
 = 
sˇÀd_c€ff
;

670 
Àvñ
 = (
sˇÀd_c€ff
 >> 
q_bôs
);

672 
lowîI¡
 = ((
sˇÀd_c€ff
 - (
Àvñ
 << 
q_bôs
)Ë< 
q_off£t
 ) ? 1 : 0;

674 
d©aLevñ
->
Àvñ
[0] = 0;

675 i‡(
Àvñ
 =0 && 
lowîI¡
 == 1)

677 
d©aLevñ
->
noLevñs
 = 1;

679 i‡(
Àvñ
 =0 && 
lowîI¡
 == 0)

681 
d©aLevñ
->
Àvñ
[1] = 1;

682 
d©aLevñ
->
noLevñs
 = 2;

684 i‡(
Àvñ
 > 0 && 
lowîI¡
 == 1)

686 i‡(
Àvñ
 > 1)

688 
d©aLevñ
->
Àvñ
[1] =Üevel - 1;

689 
d©aLevñ
->
Àvñ
[2] =Üevel;

690 
d©aLevñ
->
noLevñs
 = 3;

694 
d©aLevñ
->
Àvñ
[1] =Üevel;

695 
d©aLevñ
->
noLevñs
 = 2;

700 
d©aLevñ
->
Àvñ
[1] =Üevel;

701 
d©aLevñ
->
Àvñ
[2] =Üevel + 1;

702 
d©aLevñ
->
noLevñs
 = 3;

705 
k
 = 0; k < 
d©aLevñ
->
noLevñs
; k++)

707 
îr
 = ()(
d©aLevñ
->
Àvñ
[
k
] << 
q_bôs
Ë- ()
sˇÀd_c€ff
;

708 
d©aLevñ
->
îrLevñ
[
k
] = 
îr
 *Éº * 
e°Eº
;

711 if(
d©aLevñ
->
noLevñs
 == 1)

712 
d©aLevñ
->
¥e_Àvñ
 = 0;

714 
d©aLevñ
->
¥e_Àvñ
 = (
	`übs
 (*
m7
Ë* 
q_∑øms
[
j
][
i
].
SˇÀComp
 + q_∑øms[j][i].
Off£tComp
Ë>> 
q_bôs
;

715 
d©aLevñ
->
sign
 = 
	`isign
(*
m7
);

719 
	}
}

	@lencod/src/rdpicdecision.c

15 
	~"globÆ.h
"

16 
	~<m©h.h
>

25 
	$rd_pic_decisi⁄
(
¢rY_vîsi⁄1
, 
¢rY_vîsi⁄2
, 
bôs_vîsi⁄1
, 
bôs_vîsi⁄2
, 
œmbda_pi˘uª
)

27 
co°_vîsi⁄1
, 
co°_vîsi⁄2
;

29 
co°_vîsi⁄1
 = (Ë
bôs_vîsi⁄1
 * 
œmbda_pi˘uª
 + 
¢rY_vîsi⁄1
;

30 
co°_vîsi⁄2
 = (Ë
bôs_vîsi⁄2
 * 
œmbda_pi˘uª
 + 
¢rY_vîsi⁄2
;

32 i‡(
co°_vîsi⁄2
 > 
co°_vîsi⁄1
 || (co°_vîsi⁄2 =co°_vîsi⁄1 && 
¢rY_vîsi⁄2
 >
¢rY_vîsi⁄1
) )

36 
	}
}

44 
	$pi˘uª_codög_decisi⁄
 (
VideoP¨amëîs
 *
p_Vid
, 
Pi˘uª
 *
pi˘uª1
, Pi˘uª *
pi˘uª2
, 
qp
)

46 
œmbda_pi˘uª
;

47 
s£_pi˘uª1
, 
s£_pi˘uª2
;

49 i‡(
p_Vid
->
p_I≈
->
NumbîBFømes
)

50 
œmbda_pi˘uª
 = (
qp
 < 20 ? 0.55 : 0.68Ë* 
	`pow
 (2, (q∞- 
SHIFT_QP
Ë/ 3.0Ë* ((
p_Vid
->
ty≥
 =
B_SLICE
Ë|| (p_Vid->ty≥ =
SP_SLICE
 ||Ö_Vid->ty≥ =
SI_SLICE
) ? 2 : 1);

52 
œmbda_pi˘uª
 = (
qp
 < 20 ? 0.55 : 0.68Ë* 
	`pow
 (2, (q∞- 
SHIFT_QP
) / 3.0);

54 if(
pi˘uª1
->
di°‹ti⁄
.
vÆue
[0] == 0)

56 if(
pi˘uª2
->
di°‹ti⁄
.
vÆue
[0] == 0)

59 
s£_pi˘uª1
 = 
pi˘uª1
->
di°‹ti⁄
.
vÆue
[0] +Öicture1->distortion.value[1] +Öicture1->distortion.value[2];

60 
s£_pi˘uª2
 = 
pi˘uª2
->
di°‹ti⁄
.
vÆue
[0] +Öicture2->distortion.value[1] +Öicture2->distortion.value[2];

62  
	`rd_pic_decisi⁄
(
s£_pi˘uª1
, 
s£_pi˘uª2
, 
pi˘uª1
->
bôs_≥r_pi˘uª
, 
pi˘uª2
->bôs_≥r_pi˘uª, 
œmbda_pi˘uª
);

63 
	}
}

	@lencod/src/report.c

13 
	~"c⁄åibut‹s.h
"

15 
	~<time.h
>

16 
	~<m©h.h
>

18 
	~"globÆ.h
"

19 
	~"c⁄ãxt_öi.h
"

20 
	~"ex∂icô_g›.h
"

21 
	~"fûeh™dÀ.h
"

22 
	~"fmo.h
"

23 
	~"image.h
"

24 
	~"öå¨e‰esh.h
"

25 
	~"Àaky_buckë.h
"

26 
	~"me_ïzs.h
"

27 
	~"me_ïzs_öt.h
"

28 
	~"ouçut.h
"

29 
	~"∑r£t.h
"

30 
	~"ªp‹t.h
"

31 
	~"img_¥o˚ss_ty≥s.h
"

34 c⁄° 
	gDi°‹ti⁄Ty≥
[3][20] = {"SAD", "SSE", "Hadamard SAD"};

36 
ªp‹t_log_mode
 (
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
SètP¨amëîs
 *
p_Sèts
);

43 
	$ªp‹t_‰ame_°©i°ic
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

45 
Di°‹ti⁄P¨ams
 *
p_Di°
 = 
p_Vid
->p_Dist;

46 
FILE
 *
p_°©_‰m
 = 
NULL
;

48 
i
;

49 
«me
[30];

50 
bôcou¡î
;

51 
SètP¨amëîs
 *
cur_°©s
 = &
p_Vid
->
íc_pi˘uª
->
°©s
;

53 #i‚de‡
WIN32


54 
time_t
 
now
;

55 
tm
 *
l_time
;

56 
°rög
[1000];

58 
timebuf
[128];

62 i‡((
p_°©_‰m
 = 
	`f›í
("stat_frame.dat", "r")) == 0)

64 i‡((
p_°©_‰m
 = 
	`f›í
("°©_‰ame.d©", "a")Ë=
NULL
)

66 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Error open file %s \n", "stat_frame.dat.dat");

67 
	`îr‹
(
îr‹ãxt
, 500);

71 
	`Ârötf
(
p_°©_‰m
, " --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- \n");

72 
	`Ârötf
(
p_°©_‰m
, "| Encoder statistics. This file is generated during firstÉncoding session,Çew sessions will beáppended |\n");

73 
	`Ârötf
(
p_°©_‰m
, " --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- \n");

78 
	`f˛o£
 (
p_°©_‰m
);

79 i‡((
p_°©_‰m
 = 
	`f›í
("°©_‰ame.d©", "a")Ë=
NULL
)

81 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Error open file %s \n", "stat_frame.dat.dat");

82 
	`îr‹
(
îr‹ãxt
, 500);

86 i‡(
p_Vid
->
‰ame_°©i°ic_°¨t
)

88 
	`Ârötf
(
p_°©_‰m
, "| ver | Date | Time | Sequence |Frm | QP |P/MbInt| Bits | SNRY | SNRU | SNRV | I4 | I8 | I16 | IC0 | IC1 | IC2 | IC3 | PI4 | PI8 | PI16 | P0 | P1 | P2 | P3 | P1*4*| P1*8*| P2*4*| P2*8*| P3*4*| P3*8*| P8 | P8:4 | P4*4*| P4*8*| P8:5 | P8:6 | P8:7 | BI4 | BI8 | BI16 | B0 | B1 | B2 | B3 | B0*4*| B0*8*| B1*4*| B1*8*| B2*4*| B2*8*| B3*4*| B3*8*| B8 | B8:0 |B80*4*|B80*8*| B8:4 | B4*4*| B4*8*| B8:5 | B8:6 | B8:7 |\n");

89 
	`Ârötf
(
p_°©_‰m
, " ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ \n");

93 
	`Ârötf
(
p_°©_‰m
, "|%4s/%s", 
VERSION
, 
EXT_VERSION
);

95 #ifde‡
WIN32


96 
	`_°rd©e
–
timebuf
 );

97 
	`Ârötf
(
p_°©_‰m
, "| %1.5†|", 
timebuf
);

99 
	`_°πime
–
timebuf
);

100 
	`Ârötf
(
p_°©_‰m
, " % 1.5†|", 
timebuf
);

102 
now
 = 
	`time
 ((
time_t
 *Ë
NULL
);

103 
	`time
 (&
now
);

104 
l_time
 = 
	`loˇ…ime
 (&
now
);

105 
	`°r·ime
 (
°rög
,  såög, "%d-%b-%Y", 
l_time
);

106 
	`Ârötf
(
p_°©_‰m
, "| %1.5†|", 
°rög
 );

108 
	`°r·ime
 (
°rög
,  såög, "%H:%M:%S", 
l_time
);

109 
	`Ârötf
(
p_°©_‰m
, " %1.5†|", 
°rög
);

112 
i
=0;i<30;i++)

113 
«me
[
i
] = 
p_I≈
->
öput_fûe1
.
‚ame
[ò+ 
	`imax
(0,(Ë(
	`°æí
(p_Inp->input_file1.fname)- 30))];

115 
	`Ârötf
(
p_°©_‰m
, "%30.30s|", 
«me
);

116 
	`Ârötf
(
p_°©_‰m
, "%3d |", 
p_Vid
->
‰ame_no
);

117 
	`Ârötf
(
p_°©_‰m
, "%3d |", 
p_Vid
->
qp
);

118 
	`Ârötf
(
p_°©_‰m
, " %d/%d |", 
p_I≈
->
PicI¡îœ˚
,Ö_I≈->
MbI¡îœ˚
);

120 #i‡(
MVC_EXTENSION_ENABLE
)

121 i‡(
p_Vid
->
cuº_‰m_idx
 =0 &&Ö_Vid->
‰ame_num
 =0 && !p_Vid->
võw_id
)

123 i‡(
p_Vid
->
cuº_‰m_idx
 =0 &&Ö_Vid->
‰ame_num
 == 0)

126 
bôcou¡î
 = (Ë
p_Vid
->
p_Sèts
->
bô_cou¡î
[
I_SLICE
];

130 
bôcou¡î
 = (Ë(
p_Vid
->
p_Sèts
->
bô_˘r_n
 -Ö_Vid->
œ°_bô_˘r_n
);

131 
p_Vid
->
œ°_bô_˘r_n
 =Ö_Vid->
p_Sèts
->
bô_˘r_n
;

135 
	`Ârötf
(
p_°©_‰m
, " %9d|", 
bôcou¡î
);

138 
	`Ârötf
(
p_°©_‰m
, " %2.4f| %2.4f| %2.4f|", 
p_Di°
->
mëric
[
PSNR
].
vÆue
[0],Ö_Dist->metric[PSNR].value[1],Ö_Dist->metric[PSNR].value[2]);

142 
	`Ârötf
(
p_°©_‰m
, " %5" 
FORMAT_OFF_T
 "|", 
cur_°©s
->
mode_u£
[
I_SLICE
][
I4MB
 ]);

143 
	`Ârötf
(
p_°©_‰m
, " %5" 
FORMAT_OFF_T
 "|", 
cur_°©s
->
mode_u£
[
I_SLICE
][
I8MB
 ]);

144 
	`Ârötf
(
p_°©_‰m
, " %5" 
FORMAT_OFF_T
 "|", 
cur_°©s
->
mode_u£
[
I_SLICE
][
I16MB
]);

147 
	`Ârötf
(
p_°©_‰m
, " %5" 
FORMAT_OFF_T
 "|", 
cur_°©s
->
öåa_chroma_mode
[0]);

148 
	`Ârötf
(
p_°©_‰m
, " %5" 
FORMAT_OFF_T
 "|", 
cur_°©s
->
öåa_chroma_mode
[1]);

149 
	`Ârötf
(
p_°©_‰m
, " %5" 
FORMAT_OFF_T
 "|", 
cur_°©s
->
öåa_chroma_mode
[2]);

150 
	`Ârötf
(
p_°©_‰m
, " %5" 
FORMAT_OFF_T
 "|", 
cur_°©s
->
öåa_chroma_mode
[3]);

153 
	`Ârötf
(
p_°©_‰m
, " %5" 
FORMAT_OFF_T
 "|", 
cur_°©s
->
mode_u£
[
P_SLICE
][
I4MB
 ]);

154 
	`Ârötf
(
p_°©_‰m
, " %5" 
FORMAT_OFF_T
 "|", 
cur_°©s
->
mode_u£
[
P_SLICE
][
I8MB
 ]);

155 
	`Ârötf
(
p_°©_‰m
, " %5" 
FORMAT_OFF_T
 "|", 
cur_°©s
->
mode_u£
[
P_SLICE
][
I16MB
]);

156 
	`Ârötf
(
p_°©_‰m
, " %5" 
FORMAT_OFF_T
 "|", 
cur_°©s
->
mode_u£
[
P_SLICE
][0 ]);

158 
	`Ârötf
(
p_°©_‰m
, " %5" 
FORMAT_OFF_T
 "|", 
cur_°©s
->
mode_u£
[
P_SLICE
][1 ]);

159 
	`Ârötf
(
p_°©_‰m
, " %5" 
FORMAT_OFF_T
 "|", 
cur_°©s
->
mode_u£
[
P_SLICE
][2 ]);

160 
	`Ârötf
(
p_°©_‰m
, " %5" 
FORMAT_OFF_T
 "|", 
cur_°©s
->
mode_u£
[
P_SLICE
][3 ]);

162 
	`Ârötf
(
p_°©_‰m
, " %5" 
FORMAT_OFF_T
 "|", 
cur_°©s
->
mode_u£_å™sf‹m
[
P_SLICE
][1][0]);

163 
	`Ârötf
(
p_°©_‰m
, " %5" 
FORMAT_OFF_T
 "|", 
cur_°©s
->
mode_u£_å™sf‹m
[
P_SLICE
][1][1]);

164 
	`Ârötf
(
p_°©_‰m
, " %5" 
FORMAT_OFF_T
 "|", 
cur_°©s
->
mode_u£_å™sf‹m
[
P_SLICE
][2][0]);

165 
	`Ârötf
(
p_°©_‰m
, " %5" 
FORMAT_OFF_T
 "|", 
cur_°©s
->
mode_u£_å™sf‹m
[
P_SLICE
][2][1]);

166 
	`Ârötf
(
p_°©_‰m
, " %5" 
FORMAT_OFF_T
 "|", 
cur_°©s
->
mode_u£_å™sf‹m
[
P_SLICE
][3][0]);

167 
	`Ârötf
(
p_°©_‰m
, " %5" 
FORMAT_OFF_T
 "|", 
cur_°©s
->
mode_u£_å™sf‹m
[
P_SLICE
][3][1]);

169 
	`Ârötf
(
p_°©_‰m
, " %5" 
FORMAT_OFF_T
 "|", 
cur_°©s
->
mode_u£
[
P_SLICE
][
P8x8
 ]);

170 
	`Ârötf
(
p_°©_‰m
, " %5" 
FORMAT_OFF_T
 "|", 
cur_°©s
->
mode_u£
[
P_SLICE
][4 ]);

171 
	`Ârötf
(
p_°©_‰m
, " %5" 
FORMAT_OFF_T
 "|", 
cur_°©s
->
mode_u£_å™sf‹m
[
P_SLICE
][4][0]);

172 
	`Ârötf
(
p_°©_‰m
, " %5" 
FORMAT_OFF_T
 "|", 
cur_°©s
->
mode_u£_å™sf‹m
[
P_SLICE
][4][1]);

173 
	`Ârötf
(
p_°©_‰m
, " %5" 
FORMAT_OFF_T
 "|", 
cur_°©s
->
mode_u£
[
P_SLICE
][5 ]);

174 
	`Ârötf
(
p_°©_‰m
, " %5" 
FORMAT_OFF_T
 "|", 
cur_°©s
->
mode_u£
[
P_SLICE
][6 ]);

175 
	`Ârötf
(
p_°©_‰m
, " %5" 
FORMAT_OFF_T
 "|", 
cur_°©s
->
mode_u£
[
P_SLICE
][7 ]);

178 
	`Ârötf
(
p_°©_‰m
, " %5" 
FORMAT_OFF_T
 "|", 
cur_°©s
->
mode_u£
[
B_SLICE
][
I4MB
 ]);

179 
	`Ârötf
(
p_°©_‰m
, " %5" 
FORMAT_OFF_T
 "|", 
cur_°©s
->
mode_u£
[
B_SLICE
][
I8MB
 ]);

180 
	`Ârötf
(
p_°©_‰m
, " %5" 
FORMAT_OFF_T
 "|", 
cur_°©s
->
mode_u£
[
B_SLICE
][
I16MB
]);

181 
	`Ârötf
(
p_°©_‰m
, " %5" 
FORMAT_OFF_T
 "|", 
cur_°©s
->
mode_u£
[
B_SLICE
][0 ]);

182 
	`Ârötf
(
p_°©_‰m
, " %5" 
FORMAT_OFF_T
 "|", 
cur_°©s
->
mode_u£
[
B_SLICE
][1 ]);

183 
	`Ârötf
(
p_°©_‰m
, " %5" 
FORMAT_OFF_T
 "|", 
cur_°©s
->
mode_u£
[
B_SLICE
][2 ]);

184 
	`Ârötf
(
p_°©_‰m
, " %5" 
FORMAT_OFF_T
 "|", 
cur_°©s
->
mode_u£
[
B_SLICE
][3 ]);

185 
	`Ârötf
(
p_°©_‰m
, " %5" 
FORMAT_OFF_T
 "|", 
cur_°©s
->
mode_u£_å™sf‹m
[
B_SLICE
][0][0]);

186 
	`Ârötf
(
p_°©_‰m
, " %5" 
FORMAT_OFF_T
 "|", 
cur_°©s
->
mode_u£_å™sf‹m
[
B_SLICE
][0][1]);

187 
	`Ârötf
(
p_°©_‰m
, " %5" 
FORMAT_OFF_T
 "|", 
cur_°©s
->
mode_u£_å™sf‹m
[
B_SLICE
][1][0]);

188 
	`Ârötf
(
p_°©_‰m
, " %5" 
FORMAT_OFF_T
 "|", 
cur_°©s
->
mode_u£_å™sf‹m
[
B_SLICE
][1][1]);

189 
	`Ârötf
(
p_°©_‰m
, " %5" 
FORMAT_OFF_T
 "|", 
cur_°©s
->
mode_u£_å™sf‹m
[
B_SLICE
][2][0]);

190 
	`Ârötf
(
p_°©_‰m
, " %5" 
FORMAT_OFF_T
 "|", 
cur_°©s
->
mode_u£_å™sf‹m
[
B_SLICE
][2][1]);

191 
	`Ârötf
(
p_°©_‰m
, " %5" 
FORMAT_OFF_T
 "|", 
cur_°©s
->
mode_u£_å™sf‹m
[
B_SLICE
][3][0]);

192 
	`Ârötf
(
p_°©_‰m
, " %5" 
FORMAT_OFF_T
 "|", 
cur_°©s
->
mode_u£_å™sf‹m
[
B_SLICE
][3][1]);

194 
	`Ârötf
(
p_°©_‰m
, " %5" 
FORMAT_OFF_T
 "|", 
cur_°©s
->
mode_u£
[
B_SLICE
][
P8x8
]);

195 
	`Ârötf
(
p_°©_‰m
, " %d|", (
cur_°©s
->
b8_mode_0_u£
 [
B_SLICE
][0] + cur_stats->b8_mode_0_use [B_SLICE][1]));

196 
	`Ârötf
(
p_°©_‰m
, " %5d|", 
cur_°©s
->
b8_mode_0_u£
 [
B_SLICE
][0]);

197 
	`Ârötf
(
p_°©_‰m
, " %5d|", 
cur_°©s
->
b8_mode_0_u£
 [
B_SLICE
][1]);

198 
	`Ârötf
(
p_°©_‰m
, " %5" 
FORMAT_OFF_T
 "|", 
cur_°©s
->
mode_u£
[
B_SLICE
][4 ]);

199 
	`Ârötf
(
p_°©_‰m
, " %5" 
FORMAT_OFF_T
 "|", 
cur_°©s
->
mode_u£_å™sf‹m
[
B_SLICE
][4][0]);

200 
	`Ârötf
(
p_°©_‰m
, " %5" 
FORMAT_OFF_T
 "|", 
cur_°©s
->
mode_u£_å™sf‹m
[
B_SLICE
][4][1]);

201 
	`Ârötf
(
p_°©_‰m
, " %5" 
FORMAT_OFF_T
 "|", 
cur_°©s
->
mode_u£
[
B_SLICE
][5 ]);

202 
	`Ârötf
(
p_°©_‰m
, " %5" 
FORMAT_OFF_T
 "|", 
cur_°©s
->
mode_u£
[
B_SLICE
][6 ]);

203 
	`Ârötf
(
p_°©_‰m
, " %5" 
FORMAT_OFF_T
 "|", 
cur_°©s
->
mode_u£
[
B_SLICE
][7 ]);

205 
	`Ârötf
(
p_°©_‰m
, "\n");

208 
p_Vid
->
‰ame_°©i°ic_°¨t
 = 0;

209 
	`f˛o£
(
p_°©_‰m
);

210 
	}
}

213 
	$ªp‹t_¶i˚_¥ed_°©s
(
FILE
 *
p_°©
, 
SètP¨amëîs
 *
p_Sèts
, 
¶i˚_ty≥
, 
bô_u£
, *
¶i˚_«me
)

215 
	`Ârötf
(
p_°©
,"\n ---------------------|----------------|-----------------|");

216 
	`Ârötf
(
p_°©
,"\¿ %8† | Modêu£d | MŸi⁄Infÿbô†|", 
¶i˚_«me
);

217 
	`Ârötf
(
p_°©
,"\n ---------------------|----------------|-----------------|");

218 
	`Ârötf
(
p_°©
,"\¿Modê 0 (c›yË | %5" 
FORMAT_OFF_T
 " | %8.2‡ |", 
p_Sèts
->
mode_u£
[
¶i˚_ty≥
][0 ], (Ì_Sèts->
bô_u£_mode
[¶i˚_ty≥][0 ] / 
bô_u£
);

219 
	`Ârötf
(
p_°©
,"\¿Modê 1 (16x16Ë | %5" 
FORMAT_OFF_T
 " | %8.2‡ |", 
p_Sèts
->
mode_u£
[
¶i˚_ty≥
][1 ], (Ì_Sèts->
bô_u£_mode
[¶i˚_ty≥][1 ] / 
bô_u£
);

220 
	`Ârötf
(
p_°©
,"\¿Modê 2 (16x8Ë | %5" 
FORMAT_OFF_T
 " | %8.2‡ |", 
p_Sèts
->
mode_u£
[
¶i˚_ty≥
][2 ], (Ì_Sèts->
bô_u£_mode
[¶i˚_ty≥][2 ] / 
bô_u£
);

221 
	`Ârötf
(
p_°©
,"\¿Modê 3 (8x16Ë | %5" 
FORMAT_OFF_T
 " | %8.2‡ |", 
p_Sèts
->
mode_u£
[
¶i˚_ty≥
][3 ], (Ì_Sèts->
bô_u£_mode
[¶i˚_ty≥][3 ] / 
bô_u£
);

222 
	`Ârötf
(
p_°©
,"\¿Modê 4 (8x8Ë | %5" 
FORMAT_OFF_T
 " | %8.2‡ |", 
p_Sèts
->
mode_u£
[
¶i˚_ty≥
][
P8x8
], (Ì_Sèts->
bô_u£_mode
[¶i˚_ty≥][P8x8] / 
bô_u£
);

223 
	`Ârötf
(
p_°©
,"\¿Modê 5 i¡ø 4x4 | %5" 
FORMAT_OFF_T
 " |-----------------|", 
p_Sèts
->
mode_u£
[
¶i˚_ty≥
][
I4MB
]);

224 
	`Ârötf
(
p_°©
,"\¿Modê 6 i¡ø 8x8 | %5" 
FORMAT_OFF_T
 " |", 
p_Sèts
->
mode_u£
[
¶i˚_ty≥
][
I8MB
]);

225 
	`Ârötf
(
p_°©
,"\¿Modê 7+ i¡ø 16x16 | %5" 
FORMAT_OFF_T
 " |", 
p_Sèts
->
mode_u£
[
¶i˚_ty≥
][
I16MB
]);

226 
	`Ârötf
(
p_°©
,"\¿Modê i¡ø IPCM | %5" 
FORMAT_OFF_T
 " |", 
p_Sèts
->
mode_u£
[
¶i˚_ty≥
][
IPCM
 ]);

228  ()(
p_Sèts
->
bô_u£_mode
[
¶i˚_ty≥
][0] +Ö_Stats->bit_use_mode[slice_type][1] +Ö_Stats->bit_use_mode[slice_type][2]

229 + 
p_Sèts
->
bô_u£_mode
[
¶i˚_ty≥
][3] +Ö_Sèts->bô_u£_mode[¶i˚_ty≥][
P8x8
]Ë/ 
bô_u£
;

230 
	}
}

239 
	$ªp‹t_°©s_⁄_îr‹
()

241 
	`‰ì_ícodî_mem‹y
(
p_Enc
->
p_Vid
,Ö_Enc->
p_I≈
);

242 
	`exô
 (-1);

243 
	}
}

246 
	$ªp‹t_°©s
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
SètP¨amëîs
 *
p_Sèts
, 
öt64
 
bô_u£
[
NUM_SLICE_TYPES
][2])

248 
Di°‹ti⁄P¨ams
 *
p_Di°
 = 
p_Vid
->p_Dist;

249 
FILE
 *
p_°©
;

250 
món_mŸi⁄_öfo_bô_u£
[
NUM_SLICE_TYPES
] = {0.0};

251 
i
;

253 i‡(
	`°æí
(
p_I≈
->
SètsFûe
) == 0)

254 
	`°r˝y
 (
p_I≈
->
SètsFûe
,"stats.dat");

256 i‡((
p_°©
 = 
	`f›í
(
p_I≈
->
SètsFûe
, "wt")) == 0)

258 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Eº‹ o≥¿fûê%s", 
p_I≈
->
SètsFûe
);

259 
	`îr‹
(
îr‹ãxt
, 500);

262 
	`Ârötf
(
p_°©
," -------------------------------------------------------------- \n");

263 
	`Ârötf
(
p_°©
," This file contains statistics forÅheÜastÉncoded sequence \n");

264 
	`Ârötf
(
p_°©
," -------------------------------------------------------------- \n");

265 
	`Ârötf
(
p_°©
, " Sequí˚ : %s\n", 
p_I≈
->
öput_fûe1
.
‚ame
);

268 
	`Ârötf
(
p_°©
, " No.o‡codedÖi˘uª† : %4d\n", 
p_Sèts
->
‰ame_cou¡î
);

269 
	`Ârötf
(
p_°©
, " Fªq. f‹Éncoded bô°ªam : %4.0f\n", 
p_I≈
->
ouçut
.
‰ame_øã
);

271 
	`Ârötf
(
p_°©
, " I Sli˚ Bôøã(kb/sË : %6.2f\n", 
p_Sèts
->
bôøã_°
[
I_SLICE
] / 1000.0);

272 
	`Ârötf
(
p_°©
, " P Sli˚ Bôøã(kb/sË : %6.2f\n", 
p_Sèts
->
bôøã_°
[
P_SLICE
] / 1000.0);

273 
	`Ârötf
(
p_°©
, " B Sli˚ Bôøã(kb/sË : %6.2f\n", 
p_Sèts
->
bôøã_°
[
B_SLICE
] / 1000.0);

274 
	`Ârötf
(
p_°©
, " TŸÆ Bôøã(kb/sË : %6.2f\n", 
p_Sèts
->
bôøã
 / 1000.0);

276 
i
 = 0; i < 3; i++)

278 
	`Ârötf
(
p_°©
," ME Levñ %1d Mëri¯ : %s\n", 
i
, 
Di°‹ti⁄Ty≥
[
p_I≈
->
MEEº‹Mëric
[i]]);

280 
	`Ârötf
(
p_°©
," ModêDecisi⁄ Mëri¯ : %s\n", 
Di°‹ti⁄Ty≥
[
p_I≈
->
ModeDecisi⁄Mëric
]);

282  
p_I≈
->
ChromaMEE«bÀ
 )

285 
	`Ârötf
(
p_°©
," ME for components : YCbCr\n");

288 
	`Ârötf
(
p_°©
," ME for components : Y\n");

292 
	`Ârötf
(
p_°©
, " Imagêf‹m© : %dx%d\n", 
p_I≈
->
ouçut
.
width
[0],Ö_I≈->ouçut.
height
[0]);

294 i‡(
p_I≈
->
öåa_upd
)

295 
	`Ârötf
(
p_°©
," ErrorÑobustness : On\n");

297 
	`Ârötf
(
p_°©
," ErrorÑobustness : Off\n");

299 
	`Ârötf
(
p_°©
, " SórchÑ™gê : %d\n", 
p_I≈
->
£¨ch_ønge
[0]);

300 #i‡(
MVC_EXTENSION_ENABLE
)

301 i‡–
p_I≈
->
SïVõwI¡îSórch
 )

303 
	`Ârötf
(
p_°©
, " SórchÑ™gê(võw 1Ë : %d\n", 
p_I≈
->
£¨ch_ønge
[1]);

307 
	`Ârötf
(
p_°©
, " TŸÆÇumbî o‡ª„ªn˚† : %d\n", 
p_I≈
->
num_ªf_‰ames_‹g
);

308 
	`Ârötf
(
p_°©
, " Re„ªn˚†f‹ P sli˚† : %d\n", 
p_I≈
->
P_Li°0_ªfs_‹g
[0] ?Ö_I≈->P_Li°0_ªfs_‹g[0] :Ö_I≈->
num_ªf_‰ames_‹g
);

310 i‡(
p_Sèts
->
‰ame_˘r
[
B_SLICE
]!=0)

312 
	`Ârötf
(
p_°©
, " Li°0Ñef†f‹ B sli˚† : %d\n", 
p_I≈
->
B_Li°0_ªfs_‹g
[0] ?Ö_I≈->B_Li°0_ªfs_‹g[0] :Ö_I≈->
num_ªf_‰ames_‹g
);

313 
	`Ârötf
(
p_°©
, " Li°1Ñef†f‹ B sli˚† : %d\n", 
p_I≈
->
B_Li°1_ªfs_‹g
[0] ?Ö_I≈->B_Li°1_ªfs_‹g[0] :Ö_I≈->
num_ªf_‰ames_‹g
);

316 #i‡(
MVC_EXTENSION_ENABLE
)

317 i‡–
p_Vid
->
num_of_œyîs
 > 1 )

319 
	`Ârötf
(
p_°©
, " Võw 1Ñef†f‹ P sli˚† : %d\n", 
p_I≈
->
P_Li°0_ªfs_‹g
[1] ?Ö_I≈->P_Li°0_ªfs_‹g[1] :Ö_I≈->
num_ªf_‰ames_‹g
);

320 
	`Ârötf
(
p_°©
, " Võw 1 L0Ñef†f‹ B sli˚† : %d\n", 
p_I≈
->
B_Li°0_ªfs_‹g
[1] ?Ö_I≈->B_Li°0_ªfs_‹g[1] :Ö_I≈->
num_ªf_‰ames_‹g
);

321 
	`Ârötf
(
p_°©
, " Võw 1 L1Ñef†f‹ B sli˚† : %d\n", 
p_I≈
->
B_Li°1_ªfs_‹g
[1] ?Ö_I≈->B_Li°1_ªfs_‹g[1] :Ö_I≈->
num_ªf_‰ames_‹g
);

325 
	`Ârötf
(
p_°©
, " Profûe/Levñ IDC : (%d,%d)\n", 
p_I≈
->
ProfûeIDC
,Ö_I≈->
LevñIDC
);

326 i‡(
p_I≈
->
symbﬁ_mode
 =
CAVLC
)

327 
	`Ârötf
(
p_°©
, " Entropy coding method : CAVLC\n");

329 
	`Ârötf
(
p_°©
, " Entropy coding method : CABAC\n");

331 i‡(
p_I≈
->
MbI¡îœ˚
)

332 
	`Ârötf
(
p_°©
, " MB Field Coding : On \n");

334 i‡(
p_I≈
->
SórchMode
[0] =
EPZS
 ||Ö_Inp->SearchMode[1] == EPZS)

336 
	`EPZSOuçutSèts
(
p_I≈
, 
p_°©
, 1);

339 i‡(
p_I≈
->
fuŒ_£¨ch
 == 2)

340 
	`Ârötf
(
p_°©
," SearchÑangeÑestrictions :Çone\n");

341 i‡(
p_I≈
->
fuŒ_£¨ch
 == 1)

342 
	`Ârötf
(
p_°©
," SearchÑangeÑestrictions : olderÑeference frames\n");

344 
	`Ârötf
(
p_°©
," SearchÑangeÑestrictions : smaller blocksánd olderÑeference frames\n");

346 i‡(
p_I≈
->
rd›t
)

347 
	`Ârötf
(
p_°©
," RD-optimized mode decision : used\n");

349 
	`Ârötf
(
p_°©
," RD-optimized mode decision :Çot used\n");

351 
	`Ârötf
(
p_°©
,"\n ---------------------|----------------|---------------|");

352 
	`Ârötf
(
p_°©
,"\n Item | Intra | All frames |");

353 
	`Ârötf
(
p_°©
,"\n ---------------------|----------------|---------------|");

354 
	`Ârötf
(
p_°©
,"\n SNR Y(dB) |");

355 
	`Ârötf
(
p_°©
," %5.2‡ |", 
p_Di°
->
mëric
[
PSNR
].
av¶i˚
[
I_SLICE
][0]);

356 
	`Ârötf
(
p_°©
," %5.2‡ |", 
p_Di°
->
mëric
[
PSNR
].
avîage
[0]);

357 
	`Ârötf
(
p_°©
,"\n SNR U/V (dB) |");

358 
	`Ârötf
(
p_°©
," %5.2f/%5.2‡ |", 
p_Di°
->
mëric
[
PSNR
].
av¶i˚
[
I_SLICE
][1],Ö_Dist->metric[PSNR].avslice[I_SLICE][2]);

359 
	`Ârötf
(
p_°©
," %5.2f/%5.2‡ |", 
p_Di°
->
mëric
[
PSNR
].
avîage
[1],Ö_Dist->metric[PSNR].average[2]);

360 
	`Ârötf
(
p_°©
,"\n ---------------------|----------------|---------------|");

361 
	`Ârötf
(
p_°©
,"\n");

363 
	`Ârötf
(
p_°©
,"\n ---------------------|----------------|---------------|---------------|");

364 
	`Ârötf
(
p_°©
,"\n SNR | I | P | B |");

365 
	`Ârötf
(
p_°©
,"\n ---------------------|----------------|---------------|---------------|");

366 
	`Ârötf
(
p_°©
,"\n SNR Y(dB) | %5.3f | %5.3f | %5.3f |",

367 
p_Di°
->
mëric
[
PSNR
].
av¶i˚
[
I_SLICE
][0],Ö_Di°->mëric[PSNR].av¶i˚[
P_SLICE
][0],Ö_Di°->mëric[PSNR].av¶i˚[
B_SLICE
][0]);

368 
	`Ârötf
(
p_°©
,"\n SNR U(dB) | %5.3f | %5.3f | %5.3f |",

369 
p_Di°
->
mëric
[
PSNR
].
av¶i˚
[
I_SLICE
][1],Ö_Di°->mëric[PSNR].av¶i˚[
P_SLICE
][1],Ö_Di°->mëric[PSNR].av¶i˚[
B_SLICE
][1]);

370 
	`Ârötf
(
p_°©
,"\n SNR V(dB) | %5.3f | %5.3f | %5.3f |",

371 
p_Di°
->
mëric
[
PSNR
].
av¶i˚
[
I_SLICE
][2],Ö_Di°->mëric[PSNR].av¶i˚[
P_SLICE
][2],Ö_Di°->mëric[PSNR].av¶i˚[
B_SLICE
][2]);

372 
	`Ârötf
(
p_°©
,"\n ---------------------|----------------|---------------|---------------|");

373 
	`Ârötf
(
p_°©
,"\n");

376 
	`Ârötf
(
p_°©
,"\n ---------------------|----------------|---------------|---------------|");

377 
	`Ârötf
(
p_°©
,"\n Ave Quant | I | P | B |");

378 
	`Ârötf
(
p_°©
,"\n ---------------------|----------------|---------------|---------------|");

379 
	`Ârötf
(
p_°©
,"\n QP | %5.3f | %5.3f | %5.3f |",

380 ()
p_Sèts
->
qu™t
[
I_SLICE
]/
	`dmax
(1.0,(Ì_Sèts->
num_ma¸oblocks
[I_SLICE]),

381 ()
p_Sèts
->
qu™t
[
P_SLICE
]/
	`dmax
(1.0,(Ì_Sèts->
num_ma¸oblocks
[P_SLICE]),

382 ()
p_Sèts
->
qu™t
[
B_SLICE
]/
	`dmax
(1.0,(Ì_Sèts->
num_ma¸oblocks
[B_SLICE]));

383 
	`Ârötf
(
p_°©
,"\n ---------------------|----------------|---------------|---------------|");

384 
	`Ârötf
(
p_°©
,"\n");

387 
	`Ârötf
(
p_°©
,"\n ---------------------|----------------|");

388 
	`Ârötf
(
p_°©
,"\n Intra | Mode used |");

389 
	`Ârötf
(
p_°©
,"\n ---------------------|----------------|");

390 
	`Ârötf
(
p_°©
,"\¿Modê0 i¡ø 4x4 | %5" 
FORMAT_OFF_T
 " |", 
p_Sèts
->
mode_u£
[
I_SLICE
][
I4MB
 ]);

391 
	`Ârötf
(
p_°©
,"\¿Modê1 i¡ø 8x8 | %5" 
FORMAT_OFF_T
 " |", 
p_Sèts
->
mode_u£
[
I_SLICE
][
I8MB
 ]);

392 
	`Ârötf
(
p_°©
,"\¿Modê2+ i¡ø 16x16 | %5" 
FORMAT_OFF_T
 " |", 
p_Sèts
->
mode_u£
[
I_SLICE
][
I16MB
]);

393 
	`Ârötf
(
p_°©
,"\¿Modê i¡ø IPCM | %5" 
FORMAT_OFF_T
 " |", 
p_Sèts
->
mode_u£
[
I_SLICE
][
IPCM
 ]);

396 i‡(
p_Sèts
->
‰ame_˘r
[
P_SLICE
]!=0)

398 
món_mŸi⁄_öfo_bô_u£
[
P_SLICE
] = 
	`ªp‹t_¶i˚_¥ed_°©s
(
p_°©
, 
p_Sèts
, P_SLICE,(Ë
bô_u£
[P_SLICE][0], "P Slice ");

401 i‡(
p_Sèts
->
‰ame_˘r
[
B_SLICE
]!=0)

403 
món_mŸi⁄_öfo_bô_u£
[
B_SLICE
] = 
	`ªp‹t_¶i˚_¥ed_°©s
(
p_°©
, 
p_Sèts
, B_SLICE,(Ë
bô_u£
[B_SLICE][0], "B Slice ");

406 i‡(
p_Sèts
->
‰ame_˘r
[
SP_SLICE
]!=0)

408 
món_mŸi⁄_öfo_bô_u£
[
SP_SLICE
] = 
	`ªp‹t_¶i˚_¥ed_°©s
(
p_°©
, 
p_Sèts
, SP_SLICE,(Ë
bô_u£
[SP_SLICE][0], "SP Slice");

412 
	`Ârötf
(
p_°©
,"\n ---------------------|----------------|");

413 
	`Ârötf
(
p_°©
,"\n");

415 
	`Ârötf
(
p_°©
,"\n ---------------------|----------------|----------------|----------------|----------------|");

416 
	`Ârötf
(
p_°©
,"\n Bit usage: | Intra | Inter | B frame | SP frame |");

417 
	`Ârötf
(
p_°©
,"\n ---------------------|----------------|----------------|----------------|----------------|");

419 
	`Ârötf
(
p_°©
,"\n Header |");

420 
	`Ârötf
(
p_°©
," %10.2‡ |", (Ë
p_Sèts
->
bô_u£_hódî
[
I_SLICE
] / 
bô_u£
[I_SLICE][0]);

421 
	`Ârötf
(
p_°©
," %10.2‡ |", (Ë
p_Sèts
->
bô_u£_hódî
[
P_SLICE
] / 
bô_u£
[P_SLICE][0]);

422 
	`Ârötf
(
p_°©
," %10.2‡ |", (Ë
p_Sèts
->
bô_u£_hódî
[
B_SLICE
] / 
bô_u£
[B_SLICE][0]);

424 
	`Ârötf
(
p_°©
,"\n Mode |");

425 
	`Ârötf
(
p_°©
," %10.2‡ |", ()
p_Sèts
->
bô_u£_mb_ty≥
[
I_SLICE
] / 
bô_u£
[I_SLICE][0]);

426 
	`Ârötf
(
p_°©
," %10.2‡ |", ()
p_Sèts
->
bô_u£_mb_ty≥
[
P_SLICE
] / 
bô_u£
[P_SLICE][0]);

427 
	`Ârötf
(
p_°©
," %10.2‡ |", ()
p_Sèts
->
bô_u£_mb_ty≥
[
B_SLICE
] / 
bô_u£
[B_SLICE][0]);

429 
	`Ârötf
(
p_°©
,"\n Motion Info |");

430 
	`Ârötf
(
p_°©
," ./. |");

431 
	`Ârötf
(
p_°©
," %10.2‡ |", 
món_mŸi⁄_öfo_bô_u£
[
P_SLICE
]);

432 
	`Ârötf
(
p_°©
," %10.2‡ |", 
món_mŸi⁄_öfo_bô_u£
[
B_SLICE
]);

434 
	`Ârötf
(
p_°©
,"\n CBP Y/C |");

435 
	`Ârötf
(
p_°©
," %10.2‡ |", (Ë
p_Sèts
->
tmp_bô_u£_cbp
[
I_SLICE
] / 
bô_u£
[I_SLICE][0]);

436 
	`Ârötf
(
p_°©
," %10.2‡ |", (Ë
p_Sèts
->
tmp_bô_u£_cbp
[
P_SLICE
] / 
bô_u£
[P_SLICE][0]);

437 
	`Ârötf
(
p_°©
," %10.2‡ |", (Ë
p_Sèts
->
tmp_bô_u£_cbp
[
B_SLICE
] / 
bô_u£
[B_SLICE][0]);

440 
	`Ârötf
(
p_°©
,"\n Coeffs. Y |");

441 
	`Ârötf
(
p_°©
," %10.2‡ |", (Ë
p_Sèts
->
bô_u£_c€ff
[0][
I_SLICE
] / 
bô_u£
[I_SLICE][0]);

442 
	`Ârötf
(
p_°©
," %10.2‡ |", (Ë
p_Sèts
->
bô_u£_c€ff
[0][
P_SLICE
] / 
bô_u£
[P_SLICE][0]);

443 
	`Ârötf
(
p_°©
," %10.2‡ |", (Ë
p_Sèts
->
bô_u£_c€ff
[0][
B_SLICE
] / 
bô_u£
[B_SLICE][0]);

444 
	`Ârötf
(
p_°©
," %10.2‡ |", (Ë
p_Sèts
->
bô_u£_c€ff
[0][
SP_SLICE
] / 
bô_u£
[SP_SLICE][0]);

446 
	`Ârötf
(
p_°©
,"\n Coeffs. C |");

447 
	`Ârötf
(
p_°©
," %10.2‡ |", (Ë
p_Sèts
->
bô_u£_c€ffC
[
I_SLICE
] / 
bô_u£
[I_SLICE][0]);

448 
	`Ârötf
(
p_°©
," %10.2‡ |", (Ë
p_Sèts
->
bô_u£_c€ffC
[
P_SLICE
] / 
bô_u£
[P_SLICE][0]);

449 
	`Ârötf
(
p_°©
," %10.2‡ |", (Ë
p_Sèts
->
bô_u£_c€ffC
[
B_SLICE
] / 
bô_u£
[B_SLICE][0]);

450 
	`Ârötf
(
p_°©
," %10.2‡ |", (Ë
p_Sèts
->
bô_u£_c€ffC
[
SP_SLICE
] / 
bô_u£
[SP_SLICE][0]);

452 
	`Ârötf
(
p_°©
,"\n Coeffs. CB |");

453 
	`Ârötf
(
p_°©
," %10.2‡ |", (Ë
p_Sèts
->
bô_u£_c€ff
[1][
I_SLICE
] / 
bô_u£
[I_SLICE][0]);

454 
	`Ârötf
(
p_°©
," %10.2‡ |", (Ë
p_Sèts
->
bô_u£_c€ff
[1][
P_SLICE
] / 
bô_u£
[P_SLICE][0]);

455 
	`Ârötf
(
p_°©
," %10.2‡ |", (Ë
p_Sèts
->
bô_u£_c€ff
[1][
B_SLICE
] / 
bô_u£
[B_SLICE][0]);

456 
	`Ârötf
(
p_°©
," %10.2‡ |", (Ë
p_Sèts
->
bô_u£_c€ff
[1][
SP_SLICE
] / 
bô_u£
[SP_SLICE][0]);

458 
	`Ârötf
(
p_°©
,"\n Coeffs. CR |");

459 
	`Ârötf
(
p_°©
," %10.2‡ |", (Ë
p_Sèts
->
bô_u£_c€ff
[2][
I_SLICE
] / 
bô_u£
[I_SLICE][0]);

460 
	`Ârötf
(
p_°©
," %10.2‡ |", (Ë
p_Sèts
->
bô_u£_c€ff
[2][
P_SLICE
] / 
bô_u£
[P_SLICE][0]);

461 
	`Ârötf
(
p_°©
," %10.2‡ |", (Ë
p_Sèts
->
bô_u£_c€ff
[2][
B_SLICE
] / 
bô_u£
[B_SLICE][0]);

462 
	`Ârötf
(
p_°©
," %10.2‡ |", (Ë
p_Sèts
->
bô_u£_c€ff
[2][
SP_SLICE
] / 
bô_u£
[SP_SLICE][0]);

464 
	`Ârötf
(
p_°©
,"\n Delta quant |");

465 
	`Ârötf
(
p_°©
," %10.2‡ |", (Ë
p_Sèts
->
bô_u£_dñè_qu™t
[
I_SLICE
] / 
bô_u£
[I_SLICE][0]);

466 
	`Ârötf
(
p_°©
," %10.2‡ |", (Ë
p_Sèts
->
bô_u£_dñè_qu™t
[
P_SLICE
] / 
bô_u£
[P_SLICE][0]);

467 
	`Ârötf
(
p_°©
," %10.2‡ |", (Ë
p_Sèts
->
bô_u£_dñè_qu™t
[
B_SLICE
] / 
bô_u£
[B_SLICE][0]);

469 
	`Ârötf
(
p_°©
,"\n Stuffing Bits |");

470 
	`Ârötf
(
p_°©
," %10.2‡ |", (Ë
p_Sèts
->
bô_u£_°uffög_bôs
[
I_SLICE
] / 
bô_u£
[I_SLICE][0]);

471 
	`Ârötf
(
p_°©
," %10.2‡ |", (Ë
p_Sèts
->
bô_u£_°uffög_bôs
[
P_SLICE
] / 
bô_u£
[P_SLICE][0]);

472 
	`Ârötf
(
p_°©
," %10.2‡ |", (Ë
p_Sèts
->
bô_u£_°uffög_bôs
[
B_SLICE
] / 
bô_u£
[B_SLICE][0]);

474 
	`Ârötf
(
p_°©
,"\n ---------------------|----------------|----------------|----------------|");

475 
	`Ârötf
(
p_°©
,"\náverage bits/frame |");

476 
	`Ârötf
(
p_°©
," %10.2‡ |", (Ë
bô_u£
[
I_SLICE
][1] / () bit_use[I_SLICE][0] );

477 
	`Ârötf
(
p_°©
," %10.2‡ |", (Ë
bô_u£
[
P_SLICE
][1] / () bit_use[P_SLICE][0] );

478 
	`Ârötf
(
p_°©
," %10.2‡ |", (Ë
bô_u£
[
B_SLICE
][1] / () bit_use[B_SLICE][0] );

479 
	`Ârötf
(
p_°©
,"\n ---------------------|----------------|----------------|----------------|");

480 
	`Ârötf
(
p_°©
,"\n");

482 
	`f˛o£
(
p_°©
);

483 
	}
}

486 
	$ªp‹t_log
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
SètP¨amëîs
 *
p_Sèts
)

488 
Di°‹ti⁄P¨ams
 *
p_Di°
 = 
p_Vid
->p_Dist;

489 
FILE
 *
p_log
 = 
p_Vid
->p_log;

490 
«me
[40];

491 
i
;

492 #i‚de‡
WIN32


493 
time_t
 
now
;

494 
tm
 *
l_time
;

495 
°rög
[1000];

497 
timebuf
[128];

500 i‡((
p_log
 = 
	`f›í
("log.dat", "r")) == 0)

502 i‡((
p_log
 = 
	`f›í
("log.d©", "a")Ë=
NULL
)

504 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Error open file %s \n", "log.dat");

505 
	`îr‹
(
îr‹ãxt
, 500);

509 
	`Ârötf
(
p_log
," ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ \n");

510 
	`Ârötf
(
p_log
,"| Encoder statistics. This file is generated during firstÉncoding session,Çew sessions will beáppended |\n");

511 
	`Ârötf
(
p_log
," ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ \n");

512 
	`Ârötf
(
p_log
,"| ver | Date | Time | Sequence | #Img |P/MbInt| QPI| QPP| QPB| Format |Iperiod| #B | FMES | Hdmd | S.R |#Ref | Freq |Coding|RD-opt|Intra upd|8x8Tr| SNRY 1| SNRU 1| SNRV 1| SNRY N| SNRU N| SNRV N|#Bitr I|#Bitr P|#Bitr B|#Bitr IPB| Total Time | Me Time |\n");

513 
	`Ârötf
(
p_log
," ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ \n");

519 
	`f˛o£
 (
p_log
);

520 i‡((
p_log
 = 
	`f›í
("log.d©", "a")Ë=
NULL
)

522 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Error open file %s \n", "log.dat");

523 
	`îr‹
(
îr‹ãxt
, 500);

526 
	`Ârötf
(
p_log
,"|%5s/%-5s", 
VERSION
, 
EXT_VERSION
);

528 #ifde‡
WIN32


529 
	`_°rd©e
–
timebuf
 );

530 
	`Ârötf
(
p_log
,"| %1.5†|", 
timebuf
 );

532 
	`_°πime
–
timebuf
);

533 
	`Ârötf
(
p_log
," % 1.5†|", 
timebuf
);

535 
now
 = 
	`time
 ((
time_t
 *Ë
NULL
);

536 
	`time
 (&
now
);

537 
l_time
 = 
	`loˇ…ime
 (&
now
);

538 
	`°r·ime
 (
°rög
,  såög, "%d-%b-%Y", 
l_time
);

539 
	`Ârötf
(
p_log
,"| %1.5†|", 
°rög
 );

541 
	`°r·ime
 (
°rög
,  såög, "%H:%M:%S", 
l_time
);

542 
	`Ârötf
(
p_log
," %1.5†|", 
°rög
 );

545 
i
=0; i < 40; i++)

546 
«me
[
i
] = 
p_I≈
->
öput_fûe1
.
‚ame
[ò+ 
	`imax
(0, ((Ë
	`°æí
(p_Inp->input_file1.fname)) - 40)];

547 
	`Ârötf
(
p_log
,"%40.40s|",
«me
);

549 
	`Ârötf
(
p_log
,"%5d | %d/%d |", 
p_I≈
->
no_‰ames
,Ö_I≈->
PicI¡îœ˚
,Ö_I≈->
MbI¡îœ˚
);

550 
	`Ârötf
(
p_log
," %-3d| %-3d| %-3d|", 
p_I≈
->
qp
[
I_SLICE
],Ö_I≈->qp[
P_SLICE
],Ö_I≈->qp[
B_SLICE
]);

552 
	`Ârötf
(
p_log
,"%4dx%-4d|", 
p_I≈
->
ouçut
.
width
[0],Ö_I≈->ouçut.
height
[0]);

553 
	`Ârötf
(
p_log
," %3d |%3d |", 
p_I≈
->
öåa_≥riod
, 
p_Sèts
->
NumbîBFømes
);

556  
p_I≈
->
SórchMode
[0] )

558 
UM_HEX
:

559 
	`Ârötf
(
p_log
," HEX |");

561 
UM_HEX_SIMPLE
:

562 
	`Ârötf
(
p_log
," SHEX |");

564 
EPZS
:

565 
	`Ârötf
(
p_log
," EPZS |");

567 
FAST_FULL_SEARCH
:

568 
	`Ârötf
(
p_log
," FFS |");

571 
	`Ârötf
(
p_log
," FS |");

574 #i‡(
MVC_EXTENSION_ENABLE
)

575 i‡–
p_I≈
->
SïVõwI¡îSórch
 )

577  
p_I≈
->
SórchMode
[1] )

579 
UM_HEX
:

580 
	`Ârötf
(
p_log
," HEX |");

582 
UM_HEX_SIMPLE
:

583 
	`Ârötf
(
p_log
," SHEX |");

585 
EPZS
:

586 
	`Ârötf
(
p_log
," EPZS |");

588 
FAST_FULL_SEARCH
:

589 
	`Ârötf
(
p_log
," FFS |");

592 
	`Ârötf
(
p_log
," FS |");

598 
	`Ârötf
(
p_log
," %1d%1d%1d |", 
p_I≈
->
MEEº‹Mëric
[
F_PEL
],Ö_I≈->MEEº‹Mëric[
H_PEL
],Ö_I≈->MEEº‹Mëric[
Q_PEL
]);

600 #i‡(
MVC_EXTENSION_ENABLE
)

601 i‡–
p_I≈
->
SïVõwI¡îSórch
 )

603 
	`Ârötf
(
p_log
," %3d (%3dË| %2d |", 
p_I≈
->
£¨ch_ønge
[0],Ö_I≈->£¨ch_ønge[1],Ö_I≈->
num_ªf_‰ames
 );

607 
	`Ârötf
(
p_log
," %3d | %2d |", 
p_I≈
->
£¨ch_ønge
[0],Ö_I≈->
num_ªf_‰ames
 );

609 
	`Ârötf
(
p_log
," %5.2f|", 
p_Vid
->
‰amî©e
);

611 i‡(
p_I≈
->
symbﬁ_mode
 =
CAVLC
)

612 
	`Ârötf
(
p_log
," CAVLC|");

614 
	`Ârötf
(
p_log
," CABAC|");

616 
	`Ârötf
(
p_log
," %d |", 
p_I≈
->
rd›t
);

618 i‡(
p_I≈
->
öåa_upd
 == 1)

619 
	`Ârötf
(
p_log
," ON |");

621 
	`Ârötf
(
p_log
," OFF |");

623 
	`Ârötf
(
p_log
," %d |", 
p_I≈
->
Tønsf‹m8x8Mode
);

625 
	`Ârötf
(
p_log
,"%7.3f|%7.3f|%7.3f|",

626 
p_Di°
->
mëric
[
PSNR
].
av¶i˚
[
I_SLICE
][0],

627 
p_Di°
->
mëric
[
PSNR
].
av¶i˚
[
I_SLICE
][1],

628 
p_Di°
->
mëric
[
PSNR
].
av¶i˚
[
I_SLICE
][2]);

629 
	`Ârötf
(
p_log
,"%7.3f|%7.3f|%7.3f|", 
p_Di°
->
mëric
[
PSNR
].
avîage
[0],p_Dist->metric[PSNR].average[1],p_Dist->metric[PSNR].average[2]);

635 
	`Ârötf
(
p_log
,"%7.0f|%7.0f|%7.0f|%9.0f|", 
p_Sèts
->
bôøã_°
[
I_SLICE
],p_Sèts->bôøã_°[
P_SLICE
],p_Sèts->bôøã_°[
B_SLICE
],Ö_Sèts->
bôøã
);

636 
	`Ârötf
(
p_log
," %12d | %12d |", ()
p_Vid
->
tŸ_time
,(Ì_Vid->
me_tŸ_time
);

639 
	`Ârötf
(
p_log
,"\n");

641 
	`f˛o£
(
p_log
);

643 
p_log
 = 
	`f›í
("data.txt", "a");

645 i‡((
p_Sèts
->
NumbîBFømes
 !0Ë&& (p_Sèts->
‰ame_˘r
[
B_SLICE
] != 0))

647 
	`Ârötf
(
p_log
, "%3d %2d %2d %2.2‡%2.2‡%2.2‡%5" 
FORMAT_OFF_T
 " "

649 "%2.2‡%2.2‡%2.2‡%5" 
FORMAT_OFF_T
 " %5" FORMAT_OFF_T " %.3f\n",

650 
p_Sèts
->
‰ame_cou¡î
, 
p_I≈
->
qp
[
I_SLICE
],Ö_I≈->qp[
P_SLICE
],

651 
p_Di°
->
mëric
[
PSNR
].
av¶i˚
[
I_SLICE
][0],

652 
p_Di°
->
mëric
[
PSNR
].
av¶i˚
[
I_SLICE
][1],

653 
p_Di°
->
mëric
[
PSNR
].
av¶i˚
[
I_SLICE
][2],

654 
p_Sèts
->
bô_cou¡î
[
I_SLICE
],

659 
p_Di°
->
mëric
[
PSNR
].
avîage
[0],

660 
p_Di°
->
mëric
[
PSNR
].
avîage
[1],

661 
p_Di°
->
mëric
[
PSNR
].
avîage
[2],

662 (
p_Sèts
->
bô_cou¡î
[
I_SLICE
] +Ö_Sèts->
bô_˘r
Ë/Ö_Sèts->
‰ame_cou¡î
,

663 
p_Sèts
->
bô_cou¡î
[
B_SLICE
] /Ö_Sèts->
‰ame_˘r
[B_SLICE],

664 (Ë0.001 * 
p_Vid
->
tŸ_time
 / (
p_Sèts
->
‰ame_cou¡î
));

668 i‡(
p_I≈
->
no_‰ames
 != 0)

669 
	`Ârötf
(
p_log
, "%3d %2d %2d %2.2‡%2.2‡%2.2‡%5" 
FORMAT_OFF_T
 " "

671 "%2.2‡%2.2‡%2.2‡%5" 
FORMAT_OFF_T
 " %5d %.3f\n",

672 
p_Sèts
->
‰ame_cou¡î
, 
p_I≈
->
qp
[
I_SLICE
],Ö_I≈->qp[
P_SLICE
],

673 
p_Di°
->
mëric
[
PSNR
].
av¶i˚
[
I_SLICE
][0],

674 
p_Di°
->
mëric
[
PSNR
].
av¶i˚
[
I_SLICE
][1],

675 
p_Di°
->
mëric
[
PSNR
].
av¶i˚
[
I_SLICE
][2],

676 
p_Sèts
->
bô_cou¡î
[
I_SLICE
],

681 
p_Di°
->
mëric
[
PSNR
].
avîage
[0],

682 
p_Di°
->
mëric
[
PSNR
].
avîage
[1],

683 
p_Di°
->
mëric
[
PSNR
].
avîage
[2],

684 (
p_Sèts
->
bô_cou¡î
[
I_SLICE
] +Ö_Sèts->
bô_˘r
)/Ö_Sèts->
‰ame_cou¡î
,

686 ()0.001 * 
p_Vid
->
tŸ_time
 / 
p_Sèts
->
‰ame_cou¡î
);

689 
	`f˛o£
(
p_log
);

690 
	}
}

705 
	$ªp‹t
–
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
SètP¨amëîs
 *
p_Sèts
)

707 
Di°‹ti⁄P¨ams
 *
p_Di°
 = 
p_Vid
->p_Dist;

708 
öt64
 
bô_u£
[
NUM_SLICE_TYPES
][2];

709 
i
,
j
;

710 
öt64
 
tŸÆ_bôs
;

711 #i‡(
MVC_EXTENSION_ENABLE
)

712 
öt64
 
tŸÆ_bôs_v
[
NUM_VIEWS
];

715 
bô_u£
[ 
I_SLICE
][0] = 
p_Sèts
->
‰ame_˘r
[I_SLICE];

716 
bô_u£
[ 
P_SLICE
][0] = 
	`imax
(
p_Sèts
->
‰ame_˘r
[P_SLICE ] +Ö_Sèts->‰ame_˘r[
SP_SLICE
], 1);

717 
bô_u£
[ 
B_SLICE
][0] = 
	`imax
(
p_Sèts
->
‰ame_˘r
[B_SLICE ], 1);

718 
bô_u£
[
SP_SLICE
][0] = 
	`imax
(
p_Sèts
->
‰ame_˘r
[SP_SLICE], 1);

721 
p_Vid
->
tŸ_time
 = 
	`timí‹m
(p_Vid->tot_time);

722 
p_Vid
->
me_tŸ_time
 = 
	`timí‹m
(p_Vid->me_tot_time);

724 
j
=0; j < 
NUM_SLICE_TYPES
; j++)

726 
bô_u£
[
j
][1] = 0;

729 
j
=0; j < 
NUM_SLICE_TYPES
; j++)

731 
i
=0; i < 
MAXMODE
; i++)

732 
bô_u£
[
j
][1] +
p_Sèts
->
bô_u£_mode
[j][
i
];

734 
bô_u£
[
j
][1] +
p_Sèts
->
bô_u£_mb_ty≥
[j];

735 
bô_u£
[
j
][1] +
p_Sèts
->
bô_u£_hódî
[j];

736 
bô_u£
[
j
][1] +
p_Sèts
->
tmp_bô_u£_cbp
[j];

737 
bô_u£
[
j
][1] +
p_Sèts
->
bô_u£_c€ffC
[j];

738 
bô_u£
[
j
][1] +
p_Sèts
->
bô_u£_c€ff
[0][j];

739 
bô_u£
[
j
][1] +
p_Sèts
->
bô_u£_c€ff
[1][j];

740 
bô_u£
[
j
][1] +
p_Sèts
->
bô_u£_c€ff
[2][j];

741 
bô_u£
[
j
][1] +
p_Sèts
->
bô_u£_dñè_qu™t
[j];

742 
bô_u£
[
j
][1] +
p_Sèts
->
bô_u£_°uffög_bôs
[j];

746 
p_Sèts
->
bôøã_°
[ 
I_SLICE
] = (p_Sèts->
bô_cou¡î
[ I_SLICE]Ë* (Ë(
p_I≈
->
ouçut
.
‰ame_øã
Ë/ (Ë’_Sèts->
‰ame_cou¡î
);

747 
p_Sèts
->
bôøã_°
[ 
P_SLICE
] = (p_Sèts->
bô_cou¡î
[ P_SLICE]Ë* (Ë(
p_I≈
->
ouçut
.
‰ame_øã
Ë/ (Ë’_Sèts->
‰ame_cou¡î
);

748 
p_Sèts
->
bôøã_°
[ 
B_SLICE
] = (p_Sèts->
bô_cou¡î
[ B_SLICE]Ë* (Ë(
p_I≈
->
ouçut
.
‰ame_øã
Ë/ (Ë’_Sèts->
‰ame_cou¡î
);

749 
p_Sèts
->
bôøã_°
[
SP_SLICE
] = (p_Sèts->
bô_cou¡î
[SP_SLICE]Ë* (Ë(
p_I≈
->
ouçut
.
‰ame_øã
Ë/ (Ë’_Sèts->
‰ame_cou¡î
);

751 
p_I≈
->
Vîbo£
)

756 
	`Ârötf
(
°dout
,"------------------ Average dataáll frames -----------------------------------\n\n");

759 
	`Ârötf
(
°dout
,"------------------------------------ Average dataáll frames ---------------------------------\n\n");

762 
	`Ârötf
(
°dout
,"--------------------------------------- Average dataáll frames -------------------------------------\n\n");

766 i‡(
p_I≈
->
Vîbo£
 != 0)

768 
Di°Mëric
 *
¢r
 = &
p_Di°
->
mëric
[
PSNR
 ];

769 
Di°Mëric
 *
s£
 = &
p_Di°
->
mëric
[
SSE
 ];

770 
Di°Mëric
 *
¢r_rgb
 = &
p_Di°
->
mëric
[
PSNR_RGB
];

771 
Di°Mëric
 *
s£_rgb
 = &
p_Di°
->
mëric
[
SSE_RGB
 ];

773 
impix
 = 
p_I≈
->
ouçut
.
size_cmp
[0];

774 
impix_¸
 = 
p_I≈
->
ouçut
.
size_cmp
[1];

776 
c¢r_y
 = 
	`p¢r
(
p_Vid
->
max_img≥l_vÆue_comp_sq
[0], 
impix
 , 
s£
->
avîage
[0]);

777 
c¢r_u
 = 
	`p¢r
(
p_Vid
->
max_img≥l_vÆue_comp_sq
[1], 
impix_¸
, 
s£
->
avîage
[1]);

778 
c¢r_v
 = 
	`p¢r
(
p_Vid
->
max_img≥l_vÆue_comp_sq
[2], 
impix_¸
, 
s£
->
avîage
[2]);

780 #i‡(
MVC_EXTENSION_ENABLE
)

781 
Di°Mëric
 *
¢r_v
[2] = {
NULL
, NULL};

782 
Di°Mëric
 *
s£_v
[2] = {
NULL
, NULL};

783 
c¢r_y_v
[2] = {0.0, 0.0};

784 
c¢r_u_v
[2] = {0.0, 0.0};

785 
c¢r_v_v
[2] = {0.0, 0.0};

787 i‡(
p_I≈
->
num_of_võws
 == 2)

789 
¢r_v
[0] = &
p_Di°
->
mëric_v
[0][
PSNR
];

790 
¢r_v
[1] = &
p_Di°
->
mëric_v
[1][
PSNR
];

791 
s£_v
[0] = &
p_Di°
->
mëric_v
[0][
SSE
];

792 
s£_v
[1] = &
p_Di°
->
mëric_v
[1][
SSE
];

793 
c¢r_y_v
[0] = 
	`p¢r
(
p_Vid
->
max_img≥l_vÆue_comp_sq
[0], 
impix
 , 
s£_v
[0]->
avîage
[0]);

794 
c¢r_u_v
[0] = 
	`p¢r
(
p_Vid
->
max_img≥l_vÆue_comp_sq
[1], 
impix_¸
, 
s£_v
[0]->
avîage
[1]);

795 
c¢r_v_v
[0] = 
	`p¢r
(
p_Vid
->
max_img≥l_vÆue_comp_sq
[2], 
impix_¸
, 
s£_v
[0]->
avîage
[2]);

796 
c¢r_y_v
[1] = 
	`p¢r
(
p_Vid
->
max_img≥l_vÆue_comp_sq
[0], 
impix
 , 
s£_v
[1]->
avîage
[0]);

797 
c¢r_u_v
[1] = 
	`p¢r
(
p_Vid
->
max_img≥l_vÆue_comp_sq
[1], 
impix_¸
, 
s£_v
[1]->
avîage
[1]);

798 
c¢r_v_v
[1] = 
	`p¢r
(
p_Vid
->
max_img≥l_vÆue_comp_sq
[2], 
impix_¸
, 
s£_v
[1]->
avîage
[2]);

802 
	`Ârötf
(
°dout
, " TŸÆÉncodögÅimêf‹Åhê£q. : %7.3‡£¯(%3.2‡Âs)\n", (Ë
p_Vid
->
tŸ_time
 * 0.001, 1000.0 * (Ë(
p_Sèts
->
‰ame_cou¡î
) / ()p_Vid->tot_time);

803 
	`Ârötf
(
°dout
, " TŸÆ MEÅimêf‹ sequí˚ : %7.3‡£¯\n\n", ()
p_Vid
->
me_tŸ_time
 * 0.001);

805 
	`Ârötf
(
°dout
," Y { PSNR (dB), cSNR (dB), MSE } : { %7.3f, %7.3f, %9.5f }\n",

806 
¢r
->
avîage
[0], 
c¢r_y
, 
s£
->avîage[0]/()
impix
);

807 
	`Ârötf
(
°dout
," U { PSNR (dB), cSNR (dB), MSE } : { %7.3f, %7.3f, %9.5f }\n",

808 
¢r
->
avîage
[1], 
c¢r_u
, 
s£
->avîage[1]/()
impix_¸
);

809 
	`Ârötf
(
°dout
," V { PSNR (dB), cSNR (dB), MSE } : { %7.3f, %7.3f, %9.5f }\n",

810 
¢r
->
avîage
[2], 
c¢r_v
, 
s£
->avîage[2]/()
impix_¸
);

811 #i‡(
MVC_EXTENSION_ENABLE
)

812 i‡(
p_I≈
->
num_of_võws
 == 2)

814 
	`Ârötf
–
°dout
, "\n" );

815 
	`Ârötf
(
°dout
," View0_Y { PSNR (dB), cSNR (dB), MSE } : { %7.3f, %7.3f, %9.5f }\n",

816 
¢r_v
[0]->
avîage
[0], 
c¢r_y_v
[0], 
s£_v
[0]->avîage[0]/()
impix
);

817 
	`Ârötf
(
°dout
," View0_U { PSNR (dB), cSNR (dB), MSE } : { %7.3f, %7.3f, %9.5f }\n",

818 
¢r_v
[0]->
avîage
[1], 
c¢r_u_v
[0], 
s£_v
[0]->avîage[1]/()
impix_¸
);

819 
	`Ârötf
(
°dout
," View0_V { PSNR (dB), cSNR (dB), MSE } : { %7.3f, %7.3f, %9.5f }\n",

820 
¢r_v
[0]->
avîage
[2], 
c¢r_v_v
[0], 
s£_v
[0]->avîage[2]/()
impix_¸
);

821 
	`Ârötf
–
°dout
, "\n" );

822 
	`Ârötf
(
°dout
," View1_Y { PSNR (dB), cSNR (dB), MSE } : { %7.3f, %7.3f, %9.5f }\n",

823 
¢r_v
[1]->
avîage
[0], 
c¢r_y_v
[1], 
s£_v
[1]->avîage[0]/()
impix
);

824 
	`Ârötf
(
°dout
," View1_U { PSNR (dB), cSNR (dB), MSE } : { %7.3f, %7.3f, %9.5f }\n",

825 
¢r_v
[1]->
avîage
[1], 
c¢r_u_v
[1], 
s£_v
[1]->avîage[1]/()
impix_¸
);

826 
	`Ârötf
(
°dout
," View1_V { PSNR (dB), cSNR (dB), MSE } : { %7.3f, %7.3f, %9.5f }\n",

827 
¢r_v
[1]->
avîage
[2], 
c¢r_v_v
[1], 
s£_v
[1]->avîage[2]/()
impix_¸
);

831 if(
p_I≈
->
Di°‹ti⁄YUVtoRGB
 == 1)

833 
c¢r_r
 = 
	`p¢r
(
p_Vid
->
max_img≥l_vÆue_comp_sq
[0], 
impix
, 
s£_rgb
->
avîage
[0]);

834 
c¢r_g
 = 
	`p¢r
(
p_Vid
->
max_img≥l_vÆue_comp_sq
[1], 
impix
, 
s£_rgb
->
avîage
[1]);

835 
c¢r_b
 = 
	`p¢r
(
p_Vid
->
max_img≥l_vÆue_comp_sq
[2], 
impix
, 
s£_rgb
->
avîage
[2]);

837 
	`Ârötf
(
°dout
," R { PSNR (dB), cSNR (dB), MSE } : { %7.3f, %7.3f, %9.5f }\n",

838 
¢r_rgb
->
avîage
[0], 
c¢r_r
, 
s£_rgb
->avîage[0] / (Ë
impix
);

839 
	`Ârötf
(
°dout
," G { PSNR (dB), cSNR (dB), MSE } : { %7.3f, %7.3f, %9.5f }\n",

840 
¢r_rgb
->
avîage
[1], 
c¢r_g
, 
s£_rgb
->avîage[1] / (Ë
impix
);

841 
	`Ârötf
(
°dout
," B { PSNR (dB), cSNR (dB), MSE } : { %7.3f, %7.3f, %9.5f }\n",

842 
¢r_rgb
->
avîage
[2], 
c¢r_b
, 
s£_rgb
->avîage[2] / (Ë
impix
);

845 i‡(
p_I≈
->
Di°‹ti⁄
[
SSIM
] == 1)

847 if(
p_I≈
->
Di°‹ti⁄YUVtoRGB
 == 1)

849 
	`Ârötf
(
°dout
," SSIM {Y, R} : { %5.4f, %5.4‡}\n", 
p_Di°
->
mëric
[
SSIM
].
avîage
[0],Ö_Di°->mëric[
SSIM_RGB
].average[0]);

850 
	`Ârötf
(
°dout
," SSIM {U, G} : { %5.4f, %5.4‡}\n", 
p_Di°
->
mëric
[
SSIM
].
avîage
[1],Ö_Di°->mëric[
SSIM_RGB
].average[1]);

851 
	`Ârötf
(
°dout
," SSIM {V, B} : { %5.4f, %5.4‡}\n", 
p_Di°
->
mëric
[
SSIM
].
avîage
[2],Ö_Di°->mëric[
SSIM_RGB
].average[2]);

855 
	`Ârötf
(
°dout
," Y SSIM : %5.4f\n", 
p_Di°
->
mëric
[
SSIM
].
avîage
[0]);

856 
	`Ârötf
(
°dout
," U SSIM : %5.4f\n", 
p_Di°
->
mëric
[
SSIM
].
avîage
[1]);

857 
	`Ârötf
(
°dout
," V SSIM : %5.4f\n", 
p_Di°
->
mëric
[
SSIM
].
avîage
[2]);

860 i‡(
p_I≈
->
Di°‹ti⁄
[
MS_SSIM
] == 1)

862 if(
p_I≈
->
Di°‹ti⁄YUVtoRGB
 == 1)

864 
	`Ârötf
(
°dout
," MS-SSIM {Y, R} : { %5.4f, %5.4‡}\n", 
p_Di°
->
mëric
[
MS_SSIM
].
avîage
[0],Ö_Di°->mëric[
MS_SSIM_RGB
].average[0]);

865 
	`Ârötf
(
°dout
," MS-SSIM {U, G} : { %5.4f, %5.4‡}\n", 
p_Di°
->
mëric
[
MS_SSIM
].
avîage
[1],Ö_Di°->mëric[
MS_SSIM_RGB
].average[1]);

866 
	`Ârötf
(
°dout
," MS-SSIM {V, B} : { %5.4f, %5.4‡}\n", 
p_Di°
->
mëric
[
MS_SSIM
].
avîage
[2],Ö_Di°->mëric[
MS_SSIM_RGB
].average[2]);

870 
	`Ârötf
(
°dout
," Y MS-SSIM : %5.4f\n", 
p_Di°
->
mëric
[
MS_SSIM
].
avîage
[0]);

871 
	`Ârötf
(
°dout
," U MS-SSIM : %5.4f\n", 
p_Di°
->
mëric
[
MS_SSIM
].
avîage
[1]);

872 
	`Ârötf
(
°dout
," V MS-SSIM : %5.4f\n", 
p_Di°
->
mëric
[
MS_SSIM
].
avîage
[2]);

875 
	`Ârötf
(
°dout
,"\n");

878 
	`Ârötf
(
°dout
, " TŸÆÉncodögÅimêf‹Åhê£q. : %5.3‡£¯(%5.2‡Âs)\n\n", 
p_Vid
->
tŸ_time
 * 0.001, 1000.0 * (
p_Sèts
->
‰ame_cou¡î
) /Ö_Vid->tot_time);

880 
tŸÆ_bôs
 = 
p_Sèts
->
bô_˘r_∑ømëî£ts
;

881 
tŸÆ_bôs
 +
p_Sèts
->
bô_˘r_fûÀr_d©a
;

882 
i
 = 0; i < 
NUM_SLICE_TYPES
; i++)

883 
tŸÆ_bôs
 +
p_Sèts
->
bô_cou¡î
[
i
];

884 #i‡(
MVC_EXTENSION_ENABLE
)

885 i‡(
p_I≈
->
num_of_võws
 == 2)

887  
j
 = 0; j < 
NUM_VIEWS
; j++ )

889 
tŸÆ_bôs_v
[
j
] = 
p_Sèts
->
bô_˘r_∑ømëî£ts_v
[j];

890 
tŸÆ_bôs_v
[
j
] +
p_Sèts
->
bô_˘r_fûÀr_d©a_v
[j];

891 
i
 = 0; i < 
NUM_SLICE_TYPES
; i++)

892 
tŸÆ_bôs_v
[
j
] +
p_Sèts
->
bô_cou¡î_v
[j][
i
];

896 i‡(
p_I≈
->
num_of_võws
 =2 && 
p_Vid
->
Êd_Êag
)

898 i‡(
p_Sèts
->
‰ame_˘r
[
B_SLICE
] != 0)

900 
	`Ârötf
(
°dout
, " TŸÆ bô† : %" 
FORMAT_OFF_T
 " (I %" FORMAT_OFF_T ", P %" FORMAT_OFF_T ", B %" FORMAT_OFF_T " NVB %d) \n",

901 
tŸÆ_bôs_v
[0] +Åotal_bits_v[1],

902 
p_Sèts
->
bô_cou¡î_v
[0][
I_SLICE
] +Ö_Stats->bit_counter_v[1][I_SLICE],

903 
p_Sèts
->
bô_cou¡î_v
[0][
P_SLICE
] +Ö_Stats->bit_counter_v[1][P_SLICE],

904 
p_Sèts
->
bô_cou¡î_v
[0][
B_SLICE
] +Ö_Stats->bit_counter_v[1][B_SLICE],

905 
p_Sèts
->
bô_˘r_∑ømëî£ts_v
[0] +Ö_Stats->bit_ctr_parametersets_v[1]);

909 
	`Ârötf
(
°dout
, " TŸÆ bô† : %" 
FORMAT_OFF_T
 " (I %" FORMAT_OFF_T ", P %" FORMAT_OFF_T ", NVB %d) \n",

910 
tŸÆ_bôs_v
[0] +Åotal_bits_v[1],

911 
p_Sèts
->
bô_cou¡î_v
[0][
I_SLICE
] +Ö_Stats->bit_counter_v[1][I_SLICE],

912 
p_Sèts
->
bô_cou¡î_v
[0][
P_SLICE
] +Ö_Stats->bit_counter_v[1][P_SLICE],

913 
p_Sèts
->
bô_˘r_∑ømëî£ts_v
[0] +Ö_Stats->bit_ctr_parametersets_v[1]);

919 i‡(
p_Sèts
->
‰ame_˘r
[
B_SLICE
] != 0)

921 
	`Ârötf
(
°dout
, " TŸÆ bô† : %" 
FORMAT_OFF_T
 " (I %" FORMAT_OFF_T ", P %" FORMAT_OFF_T ", B %" FORMAT_OFF_T " NVB %d) \n",

922 
tŸÆ_bôs
, 
p_Sèts
->
bô_cou¡î
[
I_SLICE
],Ö_Sèts->bô_cou¡î[
P_SLICE
],Ö_Sèts->bô_cou¡î[
B_SLICE
],Ö_Sèts->
bô_˘r_∑ømëî£ts
);

926 
	`Ârötf
(
°dout
, " TŸÆ bô† : %" 
FORMAT_OFF_T
 " (I %" FORMAT_OFF_T ", P %" FORMAT_OFF_T ", NVB %d) \n",

927 
tŸÆ_bôs
, 
p_Sèts
->
bô_cou¡î
[
I_SLICE
],Ö_Sèts->bô_cou¡î[
P_SLICE
],Ö_Sèts->
bô_˘r_∑ømëî£ts
);

930 #i‡(
MVC_EXTENSION_ENABLE
)

931 i‡(
p_I≈
->
num_of_võws
 == 2)

933 
võw_id
;

935  
võw_id
 = 0; võw_id < 
NUM_VIEWS
; view_id++ )

937 i‡(
p_Sèts
->
‰ame_˘r
[
B_SLICE
] != 0)

939 
	`Ârötf
(
°dout
, " Võw %1d TŸÆ-bô† : %" 
FORMAT_OFF_T
 " (I %" FORMAT_OFF_T ", P %" FORMAT_OFF_T ", B %" FORMAT_OFF_T " NVB %d) \n",

940 
võw_id
, 
tŸÆ_bôs_v
[võw_id], 
p_Sèts
->
bô_cou¡î_v
[võw_id][
I_SLICE
],Ö_Sèts->bô_cou¡î_v[võw_id][
P_SLICE
],Ö_Sèts->bô_cou¡î_v[võw_id][
B_SLICE
],Ö_Sèts->
bô_˘r_∑ømëî£ts_v
[view_id]);

944 
	`Ârötf
(
°dout
, " Võw %1d TŸÆ-bô† : %" 
FORMAT_OFF_T
 " (I %" FORMAT_OFF_T ", P %" FORMAT_OFF_T ", NVB %d) \n",

945 
võw_id
, 
tŸÆ_bôs_v
[võw_id], 
p_Sèts
->
bô_cou¡î_v
[võw_id][
I_SLICE
],Ö_Sèts->bô_cou¡î_v[võw_id][
P_SLICE
],Ö_Sèts->
bô_˘r_∑ømëî£ts_v
[view_id]);

950 i‡(
p_I≈
->
num_of_võws
 == 2)

952 
p_Sèts
->
bôøã
((Ë
tŸÆ_bôs
 * (Ë
p_I≈
->
ouçut
.
‰ame_øã
Ë/ ((Ë’_Sèts->
‰ame_cou¡î
>>1));

956 
p_Sèts
->
bôøã
((Ë
tŸÆ_bôs
 * (Ë
p_I≈
->
ouçut
.
‰ame_øã
Ë/ ((Ë’_Sèts->
‰ame_cou¡î
));

957 
	`Ârötf
(
°dout
, " BôÑ©ê(kbô/sË @ %2.2‡Hz : %5.2f\n", 
p_I≈
->
ouçut
.
‰ame_øã
, 
p_Sèts
->
bôøã
 / 1000.0);

958 #i‡(
MVC_EXTENSION_ENABLE
)

959 i‡(
p_I≈
->
num_of_võws
 == 2)

961 
p_Sèts
->
bôøã_v
[0] = ((Ë
tŸÆ_bôs_v
[0] * (Ë
p_I≈
->
ouçut
.
‰ame_øã
Ë/ ((Ë’_Sèts->
‰ame_cou¡î
 >> 1));

962 
p_Sèts
->
bôøã_v
[1] = ((Ë
tŸÆ_bôs_v
[1] * (Ë
p_I≈
->
ouçut
.
‰ame_øã
Ë/ ((Ë’_Sèts->
‰ame_cou¡î
 >> 1));

963 
	`Ârötf
(
°dout
, " Võw 0 BR (kbô/sË @ %2.2‡Hz : %5.2f\n", 
p_I≈
->
ouçut
.
‰ame_øã
, 
p_Sèts
->
bôøã_v
[0] / 1000.0);

964 
	`Ârötf
(
°dout
, " Võw 1 BR (kbô/sË @ %2.2‡Hz : %5.2f\n", 
p_I≈
->
ouçut
.
‰ame_øã
, 
p_Sèts
->
bôøã_v
[1] / 1000.0);

968 
i
 = 0; i < 5; i++)

970 
p_Sèts
->
bô_˘r_emuœti⁄_¥evíti⁄
 +p_Sèts->
bô_u£_°uffög_bôs
[
i
];

972 #i‡(
MVC_EXTENSION_ENABLE
)

973 i‡–
p_Vid
->
num_of_œyîs
 == 2 )

975 
i
 = 0; i < 5; i++)

977 
p_Sèts
->
bô_˘r_emuœti⁄¥evíti⁄_v
[
p_Vid
->
dpb_œyî_id
] +p_Sèts->
bô_u£_°uffög_bôs
[
i
];

982 
	`Ârötf
(
°dout
, " Bô†tÿavoid SèπcodêEmuœti⁄ : %" 
FORMAT_OFF_T
 " \n", 
p_Sèts
->
bô_˘r_emuœti⁄_¥evíti⁄
);

983 
	`Ârötf
(
°dout
, " Bô†f‹Ö¨amëî së† : %d \n", 
p_Sèts
->
bô_˘r_∑ømëî£ts
);

984 
	`Ârötf
(
°dout
, " Bô†f‹ fûÀ∏d©® : %" 
FORMAT_OFF_T
 " \n\n", 
p_Sèts
->
bô_˘r_fûÀr_d©a
);

986 
p_I≈
->
Vîbo£
)

991 
	`Ârötf
(
°dout
,"-------------------------------------------------------------------------------\n");

994 
	`Ârötf
(
°dout
,"------------------------------------------------------------------------------------------------\n");

997 
	`Ârötf
(
°dout
,"-------------------------------------------------------------------------------------------------------\n");

1000 
	`Ârötf
(
°dout
,"Exô JM %†ícodî vî %†", 
JM
, 
VERSION
);

1001 
	`Ârötf
(
°dout
,"\n");

1004 
	`ªp‹t_°©s
(
p_Vid
, 
p_I≈
, 
p_Sèts
, 
bô_u£
);

1007 
	`ªp‹t_log
(
p_Vid
, 
p_I≈
, 
p_Sèts
);

1009 i‡(
p_I≈
->
Rï‹tFømeSèts
)

1011 i‡((
p_Vid
->
p_log
 = 
	`f›í
("°©_‰ame.d©", "a")Ë=
NULL
)

1013 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Error open file %s \n", "stat_frame.dat.dat");

1018 
	`Ârötf
(
p_Vid
->
p_log
," --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- \n");

1019 
	`f˛o£
(
p_Vid
->
p_log
);

1021 
	`ªp‹t_log_mode
(
p_Vid
, 
p_I≈
, 
p_Sèts
);

1023 
	}
}

1036 
	$öf‹m©i⁄_öô
 ( 
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
SètP¨amëîs
 *
p_Sèts
)

1038 
i
;

1039 c⁄° 
yuv_ty≥s
[4][10] = {"YUV 4:0:0", "YUV 4:2:0", "YUV 4:2:2", "YUV 4:4:4"};

1040 
p_I≈
->
Vîbo£
)

1045 
	`¥ötf
("------------------------------- JM %4.4†%7.7†-------------------------------\n", 
VERSION
, 
EXT_VERSION
);

1048 
	`¥ötf
("--------------------------------------- JM %4.4†%7.7†----------------------------------------\n", 
VERSION
, 
EXT_VERSION
);

1051 
	`¥ötf
("------------------------------------------ JM %4.4†%7.7†------------------------------------------\n", 
VERSION
, 
EXT_VERSION
);

1055 
	`Ârötf
(
°dout
, " I≈uàYUV fûê : %†\n", 
p_I≈
->
öput_fûe1
.
‚ame
);

1056 #i‡(
MVC_EXTENSION_ENABLE
)

1057 if(
p_I≈
->
num_of_võws
==2)

1058 
	`Ârötf
(
°dout
, " I≈uàYUV fûê2 : %†\n", 
p_I≈
->
öput_fûe2
.
‚ame
);

1061 
	`Ârötf
(
°dout
, " OuçuàH.264 bô°ªam : %†\n", 
p_I≈
->
outfûe
);

1062 i‡(
p_Vid
->
p_dec
 != -1)

1063 
	`Ârötf
(
°dout
, " OuçuàYUV fûê : %†\n", 
p_I≈
->
Rec⁄Fûe
);

1064 #i‡(
MVC_EXTENSION_ENABLE
)

1065 if(
p_I≈
->
num_of_võws
==2)

1067 i‡(
p_Vid
->
p_dec2
 != -1)

1068 
	`Ârötf
(
°dout
, " OuçuàYUV fûê2 : %†\n", 
p_I≈
->
Rec⁄Fûe2
);

1071 
	`Ârötf
(
°dout
, " YUV F‹m© : %†\n", &
yuv_ty≥s
[
p_Vid
->
yuv_f‹m©
][0]);

1072 
	`Ârötf
(
°dout
, " Føme†tÿbêícoded : %d\n", 
p_I≈
->
no_‰ames
);

1073 i‡(
p_I≈
->
Vîbo£
 != 0)

1075 
	`Ârötf
(
°dout
, " Fªq. f‹Éncoded bô°ªam : %3.2f\n", 
p_I≈
->
ouçut
.
‰ame_øã
);

1076 
	`Ârötf
(
°dout
, " PicI¡îœ˚ / MbI¡îœ˚ : %d/%d\n", 
p_I≈
->
PicI¡îœ˚
,Ö_I≈->
MbI¡îœ˚
);

1077 
	`Ârötf
(
°dout
, " Tønsf‹m8x8Modê : %d\n", 
p_I≈
->
Tønsf‹m8x8Mode
);

1079 
i
=0; i<3; i++)

1081 
	`Ârötf
(
°dout
," ME Mëri¯f‹ ReföemíàLevñ %1d : %s\n", 
i
, 
Di°‹ti⁄Ty≥
[
p_I≈
->
MEEº‹Mëric
[i]]);

1083 
	`Ârötf
(
°dout
, " ModêDecisi⁄ Mëri¯ : %s\n", 
Di°‹ti⁄Ty≥
[
p_I≈
->
ModeDecisi⁄Mëric
]);

1085 if–
p_I≈
->
OnTheFlyFø˘MCP
 )

1087 
	`Ârötf
(
°dout
," On-the-Êy i¡îpﬁ©i⁄ modê : OTF_L%d\n", 
p_I≈
->
OnTheFlyFø˘MCP
 );

1090  
p_I≈
->
ChromaMEE«bÀ
 )

1093 
	`Ârötf
(
°dout
," Motion Estimation for components : YCbCr\n");

1096 
	`Ârötf
(
°dout
," Motion Estimation for components : Y\n");

1100 
	`Ârötf
(
°dout
, " Imagêf‹m© : %dx%d (%dx%d)\n", 
p_I≈
->
ouçut
.
width
[0],Ö_I≈->ouçut.
height
[0], 
p_Vid
->width,p_Vid->height);

1102 i‡(
p_I≈
->
öåa_upd
)

1103 
	`Ârötf
(
°dout
," ErrorÑobustness : On\n");

1105 
	`Ârötf
(
°dout
," ErrorÑobustness : Off\n");

1106 
	`Ârötf
(
°dout
, " SórchÑ™gê : %d\n", 
p_I≈
->
£¨ch_ønge
[0]);

1107 #i‡(
MVC_EXTENSION_ENABLE
)

1108 i‡–
p_I≈
->
SïVõwI¡îSórch
 )

1110 
	`Ârötf
(
°dout
, " SórchÑ™gê(võw 1Ë : %d\n", 
p_I≈
->
£¨ch_ønge
[1]);

1114 
	`Ârötf
(
°dout
, " TŸÆÇumbî o‡ª„ªn˚† : %d\n", 
p_I≈
->
num_ªf_‰ames_‹g
);

1115 
	`Ârötf
(
°dout
, " Re„ªn˚†f‹ P sli˚† : %d\n", 
p_I≈
->
P_Li°0_ªfs_‹g
[0] ?Ö_I≈->P_Li°0_ªfs_‹g[0] :Ö_I≈->
num_ªf_‰ames_‹g
);

1116 
	`Ârötf
(
°dout
, " References for B slices (L0, L1) : %d, %d\n",

1117 
p_I≈
->
B_Li°0_ªfs_‹g
[0] ?Ö_I≈->B_Li°0_ªfs_‹g[0] :Ö_I≈->
num_ªf_‰ames_‹g
,

1118 
p_I≈
->
B_Li°1_ªfs_‹g
[0] ?Ö_I≈->B_Li°1_ªfs_‹g[0] :Ö_I≈->
num_ªf_‰ames_‹g
);

1120 i‡–
p_Vid
->
num_of_œyîs
 > 1 )

1122 
	`Ârötf
(
°dout
, " Võw 1Ñef†f‹ P sli˚† : %d\n", 
p_I≈
->
P_Li°0_ªfs_‹g
[1] ?Ö_I≈->P_Li°0_ªfs_‹g[1] :Ö_I≈->
num_ªf_‰ames_‹g
);

1123 
	`Ârötf
(
°dout
, " View 1Ñefs for B slices (L0, L1) : %d, %d\n",

1124 
p_I≈
->
B_Li°0_ªfs_‹g
[1] ?Ö_I≈->B_Li°0_ªfs_‹g[1] :Ö_I≈->
num_ªf_‰ames_‹g
,

1125 
p_I≈
->
B_Li°1_ªfs_‹g
[1] ?Ö_I≈->B_Li°1_ªfs_‹g[1] :Ö_I≈->
num_ªf_‰ames_‹g
);

1129 
	`Ârötf
(
°dout
, " SequenceÅype :");

1130 i‡(
p_Sèts
->
NumbîBFømes
 > 0 && 
p_I≈
->
HõørchiˇlCodög
)

1132 
	`Ârötf
(
°dout
, " Hierarchy (QP: I %d, P %d, B %d) \n",

1133 
p_I≈
->
qp
[
I_SLICE
],Ö_I≈->qp[
P_SLICE
],Ö_I≈->qp[
B_SLICE
]);

1135 i‡(
p_Sèts
->
NumbîBFømes
 > 0)

1137 
£qty≥
[80];

1138 
i
,
j
;

1140 
	`°r˝y
 (
£qty≥
,"I");

1142 
j
=0; j < 2; j++)

1144 
i
=0; i < 
p_Sèts
->
NumbîBFømes
; i++)

1146 i‡(
p_I≈
->
BRefPi˘uªs
)

1147 
	`°∫ˇt
(
£qty≥
,"-RB", 
	`imax
(0, (Ë(79 - 
	`°æí
(seqtype))));

1149 
	`°∫ˇt
(
£qty≥
,"-B", 
	`imax
(0, (Ë(79 - 
	`°æí
(seqtype))));

1151 
	`°∫ˇt
(
£qty≥
,"-P", 
	`imax
(0, (Ë(79 - 
	`°æí
(seqtype))));

1153 i‡(
p_I≈
->
BRefPi˘uªs
)

1154 
	`Ârötf
(
°dout
, " %†(QP: I %d, P %d, RB %dË\n", 
£qty≥
, 
p_I≈
->
qp
[
I_SLICE
],Ö_I≈->qp[
P_SLICE
], 
	`iClù3
(0, 51,Ö_I≈->qp[
B_SLICE
] +Ö_I≈->
qpBRSOff£t
));

1156 
	`Ârötf
(
°dout
, " %†(QP: I %d, P %d, B %dË\n", 
£qty≥
, 
p_I≈
->
qp
[
I_SLICE
],Ö_I≈->qp[
P_SLICE
],Ö_I≈->qp[
B_SLICE
]);

1158 i‡(
p_Sèts
->
NumbîBFømes
 =0 && (
p_I≈
->
öåa_≥riod
 =1 ||Ö_I≈->
idr_≥riod
 == 1))

1159 
	`Ârötf
(
°dout
, " IIII (QP: I %dË\n", 
p_I≈
->
qp
[
I_SLICE
]);

1160 i‡(
p_Sèts
->
NumbîBFømes
 =0 && 
p_I≈
->
•_≥riodicôy
 == 0)

1161 
	`Ârötf
(
°dout
, " IPPP (QP: I %d, P %dË\n", 
p_I≈
->
qp
[
I_SLICE
],Ö_I≈->qp[
P_SLICE
]);

1163 
	`Ârötf
(
°dout
, " I-P-P-SP-P (QP: I %d, P %d, SP (%d, %d)Ë\n", 
p_I≈
->
qp
[
I_SLICE
],Ö_I≈->qp[
P_SLICE
],Ö_I≈->qp[
SP_SLICE
],Ö_I≈->
qp•
);

1166 i‡(
p_I≈
->
symbﬁ_mode
 =
CAVLC
)

1167 
	`Ârötf
(
°dout
," Entropy coding method : CAVLC\n");

1169 
	`Ârötf
(
°dout
," Entropy coding method : CABAC\n");

1171 
	`Ârötf
(
°dout
, " Profûe/Levñ IDC : (%d,%d)\n", 
p_I≈
->
ProfûeIDC
,Ö_I≈->
LevñIDC
);

1173 i‡(
p_I≈
->
SórchMode
[0] =
UM_HEX
)

1174 
	`Ârötf
(
°dout
, " Motion Estimation Scheme : HEX\n");

1175 i‡(
p_I≈
->
SórchMode
[0] =
UM_HEX_SIMPLE
)

1176 
	`Ârötf
(
°dout
, " Motion Estimation Scheme : SHEX\n");

1177 i‡(
p_I≈
->
SórchMode
[0] =
EPZS
)

1179 
	`Ârötf
(
°dout
, " Motion Estimation Scheme : EPZS\n");

1180 
	`EPZSOuçutSèts
(
p_I≈
, 
°dout
, 0);

1182 i‡(
p_I≈
->
SórchMode
[0] =
FAST_FULL_SEARCH
)

1183 
	`Ârötf
(
°dout
, " Motion Estimation Scheme : Fast Full Search\n");

1185 
	`Ârötf
(
°dout
, " Motion Estimation Scheme : Full Search\n");

1187 #i‡(
MVC_EXTENSION_ENABLE
)

1188 i‡–
p_I≈
->
SïVõwI¡îSórch
 )

1190 i‡(
p_I≈
->
SórchMode
[1] =
UM_HEX
)

1191 
	`Ârötf
(
°dout
, " Motion Estimation Scheme : HEX\n");

1192 i‡(
p_I≈
->
SórchMode
[1] =
UM_HEX_SIMPLE
)

1193 
	`Ârötf
(
°dout
, " Motion Estimation Scheme : SHEX\n");

1194 i‡(
p_I≈
->
SórchMode
[1] =
EPZS
)

1196 
	`Ârötf
(
°dout
, " Motion Estimation Scheme : EPZS\n");

1197 
	`EPZSOuçutSèts
(
p_I≈
, 
°dout
, 0);

1199 i‡(
p_I≈
->
SórchMode
[1] =
FAST_FULL_SEARCH
)

1200 
	`Ârötf
(
°dout
, " Motion Estimation Scheme : Fast Full Search\n");

1202 
	`Ârötf
(
°dout
, " Motion Estimation Scheme : Full Search\n");

1206 i‡(
p_I≈
->
fuŒ_£¨ch
 == 2)

1207 
	`Ârötf
(
°dout
," SearchÑangeÑestrictions :Çone\n");

1208 i‡(
p_I≈
->
fuŒ_£¨ch
 == 1)

1209 
	`Ârötf
(
°dout
," SearchÑangeÑestrictions : olderÑeference frames\n");

1211 
	`Ârötf
(
°dout
," SearchÑangeÑestrictions : smaller blocksánd olderÑeference frames\n");

1213 i‡(
p_I≈
->
rd›t
)

1214 
	`Ârötf
(
°dout
," RD-optimized mode decision : used\n");

1216 
	`Ârötf
(
°dout
," RD-optimized mode decision :Çot used\n");

1218 
p_I≈
->
∑πôi⁄_mode
)

1220 
PAR_DP_1
:

1221 
	`Ârötf
(
°dout
," Data Partitioning Mode : 1Öartition \n");

1223 
PAR_DP_3
:

1224 
	`Ârötf
(
°dout
," Data Partitioning Mode : 3Öartitions \n");

1227 
	`Ârötf
(
°dout
," Data Partitioning Mode :Çot supported\n");

1231 
p_I≈
->
of_mode
)

1233 
PAR_OF_ANNEXB
:

1234 
	`Ârötf
(
°dout
," Output File Format : H.264/AVC Annex B Byte Stream Format \n");

1236 
PAR_OF_RTP
:

1237 
	`Ârötf
(
°dout
," Output File Format : RTP Packet File Format \n");

1240 
	`Ârötf
(
°dout
," Output File Format :Çot supported\n");

1246 
p_I≈
->
Vîbo£
)

1250 
	`¥ötf
("-------------------------------------------------------------------------------\n");

1251 
	`¥ötf
("\nEncoding. Please Wait.\n\n");

1254 #i‡(
MVC_EXTENSION_ENABLE
)

1255 i‡(
p_I≈
->
num_of_võws
 == 2)

1257 
	`¥ötf
("------------------------------------------------------------------------------------\n");

1258 
	`¥ötf
("Frame View Bit/pic QP SnrY SnrU SnrV Time(ms) MET(ms) Frm/Fld Ref \n");

1259 
	`¥ötf
("------------------------------------------------------------------------------------\n");

1264 
	`¥ötf
("-------------------------------------------------------------------------------\n");

1265 
	`¥ötf
("Frame Bit/pic QP SnrY SnrU SnrV Time(ms) MET(ms) Frm/Fld Ref \n");

1266 
	`¥ötf
("-------------------------------------------------------------------------------\n");

1270 #i‡(
MVC_EXTENSION_ENABLE
)

1271 i‡(
p_I≈
->
num_of_võws
 == 2)

1273 i‡(
p_I≈
->
Di°‹ti⁄
[
SSIM
] == 1)

1275 
	`¥ötf
("----------------------------------------------------------------------------------------------------------------------------------\n");

1276 
	`¥ötf
("Frame View Bit/pic WP QP QL SnrY SnrU SnrV SsimY SsimU SsimV Time(ms) MET(ms) Frm/Fld I D L0 L1 RDP Ref\n");

1277 
	`¥ötf
("----------------------------------------------------------------------------------------------------------------------------------\n");

1281 
	`¥ötf
("---------------------------------------------------------------------------------------------------------\n");

1282 
	`¥ötf
("Frame View Bit/pic WP QP QL SnrY SnrU SnrV Time(ms) MET(ms) Frm/Fld I D L0 L1 RDP Ref\n");

1283 
	`¥ötf
("---------------------------------------------------------------------------------------------------------\n");

1289 i‡(
p_I≈
->
Di°‹ti⁄
[
SSIM
] == 1)

1291 
	`¥ötf
("---------------------------------------------------------------------------------------------------------------------------\n");

1292 
	`¥ötf
("Frame Bit/pic WP QP QL SnrY SnrU SnrV SsimY SsimU SsimV Time(ms) MET(ms) Frm/Fld I D L0 L1 RDP Ref\n");

1293 
	`¥ötf
("---------------------------------------------------------------------------------------------------------------------------\n");

1297 
	`¥ötf
("---------------------------------------------------------------------------------------------------\n");

1298 
	`¥ötf
("Frame Bit/pic WP QP QL SnrY SnrU SnrV Time(ms) MET(ms) Frm/Fld I D L0 L1 RDP Ref\n");

1299 
	`¥ötf
("---------------------------------------------------------------------------------------------------\n");

1304 #i‡(
MVC_EXTENSION_ENABLE
)

1305 i‡(
p_I≈
->
num_of_võws
 == 2)

1307 i‡(
p_I≈
->
Di°‹ti⁄
[
SSIM
] == 1)

1309 
	`¥ötf
("---------------------------------------------------------------------------------------------------------------------------------------\n");

1310 
	`¥ötf
("Frame View Bit/pic NVB WP QP QL SnrY SnrU SnrV SsimY SsimU SsimV Time(ms) MET(ms) Frm/Fld I D L0 L1 RDP Ref\n");

1311 
	`¥ötf
("---------------------------------------------------------------------------------------------------------------------------------------\n");

1315 
	`¥ötf
("---------------------------------------------------------------------------------------------------------------\n");

1316 
	`¥ötf
("Frame View Bit/pic NVB WP QP QL SnrY SnrU SnrV Time(ms) MET(ms) Frm/Fld I D L0 L1 RDP Ref\n");

1317 
	`¥ötf
("---------------------------------------------------------------------------------------------------------------\n");

1323 i‡(
p_I≈
->
Di°‹ti⁄
[
SSIM
] == 1)

1325 
	`¥ötf
("--------------------------------------------------------------------------------------------------------------------------------\n");

1326 
	`¥ötf
("Frame Bit/pic NVB WP QP QL SnrY SnrU SnrV SsimY SsimU SsimV Time(ms) MET(ms) Frm/Fld I D L0 L1 RDP Ref\n");

1327 
	`¥ötf
("--------------------------------------------------------------------------------------------------------------------------------\n");

1331 
	`¥ötf
("--------------------------------------------------------------------------------------------------------\n");

1332 
	`¥ötf
("Frame Bit/pic NVB WP QP QL SnrY SnrU SnrV Time(ms) MET(ms) Frm/Fld I D L0 L1 RDP Ref\n");

1333 
	`¥ötf
("--------------------------------------------------------------------------------------------------------\n");

1338 #i‡(
MVC_EXTENSION_ENABLE
)

1339 i‡(
p_I≈
->
num_of_võws
 == 2)

1341 i‡(
p_I≈
->
Di°‹ti⁄
[
SSIM
] == 1)

1343 
	`¥ötf
("-------------------------------------------------------------------------------------------------------------------------------------------------\n");

1344 
	`¥ötf
("Frame View Bit/pic Filler NVB WP QP QL SnrY SnrU SnrV SsimY SsimU SsimV Time(ms) MET(ms) Frm/Fld I D L0 L1 RDP Ref\n");

1345 
	`¥ötf
("-------------------------------------------------------------------------------------------------------------------------------------------------\n");

1349 
	`¥ötf
("-------------------------------------------------------------------------------------------------------------------------\n");

1350 
	`¥ötf
("Frame View Bit/pic Filler NVB WP QP QL SnrY SnrU SnrV Time(ms) MET(ms) Frm/Fld I D L0 L1 RDP Ref\n");

1351 
	`¥ötf
("-------------------------------------------------------------------------------------------------------------------------\n");

1357 i‡(
p_I≈
->
Di°‹ti⁄
[
SSIM
] == 1)

1359 
	`¥ötf
("------------------------------------------------------------------------------------------------------------------------------------------\n");

1360 
	`¥ötf
("Frame Bit/pic Filler NVB WP QP QL SnrY SnrU SnrV SsimY SsimU SsimV Time(ms) MET(ms) Frm/Fld I D L0 L1 RDP Ref\n");

1361 
	`¥ötf
("------------------------------------------------------------------------------------------------------------------------------------------\n");

1365 
	`¥ötf
("------------------------------------------------------------------------------------------------------------------\n");

1366 
	`¥ötf
("Frame Bit/pic Filler NVB WP QP QL SnrY SnrU SnrV Time(ms) MET(ms) Frm/Fld I D L0 L1 RDP Ref\n");

1367 
	`¥ötf
("------------------------------------------------------------------------------------------------------------------\n");

1372 
	}
}

1380 
	$ªp‹t_log_mode
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
SètP¨amëîs
 *
p_Sèts
)

1382 
FILE
 *
p_°©
;

1383 
i
;

1384 
«me
[40];

1385 #i‚de‡
WIN32


1386 
time_t
 
now
;

1387 
tm
 *
l_time
;

1388 
°rög
[1000];

1390 
timebuf
[128];

1393 i‡((
p_°©
 = 
	`f›í
("log_mode.dat", "r")) == 0)

1395 i‡((
p_°©
 = 
	`f›í
("log_mode.d©", "a")Ë=
NULL
)

1397 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Error open file %s \n", "log_mode.dat");

1398 
	`îr‹
(
îr‹ãxt
, 500);

1402 
	`Ârötf
(
p_°©
, " ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- \n");

1403 
	`Ârötf
(
p_°©
,"| Encoder statistics. This file is generated during firstÉncoding session,Çew sessions will beáppended |\n");

1404 
	`Ârötf
(
p_°©
, " ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- \n");

1405 
	`Ârötf
(
p_°©
, "| ver | Date | Time | Sequence | QP | I4 | I8 | I16 | IC0 | IC1 | IC2 | IC3 | PI4 | PI8 | PI16 | P0 | P1 | P2 | P3 | P1*4*| P1*8*| P2*4*| P2*8*| P3*4*| P3*8*| P8 | P8:4 | P4*4*| P4*8*| P8:5 | P8:6 | P8:7 | BI4 | BI8 | BI16 | B0 | B1 | B2 | B3 | B0*4*| B0*8*| B1*4*| B1*8*| B2*4*| B2*8*| B3*4*| B3*8*| B8 | B8:0 |B80*4*|B80*8*| B8:4 | B4*4*| B4*8*| B8:5 | B8:6 | B8:7 |\n");

1406 
	`Ârötf
(
p_°©
, " ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- \n");

1411 
	`f˛o£
 (
p_°©
);

1412 i‡((
p_°©
 = 
	`f›í
("log_mode.d©", "a")Ë=
NULL
)

1414 
	`¢¥ötf
(
îr‹ãxt
, 
ET_SIZE
, "Error open file %s \n", "log_mode.dat");

1415 
	`îr‹
(
îr‹ãxt
, 500);

1420 
	`Ârötf
(
p_°©
, "|%4s/%s", 
VERSION
, 
EXT_VERSION
);

1422 #ifde‡
WIN32


1423 
	`_°rd©e
–
timebuf
 );

1424 
	`Ârötf
(
p_°©
, "| %1.5†|", 
timebuf
);

1426 
	`_°πime
–
timebuf
);

1427 
	`Ârötf
(
p_°©
, " % 1.5†|", 
timebuf
);

1429 
now
 = 
	`time
 ((
time_t
 *Ë
NULL
);

1430 
	`time
 (&
now
);

1431 
l_time
 = 
	`loˇ…ime
 (&
now
);

1432 
	`°r·ime
 (
°rög
,  såög, "%d-%b-%Y", 
l_time
);

1433 
	`Ârötf
(
p_°©
, "| %1.5†|", 
°rög
 );

1435 
	`°r·ime
 (
°rög
,  såög, "%H:%M:%S", 
l_time
);

1436 
	`Ârötf
(
p_°©
, " %1.5†|", 
°rög
);

1439 
i
=0;i<30;i++)

1440 
«me
[
i
]=
p_I≈
->
öput_fûe1
.
‚ame
[ò+ 
	`imax
(0,(Ë(
	`°æí
(p_Inp->input_file1.fname)- 30))];

1442 
	`Ârötf
(
p_°©
, "%30.30s|", 
«me
);

1443 
	`Ârötf
(
p_°©
, "%3d |", 
p_Vid
->
qp
);

1447 
	`Ârötf
(
p_°©
, " %5" 
FORMAT_OFF_T
 "|", 
p_Sèts
->
mode_u£
[
I_SLICE
][
I4MB
 ]);

1448 
	`Ârötf
(
p_°©
, " %5" 
FORMAT_OFF_T
 "|", 
p_Sèts
->
mode_u£
[
I_SLICE
][
I8MB
 ]);

1449 
	`Ârötf
(
p_°©
, " %5" 
FORMAT_OFF_T
 "|", 
p_Sèts
->
mode_u£
[
I_SLICE
][
I16MB
]);

1452 
	`Ârötf
(
p_°©
, " %5" 
FORMAT_OFF_T
 "|", 
p_Sèts
->
öåa_chroma_mode
[0]);

1453 
	`Ârötf
(
p_°©
, " %5" 
FORMAT_OFF_T
 "|", 
p_Sèts
->
öåa_chroma_mode
[1]);

1454 
	`Ârötf
(
p_°©
, " %5" 
FORMAT_OFF_T
 "|", 
p_Sèts
->
öåa_chroma_mode
[2]);

1455 
	`Ârötf
(
p_°©
, " %5" 
FORMAT_OFF_T
 "|", 
p_Sèts
->
öåa_chroma_mode
[3]);

1458 
	`Ârötf
(
p_°©
, " %5" 
FORMAT_OFF_T
 "|", 
p_Sèts
->
mode_u£
[
P_SLICE
][
I4MB
 ]);

1459 
	`Ârötf
(
p_°©
, " %5" 
FORMAT_OFF_T
 "|", 
p_Sèts
->
mode_u£
[
P_SLICE
][
I8MB
 ]);

1460 
	`Ârötf
(
p_°©
, " %5" 
FORMAT_OFF_T
 "|", 
p_Sèts
->
mode_u£
[
P_SLICE
][
I16MB
]);

1461 
	`Ârötf
(
p_°©
, " %5" 
FORMAT_OFF_T
 "|", 
p_Sèts
->
mode_u£
[
P_SLICE
][0 ]);

1463 
	`Ârötf
(
p_°©
, " %5" 
FORMAT_OFF_T
 "|", 
p_Sèts
->
mode_u£
[
P_SLICE
][1 ]);

1464 
	`Ârötf
(
p_°©
, " %5" 
FORMAT_OFF_T
 "|", 
p_Sèts
->
mode_u£
[
P_SLICE
][2 ]);

1465 
	`Ârötf
(
p_°©
, " %5" 
FORMAT_OFF_T
 "|", 
p_Sèts
->
mode_u£
[
P_SLICE
][3 ]);

1467 
	`Ârötf
(
p_°©
, " %5" 
FORMAT_OFF_T
 "|", 
p_Sèts
->
mode_u£_å™sf‹m
[
P_SLICE
][1][0]);

1468 
	`Ârötf
(
p_°©
, " %5" 
FORMAT_OFF_T
 "|", 
p_Sèts
->
mode_u£_å™sf‹m
[
P_SLICE
][1][1]);

1469 
	`Ârötf
(
p_°©
, " %5" 
FORMAT_OFF_T
 "|", 
p_Sèts
->
mode_u£_å™sf‹m
[
P_SLICE
][2][0]);

1470 
	`Ârötf
(
p_°©
, " %5" 
FORMAT_OFF_T
 "|", 
p_Sèts
->
mode_u£_å™sf‹m
[
P_SLICE
][2][1]);

1471 
	`Ârötf
(
p_°©
, " %5" 
FORMAT_OFF_T
 "|", 
p_Sèts
->
mode_u£_å™sf‹m
[
P_SLICE
][3][0]);

1472 
	`Ârötf
(
p_°©
, " %5" 
FORMAT_OFF_T
 "|", 
p_Sèts
->
mode_u£_å™sf‹m
[
P_SLICE
][3][1]);

1474 
	`Ârötf
(
p_°©
, " %5" 
FORMAT_OFF_T
 "|", 
p_Sèts
->
mode_u£
[
P_SLICE
][
P8x8
 ]);

1475 
	`Ârötf
(
p_°©
, " %5" 
FORMAT_OFF_T
 "|", 
p_Sèts
->
mode_u£
[
P_SLICE
][4 ]);

1476 
	`Ârötf
(
p_°©
, " %5" 
FORMAT_OFF_T
 "|", 
p_Sèts
->
mode_u£_å™sf‹m
[
P_SLICE
][4][0]);

1477 
	`Ârötf
(
p_°©
, " %5" 
FORMAT_OFF_T
 "|", 
p_Sèts
->
mode_u£_å™sf‹m
[
P_SLICE
][4][1]);

1478 
	`Ârötf
(
p_°©
, " %5" 
FORMAT_OFF_T
 "|", 
p_Sèts
->
mode_u£
[
P_SLICE
][5 ]);

1479 
	`Ârötf
(
p_°©
, " %5" 
FORMAT_OFF_T
 "|", 
p_Sèts
->
mode_u£
[
P_SLICE
][6 ]);

1480 
	`Ârötf
(
p_°©
, " %5" 
FORMAT_OFF_T
 "|", 
p_Sèts
->
mode_u£
[
P_SLICE
][7 ]);

1483 
	`Ârötf
(
p_°©
, " %5" 
FORMAT_OFF_T
 "|", 
p_Sèts
->
mode_u£
[
B_SLICE
][
I4MB
 ]);

1484 
	`Ârötf
(
p_°©
, " %5" 
FORMAT_OFF_T
 "|", 
p_Sèts
->
mode_u£
[
B_SLICE
][
I8MB
 ]);

1485 
	`Ârötf
(
p_°©
, " %5" 
FORMAT_OFF_T
 "|", 
p_Sèts
->
mode_u£
[
B_SLICE
][
I16MB
]);

1486 
	`Ârötf
(
p_°©
, " %5" 
FORMAT_OFF_T
 "|", 
p_Sèts
->
mode_u£
[
B_SLICE
][0 ]);

1487 
	`Ârötf
(
p_°©
, " %5" 
FORMAT_OFF_T
 "|", 
p_Sèts
->
mode_u£
[
B_SLICE
][1 ]);

1488 
	`Ârötf
(
p_°©
, " %5" 
FORMAT_OFF_T
 "|", 
p_Sèts
->
mode_u£
[
B_SLICE
][2 ]);

1489 
	`Ârötf
(
p_°©
, " %5" 
FORMAT_OFF_T
 "|", 
p_Sèts
->
mode_u£
[
B_SLICE
][3 ]);

1490 
	`Ârötf
(
p_°©
, " %5" 
FORMAT_OFF_T
 "|", 
p_Sèts
->
mode_u£_å™sf‹m
[
B_SLICE
][0][0]);

1491 
	`Ârötf
(
p_°©
, " %5" 
FORMAT_OFF_T
 "|", 
p_Sèts
->
mode_u£_å™sf‹m
[
B_SLICE
][0][1]);

1492 
	`Ârötf
(
p_°©
, " %5" 
FORMAT_OFF_T
 "|", 
p_Sèts
->
mode_u£_å™sf‹m
[
B_SLICE
][1][0]);

1493 
	`Ârötf
(
p_°©
, " %5" 
FORMAT_OFF_T
 "|", 
p_Sèts
->
mode_u£_å™sf‹m
[
B_SLICE
][1][1]);

1494 
	`Ârötf
(
p_°©
, " %5" 
FORMAT_OFF_T
 "|", 
p_Sèts
->
mode_u£_å™sf‹m
[
B_SLICE
][2][0]);

1495 
	`Ârötf
(
p_°©
, " %5" 
FORMAT_OFF_T
 "|", 
p_Sèts
->
mode_u£_å™sf‹m
[
B_SLICE
][2][1]);

1496 
	`Ârötf
(
p_°©
, " %5" 
FORMAT_OFF_T
 "|", 
p_Sèts
->
mode_u£_å™sf‹m
[
B_SLICE
][3][0]);

1497 
	`Ârötf
(
p_°©
, " %5" 
FORMAT_OFF_T
 "|", 
p_Sèts
->
mode_u£_å™sf‹m
[
B_SLICE
][3][1]);

1499 
	`Ârötf
(
p_°©
, " %5" 
FORMAT_OFF_T
 "|", 
p_Sèts
->
mode_u£
[
B_SLICE
][
P8x8
]);

1500 
	`Ârötf
(
p_°©
, " %d|", (
p_Sèts
->
b8_mode_0_u£
 [
B_SLICE
][0]+p_Stats->b8_mode_0_use [B_SLICE][1]));

1501 
	`Ârötf
(
p_°©
, " %5d|", 
p_Sèts
->
b8_mode_0_u£
 [
B_SLICE
][0]);

1502 
	`Ârötf
(
p_°©
, " %5d|", 
p_Sèts
->
b8_mode_0_u£
 [
B_SLICE
][1]);

1503 
	`Ârötf
(
p_°©
, " %5" 
FORMAT_OFF_T
 "|", 
p_Sèts
->
mode_u£
[
B_SLICE
][4 ]);

1504 
	`Ârötf
(
p_°©
, " %5" 
FORMAT_OFF_T
 "|", 
p_Sèts
->
mode_u£_å™sf‹m
[
B_SLICE
][4][0]);

1505 
	`Ârötf
(
p_°©
, " %5" 
FORMAT_OFF_T
 "|", 
p_Sèts
->
mode_u£_å™sf‹m
[
B_SLICE
][4][1]);

1506 
	`Ârötf
(
p_°©
, " %5" 
FORMAT_OFF_T
 "|", 
p_Sèts
->
mode_u£
[
B_SLICE
][5 ]);

1507 
	`Ârötf
(
p_°©
, " %5" 
FORMAT_OFF_T
 "|", 
p_Sèts
->
mode_u£
[
B_SLICE
][6 ]);

1508 
	`Ârötf
(
p_°©
, " %5" 
FORMAT_OFF_T
 "|", 
p_Sèts
->
mode_u£
[
B_SLICE
][7 ]);

1510 
	`Ârötf
(
p_°©
, "\n");

1511 
	`f˛o£
(
p_°©
);

1512 
	}
}

	@lencod/src/rtp.c

14 #ifde‡
WIN32


15 
	~<Wösock2.h
>

17 
	~<√töë/ö.h
>

20 
	~"globÆ.h
"

21 
	~"πp.h
"

22 
	~"£i.h
"

25 #i‡
TRACE


26 
	#SYMTRACESTRING
(
s
Ë
	`°∫˝y
(
sym
.
åa˚°rög
,s,
TRACESTRING_SIZE
)

	)

28 
	#SYMTRACESTRING
(
s
)

30 

	)

60 
	$Compo£RTPPackë
 (
RTP∑ckë_t
 *
p
)

63 
ãmp32
;

64 
uöt16
 
ãmp16
;

67 
	`as£π
 (
p
->
v
 == 2);

68 
	`as£π
 (
p
->p == 0);

69 
	`as£π
 (
p
->
x
 == 0);

70 
	`as£π
 (
p
->
cc
 == 0);

71 
	`as£π
 (
p
->
m
 == 0 ||Ö->m == 1);

72 
	`as£π
 (
p
->
±
 < 128);

73 
	`as£π
 (
p
->
∑ylﬂd
 !
NULL
);

74 
	`as£π
 (
p
->
∑yÀn
 < 65536 - 40);

75 
	`as£π
 (
p
->
∑ckë
 !
NULL
);

79 
p
->
∑ckë
[0] = (
byã
)

80 –((
p
->
v
 & 0x03) << 6)

81 | ((
p
->p & 0x01) << 5)

82 | ((
p
->
x
 & 0x01) << 4)

83 | ((
p
->
cc
 & 0x0F) << 0) );

85 
p
->
∑ckë
[1] = (
byã
)

86 –((
p
->
m
 & 0x01) << 7)

87 | ((
p
->
±
 & 0x7F) << 0) );

90 
ãmp16
 = 
	`ht⁄s
((
uöt16
)
p
->
£q
);

91 
	`mem˝y
 (&
p
->
∑ckë
[2], &
ãmp16
, 2);

94 
ãmp32
 = 
	`ht⁄l
(
p
->
time°amp
);

95 
	`mem˝y
 (&
p
->
∑ckë
[4], &
ãmp32
, 4);

97 
ãmp32
 = 
	`ht⁄l
(
p
->
s§c
);

98 
	`mem˝y
 (&
p
->
∑ckë
[8], &
ãmp32
, 4);

102 
	`mem˝y
 (&
p
->
∑ckë
[12],Ö->
∑ylﬂd
,Ö->
∑yÀn
);

103 
p
->
∑ckÀn
 =Ö->
∑yÀn
+12;

105 
	}
}

131 
	$WrôeRTPPackë
 (
RTP∑ckë_t
 *
p
, 
FILE
 *
f
)

134 
ötime
 = -1;

136 
	`as£π
 (
f
 !
NULL
);

137 
	`as£π
 (
p
 !
NULL
);

140 i‡(1 !
	`fwrôe
 (&
p
->
∑ckÀn
, 4, 1, 
f
))

142 i‡(1 !
	`fwrôe
 (&
ötime
, 4, 1, 
f
))

144 i‡(1 !
	`fwrôe
 (
p
->
∑ckë
,Ö->
∑ckÀn
, 1, 
f
))

147 
	}
}

173 
	$WrôeRTPNALU
 (
VideoP¨amëîs
 *
p_Vid
, 
NALU_t
 *
n
, 
FILE
 **
f_πp
)

175 
RTP∑ckë_t
 *
p
;

177 
byã
 
fú°_byã
;

179 
	`as£π
 ((*
f_πp
Ë!
NULL
);

180 
	`as£π
 (
n
 !
NULL
);

181 
	`as£π
 (
n
->
Àn
 < 65000);

183 
fú°_byã
 = (
byã
)

184 (
n
->
f‹biddí_bô
 << 7 |

185 
n
->
«l_ª„ªn˚_idc
 << 5 |

186 
n
->
«l_unô_ty≥
 );

189 i‡((
p
 = (
RTP∑ckë_t
 *Ë
	`mÆloc
 ( (RTP∑ckë_t))Ë=
NULL
)

190 
	`no_mem_exô
 ("RTPWriteNALU-1");

191 i‡((
p
->
∑ckë
 = 
	`mÆloc
 (
MAXRTPPACKETSIZE
)Ë=
NULL
)

192 
	`no_mem_exô
 ("RTPWriteNALU-2");

193 i‡((
p
->
∑ylﬂd
 = 
	`mÆloc
 (
MAXRTPPACKETSIZE
)Ë=
NULL
)

194 
	`no_mem_exô
 ("RTPWriteNALU-3");

196 
p
->
v
=2;

197 
p
->p=0;

198 
p
->
x
=0;

199 
p
->
cc
=0;

200 
p
->
m
=(
n
->
°¨tcodïªfix_Àn
==4)&1;

206 
p
->
±
=
H264PAYLOADTYPE
;

207 
p
->
£q
 = 
p_Vid
->
CuºítRTPSequí˚Numbî
++;

208 
p
->
time°amp
 = 
p_Vid
->
CuºítRTPTime°amp
;

209 
p
->
s§c
=
H264SSRC
;

210 
p
->
∑yÀn
 = 1 + 
n
->
Àn
;

212 
p
->
∑ylﬂd
[0] = 
fú°_byã
;

213 
	`mem˝y
 (
p
->
∑ylﬂd
+1, 
n
->
buf
,Ç->
Àn
);

216 i‡(
	`Compo£RTPPackë
 (
p
) < 0)

218 
	`¥ötf
 ("Cannot compose RTPÖacket,Éxit\n");

219 
	`exô
 (-1);

221 i‡(
	`WrôeRTPPackë
 (
p
, *
f_πp
) < 0)

223 
	`¥ötf
 ("C™nŸ wrôê%d byã†o‡RTPÖackëÅÿoutfûe,Éxô\n", 
p
->
∑ckÀn
);

224 
	`exô
 (-1);

226 
	`‰ì
 (
p
->
∑ckë
);

227 
	`‰ì
 (
p
->
∑ylﬂd
);

228 
	`‰ì
 (
p
);

229  (
n
->
Àn
 * 8);

230 
	}
}

250 
	$RTPUpd©eTime°amp
 (
VideoP¨amëîs
 *
p_Vid
, 
å
)

252 
dñè
;

253 
ﬁdå
 = -1;

255 i‡(
ﬁdå
 == -1)

257 
p_Vid
->
CuºítRTPTime°amp
 = 0;

259 
ﬁdå
 = 0;

273 
dñè
 = 
å
 - 
ﬁdå
;

275 i‡(
dñè
 < -10)

276 
dñè
+=256;

278 
p_Vid
->
CuºítRTPTime°amp
 +
dñè
 * 
RTP_TR_TIMESTAMP_MULT
;

279 
ﬁdå
 = 
å
;

280 
	}
}

299 
	$O≥nRTPFûe
 (*
Fûíame
, 
FILE
 **
f_πp
)

301 i‡(((*
f_πp
Ë
	`f›í
 (
Fûíame
, "wb")Ë=
NULL
)

303 
	`¥ötf
 ("F©Æ: c™nŸ o≥¿bô°ªam fûê'%s',Éxô (-1)\n", 
Fûíame
);

304 
	`exô
 (-1);

306 
	}
}

320 
	$Clo£RTPFûe
 (
FILE
 *
f_πp
)

322 
	`f˛o£
(
f_πp
);

323 
	}
}

	@lencod/src/sei.c

15 
	~"globÆ.h
"

16 
	~"memÆloc.h
"

17 
	~"πp.h
"

18 
	~"mbuf„r.h
"

19 
	~"£i.h
"

20 
	~"vlc.h
"

21 
	~"hódî.h
"

23 
InôR™domAc˚ss
 (
SEIP¨amëîs
 *
p_SEI
);

24 
Clo£R™domAc˚ss
 (
SEIP¨amëîs
 *
p_SEI
);

25 
InôT⁄eM≠pög
 (
SEIP¨amëîs
 *
p_SEI
, 
I≈utP¨amëîs
 *
p_I≈
);

26 
Clo£T⁄eM≠pög
 (
SEIP¨amëîs
 *
p_SEI
);

27 
Clo£Buf„rögPîiod
 (
SEIP¨amëîs
 *
p_SEI
);

28 
InôPicTimög
 (
SEIP¨amëîs
 *
p_SEI
);

29 
Clo£PicTimög
 (
SEIP¨amëîs
 *
p_SEI
);

30 
InôDRPMRïëôi⁄
 (
SEIP¨amëîs
 *
p_SEI
);

31 
Clo£DRPMRïëôi⁄
 (
SEIP¨amëîs
 *
p_SEI
);

32 
FöÆizeDRPMRïëôi⁄
 (
VideoP¨amëîs
 *
p_Vid
);

33 
InôS∑ªPi˘uª
 (
SEIP¨amëîs
 *
p_SEI
);

34 
Clo£S∑ªPi˘uª
 (
SEIP¨amëîs
 *
p_SEI
);

35 
FöÆizeS∑ªMBM≠
 (
VideoP¨amëîs
 *
p_Vid
);

36 
InôSub£qCh¨
 (
VideoP¨amëîs
 *
p_Vid
);

37 
CÀ¨Sub£qCh¨Paylﬂd
 (
SEIP¨amëîs
 *
p_SEI
);

38 
Clo£Sub£qCh¨
 (
SEIP¨amëîs
 *
p_SEI
);

39 
InôSub£qLayîInfo
 (
SEIP¨amëîs
 *
p_SEI
);

40 
InôP™SˇnRe˘Info
 (
SEIP¨amëîs
 *
p_SEI
);

41 
Clo£P™SˇnRe˘Info
 (
SEIP¨amëîs
 *
p_SEI
);

42 
InôU£r_d©a_uƒegi°îed
 (
SEIP¨amëîs
 *
p_SEI
);

43 
InôU£r_d©a_ªgi°îed_ôu_t_t35
(
SEIP¨amëîs
 *
p_SEI
);

44 
CÀ¨U£r_d©a_uƒegi°îed
(
SEIP¨amëîs
 *
p_SEI
);

45 
Clo£U£r_d©a_uƒegi°îed
(
SEIP¨amëîs
 *
p_SEI
);

46 
CÀ¨U£r_d©a_ªgi°îed_ôu_t_t35
(
SEIP¨amëîs
 *
p_SEI
);

47 
Clo£U£r_d©a_ªgi°îed_ôu_t_t35
(
SEIP¨amëîs
 *
p_SEI
);

48 
InôPo°FûãrHöts
 (
SEIP¨amëîs
 *
p_SEI
);

49 
CÀ¨Po°FûãrHöts
 (
SEIP¨amëîs
 *
p_SEI
);

50 
Clo£Po°FûãrHöts
 (
SEIP¨amëîs
 *
p_SEI
);

51 
InôFømePackögAº™gemít
(
VideoP¨amëîs
 *
p_Vid
);

52 
Clo£FømePackögAº™gemít
(
SEIP¨amëîs
 *
p_SEI
);

54 
	$öô_£i
(
SEIP¨amëîs
 *
p_SEI
)

56 
p_SEI
->
£iHasTemp‹Æ_ª„ªn˚
=
FALSE
;

57 
p_SEI
->
£iHasClock_time°amp
=
FALSE
;

58 
p_SEI
->
£iHasP™sˇn_ª˘
=
FALSE
;

59 
p_SEI
->
£iHasHrd_pi˘uª
=
FALSE
;

60 
p_SEI
->
£iHasFûÀr_∑ylﬂd
=
FALSE
;

61 
p_SEI
->
£iHasU£r_d©a_ªgi°îed_ôu_t_t35
=
FALSE
;

62 
p_SEI
->
£iHasU£r_d©a_uƒegi°îed
=
FALSE
;

63 
p_SEI
->
£iHasRecovîyPoöt_öfo
=
FALSE
;

64 
p_SEI
->
£iHasRef_pic_buf„r_m™agemít_ª≥tôi⁄
=
FALSE
;

65 
p_SEI
->
£iHasS∑ª_pi˘uª
=
FALSE
;

66 
p_SEI
->
£iHasBuf„rögPîiod_öfo
=
FALSE
;

67 
p_SEI
->
£iHasPicTimög_öfo
=
FALSE
;

68 
p_SEI
->
£iHasS˚√Inf‹m©i⁄
=
FALSE
;

69 
p_SEI
->
£iHasSub£q_öf‹m©i⁄
=
FALSE
;

70 
p_SEI
->
£iHasSub£q_œyî_ch¨a˘îi°ics
=
FALSE
;

71 
p_SEI
->
£iHasSub£q_ch¨a˘îi°ics
=
FALSE
;

72 
p_SEI
->
£iHasT⁄e_m≠pög
=
FALSE
;

73 
p_SEI
->
£iHasPo°FûãrHöts_öfo
=
FALSE
;

74 
p_SEI
->
£iHasDRPMRïëôi⁄_öfo
=
FALSE
;

75 
p_SEI
->
£iHasS∑ªPi˘uª
 = 
FALSE
;

76 
p_SEI
->
£iHasSub£qCh¨
 = 
FALSE
;

77 
p_SEI
->
£iHasSub£qInfo
 = 
FALSE
;

78 
p_SEI
->
£iHasSub£qLayîInfo
 = 
FALSE
;

79 
p_SEI
->
£iHasP™SˇnRe˘Info
 = 
FALSE
;

80 
	}
}

89 
	$InôSEIMesßges
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

91 
SEIP¨amëîs
 *
p_SEI
 = 
p_Vid
->p_SEI;

92 
i
;

93 
i
=0; i<2; i++)

95 
p_SEI
->
£i_mesßge
[
i
].
d©a
 = 
	`mÆloc
(
MAXRTPPAYLOADLEN
);

96 if–
p_SEI
->
£i_mesßge
[
i
].
d©a
 =
NULL
 ) 
	`no_mem_exô
("InitSEIMessages: sei_message[i].data");

97 
p_SEI
->
£i_mesßge
[
i
].
subPackëTy≥
 = 
SEI_PACKET_TYPE
;

98 
	`˛ór_£i_mesßge
(
p_SEI
, 
i
);

102 
p_SEI
->
£iS∑ªPi˘uªPaylﬂd
.
d©a
 = 
NULL
;

103 
	`InôS∑ªPi˘uª
(
p_SEI
);

104 i‡(
p_I≈
->
NumFømesInELSubSeq
 != 0)

106 
	`InôSub£qLayîInfo
(
p_SEI
);

107 
	`InôSub£qCh¨
(
p_Vid
);

109 
	`InôS˚√Inf‹m©i⁄
(
p_SEI
);

111 
	`InôP™SˇnRe˘Info
(
p_SEI
);

113 
	`InôU£r_d©a_uƒegi°îed
(
p_SEI
);

115 
	`InôU£r_d©a_ªgi°îed_ôu_t_t35
(
p_SEI
);

117 
	`InôR™domAc˚ss
(
p_SEI
);

119 
	`InôT⁄eM≠pög
(
p_SEI
, 
p_I≈
);

121 
	`InôPo°FûãrHöts
(
p_SEI
);

123 
	`InôBuf„rögPîiod
(
p_Vid
);

125 
	`InôPicTimög
(
p_SEI
);

127 
	`InôDRPMRïëôi⁄
(
p_SEI
);

129 
	`InôFømePackögAº™gemít
(
p_Vid
);

130 
	}
}

132 
	$Clo£SEIMesßges
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

134 
SEIP¨amëîs
 *
p_SEI
 = 
p_Vid
->p_SEI;

135 
i
;

137 i‡(
p_I≈
->
NumFømesInELSubSeq
 != 0)

138 
	`Clo£Sub£qLayîInfo
();

140 
	`Clo£Sub£qCh¨
(
p_SEI
);

141 
	`Clo£S∑ªPi˘uª
(
p_SEI
);

142 
	`Clo£S˚√Inf‹m©i⁄
(
p_SEI
);

143 
	`Clo£P™SˇnRe˘Info
(
p_SEI
);

144 
	`Clo£U£r_d©a_uƒegi°îed
(
p_SEI
);

145 
	`Clo£U£r_d©a_ªgi°îed_ôu_t_t35
(
p_SEI
);

146 
	`Clo£R™domAc˚ss
(
p_SEI
);

147 
	`Clo£T⁄eM≠pög
(
p_SEI
);

148 
	`Clo£Po°FûãrHöts
(
p_SEI
);

149 
	`Clo£Buf„rögPîiod
(
p_SEI
);

150 
	`Clo£PicTimög
(
p_SEI
);

151 
	`Clo£DRPMRïëôi⁄
(
p_SEI
);

152 
	`Clo£FømePackögAº™gemít
(
p_SEI
);

154 
i
=0; i<
MAX_LAYER_NUMBER
; i++)

156 i‡–
p_SEI
->
£i_mesßge
[
i
].
d©a
 )

157 
	`‰ì
–
p_SEI
->
£i_mesßge
[
i
].
d©a
 );

158 
p_SEI
->
£i_mesßge
[
i
].
d©a
 = 
NULL
;

160 
	}
}

162 
Boﬁón
 
	$HaveAggªg©i⁄SEI
(
VideoP¨amëîs
 *
p_Vid
)

164 
SEIP¨amëîs
 *
p_SEI
 = 
p_Vid
->p_SEI;

165 i‡(
p_SEI
->
£i_mesßge
[
AGGREGATION_SEI
].
avaûabÀ
 && 
p_Vid
->
ty≥
 !
B_SLICE
)

166  
TRUE
;

167 i‡(
p_SEI
->
£iHasSub£qInfo
)

168  
TRUE
;

169 i‡(
p_SEI
->
£iHasSub£qLayîInfo
 && 
p_Vid
->
numbî
 == 0)

170  
TRUE
;

171 i‡(
p_SEI
->
£iHasSub£qCh¨
)

172  
TRUE
;

173 i‡(
p_SEI
->
£iHasS˚√Inf‹m©i⁄
)

174  
TRUE
;

175 i‡(
p_SEI
->
£iHasP™SˇnRe˘Info
)

176  
TRUE
;

177 i‡(
p_SEI
->
£iHasU£r_d©a_uƒegi°îed_öfo
)

178  
TRUE
;

179 i‡(
p_SEI
->
£iHasU£r_d©a_ªgi°îed_ôu_t_t35_öfo
)

180  
TRUE
;

181 i‡(
p_SEI
->
£iHasRecovîyPoöt_öfo
)

182  
TRUE
;

183 i‡(
p_SEI
->
£iHasT⁄e_m≠pög
)

184  
TRUE
;

185 i‡(
p_SEI
->
£iHasPo°FûãrHöts_öfo
)

186  
TRUE
;

187 i‡(
p_SEI
->
£iHasBuf„rögPîiod_öfo
)

188  
TRUE
;

189 i‡(
p_SEI
->
£iHasPicTimög_öfo
)

190  
TRUE
;

191 i‡(
p_SEI
->
£iHasDRPMRïëôi⁄_öfo
)

192  
TRUE
;

194  
FALSE
;

197 
	}
}

219 
	$wrôe_£i_mesßge
(
SEIP¨amëîs
 *
p_SEI
, 
id
, 
byã
* 
∑ylﬂd
, 
∑ylﬂd_size
, 
∑ylﬂd_ty≥
)

221 
off£t
, 
ty≥
, 
size
;

222 
	`as£π
(
∑ylﬂd_ty≥
 >0 &&Öaylﬂd_ty≥ < 
SEI_MAX_ELEMENTS
);

224 
ty≥
 = 
∑ylﬂd_ty≥
;

225 
size
 = 
∑ylﬂd_size
;

226 
off£t
 = 
p_SEI
->
£i_mesßge
[
id
].
∑ylﬂdSize
;

228  
ty≥
 > 254 )

230 
p_SEI
->
£i_mesßge
[
id
].
d©a
[
off£t
++] = 0xFF;

231 
ty≥
 =Åype - 255;

233 
p_SEI
->
£i_mesßge
[
id
].
d©a
[
off£t
++] = (
byã
Ë
ty≥
;

235  
size
 > 254 )

237 
p_SEI
->
£i_mesßge
[
id
].
d©a
[
off£t
++] = 0xFF;

238 
size
 = size - 255;

240 
p_SEI
->
£i_mesßge
[
id
].
d©a
[
off£t
++] = (
byã
Ë
size
;

242 
	`mem˝y
(
p_SEI
->
£i_mesßge
[
id
].
d©a
 + 
off£t
, 
∑ylﬂd
, 
∑ylﬂd_size
);

243 
off£t
 +
∑ylﬂd_size
;

245 
p_SEI
->
£i_mesßge
[
id
].
∑ylﬂdSize
 = 
off£t
;

246 
	}
}

261 
	$föÆize_£i_mesßge
(
SEIP¨amëîs
 *
p_SEI
, 
id
)

263 
off£t
 = 
p_SEI
->
£i_mesßge
[
id
].
∑ylﬂdSize
;

265 
p_SEI
->
£i_mesßge
[
id
].
d©a
[
off£t
] = 0x80;

266 
p_SEI
->
£i_mesßge
[
id
].
∑ylﬂdSize
++;

268 
p_SEI
->
£i_mesßge
[
id
].
avaûabÀ
 = 
TRUE
;

269 
	}
}

285 
	$˛ór_£i_mesßge
(
SEIP¨amëîs
 *
p_SEI
, 
id
)

287 
	`mem£t
–
p_SEI
->
£i_mesßge
[
id
].
d©a
, 0, 
MAXRTPPAYLOADLEN
);

288 
p_SEI
->
£i_mesßge
[
id
].
∑ylﬂdSize
 = 0;

289 
p_SEI
->
£i_mesßge
[
id
].
avaûabÀ
 = 
FALSE
;

290 
	}
}

304 
	$AµídTmpbôs2Buf
–
Bô°ªam
* 
de°
, Bô°ªam* 
sour˚
 )

306 
i
, 
j
;

307 
byã
 
mask
;

308 
bôs_ö_œ°_byã
;

311 
i
=0; i<
sour˚
->
byã_pos
; i++)

313 
mask
 = 0x80;

314 
j
=0; j<8; j++)

316 
de°
->
byã_buf
 <<= 1;

317 i‡(
sour˚
->
°ªamBuf„r
[
i
] & 
mask
)

318 
de°
->
byã_buf
 |= 1;

319 
de°
->
bôs_to_go
--;

320 
mask
 >>= 1;

321 i‡(
de°
->
bôs_to_go
==0)

323 
de°
->
bôs_to_go
 = 8;

324 
de°
->
°ªamBuf„r
[de°->
byã_pos
++]=de°->
byã_buf
;

325 
de°
->
byã_buf
 = 0;

330 
bôs_ö_œ°_byã
 = 8-
sour˚
->
bôs_to_go
;

331 i‡–
bôs_ö_œ°_byã
 > 0 )

333 
mask
 = (
byã
Ë(1 << (
bôs_ö_œ°_byã
-1));

334 
j
=0; j<
bôs_ö_œ°_byã
; j++)

336 
de°
->
byã_buf
 <<= 1;

337 i‡(
sour˚
->
byã_buf
 & 
mask
)

338 
de°
->
byã_buf
 |= 1;

339 
de°
->
bôs_to_go
--;

340 
mask
 >>= 1;

341 i‡(
de°
->
bôs_to_go
==0)

343 
de°
->
bôs_to_go
 = 8;

344 
de°
->
°ªamBuf„r
[de°->
byã_pos
++]=de°->
byã_buf
;

345 
de°
->
byã_buf
 = 0;

349 
	}
}

369 
	$InôS∑ªPi˘uª
(
SEIP¨amëîs
 *
p_SEI
)

371 i‡–
p_SEI
->
£iS∑ªPi˘uªPaylﬂd
.
d©a
 !
NULL
 )

372 
	`Clo£S∑ªPi˘uª
(
p_SEI
);

374 
p_SEI
->
£iS∑ªPi˘uªPaylﬂd
.
d©a
 = 
	`mÆloc
–(
Bô°ªam
) );

375 i‡–
p_SEI
->
£iS∑ªPi˘uªPaylﬂd
.
d©a
 =
NULL
 ) 
	`no_mem_exô
("InitSparePicture: seiSparePicturePayload.data");

376 
p_SEI
->
£iS∑ªPi˘uªPaylﬂd
.
d©a
->
°ªamBuf„r
 = 
	`mÆloc
(
MAXRTPPAYLOADLEN
);

377 i‡–
p_SEI
->
£iS∑ªPi˘uªPaylﬂd
.
d©a
->
°ªamBuf„r
 =
NULL
 ) 
	`no_mem_exô
("InitSparePicture: seiSparePicturePayload.data->streamBuffer");

378 
	`mem£t
–
p_SEI
->
£iS∑ªPi˘uªPaylﬂd
.
d©a
->
°ªamBuf„r
, 0, 
MAXRTPPAYLOADLEN
);

379 
p_SEI
->
£iS∑ªPi˘uªPaylﬂd
.
num_•¨e_pics
 = 0;

380 
p_SEI
->
£iS∑ªPi˘uªPaylﬂd
.
èrgë_‰ame_num
 = 0;

382 
p_SEI
->
£iS∑ªPi˘uªPaylﬂd
.
d©a
->
bôs_to_go
 = 8;

383 
p_SEI
->
£iS∑ªPi˘uªPaylﬂd
.
d©a
->
byã_pos
 = 0;

384 
p_SEI
->
£iS∑ªPi˘uªPaylﬂd
.
d©a
->
byã_buf
 = 0;

385 
	}
}

393 
	$Clo£S∑ªPi˘uª
(
SEIP¨amëîs
 *
p_SEI
)

395 i‡(
p_SEI
->
£iS∑ªPi˘uªPaylﬂd
.
d©a
->
°ªamBuf„r
)

396 
	`‰ì
(
p_SEI
->
£iS∑ªPi˘uªPaylﬂd
.
d©a
->
°ªamBuf„r
);

397 
p_SEI
->
£iS∑ªPi˘uªPaylﬂd
.
d©a
->
°ªamBuf„r
 = 
NULL
;

398 i‡(
p_SEI
->
£iS∑ªPi˘uªPaylﬂd
.
d©a
)

399 
	`‰ì
(
p_SEI
->
£iS∑ªPi˘uªPaylﬂd
.
d©a
);

400 
p_SEI
->
£iS∑ªPi˘uªPaylﬂd
.
d©a
 = 
NULL
;

401 
p_SEI
->
£iS∑ªPi˘uªPaylﬂd
.
num_•¨e_pics
 = 0;

402 
p_SEI
->
£iS∑ªPi˘uªPaylﬂd
.
èrgë_‰ame_num
 = 0;

403 
	}
}

416 
	$CÆcuœãS∑ªPi˘uª
()

580 
	}
}

599 
	$Compo£S∑ªPi˘uªMesßge
(
SEIP¨amëîs
 *
p_SEI
, 
dñè_•¨e_‰ame_num
, 
ªf_¨ó_ödiˇt‹
, 
Bô°ªam
 *
tmpBô°ªam
)

601 
Bô°ªam
 *
bô°ªam
 = 
p_SEI
->
£iS∑ªPi˘uªPaylﬂd
.
d©a
;

602 
Sy¡axEÀmít
 
sym
;

604 
sym
.
ty≥
 = 
SE_HEADER
;

605 
sym
.
m≠pög
 = 
ue_löfo
;

607 
sym
.
vÆue1
 = 
dñè_•¨e_‰ame_num
;

608 
	`wrôeSy¡axEÀmít2Buf_UVLC
(&
sym
, 
bô°ªam
);

609 
sym
.
vÆue1
 = 
ªf_¨ó_ödiˇt‹
;

610 
	`wrôeSy¡axEÀmít2Buf_UVLC
(&
sym
, 
bô°ªam
);

612 
	`AµídTmpbôs2Buf
–
bô°ªam
, 
tmpBô°ªam
 );

613 
	}
}

631 
Boﬁón
 
	$Com¥essS∑ªMBM≠
(
VideoP¨amëîs
 *
p_Vid
, **
m≠_•
, 
Bô°ªam
 *
bô°ªam
)

633 
j
, 
k
;

634 
noc
, 
bô0
, 
bôc
;

635 
Sy¡axEÀmít
 
sym
;

636 
x
, 
y
, 
À·
, 
right
, 
bŸtom
, 
t›
, 
dúe˘x
, 
dúe˘y
;

639 
size_uncom¥es£d
 = (
p_Vid
->
height
 >> 4Ë* (p_Vid->
width
 >> 4);

640 
size_com¥es£d
 = 0;

641 
Boﬁón
 
ªt
;

644 
sym
.
ty≥
 = 
SE_HEADER
;

645 
sym
.
m≠pög
 = 
ue_löfo
;

646 
noc
 = 0;

647 
bô0
 = 0;

648 
bôc
 = 
bô0
;

651 
x
 = ( (
p_Vid
->
width
 >> 4) - 1 ) / 2;

652 
y
 = ( (
p_Vid
->
height
 >> 4) - 1 ) / 2;

653 
À·
 = 
right
 = 
x
;

654 
t›
 = 
bŸtom
 = 
y
;

655 
dúe˘x
 = 0;

656 
dúe˘y
 = 1;

657 
j
=0; j<
p_Vid
->
height
 >> 4; j++)

658 
k
=0; k<
p_Vid
->
width
 >> 4; k++)

661 i‡–
m≠_•
[
y
][
x
] =
bôc
 ) 
noc
++;

664 
sym
.
vÆue1
 = 
noc
;

665 
size_com¥es£d
 +
	`wrôeSy¡axEÀmít2Buf_UVLC
(&
sym
, 
bô°ªam
);

666 
noc
=0;

669 i‡–
dúe˘x
 =-1 && 
dúe˘y
 == 0 )

671 i‡(
x
 > 
À·
) x--;

672 i‡(
x
 == 0)

674 
y
 = 
bŸtom
 + 1;

675 
bŸtom
++;

676 
dúe˘x
 = 1;

677 
dúe˘y
 = 0;

679 i‡(
x
 =
À·
)

681 
x
--;

682 
À·
--;

683 
dúe˘x
 = 0;

684 
dúe˘y
 = 1;

687 i‡–
dúe˘x
 =1 && 
dúe˘y
 == 0 )

689 i‡(
x
 < 
right
) x++;

690 i‡(
x
 =(
p_Vid
->
width
 >> 4) - 1)

692 
y
 = 
t›
 - 1;

693 
t›
--;

694 
dúe˘x
 = -1;

695 
dúe˘y
 = 0;

697 i‡(
x
 =
right
)

699 
x
++;

700 
right
++;

701 
dúe˘x
 = 0;

702 
dúe˘y
 = -1;

705 i‡–
dúe˘x
 =0 && 
dúe˘y
 == -1 )

707 i‡–
y
 > 
t›
) y--;

708 i‡(
y
 == 0)

710 
x
 = 
À·
 - 1;

711 
À·
--;

712 
dúe˘x
 = 0;

713 
dúe˘y
 = 1;

715 i‡(
y
 =
t›
)

717 
y
--;

718 
t›
--;

719 
dúe˘x
 = -1;

720 
dúe˘y
 = 0;

723 i‡–
dúe˘x
 =0 && 
dúe˘y
 == 1 )

725 i‡(
y
 < 
bŸtom
) y++;

726 i‡(
y
 =(
p_Vid
->
height
 >> 4) - 1)

728 
x
 = 
right
+1;

729 
right
++;

730 
dúe˘x
 = 0;

731 
dúe˘y
 = -1;

733 i‡(
y
 =
bŸtom
)

735 
y
++;

736 
bŸtom
++;

737 
dúe˘x
 = 1;

738 
dúe˘y
 = 0;

742 i‡(
noc
!=0)

744 
sym
.
vÆue1
 = 
noc
;

745 
size_com¥es£d
 +
	`wrôeSy¡axEÀmít2Buf_UVLC
(&
sym
, 
bô°ªam
);

748 
ªt
 = (
size_com¥es£d
<
size_uncom¥es£d
? 
TRUE
 : 
FALSE
);

749 i‡–!
ªt
 )

752 
bô°ªam
->
byã_buf
 = 0;

753 
bô°ªam
->
bôs_to_go
 = 8;

754 
bô°ªam
->
byã_pos
 = 0;

755 
j
=0; j<
p_Vid
->
height
 >> 4; j++)

757 
k
=0; k<
p_Vid
->
width
 >> 4; k++)

759 
bô°ªam
->
byã_buf
 <<= 1;

760 i‡(
m≠_•
[
j
][
k
]Ë
bô°ªam
->
byã_buf
 |= 1;

761 
bô°ªam
->
bôs_to_go
--;

762 i‡(
bô°ªam
->
bôs_to_go
==0)

764 
bô°ªam
->
bôs_to_go
 = 8;

765 
bô°ªam
->
°ªamBuf„r
[bô°ªam->
byã_pos
++]=bô°ªam->
byã_buf
;

766 
bô°ªam
->
byã_buf
 = 0;

772  
ªt
;

773 
	}
}

790 
	$FöÆizeS∑ªMBM≠
(
VideoP¨amëîs
 *
p_Vid
)

792 
SEIP¨amëîs
 *
p_SEI
 = 
p_Vid
->p_SEI;

793 
CuºFømeNum
 = 
p_Vid
->
numbî
 % 
MAX_FN
;

794 
dñè_‰ame_num
;

795 
Sy¡axEÀmít
 
sym
;

796 
Bô°ªam
 *
de°
, *
sour˚
;

798 
sym
.
ty≥
 = 
SE_HEADER
;

799 
sym
.
m≠pög
 = 
ue_löfo
;

801 
sour˚
 = 
p_SEI
->
£iS∑ªPi˘uªPaylﬂd
.
d©a
;

802 
de°
 = 
	`mÆloc
((
Bô°ªam
));

803 i‡–
de°
 =
NULL
 ) 
	`no_mem_exô
("FinalizeSpareMBMap: dest");

804 
de°
->
°ªamBuf„r
 = 
	`mÆloc
(
MAXRTPPAYLOADLEN
);

805 i‡–
de°
->
°ªamBuf„r
 =
NULL
 ) 
	`no_mem_exô
("FinalizeSpareMBMap: dest->streamBuffer");

806 
de°
->
bôs_to_go
 = 8;

807 
de°
->
byã_pos
 = 0;

808 
de°
->
byã_buf
 = 0;

809 
	`mem£t
–
de°
->
°ªamBuf„r
, 0, 
MAXRTPPAYLOADLEN
);

812 
dñè_‰ame_num
 = 
CuºFømeNum
 - 
p_SEI
->
£iS∑ªPi˘uªPaylﬂd
.
èrgë_‰ame_num
;

813 i‡–
dñè_‰ame_num
 < 0 ) dñè_‰ame_num +
MAX_FN
;

814 
sym
.
vÆue1
 = 
dñè_‰ame_num
;

815 
	`wrôeSy¡axEÀmít2Buf_UVLC
(&
sym
, 
de°
);

818 
sym
.
vÆue1
 = 
p_SEI
->
£iS∑ªPi˘uªPaylﬂd
.
num_•¨e_pics
 - 1;

819 
	`wrôeSy¡axEÀmít2Buf_UVLC
(&
sym
, 
de°
);

822 
	`AµídTmpbôs2Buf
–
de°
, 
sour˚
);

825 i‡–
de°
->
bôs_to_go
 != 8 )

827 (
de°
->
byã_buf
) <<= 1;

828 
de°
->
byã_buf
 |= 1;

829 
de°
->
bôs_to_go
--;

830 i‡–
de°
->
bôs_to_go
 !0 ) (de°->
byã_buf
) <<= (dest->bits_to_go);

831 
de°
->
bôs_to_go
 = 8;

832 
de°
->
°ªamBuf„r
[de°->
byã_pos
++]=de°->
byã_buf
;

833 
de°
->
byã_buf
 = 0;

835 
p_SEI
->
£iS∑ªPi˘uªPaylﬂd
.
∑ylﬂdSize
 = 
de°
->
byã_pos
;

838 
p_SEI
->
£iS∑ªPi˘uªPaylﬂd
.
d©a
 = 
de°
;

839 
	`‰ì
–
sour˚
->
°ªamBuf„r
 );

840 
	`‰ì
–
sour˚
 );

841 
	}
}

860 
	$InôSub£qInfo
(
SEIP¨amëîs
 *
p_SEI
, 
cuºLayî
)

862 
uöt16
 
id
 = 0;

864 
p_SEI
->
£iHasSub£qInfo
 = 
TRUE
;

865 
p_SEI
->
£iSub£qInfo
[
cuºLayî
].
sub£q_œyî_num
 = currLayer;

866 
p_SEI
->
£iSub£qInfo
[
cuºLayî
].
sub£q_id
 = 
id
++;

867 
p_SEI
->
£iSub£qInfo
[
cuºLayî
].
œ°_pi˘uª_Êag
 = 0;

868 
p_SEI
->
£iSub£qInfo
[
cuºLayî
].
°‹ed_‰ame_˙t
 = () -1;

869 
p_SEI
->
£iSub£qInfo
[
cuºLayî
].
∑ylﬂdSize
 = 0;

871 
p_SEI
->
£iSub£qInfo
[
cuºLayî
].
d©a
 = 
	`mÆloc
–(
Bô°ªam
) );

872 i‡–
p_SEI
->
£iSub£qInfo
[
cuºLayî
].
d©a
 =
NULL
 ) 
	`no_mem_exô
("InitSubseqInfo:Ö_SEI->seiSubseqInfo[currLayer].data");

873 
p_SEI
->
£iSub£qInfo
[
cuºLayî
].
d©a
->
°ªamBuf„r
 = 
	`mÆloc
–
MAXRTPPAYLOADLEN
 );

874 i‡–
p_SEI
->
£iSub£qInfo
[
cuºLayî
].
d©a
->
°ªamBuf„r
 =
NULL
 ) 
	`no_mem_exô
("InitSubseqInfo:Ö_SEI->seiSubseqInfo[currLayer].data->streamBuffer");

875 
p_SEI
->
£iSub£qInfo
[
cuºLayî
].
d©a
->
bôs_to_go
 = 8;

876 
p_SEI
->
£iSub£qInfo
[
cuºLayî
].
d©a
->
byã_pos
 = 0;

877 
p_SEI
->
£iSub£qInfo
[
cuºLayî
].
d©a
->
byã_buf
 = 0;

878 
	`mem£t
–
p_SEI
->
£iSub£qInfo
[
cuºLayî
].
d©a
->
°ªamBuf„r
, 0, 
MAXRTPPAYLOADLEN
 );

879 
	}
}

887 
	$Upd©eSub£qInfo
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
cuºLayî
)

889 
SEIP¨amëîs
 *
p_SEI
 = 
p_Vid
->p_SEI;

890 i‡(
p_Vid
->
ty≥
 !
B_SLICE
)

892 
p_SEI
->
£iSub£qInfo
[
cuºLayî
].
°‹ed_‰ame_˙t
 ++;

893 
p_SEI
->
£iSub£qInfo
[
cuºLayî
].
°‹ed_‰ame_˙t
 =Ö_SEI->£iSub£qInfo[cuºLayî].°‹ed_‰ame_˙à% 
MAX_FN
;

896 i‡–
cuºLayî
 == 0 )

898 i‡–
p_Vid
->
numbî
 =
p_I≈
->
no_‰ames
 - 1 )

899 
p_SEI
->
£iSub£qInfo
[
cuºLayî
].
œ°_pi˘uª_Êag
 = 1;

901 
p_SEI
->
£iSub£qInfo
[
cuºLayî
].
œ°_pi˘uª_Êag
 = 0;

903 i‡–
cuºLayî
 == 1 )

905 i‡–(((
p_Vid
->
cuº_‰m_idx
 -Ö_Vid->
œ°_idr_code_‹dî
Ë% (
p_I≈
->
NumFømesInELSubSeq
 + 1Ë=0Ë&& (p_I≈->
NumbîBFømes
 != 0) && ((p_Vid->curr_frm_idx -Ö_Vid->last_idr_code_order) > 0)) ||

906 (((
p_Vid
->
cuº_‰m_idx
 -Ö_Vid->
œ°_idr_code_‹dî
Ë% (
p_I≈
->
NumFømesInELSubSeq
 + 1Ë=p_I≈->NumFømesInELSubSeqË&& (p_I≈->
NumbîBFømes
==0))

908 
p_SEI
->
£iSub£qInfo
[
cuºLayî
].
œ°_pi˘uª_Êag
 = 1;

910 
p_SEI
->
£iSub£qInfo
[
cuºLayî
].
œ°_pi˘uª_Êag
 = 0;

912 
	}
}

920 
	$FöÆizeSub£qInfo
(
SEIP¨amëîs
 *
p_SEI
, 
cuºLayî
)

922 
Sy¡axEÀmít
 
sym
;

923 
Bô°ªam
 *
de°
 = 
p_SEI
->
£iSub£qInfo
[
cuºLayî
].
d©a
;

925 
sym
.
ty≥
 = 
SE_HEADER
;

926 
sym
.
m≠pög
 = 
ue_löfo
;

928 
sym
.
vÆue1
 = 
p_SEI
->
£iSub£qInfo
[
cuºLayî
].
sub£q_œyî_num
;

929 
	`wrôeSy¡axEÀmít2Buf_UVLC
(&
sym
, 
de°
);

930 
sym
.
vÆue1
 = 
p_SEI
->
£iSub£qInfo
[
cuºLayî
].
sub£q_id
;

931 
	`wrôeSy¡axEÀmít2Buf_UVLC
(&
sym
, 
de°
);

932 
sym
.
bô∑âîn
 = 
p_SEI
->
£iSub£qInfo
[
cuºLayî
].
œ°_pi˘uª_Êag
;

933 
sym
.
Àn
 = 1;

934 
	`wrôeSy¡axEÀmít2Buf_Fixed
(&
sym
, 
de°
);

935 
sym
.
vÆue1
 = 
p_SEI
->
£iSub£qInfo
[
cuºLayî
].
°‹ed_‰ame_˙t
;

936 
	`wrôeSy¡axEÀmít2Buf_UVLC
(&
sym
, 
de°
);

939 i‡–
de°
->
bôs_to_go
 != 8 )

941 (
de°
->
byã_buf
) <<= 1;

942 
de°
->
byã_buf
 |= 1;

943 
de°
->
bôs_to_go
--;

944 i‡–
de°
->
bôs_to_go
 !0 ) (de°->
byã_buf
) <<= (dest->bits_to_go);

945 
de°
->
bôs_to_go
 = 8;

946 
de°
->
°ªamBuf„r
[de°->
byã_pos
++]=de°->
byã_buf
;

947 
de°
->
byã_buf
 = 0;

949 
p_SEI
->
£iSub£qInfo
[
cuºLayî
].
∑ylﬂdSize
 = 
de°
->
byã_pos
;

952 
	}
}

960 
	$CÀ¨Sub£qInfoPaylﬂd
(
SEIP¨amëîs
 *
p_SEI
, 
cuºLayî
)

962 
p_SEI
->
£iSub£qInfo
[
cuºLayî
].
d©a
->
bôs_to_go
 = 8;

963 
p_SEI
->
£iSub£qInfo
[
cuºLayî
].
d©a
->
byã_pos
 = 0;

964 
p_SEI
->
£iSub£qInfo
[
cuºLayî
].
d©a
->
byã_buf
 = 0;

965 
	`mem£t
–
p_SEI
->
£iSub£qInfo
[
cuºLayî
].
d©a
->
°ªamBuf„r
, 0, 
MAXRTPPAYLOADLEN
 );

966 
p_SEI
->
£iSub£qInfo
[
cuºLayî
].
∑ylﬂdSize
 = 0;

967 
	}
}

975 
	$Clo£Sub£qInfo
(
SEIP¨amëîs
 *
p_SEI
, 
cuºLayî
)

977 
p_SEI
->
£iSub£qInfo
[
cuºLayî
].
°‹ed_‰ame_˙t
 = () -1;

978 
p_SEI
->
£iSub£qInfo
[
cuºLayî
].
∑ylﬂdSize
 = 0;

980 
	`‰ì
–
p_SEI
->
£iSub£qInfo
[
cuºLayî
].
d©a
->
°ªamBuf„r
 );

981 
	`‰ì
–
p_SEI
->
£iSub£qInfo
[
cuºLayî
].
d©a
 );

982 
	}
}

1000 
	$InôSub£qLayîInfo
(
SEIP¨amëîs
 *
p_SEI
)

1002 
i
;

1003 
p_SEI
->
£iHasSub£qLayîInfo
 = 
TRUE
;

1004 
p_SEI
->
£iSub£qLayîInfo
.
œyî_numbî
 = 0;

1005 
i
=0; i<
MAX_LAYER_NUMBER
; i++)

1007 
p_SEI
->
£iSub£qLayîInfo
.
bô_øã
[
i
] = 0;

1008 
p_SEI
->
£iSub£qLayîInfo
.
‰ame_øã
[
i
] = 0;

1009 
p_SEI
->
£iSub£qLayîInfo
.
œyî_numbî
++;

1011 
	}
}

1019 
	$Clo£Sub£qLayîInfo
()

1021 
	}
}

1029 
	$FöÆizeSub£qLayîInfo
(
SEIP¨amëîs
 *
p_SEI
)

1031 
i
, 
pos
;

1032 
pos
 = 0;

1033 
p_SEI
->
£iSub£qLayîInfo
.
∑ylﬂdSize
 = 0;

1034 
i
=0; i<
p_SEI
->
£iSub£qLayîInfo
.
œyî_numbî
; i++)

1036 *((
uöt16
*)&(
p_SEI
->
£iSub£qLayîInfo
.
d©a
[
pos
])Ëp_SEI->£iSub£qLayîInfo.
bô_øã
[
i
];

1037 
pos
 += 2;

1038 *((
uöt16
*)&(
p_SEI
->
£iSub£qLayîInfo
.
d©a
[
pos
])Ëp_SEI->£iSub£qLayîInfo.
‰ame_øã
[
i
];

1039 
pos
 += 2;

1040 
p_SEI
->
£iSub£qLayîInfo
.
∑ylﬂdSize
 += 4;

1042 
	}
}

1054 
	$InôSub£qCh¨
(
VideoP¨amëîs
 *
p_Vid
)

1056 
SEIP¨amëîs
 *
p_SEI
 = 
p_Vid
->p_SEI;

1057 
p_SEI
->
£iSub£qCh¨
.
d©a
 = 
	`mÆloc
–(
Bô°ªam
) );

1058 if–
p_SEI
->
£iSub£qCh¨
.
d©a
 =
NULL
 ) 
	`no_mem_exô
("InitSubseqChar:Ö_SEI->seiSubseqChar.data");

1059 
p_SEI
->
£iSub£qCh¨
.
d©a
->
°ªamBuf„r
 = 
	`mÆloc
(
MAXRTPPAYLOADLEN
);

1060 if–
p_SEI
->
£iSub£qCh¨
.
d©a
->
°ªamBuf„r
 =
NULL
 ) 
	`no_mem_exô
("InitSubseqChar:Ö_SEI->seiSubseqChar.data->streamBuffer");

1061 
	`CÀ¨Sub£qCh¨Paylﬂd
(
p_SEI
);

1063 
p_SEI
->
£iSub£qCh¨
.
sub£q_œyî_num
 = 
p_Vid
->
œyî
;

1064 
p_SEI
->
£iSub£qCh¨
.
sub£q_id
 =Ö_SEI->
£iSub£qInfo
[
p_Vid
->
œyî
].subseq_id;

1065 
p_SEI
->
£iSub£qCh¨
.
duøti⁄_Êag
 = 0;

1066 
p_SEI
->
£iSub£qCh¨
.
avîage_øã_Êag
 = 0;

1067 
p_SEI
->
£iSub£qCh¨
.
num_ª„ªn˚d_sub£qs
 = 0;

1068 
	}
}

1070 
	$CÀ¨Sub£qCh¨Paylﬂd
(
SEIP¨amëîs
 *
p_SEI
)

1072 
	`mem£t
–
p_SEI
->
£iSub£qCh¨
.
d©a
->
°ªamBuf„r
, 0, 
MAXRTPPAYLOADLEN
);

1073 
p_SEI
->
£iSub£qCh¨
.
d©a
->
bôs_to_go
 = 8;

1074 
p_SEI
->
£iSub£qCh¨
.
d©a
->
byã_pos
 = 0;

1075 
p_SEI
->
£iSub£qCh¨
.
d©a
->
byã_buf
 = 0;

1076 
p_SEI
->
£iSub£qCh¨
.
∑ylﬂdSize
 = 0;

1078 
p_SEI
->
£iHasSub£qCh¨
 = 
FALSE
;

1079 
	}
}

1081 
	$Upd©eSub£qCh¨
(
VideoP¨amëîs
 *
p_Vid
)

1083 
SEIP¨amëîs
 *
p_SEI
 = 
p_Vid
->p_SEI;

1085 
p_SEI
->
£iSub£qCh¨
.
sub£q_œyî_num
 = 
p_Vid
->
œyî
;

1086 
p_SEI
->
£iSub£qCh¨
.
sub£q_id
 =Ö_SEI->
£iSub£qInfo
[
p_Vid
->
œyî
].subseq_id;

1087 
p_SEI
->
£iSub£qCh¨
.
duøti⁄_Êag
 = 0;

1088 
p_SEI
->
£iSub£qCh¨
.
avîage_øã_Êag
 = 0;

1089 
p_SEI
->
£iSub£qCh¨
.
avîage_bô_øã
 = 100;

1090 
p_SEI
->
£iSub£qCh¨
.
avîage_‰ame_øã
 = 30;

1091 
p_SEI
->
£iSub£qCh¨
.
num_ª„ªn˚d_sub£qs
 = 0;

1092 
p_SEI
->
£iSub£qCh¨
.
ªf_sub£q_œyî_num
[0] = 1;

1093 
p_SEI
->
£iSub£qCh¨
.
ªf_sub£q_id
[0] = 2;

1094 
p_SEI
->
£iSub£qCh¨
.
ªf_sub£q_œyî_num
[1] = 3;

1095 
p_SEI
->
£iSub£qCh¨
.
ªf_sub£q_id
[1] = 4;

1097 
p_SEI
->
£iHasSub£qCh¨
 = 
TRUE
;

1098 
	}
}

1100 
	$FöÆizeSub£qCh¨
(
SEIP¨amëîs
 *
p_SEI
)

1102 
i
;

1103 
Sy¡axEÀmít
 
sym
;

1104 
Bô°ªam
 *
de°
 = 
p_SEI
->
£iSub£qCh¨
.
d©a
;

1106 
sym
.
ty≥
 = 
SE_HEADER
;

1107 
sym
.
m≠pög
 = 
ue_löfo
;

1109 
sym
.
vÆue1
 = 
p_SEI
->
£iSub£qCh¨
.
sub£q_œyî_num
;

1110 
	`wrôeSy¡axEÀmít2Buf_UVLC
(&
sym
, 
de°
);

1111 
sym
.
vÆue1
 = 
p_SEI
->
£iSub£qCh¨
.
sub£q_id
;

1112 
	`wrôeSy¡axEÀmít2Buf_UVLC
(&
sym
, 
de°
);

1113 
sym
.
bô∑âîn
 = 
p_SEI
->
£iSub£qCh¨
.
duøti⁄_Êag
;

1114 
sym
.
Àn
 = 1;

1115 
	`wrôeSy¡axEÀmít2Buf_Fixed
(&
sym
, 
de°
);

1116 i‡–
p_SEI
->
£iSub£qCh¨
.
duøti⁄_Êag
 )

1118 
sym
.
bô∑âîn
 = 
p_SEI
->
£iSub£qCh¨
.
sub£q_duøti⁄
;

1119 
sym
.
Àn
 = 32;

1120 
	`wrôeSy¡axEÀmít2Buf_Fixed
(&
sym
, 
de°
);

1122 
sym
.
bô∑âîn
 = 
p_SEI
->
£iSub£qCh¨
.
avîage_øã_Êag
;

1123 
sym
.
Àn
 = 1;

1124 
	`wrôeSy¡axEÀmít2Buf_Fixed
(&
sym
, 
de°
);

1125 i‡–
p_SEI
->
£iSub£qCh¨
.
avîage_øã_Êag
 )

1127 
sym
.
bô∑âîn
 = 
p_SEI
->
£iSub£qCh¨
.
avîage_bô_øã
;

1128 
sym
.
Àn
 = 16;

1129 
	`wrôeSy¡axEÀmít2Buf_Fixed
(&
sym
, 
de°
);

1130 
sym
.
bô∑âîn
 = 
p_SEI
->
£iSub£qCh¨
.
avîage_‰ame_øã
;

1131 
sym
.
Àn
 = 16;

1132 
	`wrôeSy¡axEÀmít2Buf_Fixed
(&
sym
, 
de°
);

1134 
sym
.
vÆue1
 = 
p_SEI
->
£iSub£qCh¨
.
num_ª„ªn˚d_sub£qs
;

1135 
	`wrôeSy¡axEÀmít2Buf_UVLC
(&
sym
, 
de°
);

1136 
i
=0; i<
p_SEI
->
£iSub£qCh¨
.
num_ª„ªn˚d_sub£qs
; i++)

1138 
sym
.
vÆue1
 = 
p_SEI
->
£iSub£qCh¨
.
ªf_sub£q_œyî_num
[
i
];

1139 
	`wrôeSy¡axEÀmít2Buf_UVLC
(&
sym
, 
de°
);

1140 
sym
.
vÆue1
 = 
p_SEI
->
£iSub£qCh¨
.
ªf_sub£q_id
[
i
];

1141 
	`wrôeSy¡axEÀmít2Buf_UVLC
(&
sym
, 
de°
);

1145 i‡–
de°
->
bôs_to_go
 != 8 )

1147 (
de°
->
byã_buf
) <<= 1;

1148 
de°
->
byã_buf
 |= 1;

1149 
de°
->
bôs_to_go
--;

1150 i‡–
de°
->
bôs_to_go
 !0 ) (de°->
byã_buf
) <<= (dest->bits_to_go);

1151 
de°
->
bôs_to_go
 = 8;

1152 
de°
->
°ªamBuf„r
[de°->
byã_pos
++]=de°->
byã_buf
;

1153 
de°
->
byã_buf
 = 0;

1155 
p_SEI
->
£iSub£qCh¨
.
∑ylﬂdSize
 = 
de°
->
byã_pos
;

1156 
	}
}

1158 
	$Clo£Sub£qCh¨
(
SEIP¨amëîs
 *
p_SEI
)

1160 i‡(
p_SEI
->
£iSub£qCh¨
.
d©a
)

1162 
	`‰ì
(
p_SEI
->
£iSub£qCh¨
.
d©a
->
°ªamBuf„r
);

1163 
	`‰ì
(
p_SEI
->
£iSub£qCh¨
.
d©a
);

1165 
p_SEI
->
£iSub£qCh¨
.
d©a
 = 
NULL
;

1166 
	}
}

1179 
	$InôS˚√Inf‹m©i⁄
(
SEIP¨amëîs
 *
p_SEI
)

1181 
p_SEI
->
£iHasS˚√Inf‹m©i⁄
 = 
TRUE
;

1183 
p_SEI
->
£iS˚√Inf‹m©i⁄
.
s˚√_id
 = 0;

1184 
p_SEI
->
£iS˚√Inf‹m©i⁄
.
s˚√_å™sôi⁄_ty≥
 = 0;

1185 
p_SEI
->
£iS˚√Inf‹m©i⁄
.
£c⁄d_s˚√_id
 = -1;

1187 
p_SEI
->
£iS˚√Inf‹m©i⁄
.
d©a
 = 
	`mÆloc
–(
Bô°ªam
) );

1188 if(
p_SEI
-> 
£iS˚√Inf‹m©i⁄
.
d©a
 =
NULL
 ) 
	`no_mem_exô
("InitSceneInformation: seiSceneInformation.data");

1189 
p_SEI
->
£iS˚√Inf‹m©i⁄
.
d©a
->
°ªamBuf„r
 = 
	`mÆloc
–
MAXRTPPAYLOADLEN
 );

1190 if–
p_SEI
->
£iS˚√Inf‹m©i⁄
.
d©a
->
°ªamBuf„r
 =
NULL
 ) 
	`no_mem_exô
("InitSceneInformation: seiSceneInformation.data->streamBuffer");

1191 
p_SEI
->
£iS˚√Inf‹m©i⁄
.
d©a
->
bôs_to_go
 = 8;

1192 
p_SEI
->
£iS˚√Inf‹m©i⁄
.
d©a
->
byã_pos
 = 0;

1193 
p_SEI
->
£iS˚√Inf‹m©i⁄
.
d©a
->
byã_buf
 = 0;

1194 
	`mem£t
–
p_SEI
->
£iS˚√Inf‹m©i⁄
.
d©a
->
°ªamBuf„r
, 0, 
MAXRTPPAYLOADLEN
 );

1195 
	}
}

1197 
	$Clo£S˚√Inf‹m©i⁄
(
SEIP¨amëîs
 *
p_SEI
)

1199 i‡(
p_SEI
->
£iS˚√Inf‹m©i⁄
.
d©a
)

1201 
	`‰ì
(
p_SEI
->
£iS˚√Inf‹m©i⁄
.
d©a
->
°ªamBuf„r
);

1202 
	`‰ì
(
p_SEI
->
£iS˚√Inf‹m©i⁄
.
d©a
);

1204 
p_SEI
->
£iS˚√Inf‹m©i⁄
.
d©a
 = 
NULL
;

1205 
	}
}

1207 
	$FöÆizeS˚√Inf‹m©i⁄
(
SEIP¨amëîs
 *
p_SEI
)

1209 
Sy¡axEÀmít
 
sym
;

1210 
Bô°ªam
 *
de°
 = 
p_SEI
->
£iS˚√Inf‹m©i⁄
.
d©a
;

1212 
sym
.
ty≥
 = 
SE_HEADER
;

1213 
sym
.
m≠pög
 = 
ue_löfo
;

1215 
sym
.
bô∑âîn
 = 
p_SEI
->
£iS˚√Inf‹m©i⁄
.
s˚√_id
;

1216 
sym
.
Àn
 = 8;

1217 
	`wrôeSy¡axEÀmít2Buf_Fixed
(&
sym
, 
de°
);

1219 
sym
.
vÆue1
 = 
p_SEI
->
£iS˚√Inf‹m©i⁄
.
s˚√_å™sôi⁄_ty≥
;

1220 
	`wrôeSy¡axEÀmít2Buf_UVLC
(&
sym
, 
de°
);

1222 if(
p_SEI
->
£iS˚√Inf‹m©i⁄
.
s˚√_å™sôi⁄_ty≥
 > 3)

1224 
sym
.
bô∑âîn
 = 
p_SEI
->
£iS˚√Inf‹m©i⁄
.
£c⁄d_s˚√_id
;

1225 
sym
.
Àn
 = 8;

1226 
	`wrôeSy¡axEÀmít2Buf_Fixed
(&
sym
, 
de°
);

1230 i‡–
de°
->
bôs_to_go
 != 8 )

1232 (
de°
->
byã_buf
) <<= 1;

1233 
de°
->
byã_buf
 |= 1;

1234 
de°
->
bôs_to_go
--;

1235 i‡–
de°
->
bôs_to_go
 !0 ) (de°->
byã_buf
) <<= (dest->bits_to_go);

1236 
de°
->
bôs_to_go
 = 8;

1237 
de°
->
°ªamBuf„r
[de°->
byã_pos
++]=de°->
byã_buf
;

1238 
de°
->
byã_buf
 = 0;

1240 
p_SEI
->
£iS˚√Inf‹m©i⁄
.
∑ylﬂdSize
 = 
de°
->
byã_pos
;

1241 
	}
}

1246 
	$Upd©eS˚√Inf‹m©i⁄
(
SEIP¨amëîs
 *
p_SEI
, 
Boﬁón
 
HasS˚√Inf‹m©i⁄
, 
s˚√ID
, 
s˚√TønsTy≥
, 
£c⁄dS˚√ID
)

1248 
p_SEI
->
£iHasS˚√Inf‹m©i⁄
 = 
HasS˚√Inf‹m©i⁄
;

1250 
	`as£π
 (
s˚√ID
 < 256);

1251 
p_SEI
->
£iS˚√Inf‹m©i⁄
.
s˚√_id
 = 
s˚√ID
;

1253 
	`as£π
 (
s˚√TønsTy≥
 <= 6 );

1254 
p_SEI
->
£iS˚√Inf‹m©i⁄
.
s˚√_å™sôi⁄_ty≥
 = 
s˚√TønsTy≥
;

1256 if(
s˚√TønsTy≥
 > 3)

1258 
	`as£π
 (
£c⁄dS˚√ID
 < 256);

1259 
p_SEI
->
£iS˚√Inf‹m©i⁄
.
£c⁄d_s˚√_id
 = 
£c⁄dS˚√ID
;

1261 
	}
}

1276 
	$InôP™SˇnRe˘Info
(
SEIP¨amëîs
 *
p_SEI
)

1278 
p_SEI
->
£iP™SˇnRe˘Info
.
d©a
 = 
	`mÆloc
–(
Bô°ªam
) );

1279 if–
p_SEI
->
£iP™SˇnRe˘Info
.
d©a
 =
NULL
 ) 
	`no_mem_exô
("InitPanScanRectInfo:Ö_SEI->seiPanScanRectInfo.data");

1280 
p_SEI
->
£iP™SˇnRe˘Info
.
d©a
->
°ªamBuf„r
 = 
	`mÆloc
(
MAXRTPPAYLOADLEN
);

1281 if–
p_SEI
->
£iP™SˇnRe˘Info
.
d©a
->
°ªamBuf„r
 =
NULL
 ) 
	`no_mem_exô
("InitPanScanRectInfo:Ö_SEI->seiPanScanRectInfo.data->streamBuffer");

1282 
	`CÀ¨P™SˇnRe˘InfoPaylﬂd
(
p_SEI
);

1284 
p_SEI
->
£iP™SˇnRe˘Info
.
∑n_sˇn_ª˘_id
 = 0;

1285 
p_SEI
->
£iP™SˇnRe˘Info
.
∑n_sˇn_ª˘_ˇn˚l_Êag
 = 0;

1286 
p_SEI
->
£iP™SˇnRe˘Info
.
∑n_sˇn_˙t_möus1
 = 0;

1287 
	`mem£t
–
p_SEI
->
£iP™SˇnRe˘Info
.
∑n_sˇn_ª˘_À·_off£t
, 0, 3 *  ( ) );

1288 
	`mem£t
–
p_SEI
->
£iP™SˇnRe˘Info
.
∑n_sˇn_ª˘_right_off£t
, 0, 3 *  ( ) );

1289 
	`mem£t
–
p_SEI
->
£iP™SˇnRe˘Info
.
∑n_sˇn_ª˘_t›_off£t
, 0, 3 *  ( ) );

1290 
	`mem£t
–
p_SEI
->
£iP™SˇnRe˘Info
.
∑n_sˇn_ª˘_bŸtom_off£t
, 0, 3 *  ( ) );

1291 
p_SEI
->
£iP™SˇnRe˘Info
.
∑c_sˇn_ª˘_ª≥tôi⁄_≥riod
 = 0;

1292 
	}
}

1295 
	$CÀ¨P™SˇnRe˘InfoPaylﬂd
(
SEIP¨amëîs
 *
p_SEI
)

1297 
	`mem£t
–
p_SEI
->
£iP™SˇnRe˘Info
.
d©a
->
°ªamBuf„r
, 0, 
MAXRTPPAYLOADLEN
);

1298 
p_SEI
->
£iP™SˇnRe˘Info
.
d©a
->
bôs_to_go
 = 8;

1299 
p_SEI
->
£iP™SˇnRe˘Info
.
d©a
->
byã_pos
 = 0;

1300 
p_SEI
->
£iP™SˇnRe˘Info
.
d©a
->
byã_buf
 = 0;

1301 
p_SEI
->
£iP™SˇnRe˘Info
.
∑ylﬂdSize
 = 0;

1303 
p_SEI
->
£iHasP™SˇnRe˘Info
 = 
FALSE
;

1304 
	}
}

1306 
	$Upd©eP™SˇnRe˘Info
–
VideoP¨amëîs
 *
p_Vid
 )

1308 
SEIP¨amëîs
 *
p_SEI
 = 
p_Vid
->p_SEI;

1311 
p_SEI
->
£iP™SˇnRe˘Info
.
∑n_sˇn_ª˘_id
 = 0;

1312 
p_SEI
->
£iP™SˇnRe˘Info
.
∑n_sˇn_ª˘_ˇn˚l_Êag
 = 0;

1313 
p_SEI
->
£iP™SˇnRe˘Info
.
∑n_sˇn_˙t_möus1
 = 0;

1314 
p_SEI
->
£iP™SˇnRe˘Info
.
∑n_sˇn_ª˘_À·_off£t
[0] = 0;

1315 
p_SEI
->
£iP™SˇnRe˘Info
.
∑n_sˇn_ª˘_right_off£t
[0] = 160;

1316 
p_SEI
->
£iP™SˇnRe˘Info
.
∑n_sˇn_ª˘_t›_off£t
[0] = 0;

1317 
p_SEI
->
£iP™SˇnRe˘Info
.
∑n_sˇn_ª˘_bŸtom_off£t
[0] = 160;

1318 
p_SEI
->
£iP™SˇnRe˘Info
.
∑c_sˇn_ª˘_ª≥tôi⁄_≥riod
 = 1;

1321 
p_SEI
->
£iHasP™SˇnRe˘Info
 = 
TRUE
;

1322 
	}
}

1324 
	$FöÆizeP™SˇnRe˘Info
(
SEIP¨amëîs
 *
p_SEI
)

1326 
i
;

1327 
Bô°ªam
 *
bô°ªam
 = 
p_SEI
->
£iP™SˇnRe˘Info
.
d©a
;

1329 
	`wrôe_ue_v
–"SEI:Ö™_sˇn_ª˘_id", 
p_SEI
->
£iP™SˇnRe˘Info
.
∑n_sˇn_ª˘_id
, 
bô°ªam
 );

1330 
	`wrôe_u_1
–"SEI:Ö™_sˇn_ª˘_ˇn˚l_Êag", 
p_SEI
->
£iP™SˇnRe˘Info
.
∑n_sˇn_ª˘_ˇn˚l_Êag
, 
bô°ªam
 );

1331 i‡–!(
p_SEI
->
£iP™SˇnRe˘Info
.
∑n_sˇn_ª˘_ˇn˚l_Êag
) )

1333 
	`wrôe_ue_v
–"SEI:Ö™_sˇn_˙t_möus1", 
p_SEI
->
£iP™SˇnRe˘Info
.
∑n_sˇn_˙t_möus1
, 
bô°ªam
 );

1334  
i
 = 0; i <
p_SEI
->
£iP™SˇnRe˘Info
.
∑n_sˇn_˙t_möus1
; i++ )

1336 
	`wrôe_£_v
–"SEI:Ö™_sˇn_ª˘_À·_off£t[X]", 
p_SEI
->
£iP™SˇnRe˘Info
.
∑n_sˇn_ª˘_À·_off£t
[
i
], 
bô°ªam
 );

1337 
	`wrôe_£_v
–"SEI:Ö™_sˇn_ª˘_right_off£t[X]", 
p_SEI
->
£iP™SˇnRe˘Info
.
∑n_sˇn_ª˘_right_off£t
[
i
], 
bô°ªam
 );

1338 
	`wrôe_£_v
–"SEI:Ö™_sˇn_ª˘_t›_off£t[X]", 
p_SEI
->
£iP™SˇnRe˘Info
.
∑n_sˇn_ª˘_t›_off£t
[
i
], 
bô°ªam
 );

1339 
	`wrôe_£_v
–"SEI:Ö™_sˇn_ª˘_bŸtom_off£t[X]", 
p_SEI
->
£iP™SˇnRe˘Info
.
∑n_sˇn_ª˘_bŸtom_off£t
[
i
], 
bô°ªam
 );

1341 
	`wrôe_ue_v
–"SEI:Öac_sˇn_ª˘_ª≥tôi⁄_≥riod", 
p_SEI
->
£iP™SˇnRe˘Info
.
∑c_sˇn_ª˘_ª≥tôi⁄_≥riod
, 
bô°ªam
 );

1345 i‡–
bô°ªam
->
bôs_to_go
 != 8 )

1347 (
bô°ªam
->
byã_buf
) <<= 1;

1348 
bô°ªam
->
byã_buf
 |= 1;

1349 
bô°ªam
->
bôs_to_go
--;

1350 i‡–
bô°ªam
->
bôs_to_go
 != 0 )

1351 (
bô°ªam
->
byã_buf
Ë<<(bô°ªam->
bôs_to_go
);

1352 
bô°ªam
->
bôs_to_go
 = 8;

1353 
bô°ªam
->
°ªamBuf„r
[bô°ªam->
byã_pos
++]=bô°ªam->
byã_buf
;

1354 
bô°ªam
->
byã_buf
 = 0;

1356 
p_SEI
->
£iP™SˇnRe˘Info
.
∑ylﬂdSize
 = 
bô°ªam
->
byã_pos
;

1357 
	}
}

1360 
	$Clo£P™SˇnRe˘Info
(
SEIP¨amëîs
 *
p_SEI
)

1362 i‡(
p_SEI
->
£iP™SˇnRe˘Info
.
d©a
)

1364 
	`‰ì
(
p_SEI
->
£iP™SˇnRe˘Info
.
d©a
->
°ªamBuf„r
);

1365 
	`‰ì
(
p_SEI
->
£iP™SˇnRe˘Info
.
d©a
);

1367 
p_SEI
->
£iP™SˇnRe˘Info
.
d©a
 = 
NULL
;

1368 
	}
}

1379 
	$InôU£r_d©a_uƒegi°îed
(
SEIP¨amëîs
 *
p_SEI
)

1382 
p_SEI
->
£iU£r_d©a_uƒegi°îed
.
d©a
 = 
	`mÆloc
–(
Bô°ªam
) );

1383 if–
p_SEI
->
£iU£r_d©a_uƒegi°îed
.
d©a
 =
NULL
 ) 
	`no_mem_exô
("InitUser_data_unregistered:Ö_SEI->seiUser_data_unregistered.data");

1384 
p_SEI
->
£iU£r_d©a_uƒegi°îed
.
d©a
->
°ªamBuf„r
 = 
	`mÆloc
(
MAXRTPPAYLOADLEN
);

1385 if–
p_SEI
->
£iU£r_d©a_uƒegi°îed
.
d©a
->
°ªamBuf„r
 =
NULL
 ) 
	`no_mem_exô
("InitUser_data_unregistered:Ö_SEI->seiUser_data_unregistered.data->streamBuffer");

1386 
p_SEI
->
£iU£r_d©a_uƒegi°îed
.
byã
 = 
	`mÆloc
(
MAXRTPPAYLOADLEN
);

1387 if–
p_SEI
->
£iU£r_d©a_uƒegi°îed
.
byã
 =
NULL
 ) 
	`no_mem_exô
("InitUser_data_unregistered:Ö_SEI->seiUser_data_unregistered.byte");

1388 
	`CÀ¨U£r_d©a_uƒegi°îed
(
p_SEI
);

1390 
	}
}

1393 
	$CÀ¨U£r_d©a_uƒegi°îed
(
SEIP¨amëîs
 *
p_SEI
)

1395 
	`mem£t
–
p_SEI
->
£iU£r_d©a_uƒegi°îed
.
d©a
->
°ªamBuf„r
, 0, 
MAXRTPPAYLOADLEN
);

1396 
p_SEI
->
£iU£r_d©a_uƒegi°îed
.
d©a
->
bôs_to_go
 = 8;

1397 
p_SEI
->
£iU£r_d©a_uƒegi°îed
.
d©a
->
byã_pos
 = 0;

1398 
p_SEI
->
£iU£r_d©a_uƒegi°îed
.
d©a
->
byã_buf
 = 0;

1399 
p_SEI
->
£iU£r_d©a_uƒegi°îed
.
∑ylﬂdSize
 = 0;

1401 
	`mem£t
–
p_SEI
->
£iU£r_d©a_uƒegi°îed
.
byã
, 0, 
MAXRTPPAYLOADLEN
);

1402 
p_SEI
->
£iU£r_d©a_uƒegi°îed
.
tŸÆ_byã
 = 0;

1404 
p_SEI
->
£iHasU£r_d©a_uƒegi°îed_öfo
 = 
FALSE
;

1405 
	}
}

1407 
	$Upd©eU£r_d©a_uƒegi°îed
(
SEIP¨amëîs
 *
p_SEI
)

1409 
i
, 
ãmp_d©a
;

1410 
tŸÆ_byã
;

1413 
tŸÆ_byã
 = 7;

1414 
i
 = 0; i < 
tŸÆ_byã
; i++)

1416 
ãmp_d©a
 = 
i
 * 4;

1417 
p_SEI
->
£iU£r_d©a_uƒegi°îed
.
byã
[
i
] = (Ë
	`iClù3
(0, 255, 
ãmp_d©a
);

1419 
p_SEI
->
£iU£r_d©a_uƒegi°îed
.
tŸÆ_byã
 =Åotal_byte;

1420 
	}
}

1422 
	$FöÆizeU£r_d©a_uƒegi°îed
(
SEIP¨amëîs
 *
p_SEI
)

1424 
i
;

1425 
Sy¡axEÀmít
 
sym
;

1426 
Bô°ªam
 *
de°
 = 
p_SEI
->
£iU£r_d©a_uƒegi°îed
.
d©a
;

1428 
sym
.
ty≥
 = 
SE_HEADER
;

1429 
sym
.
m≠pög
 = 
ue_löfo
;

1432  
i
 = 0; i < 
p_SEI
->
£iU£r_d©a_uƒegi°îed
.
tŸÆ_byã
; i++)

1434 
sym
.
bô∑âîn
 = 
p_SEI
->
£iU£r_d©a_uƒegi°îed
.
byã
[
i
];

1435 
sym
.
Àn
 = 8;

1436 
	`wrôeSy¡axEÀmít2Buf_Fixed
(&
sym
, 
de°
);

1437 #ifde‡
PRINT_USER_DATA_UNREGISTERED_INFO


1438 
	`¥ötf
("Uƒeg d©®∑ylﬂd_byã = %d\n", 
p_SEI
->
£iU£r_d©a_uƒegi°îed
.
byã
[
i
]);

1441 #ifde‡
PRINT_USER_DATA_UNREGISTERED_INFO


1442 #unde‡
PRINT_USER_DATA_UNREGISTERED_INFO


1445 i‡–
de°
->
bôs_to_go
 != 8 )

1447 (
de°
->
byã_buf
) <<= 1;

1448 
de°
->
byã_buf
 |= 1;

1449 
de°
->
bôs_to_go
--;

1450 i‡–
de°
->
bôs_to_go
 !0 ) (de°->
byã_buf
) <<= (dest->bits_to_go);

1451 
de°
->
bôs_to_go
 = 8;

1452 
de°
->
°ªamBuf„r
[de°->
byã_pos
++]=de°->
byã_buf
;

1453 
de°
->
byã_buf
 = 0;

1455 
p_SEI
->
£iU£r_d©a_uƒegi°îed
.
∑ylﬂdSize
 = 
de°
->
byã_pos
;

1456 
	}
}

1458 
	$Clo£U£r_d©a_uƒegi°îed
(
SEIP¨amëîs
 *
p_SEI
)

1460 i‡(
p_SEI
->
£iU£r_d©a_uƒegi°îed
.
d©a
)

1462 
	`‰ì
(
p_SEI
->
£iU£r_d©a_uƒegi°îed
.
d©a
->
°ªamBuf„r
);

1463 
	`‰ì
(
p_SEI
->
£iU£r_d©a_uƒegi°îed
.
d©a
);

1465 
p_SEI
->
£iU£r_d©a_uƒegi°îed
.
d©a
 = 
NULL
;

1466 if(
p_SEI
->
£iU£r_d©a_uƒegi°îed
.
byã
)

1468 
	`‰ì
(
p_SEI
->
£iU£r_d©a_uƒegi°îed
.
byã
);

1470 
	}
}

1482 
	$InôU£r_d©a_ªgi°îed_ôu_t_t35
(
SEIP¨amëîs
 *
p_SEI
)

1485 
p_SEI
->
£iU£r_d©a_ªgi°îed_ôu_t_t35
.
d©a
 = 
	`mÆloc
–(
Bô°ªam
) );

1486 if–
p_SEI
->
£iU£r_d©a_ªgi°îed_ôu_t_t35
.
d©a
 =
NULL
 ) 
	`no_mem_exô
("InitUser_data_unregistered:Ö_SEI->seiUser_data_registered_itu_t_t35.data");

1487 
p_SEI
->
£iU£r_d©a_ªgi°îed_ôu_t_t35
.
d©a
->
°ªamBuf„r
 = 
	`mÆloc
(
MAXRTPPAYLOADLEN
);

1488 if–
p_SEI
->
£iU£r_d©a_ªgi°îed_ôu_t_t35
.
d©a
->
°ªamBuf„r
 =
NULL
 ) 
	`no_mem_exô
("InitUser_data_unregistered:Ö_SEI->seiUser_data_registered_itu_t_t35.data->streamBuffer");

1489 
p_SEI
->
£iU£r_d©a_ªgi°îed_ôu_t_t35
.
byã
 = 
	`mÆloc
(
MAXRTPPAYLOADLEN
);

1490 if–
p_SEI
->
£iU£r_d©a_ªgi°îed_ôu_t_t35
.
d©a
 =
NULL
 ) 
	`no_mem_exô
("InitUser_data_unregistered:Ö_SEI->seiUser_data_registered_itu_t_t35.byte");

1491 
	`CÀ¨U£r_d©a_ªgi°îed_ôu_t_t35
(
p_SEI
);

1493 
	}
}

1496 
	$CÀ¨U£r_d©a_ªgi°îed_ôu_t_t35
(
SEIP¨amëîs
 *
p_SEI
)

1498 
	`mem£t
–
p_SEI
->
£iU£r_d©a_ªgi°îed_ôu_t_t35
.
d©a
->
°ªamBuf„r
, 0, 
MAXRTPPAYLOADLEN
);

1499 
p_SEI
->
£iU£r_d©a_ªgi°îed_ôu_t_t35
.
d©a
->
bôs_to_go
 = 8;

1500 
p_SEI
->
£iU£r_d©a_ªgi°îed_ôu_t_t35
.
d©a
->
byã_pos
 = 0;

1501 
p_SEI
->
£iU£r_d©a_ªgi°îed_ôu_t_t35
.
d©a
->
byã_buf
 = 0;

1502 
p_SEI
->
£iU£r_d©a_ªgi°îed_ôu_t_t35
.
∑ylﬂdSize
 = 0;

1504 
	`mem£t
–
p_SEI
->
£iU£r_d©a_ªgi°îed_ôu_t_t35
.
byã
, 0, 
MAXRTPPAYLOADLEN
);

1505 
p_SEI
->
£iU£r_d©a_ªgi°îed_ôu_t_t35
.
tŸÆ_byã
 = 0;

1506 
p_SEI
->
£iU£r_d©a_ªgi°îed_ôu_t_t35
.
ôu_t_t35_cou¡ry_code
 = 0;

1507 
p_SEI
->
£iU£r_d©a_ªgi°îed_ôu_t_t35
.
ôu_t_t35_cou¡ry_code_exãnsi⁄_byã
 = 0;

1509 
p_SEI
->
£iHasU£r_d©a_ªgi°îed_ôu_t_t35_öfo
 = 
FALSE
;

1510 
	}
}

1512 
	$Upd©eU£r_d©a_ªgi°îed_ôu_t_t35
(
SEIP¨amëîs
 *
p_SEI
)

1514 
i
, 
ãmp_d©a
;

1515 
tŸÆ_byã
;

1516 
cou¡ry_code
 = 82;

1518 if(
cou¡ry_code
 < 0xFF)

1520 
p_SEI
->
£iU£r_d©a_ªgi°îed_ôu_t_t35
.
ôu_t_t35_cou¡ry_code
 = 
cou¡ry_code
;

1524 
p_SEI
->
£iU£r_d©a_ªgi°îed_ôu_t_t35
.
ôu_t_t35_cou¡ry_code
 = 0xFF;

1525 
p_SEI
->
£iU£r_d©a_ªgi°îed_ôu_t_t35
.
ôu_t_t35_cou¡ry_code_exãnsi⁄_byã
 = 
cou¡ry_code
 - 0xFF;

1528 
tŸÆ_byã
 = 7;

1529 
i
 = 0; i < 
tŸÆ_byã
; i++)

1531 
ãmp_d©a
 = 
i
 * 3;

1532 
p_SEI
->
£iU£r_d©a_ªgi°îed_ôu_t_t35
.
byã
[
i
] = (Ë
	`iClù3
(0, 255, 
ãmp_d©a
);

1534 
p_SEI
->
£iU£r_d©a_ªgi°îed_ôu_t_t35
.
tŸÆ_byã
 =Åotal_byte;

1535 
	}
}

1537 
	$FöÆizeU£r_d©a_ªgi°îed_ôu_t_t35
(
SEIP¨amëîs
 *
p_SEI
)

1539 
i
;

1540 
Sy¡axEÀmít
 
sym
;

1541 
Bô°ªam
 *
de°
 = 
p_SEI
->
£iU£r_d©a_ªgi°îed_ôu_t_t35
.
d©a
;

1543 
sym
.
ty≥
 = 
SE_HEADER
;

1544 
sym
.
m≠pög
 = 
ue_löfo
;

1546 
sym
.
bô∑âîn
 = 
p_SEI
->
£iU£r_d©a_ªgi°îed_ôu_t_t35
.
ôu_t_t35_cou¡ry_code
;

1547 
sym
.
Àn
 = 8;

1548 
	`wrôeSy¡axEÀmít2Buf_Fixed
(&
sym
, 
de°
);

1551 #ifde‡
PRINT_USER_DATA_REGISTERED_ITU_T_T35_INFO


1552 
	`¥ötf
(" ITU_T_T35_COUNTRTY_CODE %d \n", 
p_SEI
->
£iU£r_d©a_ªgi°îed_ôu_t_t35
.
ôu_t_t35_cou¡ry_code
);

1555 if(
p_SEI
->
£iU£r_d©a_ªgi°îed_ôu_t_t35
.
ôu_t_t35_cou¡ry_code
 == 0xFF)

1557 
sym
.
bô∑âîn
 = 
p_SEI
->
£iU£r_d©a_ªgi°îed_ôu_t_t35
.
ôu_t_t35_cou¡ry_code_exãnsi⁄_byã
;

1558 
sym
.
Àn
 = 8;

1559 
	`wrôeSy¡axEÀmít2Buf_Fixed
(&
sym
, 
de°
);

1560 #ifde‡
PRINT_USER_DATA_REGISTERED_ITU_T_T35_INFO


1561 
	`¥ötf
(" ITU_T_T35_COUNTRTY_CODE_EXTENSION_BYTE %d \n", 
p_SEI
->
£iU£r_d©a_ªgi°îed_ôu_t_t35
.
ôu_t_t35_cou¡ry_code_exãnsi⁄_byã
);

1565  
i
 = 0; i < 
p_SEI
->
£iU£r_d©a_ªgi°îed_ôu_t_t35
.
tŸÆ_byã
; i++)

1567 
sym
.
bô∑âîn
 = 
p_SEI
->
£iU£r_d©a_ªgi°îed_ôu_t_t35
.
byã
[
i
];

1568 
sym
.
Àn
 = 8;

1569 
	`wrôeSy¡axEÀmít2Buf_Fixed
(&
sym
, 
de°
);

1570 #ifde‡
PRINT_USER_DATA_REGISTERED_ITU_T_T35_INFO


1571 
	`¥ötf
("ôu_t_t35Öaylﬂd_byã = %d\n", 
p_SEI
->
£iU£r_d©a_ªgi°îed_ôu_t_t35
.
byã
[
i
]);

1574 #ifde‡
PRINT_USER_DATA_REGISTERED_ITU_T_T35_INFO


1575 #unde‡
PRINT_USER_DATA_REGISTERED_ITU_T_T35_INFO


1578 i‡–
de°
->
bôs_to_go
 != 8 )

1580 (
de°
->
byã_buf
) <<= 1;

1581 
de°
->
byã_buf
 |= 1;

1582 
de°
->
bôs_to_go
--;

1583 i‡–
de°
->
bôs_to_go
 !0 ) (de°->
byã_buf
) <<= (dest->bits_to_go);

1584 
de°
->
bôs_to_go
 = 8;

1585 
de°
->
°ªamBuf„r
[de°->
byã_pos
++]=de°->
byã_buf
;

1586 
de°
->
byã_buf
 = 0;

1588 
p_SEI
->
£iU£r_d©a_ªgi°îed_ôu_t_t35
.
∑ylﬂdSize
 = 
de°
->
byã_pos
;

1589 
	}
}

1591 
	$Clo£U£r_d©a_ªgi°îed_ôu_t_t35
(
SEIP¨amëîs
 *
p_SEI
)

1593 i‡(
p_SEI
->
£iU£r_d©a_ªgi°îed_ôu_t_t35
.
d©a
)

1595 
	`‰ì
(
p_SEI
->
£iU£r_d©a_ªgi°îed_ôu_t_t35
.
d©a
->
°ªamBuf„r
);

1596 
	`‰ì
(
p_SEI
->
£iU£r_d©a_ªgi°îed_ôu_t_t35
.
d©a
);

1598 
p_SEI
->
£iU£r_d©a_ªgi°îed_ôu_t_t35
.
d©a
 = 
NULL
;

1599 if(
p_SEI
->
£iU£r_d©a_ªgi°îed_ôu_t_t35
.
byã
)

1601 
	`‰ì
(
p_SEI
->
£iU£r_d©a_ªgi°îed_ôu_t_t35
.
byã
);

1603 
	}
}

1614 
	$InôR™domAc˚ss
(
SEIP¨amëîs
 *
p_SEI
)

1616 
p_SEI
->
£iRecovîyPoöt
.
d©a
 = 
	`mÆloc
–(
Bô°ªam
) );

1617 if–
p_SEI
->
£iRecovîyPoöt
.
d©a
 =
NULL
 ) 
	`no_mem_exô
("InitRandomAccess: seiRandomAccess.data");

1618 
p_SEI
->
£iRecovîyPoöt
.
d©a
->
°ªamBuf„r
 = 
	`mÆloc
(
MAXRTPPAYLOADLEN
);

1619 if–
p_SEI
->
£iRecovîyPoöt
.
d©a
->
°ªamBuf„r
 =
NULL
 ) 
	`no_mem_exô
("InitRandomAccess: seiRandomAccess.data->streamBuffer");

1620 
	`CÀ¨R™domAc˚ss
(
p_SEI
);

1621 
	}
}

1624 
	$CÀ¨R™domAc˚ss
(
SEIP¨amëîs
 *
p_SEI
)

1626 
	`mem£t
–
p_SEI
->
£iRecovîyPoöt
.
d©a
->
°ªamBuf„r
, 0, 
MAXRTPPAYLOADLEN
);

1627 
p_SEI
->
£iRecovîyPoöt
.
d©a
->
bôs_to_go
 = 8;

1628 
p_SEI
->
£iRecovîyPoöt
.
d©a
->
byã_pos
 = 0;

1629 
p_SEI
->
£iRecovîyPoöt
.
d©a
->
byã_buf
 = 0;

1630 
p_SEI
->
£iRecovîyPoöt
.
∑ylﬂdSize
 = 0;

1632 
p_SEI
->
£iRecovîyPoöt
.
ªcovîy_‰ame_˙t
 = 0;

1633 
p_SEI
->
£iRecovîyPoöt
.
brokí_lök_Êag
 = 0;

1634 
p_SEI
->
£iRecovîyPoöt
.
exa˘_m©ch_Êag
 = 0;

1635 
p_SEI
->
£iRecovîyPoöt
.
ch™gög_¶i˚_group_idc
 = 0;

1637 
p_SEI
->
£iHasRecovîyPoöt_öfo
 = 
FALSE
;

1638 
	}
}

1640 
	$Upd©eR™domAc˚ss
(
VideoP¨amëîs
 *
p_Vid
)

1642 
SEIP¨amëîs
 *
p_SEI
 = 
p_Vid
->p_SEI;

1643 if(
p_Vid
->
ty≥
 =
I_SLICE
)

1645 
p_SEI
->
£iRecovîyPoöt
.
ªcovîy_‰ame_˙t
 = 0;

1646 
p_SEI
->
£iRecovîyPoöt
.
exa˘_m©ch_Êag
 = 1;

1647 
p_SEI
->
£iRecovîyPoöt
.
brokí_lök_Êag
 = 0;

1648 
p_SEI
->
£iRecovîyPoöt
.
ch™gög_¶i˚_group_idc
 = 0;

1649 
p_SEI
->
£iHasRecovîyPoöt_öfo
 = 
TRUE
;

1653 
p_SEI
->
£iHasRecovîyPoöt_öfo
 = 
FALSE
;

1655 
	}
}

1657 
	$FöÆizeR™domAc˚ss
(
SEIP¨amëîs
 *
p_SEI
)

1659 
Bô°ªam
 *
bô°ªam
 = 
p_SEI
->
£iRecovîyPoöt
.
d©a
;

1661 
	`wrôe_ue_v
–"SEI:Ñecovîy_‰ame_˙t", 
p_SEI
->
£iRecovîyPoöt
.
ªcovîy_‰ame_˙t
, 
bô°ªam
);

1662 
	`wrôe_u_1
 ( "SEI:Éxa˘_m©ch_Êag", 
p_SEI
->
£iRecovîyPoöt
.
exa˘_m©ch_Êag
, 
bô°ªam
);

1663 
	`wrôe_u_1
 ( "SEI: brokí_lök_Êag", 
p_SEI
->
£iRecovîyPoöt
.
brokí_lök_Êag
, 
bô°ªam
);

1664 
	`wrôe_u_v
 (2, "SEI: ch™gög_¶i˚_group_idc", 
p_SEI
->
£iRecovîyPoöt
.
ch™gög_¶i˚_group_idc
, 
bô°ªam
);

1668 #ifde‡
PRINT_RECOVERY_POINT


1669 
	`¥ötf
("Ñecovîy_‰ame_˙à%d \n", 
p_SEI
->
£iRecovîyPoöt
.
ªcovîy_‰ame_˙t
);

1670 
	`¥ötf
("Éxa˘_m©ch_Êag %d \n", 
p_SEI
->
£iRecovîyPoöt
.
exa˘_m©ch_Êag
);

1671 
	`¥ötf
(" brokí_lök_Êag %d \n", 
p_SEI
->
£iRecovîyPoöt
.
brokí_lök_Êag
);

1672 
	`¥ötf
(" ch™gög_¶i˚_group_id¯%d \n", 
p_SEI
->
£iRecovîyPoöt
.
ch™gög_¶i˚_group_idc
);

1673 
	`¥ötf
(" %d %d \n", 
bô°ªam
->
byã_pos
, bô°ªam->
bôs_to_go
);

1675 #unde‡
PRINT_RECOVERY_POINT


1678 i‡–
bô°ªam
->
bôs_to_go
 != 8 )

1680 (
bô°ªam
->
byã_buf
) <<= 1;

1681 
bô°ªam
->
byã_buf
 |= 1;

1682 
bô°ªam
->
bôs_to_go
--;

1683 i‡–
bô°ªam
->
bôs_to_go
 != 0 )

1684 (
bô°ªam
->
byã_buf
Ë<<(bô°ªam->
bôs_to_go
);

1685 
bô°ªam
->
bôs_to_go
 = 8;

1686 
bô°ªam
->
°ªamBuf„r
[bô°ªam->
byã_pos
++]=bô°ªam->
byã_buf
;

1687 
bô°ªam
->
byã_buf
 = 0;

1689 
p_SEI
->
£iRecovîyPoöt
.
∑ylﬂdSize
 = 
bô°ªam
->
byã_pos
;

1690 
	}
}

1692 
	$Clo£R™domAc˚ss
(
SEIP¨amëîs
 *
p_SEI
)

1694 i‡(
p_SEI
->
£iRecovîyPoöt
.
d©a
)

1696 
	`‰ì
(
p_SEI
->
£iRecovîyPoöt
.
d©a
->
°ªamBuf„r
);

1697 
	`‰ì
(
p_SEI
->
£iRecovîyPoöt
.
d©a
);

1699 
p_SEI
->
£iRecovîyPoöt
.
d©a
 = 
NULL
;

1700 
	}
}

1711 
	$P¨£T⁄eM≠pögC⁄figFûe
(
SEIP¨amëîs
 *
p_SEI
, 
I≈utP¨amëîs
 *
p_I≈
, 
T⁄eM≠pögSEI
 *
pSeiT⁄eM≠pög
)

1713 
i
;

1714 
ªt
;

1715 
FILE
* 
Â
;

1716 
buf
[1024];

1717 
tmp
;

1719 
	`¥ötf
 ("P¨sög T⁄êm≠pög cfg fûê%†..........\n\n", 
p_I≈
->
T⁄eM≠pögFûe
);

1720 i‡((
Â
 = 
	`f›í
(
p_I≈
->
T⁄eM≠pögFûe
, "r")Ë=
NULL
)

1722 
	`Ârötf
(
°dîr
, "T⁄êm≠pög c⁄fig fûê%†i†nŸ found, dißbÀÅ⁄êm≠pög SEI\n", 
p_I≈
->
T⁄eM≠pögFûe
);

1723 
p_SEI
->
£iHasT⁄e_m≠pög
=
FALSE
;

1729 
	`fsˇnf
(
Â
, "%s", 
buf
)!=
EOF
)

1731 
ªt
 = 1;

1732 i‡(
	`°rcmp
(
buf
, "tone_map_id")==0)

1734 
ªt
 = 
	`fsˇnf
(
Â
, " = %ud\n", &(
pSeiT⁄eM≠pög
->
t⁄e_m≠_id
));

1736 i‡(
	`°rcmp
(
buf
, "tone_map_cancel_flag")==0)

1738 
ªt
 = 
	`fsˇnf
(
Â
, " = %ud\n", &
tmp
);

1739 
pSeiT⁄eM≠pög
->
t⁄e_m≠_ˇn˚l_Êag
 = (Ë(
tmp
 ? 1 : 0);

1741 i‡(
	`°rcmp
(
buf
, "tone_map_repetition_period")==0)

1743 
ªt
 = 
	`fsˇnf
(
Â
, " = %ud\n", &(
pSeiT⁄eM≠pög
->
t⁄e_m≠_ª≥tôi⁄_≥riod
));

1745 i‡(
	`°rcmp
(
buf
, "coded_data_bit_depth")==0)

1747 
ªt
 = 
	`fsˇnf
(
Â
, " = %ud\n", &
tmp
);

1748 
pSeiT⁄eM≠pög
->
coded_d©a_bô_dïth
 = (Ë
tmp
;

1750 i‡(
	`°rcmp
(
buf
, "sei_bit_depth")==0)

1752 
ªt
 = 
	`fsˇnf
(
Â
, " = %ud\n", &
tmp
);

1753 
pSeiT⁄eM≠pög
->
£i_bô_dïth
 = (Ë
tmp
;

1755 i‡(
	`°rcmp
(
buf
, "model_id")==0)

1757 
ªt
 = 
	`fsˇnf
(
Â
, " = %ud\n", &(
pSeiT⁄eM≠pög
->
modñ_id
));

1760 i‡(
	`°rcmp
(
buf
, "min_value")==0)

1762 
ªt
 = 
	`fsˇnf
(
Â
, " = %d\n", &(
pSeiT⁄eM≠pög
->
mö_vÆue
));

1764 i‡(
	`°rcmp
(
buf
, "max_value")==0)

1766 
ªt
 = 
	`fsˇnf
(
Â
, " = %d\n", &(
pSeiT⁄eM≠pög
->
max_vÆue
));

1769 i‡(
	`°rcmp
(
buf
, "sigmoid_midpoint")==0)

1771 
ªt
 = 
	`fsˇnf
(
Â
, " = %d\n", &(
pSeiT⁄eM≠pög
->
sigmoid_midpoöt
));

1773 i‡(
	`°rcmp
(
buf
, "sigmoid_width")==0)

1775 
ªt
 = 
	`fsˇnf
(
Â
, " = %d\n", &(
pSeiT⁄eM≠pög
->
sigmoid_width
));

1778 i‡(
	`°rcmp
(
buf
, "start_of_coded_interval")==0)

1780 
max_ouçut_num
 = 1<<(
pSeiT⁄eM≠pög
->
£i_bô_dïth
);

1781 
ªt
 = 
	`fsˇnf
(
Â
, " = ");

1782 i‡(
ªt
!=0)

1784 
	`îr‹
 ("ParseToneMappingConfigFile:ÉrrorÖarsingÅone mapping config file",500);

1786 
i
=0; i < 
max_ouçut_num
; i++)

1788 
ªt
 = 
	`fsˇnf
(
Â
, "%d\n", &(
pSeiT⁄eM≠pög
->
°¨t_of_coded_öãrvÆ
[
i
]));

1789 i‡(
ªt
!=1)

1791 
	`îr‹
 ("ParseToneMappingConfigFile:ÉrrorÖarsingÅone mapping config file",500);

1796 i‡(
	`°rcmp
(
buf
, "num_pivots")==0)

1798 
ªt
 = 
	`fsˇnf
(
Â
, " = %d\n", &(
pSeiT⁄eM≠pög
->
num_pivŸs
));

1801 i‡(
	`°rcmp
(
buf
, "coded_pivot_value")==0)

1803 
ªt
 = 
	`fsˇnf
(
Â
, " = ");

1804 i‡(
ªt
!=0)

1806 
	`îr‹
 ("ParseToneMappingConfigFile:ÉrrorÖarsingÅone mapping config file",500);

1808 
i
=0; i < 
pSeiT⁄eM≠pög
->
num_pivŸs
; i++)

1810 
ªt
 = 
	`fsˇnf
(
Â
, "%d\n", &(
pSeiT⁄eM≠pög
->
coded_pivŸ_vÆue
[
i
]));

1811 i‡(
ªt
!=1)

1813 
	`îr‹
 ("ParseToneMappingConfigFile:ÉrrorÖarsingÅone mapping config file",500);

1817 i‡(
	`°rcmp
(
buf
, "sei_pivot_value")==0)

1819 
ªt
 = 
	`fsˇnf
(
Â
, " = ");

1820 i‡(
ªt
!=0)

1822 
	`îr‹
 ("ParseToneMappingConfigFile:ÉrrorÖarsingÅone mapping config file",500);

1824 
i
=0; i < 
pSeiT⁄eM≠pög
->
num_pivŸs
; i++)

1826 
ªt
 = 
	`fsˇnf
(
Â
, "%d\n", &(
pSeiT⁄eM≠pög
->
£i_pivŸ_vÆue
[
i
]));

1827 i‡(
ªt
!=1)

1829 
	`îr‹
 ("ParseToneMappingConfigFile:ÉrrorÖarsingÅone mapping config file",500);

1836 i‡(
NULL
 =
	`fgës
(
buf
, (buf), 
Â
))

1838 
	`îr‹
 ("ParseToneMappingConfigFile:ÉrrorÖarsingÅone mapping config file",500);

1841 i‡(
ªt
!=1)

1843 
	`îr‹
 ("ParseToneMappingConfigFile:ÉrrorÖarsingÅone mapping config file",500);

1847 
	`f˛o£
(
Â
);

1850 
	}
}

1852 
	$InôT⁄eM≠pög
(
SEIP¨amëîs
 *
p_SEI
, 
I≈utP¨amëîs
 *
p_I≈
)

1854 i‡(
p_I≈
->
T⁄eM≠pögSEIPª£¡Fœg
 == 0)

1856 
p_SEI
->
£iHasT⁄e_m≠pög
 = 
FALSE
;

1860 
p_SEI
->
£iHasT⁄e_m≠pög
 = 
TRUE
;

1862 
p_SEI
->
£iT⁄eM≠pög
.
d©a
 = 
	`mÆloc
–(
Bô°ªam
) );

1863 if–
p_SEI
->
£iT⁄eM≠pög
.
d©a
 =
NULL
 ) 
	`no_mem_exô
("InitToneMapping: seiToneMapping.data");

1864 
p_SEI
->
£iT⁄eM≠pög
.
d©a
->
°ªamBuf„r
 = 
	`mÆloc
(
MAXRTPPAYLOADLEN
);

1865 if–
p_SEI
->
£iT⁄eM≠pög
.
d©a
->
°ªamBuf„r
 =
NULL
 ) 
	`no_mem_exô
("InitToneMapping: seiToneMapping.data->streamBuffer");

1866 
	`mem£t
–
p_SEI
->
£iT⁄eM≠pög
.
d©a
->
°ªamBuf„r
, 0, 
MAXRTPPAYLOADLEN
);

1867 
p_SEI
->
£iT⁄eM≠pög
.
d©a
->
bôs_to_go
 = 8;

1868 
p_SEI
->
£iT⁄eM≠pög
.
d©a
->
byã_pos
 = 0;

1869 
p_SEI
->
£iT⁄eM≠pög
.
d©a
->
byã_buf
 = 0;

1870 
p_SEI
->
£iT⁄eM≠pög
.
∑ylﬂdSize
 = 0;

1873 
	`P¨£T⁄eM≠pögC⁄figFûe
(
p_SEI
, 
p_I≈
, &p_SEI->
£iT⁄eM≠pög
);

1874 
	}
}

1876 
	$FöÆizeT⁄eM≠pög
(
VideoP¨amëîs
 *
p_Vid
)

1878 
SEIP¨amëîs
 *
p_SEI
 = 
p_Vid
->p_SEI;

1880 
Bô°ªam
 *
bô°ªam
 = 
p_SEI
->
£iT⁄eM≠pög
.
d©a
;

1881 
i
;

1883 
	`wrôe_ue_v
("SEI:Å⁄e_m≠_id" , 
p_SEI
->
£iT⁄eM≠pög
.
t⁄e_m≠_id
, 
bô°ªam
);

1884 
	`wrôe_u_1
("SEI:Å⁄e_m≠_ˇn˚l_Êag" , 
p_SEI
->
£iT⁄eM≠pög
.
t⁄e_m≠_ˇn˚l_Êag
, 
bô°ªam
);

1886 #ifde‡
PRINT_TONE_MAPPING


1887 
	`¥ötf
("‰amê%d: T⁄e-m≠pög SEI mesßge\n", 
p_Vid
->
‰ame_num
);

1888 
	`¥ötf
("t⁄e_m≠_id = %d\n", 
p_SEI
->
£iT⁄eM≠pög
.
t⁄e_m≠_id
);

1889 
	`¥ötf
("t⁄e_m≠_ˇn˚l_Êag = %d\n", 
p_SEI
->
£iT⁄eM≠pög
.
t⁄e_m≠_ˇn˚l_Êag
);

1891 i‡(!
p_SEI
->
£iT⁄eM≠pög
.
t⁄e_m≠_ˇn˚l_Êag
)

1893 
	`wrôe_ue_v
–"SEI:Å⁄e_m≠_ª≥tôi⁄_≥riod", 
p_SEI
->
£iT⁄eM≠pög
.
t⁄e_m≠_ª≥tôi⁄_≥riod
, 
bô°ªam
);

1894 
	`wrôe_u_v
 (8,"SEI: coded_d©a_bô_dïth" , 
p_SEI
->
£iT⁄eM≠pög
.
coded_d©a_bô_dïth
, 
bô°ªam
);

1895 
	`wrôe_u_v
 (8,"SEI: sei_bô_dïth" , 
p_SEI
->
£iT⁄eM≠pög
.
£i_bô_dïth
, 
bô°ªam
);

1896 
	`wrôe_ue_v
–"SEI: modñ_id" , 
p_SEI
->
£iT⁄eM≠pög
.
modñ_id
, 
bô°ªam
);

1898 #ifde‡
PRINT_TONE_MAPPING


1899 
	`¥ötf
("t⁄e_m≠_ª≥tôi⁄_≥riod = %d\n", 
p_SEI
->
£iT⁄eM≠pög
.
t⁄e_m≠_ª≥tôi⁄_≥riod
);

1900 
	`¥ötf
("coded_d©a_bô_dïth = %d\n", 
p_SEI
->
£iT⁄eM≠pög
.
coded_d©a_bô_dïth
);

1901 
	`¥ötf
("£i_bô_dïth = %d\n", 
p_SEI
->
£iT⁄eM≠pög
.
£i_bô_dïth
);

1902 
	`¥ötf
("modñ_id = %d\n", 
p_SEI
->
£iT⁄eM≠pög
.
modñ_id
);

1904 i‡(
p_SEI
->
£iT⁄eM≠pög
.
modñ_id
 == 0)

1906 
	`wrôe_u_v
 (32,"SEI: mö_vÆue", 
p_SEI
->
£iT⁄eM≠pög
.
mö_vÆue
, 
bô°ªam
);

1907 
	`wrôe_u_v
 (32,"SEI: mö_vÆue", 
p_SEI
->
£iT⁄eM≠pög
.
max_vÆue
, 
bô°ªam
);

1908 #ifde‡
PRINT_TONE_MAPPING


1909 
	`¥ötf
("mö_vÆuê%d, max_vÆuê%d\n", 
p_SEI
->
£iT⁄eM≠pög
.
mö_vÆue
,Ö_SEI->£iT⁄eM≠pög.
max_vÆue
);

1912 i‡(
p_SEI
->
£iT⁄eM≠pög
.
modñ_id
 == 1)

1914 
	`wrôe_u_v
 (32,"SEI: sigmoid_midpoöt", 
p_SEI
->
£iT⁄eM≠pög
.
sigmoid_midpoöt
, 
bô°ªam
);

1915 
	`wrôe_u_v
 (32,"SEI: sigmoid_width", 
p_SEI
->
£iT⁄eM≠pög
.
sigmoid_width
, 
bô°ªam
);

1916 #ifde‡
PRINT_TONE_MAPPING


1917 
	`¥ötf
("sigmoid_midpoöà%d, sigmoid_width = %d\n", 
p_SEI
->
£iT⁄eM≠pög
.
sigmoid_midpoöt
,Ö_SEI->£iT⁄eM≠pög.
sigmoid_width
);

1920 i‡(
p_SEI
->
£iT⁄eM≠pög
.
modñ_id
 == 2)

1922 
bô_dïth_vÆ
 = 1 << 
p_SEI
->
£iT⁄eM≠pög
.
£i_bô_dïth
;

1923 
i
=0; i<
bô_dïth_vÆ
; i++)

1925 
	`wrôe_u_v
((((
p_SEI
->
£iT⁄eM≠pög
.
coded_d©a_bô_dïth
+7)>>3)<<3), "SEI: sèπ_of_coded_öãrvÆ",Ö_SEI->£iT⁄eM≠pög.
°¨t_of_coded_öãrvÆ
[
i
], 
bô°ªam
);

1926 #ifde‡
PRINT_TONE_MAPPING


1931 i‡(
p_SEI
->
£iT⁄eM≠pög
.
modñ_id
 == 3)

1933 
	`wrôe_u_v
 (16,"SEI:Çum_pivŸs", 
p_SEI
->
£iT⁄eM≠pög
.
num_pivŸs
, 
bô°ªam
);

1934 #ifde‡
PRINT_TONE_MAPPING


1935 
	`¥ötf
("num_pivŸ†%d\n", 
p_SEI
->
£iT⁄eM≠pög
.
num_pivŸs
);

1937 
i
=0; i < 
p_SEI
->
£iT⁄eM≠pög
.
num_pivŸs
; i++)

1939 
	`wrôe_u_v
–(((
p_SEI
->
£iT⁄eM≠pög
.
coded_d©a_bô_dïth
+7)>>3)<<3), "SEI: coded_pivŸ_vÆue",Ö_SEI->£iT⁄eM≠pög.
coded_pivŸ_vÆue
[
i
], 
bô°ªam
);

1940 
	`wrôe_u_v
–(((
p_SEI
->
£iT⁄eM≠pög
.
£i_bô_dïth
+7)>>3)<<3), "SEI: sei_pivŸ_vÆue",Ö_SEI->£iT⁄eM≠pög.
£i_pivŸ_vÆue
[
i
], 
bô°ªam
);

1941 #ifde‡
PRINT_TONE_MAPPING


1942 
	`¥ötf
("coded_pivŸ_vÆue[%d] = %d, sei_pivŸ_vÆue[%d] = %d\n", 
i
, 
p_SEI
->
£iT⁄eM≠pög
.
coded_pivŸ_vÆue
[i], i,Ö_SEI->£iT⁄eM≠pög.
£i_pivŸ_vÆue
[i]);

1949 i‡–
bô°ªam
->
bôs_to_go
 != 8 )

1951 (
bô°ªam
->
byã_buf
) <<= 1;

1952 
bô°ªam
->
byã_buf
 |= 1;

1953 
bô°ªam
->
bôs_to_go
--;

1954 i‡–
bô°ªam
->
bôs_to_go
 != 0 )

1955 (
bô°ªam
->
byã_buf
Ë<<(bô°ªam->
bôs_to_go
);

1956 
bô°ªam
->
bôs_to_go
 = 8;

1957 
bô°ªam
->
°ªamBuf„r
[bô°ªam->
byã_pos
++]=bô°ªam->
byã_buf
;

1958 
bô°ªam
->
byã_buf
 = 0;

1960 
p_SEI
->
£iT⁄eM≠pög
.
∑ylﬂdSize
 = 
bô°ªam
->
byã_pos
;

1961 
	}
}

1964 
	$Upd©eT⁄eM≠pög
(
SEIP¨amëîs
 *
p_SEI
)

1969 
	}
}

1971 
	$CÀ¨T⁄eM≠pög
(
SEIP¨amëîs
 *
p_SEI
)

1973 
	`mem£t
–
p_SEI
->
£iT⁄eM≠pög
.
d©a
->
°ªamBuf„r
, 0, 
MAXRTPPAYLOADLEN
);

1974 
p_SEI
->
£iT⁄eM≠pög
.
d©a
->
bôs_to_go
 = 8;

1975 
p_SEI
->
£iT⁄eM≠pög
.
d©a
->
byã_pos
 = 0;

1976 
p_SEI
->
£iT⁄eM≠pög
.
d©a
->
byã_buf
 = 0;

1977 
p_SEI
->
£iT⁄eM≠pög
.
∑ylﬂdSize
 = 0;

1979 
p_SEI
->
£iHasT⁄e_m≠pög
=
FALSE
;

1980 
	}
}

1982 
	$Clo£T⁄eM≠pög
(
SEIP¨amëîs
 *
p_SEI
)

1985 i‡(
p_SEI
->
£iT⁄eM≠pög
.
d©a
)

1987 
	`‰ì
(
p_SEI
->
£iT⁄eM≠pög
.
d©a
->
°ªamBuf„r
);

1988 
	`‰ì
(
p_SEI
->
£iT⁄eM≠pög
.
d©a
);

1990 
p_SEI
->
£iT⁄eM≠pög
.
d©a
 = 
NULL
;

1991 
p_SEI
->
£iHasT⁄e_m≠pög
 = 
FALSE
;

1992 
	}
}

2003 
	$InôPo°FûãrHöts
(
SEIP¨amëîs
 *
p_SEI
)

2005 
p_SEI
->
£iPo°FûãrHöts
.
d©a
 = 
	`mÆloc
–(
Bô°ªam
) );

2006 if–
p_SEI
->
£iPo°FûãrHöts
.
d©a
 =
NULL
 ) 
	`no_mem_exô
("InitPostFilterHints:Ö_SEI->seiPostFilterHints.data");

2007 
p_SEI
->
£iPo°FûãrHöts
.
d©a
->
°ªamBuf„r
 = 
	`mÆloc
(
MAXRTPPAYLOADLEN
);

2008 if–
p_SEI
->
£iPo°FûãrHöts
.
d©a
->
°ªamBuf„r
 =
NULL
 ) 
	`no_mem_exô
("InitPostFilterHints:Ö_SEI->seiPostFilterHints.data->streamBuffer");

2009 
	`CÀ¨Po°FûãrHöts
(
p_SEI
);

2010 
	}
}

2012 
	$CÀ¨Po°FûãrHöts
(
SEIP¨amëîs
 *
p_SEI
)

2014 
	`mem£t
–
p_SEI
->
£iPo°FûãrHöts
.
d©a
->
°ªamBuf„r
, 0, 
MAXRTPPAYLOADLEN
);

2015 
p_SEI
->
£iPo°FûãrHöts
.
d©a
->
bôs_to_go
 = 8;

2016 
p_SEI
->
£iPo°FûãrHöts
.
d©a
->
byã_pos
 = 0;

2017 
p_SEI
->
£iPo°FûãrHöts
.
d©a
->
byã_buf
 = 0;

2018 
p_SEI
->
£iPo°FûãrHöts
.
∑ylﬂdSize
 = 0;

2020 
p_SEI
->
£iPo°FûãrHöts
.
fûãr_höt_size_y
 = 0;

2021 
p_SEI
->
£iPo°FûãrHöts
.
fûãr_höt_size_x
 = 0;

2022 
p_SEI
->
£iPo°FûãrHöts
.
fûãr_höt_ty≥
 = 0;

2023 
p_SEI
->
£iPo°FûãrHöts
.
addôi⁄Æ_exãnsi⁄_Êag
 = 0;

2024 
	}
}

2026 
	$Upd©ePo°FûãrHöts
(
SEIP¨amëîs
 *
p_SEI
)

2028 
cﬁ‹_comp⁄ít
, 
cx
, 
cy
;

2029 
p_SEI
->
£iPo°FûãrHöts
.
fûãr_höt_ty≥
 = 0;

2030 
p_SEI
->
£iPo°FûãrHöts
.
fûãr_höt_size_y
 =Ö_SEI->£iPo°FûãrHöts.
fûãr_höt_size_x
 = 5;

2031 
	`gë_mem3Döt
(&
p_SEI
->
£iPo°FûãrHöts
.
fûãr_höt
, 3,Ö_SEI->£iPo°FûãrHöts.
fûãr_höt_size_y
,Ö_SEI->£iPo°FûãrHöts.
fûãr_höt_size_x
);

2033 
cﬁ‹_comp⁄ít
 = 0; color_component < 3; color_component ++)

2034 
cy
 = 0; cy < 
p_SEI
->
£iPo°FûãrHöts
.
fûãr_höt_size_y
; cy ++)

2035 
cx
 = 0; cx < 
p_SEI
->
£iPo°FûãrHöts
.
fûãr_höt_size_x
; cx ++)

2036 
p_SEI
->
£iPo°FûãrHöts
.
fûãr_höt
[
cﬁ‹_comp⁄ít
][
cy
][
cx
] = 1;

2038 
p_SEI
->
£iPo°FûãrHöts
.
addôi⁄Æ_exãnsi⁄_Êag
 = 0;

2039 
	}
}

2041 
	$FöÆizePo°FûãrHöts
(
SEIP¨amëîs
 *
p_SEI
)

2043 
Bô°ªam
 *
bô°ªam
 = 
p_SEI
->
£iPo°FûãrHöts
.
d©a
;

2044 
cﬁ‹_comp⁄ít
, 
cx
, 
cy
;

2046 
	`wrôe_ue_v
–"SEI:Öo°_fûãr_höt_size_y", 
p_SEI
->
£iPo°FûãrHöts
.
fûãr_höt_size_y
, 
bô°ªam
);

2047 
	`wrôe_ue_v
–"SEI:Öo°_fûãr_höt_size_x", 
p_SEI
->
£iPo°FûãrHöts
.
fûãr_höt_size_x
, 
bô°ªam
);

2048 
	`wrôe_u_v
 (2,"SEI:Öo°_fûãr_höt_ty≥", 
p_SEI
->
£iPo°FûãrHöts
.
fûãr_höt_ty≥
, 
bô°ªam
);

2050 
cﬁ‹_comp⁄ít
 = 0; color_component < 3; color_component ++)

2051 
cy
 = 0; cy < 
p_SEI
->
£iPo°FûãrHöts
.
fûãr_höt_size_y
; cy ++)

2052 
cx
 = 0; cx < 
p_SEI
->
£iPo°FûãrHöts
.
fûãr_höt_size_x
; cx ++)

2053 
	`wrôe_£_v
("SEI:Öo°_fûãr_höts", 
p_SEI
->
£iPo°FûãrHöts
.
fûãr_höt
[
cﬁ‹_comp⁄ít
][
cy
][
cx
], 
bô°ªam
);

2055 
	`wrôe_u_1
 ("SEI:Öo°_fûãr_addôi⁄Æ_exãnsi⁄_Êag", 
p_SEI
->
£iPo°FûãrHöts
.
addôi⁄Æ_exãnsi⁄_Êag
, 
bô°ªam
);

2058 #ifde‡
PRINT_POST_FILTER_HINTS


2059 
	`¥ötf
("Öo°_fûãr_höt_size_y %d \n", 
p_SEI
->
£iPo°FûãrHöts
.
fûãr_höt_size_y
);

2060 
	`¥ötf
("Öo°_fûãr_höt_size_x %d \n", 
p_SEI
->
£iPo°FûãrHöts
.
fûãr_höt_size_x
);

2061 
	`¥ötf
("Öo°_fûãr_höt_ty≥ %d \n", 
p_SEI
->
£iPo°FûãrHöts
.
fûãr_höt_ty≥
);

2062 
cﬁ‹_comp⁄ít
 = 0; color_component < 3; color_component ++)

2063 
cy
 = 0; cy < 
p_SEI
->
£iPo°FûãrHöts
.
fûãr_höt_size_y
; cy ++)

2064 
cx
 = 0; cx < 
p_SEI
->
£iPo°FûãrHöts
.
fûãr_höt_size_x
; cx ++)

2065 
	`¥ötf
("Öo°_fûãr_höt[%d][%d][%d] %d \n", 
cﬁ‹_comp⁄ít
, 
cy
, 
cx
, 
fûãr_höt
[color_component][cy][cx]);

2067 
	`¥ötf
("áddôi⁄Æ_exãnsi⁄_Êag %d \n", 
p_SEI
->
£iPo°FûãrHöts
.
addôi⁄Æ_exãnsi⁄_Êag
);

2069 #unde‡
PRINT_POST_FILTER_HINTS


2072 i‡–
bô°ªam
->
bôs_to_go
 != 8 )

2074 (
bô°ªam
->
byã_buf
) <<= 1;

2075 
bô°ªam
->
byã_buf
 |= 1;

2076 
bô°ªam
->
bôs_to_go
--;

2077 i‡–
bô°ªam
->
bôs_to_go
 != 0 )

2078 (
bô°ªam
->
byã_buf
Ë<<(bô°ªam->
bôs_to_go
);

2079 
bô°ªam
->
bôs_to_go
 = 8;

2080 
bô°ªam
->
°ªamBuf„r
[bô°ªam->
byã_pos
++]=bô°ªam->
byã_buf
;

2081 
bô°ªam
->
byã_buf
 = 0;

2083 
p_SEI
->
£iPo°FûãrHöts
.
∑ylﬂdSize
 = 
bô°ªam
->
byã_pos
;

2084 
	}
}

2086 
	$Clo£Po°FûãrHöts
(
SEIP¨amëîs
 *
p_SEI
)

2088 i‡(
p_SEI
->
£iPo°FûãrHöts
.
d©a
)

2090 
	`‰ì
(
p_SEI
->
£iPo°FûãrHöts
.
d©a
->
°ªamBuf„r
);

2091 
	`‰ì
(
p_SEI
->
£iPo°FûãrHöts
.
d©a
);

2092 i‡(
p_SEI
->
£iPo°FûãrHöts
.
fûãr_höt
)

2093 
	`‰ì_mem3Döt
(
p_SEI
->
£iPo°FûãrHöts
.
fûãr_höt
);

2095 
p_SEI
->
£iPo°FûãrHöts
.
d©a
 = 
NULL
;

2096 
	}
}

2104 
	$Wrôe_SEI_NALU
(
VideoP¨amëîs
 *
p_Vid
, 
Àn
)

2106 
NALU_t
 *
«lu
 = 
NULL
;

2107 
RBSPÀn
 = 0;

2108 
byã
 *
rb•
;

2110 i‡(
	`HaveAggªg©i⁄SEI
(
p_Vid
))

2112 
SEIP¨amëîs
 *
p_SEI
 = 
p_Vid
->p_SEI;

2114 
«lu
 = 
	`AŒocNALU
(
MAXNALUSIZE
);

2115 
rb•
 = 
p_SEI
->
£i_mesßge
[
AGGREGATION_SEI
].
d©a
;

2116 
RBSPÀn
 = 
p_SEI
->
£i_mesßge
[
AGGREGATION_SEI
].
∑ylﬂdSize
;

2117 
	`RBSPtoNALU
 (
rb•
, 
«lu
, 
RBSPÀn
, 
NALU_TYPE_SEI
, 
NALU_PRIORITY_DISPOSABLE
, 1);

2118 
«lu
->
°¨tcodïªfix_Àn
 = 4;

2120 
Àn
 +
p_Vid
->
	`WrôeNALU
 (p_Vid, 
«lu
,Ö_Vid->
f_out
);

2121 
	`FªeNALU
 (
«lu
);

2124  
Àn
;

2125 
	}
}

2134 
	$InôBuf„rögPîiod
(
VideoP¨amëîs
 *
p_Vid
)

2136 
SEIP¨amëîs
 *
p_SEI
 = 
p_Vid
->p_SEI;

2137 
p_SEI
->
£iBuf„rögPîiod
.
d©a
 = 
	`mÆloc
–(
Bô°ªam
) );

2138 if–
p_SEI
->
£iBuf„rögPîiod
.
d©a
 =
NULL
 )

2139 
	`no_mem_exô
("InitBufferingPeriod: seiBufferingPeriod.data");

2141 
p_SEI
->
£iBuf„rögPîiod
.
d©a
->
°ªamBuf„r
 = 
	`mÆloc
(
MAXRTPPAYLOADLEN
);

2142 if–
p_SEI
->
£iBuf„rögPîiod
.
d©a
->
°ªamBuf„r
 =
NULL
 )

2143 
	`no_mem_exô
("InitBufferingPeriod: seiBufferingPeriod.data->streamBuffer");

2145 
	`CÀ¨Buf„rögPîiod
(
p_SEI
, 
p_Vid
->
a˘ive_•s
);

2146 
	}
}

2148 
	$CÀ¨Buf„rögPîiod
(
SEIP¨amëîs
 *
p_SEI
, 
£q_∑ømëî_£t_rb•_t
 *
a˘ive_•s
)

2150 
SchedSñIdx
;

2151 
	`mem£t
–
p_SEI
->
£iBuf„rögPîiod
.
d©a
->
°ªamBuf„r
, 0, 
MAXRTPPAYLOADLEN
);

2153 
p_SEI
->
£iBuf„rögPîiod
.
d©a
->
bôs_to_go
 = 8;

2154 
p_SEI
->
£iBuf„rögPîiod
.
d©a
->
byã_pos
 = 0;

2155 
p_SEI
->
£iBuf„rögPîiod
.
d©a
->
byã_buf
 = 0;

2156 
p_SEI
->
£iBuf„rögPîiod
.
∑ylﬂdSize
 = 0;

2158 
p_SEI
->
£iBuf„rögPîiod
.
£q_∑ømëî_£t_id
 = 
a˘ive_•s
->seq_parameter_set_id;

2159 i‡–
a˘ive_•s
->
vui_£q_∑ømëîs
.
«l_hrd_∑ømëîs_¥e£¡_Êag
 )

2161  
SchedSñIdx
 = 0; SchedSñIdx <
a˘ive_•s
->
vui_£q_∑ømëîs
.
«l_hrd_∑ømëîs
.
˝b_˙t_möus1
; SchedSelIdx++ )

2163 
p_SEI
->
£iBuf„rögPîiod
.
«l_öôül_˝b_ªmovÆ_dñay
[
SchedSñIdx
] = 0;

2164 
p_SEI
->
£iBuf„rögPîiod
.
«l_öôül_˝b_ªmovÆ_dñay_off£t
[
SchedSñIdx
] = 0;

2167 i‡–
a˘ive_•s
->
vui_£q_∑ømëîs
.
v˛_hrd_∑ømëîs_¥e£¡_Êag
 )

2169  
SchedSñIdx
 = 0; SchedSñIdx <
a˘ive_•s
->
vui_£q_∑ømëîs
.
v˛_hrd_∑ømëîs
.
˝b_˙t_möus1
; SchedSelIdx++ )

2171 
p_SEI
->
£iBuf„rögPîiod
.
v˛_öôül_˝b_ªmovÆ_dñay
[
SchedSñIdx
] = 0;

2172 
p_SEI
->
£iBuf„rögPîiod
.
v˛_öôül_˝b_ªmovÆ_dñay_off£t
[
SchedSñIdx
] = 0;

2176 
p_SEI
->
£iHasBuf„rögPîiod_öfo
 = 
FALSE
;

2177 
	}
}

2179 
	$Upd©eBuf„rögPîiod
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

2181 
SEIP¨amëîs
 *
p_SEI
 = 
p_Vid
->p_SEI;

2182 
p_SEI
->
£iHasBuf„rögPîiod_öfo
 = 
FALSE
;

2183 
	}
}

2185 
	$FöÆizeBuf„rögPîiod
(
SEIP¨amëîs
 *
p_SEI
, 
£q_∑ømëî_£t_rb•_t
 *
a˘ive_•s
)

2187 
SchedSñIdx
;

2188 
Bô°ªam
 *
bô°ªam
 = 
p_SEI
->
£iBuf„rögPîiod
.
d©a
;

2190 
	`wrôe_ue_v
–"SEI: seq_∑ømëî_£t_id", 
p_SEI
->
£iBuf„rögPîiod
.
£q_∑ømëî_£t_id
, 
bô°ªam
);

2191 i‡–
a˘ive_•s
->
vui_£q_∑ømëîs
.
«l_hrd_∑ømëîs_¥e£¡_Êag
 )

2193  
SchedSñIdx
 = 0; SchedSñIdx <
a˘ive_•s
->
vui_£q_∑ømëîs
.
«l_hrd_∑ømëîs
.
˝b_˙t_möus1
; SchedSelIdx++ )

2195 
	`wrôe_u_v
–
a˘ive_•s
->
vui_£q_∑ømëîs
.
«l_hrd_∑ømëîs
.
öôül_˝b_ªmovÆ_dñay_Àngth_möus1
 + 1,

2196 "SEI: inôül_˝b_ªmovÆ_dñay", 
p_SEI
->
£iBuf„rögPîiod
.
«l_öôül_˝b_ªmovÆ_dñay
[
SchedSñIdx
], 
bô°ªam
);

2197 
	`wrôe_u_v
–
a˘ive_•s
->
vui_£q_∑ømëîs
.
«l_hrd_∑ømëîs
.
öôül_˝b_ªmovÆ_dñay_Àngth_möus1
 + 1,

2198 "SEI: inôül_˝b_ªmovÆ_dñay_off£t", 
p_SEI
->
£iBuf„rögPîiod
.
«l_öôül_˝b_ªmovÆ_dñay_off£t
[
SchedSñIdx
], 
bô°ªam
);

2201 i‡–
a˘ive_•s
->
vui_£q_∑ømëîs
.
v˛_hrd_∑ømëîs_¥e£¡_Êag
 )

2203  
SchedSñIdx
 = 0; SchedSñIdx <
a˘ive_•s
->
vui_£q_∑ømëîs
.
v˛_hrd_∑ømëîs
.
˝b_˙t_möus1
; SchedSelIdx++ )

2205 
	`wrôe_u_v
–
a˘ive_•s
->
vui_£q_∑ømëîs
.
v˛_hrd_∑ømëîs
.
öôül_˝b_ªmovÆ_dñay_Àngth_möus1
 + 1,

2206 "SEI: inôül_˝b_ªmovÆ_dñay", 
p_SEI
->
£iBuf„rögPîiod
.
v˛_öôül_˝b_ªmovÆ_dñay
[
SchedSñIdx
], 
bô°ªam
);

2207 
	`wrôe_u_v
–
a˘ive_•s
->
vui_£q_∑ømëîs
.
v˛_hrd_∑ømëîs
.
öôül_˝b_ªmovÆ_dñay_Àngth_möus1
 + 1,

2208 "SEI: inôül_˝b_ªmovÆ_dñay_off£t", 
p_SEI
->
£iBuf„rögPîiod
.
v˛_öôül_˝b_ªmovÆ_dñay_off£t
[
SchedSñIdx
], 
bô°ªam
);

2213 i‡–
bô°ªam
->
bôs_to_go
 != 8 )

2215 (
bô°ªam
->
byã_buf
) <<= 1;

2216 
bô°ªam
->
byã_buf
 |= 1;

2217 
bô°ªam
->
bôs_to_go
--;

2218 i‡–
bô°ªam
->
bôs_to_go
 != 0 )

2219 (
bô°ªam
->
byã_buf
Ë<<(bô°ªam->
bôs_to_go
);

2220 
bô°ªam
->
bôs_to_go
 = 8;

2221 
bô°ªam
->
°ªamBuf„r
[bô°ªam->
byã_pos
++]=bô°ªam->
byã_buf
;

2222 
bô°ªam
->
byã_buf
 = 0;

2224 
p_SEI
->
£iBuf„rögPîiod
.
∑ylﬂdSize
 = 
bô°ªam
->
byã_pos
;

2225 
	}
}

2227 
	$Clo£Buf„rögPîiod
(
SEIP¨amëîs
 *
p_SEI
)

2229 i‡(
p_SEI
->
£iBuf„rögPîiod
.
d©a
)

2231 
	`‰ì
(
p_SEI
->
£iBuf„rögPîiod
.
d©a
->
°ªamBuf„r
);

2232 
	`‰ì
(
p_SEI
->
£iBuf„rögPîiod
.
d©a
);

2234 
p_SEI
->
£iBuf„rögPîiod
.
d©a
 = 
NULL
;

2235 
	}
}

2243 
	$InôPicTimög
(
SEIP¨amëîs
 *
p_SEI
)

2245 
p_SEI
->
£iPicTimög
.
d©a
 = 
	`mÆloc
–(
Bô°ªam
) );

2246 if–
p_SEI
->
£iPicTimög
.
d©a
 =
NULL
 )

2247 
	`no_mem_exô
("InitPicTiming: seiPicTiming.data");

2249 
p_SEI
->
£iPicTimög
.
d©a
->
°ªamBuf„r
 = 
	`mÆloc
(
MAXRTPPAYLOADLEN
);

2250 if–
p_SEI
->
£iPicTimög
.
d©a
->
°ªamBuf„r
 =
NULL
 )

2251 
	`no_mem_exô
("InitPicTiming: seiPicTiming.data->streamBuffer");

2253 
	`CÀ¨PicTimög
(
p_SEI
);

2254 
	}
}

2262 
	$CÀ¨PicTimög
(
SEIP¨amëîs
 *
p_SEI
)

2264 
	`mem£t
–
p_SEI
->
£iPicTimög
.
d©a
->
°ªamBuf„r
, 0, 
MAXRTPPAYLOADLEN
);

2266 
p_SEI
->
£iPicTimög
.
d©a
->
bôs_to_go
 = 8;

2267 
p_SEI
->
£iPicTimög
.
d©a
->
byã_pos
 = 0;

2268 
p_SEI
->
£iPicTimög
.
d©a
->
byã_buf
 = 0;

2269 
p_SEI
->
£iPicTimög
.
∑ylﬂdSize
 = 0;

2272 
p_SEI
->
£iPicTimög
.
˝b_ªmovÆ_dñay
 = 0;

2273 
p_SEI
->
£iPicTimög
.
dpb_ouçut_dñay
 = 0;

2274 
p_SEI
->
£iPicTimög
.
pic_°ru˘
 = 0;

2275 
	`mem£t
(
p_SEI
->
£iPicTimög
.
˛ock_time°amp_Êag
, 0, 
MAX_PIC_STRUCT_VALUE
 * (
Boﬁón
) );

2276 
p_SEI
->
£iPicTimög
.
˘_ty≥
 = 0;

2277 
p_SEI
->
£iPicTimög
.
nuô_fõld_ba£d_Êag
 = 
FALSE
;

2278 
p_SEI
->
£iPicTimög
.
cou¡ög_ty≥
 = 0;

2279 
p_SEI
->
£iPicTimög
.
fuŒ_time°amp_Êag
 = 
FALSE
;

2280 
p_SEI
->
£iPicTimög
.
disc⁄töuôy_Êag
 = 
FALSE
;

2281 
p_SEI
->
£iPicTimög
.
˙t_dr›≥d_Êag
 = 
FALSE
;

2282 
p_SEI
->
£iPicTimög
.
n_‰ames
 = 0;

2283 
p_SEI
->
£iPicTimög
.
£c⁄ds_vÆue
 = 0;

2284 
p_SEI
->
£iPicTimög
.
möuãs_vÆue
 = 0;

2285 
p_SEI
->
£iPicTimög
.
hours_vÆue
 = 0;

2286 
p_SEI
->
£iPicTimög
.
£c⁄ds_Êag
 = 
FALSE
;

2287 
p_SEI
->
£iPicTimög
.
möuãs_Êag
 = 
FALSE
;

2288 
p_SEI
->
£iPicTimög
.
hours_Êag
 = 
FALSE
;

2289 
p_SEI
->
£iPicTimög
.
time_off£t
 = 0;

2291 
p_SEI
->
£iHasPicTimög_öfo
 = 
FALSE
;

2292 
	}
}

2300 
	$gë_pic_°ru˘
–
VideoP¨amëîs
 *
p_Vid
, 
‰ame_no
, 
fõld_pic_Êag
, 
t›
 )

2302 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

2304 i‡–
fõld_pic_Êag
 )

2306 i‡–
t›
 )

2317 i‡–!
p_I≈
->
SEIVUI32PuŒdown
 )

2323 
‹dî
 = (
‰ame_no
 % 4);

2324 
pic_°ru˘_a
[4] = {0,5,6,0};

2325 
pic_°ru˘_b
[4] = {0,0,7,0};

2326 
pic_°ru˘_c
[4] = {3,5,6,3};

2327 
pic_°ru˘_d
[4] = {0,5,4,6};

2328 
pic_°ru˘_e
[4] = {3,5,4,6};

2330  
p_I≈
->
SEIVUI32PuŒdown
 )

2334  
pic_°ru˘_a
[
‹dî
];

2337  
pic_°ru˘_b
[
‹dî
];

2340  
pic_°ru˘_c
[
‹dî
];

2343  
pic_°ru˘_d
[
‹dî
];

2346  
pic_°ru˘_e
[
‹dî
];

2351 
	}
}

2360 
	$Upd©ePicTimög
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

2362 
SEIP¨amëîs
 *
p_SEI
 = 
p_Vid
->p_SEI;

2363 
£q_∑ømëî_£t_rb•_t
 *
a˘ive_•s
 = 
p_Vid
->active_sps;

2366 i‡–
p_I≈
->
SEIVUI32PuŒdown
 )

2368 
Êd_Êag
 = 
p_Vid
->fld_flag;

2370 
p_Vid
->
pic_°ru˘
 = 
	`gë_pic_°ru˘
–p_Vid,Ö_Vid->
‰m_no_ö_fûe
, 
Êd_Êag
, (p_Vid->
°ru˘uª
 =
TOP_FIELD
) ? 1 : 0 );

2372 i‡–
a˘ive_•s
->
vui_£q_∑ømëîs
.
pic_°ru˘_¥e£¡_Êag
 )

2374 
NumClockTS
 = 0, 
i
;

2375 
bŸtom_fõld_Êag
 = (
p_Vid
->
°ru˘uª
 =
BOTTOM_FIELD
);

2376 
p_SEI
->
£iPicTimög
.
pic_°ru˘
 = 
p_Vid
->pic_struct;

2378  
p_SEI
->
£iPicTimög
.
pic_°ru˘
 )

2383 
	`as£π
–
Êd_Êag
 =
FALSE
 );

2384 
NumClockTS
 = 1;

2388 
	`as£π
–(
p_Vid
->
Êd_Êag
 =
TRUE
Ë&& (
bŸtom_fõld_Êag
 =
FALSE
) );

2389 
NumClockTS
 = 1;

2393 
	`as£π
–(
p_Vid
->
Êd_Êag
 =
TRUE
Ë&& (
bŸtom_fõld_Êag
 == TRUE) );

2394 
NumClockTS
 = 1;

2400 
	`as£π
–
p_Vid
->
Êd_Êag
 =
FALSE
 );

2401 
NumClockTS
 = 2;

2407 
	`as£π
–
p_Vid
->
Êd_Êag
 =
FALSE
 );

2408 
NumClockTS
 = 3;

2411 
	`as£π
–(
p_Vid
->
Êd_Êag
 =
FALSE
Ë&& 
a˘ive_•s
->
vui_£q_∑ømëîs
.
fixed_‰ame_øã_Êag
 == 1 );

2412 
NumClockTS
 = 2;

2416 
	`as£π
–(
p_Vid
->
Êd_Êag
 =
FALSE
Ë&& 
a˘ive_•s
->
vui_£q_∑ømëîs
.
fixed_‰ame_øã_Êag
 == 1 );

2417 
NumClockTS
 = 3;

2420  
i
 = 0; i < 
NumClockTS
; i++ )

2422 
p_SEI
->
£iPicTimög
.
˛ock_time°amp_Êag
[
i
] = 
FALSE
;

2423 i‡–
p_SEI
->
£iPicTimög
.
˛ock_time°amp_Êag
[
i
] )

2425 
£c⁄ds
 = 0;

2426 
möuãs
 = 0;

2427 
hours
 = 0;

2428 
time_off£t_Àngth
;

2429 
	`as£π
–
£c⁄ds
 >= 0 && seconds <= 59 );

2430 
	`as£π
–
möuãs
 >= 0 && minutes <= 59 );

2431 
	`as£π
–
hours
 >= 0 && hours <= 23 );

2433 
p_SEI
->
£iPicTimög
.
˘_ty≥
 = 0;

2434 
p_SEI
->
£iPicTimög
.
nuô_fõld_ba£d_Êag
 = 
FALSE
;

2435 
p_SEI
->
£iPicTimög
.
cou¡ög_ty≥
 = 0;

2436 
p_SEI
->
£iPicTimög
.
fuŒ_time°amp_Êag
 = 
FALSE
;

2437 
p_SEI
->
£iPicTimög
.
disc⁄töuôy_Êag
 = 
FALSE
;

2438 
p_SEI
->
£iPicTimög
.
˙t_dr›≥d_Êag
 = 
FALSE
;

2439 
p_SEI
->
£iPicTimög
.
n_‰ames
 = 0;

2441 i‡–
p_SEI
->
£iPicTimög
.
fuŒ_time°amp_Êag
 )

2443 
p_SEI
->
£iPicTimög
.
£c⁄ds_vÆue
 = 
£c⁄ds
;

2444 
p_SEI
->
£iPicTimög
.
möuãs_vÆue
 = 
möuãs
;

2445 
p_SEI
->
£iPicTimög
.
hours_vÆue
 = 
hours
;

2449 
p_SEI
->
£iPicTimög
.
£c⁄ds_Êag
 = 
FALSE
;

2450 i‡(
p_SEI
->
£iPicTimög
.
£c⁄ds_Êag
)

2452 
p_SEI
->
£iPicTimög
.
£c⁄ds_vÆue
 = 
£c⁄ds
;

2453 
p_SEI
->
£iPicTimög
.
möuãs_Êag
 = 
FALSE
;

2454 i‡(
p_SEI
->
£iPicTimög
.
möuãs_Êag
)

2456 
p_SEI
->
£iPicTimög
.
möuãs_vÆue
 = 
möuãs
;

2457 
p_SEI
->
£iPicTimög
.
hours_Êag
 = 
FALSE
;

2458 i‡(
p_SEI
->
£iPicTimög
.
hours_Êag
)

2460 
p_SEI
->
£iPicTimög
.
hours_vÆue
 = 
hours
;

2465 i‡(
a˘ive_•s
->
vui_£q_∑ømëîs
.
v˛_hrd_∑ømëîs_¥e£¡_Êag
)

2466 
time_off£t_Àngth
 = 
a˘ive_•s
->
vui_£q_∑ømëîs
.
v˛_hrd_∑ømëîs
.time_offset_length;

2467 i‡(
a˘ive_•s
->
vui_£q_∑ømëîs
.
«l_hrd_∑ømëîs_¥e£¡_Êag
)

2468 
time_off£t_Àngth
 = 
a˘ive_•s
->
vui_£q_∑ømëîs
.
«l_hrd_∑ømëîs
.time_offset_length;

2470 
time_off£t_Àngth
 = 24;

2471 i‡–
time_off£t_Àngth
 )

2473 
p_SEI
->
£iPicTimög
.
time_off£t
 = 0;

2478 
p_SEI
->
£iHasPicTimög_öfo
 = 
TRUE
;

2482 
p_SEI
->
£iHasPicTimög_öfo
 = 
FALSE
;

2484 
	}
}

2492 
	$FöÆizePicTimög
(
VideoP¨amëîs
 *
p_Vid
)

2494 
SEIP¨amëîs
 *
p_SEI
 = 
p_Vid
->p_SEI;

2495 
£q_∑ømëî_£t_rb•_t
 *
a˘ive_•s
 = 
p_Vid
->active_sps;

2497 
Bô°ªam
 *
bô°ªam
 = 
p_SEI
->
£iPicTimög
.
d©a
;

2499 
Boﬁón
 
CpbDpbDñaysPª£¡Fœg
 = (BoﬁónË(
a˘ive_•s
->
vui_∑ømëîs_¥e£¡_Êag


2500 && ( (
a˘ive_•s
->
vui_£q_∑ømëîs
.
«l_hrd_∑ømëîs_¥e£¡_Êag
 != 0)

2501 ||(
a˘ive_•s
->
vui_£q_∑ømëîs
.
v˛_hrd_∑ømëîs_¥e£¡_Êag
 != 0)));

2502 
hrd_∑ømëîs_t
 *
hrd
 = 
NULL
;

2504 i‡(
a˘ive_•s
->
vui_£q_∑ømëîs
.
v˛_hrd_∑ømëîs_¥e£¡_Êag
)

2506 
hrd
 = &(
a˘ive_•s
->
vui_£q_∑ømëîs
.
v˛_hrd_∑ømëîs
);

2508 i‡(
a˘ive_•s
->
vui_£q_∑ømëîs
.
«l_hrd_∑ømëîs_¥e£¡_Êag
)

2510 
hrd
 = &(
a˘ive_•s
->
vui_£q_∑ømëîs
.
«l_hrd_∑ømëîs
);

2514 
hrd
 = 
NULL
;

2517 i‡–
CpbDpbDñaysPª£¡Fœg
 )

2519 
	`wrôe_u_v
–
hrd
->
˝b_ªmovÆ_dñay_Àngth_möus1
 + 1, "SEI: cpb_ªmovÆ_dñay", 
p_SEI
->
£iPicTimög
.
˝b_ªmovÆ_dñay
, 
bô°ªam
);

2520 
	`wrôe_u_v
–
hrd
->
dpb_ouçut_dñay_Àngth_möus1
 + 1, "SEI: dpb_ouçut_dñay", 
p_SEI
->
£iPicTimög
.
dpb_ouçut_dñay
, 
bô°ªam
);

2522 i‡–
a˘ive_•s
->
vui_£q_∑ømëîs
.
pic_°ru˘_¥e£¡_Êag
 )

2524 
NumClockTS
 = 0, 
i
;

2525 
bŸtom_fõld_Êag
 = (
p_Vid
->
°ru˘uª
 =
BOTTOM_FIELD
);

2527 
	`wrôe_u_v
–4, "SEI:Öic_°ru˘", 
p_SEI
->
£iPicTimög
.
pic_°ru˘
, 
bô°ªam
);

2529  
p_SEI
->
£iPicTimög
.
pic_°ru˘
 )

2534 
	`as£π
–
p_Vid
->
Êd_Êag
 =
FALSE
 );

2535 
NumClockTS
 = 1;

2539 
	`as£π
–(
p_Vid
->
Êd_Êag
 =
TRUE
Ë&& (
bŸtom_fõld_Êag
 =
FALSE
) );

2540 
NumClockTS
 = 1;

2544 
	`as£π
–(
p_Vid
->
Êd_Êag
 =
TRUE
Ë&& (
bŸtom_fõld_Êag
 == TRUE) );

2545 
NumClockTS
 = 1;

2551 
	`as£π
–
p_Vid
->
Êd_Êag
 =
FALSE
 );

2552 
NumClockTS
 = 2;

2558 
	`as£π
–
p_Vid
->
Êd_Êag
 =
FALSE
 );

2559 
NumClockTS
 = 3;

2563 
	`as£π
–(
p_Vid
->
Êd_Êag
 =
FALSE
Ë&& 
a˘ive_•s
->
vui_£q_∑ømëîs
.
fixed_‰ame_øã_Êag
 == 1 );

2564 
NumClockTS
 = 2;

2568 
	`as£π
–(
p_Vid
->
Êd_Êag
 =
FALSE
Ë&& 
a˘ive_•s
->
vui_£q_∑ømëîs
.
fixed_‰ame_øã_Êag
 == 1 );

2569 
NumClockTS
 = 3;

2572  
i
 = 0; i < 
NumClockTS
; i++ )

2574 
	`wrôe_u_1
–"SEI: clock_time°amp_Êag", 
p_SEI
->
£iPicTimög
.
˛ock_time°amp_Êag
[
i
], 
bô°ªam
);

2575 i‡–
p_SEI
->
£iPicTimög
.
˛ock_time°amp_Êag
[
i
] )

2577 
	`wrôe_u_v
–2, "SEI: ct_ty≥", 
p_SEI
->
£iPicTimög
.
˘_ty≥
, 
bô°ªam
);

2578 
	`wrôe_u_1
–"SEI:Çuô_fõld_ba£d_Êag", 
p_SEI
->
£iPicTimög
.
nuô_fõld_ba£d_Êag
, 
bô°ªam
);

2579 
	`wrôe_u_v
–5, "SEI: cou¡ög_ty≥", 
p_SEI
->
£iPicTimög
.
cou¡ög_ty≥
, 
bô°ªam
);

2580 
	`wrôe_u_1
–"SEI: fuŒ_time°amp_Êag", 
p_SEI
->
£iPicTimög
.
fuŒ_time°amp_Êag
, 
bô°ªam
);

2581 
	`wrôe_u_1
–"SEI: disc⁄töuôy_Êag", 
p_SEI
->
£iPicTimög
.
disc⁄töuôy_Êag
, 
bô°ªam
);

2582 
	`wrôe_u_1
–"SEI: c¡_dr›≥d_Êag", 
p_SEI
->
£iPicTimög
.
˙t_dr›≥d_Êag
, 
bô°ªam
);

2583 
	`wrôe_u_v
–8, "SEI:Ç_‰ames", 
p_SEI
->
£iPicTimög
.
n_‰ames
, 
bô°ªam
);

2585 i‡–
p_SEI
->
£iPicTimög
.
fuŒ_time°amp_Êag
 )

2587 
	`wrôe_u_v
–6, "SEI: sec⁄ds_vÆue", 
p_SEI
->
£iPicTimög
.
£c⁄ds_vÆue
, 
bô°ªam
);

2588 
	`wrôe_u_v
–6, "SEI: möuãs_vÆue", 
p_SEI
->
£iPicTimög
.
möuãs_vÆue
, 
bô°ªam
);

2589 
	`wrôe_u_v
–5, "SEI: hours_vÆue", 
p_SEI
->
£iPicTimög
.
hours_vÆue
, 
bô°ªam
);

2593 
	`wrôe_u_1
–"SEI: sec⁄ds_Êag", 
p_SEI
->
£iPicTimög
.
£c⁄ds_Êag
, 
bô°ªam
);

2594 i‡(
p_SEI
->
£iPicTimög
.
£c⁄ds_Êag
)

2596 
	`wrôe_u_v
–6, "SEI: sec⁄ds_vÆue", 
p_SEI
->
£iPicTimög
.
£c⁄ds_vÆue
, 
bô°ªam
);

2597 
	`wrôe_u_1
–"SEI: möuãs_Êag", 
p_SEI
->
£iPicTimög
.
möuãs_Êag
, 
bô°ªam
);

2598 i‡(
p_SEI
->
£iPicTimög
.
möuãs_Êag
)

2600 
	`wrôe_u_v
–6, "SEI: möuãs_vÆue", 
p_SEI
->
£iPicTimög
.
möuãs_vÆue
, 
bô°ªam
);

2601 
	`wrôe_u_1
–"SEI: hours_Êag", 
p_SEI
->
£iPicTimög
.
hours_Êag
, 
bô°ªam
);

2602 i‡(
p_SEI
->
£iPicTimög
.
hours_Êag
)

2604 
	`wrôe_u_v
–5, "SEI: hours_vÆue", 
p_SEI
->
£iPicTimög
.
hours_vÆue
, 
bô°ªam
);

2609 i‡–
hrd
 =
NULL
 )

2611 
	`wrôe_u_v
–24, "SEI:Åime_off£t", 
p_SEI
->
£iPicTimög
.
time_off£t
, 
bô°ªam
);

2615 
	`wrôe_u_v
–
hrd
->
time_off£t_Àngth
, "SEI:Åime_off£t", 
p_SEI
->
£iPicTimög
.
time_off£t
, 
bô°ªam
);

2622 i‡–
bô°ªam
->
bôs_to_go
 != 8 )

2624 (
bô°ªam
->
byã_buf
) <<= 1;

2625 
bô°ªam
->
byã_buf
 |= 1;

2626 
bô°ªam
->
bôs_to_go
--;

2627 i‡–
bô°ªam
->
bôs_to_go
 != 0 )

2628 (
bô°ªam
->
byã_buf
Ë<<(bô°ªam->
bôs_to_go
);

2629 
bô°ªam
->
bôs_to_go
 = 8;

2630 
bô°ªam
->
°ªamBuf„r
[bô°ªam->
byã_pos
++]=bô°ªam->
byã_buf
;

2631 
bô°ªam
->
byã_buf
 = 0;

2633 
p_SEI
->
£iPicTimög
.
∑ylﬂdSize
 = 
bô°ªam
->
byã_pos
;

2634 
	}
}

2642 
	$Clo£PicTimög
(
SEIP¨amëîs
 *
p_SEI
)

2644 i‡(
p_SEI
->
£iPicTimög
.
d©a
)

2646 
	`‰ì
(
p_SEI
->
£iPicTimög
.
d©a
->
°ªamBuf„r
);

2647 
	`‰ì
(
p_SEI
->
£iPicTimög
.
d©a
);

2649 
p_SEI
->
£iPicTimög
.
d©a
 = 
NULL
;

2650 
	}
}

2661 
	$InôFømePackögAº™gemít
(
VideoP¨amëîs
 *
p_Vid
)

2663 
SEIP¨amëîs
 *
p_SEI
 = 
p_Vid
->p_SEI;

2665 
p_SEI
->
£iFømePackögAº™gemít
.
d©a
 = 
	`mÆloc
–(
Bô°ªam
) );

2666 if–
p_SEI
->
£iFømePackögAº™gemít
.
d©a
 =
NULL
 )

2667 
	`no_mem_exô
("InitFramePackingArrangement: seiFramePackingArrangement.data");

2669 
p_SEI
->
£iFømePackögAº™gemít
.
d©a
->
°ªamBuf„r
 = 
	`mÆloc
(
MAXRTPPAYLOADLEN
);

2670 if–
p_SEI
->
£iFømePackögAº™gemít
.
d©a
->
°ªamBuf„r
 =
NULL
 )

2671 
	`no_mem_exô
("InitFramePackingArrangement: seiFramePackingArrangement.data->streamBuffer");

2673 
	`CÀ¨FømePackögAº™gemít
(
p_SEI
);

2674 
	}
}

2676 
	$CÀ¨FømePackögAº™gemít
(
SEIP¨amëîs
 *
p_SEI
)

2678 
	`mem£t
–
p_SEI
->
£iFømePackögAº™gemít
.
d©a
->
°ªamBuf„r
, 0, 
MAXRTPPAYLOADLEN
);

2680 
p_SEI
->
£iFømePackögAº™gemít
.
d©a
->
bôs_to_go
 = 8;

2681 
p_SEI
->
£iFømePackögAº™gemít
.
d©a
->
byã_pos
 = 0;

2682 
p_SEI
->
£iFømePackögAº™gemít
.
d©a
->
byã_buf
 = 0;

2683 
p_SEI
->
£iFømePackögAº™gemít
.
∑ylﬂdSize
 = 0;

2685 
p_SEI
->
£iFømePackögAº™gemít
.
‰ame_∑ckög_¨øngemít_id
 = 0;

2686 
p_SEI
->
£iFømePackögAº™gemít
.
‰ame_∑ckög_¨øngemít_ˇn˚l_Êag
 = 
FALSE
;

2687 
p_SEI
->
£iFømePackögAº™gemít
.
‰ame_∑ckög_¨øngemít_ty≥
 = 0;

2688 
p_SEI
->
£iFømePackögAº™gemít
.
quöcunx_ßm∂ög_Êag
 = 
FALSE
;

2689 
p_SEI
->
£iFømePackögAº™gemít
.
c⁄ã¡_öãΩªèti⁄_ty≥
 = 0;

2690 
p_SEI
->
£iFømePackögAº™gemít
.
•©ül_Êùpög_Êag
 = 
FALSE
;

2691 
p_SEI
->
£iFømePackögAº™gemít
.
‰ame0_Êù≥d_Êag
 = 
FALSE
;

2692 
p_SEI
->
£iFømePackögAº™gemít
.
fõld_võws_Êag
 = 
FALSE
;

2693 
p_SEI
->
£iFømePackögAº™gemít
.
cuºít_‰ame_is_‰ame0_Êag
 = 
FALSE
;

2694 
p_SEI
->
£iFømePackögAº™gemít
.
‰ame0_£lf_c⁄èöed_Êag
 = 
FALSE
;

2695 
p_SEI
->
£iFømePackögAº™gemít
.
‰ame1_£lf_c⁄èöed_Êag
 = 
FALSE
;

2700 
p_SEI
->
£iFømePackögAº™gemít
.
‰ame_∑ckög_¨øngemít_ª£rved_byã
 = 0;

2701 
p_SEI
->
£iFømePackögAº™gemít
.
‰ame_∑ckög_¨øngemít_ª≥tôi⁄_≥riod
 = 0;

2702 
p_SEI
->
£iFømePackögAº™gemít
.
‰ame_∑ckög_¨øngemít_exãnsi⁄_Êag
 = 
FALSE
;

2704 
p_SEI
->
£iHasFømePackögAº™gemít_öfo
 = 
FALSE
;

2705 
	}
}

2707 
	$Upd©eFømePackögAº™gemít
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

2709 
SEIP¨amëîs
 *
p_SEI
 = 
p_Vid
->p_SEI;

2711 
p_SEI
->
£iHasFømePackögAº™gemít_öfo
 = 
FALSE
;

2712 
	}
}

2714 
	$FöÆizeFømePackögAº™gemít
(
SEIP¨amëîs
 *
p_SEI
, 
I≈utP¨amëîs
 *
p_I≈
)

2716 
Bô°ªam
 *
bô°ªam
 = 
p_SEI
->
£iFømePackögAº™gemít
.
d©a
;

2718 
	`wrôe_ue_v
–"SEI: føme_∑ckög_¨øngemít_id", ()
p_SEI
->
£iFømePackögAº™gemít
.
‰ame_∑ckög_¨øngemít_id
, 
bô°ªam
 );

2719 
	`wrôe_u_1
–"SEI: føme_∑ckög_¨øngemít_ˇn˚l_Êag", ()
p_SEI
->
£iFømePackögAº™gemít
.
‰ame_∑ckög_¨øngemít_ˇn˚l_Êag
, 
bô°ªam
 );

2720 i‡–
p_SEI
->
£iFømePackögAº™gemít
.
‰ame_∑ckög_¨øngemít_ˇn˚l_Êag
 =
FALSE
 )

2722 
	`wrôe_u_v
–7, "SEI: føme_∑ckög_¨øngemít_ty≥", ()
p_SEI
->
£iFømePackögAº™gemít
.
‰ame_∑ckög_¨øngemít_ty≥
, 
bô°ªam
 );

2723 
	`wrôe_u_1
–"SEI: quöcunx_ßm∂ög_Êag", ()
p_SEI
->
£iFømePackögAº™gemít
.
quöcunx_ßm∂ög_Êag
, 
bô°ªam
 );

2724 
	`wrôe_u_v
–6, "SEI: c⁄ã¡_öãΩªèti⁄_ty≥", ()
p_SEI
->
£iFømePackögAº™gemít
.
c⁄ã¡_öãΩªèti⁄_ty≥
, 
bô°ªam
 );

2725 
	`wrôe_u_1
–"SEI: s∑tül_Êùpög_Êag", ()
p_SEI
->
£iFømePackögAº™gemít
.
•©ül_Êùpög_Êag
, 
bô°ªam
 );

2726 
	`wrôe_u_1
–"SEI: føme0_Êù≥d_Êag", ()
p_SEI
->
£iFømePackögAº™gemít
.
‰ame0_Êù≥d_Êag
, 
bô°ªam
 );

2727 
	`wrôe_u_1
–"SEI: fõld_võws_Êag", ()
p_SEI
->
£iFømePackögAº™gemít
.
fõld_võws_Êag
, 
bô°ªam
 );

2728 
	`wrôe_u_1
–"SEI: cuºít_‰ame_is_‰ame0_Êag", ()
p_SEI
->
£iFømePackögAº™gemít
.
cuºít_‰ame_is_‰ame0_Êag
, 
bô°ªam
 );

2729 
	`wrôe_u_1
–"SEI: føme0_£lf_c⁄èöed_Êag", ()
p_SEI
->
£iFømePackögAº™gemít
.
‰ame0_£lf_c⁄èöed_Êag
, 
bô°ªam
 );

2730 
	`wrôe_u_1
–"SEI: føme1_£lf_c⁄èöed_Êag", ()
p_SEI
->
£iFømePackögAº™gemít
.
‰ame1_£lf_c⁄èöed_Êag
, 
bô°ªam
 );

2731 i‡–
p_SEI
->
£iFømePackögAº™gemít
.
quöcunx_ßm∂ög_Êag
 =
FALSE
 &&Ö_SEI->£iFømePackögAº™gemít.
‰ame_∑ckög_¨øngemít_ty≥
 != 5 )

2733 
	`wrôe_u_v
–4, "SEI: føme0_grid_posôi⁄_x", ()
p_SEI
->
£iFømePackögAº™gemít
.
‰ame0_grid_posôi⁄_x
, 
bô°ªam
 );

2734 
	`wrôe_u_v
–4, "SEI: føme0_grid_posôi⁄_y", ()
p_SEI
->
£iFømePackögAº™gemít
.
‰ame0_grid_posôi⁄_y
, 
bô°ªam
 );

2735 
	`wrôe_u_v
–4, "SEI: føme1_grid_posôi⁄_x", ()
p_SEI
->
£iFømePackögAº™gemít
.
‰ame1_grid_posôi⁄_x
, 
bô°ªam
 );

2736 
	`wrôe_u_v
–4, "SEI: føme1_grid_posôi⁄_y", ()
p_SEI
->
£iFømePackögAº™gemít
.
‰ame1_grid_posôi⁄_y
, 
bô°ªam
 );

2740 
	`wrôe_u_v
–8, "SEI: føme_∑ckög_¨øngemít_ª£rved_byã", ()
p_SEI
->
£iFømePackögAº™gemít
.
‰ame_∑ckög_¨øngemít_ª£rved_byã
, 
bô°ªam
 );

2741 
	`wrôe_ue_v
–"SEI: føme_∑ckög_¨øngemít_ª≥tôi⁄_≥riod", ()
p_SEI
->
£iFømePackögAº™gemít
.
‰ame_∑ckög_¨øngemít_ª≥tôi⁄_≥riod
, 
bô°ªam
 );

2743 
	`wrôe_u_1
–"SEI: føme_∑ckög_¨øngemít_exãnsi⁄_Êag", ()
p_SEI
->
£iFømePackögAº™gemít
.
‰ame_∑ckög_¨øngemít_exãnsi⁄_Êag
, 
bô°ªam
 );

2746 i‡–
bô°ªam
->
bôs_to_go
 != 8 )

2748 (
bô°ªam
->
byã_buf
) <<= 1;

2749 
bô°ªam
->
byã_buf
 |= 1;

2750 
bô°ªam
->
bôs_to_go
--;

2751 i‡–
bô°ªam
->
bôs_to_go
 != 0 )

2752 (
bô°ªam
->
byã_buf
Ë<<(bô°ªam->
bôs_to_go
);

2753 
bô°ªam
->
bôs_to_go
 = 8;

2754 
bô°ªam
->
°ªamBuf„r
[bô°ªam->
byã_pos
++]=bô°ªam->
byã_buf
;

2755 
bô°ªam
->
byã_buf
 = 0;

2757 
p_SEI
->
£iFømePackögAº™gemít
.
∑ylﬂdSize
 = 
bô°ªam
->
byã_pos
;

2758 
	}
}

2760 
	$Clo£FømePackögAº™gemít
(
SEIP¨amëîs
 *
p_SEI
)

2762 i‡(
p_SEI
->
£iFømePackögAº™gemít
.
d©a
)

2764 
	`‰ì
(
p_SEI
->
£iFømePackögAº™gemít
.
d©a
->
°ªamBuf„r
);

2765 
	`‰ì
(
p_SEI
->
£iFømePackögAº™gemít
.
d©a
);

2767 
p_SEI
->
£iFømePackögAº™gemít
.
d©a
 = 
NULL
;

2768 
	}
}

2776 
	$InôDRPMRïëôi⁄
(
SEIP¨amëîs
 *
p_SEI
)

2778 
p_SEI
->
£iDRPMRïëôi⁄
.
d©a
 = 
	`mÆloc
–(
Bô°ªam
) );

2779 if–
p_SEI
->
£iDRPMRïëôi⁄
.
d©a
 =
NULL
 )

2780 
	`no_mem_exô
("InitDRPMRepetition:Ö_SEI->seiDRPMRepetition.data");

2782 
p_SEI
->
£iDRPMRïëôi⁄
.
d©a
->
°ªamBuf„r
 = 
	`mÆloc
(
MAXRTPPAYLOADLEN
);

2783 if–
p_SEI
->
£iDRPMRïëôi⁄
.
d©a
->
°ªamBuf„r
 =
NULL
 )

2784 
	`no_mem_exô
("InitDRPMRepetition:Ö_SEI->seiDRPMRepetition.data->streamBuffer");

2786 
	`CÀ¨DRPMRïëôi⁄
(
p_SEI
);

2787 
	}
}

2795 
	$CÀ¨DRPMRïëôi⁄
(
SEIP¨amëîs
 *
p_SEI
)

2797 
	`mem£t
–
p_SEI
->
£iDRPMRïëôi⁄
.
d©a
->
°ªamBuf„r
, 0, 
MAXRTPPAYLOADLEN
);

2799 
p_SEI
->
£iDRPMRïëôi⁄
.
d©a
->
bôs_to_go
 = 8;

2800 
p_SEI
->
£iDRPMRïëôi⁄
.
d©a
->
byã_pos
 = 0;

2801 
p_SEI
->
£iDRPMRïëôi⁄
.
d©a
->
byã_buf
 = 0;

2802 
p_SEI
->
£iDRPMRïëôi⁄
.
∑ylﬂdSize
 = 0;

2804 
p_SEI
->
£iDRPMRïëôi⁄
.
‹igöÆ_bŸtom_fõld_Êag
 = 
FALSE
;

2805 
p_SEI
->
£iDRPMRïëôi⁄
.
‹igöÆ_fõld_pic_Êag
 = 
FALSE
;

2806 
p_SEI
->
£iDRPMRïëôi⁄
.
‹igöÆ_‰ame_num
 = 0;

2807 
p_SEI
->
£iDRPMRïëôi⁄
.
‹igöÆ_idr_Êag
 = 
FALSE
;

2808 i‡–
p_SEI
->
£iDRPMRïëôi⁄
.
dec_ªf_pic_m¨kög_buf„r_ßved
 !
NULL
 )

2810 
	`‰ì_dΩm_buf„r
–
p_SEI
->
£iDRPMRïëôi⁄
.
dec_ªf_pic_m¨kög_buf„r_ßved
 );

2811 
p_SEI
->
£iDRPMRïëôi⁄
.
dec_ªf_pic_m¨kög_buf„r_ßved
 = 
NULL
;

2814 
p_SEI
->
£iHasDRPMRïëôi⁄_öfo
 = 
FALSE
;

2815 
	}
}

2823 
	$Upd©eDRPMRïëôi⁄
(
SEIP¨amëîs
 *
p_SEI
)

2825 i‡–
p_SEI
->
£iDRPMRïëôi⁄
.
dec_ªf_pic_m¨kög_buf„r_ßved
 !
NULL
 )

2827 
p_SEI
->
£iHasDRPMRïëôi⁄_öfo
 = 
TRUE
;

2831 
p_SEI
->
£iHasDRPMRïëôi⁄_öfo
 = 
FALSE
;

2833 
	}
}

2841 
	$FöÆizeDRPMRïëôi⁄
(
VideoP¨amëîs
 *
p_Vid
)

2843 
SEIP¨amëîs
 *
p_SEI
 = 
p_Vid
->p_SEI;

2844 
£q_∑ømëî_£t_rb•_t
 *
a˘ive_•s
 = 
p_Vid
->active_sps;

2846 
Bô°ªam
 *
bô°ªam
 = 
p_SEI
->
£iDRPMRïëôi⁄
.
d©a
;

2849 
	`wrôe_u_1
–"SEI: origöÆ_idr_Êag", 
p_SEI
->
£iDRPMRïëôi⁄
.
‹igöÆ_idr_Êag
, 
bô°ªam
);

2850 
	`wrôe_ue_v
–"SEI: origöÆ_‰ame_num", 
p_SEI
->
£iDRPMRïëôi⁄
.
‹igöÆ_‰ame_num
, 
bô°ªam
);

2851 i‡–!
a˘ive_•s
->
‰ame_mbs_⁄ly_Êag
 )

2853 
	`wrôe_u_1
–"SEI: origöÆ_fõld_pic_Êag", 
p_SEI
->
£iDRPMRïëôi⁄
.
‹igöÆ_fõld_pic_Êag
, 
bô°ªam
);

2854 i‡–
p_SEI
->
£iDRPMRïëôi⁄
.
‹igöÆ_fõld_pic_Êag
 )

2856 
	`wrôe_u_1
–"SEI: origöÆ_bŸtom_fõld_Êag", 
p_SEI
->
£iDRPMRïëôi⁄
.
‹igöÆ_bŸtom_fõld_Êag
, 
bô°ªam
);

2860 
	`dec_ªf_pic_m¨kög
–
bô°ªam
,

2861 
p_SEI
->
£iDRPMRïëôi⁄
.
dec_ªf_pic_m¨kög_buf„r_ßved
,

2862 
p_SEI
->
£iDRPMRïëôi⁄
.
‹igöÆ_idr_Êag
, 0, 0);

2865 i‡–
bô°ªam
->
bôs_to_go
 != 8 )

2867 (
bô°ªam
->
byã_buf
) <<= 1;

2868 
bô°ªam
->
byã_buf
 |= 1;

2869 
bô°ªam
->
bôs_to_go
--;

2870 i‡–
bô°ªam
->
bôs_to_go
 != 0 )

2871 (
bô°ªam
->
byã_buf
Ë<<(bô°ªam->
bôs_to_go
);

2872 
bô°ªam
->
bôs_to_go
 = 8;

2873 
bô°ªam
->
°ªamBuf„r
[bô°ªam->
byã_pos
++]=bô°ªam->
byã_buf
;

2874 
bô°ªam
->
byã_buf
 = 0;

2876 
p_SEI
->
£iDRPMRïëôi⁄
.
∑ylﬂdSize
 = 
bô°ªam
->
byã_pos
;

2877 
	}
}

2885 
	$Clo£DRPMRïëôi⁄
(
SEIP¨amëîs
 *
p_SEI
)

2887 i‡(
p_SEI
->
£iDRPMRïëôi⁄
.
d©a
)

2889 
	`‰ì
(
p_SEI
->
£iDRPMRïëôi⁄
.
d©a
->
°ªamBuf„r
);

2890 
	`‰ì
(
p_SEI
->
£iDRPMRïëôi⁄
.
d©a
);

2892 
p_SEI
->
£iDRPMRïëôi⁄
.
d©a
 = 
NULL
;

2893 i‡–
p_SEI
->
£iDRPMRïëôi⁄
.
dec_ªf_pic_m¨kög_buf„r_ßved
 !
NULL
 )

2895 
	`‰ì_dΩm_buf„r
–
p_SEI
->
£iDRPMRïëôi⁄
.
dec_ªf_pic_m¨kög_buf„r_ßved
 );

2896 
p_SEI
->
£iDRPMRïëôi⁄
.
dec_ªf_pic_m¨kög_buf„r_ßved
 = 
NULL
;

2898 
	}
}

2911 
	$Pª∑ªAggªg©i⁄SEIMesßge
(
VideoP¨amëîs
 *
p_Vid
)

2913 
SEIP¨amëîs
 *
p_SEI
 = 
p_Vid
->p_SEI;

2914 
Boﬁón
 
has_aggªg©i⁄_£i_mesßge
 = 
FALSE
;

2916 
	`˛ór_£i_mesßge
(
p_SEI
, 
AGGREGATION_SEI
);

2920 i‡(
p_SEI
->
£iHasS∑ªPi˘uª
 && 
p_Vid
->
ty≥
 !
B_SLICE
)

2922 
	`FöÆizeS∑ªMBM≠
(
p_Vid
);

2923 
	`as£π
(
p_SEI
->
£iS∑ªPi˘uªPaylﬂd
.
d©a
->
byã_pos
 =p_SEI->£iS∑ªPi˘uªPaylﬂd.
∑ylﬂdSize
);

2924 
	`wrôe_£i_mesßge
(
p_SEI
, 
AGGREGATION_SEI
,Ö_SEI->
£iS∑ªPi˘uªPaylﬂd
.
d©a
->
°ªamBuf„r
,Ö_SEI->£iS∑ªPi˘uªPaylﬂd.
∑ylﬂdSize
, 
SEI_SPARE_PIC
);

2925 
has_aggªg©i⁄_£i_mesßge
 = 
TRUE
;

2928 i‡(
p_SEI
->
£iHasSub£qInfo
)

2930 
	`FöÆizeSub£qInfo
(
p_SEI
, 
p_Vid
->
œyî
);

2931 
	`wrôe_£i_mesßge
(
p_SEI
, 
AGGREGATION_SEI
,Ö_SEI->
£iSub£qInfo
[
p_Vid
->
œyî
].
d©a
->
°ªamBuf„r
,Ö_SEI->£iSub£qInfo[p_Vid->œyî].
∑ylﬂdSize
, 
SEI_SUB_SEQ_INFO
);

2932 
	`CÀ¨Sub£qInfoPaylﬂd
(
p_SEI
, 
p_Vid
->
œyî
);

2933 
has_aggªg©i⁄_£i_mesßge
 = 
TRUE
;

2936 i‡(
p_SEI
->
£iHasSub£qLayîInfo
 && 
p_Vid
->
numbî
 == 0)

2938 
	`FöÆizeSub£qLayîInfo
(
p_SEI
);

2939 
	`wrôe_£i_mesßge
(
p_SEI
, 
AGGREGATION_SEI
,Ö_SEI->
£iSub£qLayîInfo
.
d©a
,Ö_SEI->£iSub£qLayîInfo.
∑ylﬂdSize
, 
SEI_SUB_SEQ_LAYER_CHARACTERISTICS
);

2940 
p_SEI
->
£iHasSub£qLayîInfo
 = 
FALSE
;

2941 
has_aggªg©i⁄_£i_mesßge
 = 
TRUE
;

2944 i‡(
p_SEI
->
£iHasSub£qCh¨
)

2946 
	`FöÆizeSub£qCh¨
(
p_SEI
);

2947 
	`wrôe_£i_mesßge
(
p_SEI
, 
AGGREGATION_SEI
,Ö_SEI->
£iSub£qCh¨
.
d©a
->
°ªamBuf„r
,Ö_SEI->£iSub£qCh¨.
∑ylﬂdSize
, 
SEI_SUB_SEQ_CHARACTERISTICS
);

2948 
	`CÀ¨Sub£qCh¨Paylﬂd
(
p_SEI
);

2949 
has_aggªg©i⁄_£i_mesßge
 = 
TRUE
;

2952 i‡(
p_SEI
->
£iHasP™SˇnRe˘Info
)

2954 
	`FöÆizeP™SˇnRe˘Info
(
p_SEI
);

2955 
	`wrôe_£i_mesßge
(
p_SEI
, 
AGGREGATION_SEI
,Ö_SEI->
£iP™SˇnRe˘Info
.
d©a
->
°ªamBuf„r
,Ö_SEI->£iP™SˇnRe˘Info.
∑ylﬂdSize
, 
SEI_PAN_SCAN_RECT
);

2956 
	`CÀ¨P™SˇnRe˘InfoPaylﬂd
(
p_SEI
);

2957 
has_aggªg©i⁄_£i_mesßge
 = 
TRUE
;

2960 i‡(
p_SEI
->
£iHasU£r_d©a_uƒegi°îed_öfo
)

2962 
	`FöÆizeU£r_d©a_uƒegi°îed
(
p_SEI
);

2963 
	`wrôe_£i_mesßge
(
p_SEI
, 
AGGREGATION_SEI
,Ö_SEI->
£iU£r_d©a_uƒegi°îed
.
d©a
->
°ªamBuf„r
,Ö_SEI->£iU£r_d©a_uƒegi°îed.
∑ylﬂdSize
, 
SEI_USER_DATA_UNREGISTERED
);

2964 
	`CÀ¨U£r_d©a_uƒegi°îed
(
p_SEI
);

2965 
has_aggªg©i⁄_£i_mesßge
 = 
TRUE
;

2968 i‡(
p_SEI
->
£iHasU£r_d©a_ªgi°îed_ôu_t_t35_öfo
)

2970 
	`FöÆizeU£r_d©a_ªgi°îed_ôu_t_t35
(
p_SEI
);

2971 
	`wrôe_£i_mesßge
(
p_SEI
, 
AGGREGATION_SEI
,Ö_SEI->
£iU£r_d©a_ªgi°îed_ôu_t_t35
.
d©a
->
°ªamBuf„r
,Ö_SEI->£iU£r_d©a_ªgi°îed_ôu_t_t35.
∑ylﬂdSize
, 
SEI_USER_DATA_REGISTERED_ITU_T_T35
);

2972 
	`CÀ¨U£r_d©a_ªgi°îed_ôu_t_t35
(
p_SEI
);

2973 
has_aggªg©i⁄_£i_mesßge
 = 
TRUE
;

2978 i‡(
p_SEI
->
£iHasS˚√Inf‹m©i⁄
)

2980 
	`FöÆizeS˚√Inf‹m©i⁄
(
p_SEI
);

2981 
	`wrôe_£i_mesßge
(
p_SEI
, 
AGGREGATION_SEI
,Ö_SEI->
£iS˚√Inf‹m©i⁄
.
d©a
->
°ªamBuf„r
,Ö_SEI->£iS˚√Inf‹m©i⁄.
∑ylﬂdSize
, 
SEI_SCENE_INFO
);

2982 
has_aggªg©i⁄_£i_mesßge
 = 
TRUE
;

2985 i‡(
p_SEI
->
£iHasT⁄e_m≠pög
)

2987 
	`FöÆizeT⁄eM≠pög
(
p_Vid
);

2988 
	`wrôe_£i_mesßge
(
p_SEI
, 
AGGREGATION_SEI
,Ö_SEI->
£iT⁄eM≠pög
.
d©a
->
°ªamBuf„r
,Ö_SEI->£iT⁄eM≠pög.
∑ylﬂdSize
, 
SEI_TONE_MAPPING
);

2989 
	`CÀ¨T⁄eM≠pög
(
p_SEI
);

2990 
has_aggªg©i⁄_£i_mesßge
 = 
TRUE
;

2993 i‡(
p_SEI
->
£iHasPo°FûãrHöts_öfo
)

2995 
	`FöÆizePo°FûãrHöts
(
p_SEI
);

2996 
	`wrôe_£i_mesßge
(
p_SEI
, 
AGGREGATION_SEI
,Ö_SEI->
£iPo°FûãrHöts
.
d©a
->
°ªamBuf„r
,Ö_SEI->£iPo°FûãrHöts.
∑ylﬂdSize
, 
SEI_POST_FILTER_HINTS
);

2997 
has_aggªg©i⁄_£i_mesßge
 = 
TRUE
;

3000 i‡(
p_SEI
->
£iHasBuf„rögPîiod_öfo
)

3002 
	`FöÆizeBuf„rögPîiod
(
p_SEI
, 
p_Vid
->
a˘ive_•s
);

3003 
	`wrôe_£i_mesßge
(
p_SEI
, 
AGGREGATION_SEI
,Ö_SEI->
£iBuf„rögPîiod
.
d©a
->
°ªamBuf„r
,Ö_SEI->£iBuf„rögPîiod.
∑ylﬂdSize
, 
SEI_BUFFERING_PERIOD
);

3004 
has_aggªg©i⁄_£i_mesßge
 = 
TRUE
;

3007 i‡(
p_SEI
->
£iHasPicTimög_öfo
)

3009 
	`FöÆizePicTimög
(
p_Vid
);

3010 
	`wrôe_£i_mesßge
(
p_SEI
, 
AGGREGATION_SEI
,Ö_SEI->
£iPicTimög
.
d©a
->
°ªamBuf„r
,Ö_SEI->£iPicTimög.
∑ylﬂdSize
, 
SEI_PIC_TIMING
);

3011 
has_aggªg©i⁄_£i_mesßge
 = 
TRUE
;

3014 i‡(
p_SEI
->
£iHasRecovîyPoöt_öfo
)

3016 
	`FöÆizeR™domAc˚ss
(
p_SEI
);

3017 
	`wrôe_£i_mesßge
(
p_SEI
, 
AGGREGATION_SEI
,Ö_SEI->
£iRecovîyPoöt
.
d©a
->
°ªamBuf„r
,Ö_SEI->£iRecovîyPoöt.
∑ylﬂdSize
, 
SEI_RECOVERY_POINT
);

3018 
	`CÀ¨R™domAc˚ss
(
p_SEI
);

3019 
has_aggªg©i⁄_£i_mesßge
 = 
TRUE
;

3022 i‡(
p_SEI
->
£iHasDRPMRïëôi⁄_öfo
)

3024 
	`FöÆizeDRPMRïëôi⁄
(
p_Vid
);

3025 
	`wrôe_£i_mesßge
(
p_SEI
, 
AGGREGATION_SEI
,Ö_SEI->
£iDRPMRïëôi⁄
.
d©a
->
°ªamBuf„r
,Ö_SEI->£iDRPMRïëôi⁄.
∑ylﬂdSize
, 
SEI_DEC_REF_PIC_MARKING_REPETITION
);

3026 
has_aggªg©i⁄_£i_mesßge
 = 
TRUE
;

3027 
	`CÀ¨DRPMRïëôi⁄
(
p_SEI
);

3030 i‡(
p_SEI
->
£iHasFømePackögAº™gemít_öfo
)

3032 
	`FöÆizeFømePackögAº™gemít
(
p_SEI
, 
p_Vid
->
p_I≈
);

3033 
	`wrôe_£i_mesßge
(
p_SEI
, 
AGGREGATION_SEI
,Ö_SEI->
£iFømePackögAº™gemít
.
d©a
->
°ªamBuf„r
,Ö_SEI->£iFømePackögAº™gemít.
∑ylﬂdSize
, 
SEI_FRAME_PACKING_ARRANGEMENT
);

3034 
has_aggªg©i⁄_£i_mesßge
 = 
TRUE
;

3038 i‡(
has_aggªg©i⁄_£i_mesßge
)

3040 
	`föÆize_£i_mesßge
(
p_SEI
, 
AGGREGATION_SEI
);

3042 
	}
}

3050 
	$‰ì_dΩm_buf„r
–
DecRefPicM¨kög_t
 *
pDRPM
 )

3052 
DecRefPicM¨kög_t
 *
pTmp
 = 
pDRPM
, *
pPªv
;

3054 i‡(
pTmp
 =
NULL
)

3057  
pTmp
->
Next
 !
NULL
 )

3059 
pPªv
 = 
pTmp
;

3060 
pTmp
 =ÖTmp->
Next
;

3061 
	`‰ì
–
pPªv
 );

3063 
	`‰ì
–
pTmp
 );

3064 
	}
}

	@lencod/src/slice.c

18 
	~"c⁄åibut‹s.h
"

20 
	~<m©h.h
>

21 
	~<Êﬂt.h
>

23 
	~"globÆ.h
"

24 
	~"hódî.h
"

25 
	~"«l.h
"

26 
	~"πp.h
"

27 
	~"fmo.h
"

28 
	~"vlc.h
"

29 
	~"image.h
"

30 
	~"ˇbac.h
"

31 
	~"bürõncode.h
"

32 
	~"ñemíts.h
"

33 
	~"ma¸oblock.h
"

34 
	~"memÆloc.h
"

35 
	~"mode_decisi⁄_p8x8.h
"

36 
	~"symbﬁ.h
"

37 
	~"c⁄ãxt_öi.h
"

38 
	~"íc_°©i°ics.h
"

39 
	~"øã˘l.h
"

40 
	~"me_ïzs.h
"

41 
	~"me_ïzs_öt.h
"

42 
	~"wp.h
"

43 
	~"¶i˚.h
"

44 
	~"rdoq.h
"

45 
	~"wp_m˝ªc.h
"

46 
	~"q_off£ts.h
"

47 
	~"c⁄f‹m™˚.h
"

48 
	~"li°_ª‹dî.h
"

49 
	~"md_comm⁄.h
"

50 
	~"mmco.h
"

51 
	~"mv_£¨ch.h
"

52 
	~"qu™t4x4.h
"

53 
	~"qu™t8x8.h
"

54 
	~"qu™tChroma.h
"

55 
	~"rd›t.h
"

56 
	~"rd›t_codög_°©e.h
"

57 
	~"œmbda.h
"

58 
	~"öåa4x4.h
"

59 
	~"öåa8x8.h
"

60 
	~"öåa16x16.h
"

61 
	~"mc_¥edi˘i⁄.h
"

62 
	~"rd_öåa_jm.h
"

63 
	~"rd_öåa_jm444.h
"

66 
Sli˚
 *
mÆloc_¶i˚
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
);

67 
Sli˚
 *
mÆloc_¶i˚_lôe
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
);

69 
	$Æloˇã_block_mem
(
Sli˚
 *
cuºSli˚
)

71 
Æloc_size
 = 0;

72 
Æloc_size
 +
	`gë_mem2Döt
(&
cuºSli˚
->
tblk4x4
, 
BLOCK_SIZE
, BLOCK_SIZE);

73 
Æloc_size
 +
	`gë_mem2Döt
(&
cuºSli˚
->
tblk16x16
, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE);

74 
Æloc_size
 +
	`gë_mem4Döt
(&
cuºSli˚
->
i16blk4x4
, 
BLOCK_SIZE
, BLOCK_SIZE, BLOCK_SIZE, BLOCK_SIZE);

76  (
Æloc_size
);

77 
	}
}

80 
	$‰ì_block_mem
(
Sli˚
 *
cuºSli˚
)

82 if(
cuºSli˚
->
i16blk4x4
)

83 
	`‰ì_mem4Döt
(
cuºSli˚
->
i16blk4x4
);

84 if(
cuºSli˚
->
tblk16x16
)

85 
	`‰ì_mem2Döt
(
cuºSli˚
->
tblk16x16
);

86 if(
cuºSli˚
->
tblk4x4
)

87 
	`‰ì_mem2Döt
(
cuºSli˚
->
tblk4x4
);

88 
	}
}

102 
	$CAVLC_öô
(
Sli˚
 *
cuºSli˚
)

104 
	`mem£t
(&
cuºSli˚
->
p_Vid
->
nz_c€ff
[0][0][0], 0, cuºSli˚->
PicSizeInMbs
 * 4 * (4 + cuºSli˚->
num_blk8x8_uv
)* ());

105 
	}
}

107 
	$Æloc_rdd©a
(
Sli˚
 *
cuºSli˚
, 
RD_DATA
 *
rd_d©a
)

109 
Æloc_size
 = 0;

111 
Æloc_size
 +
	`gë_mem3D≥l
(&(
rd_d©a
->
ªc_mb
), 3, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE);

113 
Æloc_size
 +
	`gë_mem_ACc€ff
 (
cuºSli˚
->
p_Vid
, &(
rd_d©a
->
cofAC
));

114 
Æloc_size
 +
	`gë_mem_DCc€ff
 (&(
rd_d©a
->
cofDC
));

116 i‡((
cuºSli˚
->
¶i˚_ty≥
 !
I_SLICE
Ë&& cuºSli˚->¶i˚_ty≥ !
SI_SLICE
)

118 
Æloc_size
 +
	`gë_mem5Dmv
 (&(
rd_d©a
->
Æl_mv
), 2, 
cuºSli˚
->
max_num_ª„ªn˚s
, 9, 4, 4);

122 
Æloc_size
 +
	`gë_mem2D
((
byã
***)&(
rd_d©a
->
ùªdmode
), 
cuºSli˚
->
height_blk
, cuºSli˚->
width_blk
);

123 
Æloc_size
 +
	`gë_mem3D
((
byã
****)&(
rd_d©a
->
ªÁr
), 2, 4, 4);

125  
Æloc_size
;

126 
	}
}

129 
	$nuŒify_rdd©a
(
RD_DATA
 *
rd_d©a
)

131 
rd_d©a
->
ªc_mb
 = 
NULL
;

133 
rd_d©a
->
cofAC
 = 
NULL
;

134 
rd_d©a
->
cofDC
 = 
NULL
;

135 
rd_d©a
->
Æl_mv
 = 
NULL
;

137 
rd_d©a
->
ùªdmode
 = 
NULL
;

138 
rd_d©a
->
ªÁr
 = 
NULL
;

140 
rd_d©a
->
Æl_mv
 = 
NULL
;

141 
rd_d©a
->
bùªd_mv
 = 
NULL
;

142 
	}
}

144 
	$‰ì_rdd©a
(
Sli˚
 *
cuºSli˚
, 
RD_DATA
 *
rd_d©a
)

146 if(
rd_d©a
->
ªÁr
)

147 
	`‰ì_mem3D
((
byã
***Ë
rd_d©a
->
ªÁr
);

148 if(
rd_d©a
->
ùªdmode
)

149 
	`‰ì_mem2D
((
byã
**Ë
rd_d©a
->
ùªdmode
);

151 i‡((
cuºSli˚
->
¶i˚_ty≥
 !
I_SLICE
Ë&& cuºSli˚->¶i˚_ty≥ !
SI_SLICE
)

153 if(
rd_d©a
->
Æl_mv
)

154 
	`‰ì_mem5Dmv
 (
rd_d©a
->
Æl_mv
);

157 if(
rd_d©a
->
cofDC
)

158 
	`‰ì_mem_DCc€ff
 (
rd_d©a
->
cofDC
);

159 if(
rd_d©a
->
cofAC
)

160 
	`‰ì_mem_ACc€ff
 (
rd_d©a
->
cofAC
);

162 if(
rd_d©a
->
ªc_mb
)

163 
	`‰ì_mem3D≥l
(
rd_d©a
->
ªc_mb
);

164 
	}
}

180 
	$°¨t_¶i˚
(
Sli˚
 *
cuºSli˚
, 
SètP¨amëîs
 *
cur_°©s
)

182 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

183 
EncodögEnvú⁄mítPå
 
ìp
;

184 
Bô°ªam
 *
cuºSåóm
;

185 
hódî_Àn
 = 0;

186 
i
;

187 
NumbîOfP¨tôi⁄s
 = (
cuºSli˚
->
∑πôi⁄_mode
 =
PAR_DP_1
?1:3);

190 if(
cuºSli˚
->
idr_Êag
)

192 
NumbîOfP¨tôi⁄s
 = 1;

195 
	`RTPUpd©eTime°amp
 (
p_Vid
, 
cuºSli˚
->
‰ame_no
);

197 
i
 = 0; i < 
NumbîOfP¨tôi⁄s
; i++)

199 
cuºSåóm
 = (
cuºSli˚
->
∑πAº
[
i
]).
bô°ªam
;

201 
cuºSåóm
->
wrôe_Êag
 = 0;

202 i‡(
i
==0)

203 
hódî_Àn
 +
	`Sli˚Hódî
 (
cuºSli˚
);

205 
hódî_Àn
 +
	`P¨tôi⁄_BC_Hódî
(
cuºSli˚
, 
i
);

208 i‡(
cuºSli˚
->
symbﬁ_mode
 =
CABAC
)

210 
ìp
 = &((
cuºSli˚
->
∑πAº
[
i
]).
ì_ˇbac
);

211 i‡(
cuºSåóm
->
bôs_to_go
 != 8)

212 
hódî_Àn
 +
cuºSåóm
->
bôs_to_go
;

213 
	`wrôeVlcByãAlign
(
p_Vid
, 
cuºSåóm
, 
cur_°©s
);

215 
ìp
->
p_Vid
 =Ö_Vid;

216 
	`¨õnco_°¨t_ícodög
(
ìp
, 
cuºSåóm
->
°ªamBuf„r
, &(cuºSåóm->
byã_pos
));

218 
	`¨õnco_ª£t_EC
(
ìp
);

223 
	`CAVLC_öô
(
cuºSli˚
);

227 if(
cuºSli˚
->
symbﬁ_mode
 =
CABAC
)

229 
	`öô_c⁄ãxts
(
cuºSli˚
);

232 #i‡
MVC_EXTENSION_ENABLE


233 if(
p_Vid
->
p_I≈
->
num_of_võws
 > 1 &&Ö_Vid->
võw_id
 =1 && 
cuºSli˚
->
«l_ª„ªn˚_idc
 && cuºSli˚->
¶i˚_ƒ
==0)

235 
i
=0; i<
cuºSli˚
->
li°Xsize
[0]; i++)

237 if(
cuºSli˚
->
li°X
[0][
i
]->
võw_id
 == 0)

240 if(
i
<
cuºSli˚
->
li°Xsize
[0])

241 
p_Vid
->
íc_pi˘uª
->
ªf_pic_«
[0] = 
i
;

242 
i
=0; i<
cuºSli˚
->
li°Xsize
[1]; i++)

244 if(
cuºSli˚
->
li°X
[1][
i
]->
võw_id
 == 0)

247 if(
i
<
cuºSli˚
->
li°Xsize
[1])

248 
p_Vid
->
íc_pi˘uª
->
ªf_pic_«
[1] = 
i
;

251  
hódî_Àn
;

252 
	}
}

261 
	$¸óã_¶i˚_«lus
(
Sli˚
 *
cuºSli˚
, 
is_bŸtom
)

265 
buf„r_size
 = 
cuºSli˚
->
∑πAº
[0].
bô°ªam
->buffer_size;

266 #i‡(
MVC_EXTENSION_ENABLE
)

267 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

271 
∑π
;

272 
NALU_t
 *
«lu
;

274 
∑π
=0;Ö¨t< 
cuºSli˚
->
max_∑π_ƒ
;Öart++)

276 i‡(
cuºSli˚
->
∑πAº
[
∑π
].
bô°ªam
->
wrôe_Êag
)

278 
«lu
 = 
	`AŒocNALU
(
buf„r_size
);

279 
cuºSli˚
->
∑πAº
[
∑π
].
«l_unô
 = 
«lu
;

280 
«lu
->
°¨tcodïªfix_Àn
 = 1+ (
cuºSli˚
->
°¨t_mb_ƒ
 =0 && 
∑π
 =0 ?
ZEROBYTES_SHORTSTARTCODE
+1:ZEROBYTES_SHORTSTARTCODE);

281 
«lu
->
f‹biddí_bô
 = 0;

283 #i‡(
MVC_EXTENSION_ENABLE
)

284 if(
p_Vid
->
num_of_œyîs
 == 2)

286 
«lu
->
¥i‹ôy_id
 = 
p_Vid
->priority_id;

287 
«lu
->
võw_id
 = 
p_Vid
->
dpb_œyî_id
;

288 
«lu
->
ãmp‹Æ_id
 = 
p_Vid
->temporal_id;

289 
«lu
->
™ch‹_pic_Êag
 = 
p_Vid
->™ch‹_pic_Êag[
is_bŸtom
];

290 
«lu
->
öãr_võw_Êag
 = 
p_Vid
->öãr_võw_Êag[
is_bŸtom
];

291 
«lu
->
n⁄_idr_Êag
 = !«lu->
™ch‹_pic_Êag
;

292 
«lu
->
ª£rved_⁄e_bô
 = 1;

296 i‡(
cuºSli˚
->
idr_Êag
)

298 
«lu
->
«l_unô_ty≥
 = 
NALU_TYPE_IDR
;

299 
«lu
->
«l_ª„ªn˚_idc
 = 
NALU_PRIORITY_HIGHEST
;

304 if(
cuºSli˚
->
∑πôi⁄_mode
 == 0)

306 #i‡(
MVC_EXTENSION_ENABLE
)

307 if(
p_Vid
->
num_of_œyîs
 == 2)

309 
«lu
->
«l_unô_ty≥
 = 
p_Vid
->
dpb_œyî_id
 ==0 ? 
NALU_TYPE_SLICE
 : 
NALU_TYPE_SLC_EXT
;

312 
«lu
->
«l_unô_ty≥
 = 
NALU_TYPE_SLICE
;

314 
«lu
->
«l_unô_ty≥
 = 
NALU_TYPE_SLICE
;

319 
«lu
->
«l_unô_ty≥
 = (
NÆuTy≥
Ë(
NALU_TYPE_DPA
 + 
∑π
);

322 i‡(
cuºSli˚
->
«l_ª„ªn˚_idc
 !=0)

324 
«lu
->
«l_ª„ªn˚_idc
 = 
NALU_PRIORITY_HIGH
;

328 
«lu
->
«l_ª„ªn˚_idc
 = 
NALU_PRIORITY_DISPOSABLE
;

334 
cuºSli˚
->
∑πAº
[
∑π
].
«l_unô
 = 
NULL
;

337 
	}
}

350 
	$ãrmö©e_¶i˚
(
Ma¸oblock
 *
cuºMB
, 
œ°¶i˚
, 
SètP¨amëîs
 *
cur_°©s
 )

352 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

353 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

355 
Bô°ªam
 *
cuºSåóm
;

356 
NALU_t
 *
cuºNÆu
;

357 
EncodögEnvú⁄mítPå
 
ìp
;

358 
∑π
;

359 
tmp_°uffögbôs
 = 
cuºMB
->
bôs
.
mb_°uffög
;

361 i‡(
cuºSli˚
->
symbﬁ_mode
 =
CABAC
)

362 
	`wrôe_ãrmö©ög_bô
 (
cuºSli˚
, 1);

364 
	`¸óã_¶i˚_«lus
(
cuºSli˚
, 
p_Vid
->
°ru˘uª
 =
BOTTOM_FIELD
 ? 1 : 0);

366 
∑π
 = 0;Ö¨à< 
cuºSli˚
->
max_∑π_ƒ
;Öart++)

368 
cuºSåóm
 = (
cuºSli˚
->
∑πAº
[
∑π
]).
bô°ªam
;

369 
cuºNÆu
 = (
cuºSli˚
->
∑πAº
[
∑π
]).
«l_unô
;

370 i‡(
cuºSåóm
->
wrôe_Êag
)

372 i‡(
cuºSli˚
->
symbﬁ_mode
 =
CAVLC
)

374 
	`SODBtoRBSP
(
cuºSåóm
);

375 
cuºNÆu
->
Àn
 = 
	`RBSPtoEBSP
(cuºNÆu->
buf
, 
cuºSåóm
->
°ªamBuf„r
, cuºSåóm->
byã_pos
);

379 
ìp
 = &((
cuºSli˚
->
∑πAº
[
∑π
]).
ì_ˇbac
);

381 
	`¨õnco_d⁄e_ícodög
(
cuºMB
, 
ìp
);

382 
	`£t_pic_bö_cou¡
(
p_Vid
, 
ìp
);

384 
cuºSåóm
->
bôs_to_go
 = 
ìp
->
Ebôs_to_go
;

385 
cuºSåóm
->
byã_buf
 = 0;

387 
cuºNÆu
->
Àn
 = 
	`RBSPtoEBSP
(cuºNÆu->
buf
, 
cuºSåóm
->
°ªamBuf„r
, cuºSåóm->
byã_pos
);

390 
p_Vid
->
byãs_ö_pi˘uª
 +
cuºNÆu
->
Àn
 + 1;

392 i‡(
œ°¶i˚
 && (
∑π
==(
cuºSli˚
->
max_∑π_ƒ
 - 1)))

394 
	`addCabacZîoW‹ds
(
p_Vid
, 
cuºNÆu
, 
cur_°©s
);

400 if–
cuºSli˚
->
symbﬁ_mode
 =
CABAC
 )

402 
	`°‹e_c⁄ãxts
(
cuºSli˚
);

405 
cur_°©s
->
bô_u£_°uffög_bôs
[
cuºSli˚
->
¶i˚_ty≥
] +
cuºMB
->
bôs
.
mb_°uffög
 - 
tmp_°uffögbôs
;

408 
	}
}

410 
	$öô_bùªd_íabÀd
(
VideoP¨amëîs
 *
p_Vid
)

412 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

413 
mode
;

415 
	`mem£t
(
p_Vid
->
bùªd_íabÀd
, 0, ()*
MAXMODE
);

416 i‡(
p_Vid
->
cuºítSli˚
->
¶i˚_ty≥
 !
B_SLICE
 || !
p_I≈
->
BiPªdMŸi⁄E°im©i⁄
)

419 
mode
 = 1; mode < 5; mode++)

420 
p_Vid
->
bùªd_íabÀd
[
mode
] = (
p_I≈
->
BiPªdSórch
[mode - 1]) ? 1: 0;

421 
	}
}

431 
	$ícode_⁄e_¶i˚
 (
VideoP¨amëîs
 *
p_Vid
, 
Sli˚GroupId
, 
TŸÆCodedMBs
)

433 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

434 
Boﬁón
 
íd_of_¶i˚
 = 
FALSE
;

436 
Àn
;

437 
NumbîOfCodedMBs
 = 0;

438 
Ma¸oblock
* 
cuºMB
 = 
NULL
;

439 
CuºítMbAddr
;

440 
SètP¨amëîs
 *
cur_°©s
 = &
p_Vid
->
íc_pi˘uª
->
°©s
;

441 
Sli˚
 *
cuºSli˚
 = 
NULL
;

443 if–(
p_I≈
->
£∑øã_cﬁour_∂™e_Êag
 != 0) )

445 
	`ch™ge_∂™e_JV
–
p_Vid
,Ö_Vid->
cﬁour_∂™e_id
 );

448 
p_Vid
->
cod_cou¡î
 = 0;

450 
CuºítMbAddr
 = 
	`FmoGëFú°Ma¸oblockInSli˚
 (
p_Vid
, 
Sli˚GroupId
);

453 
p_Vid
->
íc_pi˘uª
->
ãmp‹Æ_œyî
 =Ö_Vid->
p_cuº_‰m_°ru˘
->temporal_layer;

454 
	`öô_¶i˚
 (
p_Vid
, &
cuºSli˚
, 
CuºítMbAddr
);

455 
cuºSli˚
->
rdoq_mŸi⁄_c›y
 = 0;

456 
	`öô_bùªd_íabÀd
(
p_Vid
);

460 
	`öô_qu™t_4x4
 (
cuºSli˚
);

461 
	`öô_qu™t_8x8
 (
cuºSli˚
);

462 
	`öô_qu™t_Chroma
(
cuºSli˚
);

464 
cuºSli˚
->
	`£t_œgøngün_mu…ùlõrs
(currSlice);

466 i‡(
cuºSli˚
->
symbﬁ_mode
 =
CABAC
)

468 
	`SëCtxModñNumbî
 (
cuºSli˚
);

471 
p_Vid
->
checkªf
 = (Ë(
p_I≈
->
rd›t
 &&Ö_I≈->
Re°ri˘Ref
 && (
cuºSli˚
->
¶i˚_ty≥
==
P_SLICE
 || cuºSli˚->¶i˚_ty≥==
SP_SLICE
));

473 
Àn
 = 
	`°¨t_¶i˚
 (
cuºSli˚
, 
cur_°©s
);

476 i‡(
p_I≈
->
RCE«bÀ
)

477 
	`rc_°‹e_¶i˚_hódî_bôs
–
p_Vid
, 
p_I≈
, 
Àn
 );

480 
p_Vid
->
p_Sèts
->
bô_¶i˚
 +
Àn
;

481 
cur_°©s
->
bô_u£_hódî
[
cuºSli˚
->
¶i˚_ty≥
] +
Àn
;

483 if(
cuºSli˚
->
U£RDOQu™t
 =1 && cuºSli˚->
RDOQ_QP_Num
 > 1)

484 
	`gë_dQP_èbÀ
(
cuºSli˚
);

486 
íd_of_¶i˚
 =
FALSE
)

488 
Boﬁón
 
ªcode_ma¸oblock
 = 
FALSE
;

489 i‡(
p_Vid
->
Ad≠tiveRoundög
 && 
p_I≈
->
Ad≠tRndPîiod
 && (p_Vid->
cuºít_mb_ƒ
 %Ö_Inp->AdaptRndPeriod == 0))

491 
	`CÆcuœãOff£t4x4P¨am
(
p_Vid
);

492 if(
p_I≈
->
Tønsf‹m8x8Mode
)

493 
	`CÆcuœãOff£t8x8P¨am
(
p_Vid
);

496 if(
cuºSli˚
->
U£RDOQu™t
)

497 
cuºSli˚
->
rdd©a
 = &cuºSli˚->
rdd©a_åñlis_cuº
;

499 
cuºSli˚
->
rdd©a
 = &cuºSli˚->
rdd©a_t›_‰ame_mb
;

501 
	`°¨t_ma¸oblock
 (
cuºSli˚
, &
cuºMB
, 
CuºítMbAddr
, 
FALSE
);

504 if(
cuºSli˚
->
U£RDOQu™t
)

506 
	`åñlis_codög
(
cuºMB
);

510 
p_Vid
->
ma°îQP
 =Ö_Vid->
qp
;

512 
cuºSli˚
->
	`ícode_⁄e_ma¸oblock
 (
cuºMB
);

513 
	`íd_ícode_⁄e_ma¸oblock
(
cuºMB
);

515 
	`wrôe_ma¸oblock
 (
cuºMB
, 1);

518 
	`íd_ma¸oblock
 (
cuºMB
, &
íd_of_¶i˚
, &
ªcode_ma¸oblock
);

519 
cuºMB
->
¥ev_ªcode_mb
 = 
ªcode_ma¸oblock
;

524 i‡(
ªcode_ma¸oblock
 =
FALSE
)

526 
p_Vid
->
SumFømeQP
 +
cuºMB
->
qp
;

527 
CuºítMbAddr
 = 
	`FmoGëNextMBNr
 (
p_Vid
, CurrentMbAddr);

528 i‡(
CuºítMbAddr
 == -1)

531 
íd_of_¶i˚
 = 
TRUE
;

533 
NumbîOfCodedMBs
++;

534 
	`√xt_ma¸oblock
 (
cuºMB
);

539 
p_Vid
->
cuºít_mb_ƒ
 = 
	`FmoGëPªviousMBNr
(p_Vid,Ö_Vid->current_mb_nr);

540 
p_Vid
->
NumbîofCodedMa¸oBlocks
--;

541 if(
p_Vid
->
cuºít_mb_ƒ
 == -1 )

544 
	`¢¥ötf
 (
îr‹ãxt
, 
ET_SIZE
, "ErrorÉncoding first MB with specifiedÖarameter, bits of current MB may beÅoo big");

545 
	`îr‹
 (
îr‹ãxt
, 300);

551 i‡((
p_I≈
->
WPIãrMC
Ë&& (
p_Vid
->
‰ameOff£tAvaû
 =0Ë&&Ö_Vid->
«l_ª„ªn˚_idc
)

553 
	`compuã_off£t
(
cuºSli˚
);

555 
p_Vid
->
num_ªf_idx_l0_a˘ive
 = 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
];

556 
p_Vid
->
num_ªf_idx_l1_a˘ive
 = 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_1
];

558 
	`ãrmö©e_¶i˚
 (
cuºMB
, (
NumbîOfCodedMBs
 + 
TŸÆCodedMBs
 >()
p_Vid
->
PicSizeInMbs
), 
cur_°©s
 );

559  
NumbîOfCodedMBs
;

560 
	}
}

571 
	$ícode_⁄e_¶i˚_MBAFF
 (
VideoP¨amëîs
 *
p_Vid
, 
Sli˚GroupId
, 
TŸÆCodedMBs
)

573 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

574 
Boﬁón
 
íd_of_¶i˚
 = 
FALSE
;

575 
Boﬁón
 
ªcode_ma¸oblock
;

576 
Àn
;

577 
NumbîOfCodedMBs
 = 0;

578 
Ma¸oblock
* 
cuºMB
 = 
NULL
;

579 
CuºítMbAddr
;

580 
FømeRDCo°
 = 
DBL_MAX
, 
FõldRDCo°
 = DBL_MAX;

581 
SètP¨amëîs
 *
cur_°©s
 = &
p_Vid
->
íc_pi˘uª
->
°©s
;

582 
Sli˚
 *
cuºSli˚
 = 
NULL
;

584 if–(
p_I≈
->
£∑øã_cﬁour_∂™e_Êag
 != 0) )

586 
	`ch™ge_∂™e_JV
–
p_Vid
,Ö_Vid->
cﬁour_∂™e_id
 );

589 
p_Vid
->
cod_cou¡î
 = 0;

591 
CuºítMbAddr
 = 
	`FmoGëFú°Ma¸oblockInSli˚
 (
p_Vid
, 
Sli˚GroupId
);

594 
	`öô_¶i˚
 (
p_Vid
, &
cuºSli˚
, 
CuºítMbAddr
);

595 
cuºSli˚
->
rdoq_mŸi⁄_c›y
 = 0;

596 
	`öô_bùªd_íabÀd
(
p_Vid
);

600 
	`öô_qu™t_4x4
 (
cuºSli˚
);

601 
	`öô_qu™t_8x8
 (
cuºSli˚
);

602 
	`öô_qu™t_Chroma
(
cuºSli˚
);

604 
cuºSli˚
->
	`£t_œgøngün_mu…ùlõrs
(currSlice);

606 i‡(
cuºSli˚
->
symbﬁ_mode
 =
CABAC
)

608 
	`SëCtxModñNumbî
 (
cuºSli˚
);

611 
p_Vid
->
checkªf
 = (Ë(
p_I≈
->
rd›t
 &&Ö_I≈->
Re°ri˘Ref
 && (
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
 || cuºSli˚->¶i˚_ty≥ =
SP_SLICE
));

613 
Àn
 = 
	`°¨t_¶i˚
 (
cuºSli˚
, 
cur_°©s
);

616 i‡(
p_I≈
->
RCE«bÀ
)

617 
	`rc_°‹e_¶i˚_hódî_bôs
–
p_Vid
, 
p_I≈
, 
Àn
 );

620 
p_Vid
->
p_Sèts
->
bô_¶i˚
 +
Àn
;

621 
cur_°©s
->
bô_u£_hódî
[
cuºSli˚
->
¶i˚_ty≥
] +
Àn
;

623 
íd_of_¶i˚
 =
FALSE
)

626 i‡(
p_Vid
->
Ad≠tiveRoundög
 && 
p_I≈
->
Ad≠tRndPîiod
 && (p_Vid->
cuºít_mb_ƒ
 %Ö_Inp->AdaptRndPeriod == 0))

628 
	`CÆcuœãOff£t4x4P¨am
(
p_Vid
);

629 if(
p_I≈
->
Tønsf‹m8x8Mode
)

630 
	`CÆcuœãOff£t8x8P¨am
(
p_Vid
);

661 
p_Vid
->
wrôe_ma¸oblock
 = 
FALSE
;

662 i‡(
p_I≈
->
MbI¡îœ˚
 =
ADAPTIVE_CODING
 ||Ö_I≈->MbI¡îœ˚ =
FRAME_MB_PAIR_CODING
)

666 
ªcode_ma¸oblock
 = 
FALSE
;

668 
	`upd©e_mv_limôs
(
p_Vid
, 
FALSE
);

670 
p_Vid
->
fõld_mode
 = 
FALSE
;

671 
p_Vid
->
t›_fõld
 = 
FALSE
;

674 
p_Vid
->
wrôe_ma¸oblock
 = 
FALSE
;

675 
p_Vid
->
bŸ_MB
 = 
FALSE
;

678 i‡–
p_I≈
->
RCE«bÀ
 &&Ö_I≈->
RCUpd©eMode
 <
MAX_RC_MODE
 )

680 i‡–
p_I≈
->
MbI¡îœ˚
 =
ADAPTIVE_CODING


681 && 
p_Vid
->
NumbîofCodedMa¸oBlocks
 > 0 && (p_Vid->NumbîofCodedMa¸oBlock†%Ö_Vid->
BasicUnô
) == 0 )

682 
	`rc_c›y_quadøtic
–
p_Vid
, 
p_I≈
,Ö_Vid->
p_rc_quad_öô
,Ö_Vid->
p_rc_quad
 );

683 i‡–
p_I≈
->
MbI¡îœ˚
 =
ADAPTIVE_CODING
 )

684 
	`rc_c›y_gíîic
–
p_Vid
,Ö_Vid->
p_rc_gí_öô
,Ö_Vid->
p_rc_gí
 );

687 
	`°¨t_ma¸oblock
 (
cuºSli˚
, &
cuºMB
, 
CuºítMbAddr
, 
FALSE
);

689 
cuºSli˚
->
rdd©a
 = &cuºSli˚->
rdd©a_t›_‰ame_mb
;

690 
p_Vid
->
ma°îQP
 =Ö_Vid->
qp
;

691 
cuºSli˚
->
	`ícode_⁄e_ma¸oblock
 (
cuºMB
);

692 
	`íd_ícode_⁄e_ma¸oblock
(
cuºMB
);

694 
FømeRDCo°
 = 
cuºSli˚
->
rdd©a
->
mö_rdco°
;

698 
p_Vid
->
bŸ_MB
 = 
TRUE
;

701 
p_Vid
->
fõld_mode
 = 
FALSE
;

703 
	`°¨t_ma¸oblock
 (
cuºSli˚
, &
cuºMB
, 
CuºítMbAddr
 + 1, 
FALSE
);

704 
cuºSli˚
->
rdd©a
 = &cuºSli˚->
rdd©a_bŸ_‰ame_mb
;

705 
p_Vid
->
ma°îQP
 =Ö_Vid->
qp
;

706 
cuºSli˚
->
	`ícode_⁄e_ma¸oblock
 (
cuºMB
);

707 
	`íd_ícode_⁄e_ma¸oblock
(
cuºMB
);

709 i‡–
p_I≈
->
RCE«bÀ
 &&Ö_I≈->
RCUpd©eMode
 <
MAX_RC_MODE
 )

711 i‡–
p_I≈
->
MbI¡îœ˚
 =
ADAPTIVE_CODING


712 && 
p_Vid
->
NumbîofCodedMa¸oBlocks
 > 0 && (p_Vid->NumbîofCodedMa¸oBlock†%Ö_Vid->
BasicUnô
) == 0 )

713 
	`rc_c›y_quadøtic
–
p_Vid
, 
p_I≈
,Ö_Vid->
p_rc_quad_be°
,Ö_Vid->
p_rc_quad
 );

715 i‡–
p_I≈
->
MbI¡îœ˚
 =
ADAPTIVE_CODING
 )

716 
	`rc_c›y_gíîic
–
p_Vid
,Ö_Vid->
p_rc_gí_be°
,Ö_Vid->
p_rc_gí
 );

719 
FømeRDCo°
 +
cuºSli˚
->
rdd©a
->
mö_rdco°
;

723 i‡((
p_I≈
->
MbI¡îœ˚
 =
ADAPTIVE_CODING
Ë|| (p_I≈->MbI¡îœ˚ =
FIELD_CODING
))

726 
p_Vid
->
bŸ_MB
 = 
FALSE
;

728 
	`upd©e_mv_limôs
(
p_Vid
, 
TRUE
);

732 
p_Vid
->
fõld_mode
 = 
TRUE
;

733 
p_Vid
->
t›_fõld
 = 
TRUE
;

734 
p_I≈
->
num_ªf_‰ames
 <<= 1;

735 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
] <<= 1;

736 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
] += 1;

738 i‡–
p_I≈
->
RCE«bÀ
 &&Ö_I≈->
RCUpd©eMode
 <
MAX_RC_MODE
 )

740 i‡–
p_I≈
->
MbI¡îœ˚
 =
ADAPTIVE_CODING


741 && 
p_Vid
->
NumbîofCodedMa¸oBlocks
 > 0 && (p_Vid->NumbîofCodedMa¸oBlock†%Ö_Vid->
BasicUnô
) == 0 )

742 
	`rc_c›y_quadøtic
–
p_Vid
, 
p_I≈
,Ö_Vid->
p_rc_quad
,Ö_Vid->
p_rc_quad_öô
 );

744 i‡–
p_I≈
->
MbI¡îœ˚
 =
ADAPTIVE_CODING
 )

745 
	`rc_c›y_gíîic
–
p_Vid
,Ö_Vid->
p_rc_gí
,Ö_Vid->
p_rc_gí_öô
 );

748 
	`°¨t_ma¸oblock
 (
cuºSli˚
, &
cuºMB
, 
CuºítMbAddr
, 
TRUE
);

750 
cuºSli˚
->
rdd©a
 = &cuºSli˚->
rdd©a_t›_fõld_mb
;

752 
p_Vid
->
ma°îQP
 =Ö_Vid->
qp
;

753 
cuºSli˚
->
	`ícode_⁄e_ma¸oblock
 (
cuºMB
);

754 
	`íd_ícode_⁄e_ma¸oblock
(
cuºMB
);

756 
FõldRDCo°
 = 
cuºSli˚
->
rdd©a
->
mö_rdco°
;

759 
p_Vid
->
bŸ_MB
 = 
TRUE
;

761 
p_Vid
->
t›_fõld
 = 
FALSE
;

762 
	`°¨t_ma¸oblock
 (
cuºSli˚
, &
cuºMB
, 
CuºítMbAddr
+1, 
TRUE
);

763 
cuºSli˚
->
rdd©a
 = &cuºSli˚->
rdd©a_bŸ_fõld_mb
;

764 
p_Vid
->
ma°îQP
 =Ö_Vid->
qp
;

765 
cuºSli˚
->
	`ícode_⁄e_ma¸oblock
 (
cuºMB
);

766 
	`íd_ícode_⁄e_ma¸oblock
(
cuºMB
);

768 
FõldRDCo°
 +
cuºSli˚
->
rdd©a
->
mö_rdco°
;

773 
p_Vid
->
wrôe_mbaff_‰ame
 = 0;

777 i‡–((
p_I≈
->
MbI¡îœ˚
 =
ADAPTIVE_CODING
Ë&& (
FømeRDCo°
 < 
FõldRDCo°
)Ë||Ö_I≈->MbI¡îœ˚ =
FRAME_MB_PAIR_CODING
 )

779 
p_Vid
->
fõld_mode
 = 
FALSE
;

780 
p_Vid
->
MBPaúIsFõld
 = 
FALSE
;

782 i‡–
p_I≈
->
MbI¡îœ˚
 !
FRAME_MB_PAIR_CODING
 )

784 
p_I≈
->
num_ªf_‰ames
 >>= 1;

785 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
] -= 1;

786 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
] >>= 1;

789 i‡–
p_I≈
->
RCE«bÀ
 &&Ö_I≈->
RCUpd©eMode
 <
MAX_RC_MODE
 )

791 i‡–
p_I≈
->
MbI¡îœ˚
 =
ADAPTIVE_CODING


792 && 
p_Vid
->
NumbîofCodedMa¸oBlocks
 > 0 && (p_Vid->NumbîofCodedMa¸oBlock†%Ö_Vid->
BasicUnô
) == 0 )

793 
	`rc_c›y_quadøtic
–
p_Vid
, 
p_I≈
,Ö_Vid->
p_rc_quad
,Ö_Vid->
p_rc_quad_be°
 );

795 i‡–
p_I≈
->
MbI¡îœ˚
 =
ADAPTIVE_CODING
 )

796 
	`rc_c›y_gíîic
–
p_Vid
,Ö_Vid->
p_rc_gí
,Ö_Vid->
p_rc_gí_be°
 );

800 
p_Vid
->
wrôe_mbaff_‰ame
 = 1;

804 
p_Vid
->
fõld_mode
 = 
TRUE
;

805 
p_Vid
->
MBPaúIsFõld
 = 
TRUE
;

809 
p_Vid
->
wrôe_ma¸oblock
 = 
TRUE
;

811 i‡(
p_Vid
->
MBPaúIsFõld
)

812 
p_Vid
->
t›_fõld
 = 
TRUE
;

814 
p_Vid
->
t›_fõld
 = 
FALSE
;

817 
p_Vid
->
bŸ_MB
 = 
FALSE
;

820 
	`°¨t_ma¸oblock
 (
cuºSli˚
, &
cuºMB
, 
CuºítMbAddr
, 
p_Vid
->
fõld_mode
);

822 
cuºSli˚
->
rdd©a
 = 
p_Vid
->
fõld_mode
 ? &cuºSli˚->
rdd©a_t›_fõld_mb
 : &cuºSli˚->
rdd©a_t›_‰ame_mb
;

823 
	`c›y_rd›t_d©a
 (
cuºMB
);

824 
	`wrôe_ma¸oblock
 (
cuºMB
, 1);

825 
	`íd_ma¸oblock
 (
cuºMB
, &
íd_of_¶i˚
, &
ªcode_ma¸oblock
);

826 
cuºMB
->
¥ev_ªcode_mb
 = 
ªcode_ma¸oblock
;

828 i‡(
ªcode_ma¸oblock
 =
FALSE
)

830 
p_Vid
->
SumFømeQP
 +
cuºMB
->
qp
;

832 
CuºítMbAddr
 = 
	`FmoGëNextMBNr
 (
p_Vid
, CurrentMbAddr);

833 i‡(
CuºítMbAddr
 == -1)

835 
íd_of_¶i˚
 = 
TRUE
;

837 
NumbîOfCodedMBs
++;

838 
	`√xt_ma¸oblock
 (
cuºMB
);

841 
p_Vid
->
bŸ_MB
 = 
TRUE
;

843 
p_Vid
->
t›_fõld
 = 
FALSE
;

844 
	`°¨t_ma¸oblock
 (
cuºSli˚
, &
cuºMB
, 
CuºítMbAddr
, 
p_Vid
->
fõld_mode
);

846 
cuºSli˚
->
rdd©a
 = 
p_Vid
->
fõld_mode
 ? &cuºSli˚->
rdd©a_bŸ_fõld_mb
 : &cuºSli˚->
rdd©a_bŸ_‰ame_mb
;

847 
	`c›y_rd›t_d©a
 (
cuºMB
);

849 
	`wrôe_ma¸oblock
 (
cuºMB
, 0);

850 
	`íd_ma¸oblock
 (
cuºMB
, &
íd_of_¶i˚
, &
ªcode_ma¸oblock
);

851 
cuºMB
->
¥ev_ªcode_mb
 = 
ªcode_ma¸oblock
;

852 i‡(
ªcode_ma¸oblock
 =
FALSE
)

854 
p_Vid
->
SumFømeQP
 +
cuºMB
->
qp
;

856 
CuºítMbAddr
 = 
	`FmoGëNextMBNr
 (
p_Vid
, CurrentMbAddr);

857 i‡(
CuºítMbAddr
 == -1)

859 
íd_of_¶i˚
 = 
TRUE
;

861 
NumbîOfCodedMBs
++;

862 
	`√xt_ma¸oblock
 (
cuºMB
);

867 
p_Vid
->
cuºít_mb_ƒ
 = 
	`FmoGëPªviousMBNr
(p_Vid,Ö_Vid->current_mb_nr);

868 
p_Vid
->
NumbîofCodedMa¸oBlocks
 -= 2;

869 if(
p_Vid
->
cuºít_mb_ƒ
 == -1 )

872 
	`¢¥ötf
 (
îr‹ãxt
, 
ET_SIZE
, "ErrorÉncoding first MB with specifiedÖarameter, bits of current MB may beÅoo big");

873 
	`îr‹
 (
îr‹ãxt
, 300);

880 
p_Vid
->
cuºít_mb_ƒ
 = 
	`FmoGëPªviousMBNr
(p_Vid,Ö_Vid->current_mb_nr);

881 
p_Vid
->
NumbîofCodedMa¸oBlocks
--;

882 if(
p_Vid
->
cuºít_mb_ƒ
 == -1 )

885 
	`¢¥ötf
 (
îr‹ãxt
, 
ET_SIZE
, "ErrorÉncoding first MB with specifiedÖarameter, bits of current MB may beÅoo big");

886 
	`îr‹
 (
îr‹ãxt
, 300);

890 i‡(
p_Vid
->
MBPaúIsFõld
)

892 
p_I≈
->
num_ªf_‰ames
 >>= 1;

893 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
] -= 1;

894 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
] >>= 1;

897 
p_Vid
->
fõld_mode
 =Ö_Vid->
t›_fõld
 = 
FALSE
;

899 i‡–!
íd_of_¶i˚
 )

901 
	`as£π
–
CuºítMbAddr
 < ()
p_Vid
->
PicSizeInMbs
 );

902 
	`as£π
–
CuºítMbAddr
 >= 0 );

903 i‡(
CuºítMbAddr
 =
	`FmoGëLa°CodedMBOfSli˚Group
 (
p_Vid
, 
	`FmoMB2Sli˚Group
 (p_Vid, CurrentMbAddr)))

904 
íd_of_¶i˚
 = 
TRUE
;

908 
p_Vid
->
num_ªf_idx_l0_a˘ive
 = 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
];

909 
p_Vid
->
num_ªf_idx_l1_a˘ive
 = 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_1
];

911 
	`ãrmö©e_¶i˚
 (
cuºMB
, (
NumbîOfCodedMBs
 + 
TŸÆCodedMBs
 >()
p_Vid
->
PicSizeInMbs
), 
cur_°©s
 );

912  
NumbîOfCodedMBs
;

913 
	}
}

915 
	$£tup_ˇbac
(
Sli˚
 *
cuºSli˚
, *
li°Xsize
)

917 
£q_∑ømëî_£t_rb•_t
 *
a˘ive_•s
 = 
cuºSli˚
->active_sps;

918 
i
;

920 i‡(
cuºSli˚
->
¶i˚_ty≥
 =
I_SLICE
)

922 
cuºSli˚
->
£t_modes_™d_ª‰ame
 = 
£t_modes_™d_ª‰ame_i_¶i˚
;

923 
cuºSli˚
->
°‹e_8x8_mŸi⁄_ve˘‹s
 = 
NULL
;

924 
cuºSli˚
->
wrôeMB_Skù
 = 
NULL
;

925 
cuºSli˚
->
wrôeMB_ty≥Info
 = 
wrôeMB_I_ty≥Info_CABAC
;

926 
cuºSli˚
->
wrôeB8_ty≥Info
 = 
wrôeB8_ty≥Info_CABAC
;

927 
cuºSli˚
->
wrôeMŸi⁄Info2NAL
 = 
NULL
;

928 
cuºSli˚
->
wrôe_MB_œyî
 = 
wrôe_i_¶i˚_MB_œyî
;

929 
i
=0; i<6; i++)

931 
cuºSli˚
->
wrôeRefFøme
[
i
] = 
NULL
;

934 i‡(
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
)

936 
cuºSli˚
->
£t_modes_™d_ª‰ame
 = 
£t_modes_™d_ª‰ame_b_¶i˚
;

937 
cuºSli˚
->
°‹e_8x8_mŸi⁄_ve˘‹s
 = 
°‹e_8x8_mŸi⁄_ve˘‹s_b_¶i˚
;

938 
cuºSli˚
->
wrôeMB_Skù
 = 
wrôeMB_Bskù_ÊagInfo_CABAC
;

939 
cuºSli˚
->
wrôeMB_ty≥Info
 = 
wrôeMB_B_ty≥Info_CABAC
;

940 
cuºSli˚
->
wrôeB8_ty≥Info
 = 
wrôeB8_B_ty≥Info_CABAC
;

941 
cuºSli˚
->
wrôeMŸi⁄Info2NAL
 = 
wrôe_b_¶i˚_mŸi⁄_öfo_to_NAL
;

942 
cuºSli˚
->
wrôe_MB_œyî
 = 
wrôe_b_¶i˚_MB_œyî
;

943 
i
=0; i<6; i++)

945 
li°Xsize
[
i
])

948 
cuºSli˚
->
wrôeRefFøme
[
i
] = 
NULL
;

951 
cuºSli˚
->
wrôeRefFøme
[
i
] = 
wrôeRefPic_Dummy
;

954 
cuºSli˚
->
wrôeRefFøme
[
i
] = 
wrôeRefPic_B_CABAC
;

960 
cuºSli˚
->
£t_modes_™d_ª‰ame
 = 
£t_modes_™d_ª‰ame_p_¶i˚
;

961 
cuºSli˚
->
°‹e_8x8_mŸi⁄_ve˘‹s
 = 
°‹e_8x8_mŸi⁄_ve˘‹s_p_¶i˚
;

962 
cuºSli˚
->
wrôeMB_Skù
 = 
wrôeMB_Pskù_ÊagInfo_CABAC
;

963 
cuºSli˚
->
wrôeMB_ty≥Info
 = 
wrôeMB_P_ty≥Info_CABAC
;

964 
cuºSli˚
->
wrôeB8_ty≥Info
 = 
wrôeB8_ty≥Info_CABAC
;

965 
cuºSli˚
->
wrôeMŸi⁄Info2NAL
 = 
wrôe_p_¶i˚_mŸi⁄_öfo_to_NAL
;

966 
cuºSli˚
->
wrôe_MB_œyî
 = 
wrôe_p_¶i˚_MB_œyî
;

968 
i
=0; i<6; i++)

970 
li°Xsize
[
i
])

973 
cuºSli˚
->
wrôeRefFøme
[
i
] = 
NULL
;

976 
cuºSli˚
->
wrôeRefFøme
[
i
] = 
wrôeRefPic_Dummy
;

979 
cuºSli˚
->
wrôeRefFøme
[
i
] = 
wrôeRefPic_P_CABAC
;

984 
cuºSli˚
->
wrôeI¡øPªdMode
 = 
wrôeI¡øPªdMode_CABAC
;

985 
cuºSli˚
->
wrôeC€ff16x16
 = 
wrôeC€ff16x16_CABAC
;

986 
cuºSli˚
->
wrôeMVD
 = 
wrôeMVD_CABAC
;

987 
cuºSli˚
->
wrôeCBP
 = 
wrôeCBP_CABAC
;

988 
cuºSli˚
->
wrôeDqu™t
 = 
wrôeDqu™t_CABAC
;

989 
cuºSli˚
->
wrôeCIPªdMode
 = 
wrôeCIPªdMode_CABAC
;

990 
cuºSli˚
->
wrôeFõldModeInfo
 = 
wrôeFõldModeInfo_CABAC
;

991 
cuºSli˚
->
wrôeMB_å™sf‹m_size
 = 
wrôeMB_å™sf‹m_size_CABAC
;

993 i‡(
a˘ive_•s
->
chroma_f‹m©_idc
 =
YUV444
)

994 
cuºSli˚
->
wrôe_™d_°‹e_CBP_block_bô
 = 
wrôe_™d_°‹e_CBP_block_bô_444
;

996 
cuºSli˚
->
wrôe_™d_°‹e_CBP_block_bô
 = write_and_store_CBP_block_bit;

998 
	`mem£t
(
cuºSli˚
->
c€ff
, 0 , 64 * ());

999 
cuºSli˚
->
c€ff_˘r
 = 0;

1000 
cuºSli˚
->
pos
 = 0;

1001 
	}
}

1003 
	$£tup_ˇvlc
(
Sli˚
 *
cuºSli˚
, *
li°Xsize
)

1005 
£q_∑ømëî_£t_rb•_t
 *
a˘ive_•s
 = 
cuºSli˚
->active_sps;

1007 
i
;

1008 
cuºSli˚
->
wrôeMB_ty≥Info
 = 
wrôeUVLC_CAVLC
;

1009 
cuºSli˚
->
wrôeI¡øPªdMode
 = 
wrôeI¡øPªdMode_CAVLC
;

1010 
cuºSli˚
->
wrôeB8_ty≥Info
 = 
wrôeSE_UVLC
;

1011 
cuºSli˚
->
wrôeC€ff16x16
 = 
wrôeC€ff16x16_CAVLC
;

1012 
i
=0; i<6; i++)

1014 
li°Xsize
[
i
])

1017 
cuºSli˚
->
wrôeRefFøme
[
i
] = 
NULL
;

1020 
cuºSli˚
->
wrôeRefFøme
[
i
] = 
wrôeRefPic_Dummy
;

1023 
cuºSli˚
->
wrôeRefFøme
[
i
] = 
wrôeRefPic_2Ref_CAVLC
;

1026 
cuºSli˚
->
wrôeRefFøme
[
i
] = 
wrôeRefPic_NRef_CAVLC
;

1031 i‡(
cuºSli˚
->
¶i˚_ty≥
 =
I_SLICE
 || cuºSli˚->¶i˚_ty≥ =
SI_SLICE
)

1033 
cuºSli˚
->
£t_modes_™d_ª‰ame
 = set_modes_and_reframe;

1034 
cuºSli˚
->
°‹e_8x8_mŸi⁄_ve˘‹s
 = 
NULL
;

1035 
cuºSli˚
->
wrôeMŸi⁄Info2NAL
 = 
NULL
;

1036 
cuºSli˚
->
wrôe_MB_œyî
 = 
wrôe_i_¶i˚_MB_œyî
;

1038 i‡(
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
)

1040 
cuºSli˚
->
£t_modes_™d_ª‰ame
 = 
£t_modes_™d_ª‰ame_b_¶i˚
;

1041 
cuºSli˚
->
°‹e_8x8_mŸi⁄_ve˘‹s
 = 
°‹e_8x8_mŸi⁄_ve˘‹s_b_¶i˚
;

1042 
cuºSli˚
->
wrôeMŸi⁄Info2NAL
 = 
wrôe_b_¶i˚_mŸi⁄_öfo_to_NAL
;

1043 
cuºSli˚
->
wrôe_MB_œyî
 = 
wrôe_b_¶i˚_MB_œyî
;

1047 
cuºSli˚
->
£t_modes_™d_ª‰ame
 = 
£t_modes_™d_ª‰ame_p_¶i˚
;

1048 
cuºSli˚
->
°‹e_8x8_mŸi⁄_ve˘‹s
 = 
°‹e_8x8_mŸi⁄_ve˘‹s_p_¶i˚
;

1049 
cuºSli˚
->
wrôeMŸi⁄Info2NAL
 = 
wrôe_p_¶i˚_mŸi⁄_öfo_to_NAL
;

1050 
cuºSli˚
->
wrôe_MB_œyî
 = 
wrôe_p_¶i˚_MB_œyî
;

1053 
cuºSli˚
->
wrôeMVD
 = 
wrôeSVLC_CAVLC
;

1054 
cuºSli˚
->
wrôeCBP
 = 
wrôeCBP_VLC
;

1055 
cuºSli˚
->
wrôeDqu™t
 = 
wrôeSVLC_CAVLC
;

1056 
cuºSli˚
->
wrôeCIPªdMode
 = 
wrôeUVLC_CAVLC
;

1057 
cuºSli˚
->
wrôeFõldModeInfo
 = 
wrôeFœg_CAVLC
;

1058 
cuºSli˚
->
wrôeMB_å™sf‹m_size
 = 
wrôeFœg_CAVLC
;

1061 i‡(
a˘ive_•s
->
chroma_f‹m©_idc
 =
YUV444
)

1062 
cuºSli˚
->
wrôeC€ff4x4_CAVLC
 = 
wrôeC€ff4x4_CAVLC_444
;

1064 
cuºSli˚
->
wrôeC€ff4x4_CAVLC
 = 
wrôeC€ff4x4_CAVLC_n‹mÆ
;

1065 
	}
}

1067 
	$£tup_¶i˚
(
Sli˚
 *
cuºSli˚
)

1069 i‡(
cuºSli˚
->
P444_joöed
)

1071 
cuºSli˚
->
luma_ªsiduÆ_codög
 = 
luma_ªsiduÆ_codög_p444
;

1072 
cuºSli˚
->
luma_ªsiduÆ_codög_8x8
 = 
luma_ªsiduÆ_codög_p444_8x8
;

1076 i‡(
cuºSli˚
->
¶i˚_ty≥
 =
SP_SLICE
)

1077 
cuºSli˚
->
luma_ªsiduÆ_codög
 = 
luma_ªsiduÆ_codög_•
;

1079 
cuºSli˚
->
luma_ªsiduÆ_codög
 =Üuma_residual_coding;

1080 
cuºSli˚
->
luma_ªsiduÆ_codög_8x8
 =Üuma_residual_coding_8x8;

1083 i‡(
cuºSli˚
->
¶i˚_ty≥
 =
SP_SLICE
)

1084 
cuºSli˚
->
chroma_ªsiduÆ_codög
 = 
chroma_ªsiduÆ_codög_•
;

1085 i‡(
cuºSli˚
->
¶i˚_ty≥
 =
SI_SLICE
)

1086 
cuºSli˚
->
chroma_ªsiduÆ_codög
 = 
chroma_ªsiduÆ_codög_si
;

1088 
cuºSli˚
->
chroma_ªsiduÆ_codög
 = chroma_residual_coding;

1090 i‡(
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
 || cuºSli˚->¶i˚_ty≥ =
SP_SLICE
)

1092 
cuºSli˚
->
weighãd_¥edi˘i⁄
 = (
byã
ËcuºSli˚->
p_Vid
->
a˘ive_µs
->
weighãd_¥ed_Êag
;

1093 
cuºSli˚
->
£t_modes_™d_ªfs_f‹_blocks
 = 
£t_modes_™d_ªfs_f‹_blocks_p_¶i˚
;

1094 
cuºSli˚
->
£t_c€ff_™d_ªc⁄_8x8
 = 
£t_c€ff_™d_ªc⁄_8x8_p_¶i˚
;

1095 
cuºSli˚
->
öô_li°s
 = 
öô_li°s_p_¶i˚
;

1096 
cuºSli˚
->
subma¸oblock_mode_decisi⁄
 = 
subma¸oblock_mode_decisi⁄_p_¶i˚
;

1097 
cuºSli˚
->
£t_mŸi⁄_ve˘‹s_mb
 = 
SëMŸi⁄Ve˘‹sMBPSli˚
;

1099 i‡(
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
)

1101 
cuºSli˚
->
weighãd_¥edi˘i⁄
 = (
byã
ËcuºSli˚->
p_Vid
->
a˘ive_µs
->
weighãd_bùªd_idc
;

1102 
cuºSli˚
->
£t_modes_™d_ªfs_f‹_blocks
 = 
£t_modes_™d_ªfs_f‹_blocks_b_¶i˚
;

1103 
cuºSli˚
->
£t_c€ff_™d_ªc⁄_8x8
 = 
£t_c€ff_™d_ªc⁄_8x8_b_¶i˚
;

1104 
cuºSli˚
->
öô_li°s
 = 
öô_li°s_b_¶i˚
;

1105 
cuºSli˚
->
subma¸oblock_mode_decisi⁄
 = 
subma¸oblock_mode_decisi⁄_b_¶i˚
;

1106 
cuºSli˚
->
£t_mŸi⁄_ve˘‹s_mb
 = 
SëMŸi⁄Ve˘‹sMBBSli˚
;

1110 
cuºSli˚
->
£t_modes_™d_ªfs_f‹_blocks
 = 
£t_modes_™d_ªfs_f‹_blocks_i_¶i˚
;

1111 
cuºSli˚
->
£t_c€ff_™d_ªc⁄_8x8
 = 
NULL
;

1112 
cuºSli˚
->
öô_li°s
 = 
öô_li°s_i_¶i˚
;

1113 
cuºSli˚
->
subma¸oblock_mode_decisi⁄
 = 
NULL
;

1114 
cuºSli˚
->
£t_mŸi⁄_ve˘‹s_mb
 = 
SëMŸi⁄Ve˘‹sMBISli˚
;

1117 i‡(
cuºSli˚
->
mb_aff_‰ame_Êag
)

1119 
cuºSli˚
->
£t_öå≠ªd_4x4
 = 
£t_öå≠ªd_4x4_mbaff
;

1120 
cuºSli˚
->
£t_öå≠ªd_8x8
 = 
£t_öå≠ªd_8x8_mbaff
;

1121 
cuºSli˚
->
£t_öå≠ªd_16x16
 = 
£t_öå≠ªd_16x16_mbaff
;

1122 
cuºSli˚
->
rdo_low_öåa_chroma_decisi⁄
 = 
rdo_low_öåa_chroma_decisi⁄_mbaff
;

1123 
cuºSli˚
->
öåa_chroma_¥edi˘i⁄
 = 
öåa_chroma_¥edi˘i⁄_mbaff
;

1124 i‡(
cuºSli˚
->
dúe˘_•©ül_mv_¥ed_Êag
)

1125 
cuºSli˚
->
Gë_Dúe˘_MŸi⁄_Ve˘‹s
 = 
Gë_Dúe˘_MV_S∑tül_MBAFF
;

1127 
cuºSli˚
->
Gë_Dúe˘_MŸi⁄_Ve˘‹s
 = 
Gë_Dúe˘_MV_Temp‹Æ
;

1131 
cuºSli˚
->
£t_öå≠ªd_4x4
 = set_intrapred_4x4;

1132 
cuºSli˚
->
£t_öå≠ªd_8x8
 = set_intrapred_8x8;

1133 
cuºSli˚
->
£t_öå≠ªd_16x16
 = set_intrapred_16x16;

1134 
cuºSli˚
->
rdo_low_öåa_chroma_decisi⁄
 =Ñdo_low_intra_chroma_decision;

1135 
cuºSli˚
->
öåa_chroma_¥edi˘i⁄
 = intra_chroma_prediction;

1136 i‡(
cuºSli˚
->
dúe˘_•©ül_mv_¥ed_Êag
)

1137 
cuºSli˚
->
Gë_Dúe˘_MŸi⁄_Ve˘‹s
 = 
Gë_Dúe˘_MV_S∑tül_N‹mÆ
;

1139 
cuºSli˚
->
Gë_Dúe˘_MŸi⁄_Ve˘‹s
 = 
Gë_Dúe˘_MV_Temp‹Æ
;

1142 i‡(
cuºSli˚
->
a˘ive_•s
->
chroma_f‹m©_idc
 =
YUV444
)

1143 
cuºSli˚
->
mode_decisi⁄_f‹_I16x16_MB
 = 
mode_decisi⁄_f‹_I16x16_MB_444
;

1144 if(
cuºSli˚
->
p_I≈
->
I16rdo
)

1145 
cuºSli˚
->
mode_decisi⁄_f‹_I16x16_MB
 = 
mode_decisi⁄_f‹_I16x16_MB_RDO
;

1147 
cuºSli˚
->
mode_decisi⁄_f‹_I16x16_MB
 = mode_decision_for_I16x16_MB;

1148 
	}
}

1150 
	$ClùWPP¨ams
(
Sli˚
 *
cuºSli˚
 )

1172 
	}
}

1174 
	$£tup_›í_g›_li°s
(
VideoP¨amëîs
 *
p_Vid
, 
Sli˚
 *
cuºSli˚
)

1176 
i
, 
j
;

1178 i‡(
cuºSli˚
->
¶i˚_ty≥
 !
I_SLICE
 && cuºSli˚->¶i˚_ty≥ !
SI_SLICE
)

1180 
i
 = 0; i < 
cuºSli˚
->
li°Xsize
[0]; i++)

1182 i‡(
cuºSli˚
->
li°X
[
LIST_0
][
i
]->
poc
 < 
p_Vid
->
œ°_vÆid_ª„ªn˚
 &&Ö_Vid->
ThisPOC
 >=Ö_Vid->last_valid_reference)

1185 
j
 = 
i
; j < 
cuºSli˚
->
li°Xsize
[
LIST_0
]-1; j++)

1187 
cuºSli˚
->
li°X
[
LIST_0
][
j
] = currSlice->listX[LIST_0][j+1];

1189 
cuºSli˚
->
li°Xsize
[
LIST_0
]--;

1190 
i
--;

1194 
i
 = 0; i < 
cuºSli˚
->
li°Xsize
[
LIST_1
]; i++)

1196 i‡(
cuºSli˚
->
li°X
[
LIST_1
][
i
]->
poc
 < 
p_Vid
->
œ°_vÆid_ª„ªn˚
 &&Ö_Vid->
ThisPOC
 >=Ö_Vid->last_valid_reference)

1199 
j
 = 
i
; j < 
cuºSli˚
->
li°Xsize
[
LIST_1
]-1; j++)

1201 
cuºSli˚
->
li°X
[
LIST_1
][
j
] = currSlice->listX[LIST_1][j+1];

1203 
cuºSli˚
->
li°Xsize
[
LIST_1
]--;

1204 
i
--;

1211 i‡(
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
)

1213 i‡(
cuºSli˚
->
li°Xsize
[
LIST_1
] =0 && cuºSli˚->li°Xsize[
LIST_0
] != 0)

1215 i‡(
cuºSli˚
->
li°Xsize
[
LIST_0
] > 1)

1216 
cuºSli˚
->
li°X
[
LIST_1
][0] = cuºSli˚->li°X[
LIST_0
][1];

1218 
cuºSli˚
->
li°X
[
LIST_1
][0] = cuºSli˚->li°X[
LIST_0
][0];

1219 
cuºSli˚
->
li°Xsize
[
LIST_1
]++;

1221 i‡(
cuºSli˚
->
li°Xsize
[
LIST_0
] =0 && cuºSli˚->li°Xsize[
LIST_1
] != 0)

1223 i‡(
cuºSli˚
->
li°Xsize
[
LIST_1
] > 1)

1224 
cuºSli˚
->
li°X
[
LIST_0
][0] = cuºSli˚->li°X[
LIST_1
][1];

1226 
cuºSli˚
->
li°X
[
LIST_0
][0] = cuºSli˚->li°X[
LIST_1
][0];

1227 
cuºSli˚
->
li°Xsize
[
LIST_0
]++;

1235 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
] = cuºSli˚->
li°Xsize
[LIST_0];

1236 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_1
] = cuºSli˚->
li°Xsize
[LIST_1];

1238 
	}
}

1241 
	$£t_¶i˚
 (
VideoP¨amëîs
 *
p_Vid
, 
Sli˚
 *
cuºSli˚
)

1243 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

1245 
cuºSli˚
->
p_Vid
 =Ö_Vid;

1246 
cuºSli˚
->
p_I≈
 =Ö_Inp;

1247 
cuºSli˚
->
œyî_id
 = 
p_Vid
->
dpb_œyî_id
;

1248 
cuºSli˚
->
p_Dpb
 = 
p_Vid
->
p_Dpb_œyî
[p_Vid->
dpb_œyî_id
];

1249 
cuºSli˚
->
a˘ive_•s
 = 
p_Vid
->active_sps;

1250 
cuºSli˚
->
a˘ive_µs
 = 
p_Vid
->active_pps;

1251 
cuºSli˚
->
pi˘uª_id
 = (
p_Vid
->
‰ame_no
 & 0xFF);

1252 
cuºSli˚
->
¶i˚_ƒ
 = 
p_Vid
->
cuºít_¶i˚_ƒ
;

1253 
cuºSli˚
->
idr_Êag
 = 
p_Vid
->
cuºítPi˘uª
->idr_flag;

1254 
cuºSli˚
->
¶i˚_ty≥
 = 
p_Vid
->
ty≥
;

1255 
cuºSli˚
->
‰ame_no
 = 
p_Vid
->frame_no;

1256 
cuºSli˚
->
‰ame_num
 = 
p_Vid
->frame_num;

1257 
cuºSli˚
->
max_‰ame_num
 = 
p_Vid
->max_frame_num;

1258 
cuºSli˚
->
‰amïoc
 = 
p_Vid
->framepoc;

1259 
cuºSli˚
->
ThisPOC
 = 
p_Vid
->ThisPOC;

1260 
cuºSli˚
->
qp
 = 
p_Vid
->
p_cuº_‰m_°ru˘
->qp;

1261 
cuºSli˚
->
°¨t_mb_ƒ
 = 
p_Vid
->
cuºít_mb_ƒ
;

1262 
cuºSli˚
->
cﬁour_∂™e_id
 = 
p_Vid
->colour_plane_id;

1264 
cuºSli˚
->
si_‰ame_ödiˇt‹
 = cuºSli˚->
¶i˚_ty≥
 =
SI_SLICE
 ? 
TRUE
 : 
FALSE
;

1265 
cuºSli˚
->
•2_‰ame_ödiˇt‹
 = 
p_Vid
->sp2_frame_indicator;

1267 
cuºSli˚
->
P444_joöed
 = 
p_Vid
->P444_joined;

1268 
cuºSli˚
->
di°hªs
 = 
p_I≈
->disthres;

1269 
cuºSli˚
->
U£RDOQu™t
 = 
p_I≈
->UseRDOQuant;

1270 
cuºSli˚
->
RDOQ_QP_Num
 = 
p_I≈
->RDOQ_QP_Num;

1271 
cuºSli˚
->
Tønsf‹m8x8Mode
 = 
p_I≈
->Transform8x8Mode;

1273 
cuºSli˚
->
¶i˚_too_big
 = 
dummy_¶i˚_too_big
;

1274 
cuºSli˚
->
width_blk
 = 
p_Vid
->width_blk;

1275 
cuºSli˚
->
height_blk
 = 
p_Vid
->height_blk;

1276 
cuºSli˚
->
∑πôi⁄_mode
 = (Ë
p_I≈
->partition_mode;

1277 
cuºSli˚
->
PicSizeInMbs
 = 
p_Vid
->PicSizeInMbs;

1278 
cuºSli˚
->
num_blk8x8_uv
 = 
p_Vid
->num_blk8x8_uv;

1279 
cuºSli˚
->
«l_ª„ªn˚_idc
 = 
p_Vid
->nal_reference_idc;

1280 
cuºSli˚
->
bôdïth_luma
 = 
p_Vid
->bitdepth_luma;

1281 
cuºSli˚
->
bôdïth_chroma
 = 
p_Vid
->bitdepth_chroma;

1282 
cuºSli˚
->
bôdïth_sˇÀ
[0] = 
p_Vid
->bitdepth_scale[0];

1283 
cuºSli˚
->
bôdïth_sˇÀ
[1] = 
p_Vid
->bitdepth_scale[1];

1284 
cuºSli˚
->
bôdïth_luma_qp_sˇÀ
 = 
p_Vid
->bitdepth_luma_qp_scale;

1285 
cuºSli˚
->
bôdïth_chroma_qp_sˇÀ
 = 
p_Vid
->bitdepth_chroma_qp_scale;

1286 
cuºSli˚
->
bôdïth_œmbda_sˇÀ
 = 
p_Vid
->bitdepth_lambda_scale;

1287 
cuºSli˚
->
dúe˘_•©ül_mv_¥ed_Êag
 = 
p_Vid
->direct_spatial_mv_pred_flag;

1288 
cuºSli˚
->
mb_aff_‰ame_Êag
 = 
p_Vid
->mb_aff_frame_flag;

1289 
cuºSli˚
->
°ru˘uª
 = 
p_Vid
->structure;

1290 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
] = (Ë(
p_Vid
->
a˘ive_µs
->
num_ªf_idx_l0_deÁu…_a˘ive_möus1
 + 1);

1291 
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_1
] = (Ë(
p_Vid
->
a˘ive_µs
->
num_ªf_idx_l1_deÁu…_a˘ive_möus1
 + 1);

1292 
cuºSli˚
->
DFDißbÀIdc
 = (
p_Vid
->
Tu∫DBOff
) ? 1 :Ö_Vid->DFDisableIdc;

1293 
cuºSli˚
->
DFAÕhaC0Off£t
 = 
p_Vid
->DFAlphaC0Offset;

1294 
cuºSli˚
->
DFBëaOff£t
 = 
p_Vid
->DFBetaOffset;

1295 
cuºSli˚
->
võw_id
 = 
p_Vid
->view_id;

1296 
	}
}

1309 
	$öô_¶i˚
 (
VideoP¨amëîs
 *
p_Vid
, 
Sli˚
 **
cuºSli˚
, 
°¨t_mb_addr
)

1311 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

1312 
i
,
j
;

1314 
œyî_id
 = 
p_Vid
->
dpb_œyî_id
;

1316 
£q_∑ømëî_£t_rb•_t
 *
a˘ive_•s
 = 
p_Vid
->active_sps;

1317 
Pi˘uª
 *
cuºPic
 = 
p_Vid
->
cuºítPi˘uª
;

1318 
D©aP¨tôi⁄
 *
d©aP¨t
;

1319 
Bô°ªam
 *
cuºSåóm
;

1320 
a˘ive_ªf_li°s
 = (
p_Vid
->
mb_aff_‰ame_Êag
) ? 6 : 2;

1321 
DecodedPi˘uªBuf„r
 *
p_Dpb
 = 
p_Vid
->
p_Dpb_œyî
[
œyî_id
];

1322 
Æloc_size
 = 0;

1324 #i‡(
MVC_EXTENSION_ENABLE
)

1325 if(
p_I≈
->
num_of_võws
 == 2)

1327 
íabÀ_öãr_võw
 = (
p_Vid
->
«l_ª„ªn˚_idc
 || 
p_I≈
->
íabÀ_öãr_võw_Êag
) ? 1 : 0;

1328 
p_Vid
->
¥i‹ôy_id
 = 0;

1329 
p_Vid
->
ãmp‹Æ_id
 = 0;

1330 
p_Vid
->
öãr_võw_Êag
[0] = ((
œyî_id
 =0Ë? 
íabÀ_öãr_võw
 : 0);

1331 
p_Vid
->
öãr_võw_Êag
[1] = ((
œyî_id
 =0Ë? 
íabÀ_öãr_võw
 : 0);

1333 if(
p_Vid
->
°ru˘uª
!=
BOTTOM_FIELD
)

1334 
p_Vid
->
™ch‹_pic_Êag
[0] = ((’_Vid->
cuºítPi˘uª
->
idr_Êag
 &&Ö_Vid->
«l_ª„ªn˚_idc
!=0Ë||Ö_Vid->
¥ev_võw_is_™ch‹
) ? 1:0);

1336 
p_Vid
->
™ch‹_pic_Êag
[1] = 0;

1337 
p_Vid
->
n⁄_idr_Êag
[p_Vid->
°ru˘uª
!=
BOTTOM_FIELD
 ? 0:1] = !p_Vid->
™ch‹_pic_Êag
[p_Vid->structure!=BOTTOM_FIELD ? 0:1];

1341 
p_Vid
->
cuºít_mb_ƒ
 = 
°¨t_mb_addr
;

1344 
	`as£π
 (
cuºPic
 !
NULL
);

1345 
cuºPic
->
no_¶i˚s
++;

1347 i‡(
cuºPic
->
no_¶i˚s
 >
MAXSLICEPERPICTURE
)

1348 
	`îr‹
 ("Too many slicesÖerÖicture, increase MAXSLICEPERPICTURE in global.h.", -1);

1350 
cuºPic
->
¶i˚s
[cuºPic->
no_¶i˚s
 - 1] = 
	`mÆloc_¶i˚
(
p_Vid
, 
p_I≈
);

1351 *
cuºSli˚
 = 
cuºPic
->
¶i˚s
[cuºPic->
no_¶i˚s
-1];

1353 
p_Vid
->
cuºítSli˚
 = *
cuºSli˚
;

1354 
	`£t_¶i˚
 (
p_Vid
, *
cuºSli˚
);

1357 if(
p_I≈
->
ªdund™t_pic_Êag
)

1359 if(!
p_Vid
->
ªdund™t_codög
)

1361 (*
cuºSli˚
)->
num_ªf_idx_a˘ive
[
LIST_0
] = (Ë
	`imö
(
p_Vid
->
numbî
,
p_I≈
->
NumRefPrim¨y
);

1366 (*
cuºSli˚
)->
num_ªf_idx_a˘ive
[
LIST_0
] = 1;

1370 
i
 = 0; i < (*
cuºSli˚
)->
max_∑π_ƒ
; i++)

1372 
d©aP¨t
 = &(*
cuºSli˚
)->
∑πAº
[
i
];

1374 
cuºSåóm
 = 
d©aP¨t
->
bô°ªam
;

1375 
cuºSåóm
->
bôs_to_go
 = 8;

1376 
cuºSåóm
->
byã_pos
 = 0;

1377 
cuºSåóm
->
byã_buf
 = 0;

1381 i‡(((*
cuºSli˚
)->
¶i˚_ty≥
 =
P_SLICE
 || (*cuºSli˚)->¶i˚_ty≥ =
SP_SLICE
Ë&& 
p_I≈
->
P_Li°0_ªfs
[
œyî_id
])

1383 (*
cuºSli˚
)->
num_ªf_idx_a˘ive
[
LIST_0
] = (Ë
	`imö
((*cuºSli˚)->num_ªf_idx_a˘ive[LIST_0], 
p_I≈
->
P_Li°0_ªfs
[
œyî_id
] * ((
p_Vid
->
°ru˘uª
 !=0) + 1));

1384 #i‡
CRA


1385 i‡–
p_I≈
->
u£CRA
 )

1387 i‡––((*
cuºSli˚
)->
ThisPOC
/2Ë- (
p_Vid
->
p_I≈
->
NumbîBFømes
+1ËË%Ö_Vid->p_I≈->
öåa_≥riod
 == 0 )

1389 (*
cuºSli˚
)->
num_ªf_idx_a˘ive
[
LIST_0
] = () 1;

1395 i‡((*
cuºSli˚
)->
¶i˚_ty≥
 =
B_SLICE
 )

1397 i‡(
p_I≈
->
B_Li°0_ªfs
[
œyî_id
])

1399 #i‡
B0_MORE_REF


1400 i‡–
p_I≈
->
BLevñ0M‹eRef
 )

1402 i‡–((*
cuºSli˚
)->
ThisPOC
/2Ë% (
p_Vid
->
p_I≈
->
NumbîBFømes
+1) == 0 )

1404 (*
cuºSli˚
)->
num_ªf_idx_a˘ive
[
LIST_0
] = (Ë
	`imö
((*cuºSli˚)->num_ªf_idx_a˘ive[LIST_0], 
p_I≈
->
P_Li°0_ªfs
[
œyî_id
] * ((
p_Vid
->
°ru˘uª
 !=0) + 1));

1408 (*
cuºSli˚
)->
num_ªf_idx_a˘ive
[
LIST_0
] = (Ë
	`imö
((*cuºSli˚)->num_ªf_idx_a˘ive[LIST_0], 
p_I≈
->
B_Li°0_ªfs
[
œyî_id
] * ((
p_Vid
->
°ru˘uª
 !=0) + 1));

1413 (*
cuºSli˚
)->
num_ªf_idx_a˘ive
[
LIST_0
] = (Ë
	`imö
((*cuºSli˚)->num_ªf_idx_a˘ive[LIST_0], 
p_I≈
->
B_Li°0_ªfs
[
œyî_id
] * ((
p_Vid
->
°ru˘uª
 !=0) + 1));

1415 #i‡
CRA


1416 i‡–
p_I≈
->
u£CRA
 )

1418 i‡––((*
cuºSli˚
)->
ThisPOC
/2Ë- (
p_Vid
->
p_I≈
->
NumbîBFømes
+1ËË%Ö_Vid->p_I≈->
öåa_≥riod
 == 0 )

1420 (*
cuºSli˚
)->
num_ªf_idx_a˘ive
[
LIST_0
] = () 1;

1425 i‡(
p_I≈
->
B_Li°1_ªfs
[
œyî_id
])

1427 (*
cuºSli˚
)->
num_ªf_idx_a˘ive
[
LIST_1
] = (Ë
	`imö
((*cuºSli˚)->num_ªf_idx_a˘ive[LIST_1], 
p_I≈
->
B_Li°1_ªfs
[
œyî_id
] * ((
p_Vid
->
°ru˘uª
 !=0) + 1));

1428 #i‡
B0_MORE_REF


1429 i‡–
p_I≈
->
BLevñ0M‹eRef
 )

1431 i‡–((*
cuºSli˚
)->
ThisPOC
/2Ë% (
p_Vid
->
p_I≈
->
NumbîBFømes
+1) == 0 )

1433 (*
cuºSli˚
)->
num_ªf_idx_a˘ive
[
LIST_1
] = (*cuºSli˚)->num_ªf_idx_a˘ive[
LIST_0
];

1437 #i‡
CRA


1438 i‡–
p_I≈
->
u£CRA
 )

1440 i‡––((*
cuºSli˚
)->
ThisPOC
/2Ë- (
p_Vid
->
p_I≈
->
NumbîBFømes
+1ËË%Ö_Vid->p_I≈->
öåa_≥riod
 == 0 )

1442 (*
cuºSli˚
)->
num_ªf_idx_a˘ive
[
LIST_1
] = (*cuºSli˚)->num_ªf_idx_a˘ive[
LIST_0
];

1447 
	`gë_mem3D
((
byã
 ****)(*)&(*
cuºSli˚
)->
dúe˘_ªf_idx
, (*cuºSli˚)->
height_blk
, (*cuºSli˚)->
width_blk
, 2);

1448 
	`gë_mem2D
((
byã
 ***Ë(*)&(*
cuºSli˚
)->
dúe˘_pdú
, (*cuºSli˚)->
height_blk
, (*cuºSli˚)->
width_blk
);

1451 
	`£tup_¶i˚
(*
cuºSli˚
);

1452 
	`upd©e_pic_num
(*
cuºSli˚
);

1454 (*
cuºSli˚
)->
	`öô_li°s
(*currSlice);

1457 (*
cuºSli˚
)->
num_ªf_idx_a˘ive
[
LIST_0
] = (*cuºSli˚)->
li°Xsize
[LIST_0];

1458 (*
cuºSli˚
)->
num_ªf_idx_a˘ive
[
LIST_1
] = (*cuºSli˚)->
li°Xsize
[LIST_1];

1460 #i‡
CRA


1461 i‡–
p_I≈
->
u£CRA
 )

1463 i‡––(*
cuºSli˚
)->
¶i˚_ty≥
 =
B_SLICE
 || (*cuºSli˚)->¶i˚_ty≥ =
P_SLICE
 ) && (*cuºSli˚)->
p_Dpb
->
ªf_‰ames_ö_buf„r
 >= 2 )

1465 i‡––((*
cuºSli˚
)->
ThisPOC
/2Ë- (
p_Vid
->
p_I≈
->
NumbîBFømes
+1ËË%Ö_Vid->p_I≈->
öåa_≥riod
 == 0 )

1467 
	`¸a_ªf_m™agemít_‰ame_pic
(
p_Dpb
, 
p_Vid
->
‰ame_num
);

1473 #i‡
HM50_LIKE_MMCO


1474 i‡–
p_I≈
->
HM50RefSåu˘uª
 )

1476 i‡(
p_Vid
->
°ru˘uª
 =
FRAME
 && 
p_Dpb
->
ªf_‰ames_ö_buf„r
 =
a˘ive_•s
->
num_ªf_‰ames
)

1477 
	`hm50_ªf_m™agemít_‰ame_pic
(
p_Dpb
, 
p_Vid
->
‰ame_num
);

1481 #i‡
LD_REF_SETTING


1482 i‡–
p_I≈
->
LDRefSëtög
 )

1484 i‡(
p_Vid
->
°ru˘uª
 =
FRAME
 && 
p_Dpb
->
ªf_‰ames_ö_buf„r
 =
a˘ive_•s
->
num_ªf_‰ames
)

1485 
	`low_dñay_ªf_m™agemít_‰ame_pic
(
p_Dpb
, 
p_Vid
->
‰ame_num
);

1490 i‡(
p_I≈
->
SëFú°AsL⁄gTîm
 && 
p_Vid
->
numbî
 == 0)

1492 
	`mmco_l⁄g_ãrm
(
p_Vid
,Ö_Vid->
numbî
);

1494 i‡(
p_Vid
->
«l_ª„ªn˚_idc
 && 
p_I≈
->
PocMem‹yM™agemít
 == 1)

1496 i‡(
p_Vid
->
°ru˘uª
 =
FRAME
 && 
p_Dpb
->
ªf_‰ames_ö_buf„r
 =
a˘ive_•s
->
num_ªf_‰ames
)

1497 
	`poc_ba£d_ªf_m™agemít_‰ame_pic
(
p_Dpb
, 
p_Vid
->
‰ame_num
);

1498 i‡(
p_Vid
->
°ru˘uª
 =
TOP_FIELD
 && 
p_Dpb
->
ªf_‰ames_ö_buf„r
=
a˘ive_•s
->
num_ªf_‰ames
)

1499 
	`poc_ba£d_ªf_m™agemít_fõld_pic
(
p_Dpb
, (
p_Vid
->
‰ame_num
 << 1) + 1);

1500 i‡(
p_Vid
->
°ru˘uª
 =
BOTTOM_FIELD
)

1501 
	`poc_ba£d_ªf_m™agemít_fõld_pic
(
p_Dpb
, (
p_Vid
->
‰ame_num
 << 1) + 1);

1503 i‡(
p_Vid
->
«l_ª„ªn˚_idc
 && 
p_I≈
->
PocMem‹yM™agemít
 == 2)

1505 i‡(
p_Vid
->
°ru˘uª
 =
FRAME
)

1506 
	`éyr_ba£d_ªf_m™agemít_‰ame_pic
(
p_Vid
,Ö_Vid->
‰ame_num
);

1509 
	`£t_deÁu…_ªf_pic_li°s
(*
cuºSli˚
);

1512 
	`öô_ªf_pic_li°_ª‹dîög
(*
cuºSli˚
, 
p_I≈
->
Re„ªn˚Re‹dî
);

1513 
	`Æloc_ªf_pic_li°_ª‹dîög_buf„r
(*
cuºSli˚
);

1515 #i‡(
MVC_EXTENSION_ENABLE
)

1516 
p_Vid
->
MVCI¡îVõwRe‹dî
 = 0;

1518 if(
p_Vid
->
num_of_œyîs
 =2 && 
p_I≈
->
MVCI¡îVõwRe‹dî
 =1 && 
œyî_id
 == 1)

1521 
p_Vid
->
MVCI¡îVõwRe‹dî
 = 1;

1523 (*
cuºSli˚
)->
	`ª‹dî_li°s
( *currSlice );

1525 if((*
cuºSli˚
)->
li°Xsize
[0]!=0)

1527 
St‹abÀPi˘uª
 *
I¡î_VõwL0
 = (*
cuºSli˚
)->
li°X
[0][(*cuºSli˚)->
li°Xsize
[0]-1];

1530 
i
=(*
cuºSli˚
)->
li°Xsize
[0] - 1; i>0; i--)

1531 (*
cuºSli˚
)->
li°X
[0][
i
] = (*currSlice)->listX[0][i - 1];

1532 (*
cuºSli˚
)->
li°X
[0][0] = 
I¡î_VõwL0
;

1533 (*
cuºSli˚
)->
li°Xsize
[0] = (Ë
	`imö
 ((*cuºSli˚)->li°Xsize[0], (*cuºSli˚)->
num_ªf_idx_a˘ive
[
LIST_0
]);

1542 if(
p_I≈
->
ªdund™t_pic_Êag
 && 
p_Vid
->
ªdund™t_codög
)

1544 
	`Æloc_ªf_pic_li°_ª‹dîög_buf„r
(*
cuºSli˚
);

1545 (*
cuºSli˚
)->
ªf_pic_li°_ª‹dîög_Êag
[
LIST_0
] = 1;

1546 (*
cuºSli˚
)->
modifiˇti⁄_of_pic_nums_idc
[
LIST_0
][0] = 0;

1547 (*
cuºSli˚
)->
modifiˇti⁄_of_pic_nums_idc
[
LIST_0
][1] = 3;

1548 (*
cuºSli˚
)->
abs_diff_pic_num_möus1
[
LIST_0
][0] = 
p_Vid
->
ªdund™t_ªf_idx
 - 1;

1549 (*
cuºSli˚
)->
l⁄g_ãrm_pic_idx
[
LIST_0
][0] = 0;

1551 
	`ª‹dî_ªf_pic_li°
 ( *
cuºSli˚
, 
LIST_0
);

1553 i‡(–(*
cuºSli˚
)->
¶i˚_ty≥
 =
P_SLICE
 || (*cuºSli˚)->¶i˚_ty≥ =
B_SLICE
Ë&& 
p_I≈
->
WPMCPªcisi⁄
 && 
p_Vid
->
pWPX
->
cuº_wp_rd_∑ss
->
Æg‹ôhm
 !
WP_REGULAR
 )

1554 
	`wp_m˝ªc_ª‹dî_li°s
–*
cuºSli˚
 );

1556 (*
cuºSli˚
)->
	`ª‹dî_li°s
( *currSlice );

1558 i‡(
p_I≈
->
E«bÀO≥nGOP
)

1559 
	`£tup_›í_g›_li°s
(
p_Vid
, *
cuºSli˚
);

1562 #i‡
PRINTREFLIST


1563 #i‡(
MVC_EXTENSION_ENABLE
)

1564 i‡–(*
cuºSli˚
)->
¶i˚_ty≥
 =
P_SLICE
 )

1567 if(
p_Vid
->
cuºít_¶i˚_ƒ
==0)

1569 if((*
cuºSli˚
)->
li°Xsize
[0]>0)

1571 
	`¥ötf
("\n");

1572 
	`¥ötf
(" ** (CurVõwID:%dË%†Re‡Pi¯Li° 0 ****\n", 
œyî_id
, (*
cuºSli˚
)->
°ru˘uª
==
FRAME
 ? "FRM":((*cuºSli˚)->°ru˘uª==
TOP_FIELD
 ? "TOP":"BOT"));

1573 
i
=0; i<()((*
cuºSli˚
)->
li°Xsize
[0]); i++)

1575 
	`¥ötf
(" %2d -> POC: %4d PicNum: %4d VõwID: %d\n", 
i
, (*
cuºSli˚
)->
li°X
[0][i]->
poc
, (*cuºSli˚)->li°X[0][i]->
pic_num
, (*cuºSli˚)->li°X[0][i]->
võw_id
);

1580 i‡–(*
cuºSli˚
)->
¶i˚_ty≥
 =
B_SLICE
 )

1583 if(
p_Vid
->
cuºít_¶i˚_ƒ
==0)

1585 if(((*
cuºSli˚
)->
li°Xsize
[0]>0) || ((*currSlice)->listXsize[1]>0))

1586 
	`¥ötf
("\n");

1587 if((*
cuºSli˚
)->
li°Xsize
[0]>0)

1589 
	`¥ötf
(" ** (CurVõwID:%dË%†Re‡Pi¯Li° 0 ****\n", 
œyî_id
, (*
cuºSli˚
)->
°ru˘uª
==
FRAME
 ? "FRM":((*cuºSli˚)->°ru˘uª==
TOP_FIELD
 ? "TOP":"BOT"));

1590 
i
=0; i<()((*
cuºSli˚
)->
li°Xsize
[0]); i++)

1592 
	`¥ötf
(" %2d -> POC: %4d PicNum: %4d VõwID: %d\n", 
i
, (*
cuºSli˚
)->
li°X
[0][i]->
poc
, (*cuºSli˚)->li°X[0][i]->
pic_num
, (*cuºSli˚)->li°X[0][i]->
võw_id
);

1595 if((*
cuºSli˚
)->
li°Xsize
[1]>0)

1597 
	`¥ötf
(" ** (CurVõwID:%dË%†Re‡Pi¯Li° 1 ****\n", 
œyî_id
, (*
cuºSli˚
)->
°ru˘uª
==
FRAME
 ? "FRM":((*cuºSli˚)->°ru˘uª==
TOP_FIELD
 ? "TOP":"BOT"));

1598 
i
=0; i<()((*
cuºSli˚
)->
li°Xsize
[1]); i++)

1600 
	`¥ötf
(" %2d -> POC: %4d PicNum: %4d VõwID: %d\n", 
i
, (*
cuºSli˚
)->
li°X
[1][i]->
poc
, (*cuºSli˚)->li°X[1][i]->
pic_num
, (*cuºSli˚)->li°X[1][i]->
võw_id
);

1608 (*
cuºSli˚
)->
max_num_ª„ªn˚s
 = (Ë
p_Vid
->max_num_references;

1610 i‡(((*
cuºSli˚
)->
¶i˚_ty≥
 !
I_SLICE
Ë&& (*cuºSli˚)->¶i˚_ty≥ !
SI_SLICE
)

1612 
Æloc_size
 +
	`gë_mem5Dmv
 (&((*
cuºSli˚
)->
Æl_mv
), 2, (*cuºSli˚)->
max_num_ª„ªn˚s
, 9, 4, 4);

1614 i‡(
p_I≈
->
BiPªdMŸi⁄E°im©i⁄
 && ((*
cuºSli˚
)->
¶i˚_ty≥
 =
B_SLICE
))

1616 
Æloc_size
 +
	`gë_mem6Dmv
 (&((*
cuºSli˚
)->
bùªd_mv
), 2, 2, (*cuºSli˚)->
max_num_ª„ªn˚s
, 9, 4, 4);

1619 i‡(
p_I≈
->
U£RDOQu™t
 &&Ö_I≈->
RDOQ_QP_Num
 > 1)

1621 i‡(
p_I≈
->
Tønsf‹m8x8Mode
 &&Ö_I≈->
RDOQ_CP_MV
)

1623 
	`gë_mem4Dmv
 (&(*
cuºSli˚
)->
tmp_mv8
, 2, (*cuºSli˚)->
max_num_ª„ªn˚s
, 4, 4);

1624 
	`gë_mem3Ddi°blk
(&(*
cuºSli˚
)->
mŸi⁄_co°8
, 2, (*cuºSli˚)->
max_num_ª„ªn˚s
, 4);

1625 
	`gë_mem4Dmv
 (&(*
cuºSli˚
)->
tmp_mv4
, 2, (*cuºSli˚)->
max_num_ª„ªn˚s
, 4, 4);

1626 
	`gë_mem3Ddi°blk
(&(*
cuºSli˚
)->
mŸi⁄_co°4
, 2, (*cuºSli˚)->
max_num_ª„ªn˚s
, 4);

1631 i‡(
p_Vid
->
mb_aff_‰ame_Êag
)

1632 
	`öô_mbaff_li°s
(*
cuºSli˚
);

1634 i‡(((*
cuºSli˚
)->
¶i˚_ty≥
 !
I_SLICE
 && (*cuºSli˚)->¶i˚_ty≥ !
SI_SLICE
Ë&& (
p_Vid
->
a˘ive_µs
->
weighãd_¥ed_Êag
 =1 || (p_Vid->a˘ive_µs->
weighãd_bùªd_idc
 > 0 && ((*cuºSli˚)->¶i˚_ty≥ =
B_SLICE
))))

1636 i‡((*
cuºSli˚
)->
¶i˚_ty≥
 =
P_SLICE
 || (*cuºSli˚)->¶i˚_ty≥ =
SP_SLICE
)

1638 
wp_ty≥
 = (
p_I≈
->
Gíî©eMu…ùÀPPS
 &&Ö_I≈->
RDPi˘uªDecisi⁄
Ë&& (
p_Vid
->
íc_pi˘uª
 !p_Vid->
íc_‰ame_pi˘uª
[1]);

1639 
p_Vid
->
	`E°im©eWPPSli˚
 (*
cuºSli˚
, 
wp_ty≥
);

1642 
p_Vid
->
	`E°im©eWPBSli˚
 (*
cuºSli˚
);

1644 
	`ClùWPP¨ams
–*
cuºSli˚
 );

1647 i‡((*
cuºSli˚
)->
¶i˚_ty≥
 =
B_SLICE
)

1650 
	`compuã_cﬁoˇãd
(*
cuºSli˚
, (*cuºSli˚)->
li°X
);

1653 i‡((*
cuºSli˚
)->
¶i˚_ty≥
 !
I_SLICE
 && (*cuºSli˚)->¶i˚_ty≥ !
SI_SLICE
)

1655 
p_Vid
->
£¨chR™ge
.
mö_x
 = -
p_I≈
->
£¨ch_ønge
[
œyî_id
] << 2;

1656 
p_Vid
->
£¨chR™ge
.
max_x
 = 
p_I≈
->
£¨ch_ønge
[
œyî_id
] << 2;

1657 
p_Vid
->
£¨chR™ge
.
mö_y
 = -
p_I≈
->
£¨ch_ønge
[
œyî_id
] << 2;

1658 
p_Vid
->
£¨chR™ge
.
max_y
 = 
p_I≈
->
£¨ch_ønge
[
œyî_id
] << 2;

1660 i‡(
p_I≈
->
SórchMode
[
œyî_id
] =
EPZS
)

1662 i‡(((*
cuºSli˚
)->
p_EPZS
 = (
EPZSP¨amëîs
*Ë
	`ˇŒoc
(1, (EPZSP¨amëîs)))==
NULL
)

1663 
	`no_mem_exô
("init_slice:Ö_EPZS");

1664 
	`EPZSSåu˘Inô
 (*
cuºSli˚
);

1665 
	`EPZSSli˚Inô
 (*
cuºSli˚
);

1670 i‡((*
cuºSli˚
)->
symbﬁ_mode
 =
CAVLC
)

1672 
	`£tup_ˇvlc
(*
cuºSli˚
, (*cuºSli˚)->
li°Xsize
);

1676 
	`£tup_ˇbac
(*
cuºSli˚
, (*cuºSli˚)->
li°Xsize
);

1681 
i
 = 0; i < 
a˘ive_ªf_li°s
; i++)

1683 
j
 = 0; j < (*
cuºSli˚
)->
li°Xsize
[
i
]; j++)

1685 if–(*
cuºSli˚
)->
li°X
[
i
][
j
] )

1687 (*
cuºSli˚
)->
li°X
[
i
][
j
]->
p_cuº_img
 = (*cuºSli˚)->li°X[i][j]->
p_img
 [(Ë
p_Vid
->
cﬁour_∂™e_id
];

1688 (*
cuºSli˚
)->
li°X
[
i
][
j
]->
p_cuº_img_sub
 = (*cuºSli˚)->li°X[i][j]->
p_img_sub
[(Ë
p_Vid
->
cﬁour_∂™e_id
];

1693 i‡(
p_I≈
->
U£RDOQu™t
)

1695 i‡(((*
cuºSli˚
)->
e°BôsCabac
 = (
e°BôsCabacSåu˘
*Ë
	`ˇŒoc
(
NUM_BLOCK_TYPES
, ”°BôsCabacSåu˘)))==
NULL
)

1696 
	`no_mem_exô
("init_slice: (*currSlice)->estBitsCabac");

1698 
	`öô_rdoq_¶i˚
(*
cuºSli˚
);

1700 
	`Æloc_rdd©a
(*
cuºSli˚
, &(*cuºSli˚)->
rdd©a_åñlis_cuº
);

1701 i‡(
p_I≈
->
RDOQ_QP_Num
 > 1)

1703 
	`Æloc_rdd©a
(*
cuºSli˚
, &(*cuºSli˚)->
rdd©a_åñlis_be°
);

1707 if(
p_Vid
->
mb_aff_‰ame_Êag
)

1709 
	`Æloc_rdd©a
(*
cuºSli˚
, &(*cuºSli˚)->
rdd©a_t›_‰ame_mb
);

1710 
	`Æloc_rdd©a
(*
cuºSli˚
, &(*cuºSli˚)->
rdd©a_bŸ_‰ame_mb
);

1711 i‡–
p_I≈
->
MbI¡îœ˚
 !
FRAME_MB_PAIR_CODING
 )

1713 
	`Æloc_rdd©a
(*
cuºSli˚
, &(*cuºSli˚)->
rdd©a_t›_fõld_mb
);

1714 
	`Æloc_rdd©a
(*
cuºSli˚
, &(*cuºSli˚)->
rdd©a_bŸ_fõld_mb
);

1718 i‡((*
cuºSli˚
)->
¶i˚_ty≥
 =
B_SLICE
)

1720 (*
cuºSli˚
)->
£t_mŸi⁄_ve˘‹s_mb
 = 
SëMŸi⁄Ve˘‹sMBBSli˚
;

1722 i‡((*
cuºSli˚
)->
¶i˚_ty≥
 =
P_SLICE
 || (*cuºSli˚)->¶i˚_ty≥ =
SP_SLICE
)

1724 (*
cuºSli˚
)->
£t_mŸi⁄_ve˘‹s_mb
 = 
SëMŸi⁄Ve˘‹sMBPSli˚
;

1728 (*
cuºSli˚
)->
£t_mŸi⁄_ve˘‹s_mb
 = 
SëMŸi⁄Ve˘‹sMBISli˚
;

1731 
	`gë_mem3D≥l
(&((*
cuºSli˚
)->
mb_¥ed
), 
MAX_PLANE
, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE);

1732 
	`gë_mem3Döt
(&((*
cuºSli˚
)->
mb_ºes
), 
MAX_PLANE
, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE);

1733 
	`gë_mem3Döt
(&((*
cuºSli˚
)->
mb_‹es
), 
MAX_PLANE
, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE);

1734 
	`gë_mem4D≥l
(&((*
cuºSli˚
)->
m¥_4x4
), 
MAX_PLANE
, 9, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE);

1735 
	`gë_mem4D≥l
(&((*
cuºSli˚
)->
m¥_8x8
), 
MAX_PLANE
, 9, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE);

1736 
	`gë_mem4D≥l
(&((*
cuºSli˚
)->
m¥_16x16
), 
MAX_PLANE
, 5, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE);

1738 
	`gë_mem_ACc€ff
 (
p_Vid
, &((*
cuºSli˚
)->
cofAC
));

1739 
	`gë_mem_DCc€ff
 (&((*
cuºSli˚
)->
cofDC
));

1741 
	`Æloˇã_block_mem
(*
cuºSli˚
);

1742 
	`öô_codög_°©e_mëhods
(*
cuºSli˚
);

1743 
	`öô_rd›t
(*
cuºSli˚
);

1744 
	}
}

1757 
	$öô_¶i˚_lôe
 (
VideoP¨amëîs
 *
p_Vid
, 
Sli˚
 **
cuºSli˚
, 
°¨t_mb_addr
)

1759 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

1760 
i
,
j
;

1761 #i‡(
MVC_EXTENSION_ENABLE
)

1762 
œyî_id
 = 
p_Vid
->
dpb_œyî_id
;

1764 
œyî_id
 = 0;

1766 
a˘ive_ªf_li°s
 = (
p_Vid
->
mb_aff_‰ame_Êag
) ? 6 : 2;

1768 #i‡(
MVC_EXTENSION_ENABLE
)

1769 if(
p_I≈
->
num_of_võws
 == 2)

1771 
íabÀ_öãr_võw
 = (
p_Vid
->
«l_ª„ªn˚_idc
 || 
p_I≈
->
íabÀ_öãr_võw_Êag
) ? 1 : 0;

1772 
p_Vid
->
¥i‹ôy_id
 = 0;

1773 
p_Vid
->
ãmp‹Æ_id
 = 0;

1774 
p_Vid
->
öãr_võw_Êag
[0] = ((
œyî_id
 =0Ë? 
íabÀ_öãr_võw
 : 0);

1775 
p_Vid
->
öãr_võw_Êag
[1] = ((
œyî_id
 =0Ë? 
íabÀ_öãr_võw
 : 0);

1777 if(
p_Vid
->
°ru˘uª
!=
BOTTOM_FIELD
)

1778 
p_Vid
->
™ch‹_pic_Êag
[0] = ((’_Vid->
cuºítPi˘uª
->
idr_Êag
 &&Ö_Vid->
«l_ª„ªn˚_idc
!=0Ë||Ö_Vid->
¥ev_võw_is_™ch‹
) ? 1:0);

1780 
p_Vid
->
™ch‹_pic_Êag
[1] = 0;

1781 
p_Vid
->
n⁄_idr_Êag
[p_Vid->
°ru˘uª
!=
BOTTOM_FIELD
 ? 0:1] = !p_Vid->
™ch‹_pic_Êag
[p_Vid->structure!=BOTTOM_FIELD ? 0:1];

1785 *
cuºSli˚
 = 
	`mÆloc_¶i˚_lôe
(
p_Vid
, 
p_I≈
);

1787 
	`£t_¶i˚
 (
p_Vid
, *
cuºSli˚
);

1790 i‡(((*
cuºSli˚
)->
¶i˚_ty≥
 =
P_SLICE
 || (*cuºSli˚)->¶i˚_ty≥ =
SP_SLICE
Ë&& 
p_I≈
->
P_Li°0_ªfs
[
œyî_id
])

1792 (*
cuºSli˚
)->
num_ªf_idx_a˘ive
[
LIST_0
] = (Ë
	`imö
((*cuºSli˚)->num_ªf_idx_a˘ive[LIST_0], 
p_I≈
->
P_Li°0_ªfs
[
œyî_id
] * ((
p_Vid
->
°ru˘uª
 !=0) + 1));

1795 i‡((*
cuºSli˚
)->
¶i˚_ty≥
 =
B_SLICE
 )

1797 i‡(
p_I≈
->
B_Li°0_ªfs
[
œyî_id
])

1799 (*
cuºSli˚
)->
num_ªf_idx_a˘ive
[
LIST_0
] = (Ë
	`imö
((*cuºSli˚)->num_ªf_idx_a˘ive[LIST_0], 
p_I≈
->
B_Li°0_ªfs
[
œyî_id
] * ((
p_Vid
->
°ru˘uª
 !=0) + 1));

1801 i‡(
p_I≈
->
B_Li°1_ªfs
[
œyî_id
])

1803 (*
cuºSli˚
)->
num_ªf_idx_a˘ive
[
LIST_1
] = (Ë
	`imö
((*cuºSli˚)->num_ªf_idx_a˘ive[LIST_1], 
p_I≈
->
B_Li°1_ªfs
[
œyî_id
] * ((
p_Vid
->
°ru˘uª
 !=0) + 1));

1807 
	`£tup_¶i˚
(*
cuºSli˚
);

1809 
	`upd©e_pic_num
(*
cuºSli˚
);

1810 (*
cuºSli˚
)->
	`öô_li°s
(*currSlice);

1813 (*
cuºSli˚
)->
num_ªf_idx_a˘ive
[
LIST_0
] = (*cuºSli˚)->
li°Xsize
[LIST_0];

1814 (*
cuºSli˚
)->
num_ªf_idx_a˘ive
[
LIST_1
] = (*cuºSli˚)->
li°Xsize
[LIST_1];

1816 
	`£t_deÁu…_ªf_pic_li°s
(*
cuºSli˚
);

1818 
	`öô_ªf_pic_li°_ª‹dîög
(*
cuºSli˚
, 
p_I≈
->
Re„ªn˚Re‹dî
);

1819 
	`Æloc_ªf_pic_li°_ª‹dîög_buf„r
(*
cuºSli˚
);

1821 #i‡(
MVC_EXTENSION_ENABLE
)

1822 
p_Vid
->
MVCI¡îVõwRe‹dî
 = 0;

1823 if(
p_Vid
->
num_of_œyîs
 =2 && 
p_I≈
->
MVCI¡îVõwRe‹dî
 =1 && 
œyî_id
 == 1)

1826 
p_Vid
->
MVCI¡îVõwRe‹dî
 = 1;

1828 if((*
cuºSli˚
)->
li°Xsize
[0]!=0)

1830 
St‹abÀPi˘uª
 *
I¡î_VõwL0
 = (*
cuºSli˚
)->
li°X
[0][(*cuºSli˚)->
li°Xsize
[0]-1];

1831 
i
=(*
cuºSli˚
)->
li°Xsize
[0] - 1; i>0; i--)

1832 (*
cuºSli˚
)->
li°X
[0][
i
] = (*currSlice)->listX[0][i - 1];

1833 (*
cuºSli˚
)->
li°X
[0][0] = 
I¡î_VõwL0
;

1834 (*
cuºSli˚
)->
li°Xsize
[0] = (Ë
	`imö
 ((*cuºSli˚)->li°Xsize[0], (*cuºSli˚)->
num_ªf_idx_a˘ive
[
LIST_0
]);

1836 (*
cuºSli˚
)->
	`ª‹dî_li°s
( *currSlice );

1844 if(
p_I≈
->
ªdund™t_pic_Êag
 && 
p_Vid
->
ªdund™t_codög
)

1846 (*
cuºSli˚
)->
ªf_pic_li°_ª‹dîög_Êag
[
LIST_0
] = 1;

1847 (*
cuºSli˚
)->
modifiˇti⁄_of_pic_nums_idc
[
LIST_0
][0] = 0;

1848 (*
cuºSli˚
)->
modifiˇti⁄_of_pic_nums_idc
[
LIST_0
][1] = 3;

1849 (*
cuºSli˚
)->
abs_diff_pic_num_möus1
[
LIST_0
][0] = 
p_Vid
->
ªdund™t_ªf_idx
 - 1;

1850 (*
cuºSli˚
)->
l⁄g_ãrm_pic_idx
[
LIST_0
][0] = 0;

1852 
	`ª‹dî_ªf_pic_li°
 ( *
cuºSli˚
, 
LIST_0
);

1854 i‡–((*
cuºSli˚
)->
¶i˚_ty≥
 =
P_SLICE
 || (*cuºSli˚)->¶i˚_ty≥ =
B_SLICE
Ë&& 
p_I≈
->
WPMCPªcisi⁄
 && 
p_Vid
->
pWPX
->
cuº_wp_rd_∑ss
->
Æg‹ôhm
 !
WP_REGULAR
 )

1855 
	`wp_m˝ªc_ª‹dî_li°s
–*
cuºSli˚
 );

1857 (*
cuºSli˚
)->
	`ª‹dî_li°s
( *currSlice );

1859 i‡(
p_I≈
->
E«bÀO≥nGOP
)

1860 
	`£tup_›í_g›_li°s
(
p_Vid
, *
cuºSli˚
);

1863 (*
cuºSli˚
)->
max_num_ª„ªn˚s
 = (Ë
p_Vid
->max_num_references;

1865 i‡(
p_Vid
->
mb_aff_‰ame_Êag
)

1866 
	`öô_mbaff_li°s
(*
cuºSli˚
);

1869 
i
 = 0; i < 
a˘ive_ªf_li°s
; i++)

1871 
j
 = 0; j < (*
cuºSli˚
)->
li°Xsize
[
i
]; j++)

1873 if–(*
cuºSli˚
)->
li°X
[
i
][
j
] )

1875 (*
cuºSli˚
)->
li°X
[
i
][
j
]->
p_cuº_img
 = (*cuºSli˚)->li°X[i][j]->
p_img
 [(Ë
p_Vid
->
cﬁour_∂™e_id
];

1876 (*
cuºSli˚
)->
li°X
[
i
][
j
]->
p_cuº_img_sub
 = (*cuºSli˚)->li°X[i][j]->
p_img_sub
[(Ë
p_Vid
->
cﬁour_∂™e_id
];

1881 (*
cuºSli˚
)->
e°BôsCabac
 = 
NULL
;

1882 
	`nuŒify_rdd©a
(&((*
cuºSli˚
)->
rdd©a_åñlis_cuº
));

1883 
	`nuŒify_rdd©a
(&((*
cuºSli˚
)->
rdd©a_åñlis_be°
));

1885 if(
p_Vid
->
mb_aff_‰ame_Êag
)

1887 
	`nuŒify_rdd©a
(&((*
cuºSli˚
)->
rdd©a_t›_‰ame_mb
));

1888 
	`nuŒify_rdd©a
(&((*
cuºSli˚
)->
rdd©a_bŸ_‰ame_mb
));

1889 i‡–
p_I≈
->
MbI¡îœ˚
 !
FRAME_MB_PAIR_CODING
 )

1891 
	`nuŒify_rdd©a
(&((*
cuºSli˚
)->
rdd©a_t›_fõld_mb
));

1892 
	`nuŒify_rdd©a
(&((*
cuºSli˚
)->
rdd©a_bŸ_fõld_mb
));

1896 (*
cuºSli˚
)->
Æl_mv
 = 
NULL
;

1897 (*
cuºSli˚
)->
bùªd_mv
 = 
NULL
;

1899 (*
cuºSli˚
)->
tmp_mv8
 = 
NULL
;

1900 (*
cuºSli˚
)->
mŸi⁄_co°8
 = 
NULL
;

1901 (*
cuºSli˚
)->
tmp_mv4
 = 
NULL
;

1902 (*
cuºSli˚
)->
mŸi⁄_co°4
 = 
NULL
;

1903 (*
cuºSli˚
)->
p_EPZS
 = 
NULL
;

1905 (*
cuºSli˚
)->
mb_¥ed
 = 
NULL
;

1906 (*
cuºSli˚
)->
mb_ºes
 = 
NULL
;

1907 (*
cuºSli˚
)->
mb_‹es
 = 
NULL
;

1908 (*
cuºSli˚
)->
m¥_4x4
 = 
NULL
;

1909 (*
cuºSli˚
)->
m¥_8x8
 = 
NULL
;

1910 (*
cuºSli˚
)->
m¥_16x16
 = 
NULL
;

1912 (*
cuºSli˚
)->
cofAC
 = 
NULL
;

1913 (*
cuºSli˚
)->
cofDC
 = 
NULL
;

1915 (*
cuºSli˚
)->
tblk4x4
 = 
NULL
;

1916 (*
cuºSli˚
)->
tblk16x16
 = 
NULL
;

1917 (*
cuºSli˚
)->
i16blk4x4
 = 
NULL
;

1919 (*
cuºSli˚
)->
dúe˘_ªf_idx
 = 
NULL
;

1920 (*
cuºSli˚
)->
dúe˘_pdú
 = 
NULL
;

1922 
	`öô_codög_°©e_mëhods
(*
cuºSli˚
);

1923 
	}
}

1933 
Sli˚
 *
	$mÆloc_¶i˚
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

1935 
i
;

1936 
D©aP¨tôi⁄
 *
d©aP¨t
;

1937 
Sli˚
 *
cuºSli˚
;

1938 
¸_size
 = (
p_I≈
->
£∑øã_cﬁour_∂™e_Êag
 != 0) ? 0 : 512;

1940 
buf„r_size
;

1942 
p_I≈
->
¶i˚_mode
)

1946 
buf„r_size
 = 
	`imax
(2 * 
p_I≈
->
¶i˚_¨gumít
, 764);

1949 
buf„r_size
 = 500 + 
p_I≈
->
¶i˚_¨gumít
 * ((128 + 256 * 
p_Vid
->
bôdïth_luma
 + 
¸_size
 *Ö_Vid->
bôdïth_chroma
) >> 3);

1952 
buf„r_size
 = 500 + 
p_Vid
->
FømeSizeInMbs
 * ((128 + 256 *Ö_Vid->
bôdïth_luma
 + 
¸_size
 *Ö_Vid->
bôdïth_chroma
) >> 3);

1957 i‡((
cuºSli˚
 = (
Sli˚
 *Ë
	`ˇŒoc
(1, (Sli˚))Ë=
NULL
Ë
	`no_mem_exô
 ("malloc_slice: currSlice structure");

1959 
cuºSli˚
->
p_Vid
 =Ö_Vid;

1960 
cuºSli˚
->
p_I≈
 =Ö_Inp;

1962 i‡(((
cuºSli˚
->
p_RDO
Ë(
RDOPTSåu˘uª
 *Ë
	`ˇŒoc
(1, (RDOPTSåu˘uª)))==
NULL
)

1963 
	`no_mem_exô
("malloc_slice:Ö_RDO");

1965 
cuºSli˚
->
symbﬁ_mode
 = (Ë
p_I≈
->symbol_mode;

1967 i‡(
cuºSli˚
->
symbﬁ_mode
 =
CABAC
)

1970 
cuºSli˚
->
mŸ_˘x
 = 
	`¸óã_c⁄ãxts_MŸi⁄Info
 ();

1971 
cuºSli˚
->
ãx_˘x
 = 
	`¸óã_c⁄ãxts_TextuªInfo
();

1974 
cuºSli˚
->
max_∑π_ƒ
 = 
p_I≈
->
∑πôi⁄_mode
==0?1:3;

1977 if(
p_Vid
->
cuºítPi˘uª
->
idr_Êag
)

1978 
cuºSli˚
->
max_∑π_ƒ
 = 1;

1980 
assignSE2∑πôi⁄
[0] = 
assignSE2∑πôi⁄_NoDP
;

1983 if(!
p_Vid
->
cuºítPi˘uª
->
idr_Êag
 && 
p_I≈
->
∑πôi⁄_mode
 == 1)

1984 
assignSE2∑πôi⁄
[1] = 
assignSE2∑πôi⁄_DP
;

1986 
assignSE2∑πôi⁄
[1] = 
assignSE2∑πôi⁄_NoDP
;

1988 
cuºSli˚
->
num_mb
 = 0;

1990 i‡((
cuºSli˚
->
∑πAº
 = (
D©aP¨tôi⁄
 *Ë
	`ˇŒoc
(cuºSli˚->
max_∑π_ƒ
, (D©aP¨tôi⁄))Ë=
NULL
)

1991 
	`no_mem_exô
 ("malloc_slice:ÖartArr");

1992 
i
=0; i<
cuºSli˚
->
max_∑π_ƒ
; i++)

1994 
d©aP¨t
 = &(
cuºSli˚
->
∑πAº
[
i
]);

1995 i‡((
d©aP¨t
->
bô°ªam
 = (
Bô°ªam
 *Ë
	`ˇŒoc
(1, (Bô°ªam))Ë=
NULL
)

1996 
	`no_mem_exô
 ("malloc_slice: Bitstream");

1997 i‡((
d©aP¨t
->
bô°ªam
->
°ªamBuf„r
 = (
byã
 *Ë
	`ˇŒoc
(
buf„r_size
, (byã))Ë=
NULL
)

1998 
	`no_mem_exô
 ("malloc_slice: StreamBuffer");

1999 
d©aP¨t
->
bô°ªam
->
buf„r_size
 = buffer_size;

2002 
d©aP¨t
->
p_Sli˚
 = 
cuºSli˚
;

2003 
d©aP¨t
->
p_Vid
 =Ö_Vid;

2004 
d©aP¨t
->
p_I≈
 =Ö_Inp;

2007 i‡(
p_I≈
->
WeighãdPªdi˘i⁄
 ||Ö_I≈->
WeighãdBùªdi˘i⁄
 ||Ö_I≈->
Gíî©eMu…ùÀPPS
)

2010 
	`gë_mem3Dsh‹t
(&
cuºSli˚
->
wp_weight
 , 6, 
MAX_REFERENCE_PICTURES
, 3);

2011 
	`gë_mem3Dsh‹t
(&
cuºSli˚
->
wp_off£t
 , 6, 
MAX_REFERENCE_PICTURES
, 3);

2012 
	`gë_mem4Dsh‹t
(&
cuºSli˚
->
wbp_weight
, 6, 
MAX_REFERENCE_PICTURES
, MAX_REFERENCE_PICTURES, 3);

2015  
cuºSli˚
;

2016 
	}
}

2029 
Sli˚
 *
	$mÆloc_¶i˚_lôe
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

2031 
Sli˚
 *
cuºSli˚
;

2034 i‡((
cuºSli˚
 = (
Sli˚
 *Ë
	`ˇŒoc
(1, (Sli˚))Ë=
NULL
Ë
	`no_mem_exô
 ("malloc_slice: currSlice structure");

2036 
cuºSli˚
->
p_Vid
 =Ö_Vid;

2037 
cuºSli˚
->
p_I≈
 =Ö_Inp;

2038 
cuºSli˚
->
p_RDO
 = 
NULL
;

2040 
cuºSli˚
->
symbﬁ_mode
 = (Ë
p_I≈
->symbol_mode;

2043 
cuºSli˚
->
mŸ_˘x
 = 
NULL
;

2044 
cuºSli˚
->
ãx_˘x
 = 
NULL
;

2047 
cuºSli˚
->
max_∑π_ƒ
 = 
p_I≈
->
∑πôi⁄_mode
==0?1:3;

2050 if(
p_Vid
->
cuºítPi˘uª
->
idr_Êag
)

2051 
cuºSli˚
->
max_∑π_ƒ
 = 1;

2053 
assignSE2∑πôi⁄
[0] = 
assignSE2∑πôi⁄_NoDP
;

2056 if(!
p_Vid
->
cuºítPi˘uª
->
idr_Êag
 && 
p_I≈
->
∑πôi⁄_mode
 == 1)

2057 
assignSE2∑πôi⁄
[1] = 
assignSE2∑πôi⁄_DP
;

2059 
assignSE2∑πôi⁄
[1] = 
assignSE2∑πôi⁄_NoDP
;

2061 
cuºSli˚
->
num_mb
 = 0;

2063 
cuºSli˚
->
∑πAº
 = 
NULL
;

2065 i‡(
p_I≈
->
WeighãdPªdi˘i⁄
 ||Ö_I≈->
WeighãdBùªdi˘i⁄
 ||Ö_I≈->
Gíî©eMu…ùÀPPS
)

2068 
	`gë_mem3Dsh‹t
(&
cuºSli˚
->
wp_weight
, 6, 
MAX_REFERENCE_PICTURES
, 3);

2069 
	`gë_mem3Dsh‹t
(&
cuºSli˚
->
wp_off£t
, 6, 
MAX_REFERENCE_PICTURES
, 3);

2070 
	`gë_mem4Dsh‹t
(&
cuºSli˚
->
wbp_weight
, 6, 
MAX_REFERENCE_PICTURES
, MAX_REFERENCE_PICTURES, 3);

2073  
cuºSli˚
;

2074 
	}
}

2085 
	$‰ì_«l_unô
(
Pi˘uª
 *
pic
)

2087 
∑πôi⁄
, 
¶i˚
;

2088 
Sli˚
 *
cuºSli˚
;

2091 
¶i˚
=0; sli˚ < 
pic
->
no_¶i˚s
; slice++)

2093 
cuºSli˚
 = 
pic
->
¶i˚s
[
¶i˚
];

2096 i‡(
cuºSli˚
 !
NULL
)

2098 
∑πôi⁄
=0;Ö¨tôi⁄ < 
cuºSli˚
->
max_∑π_ƒ
;Öartition++)

2101 i‡(
cuºSli˚
->
∑πAº
[
∑πôi⁄
].
bô°ªam
->
wrôe_Êag
 )

2103 i‡(
cuºSli˚
->
∑πAº
[
∑πôi⁄
].
«l_unô
 !
NULL
)

2105 
	`FªeNALU
(
cuºSli˚
->
∑πAº
[
∑πôi⁄
].
«l_unô
);

2106 
cuºSli˚
->
∑πAº
[
∑πôi⁄
].
«l_unô
 = 
NULL
;

2112 
	}
}

2124 
	$‰ì_¶i˚
(
Sli˚
 *
cuºSli˚
)

2126 i‡(
cuºSli˚
 !
NULL
)

2128 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

2129 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºSli˚
->p_Inp;

2131 
i
;

2132 
D©aP¨tôi⁄
 *
d©aP¨t
;

2134 
i
=0; i<6; i++)

2136 i‡(
cuºSli˚
->
li°X
[
i
])

2138 
	`‰ì
 (
cuºSli˚
->
li°X
[
i
]);

2139 
cuºSli˚
->
li°X
[
i
] = 
NULL
;

2143 
i
 = 0; i < 
cuºSli˚
->
max_∑π_ƒ
; i++)

2145 i‡–
cuºSli˚
->
∑πAº
 !
NULL
)

2147 
d©aP¨t
 = &(
cuºSli˚
->
∑πAº
[
i
]);

2149 i‡(
d©aP¨t
 !
NULL
)

2151 i‡(
d©aP¨t
->
bô°ªam
 !
NULL
)

2153 i‡(
d©aP¨t
->
bô°ªam
->
°ªamBuf„r
 !
NULL
)

2155 
	`‰ì
(
d©aP¨t
->
bô°ªam
->
°ªamBuf„r
);

2156 
d©aP¨t
->
bô°ªam
->
°ªamBuf„r
 = 
NULL
;

2158 
	`‰ì
(
d©aP¨t
->
bô°ªam
);

2159 
d©aP¨t
->
bô°ªam
 = 
NULL
;

2165 i‡(
cuºSli˚
->
¶i˚_ty≥
 !
I_SLICE
 && cuºSli˚->¶i˚_ty≥ !
SI_SLICE
)

2166 
	`‰ì_ªf_pic_li°_ª‹dîög_buf„r
 (
cuºSli˚
);

2169 if(
cuºSli˚
->
p_RDO
)

2171 
	`˛ór_rd›t
 (
cuºSli˚
);

2172 
	`‰ì
 (
cuºSli˚
->
p_RDO
);

2175 if(
cuºSli˚
->
cofAC
)

2176 
	`‰ì_mem_ACc€ff
 (
cuºSli˚
->
cofAC
);

2177 if(
cuºSli˚
->
cofDC
)

2178 
	`‰ì_mem_DCc€ff
 (
cuºSli˚
->
cofDC
);

2180 if(
cuºSli˚
->
mb_ºes
)

2181 
	`‰ì_mem3Döt
(
cuºSli˚
->
mb_ºes
 );

2182 if(
cuºSli˚
->
mb_‹es
)

2183 
	`‰ì_mem3Döt
(
cuºSli˚
->
mb_‹es
 );

2184 if(
cuºSli˚
->
mb_¥ed
)

2185 
	`‰ì_mem3D≥l
(
cuºSli˚
->
mb_¥ed
 );

2186 if(
cuºSli˚
->
m¥_16x16
)

2187 
	`‰ì_mem4D≥l
(
cuºSli˚
->
m¥_16x16
);

2188 if(
cuºSli˚
->
m¥_8x8
)

2189 
	`‰ì_mem4D≥l
(
cuºSli˚
->
m¥_8x8
 );

2190 if(
cuºSli˚
->
m¥_4x4
)

2191 
	`‰ì_mem4D≥l
(
cuºSli˚
->
m¥_4x4
 );

2194 i‡(
cuºSli˚
->
∑πAº
 !
NULL
)

2196 
	`‰ì
(
cuºSli˚
->
∑πAº
);

2197 
cuºSli˚
->
∑πAº
 = 
NULL
;

2200 i‡(
cuºSli˚
->
symbﬁ_mode
 =
CABAC
)

2202 if(
cuºSli˚
->
mŸ_˘x
)

2203 
	`dñëe_c⁄ãxts_MŸi⁄Info
(
cuºSli˚
->
mŸ_˘x
);

2204 if(
cuºSli˚
->
ãx_˘x
)

2205 
	`dñëe_c⁄ãxts_TextuªInfo
(
cuºSli˚
->
ãx_˘x
);

2208 i‡(
p_I≈
->
WeighãdPªdi˘i⁄
 ||Ö_I≈->
WeighãdBùªdi˘i⁄
 ||Ö_I≈->
Gíî©eMu…ùÀPPS
)

2210 
	`‰ì_mem3Dsh‹t
(
cuºSli˚
->
wp_weight
 );

2211 
	`‰ì_mem3Dsh‹t
(
cuºSli˚
->
wp_off£t
 );

2212 
	`‰ì_mem4Dsh‹t
(
cuºSli˚
->
wbp_weight
);

2215 i‡(
cuºSli˚
->
U£RDOQu™t
)

2217 
	`‰ì
(
cuºSli˚
->
e°BôsCabac
);

2219 
	`‰ì_rdd©a
(
cuºSli˚
, &cuºSli˚->
rdd©a_åñlis_cuº
);

2220 if(
cuºSli˚
->
RDOQ_QP_Num
 > 1)

2222 
	`‰ì_rdd©a
(
cuºSli˚
, &cuºSli˚->
rdd©a_åñlis_be°
);

2226 if(
cuºSli˚
->
mb_aff_‰ame_Êag
)

2228 
	`‰ì_rdd©a
(
cuºSli˚
, &cuºSli˚->
rdd©a_t›_‰ame_mb
);

2229 
	`‰ì_rdd©a
(
cuºSli˚
, &cuºSli˚->
rdd©a_bŸ_‰ame_mb
);

2231 i‡–
p_I≈
->
MbI¡îœ˚
 !
FRAME_MB_PAIR_CODING
 )

2233 
	`‰ì_rdd©a
(
cuºSli˚
, &cuºSli˚->
rdd©a_t›_fõld_mb
);

2234 
	`‰ì_rdd©a
(
cuºSli˚
, &cuºSli˚->
rdd©a_bŸ_fõld_mb
);

2238 i‡((
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
Ë|| (cuºSli˚->¶i˚_ty≥ =
SP_SLICE
Ë|| (cuºSli˚->¶i˚_ty≥ =
B_SLICE
))

2240 if(
cuºSli˚
->
Æl_mv
)

2241 
	`‰ì_mem5Dmv
 (
cuºSli˚
->
Æl_mv
);

2242 i‡(
p_I≈
->
BiPªdMŸi⁄E°im©i⁄
 && (
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
Ë&& cuºSli˚->
bùªd_mv
)

2243 
	`‰ì_mem6Dmv
(
cuºSli˚
->
bùªd_mv
);

2245 i‡(
cuºSli˚
->
U£RDOQu™t
 && cuºSli˚->
RDOQ_QP_Num
 > 1)

2247 i‡(
p_I≈
->
Tønsf‹m8x8Mode
 &&Ö_I≈->
RDOQ_CP_MV
)

2249 if(
cuºSli˚
->
tmp_mv8
)

2250 
	`‰ì_mem4Dmv
 (
cuºSli˚
->
tmp_mv8
);

2251 if(
cuºSli˚
->
mŸi⁄_co°8
)

2252 
	`‰ì_mem3Ddi°blk
(
cuºSli˚
->
mŸi⁄_co°8
);

2253 if(
cuºSli˚
->
tmp_mv4
)

2254 
	`‰ì_mem4Dmv
 (
cuºSli˚
->
tmp_mv4
);

2255 if(
cuºSli˚
->
mŸi⁄_co°4
)

2256 
	`‰ì_mem3Ddi°blk
(
cuºSli˚
->
mŸi⁄_co°4
);

2261 i‡(
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
)

2263 if(
cuºSli˚
->
dúe˘_ªf_idx
)

2264 
	`‰ì_mem3D
((
byã
 ***)
cuºSli˚
->
dúe˘_ªf_idx
);

2265 if(
cuºSli˚
->
dúe˘_pdú
)

2266 
	`‰ì_mem2D
((
byã
 **Ë
cuºSli˚
->
dúe˘_pdú
);

2269 
	`‰ì_block_mem
(
cuºSli˚
);

2271 i‡(
cuºSli˚
->
¶i˚_ty≥
 !
I_SLICE
 && cuºSli˚->¶i˚_ty≥ !
SI_SLICE
)

2273 i‡(
p_I≈
->
SórchMode
[
p_Vid
->
võw_id
] =
EPZS
)

2275 if(
cuºSli˚
->
p_EPZS
)

2276 
	`EPZSSåu˘Dñëe
 (
cuºSli˚
);

2280 
	`‰ì
(
cuºSli˚
);

2282 
	}
}

2293 
	$‰ì_¶i˚_li°
(
Pi˘uª
 *
cuºPic
)

2295 
i
;

2297 i‡(
cuºPic
 !
NULL
)

2299 
	`‰ì_«l_unô
(
cuºPic
);

2301 
i
 = 0; i < 
cuºPic
->
no_¶i˚s
; i++)

2303 
	`‰ì_¶i˚
 (
cuºPic
->
¶i˚s
[
i
]);

2304 
cuºPic
->
¶i˚s
[
i
] = 
NULL
;

2307 
	}
}

2309 
	$Upd©eMELambda
(
Sli˚
 *
cuºSli˚
)

2311 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºSli˚
->p_Inp;

2313 i‡(
p_I≈
->
Upd©eLambdaChromaME
)

2315 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

2316 
j
, 
k
, 
qp
;

2317 i‡(
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
)

2318 
j
 = 
cuºSli˚
->
«l_ª„ªn˚_idc
 ? 5 : 
B_SLICE
;

2320 
j
 = 
cuºSli˚
->
¶i˚_ty≥
;

2322 
p_Vid
->
yuv_f‹m©
)

2324 
YUV420
:

2325 
qp
 = -
cuºSli˚
->
bôdïth_luma_qp_sˇÀ
; qp < 52; qp++)

2327 
k
 = 0; k < 3; k++)

2329 i‡((
p_I≈
->
MEEº‹Mëric
[
k
] =
ERROR_SAD
Ë&& (p_I≈->
ChromaMEE«bÀ
))

2331 
p_Vid
->
œmbda_mf
[
j
][
qp
][
k
] = (3 *Ö_Vid->lambda_mf[j][qp][k] + 1) >> 1;

2332 
p_Vid
->
œmbda_me
[
j
][
qp
][
k
] *= 1.5;

2337 
YUV422
:

2338 
qp
 = -
cuºSli˚
->
bôdïth_luma_qp_sˇÀ
; qp < 52; qp++)

2340 
k
 = 0; k < 3; k++)

2342 i‡((
p_I≈
->
MEEº‹Mëric
[
k
] =
ERROR_SAD
Ë&& (p_I≈->
ChromaMEE«bÀ
))

2344 
p_Vid
->
œmbda_mf
[
j
][
qp
][
k
] *= 2;

2345 
p_Vid
->
œmbda_me
[
j
][
qp
][
k
] *= 2.0;

2350 
YUV444
:

2351 
qp
 = -
cuºSli˚
->
bôdïth_luma_qp_sˇÀ
; qp < 52; qp++)

2353 
k
 = 0; k < 3; k++)

2355 i‡((
p_I≈
->
MEEº‹Mëric
[
k
] =
ERROR_SAD
Ë&& (p_I≈->
ChromaMEE«bÀ
))

2357 
p_Vid
->
œmbda_mf
[
j
][
qp
][
k
] *= 3;

2358 
p_Vid
->
œmbda_me
[
j
][
qp
][
k
] *= 3.0;

2367 
	}
}

2370 
	$SëLagøngünMu…ùlõrsOn
(
Sli˚
 *
cuºSli˚
)

2372 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºSli˚
->p_Inp;

2374 i‡(
p_I≈
->
U£Ex∂icôLambdaP¨ams
 == 1)

2375 
	`gë_ex∂icô_œmbda
(
cuºSli˚
);

2376 i‡(
p_I≈
->
U£Ex∂icôLambdaP¨ams
 == 2)

2377 
	`gë_fixed_œmbda
(
cuºSli˚
);

2380 
cuºSli˚
->
¶i˚_ty≥
)

2382 
I_SLICE
:

2383 
	`gë_im∂icô_œmbda_i_¶i˚
(
cuºSli˚
);

2386 
P_SLICE
:

2387 
	`gë_im∂icô_œmbda_p_¶i˚
(
cuºSli˚
);

2389 
B_SLICE
:

2390 
	`gë_im∂icô_œmbda_b_¶i˚
(
cuºSli˚
);

2392 
SI_SLICE
:

2393 
SP_SLICE
:

2394 
	`gë_im∂icô_œmbda_•_¶i˚
(
cuºSli˚
);

2399 
	`Upd©eMELambda
(
cuºSli˚
);

2400 i‡–
p_I≈
->
U£RDOQu™t
 )

2402 
	`£t_rdoq_œmbda
(
cuºSli˚
);

2404 
	}
}

2407 
	$SëLagøngünMu…ùlõrsOff
(
Sli˚
 *
cuºSli˚
)

2409 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

2410 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºSli˚
->p_Inp;

2412 
qp
, 
j
, 
k
;

2413 
qp_ãmp
;

2415 
j
 = 0; j < 6; j++)

2417 
qp
 = -
cuºSli˚
->
bôdïth_luma_qp_sˇÀ
; qp < 52; qp++)

2419 
qp_ãmp
 = ()
qp
 + 
cuºSli˚
->
bôdïth_luma_qp_sˇÀ
 - 
SHIFT_QP
;

2421 
p_I≈
->
U£Ex∂icôLambdaP¨ams
)

2424 
p_Vid
->
œmbda_md
[
j
][
qp
] = 
	`sqπ
(
p_I≈
->
LambdaWeight
[j] * 
	`pow
 (2, 
qp_ãmp
/3.0));

2427 
p_Vid
->
œmbda_md
[
j
][
qp
] = 
	`sqπ
(
p_I≈
->
FixedLambda
[j]);

2430 
p_Vid
->
œmbda_md
[
j
][
qp
] = 
QP2QUANT
[
	`imax
(0,q∞- 
SHIFT_QP
)];

2434 
k
 = 
F_PEL
; k <
Q_PEL
; k++)

2436 
p_Vid
->
œmbda_me
[
j
][
qp
][
k
] = (
p_I≈
->
MEEº‹Mëric
[k] =
ERROR_SSE
 &&Ö_I≈->
MESo·íSSEMëric
 =0Ë? (p_Vid->
œmbda_md
[j][qp] *Ö_Vid->lambda_md[j][qp]) :Ö_Vid->lambda_md[j][qp];

2437 
p_Vid
->
œmbda_mf
[
j
][
qp
][
k
] = 
	`LAMBDA_FACTOR
 (p_Vid->
œmbda_me
[j][qp][k]);

2440 i‡(
p_I≈
->
CtxAd±LagøngeMu…
 == 1)

2442 
œmbda_qp
 = (
qp
 >32 && !
p_I≈
->
RCE«bÀ
Ë? 
	`imax
(0, qp-4) : imax(0, qp-6);

2443 
p_Vid
->
œmbda_mf_Á˘‹
[
j
][
qp
] = 
	`log
 (p_Vid->
œmbda_me
[j][
œmbda_qp
][
Q_PEL
] + 1.0) /Üog (2.0);

2447 
	`Upd©eMELambda
(
cuºSli˚
);

2448 i‡–
p_I≈
->
U£RDOQu™t
 )

2450 
	`£t_rdoq_œmbda
(
cuºSli˚
);

2452 
	}
}

	@lencod/src/symbol.c

17 
	~"globÆ.h
"

18 
	~"symbﬁ.h
"

	@lencod/src/transform8x8.c

18 
	~<m©h.h
>

19 
	~<limôs.h
>

21 
	~"globÆ.h
"

23 
	~"image.h
"

24 
	~"mb_ac˚ss.h
"

25 
	~"blk_¥edi˘i⁄.h
"

26 
	~"ñemíts.h
"

27 
	~"vlc.h
"

28 
	~"å™sf‹m8x8.h
"

29 
	~"å™sf‹m.h
"

30 
	~"ma¸oblock.h
"

31 
	~"symbﬁ.h
"

32 
	~"mc_¥edi˘i⁄.h
"

33 
	~"md_di°‹ti⁄.h
"

34 
	~"qu™t8x8.h
"

35 
	~"rdoq.h
"

36 
	~"q_m©rix.h
"

37 
	~"q_off£ts.h
"

38 
	~"rd›t.h
"

39 
	~"md_comm⁄.h
"

40 
	~"öåa8x8.h
"

41 
	~"rd›t_codög_°©e.h
"

44 c⁄° 
byã
 
	gSNGL_SCAN8x8
[64][2] = {

55 c⁄° 
byã
 
	gSNGL_SCAN8x8_CAVLC
[64][2] = {

63 c⁄° 
byã
 
	gFIELD_SCAN8x8
[64][2] = {

74 c⁄° 
byã
 
	gFIELD_SCAN8x8_CAVLC
[64][2] = {

83 c⁄° 
byã
 
	gCOEFF_COST8x8
[2][64] =

97 
	#P_Z
 (
PªdPñ
[0])

	)

98 
	#P_A
 (
PªdPñ
[1])

	)

99 
	#P_B
 (
PªdPñ
[2])

	)

100 
	#P_C
 (
PªdPñ
[3])

	)

101 
	#P_D
 (
PªdPñ
[4])

	)

102 
	#P_E
 (
PªdPñ
[5])

	)

103 
	#P_F
 (
PªdPñ
[6])

	)

104 
	#P_G
 (
PªdPñ
[7])

	)

105 
	#P_H
 (
PªdPñ
[8])

	)

106 
	#P_I
 (
PªdPñ
[9])

	)

107 
	#P_J
 (
PªdPñ
[10])

	)

108 
	#P_K
 (
PªdPñ
[11])

	)

109 
	#P_L
 (
PªdPñ
[12])

	)

110 
	#P_M
 (
PªdPñ
[13])

	)

111 
	#P_N
 (
PªdPñ
[14])

	)

112 
	#P_O
 (
PªdPñ
[15])

	)

113 
	#P_P
 (
PªdPñ
[16])

	)

114 
	#P_Q
 (
PªdPñ
[17])

	)

115 
	#P_R
 (
PªdPñ
[18])

	)

116 
	#P_S
 (
PªdPñ
[19])

	)

117 
	#P_T
 (
PªdPñ
[20])

	)

118 
	#P_U
 (
PªdPñ
[21])

	)

119 
	#P_V
 (
PªdPñ
[22])

	)

120 
	#P_W
 (
PªdPñ
[23])

	)

121 
	#P_X
 (
PªdPñ
[24])

	)

135 
	$ResiduÆ_DPCM_8x8
(
ùmode
, **
‹es
, **
ºes
,
block_y
, 
block_x
)

137 
i
,
j
;

138 
ãmp
[8][8];

140 if(
ùmode
==
VERT_PRED
)

142 
j
=0; j<8; j++)

143 
ãmp
[0][
j
] = 
‹es
[
block_y
][
block_x
+j];

145 
i
=1; i<8; i++)

146 
j
=0; j<8; j++)

147 
ãmp
[
i
][
j
] = 
‹es
[
block_y
+i][
block_x
+j] - ores[block_y+i-1][block_x+j];

149 
i
 = 0; i < 8; i++)

150 
j
 = 0; j < 8; j++)

151 
ºes
[
block_y
+
i
][
block_x
+
j
] = 
ãmp
[i][j];

155 
i
=0; i<8; i++)

156 
ãmp
[
i
][0] = 
‹es
[
block_y
 + i][
block_x
];

158 
i
=0; i<8; i++)

159 
j
=1; j<8; j++)

160 
ãmp
[
i
][
j
] = 
‹es
[
block_y
+i][
block_x
+j] - ores[block_y+i][block_x+j-1];

162 
i
=0; i<8; i++)

163 
j
=0; j<8; j++)

164 
ºes
[
block_y
+
i
][
block_x
+
j
] = 
ãmp
[i][j];

167 
	}
}

179 
	$Inv_ResiduÆ_DPCM_8x8
(
Ma¸oblock
 *
cuºMB
, **
m7
, 
block_y
, 
block_x
)

181 
i
;

182 
ãmp
[8][8];

184 if(
cuºMB
->
ùmode_DPCM
 =
VERT_PRED
)

186 
i
=0; i<8; i++)

188 
ãmp
[0][
i
] = 
m7
[
block_y
+0][
block_x
+i];

189 
ãmp
[1][
i
] =Åemp[0][i] + 
m7
[
block_y
+1][
block_x
+i];

190 
ãmp
[2][
i
] =Åemp[1][i] + 
m7
[
block_y
+2][
block_x
+i];

191 
ãmp
[3][
i
] =Åemp[2][i] + 
m7
[
block_y
+3][
block_x
+i];

192 
ãmp
[4][
i
] =Åemp[3][i] + 
m7
[
block_y
+4][
block_x
+i];

193 
ãmp
[5][
i
] =Åemp[4][i] + 
m7
[
block_y
+5][
block_x
+i];

194 
ãmp
[6][
i
] =Åemp[5][i] + 
m7
[
block_y
+6][
block_x
+i];

195 
ãmp
[7][
i
] =Åemp[6][i] + 
m7
[
block_y
+7][
block_x
+i];

197 
i
=0; i<8; i++)

199 
m7
[
block_y
+1][
block_x
+
i
] = 
ãmp
[1][i];

200 
m7
[
block_y
+2][
block_x
+
i
] = 
ãmp
[2][i];

201 
m7
[
block_y
+3][
block_x
+
i
] = 
ãmp
[3][i];

202 
m7
[
block_y
+4][
block_x
+
i
] = 
ãmp
[4][i];

203 
m7
[
block_y
+5][
block_x
+
i
] = 
ãmp
[5][i];

204 
m7
[
block_y
+6][
block_x
+
i
] = 
ãmp
[6][i];

205 
m7
[
block_y
+7][
block_x
+
i
] = 
ãmp
[7][i];

210 
i
=0; i<8; i++)

212 
ãmp
[
i
][0] = 
m7
[
block_y
+i][
block_x
+0];

213 
ãmp
[
i
][1] =Åemp[i][0] + 
m7
[
block_y
+i][
block_x
+1];

214 
ãmp
[
i
][2] =Åemp[i][1] + 
m7
[
block_y
+i][
block_x
+2];

215 
ãmp
[
i
][3] =Åemp[i][2] + 
m7
[
block_y
+i][
block_x
+3];

216 
ãmp
[
i
][4] =Åemp[i][3] + 
m7
[
block_y
+i][
block_x
+4];

217 
ãmp
[
i
][5] =Åemp[i][4] + 
m7
[
block_y
+i][
block_x
+5];

218 
ãmp
[
i
][6] =Åemp[i][5] + 
m7
[
block_y
+i][
block_x
+6];

219 
ãmp
[
i
][7] =Åemp[i][6] + 
m7
[
block_y
+i][
block_x
+7];

221 
i
=0; i<8; i++)

223 
m7
[
block_y
+
i
][
block_x
+1] = 
ãmp
[i][1];

224 
m7
[
block_y
+
i
][
block_x
+2] = 
ãmp
[i][2];

225 
m7
[
block_y
+
i
][
block_x
+3] = 
ãmp
[i][3];

226 
m7
[
block_y
+
i
][
block_x
+4] = 
ãmp
[i][4];

227 
m7
[
block_y
+
i
][
block_x
+5] = 
ãmp
[i][5];

228 
m7
[
block_y
+
i
][
block_x
+6] = 
ãmp
[i][6];

229 
m7
[
block_y
+
i
][
block_x
+7] = 
ãmp
[i][7];

233 
	}
}

241 
	$mode_decisi⁄_f‹_I8x8_MB
 (
Ma¸oblock
 *
cuºMB
, 
œmbda
, 
di°blk
 *
mö_co°
)

243 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

244 
cur_cbp
 = 0, 
b8
;

246 
di°blk
 
co°8x8
;

247 *
mö_co°
 = 
	`weighãd_co°
(
œmbda
, 6);

249 i‡(
cuºSli˚
->
P444_joöed
 == 0)

251 
b8
=0; b8<4; b8++)

253 i‡(
cuºSli˚
->
	`mode_decisi⁄_f‹_I8x8_blocks
 (
cuºMB
, 
b8
, 
œmbda
, &
co°8x8
))

255 
cur_cbp
 |(1<<
b8
);

257 *
mö_co°
 +
co°8x8
;

262 
k
;

263 
cuºSli˚
->
cmp_cbp
[1] = currSlice->cmp_cbp[2] = 0;

264 
cuºMB
->
¸_cbp
[0] = 0;

265 
cuºMB
->
¸_cbp
[1] = 0;

266 
cuºMB
->
¸_cbp
[2] = 0;

268 
b8
 = 0; b8 < 4; b8++)

270 i‡(
cuºSli˚
->
	`mode_decisi⁄_f‹_I8x8_blocks
 (
cuºMB
, 
b8
, 
œmbda
, &
co°8x8
))

272 
cur_cbp
 |(1<<
b8
);

274 *
mö_co°
 +
co°8x8
;

276 
k
 = 1; k < 3; k++)

278 if(
cuºMB
->
¸_cbp
[
k
])

280 
cuºSli˚
->
cmp_cbp
[
k
] |(1 << 
b8
);

281 
cur_cbp
 |
cuºSli˚
->
cmp_cbp
[
k
];

282 
cuºSli˚
->
cmp_cbp
[
k
] = 
cur_cbp
;

288  
cur_cbp
;

289 
	}
}

298 
di°blk
 
	$rdco°_f‹_8x8_öåa_blocks
(
Ma¸oblock
 *
cuºMB
, *
n⁄zîo
, 
b8
, 
ùmode
, 
œmbda
, 
di°blk
 
mö_rdco°
, 
mo°ProbabÀMode
)

300 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

301 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

302 
di°blk
 
rdco°
 = 0;

303 
dummy
 = 0;

304 
øã
;

305 
di°blk
 
di°‹ti⁄
 = 0;

306 
block_x
 = (
b8
 & 0x01) << 3;

307 
block_y
 = (
b8
 >> 1) << 3;

308 
pic_pix_x
 = 
cuºMB
->
pix_x
 + 
block_x
;

309 
pic_pix_y
 = 
cuºMB
->
pix_y
 + 
block_y
;

310 
pic_›ix_y
 = 
cuºMB
->
›ix_y
 + 
block_y
;

312 
Sy¡axEÀmít
 
£
;

313 c⁄° *
∑πM≠
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
∑πôi⁄_mode
];

314 
D©aP¨tôi⁄
 *
d©aP¨t
;

317 *
n⁄zîo
 = 
cuºMB
->
	`ªsiduÆ_å™sf‹m_qu™t_luma_8x8
 (cuºMB, 
PLANE_Y
, 
b8
, &
dummy
, 1);

320 
di°‹ti⁄
 +
	`compuã_SSE8x8
(&
p_Vid
->
pCurImg
[
pic_›ix_y
], &p_Vid->
íc_pi˘uª
->
imgY
[
pic_pix_y
], 
pic_pix_x
,Öic_pix_x);

321 i‡(
di°‹ti⁄
 > 
mö_rdco°
)

324  
di°‹ti⁄
;

326 
cuºMB
->
ùmode_DPCM
 = 
NO_INTRA_PMODE
;

329 
£
.
vÆue1
 = (
mo°ProbabÀMode
 =
ùmode
) ? -1 : ipmode < mostProbableMode ? ipmode : ipmode-1;

332 
£
.
c⁄ãxt
 = 
b8
;

333 
£
.
ty≥
 = 
SE_INTRAPREDMODE
;

336 i‡(
cuºSli˚
->
¶i˚_ty≥
 !
B_SLICE
)

337 
d©aP¨t
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_INTRAPREDMODE
]]);

339 
d©aP¨t
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_BFRAME
]]);

342 
cuºSli˚
->
	`wrôeI¡øPªdMode
 (&
£
, 
d©aP¨t
);

344 
øã
 = 
£
.
Àn
;

348 i‡(
cuºSli˚
->
symbﬁ_mode
 =
CAVLC
)

350 
øã
 +
cuºSli˚
->
	`wrôeC€ff4x4_CAVLC
 (
cuºMB
, 
LUMA
, 
b8
, 0, 0);

351 
øã
 +
cuºSli˚
->
	`wrôeC€ff4x4_CAVLC
 (
cuºMB
, 
LUMA
, 
b8
, 1, 0);

352 
øã
 +
cuºSli˚
->
	`wrôeC€ff4x4_CAVLC
 (
cuºMB
, 
LUMA
, 
b8
, 2, 0);

353 
øã
 +
cuºSli˚
->
	`wrôeC€ff4x4_CAVLC
 (
cuºMB
, 
LUMA
, 
b8
, 3, 0);

357 
øã
 +
	`wrôeC€ff8x8_CABAC
 (
cuºMB
, 
PLANE_Y
, 
b8
, 1);

359 
rdco°
 = 
di°‹ti⁄
 + 
	`weight_co°
(
œmbda
, 
øã
);

360 
cuºSli˚
->
	`ª£t_codög_°©e
 (
cuºMB
, cuºSli˚->
p_RDO
->
cs_cm
);

362  
rdco°
;

363 
	}
}

372 
di°blk
 
	$rdco°_f‹_8x8_öåa_blocks_444
(
Ma¸oblock
 *
cuºMB
, *
n⁄zîo
, 
b8
, 
ùmode
, 
œmbda
, 
di°blk
 
mö_rdco°
, 
mo°ProbabÀMode
)

374 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

375 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

376 
di°blk
 
rdco°
 = 0;

377 
dummy
 = 0;

378 
øã
;

379 
di°blk
 
di°‹ti⁄
 = 0;

380 
block_x
 = (
b8
 & 0x01) << 3;

381 
block_y
 = (
b8
 >> 1) << 3;

382 
pic_pix_x
 = 
cuºMB
->
pix_x
 + 
block_x
;

383 
pic_pix_y
 = 
cuºMB
->
pix_y
 + 
block_y
;

384 
pic_›ix_y
 = 
cuºMB
->
›ix_y
 + 
block_y
;

386 
Sy¡axEÀmít
 
£
;

387 c⁄° *
∑πM≠
 = 
assignSE2∑πôi⁄
[
cuºSli˚
->
∑πôi⁄_mode
];

388 
D©aP¨tôi⁄
 *
d©aP¨t
;

390 if(
cuºSli˚
->
P444_joöed
 == 0)

393 *
n⁄zîo
 = 
cuºMB
->
	`ªsiduÆ_å™sf‹m_qu™t_luma_8x8
 (cuºMB, 
PLANE_Y
, 
b8
, &
dummy
, 1);

396 
di°‹ti⁄
 +
	`compuã_SSE8x8
(&
p_Vid
->
pCurImg
[
pic_›ix_y
], &p_Vid->
íc_pi˘uª
->
imgY
[
pic_pix_y
], 
pic_pix_x
,Öic_pix_x);

398 
cuºMB
->
ùmode_DPCM
 = 
NO_INTRA_PMODE
;

401 
£
.
vÆue1
 = (
mo°ProbabÀMode
 =
ùmode
) ? -1 : ipmode < mostProbableMode ? ipmode : ipmode-1;

404 
£
.
c⁄ãxt
 = 
b8
;

405 
£
.
ty≥
 = 
SE_INTRAPREDMODE
;

408 i‡(
cuºSli˚
->
¶i˚_ty≥
 !
B_SLICE
)

409 
d©aP¨t
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_INTRAPREDMODE
]]);

411 
d©aP¨t
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_BFRAME
]]);

414 
cuºSli˚
->
	`wrôeI¡øPªdMode
 (&
£
, 
d©aP¨t
);

416 
øã
 = 
£
.
Àn
;

420 i‡(
cuºSli˚
->
symbﬁ_mode
 =
CAVLC
)

422 
øã
 +
cuºSli˚
->
	`wrôeC€ff4x4_CAVLC
 (
cuºMB
, 
LUMA
, 
b8
, 0, 0);

423 
øã
 +
cuºSli˚
->
	`wrôeC€ff4x4_CAVLC
 (
cuºMB
, 
LUMA
, 
b8
, 1, 0);

424 
øã
 +
cuºSli˚
->
	`wrôeC€ff4x4_CAVLC
 (
cuºMB
, 
LUMA
, 
b8
, 2, 0);

425 
øã
 +
cuºSli˚
->
	`wrôeC€ff4x4_CAVLC
 (
cuºMB
, 
LUMA
, 
b8
, 3, 0);

429 
øã
 +
	`wrôeC€ff8x8_CABAC
 (
cuºMB
, 
PLANE_Y
, 
b8
, 1);

434 
Cﬁ‹Pœ√
 
k
;

436 *
n⁄zîo
 = 
cuºMB
->
	`ªsiduÆ_å™sf‹m_qu™t_luma_8x8
 (cuºMB, 
PLANE_Y
, 
b8
, &
dummy
, 1);

439 
di°‹ti⁄
 +
	`compuã_SSE8x8
(&
p_Vid
->
pCurImg
[
pic_›ix_y
], &p_Vid->
íc_pi˘uª
->
imgY
[
pic_pix_y
], 
pic_pix_x
,Öic_pix_x);

441 
k
 = 
PLANE_U
; k <
PLANE_V
; k++)

443 
	`£À˘_∂™e
(
p_Vid
, 
k
);

444 
cuºMB
->
c_nzCbCr
[
k
 ]cuºMB->
	`ªsiduÆ_å™sf‹m_qu™t_luma_8x8
(cuºMB, k, 
b8
, &
dummy
,1);

445 
di°‹ti⁄
 +
	`compuã_SSE8x8
(&
p_Vid
->
pImgOrg
[
k
][
pic_›ix_y
], &p_Vid->
íc_pi˘uª
->
p_cuº_img
[
pic_pix_y
], 
pic_pix_x
,Öic_pix_x);

447 
cuºMB
->
ùmode_DPCM
 = 
NO_INTRA_PMODE
;

448 
	`£À˘_∂™e
(
p_Vid
, 
PLANE_Y
);

451 
£
.
vÆue1
 = (
mo°ProbabÀMode
 =
ùmode
) ? -1 : ipmode < mostProbableMode ? ipmode : ipmode-1;

454 
£
.
c⁄ãxt
 = 
b8
;

455 
£
.
ty≥
 = 
SE_INTRAPREDMODE
;

458 i‡(
cuºSli˚
->
¶i˚_ty≥
 !
B_SLICE
)

459 
d©aP¨t
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_INTRAPREDMODE
]]);

461 
d©aP¨t
 = &(
cuºSli˚
->
∑πAº
[
∑πM≠
[
SE_BFRAME
]]);

464 
cuºSli˚
->
	`wrôeI¡øPªdMode
 (&
£
, 
d©aP¨t
);

465 
øã
 = 
£
.
Àn
;

469 i‡(
cuºSli˚
->
symbﬁ_mode
 =
CAVLC
)

471 
b4
;

472 
b4
=0; b4<4; b4++)

474 
øã
 +
cuºSli˚
->
	`wrôeC€ff4x4_CAVLC
 (
cuºMB
, 
LUMA
, 
b8
, 
b4
, 0);

475 
øã
 +
cuºSli˚
->
	`wrôeC€ff4x4_CAVLC
 (
cuºMB
, 
CB
, 
b8
, 
b4
, 0);

476 
øã
 +
cuºSli˚
->
	`wrôeC€ff4x4_CAVLC
 (
cuºMB
, 
CR
, 
b8
, 
b4
, 0);

481 
øã
 +
	`wrôeC€ff8x8_CABAC
 (
cuºMB
, 
PLANE_Y
, 
b8
, 1);

482 
øã
 +
	`wrôeC€ff8x8_CABAC
 (
cuºMB
, 
PLANE_U
, 
b8
, 1);

483 
øã
 +
	`wrôeC€ff8x8_CABAC
 (
cuºMB
, 
PLANE_V
, 
b8
, 1);

486 
rdco°
 = 
di°‹ti⁄
 + 
	`weight_co°
(
œmbda
, 
øã
);

487 
cuºSli˚
->
	`ª£t_codög_°©e
 (
cuºMB
, cuºSli˚->
p_RDO
->
cs_cm
);

489  
rdco°
;

490 
	}
}

492 
ölöe
 
	$check_zîo
(**
mb_‹es
, 
block_x
)

494 
i
, 
j
, 
k
 = 0;

496 
j
 = 0; (j < 
BLOCK_SIZE_8x8
Ë&& (
k
 == 0); j++)

498 
i
 = 
block_x
; (i< block_x + 
BLOCK_SIZE_8x8
Ë&& (
k
 == 0); i++)

501 
k
 |
mb_‹es
[
j
][
i
];

504  
k
;

505 
	}
}

522 
	$ªsiduÆ_å™sf‹m_qu™t_luma_8x8
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
b8
, *
c€ff_co°
, 
öåa
)

524 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

525 
n⁄zîo
 = 
FALSE
;

527 
block_x
 = 8*(
b8
 & 0x01);

528 
block_y
 = 8*(
b8
 >> 1);

529 
∂_off
 = 
b8
+ (
∂
<<2);

530 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

531 
img≥l
 **
img_íc
 = 
p_Vid
->
íc_pi˘uª
->
p_cuº_img
;

533 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_¥ed[
∂
];

534 **
mb_‹es
 = 
cuºSli˚
->mb_‹es[
∂
];

535 **
mb_ºes
 = 
cuºSli˚
->mb_ºes[
∂
];

537 
max_img≥l_vÆue
 = 
p_Vid
->max_imgpel_value;

539 i‡(
	`check_zîo
(&
mb_‹es
[
block_y
], 
block_x
) != 0)

541 
qp
 = (
p_Vid
->
yuv_f‹m©
==
YUV444
 && !
cuºSli˚
->
P444_joöed
)? 
cuºMB
->
qp_sˇÀd
[()’_Vid->
cﬁour_∂™e_id
)]: cuºMB->qp_sˇÀd[
∂
];

545 
Qu™tP¨amëîs
 *
p_Qu™t
 = 
p_Vid
->p_Quant;

547 
Qu™tMëhods
 
qu™t_mëhods
;

548 
qu™t_mëhods
.
block_x
 = block_x;

549 
qu™t_mëhods
.
block_y
 = block_y;

551 
qu™t_mëhods
.
ACLevñ
 = 
cuºSli˚
->
cofAC
[
∂_off
][0][0];

552 
qu™t_mëhods
.
ACRun
 = 
cuºSli˚
->
cofAC
[
∂_off
][0][1];

554 
qu™t_mëhods
.
qp
 = qp;

555 
qu™t_mëhods
.
q_∑øms
 = 
p_Qu™t
->
q_∑øms_8x8
[
∂
][
öåa
][
qp
];

556 
qu™t_mëhods
.
Ádju°
 = 
p_Vid
->
Ad≠tiveRoundög
 ? (&p_Vid->
ARCofAdj8x8
[
∂
][
cuºMB
->
¨_mode
][
block_y
]Ë: 
NULL
;

557 
qu™t_mëhods
.
c€ff_co°
 = coeff_cost;

558 
qu™t_mëhods
.
pos_sˇn
 = 
cuºMB
->
is_fõld_mode
 ? 
FIELD_SCAN8x8
 : 
SNGL_SCAN8x8
;

559 
qu™t_mëhods
.
c_co°
 = 
COEFF_COST8x8
[
cuºSli˚
->
di°hªs
];

562 
	`f‹w¨d8x8
(
mb_‹es
, 
mb_ºes
, 
block_y
, 
block_x
);

565 
n⁄zîo
 = 
cuºSli˚
->
	`qu™t_8x8
(
cuºMB
, &
mb_ºes
[
block_y
], &
qu™t_mëhods
);

569 
cuºSli˚
->
cofAC
[
∂_off
][0][0][0] = 0;

572 i‡(
n⁄zîo
)

575 
	`övî£8x8
(&
mb_ºes
[
block_y
], &mb_ºes[block_y], 
block_x
);

578 
	`ßm∂e_ªc⁄°ru˘
 (&
img_íc
[
cuºMB
->
pix_y
 + 
block_y
], &
mb_¥ed
[block_y], &
mb_ºes
[block_y], 
block_x
, cuºMB->
pix_x
 + block_x, 
BLOCK_SIZE_8x8
, BLOCK_SIZE_8x8, 
max_img≥l_vÆue
, 
DQ_BITS_8
);

582 
	`c›y_image_d©a_8x8
 (&
img_íc
[
cuºMB
->
pix_y
 + 
block_y
], &
mb_¥ed
[block_y], cuºMB->
pix_x
 + 
block_x
, block_x);

586  
n⁄zîo
;

587 
	}
}

604 
	$ªsiduÆ_å™sf‹m_qu™t_luma_8x8_ˇvlc
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
b8
, *
c€ff_co°
, 
öåa
)

606 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

607 
n⁄zîo
 = 
FALSE
;

609 
block_x
 = 8*(
b8
 & 0x01);

610 
block_y
 = 8*(
b8
 >> 1);

611 
∂_off
 = 
b8
+ (
∂
<<2);

612 
img≥l
 **
img_íc
 = 
p_Vid
->
íc_pi˘uª
->
p_cuº_img
;

613 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

614 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_¥ed[
∂
];

615 **
mb_‹es
 = 
cuºSli˚
->mb_‹es[
∂
];

616 **
mb_ºes
 = 
cuºSli˚
->mb_ºes[
∂
];

618 
max_img≥l_vÆue
 = 
p_Vid
->max_imgpel_value;

620 
qp
 = 
cuºMB
->
qp_sˇÀd
[
∂
];

626 
Qu™tP¨amëîs
 *
p_Qu™t
 = 
p_Vid
->p_Quant;

628 
Qu™tMëhods
 
qu™t_mëhods
;

629 
qu™t_mëhods
.
block_x
 = block_x;

630 
qu™t_mëhods
.
block_y
 = block_y;

631 
qu™t_mëhods
.
qp
 = qp;

632 
qu™t_mëhods
.
q_∑øms
 = 
p_Qu™t
->
q_∑øms_8x8
[
∂
][
öåa
][
qp
];

633 
qu™t_mëhods
.
Ádju°
 = 
p_Vid
->
Ad≠tiveRoundög
 ? (&p_Vid->
ARCofAdj8x8
[
∂
][
cuºMB
->
¨_mode
][
block_y
]Ë: 
NULL
;

634 
qu™t_mëhods
.
c€ff_co°
 = coeff_cost;

636 
qu™t_mëhods
.
pos_sˇn
 = 
cuºMB
->
is_fõld_mode
 ? 
FIELD_SCAN8x8_CAVLC
 : 
SNGL_SCAN8x8_CAVLC
;

637 
qu™t_mëhods
.
c_co°
 = 
COEFF_COST8x8
[
cuºSli˚
->
di°hªs
];

640 
	`f‹w¨d8x8
(
mb_‹es
, 
mb_ºes
, 
block_y
, 
block_x
);

643 
n⁄zîo
 = 
cuºSli˚
->
	`qu™t_8x8ˇvlc
(
cuºMB
, &
mb_ºes
[
block_y
], &
qu™t_mëhods
, cuºSli˚->
cofAC
[
∂_off
]);

646 i‡(
n⁄zîo
)

649 
	`övî£8x8
(&
mb_ºes
[
block_y
], &mb_ºes[block_y], 
block_x
);

652 
	`ßm∂e_ªc⁄°ru˘
 (&
img_íc
[
cuºMB
->
pix_y
 + 
block_y
], &
mb_¥ed
[block_y], &
mb_ºes
[block_y], 
block_x
, cuºMB->
pix_x
 + block_x, 
BLOCK_SIZE_8x8
, BLOCK_SIZE_8x8, 
max_img≥l_vÆue
, 
DQ_BITS_8
);

656 
	`c›y_image_d©a_8x8
(&
img_íc
[
cuºMB
->
pix_y
 + 
block_y
], &
mb_¥ed
[block_y], cuºMB->
pix_x
 + 
block_x
, block_x);

660  
n⁄zîo
;

661 
	}
}

663 
	$ªsiduÆ_å™sf‹m_qu™t_luma_8x8_ls
(
Ma¸oblock
 *
cuºMB
, 
Cﬁ‹Pœ√
 
∂
, 
b8
, *
c€ff_co°
, 
öåa
)

665 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

666 
i
,
j
,
c€ff_˘r
;

667 
sˇn_pos
 = 0,
run
 = -1;

668 
n⁄zîo
 = 
FALSE
;

670 
block_x
 = 8*(
b8
 & 0x01);

671 
block_y
 = 8*(
b8
 >> 1);

672 
∂_off
 = 
b8
 + (
∂
<<2);

673 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

674 * 
ACLevñ
 = 
cuºSli˚
->
cofAC
[
∂_off
][0][0];

675 * 
ACRun
 = 
cuºSli˚
->
cofAC
[
∂_off
][0][1];

676 
img≥l
 **
img_íc
 = 
p_Vid
->
íc_pi˘uª
->
p_cuº_img
;

677 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_¥ed[
∂
];

678 **
mb_‹es
 = 
cuºSli˚
->mb_‹es[
∂
];

679 **
mb_ºes
 = 
cuºSli˚
->mb_ºes[
∂
];

681 
sˇn_poss
[4] = { 0 }, 
runs
[4] = { -1, -1, -1, -1 };

682 
MCc€ff
 = 0;

683 *
m7
;

684 
is_ˇvlc
 = (
cuºSli˚
->
symbﬁ_mode
 =
CAVLC
);

686 c⁄° 
	`byã
 (*
pos_sˇn
)[2] = 
cuºMB
->
is_fõld_mode
 ? 
FIELD_SCAN8x8
 : 
SNGL_SCAN8x8
;

688 **
Ádju°8x8
 = 
p_Vid
->
Ad≠tiveRoundög
 ? (&p_Vid->
ARCofAdj8x8
[
∂
][
cuºMB
->
¨_mode
][
block_y
]Ë:
NULL
;

690 
runs
[0]=runs[1]=runs[2]=runs[3]=-1;

691 
sˇn_poss
[0] = scan_poss[1] = scan_poss[2] = scan_poss[3] = 0;

693 if–(
cuºMB
->
ùmode_DPCM
 < 2)&&(
öåa
))

695 
	`ResiduÆ_DPCM_8x8
(
cuºMB
->
ùmode_DPCM
, 
mb_‹es
, 
mb_ºes
, 
block_y
, 
block_x
);

699 
j
 = 
block_y
 ; j < block_y + 
BLOCK_SIZE_8x8
 ; j ++)

700 
i
 = 
block_x
 ; i < block_x + 
BLOCK_SIZE_8x8
 ; i ++)

701 
mb_ºes
[
j
][
i
] = 
mb_‹es
[j][i] ;

704 
c€ff_˘r
=0; coeff_ctr < 64; coeff_ctr++)

706 
i
=
pos_sˇn
[
c€ff_˘r
][0];

707 
j
=
pos_sˇn
[
c€ff_˘r
][1];

709 
run
++;

711 i‡(
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 && 
is_ˇvlc
)

713 
MCc€ff
 = (
c€ff_˘r
 & 3);

714 
runs
[
MCc€ff
]++;

717 
m7
 = &
mb_ºes
[
block_y
 + 
j
][
block_x
 + 
i
];

719 i‡(
p_Vid
->
Ad≠tiveRoundög
)

721 
Ádju°8x8
[
j
][
block_x
+
i
] = 0;

724 i‡(*
m7
 != 0)

726 
n⁄zîo
 = 
TRUE
;

728 i‡(
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 && 
is_ˇvlc
)

730 *
m7
 = 
	`iClù3
(-
CAVLC_LEVEL_LIMIT
, CAVLC_LEVEL_LIMIT, *m7);

731 *
c€ff_co°
 +
MAX_VALUE
;

733 
cuºSli˚
->
cofAC
[
∂_off
][
MCc€ff
][0][
sˇn_poss
[MCc€ff] ] = *
m7
;

734 
cuºSli˚
->
cofAC
[
∂_off
][
MCc€ff
][1][
sˇn_poss
[MCc€ff]++] = 
runs
[MCcoeff];

735 ++
sˇn_pos
;

736 
runs
[
MCc€ff
]=-1;

740 *
c€ff_co°
 +
MAX_VALUE
;

741 
ACLevñ
[
sˇn_pos
 ] = *
m7
;

742 
ACRun
 [
sˇn_pos
++] = 
run
;

743 
run
=-1;

748 i‡(!
cuºMB
->
luma_å™sf‹m_size_8x8_Êag
 || !
is_ˇvlc
)

749 
ACLevñ
[
sˇn_pos
] = 0;

752 
i
=0; i<4; i++)

753 
cuºSli˚
->
cofAC
[
∂_off
][
i
][0][
sˇn_poss
[i]] = 0;

756 if–(
cuºMB
->
ùmode_DPCM
 < 2Ë&& (
öåa
))

758 
	`Inv_ResiduÆ_DPCM_8x8
(
cuºMB
, 
mb_ºes
, 
block_y
, 
block_x
);

761  
j
=
block_y
; j<block_y + 
BLOCK_SIZE_8x8
; j++)

763  
i
=
block_x
; i< block_x + 
BLOCK_SIZE_8x8
; i++)

765 
mb_ºes
[
j
][
i
] +(Ë
mb_¥ed
[j][i];

766 
img_íc
[
cuºMB
->
pix_y
 + 
j
][cuºMB->
pix_x
 + 
i
](
img≥l
Ë
mb_ºes
[j][i];

771  
n⁄zîo
;

772 
	}
}

790 
di°blk
 
	$compuã_comp8x8_co°
(
VideoP¨amëîs
 *
p_Vid
, 
img≥l
 **
cur_img
, img≥»**
m¥8x8
, 
pic_›ix_x
, 
di°blk
 
mö_co°
)

792 
diff64
[64];

794 
i
, 
j
;

795 *
diff
 = &
diff64
[0];

796 
img≥l
 *
cimg
, *
cm¥
;

798 
j
=0; j<8; j++)

802 
cimg
 = &
cur_img
[
j
][
pic_›ix_x
];

803 
cm¥
 = &
m¥8x8
[
j
][0];

804 
i
=0; i<8; i++)

806 *
diff
++ = *
cimg
++ - *
cm¥
++;

810  
p_Vid
->
	`di°‹ti⁄8x8
 (
diff64
, 
mö_co°
);

811 
	}
}

820 
di°blk
 
	$compuã_ßd8x8_co°
(
VideoP¨amëîs
 *
p_Vid
, 
img≥l
 **
cur_img
, img≥»**
m¥8x8
, 
pic_›ix_x
, 
di°blk
 
mö_co°
)

822 
img≥l
 *
cimg
, *
cm¥
;

823 
i32Co°
 = 0;

824 
i
, 
j
;

825 
imö_co°
 = 
	`di°_down
(
mö_co°
);

827 
j
=0; j<8; j++)

829 
cimg
 = &
cur_img
[
j
][
pic_›ix_x
];

830 
cm¥
 = &
m¥8x8
[
j
][0];

831 
i
=0; i<8; i++)

833 
i32Co°
 +
	`übs
(*
cimg
++ - *
cm¥
++);

836 i‡(
i32Co°
 > 
imö_co°
)

838  
mö_co°
;

841  
	`di°_sˇÀ
(
i32Co°
);

842 
	}
}

850 
di°blk
 
	$compuã_s£8x8_co°
(
VideoP¨amëîs
 *
p_Vid
, 
img≥l
 **
cur_img
, img≥»**
m¥8x8
, 
pic_›ix_x
, 
di°blk
 
mö_co°
)

852 
i
, 
j
;

853 
img≥l
 *
cimg
, *
cm¥
;

854 
imö_co°
 = 
	`di°_down
(
mö_co°
);

855 
di°‹ti⁄
 = 0;

857 
j
=0; j<8; j++)

859 
cimg
 = &
cur_img
[
j
][
pic_›ix_x
];

860 
cm¥
 = &
m¥8x8
[
j
][0];

862 
i
=0; i<8; i++)

864 
di°‹ti⁄
 +
	`übs2
(*
cimg
++ - *
cm¥
++);

867 i‡(
di°‹ti⁄
 > 
imö_co°
)

869  
mö_co°
;

872  
	`di°_sˇÀ
(
di°‹ti⁄
);

873 
	}
}

880 
di°blk
 
	$compuã_ßtd8x8_co°
(
VideoP¨amëîs
 *
p_Vid
, 
img≥l
 **
cur_img
, img≥»**
m¥8x8
, 
pic_›ix_x
, 
di°blk
 
mö_co°
)

882 
i
, 
j
;

883 
diff64
[64];

885 *
diff
 = &
diff64
[0];

886 
img≥l
 *
cimg
, *
cm¥
;

888 
j
=0; j<8; j++)

890 
cimg
 = &
cur_img
[
j
][
pic_›ix_x
];

891 
cm¥
 = &
m¥8x8
[
j
][0];

892 
i
=0; i<8; i++)

894 *
diff
++ = *
cimg
++ - *
cm¥
++;

898  (
	`di°_sˇÀ
(
	`Hadam¨dSAD8x8
 (
diff64
)));

899 
	}
}

	@lencod/src/transform8x8_H444.c

18 
	~<m©h.h
>

19 
	~<limôs.h
>

21 
	~"globÆ.h
"

23 
	~"image.h
"

24 
	~"mb_ac˚ss.h
"

25 
	~"ñemíts.h
"

26 
	~"vlc.h
"

27 
	~"å™sf‹m8x8.h
"

28 
	~"å™sf‹m.h
"

29 
	~"ma¸oblock.h
"

30 
	~"symbﬁ.h
"

31 
	~"mc_¥edi˘i⁄.h
"

32 
	~"qu™t8x8.h
"

33 
	~"rdoq.h
"

34 
	~"q_m©rix.h
"

35 
	~"q_off£ts.h
"

36 
	~"rd›t.h
"

37 
	~"md_comm⁄.h
"

38 
	~"öåa8x8.h
"

39 
	~"rd›t_codög_°©e.h
"

40 
	~"blk_¥edi˘i⁄.h
"

48 
	$mode_decisi⁄_f‹_I8x8_blocks_JM_Low444
 (
Ma¸oblock
 *
cuºMB
, 
b8
, 
œmbda
, 
di°blk
 *
mö_co°
)

50 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

51 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

52 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

54 
ùmode
, 
be°_ùmode
 = 0, 
j
, 
dummy
;

55 
di°blk
 
co°
;

56 
n⁄zîo
 = 0;

57 
block_x
 = (
b8
 & 0x01) << 3;

58 
block_y
 = (
b8
 >> 1) << 3;

59 
pic_pix_x
 = 
cuºMB
->
pix_x
 + 
block_x
;

60 
pic_pix_y
 = 
cuºMB
->
pix_y
 + 
block_y
;

61 
pic_›ix_x
 = 
cuºMB
->
pix_x
 + 
block_x
;

62 
pic_›ix_y
 = 
cuºMB
->
›ix_y
 + 
block_y
;

63 
pic_block_x
 = 
pic_pix_x
 >> 2;

64 
pic_block_y
 = 
pic_pix_y
 >> 2;

65 
mb_block_y
 = (
cuºMB
->
block_y
Ë+ ((
b8
 >> 1) << 1);

66 
mb_block_x
 = (
cuºMB
->
block_x
Ë+ ((
b8
 & 0x01) << 1);

70 
À·_avaûabÀ
, 
up_avaûabÀ
, 
Æl_avaûabÀ
;

71 **
mb_‹es
 = 
cuºSli˚
->mb_ores[0];

72 
img≥l
 **
mb_¥ed
 = 
cuºSli˚
->mb_pred[0];

73 *
mb_size
 = 
p_Vid
->mb_size[
IS_LUMA
];

75 
upMode
, 
À·Mode
;

76 
mo°ProbabÀMode
;

78 
PixñPos
 
À·_block
, 
t›_block
;

80 
	`gë4x4Neighbour
(
cuºMB
, 
block_x
 - 1, 
block_y
 , 
mb_size
, &
À·_block
);

81 
	`gë4x4Neighbour
(
cuºMB
, 
block_x
, 
block_y
 - 1, 
mb_size
, &
t›_block
 );

83 i‡(
p_I≈
->
U£C⁄°øöedI¡øPªd
)

85 
t›_block
.
avaûabÀ
 =Å›_block.avaûabÀ ? 
p_Vid
->
öåa_block
 [t›_block.
mb_addr
] : 0;

86 
À·_block
.
avaûabÀ
 =Üe·_block.avaûabÀ ? 
p_Vid
->
öåa_block
 [À·_block.
mb_addr
] : 0;

89 if(
b8
 >> 1)

90 
upMode
 = 
t›_block
.
avaûabÀ
 ? 
p_Vid
->
ùªdmode8x8
[t›_block.
pos_y
 ][t›_block.
pos_x
 ] : -1;

92 
upMode
 = 
t›_block
.
avaûabÀ
 ? 
p_Vid
->
ùªdmode
 [t›_block.
pos_y
 ][t›_block.
pos_x
 ] : -1;

94 if(
b8
 & 0x01)

95 
À·Mode
 = 
À·_block
.
avaûabÀ
 ? 
p_Vid
->
ùªdmode8x8
[À·_block.
pos_y
][À·_block.
pos_x
] : -1;

97 
À·Mode
 = 
À·_block
.
avaûabÀ
 ? 
p_Vid
->
ùªdmode
[À·_block.
pos_y
][À·_block.
pos_x
] : -1;

99 
mo°ProbabÀMode
 = (
upMode
 < 0 || 
À·Mode
 < 0Ë? 
DC_PRED
 : upMode <ÜeftMode ? upMode :ÜeftMode;

100 *
mö_co°
 = 
DISTBLK_MAX
;

101 
cuºMB
->
ùmode_DPCM
 = 
NO_INTRA_PMODE
;

104 
cuºSli˚
->
	`£t_öå≠ªd_8x8
(
cuºMB
, 
PLANE_Y
, 
pic_pix_x
, 
pic_pix_y
, &
À·_avaûabÀ
, &
up_avaûabÀ
, &
Æl_avaûabÀ
);

106 if(
cuºSli˚
->
P444_joöed
)

108 
	`£À˘_∂™e
(
p_Vid
, 
PLANE_U
);

109 
cuºSli˚
->
	`£t_öå≠ªd_8x8
(
cuºMB
, 
PLANE_U
, 
pic_pix_x
, 
pic_pix_y
, &
À·_avaûabÀ
, &
up_avaûabÀ
, &
Æl_avaûabÀ
);

110 
	`£À˘_∂™e
(
p_Vid
, 
PLANE_V
);

111 
cuºSli˚
->
	`£t_öå≠ªd_8x8
(
cuºMB
, 
PLANE_V
, 
pic_pix_x
, 
pic_pix_y
, &
À·_avaûabÀ
, &
up_avaûabÀ
, &
Æl_avaûabÀ
);

112 
	`£À˘_∂™e
(
p_Vid
, 
PLANE_Y
);

116 
ùmode
 = 0; ipmodê< 
NO_INTRA_PMODE
; ipmode++)

118 if–(
ùmode
==
DC_PRED
) ||

119 ((
ùmode
==
VERT_PRED
||ùmode==
VERT_LEFT_PRED
||ùmode==
DIAG_DOWN_LEFT_PRED
Ë&& 
up_avaûabÀ
 ) ||

120 ((
ùmode
==
HOR_PRED
||ùmode==
HOR_UP_PRED
Ë&& 
À·_avaûabÀ
 ) ||

121 (
Æl_avaûabÀ
) )

123 
	`gë_öå≠ªd_8x8
(
cuºMB
, 
PLANE_Y
, 
ùmode
, 
À·_avaûabÀ
, 
up_avaûabÀ
);

124 
co°
 = (
ùmode
 =
mo°ProbabÀMode
Ë? 0 : ( 
	`weighãd_co°
(
œmbda
, 4) );

125 
co°
 +
cuºSli˚
->
	`compuã_co°8x8
(
p_Vid
, &p_Vid->
pImgOrg
[0][
pic_›ix_y
], cuºSli˚->
m¥_8x8
[0][
ùmode
], 
pic_›ix_x
, *
mö_co°
 - cost);

127 if(
cuºSli˚
->
P444_joöed
)

129 
	`gë_öå≠ªd_8x8
(
cuºMB
, 
PLANE_U
, 
ùmode
, 
À·_avaûabÀ
, 
up_avaûabÀ
);

130 
co°
 +
cuºSli˚
->
	`compuã_co°8x8
(
p_Vid
, &p_Vid->
pImgOrg
[
PLANE_U
][
pic_›ix_y
], cuºSli˚->
m¥_8x8
[PLANE_U][
ùmode
], 
pic_›ix_x
, *
mö_co°
 - cost);

131 
	`gë_öå≠ªd_8x8
(
cuºMB
, 
PLANE_V
, 
ùmode
, 
À·_avaûabÀ
, 
up_avaûabÀ
);

132 
co°
 +
cuºSli˚
->
	`compuã_co°8x8
(
p_Vid
, &p_Vid->
pImgOrg
[
PLANE_V
][
pic_›ix_y
], cuºSli˚->
m¥_8x8
[PLANE_V][
ùmode
], 
pic_›ix_x
, *
mö_co°
 - cost);

135 i‡(
co°
 < *
mö_co°
)

137 
be°_ùmode
 = 
ùmode
;

138 *
mö_co°
 = 
co°
;

144 
p_Vid
->
ùªdmode8x8
[
pic_block_y
][
pic_block_x
] = (Ë
be°_ùmode
;

145 
cuºMB
->
ùmode_DPCM
 = (Ë
be°_ùmode
;

147 if(
cuºSli˚
->
P444_joöed
)

149 
Cﬁ‹Pœ√
 
k
;

150 
p_Vid
->
CbCr_¥edmode_8x8
[
b8
] = 
be°_ùmode
;

151 
k
 = 
PLANE_U
; k <
PLANE_V
; k++)

153 
cuºMB
->
¸_cbp
[
k
] = 0;

154 
	`£À˘_∂™e
(
p_Vid
, 
k
);

165 
	`c›y_image_d©a_8x8
(&
cuºSli˚
->
mb_¥ed
[
k
][
block_y
], cuºSli˚->
m¥_8x8
[k][
be°_ùmode
], 
block_x
, 0);

166 
	`compuã_ªsidue
(&(
p_Vid
->
pImgOrg
[
k
][
cuºMB
->
pix_y
+
block_y
]), &
cuºSli˚
->
mb_¥ed
[k][block_y], &cuºSli˚->
mb_‹es
[k][block_y], 
block_x
, cuºMB->
pix_x
+block_x, 8, 8);

168 
cuºMB
->
ùmode_DPCM
 = (Ë
be°_ùmode
;

169 i‡(
cuºMB
->
	`ªsiduÆ_å™sf‹m_qu™t_luma_8x8
(cuºMB, 
k
, 
b8
, &
dummy
, 1))

170 
cuºMB
->
¸_cbp
[
k
] = 1;

172 
	`£À˘_∂™e
(
p_Vid
, 
PLANE_Y
);

175 
cuºMB
->
öåa_¥ed_modes8x8
[4*
b8
] = (Ë((
mo°ProbabÀMode
 =
be°_ùmode
)

177 : (
be°_ùmode
 < 
mo°ProbabÀMode
 ? best_ipmode : best_ipmode-1));

179 
j
 = 
mb_block_y
; j < mb_block_y + 2; j++)

180 
	`mem£t
(&
p_Vid
->
ùªdmode8x8
[
j
][
mb_block_x
], 
be°_ùmode
, 2 * ());

196 
	`gíî©e_¥ed_îr‹_8x8
(&
p_Vid
->
pCurImg
[
cuºMB
->
›ix_y
+
block_y
], 
cuºSli˚
->
m¥_8x8
[0][
be°_ùmode
], &
mb_¥ed
[block_y], &
mb_‹es
[block_y], 
pic_›ix_x
, 
block_x
);

198 
cuºMB
->
ùmode_DPCM
 = (Ë
be°_ùmode
;

199 
n⁄zîo
 = 
cuºMB
->
	`ªsiduÆ_å™sf‹m_qu™t_luma_8x8
 (cuºMB, 
PLANE_Y
, 
b8
, &
dummy
, 1);

200  
n⁄zîo
;

201 
	}
}

209 
	$mode_decisi⁄_f‹_I8x8_blocks_JM_High444
 (
Ma¸oblock
 *
cuºMB
, 
b8
, 
œmbda
, 
di°blk
 *
mö_co°
)

211 
VideoP¨amëîs
 *
p_Vid
 = 
cuºMB
->p_Vid;

212 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºMB
->p_Inp;

213 
Sli˚
 *
cuºSli˚
 = 
cuºMB
->
p_Sli˚
;

214 
RDOPTSåu˘uª
 *
p_RDO
 = 
cuºSli˚
->p_RDO;

216 
ùmode
, 
be°_ùmode
 = 0, 
j
, 
dummy
;

217 
c_nz
, 
n⁄zîo
 = 0;

218 
di°blk
 
rdco°
 = 0;

219 
di°blk
 
mö_rdco°
 = 
DISTBLK_MAX
;

220 
block_x
 = (
b8
 & 0x01) << 3;

221 
block_y
 = (
b8
 >> 1) << 3;

222 
pic_pix_x
 = 
cuºMB
->
pix_x
 + 
block_x
;

223 
pic_pix_y
 = 
cuºMB
->
pix_y
 + 
block_y
;

224 
pic_›ix_x
 = 
cuºMB
->
pix_x
 + 
block_x
;

225 
pic_›ix_y
 = 
cuºMB
->
›ix_y
 + 
block_y
;

226 
pic_block_x
 = 
pic_pix_x
 >> 2;

227 
pic_block_y
 = 
pic_pix_y
 >> 2;

228 
mb_block_y
 = (
cuºMB
->
block_y
Ë+ ((
b8
 >> 1) << 1);

229 
mb_block_x
 = (
cuºMB
->
block_x
Ë+ ((
b8
 & 0x01) << 1);

231 
uv
;

232 
À·_avaûabÀ
, 
up_avaûabÀ
, 
Æl_avaûabÀ
;

234 
upMode
, 
À·Mode
;

235 
mo°ProbabÀMode
;

237 
PixñPos
 
À·_block
, 
t›_block
;

239 *
mb_size
 = 
p_Vid
->mb_size[
IS_LUMA
];

241 
	`gë4x4Neighbour
(
cuºMB
, 
block_x
 - 1, 
block_y
 , 
mb_size
, &
À·_block
);

242 
	`gë4x4Neighbour
(
cuºMB
, 
block_x
, 
block_y
 - 1, 
mb_size
, &
t›_block
 );

244 i‡(
p_I≈
->
U£C⁄°øöedI¡øPªd
)

246 
t›_block
.
avaûabÀ
 =Å›_block.avaûabÀ ? 
p_Vid
->
öåa_block
 [t›_block.
mb_addr
 ] : 0;

247 
À·_block
.
avaûabÀ
 =Üe·_block.avaûabÀ ? 
p_Vid
->
öåa_block
 [À·_block.
mb_addr
] : 0;

250 if(
b8
 >> 1)

251 
upMode
 = 
t›_block
.
avaûabÀ
 ? 
p_Vid
->
ùªdmode8x8
[t›_block.
pos_y
 ][t›_block.
pos_x
 ] : -1;

253 
upMode
 = 
t›_block
.
avaûabÀ
 ? 
p_Vid
->
ùªdmode
 [t›_block.
pos_y
 ][t›_block.
pos_x
 ] : -1;

255 if(
b8
 & 0x01)

256 
À·Mode
 = 
À·_block
.
avaûabÀ
 ? 
p_Vid
->
ùªdmode8x8
[À·_block.
pos_y
][À·_block.
pos_x
] : -1;

258 
À·Mode
 = 
À·_block
.
avaûabÀ
 ? 
p_Vid
->
ùªdmode
[À·_block.
pos_y
][À·_block.
pos_x
] : -1;

260 
mo°ProbabÀMode
 = (
upMode
 < 0 || 
À·Mode
 < 0Ë? 
DC_PRED
 : upMode <ÜeftMode ? upMode :ÜeftMode;

261 *
mö_co°
 = 
DISTBLK_MAX
;

262 
cuºMB
->
ùmode_DPCM
 = 
NO_INTRA_PMODE
;

265 
cuºSli˚
->
	`£t_öå≠ªd_8x8
(
cuºMB
, 
PLANE_Y
, 
pic_pix_x
, 
pic_pix_y
, &
À·_avaûabÀ
, &
up_avaûabÀ
, &
Æl_avaûabÀ
);

267 if(
cuºSli˚
->
P444_joöed
)

269 
	`£À˘_∂™e
(
p_Vid
, 
PLANE_U
);

270 
cuºSli˚
->
	`£t_öå≠ªd_8x8
(
cuºMB
, 
PLANE_U
, 
pic_pix_x
, 
pic_pix_y
, &
À·_avaûabÀ
, &
up_avaûabÀ
, &
Æl_avaûabÀ
);

271 
	`£À˘_∂™e
(
p_Vid
, 
PLANE_V
);

272 
cuºSli˚
->
	`£t_öå≠ªd_8x8
(
cuºMB
, 
PLANE_V
, 
pic_pix_x
, 
pic_pix_y
, &
À·_avaûabÀ
, &
up_avaûabÀ
, &
Æl_avaûabÀ
);

273 
	`£À˘_∂™e
(
p_Vid
, 
PLANE_Y
);

277 
ùmode
 = 0; ipmodê< 
NO_INTRA_PMODE
; ipmode++)

279 if–(
ùmode
==
DC_PRED
) ||

280 ((
ùmode
==
VERT_PRED
||ùmode==
VERT_LEFT_PRED
||ùmode==
DIAG_DOWN_LEFT_PRED
Ë&& 
up_avaûabÀ
 ) ||

281 ((
ùmode
==
HOR_PRED
||ùmode==
HOR_UP_PRED
Ë&& 
À·_avaûabÀ
 ) ||

282 (
Æl_avaûabÀ
) )

284 
	`gë_öå≠ªd_8x8
(
cuºMB
, 
PLANE_Y
, 
ùmode
, 
À·_avaûabÀ
, 
up_avaûabÀ
);

287 
	`gíî©e_¥ed_îr‹_8x8
(&
p_Vid
->
pImgOrg
[0][
pic_›ix_y
], 
cuºSli˚
->
m¥_8x8
[0][
ùmode
], &cuºSli˚->
mb_¥ed
[0][
block_y
], &cuºSli˚->
mb_‹es
[0][block_y], 
pic_›ix_x
, 
block_x
);

289 if(
cuºSli˚
->
P444_joöed
)

291 
	`gë_öå≠ªd_8x8
(
cuºMB
, 
PLANE_U
, 
ùmode
, 
À·_avaûabÀ
, 
up_avaûabÀ
);

292 
	`gíî©e_¥ed_îr‹_8x8
(&
p_Vid
->
pImgOrg
[1][
pic_›ix_y
], 
cuºSli˚
->
m¥_8x8
[1][
ùmode
], &cuºSli˚->
mb_¥ed
[1][
block_y
], &cuºSli˚->
mb_‹es
[1][block_y], 
pic_›ix_x
, 
block_x
);

293 
	`gë_öå≠ªd_8x8
(
cuºMB
, 
PLANE_V
, 
ùmode
, 
À·_avaûabÀ
, 
up_avaûabÀ
);

294 
	`gíî©e_¥ed_îr‹_8x8
(&
p_Vid
->
pImgOrg
[2][
pic_›ix_y
], 
cuºSli˚
->
m¥_8x8
[2][
ùmode
], &cuºSli˚->
mb_¥ed
[2][
block_y
], &cuºSli˚->
mb_‹es
[2][block_y], 
pic_›ix_x
, 
block_x
);

297 
cuºMB
->
ùmode_DPCM
 = (Ë
ùmode
;

301 
rdco°
 = 
cuºSli˚
->
	`rdco°_f‹_8x8_öåa_blocks
 (
cuºMB
, &
c_nz
, 
b8
, 
ùmode
, 
œmbda
, 
mö_rdco°
, 
mo°ProbabÀMode
);

302 i‡((
rdco°
 < 
mö_rdco°
Ë|| (rdco° =mö_rdco° && 
ùmode
 =
mo°ProbabÀMode
))

305 
	`mem˝y
(
p_RDO
->
c€fAC8x8öåa
[
b8
][0][0][0],
cuºSli˚
->
cofAC
[b8][0][0], 4 * 2 * 65 * ());

308 
	`c›y_image_d©a_8x8
(
p_RDO
->
ªc8x8
[
PLANE_Y
], &
p_Vid
->
íc_pi˘uª
->
imgY
[
pic_pix_y
], 0, 
pic_pix_x
);

310 i‡(
p_Vid
->
Ad≠tiveRoundög
)

312 
j
 = 
block_y
; j < block_y + 8; j++)

313 
	`mem˝y
(&
p_Vid
->
ARCofAdj8x8
[0][
DUMMY
][
j
][
block_x
],&p_Vid->ARCofAdj8x8[0][
I8MB
][j][block_x], 8 * ());

315 i‡(
cuºSli˚
->
P444_joöed
)

317 
j
 = 
block_y
; j < block_y + 8; j++)

319 
	`mem˝y
(&
p_Vid
->
ARCofAdj8x8
[1][
DUMMY
][
j
][
block_x
],&p_Vid->ARCofAdj8x8[1][
I8MB
][j][block_x], 8 * ());

320 
	`mem˝y
(&
p_Vid
->
ARCofAdj8x8
[2][
DUMMY
][
j
][
block_x
],&p_Vid->ARCofAdj8x8[2][
I8MB
][j][block_x], 8 * ());

325 i‡(
cuºSli˚
->
P444_joöed
)

328 
uv
=0; uv < 2; uv++)

330 
	`mem˝y
(
p_RDO
->
c€fAC8x8öåa
[
b8
][
uv
 + 1][0][0],
cuºSli˚
->
cofAC
[4+b8+4*uv][0][0], 2 * 4 * 65 * ());

332 
cuºMB
->
¸_cbp
[
uv
 + 1] = cuºMB->
c_nzCbCr
[uv + 1];

334 
	`c›y_image_d©a_8x8
(
p_RDO
->
ªc8x8
[
uv
 + 1], &
p_Vid
->
íc_pi˘uª
->
imgUV
[uv][
pic_pix_y
], 0, 
pic_pix_x
);

339 
n⁄zîo
 = 
c_nz
;

342 *
mö_co°
 = 
rdco°
;

343 
mö_rdco°
 = 
rdco°
;

344 
be°_ùmode
 = 
ùmode
;

350 
p_Vid
->
ùªdmode8x8
[
pic_block_y
][
pic_block_x
] = (Ë
be°_ùmode
;

351 
cuºMB
->
ùmode_DPCM
 = (Ë
be°_ùmode
;

353 if(
cuºSli˚
->
P444_joöed
)

355 
Cﬁ‹Pœ√
 
k
;

356 
p_Vid
->
CbCr_¥edmode_8x8
[
b8
] = 
be°_ùmode
;

357 
k
 = 
PLANE_U
; k <
PLANE_V
; k++)

359 
cuºMB
->
¸_cbp
[
k
] = 0;

360 
	`£À˘_∂™e
(
p_Vid
, 
k
);

371 
	`gíî©e_¥ed_îr‹_8x8
(&
p_Vid
->
pImgOrg
[
k
][
cuºMB
->
pix_y
 + 
block_y
], 
cuºSli˚
->
m¥_8x8
[k][
be°_ùmode
], &cuºSli˚->
mb_¥ed
[k][block_y], &cuºSli˚->
mb_‹es
[k][block_y], cuºMB->
pix_x
 + 
block_x
, block_x);

372 
cuºMB
->
ùmode_DPCM
 = (Ë
be°_ùmode
;

374 i‡(
cuºMB
->
	`ªsiduÆ_å™sf‹m_qu™t_luma_8x8
(cuºMB, 
k
, 
b8
, &
dummy
, 1))

375 
cuºMB
->
¸_cbp
[
k
] = 1;

377 
	`£À˘_∂™e
(
p_Vid
, 
PLANE_Y
);

380 
cuºMB
->
öåa_¥ed_modes8x8
[4*
b8
] = (Ë((
mo°ProbabÀMode
 =
be°_ùmode
)

382 : (
be°_ùmode
 < 
mo°ProbabÀMode
 ? best_ipmode : best_ipmode-1));

384 
	`mem£t
(&
p_Vid
->
ùªdmode8x8
[
mb_block_y
 ][
mb_block_x
], 
be°_ùmode
, 2 * ());

385 
	`mem£t
(&
p_Vid
->
ùªdmode8x8
[
mb_block_y
 + 1][
mb_block_x
], 
be°_ùmode
, 2 * ());

388 
	`mem˝y
(
cuºSli˚
->
cofAC
[
b8
][0][0], 
p_RDO
->
c€fAC8x8öåa
[b8][0][0][0], 4 * 2 * 65 * ());

390 i‡(
p_Vid
->
Ad≠tiveRoundög
)

392 
j
=
block_y
; j< block_y + 8; j++)

393 
	`mem˝y
(&
p_Vid
->
ARCofAdj8x8
[0][
I8MB
][
j
][
block_x
], &p_Vid->ARCofAdj8x8[0][
DUMMY
][j][block_x], 8 * ());

395 i‡(
cuºSli˚
->
P444_joöed
)

397 
j
=0; j<8; j++)

399 
	`mem˝y
(&
p_Vid
->
ARCofAdj8x8
[1][
I8MB
][
block_y
 + 
j
][
block_x
], &p_Vid->ARCofAdj8x8[1][
DUMMY
][block_y + j][block_x], 8 * ());

400 
	`mem˝y
(&
p_Vid
->
ARCofAdj8x8
[2][
I8MB
][
block_y
 + 
j
][
block_x
], &p_Vid->ARCofAdj8x8[2][
DUMMY
][block_y + j][block_x], 8 * ());

406 
	`c›y_image_d©a_8x8
(&
p_Vid
->
íc_pi˘uª
->
imgY
[
pic_pix_y
], 
p_RDO
->
ªc8x8
[0], 
pic_pix_x
, 0);

407 
	`c›y_image_d©a_8x8
(&
cuºSli˚
->
mb_¥ed
[0][
block_y
], cuºSli˚->
m¥_8x8
[0][
be°_ùmode
], 
block_x
, 0);

409 i‡(
cuºSli˚
->
P444_joöed
)

412 
	`mem˝y
(
cuºSli˚
->
cofAC
[4 + 
b8
 + 4*0][0][0], 
p_RDO
->
c€fAC8x8öåa
[b8][1][0][0], 4 * 2 * 65 * ());

413 
	`mem˝y
(
cuºSli˚
->
cofAC
[4 + 
b8
 + 4*1][0][0], 
p_RDO
->
c€fAC8x8öåa
[b8][2][0][0], 4 * 2 * 65 * ());

416 
	`c›y_image_d©a_8x8
(&
p_Vid
->
íc_pi˘uª
->
imgUV
[0][
pic_pix_y
], 
p_RDO
->
ªc8x8
[1], 
pic_pix_x
, 0);

417 
	`c›y_image_d©a_8x8
(&
p_Vid
->
íc_pi˘uª
->
imgUV
[1][
pic_pix_y
], 
p_RDO
->
ªc8x8
[2], 
pic_pix_x
, 0);

418 
	`c›y_image_d©a_8x8
(&
cuºSli˚
->
mb_¥ed
[1][
block_y
], cuºSli˚->
m¥_8x8
[1][
be°_ùmode
], 
block_x
, 0);

419 
	`c›y_image_d©a_8x8
(&
cuºSli˚
->
mb_¥ed
[2][
block_y
], cuºSli˚->
m¥_8x8
[2][
be°_ùmode
], 
block_x
, 0);

422  
n⁄zîo
;

423 
	}
}

	@lencod/src/vlc.c

17 
	~"c⁄åibut‹s.h
"

19 
	~<m©h.h
>

21 
	~"globÆ.h
"

22 
	~"íc_°©i°ics.h
"

23 
	~"vlc.h
"

25 #i‡
TRACE


26 
	#SYMTRACESTRING
(
s
Ë
	`°∫˝y
(
sym
.
åa˚°rög
,s,
TRACESTRING_SIZE
)

	)

28 
	#SYMTRACESTRING
(
s
)

30 

	)

32 c⁄° 
byã
 
	gNCBP
[2][48][2]=

72 
	$wrôe_ue_v
 (*
åa˚°rög
, 
vÆue
, 
Bô°ªam
 *
bô°ªam
)

74 
Sy¡axEÀmít
 
symbﬁ
, *
sym
=&symbol;

75 
sym
->
vÆue1
 = 
vÆue
;

76 
sym
->
vÆue2
 = 0;

80 
	`ue_löfo
(
sym
->
vÆue1
,sym->
vÆue2
,&(sym->
Àn
),&(sym->
öf
));

81 
	`symbﬁ2uvlc
(
sym
);

83 
	`wrôeUVLC2buf„r
 (
sym
, 
bô°ªam
);

85 #i‡
TRACE


86 
	`°∫˝y
(
sym
->
åa˚°rög
,åa˚°rög,
TRACESTRING_SIZE
);

87 
	`åa˚2out
 (
sym
);

90  (
sym
->
Àn
);

91 
	}
}

117 
	$wrôe_£_v
 (*
åa˚°rög
, 
vÆue
, 
Bô°ªam
 *
bô°ªam
)

119 
Sy¡axEÀmít
 
symbﬁ
, *
sym
=&symbol;

120 
sym
->
vÆue1
 = 
vÆue
;

121 
sym
->
vÆue2
 = 0;

125 
	`£_löfo
(
sym
->
vÆue1
,sym->
vÆue2
,&(sym->
Àn
),&(sym->
öf
));

126 
	`symbﬁ2uvlc
(
sym
);

128 
	`wrôeUVLC2buf„r
 (
sym
, 
bô°ªam
);

130 #i‡
TRACE


131 
	`°∫˝y
(
sym
->
åa˚°rög
,åa˚°rög,
TRACESTRING_SIZE
);

132 
	`åa˚2out
 (
sym
);

135  (
sym
->
Àn
);

136 
	}
}

163 
Boﬁón
 
	$wrôe_u_1
 (*
åa˚°rög
, 
vÆue
, 
Bô°ªam
 *
bô°ªam
)

165 
Sy¡axEÀmít
 
symbﬁ
, *
sym
=&symbol;

167 
sym
->
bô∑âîn
 = 
vÆue
;

168 
sym
->
vÆue1
 = 
vÆue
;

169 
sym
->
Àn
 = 1;

173 
	`wrôeUVLC2buf„r
(
sym
, 
bô°ªam
);

175 #i‡
TRACE


176 
	`°∫˝y
(
sym
->
åa˚°rög
,åa˚°rög,
TRACESTRING_SIZE
);

177 
	`åa˚2out
 (
sym
);

180  ((
Boﬁón
Ë
sym
->
Àn
);

181 
	}
}

210 
	$wrôe_u_v
 (
n
, *
åa˚°rög
, 
vÆue
, 
Bô°ªam
 *
bô°ªam
)

212 
Sy¡axEÀmít
 
symbﬁ
, *
sym
=&symbol;

214 
sym
->
bô∑âîn
 = 
vÆue
;

215 
sym
->
vÆue1
 = 
vÆue
;

216 
sym
->
Àn
 = 
n
;

220 
	`wrôeUVLC2buf„r
(
sym
, 
bô°ªam
);

222 #i‡
TRACE


223 
	`°∫˝y
(
sym
->
åa˚°rög
,åa˚°rög,
TRACESTRING_SIZE
);

224 
	`åa˚2out
 (
sym
);

227  (
sym
->
Àn
);

228 
	}
}

245 
	$ue_löfo
(
ue
, 
dummy
, *
Àn
,*
öfo
)

247 
i
, 
¬
 =(
ue
 + 1) >> 1;

249 
i
=0; i < 33 && 
¬
 != 0; i++)

251 
¬
 >>= 1;

253 *
Àn
 = (
i
 << 1) + 1;

254 *
öfo
 = 
ue
 + 1 - (1 << 
i
);

255 
	}
}

272 
	$£_löfo
(
£
, 
dummy
, *
Àn
,*
öfo
)

274 
sign
 = (
£
 <= 0) ? 1 : 0;

275 
n
 = 
	`übs
(
£
) << 1;

276 
¬
 = (
n
 >> 1);

277 
i
;

278 
i
 = 0; i < 33 && 
¬
 != 0; i++)

280 
¬
 >>= 1;

282 *
Àn
 = (
i
 << 1) + 1;

283 *
öfo
 = 
n
 - (1 << 
i
Ë+ 
sign
;

284 
	}
}

295 
	$cbp_löfo_öåa_Ÿhî
(
cbp
, 
dummy
, *
Àn
,*
öfo
)

297 
	`ue_löfo
(
NCBP
[0][
cbp
][0], 
dummy
, 
Àn
, 
öfo
);

298 
	}
}

309 
	$cbp_löfo_öåa_n‹mÆ
(
cbp
, 
dummy
, *
Àn
,*
öfo
)

311 
	`ue_löfo
(
NCBP
[1][
cbp
][0], 
dummy
, 
Àn
, 
öfo
);

312 
	}
}

322 
	$cbp_löfo_öãr_Ÿhî
(
cbp
, 
dummy
, *
Àn
,*
öfo
)

324 
	`ue_löfo
(
NCBP
[0][
cbp
][1], 
dummy
, 
Àn
, 
öfo
);

325 
	}
}

335 
	$cbp_löfo_öãr_n‹mÆ
(
cbp
, 
dummy
, *
Àn
,*
öfo
)

337 
	`ue_löfo
(
NCBP
[1][
cbp
][1], 
dummy
, 
Àn
, 
öfo
);

338 
	}
}

352 
	$Àvrun_löfo_c2x2
(
Àvñ
,
run
,*
Àn
,*
öfo
)

354 c⁄° 
byã
 
NTAB
[2][2]=

359 c⁄° 
byã
 
LEVRUN
[4]=

364 i‡(
Àvñ
 == 0)

366 *
Àn
=1;

371 
Àvabs
 = 
	`übs
(
Àvñ
);

372 
sign
 = 
Àvñ
 <= 0 ? 1 : 0;

373 
n
 = (
Àvabs
 <
LEVRUN
[
run
]Ë? 
NTAB
[levabs - 1][run] + 1 : (levabs - LEVRUN[run]) * 8 +Ñun * 2;

374 
¬
 = 
n
 >> 1;

375 
i
;

377 
i
=0; i < 16 && 
¬
 != 0; i++)

379 
¬
 >>= 1;

381 *
Àn
 = (
i
 << 1) + 1;

382 *
öfo
 = 
n
 - (1 << 
i
Ë+ 
sign
;

384 
	}
}

399 
	$Àvrun_löfo_öãr
(
Àvñ
,
run
,*
Àn
,*
öfo
)

401 c⁄° 
byã
 
LEVRUN
[16]=

405 c⁄° 
byã
 
NTAB
[4][10]=

413 i‡(
Àvñ
 == 0)

415 *
Àn
=1;

421 
sign
 = (
Àvñ
 <= 0) ? 1 : 0;

422 
Àvabs
 = 
	`übs
(
Àvñ
);

424 
n
 = (
Àvabs
 <
LEVRUN
[
run
]Ë? 
NTAB
[levabs - 1][run] + 1 : (levabs - LEVRUN[run]) * 32 +Ñun * 2;

426 
¬
 = 
n
 >> 1;

427 
i
;

429 
i
=0; i < 16 && 
¬
 != 0; i++)

431 
¬
 >>= 1;

433 *
Àn
 = (
i
 << 1) + 1;

434 *
öfo
 = 
n
 - (1 << 
i
Ë+ 
sign
;

436 
	}
}

451 
	$symbﬁ2uvlc
(
Sy¡axEÀmít
 *
sym
)

453 
suffix_Àn
 = 
sym
->
Àn
 >> 1;

455 
suffix_Àn
 = (1 << suffix_len);

456 
sym
->
bô∑âîn
 = 
suffix_Àn
 | (sym->
öf
 & (suffix_len - 1));

458 
	}
}

466 
	$wrôeSE_UVLC
(
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
)

468 
	`ue_löfo
 (
£
->
vÆue1
,£->
vÆue2
,&(£->
Àn
),&(£->
öf
));

469 
	`symbﬁ2uvlc
(
£
);

471 
	`wrôeUVLC2buf„r
(
£
, 
dp
->
bô°ªam
);

473 if(
£
->
ty≥
 !
SE_HEADER
)

474 
dp
->
bô°ªam
->
wrôe_Êag
 = 1;

476 #i‡
TRACE


477 if(
dp
->
bô°ªam
->
åa˚_íabÀd
)

478 
	`åa˚2out
 (
£
);

480 
	}
}

488 
	$wrôeSE_SVLC
(
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
)

490 
	`£_löfo
 (
£
->
vÆue1
,£->
vÆue2
,&(£->
Àn
),&(£->
öf
));

491 
	`symbﬁ2uvlc
(
£
);

493 
	`wrôeUVLC2buf„r
(
£
, 
dp
->
bô°ªam
);

495 if(
£
->
ty≥
 !
SE_HEADER
)

496 
dp
->
bô°ªam
->
wrôe_Êag
 = 1;

498 #i‡
TRACE


499 if(
dp
->
bô°ªam
->
åa˚_íabÀd
)

500 
	`åa˚2out
 (
£
);

502 
	}
}

510 
	$wrôeCBP_VLC
 (
Ma¸oblock
* 
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
)

512 i‡(
cuºMB
->
mb_ty≥
 =
I4MB
 || cuºMB->mb_ty≥ =
SI4MB
 || cuºMB->mb_ty≥ =
I8MB
)

514 
cuºMB
->
	`cbp_löfo_öåa
 (
£
->
vÆue1
, se->
vÆue2
, &(£->
Àn
), &(£->
öf
));

518 
cuºMB
->
	`cbp_löfo_öãr
 (
£
->
vÆue1
,£->
vÆue2
,&(£->
Àn
),&(£->
öf
));

520 
	`symbﬁ2uvlc
(
£
);

522 
	`wrôeUVLC2buf„r
(
£
, 
dp
->
bô°ªam
);

524 if(
£
->
ty≥
 !
SE_HEADER
)

525 
dp
->
bô°ªam
->
wrôe_Êag
 = 1;

527 #i‡
TRACE


528 if(
dp
->
bô°ªam
->
åa˚_íabÀd
)

529 
	`åa˚2out
 (
£
);

531 
	}
}

540 
	$wrôeI¡øPªdMode_CAVLC
(
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
)

543 i‡(
£
->
vÆue1
 == -1)

545 
£
->
Àn
 = 1;

546 
£
->
öf
 = 1;

550 
£
->
Àn
 = 4;

551 
£
->
öf
 = se->
vÆue1
;

554 
£
->
bô∑âîn
 = se->
öf
;

555 
	`wrôeUVLC2buf„r
(
£
, 
dp
->
bô°ªam
);

557 if(
£
->
ty≥
 !
SE_HEADER
)

558 
dp
->
bô°ªam
->
wrôe_Êag
 = 1;

560 #i‡
TRACE


561 if(
dp
->
bô°ªam
->
åa˚_íabÀd
)

562 
	`åa˚2out
 (
£
);

566 
	}
}

577 
	$wrôeSy¡axEÀmít2Buf_UVLC
(
Sy¡axEÀmít
 *
£
, 
Bô°ªam
* 
this_°ªamBuf„r
 )

580 
£
->
	`m≠pög
(£->
vÆue1
,£->
vÆue2
,&(£->
Àn
),&(£->
öf
));

582 
	`symbﬁ2uvlc
(
£
);

584 
	`wrôeUVLC2buf„r
(
£
, 
this_°ªamBuf„r
 );

586 #i‡
TRACE


587 if(
£
->
ty≥
 <= 1)

588 
	`åa˚2out
 (
£
);

591  (
£
->
Àn
);

592 
	}
}

601 
	$wrôeUVLC2buf„r
(
Sy¡axEÀmít
 *
£
, 
Bô°ªam
 *
cuºSåóm
)

603 
mask
 = 1 << (
£
->
Àn
 - 1);

604 
byã
 *
byã_buf
 = &
cuºSåóm
->byte_buf;

605 *
bôs_to_go
 = &
cuºSåóm
->bits_to_go;

606 
i
;

610 i‡–
£
->
Àn
 < 33 )

612 
i
 = 0; i < 
£
->
Àn
; i++)

614 *
byã_buf
 <<= 1;

616 i‡(
£
->
bô∑âîn
 & 
mask
)

617 *
byã_buf
 |= 1;

619 
mask
 >>= 1;

621 i‡((--(*
bôs_to_go
)) == 0)

623 *
bôs_to_go
 = 8;

624 
cuºSåóm
->
°ªamBuf„r
[cuºSåóm->
byã_pos
++] = *
byã_buf
;

625 *
byã_buf
 = 0;

632 
i
 = 0; i < (
£
->
Àn
 - 32); i++)

634 *
byã_buf
 <<= 1;

636 i‡((--(*
bôs_to_go
)) == 0)

638 *
bôs_to_go
 = 8;

639 
cuºSåóm
->
°ªamBuf„r
[cuºSåóm->
byã_pos
++] = *
byã_buf
;

640 *
byã_buf
 = 0;

644 
mask
 = () 1 << 31;

645 
i
 = 0; i < 32; i++)

647 *
byã_buf
 <<= 1;

649 i‡(
£
->
bô∑âîn
 & 
mask
)

650 *
byã_buf
 |= 1;

652 
mask
 >>= 1;

654 i‡((--(*
bôs_to_go
)) == 0)

656 *
bôs_to_go
 = 8;

657 
cuºSåóm
->
°ªamBuf„r
[cuºSåóm->
byã_pos
++] = *
byã_buf
;

658 *
byã_buf
 = 0;

662 
	}
}

673 
	$wrôeSy¡axEÀmít2Buf_Fixed
(
Sy¡axEÀmít
 *
£
, 
Bô°ªam
* 
this_°ªamBuf„r
 )

675 
	`wrôeUVLC2buf„r
(
£
, 
this_°ªamBuf„r
 );

677 #i‡
TRACE


678 if(
£
->
ty≥
 <= 1)

679 
	`åa˚2out
 (
£
);

681  (
£
->
Àn
);

682 
	}
}

692 
	$wrôeSE_Fœg
(
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
 )

694 
£
->
Àn
 = 1;

695 
£
->
bô∑âîn
 = (£->
vÆue1
 & 1);

697 
	`wrôeUVLC2buf„r
(
£
, 
dp
->
bô°ªam
 );

699 #i‡
TRACE


700 if(
dp
->
bô°ªam
->
åa˚_íabÀd
)

701 
	`åa˚2out
 (
£
);

703 
	}
}

713 
	$wrôeSE_övFœg
(
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
 )

715 
£
->
Àn
 = 1;

716 
£
->
bô∑âîn
 = 1 - (£->
vÆue1
 & 1);

718 
	`wrôeUVLC2buf„r
(
£
, 
dp
->
bô°ªam
 );

720 #i‡
TRACE


721 if(
dp
->
bô°ªam
->
åa˚_íabÀd
)

722 
	`åa˚2out
 (
£
);

724 
	}
}

734 
	$wrôeSE_Dummy
(
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
 )

736 
£
->
Àn
 = 0;

737 
	}
}

748 
	$wrôeSE_Fix
(
Sy¡axEÀmít
 *
£
, 
Bô°ªam
 *
bô°ªam
 )

750 
	`wrôeUVLC2buf„r
(
£
, 
bô°ªam
);

752 #i‡
TRACE


753 if(
bô°ªam
->
åa˚_íabÀd
)

754 
	`åa˚2out
 (
£
);

756 
	}
}

770 
	$symbﬁ2vlc
(
Sy¡axEÀmít
 *
sym
)

772 
öfo_Àn
 = 
sym
->
Àn
;

775 
sym
->
bô∑âîn
 = 0;

778 --
öfo_Àn
 >= 0)

780 
sym
->
bô∑âîn
 <<= 1;

781 
sym
->
bô∑âîn
 |(0x01 & (sym->
öf
 >> 
öfo_Àn
));

784 
	}
}

793 
	$wrôeSy¡axEÀmít_VLC
(
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
)

795 
£
->
öf
 = se->
vÆue1
;

796 
£
->
Àn
 = se->
vÆue2
;

797 
	`symbﬁ2vlc
(
£
);

799 
	`wrôeUVLC2buf„r
(
£
, 
dp
->
bô°ªam
);

801 if(
£
->
ty≥
 !
SE_HEADER
)

802 
dp
->
bô°ªam
->
wrôe_Êag
 = 1;

804 #i‡
TRACE


805 if(
dp
->
bô°ªam
->
åa˚_íabÀd
)

806 
	`åa˚2out
 (
£
);

809  (
£
->
Àn
);

810 
	}
}

820 
	$wrôeSy¡axEÀmít_NumC€ffTøûögO√s
(
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
)

822 c⁄° 
byã
 
À¡ab
[3][4][17] =

845 c⁄° 
byã
 
codèb
[3][4][17] =

866 
vl˙um
 = 
£
->
Àn
;

871 i‡(
vl˙um
 == 3)

873 
£
->
Àn
 = 6;

874 i‡(
£
->
vÆue1
 > 0)

876 
£
->
öf
 = ((£->
vÆue1
-1Ë<< 2Ë| se->
vÆue2
;

880 
£
->
öf
 = 3;

885 
£
->
Àn
 = 
À¡ab
[
vl˙um
][£->
vÆue2
][£->
vÆue1
];

886 
£
->
öf
 = 
codèb
[
vl˙um
][£->
vÆue2
][£->
vÆue1
];

889 i‡(
£
->
Àn
 == 0)

891 
	`¥ötf
("ERROR: (numcoeff,trailingones)Çot valid: vlc=%d (%d, %d)\n",

892 
vl˙um
, 
£
->
vÆue1
, se->
vÆue2
);

893 
	`exô
(-1);

896 
	`symbﬁ2vlc
(
£
);

898 
	`wrôeUVLC2buf„r
(
£
, 
dp
->
bô°ªam
);

900 if(
£
->
ty≥
 !
SE_HEADER
)

901 
dp
->
bô°ªam
->
wrôe_Êag
 = 1;

903 #i‡
TRACE


904 if(
dp
->
bô°ªam
->
åa˚_íabÀd
)

905 
	`åa˚2out
 (
£
);

908  (
£
->
Àn
);

909 
	}
}

918 
	$wrôeSy¡axEÀmít_NumC€ffTøûögO√sChromaDC
(
VideoP¨amëîs
 *
p_Vid
, 
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
)

920 c⁄° 
byã
 
À¡ab
[3][4][17] =

939 c⁄° 
byã
 
codèb
[3][4][17] =

958 
yuv
 = 
p_Vid
->
yuv_f‹m©
 - 1;

962 
£
->
Àn
 = 
À¡ab
[
yuv
][£->
vÆue2
][£->
vÆue1
];

963 
£
->
öf
 = 
codèb
[
yuv
][£->
vÆue2
][£->
vÆue1
];

965 i‡(
£
->
Àn
 == 0)

967 
	`¥ötf
("ERROR: (numcoeff,trailingones)Çot valid: (%d, %d)\n",

968 
£
->
vÆue1
, se->
vÆue2
);

969 
	`exô
(-1);

972 
	`symbﬁ2vlc
(
£
);

974 
	`wrôeUVLC2buf„r
(
£
, 
dp
->
bô°ªam
);

976 if(
£
->
ty≥
 !
SE_HEADER
)

977 
dp
->
bô°ªam
->
wrôe_Êag
 = 1;

979 #i‡
TRACE


980 if(
dp
->
bô°ªam
->
åa˚_íabÀd
)

981 
	`åa˚2out
 (
£
);

984  (
£
->
Àn
);

985 
	}
}

994 
	$wrôeSy¡axEÀmít_TŸÆZîos
(
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
)

996 c⁄° 
byã
 
À¡ab
[
TOTRUN_NUM
][16] =

1015 c⁄° 
byã
 
codèb
[
TOTRUN_NUM
][16] =

1033 
vl˙um
 = 
£
->
Àn
;

1036 
£
->
Àn
 = 
À¡ab
[
vl˙um
][£->
vÆue1
];

1037 
£
->
öf
 = 
codèb
[
vl˙um
][£->
vÆue1
];

1039 i‡(
£
->
Àn
 == 0)

1041 
	`¥ötf
("ERROR: (TŸÆZîosËnŸ vÆid: (%d)\n",
£
->
vÆue1
);

1042 
	`exô
(-1);

1045 
	`symbﬁ2vlc
(
£
);

1047 
	`wrôeUVLC2buf„r
(
£
, 
dp
->
bô°ªam
);

1049 if(
£
->
ty≥
 !
SE_HEADER
)

1050 
dp
->
bô°ªam
->
wrôe_Êag
 = 1;

1052 #i‡
TRACE


1053 if(
dp
->
bô°ªam
->
åa˚_íabÀd
)

1054 
	`åa˚2out
 (
£
);

1057  (
£
->
Àn
);

1058 
	}
}

1067 
	$wrôeSy¡axEÀmít_TŸÆZîosChromaDC
(
VideoP¨amëîs
 *
p_Vid
, 
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
)

1069 c⁄° 
byã
 
À¡ab
[3][
TOTRUN_NUM
][16] =

1101 c⁄° 
byã
 
codèb
[3][
TOTRUN_NUM
][16] =

1132 
vl˙um
 = 
£
->
Àn
;

1133 
yuv
 = 
p_Vid
->
yuv_f‹m©
 - 1;

1136 
£
->
Àn
 = 
À¡ab
[
yuv
][
vl˙um
][£->
vÆue1
];

1137 
£
->
öf
 = 
codèb
[
yuv
][
vl˙um
][£->
vÆue1
];

1139 i‡(
£
->
Àn
 == 0)

1141 
	`¥ötf
("ERROR: (TŸÆZîosËnŸ vÆid: (%d)\n",
£
->
vÆue1
);

1142 
	`exô
(-1);

1145 
	`symbﬁ2vlc
(
£
);

1147 
	`wrôeUVLC2buf„r
(
£
, 
dp
->
bô°ªam
);

1149 if(
£
->
ty≥
 !
SE_HEADER
)

1150 
dp
->
bô°ªam
->
wrôe_Êag
 = 1;

1152 #i‡
TRACE


1153 if(
dp
->
bô°ªam
->
åa˚_íabÀd
)

1154 
	`åa˚2out
 (
£
);

1157  (
£
->
Àn
);

1158 
	}
}

1167 
	$wrôeSy¡axEÀmít_Run
(
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
)

1169 c⁄° 
byã
 
À¡ab
[
TOTRUN_NUM
][16] =

1180 c⁄° 
byã
 
codèb
[
TOTRUN_NUM
][16] =

1190 
vl˙um
 = 
£
->
Àn
;

1193 
£
->
Àn
 = 
À¡ab
[
vl˙um
][£->
vÆue1
];

1194 
£
->
öf
 = 
codèb
[
vl˙um
][£->
vÆue1
];

1196 i‡(
£
->
Àn
 == 0)

1198 
	`¥ötf
("ERROR: (runËnŸ vÆid: (%d)\n",
£
->
vÆue1
);

1199 
	`exô
(-1);

1202 
	`symbﬁ2vlc
(
£
);

1204 
	`wrôeUVLC2buf„r
(
£
, 
dp
->
bô°ªam
);

1206 if(
£
->
ty≥
 !
SE_HEADER
)

1207 
dp
->
bô°ªam
->
wrôe_Êag
 = 1;

1209 #i‡
TRACE


1210 if(
dp
->
bô°ªam
->
åa˚_íabÀd
)

1211 
	`åa˚2out
 (
£
);

1214  (
£
->
Àn
);

1215 
	}
}

1224 
	$wrôeSy¡axEÀmít_Levñ_VLC1
(
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
, 
¥ofûe_idc
)

1226 
Àvñ
 = 
£
->
vÆue1
;

1227 
sign
 = (
Àvñ
 < 0 ? 1 : 0);

1228 
Àvabs
 = 
	`übs
(
Àvñ
);

1230 i‡(
Àvabs
 < 8)

1232 
£
->
Àn
 = 
Àvabs
 * 2 + 
sign
 - 1;

1233 
£
->
öf
 = 1;

1235 i‡(
Àvabs
 < 16)

1238 
£
->
Àn
 = 19;

1239 
£
->
öf
 = 16 | ((
Àvabs
 << 1Ë- 16Ë| 
sign
;

1243 
iMask
 = 4096, 
numPªfix
 = 0;

1244 
Àvabsm16
 = 
Àvabs
 + 2032;

1247 i‡((
Àvabsm16
) >= 4096)

1249 
numPªfix
++;

1250 (
Àvabsm16
Ë>(4096 << 
numPªfix
))

1252 
numPªfix
++;

1256 
iMask
 <<
numPªfix
;

1257 
£
->
öf
 = 
iMask
 | ((
Àvabsm16
 << 1Ë- iMaskË| 
sign
;

1261 i‡(
numPªfix
 > 0 && !
	`is_FREXT_¥ofûe
–
¥ofûe_idc
 ))

1264 
£
->
Àn
 = 0x0000FFFF;

1265  (
£
->
Àn
);

1268 
£
->
Àn
 = 28 + (
numPªfix
 << 1);

1271 
	`symbﬁ2vlc
(
£
);

1273 
	`wrôeUVLC2buf„r
(
£
, 
dp
->
bô°ªam
);

1275 if(
£
->
ty≥
 !
SE_HEADER
)

1276 
dp
->
bô°ªam
->
wrôe_Êag
 = 1;

1278 #i‡
TRACE


1279 if(
dp
->
bô°ªam
->
åa˚_íabÀd
)

1280 
	`åa˚2out
 (
£
);

1283  (
£
->
Àn
);

1284 
	}
}

1293 
	$wrôeSy¡axEÀmít_Levñ_VLCN
(
Sy¡axEÀmít
 *
£
, 
vlc
, 
D©aP¨tôi⁄
 *
dp
, 
¥ofûe_idc
)

1295 
Àvñ
 = 
£
->
vÆue1
;

1296 
sign
 = (
Àvñ
 < 0 ? 1 : 0);

1297 
Àvabs
 = 
	`übs
(
Àvñ
) - 1;

1299 
shi·
 = 
vlc
 - 1;

1300 
esˇ≥
 = (15 << 
shi·
);

1302 i‡(
Àvabs
 < 
esˇ≥
)

1304 
sufmask
 = ~((0xffffffffË<< 
shi·
);

1305 
suffix
 = (
Àvabs
Ë& 
sufmask
;

1307 
£
->
Àn
 = ((
Àvabs
Ë>> 
shi·
Ë+ 1 + 
vlc
;

1308 
£
->
öf
 = (2 << 
shi·
Ë| (
suffix
 << 1Ë| 
sign
;

1312 
iMask
 = 4096;

1313 
Àvab£sc
 = 
Àvabs
 - 
esˇ≥
 + 2048;

1314 
numPªfix
 = 0;

1316 i‡((
Àvab£sc
) >= 4096)

1318 
numPªfix
++;

1319 (
Àvab£sc
Ë>(4096 << 
numPªfix
))

1321 
numPªfix
++;

1325 
iMask
 <<
numPªfix
;

1326 
£
->
öf
 = 
iMask
 | ((
Àvab£sc
 << 1Ë- iMaskË| 
sign
;

1330 i‡(
numPªfix
 > 0 && !
	`is_FREXT_¥ofûe
–
¥ofûe_idc
 ))

1333 
£
->
Àn
 = 0x0000FFFF;

1334  (
£
->
Àn
);

1336 
£
->
Àn
 = 28 + (
numPªfix
 << 1);

1339 
	`symbﬁ2vlc
(
£
);

1341 
	`wrôeUVLC2buf„r
(
£
, 
dp
->
bô°ªam
);

1343 if(
£
->
ty≥
 !
SE_HEADER
)

1344 
dp
->
bô°ªam
->
wrôe_Êag
 = 1;

1346 #i‡
TRACE


1347 if(
dp
->
bô°ªam
->
åa˚_íabÀd
)

1348 
	`åa˚2out
 (
£
);

1351  (
£
->
Àn
);

1352 
	}
}

1355 #i‡
TRACE


1356 
	gbôcou¡î
 = 0;

1364 
	$åa˚2out
(
Sy¡axEÀmít
 *
sym
)

1366 
i
, 
ch¨s
;

1368 i‡(
p_Enc
->
p_åa˚
 !
NULL
)

1370 
	`putc
('@', 
p_Enc
->
p_åa˚
);

1371 
ch¨s
 = 
	`Ârötf
(
p_Enc
->
p_åa˚
, "%i", 
bôcou¡î
);

1372 
ch¨s
++ < 6)

1373 
	`putc
(' ',
p_Enc
->
p_åa˚
);

1375 
ch¨s
 +
	`Ârötf
(
p_Enc
->
p_åa˚
, "%s", 
sym
->
åa˚°rög
);

1376 
ch¨s
++ < 55)

1377 
	`putc
(' ',
p_Enc
->
p_åa˚
);

1380 if(
sym
->
Àn
<15)

1382 
i
=0 ; i<15-
sym
->
Àn
 ; i++)

1383 
	`Âutc
(' ', 
p_Enc
->
p_åa˚
);

1387 
bôcou¡î
 +
sym
->
Àn
;

1388 
i
=1 ; i<=
sym
->
Àn
 ; i++)

1390 if((
sym
->
bô∑âîn
 >> (sym->
Àn
-
i
)) & 0x1)

1391 
	`Âutc
('1', 
p_Enc
->
p_åa˚
);

1393 
	`Âutc
('0', 
p_Enc
->
p_åa˚
);

1395 
	`Ârötf
(
p_Enc
->
p_åa˚
, " (%3dË\n",
sym
->
vÆue1
);

1397 
	`fÊush
 (
p_Enc
->
p_åa˚
);

1398 
	}
}

1400 
	$åa˚2out_ˇbac
(
Sy¡axEÀmít
 *
sym
)

1402 
ch¨s
;

1404 i‡(
p_Enc
->
p_åa˚
 !
NULL
)

1406 
	`putc
('@', 
p_Enc
->
p_åa˚
);

1407 
ch¨s
 = 
	`Ârötf
(
p_Enc
->
p_åa˚
, "%i", 
bôcou¡î
);

1408 
ch¨s
++ < 6)

1409 
	`putc
(' ',
p_Enc
->
p_åa˚
);

1411 
ch¨s
 +
	`Ârötf
(
p_Enc
->
p_åa˚
, "%s", 
sym
->
åa˚°rög
);

1412 
ch¨s
++ < 70)

1413 
	`putc
(' ',
p_Enc
->
p_åa˚
);

1415 
	`Ârötf
(
p_Enc
->
p_åa˚
, " (%3dË\n",
sym
->
vÆue1
);

1417 
	`fÊush
 (
p_Enc
->
p_åa˚
);

1418 
bôcou¡î
 +
sym
->
Àn
;

1419 
	}
}

1438 
	$wrôeVlcByãAlign
(
VideoP¨amëîs
 *
p_Vid
, 
Bô°ªam
* 
cuºSåóm
, 
SètP¨amëîs
 *
cur_°©s
)

1440 i‡(
cuºSåóm
->
bôs_to_go
 < 8)

1442 
cuºSåóm
->
byã_buf
 = (
byã
Ë((cuºSåóm->byã_bu‡<< cuºSåóm->
bôs_to_go
) | (0xff >> (8 - currStream->bits_to_go)));

1443 
cuºSåóm
->
°ªamBuf„r
[cuºSåóm->
byã_pos
++] = cuºSåóm->
byã_buf
;

1444 
cur_°©s
->
bô_u£_°uffög_bôs
[
p_Vid
->
ty≥
] +
cuºSåóm
->
bôs_to_go
;

1445 
cuºSåóm
->
bôs_to_go
 = 8;

1447 
	}
}

1454 
	$ª£t_mb_nz_c€ff
(
VideoP¨amëîs
 *
p_Vid
, 
mb_numbî
)

1456 
	`mem£t
(&
p_Vid
->
nz_c€ff
 [
mb_numbî
][0][0], 0, 
BLOCK_SIZE
 * (BLOCK_SIZE +Ö_Vid->
num_blk8x8_uv
) * ());

1457 
	}
}

1460 
	$wrôeUVLC_CAVLC
(
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
)

1462 
	`wrôeSE_UVLC
(
£
, 
dp
);

1463 
	}
}

1465 
	$wrôeSVLC_CAVLC
(
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
)

1467 
	`wrôeSE_SVLC
(
£
, 
dp
);

1468 
	}
}

1470 
	$wrôeFœg_CAVLC
(
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
)

1472 
	`wrôeSE_Fœg
(
£
, 
dp
);

1473 
	}
}

1475 
	$bs_bôÀngth
(
Bô°ªam
 *
bô°ªam
)

1477  (
bô°ªam
->
byã_pos
*8+(8-bô°ªam->
bôs_to_go
));

1478 
	}
}

1487 
	$wrôeRefPic_Dummy
(
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
 )

1489 
£
->
Àn
 = 0;

1490 
	}
}

1499 
	$wrôeRefPic_2Ref_CAVLC
(
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
 )

1501 
	`wrôeSE_övFœg
–
£
, 
dp
 );

1502 
	}
}

1511 
	$wrôeRefPic_NRef_CAVLC
(
Ma¸oblock
 *
cuºMB
, 
Sy¡axEÀmít
 *
£
, 
D©aP¨tôi⁄
 *
dp
 )

1513 
	`wrôeSE_UVLC
–
£
, 
dp
 );

1514 
	}
}

1534 
	$GëBôs
 (
byã
 *
buf„r
,

1535 
tŸbôoff£t
,

1536 *
öfo
,

1537 
bôcou¡
,

1538 
numbôs
)

1540 i‡((
tŸbôoff£t
 + 
numbôs
 ) > 
bôcou¡
)

1546 
bôoff£t
 = 7 - (
tŸbôoff£t
 & 0x07);

1547 
byãoff£t
 = (
tŸbôoff£t
 >> 3);

1548 
bôcou¡î
 = 
numbôs
;

1549 
byã
 *
curbyã
 = &(
buf„r
[
byãoff£t
]);

1550 
öf
 = 0;

1552 
numbôs
--)

1554 
öf
 <<=1;

1555 
öf
 |((*
curbyã
)>> (
bôoff£t
--)) & 0x01;

1556 i‡(
bôoff£t
 == -1 )

1558 
curbyã
++;

1559 
bôoff£t
 = 7;

1565 *
öfo
 = 
öf
;

1567  
bôcou¡î
;

1569 
	}
}

	@lencod/src/weighted_prediction.c

15 
	~"c⁄åibut‹s.h
"

17 
	~"globÆ.h
"

18 
	~"image.h
"

19 
	~"wp.h
"

27 
	$InôWP
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
, 
f‹˚_wp_mëhod
)

29 if(
f‹˚_wp_mëhod
)

31 
p_Vid
->
E°im©eWPPSli˚
 = 
E°im©eWPPSli˚Alg1
;

32 
p_Vid
->
E°im©eWPBSli˚
 = 
E°im©eWPBSli˚Alg1
;

33 
p_Vid
->
Te°WPPSli˚
 = 
Te°WPPSli˚Alg1
;

34 
p_Vid
->
Te°WPBSli˚
 = 
Te°WPBSli˚Alg1
;

37 i‡(
p_I≈
->
WPIãrMC
 && 
p_Vid
->
«l_ª„ªn˚_idc
)

39 
p_Vid
->
E°im©eWPPSli˚
 = 
E°im©eWPPSli˚Alg2
;

40 
p_Vid
->
E°im©eWPBSli˚
 = 
E°im©eWPBSli˚Alg2
;

41 
p_Vid
->
Te°WPPSli˚
 = 
Te°WPPSli˚Alg2
;

42 
p_Vid
->
Te°WPBSli˚
 = 
Te°WPBSli˚Alg2
;

46 
wp_mëhod
 = 
p_I≈
->
WPMëhod
;

47 
wp_mëhod
)

51 
p_Vid
->
E°im©eWPPSli˚
 = 
E°im©eWPPSli˚Alg0
;

52 
p_Vid
->
E°im©eWPBSli˚
 = 
E°im©eWPBSli˚Alg0
;

53 
p_Vid
->
Te°WPPSli˚
 = 
Te°WPPSli˚Alg0
;

54 
p_Vid
->
Te°WPBSli˚
 = 
Te°WPBSli˚Alg0
;

57 
p_Vid
->
E°im©eWPPSli˚
 = 
E°im©eWPPSli˚Alg1
;

58 
p_Vid
->
E°im©eWPBSli˚
 = 
E°im©eWPBSli˚Alg1
;

59 
p_Vid
->
Te°WPPSli˚
 = 
Te°WPPSli˚Alg1
;

60 
p_Vid
->
Te°WPBSli˚
 = 
Te°WPBSli˚Alg1
;

63 
p_Vid
->
E°im©eWPPSli˚
 = 
E°im©eWPPSli˚R™dom
;

64 
p_Vid
->
E°im©eWPBSli˚
 = 
E°im©eWPBSli˚R™dom
;

65 
p_Vid
->
Te°WPPSli˚
 = 
Te°WPPSli˚R™dom
;

66 
p_Vid
->
Te°WPBSli˚
 = 
Te°WPBSli˚R™dom
;

69 
p_Vid
->
E°im©eWPPSli˚
 = 
E°im©eWPPSli˚Pîiodic
;

70 
p_Vid
->
E°im©eWPBSli˚
 = 
E°im©eWPBSli˚Pîiodic
;

71 
p_Vid
->
Te°WPPSli˚
 = 
Te°WPPSli˚Pîiodic
;

72 
p_Vid
->
Te°WPBSli˚
 = 
Te°WPBSli˚Pîiodic
;

77 
	}
}

79 
	$Re£tWP
(
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
)

81 
deÁu…_weights
[3];

82 
luma_log_weight_díom
 = 5;

83 
chroma_log_weight_díom
 = 5;

84 
cur_¶i˚
, 
˛i°
, 
n
;

86 
deÁu…_weights
[0] = 1 << 
luma_log_weight_díom
;

87 
deÁu…_weights
[1] = deÁu…_weights[2] = 1 << 
chroma_log_weight_díom
;

89 
p_Vid
->
wp_∑ømëîs_£t
 = 0;

90 
cur_¶i˚
 = 0; cur_¶i˚ < 
p_Vid
->
num_¶i˚s_wp
; cur_slice++)

92 
˛i°
 = 0; clist < 2 ; clist++)

94 
n
 = 0;Ç < 
p_I≈
->
num_ªf_‰ames
;Ç++)

96 
p_Vid
->
wp_weights
[0][
˛i°
][
n
][
cur_¶i˚
] = 
deÁu…_weights
[0];

97 
p_Vid
->
wp_off£ts
[0][
˛i°
][
n
][
cur_¶i˚
] = 0;

98 
p_Vid
->
wp_weights
[1][
˛i°
][
n
][
cur_¶i˚
] = 
deÁu…_weights
[1];

99 
p_Vid
->
wp_off£ts
[1][
˛i°
][
n
][
cur_¶i˚
] = 0;

100 
p_Vid
->
wp_weights
[2][
˛i°
][
n
][
cur_¶i˚
] = 
deÁu…_weights
[2];

101 
p_Vid
->
wp_off£ts
[2][
˛i°
][
n
][
cur_¶i˚
] = 0;

105 
	}
}

107 
	$CompuãIm∂icôWeights
(
Sli˚
 *
cuºSli˚
,

108 
deÁu…_weight
[3],

109 
im_weight
[6][
MAX_REFERENCE_PICTURES
][MAX_REFERENCE_PICTURES][3])

111 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

112 
i
, 
j
, 
comp
;

113 
tx
, 
td
, 
tb
, 
Di°SˇÀFa˘‹
;

115 
i
 = 0; i < 
cuºSli˚
->
li°Xsize
[
LIST_0
]; i++)

117 
j
 = 0; j < 
cuºSli˚
->
li°Xsize
[
LIST_1
]; j++)

119 
td
 = (Ë
	`iClù3
(-128, 127,(
cuºSli˚
->
li°X
[
LIST_1
][
j
]->
poc
 - cuºSli˚->li°X[
LIST_0
][
i
]->poc));

120 
tb
 = (Ë
	`iClù3
(-128, 127,(
p_Vid
->
ThisPOC
 - 
cuºSli˚
->
li°X
[
LIST_0
][
i
]->
poc
));

121 
comp
 = 0; comp < 3; comp++)

124 i‡(
td
 == 0)

126 
im_weight
[0][
i
][
j
][
comp
] = 
deÁu…_weight
[comp];

127 
im_weight
[1][
i
][
j
][
comp
] = 
deÁu…_weight
[comp];

131 
tx
 = (Ë(16384 + 
	`übs
(
td
 >> 1))/td;

132 
Di°SˇÀFa˘‹
 = 
	`sClù3
(-1024, 1023, (
tx
*
tb
 + 32 )>>6);

133 
im_weight
[1][
i
][
j
][
comp
] = 
Di°SˇÀFa˘‹
 >> 2;

134 i‡(
im_weight
[1][
i
][
j
][
comp
] < -64 || im_weight[1][i][j][comp] >128)

135 
im_weight
[1][
i
][
j
][
comp
] = 
deÁu…_weight
[comp];

136 
im_weight
[0][
i
][
j
][
comp
] = 64 - im_weight[1][i][j][comp];

141 
	}
}

150 
	$CompuãImgSum
(
img≥l
 **
CuºítImage
, 
height
, 
width
)

152 
i
, 
j
;

153 
sum_vÆue
 = 0.0;

154 
img≥l
 *
p_tmp
;

156 
i
 = 0; i < 
height
; i++)

158 
p_tmp
 = 
CuºítImage
[
i
];

159 
j
 = 0; j < 
width
; j++)

161 
sum_vÆue
 +(Ë*(
p_tmp
++);

164  
sum_vÆue
;

165 
	}
}

167 
	$CompuãBlockSum
(
img≥l
 **
CuºítImage
, 
height_ö_blk
, 
width_ö_blk
, 
blk_size_y
, 
blk_size_x
, 
cur_blk
)

169 
x
, 
y
;

170 
sum
 = 0;

172 
blkx
 = 
cur_blk
 % 
width_ö_blk
;

173 
blky
 = 
cur_blk
 / 
width_ö_blk
;

174 
blk_°¨t_x
 = 
blkx
*
blk_size_x
;

175 
blk_°¨t_y
 = 
blky
*
blk_size_y
;

176 
img≥l
 *
img_±r
;

178 
y
 = 0; y < 
blk_size_y
; y++)

180 
img_±r
 = &
CuºítImage
[
blk_°¨t_y
 + 
y
][
blk_°¨t_x
];

181 
x
 = 0; x < 
blk_size_x
; x++)

183 
sum
 +
img_±r
[
x
];

187  
sum
;

188 
	}
}

190 
	$CompuãImgSumBlockBa£d
(
img≥l
 **
CuºítImage
,

191 
height_ö_blk
, 
width_ö_blk
,

192 
blk_size_y
, 
blk_size_x
,

193 
°¨t_blk
, 
íd_blk
, *
dc
)

195 
cur_blk
;

196 
block_sum
;

197 
öt64
 
¶i˚_sum
 = 0;

199 
cur_blk
 = 
°¨t_blk
; cur_blk < 
íd_blk
; cur_blk++)

201 
block_sum
 = 
	`CompuãBlockSum
(
CuºítImage
, 
height_ö_blk
, 
width_ö_blk
, 
blk_size_y
, 
blk_size_x
, 
cur_blk
);

202 
¶i˚_sum
 +
block_sum
;

204 (*
dc
Ë(Ë
¶i˚_sum
;

205 
	}
}

207 
öt64
 
	$CompuãSumBlockBa£d
(
img≥l
 **
CuºítImage
,

208 
height_ö_blk
, 
width_ö_blk
,

209 
blk_size_y
, 
blk_size_x
,

210 
°¨t_blk
, 
íd_blk
)

212 
cur_blk
;

213 
öt64
 
¶i˚_sum
 = 0;

215 
cur_blk
 = 
°¨t_blk
; cur_blk < 
íd_blk
; cur_blk++)

217 
¶i˚_sum
 +
	`CompuãBlockSum
(
CuºítImage
, 
height_ö_blk
, 
width_ö_blk
, 
blk_size_y
, 
blk_size_x
, 
cur_blk
);

219  
¶i˚_sum
;

220 
	}
}

229 
	$E°im©eWPPSli˚Alg0
(
Sli˚
 *
cuºSli˚
, 
£À˘_off£t
)

231 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

232 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºSli˚
->p_Inp;

233 
dc_‹g
 = 0.0;

234 
dc_‹g_UV
[2] = {0.0};

235 
dc_ªf
[
MAX_REFERENCE_PICTURES
] = { 0.0 };

236 
dc_ªf_UV
[
MAX_REFERENCE_PICTURES
][2] = { {0.0}};

238 
i
, 
n
, 
k
;

239 
deÁu…_weight
[3];

240 
cur_weight
, 
cur_off£t
;

241 
li°_off£t
 = ((
cuºSli˚
->
mb_aff_‰ame_Êag
)&&(
p_Vid
->
mb_d©a
[p_Vid->
cuºít_mb_ƒ
].
mb_fõld
))? (p_Vid->current_mb_nr & 0x01) ? 4 : 2 : 0;

242 
weight
[2][
MAX_REFERENCE_PICTURES
][3];

243 
off£t
[2][
MAX_REFERENCE_PICTURES
][3];

244 
˛i°
;

246 
img≥l
 **
tmpPå
;

248 
cuºSli˚
->
luma_log_weight_díom
 = 5;

249 
cuºSli˚
->
chroma_log_weight_díom
 = 5;

251 
cuºSli˚
->
wp_luma_round
 = 1 << (cuºSli˚->
luma_log_weight_díom
 - 1);

252 
cuºSli˚
->
wp_chroma_round
 = 1 << (cuºSli˚->
chroma_log_weight_díom
 - 1);

253 
deÁu…_weight
[0] = 1 << 
cuºSli˚
->
luma_log_weight_díom
;

254 
deÁu…_weight
[1] = deÁu…_weight[2] = 1 << 
cuºSli˚
->
chroma_log_weight_díom
;

256 
dc_‹g
 = 
	`CompuãImgSum
(
p_Vid
->
pCurImg
,Ö_Vid->
height
,Ö_Vid->
width
);

258 i‡(
p_I≈
->
ChromaWeightSuµ‹t
 == 1)

260 
k
 = 0; k < 2; k++)

262 
dc_‹g_UV
[
k
] = 
	`CompuãImgSum
(
p_Vid
->
pImgOrg
[k + 1],Ö_Vid->
height_¸
,Ö_Vid->
width_¸
);

266 
˛i°
 = 0; cli° < 2 + 
li°_off£t
; clist++)

268 
n
 = 0;Ç < 
cuºSli˚
->
li°Xsize
[
˛i°
];Ç++)

270 i‡–
	`wpxDëîmöeWP
–
cuºSli˚
, 
˛i°
, 
n
 ) )

273 
i
 = 0; i < 3; i++)

275 
weight
[
˛i°
][
n
][
i
] = 
deÁu…_weight
[i];

276 
cuºSli˚
->
wp_weight
[
˛i°
][
n
][
i
] = 
deÁu…_weight
[i];

277 
cuºSli˚
->
wp_off£t
[
˛i°
][
n
][
i
] = 0;

278 
off£t
[
˛i°
][
n
][
i
] = 0;

282 
tmpPå
 = 
cuºSli˚
->
li°X
[
˛i°
][
n
]->
p_cuº_img
;

283 
dc_ªf
[
n
] = 
	`CompuãImgSum
(
tmpPå
, 
p_Vid
->
height
,Ö_Vid->
width
);

285 i‡(
p_I≈
->
ChromaWeightSuµ‹t
 == 1)

287 
k
 = 0; k < 2; k++)

290 
tmpPå
 = 
cuºSli˚
->
li°X
[
˛i°
][
n
]->
imgUV
[
k
];

291 
dc_ªf_UV
[
n
][
k
] = 
	`CompuãImgSum
(
tmpPå
, 
p_Vid
->
height_¸
,Ö_Vid->
width_¸
);

295 i‡(
£À˘_off£t
 == 0)

297 i‡(
dc_ªf
[
n
] != 0.0)

298 
cur_weight
 = (Ë(
deÁu…_weight
[0] * 
dc_‹g
 / 
dc_ªf
[
n
] + 0.5);

300 
cur_weight
 = 
deÁu…_weight
[0];

301 
cur_weight
 = 
	`sClù3
(-128, 127, cur_weight);

302 
cur_off£t
 = 0;

304 
weight
[
˛i°
][
n
][0] = 
cur_weight
;

305 
off£t
[
˛i°
][
n
][0] = 
cur_off£t
;

307 i‡(
p_I≈
->
ChromaWeightSuµ‹t
 == 1)

309 i‡(
dc_ªf_UV
[
n
][0] != 0)

310 
weight
[
˛i°
][
n
][1] = (Ë(
deÁu…_weight
[1] * 
dc_‹g_UV
[0] / 
dc_ªf_UV
[n][0] + 0.5);

312 
weight
[
˛i°
][
n
][1] = 
deÁu…_weight
[1];

313 
weight
[
˛i°
][
n
][1] = 
	`sClù3
(-128, 127, weight[clist][n][1]);

315 i‡(
dc_ªf_UV
[
n
][1] != 0)

316 
weight
[
˛i°
][
n
][2] = (Ë(
deÁu…_weight
[2] * 
dc_‹g_UV
[1] / 
dc_ªf_UV
[n][1] + 0.5);

318 
weight
[
˛i°
][
n
][2] = 
deÁu…_weight
[2];

319 
weight
[
˛i°
][
n
][2] = 
	`sClù3
(-128, 127, weight[clist][n][2]);

324 
cur_off£t
 = (Ë((
dc_‹g
 - 
dc_ªf
[
n
])/(
p_Vid
->
size
)+0.5);

325 
cur_off£t
 = (cur_off£t+((
p_Vid
->
bôdïth_luma
-8)>>1))>>(p_Vid->bitdepth_luma-8);

326 
cur_off£t
 = 
	`sClù3
( -128, 127, cur_offset);

327 
cur_off£t
 = cur_off£t<<(
p_Vid
->
bôdïth_luma
-8);

328 
cur_weight
 = 
deÁu…_weight
[0];

330 
weight
[
˛i°
][
n
][0] = 
cur_weight
;

331 
off£t
[
˛i°
][
n
][0] = 
cur_off£t
;

333 i‡(
p_I≈
->
ChromaWeightSuµ‹t
 == 1)

335 
off£t
[
˛i°
][
n
][1] = (Ë((
dc_‹g_UV
[0] - 
dc_ªf_UV
[n][0])/(
p_Vid
->
size_¸
)+0.5);

336 
off£t
[
˛i°
][
n
][1] = (off£t[˛i°][n][1] + ((
p_Vid
->
bôdïth_chroma
 - 8)>>1))>>(p_Vid->bitdepth_chroma-8);

337 
off£t
[
˛i°
][
n
][1] = 
	`sClù3
( -128, 127, offset[clist][n][1]);

338 
off£t
[
˛i°
][
n
][1] = off£t[˛i°][n][1]<<(
p_Vid
->
bôdïth_chroma
 - 8);

340 
weight
[
˛i°
][
n
][1] = 
deÁu…_weight
[1];

342 
off£t
[
˛i°
][
n
][2] = (Ë((
dc_‹g_UV
[1] - 
dc_ªf_UV
[n][1])/(
p_Vid
->
size_¸
)+0.5);

343 
off£t
[
˛i°
][
n
][2] = (off£t[˛i°][n][2] + ((
p_Vid
->
bôdïth_chroma
 - 8)>>1))>>(p_Vid->bitdepth_chroma-8);

344 
off£t
[
˛i°
][
n
][2] = 
	`sClù3
( -128, 127, offset[clist][n][2]);

345 
off£t
[
˛i°
][
n
][2] = off£t[˛i°][n][2]<<(
p_Vid
->
bôdïth_chroma
 - 8);

347 
weight
[
˛i°
][
n
][2] = 
deÁu…_weight
[2];

351 
i
=0; i < 3; i ++)

353 
cuºSli˚
->
wp_weight
[
˛i°
][
n
][
i
] = 
weight
[clist][n][i];

354 
cuºSli˚
->
wp_off£t
[
˛i°
][
n
][
i
] = 
off£t
[clist][n][i];

355 #i‡
DEBUG_WP


356 
	`¥ötf
("ödex %d comp⁄íà%d weighà%d off£à%d\n",
n
,
i
,
weight
[0][n][i],
off£t
[0][n][i]);

362 
	}
}

370 
	$E°im©eWPBSli˚Alg0
(
Sli˚
 *
cuºSli˚
)

372 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

373 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºSli˚
->p_Inp;

374 
i
, 
j
, 
k
, 
n
;

376 
ödex
;

377 
comp
;

378 
dc_‹g
 = 0.0;

379 
dc_‹g_UV
[2] = { 0.0 };

380 
dc_ªf
[6][
MAX_REFERENCE_PICTURES
] = { {0.0} };

381 
dc_ªf_UV
[6][
MAX_REFERENCE_PICTURES
][2] = { {{0.0}} };

383 
deÁu…_weight
[3];

384 
li°_off£t
 = ((
cuºSli˚
->
mb_aff_‰ame_Êag
)&&(
p_Vid
->
mb_d©a
[p_Vid->
cuºít_mb_ƒ
].
mb_fõld
))? (p_Vid->current_mb_nr & 0x01) ? 4 : 2 : 0;

385 
weight
[6][
MAX_REFERENCE_PICTURES
][3];

386 
off£t
[6][
MAX_REFERENCE_PICTURES
][3];

387 
im_weight
[6][
MAX_REFERENCE_PICTURES
][MAX_REFERENCE_PICTURES][3];

388 
˛i°
;

389 
wf_weight
, 
wf_off£t
;

390 
img≥l
 **
tmpPå
;

392 i‡(
p_Vid
->
a˘ive_µs
->
weighãd_bùªd_idc
 == 2)

394 
cuºSli˚
->
luma_log_weight_díom
 = 5;

395 
cuºSli˚
->
chroma_log_weight_díom
 = 5;

399 
cuºSli˚
->
luma_log_weight_díom
 = 5;

400 
cuºSli˚
->
chroma_log_weight_díom
 = 5;

403 
cuºSli˚
->
wp_luma_round
 = 1 << (cuºSli˚->
luma_log_weight_díom
 - 1);

404 
cuºSli˚
->
wp_chroma_round
 = 1 << (cuºSli˚->
chroma_log_weight_díom
 - 1);

405 
deÁu…_weight
[0] = 1 << 
cuºSli˚
->
luma_log_weight_díom
;

406 
deÁu…_weight
[1] = 1 << 
cuºSli˚
->
chroma_log_weight_díom
;

407 
deÁu…_weight
[2] = 1 << 
cuºSli˚
->
chroma_log_weight_díom
;

409 i‡(
p_Vid
->
a˘ive_µs
->
weighãd_bùªd_idc
 == 2)

411 
	`CompuãIm∂icôWeights
(
cuºSli˚
, 
deÁu…_weight
, 
im_weight
);

413 
k
 = 0; k < 2; k++)

415 
i
 = 0; i < 
cuºSli˚
->
li°Xsize
[
LIST_0
]; i++)

417 
j
 = 0; j < 
cuºSli˚
->
li°Xsize
[
LIST_1
]; j++)

419 
comp
 = 0; comp < 3; comp++)

421 
cuºSli˚
->
wbp_weight
[
k
][
i
][
j
][
comp
] = 
im_weight
[k][i][j][comp];

427 
˛i°
=0; cli°<2 + 
li°_off£t
; clist++)

429 
ödex
 = 0; index < 
cuºSli˚
->
li°Xsize
[
˛i°
]; index++)

431 
comp
 = 0; comp < 3; comp++)

433 
cuºSli˚
->
wp_weight
[
˛i°
][
ödex
][
comp
] = 
deÁu…_weight
[comp];

434 
cuºSli˚
->
wp_off£t
[
˛i°
][
ödex
][
comp
] = 0;

441 
dc_‹g
 = 
	`CompuãImgSum
(
p_Vid
->
pCurImg
,Ö_Vid->
height
,Ö_Vid->
width
);

443 i‡(
p_I≈
->
ChromaWeightSuµ‹t
 == 1)

445 
k
 = 0; k < 2; k++)

447 
dc_‹g_UV
[
k
] = 
	`CompuãImgSum
(
p_Vid
->
pImgOrg
[k + 1],Ö_Vid->
height_¸
,Ö_Vid->
width_¸
);

451 
˛i°
=0; cli°<2 + 
li°_off£t
; clist++)

453 
n
 = 0;Ç < 
cuºSli˚
->
li°Xsize
[
˛i°
];Ç++)

455 i‡–
	`wpxDëîmöeWP
–
cuºSli˚
, 
˛i°
, 
n
 ) )

458 
i
 = 0; i < 3; i++)

460 
cuºSli˚
->
wp_weight
[
˛i°
][
n
][
i
] = 
deÁu…_weight
[i];

461 
cuºSli˚
->
wp_off£t
[
˛i°
][
n
][
i
] = 0;

462 
off£t
 [
˛i°
][
n
][
i
] = 0;

463 
weight
 [
˛i°
][
n
][
i
] = 
deÁu…_weight
[i];

468 
tmpPå
 = 
cuºSli˚
->
li°X
[
˛i°
][
n
]->
p_cuº_img
;

469 
dc_ªf
[
˛i°
][
n
] = 
	`CompuãImgSum
(
tmpPå
, 
p_Vid
->
height
,Ö_Vid->
width
);

471 i‡(
dc_ªf
[
˛i°
][
n
] != 0.0)

472 
wf_weight
 = (Ë(
deÁu…_weight
[0] * 
dc_‹g
 / 
dc_ªf
[
˛i°
][
n
] + 0.5);

474 
wf_weight
 = 
deÁu…_weight
[0];

475 
wf_weight
 = 
	`sClù3
(-128, 127, wf_weight);

476 
wf_off£t
 = 0;

480 
weight
[
˛i°
][
n
][0] = 
wf_weight
;

481 
off£t
[
˛i°
][
n
][0] = 
wf_off£t
;

484 i‡(
p_I≈
->
ChromaWeightSuµ‹t
 == 1)

486 
k
 = 0; k < 2; k++)

488 
tmpPå
 = 
cuºSli˚
->
li°X
[
˛i°
][
n
]->
imgUV
[
k
];

489 
dc_ªf_UV
[
˛i°
][
n
][
k
] = 
	`CompuãImgSum
(
tmpPå
, 
p_Vid
->
height_¸
,Ö_Vid->
width_¸
);

491 i‡(
dc_ªf_UV
[
˛i°
][
n
][
k
] != 0.0)

492 
wf_weight
 = (Ë(
deÁu…_weight
[
k
 + 1] * 
dc_‹g_UV
[k] / 
dc_ªf_UV
[
˛i°
][
n
][k] + 0.5);

494 
wf_weight
 = 
deÁu…_weight
[
k
 + 1];

495 
wf_weight
 = 
	`sClù3
(-128, 127, wf_weight);

496 
wf_off£t
 = 0;

498 
weight
[
˛i°
][
n
][
k
 + 1] = 
wf_weight
;

499 
off£t
[
˛i°
][
n
][
k
 + 1] = 
wf_off£t
;

504 
weight
[
˛i°
][
n
][1] = 
deÁu…_weight
[1];

505 
weight
[
˛i°
][
n
][2] = 
deÁu…_weight
[2];

506 
off£t
[
˛i°
][
n
][1] = 0;

507 
off£t
[
˛i°
][
n
][2] = 0;

510 
i
 = 0; i < 3; i++)

512 
cuºSli˚
->
wp_weight
[
˛i°
][
n
][
i
] = 
weight
[clist][n][i];

513 
cuºSli˚
->
wp_off£t
[
˛i°
][
n
][
i
] = 
off£t
[clist][n][i];

514 #i‡
DEBUG_WP


515 
	`¥ötf
("%d %d\n",
cuºSli˚
->
wp_weight
[
˛i°
][
ödex
][
comp
],cuºSli˚->
wp_off£t
[clist][index][comp]);

522 i‡(
p_Vid
->
a˘ive_µs
->
weighãd_bùªd_idc
 != 1)

524 
˛i°
=0; cli°<2 + 
li°_off£t
; clist++)

526 
ödex
 = 0; index < 
cuºSli˚
->
li°Xsize
[
˛i°
]; index++)

528 
	`mem˝y
(
cuºSli˚
->
wp_weight
[
˛i°
][
ödex
], 
deÁu…_weight
, 3 * ());

529 
	`mem£t
(
cuºSli˚
->
wp_off£t
[
˛i°
][
ödex
], 0, 3 * ());

535 
i
 = 0; i < 
cuºSli˚
->
li°Xsize
[
LIST_0
]; i++)

537 
j
 = 0; j < 
cuºSli˚
->
li°Xsize
[
LIST_1
]; j++)

539 
comp
 = 0; comp < 3; comp++)

541 
cuºSli˚
->
wbp_weight
[0][
i
][
j
][
comp
] = cuºSli˚->
wp_weight
[0][i][comp];

542 
cuºSli˚
->
wbp_weight
[1][
i
][
j
][
comp
] = cuºSli˚->
wp_weight
[1][j][comp];

544 #i‡
DEBUG_WP


545 
	`¥ötf
 ("bpw weight[%d][%d] = %d , %d (%d %d %dË(%d %dË(%d %d)\n", 
i
, 
j
, 
cuºSli˚
->
wbp_weight
[0][i][j][0], currSlice->wbp_weight[1][i][j][0],

546 
p_Vid
->
íc_pi˘uª
->
poc
,
cuºSli˚
->
li°X
[
LIST_0
][
i
]->poc, cuºSli˚->li°X[
LIST_1
][
j
]->poc,

547 
Di°SˇÀFa˘‹
 ,
tx
,tx,tx);

552 
	}
}

562 
	$Te°WPPSli˚Alg0
(
Sli˚
 *
cuºSli˚
, 
£À˘_off£t
)

564 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

565 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

566 
i
, 
j
, 
k
, 
n
;

568 
ödex
;

569 
comp
;

570 
dc_‹g
 = 0.0;

571 
dc_‹g_UV
[2] = {0.0};

572 
dc_ªf
[
MAX_REFERENCE_PICTURES
] = { 0.0 };

573 
dc_ªf_UV
[
MAX_REFERENCE_PICTURES
][2] = { {0.0}};

575 
deÁu…_weight
[3];

577 
li°_off£t
 = ((
p_Vid
->
mb_aff_‰ame_Êag
)&&’_Vid->
mb_d©a
[p_Vid->
cuºít_mb_ƒ
].
mb_fõld
))? (p_Vid->current_mb_nr & 0x01) ? 4 : 2 : 0;

578 
weight
[2][
MAX_REFERENCE_PICTURES
][3];

579 
off£t
[2][
MAX_REFERENCE_PICTURES
][3];

582 
˛i°
;

583 
≥rf‹m_wp
 = 0;

584 
img≥l
 **
tmpPå
;

586 
luma_log_weight_díom
 = 5;

587 
chroma_log_weight_díom
 = 5;

589 
deÁu…_weight
[0] = 1 << 
luma_log_weight_díom
;

590 
deÁu…_weight
[1] = deÁu…_weight[2] = 1 << 
chroma_log_weight_díom
;

593 
i
 = 0; i < 2 + 
li°_off£t
; i++)

595 
j
 = 0; j < 
cuºSli˚
->
li°Xsize
[
i
]; j++)

597 
n
 = 0;Ç < 3;Ç++)

599 
weight
[
i
][
j
][
n
] = 
deÁu…_weight
[n];

602 
off£t
[
i
][
j
][
n
] = 0;

607 
dc_‹g
 = 
	`CompuãImgSum
(
p_Vid
->
pCurImg
,Ö_Vid->
height
,Ö_Vid->
width
);

609 i‡(
p_I≈
->
ChromaWeightSuµ‹t
 == 1)

611 
k
 = 0; k < 2; k++)

613 
dc_‹g_UV
[
k
] = 
	`CompuãImgSum
(
p_Vid
->
pImgOrg
[k + 1],Ö_Vid->
height_¸
,Ö_Vid->
width_¸
);

617 
˛i°
 = 0; cli° < 2 + 
li°_off£t
; clist++)

619 
n
 = 0;Ç < 
cuºSli˚
->
li°Xsize
[
˛i°
];Ç++)

621 
tmpPå
 = 
cuºSli˚
->
li°X
[
˛i°
][
n
]->
p_cuº_img
;

622 
dc_ªf
[
n
] = 
	`CompuãImgSum
(
tmpPå
, 
p_Vid
->
height
,Ö_Vid->
width
);

624 i‡(
p_I≈
->
ChromaWeightSuµ‹t
 == 1)

626 
k
 = 0; k < 2; k++)

628 
tmpPå
 = 
cuºSli˚
->
li°X
[
˛i°
][
n
]->
imgUV
[
k
];

629 
dc_ªf_UV
[
n
][
k
] = 
	`CompuãImgSum
(
tmpPå
, 
p_Vid
->
height_¸
,Ö_Vid->
width_¸
);

633 i‡(
£À˘_off£t
 == 0)

635 i‡(
dc_ªf
[
n
] != 0.0)

636 
weight
[
˛i°
][
n
][0] = (Ë(
deÁu…_weight
[0] * 
dc_‹g
 / 
dc_ªf
[n] + 0.5);

638 
weight
[
˛i°
][
n
][0] = 
deÁu…_weight
[0];

639 
weight
[
˛i°
][
n
][0] = 
	`sClù3
(-128, 127, weight[clist][n][0]);

641 i‡(
p_I≈
->
ChromaWeightSuµ‹t
 == 1)

643 i‡(
dc_ªf_UV
[
n
][0] != 0)

644 
weight
[
˛i°
][
n
][1] = (Ë(
deÁu…_weight
[1] * 
dc_‹g_UV
[0] / 
dc_ªf_UV
[n][0] + 0.5);

646 
weight
[
˛i°
][
n
][1] = 
deÁu…_weight
[1];

647 
weight
[
˛i°
][
n
][1] = 
	`sClù3
(-128, 127, weight[clist][n][1]);

649 i‡(
dc_ªf_UV
[
n
][1] != 0)

650 
weight
[
˛i°
][
n
][2] = (Ë(
deÁu…_weight
[2] * 
dc_‹g_UV
[1] / 
dc_ªf_UV
[n][1] + 0.5);

652 
weight
[
˛i°
][
n
][2] = 
deÁu…_weight
[2];

653 
weight
[
˛i°
][
n
][2] = 
	`sClù3
(-128, 127, weight[clist][n][2]);

658 
off£t
[
˛i°
][
n
][0] = (Ë((
dc_‹g
 - 
dc_ªf
[n])/(
p_Vid
->
size
)+0.5);

659 
off£t
[
˛i°
][
n
][0] = (off£t[˛i°][n][0]+((
p_Vid
->
bôdïth_luma
-8)>>1))>>(p_Vid->bitdepth_luma-8);

660 
off£t
[
˛i°
][
n
][0] = 
	`sClù3
( -128, 127, offset[clist][n][0]);

661 
off£t
[
˛i°
][
n
][0] = off£t[˛i°][n][0]<<(
p_Vid
->
bôdïth_luma
-8);

662 
weight
[
˛i°
][
n
][0] = 
deÁu…_weight
[0];

664 i‡(
p_I≈
->
ChromaWeightSuµ‹t
 == 1)

666 
off£t
[
˛i°
][
n
][1] = (Ë((
dc_‹g_UV
[0] - 
dc_ªf_UV
[n][0])/(
p_Vid
->
size_¸
)+0.5);

667 
off£t
[
˛i°
][
n
][1] = (off£t[˛i°][n][1] + ((
p_Vid
->
bôdïth_chroma
 - 8)>>1))>>(p_Vid->bitdepth_chroma-8);

668 
off£t
[
˛i°
][
n
][1] = 
	`sClù3
( -128, 127, offset[clist][n][1]);

669 
off£t
[
˛i°
][
n
][1] = off£t[˛i°][n][1]<<(
p_Vid
->
bôdïth_chroma
 - 8);

671 
weight
[
˛i°
][
n
][1] = 
deÁu…_weight
[1];

673 
off£t
[
˛i°
][
n
][2] = (Ë((
dc_‹g_UV
[1] - 
dc_ªf_UV
[n][1])/(
p_Vid
->
size_¸
)+0.5);

674 
off£t
[
˛i°
][
n
][2] = (off£t[˛i°][n][2] + ((
p_Vid
->
bôdïth_chroma
 - 8)>>1))>>(p_Vid->bitdepth_chroma-8);

675 
off£t
[
˛i°
][
n
][2] = 
	`sClù3
( -128, 127, offset[clist][n][2]);

676 
off£t
[
˛i°
][
n
][2] = off£t[˛i°][n][2]<<(
p_Vid
->
bôdïth_chroma
 - 8);

678 
weight
[
˛i°
][
n
][2] = 
deÁu…_weight
[2];

684 
˛i°
=0; cli°<2 + 
li°_off£t
; clist++)

686 
ödex
 = 0; index < 
cuºSli˚
->
li°Xsize
[
˛i°
]; index++)

688 
comp
=0; comp < 3; comp ++)

690 
off£t_ã°
 = 
p_I≈
->
RDPSli˚BTe°
 && 
p_Vid
->
a˘ive_•s
->
¥ofûe_idc
 !
BASELINE


691 ? 
	`übs
(
off£t
[
˛i°
][
ödex
][
comp
]) > 2

692 : 
off£t
[
˛i°
][
ödex
][
comp
] != 0;

694 i‡(
weight
[
˛i°
][
ödex
][
comp
] !
deÁu…_weight
[0] || 
off£t_ã°
)

696 
≥rf‹m_wp
 = 1;

700 i‡(
≥rf‹m_wp
 == 1) ;

702 i‡(
≥rf‹m_wp
 == 1) ;

705  
≥rf‹m_wp
;

706 
	}
}

715 
	$Te°WPBSli˚Alg0
(
Sli˚
 *
cuºSli˚
, 
£À˘_mëhod
)

717 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

718 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

719 
i
, 
j
, 
k
, 
n
;

720 #i‡(
MVC_EXTENSION_ENABLE
)

721 
võw_id
 = 
p_Vid
->view_id;

723 
võw_id
 = 0;

726 
ödex
;

727 
comp
;

728 
dc_‹g
 = 0.0;

729 
dc_‹g_UV
[2] = { 0.0 };

730 
dc_ªf
[6][
MAX_REFERENCE_PICTURES
] = { {0.0} };

731 
dc_ªf_UV
[6][
MAX_REFERENCE_PICTURES
][2] = { {{0.0}} };

733 
deÁu…_weight
[3];

735 
li°_off£t
 = ((
p_Vid
->
mb_aff_‰ame_Êag
)&&’_Vid->
mb_d©a
[p_Vid->
cuºít_mb_ƒ
].
mb_fõld
))? (p_Vid->current_mb_nr & 0x01) ? 4 : 2 : 0;

736 
weight
[6][
MAX_REFERENCE_PICTURES
][3];

737 
off£t
[6][
MAX_REFERENCE_PICTURES
][3];

738 
im_weight
[6][
MAX_REFERENCE_PICTURES
][MAX_REFERENCE_PICTURES][3];

739 
wp_weight
[6][
MAX_REFERENCE_PICTURES
][3];

740 
wp_off£t
[6][
MAX_REFERENCE_PICTURES
][3];

743 
˛i°
;

744 
wf_weight
, 
wf_off£t
;

745 
≥rf‹m_wp
 = 1;

746 
img≥l
 **
tmpPå
;

748 
luma_log_weight_díom
 = 5;

749 
chroma_log_weight_díom
 = 5;

751 
deÁu…_weight
[0] = 1 << 
luma_log_weight_díom
;

752 
deÁu…_weight
[1] = 1 << 
chroma_log_weight_díom
;

753 
deÁu…_weight
[2] = 1 << 
chroma_log_weight_díom
;

756 
i
 = 0; i < 2 + 
li°_off£t
; i++)

758 
j
 = 0; j < 
cuºSli˚
->
li°Xsize
[
i
]; j++)

760 
n
 = 0;Ç < 3;Ç++)

762 
wp_weight
[
i
][
j
][
n
] = 
deÁu…_weight
[n];

763 
wp_off£t
[
i
][
j
][
n
] = 0;

764 
weight
 [
i
][
j
][
n
] = 
deÁu…_weight
[n];

765 
off£t
 [
i
][
j
][
n
] = 0;

770 i‡(
£À˘_mëhod
 == 1)

772 
	`CompuãIm∂icôWeights
(
cuºSli˚
, 
deÁu…_weight
, 
im_weight
);

774 
≥rf‹m_wp
 = 0;

775 
i
 = 0; i < 
cuºSli˚
->
li°Xsize
[
LIST_0
]; i++)

777 
j
 = 0; j < 
cuºSli˚
->
li°Xsize
[
LIST_1
]; j++)

779 i‡(
im_weight
[1][
i
][
j
][0] !
deÁu…_weight
[0] || im_weight[1][i][j][0] != default_weight[0])

781 
≥rf‹m_wp
 = 1;

785 i‡(
≥rf‹m_wp
 == 1) ;

790 
dc_‹g
 = 
	`CompuãImgSum
(
p_Vid
->
pCurImg
,Ö_Vid->
height
,Ö_Vid->
width
);

792 i‡(
p_I≈
->
ChromaWeightSuµ‹t
 == 1)

794 
k
 = 0; k < 2; k++)

796 
dc_‹g_UV
[
k
] = 
	`CompuãImgSum
(
p_Vid
->
pImgOrg
[k + 1],Ö_Vid->
height_¸
,Ö_Vid->
width_¸
);

800 
˛i°
=0; cli°<2 + 
li°_off£t
; clist++)

802 
n
 = 0;Ç < 
cuºSli˚
->
li°Xsize
[
˛i°
];Ç++)

807 
tmpPå
 = 
cuºSli˚
->
li°X
[
˛i°
][
n
]->
p_cuº_img
;

808 
dc_ªf
[
˛i°
][
n
] = 
	`CompuãImgSum
(
tmpPå
, 
p_Vid
->
height
,Ö_Vid->
width
);

810 i‡(
dc_ªf
[
˛i°
][
n
] != 0.0)

811 
wf_weight
 = (Ë(
deÁu…_weight
[0] * 
dc_‹g
 / 
dc_ªf
[
˛i°
][
n
] + 0.5);

813 
wf_weight
 = 
deÁu…_weight
[0];

814 
wf_weight
 = 
	`sClù3
(-128, 127, wf_weight);

815 
wf_off£t
 = 0;

817 
weight
[
˛i°
][
n
][0] = 
wf_weight
;

818 
off£t
[
˛i°
][
n
][0] = 
wf_off£t
;

821 i‡(
p_I≈
->
ChromaWeightSuµ‹t
 == 1)

823 
k
 = 0; k < 2; k++)

825 
tmpPå
 = 
cuºSli˚
->
li°X
[
˛i°
][
n
]->
imgUV
[
k
];

826 
dc_ªf_UV
[
˛i°
][
n
][
k
] = 
	`CompuãImgSum
(
tmpPå
, 
p_Vid
->
height_¸
,Ö_Vid->
width_¸
);

828 i‡(
dc_ªf_UV
[
˛i°
][
n
][
k
] != 0.0)

829 
wf_weight
 = (Ë(
deÁu…_weight
[
k
 + 1] * 
dc_‹g_UV
[k] / 
dc_ªf_UV
[
˛i°
][
n
][k] + 0.5);

831 
wf_weight
 = 
deÁu…_weight
[
k
 + 1];

832 
wf_weight
 = 
	`sClù3
(-128, 127, wf_weight);

833 
wf_off£t
 = 0;

835 
weight
[
˛i°
][
n
][
k
 + 1] = 
wf_weight
;

836 
off£t
[
˛i°
][
n
][
k
 + 1] = 
wf_off£t
;

841 
weight
[
˛i°
][
n
][1] = 
deÁu…_weight
[1];

842 
weight
[
˛i°
][
n
][2] = 
deÁu…_weight
[2];

843 
off£t
[
˛i°
][
n
][1] = 0;

844 
off£t
[
˛i°
][
n
][2] = 0;

849 i‡(
£À˘_mëhod
 == 0)

851 
˛i°
=0; cli°<2 + 
li°_off£t
; clist++)

853 
ödex
 = 0; index < 
cuºSli˚
->
li°Xsize
[
˛i°
]; index++)

855 
	`mem˝y
(
p_Vid
->
cuºítSli˚
->
wp_weight
[
˛i°
][
ödex
], 
weight
[clist][index], 3 * ());

856 
	`mem˝y
(
p_Vid
->
cuºítSli˚
->
wp_off£t
[
˛i°
][
ödex
], 
off£t
[clist][index], 3 * ());

862 
˛i°
=0; cli°<2 + 
li°_off£t
; clist++)

864 
ödex
 = 0; index < 
cuºSli˚
->
li°Xsize
[
˛i°
]; index++)

866 
	`mem˝y
(
wp_weight
[
˛i°
][
ödex
], 
deÁu…_weight
, 3 * ());

867 
	`mem£t
(
wp_off£t
[
˛i°
][
ödex
], 0, 3 * ());

873 i‡(
£À˘_mëhod
 == 0)

875 
a˘ive_ªfs
[2];

877 
a˘ive_ªfs
[0] = (
p_I≈
->
B_Li°0_ªfs
 =0 ? 
cuºSli˚
->
li°Xsize
[0] : 
	`imö
’_I≈->B_Li°0_ªfs[
võw_id
], currSlice->listXsize[0]));

878 
a˘ive_ªfs
[1] = (
p_I≈
->
B_Li°1_ªfs
 =0 ? 
cuºSli˚
->
li°Xsize
[1] : 
	`imö
’_I≈->B_Li°1_ªfs[
võw_id
], currSlice->listXsize[1]));

880 
≥rf‹m_wp
 = 0;

881 
˛i°
=0; cli°<2 + 
li°_off£t
; clist++)

883 
ödex
 = 0; index < 
a˘ive_ªfs
[
˛i°
]; index++)

885 
comp
=0; comp < 3; comp ++)

887 i‡(
wp_weight
[
˛i°
][
ödex
][
comp
] !
deÁu…_weight
[comp])

889 
≥rf‹m_wp
 = 1;

893 i‡(
≥rf‹m_wp
 == 1) ;

895 i‡(
≥rf‹m_wp
 == 1) ;

898  
≥rf‹m_wp
;

899 
	}
}

	@lencod/src/wp_lms.c

16 
	~"c⁄åibut‹s.h
"

18 
	~"globÆ.h
"

19 
	~"image.h
"

20 
	~"wp_lms.h
"

21 
	~"wp.h
"

24 
	$CompuãBlockN‹mMón
(
img≥l
 **
CuºítImage
,

25 
height_ö_blk
, 
width_ö_blk
,

26 
blk_size_y
, 
blk_size_x
,

27 
cur_blk
, 
dc_món
)

29 
blkx
, 
blky
;

30 
x
, 
y
;

31 
sum
 = 0.;

32 
img≥l
 *
img_±r
;

34 
blkx
 = 
cur_blk
 % 
width_ö_blk
;

35 
blky
 = 
cur_blk
 / 
width_ö_blk
;

37 
y
 = 0; y < 
blk_size_y
; y++)

39 
img_±r
 = &
CuºítImage
[
blky
*
blk_size_y
+
y
][
blkx
*
blk_size_x
];

40 
x
 = 0; x < 
blk_size_x
; x++)

42 
sum
 +
	`dabs
(()
img_±r
[
x
]-
dc_món
);

46  
sum
;

47 
	}
}

49 
	$CompuãN‹mMónBlockBa£d
(
img≥l
 **
CuºítImage
, 
height_ö_blk
, 
width_ö_blk
,

50 
blk_size_y
, 
blk_size_x
,

51 
°¨t_blk
, 
íd_blk
,

52 
dc_món
, *
n‹m_¶i˚
)

54 
cur_blk
;

55 
block_n‹m
;

56 
n‹m
;

59 
n‹m
 = 0.;

60 
cur_blk
 = 
°¨t_blk
; cur_blk < 
íd_blk
; cur_blk++)

62 
block_n‹m
 = 
	`CompuãBlockN‹mMón
(
CuºítImage
, 
height_ö_blk
, 
width_ö_blk
, 
blk_size_y
, 
blk_size_x
, 
cur_blk
, 
dc_món
);

63 
n‹m
 +
block_n‹m
;

65 (*
n‹m_¶i˚
Ë(Ë
n‹m
;

67 
	}
}

69 
	$CompuãEx∂icôWPP¨amsLMS
(
Sli˚
 *
cuºSli˚
,

70 
£À˘_off£t
,

71 
°¨t_mb
,

72 
íd_mb
,

73 
deÁu…_weight
[3],

74 
weight
[6][
MAX_REFERENCE_PICTURES
][3],

75 
off£t
[6][
MAX_REFERENCE_PICTURES
][3])

77 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

78 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

79 
˛i°
, 
n
, 
k
, 
comp
;

80 
¶i˚_size
, 
¶i˚_size_¸
;

82 
dc_‹g
[3];

83 
dc_ªf
[3];

84 
n‹m_‹g
[3];

85 
n‹m_ªf
[3];

86 
numî
[3];

87 
díom
[3];

88 
cur_weight
, 
cur_off£t
;

89 
bô_dïth
 = (
p_Vid
->
bôdïth_luma
 - 8);

91 
img≥l
 **
cur_ªf
;

93 
˛i°
=0; clist< 2; clist++)

95 
n
 = 0;Ç < 
cuºSli˚
->
li°Xsize
[
˛i°
];Ç++)

97 
comp
 = 0; comp < 3; comp++)

99 
weight
[
˛i°
][
n
][
comp
] = 
deÁu…_weight
[comp];

100 
off£t
[
˛i°
][
n
][
comp
] = 0;

105 
¶i˚_size
 = (
íd_mb
-
°¨t_mb
)*
MB_BLOCK_SIZE
*MB_BLOCK_SIZE;

106 
¶i˚_size_¸
 = (
íd_mb
-
°¨t_mb
)*
p_Vid
->
mb_¸_size_x
*p_Vid->
mb_¸_size_y
;

108 
	`CompuãImgSumBlockBa£d
(
p_Vid
->
pCurImg
,Ö_Vid->
FømeHeightInMbs
,Ö_Vid->
PicWidthInMbs
, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE,

109 
°¨t_mb
, 
íd_mb
, &
dc_‹g
[0]);

111 
n‹m_‹g
[0] = 
dc_‹g
[0]/((Ë
¶i˚_size
);

112 
	`CompuãN‹mMónBlockBa£d
(
p_Vid
->
pCurImg
,Ö_Vid->
FømeHeightInMbs
,Ö_Vid->
PicWidthInMbs
, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE,

113 
°¨t_mb
, 
íd_mb
, 
n‹m_‹g
[0], &
numî
[0]);

115 i‡(
p_I≈
->
ChromaWeightSuµ‹t
 == 1)

117 
k
 = 0; k < 2; k++)

119 
	`CompuãImgSumBlockBa£d
(
p_Vid
->
pImgOrg
[
k
 + 1],Ö_Vid->
FømeHeightInMbs
,Ö_Vid->
PicWidthInMbs
,Ö_Vid->
mb_¸_size_y
,Ö_Vid->
mb_¸_size_x
,

120 
°¨t_mb
, 
íd_mb
, &
dc_‹g
[
k
+1]);

124 
˛i°
 = 0; clist < 2; clist++)

126 
n
 = 0;Ç < 
cuºSli˚
->
li°Xsize
[
˛i°
];Ç++)

128 
cur_ªf
 = 
cuºSli˚
->
li°X
[
˛i°
][
n
]->
p_cuº_img
;

129 
	`CompuãImgSumBlockBa£d
(
cur_ªf
, 
p_Vid
->
FømeHeightInMbs
,Ö_Vid->
PicWidthInMbs
, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE,

130 
°¨t_mb
, 
íd_mb
, &
dc_ªf
[0]);

131 
n‹m_ªf
[0] = 
dc_ªf
[0] / ((Ë
¶i˚_size
);

132 
	`CompuãN‹mMónBlockBa£d
(
cur_ªf
, 
p_Vid
->
FømeHeightInMbs
,Ö_Vid->
PicWidthInMbs
, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE,

133 
°¨t_mb
, 
íd_mb
, 
n‹m_ªf
[0], &
díom
[0]);

135 i‡(
p_I≈
->
ChromaWeightSuµ‹t
 == 1)

137 
k
 = 0; k < 2; k++)

139 
cur_ªf
 = 
cuºSli˚
->
li°X
[
˛i°
][
n
]->
imgUV
[
k
];

140 
	`CompuãImgSumBlockBa£d
(
cur_ªf
, 
p_Vid
->
FømeHeightInMbs
,Ö_Vid->
PicWidthInMbs
,Ö_Vid->
mb_¸_size_y
,Ö_Vid->
mb_¸_size_x
,

141 
°¨t_mb
, 
íd_mb
, &
dc_ªf
[
k
+1]);

145 i‡(
£À˘_off£t
 == 0)

147 i‡(
díom
[0] != 0)

148 
cur_weight
 = (Ë(
deÁu…_weight
[0] * 
numî
[0] / 
díom
[0] + 0.5);

150 
cur_weight
 = 
deÁu…_weight
[0];

151 
cur_weight
 = 
	`sClù3
(-128, 127, cur_weight);

153 
cur_off£t
 = (Ë(
n‹m_‹g
[0] - ((Ë
cur_weight
 * 
n‹m_ªf
[0] / (Ë
deÁu…_weight
[0]) + 0.5);

154 
cur_off£t
 = (Ë((cur_off£à+ (
bô_dïth
>>1)) >> bit_depth);

155 
cur_off£t
 = 
	`sClù3
( -128, 127, cur_offset);

156 
cur_off£t
 = (Ë(cur_off£à<< 
bô_dïth
);

157 
weight
[
˛i°
][
n
][0] = 
cur_weight
;

158 
off£t
[
˛i°
][
n
][0] = 
cur_off£t
;

160 i‡(
p_I≈
->
ChromaWeightSuµ‹t
 == 1)

162 i‡(
dc_ªf
[1] != 0)

163 
cur_weight
 = (Ë(
deÁu…_weight
[1] * 
dc_‹g
[1] / 
dc_ªf
[1] + 0.5);

165 
cur_weight
 = 
deÁu…_weight
[1];

166 
weight
[
˛i°
][
n
][1] = 
	`sClù3
(-128, 127, 
cur_weight
);

168 i‡(
dc_ªf
[2] != 0)

169 
cur_weight
 = (Ë(
deÁu…_weight
[2] * 
dc_‹g
[2] / 
dc_ªf
[2] + 0.5);

171 
cur_weight
 = 
deÁu…_weight
[2];

172 
weight
[
˛i°
][
n
][2] = 
	`sClù3
(-128, 127, 
cur_weight
);

177 
cur_off£t
 = (Ë((
dc_‹g
[0] - 
dc_ªf
[0])/(
¶i˚_size
)+0.5);

178 
cur_off£t
 = (cur_off£t+((
p_Vid
->
bôdïth_luma
-8)>>1))>>(p_Vid->bitdepth_luma-8);

179 
cur_off£t
 = 
	`sClù3
( -128, 127, cur_offset);

180 
cur_off£t
 = cur_off£t<<(
p_Vid
->
bôdïth_luma
-8);

181 
cur_weight
 = 
deÁu…_weight
[0];

183 
weight
[
˛i°
][
n
][0] = 
cur_weight
;

184 
off£t
[
˛i°
][
n
][0] = 
cur_off£t
;

186 i‡(
p_I≈
->
ChromaWeightSuµ‹t
 == 1)

188 
cur_off£t
 = (Ë((
dc_‹g
[1] - 
dc_ªf
[1])/(
¶i˚_size_¸
)+0.5);

189 
cur_off£t
 = (cur_off£à+ ((
p_Vid
->
bôdïth_chroma
 - 8)>>1))>>(p_Vid->bitdepth_chroma-8);

190 
cur_off£t
 = 
	`sClù3
( -128, 127, cur_offset);

191 
off£t
[
˛i°
][
n
][1] = 
cur_off£t
<<(
p_Vid
->
bôdïth_chroma
 - 8);

193 
weight
[
˛i°
][
n
][1] = 
deÁu…_weight
[1];

195 
cur_off£t
 = (Ë((
dc_‹g
[2] - 
dc_ªf
[2])/(
¶i˚_size_¸
)+0.5);

196 
cur_off£t
 = (cur_off£à+ ((
p_Vid
->
bôdïth_chroma
 - 8)>>1))>>(p_Vid->bitdepth_chroma-8);

197 
cur_off£t
 = 
	`sClù3
( -128, 127, cur_offset);

198 
off£t
[
˛i°
][
n
][2] = 
cur_off£t
<<(
p_Vid
->
bôdïth_chroma
 - 8);

200 
weight
[
˛i°
][
n
][2] = 
deÁu…_weight
[2];

205 
	}
}

208 
	$CompuãEx∂icôWPP¨amsJNT
(
Sli˚
 *
cuºSli˚
,

209 
°¨t_mb
,

210 
íd_mb
,

211 
deÁu…_weight
[3],

212 
weight
[6][
MAX_REFERENCE_PICTURES
][3],

213 
off£t
[6][
MAX_REFERENCE_PICTURES
][3])

215 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

216 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

217 
˛i°
, 
n
, 
k
, 
comp
;

220 
öt64
 
dc_‹g
[3];

221 
öt64
 
dc_cur_ªf
[2][
MAX_REFERENCE_PICTURES
][3];

222 
w0
 = 
deÁu…_weight
[0], 
w1
 = default_weight[0];

224 
img≥l
 **
cur_ªf
;

226 
˛i°
=0; clist< 2; clist++)

228 
n
 = 0;Ç < 
cuºSli˚
->
li°Xsize
[
˛i°
];Ç++)

230 
comp
 = 0; comp < 3; comp++)

232 
weight
[
˛i°
][
n
][
comp
] = 
deÁu…_weight
[comp];

233 
off£t
[
˛i°
][
n
][
comp
] = 0;

238 
dc_‹g
[0] = 
	`CompuãSumBlockBa£d
 (
p_Vid
->
pCurImg
,Ö_Vid->
FømeHeightInMbs
,Ö_Vid->
PicWidthInMbs
, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE,

239 
°¨t_mb
, 
íd_mb
);

241 i‡(
p_I≈
->
ChromaWeightSuµ‹t
 == 1)

243 
k
 = 0; k < 2; k++)

245 
dc_‹g
[
k
+1] = 
	`CompuãSumBlockBa£d
(
p_Vid
->
pImgOrg
[k + 1],Ö_Vid->
FømeHeightInMbs
,Ö_Vid->
PicWidthInMbs
,Ö_Vid->
mb_¸_size_y
,Ö_Vid->
mb_¸_size_x
,

246 
°¨t_mb
, 
íd_mb
);

250 
˛i°
 = 0; clist < 2; clist++)

252 
n
 = 0;Ç < 
cuºSli˚
->
li°Xsize
[
˛i°
];Ç++)

254 
cur_ªf
 = 
cuºSli˚
->
li°X
[
˛i°
][
n
]->
p_cuº_img
;

255 
dc_cur_ªf
[
˛i°
][
n
][0] = 
	`CompuãSumBlockBa£d
 (
cur_ªf
, 
p_Vid
->
FømeHeightInMbs
,Ö_Vid->
PicWidthInMbs
, 
MB_BLOCK_SIZE
, MB_BLOCK_SIZE, 
°¨t_mb
, 
íd_mb
);

257 i‡(
p_I≈
->
ChromaWeightSuµ‹t
 == 1)

259 
k
 = 0; k < 2; k++)

261 
cur_ªf
 = 
cuºSli˚
->
li°X
[
˛i°
][
n
]->
imgUV
[
k
];

262 
dc_cur_ªf
[
˛i°
][
n
][
k
+1] = 
	`CompuãSumBlockBa£d
 (
cur_ªf
, 
p_Vid
->
FømeHeightInMbs
,Ö_Vid->
PicWidthInMbs
,Ö_Vid->
mb_¸_size_y
,Ö_Vid->
mb_¸_size_x
, 
°¨t_mb
, 
íd_mb
);

269 
n
 = 0;Ç < 
cuºSli˚
->
li°Xsize
[
LIST_1
];Ç++)

272 
ãmp_weight
 = ( ()(
dc_cur_ªf
[
LIST_1
][
n
][0] - 
dc_‹g
[0]Ë/ (Ë(dc_‹g[0] - dc_cur_ªf[
LIST_0
][0][0]));

274 
w0
 = (Ë(((Ë
deÁu…_weight
[0] * 2 * 
ãmp_weight
) / ( 1.0 +Åemp_weight) + 0.5);

275 
w1
 = (Ë(((Ë
deÁu…_weight
[0] * 2Ë/ ( 1.0 + 
ãmp_weight
) + 0.5);

278 i‡(
w0
 <0 || 
w1
 <= 0)

280 
w0
 = 
deÁu…_weight
[0];

281 
w1
 = 
deÁu…_weight
[0];

284 i‡(
w1
 < -64 || w1 > 128 || 
w0
 < -64 || w0 >128)

286 
w0
 = 
deÁu…_weight
[0];

287 
w1
 = 
deÁu…_weight
[0];

290 
weight
[
LIST_1
][
n
][0] = 
w1
;

291 
off£t
[
LIST_1
][
n
][0] = 0;

293 i‡(
p_I≈
->
ChromaWeightSuµ‹t
 == 1)

295 
weight
[
LIST_1
][
n
][1] = (Ë(()(
deÁu…_weight
[1] * 
w1
) / () default_weight[0]);

296 
weight
[
LIST_1
][
n
][2] = (Ë(()(
deÁu…_weight
[2] * 
w1
) / () default_weight[0]);

301 
n
 = 0;Ç < 
cuºSli˚
->
li°Xsize
[
LIST_0
];Ç++)

303 
ãmp_weight
 = ( ()(
dc_cur_ªf
[
LIST_1
][0][0] - 
dc_‹g
[0]Ë/ (Ë(dc_‹g[0] - dc_cur_ªf[
LIST_0
][
n
][0]));

305 
w0
 = (Ë(((Ë
deÁu…_weight
[0] * 2 * 
ãmp_weight
) / ( 1.0 +Åemp_weight) + 0.5);

306 
w1
 = (Ë(((Ë
deÁu…_weight
[0] * 2Ë/ ( 1.0 + 
ãmp_weight
) + 0.5);

308 i‡(
w0
 <0 || 
w1
 <= 0)

310 
w0
 = 
deÁu…_weight
[0];

311 
w1
 = 
deÁu…_weight
[0];

314 i‡(
w1
 < -64 || w1 > 128 || 
w0
 < -64 || w0 >128)

316 
w0
 = 
deÁu…_weight
[0];

317 
w1
 = 
deÁu…_weight
[0];

320 
weight
[
LIST_0
][
n
][0] = 
w0
;

321 
off£t
[
LIST_0
][
n
][0] = 0;

323 i‡(
p_I≈
->
ChromaWeightSuµ‹t
 == 1)

325 
weight
[
LIST_0
][
n
][1] = (Ë(()(
deÁu…_weight
[1] * 
w0
) / () default_weight[0]);

326 
weight
[
LIST_0
][
n
][2] = (Ë(()(
deÁu…_weight
[2] * 
w0
) / () default_weight[0]);

329 
	}
}

338 
	$E°im©eWPPSli˚Alg1
(
Sli˚
 *
cuºSli˚
, 
£À˘_off£t
)

340 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

341 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºSli˚
->p_Inp;

343 
i
, 
n
;

344 
deÁu…_weight
[3];

345 
li°_off£t
 = ((
cuºSli˚
->
mb_aff_‰ame_Êag
Ë&& (
p_Vid
->
mb_d©a
[p_Vid->
cuºít_mb_ƒ
].
mb_fõld
))? (p_Vid->current_mb_nr & 0x01) ? 4 : 2 : 0;

346 
˛i°
;

348 
cur_¶i˚
;

350 
cuºSli˚
->
luma_log_weight_díom
 = 5;

351 
cuºSli˚
->
chroma_log_weight_díom
 = 5;

353 
cuºSli˚
->
wp_luma_round
 = 1 << (cuºSli˚->
luma_log_weight_díom
 - 1);

354 
cuºSli˚
->
wp_chroma_round
 = 1 << (cuºSli˚->
chroma_log_weight_díom
 - 1);

355 
deÁu…_weight
[0] = 1 << 
cuºSli˚
->
luma_log_weight_díom
;

356 
deÁu…_weight
[1] = deÁu…_weight[2] = 1 << 
cuºSli˚
->
chroma_log_weight_díom
;

358 if(
p_I≈
->
¶i˚_mode
 == 1)

360 
cur_¶i˚
 = 
p_Vid
->
cuºít_mb_ƒ
 / 
p_I≈
->
¶i˚_¨gumít
;

363 
cur_¶i˚
 = 0;

365 if(
p_Vid
->
wp_∑ømëîs_£t
 == 0)

367 
°¨t_mb
, 
íd_mb
;

368 
comp
;

370 
weight
[2][
MAX_REFERENCE_PICTURES
][3];

371 
off£t
[2][
MAX_REFERENCE_PICTURES
][3];

373 if(
p_I≈
->
¶i˚_mode
 == 1)

375 
°¨t_mb
 = 
cur_¶i˚
 * 
p_I≈
->
¶i˚_¨gumít
;

376 
íd_mb
 = 
°¨t_mb
 + 
p_I≈
->
¶i˚_¨gumít
;

377 if(
íd_mb
 > ()
p_Vid
->
FømeSizeInMbs
)

378 
íd_mb
 = 
p_Vid
->
FømeSizeInMbs
;

382 
°¨t_mb
 = 0;

383 
íd_mb
 = 
p_Vid
->
FømeSizeInMbs
;

386 
	`CompuãEx∂icôWPP¨amsLMS
(
cuºSli˚
, 
£À˘_off£t
, 
°¨t_mb
, 
íd_mb
, 
deÁu…_weight
, 
weight
, 
off£t
);

388 
˛i°
 = 0; cli° < 2 + 
li°_off£t
; clist++)

390 
n
 = 0;Ç < 
cuºSli˚
->
li°Xsize
[
˛i°
];Ç++)

392 i‡–
	`wpxDëîmöeWP
–
cuºSli˚
, 
˛i°
, 
n
 ) )

394 
comp
=0; comp < 3; comp ++)

396 
cuºSli˚
->
wp_weight
[
˛i°
][
n
][
comp
] = 
weight
[clist][n][comp];

397 
cuºSli˚
->
wp_off£t
[
˛i°
][
n
][
comp
] = 
off£t
[clist][n][comp];

398 if(
p_Vid
->
wp_weights
)

399 
p_Vid
->
wp_weights
[
comp
][
˛i°
][
n
][
cur_¶i˚
] = 
weight
[clist][n][comp];

400 if(
p_Vid
->
wp_off£ts
)

401 
p_Vid
->
wp_off£ts
[
comp
][
˛i°
][
n
][
cur_¶i˚
] = 
off£t
[clist][n][comp];

403 #i‡
DEBUG_WP


404 
comp
 = 0; comp < 3; comp++)

405 
	`¥ötf
("¶i˚ %d: index %d comp⁄íà%d weighà%d off£à%d\n", 
cur_¶i˚
, 
n
,
comp
,
cuºSli˚
->
wp_weight
[
˛i°
][n][comp],cuºSli˚->
wp_off£t
[clist][n][comp]);

413 
˛i°
 = 0; cli° < 2 + 
li°_off£t
; clist++)

415 
n
 = 0;Ç < 
cuºSli˚
->
li°Xsize
[
˛i°
];Ç++)

417 i‡–
	`wpxDëîmöeWP
–
cuºSli˚
, 
˛i°
, 
n
 ) )

419 
i
=0; i < 3; i ++)

421 
cuºSli˚
->
wp_weight
[
˛i°
][
n
][
i
] = 
p_Vid
->
wp_weights
[i][˛i°][n][
cur_¶i˚
];

422 
cuºSli˚
->
wp_off£t
[
˛i°
][
n
][
i
] = 
p_Vid
->
wp_off£ts
[i][˛i°][n][
cur_¶i˚
];

423 #i‡
DEBUG_WP


424 
	`¥ötf
("¶i˚ %d: index %d comp⁄íà%d weighà%d off£à%d\n", 
cur_¶i˚
, 
n
,
i
,
cuºSli˚
->
wp_weight
[
˛i°
][n][i],cuºSli˚->
wp_off£t
[clist][n][i]);

431 
	}
}

439 
	$E°im©eWPBSli˚Alg1
(
Sli˚
 *
cuºSli˚
)

441 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

442 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºSli˚
->p_Inp;

443 
i
, 
j
, 
n
;

445 
comp
;

446 
k
;

448 
deÁu…_weight
[3];

449 
li°_off£t
 = ((
cuºSli˚
->
mb_aff_‰ame_Êag
Ë&& (
p_Vid
->
mb_d©a
[p_Vid->
cuºít_mb_ƒ
].
mb_fõld
))? (p_Vid->current_mb_nr & 0x01) ? 4 : 2 : 0;

450 
˛i°
;

451 
cur_¶i˚
 = 0;

453 i‡(
p_Vid
->
a˘ive_µs
->
weighãd_bùªd_idc
 == 2)

455 
cuºSli˚
->
luma_log_weight_díom
 = 5;

456 
cuºSli˚
->
chroma_log_weight_díom
 = 5;

460 
cuºSli˚
->
luma_log_weight_díom
 = 5;

461 
cuºSli˚
->
chroma_log_weight_díom
 = 5;

464 
cuºSli˚
->
wp_luma_round
 = 1 << (cuºSli˚->
luma_log_weight_díom
 - 1);

465 
cuºSli˚
->
wp_chroma_round
 = 1 << (cuºSli˚->
chroma_log_weight_díom
 - 1);

466 
deÁu…_weight
[0] = 1 << 
cuºSli˚
->
luma_log_weight_díom
;

467 
deÁu…_weight
[1] = 1 << 
cuºSli˚
->
chroma_log_weight_díom
;

468 
deÁu…_weight
[2] = 1 << 
cuºSli˚
->
chroma_log_weight_díom
;

470 if(
p_I≈
->
¶i˚_mode
 == 1)

472 
cur_¶i˚
 = 
p_Vid
->
cuºít_mb_ƒ
 / 
p_I≈
->
¶i˚_¨gumít
 ;

475 
cur_¶i˚
 = 0;

477 i‡(
p_Vid
->
wp_∑ømëîs_£t
 == 0)

479 i‡(
p_Vid
->
a˘ive_µs
->
weighãd_bùªd_idc
 == 2)

481 
im_weight
[6][
MAX_REFERENCE_PICTURES
][MAX_REFERENCE_PICTURES][3];

483 
	`CompuãIm∂icôWeights
(
cuºSli˚
, 
deÁu…_weight
, 
im_weight
);

485 
k
 = 0; k < 2; k++)

487 
i
 = 0; i < 
cuºSli˚
->
li°Xsize
[
LIST_0
]; i++)

489 
j
 = 0; j < 
cuºSli˚
->
li°Xsize
[
LIST_1
]; j++)

491 
comp
 = 0; comp < 3; comp++)

493 
cuºSli˚
->
wbp_weight
[
k
][
i
][
j
][
comp
] = 
im_weight
[k][i][j][comp];

499 
˛i°
=0; cli°<2 + 
li°_off£t
; clist++)

501 
i
 = 0; i < 
cuºSli˚
->
li°Xsize
[
˛i°
]; i++)

503 
comp
 = 0; comp < 3; comp++)

505 
cuºSli˚
->
wp_weight
[
˛i°
][
i
][
comp
] = 
deÁu…_weight
[comp];

506 
cuºSli˚
->
wp_off£t
[
˛i°
][
i
][
comp
] = 0;

513 
°¨t_mb
, 
íd_mb
;

515 
comp
;

517 
wp_weight
[6][
MAX_REFERENCE_PICTURES
][3];

518 
wp_off£t
[6][
MAX_REFERENCE_PICTURES
][3];

520 if(
p_I≈
->
¶i˚_mode
 == 1)

522 
°¨t_mb
 = 
cur_¶i˚
 * 
p_I≈
->
¶i˚_¨gumít
;

523 
íd_mb
 = 
°¨t_mb
 + 
p_I≈
->
¶i˚_¨gumít
;

524 if(
íd_mb
 > ()
p_Vid
->
FømeSizeInMbs
)

525 
íd_mb
 = 
p_Vid
->
FømeSizeInMbs
;

529 
°¨t_mb
 = 0;

530 
íd_mb
 = 
p_Vid
->
FømeSizeInMbs
;

533 i‡(
p_I≈
->
Enh™˚dBWeightSuµ‹t
 == 2)

534 
	`CompuãEx∂icôWPP¨amsJNT
(
cuºSli˚
, 
°¨t_mb
, 
íd_mb
, 
deÁu…_weight
, 
wp_weight
, 
wp_off£t
);

536 
	`CompuãEx∂icôWPP¨amsLMS
(
cuºSli˚
, 0, 
°¨t_mb
, 
íd_mb
, 
deÁu…_weight
, 
wp_weight
, 
wp_off£t
);

538 
˛i°
=0; cli°<2 + 
li°_off£t
; clist++)

540 
n
 = 0;Ç < 
cuºSli˚
->
li°Xsize
[
˛i°
];Ç++)

542 i‡–
	`wpxDëîmöeWP
–
cuºSli˚
, 
˛i°
, 
n
 ) )

544 
comp
=0; comp < 3; comp ++)

546 
cuºSli˚
->
wp_weight
[
˛i°
][
n
][
comp
] = wp_weight[clist][n][comp];

547 
cuºSli˚
->
wp_off£t
[
˛i°
][
n
][
comp
] = wp_offset[clist][n][comp];

548 if(
p_Vid
->
wp_weights
)

549 
p_Vid
->
wp_weights
[
comp
][
˛i°
][
n
][
cur_¶i˚
] = 
wp_weight
[clist][n][comp];

550 if(
p_Vid
->
wp_off£ts
)

551 
p_Vid
->
wp_off£ts
[
comp
][
˛i°
][
n
][
cur_¶i˚
] = 
wp_off£t
[clist][n][comp];

557 i‡(
p_Vid
->
a˘ive_µs
->
weighãd_bùªd_idc
 != 1)

559 
˛i°
=0; cli°<2 + 
li°_off£t
; clist++)

561 
n
 = 0;Ç < 
cuºSli˚
->
li°Xsize
[
˛i°
];Ç++)

563 
	`mem˝y
(
cuºSli˚
->
wp_weight
[
˛i°
][
n
], 
deÁu…_weight
, 3 * ());

564 
	`mem£t
(
cuºSli˚
->
wp_off£t
[
˛i°
][
n
], 0, 3 * ());

569 
i
 = 0; i < 
cuºSli˚
->
li°Xsize
[
LIST_0
]; i++)

571 
j
 = 0; j < 
cuºSli˚
->
li°Xsize
[
LIST_1
]; j++)

573 
comp
 = 0; comp < 3; comp++)

575 
cuºSli˚
->
wbp_weight
[0][
i
][
j
][
comp
] = cuºSli˚->
wp_weight
[0][i][comp];

576 
cuºSli˚
->
wbp_weight
[1][
i
][
j
][
comp
] = cuºSli˚->
wp_weight
[1][j][comp];

583 i‡(
p_Vid
->
a˘ive_µs
->
weighãd_bùªd_idc
 == 2)

585 
k
 = 0; k < 2; k++)

587 
i
 = 0; i < 
cuºSli˚
->
li°Xsize
[
LIST_0
]; i++)

589 
j
 = 0; j < 
cuºSli˚
->
li°Xsize
[
LIST_1
]; j++)

591 
comp
 = 0; comp < 3; comp++)

593 
cuºSli˚
->
wbp_weight
[
k
][
i
][
j
][
comp
] = 
p_Vid
->wbp_weight[comp][k][i][j][
cur_¶i˚
];

601 
˛i°
=0; cli°<2 + 
li°_off£t
; clist++)

603 
n
 = 0;Ç < 
cuºSli˚
->
li°Xsize
[
˛i°
];Ç++)

605 i‡–
	`wpxDëîmöeWP
–
cuºSli˚
, 
˛i°
, 
n
 ) )

607 
i
=0; i < 3; i ++)

609 
cuºSli˚
->
wp_weight
[
˛i°
][
n
][
i
] = 
p_Vid
->
wp_weights
[i][˛i°][n][
cur_¶i˚
];

610 
cuºSli˚
->
wp_off£t
[
˛i°
][
n
][
i
] = 
p_Vid
->
wp_off£ts
[i][˛i°][n][
cur_¶i˚
];

615 
i
 = 0; i < 
cuºSli˚
->
li°Xsize
[
LIST_0
]; i++)

617 
j
 = 0; j < 
cuºSli˚
->
li°Xsize
[
LIST_1
]; j++)

619 
comp
 = 0; comp < 3; comp++)

621 
cuºSli˚
->
wbp_weight
[0][
i
][
j
][
comp
] = cuºSli˚->
wp_weight
[0][i][comp];

622 
cuºSli˚
->
wbp_weight
[1][
i
][
j
][
comp
] = cuºSli˚->
wp_weight
[1][j][comp];

627 
	}
}

636 
	$Te°WPPSli˚Alg1
(
Sli˚
 *
cuºSli˚
, 
£À˘_off£t
)

638 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

639 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

640 
i
, 
j
, 
n
;

642 
ödex
;

643 
comp
;

645 
deÁu…_weight
[3];

647 
li°_off£t
 = ((
p_Vid
->
mb_aff_‰ame_Êag
)&&’_Vid->
mb_d©a
[p_Vid->
cuºít_mb_ƒ
].
mb_fõld
))? (p_Vid->current_mb_nr & 0x01) ? 4 : 2 : 0;

648 
weight
[6][
MAX_REFERENCE_PICTURES
][3];

649 
off£t
[6][
MAX_REFERENCE_PICTURES
][3];

650 
˛i°
;

651 
≥rf‹m_wp
 = 0;

653 
cur_¶i˚
, 
num_¶i˚
;

654 
°¨t_mb
, 
íd_mb
;

656 
luma_log_weight_díom
 = 5;

657 
chroma_log_weight_díom
 = 5;

659 
deÁu…_weight
[0] = 1 << 
luma_log_weight_díom
;

660 
deÁu…_weight
[1] = deÁu…_weight[2] = 1 << 
chroma_log_weight_díom
;

663 
i
 = 0; i < 2 + 
li°_off£t
; i++)

665 
j
 = 0; j < 
cuºSli˚
->
li°Xsize
[
i
]; j++)

667 
n
 = 0;Ç < 3;Ç++)

669 
weight
[
i
][
j
][
n
] = 
deÁu…_weight
[n];

670 
off£t
[
i
][
j
][
n
] = 0;

675 
num_¶i˚
 = 
p_Vid
->
num_¶i˚s_wp
;

676 
cur_¶i˚
 = 0; cur_¶i˚ < 
num_¶i˚
; cur_slice++)

678 if(
p_I≈
->
¶i˚_mode
 == 1)

680 
°¨t_mb
 = 
cur_¶i˚
 * 
p_I≈
->
¶i˚_¨gumít
;

681 
íd_mb
 = 
°¨t_mb
 + 
p_I≈
->
¶i˚_¨gumít
;

682 if(
íd_mb
 > ()
p_Vid
->
FømeSizeInMbs
)

683 
íd_mb
 = 
p_Vid
->
FømeSizeInMbs
;

687 
°¨t_mb
 = 0;

688 
íd_mb
 = 
p_Vid
->
FømeSizeInMbs
;

691 
	`CompuãEx∂icôWPP¨amsLMS
(
cuºSli˚
, 
£À˘_off£t
, 
°¨t_mb
, 
íd_mb
, 
deÁu…_weight
, 
weight
, 
off£t
);

693 
˛i°
 = 0; clist < 2; clist++)

695 
n
 = 0;Ç < 
cuºSli˚
->
li°Xsize
[
˛i°
];Ç++)

697 
comp
=0; comp < 3; comp ++)

699 
p_Vid
->
wp_weights
[
comp
][
˛i°
][
n
][
cur_¶i˚
] = 
weight
[clist][n][comp];

700 
p_Vid
->
wp_off£ts
[
comp
][
˛i°
][
n
][
cur_¶i˚
] = 
off£t
[clist][n][comp];

702 #i‡
DEBUG_WP


703 
	`¥ötf
 ("weight[%d][%d][0] = %d\n", 
˛i°
, 
n
, 
weight
[clist][n][0]);

704 
	`¥ötf
 ("off£t[%d][%d][0] = %d\n", 
˛i°
, 
n
, 
off£t
[clist][n][0]);

705 
	`¥ötf
 ("weight[%d][%d][1] = %d\n", 
˛i°
, 
n
, 
weight
[clist][n][1]);

706 
	`¥ötf
 ("off£t[%d][%d][1] = %d\n", 
˛i°
, 
n
, 
off£t
[clist][n][1]);

707 
	`¥ötf
 ("weight[%d][%d][2] = %d\n", 
˛i°
, 
n
, 
weight
[clist][n][2]);

708 
	`¥ötf
 ("off£t[%d][%d][2] = %d\n", 
˛i°
, 
n
, 
off£t
[clist][n][2]);

714 
≥rf‹m_wp
 = 0;

715 
cur_¶i˚
 = 0; cur_¶i˚ < 
num_¶i˚
; cur_slice++)

717 
˛i°
=0; cli°<2 + 
li°_off£t
; clist++)

719 
ödex
 = 0; index < 
cuºSli˚
->
li°Xsize
[
˛i°
]; index++)

721 
comp
=0; comp < 3; comp ++)

723 
off£t_ã°
 = 
p_I≈
->
RDPSli˚BTe°
 && 
p_Vid
->
a˘ive_•s
->
¥ofûe_idc
 !
BASELINE


724 ? 
	`übs
(
p_Vid
->
wp_off£ts
[
comp
][
˛i°
][
ödex
][
cur_¶i˚
]) > 2

725 : 
p_Vid
->
wp_off£ts
[
comp
][
˛i°
][
ödex
][
cur_¶i˚
] != 0;

727 i‡(
p_Vid
->
wp_weights
[
comp
][
˛i°
][
ödex
][
cur_¶i˚
] !
deÁu…_weight
[comp] || 
off£t_ã°
)

729 
≥rf‹m_wp
 = 1;

733 i‡(
≥rf‹m_wp
 == 1) ;

735 i‡(
≥rf‹m_wp
 == 1) ;

737 if(
≥rf‹m_wp
 == 1) ;

740 
p_Vid
->
wp_∑ømëîs_£t
 = 1;

742  
≥rf‹m_wp
;

743 
	}
}

753 
	$Te°WPBSli˚Alg1
(
Sli˚
 *
cuºSli˚
, 
£À˘_mëhod
)

755 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

756 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

757 
i
, 
j
, 
n
;

759 
ödex
, 
comp
;

761 
deÁu…_weight
[3];

763 
li°_off£t
 = ((
p_Vid
->
mb_aff_‰ame_Êag
Ë&& (p_Vid->
mb_d©a
[p_Vid->
cuºít_mb_ƒ
].
mb_fõld
))? (p_Vid->current_mb_nr & 0x01) ? 4 : 2 : 0;

764 
im_weight
[6][
MAX_REFERENCE_PICTURES
][MAX_REFERENCE_PICTURES][3];

765 
wp_weight
[6][
MAX_REFERENCE_PICTURES
][3];

766 
wp_off£t
[6][
MAX_REFERENCE_PICTURES
][3];

768 
cur_¶i˚
, 
num_¶i˚
;

769 
°¨t_mb
, 
íd_mb
;

771 
˛i°
;

772 
≥rf‹m_wp
 = 1;

774 
luma_log_weight_díom
 = 5;

775 
chroma_log_weight_díom
 = 5;

777 
deÁu…_weight
[0] = 1 << 
luma_log_weight_díom
;

778 
deÁu…_weight
[1] = 1 << 
chroma_log_weight_díom
;

779 
deÁu…_weight
[2] = 1 << 
chroma_log_weight_díom
;

781 i‡(
£À˘_mëhod
 == 1)

783 
cur_¶i˚
 = 0;

784 
num_¶i˚
 = 
p_Vid
->
num_¶i˚s_wp
;

786 
	`CompuãIm∂icôWeights
(
cuºSli˚
, 
deÁu…_weight
, 
im_weight
);

788 
≥rf‹m_wp
 = 1;

789 
i
 = 0; i < 
cuºSli˚
->
li°Xsize
[
LIST_0
]; i++)

791 
j
 = 0; j < 
cuºSli˚
->
li°Xsize
[
LIST_1
]; j++)

793 
comp
 = 0; comp < 3; comp++)

795 
weight0
, 
weight1
;

797 if(
≥rf‹m_wp
)

799 
weight0
 = 
im_weight
[0][
i
][
j
][
comp
];

800 
weight1
 = 
im_weight
[1][
i
][
j
][
comp
];

804 
weight0
 = 
deÁu…_weight
[
comp
];

805 
weight1
 = 
deÁu…_weight
[
comp
];

809 
cur_¶i˚
 = 0; cur_¶i˚ < 
num_¶i˚
; cur_slice++)

811 
p_Vid
->
wbp_weight
[
comp
][0][
i
][
j
][
cur_¶i˚
] = 
weight0
;

812 
p_Vid
->
wbp_weight
[
comp
][1][
i
][
j
][
cur_¶i˚
] = 
weight1
;

820 
num_¶i˚
 = 
p_Vid
->
num_¶i˚s_wp
;

821 
cur_¶i˚
 = 0; cur_¶i˚ < 
num_¶i˚
; cur_slice++)

823 if(
p_I≈
->
¶i˚_mode
 == 1)

825 
°¨t_mb
 = 
cur_¶i˚
 * 
p_I≈
->
¶i˚_¨gumít
;

826 
íd_mb
 = 
°¨t_mb
 + 
p_I≈
->
¶i˚_¨gumít
;

827 if(
íd_mb
 > ()
p_Vid
->
FømeSizeInMbs
)

828 
íd_mb
 = 
p_Vid
->
FømeSizeInMbs
;

832 
°¨t_mb
 = 0;

833 
íd_mb
 = 
p_Vid
->
FømeSizeInMbs
;

836 i‡(
p_I≈
->
Enh™˚dBWeightSuµ‹t
 == 2)

837 
	`CompuãEx∂icôWPP¨amsJNT
(
cuºSli˚
, 
°¨t_mb
, 
íd_mb
, 
deÁu…_weight
, 
wp_weight
, 
wp_off£t
);

839 
	`CompuãEx∂icôWPP¨amsLMS
(
cuºSli˚
, 0, 
°¨t_mb
, 
íd_mb
, 
deÁu…_weight
, 
wp_weight
, 
wp_off£t
);

841 
˛i°
=0; cli°<2 + 
li°_off£t
; clist++)

843 
n
 = 0;Ç < 
cuºSli˚
->
li°Xsize
[
˛i°
];Ç++)

845 
comp
=0; comp < 3; comp ++)

847 
p_Vid
->
wp_weights
[
comp
][
˛i°
][
n
][
cur_¶i˚
] = 
wp_weight
[clist][n][comp];

848 
p_Vid
->
wp_off£ts
[
comp
][
˛i°
][
n
][
cur_¶i˚
] = 
wp_off£t
[clist][n][comp];

850 #i‡
DEBUG_WP


851 
	`¥ötf
 ("weight[%d][%d] = %d\n", 
˛i°
, 
n
, 
wp_weight
[clist][n][0]);

852 
	`¥ötf
 ("off£t[%d][%d] = %d\n", 
˛i°
, 
n
, 
wp_off£t
[clist][n][0]);

858 
≥rf‹m_wp
 = 0;

859 
cur_¶i˚
 = 0; cur_¶i˚ < 
num_¶i˚
; cur_slice++)

861 
˛i°
=0; cli°<2 + 
li°_off£t
; clist++)

863 
ödex
 = 0; index < 
cuºSli˚
->
li°Xsize
[
˛i°
]; index++)

865 
comp
=0; comp < 3; comp ++)

867 i‡(
p_Vid
->
wp_weights
[
comp
][
˛i°
][
ödex
][
cur_¶i˚
] !
deÁu…_weight
[comp] ||

868 
p_Vid
->
wp_off£ts
[
comp
][
˛i°
][
ödex
][
cur_¶i˚
] != 0)

870 
≥rf‹m_wp
 = 1;

874 i‡(
≥rf‹m_wp
 == 1) ;

876 i‡(
≥rf‹m_wp
 == 1) ;

878 if(
≥rf‹m_wp
 == 1) ;

882 
p_Vid
->
wp_∑ømëîs_£t
 = 1;

884  
≥rf‹m_wp
;

885 
	}
}

	@lencod/src/wp_mciter.c

12 
	~"c⁄åibut‹s.h
"

14 
	~<m©h.h
>

15 
	~<Êﬂt.h
>

17 
	~"globÆ.h
"

18 
	~"image.h
"

19 
	~"wp.h
"

28 
	$E°im©eWPPSli˚Alg2
(
Sli˚
 *
cuºSli˚
, 
£À˘_off£t
)

30 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

31 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºSli˚
->p_Inp;

32 
dc_‹g
 = 0.0;

33 
dc_‹g_UV
[2] = {0.0};

34 
dc_ªf
[
MAX_REFERENCE_PICTURES
] = { 0.0 };

35 
dc_ªf_UV
[
MAX_REFERENCE_PICTURES
][2] = { {0.0}};

37 
i
, 
n
, 
k
;

38 
deÁu…_weight
[3];

39 
li°_off£t
 = ((
cuºSli˚
->
mb_aff_‰ame_Êag
)&&(
p_Vid
->
mb_d©a
[p_Vid->
cuºít_mb_ƒ
].
mb_fõld
))? (p_Vid->current_mb_nr & 0x01) ? 4 : 2 : 0;

40 
weight
[2][
MAX_REFERENCE_PICTURES
][3];

41 
off£t
[2][
MAX_REFERENCE_PICTURES
][3];

42 
˛i°
;

44 
img≥l
 **
tmpPå
;

46 
cuºSli˚
->
luma_log_weight_díom
 = 5;

47 
cuºSli˚
->
chroma_log_weight_díom
 = 5;

49 
cuºSli˚
->
wp_luma_round
 = 1 << (cuºSli˚->
luma_log_weight_díom
 - 1);

50 
cuºSli˚
->
wp_chroma_round
 = 1 << (cuºSli˚->
chroma_log_weight_díom
 - 1);

51 
deÁu…_weight
[0] = 1 << 
cuºSli˚
->
luma_log_weight_díom
;

52 
deÁu…_weight
[1] = deÁu…_weight[2] = 1 << 
cuºSli˚
->
chroma_log_weight_díom
;

54 
dc_‹g
 = 
	`CompuãImgSum
(
p_Vid
->
pCurImg
,Ö_Vid->
height
,Ö_Vid->
width
);

56 i‡(
p_I≈
->
ChromaWeightSuµ‹t
 == 1)

58 
k
 = 0; k < 2; k++)

60 
dc_‹g_UV
[
k
] = 
	`CompuãImgSum
(
p_Vid
->
pImgOrg
[k + 1],Ö_Vid->
height_¸
,Ö_Vid->
width_¸
);

64 
˛i°
 = 0; cli° < 2 + 
li°_off£t
; clist++)

66 
n
 = 0;Ç < 
cuºSli˚
->
li°Xsize
[
˛i°
];Ç++)

68 i‡–
	`wpxDëîmöeWP
–
cuºSli˚
, 
˛i°
, 
n
 ) )

71 
i
 = 0; i < 3; i++)

73 
weight
[
˛i°
][
n
][
i
] = 
deÁu…_weight
[i];

74 
cuºSli˚
->
wp_weight
[
˛i°
][
n
][
i
] = 
deÁu…_weight
[i];

75 
cuºSli˚
->
wp_off£t
[
˛i°
][
n
][
i
] = 0;

76 
off£t
[
˛i°
][
n
][
i
] = 0;

80 
tmpPå
 = 
cuºSli˚
->
li°X
[
˛i°
][
n
]->
p_cuº_img
;

81 
dc_ªf
[
n
] = 
	`CompuãImgSum
(
tmpPå
, 
p_Vid
->
height
,Ö_Vid->
width
);

83 i‡(
p_I≈
->
ChromaWeightSuµ‹t
 == 1)

85 
k
 = 0; k < 2; k++)

88 
tmpPå
 = 
cuºSli˚
->
li°X
[
˛i°
][
n
]->
imgUV
[
k
];

89 
dc_ªf_UV
[
n
][
k
] = 
	`CompuãImgSum
(
tmpPå
, 
p_Vid
->
height_¸
,Ö_Vid->
width_¸
);

93 i‡(
£À˘_off£t
 == 0)

95 i‡(
dc_ªf
[
n
] != 0.0)

96 
weight
[
˛i°
][
n
][0] = (Ë(
deÁu…_weight
[0] * 
dc_‹g
 / 
dc_ªf
[n] + 0.5);

98 
weight
[
˛i°
][
n
][0] = 
deÁu…_weight
[0];

99 
weight
[
˛i°
][
n
][0] = 
	`sClù3
(-128, 127, weight[clist][n][0]);

100 i‡(
p_I≈
->
ChromaWeightSuµ‹t
 == 1)

102 i‡(
dc_ªf_UV
[
n
][0] != 0)

103 
weight
[
˛i°
][
n
][1] = (Ë(
deÁu…_weight
[1] * 
dc_‹g_UV
[0] / 
dc_ªf_UV
[n][0] + 0.5);

105 
weight
[
˛i°
][
n
][1] = 
deÁu…_weight
[1];

106 
weight
[
˛i°
][
n
][1] = 
	`sClù3
(-128, 127, weight[clist][n][1]);

108 i‡(
dc_ªf_UV
[
n
][1] != 0)

109 
weight
[
˛i°
][
n
][2] = (Ë(
deÁu…_weight
[2] * 
dc_‹g_UV
[1] / 
dc_ªf_UV
[n][1] + 0.5);

111 
weight
[
˛i°
][
n
][2] = 
deÁu…_weight
[2];

112 
weight
[
˛i°
][
n
][2] = 
	`sClù3
(-128, 127, weight[clist][n][2]);

117 
off£t
[
˛i°
][
n
][0] = 
p_Vid
->
‰ameOff£t
[clist][n];

119 
off£t
[
˛i°
][
n
][0] = (off£t[˛i°][n][0]+((
p_Vid
->
bôdïth_luma
-8)>>1))>>(p_Vid->bitdepth_luma - 8);

120 
off£t
[
˛i°
][
n
][0] = 
	`sClù3
( -128, 127, offset[clist][n][0]);

121 
off£t
[
˛i°
][
n
][0] = off£t[˛i°][n][0]<<(
p_Vid
->
bôdïth_luma
-8);

122 
weight
[
˛i°
][
n
][0] = 
deÁu…_weight
[0];

124 i‡(
p_I≈
->
ChromaWeightSuµ‹t
 == 1)

126 
off£t
[
˛i°
][
n
][1] = (Ë((
dc_‹g_UV
[0] - 
dc_ªf_UV
[n][0])/(
p_Vid
->
size_¸
)+0.5);

127 
off£t
[
˛i°
][
n
][1] = (off£t[˛i°][n][1] + ((
p_Vid
->
bôdïth_chroma
 - 8)>>1))>>(p_Vid->bitdepth_chroma - 8);

128 
off£t
[
˛i°
][
n
][1] = 
	`sClù3
( -128, 127, offset[clist][n][1]);

129 
off£t
[
˛i°
][
n
][1] = off£t[˛i°][n][1]<<(
p_Vid
->
bôdïth_chroma
 - 8);

131 
weight
[
˛i°
][
n
][1] = 
deÁu…_weight
[1];

133 
off£t
[
˛i°
][
n
][2] = (Ë((
dc_‹g_UV
[1] - 
dc_ªf_UV
[n][1])/(
p_Vid
->
size_¸
)+0.5);

134 
off£t
[
˛i°
][
n
][2] = (off£t[˛i°][n][2] + ((
p_Vid
->
bôdïth_chroma
 - 8)>>1))>>(p_Vid->bitdepth_chroma-8);

135 
off£t
[
˛i°
][
n
][2] = 
	`sClù3
( -128, 127, offset[clist][n][2]);

136 
off£t
[
˛i°
][
n
][2] = off£t[˛i°][n][2]<<(
p_Vid
->
bôdïth_chroma
 - 8);

138 
weight
[
˛i°
][
n
][2] = 
deÁu…_weight
[2];

142 
i
=0; i < 3; i ++)

144 
cuºSli˚
->
wp_weight
[
˛i°
][
n
][
i
] = 
weight
[clist][n][i];

145 
cuºSli˚
->
wp_off£t
[
˛i°
][
n
][
i
] = 
off£t
[clist][n][i];

146 #i‡
DEBUG_WP


147 
	`¥ötf
("ödex %d comp⁄íà%d weighà%d off£à%d\n",
n
,
i
,
weight
[0][n][i],
off£t
[0][n][i]);

153 
	}
}

161 
	$E°im©eWPBSli˚Alg2
(
Sli˚
 *
cuºSli˚
)

163 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

164 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºSli˚
->p_Inp;

165 
i
, 
j
, 
k
, 
n
;

167 
tx
, 
tb
, 
td
, 
Di°SˇÀFa˘‹
;

169 
ödex
;

170 
comp
;

172 
dc_‹g_UV
[2] = { 0.0 };

173 
dc_ªf_UV
[6][
MAX_REFERENCE_PICTURES
][2] = { {{0.0}} };

175 
deÁu…_weight
[3];

176 
li°_off£t
 = ((
cuºSli˚
->
mb_aff_‰ame_Êag
)&&(
p_Vid
->
mb_d©a
[p_Vid->
cuºít_mb_ƒ
].
mb_fõld
))? (p_Vid->current_mb_nr & 0x01) ? 4 : 2 : 0;

177 
weight
[6][
MAX_REFERENCE_PICTURES
][3];

178 
off£t
[6][
MAX_REFERENCE_PICTURES
][3];

179 
im_weight
[6][
MAX_REFERENCE_PICTURES
][MAX_REFERENCE_PICTURES][3];

180 
˛i°
;

181 
wf_weight
, 
wf_off£t
;

182 
img≥l
 **
tmpPå
;

184 i‡(
p_Vid
->
a˘ive_µs
->
weighãd_bùªd_idc
 == 2)

186 
cuºSli˚
->
luma_log_weight_díom
 = 5;

187 
cuºSli˚
->
chroma_log_weight_díom
 = 5;

191 
cuºSli˚
->
luma_log_weight_díom
 = 5;

192 
cuºSli˚
->
chroma_log_weight_díom
 = 5;

195 
cuºSli˚
->
wp_luma_round
 = 1 << (cuºSli˚->
luma_log_weight_díom
 - 1);

196 
cuºSli˚
->
wp_chroma_round
 = 1 << (cuºSli˚->
chroma_log_weight_díom
 - 1);

197 
deÁu…_weight
[0] = 1 << 
cuºSli˚
->
luma_log_weight_díom
;

198 
deÁu…_weight
[1] = 1 << 
cuºSli˚
->
chroma_log_weight_díom
;

199 
deÁu…_weight
[2] = 1 << 
cuºSli˚
->
chroma_log_weight_díom
;

201 i‡(
p_Vid
->
a˘ive_µs
->
weighãd_bùªd_idc
 == 2)

203 
i
 = 0; i < 
cuºSli˚
->
li°Xsize
[
LIST_0
]; i++)

205 
j
 = 0; j < 
cuºSli˚
->
li°Xsize
[
LIST_1
]; j++)

207 
td
 = (Ë
	`iClù3
(-128, 127,(
cuºSli˚
->
li°X
[
LIST_1
][
j
]->
poc
 - cuºSli˚->li°X[
LIST_0
][
i
]->poc));

208 
tb
 = ()
	`iClù3
(-128, 127,(
p_Vid
->
íc_pi˘uª
->
poc
 - 
cuºSli˚
->
li°X
[
LIST_0
][
i
]->poc));

209 
comp
 = 0; comp < 3; comp++)

212 i‡(
td
 == 0)

214 
im_weight
[0][
i
][
j
][
comp
] = 
deÁu…_weight
[comp];

215 
im_weight
[1][
i
][
j
][
comp
] = 
deÁu…_weight
[comp];

219 
tx
 = (Ë(16384 + 
	`übs
(
td
 >> 1))/td;

220 
Di°SˇÀFa˘‹
 = (Ë
	`iClù3
(-1024, 1023, (
tx
*
tb
 + 32 )>>6);

221 
im_weight
[1][
i
][
j
][
comp
] = 
Di°SˇÀFa˘‹
>>2;

222 i‡(
im_weight
[1][
i
][
j
][
comp
] < -64 || im_weight[1][i][j][comp] >128)

223 
im_weight
[1][
i
][
j
][
comp
] = 
deÁu…_weight
[comp];

224 
im_weight
[0][
i
][
j
][
comp
] = 64 - im_weight[1][i][j][comp];

227 #i‡
DEBUG_WP


228 
	`¥ötf
 ("%d im∞weight[%d][%d] = %d , %d (%d %d %dË(%d %dË(%d %d)\n",
p_Vid
->
íc_pi˘uª
->
poc
, 
i
, 
j
, 
im_weight
[0][i][j][0], im_weight[1][i][j][0],

229 
p_Vid
->
íc_pi˘uª
->
poc
,
cuºSli˚
->
li°X
[
LIST_0
][
i
]->poc, cuºSli˚->li°X[
LIST_1
][
j
]->poc,

230 
Di°SˇÀFa˘‹
 ,
tx
,
td
,
tb
);

235 
k
 = 0; k < 2; k++)

237 
i
 = 0; i < 
cuºSli˚
->
li°Xsize
[
LIST_0
]; i++)

239 
j
 = 0; j < 
cuºSli˚
->
li°Xsize
[
LIST_1
]; j++)

241 
comp
 = 0; comp < 3; comp++)

243 
cuºSli˚
->
wbp_weight
[
k
][
i
][
j
][
comp
] = 
im_weight
[k][i][j][comp];

249 
˛i°
=0; cli°<2 + 
li°_off£t
; clist++)

251 
ödex
 = 0; index < 
cuºSli˚
->
li°Xsize
[
˛i°
]; index++)

253 
comp
 = 0; comp < 3; comp++)

255 
cuºSli˚
->
wp_weight
[
˛i°
][
ödex
][
comp
] = 
deÁu…_weight
[comp];

256 
cuºSli˚
->
wp_off£t
[
˛i°
][
ödex
][
comp
] = 0;

265 i‡(
p_I≈
->
ChromaWeightSuµ‹t
 == 1)

267 
k
 = 0; k < 2; k++)

269 
dc_‹g_UV
[
k
] = 
	`CompuãImgSum
(
p_Vid
->
pImgOrg
[k + 1],Ö_Vid->
height_¸
,Ö_Vid->
width_¸
);

273 
˛i°
=0; cli°<2 + 
li°_off£t
; clist++)

275 
n
 = 0;Ç < 
cuºSli˚
->
li°Xsize
[
˛i°
];Ç++)

277 i‡–
	`wpxDëîmöeWP
–
cuºSli˚
, 
˛i°
, 
n
 ) )

280 
i
 = 0; i < 3; i++)

282 
cuºSli˚
->
wp_weight
[
˛i°
][
n
][
i
] = 
deÁu…_weight
[i];

283 
cuºSli˚
->
wp_off£t
[
˛i°
][
n
][
i
] = 0;

284 
off£t
 [
˛i°
][
n
][
i
] = 0;

285 
weight
 [
˛i°
][
n
][
i
] = 
deÁu…_weight
[i];

288 
off£t
[
˛i°
][
n
][0] = 
wf_off£t
 = 
p_Vid
->
‰ameOff£t
[clist][n];

289 
weight
[
˛i°
][
n
][0] = 
wf_weight
 = 
deÁu…_weight
[0];

293 i‡(
p_I≈
->
ChromaWeightSuµ‹t
 == 1)

295 
k
 = 0; k < 2; k++)

297 
tmpPå
 = 
cuºSli˚
->
li°X
[
˛i°
][
n
]->
imgUV
[
k
];

298 
dc_ªf_UV
[
˛i°
][
n
][
k
] = 
	`CompuãImgSum
(
tmpPå
, 
p_Vid
->
height_¸
,Ö_Vid->
width_¸
);

300 i‡(
dc_ªf_UV
[
˛i°
][
n
][
k
] != 0.0)

301 
wf_weight
 = (Ë(
deÁu…_weight
[
k
 + 1] * 
dc_‹g_UV
[k] / 
dc_ªf_UV
[
˛i°
][
n
][k] + 0.5);

303 
wf_weight
 = 
deÁu…_weight
[
k
 + 1];

304 
wf_weight
 = 
	`sClù3
(-128, 127, wf_weight);

305 
wf_off£t
 = 0;

307 
weight
[
˛i°
][
n
][
k
 + 1] = 
wf_weight
;

308 
off£t
[
˛i°
][
n
][
k
 + 1] = 
wf_off£t
;

313 
weight
[
˛i°
][
n
][1] = 
deÁu…_weight
[1];

314 
weight
[
˛i°
][
n
][2] = 
deÁu…_weight
[2];

315 
off£t
[
˛i°
][
n
][1] = 0;

316 
off£t
[
˛i°
][
n
][2] = 0;

319 
i
 = 0; i < 3; i++)

321 
cuºSli˚
->
wp_weight
[
˛i°
][
n
][
i
] = 
weight
[clist][n][i];

322 
cuºSli˚
->
wp_off£t
[
˛i°
][
n
][
i
] = 
off£t
[clist][n][i];

323 #i‡
DEBUG_WP


324 
	`¥ötf
("%d %d\n",
cuºSli˚
->
wp_weight
[
˛i°
][
ödex
][
comp
],cuºSli˚->
wp_off£t
[clist][index][comp]);

331 i‡(
p_Vid
->
a˘ive_µs
->
weighãd_bùªd_idc
 != 1)

333 
˛i°
=0; cli°<2 + 
li°_off£t
; clist++)

335 
ödex
 = 0; index < 
cuºSli˚
->
li°Xsize
[
˛i°
]; index++)

337 
	`mem˝y
(
cuºSli˚
->
wp_weight
[
˛i°
][
ödex
], 
deÁu…_weight
, 3 * ());

338 
	`mem£t
(
cuºSli˚
->
wp_off£t
[
˛i°
][
ödex
], 0, 3 * ());

344 
i
 = 0; i < 
cuºSli˚
->
li°Xsize
[
LIST_0
]; i++)

346 
j
 = 0; j < 
cuºSli˚
->
li°Xsize
[
LIST_1
]; j++)

348 
comp
 = 0; comp < 3; comp++)

350 
cuºSli˚
->
wbp_weight
[0][
i
][
j
][
comp
] = cuºSli˚->
wp_weight
[0][i][comp];

351 
cuºSli˚
->
wbp_weight
[1][
i
][
j
][
comp
] = cuºSli˚->
wp_weight
[1][j][comp];

353 #i‡
DEBUG_WP


354 
	`¥ötf
 ("bpw weight[%d][%d] = %d , %d (%d %d %dË(%d %dË(%d %d)\n", 
i
, 
j
, 
cuºSli˚
->
wbp_weight
[0][i][j][0], currSlice->wbp_weight[1][i][j][0],

355 
p_Vid
->
íc_pi˘uª
->
poc
,
cuºSli˚
->
li°X
[
LIST_0
][
i
]->poc, cuºSli˚->li°X[
LIST_1
][
j
]->poc,

356 
Di°SˇÀFa˘‹
 ,
tx
,tx,tx);

361 
	}
}

371 
	$Te°WPPSli˚Alg2
(
Sli˚
 *
cuºSli˚
, 
£À˘_off£t
)

373 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

374 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

375 
i
, 
j
, 
k
, 
n
;

377 
ödex
;

378 
comp
;

379 
dc_‹g
 = 0.0;

380 
dc_‹g_UV
[2] = {0.0};

381 
dc_ªf
[
MAX_REFERENCE_PICTURES
] = { 0.0 };

382 
dc_ªf_UV
[
MAX_REFERENCE_PICTURES
][2] = { {0.0}};

384 
deÁu…_weight
[3];

386 
li°_off£t
 = ((
p_Vid
->
mb_aff_‰ame_Êag
)&&’_Vid->
mb_d©a
[p_Vid->
cuºít_mb_ƒ
].
mb_fõld
))? (p_Vid->current_mb_nr & 0x01) ? 4 : 2 : 0;

387 
weight
[2][
MAX_REFERENCE_PICTURES
][3];

388 
off£t
[2][
MAX_REFERENCE_PICTURES
][3];

389 
wp_weight
[6][
MAX_REFERENCE_PICTURES
][3];

390 
wp_off£t
[6][
MAX_REFERENCE_PICTURES
][3];

391 
˛i°
;

392 
≥rf‹m_wp
 = 0;

393 
img≥l
 **
tmpPå
;

395 
luma_log_weight_díom
 = 5;

396 
chroma_log_weight_díom
 = 5;

398 
deÁu…_weight
[0] = 1 << 
luma_log_weight_díom
;

399 
deÁu…_weight
[1] = deÁu…_weight[2] = 1 << 
chroma_log_weight_díom
;

402 
i
 = 0; i < 2 + 
li°_off£t
; i++)

404 
j
 = 0; j < 
cuºSli˚
->
li°Xsize
[
i
]; j++)

406 
n
 = 0;Ç < 3;Ç++)

408 
weight
[
i
][
j
][
n
] = 
deÁu…_weight
[n];

409 
wp_weight
[
i
][
j
][
n
] = 
deÁu…_weight
[n];

410 
wp_off£t
[
i
][
j
][
n
] = 0;

411 
off£t
[
i
][
j
][
n
] = 0;

416 
dc_‹g
 = 
	`CompuãImgSum
(
p_Vid
->
pCurImg
,Ö_Vid->
height
,Ö_Vid->
width
);

418 i‡(
p_I≈
->
ChromaWeightSuµ‹t
 == 1)

420 
k
 = 0; k < 2; k++)

422 
dc_‹g_UV
[
k
] = 
	`CompuãImgSum
(
p_Vid
->
pImgOrg
[k + 1],Ö_Vid->
height_¸
,Ö_Vid->
width_¸
);

426 
˛i°
 = 0; cli° < 2 + 
li°_off£t
; clist++)

428 
n
 = 0;Ç < 
cuºSli˚
->
li°Xsize
[
˛i°
];Ç++)

430 
tmpPå
 = 
cuºSli˚
->
li°X
[
˛i°
][
n
]->
p_cuº_img
;

431 
dc_ªf
[
n
] = 
	`CompuãImgSum
(
tmpPå
, 
p_Vid
->
height
,Ö_Vid->
width
);

433 i‡(
p_I≈
->
ChromaWeightSuµ‹t
 == 1)

435 
k
 = 0; k < 2; k++)

437 
tmpPå
 = 
cuºSli˚
->
li°X
[
˛i°
][
n
]->
imgUV
[
k
];

438 
dc_ªf_UV
[
n
][
k
] = 
	`CompuãImgSum
(
tmpPå
, 
p_Vid
->
height_¸
,Ö_Vid->
width_¸
);

442 i‡(
£À˘_off£t
 == 0)

444 i‡(
dc_ªf
[
n
] != 0.0)

445 
weight
[
˛i°
][
n
][0] = (Ë(
deÁu…_weight
[0] * 
dc_‹g
 / 
dc_ªf
[n] + 0.5);

447 
weight
[
˛i°
][
n
][0] = 
deÁu…_weight
[0];

448 
weight
[
˛i°
][
n
][0] = 
	`sClù3
(-128, 127, weight[clist][n][0]);

449 i‡(
p_I≈
->
ChromaWeightSuµ‹t
 == 1)

451 i‡(
dc_ªf_UV
[
n
][0] != 0)

452 
weight
[
˛i°
][
n
][1] = (Ë(
deÁu…_weight
[1] * 
dc_‹g_UV
[0] / 
dc_ªf_UV
[n][0] + 0.5);

454 
weight
[
˛i°
][
n
][1] = 
deÁu…_weight
[1];

455 
weight
[
˛i°
][
n
][1] = 
	`sClù3
(-128, 127, weight[clist][n][1]);

457 i‡(
dc_ªf_UV
[
n
][1] != 0)

458 
weight
[
˛i°
][
n
][2] = (Ë(
deÁu…_weight
[2] * 
dc_‹g_UV
[1] / 
dc_ªf_UV
[n][1] + 0.5);

460 
weight
[
˛i°
][
n
][2] = 
deÁu…_weight
[2];

461 
weight
[
˛i°
][
n
][2] = 
	`sClù3
(-128, 127, weight[clist][n][2]);

466 
off£t
[
˛i°
][
n
][0] = 
p_Vid
->
‰ameOff£t
[clist][n];

468 
off£t
[
˛i°
][
n
][0] = (off£t[˛i°][n][0]+((
p_Vid
->
bôdïth_luma
-8)>>1))>>(p_Vid->bitdepth_luma-8);

469 
off£t
[
˛i°
][
n
][0] = 
	`sClù3
( -128, 127, offset[clist][n][0]);

470 
off£t
[
˛i°
][
n
][0] = off£t[˛i°][n][0]<<(
p_Vid
->
bôdïth_luma
-8);

471 
weight
[
˛i°
][
n
][0] = 
deÁu…_weight
[0];

473 i‡(
p_I≈
->
ChromaWeightSuµ‹t
 == 1)

475 
off£t
[
˛i°
][
n
][1] = (Ë((
dc_‹g_UV
[0] - 
dc_ªf_UV
[n][0])/(
p_Vid
->
size_¸
)+0.5);

476 
off£t
[
˛i°
][
n
][1] = (off£t[˛i°][n][1] + ((
p_Vid
->
bôdïth_chroma
 - 8)>>1))>>(p_Vid->bitdepth_chroma-8);

477 
off£t
[
˛i°
][
n
][1] = 
	`sClù3
( -128, 127, offset[clist][n][1]);

478 
off£t
[
˛i°
][
n
][1] = off£t[˛i°][n][1]<<(
p_Vid
->
bôdïth_chroma
 - 8);

480 
weight
[
˛i°
][
n
][1] = 
deÁu…_weight
[1];

482 
off£t
[
˛i°
][
n
][2] = (Ë((
dc_‹g_UV
[1] - 
dc_ªf_UV
[n][1])/(
p_Vid
->
size_¸
)+0.5);

483 
off£t
[
˛i°
][
n
][2] = (off£t[˛i°][n][2] + ((
p_Vid
->
bôdïth_chroma
 - 8)>>1))>>(p_Vid->bitdepth_chroma-8);

484 
off£t
[
˛i°
][
n
][2] = 
	`sClù3
( -128, 127, offset[clist][n][2]);

485 
off£t
[
˛i°
][
n
][2] = off£t[˛i°][n][2]<<(
p_Vid
->
bôdïth_chroma
 - 8);

487 
weight
[
˛i°
][
n
][2] = 
deÁu…_weight
[2];

493 
˛i°
=0; cli°<2 + 
li°_off£t
; clist++)

495 
ödex
 = 0; index < 
cuºSli˚
->
li°Xsize
[
˛i°
]; index++)

497 
comp
=0; comp < 3; comp ++)

499 
off£t_ã°
 = 
p_I≈
->
RDPSli˚BTe°
 && 
p_Vid
->
a˘ive_•s
->
¥ofûe_idc
 !
BASELINE


500 ? 
	`übs
(
off£t
[
˛i°
][
ödex
][
comp
]) > 2

501 : 
off£t
[
˛i°
][
ödex
][
comp
] != 0;

503 i‡(
weight
[
˛i°
][
ödex
][
comp
] !
deÁu…_weight
[0] || 
off£t_ã°
)

505 
≥rf‹m_wp
 = 1;

509 i‡(
≥rf‹m_wp
 == 1) ;

511 i‡(
≥rf‹m_wp
 == 1) ;

514  
≥rf‹m_wp
;

515 
	}
}

524 
	$Te°WPBSli˚Alg2
(
Sli˚
 *
cuºSli˚
, 
£À˘_mëhod
)

526 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

527 
I≈utP¨amëîs
 *
p_I≈
 = 
p_Vid
->p_Inp;

528 
i
, 
j
, 
k
, 
n
;

529 #i‡(
MVC_EXTENSION_ENABLE
)

530 
võw_id
 = 
p_Vid
->view_id;

532 
võw_id
 = 0;

535 
tx
, 
td
, 
tb
, 
Di°SˇÀFa˘‹
;

537 
ödex
;

538 
comp
;

539 
dc_‹g
 = 0.0;

540 
dc_‹g_UV
[2] = { 0.0 };

541 
dc_ªf_UV
[6][
MAX_REFERENCE_PICTURES
][2] = { {{0.0}} };

543 
deÁu…_weight
[3];

545 
li°_off£t
 = ((
p_Vid
->
mb_aff_‰ame_Êag
)&&’_Vid->
mb_d©a
[p_Vid->
cuºít_mb_ƒ
].
mb_fõld
))? (p_Vid->current_mb_nr & 0x01) ? 4 : 2 : 0;

546 
weight
[6][
MAX_REFERENCE_PICTURES
][3];

547 
off£t
[6][
MAX_REFERENCE_PICTURES
][3];

548 
im_weight
[6][
MAX_REFERENCE_PICTURES
][MAX_REFERENCE_PICTURES][3];

549 
wp_weight
[6][
MAX_REFERENCE_PICTURES
][3];

550 
wp_off£t
[6][
MAX_REFERENCE_PICTURES
][3];

551 
wbp_weight
[6][
MAX_REFERENCE_PICTURES
][MAX_REFERENCE_PICTURES][3];

553 
˛i°
;

554 
wf_weight
, 
wf_off£t
;

555 
≥rf‹m_wp
 = 0;

556 
img≥l
 **
tmpPå
;

558 
luma_log_weight_díom
 = 5;

559 
chroma_log_weight_díom
 = 5;

561 
deÁu…_weight
[0] = 1 << 
luma_log_weight_díom
;

562 
deÁu…_weight
[1] = 1 << 
chroma_log_weight_díom
;

563 
deÁu…_weight
[2] = 1 << 
chroma_log_weight_díom
;

566 
i
 = 0; i < 2 + 
li°_off£t
; i++)

568 
j
 = 0; j < 
cuºSli˚
->
li°Xsize
[
i
]; j++)

570 
n
 = 0;Ç < 3;Ç++)

572 
wp_weight
[
i
][
j
][
n
] = 
deÁu…_weight
[n];

573 
wp_off£t
[
i
][
j
][
n
] = 0;

574 
off£t
 [
i
][
j
][
n
] = 0;

575 
weight
 [
i
][
j
][
n
] = 
deÁu…_weight
[n];

580 
i
 = 0; i < 
cuºSli˚
->
li°Xsize
[
LIST_0
]; i++)

582 
j
 = 0; j < 
cuºSli˚
->
li°Xsize
[
LIST_1
]; j++)

584 
td
 = (Ë
	`iClù3
(-128, 127,(
cuºSli˚
->
li°X
[
LIST_1
][
j
]->
poc
 - cuºSli˚->li°X[
LIST_0
][
i
]->poc));

585 
tb
 = (Ë
	`iClù3
(-128, 127,(
p_Vid
->
íc_pi˘uª
->
poc
 - 
cuºSli˚
->
li°X
[
LIST_0
][
i
]->poc));

586 
comp
 = 0; comp < 3; comp++)

589 i‡(
td
 == 0)

591 
im_weight
[0][
i
][
j
][
comp
] = 
deÁu…_weight
[comp];

592 
im_weight
[1][
i
][
j
][
comp
] = 
deÁu…_weight
[comp];

596 
tx
 = (Ë(16384 + 
	`übs
(
td
 >> 1))/td;

597 
Di°SˇÀFa˘‹
 = 
	`sClù3
(-1024, 1023, (
tx
*
tb
 + 32 )>>6);

598 
im_weight
[1][
i
][
j
][
comp
] = 
Di°SˇÀFa˘‹
 >> 2;

599 i‡(
im_weight
[1][
i
][
j
][
comp
] < -64 || im_weight[1][i][j][comp] >128)

600 
im_weight
[1][
i
][
j
][
comp
] = 
deÁu…_weight
[comp];

601 
im_weight
[0][
i
][
j
][
comp
] = 64 - im_weight[1][i][j][comp];

608 i‡(
£À˘_mëhod
 == 1)

610 
i
 = 0; i < 
cuºSli˚
->
li°Xsize
[
LIST_0
]; i++)

612 
j
 = 0; j < 
cuºSli˚
->
li°Xsize
[
LIST_1
]; j++)

614 
comp
 = 0; comp < 3; comp++)

616 
wbp_weight
[1][
i
][
j
][
comp
] = 
im_weight
[1][i][j][comp] ;

617 
wbp_weight
[0][
i
][
j
][
comp
] = 
im_weight
[0][i][j][comp];

622 
˛i°
=0; cli°<2 + 
li°_off£t
; clist++)

624 
ödex
 = 0; index < 
cuºSli˚
->
li°Xsize
[
˛i°
]; index++)

626 
comp
 = 0; comp < 3; comp++)

628 
wp_weight
[
˛i°
][
ödex
][
comp
] = 
deÁu…_weight
[comp];

629 
wp_off£t
[
˛i°
][
ödex
][
comp
] = 0;

636 
dc_‹g
 = 
	`CompuãImgSum
(
p_Vid
->
pCurImg
,Ö_Vid->
height
,Ö_Vid->
width
);

638 i‡(
p_I≈
->
ChromaWeightSuµ‹t
 == 1)

640 
k
 = 0; k < 2; k++)

642 
dc_‹g_UV
[
k
] = 
	`CompuãImgSum
(
p_Vid
->
pImgOrg
[k + 1],Ö_Vid->
height_¸
,Ö_Vid->
width_¸
);

646 
˛i°
=0; cli°<2 + 
li°_off£t
; clist++)

648 
n
 = 0;Ç < 
cuºSli˚
->
li°Xsize
[
˛i°
];Ç++)

650 
off£t
[
˛i°
][
n
][0] = 
wf_off£t
 = 
p_Vid
->
‰ameOff£t
[clist][n];

651 
weight
[
˛i°
][
n
][0] = 
wf_weight
 = 
deÁu…_weight
[0];

654 i‡(
p_I≈
->
ChromaWeightSuµ‹t
 == 1)

656 
k
 = 0; k < 2; k++)

658 
tmpPå
 = 
cuºSli˚
->
li°X
[
˛i°
][
n
]->
imgUV
[
k
];

659 
dc_ªf_UV
[
˛i°
][
n
][
k
] = 
	`CompuãImgSum
(
tmpPå
, 
p_Vid
->
height_¸
,Ö_Vid->
width_¸
);

661 i‡(
dc_ªf_UV
[
˛i°
][
n
][
k
] != 0.0)

662 
wf_weight
 = (Ë(
deÁu…_weight
[
k
 + 1] * 
dc_‹g_UV
[k] / 
dc_ªf_UV
[
˛i°
][
n
][k] + 0.5);

664 
wf_weight
 = 
deÁu…_weight
[
k
 + 1];

665 
wf_weight
 = 
	`sClù3
(-128, 127, wf_weight);

666 
wf_off£t
 = 0;

668 
weight
[
˛i°
][
n
][
k
 + 1] = 
wf_weight
;

669 
off£t
[
˛i°
][
n
][
k
 + 1] = 
wf_off£t
;

674 
weight
[
˛i°
][
n
][1] = 
deÁu…_weight
[1];

675 
weight
[
˛i°
][
n
][2] = 
deÁu…_weight
[2];

676 
off£t
[
˛i°
][
n
][1] = 0;

677 
off£t
[
˛i°
][
n
][2] = 0;

682 i‡(
£À˘_mëhod
 == 0)

684 
˛i°
=0; cli°<2 + 
li°_off£t
; clist++)

686 
ödex
 = 0; index < 
cuºSli˚
->
li°Xsize
[
˛i°
]; index++)

688 
	`mem˝y
(
p_Vid
->
cuºítSli˚
->
wp_weight
[
˛i°
][
ödex
], 
weight
[clist][index], 3 * ());

689 
	`mem˝y
(
p_Vid
->
cuºítSli˚
->
wp_off£t
[
˛i°
][
ödex
], 
off£t
[clist][index], 3 * ());

695 
˛i°
=0; cli°<2 + 
li°_off£t
; clist++)

697 
ödex
 = 0; index < 
cuºSli˚
->
li°Xsize
[
˛i°
]; index++)

699 
	`mem˝y
(
wp_weight
[
˛i°
][
ödex
], 
deÁu…_weight
, 3 * ());

700 
	`mem£t
(
wp_off£t
[
˛i°
][
ödex
], 0, 3 * ());

705 
i
 = 0; i < 
cuºSli˚
->
li°Xsize
[
LIST_0
]; i++)

707 
j
 = 0; j < 
cuºSli˚
->
li°Xsize
[
LIST_1
]; j++)

709 
comp
 = 0; comp < 3; comp++)

711 
wbp_weight
[0][
i
][
j
][
comp
] = 
wp_weight
[0][i][comp];

712 
wbp_weight
[1][
i
][
j
][
comp
] = 
wp_weight
[1][j][comp];

714 #i‡
DEBUG_WP


715 
	`¥ötf
 ("bpw weight[%d][%d] = %d , %d (%d %d %dË(%d %dË(%d %d)\n", 
i
, 
j
, 
p_Vid
->
cuºítSli˚
->
wbp_weight
[0][i][j][0],Ö_Vid->currentSlice->wbp_weight[1][i][j][0],

716 
p_Vid
->
íc_pi˘uª
->
poc
,
cuºSli˚
->
li°X
[
LIST_0
][
i
]->poc, cuºSli˚->li°X[
LIST_1
][
j
]->poc,

717 
Di°SˇÀFa˘‹
 ,
tx
,tx,tx);

723 i‡(
£À˘_mëhod
 == 0)

725 
a˘ive_ªfs
[2];

727 
a˘ive_ªfs
[0] = (
p_I≈
->
B_Li°0_ªfs
 =0 ? 
cuºSli˚
->
li°Xsize
[0] : 
	`imö
’_I≈->B_Li°0_ªfs[
võw_id
], currSlice->listXsize[0]));

728 
a˘ive_ªfs
[1] = (
p_I≈
->
B_Li°1_ªfs
 =0 ? 
cuºSli˚
->
li°Xsize
[1] : 
	`imö
’_I≈->B_Li°1_ªfs[
võw_id
], currSlice->listXsize[1]));

730 
˛i°
=0; cli°<2 + 
li°_off£t
; clist++)

732 
ödex
 = 0; index < 
a˘ive_ªfs
[
˛i°
]; index++)

734 
comp
=0; comp < 3; comp ++)

736 i‡(
wp_weight
[
˛i°
][
ödex
][
comp
] !
deÁu…_weight
[comp])

738 
≥rf‹m_wp
 = 1;

742 i‡(
≥rf‹m_wp
 == 1) ;

744 i‡(
≥rf‹m_wp
 == 1) ;

747  
≥rf‹m_wp
;

748 
	}
}

750 
	$compuã_off£t
(
Sli˚
 *
cuºSli˚
)

752 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

753 
PicMŸi⁄P¨ams
 **
mŸi⁄
 = 
p_Vid
->
íc_pi˘uª
->
mv_öfo
;

754 
Ma¸oblock
 *
cuºMB
;

755 
i
, 
j
, 
x
, 
y
, 
xj
, 
yi
, 
ãmp
, 
vÆOrg
;

756 
mvx
=0, 
mvy
=0;

757 
ªf_‰ame
=0;

758 
subblock
=0;

759 
x_‹ig
, 
y_‹ig
;

760 
x_pos
, 
y_pos
;

761 
out4Y_width
 = (
p_Vid
->
width
 + 
IMG_PAD_SIZE_X
) * 4 - 1;

762 
out4Y_height
 = (
p_Vid
->
height
 + 
IMG_PAD_SIZE_Y
) * 4 - 1;

764 
‰ame
, 
li°
, 
off£t
;

765 
dãmp
;

766 
numli°s
 = (
p_Vid
->
ty≥
 =
B_SLICE
) ? 2 : 1;

769 
li°
 = 0;Üist < 2;Üist++)

771 
‰ame
 = 0; fømê< 
MAX_REFERENCE_PICTURES
; frame++)

773 
p_Vid
->
‰ameOff£tTŸÆ
[
li°
][
‰ame
] = 0;

774 
p_Vid
->
‰ameOff£tCou¡
[
li°
][
‰ame
] = 0;

779 
i
=0; i<
p_Vid
->
height
 >> 4; i++)

781 
j
=0; j<
p_Vid
->
width
 >> 4; j++)

784 
cuºMB
 = &
p_Vid
->
mb_d©a
[((
i
*p_Vid->
width
Ë>> 4)+
j
];

785 if(
	`is_öåa
(
cuºMB
))

788 
x_‹ig
 = 
MB_BLOCK_SIZE
*
j
;

789 
y_‹ig
 = 
MB_BLOCK_SIZE
*
i
;

791 
subblock
 = 0; subblock < 16; subblock++)

794 
x
 = 
x_‹ig
+4*(
subblock
 & 0x03);

795 
y
 = 
y_‹ig
+4*(
subblock
 >> 2);

796 
mvx
 = 
mŸi⁄
[
y
 >> 2][
x
 >> 2].
mv
[
LIST_0
].
mv_x
;

797 
mvy
 = 
mŸi⁄
[
y
 >> 2][
x
 >> 2].
mv
[
LIST_0
].
mv_y
;

798 
ªf_‰ame
 = 
mŸi⁄
[
y
 >> 2][
x
 >> 2].
ªf_idx
[
LIST_0
];

800 if(
ªf_‰ame
 != -1)

802 
yi
 = 0; yi < 4; yi++)

804 
xj
 = 0; xj < 4; xj++)

806 
vÆOrg
 = 
p_Vid
->
pCurImg
[
y
+
yi
][
x
+
xj
];

809 
y_pos
 = 
	`imax
(-4*
IMG_PAD_SIZE_Y
, 
	`imö
(
out4Y_height
, 4*(
y
+
yi
)+
mvy
));

811 
x_pos
 = 
	`imax
(-4*
IMG_PAD_SIZE_X
, 
	`imö
(
out4Y_width
, 4*(
x
+
xj
)+
mvx
));

813 
ãmp
=
cuºSli˚
->
li°X
[
LIST_0
][
ªf_‰ame
]->
p_cuº_img_sub
[(
y_pos
 & 0x03)][(
x_pos
 & 0x03)][y_pos >> 2][x_pos >> 2];

814 
p_Vid
->
‰ameOff£tTŸÆ
[
LIST_0
][
ªf_‰ame
]+=(
vÆOrg
-
ãmp
);

815 
p_Vid
->
‰ameOff£tCou¡
[
LIST_0
][
ªf_‰ame
]++;

822 
mvx
 = 
mŸi⁄
[
y
 >> 2][
x
 >> 2].
mv
[
LIST_1
].
mv_x
;

823 
mvy
 = 
mŸi⁄
[
y
 >> 2][
x
 >> 2].
mv
[
LIST_1
].
mv_y
;

824 
ªf_‰ame
 = 
mŸi⁄
[
y
 >> 2][
x
 >> 2].
ªf_idx
[
LIST_1
];

825 if(
ªf_‰ame
 != -1)

827 
yi
 = 0; yi < 4; yi++)

829 
xj
 = 0; xj < 4; xj++)

831 
vÆOrg
 = 
p_Vid
->
pCurImg
[
y
+
yi
][
x
+
xj
];

834 
y_pos
 = 
	`imax
(-4*
IMG_PAD_SIZE_Y
, 
	`imö
(
out4Y_height
, 4*(
y
+
yi
Ë+ 
mvy
));

836 
x_pos
 = 
	`imax
(-4*
IMG_PAD_SIZE_X
, 
	`imö
(
out4Y_width
, 4*(
x
+
xj
Ë+ 
mvx
));

838 
ãmp
=
cuºSli˚
->
li°X
[
LIST_0
][
ªf_‰ame
]->
p_cuº_img_sub
[(
y_pos
 & 0x03)][(
x_pos
 & 0x03)][y_pos >> 2][x_pos >> 2];

839 
p_Vid
->
‰ameOff£tTŸÆ
[
LIST_1
][
ªf_‰ame
]+=(
vÆOrg
-
ãmp
);

840 
p_Vid
->
‰ameOff£tCou¡
[
LIST_1
][
ªf_‰ame
]++;

848 
li°
 = 0;Üi° < 
numli°s
;Üist++)

850 
‰ame
 = 0; fømê< 
cuºSli˚
->
li°Xsize
[
li°
]; frame++)

852 
dãmp
=()
p_Vid
->
‰ameOff£tTŸÆ
[
li°
][
‰ame
];

854 i‡(
p_Vid
->
‰ameOff£tCou¡
[
li°
][
‰ame
]>0)

856 
off£t
=()(
	`Ábs
(
dãmp
)/()
p_Vid
->
‰ameOff£tCou¡
[
li°
][
‰ame
]+0.5);

857 i‡(
p_Vid
->
‰ameOff£tTŸÆ
[
li°
][
‰ame
]>=0)

859 
p_Vid
->
‰ameOff£t
[
li°
][
‰ame
] = (Ë
off£t
;

863 
p_Vid
->
‰ameOff£t
[
li°
][
‰ame
] = (Ë-
off£t
;

874 
	}
}

	@lencod/src/wp_mcprec.c

15 
	~"c⁄åibut‹s.h
"

17 
	~"globÆ.h
"

18 
	~"image.h
"

19 
	~"¶i˚.h
"

20 
	~"li°_ª‹dî.h
"

21 
	~"wp_m˝ªc.h
"

22 
	~"memÆloc.h
"

31 
	$wpxInôWPXObje˘
–
VideoP¨amëîs
 *
p_Vid
 )

33 
p_Vid
->
pWPX
 = (
WPXObje˘
 *)
	`mÆloc
( ( WPXObject ) );

34 i‡–
p_Vid
->
pWPX
 =
NULL
 )

36 
	`Ârötf
–
°dîr
, "\n Error initializing memory for WPXObject. Exiting...\n" );

37 
	`exô
(1);

41 i‡((
p_Vid
->
pWPX
->
wp_ªf_li°
[
LIST_0
] = (
WeighãdPªdRefX
 *Ë
	`ˇŒoc
(
MAX_REFERENCE_PICTURES
, (WeighãdPªdRefX))Ë=
NULL
)

42 
	`no_mem_exô
("wpxInitWPXObject:Ö_Vid->pWPX->wp_ref_list[0]");

44 i‡((
p_Vid
->
pWPX
->
wp_ªf_li°
[
LIST_1
] = (
WeighãdPªdRefX
 *Ë
	`ˇŒoc
(
MAX_REFERENCE_PICTURES
, (WeighãdPªdRefX))Ë=
NULL
)

45 
	`no_mem_exô
("wpxInitWPXObject:Ö_Vid->pWPX->wp_ref_list[1]");

46 
	}
}

55 
	$wpxFªeWPXObje˘
–
VideoP¨amëîs
 *
p_Vid
 )

58 i‡(
p_Vid
->
pWPX
->
wp_ªf_li°
[
LIST_0
])

59 
	`‰ì
(
p_Vid
->
pWPX
->
wp_ªf_li°
[
LIST_0
]);

60 
p_Vid
->
pWPX
->
wp_ªf_li°
[
LIST_0
] = 
NULL
;

62 i‡(
p_Vid
->
pWPX
->
wp_ªf_li°
[
LIST_1
])

63 
	`‰ì
(
p_Vid
->
pWPX
->
wp_ªf_li°
[
LIST_1
]);

64 
p_Vid
->
pWPX
->
wp_ªf_li°
[
LIST_1
] = 
NULL
;

66 i‡–
p_Vid
->
pWPX
 !
NULL
 )

68 
	`‰ì
–
p_Vid
->
pWPX
 );

70 
	}
}

79 
	$wpxInôWPXPas£s
–
VideoP¨amëîs
 *
p_Vid
, 
I≈utP¨amëîs
 *
p_I≈
 )

82 
p_Vid
->
pWPX
->
num_wp_ªf_li°
[
LIST_0
] = 0;

83 
p_Vid
->
pWPX
->
num_wp_ªf_li°
[
LIST_1
] = 0;

85  
p_I≈
->
WPMCPªcisi⁄
 )

91 
p_Vid
->
pWPX
->
wp_rd_∑s£s
[0].
Æg‹ôhm
 = 
WP_REGULAR
;

92 
p_Vid
->
pWPX
->
wp_rd_∑s£s
[1].
Æg‹ôhm
 = 
WP_MCPREC_MINUS0
;

95 
p_Vid
->
pWPX
->
wp_rd_∑s£s
[0].
Æg‹ôhm
 = 
WP_REGULAR
;

96 
p_Vid
->
pWPX
->
wp_rd_∑s£s
[1].
Æg‹ôhm
 = 
WP_MCPREC_MINUS0
;

97 
p_Vid
->
pWPX
->
wp_rd_∑s£s
[2].
Æg‹ôhm
 = 
WP_MCPREC_MINUS1
;

100 
	}
}

109 
	$wpxModifyRefPicLi°
–
Sli˚
 *
cuºSli˚
 )

111 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

112 
i
, 
j
, 
˛⁄ed_ªfs
;

113 
deÁu…_‹dî_li°0
[32];

114 
deÁu…_‹dî_li°1
[32];

115 
ª_‹dî
[32], *
li°_‹dî
;

116 
¥ed_li°
;

117 
DecodedPi˘uªBuf„r
 *
p_Dpb
 = 
cuºSli˚
->p_Dpb;

119 
St‹abÀPi˘uª
 **
li°
;

122 
	`mem£t
–(*)
deÁu…_‹dî_li°0
, 1<<20, 32 * ( ) );

123 
	`mem£t
–(*)
deÁu…_‹dî_li°1
, 1<<20, 32 * ( ) );

124 
	`mem£t
–(*)
ª_‹dî
, 1<<20, 32 * ( ) );

127 
li°
 = 
cuºSli˚
->
li°X
[
LIST_0
];

128 
i
=0; i<()(
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
]); i++)

130 
deÁu…_‹dî_li°0
[
i
] = 
li°
[i]->
pic_num
;

132 i‡–
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
 )

134 
li°
 = 
cuºSli˚
->
li°X
[
LIST_1
];

135 
i
=0; i<()(
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_1
]); i++)

137 
deÁu…_‹dî_li°1
[
i
] = 
li°
[i]->
pic_num
;

142 i‡–
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
 )

144 
li°_sign
[32];

145 
poc_diff
[32];

146 
tmp_vÆue
;

147 
abs_poc_di°
;

149 
i
=0; i < 
p_Dpb
->
ªf_‰ames_ö_buf„r
; i++)

151 
ª_‹dî
[
i
] = 
p_Dpb
->
fs_ªf
[i]->
‰ame
->
pic_num
;

152 i‡(
p_Dpb
->
fs_ªf
[
i
]->
is_u£d
==3 && (p_Dpb->fs_ªf[i]->
‰ame
->
u£d_f‹_ª„ªn˚
)&&(!p_Dpb->fs_ªf[i]->‰ame->
is_l⁄g_ãrm
))

154 
abs_poc_di°
 = 
	`übs
(
p_Dpb
->
fs_ªf
[
i
]->
‰ame
->
poc
 - 
p_Vid
->
íc_pi˘uª
->poc) ;

155 
poc_diff
[
i
] = 
abs_poc_di°
;

156 
li°_sign
[
i
] = (
p_Vid
->
íc_pi˘uª
->
poc
 < 
p_Dpb
->
fs_ªf
[i]->
‰ame
->poc) ? +1 : -1;

161 
i
=0; i< 
p_Dpb
->
ªf_‰ames_ö_buf„r
-1; i++)

163 
j
=
i
+1; j< 
p_Dpb
->
ªf_‰ames_ö_buf„r
; j++)

165 i‡(
poc_diff
[
i
]>poc_diff[
j
] || (poc_diff[i] =poc_diff[j] && 
li°_sign
[j] >Üist_sign[i]))

167 
tmp_vÆue
 = 
poc_diff
[
i
];

168 
poc_diff
[
i
] =Öoc_diff[
j
];

169 
poc_diff
[
j
] = 
tmp_vÆue
;

170 
tmp_vÆue
 = 
ª_‹dî
[
i
];

171 
ª_‹dî
[
i
] =Ñe_‹dî[
j
];

172 
ª_‹dî
[
j
] = 
tmp_vÆue
 ;

173 
tmp_vÆue
 = 
li°_sign
[
i
];

174 
li°_sign
[
i
] =Üi°_sign[
j
];

175 
li°_sign
[
j
] = 
tmp_vÆue
 ;

183  
¥ed_li°
 = 0;Öªd_li° < (1 + ( 
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
 ? 1 : 0 ));Öred_list++ )

185 i‡–
¥ed_li°
 =
LIST_0
 )

187 
li°_‹dî
 = (
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
Ë? 
ª_‹dî
 : 
deÁu…_‹dî_li°0
;

191 
li°_‹dî
 = 
deÁu…_‹dî_li°1
;

195  
p_Vid
->
pWPX
->
cuº_wp_rd_∑ss
->
Æg‹ôhm
 )

198 
WP_MCPREC_PLUS0
:

199 
WP_MCPREC_PLUS1
:

200 
WP_MCPREC_MINUS0
:

201 
WP_MCPREC_MINUS1
:

203 
˛⁄ed_ªfs
 = 
p_Vid
->
pWPX
->
num_wp_ªf_li°
[
¥ed_li°
] = 2;

204  
j
 = 0; j < 
˛⁄ed_ªfs
; j++ )

206 
p_Vid
->
pWPX
->
wp_ªf_li°
[
¥ed_li°
][
j
].
PicNum
 = 
li°_‹dî
[0];

209  
j
 = 
˛⁄ed_ªfs
; j < 
p_Dpb
->
ªf_‰ames_ö_buf„r
; j++ )

211 
p_Vid
->
pWPX
->
wp_ªf_li°
[
¥ed_li°
][
j
].
PicNum
 = 
li°_‹dî
[j - (
˛⁄ed_ªfs
 - 1)];

212 
p_Vid
->
pWPX
->
num_wp_ªf_li°
[
¥ed_li°
]++;

215 
WP_MCPREC_MINUS_PLUS0
:

217 
˛⁄ed_ªfs
 = 
p_Vid
->
pWPX
->
num_wp_ªf_li°
[
¥ed_li°
] = 3;

218  
j
 = 0; j < 
˛⁄ed_ªfs
; j++ )

220 
p_Vid
->
pWPX
->
wp_ªf_li°
[
¥ed_li°
][
j
].
PicNum
 = 
li°_‹dî
[0];

223  
j
 = 
˛⁄ed_ªfs
; j < 
p_Dpb
->
ªf_‰ames_ö_buf„r
; j++ )

225 
p_Vid
->
pWPX
->
wp_ªf_li°
[
¥ed_li°
][
j
].
PicNum
 = 
li°_‹dî
[j - (
˛⁄ed_ªfs
 - 1)];

226 
p_Vid
->
pWPX
->
num_wp_ªf_li°
[
¥ed_li°
]++;

231 
p_Vid
->
pWPX
->
num_wp_ªf_li°
[
¥ed_li°
] = 
	`imö
(Ö_Vid->pWPX->num_wp_ref_list[pred_list],

232 –
¥ed_li°
 =
LIST_0
 ) ? 
cuºSli˚
->
num_ªf_idx_a˘ive
[LIST_0] : cuºSli˚->num_ªf_idx_a˘ive[
LIST_1
] );

234 
	}
}

243 
	$wpxDëîmöeWP
–
Sli˚
 *
cuºSli˚
, 
˛i°
, 
n
 )

245 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

246 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºSli˚
->p_Inp;

247 
i
, 
j
, 
dëîmöe_wp
 = 0;

248 
deÁu…_weight
[3];

250 
luma_log_weight_díom
 = 5;

251 
chroma_log_weight_díom
 = 5;

252 
cur_li°
 = 
LIST_0
;

254 
deÁu…_weight
[0] = 1 << 
luma_log_weight_díom
;

255 
deÁu…_weight
[1] = 1 << 
chroma_log_weight_díom
;

256 
deÁu…_weight
[2] = 1 << 
chroma_log_weight_díom
;

258 i‡–!
p_I≈
->
WPMCPªcisi⁄
 )

260 
dëîmöe_wp
 = 1;

264 
dëîmöe_wp
 = 0;

266 i‡–
cuºSli˚
->
¶i˚_ty≥
 =
P_SLICE
 )

268 
i
 = 0; i < 3; i++)

270 
cuºSli˚
->
wp_weight
[
˛i°
][
n
][
i
] = 
deÁu…_weight
[i];

273 i‡–
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
 )

275 
cur_li°
 = ((
˛i°
 & 0x01Ë=
LIST_1
Ë? 
LIST_0
 : LIST_1;

278 
i
 = 0; i < 3; i++)

280 
cuºSli˚
->
wp_weight
[
˛i°
][
n
][
i
] = 
deÁu…_weight
[i];

283 
j
 = 0; j < 
cuºSli˚
->
li°Xsize
[
cur_li°
]; j++)

285 
i
 = 0; i < 3; i++)

286 
cuºSli˚
->
wbp_weight
[
˛i°
][
n
][
j
][
i
] = 
deÁu…_weight
[i];

290  
p_Vid
->
pWPX
->
cuº_wp_rd_∑ss
->
Æg‹ôhm
 )

292 
WP_MCPREC_PLUS0
:

293 
i
 = 0; i < 3; i++)

294 
cuºSli˚
->
wp_off£t
[
˛i°
][
n
][
i
] = (n == 1) ? 1 : 0;

296 
WP_MCPREC_MINUS0
:

297 
i
 = 0; i < 3; i++)

298 
cuºSli˚
->
wp_off£t
[
˛i°
][
n
][
i
] = (n == 1) ? -1 : 0;

300 
WP_MCPREC_PLUS1
:

301 
i
 = 0; i < 3; i++)

302 
cuºSli˚
->
wp_off£t
[
˛i°
][
n
][
i
] = (n == 0) ? 1 : 0;

304 
WP_MCPREC_MINUS1
:

305 
i
 = 0; i < 3; i++)

306 
cuºSli˚
->
wp_off£t
[
˛i°
][
n
][
i
] = (n == 0) ? -1 : 0;

308 
WP_MCPREC_MINUS_PLUS0
:

309 
i
 = 0; i < 3; i++)

310 
cuºSli˚
->
wp_off£t
[
˛i°
][
n
][
i
] = (n == 1) ? -1 : ((n == 2) ? 1 : 0);

313 
WP_REGULAR
:

314 
dëîmöe_wp
 = 1;

318 i‡–
cuºSli˚
->
¶i˚_ty≥
 =
B_SLICE
 && 
cur_li°
 =
LIST_0
 )

320 
i
 = 0; i < 3; i++)

321 
cuºSli˚
->
wp_off£t
[
˛i°
][
n
][
i
] *= 2;

324 
i
 = 1; i < 3; i++)

326 
cuºSli˚
->
wp_off£t
[
˛i°
][
n
][
i
] = 0;

330  
dëîmöe_wp
;

331 
	}
}

340 
	$wpxAd≠tRefNum
–
Sli˚
 *
cuºSli˚
 )

342 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºSli˚
->p_Inp;

343 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

344 #i‡(
MVC_EXTENSION_ENABLE
)

345 
võw_id
 = 
p_Vid
->view_id;

347 
võw_id
 = 0;

350 i‡–
p_Vid
->
pWPX
->
cuº_wp_rd_∑ss
->
Æg‹ôhm
 =
WP_REGULAR
 )

352  
cuºSli˚
->
¶i˚_ty≥
 )

355 
I_SLICE
:

357 
P_SLICE
:

358 i‡–
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
] =–
p_I≈
->
P_Li°0_ªfs
[
võw_id
] * ((cuºSli˚->
°ru˘uª
 !=0) + 1) ) )

360 
cuºSli˚
->
li°Xsize
[
LIST_0
] = cuºSli˚->
num_ªf_idx_a˘ive
[LIST_0] = (Ë
	`imax
–((cuºSli˚->
°ru˘uª
 !=0) + 1), currSlice->num_ref_idx_active[LIST_0] - ((currSlice->structure !=0) + 1) );

363 
B_SLICE
:

364 i‡–
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_0
] =–
p_I≈
->
B_Li°0_ªfs
[
võw_id
] * ((cuºSli˚->
°ru˘uª
 !=0) + 1) ) )

366 
cuºSli˚
->
li°Xsize
[
LIST_0
] = cuºSli˚->
num_ªf_idx_a˘ive
[LIST_0] = (Ë
	`imax
–((cuºSli˚->
°ru˘uª
 !=0) + 1), currSlice->num_ref_idx_active[LIST_0] - ((currSlice->structure !=0) + 1) );

368 i‡–
cuºSli˚
->
num_ªf_idx_a˘ive
[
LIST_1
] =–
p_I≈
->
B_Li°1_ªfs
[
võw_id
] * ((cuºSli˚->
°ru˘uª
 !=0) + 1) ) )

370 
cuºSli˚
->
li°Xsize
[
LIST_1
] = cuºSli˚->
num_ªf_idx_a˘ive
[LIST_1] = (Ë
	`imax
–((cuºSli˚->
°ru˘uª
 !=0) + 1), currSlice->num_ref_idx_active[LIST_1] - ((currSlice->structure !=0) + 1) );

375 
	}
}

	@lencod/src/wp_periodic.c

14 
	~"c⁄åibut‹s.h
"

16 
	~"globÆ.h
"

17 
	~"image.h
"

18 
	~"wp_≥riodic.h
"

19 
	~"wp.h
"

20 
	~<m©h.h
>

22 
	#PI
 3.14159265

	)

31 
	$E°im©eWPPSli˚Pîiodic
(
Sli˚
 *
cuºSli˚
, 
£À˘_off£t
)

33 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

34 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºSli˚
->p_Inp;

36 
n
;

37 
deÁu…_weight
[3];

38 
li°_off£t
 = ((
cuºSli˚
->
mb_aff_‰ame_Êag
Ë&& (
p_Vid
->
mb_d©a
[p_Vid->
cuºít_mb_ƒ
].
mb_fõld
))? (p_Vid->current_mb_nr & 0x01) ? 4 : 2 : 0;

39 
˛i°
;

40 
°¨t_mb
, 
íd_mb
;

41 
comp
;

42 
bôdïth
[3] = { (
p_Vid
->
bôdïth_luma
 - 8), (p_Vid->
bôdïth_chroma
 - 8), (p_Vid->bitdepth_chroma - 8)};

44 
weight
[2][
MAX_REFERENCE_PICTURES
][3];

45 
off£t
[2][
MAX_REFERENCE_PICTURES
][3];

47 
cur_¶i˚
;

48 
cur_weight
, 
cur_off£t
;

50 
cuºSli˚
->
luma_log_weight_díom
 = 5;

51 
cuºSli˚
->
chroma_log_weight_díom
 = 5;

53 
cuºSli˚
->
wp_luma_round
 = 1 << (cuºSli˚->
luma_log_weight_díom
 - 1);

54 
cuºSli˚
->
wp_chroma_round
 = 1 << (cuºSli˚->
chroma_log_weight_díom
 - 1);

55 
deÁu…_weight
[0] = 1 << 
cuºSli˚
->
luma_log_weight_díom
;

56 
deÁu…_weight
[1] = deÁu…_weight[2] = 1 << 
cuºSli˚
->
chroma_log_weight_díom
;

59 if(
p_I≈
->
¶i˚_mode
 == 1)

61 
cur_¶i˚
 = 
p_Vid
->
cuºít_mb_ƒ
 / 
p_I≈
->
¶i˚_¨gumít
;

64 
cur_¶i˚
 = 0;

67 if(
p_I≈
->
¶i˚_mode
 == 1)

69 
°¨t_mb
 = 
cur_¶i˚
 * 
p_I≈
->
¶i˚_¨gumít
;

70 
íd_mb
 = 
°¨t_mb
 + 
p_I≈
->
¶i˚_¨gumít
;

71 if(
íd_mb
 > ()
p_Vid
->
FømeSizeInMbs
)

72 
íd_mb
 = 
p_Vid
->
FømeSizeInMbs
;

76 
°¨t_mb
 = 0;

77 
íd_mb
 = 
p_Vid
->
FømeSizeInMbs
;

80 
˛i°
 = 0; cli° < 2 + 
li°_off£t
; clist++)

82 
n
 = 0;Ç < 
cuºSli˚
->
li°Xsize
[
˛i°
];Ç++)

84 
comp
=0; comp < 3; comp ++)

86 
cur_weight
 = (Ë((127.0 * 
	`cos
 (
p_Vid
->
numbî
 *
PI
 / 30)Ë+ (4.0 * (((Ë
	`ønd
()Ë/ 
RAND_MAX
)) - 4.0);

87 
weight
[
˛i°
][
n
][
comp
] = 
	`sClù3
(-128, 127, 
cur_weight
);

88 
cur_off£t
 = (Ë((127.0 * 
	`cos
 ((
p_Vid
->
numbî
 + 15Ë* 
PI
 / 45)Ë+ (4.0 * (((Ë
	`ønd
()Ë/ 
RAND_MAX
)) - 4.0);

89 
off£t
[
˛i°
][
n
][
comp
] = (
	`sClù3
(-128, 127, 
cur_off£t
Ë<< 
bôdïth
[comp]);

94 
˛i°
 = 0; cli° < 2 + 
li°_off£t
; clist++)

96 
n
 = 0;Ç < 
cuºSli˚
->
li°Xsize
[
˛i°
];Ç++)

98 
comp
=0; comp < 3; comp ++)

100 
cuºSli˚
->
wp_weight
[
˛i°
][
n
][
comp
] = 
weight
[clist][n][comp];

101 
cuºSli˚
->
wp_off£t
[
˛i°
][
n
][
comp
] = 
off£t
[clist][n][comp];

102 if(
p_Vid
->
wp_weights
)

103 
p_Vid
->
wp_weights
[
comp
][
˛i°
][
n
][
cur_¶i˚
] = 
weight
[clist][n][comp];

104 if(
p_Vid
->
wp_off£ts
)

105 
p_Vid
->
wp_off£ts
[
comp
][
˛i°
][
n
][
cur_¶i˚
] = 
off£t
[clist][n][comp];

107 #i‡
DEBUG_WP


108 
comp
 = 0; comp < 3; comp++)

109 
	`¥ötf
("¶i˚ %d: index %d comp⁄íà%d weighà%d off£à%d\n", 
cur_¶i˚
, 
n
,
comp
,
cuºSli˚
->
wp_weight
[
˛i°
][n][comp],cuºSli˚->
wp_off£t
[clist][n][comp]);

113 
	}
}

121 
	$E°im©eWPBSli˚Pîiodic
(
Sli˚
 *
cuºSli˚
)

123 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

124 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºSli˚
->p_Inp;

125 
i
, 
j
, 
n
;

127 
comp
;

128 
k
;

130 
deÁu…_weight
[3];

131 
li°_off£t
 = ((
cuºSli˚
->
mb_aff_‰ame_Êag
Ë&& (
p_Vid
->
mb_d©a
[p_Vid->
cuºít_mb_ƒ
].
mb_fõld
))? (p_Vid->current_mb_nr & 0x01) ? 4 : 2 : 0;

132 
˛i°
;

133 
cur_¶i˚
 = 0;

134 
cur_weight
, 
cur_off£t
;

135 
bôdïth
[3] = { (
p_Vid
->
bôdïth_luma
 - 8), (p_Vid->
bôdïth_chroma
 - 8), (p_Vid->bitdepth_chroma - 8)};

137 i‡(
p_Vid
->
a˘ive_µs
->
weighãd_bùªd_idc
 == 2)

139 
cuºSli˚
->
luma_log_weight_díom
 = 5;

140 
cuºSli˚
->
chroma_log_weight_díom
 = 5;

144 
cuºSli˚
->
luma_log_weight_díom
 = 5;

145 
cuºSli˚
->
chroma_log_weight_díom
 = 5;

148 
cuºSli˚
->
wp_luma_round
 = 1 << (cuºSli˚->
luma_log_weight_díom
 - 1);

149 
cuºSli˚
->
wp_chroma_round
 = 1 << (cuºSli˚->
chroma_log_weight_díom
 - 1);

150 
deÁu…_weight
[0] = 1 << 
cuºSli˚
->
luma_log_weight_díom
;

151 
deÁu…_weight
[1] = 1 << 
cuºSli˚
->
chroma_log_weight_díom
;

152 
deÁu…_weight
[2] = 1 << 
cuºSli˚
->
chroma_log_weight_díom
;

155 if(
p_I≈
->
¶i˚_mode
 == 1)

157 
cur_¶i˚
 = 
p_Vid
->
cuºít_mb_ƒ
 / 
p_I≈
->
¶i˚_¨gumít
 ;

160 
cur_¶i˚
 = 0;

162 i‡(
p_Vid
->
a˘ive_µs
->
weighãd_bùªd_idc
 == 2)

164 
im_weight
[6][
MAX_REFERENCE_PICTURES
][MAX_REFERENCE_PICTURES][3];

166 
	`CompuãIm∂icôWeights
(
cuºSli˚
, 
deÁu…_weight
, 
im_weight
);

168 
k
 = 0; k < 2; k++)

170 
i
 = 0; i < 
cuºSli˚
->
li°Xsize
[
LIST_0
]; i++)

172 
j
 = 0; j < 
cuºSli˚
->
li°Xsize
[
LIST_1
]; j++)

174 
comp
 = 0; comp < 3; comp++)

176 
cuºSli˚
->
wbp_weight
[
k
][
i
][
j
][
comp
] = 
im_weight
[k][i][j][comp];

182 
˛i°
=0; cli°<2 + 
li°_off£t
; clist++)

184 
i
 = 0; i < 
cuºSli˚
->
li°Xsize
[
˛i°
]; i++)

186 
comp
 = 0; comp < 3; comp++)

188 
cuºSli˚
->
wp_weight
[
˛i°
][
i
][
comp
] = 
deÁu…_weight
[comp];

189 
cuºSli˚
->
wp_off£t
[
˛i°
][
i
][
comp
] = 0;

196 
°¨t_mb
, 
íd_mb
;

198 
comp
;

200 
wp_weight
[6][
MAX_REFERENCE_PICTURES
][3];

201 
wp_off£t
[6][
MAX_REFERENCE_PICTURES
][3];

203 if(
p_I≈
->
¶i˚_mode
 == 1)

205 
°¨t_mb
 = 
cur_¶i˚
 * 
p_I≈
->
¶i˚_¨gumít
;

206 
íd_mb
 = 
°¨t_mb
 + 
p_I≈
->
¶i˚_¨gumít
;

207 if(
íd_mb
 > ()
p_Vid
->
FømeSizeInMbs
)

208 
íd_mb
 = 
p_Vid
->
FømeSizeInMbs
;

212 
°¨t_mb
 = 0;

213 
íd_mb
 = 
p_Vid
->
FømeSizeInMbs
;

216 
˛i°
 = 0; cli° < 2 + 
li°_off£t
; clist++)

218 
n
 = 0;Ç < 
cuºSli˚
->
li°Xsize
[
˛i°
];Ç++)

220 
comp
 = 0; comp < 3; comp ++)

222 
cur_weight
 = (Ë((127.0 * 
	`cos
 (
p_Vid
->
numbî
 *
PI
 / 30)Ë+ (4.0 * (((Ë
	`ønd
()Ë/ 
RAND_MAX
)) - 4.0);

223 
wp_weight
[
˛i°
][
n
][
comp
] = 
	`sClù3
(-128, 127, 
cur_weight
);

224 
cur_off£t
 = (Ë((127.0 * 
	`cos
 ((
p_Vid
->
numbî
 + 45Ë* 
PI
 / 45)Ë+ (4.0 * (((Ë
	`ønd
()Ë/ 
RAND_MAX
)) - 4.0);

225 
wp_off£t
[
˛i°
][
n
][
comp
] = (
	`sClù3
(-128, 127, 
cur_off£t
Ë<< 
bôdïth
[comp]);

236 
˛i°
=0; cli°<2 + 
li°_off£t
; clist++)

238 
n
 = 0;Ç < 
cuºSli˚
->
li°Xsize
[
˛i°
];Ç++)

240 
comp
=0; comp < 3; comp ++)

242 
cuºSli˚
->
wp_weight
[
˛i°
][
n
][
comp
] = wp_weight[clist][n][comp];

243 
cuºSli˚
->
wp_off£t
[
˛i°
][
n
][
comp
] = wp_offset[clist][n][comp];

244 if(
p_Vid
->
wp_weights
)

245 
p_Vid
->
wp_weights
[
comp
][
˛i°
][
n
][
cur_¶i˚
] = 
wp_weight
[clist][n][comp];

246 if(
p_Vid
->
wp_off£ts
)

247 
p_Vid
->
wp_off£ts
[
comp
][
˛i°
][
n
][
cur_¶i˚
] = 
wp_off£t
[clist][n][comp];

258 
i
 = 0; i < 
cuºSli˚
->
li°Xsize
[
LIST_0
]; i++)

260 
j
 = 0; j < 
cuºSli˚
->
li°Xsize
[
LIST_1
]; j++)

262 
comp
 = 0; comp < 3; comp++)

264 
cuºSli˚
->
wbp_weight
[0][
i
][
j
][
comp
] = cuºSli˚->
wp_weight
[0][i][comp];

265 
cuºSli˚
->
wbp_weight
[1][
i
][
j
][
comp
] = cuºSli˚->
wp_weight
[1][j][comp];

276 
	}
}

285 
	$Te°WPPSli˚Pîiodic
(
Sli˚
 *
cuºSli˚
, 
£À˘_off£t
)

287 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

288 
p_Vid
->
wp_∑ømëîs_£t
 = 1;

291 
	}
}

301 
	$Te°WPBSli˚Pîiodic
(
Sli˚
 *
cuºSli˚
, 
£À˘_mëhod
)

303 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

304 
p_Vid
->
wp_∑ømëîs_£t
 = 1;

307 
	}
}

	@lencod/src/wp_random.c

14 
	~"c⁄åibut‹s.h
"

16 
	~"globÆ.h
"

17 
	~"image.h
"

18 
	~"wp_øndom.h
"

19 
	~"wp.h
"

28 
	$E°im©eWPPSli˚R™dom
(
Sli˚
 *
cuºSli˚
, 
£À˘_off£t
)

30 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

31 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºSli˚
->p_Inp;

33 
n
;

34 
deÁu…_weight
[3];

35 
li°_off£t
 = ((
cuºSli˚
->
mb_aff_‰ame_Êag
Ë&& (
p_Vid
->
mb_d©a
[p_Vid->
cuºít_mb_ƒ
].
mb_fõld
))? (p_Vid->current_mb_nr & 0x01) ? 4 : 2 : 0;

36 
˛i°
;

37 
°¨t_mb
, 
íd_mb
;

38 
comp
;

39 
bôdïth
[3] = { (
p_Vid
->
bôdïth_luma
 - 8), (p_Vid->
bôdïth_chroma
 - 8), (p_Vid->bitdepth_chroma - 8)};

41 
weight
[2][
MAX_REFERENCE_PICTURES
][3];

42 
off£t
[2][
MAX_REFERENCE_PICTURES
][3];

44 
cur_¶i˚
;

45 
cur_weight
, 
cur_off£t
;

47 
cuºSli˚
->
luma_log_weight_díom
 = 5;

48 
cuºSli˚
->
chroma_log_weight_díom
 = 5;

50 
cuºSli˚
->
wp_luma_round
 = 1 << (cuºSli˚->
luma_log_weight_díom
 - 1);

51 
cuºSli˚
->
wp_chroma_round
 = 1 << (cuºSli˚->
chroma_log_weight_díom
 - 1);

52 
deÁu…_weight
[0] = 1 << 
cuºSli˚
->
luma_log_weight_díom
;

53 
deÁu…_weight
[1] = deÁu…_weight[2] = 1 << 
cuºSli˚
->
chroma_log_weight_díom
;

56 if(
p_I≈
->
¶i˚_mode
 == 1)

58 
cur_¶i˚
 = 
p_Vid
->
cuºít_mb_ƒ
 / 
p_I≈
->
¶i˚_¨gumít
;

61 
cur_¶i˚
 = 0;

64 if(
p_I≈
->
¶i˚_mode
 == 1)

66 
°¨t_mb
 = 
cur_¶i˚
 * 
p_I≈
->
¶i˚_¨gumít
;

67 
íd_mb
 = 
°¨t_mb
 + 
p_I≈
->
¶i˚_¨gumít
;

68 if(
íd_mb
 > ()
p_Vid
->
FømeSizeInMbs
)

69 
íd_mb
 = 
p_Vid
->
FømeSizeInMbs
;

73 
°¨t_mb
 = 0;

74 
íd_mb
 = 
p_Vid
->
FømeSizeInMbs
;

77 
˛i°
 = 0; cli° < 2 + 
li°_off£t
; clist++)

79 
n
 = 0;Ç < 
cuºSli˚
->
li°Xsize
[
˛i°
];Ç++)

81 
comp
=0; comp < 3; comp ++)

83 
cur_weight
 = ((Ë(255.0 * (((Ë
	`ønd
()Ë/ 
RAND_MAX
))) - 128;

84 
weight
[
˛i°
][
n
][
comp
] = 
	`sClù3
(-128, 127, 
cur_weight
);

85 
cur_off£t
 = ((Ë(255.0 * (((Ë
	`ønd
()Ë/ 
RAND_MAX
))) - 128;

86 
off£t
[
˛i°
][
n
][
comp
] = (
	`sClù3
(-128, 127, 
cur_off£t
Ë<< 
bôdïth
[comp]);

91 
˛i°
 = 0; cli° < 2 + 
li°_off£t
; clist++)

93 
n
 = 0;Ç < 
cuºSli˚
->
li°Xsize
[
˛i°
];Ç++)

95 
comp
=0; comp < 3; comp ++)

97 
cuºSli˚
->
wp_weight
[
˛i°
][
n
][
comp
] = 
weight
[clist][n][comp];

98 
cuºSli˚
->
wp_off£t
[
˛i°
][
n
][
comp
] = 
off£t
[clist][n][comp];

99 if(
p_Vid
->
wp_weights
)

100 
p_Vid
->
wp_weights
[
comp
][
˛i°
][
n
][
cur_¶i˚
] = 
weight
[clist][n][comp];

101 if(
p_Vid
->
wp_off£ts
)

102 
p_Vid
->
wp_off£ts
[
comp
][
˛i°
][
n
][
cur_¶i˚
] = 
off£t
[clist][n][comp];

104 #i‡
DEBUG_WP


105 
comp
 = 0; comp < 3; comp++)

106 
	`¥ötf
("¶i˚ %d: index %d comp⁄íà%d weighà%d off£à%d\n", 
cur_¶i˚
, 
n
,
comp
,
cuºSli˚
->
wp_weight
[
˛i°
][n][comp],cuºSli˚->
wp_off£t
[clist][n][comp]);

110 
	}
}

118 
	$E°im©eWPBSli˚R™dom
(
Sli˚
 *
cuºSli˚
)

120 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

121 
I≈utP¨amëîs
 *
p_I≈
 = 
cuºSli˚
->p_Inp;

122 
i
, 
j
, 
n
;

124 
comp
;

125 
k
;

127 
deÁu…_weight
[3];

128 
li°_off£t
 = ((
cuºSli˚
->
mb_aff_‰ame_Êag
Ë&& (
p_Vid
->
mb_d©a
[p_Vid->
cuºít_mb_ƒ
].
mb_fõld
))? (p_Vid->current_mb_nr & 0x01) ? 4 : 2 : 0;

129 
˛i°
;

130 
cur_¶i˚
 = 0;

131 
cur_weight
, 
cur_off£t
;

132 
bôdïth
[3] = { (
p_Vid
->
bôdïth_luma
 - 8), (p_Vid->
bôdïth_chroma
 - 8), (p_Vid->bitdepth_chroma - 8)};

134 i‡(
p_Vid
->
a˘ive_µs
->
weighãd_bùªd_idc
 == 2)

136 
cuºSli˚
->
luma_log_weight_díom
 = 5;

137 
cuºSli˚
->
chroma_log_weight_díom
 = 5;

141 
cuºSli˚
->
luma_log_weight_díom
 = 5;

142 
cuºSli˚
->
chroma_log_weight_díom
 = 5;

145 
cuºSli˚
->
wp_luma_round
 = 1 << (cuºSli˚->
luma_log_weight_díom
 - 1);

146 
cuºSli˚
->
wp_chroma_round
 = 1 << (cuºSli˚->
chroma_log_weight_díom
 - 1);

147 
deÁu…_weight
[0] = 1 << 
cuºSli˚
->
luma_log_weight_díom
;

148 
deÁu…_weight
[1] = 1 << 
cuºSli˚
->
chroma_log_weight_díom
;

149 
deÁu…_weight
[2] = 1 << 
cuºSli˚
->
chroma_log_weight_díom
;

152 if(
p_I≈
->
¶i˚_mode
 == 1)

154 
cur_¶i˚
 = 
p_Vid
->
cuºít_mb_ƒ
 / 
p_I≈
->
¶i˚_¨gumít
 ;

157 
cur_¶i˚
 = 0;

159 i‡(
p_Vid
->
a˘ive_µs
->
weighãd_bùªd_idc
 == 2)

161 
im_weight
[6][
MAX_REFERENCE_PICTURES
][MAX_REFERENCE_PICTURES][3];

163 
	`CompuãIm∂icôWeights
(
cuºSli˚
, 
deÁu…_weight
, 
im_weight
);

165 
k
 = 0; k < 2; k++)

167 
i
 = 0; i < 
cuºSli˚
->
li°Xsize
[
LIST_0
]; i++)

169 
j
 = 0; j < 
cuºSli˚
->
li°Xsize
[
LIST_1
]; j++)

171 
comp
 = 0; comp < 3; comp++)

173 
cuºSli˚
->
wbp_weight
[
k
][
i
][
j
][
comp
] = 
im_weight
[k][i][j][comp];

179 
˛i°
=0; cli°<2 + 
li°_off£t
; clist++)

181 
i
 = 0; i < 
cuºSli˚
->
li°Xsize
[
˛i°
]; i++)

183 
comp
 = 0; comp < 3; comp++)

185 
cuºSli˚
->
wp_weight
[
˛i°
][
i
][
comp
] = 
deÁu…_weight
[comp];

186 
cuºSli˚
->
wp_off£t
[
˛i°
][
i
][
comp
] = 0;

193 
°¨t_mb
, 
íd_mb
;

195 
comp
;

197 
wp_weight
[6][
MAX_REFERENCE_PICTURES
][3];

198 
wp_off£t
[6][
MAX_REFERENCE_PICTURES
][3];

200 if(
p_I≈
->
¶i˚_mode
 == 1)

202 
°¨t_mb
 = 
cur_¶i˚
 * 
p_I≈
->
¶i˚_¨gumít
;

203 
íd_mb
 = 
°¨t_mb
 + 
p_I≈
->
¶i˚_¨gumít
;

204 if(
íd_mb
 > ()
p_Vid
->
FømeSizeInMbs
)

205 
íd_mb
 = 
p_Vid
->
FømeSizeInMbs
;

209 
°¨t_mb
 = 0;

210 
íd_mb
 = 
p_Vid
->
FømeSizeInMbs
;

213 
˛i°
=0; cli°<2 + 
li°_off£t
; clist++)

215 
n
 = 0;Ç < 
cuºSli˚
->
li°Xsize
[
˛i°
];Ç++)

217 
comp
=0; comp < 3; comp ++)

219 
cur_weight
 = ((Ë(255.0 * (((Ë
	`ønd
()Ë/ 
RAND_MAX
))) - 128;

220 
wp_weight
[
˛i°
][
n
][
comp
] = 
	`sClù3
(-128, 127, 
cur_weight
);

221 
cur_off£t
 = ((Ë(255.0 * (((Ë
	`ønd
()Ë/ 
RAND_MAX
))) - 128;

222 
wp_off£t
[
˛i°
][
n
][
comp
] = (
	`sClù3
(-128, 127, 
cur_off£t
Ë<< 
bôdïth
[comp]);

231 
˛i°
=0; cli°<2 + 
li°_off£t
; clist++)

233 
n
 = 0;Ç < 
cuºSli˚
->
li°Xsize
[
˛i°
];Ç++)

235 
comp
=0; comp < 3; comp ++)

237 
cuºSli˚
->
wp_weight
[
˛i°
][
n
][
comp
] = wp_weight[clist][n][comp];

238 
cuºSli˚
->
wp_off£t
[
˛i°
][
n
][
comp
] = wp_offset[clist][n][comp];

239 if(
p_Vid
->
wp_weights
)

240 
p_Vid
->
wp_weights
[
comp
][
˛i°
][
n
][
cur_¶i˚
] = 
wp_weight
[clist][n][comp];

241 if(
p_Vid
->
wp_off£ts
)

242 
p_Vid
->
wp_off£ts
[
comp
][
˛i°
][
n
][
cur_¶i˚
] = 
wp_off£t
[clist][n][comp];

247 i‡(
p_Vid
->
a˘ive_µs
->
weighãd_bùªd_idc
 != 1)

249 
˛i°
=0; cli°<2 + 
li°_off£t
; clist++)

251 
n
 = 0;Ç < 
cuºSli˚
->
li°Xsize
[
˛i°
];Ç++)

253 
	`mem˝y
(
cuºSli˚
->
wp_weight
[
˛i°
][
n
], 
deÁu…_weight
, 3 * ());

254 
	`mem£t
(
cuºSli˚
->
wp_off£t
[
˛i°
][
n
], 0, 3 * ());

259 
i
 = 0; i < 
cuºSli˚
->
li°Xsize
[
LIST_0
]; i++)

261 
j
 = 0; j < 
cuºSli˚
->
li°Xsize
[
LIST_1
]; j++)

263 
comp
 = 0; comp < 3; comp++)

265 
cuºSli˚
->
wbp_weight
[0][
i
][
j
][
comp
] = cuºSli˚->
wp_weight
[0][i][comp];

266 
cuºSli˚
->
wbp_weight
[1][
i
][
j
][
comp
] = cuºSli˚->
wp_weight
[1][j][comp];

271 
	}
}

280 
	$Te°WPPSli˚R™dom
(
Sli˚
 *
cuºSli˚
, 
£À˘_off£t
)

282 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

283 
p_Vid
->
wp_∑ømëîs_£t
 = 1;

286 
	}
}

296 
	$Te°WPBSli˚R™dom
(
Sli˚
 *
cuºSli˚
, 
£À˘_mëhod
)

298 
VideoP¨amëîs
 *
p_Vid
 = 
cuºSli˚
->p_Vid;

299 
p_Vid
->
wp_∑ømëîs_£t
 = 1;

302 
	}
}

	@rtp_loss/rtp_loss.cpp

4 
	~<°dio.h
>

5 
	~<°dlib.h
>

6 
	~<mem‹y.h
>

7 #ifde‡
WIN32


8 
	~<Wösock2.h
>

10 
	~<√töë/ö.h
>

13 
	$¥öt_ußge
(*
¨gv
 [])

15 
	`¥ötf
 ("Ußge: %†öput_fûêouçut_fûêloss_≥r˚¡ <kìp_Àadög_∑ckës>\n", 
¨gv
[0]);

16 
	`exô
 (-1);

17 
	}
}

19 
	$kìp_∑ckë
(
loss_≥r˚¡
)

21 
∫d
;

22 i‡(
loss_≥r˚¡
>100)

24 i‡(
loss_≥r˚¡
<=0)

27 
∫d
 = (100 * (((Ë
	`ønd
()Ë/ 
RAND_MAX
));

29  (
∫d
 >
loss_≥r˚¡
 );

30 
	}
}

32 
	$maö
(
¨gc
, * 
¨gv
[])

34 
bufsize
, 
∑˙o
=0;

35 
buf
[65000];

36 
i
, 
ötime
;

37 
FILE
 *
‰
;

38 
FILE
 *
fw
;

41 i‡((
¨gc
 != 4) && (argc != 5))

43 
	`¥öt_ußge
 (
¨gv
);

46 i‡(
NULL
 =(
‰
 = 
	`f›í
 (
¨gv
[1], "rb")))

48 
	`¥ötf
 ("%s: c™nŸ o≥¿H.264Öackë fûê%†f‹Ñódög\n", 
¨gv
[0],árgv[1]);

52 i‡(
NULL
 =(
fw
 = 
	`f›í
 (
¨gv
[2], "wb")))

54 
	`¥ötf
 ("%s: c™nŸ o≥¿H.264Öackë fûê%†f‹Ñódög\n", 
¨gv
[0],árgv[1]);

55 
	`f˛o£
 (
‰
);

60 i‡(
¨gc
==5)

62 
i
=0; i< 
	`©oi
 (
¨gv
[4]); i++)

64 i‡(4 !
	`‰ód
 (&
bufsize
, 1, 4, 
‰
))

66 i‡(4 !
	`‰ód
 (&
ötime
, 1, 4, 
‰
))

68 
	`¥ötf
 ("Panic, cannotÑeadÅimestamp, old software version file?\n");

71 i‡(
bufsize
 !
	`‰ód
 (
buf
, 1, bufsize, 
‰
))

73 
	`¥ötf
 ("Problems whileÑeading buffer,Éxit\n");

77 i‡(4 !
	`fwrôe
 (&
bufsize
, 1, 4, 
fw
))

79 
	`¥ötf
 ("Problems while writing buffer size,Éxit\n");

82 i‡(4 !
	`fwrôe
 (&
ötime
, 1, 4, 
fw
))

84 
	`¥ötf
 ("Problems while writingÅimestamp,Éxit\n");

87 i‡(
bufsize
 !
	`fwrôe
 (
buf
, 1, bufsize, 
fw
))

89 
	`¥ötf
 ("Problems while writing buffer,Éxit\n");

92 
∑˙o
++;

99 i‡(4 !
	`‰ód
 (&
bufsize
, 1, 4, 
‰
))

101 i‡(4 !
	`‰ód
 (&
ötime
, 1, 4, 
‰
))

103 
	`¥ötf
 ("Panic, cannotÑeadÅimestamp, old software version file?\n");

106 i‡(
bufsize
 !
	`‰ód
 (
buf
, 1, bufsize, 
‰
))

108 
	`¥ötf
 ("Problems whileÑeading buffer,Éxit\n");

111 i‡(
	`kìp_∑ckë
(
	`©oi
 (
¨gv
[3])))

113 i‡(4 !
	`fwrôe
 (&
bufsize
, 1, 4, 
fw
))

115 
	`¥ötf
 ("Problems while writing buffer size,Éxit\n");

118 i‡(4 !
	`fwrôe
 (&
ötime
, 1, 4, 
fw
))

120 
	`¥ötf
 ("Problems while writingÅimestamp,Éxit\n");

123 i‡(
bufsize
 !
	`fwrôe
 (
buf
, 1, bufsize, 
fw
))

125 
	`¥ötf
 ("Problems while writing buffer,Éxit\n");

131 
	`¥ötf
 ("lo°Öackë #%d\n", 
∑˙o
);

133 
∑˙o
++;

136 
	}
}

	@rtp_loss/rtp_loss.h

	@rtpdump/rtpdump.cpp

5 
	~<°dio.h
>

6 
	~<°dlib.h
>

7 
	~<mem‹y.h
>

8 #i‡
deföed
(
WIN32
Ë|| deföed(
WIN64
)

9 
	~<Wösock2.h
>

11 
	~<√töë/ö.h
>

15 
	$maö
(
¨gc
, * 
¨gv
[])

17 
bufsize
, 
∑˙o
=0, 
ãmp32
;

18 
ãmp16
;

19 
buf
[65000];

20 
i
, 
ötime
;

21 
FILE
 *
f
;

23 i‡(
¨gc
 != 2)

25 
	`¥ötf
 ("Ußge: %†<H.264 RTPÖackë fûe>\n", 
¨gv
[0]);

29 i‡(
NULL
 =(
f
 = 
	`f›í
 (
¨gv
[1], "rb")))

31 
	`¥ötf
 ("%s: c™nŸ o≥¿H.264Öackë fûê%†f‹Ñódög\n", 
¨gv
[0],árgv[1]);

37 i‡(4 !
	`‰ód
 (&
bufsize
, 1, 4, 
f
))

40 i‡(4 !
	`‰ód
 (&
ötime
, 1, 4, 
f
))

42 
	`¥ötf
 ("Panic, cannotÑeadÅimestamp, old software version file?\n");

45 
	`¥ötf
 ("\n\≈ackë #%4d c⁄èöög %5d byãs\n", 
∑˙o
++, 
bufsize
);

46 i‡(
bufsize
 !
	`‰ód
 (
buf
, 1, bufsize, 
f
))

48 
	`¥ötf
 ("Problems whileÑeading buffer,Éxit\n");

52 
i
=0; i< 25; i++)

53 
	`¥ötf
 ("%02x ", 
buf
[
i
]);

55 
	`¥ötf
 ("\n");

56 
	`¥ötf
 ("Vîsi⁄ (V): %d\n", (
buf
[0] >> 6) & 0x03);

57 
	`¥ötf
 ("Paddög (P): %d\n", (
buf
[0] >> 5) & 0x01);

58 
	`¥ötf
 ("Exãnsi⁄ (X): %d\n", (
buf
[0] >> 4) & 0x01);

59 
	`¥ötf
 ("CSRC cou¡ (CC): %d\n", (
buf
[0] >> 0) & 0x0F);

60 
	`¥ötf
 ("M¨kî bô (M): %d\n", (
buf
[1] >> 7) & 0x01);

61 
	`¥ötf
 ("Paylﬂd Ty≥ (PT): %d\n", (
buf
[1] >> 0) & 0x7F);

62 
	`mem˝y
 (&
ãmp16
, &
buf
[2], 2);

63 
	`¥ötf
 ("Sequí˚ Numbî: %d\n", 
	`¡ohs
(
ãmp16
));

64 
	`mem˝y
 (&
ãmp32
, &
buf
[4], 4);

65 
	`¥ötf
 ("Time°amp: %d\n", 
	`¡ohl
(
ãmp32
));

66 
	`mem˝y
 (&
ãmp32
, &
buf
[8], 4);

67 
	`¥ötf
 ("SSRC: %d\n", 
	`¡ohl
(
ãmp32
));

69 
	`¥ötf
 ("Fú° Byã: 0x%x\n", 
buf
[12]);

71 
	}
}

	@
1
.
0
344
8322
lcommon/inc/blk_prediction.h
lcommon/inc/config_common.h
lcommon/inc/ctx_tables.h
lcommon/inc/distortion.h
lcommon/inc/enc_statistics.h
lcommon/inc/fast_memory.h
lcommon/inc/frame.h
lcommon/inc/ifunctions.h
lcommon/inc/img_io.h
lcommon/inc/img_process.h
lcommon/inc/img_process_types.h
lcommon/inc/input.h
lcommon/inc/io_image.h
lcommon/inc/io_raw.h
lcommon/inc/io_tiff.h
lcommon/inc/io_video.h
lcommon/inc/lagrangian.h
lcommon/inc/mb_access.h
lcommon/inc/mbuffer_common.h
lcommon/inc/memalloc.h
lcommon/inc/mv_prediction.h
lcommon/inc/nalucommon.h
lcommon/inc/parsetcommon.h
lcommon/inc/quant_params.h
lcommon/inc/report.h
lcommon/inc/transform.h
lcommon/inc/typedefs.h
lcommon/inc/types.h
lcommon/inc/vui_params.h
lcommon/inc/win32.h
lcommon/src/blk_prediction.c
lcommon/src/config_common.c
lcommon/src/img_io.c
lcommon/src/img_process.c
lcommon/src/input.c
lcommon/src/io_raw.c
lcommon/src/io_tiff.c
lcommon/src/mbuffer_common.c
lcommon/src/memalloc.c
lcommon/src/mv_prediction.c
lcommon/src/nalucommon.c
lcommon/src/parsetcommon.c
lcommon/src/transform.c
lcommon/src/win32.c
ldecod/inc/annexb.h
ldecod/inc/biaridecod.h
ldecod/inc/block.h
ldecod/inc/cabac.h
ldecod/inc/configfile.h
ldecod/inc/context_ini.h
ldecod/inc/contributors.h
ldecod/inc/dec_statistics.h
ldecod/inc/defines.h
ldecod/inc/elements.h
ldecod/inc/erc_api.h
ldecod/inc/erc_do.h
ldecod/inc/erc_globals.h
ldecod/inc/errorconcealment.h
ldecod/inc/filehandle.h
ldecod/inc/fmo.h
ldecod/inc/global.h
ldecod/inc/h264decoder.h
ldecod/inc/header.h
ldecod/inc/image.h
ldecod/inc/intra16x16_pred.h
ldecod/inc/intra4x4_pred.h
ldecod/inc/intra8x8_pred.h
ldecod/inc/leaky_bucket.h
ldecod/inc/loop_filter.h
ldecod/inc/loopfilter.h
ldecod/inc/macroblock.h
ldecod/inc/mb_prediction.h
ldecod/inc/mbuffer.h
ldecod/inc/mbuffer_mvc.h
ldecod/inc/mc_prediction.h
ldecod/inc/nalu.h
ldecod/inc/output.h
ldecod/inc/parset.h
ldecod/inc/quant.h
ldecod/inc/rtp.h
ldecod/inc/sei.h
ldecod/inc/transform8x8.h
ldecod/inc/vlc.h
ldecod/src/annexb.c
ldecod/src/biaridecod.c
ldecod/src/block.c
ldecod/src/cabac.c
ldecod/src/configfile.c
ldecod/src/context_ini.c
ldecod/src/dec_statistics.c
ldecod/src/decoder_test.c
ldecod/src/erc_api.c
ldecod/src/erc_do_i.c
ldecod/src/erc_do_p.c
ldecod/src/errorconcealment.c
ldecod/src/filehandle.c
ldecod/src/fmo.c
ldecod/src/header.c
ldecod/src/image.c
ldecod/src/intra16x16_pred.c
ldecod/src/intra16x16_pred_mbaff.c
ldecod/src/intra16x16_pred_normal.c
ldecod/src/intra4x4_pred.c
ldecod/src/intra4x4_pred_mbaff.c
ldecod/src/intra4x4_pred_normal.c
ldecod/src/intra8x8_pred.c
ldecod/src/intra8x8_pred_mbaff.c
ldecod/src/intra8x8_pred_normal.c
ldecod/src/intra_chroma_pred.c
ldecod/src/intra_chroma_pred_mbaff.c
ldecod/src/intra_pred_common.c
ldecod/src/ldecod.c
ldecod/src/leaky_bucket.c
ldecod/src/loopFilter.c
ldecod/src/loop_filter_mbaff.c
ldecod/src/loop_filter_normal.c
ldecod/src/macroblock.c
ldecod/src/mb_access.c
ldecod/src/mb_prediction.c
ldecod/src/mb_read.c
ldecod/src/mbuffer.c
ldecod/src/mbuffer_mvc.c
ldecod/src/mc_direct.c
ldecod/src/mc_prediction.c
ldecod/src/nal.c
ldecod/src/nalu.c
ldecod/src/output.c
ldecod/src/parset.c
ldecod/src/quant.c
ldecod/src/read_comp_cabac.c
ldecod/src/read_comp_cavlc.c
ldecod/src/rtp.c
ldecod/src/sei.c
ldecod/src/transform8x8.c
ldecod/src/vlc.c
lencod/inc/annexb.h
lencod/inc/biariencode.h
lencod/inc/block.h
lencod/inc/cabac.h
lencod/inc/cconv_yuv2rgb.h
lencod/inc/configfile.h
lencod/inc/conformance.h
lencod/inc/context_ini.h
lencod/inc/contributors.h
lencod/inc/defines.h
lencod/inc/elements.h
lencod/inc/errdo.h
lencod/inc/errdo_dist_mhyp.h
lencod/inc/explicit_gop.h
lencod/inc/explicit_seq.h
lencod/inc/filehandle.h
lencod/inc/fmo.h
lencod/inc/get_block_otf.h
lencod/inc/global.h
lencod/inc/header.h
lencod/inc/image.h
lencod/inc/img_chroma.h
lencod/inc/img_dist_ms_ssim.h
lencod/inc/img_dist_snr.h
lencod/inc/img_dist_ssim.h
lencod/inc/img_distortion.h
lencod/inc/img_luma.h
lencod/inc/intra16x16.h
lencod/inc/intra4x4.h
lencod/inc/intra8x8.h
lencod/inc/intrarefresh.h
lencod/inc/lambda.h
lencod/inc/leaky_bucket.h
lencod/inc/list_reorder.h
lencod/inc/lln_mc_prediction.h
lencod/inc/loop_filter.h
lencod/inc/macroblock.h
lencod/inc/macroblock_p444.h
lencod/inc/mbuffer.h
lencod/inc/mc_prediction.h
lencod/inc/mc_prediction_otf.h
lencod/inc/md_common.h
lencod/inc/md_distortion.h
lencod/inc/me_distortion.h
lencod/inc/me_distortion_otf.h
lencod/inc/me_epzs.h
lencod/inc/me_epzs_common.h
lencod/inc/me_epzs_int.h
lencod/inc/me_fullfast.h
lencod/inc/me_fullfast_otf.h
lencod/inc/me_fullsearch.h
lencod/inc/me_umhex.h
lencod/inc/me_umhexsmp.h
lencod/inc/mmco.h
lencod/inc/mode_decision.h
lencod/inc/mode_decision_p8x8.h
lencod/inc/mv_search.h
lencod/inc/nal.h
lencod/inc/nalu.h
lencod/inc/output.h
lencod/inc/params.h
lencod/inc/parset.h
lencod/inc/pred_struct.h
lencod/inc/pred_struct_adapt.h
lencod/inc/pred_struct_adapt_types.h
lencod/inc/pred_struct_types.h
lencod/inc/q_around.h
lencod/inc/q_matrix.h
lencod/inc/q_offsets.h
lencod/inc/quant4x4.h
lencod/inc/quant8x8.h
lencod/inc/quantChroma.h
lencod/inc/ratectl.h
lencod/inc/rc_quadratic.h
lencod/inc/rc_types.h
lencod/inc/rd_intra_jm.h
lencod/inc/rd_intra_jm444.h
lencod/inc/rdopt.h
lencod/inc/rdopt_coding_state.h
lencod/inc/rdoq.h
lencod/inc/refbuf.h
lencod/inc/refbuf_otf.h
lencod/inc/rtp.h
lencod/inc/sei.h
lencod/inc/slice.h
lencod/inc/symbol.h
lencod/inc/transform8x8.h
lencod/inc/vlc.h
lencod/inc/wp.h
lencod/inc/wp_lms.h
lencod/inc/wp_mciter.h
lencod/inc/wp_mcprec.h
lencod/inc/wp_periodic.h
lencod/inc/wp_random.h
lencod/src/annexb.c
lencod/src/biariencode.c
lencod/src/block.c
lencod/src/cabac.c
lencod/src/cconv_yuv2rgb.c
lencod/src/configfile.c
lencod/src/conformance.c
lencod/src/context_ini.c
lencod/src/errdo.c
lencod/src/errdo_dist_mhyp.c
lencod/src/explicit_gop.c
lencod/src/explicit_seq.c
lencod/src/filehandle.c
lencod/src/fmo.c
lencod/src/get_block_otf.c
lencod/src/header.c
lencod/src/image.c
lencod/src/image_mp.c
lencod/src/img_chroma.c
lencod/src/img_dist_ms_ssim.c
lencod/src/img_dist_snr.c
lencod/src/img_dist_ssim.c
lencod/src/img_distortion.c
lencod/src/img_luma.c
lencod/src/intra16x16.c
lencod/src/intra4x4.c
lencod/src/intra8x8.c
lencod/src/intra_chroma.c
lencod/src/intrarefresh.c
lencod/src/lambda.c
lencod/src/leaky_bucket.c
lencod/src/lencod.c
lencod/src/list_reorder.c
lencod/src/lln_mc_prediction.c
lencod/src/loopFilter.c
lencod/src/loop_filter_mbaff.c
lencod/src/loop_filter_normal.c
lencod/src/macroblock.c
lencod/src/macroblock_P444.c
lencod/src/mb_access.c
lencod/src/mbuffer.c
lencod/src/mc_prediction.c
lencod/src/mc_prediction_otf.c
lencod/src/md_common.c
lencod/src/md_distortion.c
lencod/src/md_high.c
lencod/src/md_highfast.c
lencod/src/md_highloss.c
lencod/src/md_low.c
lencod/src/me_distortion.c
lencod/src/me_distortion_otf.c
lencod/src/me_epzs.c
lencod/src/me_epzs_common.c
lencod/src/me_epzs_int.c
lencod/src/me_epzs_sub.c
lencod/src/me_fullfast.c
lencod/src/me_fullfast_otf.c
lencod/src/me_fullsearch.c
lencod/src/me_umhex.c
lencod/src/me_umhexsmp.c
lencod/src/mmco.c
lencod/src/mode_decision.c
lencod/src/mode_decision_P8x8.c
lencod/src/mv_direct.c
lencod/src/mv_search.c
lencod/src/nal.c
lencod/src/nalu.c
lencod/src/output.c
lencod/src/parset.c
lencod/src/pred_struct.c
lencod/src/q_around.c
lencod/src/q_matrix.c
lencod/src/q_offsets.c
lencod/src/quant4x4.c
lencod/src/quant4x4_2step.c
lencod/src/quant4x4_around.c
lencod/src/quant4x4_normal.c
lencod/src/quant4x4_trellis.c
lencod/src/quant8x8.c
lencod/src/quant8x8_around.c
lencod/src/quant8x8_normal.c
lencod/src/quant8x8_trellis.c
lencod/src/quantChroma.c
lencod/src/quantChroma_2step.c
lencod/src/quantChroma_around.c
lencod/src/quantChroma_normal.c
lencod/src/quantChroma_trellis.c
lencod/src/ratectl.c
lencod/src/rc_quadratic.c
lencod/src/rd_intra_jm.c
lencod/src/rd_intra_jm444.c
lencod/src/rd_intra_jm_low.c
lencod/src/rdopt.c
lencod/src/rdopt_coding_state.c
lencod/src/rdoq.c
lencod/src/rdoq_cabac.c
lencod/src/rdoq_cavlc.c
lencod/src/rdpicdecision.c
lencod/src/report.c
lencod/src/rtp.c
lencod/src/sei.c
lencod/src/slice.c
lencod/src/symbol.c
lencod/src/transform8x8.c
lencod/src/transform8x8_H444.c
lencod/src/vlc.c
lencod/src/weighted_prediction.c
lencod/src/wp_lms.c
lencod/src/wp_mciter.c
lencod/src/wp_mcprec.c
lencod/src/wp_periodic.c
lencod/src/wp_random.c
rtp_loss/rtp_loss.cpp
rtp_loss/rtp_loss.h
rtpdump/rtpdump.cpp
